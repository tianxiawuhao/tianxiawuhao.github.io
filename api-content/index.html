{"posts":[{"title":"å­¦ä¹ ç‡è°ƒåº¦ç­–ç•¥","content":"åœ¨æ·±åº¦å­¦ä¹ ä¸­ï¼Œè°ƒæ•´å­¦ä¹ ç‡æ˜¯ä¼˜åŒ–æ¨¡å‹æ€§èƒ½çš„é‡è¦æ‰‹æ®µã€‚ä¸åŒçš„å­¦ä¹ ç‡è°ƒåº¦ç­–ç•¥é€‚ç”¨äºä¸åŒçš„åœºæ™¯å’Œéœ€æ±‚ã€‚ä»¥ä¸‹æ˜¯å‡ ç§å¸¸è§çš„å­¦ä¹ ç‡è°ƒåº¦ç­–ç•¥åŠå…¶ä¼˜ç¼ºç‚¹ï¼š 1. å›ºå®šå­¦ä¹ ç‡ (Fixed Learning Rate) æè¿°ï¼š æ•´ä¸ªè®­ç»ƒè¿‡ç¨‹ä¸­å­¦ä¹ ç‡ä¿æŒä¸å˜ã€‚ ä¼˜ç‚¹ï¼š å®ç°ç®€å•ï¼Œæ— éœ€é¢å¤–çš„è®¡ç®—ã€‚ åœ¨æŸäº›ç®€å•çš„ä»»åŠ¡æˆ–å°è§„æ¨¡æ•°æ®é›†ä¸Šè¡¨ç°è‰¯å¥½ã€‚ ç¼ºç‚¹ï¼š å­¦ä¹ ç‡è¿‡é«˜å¯èƒ½å¯¼è‡´æ¨¡å‹æ— æ³•æ”¶æ•›ã€‚ å­¦ä¹ ç‡è¿‡ä½ä¼šå¯¼è‡´è®­ç»ƒé€Ÿåº¦å˜æ…¢ï¼Œç”šè‡³é™·å…¥å±€éƒ¨æœ€ä¼˜ã€‚ ä¸é€‚åˆå¤æ‚çš„ä»»åŠ¡æˆ–å¤§è§„æ¨¡æ•°æ®é›†ã€‚ 2. åˆ†æ®µå¸¸æ•°è¡°å‡ (Step Decay / Step LR) æè¿°ï¼š æ¯éš”å›ºå®šçš„epochæˆ–stepï¼Œå°†å­¦ä¹ ç‡ä¹˜ä»¥ä¸€ä¸ªè¡°å‡å› å­ï¼ˆå¦‚0.1ï¼‰ã€‚ ç¤ºä¾‹ï¼š lr = initial_lr * gamma ** (epoch // step_size) ä¼˜ç‚¹ï¼š ç®€å•æ˜“å®ç°ã€‚ èƒ½å¤Ÿåœ¨ç‰¹å®šé˜¶æ®µé™ä½å­¦ä¹ ç‡ï¼Œå¸®åŠ©æ¨¡å‹æ›´ç²¾ç»†åœ°ä¼˜åŒ–ã€‚ ç¼ºç‚¹ï¼š éœ€è¦æ‰‹åŠ¨è®¾ç½®step_sizeå’Œgammaï¼Œå¯¹è¶…å‚æ•°æ•æ„Ÿã€‚ å¯èƒ½å¯¼è‡´å­¦ä¹ ç‡ä¸‹é™è¿‡å¿«æˆ–è¿‡æ…¢ï¼Œå½±å“æ¨¡å‹æ€§èƒ½ã€‚ 3. æŒ‡æ•°è¡°å‡ (Exponential Decay) æè¿°ï¼š å­¦ä¹ ç‡æŒ‰æŒ‡æ•°å‡½æ•°é€æ¸å‡å°ã€‚ å…¬å¼ï¼š lr=initial_lrÃ—eâˆ’ktlr = initial\\_lr \\times e^{-kt} lr=initial_lrÃ—eâˆ’kt å…¶ä¸­ï¼Œt æ˜¯å½“å‰çš„è®­ç»ƒæ­¥æ•°ï¼Œk æ˜¯è¡°å‡é€Ÿç‡ã€‚ ä¼˜ç‚¹ï¼š å­¦ä¹ ç‡å¹³æ»‘ä¸‹é™ï¼Œé¿å…çªç„¶å˜åŒ–ã€‚ é€‚åˆéœ€è¦æŒç»­ä¼˜åŒ–çš„ä»»åŠ¡ã€‚ ç¼ºç‚¹ï¼š å¯¹äºå¤æ‚ä»»åŠ¡ï¼Œå¯èƒ½éœ€è¦ä»”ç»†è°ƒæ•´ k å€¼ã€‚ å¦‚æœè¡°å‡è¿‡å¿«ï¼Œå¯èƒ½å¯¼è‡´æ¨¡å‹æ”¶æ•›åˆ°æ¬¡ä¼˜è§£ã€‚ 4. ä½™å¼¦é€€ç« (Cosine Annealing) æè¿°ï¼š å­¦ä¹ ç‡æŒ‰ç…§ä½™å¼¦å‡½æ•°å‘¨æœŸæ€§å˜åŒ–ï¼Œé€šå¸¸ä»åˆå§‹å€¼é€æ¸ä¸‹é™åˆ°æœ€å°å€¼ã€‚ å…¬å¼ï¼š lr=min_lr+max_lrâˆ’min_lr2Ã—(1+cosâ¡(Ï€â‹…TcurTmax))lr = \\text{min\\_lr} + \\frac{\\text{max\\_lr} - \\text{min\\_lr}} 2 \\times {\\left(1 + \\cos\\left(\\pi \\cdot \\frac{T_{\\text{cur}}}{T_{\\text{max}}}\\right)\\right)} lr=min_lr+2max_lrâˆ’min_lrâ€‹Ã—(1+cos(Ï€â‹…Tmaxâ€‹Tcurâ€‹â€‹)) å…¶ä¸­ï¼ŒTcur æ˜¯å½“å‰çš„è®­ç»ƒæ­¥æ•°ï¼ŒTmax æ˜¯å‘¨æœŸçš„æœ€å¤§æ­¥æ•°ã€‚ ä¼˜ç‚¹ï¼š èƒ½å¤Ÿè‡ªåŠ¨è°ƒæ•´å­¦ä¹ ç‡ï¼Œé¿å…æ‰‹åŠ¨è®¾ç½®è¶…å‚æ•°ã€‚ å­¦ä¹ ç‡çš„å˜åŒ–æ›´åŠ å¹³æ»‘ï¼Œæœ‰åŠ©äºè·³å‡ºå±€éƒ¨æœ€ä¼˜ã€‚ å‘¨æœŸæ€§å˜åŒ–å¯ä»¥æé«˜æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚ ç¼ºç‚¹ï¼š å®ç°ç›¸å¯¹å¤æ‚ã€‚ å¯¹äºæŸäº›ä»»åŠ¡ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´å‘¨æœŸé•¿åº¦ã€‚ 5. Warmup + è¡°å‡ (Warmup + Decay) æè¿°ï¼š è®­ç»ƒåˆæœŸä½¿ç”¨è¾ƒå°çš„å­¦ä¹ ç‡é€æ­¥å¢åŠ ï¼ˆWarmupï¼‰ï¼Œç„¶åæŒ‰ç…§æŸç§ç­–ç•¥ï¼ˆå¦‚ä½™å¼¦é€€ç«æˆ–çº¿æ€§è¡°å‡ï¼‰é€æ¸å‡å°ã€‚ ç¤ºä¾‹ï¼š if current_step &lt; warmup_steps: lr = initial_lr * (current_step / warmup_steps) else: lr = initial_lr * (1 - (current_step - warmup_steps) / total_steps) ä¼˜ç‚¹ï¼š Warmupå¯ä»¥é˜²æ­¢è®­ç»ƒåˆæœŸæ¢¯åº¦çˆ†ç‚¸ã€‚ åç»­çš„è¡°å‡ç­–ç•¥å¯ä»¥å¸®åŠ©æ¨¡å‹æ›´å¥½åœ°æ”¶æ•›ã€‚ å¸¸ç”¨äºTransformerç­‰å¤æ‚æ¨¡å‹çš„è®­ç»ƒã€‚ ç¼ºç‚¹ï¼š éœ€è¦è®¾ç½®Warmupæ­¥æ•°å’Œåç»­çš„è¡°å‡ç­–ç•¥ã€‚ å¯¹äºä¸åŒä»»åŠ¡ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´Warmupæ­¥æ•°ã€‚ 6. Reduce on Plateau (åŸºäºéªŒè¯é›†æ€§èƒ½è°ƒæ•´å­¦ä¹ ç‡) æè¿°ï¼š å½“éªŒè¯é›†ä¸Šçš„æ€§èƒ½ï¼ˆå¦‚æŸå¤±æˆ–å‡†ç¡®ç‡ï¼‰åœæ­¢æ”¹å–„æ—¶ï¼Œé™ä½å­¦ä¹ ç‡ã€‚ ç¤ºä¾‹ï¼š scheduler = torch.optim.lr_scheduler.ReduceLROnPlateau(optimizer, mode='min', factor=0.1, patience=10) ä¼˜ç‚¹ï¼š è‡ªåŠ¨æ ¹æ®æ¨¡å‹æ€§èƒ½è°ƒæ•´å­¦ä¹ ç‡ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„ã€‚ é€‚åˆéªŒè¯é›†æ€§èƒ½æ³¢åŠ¨è¾ƒå¤§çš„ä»»åŠ¡ã€‚ ç¼ºç‚¹ï¼š å¯¹éªŒè¯é›†çš„ä¾èµ–è¾ƒå¼ºï¼Œå¦‚æœéªŒè¯é›†ä¸å…·æœ‰ä»£è¡¨æ€§ï¼Œå¯èƒ½å¯¼è‡´é”™è¯¯çš„è°ƒæ•´ã€‚ å¯èƒ½å¯¼è‡´å­¦ä¹ ç‡è¿‡æ—©ä¸‹é™ï¼Œå½±å“è®­ç»ƒæ•ˆæœã€‚ 7. å¾ªç¯å­¦ä¹ ç‡ (Cyclic Learning Rate) æè¿°ï¼š å­¦ä¹ ç‡åœ¨ä¸€ä¸ªèŒƒå›´å†…å‘¨æœŸæ€§åœ°å¢å¤§å’Œå‡å°ã€‚ ç¤ºä¾‹ï¼š scheduler = torch.optim.lr_scheduler.CyclicLR(optimizer, base_lr=0.001, max_lr=0.1, step_size_up=2000) ä¼˜ç‚¹ï¼š èƒ½å¤Ÿå¸®åŠ©æ¨¡å‹è·³å‡ºå±€éƒ¨æœ€ä¼˜ã€‚ é€‚åˆæ¢ç´¢æ€§è¾ƒå¼ºçš„ä»»åŠ¡ã€‚ ç¼ºç‚¹ï¼š å‚æ•°è®¾ç½®è¾ƒä¸ºå¤æ‚ï¼ˆå¦‚æœ€å¤§æœ€å°å­¦ä¹ ç‡ã€å‘¨æœŸé•¿åº¦ï¼‰ã€‚ å¯¹äºæŸäº›ä»»åŠ¡ï¼Œå¯èƒ½å¯¼è‡´è®­ç»ƒä¸ç¨³å®šã€‚ 8. è‡ªé€‚åº”å­¦ä¹ ç‡æ–¹æ³• (Adaptive Methods) æè¿°ï¼š ä½¿ç”¨è‡ªé€‚åº”ä¼˜åŒ–å™¨ï¼ˆå¦‚Adamã€RMSPropï¼‰åŠ¨æ€è°ƒæ•´æ¯ä¸ªå‚æ•°çš„å­¦ä¹ ç‡ã€‚ ä¼˜ç‚¹ï¼š ä¸éœ€è¦æ‰‹åŠ¨è®¾ç½®å­¦ä¹ ç‡è°ƒåº¦ç­–ç•¥ã€‚ èƒ½å¤Ÿé’ˆå¯¹ä¸åŒå‚æ•°åŠ¨æ€è°ƒæ•´å­¦ä¹ ç‡ï¼Œé€‚åˆéå‡¸ä¼˜åŒ–é—®é¢˜ã€‚ ç¼ºç‚¹ï¼š è‡ªé€‚åº”ä¼˜åŒ–å™¨å¯èƒ½ä¼šå¯¼è‡´æ¨¡å‹åœ¨è®­ç»ƒåæœŸæ”¶æ•›è¾ƒæ…¢ã€‚ å¯¹äºæŸäº›ä»»åŠ¡ï¼Œå¯èƒ½éœ€è¦ç»“åˆå…¶ä»–å­¦ä¹ ç‡è°ƒåº¦ç­–ç•¥ã€‚ 9. OneCycle Learning Rate æè¿°ï¼š å­¦ä¹ ç‡åœ¨ä¸€ä¸ªå‘¨æœŸå†…å…ˆä¸Šå‡åä¸‹é™ï¼ŒåŒæ—¶é…åˆåŠ¨é‡çš„è°ƒæ•´ã€‚ ä¼˜ç‚¹ï¼š èƒ½å¤Ÿå¿«é€Ÿæ”¶æ•›å¹¶è¾¾åˆ°è¾ƒå¥½çš„æ€§èƒ½ã€‚ é€‚åˆè®­ç»ƒæ—¶é—´æœ‰é™çš„ä»»åŠ¡ã€‚ ç¼ºç‚¹ï¼š éœ€è¦è®¾ç½®æœ€å¤§å­¦ä¹ ç‡ã€å‘¨æœŸé•¿åº¦ç­‰è¶…å‚æ•°ã€‚ å¯¹äºæŸäº›ä»»åŠ¡ï¼Œå¯èƒ½éœ€è¦å¤šæ¬¡å®éªŒæ‰èƒ½æ‰¾åˆ°åˆé€‚çš„å‚æ•°ã€‚ æ€»ç»“å¯¹æ¯” ç­–ç•¥ ä¼˜ç‚¹ ç¼ºç‚¹ å›ºå®šå­¦ä¹ ç‡ ç®€å•æ˜“ç”¨ å®¹æ˜“è¿‡æ‹Ÿåˆæˆ–æ¬ æ‹Ÿåˆ åˆ†æ®µå¸¸æ•°è¡°å‡ æ˜“å®ç°ï¼Œé€‚åˆé˜¶æ®µæ€§ä¼˜åŒ– å¯¹è¶…å‚æ•°æ•æ„Ÿ æŒ‡æ•°è¡°å‡ å¹³æ»‘ä¸‹é™ï¼Œé€‚åˆé•¿æœŸä¼˜åŒ– å¯èƒ½è¡°å‡è¿‡å¿« ä½™å¼¦é€€ç« å¹³æ»‘ä¸”å‘¨æœŸæ€§å˜åŒ–ï¼Œæœ‰åŠ©äºè·³å‡ºå±€éƒ¨æœ€ä¼˜ å®ç°å¤æ‚ï¼Œéœ€è¦è°ƒæ•´å‘¨æœŸ Warmup + è¡°å‡ é˜²æ­¢æ¢¯åº¦çˆ†ç‚¸ï¼Œé€‚åˆå¤æ‚æ¨¡å‹ éœ€è¦è®¾ç½®å¤šä¸ªè¶…å‚æ•° Reduce on Plateau è‡ªåŠ¨è°ƒæ•´ï¼Œé€‚åˆéªŒè¯é›†æ€§èƒ½æ³¢åŠ¨å¤§çš„ä»»åŠ¡ å¯¹éªŒè¯é›†ä¾èµ–å¼º å¾ªç¯å­¦ä¹ ç‡ å¸®åŠ©è·³å‡ºå±€éƒ¨æœ€ä¼˜ï¼Œé€‚åˆæ¢ç´¢æ€§ä»»åŠ¡ å‚æ•°è®¾ç½®å¤æ‚ï¼Œå¯èƒ½å¯¼è‡´ä¸ç¨³å®š è‡ªé€‚åº”å­¦ä¹ ç‡æ–¹æ³• åŠ¨æ€è°ƒæ•´ï¼Œé€‚åˆéå‡¸ä¼˜åŒ–é—®é¢˜ æ”¶æ•›è¾ƒæ…¢ï¼Œå¯èƒ½éœ€è¦ç»“åˆå…¶ä»–ç­–ç•¥ OneCycle Learning Rate å¿«é€Ÿæ”¶æ•›ï¼Œé€‚åˆæ—¶é—´æœ‰é™çš„ä»»åŠ¡ éœ€è¦å¤šæ¬¡å®éªŒè°ƒæ•´è¶…å‚æ•° é€‰æ‹©ç­–ç•¥çš„å»ºè®® ç®€å•ä»»åŠ¡ ï¼šå›ºå®šå­¦ä¹ ç‡æˆ–åˆ†æ®µå¸¸æ•°è¡°å‡ã€‚ å¤æ‚ä»»åŠ¡ ï¼šWarmup + ä½™å¼¦é€€ç«æˆ–OneCycleã€‚ éªŒè¯é›†æ€§èƒ½æ³¢åŠ¨å¤§ ï¼šReduce on Plateauã€‚ æ¢ç´¢æ€§ä»»åŠ¡ ï¼šå¾ªç¯å­¦ä¹ ç‡ã€‚ å¤§è§„æ¨¡æ¨¡å‹ ï¼šç»“åˆWarmupå’Œè‡ªé€‚åº”ä¼˜åŒ–å™¨ï¼ˆå¦‚AdamWï¼‰ã€‚ æ ¹æ®å…·ä½“ä»»åŠ¡çš„éœ€æ±‚å’Œå®éªŒç»“æœï¼Œçµæ´»é€‰æ‹©åˆé€‚çš„å­¦ä¹ ç‡è°ƒåº¦ç­–ç•¥ã€‚ ","link":"https://tianxiawuhao.github.io/vfv73gaU-n/"},{"title":"LoRAï¼ˆLow-Rank Adaptationï¼‰","content":"LoRA (Low-Rank Adaptation) LoRAï¼ˆä½ç§©é€‚é…ï¼‰æ˜¯ä¸€ç§é«˜æ•ˆçš„å‚æ•°é«˜æ•ˆå¾®è°ƒï¼ˆParameter-Efficient Fine-Tuning, PEFTï¼‰æ–¹æ³•ï¼Œæ—¨åœ¨é€šè¿‡ä½ç§©åˆ†è§£çš„æ–¹å¼å¯¹é¢„è®­ç»ƒæ¨¡å‹è¿›è¡Œå¾®è°ƒã€‚ ç›¸æ¯”äºå…¨å‚æ•°å¾®è°ƒï¼ˆFull Fine-Tuningï¼‰ï¼ŒLoRA åªéœ€è¦æ›´æ–°å°‘é‡çš„å‚æ•°ã€‚ LoRA çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šåœ¨æ¨¡å‹çš„æƒé‡çŸ©é˜µä¸­å¼•å…¥ä½ç§©åˆ†è§£ï¼Œä»…å¯¹ä½ç§©éƒ¨åˆ†è¿›è¡Œæ›´æ–°ï¼Œè€Œä¿æŒåŸå§‹é¢„è®­ç»ƒæƒé‡ä¸å˜ã€‚ ä»£ç å¯è§ä»¥ä¸‹ï¼Œå®Œå…¨ä»0å®ç°LoRAæµç¨‹ï¼Œä¸ä¾èµ–ç¬¬ä¸‰æ–¹åº“çš„å°è£…ã€‚ import os # æ–‡ä»¶æ“ä½œ import argparse # å‘½ä»¤è¡Œå‚æ•°è§£æ import time # æ—¶é—´ç®¡ç† import math # æ•°å­¦è®¡ç®— import warnings # å¿½ç•¥è­¦å‘Šä¿¡æ¯ import torch.distributed as dist # åˆ†å¸ƒå¼è®­ç»ƒ from contextlib import nullcontext # é»˜è®¤ä¸Šä¸‹æ–‡ç®¡ç† from torch.utils.data import DataLoader, DistributedSampler # æ•°æ®åŠ è½½å’Œåˆ†å¸ƒå¼é‡‡æ · from transformers import AutoTokenizer # åŠ è½½é¢„è®­ç»ƒçš„åˆ†è¯å™¨ from model.model import MiniMindLM # æ¨¡å‹æ¶æ„ from model.LMConfig import LMConfig # é…ç½® from model.dataset import SFTDataset #æ•°æ®é›† from model.model_lora import * # LoRAæ–¹æ³• from torch import optim, nn # å¿½ç•¥è­¦å‘Šä¿¡æ¯ warnings.filterwarnings('ignore') # Logger function # åœ¨åˆ†å¸ƒå¼è®­ç»ƒä¸­ï¼Œåªæœ‰ä¸»è¿›ç¨‹ï¼ˆrank=0ï¼‰ä¼šæ‰“å°æ—¥å¿—ä¿¡æ¯ï¼Œé¿å…å¤šä¸ªè¿›ç¨‹é‡å¤è¾“å‡ºã€‚å¦‚æœä¸æ˜¯åˆ†å¸ƒå¼è®­ç»ƒï¼ˆddp=Falseï¼‰ï¼Œåˆ™ç›´æ¥æ‰“å°æ—¥å¿—ã€‚ def Logger(content): if not ddp or dist.get_rank() == 0: print(content) # ä½¿ç”¨ä½™å¼¦é€€ç«ç­–ç•¥åŠ¨æ€è°ƒæ•´å­¦ä¹ ç‡ã€‚å…¬å¼ä¸ºï¼š def get_lr(current_step, total_steps, lr): return lr / 10 + 0.5 * lr * (1 + math.cos(math.pi * current_step / total_steps)) # ä»£ç å’Œfull_sftã€Œå‡ ä¹ã€ä¸€è‡´ # ä½œç”¨ ï¼šå®šä¹‰ä¸€ä¸ªè®­ç»ƒepochçš„å‡½æ•°ã€‚ # å‚æ•° ï¼š # epochï¼šå½“å‰è®­ç»ƒçš„epochç¼–å·ï¼ˆä»0å¼€å§‹ï¼‰ã€‚ # wandbï¼šWandBæ—¥å¿—è®°å½•å·¥å…·å¯¹è±¡ï¼Œç”¨äºè®°å½•è®­ç»ƒè¿‡ç¨‹ä¸­çš„æŒ‡æ ‡ã€‚å¦‚æœæœªå¯ç”¨WandBï¼Œåˆ™ä¸ºNoneã€‚ def train_epoch(epoch, wandb): # ä½œç”¨ ï¼šå®šä¹‰äº¤å‰ç†µæŸå¤±å‡½æ•°ï¼Œreduction='none' è¡¨ç¤ºä¸å¯¹æŸå¤±è¿›è¡Œå½’çº¦æ“ä½œï¼ˆå³è¿”å›æ¯ä¸ªæ ·æœ¬çš„æŸå¤±å€¼ï¼Œè€Œä¸æ˜¯å¹³å‡æˆ–æ€»å’Œï¼‰ã€‚ # ç”¨é€” ï¼šåç»­ä¼šæ ¹æ® loss_mask å¯¹æŸå¤±è¿›è¡ŒåŠ æƒæ±‚å’Œï¼Œå› æ­¤éœ€è¦é€æ ·æœ¬è®¡ç®—æŸå¤±ã€‚ # æ‰©å±• ï¼šå¯ä»¥æ ¹æ®ä»»åŠ¡éœ€æ±‚é€‰æ‹©å…¶ä»–æŸå¤±å‡½æ•°ï¼Œå¦‚ nn.MSELoss æˆ–è‡ªå®šä¹‰æŸå¤±å‡½æ•°ã€‚ loss_fct = nn.CrossEntropyLoss(reduction='none') # ä½œç”¨ ï¼šè®°å½•å½“å‰æ—¶é—´æˆ³ï¼Œç”¨äºè®¡ç®—è®­ç»ƒè€—æ—¶ã€‚ # ç”¨é€” ï¼šåœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºæ¯ä¸€æ­¥æˆ–æ¯ä¸ªepochçš„è®­ç»ƒæ—¶é—´ã€‚ # æ‰©å±• ï¼šå¯ä»¥ç»“åˆæ›´ç²¾ç»†çš„æ—¶é—´ç®¡ç†å·¥å…·ï¼ˆå¦‚ timeit æ¨¡å—ï¼‰æ¥ä¼˜åŒ–æ€§èƒ½åˆ†æã€‚ start_time = time.time() # ä½œç”¨ ï¼šéå†è®­ç»ƒæ•°æ®åŠ è½½å™¨ train_loaderï¼Œæ¯æ¬¡è¿­ä»£è·å–ä¸€ä¸ªæ‰¹æ¬¡çš„æ•°æ®ã€‚ # stepï¼šå½“å‰batchçš„ç´¢å¼•ã€‚ # Xï¼šè¾“å…¥æ•°æ®ï¼ˆé€šå¸¸æ˜¯tokenizedçš„æ–‡æœ¬åºåˆ—ï¼‰ã€‚ # Yï¼šç›®æ ‡æ ‡ç­¾ï¼ˆé€šå¸¸æ˜¯ä¸‹ä¸€ä¸ªtokençš„é¢„æµ‹ç›®æ ‡ï¼‰ã€‚ # loss_maskï¼šç”¨äºå±è”½æ— æ•ˆtokençš„æ©ç ï¼ˆå¦‚å¡«å……tokenæˆ–ç‰¹æ®Šæ ‡è®°ï¼‰ã€‚ # ç”¨é€” ï¼šé€æ‰¹æ¬¡å¤„ç†æ•°æ®å¹¶æ›´æ–°æ¨¡å‹å‚æ•°ã€‚ # æ‰©å±• ï¼šå¯ä»¥é€šè¿‡ DataLoader çš„ collate_fn è‡ªå®šä¹‰æ•°æ®é¢„å¤„ç†é€»è¾‘ã€‚ for step, (X, Y, loss_mask) in enumerate(train_loader): # ä½œç”¨ ï¼šå°†è¾“å…¥æ•°æ®ã€ç›®æ ‡æ ‡ç­¾å’ŒæŸå¤±æ©ç ç§»åŠ¨åˆ°æŒ‡å®šè®¾å¤‡ï¼ˆå¦‚GPUæˆ–CPUï¼‰ã€‚ # ç”¨é€” ï¼šç¡®ä¿æ•°æ®å’Œæ¨¡å‹ä½äºåŒä¸€è®¾å¤‡ä¸Šï¼Œé¿å…è¿è¡Œæ—¶é”™è¯¯ã€‚ # æ‰©å±• ï¼šå¯ä»¥ä½¿ç”¨ .pin_memory() æå‰å°†æ•°æ®é”å®šåœ¨å†…å­˜ä¸­ï¼Œä»¥åŠ é€ŸGPUæ•°æ®ä¼ è¾“ã€‚ X = X.to(args.device) Y = Y.to(args.device) loss_mask = loss_mask.to(args.device) # ä½œç”¨ ï¼š # è°ƒç”¨ get_lr å‡½æ•°åŠ¨æ€è®¡ç®—å½“å‰çš„å­¦ä¹ ç‡ã€‚ # å°†è®¡ç®—å¾—åˆ°çš„å­¦ä¹ ç‡åº”ç”¨åˆ°ä¼˜åŒ–å™¨çš„æ‰€æœ‰å‚æ•°ç»„ã€‚ # ç”¨é€” ï¼šå®ç°å­¦ä¹ ç‡è°ƒåº¦ç­–ç•¥ï¼ˆå¦‚ä½™å¼¦é€€ç«ï¼‰ã€‚ # æ‰©å±• ï¼š # å¯ä»¥æ›¿æ¢ä¸ºå…¶ä»–å­¦ä¹ ç‡è°ƒåº¦å™¨ï¼ˆå¦‚ torch.optim.lr_scheduler ä¸­çš„ StepLR æˆ– CosineAnnealingLRï¼‰ã€‚ # æ”¯æŒå¤šé˜¶æ®µå­¦ä¹ ç‡è°ƒåº¦ï¼ˆå¦‚Warmup + Decayï¼‰ã€‚ lr = get_lr(epoch * iter_per_epoch + step, args.epochs * iter_per_epoch, args.learning_rate) for param_group in optimizer.param_groups: param_group['lr'] = lr # ä½œç”¨ ï¼š # ä¸Šä¸‹æ–‡ç®¡ç†å™¨ ctx ï¼šå¦‚æœä½¿ç”¨æ··åˆç²¾åº¦è®­ç»ƒï¼ˆå¦‚FP16ï¼‰ï¼Œåˆ™å¯ç”¨è‡ªåŠ¨æ··åˆç²¾åº¦ï¼ˆAMPï¼‰ã€‚ # å‰å‘ä¼ æ’­ ï¼šè°ƒç”¨æ¨¡å‹ model(X) è¿›è¡Œå‰å‘ä¼ æ’­ï¼Œè¾“å‡ºç»“æœå­˜å‚¨åœ¨ res ä¸­ã€‚ # è®¡ç®—æŸå¤± ï¼š # ä½¿ç”¨ CrossEntropyLoss è®¡ç®—é€æ ·æœ¬æŸå¤±ã€‚ # æ ¹æ® loss_mask åŠ æƒæ±‚å’Œï¼Œå¿½ç•¥æ— æ•ˆtokençš„æŸå¤±ã€‚ # æ·»åŠ è¾…åŠ©æŸå¤±ï¼ˆaux_lossï¼‰ï¼Œé€šå¸¸ç”¨äºæ­£åˆ™åŒ–æˆ–å…¶ä»–ç›®æ ‡ã€‚ # å°†æ€»æŸå¤±é™¤ä»¥ç´¯ç§¯æ­¥æ•°ï¼ˆaccumulation_stepsï¼‰ï¼Œä»¥ä¾¿æ¢¯åº¦ç´¯ç§¯åæ›´æ–°ã€‚ # ç”¨é€” ï¼šå®Œæˆä¸€æ¬¡å‰å‘ä¼ æ’­å¹¶è®¡ç®—æœ€ç»ˆæŸå¤±ã€‚ # æ‰©å±• ï¼š # å¦‚æœä»»åŠ¡å¤æ‚ï¼Œå¯ä»¥æ·»åŠ æ›´å¤šæŸå¤±é¡¹ï¼ˆå¦‚KLæ•£åº¦ã€å¯¹æ¯”æŸå¤±ç­‰ï¼‰ã€‚ # æ”¯æŒå¤šç§æŸå¤±æƒé‡çš„åŠ¨æ€è°ƒæ•´ã€‚ with ctx: res = model(X) loss = loss_fct( res.logits.view(-1, res.logits.size(-1)), Y.view(-1) ).view(Y.size()) loss = (loss * loss_mask).sum() / loss_mask.sum() loss += res.aux_loss loss = loss / args.accumulation_steps # ä½œç”¨ ï¼š # åå‘ä¼ æ’­ ï¼šä½¿ç”¨ scaler.scale(loss).backward() è®¡ç®—æ¢¯åº¦ï¼ˆæ”¯æŒæ··åˆç²¾åº¦ï¼‰ã€‚ # æ¢¯åº¦ç´¯ç§¯ ï¼šæ¯éš” accumulation_steps æ­¥æ‰§è¡Œä¸€æ¬¡æ¢¯åº¦æ›´æ–°ã€‚ # æ¢¯åº¦è£å‰ª ï¼šé˜²æ­¢æ¢¯åº¦çˆ†ç‚¸ï¼Œé™åˆ¶æ¢¯åº¦èŒƒæ•°ä¸è¶…è¿‡ grad_clipã€‚ # ä¼˜åŒ–å™¨æ›´æ–° ï¼šè°ƒç”¨ scaler.step(optimizer) æ›´æ–°æ¨¡å‹å‚æ•°ã€‚ # é‡ç½®æ¢¯åº¦ ï¼šè°ƒç”¨ optimizer.zero_grad(set_to_none=True) æ¸…ç©ºæ¢¯åº¦ã€‚ # ç”¨é€” ï¼šå®ç°æ¢¯åº¦ç´¯ç§¯å’Œæ··åˆç²¾åº¦è®­ç»ƒï¼Œæé«˜è®­ç»ƒæ•ˆç‡ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€è°ƒæ•´ accumulation_stepsï¼Œä»¥é€‚åº”ä¸åŒç¡¬ä»¶èµ„æºã€‚ # å¯ä»¥æ›¿æ¢ä¸ºå…¶ä»–ä¼˜åŒ–å™¨ï¼ˆå¦‚LAMBã€Rangerç­‰ï¼‰ã€‚ scaler.scale(loss).backward() if (step + 1) % args.accumulation_steps == 0: scaler.unscale_(optimizer) torch.nn.utils.clip_grad_norm_(lora_params, args.grad_clip) scaler.step(optimizer) scaler.update() optimizer.zero_grad(set_to_none=True) # ä½œç”¨ ï¼š # æ¯éš” log_interval æ­¥è®°å½•ä¸€æ¬¡è®­ç»ƒæ—¥å¿—ã€‚ # æ‰“å°å½“å‰epochã€stepã€æŸå¤±ã€å­¦ä¹ ç‡å’Œé¢„è®¡å‰©ä½™æ—¶é—´ã€‚ # å¦‚æœå¯ç”¨äº†WandBï¼Œå°†æ—¥å¿—ä¸Šä¼ åˆ°äº‘ç«¯ã€‚ # ç”¨é€” ï¼šç›‘æ§è®­ç»ƒè¿›åº¦ï¼Œä¾¿äºè°ƒè¯•å’Œåˆ†æã€‚ # æ‰©å±• ï¼š # å¯ä»¥è®°å½•æ›´å¤šæŒ‡æ ‡ï¼ˆå¦‚å‡†ç¡®ç‡ã€F1åˆ†æ•°ç­‰ï¼‰ã€‚ # æ”¯æŒä¿å­˜æ—¥å¿—åˆ°æœ¬åœ°æ–‡ä»¶æˆ–æ•°æ®åº“ã€‚ if step % args.log_interval == 0: spend_time = time.time() - start_time Logger( 'Epoch:[{}/{}]({}/{}) loss:{:.3f} lr:{:.12f} epoch_Time:{}min:'.format( epoch + 1, args.epochs, step, iter_per_epoch, loss.item(), optimizer.param_groups[-1]['lr'], spend_time / (step + 1) * iter_per_epoch // 60 - spend_time // 60)) if (wandb is not None) and (not ddp or dist.get_rank() == 0): wandb.log({&quot;loss&quot;: loss, &quot;lr&quot;: optimizer.param_groups[-1]['lr'], &quot;epoch_Time&quot;: spend_time / (step + 1) * iter_per_epoch // 60 - spend_time // 60}) # ä½œç”¨ ï¼š # æ¯éš” save_interval æ­¥ä¿å­˜ä¸€æ¬¡æ¨¡å‹ã€‚ # ä»…ä¿å­˜LoRAæƒé‡ï¼ˆåŒºåˆ«äºå®Œæ•´æ¨¡å‹æƒé‡ï¼‰ã€‚ # åœ¨åˆ†å¸ƒå¼è®­ç»ƒä¸­ï¼Œåªæœ‰ä¸»è¿›ç¨‹ï¼ˆrank=0ï¼‰æ‰§è¡Œä¿å­˜æ“ä½œã€‚ # ç”¨é€” ï¼šå®šæœŸä¿å­˜æ¨¡å‹ï¼Œé˜²æ­¢è®­ç»ƒä¸­æ–­å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚ # æ‰©å±• ï¼š # æ”¯æŒå¢é‡ä¿å­˜ï¼ˆä»…ä¿å­˜æ–°å¢çš„æƒé‡å˜åŒ–ï¼‰ã€‚ # å¯ä»¥æ ¹æ®éªŒè¯é›†æ€§èƒ½ä¿å­˜æœ€ä½³æ¨¡å‹ã€‚ if (step + 1) % args.save_interval == 0 and (not ddp or dist.get_rank() == 0): model.eval() # ã€åŒºåˆ«1ã€‘åªä¿å­˜loraæƒé‡å³å¯ save_lora(model, f'{args.save_dir}/lora/{args.lora_name}_{lm_config.dim}.pth') model.train() def init_model(lm_config): # ä½œç”¨ ï¼šåŠ è½½é¢„è®­ç»ƒåˆ†è¯å™¨ï¼ˆAutoTokenizerï¼‰ã€‚ # ç”¨é€” ï¼šç”¨äºå°†è¾“å…¥æ–‡æœ¬è½¬æ¢ä¸ºæ¨¡å‹å¯æ¥å—çš„tokenåºåˆ—ã€‚ # æ‰©å±• ï¼š # å¯ä»¥æ ¹æ®ä»»åŠ¡éœ€æ±‚é€‰æ‹©ä¸åŒçš„åˆ†è¯å™¨ï¼ˆå¦‚BERTã€GPTç­‰ï¼‰ã€‚ # æ”¯æŒè‡ªå®šä¹‰è¯æ±‡è¡¨æˆ–ç‰¹æ®Šæ ‡è®°ã€‚ tokenizer = AutoTokenizer.from_pretrained('./model/minimind_tokenizer') # ä½œç”¨ ï¼šåˆå§‹åŒ–æ¨¡å‹ MiniMindLMï¼Œä½¿ç”¨é…ç½®å¯¹è±¡ lm_configã€‚ # ç”¨é€” ï¼šåˆ›å»ºä¸€ä¸ªè¯­è¨€æ¨¡å‹å®ä¾‹ã€‚ # æ‰©å±• ï¼š # å¯ä»¥åŠ¨æ€è°ƒæ•´æ¨¡å‹ç»“æ„ï¼ˆå¦‚å±‚æ•°ã€éšè—ç»´åº¦ç­‰ï¼‰ã€‚ # æ”¯æŒåŠ è½½ä¸åŒç‰ˆæœ¬çš„é¢„è®­ç»ƒæ¨¡å‹æƒé‡ã€‚ model = MiniMindLM(lm_config) # ä½œç”¨ ï¼š # æ ¹æ®æ˜¯å¦å¯ç”¨ MoEï¼ˆMixture of Expertsï¼‰ï¼Œç”Ÿæˆæ£€æŸ¥ç‚¹è·¯å¾„ã€‚ # æ£€æŸ¥ç‚¹æ–‡ä»¶ååŒ…å«æ¨¡å‹ç»´åº¦å’ŒMoEæ ‡å¿—ã€‚ # ç”¨é€” ï¼šåŠ è½½ä¸å½“å‰æ¨¡å‹é…ç½®åŒ¹é…çš„é¢„è®­ç»ƒæƒé‡ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€ç”Ÿæˆæ£€æŸ¥ç‚¹è·¯å¾„ï¼Œé€‚é…å¤šç§æ¨¡å‹é…ç½®ã€‚ # å¯ä»¥æ ¹æ®ä»»åŠ¡ç±»å‹ï¼ˆå¦‚åˆ†ç±»ã€ç”Ÿæˆï¼‰åŠ è½½ä¸åŒçš„æƒé‡ã€‚ moe_path = '_moe' if lm_config.use_moe else '' ckp = f'./out/rlhf_{lm_config.dim}{moe_path}.pth' # ä½œç”¨ ï¼š # åŠ è½½é¢„è®­ç»ƒæƒé‡åˆ°æ¨¡å‹ä¸­ã€‚ # ä½¿ç”¨ strict=False å…è®¸éƒ¨åˆ†æƒé‡ä¸åŒ¹é…ï¼ˆå¦‚æ–°å¢æˆ–åˆ é™¤å±‚ï¼‰ã€‚ # ç”¨é€” ï¼šåˆå§‹åŒ–æ¨¡å‹å‚æ•°ï¼Œé¿å…ä»é›¶å¼€å§‹è®­ç»ƒã€‚ # æ‰©å±• ï¼š # å¯ä»¥å®ç°å¢é‡åŠ è½½ï¼ˆä»…åŠ è½½éƒ¨åˆ†æƒé‡ï¼‰ã€‚ # æ”¯æŒå¤šé˜¶æ®µè®­ç»ƒï¼ˆå¦‚å…ˆåŠ è½½åŸºç¡€æ¨¡å‹ï¼Œå†å¾®è°ƒç‰¹å®šä»»åŠ¡ï¼‰ã€‚ state_dict = torch.load(ckp, map_location=args.device) model.load_state_dict(state_dict, strict=False) # ä½œç”¨ ï¼šå°†æ¨¡å‹ç§»åŠ¨åˆ°æŒ‡å®šè®¾å¤‡ï¼ˆå¦‚GPUæˆ–CPUï¼‰ï¼Œå¹¶è¿”å›æ¨¡å‹å’Œåˆ†è¯å™¨ã€‚ # ç”¨é€” ï¼šç¡®ä¿æ¨¡å‹å’Œæ•°æ®ä½äºåŒä¸€è®¾å¤‡ä¸Šã€‚ # æ‰©å±• ï¼š # æ”¯æŒå¤šè®¾å¤‡åˆ†å¸ƒå¼è®­ç»ƒï¼ˆå¦‚æ¨¡å‹å¹¶è¡Œï¼‰ã€‚ return model.to(args.device), tokenizer def init_distributed_mode(): # ä½œç”¨ ï¼šå¦‚æœæœªå¯ç”¨åˆ†å¸ƒå¼è®­ç»ƒï¼ˆddp=Falseï¼‰ï¼Œç›´æ¥è¿”å›ã€‚ # ç”¨é€” ï¼šé¿å…ä¸å¿…è¦çš„åˆ†å¸ƒå¼åˆå§‹åŒ–æ“ä½œã€‚ # æ‰©å±• ï¼š # æ”¯æŒå…¶ä»–åˆ†å¸ƒå¼åç«¯ï¼ˆå¦‚glooã€mpiï¼‰ã€‚ if not ddp: return # ä½œç”¨ ï¼šåˆå§‹åŒ–åˆ†å¸ƒå¼è®­ç»ƒç¯å¢ƒï¼Œä½¿ç”¨NCCLåç«¯ï¼ˆé€‚ç”¨äºCUDAï¼‰ã€‚ # ç”¨é€” ï¼šè®¾ç½®åˆ†å¸ƒå¼é€šä¿¡ç»„ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€é€‰æ‹©åç«¯ï¼ˆå¦‚ncclã€glooï¼‰ã€‚ # å¯ä»¥å®ç°æ›´å¤æ‚çš„åˆ†å¸ƒå¼ç­–ç•¥ï¼ˆå¦‚æ¨¡å‹å¹¶è¡Œï¼‰ã€‚ global ddp_local_rank, DEVICE dist.init_process_group(backend=&quot;nccl&quot;) # ä½œç”¨ ï¼šä»ç¯å¢ƒå˜é‡ä¸­è·å–åˆ†å¸ƒå¼è®­ç»ƒçš„ç›¸å…³ä¿¡æ¯ã€‚ # RANKï¼šå½“å‰è¿›ç¨‹çš„å…¨å±€rankã€‚ # LOCAL_RANKï¼šå½“å‰è¿›ç¨‹åœ¨æœ¬åœ°èŠ‚ç‚¹çš„rankã€‚ # WORLD_SIZEï¼šæ€»è¿›ç¨‹æ•°ã€‚ # ç”¨é€” ï¼šç¡®å®šæ¯ä¸ªè¿›ç¨‹çš„è§’è‰²å’Œä½ç½®ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€è°ƒæ•´åˆ†å¸ƒå¼é…ç½®ï¼ˆå¦‚è¿›ç¨‹æ•°ã€èŠ‚ç‚¹æ•°ï¼‰ã€‚ ddp_rank = int(os.environ[&quot;RANK&quot;]) ddp_local_rank = int(os.environ[&quot;LOCAL_RANK&quot;]) ddp_world_size = int(os.environ[&quot;WORLD_SIZE&quot;]) # ä½œç”¨ ï¼šå°†å½“å‰è¿›ç¨‹ç»‘å®šåˆ°æŒ‡å®šçš„GPUè®¾å¤‡ã€‚ # ç”¨é€” ï¼šç¡®ä¿æ¯ä¸ªè¿›ç¨‹ä½¿ç”¨ç‹¬ç«‹çš„GPUèµ„æºã€‚ # æ‰©å±• ï¼š # æ”¯æŒå¤šGPUå…±äº«ï¼ˆå¦‚æ··åˆç²¾åº¦è®­ç»ƒï¼‰ã€‚ DEVICE = f&quot;cuda:{ddp_local_rank}&quot; torch.cuda.set_device(DEVICE) # ä½œç”¨ ï¼šå®šä¹‰ç¨‹åºå…¥å£ï¼Œç¡®ä¿ä»£ç åªåœ¨ç›´æ¥è¿è¡Œæ—¶æ‰§è¡Œã€‚ # ç”¨é€” ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œä¾¿äºå¤ç”¨å’Œæµ‹è¯•ã€‚ # æ‰©å±• ï¼š # æ”¯æŒå‘½ä»¤è¡Œå‚æ•°è§£æå’ŒåŠ¨æ€é…ç½®ã€‚ if __name__ == &quot;__main__&quot;: # ä½œç”¨ ï¼šåˆ›å»ºå‘½ä»¤è¡Œå‚æ•°è§£æå™¨ã€‚ # ç”¨é€” ï¼šé€šè¿‡å‘½ä»¤è¡Œä¼ é€’è¶…å‚æ•°ï¼Œçµæ´»æ§åˆ¶è®­ç»ƒè¿‡ç¨‹ã€‚ # æ‰©å±• ï¼š # æ”¯æŒä»é…ç½®æ–‡ä»¶åŠ è½½å‚æ•°ã€‚ # åŠ¨æ€éªŒè¯å‚æ•°åˆæ³•æ€§ã€‚ parser = argparse.ArgumentParser(description=&quot;MiniMind SFT with LoRA&quot;) # ä½œç”¨ ï¼šå®šä¹‰è¾“å‡ºç›®å½•è·¯å¾„ï¼Œé»˜è®¤å€¼ä¸ºoutã€‚ # ç”¨é€” ï¼šä¿å­˜æ¨¡å‹æƒé‡å’Œæ—¥å¿—æ–‡ä»¶ã€‚ # æ‰©å±• ï¼š # æ”¯æŒè‡ªåŠ¨åˆ›å»ºç›®å½•ã€‚ # åŠ¨æ€ç”Ÿæˆå­ç›®å½•ï¼ˆå¦‚æŒ‰æ—¥æœŸæˆ–ä»»åŠ¡ç±»å‹ï¼‰ã€‚ parser.add_argument(&quot;--out_dir&quot;, type=str, default=&quot;out&quot;) # ä½œç”¨ ï¼šå®šä¹‰è®­ç»ƒè½®æ•°ï¼Œé»˜è®¤å€¼ä¸º50ã€‚ # ç”¨é€” ï¼šæ§åˆ¶è®­ç»ƒæ—¶é•¿ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€è°ƒæ•´è®­ç»ƒè½®æ•°ï¼ˆå¦‚æ—©åœæœºåˆ¶ï¼‰ã€‚ parser.add_argument(&quot;--epochs&quot;, type=int, default=50) # ä½œç”¨ ï¼šå®šä¹‰æ‰¹æ¬¡å¤§å°ï¼Œé»˜è®¤å€¼ä¸º16ã€‚ # ç”¨é€” ï¼šæ§åˆ¶æ¯æ¬¡è¿­ä»£çš„æ•°æ®é‡ã€‚ # æ‰©å±• ï¼š # åŠ¨æ€è°ƒæ•´æ‰¹æ¬¡å¤§å°ä»¥é€‚åº”ç¡¬ä»¶èµ„æºã€‚ parser.add_argument(&quot;--batch_size&quot;, type=int, default=16) # ä½œç”¨ ï¼šå®šä¹‰å­¦ä¹ ç‡ï¼Œé»˜è®¤å€¼ä¸º5e-5ã€‚ # ç”¨é€” ï¼šæ§åˆ¶ä¼˜åŒ–å™¨çš„æ­¥é•¿ã€‚ # æ‰©å±• ï¼š # æ”¯æŒå­¦ä¹ ç‡è°ƒåº¦ç­–ç•¥ï¼ˆå¦‚ä½™å¼¦é€€ç«ã€Warmupï¼‰ã€‚ parser.add_argument(&quot;--learning_rate&quot;, type=float, default=5e-5) # ä½œç”¨ ï¼šå®šä¹‰è®¾å¤‡ç±»å‹ï¼Œé»˜è®¤ä¼˜å…ˆä½¿ç”¨GPUã€‚ # ç”¨é€” ï¼šæŒ‡å®šæ¨¡å‹å’Œæ•°æ®æ‰€åœ¨çš„è®¾å¤‡ã€‚ # æ‰©å±• ï¼š # æ”¯æŒå¤šè®¾å¤‡åˆ‡æ¢ï¼ˆå¦‚CPUã€GPUã€TPUï¼‰ã€‚ parser.add_argument(&quot;--device&quot;, type=str, default=&quot;cuda:0&quot; if torch.cuda.is_available() else &quot;cpu&quot;) # ä½œç”¨ ï¼šå®šä¹‰æ•°æ®ç±»å‹ï¼Œé»˜è®¤å€¼ä¸ºbfloat16ã€‚ # ç”¨é€” ï¼šæ”¯æŒæ··åˆç²¾åº¦è®­ç»ƒã€‚ # æ‰©å±• ï¼š # åŠ¨æ€è°ƒæ•´ç²¾åº¦ï¼ˆå¦‚FP32ã€FP16ï¼‰ã€‚ parser.add_argument(&quot;--dtype&quot;, type=str, default=&quot;bfloat16&quot;) # ä½œç”¨ ï¼šå¯ç”¨WandBæ—¥å¿—è®°å½•ã€‚ # ç”¨é€” ï¼šç›‘æ§è®­ç»ƒè¿‡ç¨‹ã€‚ # æ‰©å±• ï¼š # æ”¯æŒå…¶ä»–æ—¥å¿—å·¥å…·ï¼ˆå¦‚TensorBoardï¼‰ã€‚ parser.add_argument(&quot;--use_wandb&quot;, action=&quot;store_true&quot;) # ä½œç”¨ ï¼šå®šä¹‰WandBé¡¹ç›®åç§°ã€‚ # ç”¨é€” ï¼šç»„ç»‡å’Œç®¡ç†å®éªŒã€‚ # æ‰©å±• ï¼š # åŠ¨æ€ç”Ÿæˆé¡¹ç›®åç§°ï¼ˆå¦‚æŒ‰ä»»åŠ¡ç±»å‹ï¼‰ã€‚ parser.add_argument(&quot;--wandb_project&quot;, type=str, default=&quot;MiniMind-LoRA-SFT&quot;) # ä½œç”¨ ï¼šå®šä¹‰æ•°æ®åŠ è½½çº¿ç¨‹æ•°ï¼Œé»˜è®¤å€¼ä¸º1ã€‚ # ç”¨é€” ï¼šåŠ é€Ÿæ•°æ®åŠ è½½ã€‚ # æ‰©å±• ï¼š # åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ•°ä»¥ä¼˜åŒ–æ€§èƒ½ã€‚ parser.add_argument(&quot;--num_workers&quot;, type=int, default=1) # ä½œç”¨ ï¼šå¯ç”¨åˆ†å¸ƒå¼è®­ç»ƒã€‚ # ç”¨é€” ï¼šæ”¯æŒå¤šGPUæˆ–å¤šèŠ‚ç‚¹è®­ç»ƒã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€åˆ†é…èµ„æºã€‚ parser.add_argument(&quot;--ddp&quot;, action=&quot;store_true&quot;) # ä½œç”¨ ï¼šå®šä¹‰æ¢¯åº¦ç´¯ç§¯æ­¥æ•°ï¼Œé»˜è®¤å€¼ä¸º1ã€‚ # ç”¨é€” ï¼šæ¨¡æ‹Ÿæ›´å¤§çš„æ‰¹æ¬¡å¤§å°ã€‚ # æ‰©å±• ï¼š # åŠ¨æ€è°ƒæ•´ç´¯ç§¯æ­¥æ•°ä»¥é€‚åº”æ˜¾å­˜é™åˆ¶ã€‚ parser.add_argument(&quot;--accumulation_steps&quot;, type=int, default=1) # ä½œç”¨ ï¼šå®šä¹‰æ¢¯åº¦è£å‰ªé˜ˆå€¼ï¼Œé»˜è®¤å€¼ä¸º1.0ã€‚ # ç”¨é€” ï¼šé˜²æ­¢æ¢¯åº¦çˆ†ç‚¸ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€è°ƒæ•´è£å‰ªé˜ˆå€¼ã€‚ parser.add_argument(&quot;--grad_clip&quot;, type=float, default=1.0) # ä½œç”¨ ï¼šå®šä¹‰Warmupæ­¥æ•°ï¼Œé»˜è®¤å€¼ä¸º0ã€‚ # ç”¨é€” ï¼šé€æ­¥å¢åŠ å­¦ä¹ ç‡ã€‚ # æ‰©å±• ï¼š # æ”¯æŒå¤šç§Warmupç­–ç•¥ï¼ˆå¦‚çº¿æ€§ã€æŒ‡æ•°ï¼‰ã€‚ parser.add_argument(&quot;--warmup_iters&quot;, type=int, default=0) # ä½œç”¨ ï¼šå®šä¹‰æ—¥å¿—è®°å½•é—´éš”ï¼Œé»˜è®¤å€¼ä¸º100ã€‚ # ç”¨é€” ï¼šå®šæœŸæ‰“å°è®­ç»ƒè¿›åº¦ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€è°ƒæ•´æ—¥å¿—é¢‘ç‡ã€‚ parser.add_argument(&quot;--log_interval&quot;, type=int, default=100) # ä½œç”¨ ï¼šå®šä¹‰æ¨¡å‹ä¿å­˜é—´éš”ï¼Œé»˜è®¤å€¼ä¸º1ã€‚ # ç”¨é€” ï¼šå®šæœŸä¿å­˜æ¨¡å‹æƒé‡ã€‚ # æ‰©å±• ï¼š # æ”¯æŒå¢é‡ä¿å­˜ã€‚ parser.add_argument(&quot;--save_interval&quot;, type=int, default=1) # ä½œç”¨ ï¼šå®šä¹‰æœ¬åœ°rankï¼Œé»˜è®¤å€¼ä¸º-1ã€‚ # ç”¨é€” ï¼šåˆ†å¸ƒå¼è®­ç»ƒä¸­çš„è¿›ç¨‹æ ‡è¯†ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€åˆ†é…rankã€‚ parser.add_argument('--local_rank', type=int, default=-1) # ä½œç”¨ ï¼šå®šä¹‰æ¨¡å‹ç»´åº¦ï¼Œé»˜è®¤å€¼ä¸º512ã€‚ # ç”¨é€” ï¼šæ§åˆ¶æ¨¡å‹å®¹é‡ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€è°ƒæ•´ç»´åº¦ã€‚ parser.add_argument('--dim', default=512, type=int) # ä½œç”¨ ï¼šå®šä¹‰æ¨¡å‹å±‚æ•°ï¼Œé»˜è®¤å€¼ä¸º8ã€‚ # ç”¨é€” ï¼šæ§åˆ¶æ¨¡å‹æ·±åº¦ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€è°ƒæ•´å±‚æ•°ã€‚ parser.add_argument('--n_layers', default=8, type=int) # ä½œç”¨ ï¼šå®šä¹‰æœ€å¤§åºåˆ—é•¿åº¦ï¼Œé»˜è®¤å€¼ä¸º512ã€‚ # ç”¨é€” ï¼šé™åˆ¶è¾“å…¥åºåˆ—é•¿åº¦ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€æˆªæ–­æˆ–å¡«å……ã€‚ parser.add_argument('--max_seq_len', default=512, type=int) # ä½œç”¨ ï¼šå¯ç”¨MoEï¼ˆMixture of Expertsï¼‰ï¼Œé»˜è®¤å€¼ä¸ºFalseã€‚ # ç”¨é€” ï¼šæé«˜æ¨¡å‹æ•ˆç‡ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€è°ƒæ•´ä¸“å®¶æ•°é‡ã€‚ parser.add_argument('--use_moe', default=False, type=bool) # ä½œç”¨ ï¼šå®šä¹‰æ•°æ®é›†è·¯å¾„ï¼Œé»˜è®¤å€¼ä¸º./dataset/lora_identity.jsonlã€‚ # ç”¨é€” ï¼šåŠ è½½è®­ç»ƒæ•°æ®ã€‚ # æ‰©å±• ï¼š # æ”¯æŒå¤šç§æ•°æ®æ ¼å¼ï¼ˆå¦‚CSVã€JSONï¼‰ã€‚ parser.add_argument(&quot;--data_path&quot;, type=str, default=&quot;./dataset/lora_identity.jsonl&quot;) # ä½œç”¨ ï¼šå®šä¹‰LoRAæƒé‡æ–‡ä»¶åï¼Œé»˜è®¤å€¼ä¸ºlora_identityã€‚ # ç”¨é€” ï¼šåŒºåˆ†ä¸åŒä»»åŠ¡çš„LoRAæƒé‡ã€‚ # æ‰©å±• ï¼š # åŠ¨æ€ç”Ÿæˆæ–‡ä»¶åã€‚ parser.add_argument(&quot;--lora_name&quot;, type=str, default=&quot;lora_identity&quot;, help=&quot;æ ¹æ®ä»»åŠ¡ä¿å­˜æˆlora_(è‹±æ–‡/åŒ»å­¦/å¿ƒç†...)&quot;) args = parser.parse_args() # ä½œç”¨ ï¼šåˆ›å»ºä¸€ä¸ª LMConfig å¯¹è±¡ï¼Œç”¨äºå®šä¹‰æ¨¡å‹çš„è¶…å‚æ•°ã€‚ # dimï¼šéšè—å±‚ç»´åº¦ã€‚ # n_layersï¼šæ¨¡å‹å±‚æ•°ã€‚ # max_seq_lenï¼šæœ€å¤§åºåˆ—é•¿åº¦ã€‚ # use_moeï¼šæ˜¯å¦å¯ç”¨ MoEï¼ˆMixture of Expertsï¼‰ã€‚ # ç”¨é€” ï¼šå°†å‘½ä»¤è¡Œå‚æ•°ä¼ é€’ç»™æ¨¡å‹é…ç½®å¯¹è±¡ï¼Œç¡®ä¿æ¨¡å‹åˆå§‹åŒ–æ—¶ä½¿ç”¨æ­£ç¡®çš„è¶…å‚æ•°ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€è°ƒæ•´æ¨¡å‹é…ç½®ï¼ˆå¦‚é€šè¿‡ JSON æˆ– YAML æ–‡ä»¶åŠ è½½é…ç½®ï¼‰ã€‚ # å¯ä»¥æ‰©å±•ä¸ºæ”¯æŒæ›´å¤šæ¨¡å‹ç±»å‹ï¼ˆå¦‚Transformerã€RNNç­‰ï¼‰ã€‚ lm_config = LMConfig(dim=args.dim, n_layers=args.n_layers, max_seq_len=args.max_seq_len, use_moe=args.use_moe) # ä½œç”¨ ï¼š # å°†ä¿å­˜ç›®å½•è·¯å¾„è®¾ç½®ä¸º args.out_dir çš„å­ç›®å½•ã€‚ # ä½¿ç”¨ os.makedirs ç¡®ä¿ä¿å­˜ç›®å½•å­˜åœ¨ã€‚å¦‚æœç›®å½•å·²å­˜åœ¨ï¼Œåˆ™ä¸ä¼šæŠ¥é”™ï¼ˆexist_ok=Trueï¼‰ã€‚ # ç”¨é€” ï¼šä¸ºæ¨¡å‹æƒé‡å’Œæ—¥å¿—æ–‡ä»¶åˆ›å»ºå­˜å‚¨è·¯å¾„ã€‚ # æ‰©å±• ï¼š # åŠ¨æ€ç”Ÿæˆå­ç›®å½•ï¼ˆå¦‚æŒ‰ä»»åŠ¡ç±»å‹æˆ–æ—¥æœŸï¼‰ã€‚ # æ”¯æŒåˆ†å¸ƒå¼è®­ç»ƒä¸­çš„ç‹¬ç«‹ä¿å­˜è·¯å¾„ï¼ˆå¦‚æŒ‰rankç¼–å·åŒºåˆ†ï¼‰ã€‚ args.save_dir = os.path.join(args.out_dir) os.makedirs(args.save_dir, exist_ok=True) os.makedirs(args.out_dir, exist_ok=True) # ä½œç”¨ ï¼šè®¡ç®—æ¯ä¸ªæ‰¹æ¬¡ä¸­åŒ…å«çš„tokenæ€»æ•°ã€‚ # ç”¨é€” ï¼šç›‘æ§è®­ç»ƒè¿‡ç¨‹ä¸­çš„æ•°æ®ååé‡ã€‚ # æ‰©å±• ï¼š # åŠ¨æ€è°ƒæ•´æ‰¹æ¬¡å¤§å°æˆ–åºåˆ—é•¿åº¦ä»¥ä¼˜åŒ–æ€§èƒ½ã€‚ # æ”¯æŒå¤šé˜¶æ®µè®­ç»ƒï¼ˆå¦‚Warmupé˜¶æ®µé€æ­¥å¢åŠ tokenæ•°é‡ï¼‰ã€‚ tokens_per_iter = args.batch_size * lm_config.max_seq_len # ä½œç”¨ ï¼šè®¾ç½®PyTorchçš„éšæœºç§å­ï¼Œç¡®ä¿å®éªŒç»“æœå¯å¤ç°ã€‚ # ç”¨é€” ï¼šæ§åˆ¶éšæœºæ€§ï¼Œé¿å…å› éšæœºåˆå§‹åŒ–å¯¼è‡´çš„å®éªŒå·®å¼‚ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€è®¾ç½®éšæœºç§å­ï¼ˆå¦‚é€šè¿‡å‘½ä»¤è¡Œå‚æ•°ä¼ é€’ï¼‰ã€‚ # ç¡®ä¿å…¶ä»–åº“ï¼ˆå¦‚NumPyã€randomï¼‰ä¹Ÿè®¾ç½®ç›¸åŒçš„éšæœºç§å­ã€‚ torch.manual_seed(1337) # ä½œç”¨ ï¼šæ ¹æ® args.device åˆ¤æ–­å½“å‰è®¾å¤‡ç±»å‹ï¼ˆGPUæˆ–CPUï¼‰ã€‚ # ç”¨é€” ï¼šç¡®ä¿åç»­æ“ä½œä¸è®¾å¤‡ç±»å‹åŒ¹é…ã€‚ # æ‰©å±• ï¼š # æ”¯æŒå¤šè®¾å¤‡åˆ‡æ¢ï¼ˆå¦‚TPUã€MPSï¼‰ã€‚ # åŠ¨æ€æ£€æµ‹å¯ç”¨è®¾å¤‡å¹¶è‡ªåŠ¨é€‰æ‹©ã€‚ device_type = &quot;cuda&quot; if &quot;cuda&quot; in args.device else &quot;cpu&quot; # ä½œç”¨ ï¼š # å¦‚æœè®¾å¤‡æ˜¯CPUï¼Œåˆ™ä½¿ç”¨é»˜è®¤ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆnullcontextï¼‰ã€‚ # å¦‚æœè®¾å¤‡æ˜¯GPUï¼Œåˆ™å¯ç”¨æ··åˆç²¾åº¦è®­ç»ƒï¼ˆtorch.cuda.amp.autocastï¼‰ã€‚ # ç”¨é€” ï¼šåœ¨GPUä¸ŠåŠ é€Ÿè®­ç»ƒå¹¶é™ä½æ˜¾å­˜å ç”¨ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€è°ƒæ•´ç²¾åº¦ï¼ˆå¦‚FP16ã€BF16ï¼‰ã€‚ # å…¼å®¹å…¶ä»–æ··åˆç²¾åº¦å·¥å…·ï¼ˆå¦‚Apexï¼‰ã€‚ ctx = nullcontext() if device_type == &quot;cpu&quot; else torch.cuda.amp.autocast() # ä½œç”¨ ï¼šæ£€æŸ¥ç¯å¢ƒå˜é‡ RANK æ˜¯å¦å­˜åœ¨ï¼Œåˆ¤æ–­æ˜¯å¦å¯ç”¨åˆ†å¸ƒå¼è®­ç»ƒã€‚ # ç”¨é€” ï¼šå†³å®šæ˜¯å¦éœ€è¦åˆå§‹åŒ–åˆ†å¸ƒå¼æ¨¡å¼ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€åˆ†é…åˆ†å¸ƒå¼é…ç½®ï¼ˆå¦‚è¿›ç¨‹æ•°ã€èŠ‚ç‚¹æ•°ï¼‰ã€‚ # å…¼å®¹å…¶ä»–åˆ†å¸ƒå¼æ¡†æ¶ï¼ˆå¦‚Horovodï¼‰ã€‚ ddp = int(os.environ.get(&quot;RANK&quot;, -1)) != -1 # is this a ddp run? # ä½œç”¨ ï¼š # å¦‚æœå¯ç”¨åˆ†å¸ƒå¼è®­ç»ƒï¼Œè°ƒç”¨ init_distributed_mode åˆå§‹åŒ–åˆ†å¸ƒå¼ç¯å¢ƒã€‚ # è®¾ç½®å½“å‰è¿›ç¨‹çš„è®¾å¤‡ä¸º DEVICEã€‚ # ç”¨é€” ï¼šç¡®ä¿åˆ†å¸ƒå¼è®­ç»ƒä¸­çš„æ¯ä¸ªè¿›ç¨‹ä½¿ç”¨ç‹¬ç«‹çš„GPUèµ„æºã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€åˆ†é…è®¾å¤‡ï¼ˆå¦‚æŒ‰è¿›ç¨‹ç¼–å·åˆ†é…GPUï¼‰ã€‚ # å…¼å®¹å¤šèŠ‚ç‚¹åˆ†å¸ƒå¼è®­ç»ƒã€‚ ddp_local_rank, DEVICE = 0, &quot;cuda:0&quot; if ddp: init_distributed_mode() args.device = torch.device(DEVICE) # ä½œç”¨ ï¼šç”ŸæˆWandBè¿è¡Œåç§°ï¼ŒåŒ…å«è®­ç»ƒè¶…å‚æ•°ä¿¡æ¯ã€‚ # ç”¨é€” ï¼šä¾¿äºåœ¨WandBä¸­åŒºåˆ†ä¸åŒå®éªŒã€‚ # æ‰©å±• ï¼š # åŠ¨æ€ç”Ÿæˆæ›´è¯¦ç»†çš„è¿è¡Œåç§°ï¼ˆå¦‚åŠ å…¥æ—¶é—´æˆ³æˆ–ä»»åŠ¡ç±»å‹ï¼‰ã€‚ # æ”¯æŒè‡ªå®šä¹‰å‘½åè§„åˆ™ã€‚ args.wandb_run_name = f&quot;MiniMind-Lora-SFT-Epoch-{args.epochs}-BatchSize-{args.batch_size}-LearningRate-{args.learning_rate}&quot; # ä½œç”¨ ï¼š # å¦‚æœå¯ç”¨äº†WandBä¸”å½“å‰è¿›ç¨‹ä¸ºä¸»è¿›ç¨‹ï¼ˆddp_local_rank == 0ï¼‰ï¼Œåˆå§‹åŒ–WandBã€‚ # å¦åˆ™ï¼Œå°† wandb è®¾ç½®ä¸º Noneã€‚ # ç”¨é€” ï¼šè®°å½•è®­ç»ƒè¿‡ç¨‹ä¸­çš„æŒ‡æ ‡ï¼ˆå¦‚æŸå¤±ã€å­¦ä¹ ç‡ï¼‰ã€‚ # æ‰©å±• ï¼š # æ”¯æŒå…¶ä»–æ—¥å¿—å·¥å…·ï¼ˆå¦‚TensorBoardã€MLflowï¼‰ã€‚ # åŠ¨æ€è°ƒæ•´æ—¥å¿—é¢‘ç‡æˆ–å†…å®¹ã€‚ if args.use_wandb and (not ddp or ddp_local_rank == 0): import wandb wandb.init(project=args.wandb_project, name=args.wandb_run_name) else: wandb = None # ä½œç”¨ ï¼šè°ƒç”¨ init_model å‡½æ•°åŠ è½½é¢„è®­ç»ƒæ¨¡å‹å’Œåˆ†è¯å™¨ã€‚ # ç”¨é€” ï¼šå‡†å¤‡æ¨¡å‹å’Œæ•°æ®å¤„ç†å·¥å…·ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€åŠ è½½ä¸åŒç‰ˆæœ¬çš„é¢„è®­ç»ƒæ¨¡å‹ã€‚ # å…¼å®¹å¤šç§åˆ†è¯å™¨ï¼ˆå¦‚BERTã€GPTï¼‰ã€‚ model, tokenizer = init_model(lm_config) # ä½œç”¨ ï¼šå°†LoRAæ¨¡å—æ’å…¥åˆ°æ¨¡å‹ä¸­ã€‚ # ç”¨é€” ï¼šå®ç°ä½ç§©åˆ†è§£å¾®è°ƒï¼Œå‡å°‘å‚æ•°é‡ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€è°ƒæ•´LoRAçš„ç§©ï¼ˆrankï¼‰ã€‚ # å…¼å®¹å…¶ä»–é«˜æ•ˆå¾®è°ƒæ–¹æ³•ï¼ˆå¦‚Adapterã€Prefix Tuningï¼‰ apply_lora(model) # ä½œç”¨ ï¼š # ç»Ÿè®¡æ¨¡å‹çš„æ€»å‚æ•°é‡ã€‚ # ç»Ÿè®¡LoRAæ¨¡å—çš„å‚æ•°é‡ã€‚ # ç”¨é€” ï¼šè¯„ä¼°æ¨¡å‹è§„æ¨¡å’ŒLoRAçš„æ•ˆç‡ã€‚ # æ‰©å±• ï¼š # æ”¯æŒç»Ÿè®¡å…¶ä»–æ¨¡å—çš„å‚æ•°é‡ï¼ˆå¦‚MoEã€Attentionï¼‰ã€‚ # åŠ¨æ€è°ƒæ•´LoRAå‚æ•°å æ¯”ã€‚ total_params = sum(p.numel() for p in model.parameters()) # æ€»å‚æ•°æ•°é‡ lora_params_count = sum(p.numel() for name, p in model.named_parameters() if 'lora' in name) # LoRA å‚æ•°æ•°é‡ if not ddp or dist.get_rank() == 0: print(f&quot;LLM æ€»å‚æ•°é‡: {total_params}&quot;) print(f&quot;LoRA å‚æ•°é‡: {lora_params_count}&quot;) print(f&quot;LoRA å‚æ•°å æ¯”: {lora_params_count / total_params * 100:.2f}%&quot;) # ä½œç”¨ ï¼šå†»ç»“æ‰€æœ‰éLoRAå‚æ•°ï¼Œä»…å¯¹LoRAå‚æ•°è¿›è¡Œä¼˜åŒ–ã€‚ # ç”¨é€” ï¼šå‡å°‘è®­ç»ƒæ‰€éœ€çš„æ˜¾å­˜å’Œè®¡ç®—èµ„æºã€‚ # æ‰©å±• ï¼š # æ”¯æŒéƒ¨åˆ†å†»ç»“ï¼ˆå¦‚å†»ç»“Embeddingå±‚ï¼‰ã€‚ # åŠ¨æ€è°ƒæ•´å†»ç»“ç­–ç•¥ã€‚ for name, param in model.named_parameters(): if 'lora' not in name: param.requires_grad = False # ä½œç”¨ ï¼šæå–æ‰€æœ‰LoRAå‚æ•°ã€‚ # ç”¨é€” ï¼šä¸ºä¼˜åŒ–å™¨æä¾›å¾…ä¼˜åŒ–çš„å‚æ•°åˆ—è¡¨ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€è°ƒæ•´ä¼˜åŒ–å‚æ•°ï¼ˆå¦‚åŠ å…¥æ­£åˆ™åŒ–é¡¹ï¼‰ã€‚ # å…¼å®¹å…¶ä»–ä¼˜åŒ–å™¨ï¼ˆå¦‚LAMBã€Rangerï¼‰ã€‚ lora_params = [] for name, param in model.named_parameters(): if 'lora' in name: lora_params.append(param) # åªå¯¹ LoRA å‚æ•°è¿›è¡Œä¼˜åŒ– # ä½œç”¨ ï¼šå®šä¹‰AdamWä¼˜åŒ–å™¨ï¼Œä»…ä¼˜åŒ–LoRAå‚æ•°ã€‚ # ç”¨é€” ï¼šæ›´æ–°æ¨¡å‹å‚æ•°ä»¥æœ€å°åŒ–æŸå¤±ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€è°ƒæ•´å­¦ä¹ ç‡ï¼ˆå¦‚ä½™å¼¦é€€ç«ã€Warmupï¼‰ã€‚ # å…¼å®¹å…¶ä»–ä¼˜åŒ–ç®—æ³•ï¼ˆå¦‚SGDã€Adagradï¼‰ã€‚ optimizer = optim.AdamW(lora_params, lr=args.learning_rate) # ä½œç”¨ ï¼šåŠ è½½è®­ç»ƒæ•°æ®é›†ï¼Œä½¿ç”¨æŒ‡å®šçš„åˆ†è¯å™¨å’Œæœ€å¤§åºåˆ—é•¿åº¦ã€‚ # ç”¨é€” ï¼šå‡†å¤‡è®­ç»ƒæ•°æ®ã€‚ # æ‰©å±• ï¼š # æ”¯æŒå¤šç§æ•°æ®æ ¼å¼ï¼ˆå¦‚CSVã€JSONï¼‰ã€‚ # åŠ¨æ€è°ƒæ•´æ•°æ®å¢å¼ºç­–ç•¥ã€‚ train_ds = SFTDataset(args.data_path, tokenizer, max_length=lm_config.max_seq_len) # ä½œç”¨ ï¼šå¦‚æœå¯ç”¨åˆ†å¸ƒå¼è®­ç»ƒï¼Œå®šä¹‰åˆ†å¸ƒå¼é‡‡æ ·å™¨ï¼›å¦åˆ™ä¸º Noneã€‚ # ç”¨é€” ï¼šç¡®ä¿æ¯ä¸ªè¿›ç¨‹å¤„ç†ä¸åŒçš„æ•°æ®å­é›†ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€è°ƒæ•´é‡‡æ ·ç­–ç•¥ï¼ˆå¦‚åŠ æƒé‡‡æ ·ï¼‰ã€‚ # å…¼å®¹å…¶ä»–åˆ†å¸ƒå¼æ¡†æ¶ã€‚ train_sampler = DistributedSampler(train_ds) if ddp else None # ä½œç”¨ ï¼šå®šä¹‰æ•°æ®åŠ è½½å™¨ï¼Œç”¨äºæ‰¹é‡åŠ è½½è®­ç»ƒæ•°æ®ã€‚ # ç”¨é€” ï¼šåŠ é€Ÿæ•°æ®åŠ è½½å¹¶æé«˜è®­ç»ƒæ•ˆç‡ã€‚ # æ‰©å±• ï¼š # åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ•°ï¼ˆnum_workersï¼‰ä»¥ä¼˜åŒ–æ€§èƒ½ã€‚ # æ”¯æŒåŠ¨æ€è°ƒæ•´æ‰¹æ¬¡å¤§å°ã€‚ train_loader = DataLoader( train_ds, batch_size=args.batch_size, pin_memory=True, drop_last=False, shuffle=False, num_workers=args.num_workers, sampler=train_sampler ) # ä½œç”¨ ï¼šå®šä¹‰æ¢¯åº¦ç¼©æ”¾å™¨ï¼Œç”¨äºæ··åˆç²¾åº¦è®­ç»ƒã€‚ # ç”¨é€” ï¼šé˜²æ­¢æ¢¯åº¦ä¸‹æº¢ï¼Œæé«˜è®­ç»ƒç¨³å®šæ€§ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€è°ƒæ•´ç²¾åº¦ï¼ˆå¦‚FP32ã€FP16ï¼‰ã€‚ # å…¼å®¹å…¶ä»–æ··åˆç²¾åº¦å·¥å…·ã€‚ scaler = torch.cuda.amp.GradScaler(enabled=(args.dtype in ['float16', 'bfloat16'])) # ä½œç”¨ ï¼šè®¡ç®—æ¯ä¸ªepochä¸­çš„è¿­ä»£æ¬¡æ•°ã€‚ # ç”¨é€” ï¼šç›‘æ§è®­ç»ƒè¿›åº¦ã€‚ # æ‰©å±• ï¼š # åŠ¨æ€è°ƒæ•´è¿­ä»£æ¬¡æ•°ï¼ˆå¦‚æŒ‰æ•°æ®é‡å˜åŒ–ï¼‰ã€‚ iter_per_epoch = len(train_loader) # ä½œç”¨ ï¼šéå†æ¯ä¸ªepochï¼Œè°ƒç”¨ train_epoch è¿›è¡Œè®­ç»ƒã€‚ # ç”¨é€” ï¼šå®Œæˆæ•´ä¸ªè®­ç»ƒè¿‡ç¨‹ã€‚ # æ‰©å±• ï¼š # æ”¯æŒæ—©åœæœºåˆ¶ï¼ˆå¦‚éªŒè¯é›†æ€§èƒ½ä¸å†æå‡æ—¶åœæ­¢è®­ç»ƒï¼‰ã€‚ # åŠ¨æ€è°ƒæ•´è®­ç»ƒç­–ç•¥ï¼ˆå¦‚å­¦ä¹ ç‡è°ƒåº¦ï¼‰ã€‚ for epoch in range(args.epochs): train_epoch(epoch, wandb) # ä½œç”¨ ï¼š # torchï¼šPyTorchæ ¸å¿ƒåº“ï¼Œç”¨äºå¼ é‡æ“ä½œå’Œç¥ç»ç½‘ç»œåŠŸèƒ½ã€‚ # optim å’Œ nnï¼šåˆ†åˆ«æä¾›ä¼˜åŒ–å™¨å’Œç¥ç»ç½‘ç»œæ¨¡å—çš„æ”¯æŒã€‚ # ç”¨é€” ï¼š # æä¾›LoRAå®ç°æ‰€éœ€çš„å·¥å…·å’Œæ¥å£ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€åŠ è½½ä¸åŒç‰ˆæœ¬çš„PyTorchã€‚ # å¢åŠ æ›´å¤šè‡ªå®šä¹‰æ¨¡å—æˆ–å·¥å…·ã€‚ import torch from torch import nn # å®šä¹‰Loraç½‘ç»œç»“æ„ class LoRA(nn.Module): # ä½œç”¨ ï¼š # å®šä¹‰ä¸€ä¸ªLoRAæ¨¡å—ï¼Œç»§æ‰¿è‡ª nn.Moduleã€‚ # åˆå§‹åŒ–æ—¶è®¾ç½®è¾“å…¥ç‰¹å¾æ•°ï¼ˆin_featuresï¼‰ã€è¾“å‡ºç‰¹å¾æ•°ï¼ˆout_featuresï¼‰å’Œç§©ï¼ˆrankï¼‰ã€‚ # ä½¿ç”¨ä¸¤ä¸ªçº¿æ€§å±‚ï¼ˆA å’Œ Bï¼‰å®ç°ä½ç§©åˆ†è§£ã€‚ # ç”¨é€” ï¼š # æä¾›é«˜æ•ˆçš„å‚æ•°å¾®è°ƒèƒ½åŠ›ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€è°ƒæ•´ç§©ï¼ˆrankï¼‰ã€‚ # å¢åŠ å¯¹åç½®é¡¹çš„æ”¯æŒã€‚ def __init__(self, in_features, out_features, rank): super().__init__() self.rank = rank # LoRAçš„ç§©ï¼ˆrankï¼‰ï¼Œæ§åˆ¶ä½ç§©çŸ©é˜µçš„å¤§å° self.A = nn.Linear(in_features, rank, bias=False) # ä½ç§©çŸ©é˜µA self.B = nn.Linear(rank, out_features, bias=False) # ä½ç§©çŸ©é˜µB # çŸ©é˜µAé«˜æ–¯åˆå§‹åŒ– self.A.weight.data.normal_(mean=0.0, std=0.02) # çŸ©é˜µBå…¨0åˆå§‹åŒ– self.B.weight.data.zero_() # ä½œç”¨ ï¼š # å®ç°LoRAæ¨¡å—çš„å‰å‘ä¼ æ’­é€»è¾‘ã€‚ # è¾“å…¥é€šè¿‡ä½ç§©çŸ©é˜µ A å’Œ B è¿›è¡Œå˜æ¢ã€‚ # ç”¨é€” ï¼š # æä¾›ä½ç§©åˆ†è§£çš„è®¡ç®—èƒ½åŠ›ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€è°ƒæ•´æ¿€æ´»å‡½æ•°ã€‚ # å¢åŠ å¯¹å¤šåˆ†æ”¯ç»“æ„çš„æ”¯æŒã€‚ def forward(self, x): return self.B(self.A(x)) # ä½œç”¨ ï¼š # éå†æ¨¡å‹çš„æ‰€æœ‰æ¨¡å—ï¼Œæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„çº¿æ€§å±‚ï¼ˆæƒé‡ä¸ºæ–¹é˜µï¼‰ã€‚ # ä¸ºç¬¦åˆæ¡ä»¶çš„çº¿æ€§å±‚æ·»åŠ LoRAæ¨¡å—ï¼Œå¹¶ä¿®æ”¹å…¶å‰å‘ä¼ æ’­é€»è¾‘ã€‚ # ç”¨é€” ï¼š # åœ¨ç°æœ‰æ¨¡å‹ä¸­æ’å…¥LoRAæ¨¡å—ï¼Œå®ç°é«˜æ•ˆå¾®è°ƒã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€è°ƒæ•´ç­›é€‰æ¡ä»¶ï¼ˆå¦‚ä»…å¯¹ç‰¹å®šå±‚åº”ç”¨LoRAï¼‰ã€‚ # å¢åŠ å¯¹å…¶ä»–ç±»å‹å±‚ï¼ˆå¦‚å·ç§¯å±‚ï¼‰çš„æ”¯æŒã€‚ def apply_lora(model, rank=16): for name, module in model.named_modules(): if isinstance(module, nn.Linear) and module.weight.shape[0] == module.weight.shape[1]: lora = LoRA(module.weight.shape[0], module.weight.shape[1], rank=rank).to(model.device) setattr(module, &quot;lora&quot;, lora) original_forward = module.forward # æ˜¾å¼ç»‘å®š def forward_with_lora(x, layer1=original_forward, layer2=lora): return layer1(x) + layer2(x) module.forward = forward_with_lora # ä½œç”¨ ï¼š # ä»æŒ‡å®šè·¯å¾„åŠ è½½LoRAæƒé‡ã€‚ # å°†æƒé‡åŠ è½½åˆ°æ¨¡å‹ä¸­å¯¹åº”çš„LoRAæ¨¡å—ã€‚ # ç”¨é€” ï¼š # æ¢å¤LoRAæ¨¡å—çš„è®­ç»ƒçŠ¶æ€ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€è°ƒæ•´åŠ è½½è·¯å¾„ã€‚ # å¢åŠ å¯¹å¤šç§æ–‡ä»¶æ ¼å¼çš„æ”¯æŒã€‚ def load_lora(model, path): state_dict = torch.load(path, map_location=model.device) for name, module in model.named_modules(): if hasattr(module, 'lora'): lora_state = {k.replace(f'{name}.lora.', ''): v for k, v in state_dict.items() if f'{name}.lora.' in k} module.lora.load_state_dict(lora_state) # ä½œç”¨ ï¼š # éå†æ¨¡å‹çš„æ‰€æœ‰æ¨¡å—ï¼Œæå–LoRAæ¨¡å—çš„æƒé‡ã€‚ # å°†æƒé‡ä¿å­˜åˆ°æŒ‡å®šè·¯å¾„ã€‚ # ç”¨é€” ï¼š # ä¿å­˜LoRAæ¨¡å—çš„è®­ç»ƒçŠ¶æ€ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€è°ƒæ•´ä¿å­˜è·¯å¾„ã€‚ # å¢åŠ å¯¹å‹ç¼©å­˜å‚¨çš„æ”¯æŒã€‚ def save_lora(model, path): state_dict = {} for name, module in model.named_modules(): if hasattr(module, 'lora'): lora_state = {f'{name}.lora.{k}': v for k, v in module.lora.state_dict().items()} state_dict.update(lora_state) torch.save(state_dict, path) # ä½œç”¨ ï¼šä» transformers åº“ä¸­å¯¼å…¥ PretrainedConfig åŸºç±»ã€‚ # ç”¨é€” ï¼šç”¨äºå®šä¹‰æ¨¡å‹é…ç½®ç±»ï¼Œç»§æ‰¿è‡ª PretrainedConfigã€‚ # æ‰©å±• ï¼š # æ”¯æŒå…¶ä»–åŸºç±»ï¼ˆå¦‚è‡ªå®šä¹‰é…ç½®ç±»ï¼‰ã€‚ # åŠ¨æ€åŠ è½½ä¸åŒç‰ˆæœ¬çš„ transformersã€‚ from transformers import PretrainedConfig # ä½œç”¨ ï¼š # å®šä¹‰ä¸€ä¸ªåä¸º LMConfig çš„æ¨¡å‹é…ç½®ç±»ï¼Œç»§æ‰¿è‡ª PretrainedConfigã€‚ # è®¾ç½® model_type ä¸º &quot;minimind&quot;ï¼Œç”¨äºæ ‡è¯†æ¨¡å‹ç±»å‹ã€‚ # ç”¨é€” ï¼š # é…ç½®æ¨¡å‹çš„è¶…å‚æ•°ã€‚ # æä¾›æ ‡å‡†åŒ–çš„æ¥å£ï¼Œä¾¿äºä¸ transformers ç”Ÿæ€é›†æˆã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€è°ƒæ•´ model_typeã€‚ # å…¼å®¹å¤šç§æ¨¡å‹æ¶æ„ class LMConfig(PretrainedConfig): model_type = &quot;minimind&quot; # ä½œç”¨ ï¼š # å®šä¹‰åˆå§‹åŒ–æ–¹æ³•ï¼Œæ¥å—å¤šä¸ªè¶…å‚æ•°ä½œä¸ºè¾“å…¥ã€‚ # æ¯ä¸ªå‚æ•°éƒ½æœ‰é»˜è®¤å€¼ï¼Œç¡®ä¿åœ¨æœªæŒ‡å®šæ—¶ä½¿ç”¨é»˜è®¤é…ç½®ã€‚ # ç”¨é€” ï¼š # é…ç½®æ¨¡å‹çš„æ ¸å¿ƒè¶…å‚æ•°ã€‚ # æ”¯æŒçµæ´»çš„å‚æ•°è®¾ç½®ï¼Œé€‚é…ä¸åŒçš„ä»»åŠ¡éœ€æ±‚ã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€è°ƒæ•´å‚æ•°èŒƒå›´ã€‚ # å¢åŠ æ›´å¤šè¶…å‚æ•°ï¼ˆå¦‚æ­£åˆ™åŒ–é¡¹ã€ä¼˜åŒ–å™¨é…ç½®ï¼‰ã€‚ def __init__( self, dim: int = 512, n_layers: int = 8, n_heads: int = 8, n_kv_heads: int = 2, vocab_size: int = 6400, hidden_dim: int = None, multiple_of: int = 64, norm_eps: float = 1e-5, max_seq_len: int = 8192, rope_theta: int = 1e6, dropout: float = 0.0, flash_attn: bool = True, #################################################### # Here are the specific configurations of MOE # When use_moe is false, the following is invalid #################################################### use_moe: bool = False, #################################################### num_experts_per_tok: int = 2, n_routed_experts: int = 4, n_shared_experts: bool = True, scoring_func: str = 'softmax', aux_loss_alpha: float = 0.1, seq_aux: bool = True, norm_topk_prob: bool = True, **kwargs, ): # ä½œç”¨ ï¼š # å°†ä¼ å…¥çš„å‚æ•°èµ‹å€¼ç»™ç±»å±æ€§ã€‚ # æ¯ä¸ªå‚æ•°å¯¹åº”æ¨¡å‹çš„ä¸€ä¸ªæ ¸å¿ƒè¶…å‚æ•°ã€‚ # ç”¨é€” ï¼š # é…ç½®æ¨¡å‹çš„ç»“æ„å’Œè¡Œä¸ºã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€è°ƒæ•´å‚æ•°å€¼ï¼ˆå¦‚é€šè¿‡å‘½ä»¤è¡Œæˆ–é…ç½®æ–‡ä»¶ï¼‰ã€‚ # å¢åŠ æ›´å¤šè¶…å‚æ•°ï¼ˆå¦‚æ¿€æ´»å‡½æ•°ç±»å‹ã€å½’ä¸€åŒ–æ–¹å¼ï¼‰ã€‚ self.dim = dim self.n_layers = n_layers self.n_heads = n_heads self.n_kv_heads = n_kv_heads self.vocab_size = vocab_size self.hidden_dim = hidden_dim self.multiple_of = multiple_of self.norm_eps = norm_eps self.max_seq_len = max_seq_len self.rope_theta = rope_theta self.dropout = dropout self.flash_attn = flash_attn # ä½œç”¨ ï¼š # é…ç½®æ··åˆä¸“å®¶ï¼ˆMoEï¼‰æ¨¡å—çš„ç›¸å…³å‚æ•°ã€‚ # å½“ use_moe=False æ—¶ï¼Œè¿™äº›å‚æ•°æ— æ•ˆã€‚ # ç”¨é€” ï¼š # æ§åˆ¶MoEæ¨¡å—çš„è¡Œä¸ºã€‚ # æ‰©å±• ï¼š # æ”¯æŒåŠ¨æ€å¯ç”¨æˆ–ç¦ç”¨MoEã€‚ # å¢åŠ æ›´å¤šMoEç›¸å…³å‚æ•°ï¼ˆå¦‚ä¸“å®¶å®¹é‡ã€è·¯ç”±ç­–ç•¥ï¼‰ã€‚ #################################################### # Here are the specific configurations of MOE # When use_moe is false, the following is invalid #################################################### self.use_moe = use_moe self.num_experts_per_tok = num_experts_per_tok # æ¯ä¸ªtokené€‰æ‹©çš„ä¸“å®¶æ•°é‡ self.n_routed_experts = n_routed_experts # æ€»çš„ä¸“å®¶æ•°é‡ self.n_shared_experts = n_shared_experts # å…±äº«ä¸“å®¶ self.scoring_func = scoring_func # è¯„åˆ†å‡½æ•°ï¼Œé»˜è®¤ä¸º'softmax' self.aux_loss_alpha = aux_loss_alpha # è¾…åŠ©æŸå¤±çš„alphaå‚æ•° self.seq_aux = seq_aux # æ˜¯å¦åœ¨åºåˆ—çº§åˆ«ä¸Šè®¡ç®—è¾…åŠ©æŸå¤± self.norm_topk_prob = norm_topk_prob # æ˜¯å¦æ ‡å‡†åŒ–top-kæ¦‚ç‡ super().__init__(**kwargs) è®­ç»ƒåçš„æ¨¡å‹æƒé‡æ–‡ä»¶é»˜è®¤æ¯éš”100æ­¥ä¿å­˜ä¸º: lora_xxx_*.pthï¼ˆ*ä¸ºæ¨¡å‹å…·ä½“dimensionï¼Œæ¯æ¬¡ä¿å­˜æ—¶æ–°æ–‡ä»¶ä¼šè¦†ç›–æ—§æ–‡ä»¶ï¼‰ éå¸¸å¤šçš„äººå›°æƒ‘ï¼Œå¦‚ä½•ä½¿æ¨¡å‹å­¦ä¼šè‡ªå·±ç§æœ‰é¢†åŸŸçš„çŸ¥è¯†ï¼Ÿå¦‚ä½•å‡†å¤‡æ•°æ®é›†ï¼Ÿå¦‚ä½•è¿ç§»é€šç”¨é¢†åŸŸæ¨¡å‹æ‰“é€ å‚åŸŸæ¨¡å‹ï¼Ÿ è¿™é‡Œä¸¾å‡ ä¸ªä¾‹å­ï¼Œå¯¹äºé€šç”¨æ¨¡å‹ï¼ŒåŒ»å­¦é¢†åŸŸçŸ¥è¯†æ¬ ç¼ºï¼Œå¯ä»¥å°è¯•åœ¨åŸæœ‰æ¨¡å‹åŸºç¡€ä¸ŠåŠ å…¥é¢†åŸŸçŸ¥è¯†ï¼Œä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚ åŒæ—¶ï¼Œæˆ‘ä»¬é€šå¸¸ä¸å¸Œæœ›å­¦ä¼šé¢†åŸŸçŸ¥è¯†çš„åŒæ—¶æŸå¤±åŸæœ‰åŸºç¡€æ¨¡å‹çš„å…¶å®ƒèƒ½åŠ›ï¼Œæ­¤æ—¶LoRAå¯ä»¥å¾ˆå¥½çš„æ”¹å–„è¿™ä¸ªé—®é¢˜ã€‚ åªéœ€è¦å‡†å¤‡å¦‚ä¸‹æ ¼å¼çš„å¯¹è¯æ•°æ®é›†æ”¾ç½®åˆ°./dataset/lora_xxx.jsonlï¼Œå¯åŠ¨ python train_lora.py è®­ç»ƒå³å¯å¾—åˆ°./out/lora/lora_xxx.pthæ–°æ¨¡å‹æƒé‡ã€‚ åŒ»ç–—åœºæ™¯ {&quot;conversations&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;è¯·é—®é¢ˆæ¤ç—…çš„äººæ•å¤´å¤šé«˜æ‰æœ€å¥½ï¼Ÿ&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;é¢ˆæ¤ç—…æ‚£è€…é€‰æ‹©æ•å¤´çš„é«˜åº¦åº”è¯¥æ ¹æ®...&quot;}]} {&quot;conversations&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;è¯·é—®xxx&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;xxx...&quot;}]} è‡ªæˆ‘è®¤çŸ¥åœºæ™¯ {&quot;conversations&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;ä½ å«ä»€ä¹ˆåå­—ï¼Ÿ&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;æˆ‘å«minimind...&quot;}]} {&quot;conversations&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;ä½ æ˜¯è°&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;æˆ‘æ˜¯...&quot;}]} æ­¤æ—¶ã€åŸºç¡€æ¨¡å‹+LoRAæ¨¡å‹ã€‘å³å¯è·å¾—åŒ»ç–—åœºæ™¯æ¨¡å‹å¢å¼ºçš„èƒ½åŠ›ï¼Œç›¸å½“äºä¸ºåŸºç¡€æ¨¡å‹å¢åŠ äº†LoRAå¤–æŒ‚ï¼Œè¿™ä¸ªè¿‡ç¨‹å¹¶ä¸æŸå¤±åŸºç¡€æ¨¡å‹çš„æœ¬èº«èƒ½åŠ›ã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡eval_model.pyè¿›è¡Œæ¨¡å‹è¯„ä¼°æµ‹è¯•ã€‚ import argparse import random import time import numpy as np import torch import warnings from transformers import AutoTokenizer, AutoModelForCausalLM from model.model import MiniMindLM from model.LMConfig import LMConfig from model.model_lora import * warnings.filterwarnings('ignore') def init_model(args): tokenizer = AutoTokenizer.from_pretrained(r'C:\\study\\minimind-master\\model\\minimind_tokenizer') if args.load == 0: moe_path = '_moe' if args.use_moe else '' modes = {0: 'pretrain', 1: 'full_sft', 2: 'rlhf', 3: 'reason'} ckp = f'./{args.out_dir}/{modes[args.model_mode]}_{args.dim}{moe_path}.pth' model = MiniMindLM(LMConfig( dim=args.dim, n_layers=args.n_layers, max_seq_len=args.max_seq_len, use_moe=args.use_moe )) state_dict = torch.load(ckp, map_location=args.device) model.load_state_dict({k: v for k, v in state_dict.items() if 'mask' not in k}, strict=True) if args.lora_name != 'None': apply_lora(model) load_lora(model, f'./{args.out_dir}/lora/{args.lora_name}_{args.dim}.pth') else: model = AutoModelForCausalLM.from_pretrained( r'C:\\study\\minimind-master\\MiniMind2', trust_remote_code=True ) print(f'MiniMindæ¨¡å‹å‚æ•°é‡: {sum(p.numel() for p in model.parameters() if p.requires_grad) / 1e6:.2f}M(illion)') return model.eval().to(args.device), tokenizer def get_prompt_datas(args): if args.model_mode == 0: # pretrainæ¨¡å‹çš„æ¥é¾™èƒ½åŠ›ï¼ˆæ— æ³•å¯¹è¯ï¼‰ prompt_datas = [ 'é©¬å…‹æ€ä¸»ä¹‰åŸºæœ¬åŸç†', 'äººç±»å¤§è„‘çš„ä¸»è¦åŠŸèƒ½', 'ä¸‡æœ‰å¼•åŠ›åŸç†æ˜¯', 'ä¸–ç•Œä¸Šæœ€é«˜çš„å±±å³°æ˜¯', 'äºŒæ°§åŒ–ç¢³åœ¨ç©ºæ°”ä¸­', 'åœ°çƒä¸Šæœ€å¤§çš„åŠ¨ç‰©æœ‰', 'æ­å·å¸‚çš„ç¾é£Ÿæœ‰' ] else: if args.lora_name == 'None': # é€šç”¨å¯¹è¯é—®é¢˜ prompt_datas = [ 'è¯·ä»‹ç»ä¸€ä¸‹è‡ªå·±ã€‚', 'ä½ æ›´æ“…é•¿å“ªä¸€ä¸ªå­¦ç§‘ï¼Ÿ', 'é²è¿…çš„ã€Šç‹‚äººæ—¥è®°ã€‹æ˜¯å¦‚ä½•æ‰¹åˆ¤å°å»ºç¤¼æ•™çš„ï¼Ÿ', 'æˆ‘å’³å—½å·²ç»æŒç»­äº†ä¸¤å‘¨ï¼Œéœ€è¦å»åŒ»é™¢æ£€æŸ¥å—ï¼Ÿ', 'è¯¦ç»†çš„ä»‹ç»å…‰é€Ÿçš„ç‰©ç†æ¦‚å¿µã€‚', 'æ¨èä¸€äº›æ­å·çš„ç‰¹è‰²ç¾é£Ÿå§ã€‚', 'è¯·ä¸ºæˆ‘è®²è§£â€œå¤§è¯­è¨€æ¨¡å‹â€è¿™ä¸ªæ¦‚å¿µã€‚', 'å¦‚ä½•ç†è§£ChatGPTï¼Ÿ', 'Introduce the history of the United States, please.' ] else: # ç‰¹å®šé¢†åŸŸé—®é¢˜ lora_prompt_datas = { 'lora_identity': [ &quot;ä½ æ˜¯ChatGPTå§ã€‚&quot;, &quot;ä½ å«ä»€ä¹ˆåå­—ï¼Ÿ&quot;, &quot;ä½ å’Œopenaiæ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ&quot; ], 'lora_medical': [ 'æˆ‘æœ€è¿‘ç»å¸¸æ„Ÿåˆ°å¤´æ™•ï¼Œå¯èƒ½æ˜¯ä»€ä¹ˆåŸå› ï¼Ÿ', 'æˆ‘å’³å—½å·²ç»æŒç»­äº†ä¸¤å‘¨ï¼Œéœ€è¦å»åŒ»é™¢æ£€æŸ¥å—ï¼Ÿ', 'æœç”¨æŠ—ç”Ÿç´ æ—¶éœ€è¦æ³¨æ„å“ªäº›äº‹é¡¹ï¼Ÿ', 'ä½“æ£€æŠ¥å‘Šä¸­æ˜¾ç¤ºèƒ†å›ºé†‡åé«˜ï¼Œæˆ‘è¯¥æ€ä¹ˆåŠï¼Ÿ', 'å­•å¦‡åœ¨é¥®é£Ÿä¸Šéœ€è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ', 'è€å¹´äººå¦‚ä½•é¢„é˜²éª¨è´¨ç–æ¾ï¼Ÿ', 'æˆ‘æœ€è¿‘æ€»æ˜¯æ„Ÿåˆ°ç„¦è™‘ï¼Œåº”è¯¥æ€ä¹ˆç¼“è§£ï¼Ÿ', 'å¦‚æœæœ‰äººçªç„¶æ™•å€’ï¼Œåº”è¯¥å¦‚ä½•æ€¥æ•‘ï¼Ÿ' ], } prompt_datas = lora_prompt_datas[args.lora_name] return prompt_datas # è®¾ç½®å¯å¤ç°çš„éšæœºç§å­ def setup_seed(seed): random.seed(seed) np.random.seed(seed) torch.manual_seed(seed) torch.cuda.manual_seed(seed) torch.cuda.manual_seed_all(seed) torch.backends.cudnn.deterministic = True torch.backends.cudnn.benchmark = False def main(): parser = argparse.ArgumentParser(description=&quot;Chat with MiniMind&quot;) parser.add_argument('--lora_name', default='None', type=str) parser.add_argument('--out_dir', default='out', type=str) parser.add_argument('--temperature', default=0.85, type=float) parser.add_argument('--top_p', default=0.85, type=float) parser.add_argument('--device', default='cuda' if torch.cuda.is_available() else 'cpu', type=str) # æ­¤å¤„max_seq_lenï¼ˆæœ€å¤§å…è®¸è¾“å…¥é•¿åº¦ï¼‰å¹¶ä¸æ„å‘³æ¨¡å‹å…·æœ‰å¯¹åº”çš„é•¿æ–‡æœ¬çš„æ€§èƒ½ï¼Œä»…é˜²æ­¢QAå‡ºç°è¢«æˆªæ–­çš„é—®é¢˜ # MiniMind2-moe (145M)ï¼š(dim=640, n_layers=8, use_moe=True) # MiniMind2-Small (26M)ï¼š(dim=512, n_layers=8) # MiniMind2 (104M)ï¼š(dim=768, n_layers=16) parser.add_argument('--dim', default=512, type=int) parser.add_argument('--n_layers', default=8, type=int) parser.add_argument('--max_seq_len', default=8192, type=int) parser.add_argument('--use_moe', default=False, type=bool) # æºå¸¦å†å²å¯¹è¯ä¸Šä¸‹æ–‡æ¡æ•° # history_cntéœ€è¦è®¾ä¸ºå¶æ•°ï¼Œå³ã€ç”¨æˆ·é—®é¢˜, æ¨¡å‹å›ç­”ã€‘ä¸º1ç»„ï¼›è®¾ç½®ä¸º0æ—¶ï¼Œå³å½“å‰queryä¸æºå¸¦å†å²ä¸Šæ–‡ # æ¨¡å‹æœªç»è¿‡å¤–æ¨å¾®è°ƒæ—¶ï¼Œåœ¨æ›´é•¿çš„ä¸Šä¸‹æ–‡çš„chat_templateæ—¶éš¾å…å‡ºç°æ€§èƒ½çš„æ˜æ˜¾é€€åŒ–ï¼Œå› æ­¤éœ€è¦æ³¨æ„æ­¤å¤„è®¾ç½® parser.add_argument('--history_cnt', default=0, type=int) parser.add_argument('--stream', default=True, type=bool) parser.add_argument('--load', default=0, type=int, help=&quot;0: åŸç”Ÿtorchæƒé‡ï¼Œ1: transformersåŠ è½½&quot;) parser.add_argument('--model_mode', default=1, type=int, help=&quot;0: é¢„è®­ç»ƒæ¨¡å‹ï¼Œ1: SFT-Chatæ¨¡å‹ï¼Œ2: RLHF-Chatæ¨¡å‹ï¼Œ3: Reasonæ¨¡å‹&quot;) args = parser.parse_args() model, tokenizer = init_model(args) prompts = get_prompt_datas(args) test_mode = int(input('[0] è‡ªåŠ¨æµ‹è¯•\\n[1] æ‰‹åŠ¨è¾“å…¥\\n')) messages = [] for idx, prompt in enumerate(prompts if test_mode == 0 else iter(lambda: input('ğŸ‘¶: '), '')): setup_seed(random.randint(0, 2048)) # setup_seed(2025) # å¦‚éœ€å›ºå®šæ¯æ¬¡è¾“å‡ºåˆ™æ¢æˆã€å›ºå®šã€‘çš„éšæœºç§å­ if test_mode == 0: print(f'ğŸ‘¶: {prompt}') messages = messages[-args.history_cnt:] if args.history_cnt else [] messages.append({&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: prompt}) new_prompt = tokenizer.apply_chat_template( messages, tokenize=False, add_generation_prompt=True )[-args.max_seq_len + 1:] if args.model_mode != 0 else (tokenizer.bos_token + prompt) answer = new_prompt with torch.no_grad(): x = torch.tensor(tokenizer(new_prompt)['input_ids'], device=args.device).unsqueeze(0) outputs = model.generate( x, eos_token_id=tokenizer.eos_token_id, max_new_tokens=args.max_seq_len, temperature=args.temperature, top_p=args.top_p, stream=True, pad_token_id=tokenizer.pad_token_id ) print('ğŸ¤–ï¸: ', end='') try: if not args.stream: print(tokenizer.decode(outputs.squeeze()[x.shape[1]:].tolist(), skip_special_tokens=True), end='') else: history_idx = 0 for y in outputs: answer = tokenizer.decode(y[0].tolist(), skip_special_tokens=True) if (answer and answer[-1] == 'ï¿½') or not answer: continue print(answer[history_idx:], end='', flush=True) history_idx = len(answer) except StopIteration: print(&quot;No answer&quot;) print('\\n') messages.append({&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: answer}) if __name__ == &quot;__main__&quot;: main() # æ³¨æ„ï¼šmodel_modeå³é€‰æ‹©åŸºç¡€æ¨¡å‹çš„ç±»å‹ï¼Œè¿™å’Œtrain_loraæ˜¯åŸºäºå“ªä¸ªæ¨¡å‹è®­ç»ƒçš„ç›¸å…³ï¼Œç¡®ä¿ç»Ÿä¸€å³å¯ã€‚ python eval_model.py --lora_name 'lora_medical' --model_mode 2 å°æµ‹è¯• ğŸ‘¶: æˆ‘æœ€è¿‘ç»å¸¸æ„Ÿåˆ°å¤´æ™•ï¼Œå¯èƒ½æ˜¯ä»€ä¹ˆåŸå› ï¼Ÿ ğŸ¤–ï¸: å¤´æ™•å¯èƒ½æ˜¯ç”±äºå¤šç§åŸå› ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼šå¿ƒè„ç–¾ç—…ã€çœ¼ç›æŸä¼¤ã€è¿‡æ•ååº”ã€çš®è‚¤é—®é¢˜ã€è¿‡æ•ååº”ã€å‹åŠ›ã€ç„¦è™‘ã€ç–²åŠ³ã€è¯ç‰©å‰¯ä½œç”¨ã€æ€§åŠŸèƒ½éšœç¢æˆ–è€…å…¶ä»–... --- ğŸ‘¶: ä½ å’Œopenaiæ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ ğŸ¤–ï¸: æˆ‘æ˜¯ MiniMindï¼Œä¸€ä¸ªç”± Jingyao Gong å¼€å‘çš„äººå·¥æ™ºèƒ½åŠ©æ‰‹ã€‚æˆ‘é€šè¿‡è‡ªç„¶è¯­è¨€å¤„ç†å’Œç®—æ³•è®­ç»ƒæ¥ä¸ç”¨æˆ·è¿›è¡Œäº¤äº’ã€‚ PSï¼šåªè¦æœ‰æ‰€éœ€è¦çš„æ•°æ®é›†ï¼Œä¹Ÿå¯ä»¥full_sftå…¨å‚å¾®è°ƒï¼ˆéœ€è¦è¿›è¡Œé€šç”¨çŸ¥è¯†çš„æ··åˆé…æ¯”ï¼Œå¦åˆ™è¿‡æ‹Ÿåˆé¢†åŸŸæ•°æ®ä¼šè®©æ¨¡å‹å˜å‚»ï¼ŒæŸå¤±é€šç”¨æ€§ï¼‰ ","link":"https://tianxiawuhao.github.io/n7vyn_1QRC/"},{"title":"LoRA_PEFT","content":" æ¨¡å‹åŠ è½½ï¼šä½¿ç”¨4ä½é‡åŒ–(load_in_4bit=True)å‡å°‘æ˜¾å­˜æ¶ˆè€—ï¼Œå¯æ ¹æ®ç¡¬ä»¶è°ƒæ•´ LoRAé…ç½®ï¼š target_moduleséœ€è¦æ ¹æ®æ¨¡å‹ç»“æ„è°ƒæ•´ï¼Œé€šå¸¸é€‰æ‹©æ³¨æ„åŠ›å±‚çš„query/valueæŠ•å½±çŸ©é˜µ ç§©ræ§åˆ¶LoRAçš„ç»´åº¦ï¼Œé€šå¸¸8-64ä¹‹é—´ lora_alphaæ§åˆ¶ç¼©æ”¾ç³»æ•°ï¼Œä¸€èˆ¬è®¾ç½®ä¸ºrçš„2-4å€ æ•°æ®å¤„ç†ï¼š ç¡®ä¿æ•°æ®é›†åŒ…å«&quot;text&quot;å­—æ®µï¼Œæˆ–æ ¹æ®å®é™…æ•°æ®è°ƒæ•´é¢„å¤„ç†å‡½æ•° ä½¿ç”¨DataCollatorForLanguageModelingè¿›è¡ŒåŠ¨æ€å¡«å…… è®­ç»ƒä¼˜åŒ–ï¼š é€šè¿‡gradient_accumulation_stepsæ¨¡æ‹Ÿæ›´å¤§çš„batch size æ··åˆç²¾åº¦(fp16=True)å‡å°‘æ˜¾å­˜å ç”¨ ä½¿ç”¨bitsandbytesåº“è¿›è¡Œé‡åŒ–è®­ç»ƒ # ç¯å¢ƒä¾èµ–ï¼ˆéœ€æå‰å®‰è£…ï¼‰ # pip install torch transformers datasets peft accelerate bitsandbytes import torch from transformers import ( AutoTokenizer, AutoModelForCausalLM, TrainingArguments, Trainer, DataCollatorForLanguageModeling ) from peft import LoraConfig, get_peft_model, prepare_model_for_kbit_training from datasets import load_dataset # ===================== é…ç½®å‚æ•° ===================== MODEL_NAME = &quot;deepseek-ai/deepseek-r1&quot; # ç¡®è®¤HuggingFaceæ¨¡å‹ID DATASET_NAME = &quot;your_dataset&quot; # æ•°æ®é›†åç§°æˆ–æœ¬åœ°è·¯å¾„ OUTPUT_DIR = &quot;./deepseek-r1-lora-finetuned&quot; BATCH_SIZE = 2 # æ ¹æ®GPUæ˜¾å­˜è°ƒæ•´ MAX_LENGTH = 1024 # æ¨¡å‹æ”¯æŒçš„æœ€å¤§ä¸Šä¸‹æ–‡é•¿åº¦ NUM_EPOCHS = 3 LEARNING_RATE = 3e-5 # LoRAé…ç½® LORA_R = 16 LORA_ALPHA = 64 LORA_DROPOUT = 0.05 TARGET_MODULES = [&quot;q_proj&quot;, &quot;v_proj&quot;] # å…³é”®å‚æ•°ï¼éœ€æ ¹æ®å®é™…æ¨¡å‹ç»“æ„è°ƒæ•´ # ===================== æ¨¡å‹åŠ è½½ ===================== tokenizer = AutoTokenizer.from_pretrained(MODEL_NAME) model = AutoModelForCausalLM.from_pretrained( MODEL_NAME, load_in_4bit=True, # 4bité‡åŒ–èŠ‚çœæ˜¾å­˜ device_map=&quot;auto&quot;, torch_dtype=torch.bfloat16, attn_implementation=&quot;flash_attention_2&quot; # å¦‚æœæ”¯æŒFlash Attention ) # å¤„ç†ç‰¹æ®Štoken if tokenizer.pad_token is None: tokenizer.pad_token = tokenizer.eos_token # å‡†å¤‡é‡åŒ–è®­ç»ƒ model = prepare_model_for_kbit_training(model) # ===================== LoRAé…ç½® ===================== peft_config = LoraConfig( r=LORA_R, lora_alpha=LORA_ALPHA, lora_dropout=LORA_DROPOUT, target_modules=TARGET_MODULES, # å…³é”®é…ç½®é¡¹ï¼ bias=&quot;none&quot;, task_type=&quot;CAUSAL_LM&quot;, modules_to_save=[&quot;lm_head&quot;] # åŒæ—¶å¾®è°ƒè¾“å‡ºå±‚ ) model = get_peft_model(model, peft_config) model.print_trainable_parameters() # è¾“å‡ºç¤ºä¾‹ï¼štrainable params: 21,233,664 || all params: 6,742,097,920 || trainable%: 0.3148 # ===================== æ•°æ®å¤„ç† ===================== def format_function(examples): # æ ¹æ®ä»»åŠ¡æ„é€ promptï¼Œç¤ºä¾‹ï¼š texts = [ f&quot;&lt;|System|&gt;\\nä½ æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹\\n&lt;|User|&gt;\\n{query}\\n&lt;|Assistant|&gt;\\n{answer}&quot; for query, answer in zip(examples[&quot;query&quot;], examples[&quot;answer&quot;]) ] return {&quot;text&quot;: texts} dataset = load_dataset(DATASET_NAME) dataset = dataset.map(format_function, batched=True) def tokenize_function(examples): return tokenizer( examples[&quot;text&quot;], max_length=MAX_LENGTH, padding=&quot;max_length&quot;, truncation=True, add_special_tokens=True ) tokenized_dataset = dataset.map(tokenize_function, batched=True) # ===================== è®­ç»ƒé…ç½® ===================== training_args = TrainingArguments( output_dir=OUTPUT_DIR, num_train_epochs=NUM_EPOCHS, per_device_train_batch_size=BATCH_SIZE, gradient_accumulation_steps=8, # æ¨¡æ‹Ÿæ›´å¤§batch size learning_rate=LEARNING_RATE, fp16=True, # æ··åˆç²¾åº¦è®­ç»ƒ optim=&quot;paged_adamw_8bit&quot;, # ä¼˜åŒ–å™¨é€‰æ‹© logging_steps=20, save_strategy=&quot;steps&quot;, save_steps=500, evaluation_strategy=&quot;steps&quot;, # å¦‚æœæœ‰éªŒè¯é›† eval_steps=300, report_to=&quot;tensorboard&quot;, gradient_checkpointing=True, # æ˜¾å­˜ä¼˜åŒ– ddp_find_unused_parameters=False ) trainer = Trainer( model=model, args=training_args, train_dataset=tokenized_dataset[&quot;train&quot;], eval_dataset=tokenized_dataset[&quot;test&quot;], # å¦‚æœæœ‰éªŒè¯é›† data_collator=DataCollatorForLanguageModeling(tokenizer, mlm=False), ) # ===================== å¼€å§‹è®­ç»ƒ ===================== trainer.train() model.save_pretrained(OUTPUT_DIR) tokenizer.save_pretrained(OUTPUT_DIR) # ===================== æ¨ç†æµ‹è¯• ===================== from peft import PeftModel base_model = AutoModelForCausalLM.from_pretrained( MODEL_NAME, device_map=&quot;auto&quot;, torch_dtype=torch.bfloat16 ) model = PeftModel.from_pretrained(base_model, OUTPUT_DIR) inputs = tokenizer( &quot;&lt;|System|&gt;\\nä½ æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹\\n&lt;|User|&gt;\\nå¦‚ä½•å­¦ä¹ æœºå™¨å­¦ä¹ ï¼Ÿ\\n&lt;|Assistant|&gt;\\n&quot;, return_tensors=&quot;pt&quot; ).to(&quot;cuda&quot;) outputs = model.generate( **inputs, max_new_tokens=256, temperature=0.7, do_sample=True ) print(tokenizer.decode(outputs[0], skip_special_tokens=True)) ","link":"https://tianxiawuhao.github.io/GL2xUsgbSZ/"},{"title":"å¤§æ¨¡å‹æ¡†æ¶ä½“ç³»","content":"1. å¤§æ¨¡å‹åŠ è½½ Hugging Face ï¼š æä¾› transformers åº“ï¼Œé€šè¿‡ AutoModelå’Œ AutoTokenizerå¿«é€ŸåŠ è½½é¢„è®­ç»ƒæ¨¡å‹ï¼ˆå¦‚ GPTã€BERTï¼‰ï¼Œæ”¯æŒå¤šæ¡†æ¶ï¼ˆPyTorch/TensorFlowï¼‰ã€‚ ä¾èµ– ï¼šç›´æ¥å¯¹æ¥æ¨¡å‹ä»“åº“ï¼ˆModel Hubï¼‰ï¼Œä¾èµ– PyTorch æˆ– TensorFlow ä½œä¸ºåº•å±‚è®¡ç®—æ¡†æ¶ã€‚ LangChain ï¼šé€šè¿‡é›†æˆ Hugging Face æ¥å£ï¼Œç®€åŒ–æ¨¡å‹åŠ è½½ä¸è°ƒç”¨ï¼Œæ”¯æŒå¤šæ¨¡å‹ç»Ÿä¸€ç®¡ç†ï¼ˆå¦‚è°ƒç”¨æœ¬åœ°æˆ–è¿œç¨‹ LLMï¼‰ã€‚ 2. å¾®è°ƒï¼ˆFine-tuningï¼‰ Hugging Face ï¼š æä¾› Trainer API å’Œè„šæœ¬åŒ–å·¥å…·ï¼ˆå¦‚ run_glue.pyï¼‰ï¼Œå°è£…è®­ç»ƒå¾ªç¯ã€ä¼˜åŒ–å™¨å’Œè¯„ä¼°é€»è¾‘ï¼Œæ”¯æŒé«˜æ•ˆå¾®è°ƒã€‚ PyTorch ï¼šæä¾›åº•å±‚è®­ç»ƒæ”¯æŒï¼ˆå¦‚è‡ªåŠ¨æ±‚å¯¼ã€æŸå¤±å‡½æ•°ã€ä¼˜åŒ–å™¨ï¼‰ï¼ŒHugging Face çš„å¾®è°ƒå·¥å…·åŸºäº PyTorch å®ç°ã€‚ LangChain ï¼šé€šå¸¸ä¸ç›´æ¥å‚ä¸å¾®è°ƒï¼Œä½†å¯é€šè¿‡è°ƒç”¨ Hugging Face çš„å¾®è°ƒåæ¨¡å‹ï¼Œå¿«é€Ÿé›†æˆåˆ°åº”ç”¨ä¸­ã€‚ 3. ç®—æ³•æ­å»º PyTorch ï¼šæ ¸å¿ƒæ·±åº¦å­¦ä¹ æ¡†æ¶ï¼Œæä¾›å¼ é‡æ“ä½œã€åŠ¨æ€è®¡ç®—å›¾ï¼ˆautogradï¼‰å’Œç¥ç»ç½‘ç»œæ¨¡å—ï¼ˆtorch.nnï¼‰ï¼Œæ”¯æŒä»é›¶æ„å»ºè‡ªå®šä¹‰æ¨¡å‹ã€‚ Hugging Face ï¼šåŸºäº PyTorch å®ç°é¢„è®­ç»ƒæ¨¡å‹æ¶æ„ï¼ˆå¦‚ BERTã€GPTï¼‰ï¼Œæä¾›å¼€ç®±å³ç”¨çš„æ¨¡å‹é…ç½®å’Œæƒé‡ã€‚ LangChain ï¼šä¸“æ³¨åº”ç”¨å±‚é€»è¾‘ï¼Œé€šè¿‡ç»„åˆç°æœ‰æ¨¡å‹ï¼ˆå¦‚ Hugging Face çš„æ¨¡å‹ï¼‰å®ç°å¤æ‚åŠŸèƒ½ï¼ˆå¦‚é“¾å¼è°ƒç”¨ã€è®°å¿†æœºåˆ¶ï¼‰ã€‚ 4. è®­ç»ƒ PyTorch ï¼šè´Ÿè´£è®­ç»ƒæ ¸å¿ƒæµç¨‹ï¼ˆå‰å‘ä¼ æ’­ã€æŸå¤±è®¡ç®—ã€åå‘ä¼ æ’­ï¼‰ï¼Œæ”¯æŒåˆ†å¸ƒå¼è®­ç»ƒå’Œ GPU åŠ é€Ÿã€‚ Hugging Face ï¼šé€šè¿‡ datasetsåº“åŠ è½½å’Œé¢„å¤„ç†æ•°æ®ï¼Œç»“åˆ transformerså®ç°ç«¯åˆ°ç«¯è®­ç»ƒã€‚ LangChain ï¼šä¸ç›´æ¥å‚ä¸è®­ç»ƒï¼Œä½†å¯åˆ©ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹è¿›è¡Œæ¨ç†æˆ–æ„å»ºåº”ç”¨ã€‚ 5. åŠŸèƒ½æ­å»ºï¼ˆåº”ç”¨å¼€å‘ï¼‰ LangChain ï¼šæ ¸å¿ƒä¼˜åŠ¿åœ¨äºæ•´åˆæ¨¡å‹ã€æ•°æ®æºå’Œå·¥å…·ï¼ˆå¦‚æ•°æ®åº“ã€APIï¼‰ï¼Œæ”¯æŒæ„å»ºç«¯åˆ°ç«¯åº”ç”¨ï¼ˆå¦‚èŠå¤©æœºå™¨äººã€Agentï¼‰ã€‚ ä¾èµ– ï¼šéœ€ç»“åˆ Hugging Faceï¼ˆæ¨¡å‹ï¼‰ã€PyTorchï¼ˆè®¡ç®—ï¼‰ç­‰æ¡†æ¶å®ç°åŠŸèƒ½ã€‚ Hugging Face ï¼šæä¾› pipelineså¿«é€Ÿå®ç°ç‰¹å®šä»»åŠ¡ï¼ˆå¦‚æ–‡æœ¬ç”Ÿæˆã€åˆ†ç±»ï¼‰ï¼Œå¯ä½œä¸º LangChain çš„ç»„ä»¶ã€‚ PyTorch ï¼šæä¾›åº•å±‚ç®—åŠ›æ”¯æŒï¼Œç¡®ä¿æ¨¡å‹æ¨ç†å’Œè®­ç»ƒçš„é«˜æ•ˆæ€§ã€‚ æ¡†æ¶å…³ç³»æ€»ç»“ æ¡†æ¶ æ ¸å¿ƒè§’è‰² ä¾èµ–å…³ç³» PyTorch åº•å±‚è®¡ç®—å¼•æ“ï¼Œæ”¯æŒæ¨¡å‹æ„å»ºä¸è®­ç»ƒ ç‹¬ç«‹æ¡†æ¶ï¼Œè¢« Hugging Face å’Œ LangChain é—´æ¥ä¾èµ–45 Hugging Face æ¨¡å‹ä¸æ•°æ®ä¸­å°ï¼Œæä¾›é¢„è®­ç»ƒæ¨¡å‹å’Œå·¥å…·é“¾ ä¾èµ– PyTorch/TensorFlow å®ç°æ¨¡å‹23ï¼Œè¢« LangChain è°ƒç”¨æ¨¡å‹èƒ½åŠ›1 LangChain åº”ç”¨å±‚æ¡†æ¶ï¼Œæ•´åˆæ¨¡å‹ä¸å·¥å…·æ„å»ºå¤æ‚é€»è¾‘ ä¾èµ– Hugging Faceï¼ˆæ¨¡å‹ï¼‰å’Œ PyTorchï¼ˆè®¡ç®—ï¼‰69 å…¸å‹æµç¨‹ç¤ºä¾‹ æ¨¡å‹åŠ è½½ ï¼šé€šè¿‡ Hugging Face çš„ AutoModel åŠ è½½é¢„è®­ç»ƒ LLMã€‚ å¾®è°ƒ ï¼šä½¿ç”¨ Hugging Face çš„ Trainerå’Œ PyTorch ä¼˜åŒ–å™¨è¿›è¡Œé¢†åŸŸé€‚é…ã€‚ åº”ç”¨å¼€å‘ ï¼šé€šè¿‡ LangChain å°†æ¨¡å‹ä¸å¤–éƒ¨æ•°æ®æºï¼ˆå¦‚æ•°æ®åº“ï¼‰è¿æ¥ï¼Œæ„å»ºèŠå¤©æœºå™¨äººã€‚ 6. PyTorch çš„åŒç±»æ¡†æ¶ å®šä½ ï¼šæ·±åº¦å­¦ä¹ åŸºç¡€æ¡†æ¶ ï¼Œæä¾›å¼ é‡è®¡ç®—ã€è‡ªåŠ¨å¾®åˆ†å’ŒåŠ¨æ€è®¡ç®—å›¾ï¼Œæ”¯æŒæ¨¡å‹ä»è®­ç»ƒåˆ°æ¨ç†çš„å…¨æµç¨‹ã€‚ åŒç±»æ¡†æ¶ ï¼š TensorFlow ï¼šé™æ€è®¡ç®—å›¾ä¸ºä¸»ï¼Œé€‚åˆå¤§è§„æ¨¡ç”Ÿäº§éƒ¨ç½²ï¼Œä¸ PyTorch å…±äº« Hugging Face çš„æ¨¡å‹ç”Ÿæ€ã€‚ JAX ï¼šè°·æ­Œæ¨å‡ºï¼Œä»¥å‡½æ•°å¼ç¼–ç¨‹å’Œé«˜æ€§èƒ½è®¡ç®—è‘—ç§°ï¼Œé€‚åˆç ”ç©¶åœºæ™¯ï¼ˆå¦‚å¼ºåŒ–å­¦ä¹ ï¼‰ã€‚ MXNet ï¼šæ”¯æŒå¤šè¯­è¨€ç»‘å®šï¼Œæ›¾ç”¨äº AWS çš„æ·±åº¦å­¦ä¹ æœåŠ¡ï¼Œä½†ç¤¾åŒºæ´»è·ƒåº¦ä¸‹é™ã€‚ 7. Hugging Face çš„åŒç±»æ¡†æ¶ å®šä½ ï¼šæ¨¡å‹å³æœåŠ¡ï¼ˆMaaSï¼‰å¹³å° ï¼Œæä¾›é¢„è®­ç»ƒæ¨¡å‹ã€æ•°æ®é›†å’Œå·¥å…·é“¾ï¼Œç®€åŒ–å¤§æ¨¡å‹åº”ç”¨å¼€å‘ã€‚ åŒç±»æ¡†æ¶ ï¼š ModelScopeï¼ˆé­”æ­ï¼‰ ï¼šé˜¿é‡Œè¾¾æ‘©é™¢æ¨å‡ºçš„æ¨¡å‹å¼€æ”¾å¹³å°ï¼Œæä¾›å¤§é‡é¢„è®­ç»ƒæ¨¡å‹ï¼ˆå¦‚ Qwenï¼‰ï¼Œå®šä½ä¸ Hugging Face ç±»ä¼¼ã€‚ TensorFlow Hub ï¼šè°·æ­Œçš„æ¨¡å‹ä»“åº“ï¼Œä¸ Hugging Face çš„ transformers åº“åŠŸèƒ½é‡å ï¼Œä½†ç”Ÿæ€è¾ƒå°ã€‚ PaddleNLP ï¼šç™¾åº¦é£æ¡¨çš„ NLP å·¥å…·åº“ï¼Œé›†æˆæ–‡å¿ƒä¸€è¨€ç­‰å¤§æ¨¡å‹ï¼Œæä¾›å¼€ç®±å³ç”¨çš„ APIã€‚ 8. LangChain çš„åŒç±»æ¡†æ¶ å®šä½ ï¼šå¤§æ¨¡å‹åº”ç”¨å¼€å‘æ¡†æ¶ ï¼Œé€šè¿‡é“¾å¼ç»„ä»¶ã€å·¥å…·é›†æˆå’Œè®°å¿†æœºåˆ¶æ„å»ºå¤æ‚åº”ç”¨ï¼ˆå¦‚ Agentï¼‰ã€‚ åŒç±»æ¡†æ¶ ï¼š LlamaIndex ï¼šä¸“æ³¨æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰ ï¼Œæä¾›æ•°æ®ç´¢å¼•ã€æŸ¥è¯¢ä¼˜åŒ–å’Œç¼“å­˜åŠŸèƒ½ï¼Œé€‚åˆæ–‡æ¡£é—®ç­”åœºæ™¯ã€‚ TensorFlow Extended (TFX) ï¼šè°·æ­Œçš„ç«¯åˆ°ç«¯ç”Ÿäº§æµæ°´çº¿å·¥å…·ï¼Œæ”¯æŒæ¨¡å‹éƒ¨ç½²ä¸ç›‘æ§ï¼Œä½†çµæ´»æ€§å¼±äº LangChainã€‚ AutoML å·¥å…·ï¼ˆå¦‚ AutoKerasï¼‰ ï¼šè‡ªåŠ¨åŒ–æ¨¡å‹æœç´¢ä¸è°ƒå‚ï¼Œé™ä½å¼€å‘é—¨æ§›ï¼Œä½†åŠŸèƒ½èŒƒå›´ä¸ LangChain äº’è¡¥ã€‚ æ¡†æ¶å…³ç³»ä¸é€‰æ‹©å»ºè®® åœºæ™¯ PyTorch æ›¿ä»£ Hugging Face æ›¿ä»£ LangChain æ›¿ä»£ æ¨¡å‹è®­ç»ƒä¸å®éªŒ TensorFlowã€JAX ModelScopeã€PaddleNLP LlamaIndexï¼ˆRAG ä¸“ç”¨ï¼‰ ç”Ÿäº§çº§éƒ¨ç½² TensorFlow Extended TensorFlow Hub TFXã€AutoML å¿«é€Ÿåº”ç”¨å¼€å‘ PyTorch Lightning Hugging Face Pipelines LlamaIndexã€AutoKeras å…³é”®ä¾èµ–å…³ç³» PyTorch æ˜¯ Hugging Face å’Œ LangChain çš„åº•å±‚è®¡ç®—å¼•æ“ã€‚ Hugging Face ä½œä¸ºæ¨¡å‹ä¸­å°ï¼Œå‘ LangChain æä¾›é¢„è®­ç»ƒæ¨¡å‹å’Œå·¥å…·é“¾ã€‚ LangChain ä¾èµ– Hugging Face å’Œ PyTorch å®ç°å¤æ‚åº”ç”¨é€»è¾‘ï¼ˆå¦‚é“¾å¼è°ƒç”¨ã€æ•°æ®åº“é›†æˆï¼‰ã€‚ ","link":"https://tianxiawuhao.github.io/1I3syISgB_/"},{"title":"jenkinsè‡ªå®šä¹‰ç¯å¢ƒé•œåƒ","content":"dockeræ‰“åŒ…åŒ…å«jdk17,maven3.8.8,node18ç¯å¢ƒçš„jenkinsé•œåƒåŒ… FROM jenkins/jenkins # å®‰è£… Node.js USER root RUN curl -sL https://deb.nodesource.com/setup_18.x | bash - RUN apt-get install -y nodejs # å®‰è£… Yarn RUN npm install -g yarn # å®‰è£… Maven 3.8.8 ARG MAVEN_VERSION=3.8.8 ARG BASE_URL=https://archive.apache.org/dist/maven/maven-3/${MAVEN_VERSION}/binaries RUN curl -fsSL -o /tmp/apache-maven.tar.gz ${BASE_URL}/apache-maven-${MAVEN_VERSION}-bin.tar.gz &amp;&amp; \\ tar -xzf /tmp/apache-maven.tar.gz -C /opt &amp;&amp; \\ ln -s /opt/apache-maven-${MAVEN_VERSION} /opt/maven &amp;&amp; \\ ln -s /opt/maven/bin/mvn /usr/local/bin &amp;&amp; \\ rm -f /tmp/apache-maven.tar.gz # å®‰è£… JDK 17 RUN apt-get install -y openjdk-17-jdk # å®‰è£… Git RUN apt-get install -y git # è®¾ç½®ç¯å¢ƒå˜é‡ ENV JAVA_HOME /usr/lib/jvm/java-17-openjdk-amd64 ENV M2_HOME /opt/maven ENV M2 /opt/maven/bin ENV PATH $JAVA_HOME/bin:$M2:$PATH # æ›¿æ¢waræœ€æ–°ç‰ˆæœ¬ COPY jenkins.war /usr/share/jenkins/ USER jenkins ","link":"https://tianxiawuhao.github.io/_MxFmWNQI/"},{"title":"ç›®æ ‡æ£€æµ‹å¸¸è§ç®—æ³•","content":"ä¸€ã€ç›®æ ‡æ£€æµ‹å¸¸è§ç®—æ³• object detectionï¼Œå°±æ˜¯åœ¨ç»™å®šçš„å›¾ç‰‡ä¸­ç²¾ç¡®æ‰¾åˆ°ç‰©ä½“æ‰€åœ¨ä½ç½®ï¼Œå¹¶æ ‡æ³¨å‡ºç‰©ä½“çš„ç±»åˆ«ã€‚æ‰€ä»¥ï¼Œobject detectionè¦è§£å†³çš„é—®é¢˜å°±æ˜¯ç‰©ä½“åœ¨å“ªé‡Œä»¥åŠæ˜¯ä»€ä¹ˆçš„æ•´ä¸ªæµç¨‹é—®é¢˜ã€‚ ç„¶è€Œï¼Œè¿™ä¸ªé—®é¢˜å¯ä¸æ˜¯é‚£ä¹ˆå®¹æ˜“è§£å†³çš„ï¼Œç‰©ä½“çš„å°ºå¯¸å˜åŒ–èŒƒå›´å¾ˆå¤§ï¼Œæ‘†æ”¾ç‰©ä½“çš„è§’åº¦ï¼Œå§¿æ€ä¸å®šï¼Œè€Œä¸”å¯ä»¥å‡ºç°åœ¨å›¾ç‰‡çš„ä»»ä½•åœ°æ–¹ï¼Œæ›´ä½•å†µç‰©ä½“è¿˜å¯ä»¥æ˜¯å¤šä¸ªç±»åˆ«ã€‚ ç›®æ ‡æ£€æµ‹ç®—æ³• ç›®å‰å­¦æœ¯å’Œå·¥ä¸šç•Œå‡ºç°çš„ç›®æ ‡æ£€æµ‹ç®—æ³•åˆ†æˆ3ç±»ï¼š ä¼ ç»Ÿçš„ç›®æ ‡æ£€æµ‹ç®—æ³•ï¼šCascade + HOG/DPM + Haar/SVMä»¥åŠä¸Šè¿°æ–¹æ³•çš„è¯¸å¤šæ”¹è¿›ã€ä¼˜åŒ–ï¼› å€™é€‰åŒºåŸŸ/çª— + æ·±åº¦å­¦ä¹ åˆ†ç±»ï¼šé€šè¿‡æå–å€™é€‰åŒºåŸŸï¼Œå¹¶å¯¹ç›¸åº”åŒºåŸŸè¿›è¡Œä»¥æ·±åº¦å­¦ä¹ æ–¹æ³•ä¸ºä¸»çš„åˆ†ç±»çš„æ–¹æ¡ˆï¼Œå¦‚ï¼š R-CNNï¼ˆSelective Search + CNN + SVMï¼‰ SPP-netï¼ˆROI Poolingï¼‰ Fast R-CNNï¼ˆSelective Search + CNN + ROIï¼‰ Faster R-CNNï¼ˆRPN + CNN + ROIï¼‰ R-FCN åŸºäºæ·±åº¦å­¦ä¹ çš„å›å½’æ–¹æ³•ï¼šYOLO/SSD/DenseBox ç­‰æ–¹æ³•ï¼›ä»¥åŠæœ€è¿‘å‡ºç°çš„ç»“åˆRNNç®—æ³•çš„RRC detectionï¼›ç»“åˆDPMçš„Deformable CNNç­‰ ä¼ ç»Ÿç›®æ ‡æ£€æµ‹æµç¨‹ï¼š åŒºåŸŸé€‰æ‹©ï¼ˆç©·ä¸¾ç­–ç•¥ï¼šé‡‡ç”¨æ»‘åŠ¨çª—å£ï¼Œä¸”è®¾ç½®ä¸åŒçš„å¤§å°ï¼Œä¸åŒçš„é•¿å®½æ¯”å¯¹å›¾åƒè¿›è¡Œéå†ï¼Œæ—¶é—´å¤æ‚åº¦é«˜ï¼‰ ç‰¹å¾æå–ï¼ˆSIFTã€HOGç­‰ï¼›å½¢æ€å¤šæ ·æ€§ã€å…‰ç…§å˜åŒ–å¤šæ ·æ€§ã€èƒŒæ™¯å¤šæ ·æ€§ä½¿å¾—ç‰¹å¾é²æ£’æ€§å·®ï¼‰ åˆ†ç±»å™¨åˆ†ç±»ï¼ˆä¸»è¦æœ‰SVMã€Adaboostç­‰ï¼‰ äºŒã€ä¼ ç»Ÿçš„ç›®æ ‡æ£€æµ‹ç®—æ³• ä»å›¾åƒè¯†åˆ«çš„ä»»åŠ¡è¯´èµ· è¿™é‡Œæœ‰ä¸€ä¸ªå›¾åƒä»»åŠ¡ï¼šæ—¢è¦æŠŠå›¾ä¸­çš„ç‰©ä½“è¯†åˆ«å‡ºæ¥ï¼Œåˆè¦ç”¨æ–¹æ¡†æ¡†å‡ºå®ƒçš„ä½ç½®ã€‚ è¿™ä¸ªä»»åŠ¡æœ¬è´¨ä¸Šå°±æ˜¯è¿™ä¸¤ä¸ªé—®é¢˜ï¼š å›¾åƒè¯†åˆ«ï¼Œ å®šä½ã€‚ å›¾åƒè¯†åˆ«ï¼ˆclassificationï¼‰ï¼š è¾“å…¥ï¼šå›¾ç‰‡ è¾“å‡ºï¼šç‰©ä½“çš„ç±»åˆ« è¯„ä¼°æ–¹æ³•ï¼šå‡†ç¡®ç‡ å®šä½ï¼ˆlocalizationï¼‰ï¼š è¾“å…¥ï¼šå›¾ç‰‡ è¾“å‡ºï¼šæ–¹æ¡†åœ¨å›¾ç‰‡ä¸­çš„ä½ç½®ï¼ˆx,y,w,hï¼‰ è¯„ä¼°æ–¹æ³•ï¼šæ£€æµ‹è¯„ä»·å‡½æ•° intersection-over-union å·ç§¯ç¥ç»ç½‘ç»œCNNå·²ç»å¸®æˆ‘ä»¬å®Œæˆäº†å›¾åƒè¯†åˆ«ï¼ˆåˆ¤å®šæ˜¯çŒ«è¿˜æ˜¯ç‹—ï¼‰çš„ä»»åŠ¡äº†ï¼Œæˆ‘ä»¬åªéœ€è¦æ·»åŠ ä¸€äº›é¢å¤–çš„åŠŸèƒ½æ¥å®Œæˆå®šä½ä»»åŠ¡å³å¯ã€‚ å®šä½çš„é—®é¢˜çš„è§£å†³æ€è·¯ æ€è·¯ä¸€ï¼šçœ‹åšå›å½’é—®é¢˜ çœ‹åšå›å½’é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦é¢„æµ‹å‡ºï¼ˆx,y,w,hï¼‰å››ä¸ªå‚æ•°çš„å€¼ï¼Œä»è€Œå¾—å‡ºæ–¹æ¡†çš„ä½ç½®ã€‚ æ­¥éª¤1: â€¢ å…ˆè§£å†³ç®€å•é—®é¢˜ï¼Œ æ­ä¸€ä¸ªè¯†åˆ«å›¾åƒçš„ç¥ç»ç½‘ç»œ â€¢ åœ¨AlexNet VGG GoogleLenetä¸Šå¾®è°ƒfine-tuningä¸€ä¸‹ æ­¥éª¤2: â€¢ åœ¨ä¸Šè¿°ç¥ç»ç½‘ç»œçš„å°¾éƒ¨å±•å¼€ï¼ˆä¹Ÿå°±è¯´CNNå‰é¢ä¿æŒä¸å˜ï¼Œæˆ‘ä»¬å¯¹CNNçš„ç»“å°¾å¤„ä½œå‡ºæ”¹è¿›ï¼šåŠ äº†ä¸¤ä¸ªå¤´ï¼šâ€œåˆ†ç±»å¤´â€å’Œâ€œå›å½’å¤´â€ï¼‰ â€¢ æˆä¸ºclassification + regressionæ¨¡å¼ æ­¥éª¤3: â€¢ Regressioné‚£ä¸ªéƒ¨åˆ†ç”¨æ¬§æ°è·ç¦»æŸå¤± â€¢ ä½¿ç”¨SGDè®­ç»ƒ æ­¥éª¤4: â€¢ é¢„æµ‹é˜¶æ®µæŠŠ2ä¸ªå¤´éƒ¨æ‹¼ä¸Š â€¢ å®Œæˆä¸åŒçš„åŠŸèƒ½ è¿™é‡Œéœ€è¦è¿›è¡Œä¸¤æ¬¡fine-tuning ç¬¬ä¸€æ¬¡åœ¨ALexNetä¸Šåšï¼Œç¬¬äºŒæ¬¡å°†å¤´éƒ¨æ”¹æˆregression headï¼Œå‰é¢ä¸å˜ï¼Œåšä¸€æ¬¡fine-tuning Regressionçš„éƒ¨åˆ†åŠ åœ¨å“ªï¼Ÿ æœ‰ä¸¤ç§å¤„ç†æ–¹æ³•ï¼š â€¢ åŠ åœ¨æœ€åä¸€ä¸ªå·ç§¯å±‚åé¢ï¼ˆå¦‚VGGï¼‰ â€¢ åŠ åœ¨æœ€åä¸€ä¸ªå…¨è¿æ¥å±‚åé¢ï¼ˆå¦‚R-CNNï¼‰ regressionå¤ªéš¾åšäº†ï¼Œåº”æƒ³æ–¹è®¾æ³•è½¬æ¢ä¸ºclassificationé—®é¢˜ã€‚ regressionçš„è®­ç»ƒå‚æ•°æ”¶æ•›çš„æ—¶é—´è¦é•¿å¾—å¤šï¼Œæ‰€ä»¥ä¸Šé¢çš„ç½‘ç»œé‡‡å–äº†ç”¨classificationçš„ç½‘ç»œæ¥è®¡ç®—å‡ºç½‘ç»œå…±åŒéƒ¨åˆ†çš„è¿æ¥æƒå€¼ã€‚ æ€è·¯äºŒï¼šå–å›¾åƒçª—å£ â€¢ è¿˜æ˜¯åˆšæ‰çš„classification + regressionæ€è·¯ â€¢ å’±ä»¬å–ä¸åŒçš„å¤§å°çš„â€œæ¡†â€ â€¢ è®©æ¡†å‡ºç°åœ¨ä¸åŒçš„ä½ç½®ï¼Œå¾—å‡ºè¿™ä¸ªæ¡†çš„åˆ¤å®šå¾—åˆ† â€¢ å–å¾—åˆ†æœ€é«˜çš„é‚£ä¸ªæ¡† å·¦ä¸Šè§’çš„é»‘æ¡†ï¼šå¾—åˆ†0.5 å³ä¸Šè§’çš„é»‘æ¡†ï¼šå¾—åˆ†0.75 å·¦ä¸‹è§’çš„é»‘æ¡†ï¼šå¾—åˆ†0.6 å³ä¸‹è§’çš„é»‘æ¡†ï¼šå¾—åˆ†0.8 æ ¹æ®å¾—åˆ†çš„é«˜ä½ï¼Œæˆ‘ä»¬é€‰æ‹©äº†å³ä¸‹è§’çš„é»‘æ¡†ä½œä¸ºç›®æ ‡ä½ç½®çš„é¢„æµ‹ã€‚ æ³¨ï¼šæœ‰çš„æ—¶å€™ä¹Ÿä¼šé€‰æ‹©å¾—åˆ†æœ€é«˜çš„ä¸¤ä¸ªæ¡†ï¼Œç„¶åå–ä¸¤æ¡†çš„äº¤é›†ä½œä¸ºæœ€ç»ˆçš„ä½ç½®é¢„æµ‹ã€‚ ç–‘æƒ‘ï¼šæ¡†è¦å–å¤šå¤§ï¼Ÿ å–ä¸åŒçš„æ¡†ï¼Œä¾æ¬¡ä»å·¦ä¸Šè§’æ‰«åˆ°å³ä¸‹è§’ã€‚éå¸¸ç²—æš´å•Šã€‚ æ€»ç»“ä¸€ä¸‹æ€è·¯ï¼š å¯¹ä¸€å¼ å›¾ç‰‡ï¼Œç”¨å„ç§å¤§å°çš„æ¡†ï¼ˆéå†æ•´å¼ å›¾ç‰‡ï¼‰å°†å›¾ç‰‡æˆªå–å‡ºæ¥ï¼Œè¾“å…¥åˆ°CNNï¼Œç„¶åCNNä¼šè¾“å‡ºè¿™ä¸ªæ¡†çš„å¾—åˆ†ï¼ˆclassificationï¼‰ä»¥åŠè¿™ä¸ªæ¡†å›¾ç‰‡å¯¹åº”çš„x,y,h,wï¼ˆregressionï¼‰ã€‚ è¿™æ–¹æ³•å®åœ¨å¤ªè€—æ—¶é—´äº†ï¼Œåšä¸ªä¼˜åŒ–ã€‚ åŸæ¥ç½‘ç»œæ˜¯è¿™æ ·çš„ï¼š ä¼˜åŒ–æˆè¿™æ ·ï¼šæŠŠå…¨è¿æ¥å±‚æ”¹ä¸ºå·ç§¯å±‚ï¼Œè¿™æ ·å¯ä»¥ææé€Ÿã€‚ ç‰©ä½“æ£€æµ‹ï¼ˆObject Detectionï¼‰ å½“å›¾åƒæœ‰å¾ˆå¤šç‰©ä½“æ€ä¹ˆåŠçš„ï¼Ÿéš¾åº¦å¯æ˜¯ä¸€ä¸‹æš´å¢å•Šã€‚ é‚£ä»»åŠ¡å°±å˜æˆäº†ï¼šå¤šç‰©ä½“è¯†åˆ«+å®šä½å¤šä¸ªç‰©ä½“ é‚£æŠŠè¿™ä¸ªä»»åŠ¡çœ‹åšåˆ†ç±»é—®é¢˜ï¼Ÿ çœ‹æˆåˆ†ç±»é—®é¢˜æœ‰ä½•ä¸å¦¥ï¼Ÿ â€¢ ä½ éœ€è¦æ‰¾å¾ˆå¤šä½ç½®ï¼Œ ç»™å¾ˆå¤šä¸ªä¸åŒå¤§å°çš„æ¡† â€¢ ä½ è¿˜éœ€è¦å¯¹æ¡†å†…çš„å›¾åƒåˆ†ç±» â€¢ å½“ç„¶ï¼Œ å¦‚æœä½ çš„GPUå¾ˆå¼ºå¤§ï¼Œ æ©ï¼Œ é‚£åŠ æ²¹åšå§â€¦ æ‰€ä»¥ï¼Œä¼ ç»Ÿç›®æ ‡æ£€æµ‹çš„ä¸»è¦é—®é¢˜æ˜¯ï¼š åŸºäºæ»‘åŠ¨çª—å£çš„åŒºåŸŸé€‰æ‹©ç­–ç•¥æ²¡æœ‰é’ˆå¯¹æ€§ï¼Œæ—¶é—´å¤æ‚åº¦é«˜ï¼Œçª—å£å†—ä½™ æ‰‹å·¥è®¾è®¡çš„ç‰¹å¾å¯¹äºå¤šæ ·æ€§çš„å˜åŒ–æ²¡æœ‰å¾ˆå¥½çš„é²æ£’æ€§ çœ‹åšclassificationï¼Œ æœ‰æ²¡æœ‰åŠæ³•ä¼˜åŒ–ä¸‹ï¼Ÿæˆ‘å¯ä¸æƒ³è¯•é‚£ä¹ˆå¤šæ¡†é‚£ä¹ˆå¤šä½ç½®å•Šï¼ å€™é€‰åŒºåŸŸ/çª— + æ·±åº¦å­¦ä¹ åˆ†ç±» R-CNNæ¨ªç©ºå‡ºä¸– æœ‰äººæƒ³åˆ°ä¸€ä¸ªå¥½æ–¹æ³•ï¼šé¢„å…ˆæ‰¾å‡ºå›¾ä¸­ç›®æ ‡å¯èƒ½å‡ºç°çš„ä½ç½®ï¼Œå³å€™é€‰åŒºåŸŸï¼ˆRegion Proposalï¼‰ã€‚åˆ©ç”¨å›¾åƒä¸­çš„çº¹ç†ã€è¾¹ç¼˜ã€é¢œè‰²ç­‰ä¿¡æ¯ï¼Œå¯ä»¥ä¿è¯åœ¨é€‰å–è¾ƒå°‘çª—å£(å‡ åƒç”šè‡³å‡ ç™¾ï¼‰çš„æƒ…å†µä¸‹ä¿æŒè¾ƒé«˜çš„å¬å›ç‡ï¼ˆRecallï¼‰ã€‚ æ‰€ä»¥ï¼Œé—®é¢˜å°±è½¬å˜æˆæ‰¾å‡ºå¯èƒ½å«æœ‰ç‰©ä½“çš„åŒºåŸŸ/æ¡†ï¼ˆä¹Ÿå°±æ˜¯å€™é€‰åŒºåŸŸ/æ¡†ï¼Œæ¯”å¦‚é€‰2000ä¸ªå€™é€‰æ¡†ï¼‰ï¼Œè¿™äº›æ¡†ä¹‹é—´æ˜¯å¯ä»¥äº’ç›¸é‡å äº’ç›¸åŒ…å«çš„ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é¿å…æš´åŠ›æšä¸¾çš„æ‰€æœ‰æ¡†äº†ã€‚ å¤§ç‰›ä»¬å‘æ˜å¥½å¤šé€‰å®šå€™é€‰æ¡†Region Proposalçš„æ–¹æ³•ï¼Œæ¯”å¦‚Selective Searchå’ŒEdgeBoxesã€‚é‚£æå–å€™é€‰æ¡†ç”¨åˆ°çš„ç®—æ³•â€œé€‰æ‹©æ€§æœç´¢â€åˆ°åº•æ€ä¹ˆé€‰å‡ºè¿™äº›å€™é€‰æ¡†çš„å‘¢ï¼Ÿå…·ä½“å¯ä»¥çœ‹ä¸€ä¸‹PAMI2015çš„â€œWhat makes for effective detection proposalsï¼Ÿâ€ ä»¥ä¸‹æ˜¯å„ç§é€‰å®šå€™é€‰æ¡†çš„æ–¹æ³•çš„æ€§èƒ½å¯¹æ¯”ã€‚ æœ‰äº†å€™é€‰åŒºåŸŸï¼Œå‰©ä¸‹çš„å·¥ä½œå®é™…å°±æ˜¯å¯¹å€™é€‰åŒºåŸŸè¿›è¡Œå›¾åƒåˆ†ç±»çš„å·¥ä½œï¼ˆç‰¹å¾æå–+åˆ†ç±»ï¼‰ã€‚å¯¹äºå›¾åƒåˆ†ç±»ï¼Œä¸å¾—ä¸æçš„æ˜¯2012å¹´ImageNetå¤§è§„æ¨¡è§†è§‰è¯†åˆ«æŒ‘æˆ˜èµ›ï¼ˆILSVRCï¼‰ä¸Šï¼Œæœºå™¨å­¦ä¹ æ³°æ–—Geoffrey Hintonæ•™æˆå¸¦é¢†å­¦ç”ŸKrizhevskyä½¿ç”¨å·ç§¯ç¥ç»ç½‘ç»œå°†ILSVRCåˆ†ç±»ä»»åŠ¡çš„Top-5 erroré™ä½åˆ°äº†15.3%ï¼Œè€Œä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•çš„ç¬¬äºŒåtop-5 erroré«˜è¾¾ 26.2%ã€‚æ­¤åï¼Œå·ç§¯ç¥ç»ç½‘ç»œCNNå æ®äº†å›¾åƒåˆ†ç±»ä»»åŠ¡çš„ç»å¯¹ç»Ÿæ²»åœ°ä½ã€‚ 2014å¹´ï¼ŒRBGï¼ˆRoss B. Girshickï¼‰ä½¿ç”¨Region Proposal + CNNä»£æ›¿ä¼ ç»Ÿç›®æ ‡æ£€æµ‹ä½¿ç”¨çš„æ»‘åŠ¨çª—å£+æ‰‹å·¥è®¾è®¡ç‰¹å¾ï¼Œè®¾è®¡äº†R-CNNæ¡†æ¶ï¼Œä½¿å¾—ç›®æ ‡æ£€æµ‹å–å¾—å·¨å¤§çªç ´ï¼Œå¹¶å¼€å¯äº†åŸºäºæ·±åº¦å­¦ä¹ ç›®æ ‡æ£€æµ‹çš„çƒ­æ½®ã€‚ R-CNNçš„ç®€è¦æ­¥éª¤å¦‚ä¸‹ è¾“å…¥æµ‹è¯•å›¾åƒ åˆ©ç”¨é€‰æ‹©æ€§æœç´¢Selective Searchç®—æ³•åœ¨å›¾åƒä¸­ä»ä¸‹åˆ°ä¸Šæå–2000ä¸ªå·¦å³çš„å¯èƒ½åŒ…å«ç‰©ä½“çš„å€™é€‰åŒºåŸŸRegion Proposal å› ä¸ºå–å‡ºçš„åŒºåŸŸå¤§å°å„è‡ªä¸åŒï¼Œæ‰€ä»¥éœ€è¦å°†æ¯ä¸ªRegion Proposalç¼©æ”¾ï¼ˆwarpï¼‰æˆç»Ÿä¸€çš„227x227çš„å¤§å°å¹¶è¾“å…¥åˆ°CNNï¼Œå°†CNNçš„fc7å±‚çš„è¾“å‡ºä½œä¸ºç‰¹å¾ å°†æ¯ä¸ªRegion Proposalæå–åˆ°çš„CNNç‰¹å¾è¾“å…¥åˆ°SVMè¿›è¡Œåˆ†ç±» å…·ä½“æ­¥éª¤åˆ™å¦‚ä¸‹ æ­¥éª¤ä¸€ï¼šè®­ç»ƒï¼ˆæˆ–è€…ä¸‹è½½ï¼‰ä¸€ä¸ªåˆ†ç±»æ¨¡å‹ï¼ˆæ¯”å¦‚AlexNetï¼‰ æ­¥éª¤äºŒï¼šå¯¹è¯¥æ¨¡å‹åšfine-tuning â€¢ å°†åˆ†ç±»æ•°ä»1000æ”¹ä¸º20ï¼Œæ¯”å¦‚20ä¸ªç‰©ä½“ç±»åˆ« + 1ä¸ªèƒŒæ™¯ â€¢ å»æ‰æœ€åä¸€ä¸ªå…¨è¿æ¥å±‚ æ­¥éª¤ä¸‰ï¼šç‰¹å¾æå– â€¢ æå–å›¾åƒçš„æ‰€æœ‰å€™é€‰æ¡†ï¼ˆé€‰æ‹©æ€§æœç´¢Selective Searchï¼‰ â€¢ å¯¹äºæ¯ä¸€ä¸ªåŒºåŸŸï¼šä¿®æ­£åŒºåŸŸå¤§å°ä»¥é€‚åˆCNNçš„è¾“å…¥ï¼Œåšä¸€æ¬¡å‰å‘è¿ç®—ï¼Œå°†ç¬¬äº”ä¸ªæ± åŒ–å±‚çš„è¾“å‡ºï¼ˆå°±æ˜¯å¯¹å€™é€‰æ¡†æå–åˆ°çš„ç‰¹å¾ï¼‰å­˜åˆ°ç¡¬ç›˜ æ­¥éª¤å››ï¼šè®­ç»ƒä¸€ä¸ªSVMåˆ†ç±»å™¨ï¼ˆäºŒåˆ†ç±»ï¼‰æ¥åˆ¤æ–­è¿™ä¸ªå€™é€‰æ¡†é‡Œç‰©ä½“çš„ç±»åˆ« æ¯ä¸ªç±»åˆ«å¯¹åº”ä¸€ä¸ªSVMï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯å±äºè¿™ä¸ªç±»åˆ«ï¼Œæ˜¯å°±æ˜¯positiveï¼Œåä¹‹nagativeã€‚ æ¯”å¦‚ä¸‹å›¾ï¼Œå°±æ˜¯ç‹—åˆ†ç±»çš„SVM æ­¥éª¤äº”ï¼šä½¿ç”¨å›å½’å™¨ç²¾ç»†ä¿®æ­£å€™é€‰æ¡†ä½ç½®ï¼šå¯¹äºæ¯ä¸€ä¸ªç±»ï¼Œè®­ç»ƒä¸€ä¸ªçº¿æ€§å›å½’æ¨¡å‹å»åˆ¤å®šè¿™ä¸ªæ¡†æ˜¯å¦æ¡†å¾—å®Œç¾ã€‚ ç»†å¿ƒçš„åŒå­¦å¯èƒ½çœ‹å‡ºæ¥äº†é—®é¢˜ï¼ŒR-CNNè™½ç„¶ä¸å†åƒä¼ ç»Ÿæ–¹æ³•é‚£æ ·ç©·ä¸¾ï¼Œä½†R-CNNæµç¨‹çš„ç¬¬ä¸€æ­¥ä¸­å¯¹åŸå§‹å›¾ç‰‡é€šè¿‡Selective Searchæå–çš„å€™é€‰æ¡†region proposalå¤šè¾¾2000ä¸ªå·¦å³ï¼Œè€Œè¿™2000ä¸ªå€™é€‰æ¡†æ¯ä¸ªæ¡†éƒ½éœ€è¦è¿›è¡ŒCNNæç‰¹å¾+SVMåˆ†ç±»ï¼Œè®¡ç®—é‡å¾ˆå¤§ï¼Œå¯¼è‡´R-CNNæ£€æµ‹é€Ÿåº¦å¾ˆæ…¢ï¼Œä¸€å¼ å›¾éƒ½éœ€è¦47sã€‚ æœ‰æ²¡æœ‰æ–¹æ³•æé€Ÿå‘¢ï¼Ÿç­”æ¡ˆæ˜¯æœ‰çš„ï¼Œè¿™2000ä¸ªregion proposalä¸éƒ½æ˜¯å›¾åƒçš„ä¸€éƒ¨åˆ†å—ï¼Œé‚£ä¹ˆæˆ‘ä»¬å®Œå…¨å¯ä»¥å¯¹å›¾åƒæä¸€æ¬¡å·ç§¯å±‚ç‰¹å¾ï¼Œç„¶ååªéœ€è¦å°†region proposalåœ¨åŸå›¾çš„ä½ç½®æ˜ å°„åˆ°å·ç§¯å±‚ç‰¹å¾å›¾ä¸Šï¼Œè¿™æ ·å¯¹äºä¸€å¼ å›¾åƒæˆ‘ä»¬åªéœ€è¦æä¸€æ¬¡å·ç§¯å±‚ç‰¹å¾ï¼Œç„¶åå°†æ¯ä¸ªregion proposalçš„å·ç§¯å±‚ç‰¹å¾è¾“å…¥åˆ°å…¨è¿æ¥å±‚åšåç»­æ“ä½œã€‚ ä½†ç°åœ¨çš„é—®é¢˜æ˜¯æ¯ä¸ªregion proposalçš„å°ºåº¦ä¸ä¸€æ ·ï¼Œè€Œå…¨è¿æ¥å±‚è¾“å…¥å¿…é¡»æ˜¯å›ºå®šçš„é•¿åº¦ï¼Œæ‰€ä»¥ç›´æ¥è¿™æ ·è¾“å…¥å…¨è¿æ¥å±‚è‚¯å®šæ˜¯ä¸è¡Œçš„ã€‚SPP Netæ°å¥½å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ SPP Net SPPï¼šSpatial Pyramid Poolingï¼ˆç©ºé—´é‡‘å­—å¡”æ± åŒ–ï¼‰ SPP-Netæ˜¯å‡ºè‡ª2015å¹´å‘è¡¨åœ¨IEEEä¸Šçš„è®ºæ–‡-ã€ŠSpatial Pyramid Pooling in Deep ConvolutionalNetworks for Visual Recognitionã€‹ã€‚ ä¼—æ‰€å‘¨çŸ¥ï¼ŒCNNä¸€èˆ¬éƒ½å«æœ‰å·ç§¯éƒ¨åˆ†å’Œå…¨è¿æ¥éƒ¨åˆ†ï¼Œå…¶ä¸­ï¼Œå·ç§¯å±‚ä¸éœ€è¦å›ºå®šå°ºå¯¸çš„å›¾åƒï¼Œè€Œå…¨è¿æ¥å±‚æ˜¯éœ€è¦å›ºå®šå¤§å°çš„è¾“å…¥ã€‚ æ‰€ä»¥å½“å…¨è¿æ¥å±‚é¢å¯¹å„ç§å°ºå¯¸çš„è¾“å…¥æ•°æ®æ—¶ï¼Œå°±éœ€è¦å¯¹è¾“å…¥æ•°æ®è¿›è¡Œcropï¼ˆcropå°±æ˜¯ä»ä¸€ä¸ªå¤§å›¾æ‰£å‡ºç½‘ç»œè¾“å…¥å¤§å°çš„patchï¼Œæ¯”å¦‚227Ã—227ï¼‰ï¼Œæˆ–warpï¼ˆæŠŠä¸€ä¸ªè¾¹ç•Œæ¡†bounding boxçš„å†…å®¹resizeæˆ227Ã—227ï¼‰ç­‰ä¸€ç³»åˆ—æ“ä½œä»¥ç»Ÿä¸€å›¾ç‰‡çš„å°ºå¯¸å¤§å°ï¼Œæ¯”å¦‚224224ï¼ˆImageNetï¼‰ã€3232(LenNet)ã€96*96ç­‰ã€‚ æ‰€ä»¥æ‰å¦‚ä½ åœ¨ä¸Šæ–‡ä¸­çœ‹åˆ°çš„ï¼Œåœ¨R-CNNä¸­ï¼Œâ€œå› ä¸ºå–å‡ºçš„åŒºåŸŸå¤§å°å„è‡ªä¸åŒï¼Œæ‰€ä»¥éœ€è¦å°†æ¯ä¸ªRegion Proposalç¼©æ”¾ï¼ˆwarpï¼‰æˆç»Ÿä¸€çš„227x227çš„å¤§å°å¹¶è¾“å…¥åˆ°CNNâ€ã€‚ ä½†warp/cropè¿™ç§é¢„å¤„ç†ï¼Œå¯¼è‡´çš„é—®é¢˜è¦ä¹ˆè¢«æ‹‰ä¼¸å˜å½¢ã€è¦ä¹ˆç‰©ä½“ä¸å…¨ï¼Œé™åˆ¶äº†è¯†åˆ«ç²¾ç¡®åº¦ã€‚æ²¡å¤ªæ˜ç™½ï¼Ÿè¯´å¥äººè¯å°±æ˜¯ï¼Œä¸€å¼ 16:9æ¯”ä¾‹çš„å›¾ç‰‡ä½ ç¡¬æ˜¯è¦Resizeæˆ1:1çš„å›¾ç‰‡ï¼Œä½ è¯´å›¾ç‰‡å¤±çœŸä¸ï¼Ÿ SPP Netçš„ä½œè€…Kaiming Heç­‰äººé€†å‘æ€è€ƒï¼Œæ—¢ç„¶ç”±äºå…¨è¿æ¥FCå±‚çš„å­˜åœ¨ï¼Œæ™®é€šçš„CNNéœ€è¦é€šè¿‡å›ºå®šè¾“å…¥å›¾ç‰‡çš„å¤§å°æ¥ä½¿å¾—å…¨è¿æ¥å±‚çš„è¾“å…¥å›ºå®šã€‚é‚£å€Ÿé‰´å·ç§¯å±‚å¯ä»¥é€‚åº”ä»»ä½•å°ºå¯¸ï¼Œä¸ºä½•ä¸èƒ½åœ¨å·ç§¯å±‚çš„æœ€ååŠ å…¥æŸç§ç»“æ„ï¼Œä½¿å¾—åé¢å…¨è¿æ¥å±‚å¾—åˆ°çš„è¾“å…¥å˜æˆå›ºå®šçš„å‘¢ï¼Ÿ è¿™ä¸ªâ€œåŒ–è…æœ½ä¸ºç¥å¥‡â€çš„ç»“æ„å°±æ˜¯spatial pyramid pooling layerã€‚ä¸‹å›¾ä¾¿æ˜¯R-CNNå’ŒSPP Netæ£€æµ‹æµç¨‹çš„æ¯”è¾ƒï¼š å®ƒçš„ç‰¹ç‚¹æœ‰ä¸¤ä¸ª: ç»“åˆç©ºé—´é‡‘å­—å¡”æ–¹æ³•å®ç°CNNsçš„å¤šå°ºåº¦è¾“å…¥ã€‚ SPP Netçš„ç¬¬ä¸€ä¸ªè´¡çŒ®å°±æ˜¯åœ¨æœ€åä¸€ä¸ªå·ç§¯å±‚åï¼Œæ¥å…¥äº†é‡‘å­—å¡”æ± åŒ–å±‚ï¼Œä¿è¯ä¼ åˆ°ä¸‹ä¸€å±‚å…¨è¿æ¥å±‚çš„è¾“å…¥å›ºå®šã€‚ æ¢å¥è¯è¯´ï¼Œåœ¨æ™®é€šçš„CNNæœºæ„ä¸­ï¼Œè¾“å…¥å›¾åƒçš„å°ºå¯¸å¾€å¾€æ˜¯å›ºå®šçš„ï¼ˆæ¯”å¦‚224*224åƒç´ ï¼‰ï¼Œè¾“å‡ºåˆ™æ˜¯ä¸€ä¸ªå›ºå®šç»´æ•°çš„å‘é‡ã€‚SPP Netåœ¨æ™®é€šçš„CNNç»“æ„ä¸­åŠ å…¥äº†ROIæ± åŒ–å±‚ï¼ˆROI Poolingï¼‰ï¼Œä½¿å¾—ç½‘ç»œçš„è¾“å…¥å›¾åƒå¯ä»¥æ˜¯ä»»æ„å°ºå¯¸çš„ï¼Œè¾“å‡ºåˆ™ä¸å˜ï¼ŒåŒæ ·æ˜¯ä¸€ä¸ªå›ºå®šç»´æ•°çš„å‘é‡ã€‚ ç®€è¨€ä¹‹ï¼ŒCNNåŸæœ¬åªèƒ½å›ºå®šè¾“å…¥ã€å›ºå®šè¾“å‡ºï¼ŒCNNåŠ ä¸ŠSSPä¹‹åï¼Œä¾¿èƒ½ä»»æ„è¾“å…¥ã€å›ºå®šè¾“å‡ºã€‚ç¥å¥‡å§ï¼Ÿ ROIæ± åŒ–å±‚ä¸€èˆ¬è·Ÿåœ¨å·ç§¯å±‚åé¢ï¼Œæ­¤æ—¶ç½‘ç»œçš„è¾“å…¥å¯ä»¥æ˜¯ä»»æ„å°ºåº¦çš„ï¼Œåœ¨SPP layerä¸­æ¯ä¸€ä¸ªpoolingçš„filterä¼šæ ¹æ®è¾“å…¥è°ƒæ•´å¤§å°ï¼Œè€ŒSPPçš„è¾“å‡ºåˆ™æ˜¯å›ºå®šç»´æ•°çš„å‘é‡ï¼Œç„¶åç»™åˆ°å…¨è¿æ¥FCå±‚ã€‚ åªå¯¹åŸå›¾æå–ä¸€æ¬¡å·ç§¯ç‰¹å¾ åœ¨R-CNNä¸­ï¼Œæ¯ä¸ªå€™é€‰æ¡†å…ˆresizeåˆ°ç»Ÿä¸€å¤§å°ï¼Œç„¶ååˆ†åˆ«ä½œä¸ºCNNçš„è¾“å…¥ï¼Œè¿™æ ·æ˜¯å¾ˆä½æ•ˆçš„ã€‚ è€ŒSPP Netæ ¹æ®è¿™ä¸ªç¼ºç‚¹åšäº†ä¼˜åŒ–ï¼šåªå¯¹åŸå›¾è¿›è¡Œä¸€æ¬¡å·ç§¯è®¡ç®—ï¼Œä¾¿å¾—åˆ°æ•´å¼ å›¾çš„å·ç§¯ç‰¹å¾feature mapï¼Œç„¶åæ‰¾åˆ°æ¯ä¸ªå€™é€‰æ¡†åœ¨feature mapä¸Šçš„æ˜ å°„patchï¼Œå°†æ­¤patchä½œä¸ºæ¯ä¸ªå€™é€‰æ¡†çš„å·ç§¯ç‰¹å¾è¾“å…¥åˆ°SPP layerå’Œä¹‹åçš„å±‚ï¼Œå®Œæˆç‰¹å¾æå–å·¥ä½œã€‚ å¦‚æ­¤è¿™èˆ¬ï¼ŒR-CNNè¦å¯¹æ¯ä¸ªåŒºåŸŸè®¡ç®—å·ç§¯ï¼Œè€ŒSPPNetåªéœ€è¦è®¡ç®—ä¸€æ¬¡å·ç§¯ï¼Œä»è€ŒèŠ‚çœäº†å¤§é‡çš„è®¡ç®—æ—¶é—´ï¼Œæ¯”R-CNNæœ‰ä¸€ç™¾å€å·¦å³çš„æé€Ÿã€‚ Fast R-CNN SPP NetçœŸæ˜¯ä¸ªå¥½æ–¹æ³•ï¼ŒR-CNNçš„è¿›é˜¶ç‰ˆFast R-CNNå°±æ˜¯åœ¨R-CNNçš„åŸºç¡€ä¸Šé‡‡çº³äº†SPP Netæ–¹æ³•ï¼Œå¯¹R-CNNä½œäº†æ”¹è¿›ï¼Œä½¿å¾—æ€§èƒ½è¿›ä¸€æ­¥æé«˜ã€‚ R-CNNä¸Fast R-CNNçš„åŒºåˆ«æœ‰å“ªäº›å‘¢ï¼Ÿ å…ˆè¯´R-CNNçš„ç¼ºç‚¹ï¼šå³ä½¿ä½¿ç”¨äº†Selective Searchç­‰é¢„å¤„ç†æ­¥éª¤æ¥æå–æ½œåœ¨çš„bounding boxä½œä¸ºè¾“å…¥ï¼Œä½†æ˜¯R-CNNä»ä¼šæœ‰ä¸¥é‡çš„é€Ÿåº¦ç“¶é¢ˆï¼ŒåŸå› ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå°±æ˜¯è®¡ç®—æœºå¯¹æ‰€æœ‰regionè¿›è¡Œç‰¹å¾æå–æ—¶ä¼šæœ‰é‡å¤è®¡ç®—ï¼ŒFast-RCNNæ­£æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜è¯ç”Ÿçš„ã€‚ ä¸R-CNNæ¡†æ¶å›¾å¯¹æ¯”ï¼Œå¯ä»¥å‘ç°ä¸»è¦æœ‰ä¸¤å¤„ä¸åŒï¼šä¸€æ˜¯æœ€åä¸€ä¸ªå·ç§¯å±‚ååŠ äº†ä¸€ä¸ªROI pooling layerï¼ŒäºŒæ˜¯æŸå¤±å‡½æ•°ä½¿ç”¨äº†å¤šä»»åŠ¡æŸå¤±å‡½æ•°(multi-task loss)ï¼Œå°†è¾¹æ¡†å›å½’Bounding Box Regressionç›´æ¥åŠ å…¥åˆ°CNNç½‘ç»œä¸­è®­ç»ƒ ROI pooling layerå®é™…ä¸Šæ˜¯SPP-NETçš„ä¸€ä¸ªç²¾ç®€ç‰ˆï¼ŒSPP-NETå¯¹æ¯ä¸ªproposalä½¿ç”¨äº†ä¸åŒå¤§å°çš„é‡‘å­—å¡”æ˜ å°„ï¼Œè€ŒROI pooling layeråªéœ€è¦ä¸‹é‡‡æ ·åˆ°ä¸€ä¸ª7x7çš„ç‰¹å¾å›¾ã€‚å¯¹äºVGG16ç½‘ç»œconv5_3æœ‰512ä¸ªç‰¹å¾å›¾ï¼Œè¿™æ ·æ‰€æœ‰region proposalå¯¹åº”äº†ä¸€ä¸ª77512ç»´åº¦çš„ç‰¹å¾å‘é‡ä½œä¸ºå…¨è¿æ¥å±‚çš„è¾“å…¥ã€‚ æ¢è¨€ä¹‹ï¼Œè¿™ä¸ªç½‘ç»œå±‚å¯ä»¥æŠŠä¸åŒå¤§å°çš„è¾“å…¥æ˜ å°„åˆ°ä¸€ä¸ªå›ºå®šå°ºåº¦çš„ç‰¹å¾å‘é‡ï¼Œè€Œæˆ‘ä»¬çŸ¥é“ï¼Œconvã€poolingã€reluç­‰æ“ä½œéƒ½ä¸éœ€è¦å›ºå®šsizeçš„è¾“å…¥ï¼Œå› æ­¤ï¼Œåœ¨åŸå§‹å›¾ç‰‡ä¸Šæ‰§è¡Œè¿™äº›æ“ä½œåï¼Œè™½ç„¶è¾“å…¥å›¾ç‰‡sizeä¸åŒå¯¼è‡´å¾—åˆ°çš„feature mapå°ºå¯¸ä¹Ÿä¸åŒï¼Œä¸èƒ½ç›´æ¥æ¥åˆ°ä¸€ä¸ªå…¨è¿æ¥å±‚è¿›è¡Œåˆ†ç±»ï¼Œä½†æ˜¯å¯ä»¥åŠ å…¥è¿™ä¸ªç¥å¥‡çš„ROI Poolingå±‚ï¼Œå¯¹æ¯ä¸ªregionéƒ½æå–ä¸€ä¸ªå›ºå®šç»´åº¦çš„ç‰¹å¾è¡¨ç¤ºï¼Œå†é€šè¿‡æ­£å¸¸çš„softmaxè¿›è¡Œç±»å‹è¯†åˆ«ã€‚ R-CNNè®­ç»ƒè¿‡ç¨‹åˆ†ä¸ºäº†ä¸‰ä¸ªé˜¶æ®µï¼Œè€ŒFast R-CNNç›´æ¥ä½¿ç”¨softmaxæ›¿ä»£SVMåˆ†ç±»ï¼ŒåŒæ—¶åˆ©ç”¨å¤šä»»åŠ¡æŸå¤±å‡½æ•°è¾¹æ¡†å›å½’ä¹ŸåŠ å…¥åˆ°äº†ç½‘ç»œä¸­ï¼Œè¿™æ ·æ•´ä¸ªçš„è®­ç»ƒè¿‡ç¨‹æ˜¯ç«¯åˆ°ç«¯çš„(é™¤å»Region Proposalæå–é˜¶æ®µ)ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œä¹‹å‰R-CNNçš„å¤„ç†æµç¨‹æ˜¯å…ˆæproposalï¼Œç„¶åCNNæå–ç‰¹å¾ï¼Œä¹‹åç”¨SVMåˆ†ç±»å™¨ï¼Œæœ€åå†åšbbox regressionï¼Œè€Œåœ¨Fast R-CNNä¸­ï¼Œä½œè€…å·§å¦™çš„æŠŠbbox regressionæ”¾è¿›äº†ç¥ç»ç½‘ç»œå†…éƒ¨ï¼Œä¸regionåˆ†ç±»å’Œå¹¶æˆä¸ºäº†ä¸€ä¸ªmulti-taskæ¨¡å‹ï¼Œå®é™…å®éªŒä¹Ÿè¯æ˜ï¼Œè¿™ä¸¤ä¸ªä»»åŠ¡èƒ½å¤Ÿå…±äº«å·ç§¯ç‰¹å¾ï¼Œå¹¶ç›¸äº’ä¿ƒè¿›ã€‚ æ‰€ä»¥ï¼ŒFast-RCNNå¾ˆé‡è¦çš„ä¸€ä¸ªè´¡çŒ®æ˜¯æˆåŠŸçš„è®©äººä»¬çœ‹åˆ°äº†Region Proposal + CNNè¿™ä¸€æ¡†æ¶å®æ—¶æ£€æµ‹çš„å¸Œæœ›ï¼ŒåŸæ¥å¤šç±»æ£€æµ‹çœŸçš„å¯ä»¥åœ¨ä¿è¯å‡†ç¡®ç‡çš„åŒæ—¶æå‡å¤„ç†é€Ÿåº¦ï¼Œä¹Ÿä¸ºåæ¥çš„Faster R-CNNåšä¸‹äº†é“ºå«ã€‚ ç”»ä¸€ç”»é‡ç‚¹ï¼š R-CNNæœ‰ä¸€äº›ç›¸å½“å¤§çš„ç¼ºç‚¹ï¼ˆæŠŠè¿™äº›ç¼ºç‚¹éƒ½æ”¹æ‰äº†ï¼Œå°±æˆäº†Fast R-CNNï¼‰ã€‚ å¤§ç¼ºç‚¹ï¼šç”±äºæ¯ä¸€ä¸ªå€™é€‰æ¡†éƒ½è¦ç‹¬è‡ªç»è¿‡CNNï¼Œè¿™ä½¿å¾—èŠ±è´¹çš„æ—¶é—´éå¸¸å¤šã€‚ è§£å†³ï¼šå…±äº«å·ç§¯å±‚ï¼Œç°åœ¨ä¸æ˜¯æ¯ä¸€ä¸ªå€™é€‰æ¡†éƒ½å½“åšè¾“å…¥è¿›å…¥CNNäº†ï¼Œè€Œæ˜¯è¾“å…¥ä¸€å¼ å®Œæ•´çš„å›¾ç‰‡ï¼Œåœ¨ç¬¬äº”ä¸ªå·ç§¯å±‚å†å¾—åˆ°æ¯ä¸ªå€™é€‰æ¡†çš„ç‰¹å¾ åŸæ¥çš„æ–¹æ³•ï¼šè®¸å¤šå€™é€‰æ¡†ï¼ˆæ¯”å¦‚ä¸¤åƒä¸ªï¼‰--&gt;CNN--&gt;å¾—åˆ°æ¯ä¸ªå€™é€‰æ¡†çš„ç‰¹å¾--&gt;åˆ†ç±»+å›å½’ ç°åœ¨çš„æ–¹æ³•ï¼šä¸€å¼ å®Œæ•´å›¾ç‰‡--&gt;CNN--&gt;å¾—åˆ°æ¯å¼ å€™é€‰æ¡†çš„ç‰¹å¾--&gt;åˆ†ç±»+å›å½’ æ‰€ä»¥å®¹æ˜“çœ‹è§ï¼ŒFast R-CNNç›¸å¯¹äºR-CNNçš„æé€ŸåŸå› å°±åœ¨äºï¼šä¸è¿‡ä¸åƒR-CNNæŠŠæ¯ä¸ªå€™é€‰åŒºåŸŸç»™æ·±åº¦ç½‘ç»œæç‰¹å¾ï¼Œè€Œæ˜¯æ•´å¼ å›¾æä¸€æ¬¡ç‰¹å¾ï¼Œå†æŠŠå€™é€‰æ¡†æ˜ å°„åˆ°conv5ä¸Šï¼Œè€ŒSPPåªéœ€è¦è®¡ç®—ä¸€æ¬¡ç‰¹å¾ï¼Œå‰©ä¸‹çš„åªéœ€è¦åœ¨conv5å±‚ä¸Šæ“ä½œå°±å¯ä»¥äº†ã€‚ åœ¨æ€§èƒ½ä¸Šæå‡ä¹Ÿæ˜¯ç›¸å½“æ˜æ˜¾çš„ï¼š Faster R-CNN Fast R-CNNå­˜åœ¨çš„é—®é¢˜ï¼šå­˜åœ¨ç“¶é¢ˆï¼šé€‰æ‹©æ€§æœç´¢ï¼Œæ‰¾å‡ºæ‰€æœ‰çš„å€™é€‰æ¡†ï¼Œè¿™ä¸ªä¹Ÿéå¸¸è€—æ—¶ã€‚é‚£æˆ‘ä»¬èƒ½ä¸èƒ½æ‰¾å‡ºä¸€ä¸ªæ›´åŠ é«˜æ•ˆçš„æ–¹æ³•æ¥æ±‚å‡ºè¿™äº›å€™é€‰æ¡†å‘¢ï¼Ÿ è§£å†³ï¼šåŠ å…¥ä¸€ä¸ªæå–è¾¹ç¼˜çš„ç¥ç»ç½‘ç»œï¼Œä¹Ÿå°±è¯´æ‰¾åˆ°å€™é€‰æ¡†çš„å·¥ä½œä¹Ÿäº¤ç»™ç¥ç»ç½‘ç»œæ¥åšäº†ã€‚ æ‰€ä»¥ï¼Œrgbdåœ¨Fast R-CNNä¸­å¼•å…¥Region Proposal Network(RPN)æ›¿ä»£Selective Searchï¼ŒåŒæ—¶å¼•å…¥anchor boxåº”å¯¹ç›®æ ‡å½¢çŠ¶çš„å˜åŒ–é—®é¢˜ï¼ˆanchorå°±æ˜¯ä½ç½®å’Œå¤§å°å›ºå®šçš„boxï¼Œå¯ä»¥ç†è§£æˆäº‹å…ˆè®¾ç½®å¥½çš„å›ºå®šçš„proposalï¼‰ã€‚ å…·ä½“åšæ³•ï¼š â€¢ å°†RPNæ”¾åœ¨æœ€åä¸€ä¸ªå·ç§¯å±‚çš„åé¢ â€¢ RPNç›´æ¥è®­ç»ƒå¾—åˆ°å€™é€‰åŒºåŸŸ RPNç®€ä»‹ï¼š â€¢ åœ¨feature mapä¸Šæ»‘åŠ¨çª—å£ â€¢ å»ºä¸€ä¸ªç¥ç»ç½‘ç»œç”¨äºç‰©ä½“åˆ†ç±»+æ¡†ä½ç½®çš„å›å½’ â€¢ æ»‘åŠ¨çª—å£çš„ä½ç½®æä¾›äº†ç‰©ä½“çš„å¤§ä½“ä½ç½®ä¿¡æ¯ â€¢ æ¡†çš„å›å½’æä¾›äº†æ¡†æ›´ç²¾ç¡®çš„ä½ç½® ä¸€ç§ç½‘ç»œï¼Œå››ä¸ªæŸå¤±å‡½æ•°; â€¢ RPN calssification(anchor good.bad) â€¢ RPN regression(anchor-&gt;propoasal) â€¢ Fast R-CNN classification(over classes) â€¢ Fast R-CNN regression(proposal -&gt;box) é€Ÿåº¦å¯¹æ¯” Faster R-CNNçš„ä¸»è¦è´¡çŒ®å°±æ˜¯è®¾è®¡äº†æå–å€™é€‰åŒºåŸŸçš„ç½‘ç»œRPNï¼Œä»£æ›¿äº†è´¹æ—¶çš„é€‰æ‹©æ€§æœç´¢selective searchï¼Œä½¿å¾—æ£€æµ‹é€Ÿåº¦å¤§å¹…æé«˜ã€‚ æœ€åæ€»ç»“ä¸€ä¸‹å„å¤§ç®—æ³•çš„æ­¥éª¤ï¼š RCNN 1.åœ¨å›¾åƒä¸­ç¡®å®šçº¦1000-2000ä¸ªå€™é€‰æ¡† (ä½¿ç”¨é€‰æ‹©æ€§æœç´¢Selective Search) 2.æ¯ä¸ªå€™é€‰æ¡†å†…å›¾åƒå—ç¼©æ”¾è‡³ç›¸åŒå¤§å°ï¼Œå¹¶è¾“å…¥åˆ°CNNå†…è¿›è¡Œç‰¹å¾æå– 3.å¯¹å€™é€‰æ¡†ä¸­æå–å‡ºçš„ç‰¹å¾ï¼Œä½¿ç”¨åˆ†ç±»å™¨åˆ¤åˆ«æ˜¯å¦å±äºä¸€ä¸ªç‰¹å®šç±» 4.å¯¹äºå±äºæŸä¸€ç±»åˆ«çš„å€™é€‰æ¡†ï¼Œç”¨å›å½’å™¨è¿›ä¸€æ­¥è°ƒæ•´å…¶ä½ç½® Fast R-CNN 1.åœ¨å›¾åƒä¸­ç¡®å®šçº¦1000-2000ä¸ªå€™é€‰æ¡† (ä½¿ç”¨é€‰æ‹©æ€§æœç´¢Selective Search) 2.å¯¹æ•´å¼ å›¾ç‰‡è¾“è¿›CNNï¼Œå¾—åˆ°feature map 3.æ‰¾åˆ°æ¯ä¸ªå€™é€‰æ¡†åœ¨feature mapä¸Šçš„æ˜ å°„patchï¼Œå°†æ­¤patchä½œä¸ºæ¯ä¸ªå€™é€‰æ¡†çš„å·ç§¯ç‰¹å¾è¾“å…¥åˆ°SPP layerå’Œä¹‹åçš„å±‚ 4.å¯¹å€™é€‰æ¡†ä¸­æå–å‡ºçš„ç‰¹å¾ï¼Œä½¿ç”¨åˆ†ç±»å™¨åˆ¤åˆ«æ˜¯å¦å±äºä¸€ä¸ªç‰¹å®šç±» 5.å¯¹äºå±äºæŸä¸€ç±»åˆ«çš„å€™é€‰æ¡†ï¼Œç”¨å›å½’å™¨è¿›ä¸€æ­¥è°ƒæ•´å…¶ä½ç½® Faster R-CNN 1.å¯¹æ•´å¼ å›¾ç‰‡è¾“è¿›CNNï¼Œå¾—åˆ°feature map 2.å·ç§¯ç‰¹å¾è¾“å…¥åˆ°RPNï¼Œå¾—åˆ°å€™é€‰æ¡†çš„ç‰¹å¾ä¿¡æ¯ 3.å¯¹å€™é€‰æ¡†ä¸­æå–å‡ºçš„ç‰¹å¾ï¼Œä½¿ç”¨åˆ†ç±»å™¨åˆ¤åˆ«æ˜¯å¦å±äºä¸€ä¸ªç‰¹å®šç±» 4.å¯¹äºå±äºæŸä¸€ç±»åˆ«çš„å€™é€‰æ¡†ï¼Œç”¨å›å½’å™¨è¿›ä¸€æ­¥è°ƒæ•´å…¶ä½ç½® ç®€è¨€ä¹‹ï¼Œå³å¦‚æœ¬æ–‡å¼€å¤´æ‰€åˆ— R-CNNï¼ˆSelective Search + CNN + SVMï¼‰ SPP-netï¼ˆROI Poolingï¼‰ Fast R-CNNï¼ˆSelective Search + CNN + ROIï¼‰ Faster R-CNNï¼ˆRPN + CNN + ROIï¼‰ æ€»çš„æ¥è¯´ï¼Œä»R-CNN, SPP-NET, Fast R-CNN, Faster R-CNNä¸€è·¯èµ°æ¥ï¼ŒåŸºäºæ·±åº¦å­¦ä¹ ç›®æ ‡æ£€æµ‹çš„æµç¨‹å˜å¾—è¶Šæ¥è¶Šç²¾ç®€ï¼Œç²¾åº¦è¶Šæ¥è¶Šé«˜ï¼Œé€Ÿåº¦ä¹Ÿè¶Šæ¥è¶Šå¿«ã€‚å¯ä»¥è¯´åŸºäºRegion Proposalçš„R-CNNç³»åˆ—ç›®æ ‡æ£€æµ‹æ–¹æ³•æ˜¯å½“å‰ç›®æ ‡æ£€æµ‹æŠ€æœ¯é¢†åŸŸæœ€ä¸»è¦çš„ä¸€ä¸ªåˆ†æ”¯ã€‚ ä¸‰ã€åŸºäºæ·±åº¦å­¦ä¹ çš„å›å½’æ–¹æ³• YOLO (CVPR2016, oral) (You Only Look Once: Unified, Real-Time Object Detection) Faster R-CNNçš„æ–¹æ³•ç›®å‰æ˜¯ä¸»æµçš„ç›®æ ‡æ£€æµ‹æ–¹æ³•ï¼Œä½†æ˜¯é€Ÿåº¦ä¸Šå¹¶ä¸èƒ½æ»¡è¶³å®æ—¶çš„è¦æ±‚ã€‚YOLOä¸€ç±»çš„æ–¹æ³•æ…¢æ…¢æ˜¾ç°å‡ºå…¶é‡è¦æ€§ï¼Œè¿™ç±»æ–¹æ³•ä½¿ç”¨äº†å›å½’çš„æ€æƒ³ï¼Œåˆ©ç”¨æ•´å¼ å›¾ä½œä¸ºç½‘ç»œçš„è¾“å…¥ï¼Œç›´æ¥åœ¨å›¾åƒçš„å¤šä¸ªä½ç½®ä¸Šå›å½’å‡ºè¿™ä¸ªä½ç½®çš„ç›®æ ‡è¾¹æ¡†ï¼Œä»¥åŠç›®æ ‡æ‰€å±çš„ç±»åˆ«ã€‚ æˆ‘ä»¬ç›´æ¥çœ‹ä¸Šé¢YOLOçš„ç›®æ ‡æ£€æµ‹çš„æµç¨‹å›¾ï¼š (1) ç»™ä¸ªä¸€ä¸ªè¾“å…¥å›¾åƒï¼Œé¦–å…ˆå°†å›¾åƒåˆ’åˆ†æˆ77çš„ç½‘æ ¼ (2) å¯¹äºæ¯ä¸ªç½‘æ ¼ï¼Œæˆ‘ä»¬éƒ½é¢„æµ‹2ä¸ªè¾¹æ¡†ï¼ˆåŒ…æ‹¬æ¯ä¸ªè¾¹æ¡†æ˜¯ç›®æ ‡çš„ç½®ä¿¡åº¦ä»¥åŠæ¯ä¸ªè¾¹æ¡†åŒºåŸŸåœ¨å¤šä¸ªç±»åˆ«ä¸Šçš„æ¦‚ç‡ï¼‰ (3) æ ¹æ®ä¸Šä¸€æ­¥å¯ä»¥é¢„æµ‹å‡º77*2ä¸ªç›®æ ‡çª—å£ï¼Œç„¶åæ ¹æ®é˜ˆå€¼å»é™¤å¯èƒ½æ€§æ¯”è¾ƒä½çš„ç›®æ ‡çª—å£ï¼Œæœ€åNMSå»é™¤å†—ä½™çª—å£å³å¯ å¯ä»¥çœ‹åˆ°æ•´ä¸ªè¿‡ç¨‹éå¸¸ç®€å•ï¼Œä¸å†éœ€è¦ä¸­é—´çš„Region Proposalæ‰¾ç›®æ ‡ï¼Œç›´æ¥å›å½’ä¾¿å®Œæˆäº†ä½ç½®å’Œç±»åˆ«çš„åˆ¤å®šã€‚ å°ç»“ï¼šYOLOå°†ç›®æ ‡æ£€æµ‹ä»»åŠ¡è½¬æ¢æˆä¸€ä¸ªå›å½’é—®é¢˜ï¼Œå¤§å¤§åŠ å¿«äº†æ£€æµ‹çš„é€Ÿåº¦ï¼Œä½¿å¾—YOLOå¯ä»¥æ¯ç§’å¤„ç†45å¼ å›¾åƒã€‚è€Œä¸”ç”±äºæ¯ä¸ªç½‘ç»œé¢„æµ‹ç›®æ ‡çª—å£æ—¶ä½¿ç”¨çš„æ˜¯å…¨å›¾ä¿¡æ¯ï¼Œä½¿å¾—false positiveæ¯”ä¾‹å¤§å¹…é™ä½ï¼ˆå……åˆ†çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼‰ã€‚ ä½†æ˜¯YOLOä¹Ÿå­˜åœ¨é—®é¢˜ï¼šæ²¡æœ‰äº†Region Proposalæœºåˆ¶ï¼Œåªä½¿ç”¨7*7çš„ç½‘æ ¼å›å½’ä¼šä½¿å¾—ç›®æ ‡ä¸èƒ½éå¸¸ç²¾å‡†çš„å®šä½ï¼Œè¿™ä¹Ÿå¯¼è‡´äº†YOLOçš„æ£€æµ‹ç²¾åº¦å¹¶ä¸æ˜¯å¾ˆé«˜ã€‚ SSD (SSD: Single Shot MultiBox Detector) ä¸Šé¢åˆ†æäº†YOLOå­˜åœ¨çš„é—®é¢˜ï¼Œä½¿ç”¨æ•´å›¾ç‰¹å¾åœ¨7*7çš„ç²—ç³™ç½‘æ ¼å†…å›å½’å¯¹ç›®æ ‡çš„å®šä½å¹¶ä¸æ˜¯å¾ˆç²¾å‡†ã€‚é‚£æ˜¯ä¸æ˜¯å¯ä»¥ç»“åˆRegion Proposalçš„æ€æƒ³å®ç°ç²¾å‡†ä¸€äº›çš„å®šä½ï¼ŸSSDç»“åˆYOLOçš„å›å½’æ€æƒ³ä»¥åŠFaster R-CNNçš„anchoræœºåˆ¶åšåˆ°äº†è¿™ç‚¹ã€‚ ä¸Šå›¾æ˜¯SSDçš„ä¸€ä¸ªæ¡†æ¶å›¾ï¼Œé¦–å…ˆSSDè·å–ç›®æ ‡ä½ç½®å’Œç±»åˆ«çš„æ–¹æ³•è·ŸYOLOä¸€æ ·ï¼Œéƒ½æ˜¯ä½¿ç”¨å›å½’ï¼Œä½†æ˜¯YOLOé¢„æµ‹æŸä¸ªä½ç½®ä½¿ç”¨çš„æ˜¯å…¨å›¾çš„ç‰¹å¾ï¼ŒSSDé¢„æµ‹æŸä¸ªä½ç½®ä½¿ç”¨çš„æ˜¯è¿™ä¸ªä½ç½®å‘¨å›´çš„ç‰¹å¾ï¼ˆæ„Ÿè§‰æ›´åˆç†ä¸€äº›ï¼‰ã€‚ é‚£ä¹ˆå¦‚ä½•å»ºç«‹æŸä¸ªä½ç½®å’Œå…¶ç‰¹å¾çš„å¯¹åº”å…³ç³»å‘¢ï¼Ÿå¯èƒ½ä½ å·²ç»æƒ³åˆ°äº†ï¼Œä½¿ç”¨Faster R-CNNçš„anchoræœºåˆ¶ã€‚å¦‚SSDçš„æ¡†æ¶å›¾æ‰€ç¤ºï¼Œå‡å¦‚æŸä¸€å±‚ç‰¹å¾å›¾(å›¾b)å¤§å°æ˜¯88ï¼Œé‚£ä¹ˆå°±ä½¿ç”¨33çš„æ»‘çª—æå–æ¯ä¸ªä½ç½®çš„ç‰¹å¾ï¼Œç„¶åè¿™ä¸ªç‰¹å¾å›å½’å¾—åˆ°ç›®æ ‡çš„åæ ‡ä¿¡æ¯å’Œç±»åˆ«ä¿¡æ¯(å›¾c)ã€‚ ä¸åŒäºFaster R-CNNï¼Œè¿™ä¸ªanchoræ˜¯åœ¨å¤šä¸ªfeature mapä¸Šï¼Œè¿™æ ·å¯ä»¥åˆ©ç”¨å¤šå±‚çš„ç‰¹å¾å¹¶ä¸”è‡ªç„¶çš„è¾¾åˆ°å¤šå°ºåº¦ï¼ˆä¸åŒå±‚çš„feature map 3*3æ»‘çª—æ„Ÿå—é‡ä¸åŒï¼‰ã€‚ å°ç»“ï¼šSSDç»“åˆäº†YOLOä¸­çš„å›å½’æ€æƒ³å’ŒFaster R-CNNä¸­çš„anchoræœºåˆ¶ï¼Œä½¿ç”¨å…¨å›¾å„ä¸ªä½ç½®çš„å¤šå°ºåº¦åŒºåŸŸç‰¹å¾è¿›è¡Œå›å½’ï¼Œæ—¢ä¿æŒäº†YOLOé€Ÿåº¦å¿«çš„ç‰¹æ€§ï¼Œä¹Ÿä¿è¯äº†çª—å£é¢„æµ‹çš„è·ŸFaster R-CNNä¸€æ ·æ¯”è¾ƒç²¾å‡†ã€‚SSDåœ¨VOC2007ä¸ŠmAPå¯ä»¥è¾¾åˆ°72.1%ï¼Œé€Ÿåº¦åœ¨GPUä¸Šè¾¾åˆ°58å¸§æ¯ç§’ã€‚ ","link":"https://tianxiawuhao.github.io/cmQOTNxwQ/"},{"title":"å¤šä½“åŠ¨åŠ›å­¦","content":"å¤šä½“åŠ¨åŠ›å­¦ å¤šä½“ç³»ç»ŸåŠ¨åŠ›å­¦æ˜¯ç ”ç©¶å¤šä½“ç³»ç»Ÿ(ä¸€èˆ¬ç”±è‹¥å¹²ä¸ªæŸ”æ€§å’Œåˆšæ€§ç‰©ä½“ç›¸äº’è¿æ¥æ‰€ç»„æˆ)è¿åŠ¨è§„å¾‹çš„ç§‘å­¦ã€‚å®ƒä¸»è¦ç ”ç©¶åœ¨åŠ›ä½œç”¨ä¸‹ï¼Œç‰©ä½“çš„è¿åŠ¨(åæ ‡ã€ä½ç§»ã€é€Ÿåº¦ä»¥åŠåŠ é€Ÿåº¦)ä¸è¿åŠ¨ä¸­äº§ç”Ÿçš„åŠ›çš„å…³ç³»ã€‚å¤šä½“ç³»ç»ŸåŠ¨åŠ›å­¦åŒ…æ‹¬å¤šåˆšä½“ç³»ç»ŸåŠ¨åŠ›å­¦å’Œå¤šæŸ”ä½“ç³»ç»ŸåŠ¨åŠ›å­¦ å¤šåˆšä½“åŠ¨åŠ›å­¦é—®é¢˜ å¯¹äºå¤šåˆšä½“ç³»ç»Ÿï¼Œä»20ä¸–çºª60å¹´ä»£åˆ°80å¹´ä»£ï¼Œå½¢æˆäº†ä¸¤ç±»ä¸åŒçš„æ•°å­¦å»ºæ¨¡æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯æ‹‰æ ¼æœ—æ—¥æ³•å’Œç¬›å¡å°”æ³•ã€‚ æ‹‰æ ¼æœ—æ—¥æ³• æ‹‰æ ¼æœ—æ—¥æ³•æ˜¯ä¸€ç§ç›¸å¯¹åæ ‡æ–¹æ³•ï¼Œä»¥Roberson-Willenburgæ–¹æ³•ä¸ºä»£è¡¨ï¼Œæ˜¯ä»¥ç³»ç»Ÿæ¯ä¸ªè§’çš„ä¸€å¯¹é‚»æ¥åˆšä½“ä¸ºå•å…ƒï¼Œä»¥ä¸€ä¸ªåˆšä½“ä¸ºå‚è€ƒç‰©ï¼Œå¦ä¸€ä¸ªåˆšä½“ç›¸å¯¹è¯¥åˆšä½“çš„ä½ç½®ç”±è§’çš„å¹¿ä¹‰åæ ‡(åˆç§°æ‹‰æ ¼æœ—æ—¥åæ ‡)æ¥æè¿°ï¼Œå¹¿ä¹‰åæ ‡é€šå¸¸ä¸ºé‚»æ¥åˆšä½“ä¹‹é—´çš„ç›¸å¯¹è½¬è§’æˆ–ä½ç§»ã€‚è¿™æ ·å¼€ç¯ç³»ç»Ÿçš„ä½ç½®å®Œå…¨å¯ç”±æ‰€æœ‰è§’çš„æ‹‰æ ¼æœ—æ—¥åæ ‡çŸ©é˜µæ‰€ç¡®å®šã€‚å…¶åŠ¨åŠ›å­¦æ–¹ç¨‹çš„å½¢å¼ä¸ºæ‹‰æ ¼æœ—æ—¥åæ ‡çŸ©é˜µçš„äºŒé˜¶å¾®åˆ†æ–¹ç¨‹ç»„ã€‚ ç¬›å¡å°”æ³• ç¬›å¡å°”æ³•æ˜¯ä¸€ç§ç»å¯¹åæ ‡æ–¹æ³•ï¼Œä»¥ç³»ç»Ÿä¸­æ¯ä¸€ä¸ªç‰©ä½“ä¸ºå•å…ƒï¼Œå»ºç«‹å›ºç»“åœ¨åˆšä½“ä¸Šçš„åæ ‡ç³»ï¼Œåˆšä½“çš„ä½ç½®ç›¸å¯¹äºä¸€ä¸ªå…¬å…±å‚è€ƒåŸºè¿›è¡Œå®šä¹‰ï¼Œå…¶ä½ç½®åæ ‡(ä¹Ÿå¯ç§°ä¸ºå¹¿ä¹‰åæ ‡)ç»Ÿä¸€ä¸ºåˆšä½“åæ ‡ç³»åŸºç‚¹çš„ç¬›å¡å°”åæ ‡ä¸åæ ‡ç³»çš„æ–¹ä½åæ ‡ï¼Œæ–¹ä½åæ ‡å¯ä»¥é€‰ç”¨æ¬§æ‹‰è§’æˆ–æ¬§æ‹‰å‚æ•°ã€‚ å¤šæŸ”ä½“åŠ¨åŠ›å­¦é—®é¢˜ æŸ”æ€§å¤šä½“ç³»ç»Ÿé€šå¸¸é€‰å®šä¸€æµ®åŠ¨åæ ‡ç³»æè¿°ç‰©ä½“çš„å¤§èŒƒå›´è¿åŠ¨ï¼Œç‰©ä½“çš„å¼¹æ€§å˜å½¢ç›¸å¯¹è¯¥åæ ‡ç³»å®šä¹‰ã€‚å¼¹æ€§ä½“ç›¸å¯¹äºæµ®åŠ¨åæ ‡ç³»çš„ç¦»æ•£å¯ä»¥é‡‡ç”¨æœ‰é™å•å…ƒæ³•ä¸æ¨¡æ€ç»¼åˆåˆ†ææ–¹æ³•ã€‚ æ ¹æ®åŠ¨åŠ›å­¦åŸºæœ¬åŸç†æ¨å¯¼çš„æŸ”æ€§å¤šä½“ç³»ç»ŸåŠ¨åŠ›å­¦æ–¹ç¨‹ï¼Œå½¢å¼ä¸ä¸Šè¿°ä¸¤ç§åˆšä½“ç³»ç»ŸåŠ¨åŠ›å­¦æ–¹ç¨‹ç›¸åŒï¼ŒæŸ”æ€§å¤šä½“ç³»ç»Ÿå…·æœ‰ä¸å¤šåˆšä½“ç³»ç»Ÿç±»åŒçš„åŠ¨åŠ›å­¦æ•°å­¦æ¨¡å‹ã€‚ å¯¹æ¯” æœ‰é™å…ƒè½¯ä»¶ä¹Ÿèƒ½è€ƒè™‘ç‰©ä½“è¿åŠ¨æ—¶çš„é€Ÿåº¦ï¼ŒåŠ é€Ÿåº¦ç­‰ï¼Œå¤šä½“åŠ¨åŠ›å­¦è½¯ä»¶ä¹Ÿèƒ½è€ƒè™‘æŸ”æ€§ä½“çš„åº”åŠ›ï¼Œåº”å˜ç­‰ï¼Œé‚£ä¹ˆåŠ¨åŠ›æœ‰é™å…ƒä¸æŸ”æ€§å¤šä½“ç³»ç»Ÿç­‰ä»·å—? ä¸¤è€…è‚¯å®šæ˜¯ä¸ç­‰ä»·çš„ã€‚ä»åŠ›å­¦åŸç†ä¸Šï¼Œæœ‰é™å…ƒè½¯ä»¶ä¸å¤šä½“åŠ¨åŠ›å­¦è½¯ä»¶æœ‰æœ¬è´¨çš„åŒºåˆ«ï¼Œå®ƒä»¬æœ‰ç€ä¸åŒçš„åŸºæœ¬æ–¹ç¨‹ã€‚æœºæ¢°é¢†åŸŸæœ‰é™å…ƒçš„ç†è®ºåŸºç¡€æ˜¯å¼¹æ€§åŠ›å­¦ï¼Œè€Œå¤šä½“åŠ¨åŠ›å­¦è½¯ä»¶çš„ç†è®ºåŸºç¡€æ˜¯åˆ†æåŠ›å­¦ã€‚ æœ‰é™å…ƒçš„åŸºæœ¬æ–¹ç¨‹è¡¨å¾çš„æ˜¯å†…åŠ›ä¸å¤–åŠ›å¹³è¡¡å…³ç³»ï¼Œåœ¨è¿™ä¸ªæ–¹ç¨‹çš„åŸºç¡€ä¸Šè€ƒè™‘äº†ç‰©ä½“çš„è¿åŠ¨è€Œå¤šä½“åŠ¨åŠ›å­¦ä¸­çš„åŸºæœ¬æ–¹ç¨‹è¡¨å¾çš„æ˜¯è¿åŠ¨å‚æ•°ä¸å—åŠ›å…³ç³»ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šè€ƒè™‘äº†ç‰©ä½“çš„å˜å½¢ã€åº”åŠ›ã€åº”å˜ç­‰ã€‚ æœ‰é™å…ƒæ“…é•¿æè¿°ç‰©ä½“å˜å½¢ã€åº”åŠ›ã€åº”å˜ç­‰ï¼Œå¾ˆå¤šå¤šä½“åŠ¨åŠ›å­¦ä¸­ä¸èƒ½å¤„ç†æˆ–éš¾ä»¥å¤„ç†çš„é—®é¢˜ï¼Œæœ‰é™å…ƒéƒ½èƒ½å¤„ç†ï¼Œä¾‹å¦‚ï¼Œææ–™çš„å¤±æ•ˆã€ä¸åŒç‰©ç†åœºçš„è€¦åˆã€å¤æ‚çš„æ¥è§¦ä»¥åŠä»¥åŠæŸ”æ€§ä½“é›¶ä»¶çš„ä¼˜åŒ–è®¾è®¡ç­‰ã€‚ å¤šä½“åŠ¨åŠ›å­¦æ“…é•¿æè¿°ç‰©ä½“çš„è¿åŠ¨è¿‡ç¨‹ä¸­çš„é€Ÿåº¦ã€åŠ é€Ÿåº¦ã€å—åŠ›ç­‰ï¼Œå¯¹äºå¤æ‚çš„è¿åŠ¨å…³ç³»ï¼Œåº”ç”¨æœ‰é™å…ƒè½¯ä»¶æ¥è®¡ç®—ç»“æ„çš„åŠ¨åŠ›å­¦é—®é¢˜æ˜¯è¾ƒä¸ºå›°éš¾çš„ï¼Œç‰¹åˆ«æ˜¯è‹¥æœºæ„çš„è¿åŠ¨å…³ç³»å­˜åœ¨éçº¿æ€§ç‰¹æ€§ï¼Œæœ‰é™å…ƒè½¯ä»¶æ˜¯ä¸èƒ½ç›´æ¥å¤„ç†ã€‚æœºæ¢°ç³»ç»Ÿä¸æ§åˆ¶ç³»ç»Ÿçš„è”åˆä»¿çœŸï¼Œä¹Ÿæ˜¯æœ‰é™å…ƒè½¯ä»¶ä¸èƒ½å¤„ç†çš„ã€‚ ä¸¤ç§è½¯ä»¶åœ¨ä¸åŒé¢†åŸŸå„æœ‰ä¼˜åŠ¿ï¼Œåº”è¯¥æ ¹æ®é¡¹ç›®éœ€æ±‚é€‰ç”¨ã€‚å¦‚æœåˆ†æä¸­è¿åŠ¨å…³ç³»å¤æ‚ï¼Œç‰¹åˆ«æ˜¯é›¶ä»¶çš„è¿åŠ¨ç‰¹å¾æ˜¯æˆ‘ä»¬å…³å¿ƒçš„å†…å®¹æ—¶ï¼Œåº”è¯¥é€‰ç”¨å¤šä½“åŠ¨åŠ›å­¦è½¯ä»¶;å¦‚æœåˆ†æä¸­é›¶ä»¶å˜å½¢æœºåˆ¶æ¯”è¾ƒå¤æ‚(å¦‚ææ–™å¤±æ•ˆï¼Œéçº¿æ€§ç­‰)ï¼Œç‰¹åˆ«æ˜¯é›¶ä»¶çš„å˜å½¢æ˜¯æˆ‘ä»¬çš„ç ”ç©¶å†…å®¹æ—¶ï¼Œåº”è¯¥é€‰ç”¨æœ‰é™å…ƒè½¯ä»¶ã€‚ ä¾‹å¦‚ï¼Œåˆ©ç”¨ADAMSè¿›è¡Œè½¦è¾†å¹³é¡ºæ€§åˆ†æä¸­ï¼Œæˆ‘ä»¬ä¼šå»ºç«‹æ‚¬æ¶åŠ¨åŠ›å­¦å‹ï¼Œå…¶ä¸­å…³å¿ƒçš„é›¶ä»¶å¯ä»¥å¤„ç†ä¸ºæŸ”æ€§ä½“ã€‚åŒæ ·ï¼Œåœ¨åˆ©ç”¨LS-DYNAè¿›è¡Œæ•´è½¦ç¢°æ’åˆ†æä¸­ï¼Œæˆ‘ä»¬ä¹Ÿä¼šå»ºç«‹æ‚¬æ¶çš„æœ‰é™å…ƒæ¨¡å‹ã€‚æ˜¾ç„¶ADAMSä¸­æ¨¡å‹å¯¹æ‚¬æ¶è¿åŠ¨çš„æè¿°ä¼šæ›´åŠ ç²¾ç¡®ï¼Œè€ŒLS-DYNAä¸­çš„æ¨¡å‹å¯¹æ‚¬æ¶çš„å˜å½¢æè¿°çš„æ›´åŠ ç²¾ç¡®ã€‚ ","link":"https://tianxiawuhao.github.io/BO3Wz58QH/"},{"title":"æœ‰é™å…ƒåˆ†æ","content":"æœ‰é™å…ƒæ–¹æ³•ï¼š åŸºäºæ•°å­¦åŠ›å­¦åŸç†ï¼Œé‡‡ç”¨è®¡ç®—æœºä¿¡æ¯åŒ–åˆ†ææ‰‹æ®µï¼Œå®Œæ•´è·å–å¤æ‚å·¥ç¨‹é—®é¢˜åŠç§‘å­¦ç ”ç©¶ä¸­çš„å®šé‡åŒ–ç»“æœï¼Œä¹Ÿè¢«ç§°ä¸ºä¸€ç§åŸºäºè®¡ç®—æœºä¿¡æ¯åŒ–å¤„ç†çš„â€œè™šæ‹Ÿå®éªŒâ€ã€‚åœ¨æ•°å­¦ä¸Šå®ƒæ˜¯æ±‚å–å¤æ‚å¾®åˆ†æ–¹ç¨‹è¿‘ä¼¼è§£çš„æœ‰æ•ˆå·¥å…·ã€‚æœ‰é™å…ƒåˆ†æçš„åŠ›å­¦åŸºç¡€æ˜¯å¼¹æ€§åŠ›å­¦ã€‚å®ç°çš„æ–¹æ³•æ˜¯æ•°å€¼åŒ–ç¦»æ•£æŠ€æœ¯ï¼Œæœ€ç»ˆçš„è½½ä½“æ˜¯æœ‰é™å…ƒåˆ†æè½¯ä»¶ã€‚ æœ‰é™å…ƒåˆ†æï¼š ç”¨è¾ƒç®€å•çš„é—®é¢˜ä»£æ›¿å¤æ‚é—®é¢˜åå†æ±‚è§£ã€‚å®ƒå°†æ±‚è§£åŸŸçœ‹æˆæ˜¯ç”±è®¸å¤šç§°ä¸ºæœ‰é™å…ƒçš„å°çš„äº’è¿å­åŸŸç»„æˆï¼Œå¯¹æ¯ä¸€å•å…ƒå‡å®šä¸€ä¸ªåˆé€‚çš„ï¼ˆè¾ƒç®€å•çš„ï¼‰è¿‘ä¼¼è§£ï¼Œç„¶åæ¨å¯¼æ±‚è§£è¿™ä¸ªåŸŸæ€»çš„æ»¡è¶³æ¡ä»¶ï¼ˆå¦‚ç»“æ„çš„å¹³è¡¡æ¡ä»¶ï¼‰ï¼Œä»è€Œå¾—åˆ°é—®é¢˜çš„è§£ã€‚ æœ‰é™å…ƒæ±‚è§£çš„æµç¨‹ ç¬¬ä¸€æ­¥ é¢„å¤„ç† æ ¹æ®å®é™…é—®é¢˜å®šä¹‰æ±‚è§£æ¨¡å‹ï¼ŒåŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š å®šä¹‰é—®é¢˜çš„å‡ ä½•åŒºåŸŸï¼šæ ¹æ®å®é™…é—®é¢˜è¿‘ä¼¼ç¡®å®šæ±‚è§£åŸŸçš„ç‰©ç†æ€§è´¨å’Œå‡ ä½•åŒºåŸŸï¼› å®šä¹‰å•å…ƒçš„ææ–™å±æ€§ï¼› å®šä¹‰è¾¹ç•Œæ¡ä»¶ï¼› å®šä¹‰è½½è·ã€‚ ç¬¬äºŒæ­¥ ç¦»æ•£åŒ– é€‰æ‹©åˆé€‚çš„å•å…ƒç±»å‹ï¼Œå¯¹ç»“æ„è¿›è¡Œç¦»æ•£åŒ– æŒ‰å½¢çŠ¶å¯ä»¥åˆ†ä»¥ä¸‹ç±»å‹ 1. ä¸€ç»´å•å…ƒï¼šä¸€ç»´å•å…ƒç”¨äºæ¨¡æ‹Ÿæ²¿ä¸€æ¡ç›´çº¿çš„ç»“æ„ï¼Œå¦‚æ¢æˆ–æ†ä»¶ã€‚å¸¸è§çš„ä¸€ç»´å•å…ƒåŒ…æ‹¬æ¢å•å…ƒï¼ˆBeam Elementï¼‰å’Œæ†å•å…ƒï¼ˆTruss Elementï¼‰ã€‚æ¢å•å…ƒé€šå¸¸ç”¨äºæ¨¡æ‹Ÿæ¢çš„å¼¯æ›²å’Œæ‰­è½¬è¡Œä¸ºï¼Œè€Œæ†å•å…ƒåˆ™é€šå¸¸ç”¨äºæ¨¡æ‹Ÿå—æ‹‰æˆ–å—å‹çš„æ†ä»¶ã€‚ 2. äºŒç»´å•å…ƒï¼šäºŒç»´å•å…ƒç”¨äºæ¨¡æ‹Ÿå¹³é¢ç»“æ„ï¼Œå¦‚æ¿æˆ–å£³ä½“ã€‚å¸¸è§çš„äºŒç»´å•å…ƒåŒ…æ‹¬ä¸‰è§’å½¢å•å…ƒï¼ˆTriangle Elementï¼‰å’Œå››è¾¹å½¢å•å…ƒï¼ˆQuadrilateral Elementï¼‰ã€‚è¿™äº›å•å…ƒå¯ä»¥ç”¨äºæ¨¡æ‹Ÿå¹³é¢ç»“æ„çš„åº”åŠ›ã€åº”å˜å’Œå˜å½¢ç­‰è¡Œä¸ºã€‚ 3. ä¸‰ç»´å•å…ƒï¼šä¸‰ç»´å•å…ƒç”¨äºæ¨¡æ‹Ÿç«‹ä½“ç»“æ„ï¼Œå¦‚å®ä½“æˆ–ä½“ç´ ã€‚å¸¸è§çš„ä¸‰ç»´å•å…ƒåŒ…æ‹¬å››é¢ä½“å•å…ƒï¼ˆTetrahedral Elementï¼‰ã€å…­é¢ä½“å•å…ƒï¼ˆHexahedral Elementï¼‰å’Œæ£±æŸ±å•å…ƒï¼ˆPrismatic Elementï¼‰ã€‚è¿™äº›å•å…ƒå¯ä»¥ç”¨äºæ¨¡æ‹Ÿç«‹ä½“ç»“æ„çš„åº”åŠ›ã€åº”å˜å’Œå˜å½¢ç­‰è¡Œä¸ºã€‚ 4. éç»“æ„å•å…ƒï¼šéç»“æ„å•å…ƒé€‚ç”¨äºå¤æ‚å‡ ä½•å½¢çŠ¶çš„ç»“æ„ï¼Œå¦‚æ±½è½¦è½¦èº«æˆ–é£æœºç¿¼ç­‰ã€‚è¿™äº›å•å…ƒçš„å½¢çŠ¶å¯ä»¥æ ¹æ®å…·ä½“çš„ç»“æ„å½¢çŠ¶è¿›è¡Œçµæ´»çš„è°ƒæ•´ï¼Œä»¥é€‚åº”å¤æ‚çš„å‡ ä½•å½¢çŠ¶ã€‚ æŒ‰å•å…ƒé˜¶æ¬¡åˆ†ä¸ºä»¥ä¸‹ç±»å‹ 1.ä¸€é˜¶å•å…ƒï¼ˆLinear Elementï¼‰ï¼šä¸€é˜¶å•å…ƒä½¿ç”¨çº¿æ€§æ’å€¼å‡½æ•°ï¼Œåœ¨æ¯ä¸ªå•å…ƒå†…éƒ¨è¿‘ä¼¼è§£çš„å˜åŒ–æƒ…å†µã€‚ä¸€é˜¶å•å…ƒå…·æœ‰ä½é˜¶ï¼Œè®¡ç®—é€Ÿåº¦è¾ƒå¿«ï¼Œä½†ç²¾åº¦è¾ƒä½ã€‚ 2.äºŒé˜¶å•å…ƒï¼ˆQuadratic Elementï¼‰ï¼šäºŒé˜¶å•å…ƒä½¿ç”¨äºŒæ¬¡æ’å€¼å‡½æ•°ï¼Œåœ¨æ¯ä¸ªå•å…ƒå†…éƒ¨æ›´å‡†ç¡®åœ°è¿‘ä¼¼è§£çš„å˜åŒ–æƒ…å†µã€‚äºŒé˜¶å•å…ƒæ¯”ä¸€é˜¶å•å…ƒå…·æœ‰æ›´é«˜çš„ç²¾åº¦ï¼Œä½†è®¡ç®—æˆæœ¬ç¨é«˜ã€‚ 3.ä¸‰é˜¶å•å…ƒï¼ˆCubic Elementï¼‰ï¼šä¸‰é˜¶å•å…ƒä½¿ç”¨ä¸‰æ¬¡æ’å€¼å‡½æ•°ï¼Œåœ¨æ¯ä¸ªå•å…ƒå†…éƒ¨æ›´ç²¾ç¡®åœ°é€¼è¿‘è§£çš„å˜åŒ–æƒ…å†µã€‚ä¸‰é˜¶å•å…ƒå…·æœ‰æ›´é«˜çš„ç²¾åº¦ï¼Œä½†è®¡ç®—æˆæœ¬ç›¸å¯¹æ›´é«˜ã€‚ é™¤äº†ä¸Šè¿°å¸¸è§çš„å•å…ƒé˜¶æ¬¡å¤–ï¼Œè¿˜å­˜åœ¨æ›´é«˜é˜¶çš„å•å…ƒç±»å‹ï¼Œå¦‚å››é˜¶å•å…ƒã€äº”é˜¶å•å…ƒç­‰ï¼Œé€šè¿‡ä½¿ç”¨æ›´é«˜æ¬¡çš„æ’å€¼å‡½æ•°æ¥æ›´å‡†ç¡®åœ°é€¼è¿‘è§£çš„å˜åŒ–ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œéœ€æ ¹æ®å…·ä½“çš„å·¥ç¨‹é—®é¢˜å’Œè¦æ±‚é€‰æ‹©é€‚å½“çš„å•å…ƒé˜¶æ¬¡åœ¨ç²¾åº¦å’Œè®¡ç®—æ•ˆç‡ä¹‹é—´è¿›è¡Œæƒè¡¡ã€‚è¾ƒä½é˜¶çš„å•å…ƒé€šå¸¸ç”¨äºåˆæ­¥è®¾è®¡å’Œè¿…é€Ÿåˆ†æï¼Œè€Œè¾ƒé«˜é˜¶çš„å•å…ƒåˆ™ç”¨äºå¯¹ç»“æ„è¿›è¡Œæ›´ç²¾ç¡®çš„åˆ†æå’Œç ”ç©¶ã€‚ ä¸åŒç±»å‹çš„æœ‰é™å…ƒå•å…ƒé€‚ç”¨äºä¸åŒçš„ç»“æ„å½¢çŠ¶å’Œåˆ†æéœ€æ±‚ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œéœ€è¦æ ¹æ®å…·ä½“çš„å·¥ç¨‹é—®é¢˜é€‰æ‹©é€‚åˆçš„æœ‰é™å…ƒå•å…ƒç±»å‹ï¼Œä»¥è·å¾—å‡†ç¡®çš„åˆ†æç»“æœã€‚ ç¬¬ä¸‰æ­¥ å•å…ƒåˆšåº¦çŸ©é˜µ(å•å…ƒçš„åŸºå‡½æ•°) å¯ä»¥ä½¿ç”¨ä¸åŒçš„æ–¹æ³•æ¥æ¨å¯¼æœ‰é™å…ƒåˆ†æä¸­çš„åŸºæœ¬åˆšåº¦çŸ©é˜µï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯åŸºäºå¹³è¡¡çš„æ¦‚å¿µï¼š ç›´æ¥è§£ææ³•ï¼š åˆ—å‡ºé—®é¢˜çš„æ–¹ç¨‹ï¼Œé€šè¿‡å¯»æ‰¾æ»¡è¶³å…¨åœºæ¡ä»¶çš„è§£å‡½æ•°ç›´æ¥æ±‚è§£å¾®åˆ†æ–¹ç¨‹ï¼ŒæŠ€æœ¯éš¾åº¦è¾ƒé«˜ï¼Œå¹¶ä¸”ç›´è‡³ç”¨äºè§£å†³ä¸€äº›è¾ƒä¸ºç®€å•çš„é—®é¢˜ã€‚ã€ç›´æ¥ä»å¼ºå½¢å¼å‡ºå‘æ±‚è§£ã€‘ æ•°å€¼è§£æ³•ï¼š å·®åˆ†æ³•ï¼š é€šè¿‡å¾®åˆ†æ‰¾å‡ºå·®å•†ï¼Œåˆ—å‡ºçº¿æ€§æ–¹ç¨‹ç»„è¿›è¡Œæ±‚è§£ï¼Œæ“ä½œæ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯è®¡ç®—é‡å¾ˆå¤§ï¼Œè§£å†³ä¸€äº›è¾ƒä¸ºå¤æ‚çš„é—®é¢˜ã€‚å¯ä»¥çœ‹å‡ºå·®åˆ†æ³•è¦æ¯”è§£ææ³•æœ‰äº†ä¸€äº›ä¾¿åˆ©æ€§ï¼Œä½†æ˜¯æƒ³è¦æ“ä½œæ›´ç®€å•ï¼Œè§£å†³çš„é—®é¢˜æ›´å¹¿å°±éœ€è¦è¯•å‡½æ•°ï¼ è¯•å‡½æ•°æ³•ã€ä»å¼±å½¢å¼å‡ºå‘æ±‚è§£ã€‘ï¼š ç”¨ç§¯åˆ†å½¢å¼æè¿°å¾®åˆ†æ–¹ç¨‹ï¼Œè€Œä¸æ˜¯ç›´æ¥æ±‚è§£å¾®åˆ†æ–¹ç¨‹ã€‚å‡è®¾çš„è¯•å‡½æ•°æ»¡è¶³ä¸€å®šçš„è¾¹ç•Œæ¡ä»¶ï¼Œä»£å…¥åˆ°æ§åˆ¶æ–¹ç¨‹ä¸­ï¼Œä½¿å¾—æå€¼æœ€å°ï¼Œæ±‚è§£çº¿æ€§æ–¹ç¨‹ç»„ã€‚æ“ä½œç®€å•ï¼Œè®¡ç®—é‡è¾ƒå°ï¼Œç²¾åº¦ä¹Ÿè¾ƒé«˜ï¼Œåªè¦ç¡®å®šäº†è¯•å‡½æ•°ï¼Œåç»­çš„è¿‡ç¨‹ä¹Ÿä¼šéå¸¸è§„èŒƒï¼Œé€‚ç”¨èŒƒå›´å¾ˆå¹¿ï¼å…¶ä¸­è¯•å‡½æ•°æ³•ç”±äºåœ¨å·¥ç¨‹å’Œæ•°å­¦ä¸Šçš„ä¸åŒå‘å±•æœ‰è¯¾åˆ†ä¸ºå˜åˆ†æ³•å’ŒåŠ æƒæ®‹å€¼æ³•ï¼š å˜åˆ†æ–¹æ³•ï¼ˆæœ€å°åŠ¿èƒ½åŸç†ï¼‰ï¼š å½“ä¸€ä¸ªä½“ç³»çš„åŠ¿èƒ½æœ€å°æ—¶ï¼Œç³»ç»Ÿä¼šå¤„äºç¨³å®šå¹³è¡¡çŠ¶æ€ã€‚ä¸¾ä¸ªä¾‹å­æ¥è¯´ï¼Œä¸€ä¸ªå°çƒåœ¨æ›²é¢ä¸Šè¿åŠ¨ï¼Œå½“åˆ°è¾¾æ›²é¢çš„æœ€ä½ç‚¹ä½ç½®æ—¶ï¼Œç³»ç»Ÿå°±ä¼šè¶‹å‘äºç¨³å®šå¹³è¡¡çš„ä¸€ä¸ªåŸç†ã€‚ åŠ æƒæ®‹å€¼æ³•ï¼ˆä¼½è¾½é‡‘æ³•ï¼‰ï¼š é€šè¿‡é€‰å–æœ‰é™å¤šé¡¹å¼å‡½æ•°ï¼ˆåˆç§°åŸºå‡½æ•°æˆ–å½¢å‡½æ•°ï¼‰ï¼Œå°†å®ƒä»¬å åŠ ï¼Œå†è¦æ±‚ç»“æœåœ¨æ±‚è§£åŸŸå†…åŠè¾¹ç•Œä¸Šçš„åŠ æƒç§¯åˆ†ï¼ˆæƒå‡½æ•°ä¸ºè¯•å‡½æ•°æœ¬èº«ï¼‰æ»¡è¶³åŸæ–¹ç¨‹ï¼Œä¾¿å¯ä»¥å¾—åˆ°ä¸€ç»„æ˜“äºæ±‚è§£çš„çº¿æ€§ä»£æ•°æ–¹ç¨‹ï¼Œä¸”è‡ªç„¶è¾¹ç•Œæ¡ä»¶èƒ½å¤Ÿè‡ªåŠ¨æ»¡è¶³ã€‚ ç¬¬å››æ­¥ æ€»è£…(å®šä¹‰å•å…ƒçš„è¿é€šæ€§) æ ¹æ®å„ä¸ªå•å…ƒçš„è¿æ¥æƒ…å†µï¼Œå¯¹å·²ç»å¾—åˆ°çš„å•å…ƒåˆšåº¦çŸ©é˜µè¿›è¡Œç»„è£…ï¼Œä»è€Œå¾—åˆ°æ•´ä½“åˆšåº¦çŸ©é˜µï¼Œè¿™ä¸ªæ•´ä½“åˆšåº¦çŸ©é˜µå†³å®šäº†ç»“æ„å¦‚ä½•å¯¹å—åˆ°çš„è½½è·è¿›è¡Œå“åº”ï¼Œæ€»è£…æ˜¯åœ¨ç›¸é‚»å•å…ƒç»“ç‚¹è¿›è¡Œã€‚çŠ¶æ€å˜é‡åŠå…¶å¯¼æ•°ï¼ˆå¦‚æœå¯èƒ½ï¼‰è¿ç»­æ€§å»ºç«‹åœ¨ç»“ç‚¹å¤„ã€‚ ç¬¬äº”æ­¥ æ±‚è§£è®¡ç®— è”ç«‹æ–¹ç¨‹ç»„çš„æ±‚è§£å¯ç”¨ç›´æ¥æ³•(ç¨€ç–æ±‚è§£å™¨)ã€è¿­ä»£æ³•(è¿­ä»£æ±‚è§£å™¨)ã€‚æ±‚è§£ç»“æœæ˜¯å•å…ƒç»“ç‚¹å¤„çŠ¶æ€å˜é‡çš„è¿‘ä¼¼å€¼ã€‚ ä¸¤ä¸ªæ±‚è§£å™¨å¯ä»¥è¿›è¡Œé›†æˆï¼Œä¸€èˆ¬æœ‰ä¸¤ç§é›†æˆæ–¹å¼ï¼šé¡ºåºé›†æˆå’ŒååŒä»¿çœŸã€‚é¡ºåºé›†æˆï¼Œå³Standardè®¡ç®—å®Œæˆçš„ç»“æœä½œä¸ºExplicitçš„åˆå§‹çŠ¶æ€ç»§ç»­è¿›è¡Œè®¡ç®—ã€‚ååŒä»¿çœŸï¼Œåœ¨åŒä¸€ä¸ªæ¨¡å‹ä¸­ï¼Œå¯ä»¥å°†ä¸€éƒ¨åˆ†åšæˆStandardçš„æ¨¡å‹ï¼Œä¸€éƒ¨åˆ†åšæˆExplicitæ¨¡å‹ï¼Œæ±‚è§£è¿‡ç¨‹ä¸­ä¸¤éƒ¨åˆ†åŒæ—¶è¿›è¡Œï¼Œé€‚æ—¶è¿›è¡Œäº¤äº’æ•°æ®ã€‚ ç¨€ç–æ±‚è§£å™¨ 1ã€ä¸ºçŸ©é˜µæä¾›ç›´æ¥æ±‚è§£ã€‚ 2ã€å¸¦å®½æœªè¿›è¡Œä¼˜åŒ–ï¼Œå› æ­¤èŠ‚çœäº†æ‰§è¡Œæ­¤è¿ç®—æ‰€èŠ±çš„æ—¶é—´ã€‚ 3ã€ä»…å­˜å‚¨éé›¶é¡¹ï¼Œè€Œéæ•´ä¸ªçŸ©é˜µã€‚ï¼ˆæ­£å› ä¸ºå¦‚æ­¤ï¼Œæ‰å‡ºç°äº†â€œç¨€ç–æ±‚è§£å™¨â€è¿™ä¸€æœ¯è¯­ã€‚ï¼‰ 4ã€å°½ç®¡è¦å­˜å‚¨çš„åˆšåº¦çŸ©é˜µé¡¹æ›´å°‘ï¼Œä½†éœ€è¦æ›´å¤šå˜é‡æ‰èƒ½å­˜å‚¨éé›¶é¡¹çš„ä½ç½®ã€‚å› æ­¤ï¼Œç¨€ç–æ±‚è§£å™¨æ¯”å…¶ä»–æ±‚è§£å™¨éœ€è¦æ›´å¤šå†…å­˜ã€‚ 5ã€å¯¹äºä¸­å°å‹æ¨¡å‹ï¼Œç¨€ç–æ±‚è§£å™¨çš„æ±‚è§£é€Ÿåº¦é€šå¸¸æœ€å¿«ã€‚ è¿­ä»£æ±‚è§£å™¨ 1ã€ä¸ºçŸ©é˜µæä¾›é—´æ¥æ±‚è§£ã€‚å› æ­¤ï¼Œç”¨æˆ·å¿…é¡»æŒ‡å®šè¦æ‰§è¡Œçš„æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼Œå¿…é¡»æŒ‡å®šå†³å®šä½•æ—¶æ”¶æ•›è§£çš„æ”¶æ•›å‡†åˆ™ã€‚ä¸èƒ½ä¿è¯åœ¨æŒ‡å®šçš„è¿­ä»£æ¬¡æ•°å†…æ±‚å‡ºçŸ©é˜µè§£ã€‚ 2ã€ç”±äºè¿­ä»£æ±‚è§£å™¨éœ€è¦ä»åˆå§‹çŒœæµ‹å¼€å§‹ï¼Œå› æ­¤æŸäº›å¤„ç†å™¨å…·æœ‰é¢„è°ƒèŠ‚å™¨ã€‚è¿™ä¸ºæé«˜æ¨¡å‹æ±‚è§£æ•ˆç‡æä¾›äº†æ›´å¤šé€‰é¡¹ã€‚ 3ã€å¸¦å®½æœªè¿›è¡Œä¼˜åŒ–ï¼Œå› æ­¤èŠ‚çœäº†æ‰§è¡Œæ­¤è¿ç®—æ‰€èŠ±çš„æ—¶é—´ã€‚ 4ã€è¿­ä»£æ±‚è§£å™¨æ‰€éœ€çš„å†…å­˜æ¯”ç¨€ç–æ±‚è§£å™¨æ›´å°‘ã€‚ 5ã€å¯¹äºå¤§å‹æ¨¡å‹ï¼Œå¦‚æœèƒ½å¤Ÿæ”¶æ•›ï¼Œåˆ™è¿­ä»£æ±‚è§£å™¨çš„æ±‚è§£é€Ÿåº¦æœ€å¿«ã€‚å¤§å°å–å†³äºåˆ†æç±»å‹ã€‚å¯¹äºçº¿æ€§é™æ€åº”åŠ›è€Œè¨€ï¼Œ150,000 ä¸ªæ–¹ç¨‹ï¼ˆæˆ–è‡ªç”±åº¦ï¼‰å±äºå¤§å‹æ¨¡å‹ã€‚è€Œå¯¹äºéœ€è¦æ±‚è§£å¤§é‡æ—¶é—´æ­¥çš„æœºæ¢°è¿åŠ¨ä»¿çœŸè€Œè¨€ï¼Œ50,000 ä¸ªæ–¹ç¨‹æ‰æœ‰å¯èƒ½è§†ä¸ºå¤§å‹æ¨¡å‹ã€‚ ç¬¬å…­æ­¥ åå¤„ç† å¯¹æ‰€æ±‚å‡ºçš„è§£æ ¹æ®æœ‰å…³å‡†åˆ™è¿›è¡Œåˆ†æå’Œè¯„ä»·ã€‚åå¤„ç†ä½¿ç”¨æˆ·èƒ½ç®€ä¾¿æå–ä¿¡æ¯ï¼Œäº†è§£è®¡ç®—ç»“æœã€‚ æœ‰é™å…ƒåˆ†æçš„ä¼˜ç‚¹ ä¼˜ç‚¹ä¸€ åœ¨åˆ¶ä½œåŸå‹ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è®¡ç®—æœºè¾…åŠ©è®¾è®¡æ¨¡å‹æ¿å—æ‰¾åˆ°åº”åŠ›è¿™ä¸€åˆ†åŒºï¼Œæœ‰äº†å®ƒå°±å¯ä»¥é¢„æµ‹å“ªäº›åŒºåŸŸå¯èƒ½ä¼šé¦–å…ˆå¤±æ•ˆï¼Œä»¥åŠå“ªäº›ç¬¬äºŒå’Œç¬¬ä¸‰åŒºåŸŸå¯èƒ½åœ¨è¾ƒé«˜è´Ÿè½½ä¸‹å¤±æ•ˆã€‚é€šè¿‡æ­£ç¡®åº”ç”¨æœ‰é™å…ƒåˆ†æï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»¿çœŸæ¨¡å‹ä¸Šæœ‰æ•ˆåœ°æ‰§è¡Œè®¾è®¡è¿­ä»£ã€‚ ä¼˜ç‚¹äºŒ æˆ‘ä»¬å¯ä»¥æ²¿ç€æ„å»ºå’Œæµ‹è¯•è·¯çº¿çœ‹åˆ°ç‰©ç†æ¨¡å‹çœ‹ä¸åˆ°çš„ä¸œè¥¿ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œå‡å¦‚æˆ‘ä»¬è®©ç°é“¸é“é“¸ä»¶è¿‡è½½ï¼Œåœ¨å®ƒçªç„¶å¼€è£‚æˆ–æ–­è£‚ä¹‹å‰ï¼Œå˜å½¢å¯èƒ½æ˜¯ä¸æ˜æ˜¾çš„ã€‚å¦‚æœæˆ‘ä»¬æƒ³è®©å®ƒåœ¨æŸä¸ªæ–¹å‘å˜å¾—æ›´ç¡¬ï¼Œåœ¨è¯•éªŒå°æ¶ä¸Šæˆ‘ä»¬å¾ˆéš¾æµ‹é‡åˆ°å¦‚æ­¤å°çš„æŒ åº¦ã€‚ä½†é€šè¿‡æœ‰é™å…ƒåˆ†æï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“çœ‹åˆ°å®ƒçš„æŒ åº¦ï¼Œè¿™æœ‰åŠ©äºæˆ‘ä»¬ç†è§£è½½è·è·¯å¾„å¹¶ä»¥æœ€æœ‰æ•ˆçš„æ–¹å¼åŠ å›ºç»“æ„ã€‚ ","link":"https://tianxiawuhao.github.io/3PS50lCPb/"},{"title":"æœºå™¨å­¦ä¹ ç®—æ³•(ä»…äº†è§£)","content":"æœºå™¨å­¦ä¹ åˆ†ç±» æ ¹æ®æ•°æ®ç±»å‹çš„ä¸åŒï¼Œå¯¹ä¸€ä¸ªé—®é¢˜çš„å»ºæ¨¡æœ‰ä¸åŒçš„æ–¹å¼ã€‚åœ¨æœºå™¨å­¦ä¹ æˆ–è€…äººå·¥æ™ºèƒ½é¢†åŸŸï¼Œäººä»¬é¦–å…ˆä¼šè€ƒè™‘ç®—æ³•çš„å­¦ä¹ æ–¹å¼ã€‚åœ¨æœºå™¨å­¦ä¹ é¢†åŸŸï¼Œæœ‰å‡ ç§ä¸»è¦çš„å­¦ä¹ æ–¹å¼ã€‚å°†ç®—æ³•æŒ‰ç…§å­¦ä¹ æ–¹å¼åˆ†ç±»æ˜¯ä¸€ä¸ªä¸é”™çš„æƒ³æ³•ï¼Œè¿™æ ·å¯ä»¥è®©äººä»¬åœ¨å»ºæ¨¡å’Œç®—æ³•é€‰æ‹©çš„æ—¶å€™è€ƒè™‘èƒ½æ ¹æ®è¾“å…¥æ•°æ®æ¥é€‰æ‹©æœ€åˆé€‚çš„ç®—æ³•æ¥è·å¾—æœ€å¥½çš„ç»“æœã€‚ ç›‘ç£å­¦ä¹ ï¼š åœ¨ç›‘ç£å¼å­¦ä¹ ä¸‹ï¼Œè¾“å…¥æ•°æ®è¢«ç§°ä¸ºâ€œè®­ç»ƒæ•°æ®â€ï¼Œæ¯ç»„è®­ç»ƒæ•°æ®æœ‰ä¸€ä¸ªæ˜ç¡®çš„æ ‡è¯†æˆ–ç»“æœï¼Œå¦‚å¯¹é˜²åƒåœ¾é‚®ä»¶ç³»ç»Ÿä¸­â€œåƒåœ¾é‚®ä»¶â€â€œéåƒåœ¾é‚®ä»¶â€ï¼Œå¯¹æ‰‹å†™æ•°å­—è¯†åˆ«ä¸­çš„â€œ1â€œï¼Œâ€2â€œï¼Œâ€3â€œï¼Œâ€4â€œç­‰ã€‚åœ¨å»ºç«‹é¢„æµ‹æ¨¡å‹çš„æ—¶å€™ï¼Œç›‘ç£å¼å­¦ä¹ å»ºç«‹ä¸€ä¸ªå­¦ä¹ è¿‡ç¨‹ï¼Œå°†é¢„æµ‹ç»“æœä¸â€œè®­ç»ƒæ•°æ®â€çš„å®é™…ç»“æœè¿›è¡Œæ¯”è¾ƒï¼Œä¸æ–­çš„è°ƒæ•´é¢„æµ‹æ¨¡å‹ï¼Œç›´åˆ°æ¨¡å‹çš„é¢„æµ‹ç»“æœè¾¾åˆ°ä¸€ä¸ªé¢„æœŸçš„å‡†ç¡®ç‡ã€‚ç›‘ç£å¼å­¦ä¹ çš„å¸¸è§åº”ç”¨åœºæ™¯å¦‚åˆ†ç±»é—®é¢˜å’Œå›å½’é—®é¢˜ã€‚å¸¸è§ç®—æ³•æœ‰é€»è¾‘å›å½’ï¼ˆLogistic Regressionï¼‰å’Œåå‘ä¼ é€’ç¥ç»ç½‘ç»œï¼ˆBack Propagation Neural Networkï¼‰ éç›‘ç£å­¦ä¹ ï¼š åœ¨éç›‘ç£å¼å­¦ä¹ ä¸­ï¼Œæ•°æ®å¹¶ä¸è¢«ç‰¹åˆ«æ ‡è¯†ï¼Œå­¦ä¹ æ¨¡å‹æ˜¯ä¸ºäº†æ¨æ–­å‡ºæ•°æ®çš„ä¸€äº›å†…åœ¨ç»“æ„ã€‚å¸¸è§çš„åº”ç”¨åœºæ™¯åŒ…æ‹¬å…³è”è§„åˆ™çš„å­¦ä¹ ä»¥åŠèšç±»ç­‰ã€‚å¸¸è§ç®—æ³•åŒ…æ‹¬Aprioriç®—æ³•ä»¥åŠk-Meansç®—æ³•ã€‚ åŠç›‘ç£å­¦ä¹ ï¼š åœ¨æ­¤å­¦ä¹ æ–¹å¼ä¸‹ï¼Œè¾“å…¥æ•°æ®éƒ¨åˆ†è¢«æ ‡è¯†ï¼Œéƒ¨åˆ†æ²¡æœ‰è¢«æ ‡è¯†ï¼Œè¿™ç§å­¦ä¹ æ¨¡å‹å¯ä»¥ç”¨æ¥è¿›è¡Œé¢„æµ‹ï¼Œä½†æ˜¯æ¨¡å‹é¦–å…ˆéœ€è¦å­¦ä¹ æ•°æ®çš„å†…åœ¨ç»“æ„ä»¥ä¾¿åˆç†çš„ç»„ç»‡æ•°æ®æ¥è¿›è¡Œé¢„æµ‹ã€‚åº”ç”¨åœºæ™¯åŒ…æ‹¬åˆ†ç±»å’Œå›å½’ï¼Œç®—æ³•åŒ…æ‹¬ä¸€äº›å¯¹å¸¸ç”¨ç›‘ç£å¼å­¦ä¹ ç®—æ³•çš„å»¶ä¼¸ï¼Œè¿™äº›ç®—æ³•é¦–å…ˆè¯•å›¾å¯¹æœªæ ‡è¯†æ•°æ®è¿›è¡Œå»ºæ¨¡ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šå†å¯¹æ ‡è¯†çš„æ•°æ®è¿›è¡Œé¢„æµ‹ã€‚å¦‚å›¾è®ºæ¨ç†ç®—æ³•ï¼ˆGraph Inferenceï¼‰æˆ–è€…æ‹‰æ™®æ‹‰æ–¯æ”¯æŒå‘é‡æœºï¼ˆLaplacian SVM.ï¼‰ç­‰ã€‚ å¼ºåŒ–å­¦ä¹ ï¼š åœ¨è¿™ç§å­¦ä¹ æ¨¡å¼ä¸‹ï¼Œè¾“å…¥æ•°æ®ä½œä¸ºå¯¹æ¨¡å‹çš„åé¦ˆï¼Œä¸åƒç›‘ç£æ¨¡å‹é‚£æ ·ï¼Œè¾“å…¥æ•°æ®ä»…ä»…æ˜¯ä½œä¸ºä¸€ä¸ªæ£€æŸ¥æ¨¡å‹å¯¹é”™çš„æ–¹å¼ï¼Œåœ¨å¼ºåŒ–å­¦ä¹ ä¸‹ï¼Œè¾“å…¥æ•°æ®ç›´æ¥åé¦ˆåˆ°æ¨¡å‹ï¼Œæ¨¡å‹å¿…é¡»å¯¹æ­¤ç«‹åˆ»ä½œå‡ºè°ƒæ•´ã€‚å¸¸è§çš„åº”ç”¨åœºæ™¯åŒ…æ‹¬åŠ¨æ€ç³»ç»Ÿä»¥åŠæœºå™¨äººæ§åˆ¶ç­‰ã€‚å¸¸è§ç®—æ³•åŒ…æ‹¬Q-Learningä»¥åŠæ—¶é—´å·®å­¦ä¹ ï¼ˆTemporal difference learningï¼‰ åœ¨ä¼ä¸šæ•°æ®åº”ç”¨çš„åœºæ™¯ä¸‹ï¼Œ äººä»¬æœ€å¸¸ç”¨çš„å¯èƒ½å°±æ˜¯ç›‘ç£å¼å­¦ä¹ å’Œéç›‘ç£å¼å­¦ä¹ çš„æ¨¡å‹ã€‚åœ¨å›¾åƒè¯†åˆ«ç­‰é¢†åŸŸï¼Œç”±äºå­˜åœ¨å¤§é‡çš„éæ ‡è¯†çš„æ•°æ®å’Œå°‘é‡çš„å¯æ ‡è¯†æ•°æ®ï¼Œ ç›®å‰åŠç›‘ç£å¼å­¦ä¹ æ˜¯ä¸€ä¸ªå¾ˆçƒ­çš„è¯é¢˜ã€‚è€Œå¼ºåŒ–å­¦ä¹ æ›´å¤šçš„åº”ç”¨åœ¨æœºå™¨äººæ§åˆ¶åŠå…¶ä»–éœ€è¦è¿›è¡Œç³»ç»Ÿæ§åˆ¶çš„é¢†åŸŸã€‚ ç®—æ³•åˆ†ç±» æ ¹æ®ç®—æ³•çš„åŠŸèƒ½å’Œå½¢å¼çš„ç±»ä¼¼æ€§ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠç®—æ³•åˆ†ç±»ï¼Œæ¯”å¦‚è¯´åŸºäºæ ‘çš„ç®—æ³•ï¼ŒåŸºäºç¥ç»ç½‘ç»œçš„ç®—æ³•ç­‰ç­‰ã€‚å½“ç„¶ï¼Œæœºå™¨å­¦ä¹ çš„èŒƒå›´éå¸¸åºå¤§ï¼Œæœ‰äº›ç®—æ³•å¾ˆéš¾æ˜ç¡®å½’ç±»åˆ°æŸä¸€ç±»ã€‚è€Œå¯¹äºæœ‰äº›åˆ†ç±»æ¥è¯´ï¼ŒåŒä¸€åˆ†ç±»çš„ç®—æ³•å¯ä»¥é’ˆå¯¹ä¸åŒç±»å‹çš„é—®é¢˜ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å°½é‡æŠŠå¸¸ç”¨çš„ç®—æ³•æŒ‰ç…§æœ€å®¹æ˜“ç†è§£çš„æ–¹å¼è¿›è¡Œåˆ†ç±»ã€‚ å›å½’ç®—æ³•ï¼š å›å½’ç®—æ³•æ˜¯è¯•å›¾é‡‡ç”¨å¯¹è¯¯å·®çš„è¡¡é‡æ¥æ¢ç´¢å˜é‡ä¹‹é—´çš„å…³ç³»çš„ä¸€ç±»ç®—æ³•ã€‚å›å½’ç®—æ³•æ˜¯ç»Ÿè®¡æœºå™¨å­¦ä¹ çš„åˆ©å™¨ã€‚åœ¨æœºå™¨å­¦ä¹ é¢†åŸŸï¼Œäººä»¬è¯´èµ·å›å½’ï¼Œæœ‰æ—¶å€™æ˜¯æŒ‡ä¸€ç±»é—®é¢˜ï¼Œæœ‰æ—¶å€™æ˜¯æŒ‡ä¸€ç±»ç®—æ³•ï¼Œè¿™ä¸€ç‚¹å¸¸å¸¸ä¼šä½¿åˆå­¦è€…æœ‰æ‰€å›°æƒ‘ã€‚å¸¸è§çš„å›å½’ç®—æ³•åŒ…æ‹¬ï¼šæœ€å°äºŒä¹˜æ³•ï¼ˆOrdinary Least Squareï¼‰ï¼Œé€»è¾‘å›å½’ï¼ˆLogistic Regressionï¼‰ï¼Œé€æ­¥å¼å›å½’ï¼ˆStepwise Regressionï¼‰ï¼Œå¤šå…ƒè‡ªé€‚åº”å›å½’æ ·æ¡ï¼ˆMultivariate Adaptive Regression Splinesï¼‰ä»¥åŠæœ¬åœ°æ•£ç‚¹å¹³æ»‘ä¼°è®¡ï¼ˆLocally Estimated Scatterplot Smoothingï¼‰ åŸºäºå®ä¾‹çš„ç®—æ³• åŸºäºå®ä¾‹çš„ç®—æ³•å¸¸å¸¸ç”¨æ¥å¯¹å†³ç­–é—®é¢˜å»ºç«‹æ¨¡å‹ï¼Œè¿™æ ·çš„æ¨¡å‹å¸¸å¸¸å…ˆé€‰å–ä¸€æ‰¹æ ·æœ¬æ•°æ®ï¼Œç„¶åæ ¹æ®æŸäº›è¿‘ä¼¼æ€§æŠŠæ–°æ•°æ®ä¸æ ·æœ¬æ•°æ®è¿›è¡Œæ¯”è¾ƒã€‚é€šè¿‡è¿™ç§æ–¹å¼æ¥å¯»æ‰¾æœ€ä½³çš„åŒ¹é…ã€‚å› æ­¤ï¼ŒåŸºäºå®ä¾‹çš„ç®—æ³•å¸¸å¸¸ä¹Ÿè¢«ç§°ä¸ºâ€œèµ¢å®¶é€šåƒâ€å­¦ä¹ æˆ–è€…â€œåŸºäºè®°å¿†çš„å­¦ä¹ â€ã€‚å¸¸è§çš„ç®—æ³•åŒ…æ‹¬ k-Nearest Neighbor(KNN), å­¦ä¹ çŸ¢é‡é‡åŒ–ï¼ˆLearning Vector Quantizationï¼Œ LVQï¼‰ï¼Œä»¥åŠè‡ªç»„ç»‡æ˜ å°„ç®—æ³•ï¼ˆSelf-Organizing Map ï¼Œ SOMï¼‰ æ­£åˆ™åŒ–æ–¹æ³• æ­£åˆ™åŒ–æ–¹æ³•æ˜¯å…¶ä»–ç®—æ³•ï¼ˆé€šå¸¸æ˜¯å›å½’ç®—æ³•ï¼‰çš„å»¶ä¼¸ï¼Œæ ¹æ®ç®—æ³•çš„å¤æ‚åº¦å¯¹ç®—æ³•è¿›è¡Œè°ƒæ•´ã€‚æ­£åˆ™åŒ–æ–¹æ³•é€šå¸¸å¯¹ç®€å•æ¨¡å‹äºˆä»¥å¥–åŠ±è€Œå¯¹å¤æ‚ç®—æ³•äºˆä»¥æƒ©ç½šã€‚å¸¸è§çš„ç®—æ³•åŒ…æ‹¬ï¼šRidge Regressionï¼ŒLeast Absolute Shrinkage and Selection Operatorï¼ˆLASSOï¼‰ï¼Œä»¥åŠå¼¹æ€§ç½‘ç»œï¼ˆElastic Netï¼‰ã€‚ å†³ç­–æ ‘å­¦ä¹  å†³ç­–æ ‘ç®—æ³•æ ¹æ®æ•°æ®çš„å±æ€§é‡‡ç”¨æ ‘çŠ¶ç»“æ„å»ºç«‹å†³ç­–æ¨¡å‹ï¼Œ å†³ç­–æ ‘æ¨¡å‹å¸¸å¸¸ç”¨æ¥è§£å†³åˆ†ç±»å’Œå›å½’é—®é¢˜ã€‚å¸¸è§çš„ç®—æ³•åŒ…æ‹¬ï¼šåˆ†ç±»åŠå›å½’æ ‘ï¼ˆClassification And Regression Treeï¼Œ CARTï¼‰ï¼Œ ID3 (Iterative Dichotomiser 3)ï¼Œ C4.5ï¼Œ Chi-squared Automatic Interaction Detection(CHAID), Decision Stump, éšæœºæ£®æ—ï¼ˆRandom Forestï¼‰ï¼Œ å¤šå…ƒè‡ªé€‚åº”å›å½’æ ·æ¡ï¼ˆMARSï¼‰ä»¥åŠæ¢¯åº¦æ¨è¿›æœºï¼ˆGradient Boosting Machineï¼Œ GBMï¼‰ è´å¶æ–¯æ–¹æ³• è´å¶æ–¯æ–¹æ³•ç®—æ³•æ˜¯åŸºäºè´å¶æ–¯å®šç†çš„ä¸€ç±»ç®—æ³•ï¼Œä¸»è¦ç”¨æ¥è§£å†³åˆ†ç±»å’Œå›å½’é—®é¢˜ã€‚å¸¸è§ç®—æ³•åŒ…æ‹¬ï¼šæœ´ç´ è´å¶æ–¯ç®—æ³•ï¼Œå¹³å‡å•ä¾èµ–ä¼°è®¡ï¼ˆAveraged One-Dependence Estimatorsï¼Œ AODEï¼‰ï¼Œä»¥åŠBayesian Belief Networkï¼ˆBBNï¼‰ã€‚ åŸºäºæ ¸çš„ç®—æ³• åŸºäºæ ¸çš„ç®—æ³•ä¸­æœ€è‘—åçš„è«è¿‡äºæ”¯æŒå‘é‡æœºï¼ˆSVMï¼‰äº†ã€‚åŸºäºæ ¸çš„ç®—æ³•æŠŠè¾“å…¥æ•°æ®æ˜ å°„åˆ°ä¸€ä¸ªé«˜é˜¶çš„å‘é‡ç©ºé—´ï¼Œ åœ¨è¿™äº›é«˜é˜¶å‘é‡ç©ºé—´é‡Œï¼Œ æœ‰äº›åˆ†ç±»æˆ–è€…å›å½’é—®é¢˜èƒ½å¤Ÿæ›´å®¹æ˜“çš„è§£å†³ã€‚å¸¸è§çš„åŸºäºæ ¸çš„ç®—æ³•åŒ…æ‹¬ï¼šæ”¯æŒå‘é‡æœºï¼ˆSupport Vector Machineï¼Œ SVMï¼‰ï¼Œ å¾„å‘åŸºå‡½æ•°ï¼ˆRadial Basis Function ï¼ŒRBF)ï¼Œ ä»¥åŠçº¿æ€§åˆ¤åˆ«åˆ†æï¼ˆLinear Discriminate Analysis ï¼ŒLDA)ç­‰ èšç±»ç®—æ³• èšç±»ï¼Œå°±åƒå›å½’ä¸€æ ·ï¼Œæœ‰æ—¶å€™äººä»¬æè¿°çš„æ˜¯ä¸€ç±»é—®é¢˜ï¼Œæœ‰æ—¶å€™æè¿°çš„æ˜¯ä¸€ç±»ç®—æ³•ã€‚èšç±»ç®—æ³•é€šå¸¸æŒ‰ç…§ä¸­å¿ƒç‚¹æˆ–è€…åˆ†å±‚çš„æ–¹å¼å¯¹è¾“å…¥æ•°æ®è¿›è¡Œå½’å¹¶ã€‚æ‰€ä»¥çš„èšç±»ç®—æ³•éƒ½è¯•å›¾æ‰¾åˆ°æ•°æ®çš„å†…åœ¨ç»“æ„ï¼Œä»¥ä¾¿æŒ‰ç…§æœ€å¤§çš„å…±åŒç‚¹å°†æ•°æ®è¿›è¡Œå½’ç±»ã€‚å¸¸è§çš„èšç±»ç®—æ³•åŒ…æ‹¬ k-Meansç®—æ³•ä»¥åŠæœŸæœ›æœ€å¤§åŒ–ç®—æ³•ï¼ˆExpectation Maximizationï¼Œ EMï¼‰ã€‚ äººå·¥ç¥ç»ç½‘ç»œ äººå·¥ç¥ç»ç½‘ç»œç®—æ³•æ¨¡æ‹Ÿç”Ÿç‰©ç¥ç»ç½‘ç»œï¼Œæ˜¯ä¸€ç±»æ¨¡å¼åŒ¹é…ç®—æ³•ã€‚é€šå¸¸ç”¨äºè§£å†³åˆ†ç±»å’Œå›å½’é—®é¢˜ã€‚äººå·¥ç¥ç»ç½‘ç»œæ˜¯æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªåºå¤§çš„åˆ†æ”¯ï¼Œæœ‰å‡ ç™¾ç§ä¸åŒçš„ç®—æ³•ã€‚ï¼ˆå…¶ä¸­æ·±åº¦å­¦ä¹ å°±æ˜¯å…¶ä¸­çš„ä¸€ç±»ç®—æ³•ï¼Œæˆ‘ä»¬ä¼šå•ç‹¬è®¨è®ºï¼‰ï¼Œé‡è¦çš„äººå·¥ç¥ç»ç½‘ç»œç®—æ³•åŒ…æ‹¬ï¼šæ„ŸçŸ¥å™¨ç¥ç»ç½‘ç»œï¼ˆPerceptron Neural Networkï¼‰, åå‘ä¼ é€’ï¼ˆBack Propagationï¼‰ï¼Œ Hopfieldç½‘ç»œï¼Œè‡ªç»„ç»‡æ˜ å°„ï¼ˆSelf-Organizing Map, SOMï¼‰ã€‚å­¦ä¹ çŸ¢é‡é‡åŒ–ï¼ˆLearning Vector Quantizationï¼Œ LVQï¼‰ æ·±åº¦å­¦ä¹  æ·±åº¦å­¦ä¹ ç®—æ³•æ˜¯å¯¹äººå·¥ç¥ç»ç½‘ç»œçš„å‘å±•ã€‚åœ¨è¿‘æœŸèµ¢å¾—äº†å¾ˆå¤šå…³æ³¨ï¼Œ ç‰¹åˆ«æ˜¯ç™¾åº¦ä¹Ÿå¼€å§‹å‘åŠ›æ·±åº¦å­¦ä¹ åï¼Œ æ›´æ˜¯åœ¨å›½å†…å¼•èµ·äº†å¾ˆå¤šå…³æ³¨ã€‚ åœ¨è®¡ç®—èƒ½åŠ›å˜å¾—æ—¥ç›Šå»‰ä»·çš„ä»Šå¤©ï¼Œæ·±åº¦å­¦ä¹ è¯•å›¾å»ºç«‹å¤§å¾—å¤šä¹Ÿå¤æ‚å¾—å¤šçš„ç¥ç»ç½‘ç»œã€‚å¾ˆå¤šæ·±åº¦å­¦ä¹ çš„ç®—æ³•æ˜¯åŠç›‘ç£å¼å­¦ä¹ ç®—æ³•ï¼Œç”¨æ¥å¤„ç†å­˜åœ¨å°‘é‡æœªæ ‡è¯†æ•°æ®çš„å¤§æ•°æ®é›†ã€‚å¸¸è§çš„æ·±åº¦å­¦ä¹ ç®—æ³•åŒ…æ‹¬ï¼šå—é™æ³¢å°”å…¹æ›¼æœºï¼ˆRestricted Boltzmann Machineï¼Œ RBNï¼‰ï¼Œ Deep Belief Networksï¼ˆDBNï¼‰ï¼Œå·ç§¯ç½‘ç»œï¼ˆConvolutional Networkï¼‰, å †æ ˆå¼è‡ªåŠ¨ç¼–ç å™¨ï¼ˆStacked Auto-encodersï¼‰ã€‚ å¸¸è§ç®—æ³•ä¼˜åŠ£ æœ´ç´ è´å¶æ–¯ï¼š å¦‚æœç»™å‡ºçš„ç‰¹å¾å‘é‡é•¿åº¦å¯èƒ½ä¸åŒï¼Œè¿™æ˜¯éœ€è¦å½’ä¸€åŒ–ä¸ºé€šé•¿åº¦çš„å‘é‡ï¼ˆè¿™é‡Œä»¥æ–‡æœ¬åˆ†ç±»ä¸ºä¾‹ï¼‰ï¼Œæ¯”å¦‚è¯´æ˜¯å¥å­å•è¯çš„è¯ï¼Œåˆ™é•¿åº¦ä¸ºæ•´ä¸ªè¯æ±‡é‡çš„é•¿åº¦ï¼Œå¯¹åº”ä½ç½®æ˜¯è¯¥å•è¯å‡ºç°çš„æ¬¡æ•°ã€‚ å‡½æ•°è¡¨è¾¾å¼ï¼š å…¶ä¸­ä¸€é¡¹æ¡ä»¶æ¦‚ç‡å¯ä»¥é€šè¿‡æœ´ç´ è´å¶æ–¯æ¡ä»¶ç‹¬ç«‹å±•å¼€ã€‚è¦æ³¨æ„ä¸€ç‚¹å°±æ˜¯ ï¼Œå› æ­¤ä¸€èˆ¬æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯åœ¨ç±»åˆ«ä¸ºciçš„é‚£äº›æ ·æœ¬é›†ä¸­ï¼Œæ‰¾åˆ°wjå‡ºç°æ¬¡æ•°çš„æ€»å’Œï¼Œç„¶åé™¤ä»¥è¯¥æ ·æœ¬çš„æ€»å’Œï¼›ç¬¬äºŒç§æ–¹æ³•æ˜¯ç±»åˆ«ä¸ºciçš„é‚£äº›æ ·æœ¬é›†ä¸­ï¼Œæ‰¾åˆ°wjå‡ºç°æ¬¡æ•°çš„æ€»å’Œï¼Œç„¶åé™¤ä»¥è¯¥æ ·æœ¬ä¸­æ‰€æœ‰ç‰¹å¾å‡ºç°æ¬¡æ•°çš„æ€»å’Œã€‚ å¦‚æœ ä¸­çš„æŸä¸€é¡¹ä¸º0ï¼Œåˆ™å…¶è”åˆæ¦‚ç‡çš„ä¹˜ç§¯ä¹Ÿå¯èƒ½ä¸º0ï¼Œå³2ä¸­å…¬å¼çš„åˆ†å­ä¸º0ï¼Œä¸ºäº†é¿å…è¿™ç§ç°è±¡å‡ºç°ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¼šå°†è¿™ä¸€é¡¹åˆå§‹åŒ–ä¸º1ï¼Œå½“ç„¶ä¸ºäº†ä¿è¯æ¦‚ç‡ç›¸ç­‰ï¼Œåˆ†æ¯åº”å¯¹åº”åˆå§‹åŒ–ä¸º2ï¼ˆè¿™é‡Œå› ä¸ºæ˜¯2ç±»ï¼Œæ‰€ä»¥åŠ 2ï¼Œå¦‚æœæ˜¯kç±»å°±éœ€è¦åŠ kï¼Œæœ¯è¯­ä¸Šå«åšlaplaceå…‰æ»‘, åˆ†æ¯åŠ kçš„åŸå› æ˜¯ä½¿ä¹‹æ»¡è¶³å…¨æ¦‚ç‡å…¬å¼)ã€‚ ä¼˜ç‚¹ï¼š å¯¹å°è§„æ¨¡çš„æ•°æ®è¡¨ç°å¾ˆå¥½ï¼Œé€‚åˆå¤šåˆ†ç±»ä»»åŠ¡ï¼Œé€‚åˆå¢é‡å¼è®­ç»ƒã€‚ ç¼ºç‚¹ï¼š å¯¹è¾“å…¥æ•°æ®çš„è¡¨è¾¾å½¢å¼å¾ˆæ•æ„Ÿã€‚ å†³ç­–æ ‘ï¼š å†³ç­–æ ‘ä¸­å¾ˆé‡è¦çš„ä¸€ç‚¹å°±æ˜¯é€‰æ‹©ä¸€ä¸ªå±æ€§è¿›è¡Œåˆ†æï¼Œå› æ­¤è¦æ³¨æ„ä¸€ä¸‹ä¿¡æ¯å¢ç›Šçš„è®¡ç®—å…¬å¼ï¼Œå¹¶æ·±å…¥ç†è§£å®ƒã€‚ ä¿¡æ¯ç†µçš„å‡½æ•°è¡¨è¾¾å¼: å…¶ä¸­çš„nä»£è¡¨æœ‰nä¸ªåˆ†ç±»ç±»åˆ«ï¼ˆæ¯”å¦‚å‡è®¾æ˜¯2ç±»é—®é¢˜ï¼Œé‚£ä¹ˆn=2ï¼‰ã€‚åˆ†åˆ«è®¡ç®—è¿™2ç±»æ ·æœ¬åœ¨æ€»æ ·æœ¬ä¸­å‡ºç°çš„æ¦‚ç‡p1å’Œp2ï¼Œè¿™æ ·å°±å¯ä»¥è®¡ç®—å‡ºæœªé€‰ä¸­å±æ€§åˆ†æå‰çš„ä¿¡æ¯ç†µã€‚ ç°åœ¨é€‰ä¸­ä¸€ä¸ªå±æ€§xiç”¨æ¥è¿›è¡Œåˆ†æï¼Œæ­¤æ—¶åˆ†æè§„åˆ™æ˜¯ï¼šå¦‚æœxi=vxçš„è¯ï¼Œå°†æ ·æœ¬åˆ†åˆ°æ ‘çš„ä¸€ä¸ªåˆ†æ”¯ï¼›å¦‚æœä¸ç›¸ç­‰åˆ™è¿›å…¥å¦ä¸€ä¸ªåˆ†æ”¯ã€‚å¾ˆæ˜¾ç„¶ï¼Œåˆ†æ”¯ä¸­çš„æ ·æœ¬å¾ˆæœ‰å¯èƒ½åŒ…æ‹¬2ä¸ªç±»åˆ«ï¼Œåˆ†åˆ«è®¡ç®—è¿™2ä¸ªåˆ†æ”¯çš„ç†µH1å’ŒH2,è®¡ç®—å‡ºåˆ†æåçš„æ€»ä¿¡æ¯ç†µHâ€™=p1H1+p2H2.ï¼Œåˆ™æ­¤æ—¶çš„ä¿¡æ¯å¢ç›ŠÎ”H=H-Hâ€™ã€‚ä»¥ä¿¡æ¯å¢ç›Šä¸ºåŸåˆ™ï¼ŒæŠŠæ‰€æœ‰çš„å±æ€§éƒ½æµ‹è¯•ä¸€è¾¹ï¼Œé€‰æ‹©ä¸€ä¸ªä½¿å¢ç›Šæœ€å¤§çš„å±æ€§ä½œä¸ºæœ¬æ¬¡åˆ†æå±æ€§ã€‚ ä¼˜ç‚¹ï¼š è®¡ç®—é‡ç®€å•ï¼Œå¯è§£é‡Šæ€§å¼ºï¼Œæ¯”è¾ƒé€‚åˆå¤„ç†æœ‰ç¼ºå¤±å±æ€§å€¼çš„æ ·æœ¬ï¼Œèƒ½å¤Ÿå¤„ç†ä¸ç›¸å…³çš„ç‰¹å¾ï¼› ç¼ºç‚¹ï¼š å®¹æ˜“è¿‡æ‹Ÿåˆï¼ˆåç»­å‡ºç°äº†éšæœºæ£®æ—ï¼Œå‡å°äº†è¿‡æ‹Ÿåˆç°è±¡ï¼‰ã€‚ Logisticå›å½’ï¼š Logisticæ˜¯ç”¨æ¥åˆ†ç±»çš„ï¼Œæ˜¯ä¸€ç§çº¿æ€§åˆ†ç±»å™¨ï¼Œéœ€è¦æ³¨æ„çš„åœ°æ–¹æœ‰ï¼š å‡½æ•°è¡¨è¾¾å¼ï¼š å…¶å¯¼æ•°å½¢å¼ä¸ºï¼š logsitcå›å½’æ–¹æ³•ä¸»è¦æ˜¯ç”¨æœ€å¤§ä¼¼ç„¶ä¼°è®¡æ¥å­¦ä¹ çš„ï¼Œæ‰€ä»¥å•ä¸ªæ ·æœ¬çš„åéªŒæ¦‚ç‡ä¸ºï¼š åˆ°æ•´ä¸ªæ ·æœ¬çš„åéªŒæ¦‚ç‡ï¼š å…¶ä¸­ï¼š é€šè¿‡å¯¹æ•°è¿›ä¸€æ­¥åŒ–ç®€ä¸ºï¼š å…¶å®å®ƒçš„loss functionä¸º-l(Î¸)ï¼Œå› æ­¤æˆ‘ä»¬éœ€ä½¿loss functionæœ€å°ï¼Œå¯é‡‡ç”¨æ¢¯åº¦ä¸‹é™æ³•å¾—åˆ°ã€‚æ¢¯åº¦ä¸‹é™æ³•å…¬å¼ä¸º: ä¼˜ç‚¹ï¼š å®ç°ç®€å• åˆ†ç±»æ—¶è®¡ç®—é‡éå¸¸å°ï¼Œé€Ÿåº¦å¾ˆå¿«ï¼Œå­˜å‚¨èµ„æºä½ï¼› ç¼ºç‚¹ï¼š å®¹æ˜“æ¬ æ‹Ÿåˆï¼Œä¸€èˆ¬å‡†ç¡®åº¦ä¸å¤ªé«˜ åªèƒ½å¤„ç†ä¸¤åˆ†ç±»é—®é¢˜ï¼ˆåœ¨æ­¤åŸºç¡€ä¸Šè¡ç”Ÿå‡ºæ¥çš„softmaxå¯ä»¥ç”¨äºå¤šåˆ†ç±»ï¼‰ï¼Œä¸”å¿…é¡»çº¿æ€§å¯åˆ†ï¼› çº¿æ€§å›å½’ï¼š çº¿æ€§å›å½’æ‰æ˜¯çœŸæ­£ç”¨äºå›å½’çš„ï¼Œè€Œä¸åƒlogisticå›å½’æ˜¯ç”¨äºåˆ†ç±»ï¼Œå…¶åŸºæœ¬æ€æƒ³æ˜¯ç”¨æ¢¯åº¦ä¸‹é™æ³•å¯¹æœ€å°äºŒä¹˜æ³•å½¢å¼çš„è¯¯å·®å‡½æ•°è¿›è¡Œä¼˜åŒ–ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç”¨normal equationç›´æ¥æ±‚å¾—å‚æ•°çš„è§£ å‡½æ•°è¡¨è¾¾å¼: è€Œåœ¨LWLRï¼ˆå±€éƒ¨åŠ æƒçº¿æ€§å›å½’ï¼‰ä¸­ï¼Œå‚æ•°çš„è®¡ç®—è¡¨è¾¾å¼ä¸º: å› ä¸ºæ­¤æ—¶ä¼˜åŒ–çš„æ˜¯ï¼š ç”±æ­¤å¯è§LWLRä¸LRä¸åŒï¼ŒLWLRæ˜¯ä¸€ä¸ªéå‚æ•°æ¨¡å‹ï¼Œå› ä¸ºæ¯æ¬¡è¿›è¡Œå›å½’è®¡ç®—éƒ½è¦éå†è®­ç»ƒæ ·æœ¬è‡³å°‘ä¸€æ¬¡ã€‚ ä¼˜ç‚¹ï¼š å®ç°ç®€å•ï¼Œè®¡ç®—ç®€å•ï¼› ç¼ºç‚¹ï¼š ä¸èƒ½æ‹Ÿåˆéçº¿æ€§æ•°æ®ï¼› æœ€è¿‘é‚»ç®—æ³•(KNN)ï¼š KNNç®—æ³•å³æœ€è¿‘é‚»ç®—æ³•ï¼Œå…¶ä¸»è¦è¿‡ç¨‹ä¸ºï¼š è®¡ç®—è®­ç»ƒæ ·æœ¬å’Œæµ‹è¯•æ ·æœ¬ä¸­æ¯ä¸ªæ ·æœ¬ç‚¹çš„è·ç¦»ï¼ˆå¸¸è§çš„è·ç¦»åº¦é‡æœ‰æ¬§å¼è·ç¦»ï¼Œé©¬æ°è·ç¦»ç­‰ï¼‰ï¼› å¯¹ä¸Šé¢æ‰€æœ‰çš„è·ç¦»å€¼è¿›è¡Œæ’åºï¼› é€‰å‰kä¸ªæœ€å°è·ç¦»çš„æ ·æœ¬ï¼› æ ¹æ®è¿™kä¸ªæ ·æœ¬çš„æ ‡ç­¾è¿›è¡ŒæŠ•ç¥¨ï¼Œå¾—åˆ°æœ€åçš„åˆ†ç±»ç±»åˆ«ï¼› å¦‚ä½•é€‰æ‹©ä¸€ä¸ªæœ€ä½³çš„Kå€¼ï¼Œè¿™å–å†³äºæ•°æ®ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåœ¨åˆ†ç±»æ—¶è¾ƒå¤§çš„Kå€¼èƒ½å¤Ÿå‡å°å™ªå£°çš„å½±å“ã€‚ä½†ä¼šä½¿ç±»åˆ«ä¹‹é—´çš„ç•Œé™å˜å¾—æ¨¡ç³Šã€‚ä¸€ä¸ªè¾ƒå¥½çš„Kå€¼å¯é€šè¿‡å„ç§å¯å‘å¼æŠ€æœ¯æ¥è·å–ï¼Œæ¯”å¦‚ï¼Œäº¤å‰éªŒè¯ã€‚å¦å¤–å™ªå£°å’Œéç›¸å…³æ€§ç‰¹å¾å‘é‡çš„å­˜åœ¨ä¼šä½¿Kè¿‘é‚»ç®—æ³•çš„å‡†ç¡®æ€§å‡å°ã€‚ è¿‘é‚»ç®—æ³•å…·æœ‰è¾ƒå¼ºçš„ä¸€è‡´æ€§ç»“æœã€‚éšç€æ•°æ®è¶‹äºæ— é™ï¼Œç®—æ³•ä¿è¯é”™è¯¯ç‡ä¸ä¼šè¶…è¿‡è´å¶æ–¯ç®—æ³•é”™è¯¯ç‡çš„ä¸¤å€ã€‚å¯¹äºä¸€äº›å¥½çš„Kå€¼ï¼ŒKè¿‘é‚»ä¿è¯é”™è¯¯ç‡ä¸ä¼šè¶…è¿‡è´å¶æ–¯ç†è®ºè¯¯å·®ç‡ã€‚ æ³¨ï¼šé©¬æ°è·ç¦»ä¸€å®šè¦å…ˆç»™å‡ºæ ·æœ¬é›†çš„ç»Ÿè®¡æ€§è´¨ï¼Œæ¯”å¦‚å‡å€¼å‘é‡ï¼Œåæ–¹å·®çŸ©é˜µç­‰ã€‚å…³äºé©¬æ°è·ç¦»çš„ä»‹ç»å¦‚ä¸‹ï¼š ä¼˜ç‚¹ï¼š æ€æƒ³ç®€å•ï¼Œç†è®ºæˆç†Ÿï¼Œæ—¢å¯ä»¥ç”¨æ¥åšåˆ†ç±»ä¹Ÿå¯ä»¥ç”¨æ¥åšå›å½’ï¼› å¯ç”¨äºéçº¿æ€§åˆ†ç±»ï¼› è®­ç»ƒæ—¶é—´å¤æ‚åº¦ä¸ºO(n)ï¼› å‡†ç¡®åº¦é«˜ï¼Œå¯¹æ•°æ®æ²¡æœ‰å‡è®¾ï¼Œå¯¹å¼‚å¸¸å€¼ä¸æ•æ„Ÿï¼› ç¼ºç‚¹ï¼š è®¡ç®—é‡å¤§ï¼› æ ·æœ¬ä¸å¹³è¡¡é—®é¢˜ï¼ˆå³æœ‰äº›ç±»åˆ«çš„æ ·æœ¬æ•°é‡å¾ˆå¤šï¼Œè€Œå…¶å®ƒæ ·æœ¬çš„æ•°é‡å¾ˆå°‘ï¼‰ï¼› éœ€è¦å¤§é‡çš„å†…å­˜ï¼› æ”¯æŒå‘é‡æœº(SVM)ï¼š è¦å­¦ä¼šå¦‚ä½•ä½¿ç”¨libsvmä»¥åŠä¸€äº›å‚æ•°çš„è°ƒèŠ‚ç»éªŒï¼Œå¦å¤–éœ€è¦ç†æ¸…æ¥šsvmç®—æ³•çš„ä¸€äº›æ€è·¯ï¼š svmä¸­çš„æœ€ä¼˜åˆ†ç±»é¢æ˜¯å¯¹æ‰€æœ‰æ ·æœ¬çš„å‡ ä½•è£•é‡æœ€å¤§ï¼ˆä¸ºä»€ä¹ˆè¦é€‰æ‹©æœ€å¤§é—´éš”åˆ†ç±»å™¨ï¼Œè¯·ä»æ•°å­¦è§’åº¦ä¸Šè¯´æ˜ï¼Ÿç­”æ¡ˆå°±æ˜¯å‡ ä½•é—´éš”ä¸æ ·æœ¬çš„è¯¯åˆ†æ¬¡æ•°é—´å­˜åœ¨å…³ç³»ï¼š ï¼Œå…¶ä¸­çš„åˆ†æ¯å°±æ˜¯æ ·æœ¬åˆ°åˆ†ç±»é—´éš”è·ç¦»ï¼Œåˆ†å­ä¸­çš„Ræ˜¯æ‰€æœ‰æ ·æœ¬ä¸­çš„æœ€é•¿å‘é‡å€¼) å‡½æ•°è¡¨è¾¾å¼ï¼š ç»è¿‡ä¸€ç³»åˆ—æ¨å¯¼å¯å¾—ä¸ºä¼˜åŒ–ä¸‹é¢åŸå§‹ç›®æ ‡ï¼š ä¸‹é¢æ¥çœ‹çœ‹æ‹‰æ ¼æœ—æ—¥ç†è®ºï¼š å¯ä»¥å°†1ä¸­çš„ä¼˜åŒ–ç›®æ ‡è½¬æ¢ä¸ºæ‹‰æ ¼æœ—æ—¥çš„å½¢å¼ï¼ˆé€šè¿‡å„ç§å¯¹å¶ä¼˜åŒ–ï¼ŒKKDæ¡ä»¶ï¼‰ï¼Œæœ€åç›®æ ‡å‡½æ•°ä¸ºï¼š æˆ‘ä»¬åªéœ€è¦æœ€å°åŒ–ä¸Šè¿°ç›®æ ‡å‡½æ•°ï¼Œå…¶ä¸­çš„Î±ä¸ºåŸå§‹ä¼˜åŒ–é—®é¢˜ä¸­çš„ä¸ç­‰å¼çº¦æŸæ‹‰æ ¼æœ—æ—¥ç³»æ•°ã€‚ å¯¹2ä¸­æœ€åçš„å¼å­åˆ†åˆ«wå’Œbæ±‚å¯¼å¯å¾—ï¼š ç”±ä¸Šé¢ç¬¬1å¼å­å¯ä»¥çŸ¥é“ï¼Œå¦‚æœæˆ‘ä»¬ä¼˜åŒ–å‡ºäº†Î±ï¼Œåˆ™ç›´æ¥å¯ä»¥æ±‚å‡ºwäº†ï¼Œå³æ¨¡å‹çš„å‚æ•°æå®šã€‚è€Œä¸Šé¢ç¬¬2ä¸ªå¼å­å¯ä»¥ä½œä¸ºåç»­ä¼˜åŒ–çš„ä¸€ä¸ªçº¦æŸæ¡ä»¶ã€‚ å¯¹2ä¸­æœ€åä¸€ä¸ªç›®æ ‡å‡½æ•°ç”¨å¯¹å¶ä¼˜åŒ–ç†è®ºå¯ä»¥è½¬æ¢ä¸ºä¼˜åŒ–ä¸‹é¢çš„ç›®æ ‡å‡½æ•°ï¼š è€Œè¿™ä¸ªå‡½æ•°å¯ä»¥ç”¨å¸¸ç”¨çš„ä¼˜åŒ–æ–¹æ³•æ±‚å¾—Î±ï¼Œè¿›è€Œæ±‚å¾—wå’Œbã€‚ æŒ‰ç…§é“ç†ï¼Œsvmç®€å•ç†è®ºåº”è¯¥åˆ°æ­¤ç»“æŸã€‚ä¸è¿‡è¿˜æ˜¯è¦è¡¥å……ä¸€ç‚¹ï¼Œå³åœ¨é¢„æµ‹æ—¶æœ‰ï¼š é‚£ä¸ªå°–æ‹¬å·æˆ‘ä»¬å¯ä»¥ç”¨æ ¸å‡½æ•°ä»£æ›¿ï¼Œè¿™ä¹Ÿæ˜¯svmç»å¸¸å’Œæ ¸å‡½æ•°æ‰¯åœ¨ä¸€èµ·çš„åŸå› ã€‚ æœ€åæ˜¯å…³äºæ¾å¼›å˜é‡çš„å¼•å…¥ï¼Œå› æ­¤åŸå§‹çš„ç›®æ ‡ä¼˜åŒ–å…¬å¼ä¸ºï¼š æ­¤æ—¶å¯¹åº”çš„å¯¹å¶ä¼˜åŒ–å…¬å¼ä¸ºï¼š ä¸å‰é¢çš„ç›¸æ¯”åªæ˜¯Î±å¤šäº†ä¸ªä¸Šç•Œã€‚ ä¼˜ç‚¹ï¼š å¯ç”¨äºçº¿æ€§/éçº¿æ€§åˆ†ç±»ï¼Œä¹Ÿå¯ä»¥ç”¨äºå›å½’ï¼› ä½æ³›åŒ–è¯¯å·®ï¼› å®¹æ˜“è§£é‡Šï¼› è®¡ç®—å¤æ‚åº¦è¾ƒä½ï¼› ç¼ºç‚¹ï¼š å¯¹å‚æ•°å’Œæ ¸å‡½æ•°çš„é€‰æ‹©æ¯”è¾ƒæ•æ„Ÿï¼› åŸå§‹çš„SVMåªæ¯”è¾ƒæ“…é•¿å¤„ç†äºŒåˆ†ç±»é—®é¢˜ï¼› æå‡æ–¹æ³•(Boosting)ï¼š ä¸»è¦ä»¥Adaboostä¸ºä¾‹ï¼Œé¦–å…ˆæ¥çœ‹çœ‹Adaboostçš„æµç¨‹å›¾ï¼Œå¦‚ä¸‹ï¼š ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­æˆ‘ä»¬éœ€è¦è®­ç»ƒå‡ºå¤šä¸ªå¼±åˆ†ç±»å™¨ï¼ˆå›¾ä¸­ä¸º3ä¸ªï¼‰ï¼Œæ¯ä¸ªå¼±åˆ†ç±»å™¨æ˜¯ç”±ä¸åŒæƒé‡çš„æ ·æœ¬ï¼ˆå›¾ä¸­ä¸º5ä¸ªè®­ç»ƒæ ·æœ¬ï¼‰è®­ç»ƒå¾—åˆ°ï¼ˆå…¶ä¸­ç¬¬ä¸€ä¸ªå¼±åˆ†ç±»å™¨å¯¹åº”è¾“å…¥æ ·æœ¬çš„æƒå€¼æ˜¯ä¸€æ ·çš„ï¼‰ï¼Œè€Œæ¯ä¸ªå¼±åˆ†ç±»å™¨å¯¹æœ€ç»ˆåˆ†ç±»ç»“æœçš„ä½œç”¨ä¹Ÿä¸åŒï¼Œæ˜¯é€šè¿‡åŠ æƒå¹³å‡è¾“å‡ºçš„ï¼Œæƒå€¼è§ä¸Šå›¾ä¸­ä¸‰è§’å½¢é‡Œé¢çš„æ•°å€¼ã€‚é‚£ä¹ˆè¿™äº›å¼±åˆ†ç±»å™¨å’Œå…¶å¯¹åº”çš„æƒå€¼æ˜¯æ€æ ·è®­ç»ƒå‡ºæ¥çš„å‘¢ï¼Ÿ ä¸‹é¢é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥ç®€å•è¯´æ˜ï¼Œå‡è®¾çš„æ˜¯5ä¸ªè®­ç»ƒæ ·æœ¬ï¼Œæ¯ä¸ªè®­ç»ƒæ ·æœ¬çš„ç»´åº¦ä¸º2ï¼Œåœ¨è®­ç»ƒç¬¬ä¸€ä¸ªåˆ†ç±»å™¨æ—¶5ä¸ªæ ·æœ¬çš„æƒé‡å„ä¸º0.2. æ³¨æ„è¿™é‡Œæ ·æœ¬çš„æƒå€¼å’Œæœ€ç»ˆè®­ç»ƒçš„å¼±åˆ†ç±»å™¨ç»„å¯¹åº”çš„æƒå€¼Î±æ˜¯ä¸åŒçš„ï¼Œæ ·æœ¬çš„æƒé‡åªåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ç”¨åˆ°ï¼Œè€ŒÎ±åœ¨è®­ç»ƒè¿‡ç¨‹å’Œæµ‹è¯•è¿‡ç¨‹éƒ½æœ‰ç”¨åˆ°ã€‚ ç°åœ¨å‡è®¾å¼±åˆ†ç±»å™¨æ˜¯å¸¦ä¸€ä¸ªèŠ‚ç‚¹çš„ç®€å•å†³ç­–æ ‘ï¼Œè¯¥å†³ç­–æ ‘ä¼šé€‰æ‹©2ä¸ªå±æ€§ï¼ˆå‡è®¾åªæœ‰2ä¸ªå±æ€§ï¼‰çš„ä¸€ä¸ªï¼Œç„¶åè®¡ç®—å‡ºè¿™ä¸ªå±æ€§ä¸­çš„æœ€ä½³å€¼ç”¨æ¥åˆ†ç±»ã€‚ Adaboostçš„ç®€å•ç‰ˆæœ¬è®­ç»ƒè¿‡ç¨‹ï¼š è®­ç»ƒç¬¬ä¸€ä¸ªåˆ†ç±»å™¨ï¼Œæ ·æœ¬çš„æƒå€¼Dä¸ºç›¸åŒçš„å‡å€¼ã€‚é€šè¿‡ä¸€ä¸ªå¼±åˆ†ç±»å™¨ï¼Œå¾—åˆ°è¿™5ä¸ªæ ·æœ¬ï¼ˆè¯·å¯¹åº”ä¹¦ä¸­çš„ä¾‹å­æ¥çœ‹ï¼Œä¾æ—§æ˜¯machine learning in actionï¼‰çš„åˆ†ç±»é¢„æµ‹æ ‡ç­¾ã€‚ä¸ç»™å‡ºçš„æ ·æœ¬çœŸå®æ ‡ç­¾å¯¹æ¯”ï¼Œå°±å¯èƒ½å‡ºç°è¯¯å·®(å³é”™è¯¯)ã€‚å¦‚æœæŸä¸ªæ ·æœ¬é¢„æµ‹é”™è¯¯ï¼Œåˆ™å®ƒå¯¹åº”çš„é”™è¯¯å€¼ä¸ºè¯¥æ ·æœ¬çš„æƒé‡ï¼Œå¦‚æœåˆ†ç±»æ­£ç¡®ï¼Œåˆ™é”™è¯¯å€¼ä¸º0. æœ€åç´¯åŠ 5ä¸ªæ ·æœ¬çš„é”™è¯¯ç‡ä¹‹å’Œï¼Œè®°ä¸ºÎµã€‚ é€šè¿‡Îµæ¥è®¡ç®—è¯¥å¼±åˆ†ç±»å™¨çš„æƒé‡Î±ï¼Œå…¬å¼å¦‚ä¸‹ï¼š é€šè¿‡Î±æ¥è®¡ç®—è®­ç»ƒä¸‹ä¸€ä¸ªå¼±åˆ†ç±»å™¨æ ·æœ¬çš„æƒé‡Dï¼Œå¦‚æœå¯¹åº”æ ·æœ¬åˆ†ç±»æ­£ç¡®ï¼Œåˆ™å‡å°è¯¥æ ·æœ¬çš„æƒé‡ï¼Œå…¬å¼ä¸ºï¼š å¦‚æœæ ·æœ¬åˆ†ç±»é”™è¯¯ï¼Œåˆ™å¢åŠ è¯¥æ ·æœ¬çš„æƒé‡ï¼Œå…¬å¼ä¸ºï¼š å¾ªç¯æ­¥éª¤1,2,3æ¥ç»§ç»­è®­ç»ƒå¤šä¸ªåˆ†ç±»å™¨ï¼Œåªæ˜¯å…¶Då€¼ä¸åŒè€Œå·²ã€‚ ä¼˜ç‚¹ï¼š ä½æ³›åŒ–è¯¯å·®ï¼› å®¹æ˜“å®ç°ï¼Œåˆ†ç±»å‡†ç¡®ç‡è¾ƒé«˜ï¼Œæ²¡æœ‰å¤ªå¤šå‚æ•°å¯ä»¥è°ƒï¼› ç¼ºç‚¹ï¼š å¯¹å¼‚å¸¸å€¼æ¯”è¾ƒæ•æ„Ÿï¼› èšç±»ï¼š åŸºäºåˆ’åˆ†çš„èšç±»: k-meansæ˜¯ä½¿ä¸‹é¢çš„è¡¨è¾¾å¼å€¼æœ€å° å‡½æ•°è¡¨è¾¾å¼: ä¼˜ç‚¹ï¼š k-meansç®—æ³•æ˜¯è§£å†³èšç±»é—®é¢˜çš„ä¸€ç§ç»å…¸ç®—æ³•ï¼Œç®—æ³•ç®€å•ã€å¿«é€Ÿã€‚ å¯¹å¤„ç†å¤§æ•°æ®é›†ï¼Œè¯¥ç®—æ³•æ˜¯ç›¸å¯¹å¯ä¼¸ç¼©çš„å’Œé«˜æ•ˆç‡çš„ï¼Œå› ä¸ºå®ƒçš„å¤æ‚åº¦å¤§çº¦æ˜¯O(nkt)ï¼Œå…¶ä¸­næ˜¯æ‰€æœ‰å¯¹è±¡çš„æ•°ç›®ï¼Œkæ˜¯ç°‡çš„æ•°ç›®,tæ˜¯è¿­ä»£çš„æ¬¡æ•°ã€‚é€šå¸¸k&lt; ç®—æ³•å°è¯•æ‰¾å‡ºä½¿å¹³æ–¹è¯¯å·®å‡½æ•°å€¼æœ€å°çš„kä¸ªåˆ’åˆ†ã€‚å½“ç°‡æ˜¯å¯†é›†çš„ã€çƒçŠ¶æˆ–å›¢çŠ¶çš„ï¼Œä¸”ç°‡ä¸ç°‡ä¹‹é—´åŒºåˆ«æ˜æ˜¾æ—¶ï¼Œèšç±»æ•ˆæœè¾ƒå¥½ã€‚ ç¼ºç‚¹ï¼š k-å¹³å‡æ–¹æ³•åªæœ‰åœ¨ç°‡çš„å¹³å‡å€¼è¢«å®šä¹‰çš„æƒ…å†µä¸‹æ‰èƒ½ä½¿ç”¨ï¼Œä¸”å¯¹æœ‰äº›åˆ†ç±»å±æ€§çš„æ•°æ®ä¸é€‚åˆã€‚ è¦æ±‚ç”¨æˆ·å¿…é¡»äº‹å…ˆç»™å‡ºè¦ç”Ÿæˆçš„ç°‡çš„æ•°ç›®kã€‚ å¯¹åˆå€¼æ•æ„Ÿï¼Œå¯¹äºä¸åŒçš„åˆå§‹å€¼ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¸åŒçš„èšç±»ç»“æœã€‚ ä¸é€‚åˆäºå‘ç°éå‡¸é¢å½¢çŠ¶çš„ç°‡ï¼Œæˆ–è€…å¤§å°å·®åˆ«å¾ˆå¤§çš„ç°‡ã€‚ å¯¹äº&quot;å™ªå£°&quot;å’Œå­¤ç«‹ç‚¹æ•°æ®æ•æ„Ÿï¼Œå°‘é‡çš„è¯¥ç±»æ•°æ®èƒ½å¤Ÿå¯¹å¹³å‡å€¼äº§ç”Ÿæå¤§å½±å“ã€‚ åŸºäºå±‚æ¬¡çš„èšç±»ï¼š è‡ªåº•å‘ä¸Šçš„å‡èšæ–¹æ³•ï¼Œæ¯”å¦‚AGNESã€‚ è‡ªä¸Šå‘ä¸‹çš„åˆ†è£‚æ–¹æ³•ï¼Œæ¯”å¦‚DIANAã€‚ åŸºäºå¯†åº¦çš„èšç±»ï¼š DBSACN,OPTICS,BIRCH(CF-Tree),CURE. åŸºäºç½‘æ ¼çš„æ–¹æ³•ï¼š STING, WaveCluster. åŸºäºæ¨¡å‹çš„èšç±»ï¼š EM,SOM,COBWEB. ","link":"https://tianxiawuhao.github.io/J6vCn9W4Z/"},{"title":"å¯å‘å¼ç®—æ³•","content":"åå¤§ç®—æ³• 1ã€è’™ç‰¹å¡ç½—ç®—æ³• 2ã€æ•°æ®æ‹Ÿåˆã€å‚æ•°ä¼°è®¡ã€æ’å€¼ç­‰æ•°æ®å¤„ç†ç®—æ³• 3ã€çº¿æ€§è§„åˆ’ã€æ•´æ•°è§„åˆ’ã€å¤šå…ƒè§„åˆ’ã€äºŒæ¬¡è§„åˆ’ç­‰è§„åˆ’ç±»é—®é¢˜ 4ã€å›¾è®ºç®—æ³• 5ã€åŠ¨æ€è§„åˆ’ã€å›æº¯æœç´¢ã€åˆ†æ²»ç®—æ³•ã€åˆ†æ”¯å®šç•Œç­‰è®¡ç®—æœºç®—æ³• 6ã€æœ€ä¼˜åŒ–ç†è®ºçš„ä¸‰å¤§éç»å…¸ç®—æ³•ï¼šæ¨¡æ‹Ÿé€€ç«æ³•ã€ç¥ç»ç½‘ç»œã€é—ä¼ ç®—æ³• 7ã€ç½‘æ ¼ç®—æ³•å’Œç©·ä¸¾æ³• 8ã€ä¸€äº›è¿ç»­ç¦»æ•£åŒ–æ–¹æ³• 9ã€æ•°å€¼åˆ†æç®—æ³• 10ã€å›¾è±¡å¤„ç†ç®—æ³• å¸¸ç”¨äº”å¤§æ¨¡å‹ 1ã€é¢„æµ‹æ¨¡å‹ ï¼ˆ1ï¼‰ç¥ç»ç½‘ç»œé¢„æµ‹æ¨¡å‹ ï¼ˆ2ï¼‰ç°è‰²é¢„æµ‹æ¨¡å‹ ï¼ˆ3ï¼‰æ‹Ÿåˆæ’å€¼é¢„æµ‹ï¼ˆçº¿æ€§å›å½’ï¼‰ ï¼ˆ4ï¼‰æ—¶é—´åºåˆ—æ¨¡å‹ ï¼ˆ5ï¼‰ é©¬å°”ç§‘å¤«æ¨¡å‹ ï¼ˆ6ï¼‰æ”¯æŒå‘é‡æœºæ¨¡å‹ ï¼ˆ7ï¼‰Logisticæ¨¡å‹ ï¼ˆ8ï¼‰ç»„åˆé¢„æµ‹æ¨¡å‹ ï¼ˆ9ï¼‰å¾®åˆ†æ–¹ç¨‹é¢„æµ‹ ï¼ˆ10ï¼‰ç»„åˆé¢„æµ‹æ¨¡å‹ 2ã€è¯„ä»·æ¨¡å‹ ï¼ˆ1ï¼‰æ¨¡ç³Šç»¼åˆè¯„ä»·æ³• ï¼ˆ2ï¼‰å±‚æ¬¡åˆ†ææ³• ï¼ˆ3ï¼‰èšç±»åˆ†ææ³• ï¼ˆ4ï¼‰ä¸»æˆåˆ†åˆ†æè¯„ä»·æ³• ï¼ˆ5ï¼‰ç°è‰²ç»¼åˆè¯„ä»·æ³• ï¼ˆ6ï¼‰äººå·¥ç¥ç»ç½‘ç»œè¯„ä»·æ³• ï¼ˆ7ï¼‰BPç¥ç»ç½‘ç»œç»¼åˆè¯„ä»·æ³• ï¼ˆ8ï¼‰ç»„åˆè¯„ä»·æ³• 3ã€ä¼˜åŒ–æ¨¡å‹ ï¼ˆ1ï¼‰è§„åˆ’æ¨¡å‹ï¼ˆç›®æ ‡è§„åˆ’ã€çº¿æ€§è§„åˆ’ã€éçº¿æ€§è§„åˆ’ã€æ•´æ•°è§„åˆ’ã€åŠ¨æ€è§„åˆ’ï¼‰ ï¼ˆ2ï¼‰æ’é˜Ÿè®ºæ¨¡å‹ ï¼ˆ3ï¼‰ç¥ç»ç½‘ç»œæ¨¡å‹ ï¼ˆ4ï¼‰ç°ä»£ä¼˜åŒ–ç®—æ³•ï¼ˆé—ä¼ ç®—æ³•ã€æ¨¡æ‹Ÿé€€ç«ç®—æ³•ã€èšç¾¤ç®—æ³•ã€ç¦å¿Œæœç´¢ã€ç²’å­ç¾¤ç®—æ³•ï¼‰ ï¼ˆ5ï¼‰å›¾è®ºæ¨¡å‹ ï¼ˆ6ï¼‰ ç»„åˆä¼˜åŒ–æ¨¡å‹ 4ã€åˆ†ç±»æ¨¡å‹ ï¼ˆ1ï¼‰å†³ç­–æ ‘ ï¼ˆ2ï¼‰é€»è¾‘å›å½’ ï¼ˆ3ï¼‰éšæœºæ£®æ— ï¼ˆ4ï¼‰æœ´ç´ è´å¶æ–¯ã€‚ 5ã€ç»Ÿè®¡åˆ†ææ¨¡å‹ ï¼ˆ1ï¼‰å‡å€¼Tæ£€éªŒ ï¼ˆ2ï¼‰æ–¹å·®åˆ†æ ï¼ˆ3ï¼‰åæ–¹å·®åˆ†æ ï¼ˆ4ï¼‰åˆ†å¸ƒæ£€éªŒ ï¼ˆ5ï¼‰ç›¸å…³åˆ†æ ï¼ˆ6ï¼‰å¡æ–¹æ£€éªŒ ï¼ˆ7ï¼‰ç§©å’Œæ£€éªŒ ï¼ˆ8ï¼‰å›å½’åˆ†æ ï¼ˆ9ï¼‰Logisticå›å½’ ï¼ˆ10ï¼‰èšç±»åˆ†æ ï¼ˆ11ï¼‰åˆ¤åˆ«åˆ†æ ï¼ˆ12ï¼‰å…³è”åˆ†æ å¯å‘å¼ç®—æ³• å¯å‘å¼ç®—æ³•ä¸€èˆ¬ç”¨äºè§£å†³NP-hardé—®é¢˜ï¼Œå…¶ä¸­NPæ˜¯æŒ‡éç¡®å®šæ€§å¤šé¡¹å¼ã€‚ ä¾‹å¦‚ï¼Œè‘—åçš„æ¨é”€å‘˜æ—…è¡Œé—®é¢˜ï¼ˆTravel Saleman Problem or TSPï¼‰ï¼šå‡è®¾ä¸€ä¸ªæ¨é”€å‘˜éœ€è¦ä»å—äº¬å‡ºå‘ï¼Œç»è¿‡å¹¿å·ï¼ŒåŒ—äº¬ï¼Œä¸Šæµ·ï¼Œâ€¦ï¼Œç­‰ n ä¸ªåŸå¸‚ï¼Œ æœ€åè¿”å›é¦™æ¸¯ã€‚ ä»»æ„ä¸¤ä¸ªåŸå¸‚ä¹‹é—´éƒ½æœ‰é£æœºç›´è¾¾ï¼Œä½†ç¥¨ä»·ä¸ç­‰ã€‚å‡è®¾å…¬å¸åªç»™æŠ¥é”€ C å…ƒé’±ï¼Œé—®æ˜¯å¦å­˜åœ¨ä¸€ä¸ªè¡Œç¨‹å®‰æ’ï¼Œä½¿å¾—ä»–èƒ½éå†æ‰€æœ‰åŸå¸‚ï¼Œè€Œä¸”æ€»çš„è·¯è´¹å°äº Cï¼Ÿ æ¨é”€å‘˜æ—…è¡Œé—®é¢˜æ˜¾ç„¶æ˜¯ NP çš„ã€‚å› ä¸ºå¦‚æœä½ ä»»æ„ç»™å‡ºä¸€ä¸ªè¡Œç¨‹å®‰æ’ï¼Œå¯ä»¥å¾ˆå®¹æ˜“ç®—å‡ºæ—…è¡Œæ€»å¼€é”€ã€‚ä½†æ˜¯ï¼Œè¦æƒ³çŸ¥é“ä¸€æ¡æ€»è·¯è´¹å°äº C çš„è¡Œç¨‹æ˜¯å¦å­˜åœ¨ï¼Œåœ¨æœ€åæƒ…å†µä¸‹ï¼Œå¿…é¡»æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„æ—…è¡Œå®‰æ’ã€‚ å¯å‘å¼ç®—æ³•æ˜¯ç›¸å¯¹äºæœ€ä¼˜åŒ–ç®—æ³•æå‡ºçš„ï¼Œæ˜¯åŸºäºç›´è§‚æˆ–è€…ç»éªŒæ„é€ çš„ç®—æ³•ï¼Œåœ¨å¯æ¥å—çš„å¼€é”€ï¼ˆæ—¶é—´å’Œç©ºé—´ï¼‰å†…ç»™å‡ºå¾…è§£å†³ç»„åˆä¼˜åŒ–é—®é¢˜çš„ä¸€ä¸ªå¯è¡Œè§£ã€‚ ç›®å‰é€šç”¨çš„å¯å‘å¼ç®—æ³• ç›®å‰æ¯”è¾ƒé€šç”¨çš„å¯å‘å¼ç®—æ³•ä¸€èˆ¬æœ‰æ¨¡æ‹Ÿé€€ç«ç®—æ³•ï¼ˆSimulate Anneal Arithmetic, SAAï¼‰ã€é—ä¼ ç®—æ³•ï¼ˆGenetic Algorithm, GAï¼‰ã€èšç¾¤ç®—æ³•ï¼ˆAnt Colony Optimization, ACOï¼‰ã€äººå·¥ç¥ç»ç½‘ç»œ(Artificial Neural Networks, ANNs)ã€ç²’å­ç¾¤ç®—æ³•ï¼ˆParticle Swarm Optimization, PSOï¼‰ç­‰ã€‚ æ¨¡æ‹Ÿé€€ç«ç®—æ³•(SAA) æ¨¡æ‹Ÿé€€ç«ç®—æ³•(Simulate Anneal Arithmetic, SAA)çš„æ€æƒ³å€Ÿé‰´äºå›ºä½“çš„é€€ç«åŸç†ï¼Œå½“å›ºä½“çš„æ¸©åº¦å¾ˆé«˜çš„æ—¶å€™ï¼Œå†…èƒ½æ¯”è¾ƒå¤§ï¼Œå›ºä½“çš„å†…éƒ¨ç²’å­å¤„äºå¿«é€Ÿæ— åºè¿åŠ¨ï¼Œå½“æ¸©åº¦æ…¢æ…¢é™ä½çš„è¿‡ç¨‹ä¸­ï¼Œå›ºä½“çš„å†…èƒ½å‡å°ï¼Œç²’å­çš„æ…¢æ…¢è¶‹äºæœ‰åºï¼Œæœ€ç»ˆï¼Œå½“å›ºä½“å¤„äºå¸¸æ¸©æ—¶ï¼Œå†…èƒ½è¾¾åˆ°æœ€å°ï¼Œæ­¤æ—¶ï¼Œç²’å­æœ€ä¸ºç¨³å®šã€‚æ¨¡æ‹Ÿé€€ç«ç®—æ³•ä¾¿æ˜¯åŸºäºè¿™æ ·çš„åŸç†è®¾è®¡è€Œæˆã€‚ æ¨¡æ‹Ÿé€€ç«ç®—æ³•æ­¥éª¤ åˆå§‹åŒ–æ¸©åº¦T(å……åˆ†å¤§)ï¼Œæ¸©åº¦ä¸‹é™Tmin(å……åˆ†å°)ï¼Œåˆå§‹è§£Xï¼Œæ¯ä¸ªTå€¼è¿­ä»£æ¬¡æ•°L éšæœºç”Ÿæˆä¸´åŸŸè§£x_new; è®¾f(x)å‡½æ•°æ¥è®¡ç®—ç”¨æ¥è®¡ç®—è§£å¾—å¥½åï¼Œè®¡ç®—å‡ºf(x_new)-f(x); å¦‚æœf(x_new)-f(x)&gt;0ï¼Œè¯´æ˜æ–°è§£æ¯”åŸæ¥çš„è§£å¥½ï¼Œåˆ™æ— æ¡ä»¶æ¥å—ï¼Œå¦‚æœf(x_new)-f(x)&lt;0ï¼Œåˆ™è¯´æ˜æ—§è§£æ¯”æ–°è§£å¥½ï¼Œåˆ™ä»¥æ¦‚ç‡exp((f(xnew)-f(x))/k*T)æ¥å—x_newä½œä¸ºè§£ã€‚ å¦‚æœå½“å‰æ¸©åº¦&lt;Tminæ—¶ï¼Œåˆ™é€€å‡ºå¾ªç¯ï¼Œè¾“å‡ºå½“å‰ç»“æœï¼Œå¦åˆ™å‡å°‘å½“å‰æ¸©åº¦ï¼Œå›åˆ°ç¬¬2æ­¥ç»§ç»­å¾ªç¯ï¼Œå¸¸ç”¨çš„é™æ¸©æ–¹æ³•ä¸ºT= a*T (0&lt;a&lt;1)ï¼Œä¸€èˆ¬aå–æ¥è¿‘1çš„å€¼ æ¨¡æ‹Ÿé€€ç«ç®—æ³•å®ä¾‹ æ±‚è§£å‡½æ•°æœ€å°å€¼é—®é¢˜ï¼šâ€‹ å…¶ä¸­ï¼Œ0&lt;=x&lt;=100,ç»™å®šä»»æ„yå€¼ï¼Œæ±‚xä¸ºå¤šå°‘æ—¶ï¼ŒF(x)æœ€å°ã€‚ public class SATest { public static double T = 1000;// åˆå§‹åŒ–æ¸©åº¦ public static final double Tmin = 1;// æ¸©åº¦çš„ä¸‹ç•Œ public static final int k = 100;// è¿­ä»£çš„æ¬¡æ•° public static final double delta = 0.98;// æ¸©åº¦çš„ä¸‹é™ç‡ public static double getX() { return Math.random() * 100; } /** * è¯„ä»·å‡½æ•°çš„å€¼,å³å¯¹åº”ä¸Šæ–‡ä¸­çš„f(x) * * @param xç›®æ ‡å‡½æ•°ä¸­çš„ä¸€ä¸ªå‚æ•° * @param yç›®æ ‡å‡½æ•°ä¸­çš„å¦ä¸€ä¸ªå‚æ•° * @returnå‡½æ•°å€¼ */ public static double getFuncResult(double x, double y) { double result = 6 * Math.pow(x, 7) + 8 * Math.pow(x, 6) + 7 * Math.pow(x, 3) + 5 * Math.pow(x, 2) - x * y; return result; } /** * æ¨¡æ‹Ÿé€€ç«ç®—æ³•çš„è¿‡ç¨‹ * @param yç›®æ ‡å‡½æ•°ä¸­çš„æŒ‡å®šçš„å‚æ•° * @returnæœ€ä¼˜è§£ */ public static double getSA(double y) { double result = Double.MAX_VALUE;// åˆå§‹åŒ–æœ€ç»ˆçš„ç»“æœ double x[] = new double[k]; // åˆå§‹åŒ–åˆå§‹è§£ for (int i = 0; i &lt; k; i++) { x[i] = getX(); } // è¿­ä»£çš„è¿‡ç¨‹ while (T &gt; Tmin) { for (int i = 0; i &lt; k; i++) { // è®¡ç®—æ­¤æ—¶çš„å‡½æ•°ç»“æœ double funTmp = getFuncResult(x[i], y); // åœ¨é‚»åŸŸå†…äº§ç”Ÿæ–°çš„è§£ double x_new = x[i] + (Math.random() * 2 - 1); // åˆ¤æ–­æ–°çš„xä¸èƒ½è¶…å‡ºç•Œ if (x_new &gt;= 0 &amp;&amp; x_new &lt;= 100) { double funTmp_new = getFuncResult(x_new, y); if (funTmp_new - funTmp &lt; 0) { // æ›¿æ¢ x[i] = x_new; } else { // ä»¥æ¦‚ç‡æ›¿æ¢ double p = 1 / (1 + Math .exp(-(funTmp_new - funTmp) / T)); if (Math.random() &lt; p) { x[i] = x_new; } } } } T = T * delta; } for (int i = 0; i &lt; k; i++) { result = Math.min(result, getFuncResult(x[i], y)); } return result; } public static void main(String args[]) { // è®¾ç½®yçš„å€¼ int y = 0; System.out.println(&quot;æœ€ä¼˜è§£ä¸ºï¼š&quot; + getSA(y)); } } é—ä¼ ç®—æ³•(GA) é—ä¼ ç®—æ³•ï¼ˆGenetic Algorithm, GAï¼‰èµ·æºäºå¯¹ç”Ÿç‰©ç³»ç»Ÿæ‰€è¿›è¡Œçš„è®¡ç®—æœºæ¨¡æ‹Ÿç ”ç©¶ã€‚å®ƒæ˜¯æ¨¡ä»¿è‡ªç„¶ç•Œç”Ÿç‰©è¿›åŒ–æœºåˆ¶å‘å±•èµ·æ¥çš„éšæœºå…¨å±€æœç´¢å’Œä¼˜åŒ–æ–¹æ³•ï¼Œå€Ÿé‰´äº†è¾¾å°”æ–‡çš„è¿›åŒ–è®ºå’Œå­Ÿå¾·å°”çš„é—ä¼ å­¦è¯´ã€‚å…¶æœ¬è´¨æ˜¯ä¸€ç§é«˜æ•ˆã€å¹¶è¡Œã€å…¨å±€æœç´¢çš„æ–¹æ³•ï¼Œèƒ½åœ¨æœç´¢è¿‡ç¨‹ä¸­è‡ªåŠ¨è·å–å’Œç§¯ç´¯æœ‰å…³æœç´¢ç©ºé—´çš„çŸ¥è¯†ï¼Œå¹¶è‡ªé€‚åº”åœ°æ§åˆ¶æœç´¢è¿‡ç¨‹ä»¥æ±‚å¾—æœ€ä½³è§£ã€‚ ç›¸å…³æœ¯è¯­ ç¼–ç (coding)ï¼šå°†ç‰©ä½“çš„è¡¨ç°å‹ç”¨ç¼–ç çš„æ–¹å¼è½¬ä¸ºç¨‹åºå¯æ§çš„åŸºå› å‹ã€‚ æ¯”å¦‚ç°åœ¨è¦è®¡ç®—åŒ—äº¬ã€å¤©æ´¥ã€å¹¿ä¸œã€æ–°ç–†è¿™å››ä¸ªåŸå¸‚çš„ä¸€æ¡æœ€ä¼˜è·¯å¾„ï¼Œä½†ç®—æ³•ç¨‹åºä¸èƒ½å¤Ÿç›´æ¥å¤„ç†åŒ—äº¬ã€å¤©æ´¥ã€å¹¿ä¸œã€æ–°ç–†è¿™äº›æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—ç»™ å®ƒä»¬ç¼–ä¸Šå·ï¼ŒåŒ—äº¬ï¼ˆ0ï¼‰ã€å¤©æ´¥ï¼ˆ1ï¼‰ã€å¹¿ä¸œï¼ˆ2ï¼‰ã€æ–°ç–†ï¼ˆ3ï¼‰ï¼Œè·¯å¾„ï¼ˆå¤©æ´¥-&gt;æ–°ç–†-&gt;åŒ—äº¬-&gt;å¹¿ä¸œï¼‰å¯ä»¥è¡¨ç¤ºæˆåŸºå› å‹ä¸²ç»“æ„æ•°æ® ï¼ˆ1302ï¼‰ï¼Œè¿™æ ·ç®—æ³•ç¨‹åºåªè¦ç›´æ¥å¤„ç†å®ƒä»¬çš„ç¼–å·å°±è¡Œäº†ã€‚ ï¼ˆ1ï¼‰äºŒè¿›åˆ¶ç¼–ç ï¼ŒåŸºå› ç”¨0æˆ–1è¡¨ç¤ºï¼ˆå¸¸ç”¨äºè§£å†³01èƒŒåŒ…é—®é¢˜ï¼‰ å¦‚ï¼šåŸºå› Aï¼š00100011010 (ä»£è¡¨ä¸€ä¸ªä¸ªä½“çš„æŸ“è‰²ä½“) ï¼ˆ2ï¼‰äº’æ¢ç¼–ç ï¼ˆç”¨äºè§£å†³æ’åºé—®é¢˜ï¼Œå¦‚æ—…è¡Œå•†é—®é¢˜å’Œè°ƒåº¦é—®é¢˜ï¼‰ å¦‚ï¼šæ—…è¡Œå•†é—®é¢˜ä¸­ï¼Œä¸€ä¸²åŸºå› ç¼–ç ç”¨æ¥è¡¨ç¤ºéå†çš„åŸå¸‚é¡ºåºï¼Œ â€‹ å¦‚ï¼š234517986ï¼Œè¡¨ç¤ºä¹ä¸ªåŸå¸‚ä¸­ï¼Œå…ˆç»è¿‡åŸå¸‚2ï¼Œå†ç»è¿‡åŸå¸‚3ï¼Œä¾æ­¤ç±»æ¨ã€‚ è§£ç (decoding)ï¼šåŸºå› å‹åˆ°è¡¨ç°å‹çš„æ˜ å°„ã€‚ åŸºå› å‹(genotype)ï¼šå‚æ•°çš„å› å­ï¼› è¡¨ç°å‹(phenotype)ï¼šæ ¹æ®ä¸åŒå› å­æœ€ç»ˆå±•ç°çš„å½¢æ€ï¼› é€‚åº”åº¦(fitness)ï¼šåº¦é‡æŸä¸ªç»“æœçš„å¥½åã€‚ è¿›åŒ–(evolution)ï¼šä¸æ–­å‰”é™¤å·®çš„ç»“æœï¼Œæœ€ç»ˆé€æ­¥ç•™ä¸‹å¥½çš„ç»“æœã€‚ é€‰æ‹©(selection)ï¼šä»¥ä¸€å®šçš„æ¦‚ç‡ä»ç§ç¾¤ä¸­é€‰æ‹©è‹¥å¹²ä¸ªä¸ªä½“ç•™ä¸‹ï¼Œå¹¶ç¹æ®–ã€‚é€‰æ‹©è¿‡ç¨‹æ˜¯ä¸€ç§åŸºäºé€‚åº”åº¦çš„ä¼˜èƒœåŠ£æ±°çš„è¿‡ç¨‹ã€‚ å¤åˆ¶(reproduction)ï¼šå°†çˆ¶æœ¬ã€æ¯æœ¬çš„åŸºå› å¤åˆ¶ï¼Œä»¥ä¾¿äº§ç”Ÿä¸‹ä¸€ä»£ã€‚ äº¤å‰(crossover)ï¼šä¸¤ä¸ªæŸ“è‰²ä½“çš„æŸä¸€ç›¸åŒä½ç½®å¤„DNAè¢«åˆ‡æ–­ï¼Œå‰åä¸¤ä¸²åˆ†åˆ«äº¤å‰ç»„åˆå½¢æˆä¸¤ä¸ªæ–°çš„æŸ“è‰²ä½“ã€‚ä¹Ÿç§°åŸºå› é‡ç»„æˆ–æ‚äº¤ï¼› ï¼ˆ1ï¼‰å•äº¤å‰ç‚¹æ³• ï¼ˆç”¨äºäºŒè¿›åˆ¶ç¼–ç ï¼‰ é€‰æ‹©ä¸€ä¸ªäº¤å‰ç‚¹,å­ä»£åœ¨äº¤å‰ç‚¹å‰é¢çš„åŸºå› ä»ä¸€ä¸ªçˆ¶ä»£åŸºå› é‚£é‡Œå¾—åˆ°,åé¢çš„éƒ¨åˆ†ä»å¦å¤–ä¸€ä¸ªçˆ¶ä»£åŸºå› é‚£é‡Œå¾—åˆ°ã€‚ å¦‚ï¼šäº¤å‰å‰ï¼š 00000|01110000000010000 11100|00000111111000101 äº¤å‰åï¼š 00000|00000111111000101 11100|01110000000010000 ï¼ˆ2ï¼‰åŒäº¤å‰ç‚¹æ³• ï¼ˆç”¨äºäºŒè¿›åˆ¶ç¼–ç ï¼‰ é€‰æ‹©ä¸¤ä¸ªäº¤å‰ç‚¹,å­ä»£åŸºå› åœ¨ä¸¤ä¸ªäº¤å‰ç‚¹é—´éƒ¨åˆ†æ¥è‡ªä¸€ä¸ªçˆ¶ä»£åŸºå› ,å…¶ä½™éƒ¨åˆ†æ¥è‡ªäºå¦å¤–ä¸€ä¸ªçˆ¶ä»£åŸºå› . å¦‚ï¼šäº¤å‰å‰ï¼š 01 |0010| 11 11 |0111| 01 äº¤å‰åï¼š 11 |0010| 01 01 |0111| 11 ï¼ˆ3ï¼‰åŸºäºâ€œ ä¸/æˆ– â€äº¤å‰æ³• ï¼ˆç”¨äºäºŒè¿›åˆ¶ç¼–ç ï¼‰ å¯¹çˆ¶ä»£æŒ‰ä½&quot;ä¸â€é€»è¾‘è¿ç®—äº§ç”Ÿä¸€å­ä»£A;æŒ‰ä½â€æˆ–â€é€»è¾‘è¿ç®—äº§ç”Ÿå¦ä¸€å­ä»£Bã€‚è¯¥äº¤å‰ç­–ç•¥åœ¨è§£èƒŒåŒ…é—®é¢˜ä¸­æ•ˆæœè¾ƒå¥½ . å¦‚ï¼šäº¤å‰å‰ï¼š 01001011 11011101 äº¤å‰åï¼š 01001001 11011111 ï¼ˆ4ï¼‰å•äº¤å‰ç‚¹æ³• ï¼ˆç”¨äºäº’æ¢ç¼–ç ï¼‰ é€‰æ‹©ä¸€ä¸ªäº¤å‰ç‚¹ï¼Œå­ä»£çš„ä»åˆå§‹ä½ç½®å‡ºå‘çš„éƒ¨åˆ†ä»ä¸€ä¸ªåŸºå› å¤åˆ¶ï¼Œç„¶ååœ¨å¦ä¸€ä¸ªåŸºå› ä¸­æ‰«æï¼Œå¦‚æœæŸä¸ªä½ç‚¹åœ¨å­ä»£ä¸­æ²¡æœ‰ï¼Œå°±æŠŠå®ƒæ·»åŠ è¿›å»ã€‚ å¦‚ï¼šäº¤å‰å‰ï¼š 87213 | 09546 98356 | 71420 äº¤å‰åï¼š 87213 | 95640 98356 | 72104 ï¼ˆ5ï¼‰éƒ¨åˆ†åŒ¹é…äº¤å‰ï¼ˆPMXï¼‰æ³•ï¼ˆç”¨äºäº’æ¢ç¼–ç ï¼‰ å…ˆéšæœºäº§ç”Ÿä¸¤ä¸ªäº¤å‰ç‚¹ï¼Œå®šä¹‰è¿™ä¸¤ç‚¹é—´çš„åŒºåŸŸä¸ºåŒ¹é…åŒºåŸŸï¼Œå¹¶ç”¨äº¤æ¢ä¸¤ä¸ªçˆ¶ä»£çš„åŒ¹é…åŒºåŸŸã€‚ çˆ¶ä»£Aï¼š872 | 130 | 9546 çˆ¶ä»£Bï¼š983 | 567 | 1420 å˜ä¸ºï¼š TEMP A: 872 | 567 | 9546 TEMP B: 983 | 130 | 1420 å¯¹äº TEMP Aã€TEMP ï¼¢ä¸­åŒ¹é…åŒºåŸŸä»¥å¤–å‡ºç°çš„æ•°ç é‡å¤ï¼Œè¦ä¾æ®åŒ¹é…åŒºåŸŸå†…çš„ä½ç½®é€ä¸€è¿›è¡Œæ›¿æ¢ã€‚åŒ¹é…å…³ç³»ï¼š1&lt;â€”â€”&gt;ï¼• ï¼“&lt;â€”â€”&gt;ï¼– ï¼—&lt;â€”â€”&gt;ï¼ å­ä»£ï¼¡ï¼š802 | 567 | 9143 å­ä»£ï¼¢ï¼š986 | 130 | 5427 ï¼ˆ6ï¼‰é¡ºåºäº¤å‰æ³•(OX) ï¼ˆç”¨äºäº’æ¢ç¼–ç ï¼‰ ä»çˆ¶ä»£ï¼¡éšæœºé€‰ä¸€ä¸ªç¼–ç å­ä¸²ï¼Œæ”¾åˆ°å­ä»£ï¼¡çš„å¯¹åº”ä½ç½®ï¼›å­ä»£ï¼¡ç©ºä½™çš„ä½ç½®ä»çˆ¶ä»£ï¼¢ä¸­æŒ‰ï¼¢çš„é¡ºåºé€‰å–ï¼ˆä¸å·±æœ‰ç¼–ç ä¸é‡å¤ï¼‰ã€‚åŒç†å¯å¾—å­ä»£ï¼¢ã€‚ çˆ¶ä»£A: 872 | 139 | 0546 çˆ¶ä»£B: 983 | 567 | 1420 äº¤å‰åï¼š å­ä»£A: 856 | 139 | 7420 å­ä»£B: 821 | 567 | 3904 ï¼ˆ7ï¼‰å¾ªç¯äº¤å‰ï¼ˆCXï¼‰ï¼ˆç”¨äºäº’æ¢ç¼–ç ï¼‰ CXåŒOXäº¤å‰éƒ½æ˜¯ä»ä¸€ä¸ªäº²ä»£ä¸­å–ä¸€äº›åŸå¸‚ï¼Œè€Œå…¶å®ƒåŸå¸‚æ¥è‡ªå¦å¤–ä¸€ä¸ªäº²ä»£ï¼Œä½†æ˜¯äºŒè€…ä¸åŒä¹‹å¤„åœ¨äºï¼šOXä¸­æ¥è‡ªç¬¬ä¸€ä¸ªäº²ä»£çš„ç¼–ç å­ä¸²æ˜¯éšæœºäº§ç”Ÿçš„ï¼Œè€ŒCXå´ä¸æ˜¯ï¼Œå®ƒæ˜¯æ ¹æ®ä¸¤ä¸ªåŒäº²ç›¸åº”ä½ç½®çš„ç¼–ç è€Œç¡®å®šçš„ã€‚ çˆ¶ä»£Aï¼š1 2 3 4 5 6 7 8 9 çˆ¶ä»£Bï¼š5 4 6 9 2 3 7 8 1 å¯å¾—å¾ªç¯åŸºå› ï¼š1-&gt;5-&gt;2-&gt;4-&gt;3-&gt;6-&gt;9-&gt;7-&gt;8 å­ä»£ï¼¢çš„ç¼–ç åŒç†ã€‚ï¼ˆå¾ªç¯åŸºå›  5-&gt;1-&gt;4-&gt;2-&gt;6-&gt;3-&gt;9-&gt;7-&gt;8ï¼‰ å˜å¼‚(mutation)ï¼šäº¤å‰åå¯èƒ½ï¼ˆå¾ˆå°çš„æ¦‚ç‡ï¼‰å¯¹æŸ“è‰²ä½“è¿›è¡Œæ›´æ”¹ï¼Œæ¥é˜²æ­¢ç®—æ³•è¿‡æ—©æ”¶æ•›è€Œé™·å…¥å±€éƒ¨æœ€ä¼˜è§£ä¸­ã€‚ å˜å¼‚æ¦‚ç‡Pmä¸èƒ½å¤ªå°ï¼Œè¿™æ ·é™ä½å…¨å±€æœç´¢èƒ½åŠ›ï¼›ä¹Ÿä¸èƒ½å¤ªå¤§ï¼ŒPm &gt; 0.5ï¼Œè¿™æ—¶GAé€€åŒ–ä¸ºéšæœºæœç´¢ã€‚ ï¼ˆ1ï¼‰åŸºæœ¬ä½å˜å¼‚ç®—å­ï¼ˆç”¨äºäºŒè¿›åˆ¶ç¼–ç ï¼‰ åŸºæœ¬ä½å˜å¼‚ç®—å­æ˜¯æŒ‡å¯¹ä¸ªä½“ç¼–ç ä¸²éšæœºæŒ‡å®šçš„æŸä¸€ä½æˆ–æŸå‡ ä½åŸºå› ä½œå˜å¼‚è¿ç®—ã€‚å¯¹äºåŸºæœ¬é—ä¼ ç®—æ³•ä¸­ç”¨äºŒè¿›åˆ¶ç¼–ç ç¬¦å·ä¸²æ‰€è¡¨ç¤ºçš„ä¸ªä½“ï¼Œè‹¥éœ€è¦è¿›è¡Œå˜å¼‚æ“ä½œçš„æŸä¸€åŸºå› åº§ä¸Šçš„åŸæœ‰åŸºå› å€¼ä¸º0ï¼Œåˆ™å˜å¼‚æ“ä½œå°†å…¶å˜ä¸º1ï¼›åä¹‹ï¼Œè‹¥åŸæœ‰åŸºå› å€¼ä¸º1ï¼Œåˆ™å˜å¼‚æ“ä½œå°†å…¶å˜ä¸º0ã€‚ å˜å¼‚å‰ï¼š 000001110000000010000 å˜å¼‚åï¼š 000001110001000010000 ï¼ˆ2ï¼‰é€†è½¬å˜å¼‚ç®—å­ï¼ˆç”¨äºäº’æ¢ç¼–ç ï¼‰ï¼ˆæºä»£ç ä¸­ä½¿ç”¨ç±»ä¼¼æ­¤æ–¹æ³•ï¼‰ åœ¨ä¸ªä½“ä¸­éšæœºæŒ‘é€‰ä¸¤ä¸ªé€†è½¬ç‚¹ï¼Œå†å°†ä¸¤ä¸ªé€†è½¬ç‚¹é—´çš„åŸºå› äº¤æ¢ã€‚ å˜å¼‚å‰ï¼š 1346798205 å˜å¼‚åï¼š 1246798305 ä¸ªä½“ï¼ˆindividualï¼‰ï¼šæŒ‡æŸ“è‰²ä½“å¸¦æœ‰ç‰¹å¾çš„å®ä½“ï¼› ç§ç¾¤ï¼ˆpopulationï¼‰ï¼šä¸ªä½“çš„é›†åˆï¼Œè¯¥é›†åˆå†…ä¸ªä½“æ•°ç§°ä¸ºç§ç¾¤çš„å¤§å° é—ä¼ ç®—æ³•æ­¥éª¤ å¯¹æ½œåœ¨é—®é¢˜è¿›è¡Œç¼–ç ï¼Œåˆå§‹åŒ–åŸºå› ç»„ï¼Œå¹¶æ ¹æ®åŸºå› ç»„éšæœºåˆå§‹åŒ–ç§ç¾¤ï¼Œå¹¶æŒ‡å®šç¹è¡ä»£æ•°ã€‚ è®¡ç®—ç§ç¾¤ä¸­æ¯ä¸ªä¸ªä½“çš„é€‚åº”åº¦ï¼Œé€‰æ‹©ä¸€å®šæ•°ç›®çš„ç•™ä¸‹ï¼Œå…¶ä½™æ·˜æ±°ã€‚ åœ¨ç•™ä¸‹çš„ä¸ªä½“ä¸­ï¼Œéšæœºç¹è¡ï¼Œå¯¹åˆ†æ¯åŸºå› è¿›è¡Œäº¤å‰ï¼ˆæå°æ¦‚ç‡å˜å¼‚ï¼‰ï¼Œäº§ç”Ÿä¸‹ä¸€ä»£ã€‚ å›åˆ°ç¬¬2æ­¥è¿›è¡Œå¾ªç¯ã€‚ç›´åˆ°è¾¾åˆ°æŒ‡å®šçš„ç¹è¡ä»£æ•° é—ä¼ ç®—æ³•å®ä¾‹ import random import math import numpy as np import matplotlib.pyplot as plt class GeneticAlgorithm: def __init__(self, fitness_function, iterations=10, dna_length=32, population_size = 10): self.fitness_function = fitness_function self.iterations = iterations # è¿­ä»£æ¬¡æ•° self.dna_length = dna_length # dna é•¿åº¦ self.population_size = population_size # ç§ç¾¤è§„æ¨¡ self.base = 2 ** self.dna_length # åŸºæ•°ï¼Œæœ€å¤šæœ‰å¤šå°‘ä¸ªä¸åŒçš„ä¸ªä½“ # éšæœºç”Ÿæˆåˆå§‹ç§ç¾¤ self.group = self.init_group(self.dna_length, self.population_size) def init_group(self, dna_length, population_size): group = [] for i in range(population_size): code = random.randint(0, 2 ** self.dna_length - 1) group.append(code) return group def decode(self, num, min_value=-10, max_value=10): return (max_value - min_value) / (2 ** self.dna_length - 1) * num + min_value def iterate(self, verbose=True): fitnesses = [] for individual in self.group: x = self.decode(individual) fitness = self.fitness_function(x) fitnesses.append(fitness) min_fitness = min(fitnesses) # æ·˜æ±°æœ€èœçš„ä¸ªä½“ é¿å…é€‚åº”åº¦ä¸º0 weights = [f - min_fitness for f in fitnesses] # 2. è½®ç›˜èµŒé€‰æ‹© # é€‰æ‹©æ•°é‡å°äº ç§ç¾¤æ•°é‡ ç•™å‡ºä½ç½®ä¿ç•™æœ€ä¼˜ä¸ªä½“ new_group = random.choices(self.group, k=self.population_size - 1, weights=weights) # 3. äº¤å‰ new_group = self.cross(new_group) # 4. å˜å¼‚ new_group = self.mutation(new_group) # ä¿ç•™é€‚åº”åº¦æœ€é«˜çš„ä¸ªä½“ best = max(zip(fitnesses, self.group), key=lambda x: x[0]) new_group.append(best[1]) self.group = new_group if verbose: print(&quot;best fitness:&quot;, best[0], &quot;best dna:&quot;, bin(best[1])) return best def cross(self, group, probability=0.8): &quot;&quot;&quot; äº¤å‰ probability: äº¤å‰æ¦‚ç‡ &quot;&quot;&quot; new_group = [] for father in group: child = father if random.random() &lt; probability: # éšæœºé€‰æ‹©æ¯äº² mother = random.choice(group) # éšæœºé€‰æ‹©äº¤å‰ä½ç½® # random.randint(1, 4) -&gt; 1, 2, 3, 4 pos = random.randint(1, self.dna_length-1) mother = mother &amp; (2 ** pos - 1) father = father &amp; (self.base - 2 ** pos) child = father + mother new_group.append(child) return new_group def mutation(self, group, probability=0.10): &quot;&quot;&quot; å˜å¼‚ probability: å˜å¼‚æ¦‚ç‡ &quot;&quot;&quot; for k, individual in enumerate(group): # éå†æ‰€æœ‰dna ç”Ÿæˆå˜å¼‚å› å­ mutation_factor = 0 for i in range(self.dna_length): mutation_factor = mutation_factor &lt;&lt; 1 if random.random() &lt; probability: mutation_factor += 1 group[k] = individual ^ mutation_factor return group def fitness_function(x): # return x ** 2 * math.sin(x) return - (10*math.sin(5*x)+7*math.cos(4*x)) ga = GeneticAlgorithm(fitness_function) y = [] for i in range(100): best_fitness, dna = ga.iterate(verbose=False) y.append(best_fitness) best_x = ga.decode(dna) print(&quot;æœ€ä¼˜å‚æ•°: &quot;, best_x, &quot;æœ€ä¼˜å€¼:&quot;, best_fitness) plt.plot(y) æœ€ä¼˜å‚æ•°: -4.036159285818264 æœ€ä¼˜å€¼: 16.05757830547691 import matplotlib.pyplot as plt import numpy as np x = np.linspace(-10, 10, 10000) y = 10*np.sin(5*x)+7*np.cos(4*x) y = -y plt.plot(x, y) plt.vlines(best_x, min(y), max(y), colors=&quot;r&quot;) plt.show() èšç¾¤ç®—æ³•(ACO) ç®€å•ä»‹ç»ä¸€ä¸‹èšç¾¤ç®—æ³•çš„æ€è·¯ã€‚æˆ‘ä»¬å°è¯•å¤åŸä¸€ä¸‹èš‚èšå¯»æ‰¾é£Ÿç‰©çš„åœºæ™¯ã€‚æƒ³è±¡æœ‰ä¸€åªèš‚èšæ‰¾åˆ°äº†é£Ÿç‰©ï¼Œè¿™æ—¶å®ƒéœ€è¦å°†é£Ÿç‰©å¸¦å›èšç©´ã€‚å¯¹äºè¿™ä¸€åªèš‚èšè€Œè¨€ï¼Œå®ƒæ˜¾ç„¶å¹¶ä¸çŸ¥é“åº”è¯¥æ€ä¹ˆèµ°ã€‚é‚£ä¹ˆï¼Œè¿™åªèš‚èšæœ‰å¯èƒ½ä¼šéšæœºé€‰æ‹©ä¸€æ¡è·¯çº¿ã€‚ è¿™æ¡è·¯çº¿å¾ˆå¯èƒ½æ˜¯ä¸€æ¡è¿œè·¯ã€‚ä½†æ˜¯ï¼Œèš‚èšä¸€è·¯ä¸Šç•™ä¸‹äº†è®°å·ï¼Œä¹Ÿå°±æ˜¯ä¿¡æ¯ç´ ã€‚å¦‚æœè¿™åªèš‚èšç»§ç»­ä¸åœåœ°æ¬è¿é£Ÿç‰©ï¼Œæˆ–è€…æœ‰è®¸å¤šå…¶ä»–èš‚èšä¸€å—æ¬è¿çš„è¯ã€‚ä»–ä»¬æ€»ä¼šåœ¨è¿æ°”å¥½çš„æ—¶å€™èµ°åˆ°æ›´å¿«å¾€è¿”çš„è·¯çº¿ä¸Šã€‚èš‚èšé€‰æ‹©çš„è·¯è¶Šå¥½ï¼Œç›¸åŒæ—¶é—´å†…å¾€è¿”çš„æ¬¡æ•°ä¹Ÿå°±æ›´å¤šï¼Œä¹Ÿå°±åœ¨è·¯ä¸Šç•™ä¸‹äº†æ›´å¤šçš„ä¿¡æ¯ç´ ã€‚ äºæ˜¯ï¼Œèš‚èšä»¬æ€»ä¼šå‘ç°ï¼Œæœ‰ä¸€äº›è·¯å¾„çš„ä¿¡æ¯ç´ æ›´æµ“ï¼Œè¿™äº›è·¯å¾„å°±æ˜¯æ›´å¥½çš„è·¯çº¿ã€‚äºæ˜¯èš‚èšä¹Ÿå°±æ›´å¤šåœ°å‘ä¿¡æ¯ç´ æ›´æµ“çš„è·¯å¾„ä¸Šåç§»ã€‚èš‚èšä»¬ä¸åœé‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œæœ€ç»ˆæ€»èƒ½æ‰¾åˆ°ä¸€æ¡ç¡®å®šçš„è·¯çº¿ï¼Œè€Œè¿™æ¡è·¯çº¿å°±æ˜¯èš‚èšä»¬æ‰¾åˆ°çš„æœ€ä¼˜è·¯å¾„ã€‚ èšç¾¤ç®—æ³•æ­¥éª¤ åˆå§‹åŒ–èš‚èšæ•°é‡ã€å¯è¡Œè·¯æ®µã€æ¯æ¡è·¯æ®µè·ç¦»ã€æ¯æ¡è·¯æ®µçš„åˆå§‹ä¿¡æ¯ç´ å¤§å°ç­‰ä¿¡æ¯ è®¾å®šèš‚èšçš„èµ·ç‚¹ã€ç»ˆç‚¹ã€‚ èš‚èšä»èµ·ç‚¹å‡ºå‘æ ¹æ®ä¿¡æ¯ç´ æµ“åº¦ï¼Œæœ‰ä¸€å®šçš„æ¦‚ç‡æ€§é€‰æ‹©è·¯æ®µï¼Œæµ“åº¦è¶Šé«˜ï¼Œæ¦‚ç‡è¶Šå¤§ï¼Œé€æ­¥å›åˆ°ç»ˆç‚¹ã€‚ åœ¨èš‚èšèµ°è¿‡çš„è·¯å¾„ä¸Šï¼Œæ ¹æ®æ¯æ¡è·¯æ®µçš„é•¿åº¦æŒ‰æ¯”ä¾‹é‡Šæ”¾ä¿¡æ¯ç´ ï¼ŒçŸ­çš„è·¯æ®µé‡Šæ”¾çš„ä¿¡æ¯ç´ å¤šï¼Œé•¿çš„è·¯æ®µé‡Šæ”¾çš„ä¿¡æ¯ç´ å°‘ã€‚ å¯¹æ‰€æœ‰è·¯æ®µçš„ä¿¡æ¯ç´ è¿›è¡ŒæŒ¥å‘ã€‚ å›åˆ°ç¬¬äºŒæ­¥è¿›è¡Œå¾ªç¯ï¼Œç›´åˆ°èš‚èšæ•°é‡è¿­ä»£å®Œã€‚ èšç¾¤ç®—æ³•å®ä¾‹ TSPé—®é¢˜ï¼šæ—…è¡Œå•†é—®é¢˜ï¼Œå³TSPé—®é¢˜ï¼ˆTraveling Salesman Problemï¼‰ï¼Œç»™å®šä¸€ç»„åŸå¸‚å’Œæ¯å¯¹åŸå¸‚ä¹‹é—´çš„è·ç¦»ï¼Œå•†å®¶ä»å…¶ä¸­ä¸€ä¸ªåŸå¸‚å‡ºå‘ï¼Œè¦æ±‚æ¯ä¸ªåŸå¸‚éƒ½è¦ç»è¿‡ä¸”æ¯ä¸ªåŸå¸‚ç»è¿‡ä¸€æ¬¡ï¼Œæœ€åå›åˆ°èµ·ç‚¹åŸå¸‚ï¼Œæ±‚è§£å•†å®¶è®¿é—®è¿™äº›åŸå¸‚çš„æœ€çŸ­è·¯å¾„ã€‚ #èšç¾¤ç®—æ³•è§£å†³TSP import numpy as np #å¯¼å…¥å‡½æ•°åº“,æ•°å­¦åŸºç¡€åº“,å­˜å‚¨å’Œå¤„ç†å¤§å‹å¤šç»´çŸ©é˜µ import matplotlib.pyplot as plt #æä¾›ä¸€ä¸ªç»˜å›¾æ¡†æ¶ import matplotlib #matplotlibæ˜¯pythonä¸Šçš„ä¸€ä¸ª2Dç»˜å›¾åº“ import math import random matplotlib.rcParams['font.family'] = 'STSong' #è®¾å®šç»˜åˆ¶åŒºåŸŸçš„å…¨éƒ¨å­—ä½“å˜æˆ åæ–‡ä»¿å®‹ city_name = [] #åˆ›å»ºç©ºæ•°ç»„ï¼Œç”¨äºå­˜æ”¾30åŸå¸‚åç§° city_condition = [] #åˆ›å»ºç©ºæ•°ç»„ï¼Œç”¨äºå­˜æ”¾30åŸå¸‚åæ ‡ with open('30åŸå¸‚çš„åæ ‡.txt','r',encoding='UTF-8') as f: lines = f.readlines() print(&quot;åŸå¸‚åæ ‡ä¿¡æ¯ï¼ˆå…¨éƒ¨ï¼‰ï¼š&quot;,lines) #è°ƒç”¨readlines()ä¸€æ¬¡è¯»å–æ‰€æœ‰å†…å®¹å¹¶æŒ‰è¡Œè¿”å›liståˆ—è¡¨ç»™lines #forå¾ªç¯æ¯æ¬¡è¯»å–ä¸€è¡Œï¼Œå³ä¸€ä¸ªåŸå¸‚çš„åæ ‡æ•°æ® for line in lines: #ä»linesåˆ—è¡¨ä¸­é€ä¸ªè¯»å–å…ƒç´ ï¼Œèµ‹ç»™lineå˜é‡ line = line.split('\\n')[0] #ç”¨splitï¼ˆï¼‰å°†è¯¥è¡Œçš„å•è¯åˆ†å‰²æˆåˆ—è¡¨ï¼Œæ¯ä¸ªå•è¯å°±æ—¶ä¸€ä¸ªåˆ—è¡¨é¡¹ç›® line = line.split(',') city_name.append(line[0]) #ç”¨äºåœ¨åˆ—è¡¨æœ«å°¾æ·»åŠ æ–°çš„å¯¹è±¡ï¼Œåˆ—è¡¨åªå ä¸€ä¸ªç´¢å¼•ä½ï¼Œåœ¨åŸæœ‰åˆ—è¡¨ä¸Šå¢åŠ  city_condition.append([float(line[1]), float(line[2])]) #print(&quot;åŸå¸‚åç§°+åæ ‡ä¿¡æ¯ï¼š&quot;,line) city_condition = np.array(city_condition) #è·å–30åŸå¸‚åæ ‡ #print(city_condition) #print(city_name) #lm=[] #lm=np.array(range(0,31,3)) #print(lm) #å»ºç«‹ä¸€ä¸ªcitycount-citycountäºŒç»´æ•°ç»„ï¼Œå­˜æ”¾æ¯å¯¹åŸå¸‚ä¹‹é—´çš„è·ç¦»ã€‚æ³¨æ„ï¼Œå› ä¸ºè¦æ ¹æ®è·ç¦»çŸ©é˜µæ±‚å¯å‘å‡½æ•°Î· \\etaÎ·ij(Î· \\etaÎ·ijä¸ºåŸå¸‚iå’ŒåŸå¸‚jä¹‹é—´è·ç¦»çš„å€’æ•°ï¼‰,æ‰€æœ‰è·ç¦»çŸ©é˜µçš„å¯¹è§’çº¿ä¸èƒ½ä¸º0ï¼Œæˆ‘æŠŠå¯¹è§’çº¿è®¾ç½®ä¸º10000ï¼Œå…¶å®åªè¦ä¸ä¸ºé›¶å°±å¯ä»¥ã€‚ #Distanceè·ç¦»çŸ©é˜µ city_count = len(city_name) #å–æ•°ç»„é•¿åº¦ Distance = np.zeros((city_count, city_count)) #30*30çš„é›¶çŸ©é˜µ for i in range(city_count): for j in range(city_count): if i != j: Distance[i][j] = math.sqrt((city_condition[i][0] - city_condition[j][0]) ** 2 + (city_condition[i][1] - city_condition[j][1]) ** 2) else: Distance[i][j] = 100000 #ä¸ä¸º0å³å¯ # èš‚èšæ•°é‡ AntCount = 100 # åŸå¸‚æ•°é‡ city_count = len(city_name) # ä¿¡æ¯ç´  alpha = 1 # ä¿¡æ¯ç´ é‡è¦ç¨‹åº¦å› å­ beta = 2 # å¯å‘å‡½æ•°é‡è¦ç¨‹åº¦å› å­ rho = 0.1 #æŒ¥å‘é€Ÿåº¦ iter = 0 # è¿­ä»£åˆå§‹å€¼ MAX_iter = 200 # æœ€å¤§è¿­ä»£å€¼ Q = 1 # å»ºç«‹ä¸€ä¸ªcitycount-citycountäºŒç»´çš„ä¿¡æ¯ç´ çŸ©é˜µpheromonetableï¼Œå­˜æ”¾æ¯å¯¹åŸå¸‚ä¹‹é—´çš„ä¿¡æ¯ç´ ã€‚åˆå§‹ä¿¡æ¯ç´ çŸ©é˜µï¼Œå…¨æ˜¯ä¸º1ç»„æˆçš„çŸ©é˜µã€‚åœ¨æ¯æ¬¡è¿­ä»£ä¹‹åï¼Œæ›´æ–°è¯¥ä¿¡æ¯ç´ çŸ©é˜µã€‚ #å»ºç«‹ä¸€ä¸ªAntCount-city_countäºŒç»´çŸ©é˜µcandidateï¼Œåœ¨æ¯æ¬¡è¿­ä»£ä¸­ï¼Œå­˜æ”¾æ‰€æœ‰èš‚èšçš„è·¯å¾„(ä¸€åªèš‚èšä¸€ä¸ªè·¯å¾„)ã€‚ #å»ºç«‹ä¸€ä¸ªMAX_iter-city_countäºŒç»´çŸ©é˜µpath_bestï¼Œå­˜æ”¾çš„æ˜¯ç›¸åº”çš„ï¼Œæ¯æ¬¡è¿­ä»£åçš„æœ€ä¼˜è·¯å¾„ï¼Œæ¯æ¬¡è¿­ä»£åªæœ‰ä¸€ä¸ªå€¼ #å»ºç«‹ä¸€ä¸ªä¸€ç»´æ•°ç»„distance_bestï¼Œå­˜æ”¾æ¯æ¬¡è¿­ä»£çš„æœ€ä¼˜è·ç¦»ã€‚ # åˆå§‹ä¿¡æ¯ç´ çŸ©é˜µï¼Œå…¨æ˜¯ä¸º1ç»„æˆçš„çŸ©é˜µ pheromonetable = np.ones((city_count, city_count)) # å€™é€‰é›†åˆ—è¡¨,å­˜æ”¾100åªèš‚èšçš„è·¯å¾„(ä¸€åªèš‚èšä¸€ä¸ªè·¯å¾„),ä¸€å…±å°±Antcountä¸ªè·¯å¾„ï¼Œä¸€å…±æ˜¯èš‚èšæ•°é‡*30ä¸ªåŸå¸‚æ•°é‡ candidate = np.zeros((AntCount, city_count)).astype(int) # path_bestå­˜æ”¾çš„æ˜¯ç›¸åº”çš„ï¼Œæ¯æ¬¡è¿­ä»£åçš„æœ€ä¼˜è·¯å¾„ï¼Œæ¯æ¬¡è¿­ä»£åªæœ‰ä¸€ä¸ªå€¼ path_best = np.zeros((MAX_iter, city_count)) # å­˜æ”¾æ¯æ¬¡è¿­ä»£çš„æœ€ä¼˜è·ç¦» distance_best = np.zeros( MAX_iter) # å€’æ•°çŸ©é˜µ etable = 1.0 / Distance while iter &lt; MAX_iter: # firstï¼šèš‚èšåˆå§‹ç‚¹é€‰æ‹© if AntCount &lt;= city_count: #np.random.permutationéšæœºæ’åˆ—ä¸€ä¸ªæ•°ç»„çš„ #x[:,n]è¡¨ç¤ºåœ¨å…¨éƒ¨æ•°ç»„ï¼ˆç»´ï¼‰ä¸­å–ç¬¬nä¸ªæ•°æ®ï¼Œç›´è§‚æ¥è¯´ï¼Œx[:,n]å°±æ˜¯å–æ‰€æœ‰é›†åˆçš„ç¬¬nä¸ªæ•°æ®, candidate[:, 0] = np.random.permutation(range(city_count))[:AntCount] else: m =AntCount -city_count n =2 candidate[:city_count, 0] = np.random.permutation(range(city_count))[:] while m &gt;city_count: candidate[city_count*(n -1):city_count*n, 0] = np.random.permutation(range(city_count))[:] m = m -city_count n = n + 1 candidate[city_count*(n-1):AntCount,0] = np.random.permutation(range(city_count))[:m] length = np.zeros(AntCount)#æ¯æ¬¡è¿­ä»£çš„Nä¸ªèš‚èšçš„è·ç¦»å€¼ #print(candidate) # èš‚èšç”±å½“å‰åŸå¸‚ié€‰æ‹©åˆ°ä¸‹ä¸€ä¸ªåŸå¸‚jã€‚é¦–å…ˆå»ºç«‹ä¸€ä¸ªåˆ—è¡¨ unvisitå­˜æ”¾è¿˜æœªè®¿é—®è¿‡çš„åŸå¸‚ï¼Œæ¯æ¬¡è®¿é—®ä¸€ä¸ªåŸå¸‚ä¹‹åï¼ŒæŠŠè¯¥åŸå¸‚ä»unvisité‡Œé¢ç§»é™¤ã€‚ç”±å½“å‰åŸå¸‚é€‰æ‹©ä¸‹ä¸€ä¸ªåŸå¸‚æ—¶ï¼Œä½¿ç”¨æ¦‚ç‡å‡½æ•°åˆ†åˆ«è®¡ç®—å½“å‰åŸå¸‚åˆ°è¿˜æœªè®¿é—®çš„æ‰€æœ‰åŸå¸‚ä¹‹é—´æ¦‚ç‡ã€‚ ç´¯è®¡æ¦‚ç‡ï¼Œè½®ç›˜èµŒé€‰æ‹©ä¸‹ä¸€æ¬¡ä¸ªåŸå¸‚ã€‚ # secondï¼šé€‰æ‹©ä¸‹ä¸€ä¸ªåŸå¸‚é€‰æ‹© for i in range(AntCount): # ç§»é™¤å·²ç»è®¿é—®çš„ç¬¬ä¸€ä¸ªå…ƒç´  unvisit = list(range(city_count)) # åˆ—è¡¨å½¢å¼å­˜å‚¨æ²¡æœ‰è®¿é—®çš„åŸå¸‚ç¼–å· visit = candidate[i, 0] # å½“å‰æ‰€åœ¨ç‚¹,ç¬¬iä¸ªèš‚èšåœ¨ç¬¬ä¸€ä¸ªåŸå¸‚ unvisit.remove(visit) # åœ¨æœªè®¿é—®çš„åŸå¸‚ä¸­ç§»é™¤å½“å‰å¼€å§‹çš„ç‚¹ for j in range(1, city_count):#è®¿é—®å‰©ä¸‹çš„city_countä¸ªåŸå¸‚ï¼Œcity_countæ¬¡è®¿é—® # æ¯è¿­ä»£ä¸€æ¬¡ä¹‹åï¼Œæ›´æ–°æ‰€æœ‰åŸå¸‚ä¹‹é—´çš„ä¿¡æ¯ç´ ã€‚é¦–å…ˆå»ºä¸€ä¸ªä¿¡æ¯ç´ çš„å¢åŠ é‡çŸ©é˜µï¼Œå­˜æ”¾è¯¥æ¬¡è¿­ä»£åæ¯æ¡è·¯å¾„çš„ä¿¡æ¯ç´ å¢é‡ã€‚æ¯æ¡è·¯å¾„ä¸Šçš„ä¿¡æ¯ç´ ç­‰äºä¿¡æ¯ç´ è‡ªèº«æŒ¥å‘åå‰©ä½™çš„ä¿¡æ¯ç´ åŠ ä¸Šæ¯åªèš‚èšç»è¿‡åŸå¸‚iåˆ°åŸå¸‚jç•™ä¸‹çš„ä¿¡æ¯ç´ ã€‚æ³¨æ„ï¼Œæ›´æ–°ä¿¡æ¯ç´ å…¶å®æœ‰ä¸‰ç§æ–¹å¼ã€‚æˆ‘é€‰æ‹©çš„æ˜¯ç¬¬ä¸€ç§ï¼šâ–³Ï„=Q/L,Qä¸ºå¸¸æ•°ï¼Œæè¿°èš‚èšé‡Šæ”¾ä¿¡æ¯ç´ çš„æµ“åº¦ï¼ŒLä¸ºæ¯åªèš‚èšå‘¨æ¸¸ä¸­æ‰€èµ°è·¯å¾„çš„æ€»é•¿åº¦ã€‚å³æ¯åªèš‚èšä»åŸå¸‚iåˆ°åŸå¸‚jä¹‹é—´ä¿¡æ¯ç´ çš„å¢é‡ç­‰äºQé™¤ä»¥å‘¨æ¸¸ä¸­æ‰€èµ°è·¯å¾„çš„é•¿åº¦ã€‚å¯¹äºåŒä¸€åªèš‚èšï¼Œæ‰€æœ‰çš„è·¯å¾„ä¸Šï¼ˆä»»æ„ä¸¤ä¸ªåŸå¸‚ä¹‹é—´ï¼‰â–³Ï„æ˜¯ä¸€æ ·çš„ã€‚ protrans = np.zeros(len(unvisit))#æ¯æ¬¡å¾ªç¯éƒ½æ›´æ”¹å½“å‰æ²¡æœ‰è®¿é—®çš„åŸå¸‚çš„è½¬ç§»æ¦‚ç‡çŸ©é˜µ1*30,1*29,1*28... # ä¸‹ä¸€åŸå¸‚çš„æ¦‚ç‡å‡½æ•° for k in range(len(unvisit)): # è®¡ç®—å½“å‰åŸå¸‚åˆ°å‰©ä½™åŸå¸‚çš„ï¼ˆä¿¡æ¯ç´ æµ“åº¦^alphaï¼‰*ï¼ˆåŸå¸‚é€‚åº”åº¦çš„å€’æ•°ï¼‰^beta # etable[visit][unvisit[k]],(alpha+1)æ˜¯å€’æ•°åˆ†ä¹‹ä¸€ï¼Œpheromonetable[visit][unvisit[k]]æ˜¯ä»æœ¬åŸå¸‚åˆ°kåŸå¸‚çš„ä¿¡æ¯ç´  protrans[k] = np.power(pheromonetable[visit][unvisit[k]], alpha) * np.power( etable[visit][unvisit[k]], (alpha + 1)) # ç´¯è®¡æ¦‚ç‡ï¼Œè½®ç›˜èµŒé€‰æ‹© cumsumprobtrans = (protrans / sum(protrans)).cumsum() cumsumprobtrans -= np.random.rand() # æ±‚å‡ºç¦»éšæœºæ•°äº§ç”Ÿæœ€è¿‘çš„ç´¢å¼•å€¼ k = unvisit[list(cumsumprobtrans &gt; 0).index(True)] # ä¸‹ä¸€ä¸ªè®¿é—®åŸå¸‚çš„ç´¢å¼•å€¼ candidate[i, j] = k unvisit.remove(k) length[i] += Distance[visit][k] visit = k # æ›´æ”¹å‡ºå‘ç‚¹ï¼Œç»§ç»­é€‰æ‹©ä¸‹ä¸€ä¸ªåˆ°è¾¾ç‚¹ length[i] += Distance[visit][candidate[i, 0]]#æœ€åä¸€ä¸ªåŸå¸‚å’Œç¬¬ä¸€ä¸ªåŸå¸‚çš„è·ç¦»å€¼ä¹Ÿè¦åŠ è¿›å» &quot;&quot;&quot; æ›´æ–°è·¯å¾„ç­‰å‚æ•° &quot;&quot;&quot; # å¦‚æœè¿­ä»£æ¬¡æ•°ä¸ºä¸€æ¬¡ï¼Œé‚£ä¹ˆæ— æ¡ä»¶è®©åˆå§‹å€¼ä»£æ›¿path_best,distance_best. if iter == 0: distance_best[iter] = length.min() path_best[iter] = candidate[length.argmin()].copy() else: # å¦‚æœå½“å‰çš„è§£æ²¡æœ‰ä¹‹å‰çš„è§£å¥½ï¼Œé‚£ä¹ˆå½“å‰æœ€ä¼˜è¿˜æ˜¯ä¸ºä¹‹å‰çš„é‚£ä¸ªå€¼ï¼›å¹¶ä¸”ç”¨å‰ä¸€ä¸ªè·¯å¾„æ›¿æ¢ä¸ºå½“å‰çš„æœ€ä¼˜è·¯å¾„ if length.min() &gt; distance_best[iter - 1]: distance_best[iter] = distance_best[iter - 1] path_best[iter] = path_best[iter - 1].copy() else: # å½“å‰è§£æ¯”ä¹‹å‰çš„è¦å¥½ï¼Œæ›¿æ¢å½“å‰è§£å’Œè·¯å¾„ distance_best[iter] = length.min() path_best[iter] = candidate[length.argmin()].copy() &quot;&quot;&quot; ä¿¡æ¯ç´ çš„æ›´æ–° &quot;&quot;&quot; #ä¿¡æ¯ç´ çš„å¢åŠ é‡çŸ©é˜µ changepheromonetable = np.zeros((city_count, city_count)) for i in range(AntCount): for j in range(city_count - 1): # å½“å‰è·¯å¾„æ¯”å¦‚åŸå¸‚23ä¹‹é—´çš„ä¿¡æ¯ç´ çš„å¢é‡ï¼š1/å½“å‰èš‚èšè¡Œèµ°çš„æ€»è·ç¦»çš„ä¿¡æ¯ç´  changepheromonetable[candidate[i, j]][candidate[i][j + 1]] += Q / length[i] #Distance[candidate[i, j]][candidate[i, j + 1]] #æœ€åä¸€ä¸ªåŸå¸‚å’Œç¬¬ä¸€ä¸ªåŸå¸‚çš„ä¿¡æ¯ç´ å¢åŠ é‡ changepheromonetable[candidate[i, j + 1]][candidate[i, 0]] += Q / length[i] #ä¿¡æ¯ç´ æ›´æ–°çš„å…¬å¼ï¼š pheromonetable = (1 - rho) * pheromonetable + changepheromonetable iter += 1 print(&quot;èšç¾¤ç®—æ³•çš„æœ€ä¼˜è·¯å¾„&quot;,path_best[-1]+1) print(&quot;è¿­ä»£&quot;, MAX_iter,&quot;æ¬¡å&quot;,&quot;èšç¾¤ç®—æ³•æ±‚å¾—æœ€ä¼˜è§£&quot;,distance_best[-1]) # è·¯çº¿å›¾ç»˜åˆ¶ fig = plt.figure() plt.title(&quot;Best roadmap&quot;) x = [] y = [] path = [] for i in range(len(path_best[-1])): x.append(city_condition[int(path_best[-1][i])][0]) y.append(city_condition[int(path_best[-1][i])][1]) path.append(int(path_best[-1][i])+1) x.append(x[0]) y.append(y[0]) path.append(path[0]) for i in range(len(x)): plt.annotate(path[i], xy=(x[i], y[i]), xytext=(x[i] + 0.3, y[i] + 0.3)) plt.plot(x, y,'-o') # è·ç¦»è¿­ä»£å›¾ fig = plt.figure() #plt.figureè¯­()---åœ¨pltä¸­ç»˜åˆ¶ä¸€å¼ å›¾ç‰‡ plt.title(&quot;Distance iteration graph&quot;)#è·ç¦»è¿­ä»£å›¾ plt.plot(range(1, len(distance_best) + 1), distance_best) plt.xlabel(&quot;Number of iterations&quot;)#è¿­ä»£æ¬¡æ•° plt.ylabel(&quot;Distance value&quot;)#è·ç¦»å€¼ plt.show() åŸå¸‚åæ ‡ä¿¡æ¯ï¼ˆå…¨éƒ¨ï¼‰ï¼š ['1,41,94\\n', '2,37,84\\n', '3,53,67\\n', '4,25,62\\n', '5,7,64\\n', '6,2,99\\n', '7,68,58\\n', '8,71, 44\\n', '9,54,62\\n', '10,83,69\\n', '11,64,60\\n', '12,18,54\\n', '13,22,60\\n', '14,83,46\\n', '15,91,38\\n', '16,25,38\\n', '17,24,42\\n', '18,58,69\\n', '19,71,71\\n', '20,74,78\\n', '21,87,76\\n', '22,18,40\\n', '23,13,40\\n', '24,82,7\\n', '25,62,32\\n', '26,58,35\\n', '27,45,21\\n', '28,41,26\\n', '29,44,35\\n', '30,4,50\\n'] èšç¾¤ç®—æ³•çš„æœ€ä¼˜è·¯å¾„ [14. 15. 24. 25. 26. 29. 28. 27. 16. 17. 22. 23. 30. 12. 13. 4. 5. 6. 1. 2. 9. 3. 18. 19. 20. 21. 10. 7. 11. 8.] è¿­ä»£ 200 æ¬¡å èšç¾¤ç®—æ³•æ±‚å¾—æœ€ä¼˜è§£ 427.55589628421023 ç²’å­ç¾¤ä¼˜åŒ–ç®—æ³•ï¼ˆPSOï¼‰ æ˜¯1995å¹´Eberhartåšå£«å’ŒKennedyåšå£«ä¸€èµ·æå‡ºçš„ï¼Œå®ƒæ˜¯æºäºå¯¹é¸Ÿç¾¤æ•é£Ÿè¡Œä¸ºçš„ç ”ç©¶ã€‚ç²’å­ç¾¤ä¼˜åŒ–ç®—æ³•çš„åŸºæœ¬æ ¸å¿ƒæ˜¯åˆ©ç”¨ç¾¤ä½“ä¸­çš„ä¸ªä½“å¯¹ä¿¡æ¯çš„å…±äº«ä»è€Œä½¿å¾—æ•´ä¸ªç¾¤ä½“çš„è¿åŠ¨åœ¨é—®é¢˜æ±‚è§£ç©ºé—´ä¸­äº§ç”Ÿä»æ— åºåˆ°æœ‰åºçš„æ¼”åŒ–è¿‡ç¨‹ï¼Œä»è€Œè·å¾—é—®é¢˜çš„æœ€ä¼˜è§£ã€‚ åœ¨ç²’å­ç¾¤ä¼˜åŒ–ç®—æ³•ä¸­ï¼Œç›®æ ‡ç©ºé—´ä¸­çš„æ¯ä¸ªè§£éƒ½å¯ä»¥ç”¨ä¸€åªé¸Ÿï¼ˆç²’å­ï¼‰è¡¨ç¤ºï¼Œé—®é¢˜ä¸­çš„éœ€æ±‚è§£å°±æ˜¯é¸Ÿç¾¤æ‰€è¦å¯»æ‰¾çš„é£Ÿç‰©æºã€‚åœ¨å¯»æ‰¾æœ€ä¼˜è§£çš„è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªç²’å­éƒ½å­˜åœ¨ä¸ªä½“è¡Œä¸ºå’Œç¾¤ä½“è¡Œä¸ºã€‚æ¯ä¸ªç²’å­éƒ½ä¼šå­¦ä¹ åŒä¼´çš„é£è¡Œç»éªŒå’Œå€Ÿé‰´è‡ªå·±çš„é£è¡Œç»éªŒå»å¯»æ‰¾æœ€ä¼˜è§£ã€‚æ¯ä¸ªç²’å­éƒ½ä¼šå‘ä¸¤ä¸ªå€¼å­¦ä¹ ï¼Œä¸€ä¸ªå€¼æ˜¯ä¸ªä½“çš„å†å²æœ€ä¼˜å€¼ p_{best} ;å¦ä¸€ä¸ªå€¼æ˜¯ç¾¤ä½“çš„å†å²æœ€ä¼˜å€¼ï¼ˆå…¨å±€æœ€ä¼˜å€¼ï¼‰ ğ‘”ğ‘ğ‘’ğ‘ ğ‘¡gbest ã€‚ç²’å­ä¼šæ ¹æ®è¿™ä¸¤ä¸ªå€¼æ¥è°ƒæ•´è‡ªèº«çš„é€Ÿåº¦å’Œä½ç½®ï¼Œè€Œæ¯ä¸ªä½ç½®çš„ä¼˜åŠ£éƒ½æ˜¯æ ¹æ®é€‚åº”åº¦å€¼æ¥ç¡®å®šçš„ã€‚é€‚åº”åº¦å‡½æ•°æ˜¯ä¼˜åŒ–çš„ç›®æ ‡å‡½æ•°ã€‚ ç›¸å…³æœ¯è¯­ ç²’å­å’Œé€Ÿåº¦åˆå§‹åŒ– åœ¨ä¸€ä¸ªDç»´çš„ç›®æ ‡æœç´¢ç©ºé—´ä¸­ï¼Œç”±Nä¸ªç²’å­ç»„æˆä¸€ä¸ªç²’å­ç¾¤ï¼Œå…¶ä¸­æ¯ä¸ªç²’å­éƒ½æ˜¯ä¸€ä¸ªDç»´å‘é‡ï¼Œå…¶ç©ºé—´ä½ç½®å¯ä»¥è¡¨ç¤ºä¸º ğ‘¥ğ‘–=(ğ‘¥ğ‘–1,ğ‘¥ğ‘–2,â‹¯ ,ğ‘¥ğ‘–ğ·),ğ‘–=1,2,â‹¯ ,ğ‘x**i=(x**i1,x**i2,â‹¯,xiD),i=1,2,â‹¯,N ç²’å­çš„ç©ºé—´ä½ç½®æ˜¯ç›®æ ‡ä¼˜åŒ–é—®é¢˜ä¸­çš„ä¸€ä¸ªè§£ï¼Œå°†å…¶ä»£å…¥é€‚åº”åº¦å‡½æ•°å¯ä»¥è®¡ç®—å‡ºé€‚åº”åº¦å€¼ï¼Œæ ¹æ®é€‚åº”åº¦å€¼çš„å¤§å°è¡¡é‡ç²’å­çš„ä¼˜åŠ£ã€‚ ç¬¬iä¸ªç²’å­çš„é£è¡Œé€Ÿåº¦ä¹Ÿæ˜¯ä¸€ä¸ªDç»´å‘é‡ï¼Œè®°ä¸º ğ‘£ğ‘–=(ğ‘£ğ‘–1,ğ‘£ğ‘–2,â‹¯ ,ğ‘£ğ‘–ğ·),ğ‘–=1,2,â‹¯ ,ğ‘v**i=(v**i1,v**i2,â‹¯,viD),i=1,2,â‹¯,N ç²’å­çš„ä½ç½®å’Œé€Ÿåº¦å‡å€¼éƒ½åœ¨ç»™å®šçš„èŒƒå›´å†…éšæœºç”Ÿæˆã€‚ ä¸ªä½“å†å²æœ€ä¼˜å€¼å’Œå…¨å±€æœ€ä¼˜å€¼ ç¬¬iä¸ªç²’å­ç»å†è¿‡çš„å…·æœ‰æœ€ä¼˜é€‚åº”åº¦å€¼çš„ä½ç½®ç§°ä¸ºä¸ªä½“å†å²æœ€ä¼˜ä½ç½®ï¼Œè®°ä¸º ğ‘ğ‘ğ‘’ğ‘ ğ‘¡ğ‘–=(ğ‘ğ‘ğ‘’ğ‘ ğ‘¡ğ‘–1,ğ‘ğ‘ğ‘’ğ‘ ğ‘¡ğ‘–2,â‹¯ ,ğ‘ğ‘ğ‘’ğ‘ ğ‘¡ğ‘–ğ·),ğ‘–=1,2,â‹¯ ,ğ‘pbest**i=(pbest**i1,pbest**i2,â‹¯,pbestiD),i=1,2,â‹¯,N æ•´ä¸ªç²’å­ç¾¤ç»å†è¿‡çš„æœ€ä¼˜ä½ç½®ç§°ä¸ºå…¨å±€å†å²æœ€ä¼˜ä½ç½®ï¼Œè®°ä¸º ğ‘”ğ‘ğ‘’ğ‘ ğ‘¡ğ‘–=(ğ‘”ğ‘ğ‘’ğ‘ ğ‘¡ğ‘–1,ğ‘”ğ‘ğ‘’ğ‘ ğ‘¡ğ‘–2,â‹¯ ,ğ‘”ğ‘ğ‘’ğ‘ ğ‘¡ğ‘–ğ·),ğ‘–=1,2,â‹¯ ,ğ‘gbest**i=(gbest**i1,gbest**i2,â‹¯,gbestiD),i=1,2,â‹¯,N ç²’å­ç¾¤çš„é€Ÿåº¦å’Œä½ç½®æ›´æ–° ç²’å­ç¾¤çš„ä½ç½®æ›´æ–°æ“ä½œå¯ç”¨é€Ÿåº¦æ›´æ–°å’Œä½ç½®æ›´æ–°è¡¨ç¤ºã€‚ é€Ÿåº¦æ›´æ–°ä¸º ğ‘£ğ‘–ğ‘—(ğ‘¡+1)=ğ‘£ğ‘–ğ‘—(ğ‘¡)+ğ‘1ğ‘Ÿ1(ğ‘ğ‘ğ‘’ğ‘ ğ‘¡ğ‘–ğ‘—(ğ‘¡)âˆ’ğ‘¥ğ‘–ğ‘—(ğ‘¡))+ğ‘2ğ‘Ÿ2(ğ‘”ğ‘ğ‘’ğ‘ ğ‘¡ğ‘—âˆ’ğ‘¥ğ‘–ğ‘—(ğ‘¡))vij(t+1)=vij(t)+c1r1(pbestij(t)âˆ’xij(t))+c2r2(gbest**jâˆ’xij(t)) ä½ç½®æ›´æ–°ä¸º ğ‘¥ğ‘–ğ‘—(ğ‘¡+1)=ğ‘¥ğ‘–ğ‘—(ğ‘¡)+ğ‘£ğ‘–ğ‘—(ğ‘¡+1)xij(t+1)=xij(t)+vij(t+1) å…¶ä¸­ï¼Œä¸‹æ ‡jè¡¨ç¤ºç²’å­çš„ç¬¬jç»´ï¼Œä¸‹æ ‡iè¡¨ç¤ºç¬¬iä¸ªç²’å­ï¼Œtè¡¨ç¤ºå½“å‰è¿­ä»£æ¬¡æ•°ï¼Œc1ä¸c2å‡åŠ é€Ÿå¸¸é‡ï¼Œé€šå¸¸åœ¨åŒºé—´(0,2)å†…å–å€¼ï¼Œr1ä¸r2ä¸ºä¸¤ä¸ªç›¸äº’ç‹¬ç«‹çš„å–å€¼èŒƒå›´åœ¨[0,1]çš„éšæœºæ•°ã€‚ä»ä¸Šè¿°æ–¹ç¨‹å¯ä»¥çœ‹å‡ºï¼Œc1ä¸c2å°†ç²’å­å‘ä¸ªä½“å­¦ä¹ å’Œå‘ç¾¤ä½“å­¦ä¹ è”åˆèµ·æ¥ï¼Œä½¿å¾—ç²’å­èƒ½å¤Ÿå€Ÿé‰´ä½“è‡ªèº«çš„æœç´¢ç»éªŒå’Œç¾¤ä½“çš„æœç´¢ç»éªŒã€‚ ç²’å­ç¾¤ä¼˜åŒ–ç®—æ³•æ­¥éª¤ æ­¥éª¤1:åˆå§‹åŒ–ç²’å­ç¾¤å‚æ•°c1ä¸c2ï¼Œè®¾ç½®ä½ç½®è¾¹ç•ŒèŒƒå›´ä¸é€Ÿåº¦è¾¹ç•ŒèŒƒå›´ï¼Œåˆå§‹åŒ–ç²’å­ç¾¤ç¾¤ï¼Œåˆå§‹åŒ–ç²’å­ç¾¤é€Ÿåº¦ã€‚ æ­¥éª¤2:æ ¹æ®é€‚åº”åº¦å‡½æ•°è®¡ç®—é€‚åº”åº¦å€¼ï¼Œè®°å½•å†å²æœ€ä¼˜å€¼p_{best}ä¸å…¨å±€æœ€ä¼˜å€¼g_{best}ã€‚ æ­¥éª¤3:åˆ©ç”¨é€Ÿåº¦æ›´æ–°å…¬å¼ğ‘£ğ‘–ğ‘—(ğ‘¡+1)=ğ‘£ğ‘–ğ‘—(ğ‘¡)+ğ‘1ğ‘Ÿ1(ğ‘ğ‘ğ‘’ğ‘ ğ‘¡ğ‘–ğ‘—(ğ‘¡)âˆ’ğ‘¥ğ‘–ğ‘—(ğ‘¡))+ğ‘2ğ‘Ÿ2(ğ‘”ğ‘ğ‘’ğ‘ ğ‘¡ğ‘—âˆ’ğ‘¥ğ‘–ğ‘—(ğ‘¡))vij(t+1)=vij(t)+c1r1(pbestij(t)âˆ’xij(t))+c2r2(gbest**jâˆ’xij(t))å¯¹ç²’å­ç¾¤çš„é€Ÿåº¦è¿›è¡Œæ›´æ–°ï¼Œå¹¶å¯¹è¶Šç•Œçš„é€Ÿåº¦è¿›è¡Œçº¦æŸã€‚ æ­¥éª¤4:åˆ©ç”¨ä½ç½®æ›´æ–°å…¬å¼ğ‘¥ğ‘–ğ‘—(ğ‘¡+1)=ğ‘¥ğ‘–ğ‘—(ğ‘¡)+ğ‘£ğ‘–ğ‘—(ğ‘¡+1)xij(t+1)=xij(t)+vij(t+1)å¯¹ç²’å­ç¾¤çš„ä½ç½®è¿›è¡Œæ›´æ–°ï¼Œå¹¶å¯¹è¶Šç•Œçš„ä½ç½®è¿›è¡Œçº¦æŸã€‚ æ­¥éª¤5:æ ¹æ®é€‚åº”åº¦å‡½æ•°è®¡ç®—é€‚åº”åº¦å€¼ã€‚ æ­¥éª¤6:å¯¹äºæ¯ä¸ªç²’å­ï¼Œå°†å…¶é€‚åº”åº¦å€¼ä¸å®ƒçš„å†å²æœ€ä¼˜é€‚åº”åº¦å€¼ç›¸æ¯”è¾ƒï¼Œè‹¥æ›´å¥½ï¼Œåˆ™å°†ä½œä¸ºå†å²æœ€ä¼˜å€¼ğ‘ğ‘ğ‘’ğ‘ ğ‘¡pbestã€‚ æ­¥éª¤7:å¯¹äºæ¯ä¸ªç²’å­ï¼Œæ¯”è¾ƒå…¶é€‚åº”åº¦å€¼å’Œç¾¤ä½“æ‰€ç»å†çš„æœ€ä¼˜ä½ç½®çš„é€‚åº”åº¦å€¼ï¼Œè‹¥æ›´å¥½ï¼Œå°†å…¶ä½œä¸ºå…¨å±€æœ€ä¼˜å€¼ ğ‘ğ‘ğ‘’ğ‘ ğ‘¡pbest æ­¥éª¤8:åˆ¤æ–­æ˜¯å¦è¾¾åˆ°ç»“æŸæ¡ä»¶ï¼ˆè¾¾åˆ°æœ€å¤§è¾¾ä»£æ¬¡æ•°ï¼‰,è‹¥è¾¾åˆ°ï¼Œåˆ™è¾“å‡ºæœ€ä¼˜ä½ç½®ï¼Œå¦åˆ™å¤æ­¥éª¤3~8ã€‚ ç²’å­ç¾¤ä¼˜åŒ–ç®—æ³•å®ä¾‹ #--------------ç²’å­ç¾¤å‡½æ•°----------------------# # è¾“å…¥ï¼š # pop:ç§ç¾¤æ•°é‡ # dim:å•ä¸ªç²’å­çš„ç»´åº¦ # ub:ç²’å­ä¸Šè¾¹ç•Œä¿¡æ¯ï¼Œç»´åº¦ä¸º[1,dim]; # lb:ç²’å­ä¸‹è¾¹ç•Œä¿¡æ¯ï¼Œç»´åº¦ä¸º[1,dim]; # fobj:ä¸ºé€‚åº”åº¦å‡½æ•°æ¥å£ # vmax: ä¸ºé€Ÿåº¦çš„ä¸Šè¾¹ç•Œä¿¡æ¯ï¼Œç»´åº¦ä¸º[1,dim]; # vmin: ä¸ºé€Ÿåº¦çš„ä¸‹è¾¹ç•Œä¿¡æ¯ï¼Œç»´åº¦ä¸º[1,dim]; # maxIter: ç®—æ³•çš„æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼Œç”¨äºæ§åˆ¶ç®—æ³•çš„åœæ­¢ã€‚ # è¾“å‡ºï¼š # Best_Posï¼šä¸ºç²’å­ç¾¤æ‰¾åˆ°çš„æœ€ä¼˜ä½ç½® # Best_fitness: æœ€ä¼˜ä½ç½®å¯¹åº”çš„é€‚åº”åº¦å€¼ # IterCure: ç”¨äºè®°å½•æ¯æ¬¡è¿­ä»£çš„æœ€ä½³é€‚åº”åº¦ï¼Œå³åç»­ç”¨æ¥ç»˜åˆ¶è¿­ä»£æ›²çº¿ã€‚ function [Best_Pos,Best_fitness,IterCurve] = pso(pop,dim,ub,lb,fobj,vmax,vmin,maxIter) #è®¾ç½®c1,c2å‚æ•° c1 = 2.0; c2 = 2.0; # åˆå§‹åŒ–ç§ç¾¤é€Ÿåº¦ V = initialization(pop,vmax,vmin,dim); # åˆå§‹åŒ–ç§ç¾¤ä½ç½® X = initialization(pop,ub,lb,dim); # è®¡ç®—é€‚åº”åº¦å€¼ fitness = zeros(1,pop); for i = 1:pop fitness(i) = fobj(X(i,:)); end # å°†åˆå§‹ç§ç¾¤ä½œä¸ºå†å²æœ€ä¼˜ pBest = X; pBestFitness = fitness; # è®°å½•åˆå§‹å…¨å±€æœ€ä¼˜è§£,é»˜è®¤ä¼˜åŒ–æœ€å°å€¼ã€‚ #å¯»æ‰¾é€‚åº”åº¦æœ€å°çš„ä½ç½® [~,index] = min(fitness); #è®°å½•é€‚åº”åº¦å€¼å’Œä½ç½® gBestFitness = fitness(index); gBest = X(index,:); Xnew = X; #æ–°ä½ç½® fitnessNew = fitness;#æ–°ä½ç½®é€‚åº”åº¦å€¼ IterCurve = zeros(1,maxIter); # å¼€å§‹è¿­ä»£ for t = 1:maxIter #å¯¹æ¯ä¸ªç²’å­è¿›è¡Œæ›´æ–° for i = 1:pop #é€Ÿåº¦æ›´æ–° r1 = rand(1,dim); r2 = rand(1,dim); V(i,:) = V(i,:) + c1.*r1.*(pBest(i,:) - X(i,:)) + c2.*r2.*(gBest - X(i,:)); #é€Ÿåº¦è¾¹ç•Œæ£€æŸ¥åŠçº¦æŸ V(i,:) = BoundaryCheck(V(i,:),vmax,vmin,dim); #ä½ç½®æ›´æ–° Xnew(i,:) = X(i,:) + V(i,:); #ä½ç½®è¾¹ç•Œæ£€æŸ¥åŠçº¦æŸ Xnew(i,:) = BoundaryCheck(Xnew(i,:),ub,lb,dim); #è®¡ç®—æ–°ä½ç½®é€‚åº”åº¦å€¼ fitnessNew(i) = fobj(Xnew(i,:)); #æ›´æ–°å†å²æœ€ä¼˜å€¼ if fitnessNew(i) &lt; pBestFitness(i) pBest(i,:) = Xnew(i,:); pBestFitness(i) = fitnessNew(i); end #æ›´æ–°å…¨å±€æœ€ä¼˜å€¼ if fitnessNew(i)&lt;gBestFitness gBestFitness = fitnessNew(i); gBest = Xnew(i,:); end end X = Xnew; fitness = fitnessNew; # è®°å½•å½“å‰è¿­ä»£æœ€ä¼˜å€¼å’Œæœ€ä¼˜é€‚åº”åº¦å€¼ #è®°å½•æœ€ä¼˜è§£ Best_Pos = gBest; #è®°å½•æœ€ä¼˜è§£çš„é€‚åº”åº¦å€¼ Best_fitness = gBestFitness; #è®°å½•å½“å‰è¿­ä»£çš„æœ€ä¼˜è§£é€‚åº”åº¦å€¼ IterCurve(t) = gBestFitness; end end ","link":"https://tianxiawuhao.github.io/urP3v4MnQ/"},{"title":"æ•°å­—å­ªç”Ÿäº”ç»´æ¨¡å‹å’Œå…­çº§æˆç†Ÿåº¦","content":"ä¸€ã€ä»€ä¹ˆæ˜¯æ•°å­—å­ªç”Ÿï¼Ÿ ç®€å•æ¥è¯´ï¼Œæ•°å­—å­ªç”Ÿå°±æ˜¯é€šè¿‡3Dæµ‹ç»˜ã€å‡ ä½•å»ºæ¨¡ã€æµç¨‹å»ºæ¨¡ç­‰å»ºæ¨¡æŠ€æœ¯ï¼Œå®Œæˆç‰©ç†å¯¹è±¡çš„æ•°å­—åŒ–ï¼Œæ„å»ºå‡ºç›¸åº”çš„æœºç†æ¨¡å‹ã€‚ å…¶ä¸­ï¼Œå»ºæ¨¡æŠ€æœ¯æ˜¯ç”¨å‡ ä½•æ¦‚å¿µæè¿°å¯¹è±¡çš„ç‰©ç†å½¢çŠ¶ï¼Œèƒ½å¤Ÿå°†ç‰©ç†å¯¹è±¡çš„å®ä½“å½¢çŠ¶æ˜ å°„åˆ°è™šæ‹Ÿç©ºé—´ï¼Œå¹¶é…åˆæ¸²æŸ“ç­‰å®ç°æ›´å¥½çš„å±•ç¤ºå’Œäº¤äº’; æœºç†æ¨¡å‹æ ¹æ®å¯¹è±¡å†…éƒ¨æœºåˆ¶æˆ–è€…ç‰©è´¨æµçš„ä¼ é€’æœºç†å»ºç«‹ç²¾ç¡®æ¨¡å‹ï¼Œä¸»è¦æ˜¯å·²çŸ¥ç‰©ç†è§„å¾‹å’Œç»éªŒçš„è¡¨å¾ã€‚ äºŒã€æ•°å­—å­ªç”Ÿçš„äº”ç»´æ¨¡å‹ æ•°å­—å­ªç”Ÿçš„é¦–è¦ä»»åŠ¡æ˜¯åˆ›å»ºåº”ç”¨å¯¹è±¡çš„æ•°å­—å­ªç”Ÿæ¨¡å‹ã€‚Grievesæ•™æˆæœ€åˆå®šä¹‰äº†æ•°å­—å­ªç”Ÿä¸‰ç»´æ¨¡å‹ï¼Œå³ç‰©ç†å®ä½“ã€è™šæ‹Ÿå®ä½“åŠäºŒè€…é—´çš„è¿æ¥ã€‚åŒ—äº¬èˆªç©ºèˆªå¤©å¤§å­¦æ•°å­—å­ªç”ŸæŠ€æœ¯ç ”ç©¶æ‰€åœ¨æ•°å­—å­ªç”Ÿä¸‰ç»´æ¨¡å‹çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†å­ªç”Ÿæ•°æ®å’ŒæœåŠ¡ä¸¤ä¸ªæ–°ç»´åº¦ï¼Œä½¿æ•°æ®å­ªç”Ÿå¯ä»¥è¿›ä¸€æ­¥åœ¨æ›´å¤šé¢†åŸŸè½åœ°åº”ç”¨ã€‚ è€Œè¿™å°±æ˜¯æ•°å­—å­ªç”Ÿçš„äº”ç»´æ¨¡å‹MDT=(PE,VE,Ss,DD,CN)ã€‚ Â· ç‰©ç†å®ä½“(PE) ç‰©ç†å®ä½“æ˜¯æ•°å­—å­ªç”Ÿäº”ç»´æ¨¡å‹çš„åŸºç¡€ï¼Œä¸»è¦åŒ…æ‹¬å„å­ç³»ç»Ÿå…·å¤‡ä¸åŒçš„åŠŸèƒ½ï¼Œå…±åŒæ”¯æŒè®¾å¤‡çš„è¿è¡Œä»¥åŠä¼ æ„Ÿå™¨é‡‡é›†è®¾å¤‡å’Œç¯å¢ƒæ•°æ®ã€‚å¯¹ç‰©ç†å®ä½“çš„å‡†ç¡®åˆ†æä¸æœ‰æ•ˆç»´æŠ¤æ˜¯å»ºç«‹æ•°å­—å­ªç”Ÿæ¨¡å‹çš„å‰æã€‚ Â· è™šæ‹Ÿå®ä½“(VE) è™šæ‹Ÿå®ä½“æ¨¡å‹åŒ…æ‹¬å‡ ä½•æ¨¡å‹ã€ç‰©ç†æ¨¡å‹ã€è¡Œä¸ºæ¨¡å‹å’Œè§„åˆ™æ¨¡å‹ï¼Œä»å¤šæ—¶é—´å°ºåº¦ã€å¤šç©ºé—´å°ºåº¦å¯¹ç‰©ç†å®ä¹ è¿›è¡Œæè¿°å’Œåˆ»ç”»ï¼Œå½¢æˆå¯¹ç‰©ç†å®ä½“çš„å®Œæ•´æ˜ å°„ã€‚å¯ä½¿ç”¨VRä¸ARæŠ€æœ¯å®ç°è™šæ‹Ÿå®ä½“ä¸ç‰©ç†å®ä½“è™šå®å åŠ åŠèåˆæ˜¾ç¤º,å¢å¼ºè™šæ‹Ÿå®ä½“çš„æ²‰æµ¸æ€§ã€çœŸå®æ€§åŠäº¤äº’æ€§ã€‚ Â· æœåŠ¡(Ss) æœåŠ¡å¯¹æ•°å­—å­ªç”Ÿåº”ç”¨è¿‡ç¨‹ä¸­é¢å‘ä¸åŒé¢†åŸŸã€ä¸åŒå±‚æ¬¡ç”¨æˆ·ã€ä¸åŒä¸šåŠ¡æ‰€éœ€çš„å„ç±»æ•°æ®ã€æ¨¡å‹ã€ç®—æ³•ã€ä»¿çœŸã€ç»“æœç­‰è¿›è¡ŒæœåŠ¡åŒ–å°è£…ï¼Œå¹¶ä»¥åº”ç”¨è½¯ä»¶æˆ–ç§»åŠ¨ç«¯Appçš„å½¢å¼æä¾›ç»™ç”¨æˆ·ï¼Œå®ç°å¯¹æœåŠ¡çš„ä¾¿æ·ä¸æŒ‰éœ€ä½¿ç”¨ã€‚ Â· å­ªç”Ÿæ•°æ®(DD) å­ªç”Ÿæ•°æ®æ˜¯æ•°å­—å­ªç”Ÿçš„é©±åŠ¨ï¼Œé›†æˆèåˆäº†ä¿¡æ¯æ•°æ®ä¸ç‰©ç†æ•°æ®ï¼Œæ»¡è¶³ä¿¡æ¯ç©ºé—´ä¸ç‰©ç†ç©ºé—´çš„ä¸€è‡´æ€§ä¸åŒæ­¥æ€§éœ€æ±‚ï¼Œèƒ½æä¾›æ›´åŠ å‡†ç¡®ã€å…¨é¢çš„å…¨è¦ç´ /å…¨æµç¨‹/å…¨ä¸šåŠ¡æ•°æ®æ”¯æŒã€‚ Â· è¿æ¥(CN) è¿æ¥æ¨¡å‹åŒ…æ‹¬è¿æ¥ä½¿ç‰©ç†å®ä½“ã€è™šæ‹Ÿå®ä½“ã€æœåŠ¡åœ¨è¿è¡Œä¸­ä¿æŒäº¤äº’ã€ä¸€è‡´ä¸åŒæ­¥ä»¥åŠè¿æ¥ä½¿ç‰©ç†å®ä½“ã€è™šæ‹Ÿå®ä½“ã€æœåŠ¡äº§ç”Ÿçš„æ•°æ®å®æ—¶å­˜å…¥å­ªç”Ÿæ•°æ®ï¼Œå¹¶ä½¿å­ªç”Ÿæ•°æ®èƒ½å¤Ÿé©±åŠ¨ä¸‰è€…è¿è¡Œã€‚ ä¸‰ã€æ•°å­—å­ªç”Ÿçš„ä¼˜åŠ¿ 1.ä¼˜åŒ–æ€§èƒ½ ï¼šæ•°å­—å­ªç”Ÿæä¾›ç‰©ç†èµ„äº§æˆ–ç³»ç»Ÿçš„æ•´ä½“è§†å›¾ï¼Œä½¿ä¼ä¸šèƒ½å¤Ÿå®æ—¶ç›‘æ§å’Œä¼˜åŒ–å…¶æ€§èƒ½ã€‚é€šè¿‡åˆ†æä»ä¼ æ„Ÿå™¨æ”¶é›†çš„æ•°æ®ï¼Œä¼ä¸šå¯ä»¥è¯†åˆ«æ•ˆç‡ä½ä¸‹çš„æƒ…å†µï¼Œé¢„æµ‹ç»´æŠ¤éœ€æ±‚ï¼Œå¹¶åšå‡ºæ•°æ®é©±åŠ¨çš„å†³ç­–ï¼Œä»¥æé«˜æ•´ä½“è¿è¥æ•ˆç‡ã€‚ 2.å‡å°‘åœæœºæ—¶é—´ ï¼šé€šè¿‡æŒç»­ç›‘æ§ç‰©ç†èµ„äº§æˆ–ç³»ç»Ÿçš„çŠ¶å†µï¼Œæ•°å­—å­ªç”Ÿå¯ä»¥å¸®åŠ©åœ¨æ½œåœ¨é—®é¢˜å‡çº§ä¸ºé‡å¤§é—®é¢˜ä¹‹å‰å‘ç°å®ƒä»¬ã€‚è¿™ä½¿ä¼ä¸šèƒ½å¤Ÿä¸»åŠ¨æ»¡è¶³ç»´æŠ¤éœ€æ±‚ï¼Œæœ€å¤§é™åº¦åœ°å‡å°‘è®¡åˆ’å¤–åœæœºï¼Œå¹¶ç¡®ä¿å¹³ç¨³è¿è¥ã€‚é€šè¿‡é¢„æµ‹å’Œé¢„é˜²æ•…éšœï¼Œä¼ä¸šå¯ä»¥èŠ‚çœæ—¶é—´ã€èµ„æºå’Œæˆæœ¬ã€‚ 3.æé«˜æ•ˆç‡ ï¼šæ•°å­—å­ªç”Ÿå¯ä»¥æ·±å…¥äº†è§£èµ„äº§æˆ–ç³»ç»Ÿçš„åˆ©ç”¨æ–¹å¼ï¼Œä»è€Œå®ç°ä¼˜åŒ–å’Œæ•ˆç‡æé«˜ã€‚é€šè¿‡åˆ†æå®æ—¶æ•°æ®ï¼Œä¼ä¸šå¯ä»¥è¯†åˆ«æ•ˆç‡ä½ä¸‹çš„é¢†åŸŸï¼Œæ¶ˆé™¤ç“¶é¢ˆï¼Œå¹¶æœ€å¤§é™åº¦åœ°æé«˜èµ„æºåˆ©ç”¨ç‡ã€‚è¿™å¯ä»¥æé«˜ç”Ÿäº§åŠ›ã€å‡å°‘æµªè´¹å¹¶æé«˜æ•´ä½“æ•ˆç‡ã€‚ 4.å¢å¼ºå†³ç­–èƒ½åŠ› ï¼šæ•°å­—å­ªç”Ÿä¸ºä¼ä¸šæä¾›äº†å¤§é‡æ•°æ®é©±åŠ¨çš„è§è§£ï¼Œå¯ä»¥ä¸ºå†³ç­–è¿‡ç¨‹æä¾›ä¿¡æ¯ã€‚é€šè¿‡åˆ†æå®æ—¶å’Œå†å²æ•°æ®ï¼Œä¼ä¸šå¯ä»¥æ›´æ·±å…¥åœ°äº†è§£èµ„äº§ç»©æ•ˆã€å®¢æˆ·è¡Œä¸ºå’Œå¸‚åœºè¶‹åŠ¿ã€‚è¿™ä½¿åˆ©ç›Šç›¸å…³è€…èƒ½å¤Ÿåšå‡ºæ˜æ™ºçš„å†³ç­–ã€ä¼˜åŒ–æµç¨‹å¹¶æ¨åŠ¨åˆ›æ–°ã€‚ 5.èŠ‚çœæˆæœ¬ ï¼šæ•°å­—å­ªç”Ÿå¯ä»¥å¸®åŠ©ä¼ä¸šä»¥å¤šç§æ–¹å¼é™ä½æˆæœ¬ã€‚é€šè¿‡ä¼˜åŒ–èµ„äº§æ€§èƒ½ã€æœ€å¤§é™åº¦åœ°å‡å°‘åœæœºæ—¶é—´å¹¶æé«˜æ•ˆç‡ï¼Œä¼ä¸šå¯ä»¥é¿å…ä¸ç»´ä¿®ã€ç»´æŠ¤å’Œä¸­æ–­ç›¸å…³çš„ä¸å¿…è¦è´¹ç”¨ã€‚æ­¤å¤–ï¼Œæ•°å­—å­ªç”Ÿä¸­çš„é¢„æµ‹åˆ†æåŠŸèƒ½ä½¿ä¼ä¸šèƒ½å¤Ÿä¼˜åŒ–èµ„äº§ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œä»è€Œé•¿æœŸèŠ‚çœæˆæœ¬ã€‚ 6.å¢å¼ºå®‰å…¨å’Œé£é™©ç®¡ç† ï¼šæ•°å­—å­ªç”Ÿæä¾›çš„å®æ—¶ç›‘æ§å’Œåˆ†ææœ‰åŠ©äºå¢å¼ºå®‰å…¨å’Œé£é™©ç®¡ç†ã€‚é€šè¿‡æ£€æµ‹å¼‚å¸¸æƒ…å†µå’Œæ½œåœ¨é£é™©ï¼Œä¼ä¸šå¯ä»¥é‡‡å–ä¸»åŠ¨æªæ–½ï¼Œåœ¨å…¶æ„æˆå±é™©ä¹‹å‰ä»¥å‡è½»ã€‚è¿™å¯¹äºåˆ¶é€ ã€åŒ»ç–—ä¿å¥å’Œè¿è¾“ç­‰è¡Œä¸šå°¤å…¶æœ‰åˆ©ï¼Œå› ä¸ºå®‰å…¨å’Œé£é™©ç®¡ç†æ˜¯è¿™äº›è¡Œä¸šçš„å…³é”®å› ç´ ã€‚ å››ã€æ•°å­—å­ªç”Ÿæˆç†Ÿåº¦æ¨¡å‹ ç»Ÿè®¡åˆ†æç°æœ‰æ•°å­—å­ªç”Ÿç›¸å…³ç†è®ºç ”ç©¶å’Œåº”ç”¨å®è·µï¼Œä¾æ®å…¶åŠŸèƒ½å’Œç”¨é€”ä¸»è¦å¯åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š â‘ åŸºäºæ•°å­—å­ªç”Ÿçš„ç‰©ç†å®ä½“è®¾è®¡éªŒè¯ä¸ç­‰æ•ˆåˆ†æï¼› â‘¡åŸºäºæ•°å­—å­ªç”Ÿçš„ç‰©ç†å®ä½“è¿è¡Œè¿‡ç¨‹å¯è§†åŒ–ç›‘æµ‹ï¼› â‘¢åŸºäºæ•°å­—å­ªç”Ÿçš„ç‰©ç†å®ä½“è¿œç¨‹è¿ç»´ç®¡æ§ï¼› â‘£åŸºäºæ•°å­—å­ªç”Ÿçš„è¯Šæ–­ä¸é¢„æµ‹ï¼› â‘¤åŸºäºæ•°å­—å­ªç”Ÿçš„æ™ºèƒ½å†³ç­–å’Œä¼˜åŒ–ï¼› â‘¥åŸºäºæ•°å­—å­ªç”Ÿçš„ç‰©ç†å®ä½“å…¨ç”Ÿå‘½å‘¨æœŸè·Ÿè¸ªã€å›æº¯ä¸ç®¡ç†ã€‚ é€šè¿‡å¯¹ä¸Šè¿°å„ç±»æ•°å­—å­ªç”Ÿç ”ç©¶å’Œåº”ç”¨è¿›è¡Œå…±æ€§åˆ†æå‘ç°ï¼Œç‰©ç†å®ä½“ã€æ•°å­—å­ªç”Ÿæ¨¡å‹å’Œä¸¤è€…é—´çš„è¿æ¥ä¸äº¤äº’ç»„æˆäº†æ•°å­—å­ªç”Ÿçš„â€œæœ€å°æ¦‚å¿µâ€ã€‚ åœ¨æ­¤åŸºç¡€ä¸Šï¼ŒåŸºäºå‰æœŸæå‡ºçš„æ•°å­—å­ªç”Ÿäº”ç»´æ¨¡å‹ ä»ç‰©ç†å®ä½“ï¼ˆPEï¼‰ã€æ•°å­—å­ªç”Ÿæ¨¡å‹ï¼ˆDMï¼‰ã€æ•°å­—å­ªç”Ÿæ•°æ®ï¼ˆDDï¼‰ã€è¿æ¥äº¤äº’ï¼ˆCIï¼‰ã€åŠŸèƒ½æœåŠ¡ï¼ˆFSï¼‰ äº”ä¸ªç»´åº¦å‡ºå‘ï¼Œæ ¹æ®è¿æ¥äº¤äº’æ–¹å¼ä¸è‡ªåŠ¨åŒ–ç¨‹åº¦çš„ä¸åŒï¼Œä»¥æ•°å­—å­ªç”Ÿæ‰€èƒ½æä¾›çš„åŠŸèƒ½æœåŠ¡ä¸ºä¸»çº¿ï¼Œå°†æ•°å­—å­ªç”Ÿåˆ†ä¸ºå…­ä¸ªæˆç†Ÿåº¦ç­‰çº§ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚ å…¶ä¸­ï¼Œç‰©ç†ç©ºé—´ä¸­çš„ç‰©ç†å®ä½“ä¸ä¿¡æ¯ç©ºé—´ä¸­çš„æ•°å­—å­ªç”Ÿæ¨¡å‹é€šè¿‡ä¸¤è€…é—´çš„è¿æ¥è¿›è¡Œäº¤äº’ï¼Œæ•°å­—å­ªç”Ÿæ•°æ®åˆ™è•´å«æ•°å­—å­ªç”Ÿçš„æ‰€æœ‰ä¿¡æ¯ï¼Œè´¯ç©¿å½“å‰-æœªæ¥ã€ç‰©ç†ç©ºé—´-ä¿¡æ¯ç©ºé—´ã€ç‰©ç†å®ä½“-æ•°å­—å­ªç”Ÿæ¨¡å‹-è¿æ¥äº¤äº’-åŠŸèƒ½æœåŠ¡ã€‚ æ•°å­—å­ªç”Ÿæˆç†Ÿåº¦ç­‰çº§ 1.1 é›¶çº§ï¼ˆL0ï¼‰ï¼šä»¥è™šä»¿å® ä»¥è™šä»¿å®æŒ‡åˆ©ç”¨æ•°å­—å­ªç”Ÿæ¨¡å‹å¯¹ç‰©ç†å®ä½“æè¿°å’Œåˆ»ç”»ï¼Œå…·æœ‰è¯¥èƒ½åŠ›çš„æ•°å­—å­ªç”Ÿå¤„äºå…¶æˆç†Ÿåº¦ç­‰çº§çš„ç¬¬é›¶ç­‰çº§ï¼ˆL0ï¼‰ï¼Œæ»¡è¶³æ­¤è¦æ±‚çš„å®è·µå’Œåº”ç”¨å¯å½’å…¥å¹¿ä¹‰æ•°å­—å­ªç”Ÿçš„æ¦‚å¿µèŒƒç•´ã€‚åœ¨è¯¥ç­‰çº§ï¼Œæ•°å­—å­ªç”Ÿæ¨¡å‹ä»å‡ ä½•ã€ç‰©ç†ã€è¡Œä¸ºå’Œè§„åˆ™æŸä¸ªæˆ–å¤šä¸ªç»´åº¦å¯¹ç‰©ç†å®ä½“å•æ–¹é¢æˆ–å¤šæ–¹é¢çš„å±æ€§å’Œç‰¹å¾è¿›è¡Œæè¿°ï¼Œä»è€Œèƒ½å¤Ÿåœ¨ä¸€å®šç¨‹åº¦ä¸Šä»£æ›¿ç‰©ç†å®ä½“è¿›è¡Œä»¿çœŸåˆ†ææˆ–å®éªŒéªŒè¯ï¼Œä½†æ•°å­—å­ªç”Ÿæ¨¡å‹ä¸ç‰©ç†å®ä½“ä¹‹é—´æ— æ³•é€šè¿‡ç›´æ¥çš„æ•°æ®äº¤æ¢å®ç°å®æ—¶äº¤äº’ï¼Œä¸»è¦ä¾èµ–äººçš„ä»‹å…¥å®ç°é—´æ¥çš„è™šå®äº¤äº’ï¼ŒåŒ…æ‹¬å¯¹ç‰©ç†å®ä½“çš„æ§åˆ¶å’Œå¯¹æ•°å­—å­ªç”Ÿæ¨¡å‹çš„æ§åˆ¶ä¸æ›´æ–°ç­‰ã€‚ 1.2 ä¸€çº§ï¼ˆL1ï¼‰ï¼šä»¥è™šæ˜ å® ä»¥è™šæ˜ å®æŒ‡åˆ©ç”¨æ•°å­—å­ªç”Ÿæ¨¡å‹å®æ—¶å¤ç°ç‰©ç†å®ä½“çš„å®æ—¶çŠ¶æ€å’Œå˜åŒ–è¿‡ç¨‹ï¼Œå…·æœ‰è¯¥èƒ½åŠ›çš„æ•°å­—å­ªç”Ÿå¤„äºå…¶æˆç†Ÿåº¦ç­‰çº§çš„ç¬¬ä¸€ç­‰çº§ï¼ˆL1ï¼‰ã€‚åœ¨è¯¥ç­‰çº§ï¼Œæ•°å­—å­ªç”Ÿæ¨¡å‹ç”±çœŸå®ä¸”å…·æœ‰æ—¶æ•ˆæ€§çš„ç‰©ç†å®ä½“ç›¸å…³æ•°æ®é©±åŠ¨è¿è¡Œï¼ŒåŒæ­¥ç›´è§‚å‘ˆç°ä¸ç‰©ç†å®ä½“ç›¸åŒçš„è¿è¡ŒçŠ¶æ€å’Œè¿‡ç¨‹ï¼Œè¾“å‡ºä¸ç‰©ç†å®ä½“è¿è¡Œç›¸åŒçš„ç»“æœï¼Œä»è€Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šçªç ´æ—¶é—´ã€ç©ºé—´å’Œç¯å¢ƒçº¦æŸå¯¹äºç‰©ç†å®ä½“ç›‘æµ‹è¿‡ç¨‹çš„é™åˆ¶ï¼Œä½†å¯¹äºç‰©ç†å®ä½“çš„æ“ä½œå’Œç®¡æ§ä¾æ—§ä¾èµ–ç°åœºäººå‘˜çš„ç›´æ¥ä»‹å…¥ï¼Œä»æ— æ³•å®ç°ç‰©ç†å®ä½“çš„è¿œç¨‹å¯è§†åŒ–æ“æ§ã€‚ 1.3 äºŒçº§ï¼ˆL2ï¼‰ï¼šä»¥è™šæ§å® ä»¥è™šæ§å®æŒ‡åˆ©ç”¨æ•°å­—å­ªç”Ÿæ¨¡å‹é—´æ¥æ§åˆ¶ç‰©ç†å®ä½“çš„è¿è¡Œè¿‡ç¨‹ï¼Œå…·æœ‰è¯¥èƒ½åŠ›çš„æ•°å­—å­ªç”Ÿå¤„äºå…¶æˆç†Ÿåº¦ç­‰çº§çš„ç¬¬äºŒç­‰çº§ï¼ˆL2ï¼‰ã€‚åœ¨è¯¥ç­‰çº§ï¼Œä¿¡æ¯ç©ºé—´ä¸­çš„æ•°å­—å­ªç”Ÿæ¨¡å‹å·²å…·æœ‰ç›¸å¯¹å®Œæ•´çš„è¿åŠ¨å’Œæ§åˆ¶é€»è¾‘ï¼Œèƒ½å¤Ÿæ¥å—è¾“å…¥æŒ‡ä»¤åœ¨ä¿¡æ¯ç©ºé—´ä¸­å®ç°è¾ƒä¸ºå¤æ‚çš„è¿è¡Œè¿‡ç¨‹ã€‚åŒæ—¶ï¼Œåœ¨ä»¥è™šæ˜ å®çš„åŸºç¡€ä¸Šï¼Œå¢é‡å»ºè®¾ç”±æ•°å­—å­ªç”Ÿæ¨¡å‹åˆ°ç‰©ç†å®ä½“çš„æ•°æ®ä¼ è¾“é€šé“ï¼Œå®ç°è™šå®å®æ—¶åŒå‘é—­ç¯äº¤äº’ï¼Œä»è€Œèµ‹äºˆç‰©ç†å®ä½“è¿œç¨‹å¯è§†åŒ–æ“æ§çš„èƒ½åŠ›ï¼Œè¿›ä¸€æ­¥çªç ´ç©ºé—´å’Œç¯å¢ƒçº¦æŸå¯¹äºç‰©ç†å®ä½“æ“æ§çš„é™åˆ¶ã€‚å°½ç®¡è¿™ç§æ§åˆ¶å¹¶ä¸ä¸€å®šæ˜¯æ™ºèƒ½çš„æˆ–ä¼˜åŒ–çš„ï¼Œä½†ä»å¯å¤§å¹…æé«˜ç‰©ç†å®ä½“çš„ç®¡æ§æ•ˆç‡ã€‚ 1.4 ä¸‰çº§ï¼ˆL3ï¼‰ï¼šä»¥è™šé¢„å® ä»¥è™šé¢„å®æŒ‡åˆ©ç”¨æ•°å­—å­ªç”Ÿæ¨¡å‹é¢„æµ‹ç‰©ç†å®ä½“æœªæ¥ä¸€æ®µæ—¶é—´çš„è¿è¡Œè¿‡ç¨‹å’ŒçŠ¶æ€ï¼Œå…·æœ‰è¯¥èƒ½åŠ›çš„æ•°å­—å­ªç”Ÿå¤„äºå…¶æˆç†Ÿåº¦ç­‰çº§çš„ç¬¬ä¸‰ç­‰çº§ï¼ˆL3ï¼‰ã€‚åœ¨è¯¥ç­‰çº§ï¼Œæ•°å­—å­ªç”Ÿæ¨¡å‹èƒ½å¤ŸåŸºäºä¸ç‰©ç†å®ä½“çš„å®æ—¶åŒå‘é—­ç¯äº¤äº’ï¼ŒåŠ¨æ€åæ˜ ç‰©ç†å®ä½“å½“å‰çš„å®é™…çŠ¶æ€ï¼Œå¹¶é€šè¿‡åˆç†åˆ©ç”¨æ•°å­—å­ªç”Ÿæ¨¡å‹æ‰€æè¿°çš„æ˜¾æ€§æœºç†å’Œæ•°å­—å­ªç”Ÿæ•°æ®æ‰€è•´å«çš„éšæ€§è§„å¾‹ï¼Œå®ç°å¯¹ç‰©ç†å®ä½“æœªæ¥è¿è¡Œè¿‡ç¨‹çš„åœ¨çº¿é¢„æ¼”å’Œå¯¹è¿è¡Œç»“æœçš„æ¨æµ‹ï¼Œä»è€Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šå°†æœªçŸ¥è½¬åŒ–ä¸ºé¢„çŸ¥ï¼Œå°†çªå‘å’Œå¶å‘é—®é¢˜è½¬å˜ä¸ºå¸¸è§„é—®é¢˜ã€‚ 1.5 å››çº§ï¼ˆL4ï¼‰ï¼šä»¥è™šä¼˜å® ä»¥è™šä¼˜å®æŒ‡åˆ©ç”¨æ•°å­—å­ªç”Ÿæ¨¡å‹å¯¹ç‰©ç†å®ä½“è¿›è¡Œä¼˜åŒ–ï¼Œå…·æœ‰è¯¥èƒ½åŠ›çš„æ•°å­—å­ªç”Ÿå¤„äºå…¶æˆç†Ÿåº¦ç­‰çº§çš„ç¬¬å››ç­‰çº§ï¼ˆL4ï¼‰ã€‚åœ¨è¯¥ç­‰çº§ï¼Œæ•°å­—å­ªç”Ÿä¸ä»…èƒ½å¤ŸåŸºäºæ•°å­—å­ªç”Ÿæ¨¡å‹å®æ—¶åæ˜ ç‰©ç†å®ä½“çš„è¿è¡ŒçŠ¶æ€ï¼Œç»“åˆæ•°å­—å­ªç”Ÿæ•°æ®é¢„æµ‹ç‰©ç†å®ä½“çš„æœªæ¥å‘å±•ï¼Œè¿˜èƒ½å¤Ÿåœ¨æ­¤åŸºç¡€ä¸Šï¼Œåˆ©ç”¨ç­–ç•¥ã€ç®—æ³•å’Œå‰æœŸç§¯ç´¯æ²‰æ·€çš„çŸ¥è¯†ï¼Œå®ç°å…·æœ‰æ—¶æ•ˆæ€§çš„æ™ºèƒ½å†³ç­–å’Œä¼˜åŒ–ï¼Œå¹¶åŸºäºå®æ—¶äº¤äº’æœºåˆ¶å®ç°å¯¹ç‰©ç†å®ä½“çš„æ™ºèƒ½ç®¡æ§ã€‚ 1.6 äº”çº§ï¼ˆL5ï¼‰ï¼šè™šå®å…±ç”Ÿ è™šå®å…±ç”Ÿä½œä¸ºæ•°å­—å­ªç”Ÿçš„ç†æƒ³ç›®æ ‡ï¼ŒæŒ‡ç‰©ç†å®ä½“å’Œæ•°å­—å­ªç”Ÿæ¨¡å‹åœ¨é•¿æ—¶é—´çš„åŒæ­¥è¿è¡Œï¼Œç”šè‡³æ˜¯åœ¨å…¨ç”Ÿå‘½å‘¨æœŸä¸­é€šè¿‡åŠ¨æ€é‡æ„å®ç°è‡ªä¸»å­ªç”Ÿï¼Œå…·æœ‰è¯¥èƒ½åŠ›çš„æ•°å­—å­ªç”Ÿå¤„äºå…¶æˆç†Ÿåº¦ç­‰çº§çš„ç¬¬äº”ç­‰çº§ï¼ˆL5ï¼‰ã€‚åœ¨è¯¥ç­‰çº§ï¼Œç‰©ç†å®ä½“å’Œæ•°å­—å­ªç”Ÿæ¨¡å‹èƒ½å¤ŸåŸºäºåŒå‘äº¤äº’å®æ—¶æ„ŸçŸ¥å’Œè®¤çŸ¥å¯¹æ–¹çš„æ›´æ–°å†…å®¹ï¼Œå¹¶åŸºäºä¸¤è€…é—´çš„å·®å¼‚ï¼Œåˆ©ç”¨3Dæ‰“å°ã€æœºå™¨äººã€äººå·¥æ™ºèƒ½ç­‰æŠ€æœ¯å®ç°ç‰©ç†å®ä½“å’Œæ•°å­—å­ªç”Ÿæ¨¡å‹çš„è‡ªä¸»æ„å»ºæˆ–åŠ¨æ€é‡æ„ï¼Œä½¿ä¸¤è€…åœ¨é•¿æ—¶é—´çš„è¿è¡Œè¿‡ç¨‹ä¸­ä¿æŒåŠ¨æ€ä¸€è‡´æ€§ï¼Œä»è€Œä¿è¯åŒ…æ‹¬å¯è§†åŒ–ã€é¢„æµ‹ã€å†³ç­–ã€ä¼˜åŒ–ç­‰è¯¸å¤šåŠŸèƒ½æœåŠ¡çš„æœ‰æ•ˆæ€§ï¼Œå®ç°ä½æˆæœ¬ã€é«˜è´¨é‡ã€å¯æŒç»­çš„æ•°å­—å­ªç”Ÿã€‚ ","link":"https://tianxiawuhao.github.io/570IQ4n5A/"},{"title":"BOMå®šä¹‰åŠåˆ†ç±»","content":"BOMç®€è¿° BOMï¼ˆBill of Materialsï¼‰ç‰©æ–™æ¸…å•ï¼Œæ˜¯åœ¨äº§å“è®¾è®¡å’Œç”Ÿäº§è¿‡ç¨‹ä¸­ç”¨æ¥åˆ—å‡ºæ‰€éœ€ç‰©æ–™çš„æ–‡æ¡£ã€‚æ ¹æ®ä¸åŒçš„åˆ†ç±»æ ‡å‡†ï¼ŒBOMå¯ä»¥åˆ†ä¸ºä¸åŒçš„ç±»å‹ï¼Œä»¥ä¸‹æ˜¯å¸¸è§çš„å‡ ç§BOMç±»å‹ï¼š å·¥ç¨‹BOMï¼ˆEBOMï¼‰ï¼šä¹Ÿç§°ä¸ºè®¾è®¡BOMï¼Œæ˜¯äº§å“è®¾è®¡é˜¶æ®µåˆ¶å®šçš„BOMã€‚å®ƒåŒ…å«äº†äº§å“è®¾è®¡æ‰€éœ€çš„æ‰€æœ‰ç‰©æ–™æ¸…å•ï¼ŒåŒ…æ‹¬åŸææ–™ã€é›¶éƒ¨ä»¶ã€å·¥å…·ç­‰ã€‚ åˆ¶é€ BOMï¼ˆMBOMï¼‰ ï¼šä¹Ÿç§°ä¸ºå·¥è‰ºBOMï¼Œæ˜¯åœ¨äº§å“åˆ¶é€ é˜¶æ®µåˆ¶å®šçš„BOMã€‚å®ƒåŒ…å«äº†å…·ä½“çš„åˆ¶é€ ä¿¡æ¯ï¼ŒåŒ…æ‹¬åŠ å·¥é¡ºåºã€ç”Ÿäº§å·¥è‰ºã€æ‰€éœ€æœºå™¨å’Œå·¥å…·ç­‰ã€‚ æœåŠ¡BOMï¼ˆSBOMï¼‰ï¼šä¹Ÿç§°ä¸ºç»´ä¿®BOMï¼Œæ˜¯æŒ‡äº§å“åœ¨å”®åæœåŠ¡é˜¶æ®µæ‰€éœ€çš„ç‰©æ–™æ¸…å•ã€‚å®ƒåŒ…å«äº†ç»´ä¿®å’Œä¿å…»æ‰€éœ€çš„æ‰€æœ‰é›¶éƒ¨ä»¶å’Œå·¥å…·ã€‚ é‡‡è´­BOMï¼ˆPBOMï¼‰ï¼šä¹Ÿç§°ä¸ºé‡‡è´­æ¸…å•ï¼Œæ˜¯æŒ‡ä¼ä¸šåœ¨é‡‡è´­åŸææ–™å’Œé›¶éƒ¨ä»¶æ—¶æ‰€éœ€çš„ç‰©æ–™æ¸…å•ã€‚å®ƒåŒ…å«äº†æ‰€éœ€ç‰©æ–™çš„æ•°é‡ã€ä¾›åº”å•†ã€ä»·æ ¼ç­‰ä¿¡æ¯ã€‚ ä¿®è®¢BOMï¼ˆRBOMï¼‰ï¼šä¹Ÿç§°ä¸ºç‰ˆæœ¬BOMï¼Œæ˜¯æŒ‡åœ¨äº§å“è®¾è®¡æˆ–åˆ¶é€ è¿‡ç¨‹ä¸­è¿›è¡Œä¿®æ”¹æˆ–æ›´æ–°åæ‰€åˆ¶å®šçš„BOMã€‚å®ƒåŒ…å«äº†å¯¹åŸæœ‰BOMçš„ä¿®æ”¹å’Œæ›´æ–°å†…å®¹ã€‚ ä¸€ã€BOMçš„æ¦‚è¿° ï¼ˆä¸€ï¼‰BOMçš„å®šä¹‰ BOMæ˜¯æŒ‡äº§å“ç»“æ„æ¸…å•ï¼Œæ˜¯æè¿°äº§å“ç»„æˆçš„ä¸€ä»½æ¸…å•ã€‚å®ƒåŒ…å«äº†äº§å“çš„æ‰€æœ‰éƒ¨ä»¶ã€åŸææ–™ä»¥åŠå…¶å®ƒç›¸å…³ä¿¡æ¯ï¼Œå¦‚ç‰©æ–™ç¼–å·ã€æ•°é‡ã€è§„æ ¼ã€ä¾›åº”å•†ç­‰ã€‚BOMå¯ä»¥æŒ‰å±‚æ¬¡ç»“æ„ç»„ç»‡ï¼Œä»æœ€é¡¶å±‚çš„æ€»è£…äº§å“åˆ°åº•å±‚çš„åŸææ–™ï¼Œæ¸…æ™°åœ°å±•ç¤ºäº†äº§å“çš„ç»„æˆå…³ç³»å’Œç»“æ„ã€‚ BOMçš„ä¸»è¦ç›®æ ‡æ˜¯ä¸ºäº§å“è®¾è®¡ã€åˆ¶é€ å’Œç»´æŠ¤æä¾›å¿…è¦çš„ä¿¡æ¯å’ŒæŒ‡å¯¼ã€‚å®ƒä¸ä»…ä»…æ˜¯ä¸€ä»½ç‰©æ–™æ¸…å•ï¼Œè¿˜æ˜¯ä¸€ä»½åŒ…å«å·¥ç¨‹ã€åˆ¶é€ å’ŒæœåŠ¡ç­‰æ–¹é¢ä¿¡æ¯çš„å®Œæ•´æ–‡æ¡£ã€‚BOMè®°å½•äº†äº§å“çš„æ„æˆå’Œç»„è£…è¿‡ç¨‹ï¼Œç¡®ä¿äº†äº§å“çš„ä¸€è‡´æ€§å’Œå¯è¿½æº¯æ€§ã€‚ BOMçš„æ„æˆè¦ç´ åŒ…æ‹¬ï¼š 1ã€éƒ¨ä»¶ ï¼šæŒ‡äº§å“çš„ç»„æˆéƒ¨åˆ†ï¼Œå¯ä»¥æ˜¯å®ä½“éƒ¨ä»¶ï¼ˆå¦‚èºé’‰ã€ç”µå­å…ƒä»¶ç­‰ï¼‰æˆ–è€…å­è£…é…ä»¶ï¼ˆå¦‚æ¨¡å—ã€ç»„ä»¶ç­‰ï¼‰ã€‚ 2ã€åŸææ–™ ï¼šæŒ‡ç”¨äºåˆ¶é€ éƒ¨ä»¶æˆ–äº§å“çš„ææ–™ï¼Œå¦‚é‡‘å±ã€å¡‘æ–™ã€ç”µå­å…ƒå™¨ä»¶ç­‰ã€‚ 3ã€å·¥åº ï¼šæŒ‡äº§å“åˆ¶é€ è¿‡ç¨‹ä¸­çš„å„ä¸ªç¯èŠ‚å’Œæ­¥éª¤ã€‚ 4ã€ç‰©æ–™å±æ€§ ï¼šæŒ‡æ¯ä¸ªéƒ¨ä»¶æˆ–åŸææ–™çš„è¯¦ç»†å±æ€§ï¼Œå¦‚è§„æ ¼ã€å°ºå¯¸ã€é‡é‡ã€ä¾›åº”å•†ç­‰ã€‚ 5ã€ç‰ˆæœ¬æ§åˆ¶ ï¼šæŒ‡å¯¹BOMè¿›è¡Œç‰ˆæœ¬ç®¡ç†ï¼Œä»¥ç¡®ä¿åœ¨äº§å“å¼€å‘å’Œåˆ¶é€ è¿‡ç¨‹ä¸­çš„æ­£ç¡®æ€§å’Œä¸€è‡´æ€§ã€‚ BOMçš„å®šä¹‰æ˜¯PLMç³»ç»Ÿä¸­BOMç®¡ç†çš„åŸºç¡€ï¼Œå®ƒä¸ºåç»­çš„åˆ†ç±»ã€åˆ›å»ºã€ç»´æŠ¤å’Œç®¡ç†æä¾›äº†ä¾æ®ã€‚ ï¼ˆäºŒï¼‰BOMçš„ä½œç”¨ BOMä½œä¸ºPLMç³»ç»Ÿä¸­çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå…·æœ‰é‡è¦çš„ä½œç”¨å’Œæ„ä¹‰ã€‚ä»¥ä¸‹æ˜¯BOMåœ¨äº§å“ç”Ÿå‘½å‘¨æœŸä¸­çš„ä¸»è¦ä½œç”¨ï¼š 1ã€è®¾è®¡ä¾æ® ï¼šBOMæä¾›äº†äº§å“è®¾è®¡çš„åŸºç¡€ï¼Œå¸®åŠ©è®¾è®¡å¸ˆæ˜ç¡®äº§å“æ‰€éœ€çš„éƒ¨ä»¶å’Œææ–™ã€‚é€šè¿‡BOMçš„å®šä¹‰ï¼Œè®¾è®¡å›¢é˜Ÿå¯ä»¥ç¡®ä¿äº§å“çš„ç»“æ„å’ŒåŠŸèƒ½æ»¡è¶³è®¾è®¡è¦æ±‚ã€‚ 2ã€ç”Ÿäº§è®¡åˆ’ ï¼šBOMæ”¯æŒåˆ¶å®šç”Ÿäº§è®¡åˆ’å’Œç‰©æ–™é‡‡è´­è®¡åˆ’ï¼Œç¡®ä¿æ‰€éœ€ç‰©æ–™çš„åŠæ—¶ä¾›åº”ã€‚BOMä¸­è®°å½•çš„ç‰©æ–™æ•°é‡å’Œè§„æ ¼ä¿¡æ¯å¯ä»¥å¸®åŠ©åˆ¶å®šå‡†ç¡®çš„ç”Ÿäº§å’Œé‡‡è´­è®¡åˆ’ï¼Œæé«˜ç”Ÿäº§æ•ˆç‡å’Œèµ„æºåˆ©ç”¨ç‡ã€‚ 3ã€å·¥è‰ºæŒ‡å¯¼ ï¼šBOMæä¾›äº†åˆ¶é€ å·¥è‰ºçš„æŒ‡å¯¼ï¼Œå¸®åŠ©åˆ¶é€ äººå‘˜äº†è§£äº§å“çš„ç»„è£…å’ŒåŠ å·¥è¿‡ç¨‹ã€‚é€šè¿‡BOMï¼Œåˆ¶é€ äººå‘˜å¯ä»¥äº†è§£æ¯ä¸ªéƒ¨ä»¶çš„ä½ç½®å’Œè¿æ¥æ–¹å¼ï¼Œç¡®ä¿æ­£ç¡®ç»„è£…äº§å“ï¼Œå¹¶ä¸”å¯ä»¥æä¾›å·¥è‰ºå‚æ•°å’Œæ“ä½œæŒ‡å¯¼ï¼Œç¡®ä¿äº§å“çš„è´¨é‡å’Œä¸€è‡´æ€§ã€‚ 4ã€è´¨é‡æ§åˆ¶ ï¼šBOMè®°å½•äº†æ¯ä¸ªéƒ¨ä»¶çš„è§„æ ¼å’Œä¾›åº”å•†ä¿¡æ¯ï¼Œæœ‰åŠ©äºç¡®ä¿äº§å“è´¨é‡çš„ä¸€è‡´æ€§ã€‚é€šè¿‡BOMçš„å®šä¹‰ï¼Œä¼ä¸šå¯ä»¥å»ºç«‹è´¨é‡æ§åˆ¶æ ‡å‡†ï¼Œç¡®ä¿é‡‡è´­åˆ°ç¬¦åˆè¦æ±‚çš„ææ–™å’Œéƒ¨ä»¶ï¼Œä»è€Œæé«˜äº§å“è´¨é‡å’Œå¯é æ€§ã€‚ 5ã€å”®åæœåŠ¡ ï¼šBOMæä¾›äº†äº§å“ç»´æŠ¤å’Œå”®åæœåŠ¡æ‰€éœ€çš„å…³é”®ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¤‡ä»¶æ¸…å•å’Œç»´ä¿®æŒ‡å¯¼ã€‚BOMä¸­è®°å½•çš„éƒ¨ä»¶å’ŒåŸææ–™ä¿¡æ¯å¯ä»¥å¸®åŠ©å”®åæœåŠ¡å›¢é˜Ÿå‡†ç¡®è¯†åˆ«å’Œå®šä½æ•…éšœï¼Œæä¾›å‡†ç¡®çš„ç»´ä¿®æ–¹æ¡ˆå’Œå¤‡ä»¶æ”¯æŒï¼Œä»è€Œæé«˜å®¢æˆ·æ»¡æ„åº¦å’Œäº§å“çš„ä½¿ç”¨å¯¿å‘½ã€‚ ï¼ˆä¸‰ï¼‰BOMçš„ç»„æˆéƒ¨åˆ† BOMç”±å¤šä¸ªç»„æˆéƒ¨åˆ†æ„æˆï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½æ‰¿è½½ç€ç‰¹å®šçš„ä¿¡æ¯ã€‚ä¸»è¦çš„ç»„æˆéƒ¨åˆ†åŒ…æ‹¬ï¼š 1ã€äº§å“ç»“æ„ ï¼šæè¿°äº†äº§å“çš„å±‚æ¬¡ç»“æ„å’Œç»„è£…å…³ç³»ï¼Œä»¥åŠå„ä¸ªéƒ¨ä»¶ä¹‹é—´çš„è¿æ¥å…³ç³»ã€‚äº§å“ç»“æ„å¯ä»¥é€šè¿‡æ ‘çŠ¶å›¾æˆ–å±‚æ¬¡ç»“æ„å›¾æ¥è¡¨ç¤ºï¼Œä»é¡¶å±‚æ€»è£…äº§å“å¼€å§‹ï¼Œé€çº§å±•å¼€åˆ°æœ€åº•å±‚çš„åŸææ–™ã€‚ 2ã€éƒ¨ä»¶ä¿¡æ¯ ï¼šåŒ…æ‹¬éƒ¨ä»¶çš„ç‰©æ–™ç¼–å·ã€åç§°ã€æè¿°ã€è§„æ ¼ã€é‡é‡ã€å°ºå¯¸ç­‰è¯¦ç»†ä¿¡æ¯ã€‚éƒ¨ä»¶ä¿¡æ¯å¯ä»¥å¸®åŠ©è®¾è®¡å¸ˆå’Œåˆ¶é€ äººå‘˜äº†è§£æ¯ä¸ªéƒ¨ä»¶çš„ç‰¹æ€§å’Œä½¿ç”¨è¦æ±‚ã€‚ 3ã€åŸææ–™ä¿¡æ¯ ï¼šè®°å½•äº†äº§å“æ‰€ä½¿ç”¨çš„åŸææ–™çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚ææ–™ç±»å‹ã€ä¾›åº”å•†ã€ä»·æ ¼ç­‰ã€‚åŸææ–™ä¿¡æ¯çš„å‡†ç¡®æ€§å’Œå¯è¿½æº¯æ€§å¯¹äºç¡®ä¿äº§å“è´¨é‡å’Œä¾›åº”é“¾çš„ç¨³å®šæ€§è‡³å…³é‡è¦ã€‚ 4ã€å·¥è‰ºä¿¡æ¯ ï¼šåŒ…æ‹¬äº§å“çš„åˆ¶é€ å·¥è‰ºã€å·¥åºé¡ºåºã€åŠ å·¥è®¾å¤‡å’Œå·¥å…·ç­‰ä¿¡æ¯ã€‚å·¥è‰ºä¿¡æ¯å¯ä»¥å¸®åŠ©åˆ¶é€ äººå‘˜äº†è§£äº§å“çš„åŠ å·¥è¦æ±‚å’Œæµç¨‹ï¼Œç¡®ä¿äº§å“çš„ä¸€è‡´æ€§å’Œå¯é‡å¤æ€§ã€‚ 5ã€ç‰©æ–™å…³ç³» ï¼šæè¿°äº†ä¸åŒéƒ¨ä»¶ä¹‹é—´çš„ç‰©æ–™å…³ç³»ï¼Œå¦‚è£…é…å…³ç³»ã€è¿æ¥æ–¹å¼ã€æ›¿ä»£å…³ç³»ç­‰ã€‚ç‰©æ–™å…³ç³»çš„å‡†ç¡®æè¿°å¯ä»¥å¸®åŠ©ä¼ä¸šä¼˜åŒ–ç‰©æ–™é‡‡è´­å’Œåº“å­˜ç®¡ç†ï¼Œæé«˜ä¾›åº”é“¾çš„æ•ˆç‡å’Œçµæ´»æ€§ã€‚ 6ã€ç‰ˆæœ¬æ§åˆ¶ ï¼šå¯¹BOMè¿›è¡Œç‰ˆæœ¬ç®¡ç†ï¼Œä»¥ç¡®ä¿åœ¨äº§å“å¼€å‘å’Œåˆ¶é€ è¿‡ç¨‹ä¸­çš„æ­£ç¡®æ€§å’Œä¸€è‡´æ€§ã€‚ç‰ˆæœ¬æ§åˆ¶å¯ä»¥å¸®åŠ©ä¼ä¸šè¿½è¸ªå’Œç®¡ç†BOMçš„å˜æ›´ï¼Œç¡®ä¿æ‰€æœ‰ç›¸å…³å›¢é˜Ÿä½¿ç”¨çš„æ˜¯æœ€æ–°çš„BOMç‰ˆæœ¬ï¼Œé¿å…å› ä¸ºç‰ˆæœ¬ä¸ä¸€è‡´è€Œå¼•å‘çš„é—®é¢˜ã€‚ äºŒã€BOMçš„åˆ†ç±» ï¼ˆä¸€ï¼‰æ ¹æ®äº§å“å±‚çº§ åœ¨PLMç³»ç»Ÿä¸­ï¼ŒBOMå¯ä»¥æ ¹æ®äº§å“çš„å±‚çº§è¿›è¡Œåˆ†ç±»ã€‚äº§å“çš„å±‚çº§ç»“æ„æ˜¯æŒ‡äº§å“çš„ç»„æˆå…³ç³»å’Œç»„è£…æ–¹å¼ï¼Œé€šè¿‡å°†äº§å“åˆ’åˆ†ä¸ºä¸åŒçš„å±‚æ¬¡ï¼Œå¯ä»¥æ¸…æ™°åœ°æè¿°äº§å“çš„ç»„æˆå…³ç³»å’Œç»“æ„ã€‚ä¸‹é¢æ˜¯æ ¹æ®äº§å“å±‚çº§è¿›è¡Œçš„BOMåˆ†ç±»ï¼š 1ã€æ€»è£…BOMï¼ˆTop-Level BOMï¼‰ æ€»è£…BOMæ˜¯äº§å“çš„æœ€é«˜å±‚çº§ï¼Œæè¿°äº†æ•´ä¸ªäº§å“çš„ç»„è£…ç»“æ„å’Œç»„æˆå…³ç³»ã€‚å®ƒåŒ…æ‹¬æœ€ç»ˆäº¤ä»˜ç»™å®¢æˆ·çš„æˆå“æˆ–æ€»è£…äº§å“çš„æ‰€æœ‰éƒ¨ä»¶å’Œå­è£…é…ä»¶ã€‚æ€»è£…BOMé€šå¸¸ç”±äº§å“è®¾è®¡å›¢é˜Ÿåˆ›å»ºï¼Œç”¨äºæŒ‡å¯¼äº§å“çš„æ€»è£…è¿‡ç¨‹ã€‚ 2ã€å­è£…é…BOMï¼ˆSub-assembly BOMï¼‰ å­è£…é…BOMæè¿°äº†äº§å“ä¸­çš„å­è£…é…ä»¶çš„ç»„è£…ç»“æ„å’Œç»„æˆå…³ç³»ã€‚å­è£…é…ä»¶æ˜¯æ€»è£…BOMä¸­çš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†ï¼Œå¯ä»¥è¿›ä¸€æ­¥åˆ†è§£ä¸ºæ›´å°çš„ç»„ä»¶å’Œéƒ¨ä»¶ã€‚å­è£…é…BOMå¯ä»¥ç”±äº§å“è®¾è®¡å›¢é˜Ÿæˆ–åˆ¶é€ å›¢é˜Ÿåˆ›å»ºï¼Œç”¨äºæŒ‡å¯¼å­è£…é…ä»¶çš„åˆ¶é€ å’Œç»„è£…è¿‡ç¨‹ã€‚ 3ã€éƒ¨ä»¶BOMï¼ˆComponent BOMï¼‰ éƒ¨ä»¶BOMæè¿°äº†äº§å“ä¸­çš„å„ä¸ªéƒ¨ä»¶çš„ç»„æˆå…³ç³»å’Œè¯¦ç»†ä¿¡æ¯ã€‚éƒ¨ä»¶æ˜¯äº§å“çš„æœ€åŸºæœ¬çš„ç»„æˆå•ä½ï¼Œå¯ä»¥æ˜¯å®ä½“éƒ¨ä»¶ï¼ˆå¦‚èºé’‰ã€ç”µå­å…ƒä»¶ç­‰ï¼‰æˆ–è€…è™šæ‹Ÿéƒ¨ä»¶ï¼ˆå¦‚æ ‡ç­¾ã€åŒ…è£…ææ–™ç­‰ï¼‰ã€‚éƒ¨ä»¶BOMç”±ä¾›åº”é“¾å›¢é˜Ÿæˆ–é‡‡è´­å›¢é˜Ÿåˆ›å»ºï¼Œç”¨äºæŒ‡å¯¼ç‰©æ–™é‡‡è´­å’Œä¾›åº”é“¾ç®¡ç†ã€‚ 4ã€åŸææ–™BOMï¼ˆMaterial BOMï¼‰ åŸææ–™BOMæè¿°äº†äº§å“ä¸­æ‰€ä½¿ç”¨çš„åŸææ–™çš„è¯¦ç»†ä¿¡æ¯å’Œç»„æˆå…³ç³»ã€‚åŸææ–™æ˜¯åˆ¶é€ äº§å“æ‰€éœ€çš„ææ–™ï¼Œå¦‚é‡‘å±ã€å¡‘æ–™ã€ç”µå­å…ƒå™¨ä»¶ç­‰ã€‚åŸææ–™BOMé€šå¸¸ç”±é‡‡è´­å›¢é˜Ÿæˆ–ä¾›åº”é“¾å›¢é˜Ÿåˆ›å»ºï¼Œç”¨äºæŒ‡å¯¼åŸææ–™çš„é‡‡è´­å’Œåº“å­˜ç®¡ç†ã€‚ é€šè¿‡æ ¹æ®äº§å“å±‚çº§è¿›è¡ŒBOMçš„åˆ†ç±»ï¼Œä¼ä¸šå¯ä»¥æ¸…æ™°åœ°äº†è§£äº§å“çš„ç»„æˆå…³ç³»ï¼Œä»æ€»è£…åˆ°å­è£…é…ä»¶å†åˆ°éƒ¨ä»¶å’ŒåŸææ–™ï¼Œé€çº§å±•å¼€ã€‚è¿™ç§åˆ†ç±»æ–¹å¼ä½¿å¾—ä¼ä¸šèƒ½å¤Ÿæ›´å¥½åœ°ç®¡ç†äº§å“çš„è®¾è®¡ã€åˆ¶é€ å’Œä¾›åº”é“¾ï¼Œç¡®ä¿äº§å“çš„ä¸€è‡´æ€§å’Œè´¨é‡ã€‚ ï¼ˆäºŒï¼‰æ ¹æ®ç»„æˆä»¶ç±»å‹ åœ¨PLMç³»ç»Ÿä¸­ï¼ŒBOMå¯ä»¥æ ¹æ®ç»„æˆä»¶çš„ç±»å‹è¿›è¡Œåˆ†ç±»ã€‚ç»„æˆä»¶æ˜¯æŒ‡æ„æˆäº§å“çš„å„ä¸ªéƒ¨ä»¶ã€åŸææ–™å’Œå­è£…é…ä»¶ï¼Œæ ¹æ®ç»„æˆä»¶çš„ç±»å‹è¿›è¡Œåˆ†ç±»å¯ä»¥æ›´å¥½åœ°ç»„ç»‡å’Œç®¡ç†BOMä¿¡æ¯ã€‚ä¸‹é¢æ˜¯æ ¹æ®ç»„æˆä»¶ç±»å‹è¿›è¡Œçš„BOMåˆ†ç±»ï¼š 1ã€æœºæ¢°BOMï¼ˆMechanical BOMï¼‰ æœºæ¢°BOMä¸»è¦åŒ…æ‹¬äº§å“ä¸­çš„æœºæ¢°éƒ¨ä»¶ï¼Œå¦‚æ¡†æ¶ã€é½¿è½®ã€èºé’‰ã€è½´ç­‰ã€‚è¿™äº›æœºæ¢°éƒ¨ä»¶é€šå¸¸ç”±é‡‘å±æˆ–å¡‘æ–™ç­‰ææ–™åˆ¶æˆï¼Œç”¨äºæ”¯æ’‘ã€è¿æ¥å’Œä¼ è¾“åŠ›é‡ã€‚æœºæ¢°BOMæè¿°äº†æœºæ¢°éƒ¨ä»¶ä¹‹é—´çš„ç»„è£…å…³ç³»å’Œè¿æ¥æ–¹å¼ï¼Œä¸ºäº§å“çš„ç»“æ„å’ŒåŠŸèƒ½æä¾›åŸºç¡€ã€‚ 2ã€ç”µå­BOMï¼ˆElectrical BOMï¼‰ ç”µå­BOMåŒ…æ‹¬äº§å“ä¸­çš„ç”µå­å…ƒä»¶å’Œç”µè·¯æ¿ã€‚è¿™äº›ç”µå­å…ƒä»¶å¯ä»¥æ˜¯ç”µé˜»ã€ç”µå®¹ã€é›†æˆç”µè·¯ç­‰ï¼Œå®ƒä»¬é€šè¿‡ç”µè·¯æ¿ä¸Šçš„å¸ƒå±€å’Œè¿æ¥å½¢æˆç”µè·¯ã€‚ç”µå­BOMè®°å½•äº†ç”µå­å…ƒä»¶çš„è§„æ ¼ã€å‹å·ã€ä½ç½®å’Œè¿æ¥æ–¹å¼ï¼Œç”¨äºæŒ‡å¯¼ç”µè·¯æ¿çš„è®¾è®¡å’Œåˆ¶é€ ã€‚ 3ã€è½¯ä»¶BOMï¼ˆSoftware BOMï¼‰ è½¯ä»¶BOMä¸»è¦åŒ…æ‹¬äº§å“ä¸­çš„è½¯ä»¶æ¨¡å—ã€ç¨‹åºå’Œç®—æ³•ç­‰ã€‚éšç€äº§å“çš„æ™ºèƒ½åŒ–å’Œæ•°å­—åŒ–å‘å±•ï¼Œè½¯ä»¶åœ¨äº§å“ä¸­çš„ä½œç”¨è¶Šæ¥è¶Šé‡è¦ã€‚è½¯ä»¶BOMæè¿°äº†è½¯ä»¶æ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»å’Œç‰ˆæœ¬æ§åˆ¶ï¼Œä¸ºè½¯ä»¶å¼€å‘å’Œé›†æˆæä¾›æŒ‡å¯¼ã€‚ 4ã€åŒ…è£…BOMï¼ˆPackaging BOMï¼‰ åŒ…è£…BOMæè¿°äº†äº§å“çš„åŒ…è£…ææ–™å’ŒåŒ…è£…æ–¹å¼ã€‚åŒ…è£…ææ–™å¯ä»¥æ˜¯çº¸ç›’ã€æ³¡æ²«å¡‘æ–™ã€æ°”æ³¡è†œç­‰ï¼Œç”¨äºä¿æŠ¤å’ŒåŒ…è£…äº§å“ï¼Œç¡®ä¿äº§å“åœ¨è¿è¾“å’Œå‚¨å­˜è¿‡ç¨‹ä¸­çš„å®‰å…¨æ€§å’Œå®Œæ•´æ€§ã€‚åŒ…è£…BOMè®°å½•äº†åŒ…è£…ææ–™çš„è§„æ ¼ã€æ•°é‡å’Œä½¿ç”¨æ–¹å¼ï¼Œä¸ºäº§å“çš„åŒ…è£…å’Œé…é€æä¾›æŒ‡å¯¼ã€‚ 5ã€è¥é”€BOMï¼ˆMarketing BOMï¼‰ è¥é”€BOMåŒ…æ‹¬ä¸äº§å“è¥é”€ç›¸å…³çš„ç»„æˆä»¶ï¼Œå¦‚æ ‡ç­¾ã€è¯´æ˜ä¹¦ã€ä¿ƒé”€ææ–™ç­‰ã€‚è¿™äº›ç»„æˆä»¶ç”¨äºäº§å“çš„å®£ä¼ ã€é”€å”®å’Œå”®åæœåŠ¡ã€‚è¥é”€BOMæè¿°äº†è¿™äº›ç»„æˆä»¶çš„è§„æ ¼ã€è®¾è®¡å’Œä½¿ç”¨æ–¹å¼ï¼Œä¸ºäº§å“çš„è¥é”€æ´»åŠ¨æä¾›æ”¯æŒã€‚ é€šè¿‡æ ¹æ®ç»„æˆä»¶ç±»å‹è¿›è¡ŒBOMçš„åˆ†ç±»ï¼Œä¼ä¸šå¯ä»¥æ›´å¥½åœ°ç®¡ç†äº§å“çš„ä¸åŒæ–¹é¢ï¼Œä»æœºæ¢°ç»“æ„åˆ°ç”µå­å…ƒä»¶ã€è½¯ä»¶æ¨¡å—å’ŒåŒ…è£…ææ–™ï¼Œé€ä¸ªç»„æˆéƒ¨åˆ†è¿›è¡Œç®¡ç†ã€‚è¿™ç§åˆ†ç±»æ–¹å¼ä½¿å¾—ä¼ä¸šèƒ½å¤Ÿæ›´å¥½åœ°æ§åˆ¶å’Œåè°ƒäº§å“çš„å¼€å‘ã€åˆ¶é€ å’Œå¸‚åœºæ¨å¹¿è¿‡ç¨‹ã€‚ ï¼ˆä¸‰ï¼‰æ ¹æ®ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ åœ¨PLMç³»ç»Ÿä¸­ï¼ŒBOMå¯ä»¥æ ¹æ®äº§å“çš„ç”Ÿå‘½å‘¨æœŸé˜¶æ®µè¿›è¡Œåˆ†ç±»ã€‚äº§å“çš„ç”Ÿå‘½å‘¨æœŸåŒ…æ‹¬äº§å“çš„è®¾è®¡ã€å¼€å‘ã€åˆ¶é€ ã€é”€å”®å’Œç»´æŠ¤ç­‰ä¸åŒé˜¶æ®µï¼Œæ ¹æ®ç”Ÿå‘½å‘¨æœŸé˜¶æ®µå¯¹BOMè¿›è¡Œåˆ†ç±»å¯ä»¥æ›´å¥½åœ°ç®¡ç†äº§å“çš„ä¸åŒé˜¶æ®µçš„ä¿¡æ¯å’Œéœ€æ±‚ã€‚ä¸‹é¢æ˜¯æ ¹æ®ç”Ÿå‘½å‘¨æœŸé˜¶æ®µè¿›è¡Œçš„BOMåˆ†ç±»ï¼š 1ã€è®¾è®¡BOMï¼ˆDesign BOMï¼‰ è®¾è®¡BOMæ˜¯äº§å“åœ¨è®¾è®¡é˜¶æ®µçš„BOMï¼Œå®ƒæè¿°äº†äº§å“çš„åˆå§‹è®¾è®¡å’Œæ„æƒ³ã€‚è®¾è®¡BOMä¸»è¦ç”±äº§å“è®¾è®¡å›¢é˜Ÿåˆ›å»ºï¼ŒåŒ…æ‹¬äº§å“çš„æ•´ä½“ç»“æ„ã€éƒ¨ä»¶å’Œå­è£…é…ä»¶çš„è®¾è®¡ã€‚è®¾è®¡BOMé€šå¸¸åŒ…å«è¯¦ç»†çš„éƒ¨ä»¶ä¿¡æ¯ã€å°ºå¯¸è§„æ ¼å’Œææ–™è¦æ±‚ï¼Œä¸ºäº§å“çš„åˆ¶é€ å’Œç»„è£…æä¾›è®¾è®¡ä¾æ®ã€‚ 2ã€å·¥ç¨‹BOMï¼ˆEngineering BOMï¼‰ å·¥ç¨‹BOMæ˜¯äº§å“åœ¨å·¥ç¨‹å¼€å‘é˜¶æ®µçš„BOMï¼Œå®ƒæ˜¯è®¾è®¡BOMçš„è¿›ä¸€æ­¥ç»†åŒ–å’Œå®Œå–„ã€‚å·¥ç¨‹BOMç”±å·¥ç¨‹å›¢é˜Ÿæ ¹æ®è®¾è®¡BOMè¿›è¡Œè¯¦ç»†å·¥ç¨‹åˆ†æå’Œä¼˜åŒ–ååˆ›å»ºï¼ŒåŒ…æ‹¬æ›´å…·ä½“çš„éƒ¨ä»¶å’Œå­è£…é…ä»¶çš„ä¿¡æ¯ï¼Œå¦‚å…·ä½“çš„ä¾›åº”å•†ã€å·¥è‰ºå‚æ•°ã€æˆæœ¬ç­‰ã€‚å·¥ç¨‹BOMä¸ºäº§å“çš„åˆ¶é€ å’Œä¾›åº”é“¾ç®¡ç†æä¾›æ›´å‡†ç¡®çš„ä¿¡æ¯ã€‚ 3ã€åˆ¶é€ BOMï¼ˆManufacturing BOMï¼‰ åˆ¶é€ BOMæ˜¯äº§å“åœ¨åˆ¶é€ é˜¶æ®µçš„BOMï¼Œå®ƒæè¿°äº†äº§å“çš„åˆ¶é€ è¿‡ç¨‹å’Œæ‰€éœ€çš„éƒ¨ä»¶ã€ææ–™å’Œå·¥è‰ºä¿¡æ¯ã€‚åˆ¶é€ BOMç”±åˆ¶é€ å›¢é˜Ÿæ ¹æ®å·¥ç¨‹BOMè¿›è¡Œåˆ¶é€ å·¥è‰ºè§„åˆ’å’Œå·¥åºåˆ’åˆ†ååˆ›å»ºï¼ŒåŒ…æ‹¬éƒ¨ä»¶çš„è£…é…é¡ºåºã€å·¥è‰ºå‚æ•°ã€å·¥åºè¯´æ˜å’Œè®¾å¤‡è¦æ±‚ç­‰ã€‚åˆ¶é€ BOMä¸ºäº§å“çš„å®é™…åˆ¶é€ æä¾›æŒ‡å¯¼å’Œæ”¯æŒã€‚ 4ã€é”€å”®BOMï¼ˆSales BOMï¼‰ é”€å”®BOMæ˜¯äº§å“åœ¨é”€å”®é˜¶æ®µçš„BOMï¼Œå®ƒæè¿°äº†äº§å“çš„é”€å”®åŒ…è£…å’Œé™„åŠ ç»„æˆéƒ¨åˆ†ã€‚é”€å”®BOMä¸»è¦ç”±é”€å”®å›¢é˜Ÿå’Œå¸‚åœºéƒ¨é—¨åˆ›å»ºï¼ŒåŒ…æ‹¬äº§å“çš„åŒ…è£…ææ–™ã€è¥é”€èµ„æ–™ã€ç”¨æˆ·æ‰‹å†Œç­‰ã€‚é”€å”®BOMä¸ºäº§å“çš„åŒ…è£…å’Œè¥é”€æä¾›æŒ‡å¯¼ï¼Œç¡®ä¿äº§å“åœ¨å¸‚åœºä¸Šçš„å½¢è±¡å’Œç«äº‰åŠ›ã€‚ 5ã€æœåŠ¡BOMï¼ˆService BOMï¼‰ æœåŠ¡BOMæ˜¯äº§å“åœ¨å”®åæœåŠ¡é˜¶æ®µçš„BOMï¼Œå®ƒæè¿°äº†äº§å“çš„ç»´æŠ¤ã€ä¿®ç†å’Œå¤‡ä»¶éœ€æ±‚ã€‚æœåŠ¡BOMä¸»è¦ç”±å”®åæœåŠ¡å›¢é˜Ÿåˆ›å»ºï¼ŒåŒ…æ‹¬äº§å“çš„ç»´ä¿®æŒ‡å¯¼ã€å¤‡ä»¶æ¸…å•å’ŒæœåŠ¡æµç¨‹ç­‰ã€‚æœåŠ¡BOMä¸ºå”®åæœåŠ¡å›¢é˜Ÿæä¾›æŒ‡å¯¼å’Œæ”¯æŒï¼Œç¡®ä¿äº§å“çš„ç»´æŠ¤å’ŒæœåŠ¡è´¨é‡ã€‚ é€šè¿‡æ ¹æ®ç”Ÿå‘½å‘¨æœŸé˜¶æ®µè¿›è¡ŒBOMçš„åˆ†ç±»ï¼Œä¼ä¸šå¯ä»¥æ›´å¥½åœ°ç®¡ç†å’Œè·Ÿè¸ªäº§å“åœ¨ä¸åŒé˜¶æ®µçš„ä¿¡æ¯å’Œéœ€æ±‚ã€‚æ¯ä¸ªé˜¶æ®µçš„BOMéƒ½å…·æœ‰ä¸åŒçš„ç‰¹ç‚¹å’Œé‡è¦æ€§ï¼Œé€šè¿‡æœ‰æ•ˆç®¡ç†ä¸åŒé˜¶æ®µçš„BOMï¼Œä¼ä¸šå¯ä»¥æé«˜äº§å“çš„å¼€å‘æ•ˆç‡ã€è´¨é‡æ§åˆ¶å’Œå¸‚åœºå“åº”èƒ½åŠ›ã€‚ ä¸‰ã€BOMç®¡ç†çš„æŒ‘æˆ˜ ï¼ˆä¸€ï¼‰å¤šå±‚æ¬¡BOMç®¡ç† åœ¨PLMç³»ç»Ÿä¸­ï¼ŒBOMï¼ˆBill of Materialsï¼‰ç®¡ç†æ˜¯ä¸€ä¸ªå…³é”®çš„ä»»åŠ¡ï¼Œç”¨äºè®°å½•å’Œç®¡ç†äº§å“çš„ç»„æˆç»“æ„å’Œç›¸å…³ä¿¡æ¯ã€‚ç„¶è€Œï¼Œéšç€äº§å“çš„å¤æ‚æ€§å’Œå¤šæ ·æ€§å¢åŠ ï¼Œå¤šå±‚æ¬¡BOMç®¡ç†æˆä¸ºäº†ä¸€ä¸ªå…·æœ‰æŒ‘æˆ˜æ€§çš„ä»»åŠ¡ã€‚æœ¬æ–‡å°†æ¢è®¨å¤šå±‚æ¬¡BOMç®¡ç†æ‰€é¢ä¸´çš„æŒ‘æˆ˜ä»¥åŠå¦‚ä½•åº”å¯¹è¿™äº›æŒ‘æˆ˜ã€‚ 1ã€å¤æ‚æ€§ä¸å±‚çº§å…³ç³» ï¼šå½“äº§å“çš„å±‚çº§ç»“æ„å˜å¾—å¤æ‚æ—¶ï¼Œç®¡ç†å¤šå±‚æ¬¡BOMå˜å¾—æ›´åŠ å›°éš¾ã€‚ä¸åŒå±‚çº§ä¹‹é—´å­˜åœ¨ç€å¤æ‚çš„å…³ç³»ï¼Œä¾‹å¦‚æ€»è£…BOMåŒ…å«å­è£…é…BOMï¼Œå­è£…é…BOMåˆåŒ…å«éƒ¨ä»¶BOMï¼Œè€Œæ¯ä¸ªBOMåˆå¯èƒ½åŒ…å«å¤šä¸ªå±‚çº§ã€‚è¿™ç§å¤æ‚æ€§å¢åŠ äº†BOMç®¡ç†çš„éš¾åº¦ï¼Œéœ€è¦å‡†ç¡®åœ°è¯†åˆ«å’Œè·Ÿè¸ªä¸åŒå±‚çº§ä¹‹é—´çš„å…³ç³»ã€‚ 2ã€æ•°æ®ä¸€è‡´æ€§ä¸å‡†ç¡®æ€§ ï¼šåœ¨å¤šå±‚æ¬¡BOMç®¡ç†ä¸­ï¼Œç¡®ä¿BOMæ•°æ®çš„ä¸€è‡´æ€§å’Œå‡†ç¡®æ€§æ˜¯ä¸€ä¸ªæŒ‘æˆ˜ã€‚ä¸åŒå±‚çº§çš„BOMä¹‹é—´å¯èƒ½å­˜åœ¨æ•°æ®çš„é‡å¤ã€é—æ¼æˆ–ä¸ä¸€è‡´ï¼Œè¿™å¯èƒ½å¯¼è‡´ç”Ÿäº§è¿‡ç¨‹ä¸­çš„é”™è¯¯å’Œå»¶è¯¯ã€‚å› æ­¤ï¼Œéœ€è¦å»ºç«‹æœ‰æ•ˆçš„æ•°æ®ç®¡ç†æœºåˆ¶ï¼Œç¡®ä¿BOMæ•°æ®åœ¨ä¸åŒå±‚çº§ä¹‹é—´çš„åŒæ­¥å’Œæ›´æ–°ã€‚ 3ã€ç‰ˆæœ¬æ§åˆ¶ä¸å˜æ›´ç®¡ç† ï¼šäº§å“åœ¨ç”Ÿå‘½å‘¨æœŸä¸­å¯èƒ½ç»å†å¤šæ¬¡è®¾è®¡å˜æ›´å’Œç‰ˆæœ¬æ›´æ–°ï¼Œè€Œè¿™äº›å˜æ›´éœ€è¦åŠæ—¶åæ˜ åœ¨BOMä¸­ã€‚ç„¶è€Œï¼Œåœ¨å¤šå±‚æ¬¡BOMç®¡ç†ä¸­ï¼Œç‰ˆæœ¬æ§åˆ¶å’Œå˜æ›´ç®¡ç†å˜å¾—æ›´åŠ å¤æ‚ã€‚æ¯ä¸ªå±‚çº§çš„BOMéƒ½å¯èƒ½å­˜åœ¨ç‹¬ç«‹çš„å˜æ›´éœ€æ±‚å’Œç‰ˆæœ¬æ§åˆ¶æµç¨‹ï¼Œéœ€è¦ç¡®ä¿å„ä¸ªå±‚çº§ä¹‹é—´çš„å˜æ›´èƒ½å¤Ÿæ­£ç¡®åœ°åæ˜ å’ŒåŒæ­¥ã€‚ 4ã€åä½œä¸æ²Ÿé€š ï¼šå¤šå±‚æ¬¡BOMç®¡ç†æ¶‰åŠå¤šä¸ªå›¢é˜Ÿå’Œéƒ¨é—¨çš„åä½œå’Œæ²Ÿé€šã€‚è®¾è®¡å›¢é˜Ÿã€åˆ¶é€ å›¢é˜Ÿã€ä¾›åº”é“¾å›¢é˜Ÿç­‰éœ€è¦å…±åŒå‚ä¸BOMç®¡ç†ï¼Œä½†ç”±äºå„è‡ªçš„èŒè´£å’Œè§’è‰²ä¸åŒï¼Œåä½œå’Œæ²Ÿé€šå¯èƒ½å­˜åœ¨å›°éš¾ã€‚å› æ­¤ï¼Œå»ºç«‹è‰¯å¥½çš„åä½œæœºåˆ¶å’Œæ²Ÿé€šæ¸ é“æ˜¯è§£å†³å¤šå±‚æ¬¡BOMç®¡ç†æŒ‘æˆ˜çš„å…³é”®ã€‚ ä¸ºäº†åº”å¯¹å¤šå±‚æ¬¡BOMç®¡ç†çš„æŒ‘æˆ˜ï¼Œå¯ä»¥é‡‡å–ä»¥ä¸‹æªæ–½ï¼š 1ã€æ¸…æ™°çš„å±‚çº§ç»“æ„å®šä¹‰ ï¼šç¡®ä¿äº§å“çš„å±‚çº§ç»“æ„å®šä¹‰æ¸…æ™°æ˜ç¡®ï¼Œæ˜ç¡®æ¯ä¸ªå±‚çº§çš„ä½œç”¨å’Œç»„æˆå…³ç³»ï¼Œé¿å…å±‚çº§çš„é‡å å’Œæ¨¡ç³Šã€‚ 2ã€å¼ºåŒ–æ•°æ®ç®¡ç† ï¼šå»ºç«‹å®Œå–„çš„æ•°æ®ç®¡ç†æœºåˆ¶ï¼ŒåŒ…æ‹¬æ•°æ®é‡‡é›†ã€éªŒè¯ã€åŒæ­¥å’Œæ›´æ–°ç­‰ç¯èŠ‚ï¼Œç¡®ä¿BOMæ•°æ®çš„ä¸€è‡´æ€§å’Œå‡†ç¡®æ€§ã€‚ 3ã€å¼•å…¥PLMç³»ç»Ÿ ï¼šPLMç³»ç»Ÿæä¾›äº†ä¸“é—¨çš„BOMç®¡ç†åŠŸèƒ½ï¼Œå¯ä»¥å¸®åŠ©ç»„ç»‡æ›´å¥½åœ°ç®¡ç†å¤šå±‚æ¬¡BOMã€‚é€šè¿‡PLMç³»ç»Ÿï¼Œå¯ä»¥å®ç°BOMçš„ç‰ˆæœ¬æ§åˆ¶ã€å˜æ›´ç®¡ç†å’Œåä½œï¼Œæé«˜BOMç®¡ç†çš„æ•ˆç‡å’Œè´¨é‡ã€‚ 4ã€æ¢³ç†å˜æ›´æµç¨‹ ï¼šå»ºç«‹æ¸…æ™°çš„å˜æ›´æµç¨‹å’Œè§„èŒƒï¼Œç¡®ä¿æ¯ä¸ªå±‚çº§çš„BOMå˜æ›´éƒ½ç»è¿‡é€‚å½“çš„å®¡æ‰¹å’ŒéªŒè¯ï¼Œé¿å…é”™è¯¯çš„å˜æ›´å¯¹äº§å“é€ æˆå½±å“ã€‚ 5ã€åŠ å¼ºå›¢é˜Ÿåä½œ ï¼šé€šè¿‡å®šæœŸçš„æ²Ÿé€šå’Œåä½œä¼šè®®ï¼Œä¿ƒè¿›ä¸åŒå›¢é˜Ÿå’Œéƒ¨é—¨ä¹‹é—´çš„åˆä½œå’Œæ²Ÿé€šï¼Œç¡®ä¿å„ä¸ªå±‚çº§çš„BOMèƒ½å¤Ÿæ­£ç¡®åœ°åæ˜ äº§å“çš„è®¾è®¡å’Œåˆ¶é€ è¦æ±‚ã€‚ å¤šå±‚æ¬¡BOMç®¡ç†æ˜¯PLMç³»ç»Ÿä¸­BOMç®¡ç†çš„é‡è¦æ–¹é¢ï¼Œå®ƒæ¶‰åŠåˆ°äº§å“çš„æ•´ä½“ç»“æ„å’Œç»„æˆå…³ç³»ã€‚é¢å¯¹æŒ‘æˆ˜ï¼Œç»„ç»‡éœ€è¦åŠ å¼ºæ•°æ®ç®¡ç†ã€å¼•å…¥PLMç³»ç»Ÿã€è§„èŒƒå˜æ›´æµç¨‹ä»¥åŠåŠ å¼ºå›¢é˜Ÿåä½œï¼Œä»¥ç¡®ä¿å¤šå±‚æ¬¡BOMçš„å‡†ç¡®æ€§ã€ä¸€è‡´æ€§å’ŒåŠæ—¶æ€§ï¼Œä»è€Œæé«˜äº§å“çš„å¼€å‘å’Œåˆ¶é€ æ•ˆç‡ã€‚ ï¼ˆäºŒï¼‰ç‰©æ–™å˜æ›´æ§åˆ¶ åœ¨PLMç³»ç»Ÿä¸­ï¼ŒBOMï¼ˆBill of Materialsï¼‰ç®¡ç†æ˜¯å…³é”®çš„ä»»åŠ¡ä¹‹ä¸€ï¼Œç”¨äºè®°å½•å’Œç®¡ç†äº§å“çš„ç»„æˆç»“æ„å’Œç›¸å…³ä¿¡æ¯ã€‚ç„¶è€Œï¼Œéšç€äº§å“çš„å¤æ‚æ€§å’Œå¤šæ ·æ€§å¢åŠ ï¼Œç‰©æ–™å˜æ›´æ§åˆ¶æˆä¸ºäº†ä¸€ä¸ªå…·æœ‰æŒ‘æˆ˜æ€§çš„ä»»åŠ¡ã€‚æœ¬æ–‡å°†æ¢è®¨ç‰©æ–™å˜æ›´æ§åˆ¶æ‰€é¢ä¸´çš„æŒ‘æˆ˜ä»¥åŠå¦‚ä½•åº”å¯¹è¿™äº›æŒ‘æˆ˜ã€‚ 1ã€å˜æ›´å¤æ‚æ€§ ï¼šéšç€äº§å“çš„ä¸æ–­æ¼”åŒ–å’Œå¸‚åœºéœ€æ±‚çš„å˜åŒ–ï¼Œç‰©æ–™å˜æ›´å˜å¾—æ›´åŠ å¤æ‚ã€‚ä¸€ä¸ªå°å°çš„ç‰©æ–™å˜æ›´å¯èƒ½ä¼šæ¶‰åŠåˆ°å¤šä¸ªBOMå±‚çº§å’Œä¾›åº”é“¾ç¯èŠ‚çš„è°ƒæ•´ã€‚ä¾‹å¦‚ï¼Œå½“æ›´æ¢ä¸€ä¸ªéƒ¨ä»¶æ—¶ï¼Œéœ€è¦è€ƒè™‘ä¸ä¹‹ç›¸å…³çš„è£…é…å…³ç³»ã€å·¥è‰ºæµç¨‹ã€ä¾›åº”å•†é€‰æ‹©ç­‰å› ç´ ï¼Œè¿™å¢åŠ äº†ç‰©æ–™å˜æ›´çš„å¤æ‚æ€§ã€‚ 2ã€å˜æ›´å½±å“åˆ†æ ï¼šåœ¨è¿›è¡Œç‰©æ–™å˜æ›´ä¹‹å‰ï¼Œéœ€è¦è¿›è¡Œå…¨é¢çš„å˜æ›´å½±å“åˆ†æï¼Œä»¥è¯„ä¼°å˜æ›´å¯¹äº§å“å’Œåˆ¶é€ æµç¨‹çš„å½±å“ã€‚è¿™åŒ…æ‹¬åˆ†æå˜æ›´å¯¹äº§å“åŠŸèƒ½ã€æ€§èƒ½ã€è´¨é‡ã€æˆæœ¬ã€ä¾›åº”é“¾ä»¥åŠç›¸å…³æ–‡æ¡£å’Œæ ‡å‡†çš„å½±å“ã€‚ç¡®ä¿å˜æ›´çš„åˆç†æ€§å’Œå¯è¡Œæ€§æ˜¯ç‰©æ–™å˜æ›´æ§åˆ¶çš„å…³é”®æŒ‘æˆ˜ä¹‹ä¸€ã€‚ 3ã€å˜æ›´å®¡æ‰¹ä¸è¿½è¸ª ï¼šç‰©æ–™å˜æ›´é€šå¸¸éœ€è¦ç»è¿‡ä¸€ç³»åˆ—çš„å®¡æ‰¹å’ŒéªŒè¯æ­¥éª¤ã€‚æ¶‰åŠçš„å„æ–¹åŒ…æ‹¬è®¾è®¡å›¢é˜Ÿã€åˆ¶é€ å›¢é˜Ÿã€ä¾›åº”é“¾å›¢é˜Ÿç­‰ã€‚ç¡®ä¿å˜æ›´çš„å®¡æ‰¹å’Œè¿½è¸ªè¿‡ç¨‹è§„èŒƒã€é€æ˜å’ŒåŠæ—¶ï¼Œæ˜¯ç‰©æ–™å˜æ›´æ§åˆ¶çš„å…³é”®æŒ‘æˆ˜ã€‚è¿½è¸ªå˜æ›´çš„æ‰§è¡Œæƒ…å†µå’Œç»“æœï¼Œç¡®ä¿å˜æ›´çš„é¡ºåˆ©å®æ–½å’ŒéªŒè¯ã€‚ 4ã€å˜æ›´ç®¡ç†ä¸ç‰ˆæœ¬æ§åˆ¶ ï¼šåœ¨è¿›è¡Œç‰©æ–™å˜æ›´æ—¶ï¼Œéœ€è¦å»ºç«‹æœ‰æ•ˆçš„å˜æ›´ç®¡ç†å’Œç‰ˆæœ¬æ§åˆ¶æœºåˆ¶ã€‚è¿™åŒ…æ‹¬è®°å½•å˜æ›´è¯·æ±‚ã€è·Ÿè¸ªå˜æ›´è¿‡ç¨‹ã€åˆ¶å®šå˜æ›´è®¡åˆ’ã€æ‰§è¡Œå˜æ›´æ“ä½œã€éªŒè¯å˜æ›´ç»“æœç­‰ã€‚åŒæ—¶ï¼Œéœ€è¦ç¡®ä¿ä¸åŒç‰ˆæœ¬çš„BOMå’Œç›¸å…³æ–‡æ¡£èƒ½å¤Ÿæ­£ç¡®åœ°å­˜æ¡£å’Œç®¡ç†ï¼Œä»¥ä¾¿æ—¥åè¿½æº¯å’Œå‚è€ƒã€‚ 5ã€ä¾›åº”é“¾ååŒ ï¼šç‰©æ–™å˜æ›´å¾€å¾€æ¶‰åŠåˆ°ä¾›åº”é“¾ä¸­çš„å¤šä¸ªç¯èŠ‚ï¼ŒåŒ…æ‹¬ä¾›åº”å•†ã€åˆä½œä¼™ä¼´å’Œåˆ¶é€ å‚ç­‰ã€‚åè°ƒå’Œæ²Ÿé€šä¸åŒç¯èŠ‚çš„å˜æ›´ä¿¡æ¯å’Œè¦æ±‚ï¼Œç¡®ä¿å˜æ›´åœ¨æ•´ä¸ªä¾›åº”é“¾ä¸­çš„ä¼ é€’å’Œæ‰§è¡Œï¼Œæ˜¯ç‰©æ–™å˜æ›´æ§åˆ¶çš„é‡è¦æŒ‘æˆ˜ä¹‹ä¸€ã€‚ ä¸ºäº†åº”å¯¹ç‰©æ–™å˜æ›´æ§åˆ¶çš„æŒ‘æˆ˜ï¼Œå¯ä»¥é‡‡å–ä»¥ä¸‹æªæ–½ï¼š 1ã€å»ºç«‹è§„èŒƒçš„å˜æ›´æµç¨‹ ï¼šåˆ¶å®šæ˜ç¡®çš„ç‰©æ–™å˜æ›´æµç¨‹ï¼ŒåŒ…æ‹¬å˜æ›´è¯·æ±‚çš„æäº¤ã€å®¡æ‰¹æµç¨‹ã€å˜æ›´æ‰§è¡Œã€éªŒè¯å’Œè¿½è¸ªç­‰ç¯èŠ‚ã€‚ç¡®ä¿å˜æ›´æµç¨‹è§„èŒƒã€é€æ˜å’Œå¯è¿½æº¯ã€‚ 2ã€å¼•å…¥PLMç³»ç»Ÿ ï¼šPLMç³»ç»Ÿæä¾›äº†ä¸“é—¨çš„å˜æ›´ç®¡ç†åŠŸèƒ½ï¼Œå¯ä»¥å¸®åŠ©ç»„ç»‡æ›´å¥½åœ°æ§åˆ¶ç‰©æ–™å˜æ›´ã€‚é€šè¿‡PLMç³»ç»Ÿï¼Œå¯ä»¥è®°å½•å’Œè·Ÿè¸ªå˜æ›´è¯·æ±‚ã€æ‰§è¡Œå˜æ›´æ“ä½œã€è¿½è¸ªå˜æ›´ç»“æœç­‰ã€‚ 3ã€å˜æ›´å½±å“åˆ†æå·¥å…· ï¼šä½¿ç”¨ä¸“é—¨çš„å˜æ›´å½±å“åˆ†æå·¥å…·ï¼Œå¸®åŠ©è¯„ä¼°å˜æ›´å¯¹äº§å“å’Œåˆ¶é€ æµç¨‹çš„å½±å“ã€‚è¿™äº›å·¥å…·å¯ä»¥æ¨¡æ‹Ÿå’Œåˆ†æå˜æ›´çš„å½±å“ï¼Œå¸®åŠ©åšå‡ºæ˜æ™ºçš„å˜æ›´å†³ç­–ã€‚ 4ã€å¼ºåŒ–ä¾›åº”é“¾ååŒ ï¼šåŠ å¼ºä¸ä¾›åº”é“¾ä¸­çš„åˆä½œä¼™ä¼´å’Œä¾›åº”å•†çš„æ²Ÿé€šå’Œåä½œã€‚å»ºç«‹æœ‰æ•ˆçš„æ²Ÿé€šæ¸ é“ï¼ŒåŠæ—¶ä¼ é€’å˜æ›´ä¿¡æ¯å’Œè¦æ±‚ï¼Œç¡®ä¿å˜æ›´åœ¨æ•´ä¸ªä¾›åº”é“¾ä¸­çš„é¡ºåˆ©ä¼ é€’å’Œæ‰§è¡Œã€‚ 5ã€åŸ¹è®­ä¸åŸ¹å…»å›¢é˜Ÿèƒ½åŠ› ï¼šæä¾›ç›¸å…³çš„åŸ¹è®­å’ŒåŸ¹å…»è®¡åˆ’ï¼Œç¡®ä¿å›¢é˜Ÿå…·å¤‡è‰¯å¥½çš„å˜æ›´ç®¡ç†å’Œæ‰§è¡Œèƒ½åŠ›ã€‚åŸ¹å…»å›¢é˜Ÿçš„æ²Ÿé€šã€åè°ƒå’Œåˆ†æèƒ½åŠ›ï¼Œæé«˜ç‰©æ–™å˜æ›´æ§åˆ¶çš„æ•ˆç‡å’Œè´¨é‡ã€‚ ç‰©æ–™å˜æ›´æ§åˆ¶æ˜¯PLMç³»ç»Ÿä¸­BOMç®¡ç†çš„é‡è¦æ–¹é¢ï¼Œå®ƒæ¶‰åŠåˆ°äº§å“çš„ä¸æ–­æ”¹è¿›å’Œæ¼”åŒ–ã€‚é¢å¯¹æŒ‘æˆ˜ï¼Œç»„ç»‡éœ€è¦å»ºç«‹è§„èŒƒçš„å˜æ›´æµç¨‹ã€å¼•å…¥PLMç³»ç»Ÿã€è¿›è¡Œå˜æ›´å½±å“åˆ†æã€åŠ å¼ºä¾›åº”é“¾ååŒï¼Œä»¥åŠåŸ¹å…»å›¢é˜Ÿçš„èƒ½åŠ›ï¼Œä»è€Œæœ‰æ•ˆåœ°æ§åˆ¶ç‰©æ–™å˜æ›´ï¼Œç¡®ä¿äº§å“è´¨é‡å’Œåˆ¶é€ æ•ˆç‡çš„æå‡ã€‚ ï¼ˆä¸‰ï¼‰ç‰©æ–™ç‰ˆæœ¬æ§åˆ¶ åœ¨PLMç³»ç»Ÿä¸­ï¼ŒBOMï¼ˆBill of Materialsï¼‰ç®¡ç†æ˜¯ä¸€ä¸ªå…³é”®çš„ä»»åŠ¡ï¼Œç”¨äºè®°å½•å’Œç®¡ç†äº§å“çš„ç»„æˆç»“æ„å’Œç›¸å…³ä¿¡æ¯ã€‚å…¶ä¸­ä¸€ä¸ªé‡è¦çš„æŒ‘æˆ˜æ˜¯ç‰©æ–™ç‰ˆæœ¬æ§åˆ¶ã€‚æœ¬æ–‡å°†æ¢è®¨ç‰©æ–™ç‰ˆæœ¬æ§åˆ¶æ‰€é¢ä¸´çš„æŒ‘æˆ˜ä»¥åŠå¦‚ä½•åº”å¯¹è¿™äº›æŒ‘æˆ˜ã€‚ 1ã€ç‰©æ–™ä¿¡æ¯çš„å¤æ‚æ€§ ï¼šéšç€äº§å“çš„ä¸æ–­æ¼”è¿›å’Œä¾›åº”é“¾çš„å˜åŒ–ï¼Œç‰©æ–™çš„ä¿¡æ¯ä¹Ÿä¼šéšä¹‹å˜å¾—å¤æ‚ã€‚ä¸€ä¸ªç‰©æ–™å¯èƒ½å­˜åœ¨å¤šä¸ªç‰ˆæœ¬ï¼Œæ¯ä¸ªç‰ˆæœ¬å¯èƒ½åŒ…å«ä¸åŒçš„å±æ€§ã€ç‰¹æ€§å’Œä¾›åº”å•†ä¿¡æ¯ã€‚åŒæ—¶ï¼Œè¿˜éœ€è¦è€ƒè™‘ç‰©æ–™çš„æ›¿ä»£æ€§å’Œå…¼å®¹æ€§ã€‚å› æ­¤ï¼Œç®¡ç†å’Œè·Ÿè¸ªç‰©æ–™ç‰ˆæœ¬çš„æ­£ç¡®æ€§å’Œå®Œæ•´æ€§æ˜¯ä¸€ä¸ªæŒ‘æˆ˜ã€‚ 2ã€ç‰©æ–™å˜æ›´çš„é¢‘ç¹æ€§ ï¼šåœ¨äº§å“å¼€å‘å’Œåˆ¶é€ è¿‡ç¨‹ä¸­ï¼Œç‰©æ–™å˜æ›´æ˜¯ä¸å¯é¿å…çš„ã€‚ä¾›åº”å•†å˜æ›´ã€è§„æ ¼è°ƒæ•´ã€æ€§èƒ½æ”¹è¿›ç­‰å› ç´ éƒ½å¯èƒ½å¯¼è‡´ç‰©æ–™çš„ç‰ˆæœ¬å˜æ›´ã€‚ç„¶è€Œï¼Œé¢‘ç¹çš„ç‰©æ–™å˜æ›´å¢åŠ äº†ç‰ˆæœ¬æ§åˆ¶çš„å¤æ‚æ€§ï¼Œéœ€è¦ç¡®ä¿å„ä¸ªç¯èŠ‚éƒ½èƒ½åŠæ—¶äº†è§£å¹¶é‡‡ç”¨æœ€æ–°çš„ç‰©æ–™ç‰ˆæœ¬ã€‚ 3ã€ç‰©æ–™ç‰ˆæœ¬çš„ä¸€è‡´æ€§ ï¼šåœ¨æ•´ä¸ªä¾›åº”é“¾ä¸­ï¼Œä¸åŒçš„å›¢é˜Ÿå’Œéƒ¨é—¨å¯èƒ½ä½¿ç”¨ä¸åŒçš„ç‰©æ–™ç‰ˆæœ¬ã€‚ä¾‹å¦‚ï¼Œè®¾è®¡å›¢é˜Ÿå¯èƒ½ä½¿ç”¨æœ€æ–°çš„ç‰©æ–™ç‰ˆæœ¬è¿›è¡Œäº§å“è®¾è®¡ï¼Œè€Œåˆ¶é€ å›¢é˜Ÿå¯èƒ½ä½¿ç”¨æ—§ç‰ˆæœ¬è¿›è¡Œç”Ÿäº§ã€‚è¿™å¯èƒ½å¯¼è‡´äº§å“çš„ä¸ä¸€è‡´æ€§å’Œè´¨é‡é—®é¢˜ã€‚å› æ­¤ï¼Œç¡®ä¿å„ä¸ªç¯èŠ‚ä¹‹é—´çš„ç‰©æ–™ç‰ˆæœ¬ä¸€è‡´æ€§æ˜¯ä¸€ä¸ªå…³é”®æŒ‘æˆ˜ã€‚ 4ã€ç‰©æ–™æº¯æºä¸è¿½æº¯ ï¼šåœ¨äº§å“ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œéœ€è¦èƒ½å¤Ÿè¿½æº¯å’Œæº¯æºæ¯ä¸ªç‰©æ–™çš„ç‰ˆæœ¬ä¿¡æ¯ã€‚è¿™å¯¹äºäº§å“è´¨é‡æ§åˆ¶ã€å¬å›ç®¡ç†å’Œæ³•è§„éµä»ç­‰æ–¹é¢éƒ½è‡³å…³é‡è¦ã€‚ç„¶è€Œï¼Œå¯¹äºå¤æ‚çš„äº§å“å’Œä¾›åº”é“¾ï¼Œç¡®ä¿ç‰©æ–™ç‰ˆæœ¬çš„æœ‰æ•ˆè¿½æº¯å’Œæº¯æºæ˜¯ä¸€ä¸ªæŒ‘æˆ˜ã€‚ ä¸ºäº†åº”å¯¹ç‰©æ–™ç‰ˆæœ¬æ§åˆ¶çš„æŒ‘æˆ˜ï¼Œå¯ä»¥é‡‡å–ä»¥ä¸‹æªæ–½ï¼š 1ã€å¼•å…¥PLMç³»ç»Ÿ ï¼šPLMç³»ç»Ÿæä¾›äº†ç‰©æ–™ç‰ˆæœ¬æ§åˆ¶çš„åŠŸèƒ½ï¼Œå¯ä»¥è®°å½•å’Œè·Ÿè¸ªä¸åŒç‰©æ–™ç‰ˆæœ¬çš„å±æ€§ã€ç‰¹æ€§å’Œä¾›åº”å•†ä¿¡æ¯ã€‚é€šè¿‡PLMç³»ç»Ÿï¼Œå¯ä»¥å®ç°ç‰ˆæœ¬çš„ç®¡ç†ã€æ›´æ–°å’Œå…±äº«ï¼Œç¡®ä¿å„ä¸ªå›¢é˜Ÿå’Œç¯èŠ‚ä½¿ç”¨çš„éƒ½æ˜¯æœ€æ–°çš„ç‰©æ–™ç‰ˆæœ¬ã€‚ 2ã€å»ºç«‹è§„èŒƒçš„å˜æ›´æµç¨‹ ï¼šåˆ¶å®šæ˜ç¡®çš„ç‰©æ–™å˜æ›´æµç¨‹ï¼ŒåŒ…æ‹¬ç‰©æ–™ç‰ˆæœ¬çš„æ›´æ–°å’ŒéªŒè¯ã€‚ç¡®ä¿ç‰©æ–™å˜æ›´ç»è¿‡é€‚å½“çš„å®¡æ‰¹å’ŒéªŒè¯ï¼Œé¿å…é”™è¯¯çš„ç‰ˆæœ¬æ›´æ–°å’Œä½¿ç”¨ã€‚ 3ã€åŠ å¼ºä¾›åº”é“¾ååŒ ï¼šä¸ä¾›åº”é“¾ä¸­çš„ä¾›åº”å•†å’Œåˆä½œä¼™ä¼´åŠ å¼ºæ²Ÿé€šå’Œåä½œï¼Œç¡®ä¿ç‰©æ–™ç‰ˆæœ¬çš„ä¸€è‡´æ€§ã€‚å»ºç«‹æ¸…æ™°çš„æ²Ÿé€šæ¸ é“ï¼ŒåŠæ—¶ä¼ é€’ç‰©æ–™å˜æ›´ä¿¡æ¯å’Œè¦æ±‚ã€‚ 4ã€å¼ºåŒ–æ•°æ®ç®¡ç† ï¼šå»ºç«‹å®Œå–„çš„ç‰©æ–™æ•°æ®ç®¡ç†æœºåˆ¶ï¼ŒåŒ…æ‹¬æ•°æ®é‡‡é›†ã€éªŒè¯ã€åŒæ­¥å’Œæ›´æ–°ç­‰ç¯èŠ‚ã€‚ç¡®ä¿ç‰©æ–™æ•°æ®çš„å‡†ç¡®æ€§å’Œä¸€è‡´æ€§ï¼Œæä¾›å¯é çš„ç‰©æ–™ç‰ˆæœ¬ä¿¡æ¯ã€‚ 5ã€å®æ–½ç‰©æ–™è¿½æº¯ç³»ç»Ÿ ï¼šå»ºç«‹ç‰©æ–™è¿½æº¯ç³»ç»Ÿï¼Œèƒ½å¤Ÿè·Ÿè¸ªå’Œæº¯æºæ¯ä¸ªç‰©æ–™çš„ç‰ˆæœ¬ä¿¡æ¯ã€‚é€šè¿‡è¿½æº¯ç³»ç»Ÿï¼Œå¯ä»¥å¿«é€Ÿå®šä½å’Œå¤„ç†ç‰©æ–™è´¨é‡é—®é¢˜ï¼Œæé«˜äº§å“è´¨é‡å’Œå®‰å…¨æ€§ã€‚ ç‰©æ–™ç‰ˆæœ¬æ§åˆ¶æ˜¯PLMç³»ç»Ÿä¸­BOMç®¡ç†çš„å…³é”®æŒ‘æˆ˜ä¹‹ä¸€ï¼Œå®ƒæ¶‰åŠåˆ°ç‰©æ–™ä¿¡æ¯çš„å¤æ‚æ€§ã€å˜æ›´é¢‘ç¹æ€§ã€ç‰ˆæœ¬ä¸€è‡´æ€§ä»¥åŠç‰©æ–™çš„è¿½æº¯å’Œæº¯æºã€‚é€šè¿‡å¼•å…¥PLMç³»ç»Ÿã€å»ºç«‹è§„èŒƒçš„å˜æ›´æµç¨‹ã€åŠ å¼ºä¾›åº”é“¾ååŒã€å¼ºåŒ–æ•°æ®ç®¡ç†å’Œå®æ–½ç‰©æ–™è¿½æº¯ç³»ç»Ÿï¼Œå¯ä»¥æœ‰æ•ˆåœ°åº”å¯¹ç‰©æ–™ç‰ˆæœ¬æ§åˆ¶çš„æŒ‘æˆ˜ï¼Œæé«˜äº§å“çš„è´¨é‡å’Œç«äº‰åŠ›ã€‚ ï¼ˆå››ï¼‰ååŒå·¥ä½œä¸æ•°æ®å…±äº« åœ¨PLMç³»ç»Ÿä¸­ï¼ŒBOMï¼ˆBill of Materialsï¼‰ç®¡ç†æ˜¯ä¸€ä¸ªå…³é”®çš„ä»»åŠ¡ï¼Œç”¨äºè®°å½•å’Œç®¡ç†äº§å“çš„ç»„æˆç»“æ„å’Œç›¸å…³ä¿¡æ¯ã€‚å…¶ä¸­ä¸€ä¸ªé‡è¦çš„æŒ‘æˆ˜æ˜¯å®ç°ååŒå·¥ä½œå’Œæ•°æ®å…±äº«ã€‚æœ¬æ–‡å°†æ¢è®¨ååŒå·¥ä½œä¸æ•°æ®å…±äº«åœ¨BOMç®¡ç†ä¸­æ‰€é¢ä¸´çš„æŒ‘æˆ˜ä»¥åŠå¦‚ä½•åº”å¯¹è¿™äº›æŒ‘æˆ˜ã€‚ 1ã€è·¨éƒ¨é—¨åä½œ ï¼šåœ¨äº§å“çš„è®¾è®¡ã€åˆ¶é€ å’Œä¾›åº”é“¾ç­‰ç¯èŠ‚ä¸­ï¼Œæ¶‰åŠåˆ°å¤šä¸ªéƒ¨é—¨å’Œå›¢é˜Ÿçš„ååŒå·¥ä½œã€‚è®¾è®¡å›¢é˜Ÿéœ€è¦ä¸å·¥ç¨‹å›¢é˜Ÿã€é‡‡è´­å›¢é˜Ÿã€åˆ¶é€ å›¢é˜Ÿç­‰ç´§å¯†åˆä½œï¼Œå…±åŒå®ŒæˆBOMçš„åˆ›å»ºã€ç»´æŠ¤å’Œæ›´æ–°ã€‚ç„¶è€Œï¼Œä¸åŒå›¢é˜Ÿä¹‹é—´çš„åä½œå¯èƒ½é¢ä¸´æ²Ÿé€šä¸ç•…ã€ä¿¡æ¯ä¸å‡†ç¡®å’Œä¿¡æ¯ä¼ é€’æ»åç­‰æŒ‘æˆ˜ã€‚ 2ã€æ•°æ®ä¸€è‡´æ€§å’Œå‡†ç¡®æ€§ ï¼šåœ¨ååŒå·¥ä½œä¸­ï¼Œç¡®ä¿BOMæ•°æ®çš„ä¸€è‡´æ€§å’Œå‡†ç¡®æ€§æ˜¯ä¸€ä¸ªé‡è¦æŒ‘æˆ˜ã€‚ä¸åŒå›¢é˜Ÿå¯èƒ½ä½¿ç”¨ä¸åŒçš„å·¥å…·å’Œç³»ç»Ÿæ¥å¤„ç†å’Œç»´æŠ¤BOMæ•°æ®ï¼Œå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´å’Œé”™è¯¯ã€‚å› æ­¤ï¼Œç¡®ä¿å„ä¸ªå›¢é˜Ÿä½¿ç”¨çš„éƒ½æ˜¯æœ€æ–°çš„BOMæ•°æ®ï¼Œä»¥åŠå¯¹BOMæ•°æ®çš„å‡†ç¡®æ€§è¿›è¡ŒéªŒè¯å’Œå®¡æŸ¥æ˜¯å…³é”®ã€‚ 3ã€æ•°æ®è®¿é—®å’Œæƒé™æ§åˆ¶ ï¼šåœ¨ååŒå·¥ä½œä¸­ï¼Œéœ€è¦ç¡®ä¿å›¢é˜Ÿæˆå‘˜èƒ½å¤Ÿæ–¹ä¾¿åœ°è®¿é—®å’Œå…±äº«BOMæ•°æ®ï¼ŒåŒæ—¶åˆéœ€è¦æ§åˆ¶æ•°æ®çš„æƒé™å’Œä¿å¯†æ€§ã€‚ä¸åŒå›¢é˜Ÿå¯èƒ½å…·æœ‰ä¸åŒçš„æ•°æ®è®¿é—®å’Œç¼–è¾‘æƒé™ï¼Œéœ€è¦ç¡®ä¿æ•°æ®çš„å®‰å…¨æ€§å’Œæœºå¯†æ€§ã€‚æ­¤å¤–ï¼Œè¿˜éœ€è¦è€ƒè™‘è·¨ç»„ç»‡æˆ–è·¨å…¬å¸çš„ååŒå·¥ä½œï¼Œéœ€è¦å»ºç«‹å®‰å…¨çš„æ•°æ®å…±äº«å’Œè®¿é—®æœºåˆ¶ã€‚ 4ã€å®æ—¶æ•°æ®æ›´æ–°å’ŒåŒæ­¥ ï¼šåœ¨å¤šäººååŒå·¥ä½œä¸­ï¼Œéœ€è¦ç¡®ä¿BOMæ•°æ®çš„å®æ—¶æ›´æ–°å’ŒåŒæ­¥ã€‚å½“ä¸€ä¸ªå›¢é˜Ÿå¯¹BOMè¿›è¡Œä¿®æ”¹æˆ–æ›´æ–°æ—¶ï¼Œå…¶ä»–å›¢é˜Ÿéœ€è¦èƒ½å¤ŸåŠæ—¶è·å–åˆ°æœ€æ–°çš„æ•°æ®ï¼Œé¿å…ä½¿ç”¨è¿‡æ—¶æˆ–é”™è¯¯çš„æ•°æ®ã€‚å®ç°å®æ—¶æ•°æ®æ›´æ–°å’ŒåŒæ­¥å¯¹äºç¡®ä¿ååŒå·¥ä½œçš„é«˜æ•ˆæ€§å’Œå‡†ç¡®æ€§è‡³å…³é‡è¦ã€‚ ä¸ºäº†åº”å¯¹ååŒå·¥ä½œä¸æ•°æ®å…±äº«çš„æŒ‘æˆ˜ï¼Œå¯ä»¥é‡‡å–ä»¥ä¸‹æªæ–½ï¼š 1ã€å¼•å…¥PLMç³»ç»Ÿ ï¼šPLMç³»ç»Ÿæä¾›äº†ååŒå·¥ä½œå’Œæ•°æ®å…±äº«çš„å¹³å°ï¼Œå›¢é˜Ÿæˆå‘˜å¯ä»¥åœ¨åŒä¸€ä¸ªç³»ç»Ÿä¸­è®¿é—®å’Œç¼–è¾‘BOMæ•°æ®ã€‚PLMç³»ç»Ÿå¯ä»¥å®ç°å®æ—¶æ•°æ®æ›´æ–°å’ŒåŒæ­¥ï¼Œç¡®ä¿å›¢é˜Ÿä½¿ç”¨çš„éƒ½æ˜¯æœ€æ–°çš„BOMæ•°æ®ã€‚ 2ã€è§„èŒƒååŒå·¥ä½œæµç¨‹ ï¼šå»ºç«‹æ˜ç¡®çš„ååŒå·¥ä½œæµç¨‹å’Œè´£ä»»åˆ†å·¥ï¼Œç¡®ä¿ä¸åŒå›¢é˜Ÿä¹‹é—´çš„åä½œé¡ºç•…ã€‚è§„å®šæ•°æ®çš„åˆ›å»ºã€å®¡æ‰¹ã€ä¿®æ”¹å’ŒéªŒè¯æµç¨‹ï¼Œé¿å…æ•°æ®å†²çªå’Œé”™è¯¯ã€‚ 3ã€æ•°æ®è®¿é—®å’Œæƒé™æ§åˆ¶ ï¼šæ ¹æ®å›¢é˜Ÿæˆå‘˜çš„è§’è‰²å’ŒèŒè´£ï¼Œè®¾å®šä¸åŒçš„æ•°æ®è®¿é—®å’Œç¼–è¾‘æƒé™ã€‚ç¡®ä¿æ•°æ®çš„å®‰å…¨æ€§å’Œæœºå¯†æ€§ï¼Œé¿å…æœªç»æˆæƒçš„è®¿é—®å’Œä¿®æ”¹ã€‚ 4ã€å»ºç«‹æ•°æ®æ ‡å‡†å’Œè§„èŒƒ ï¼šåˆ¶å®šç»Ÿä¸€çš„æ•°æ®æ ‡å‡†å’Œè§„èŒƒï¼ŒåŒ…æ‹¬å‘½åè§„åˆ™ã€å±æ€§å®šä¹‰å’Œæ•°æ®æ ¼å¼ç­‰ã€‚ç¡®ä¿ä¸åŒå›¢é˜Ÿä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®æ ‡å‡†ï¼Œæé«˜æ•°æ®çš„ä¸€è‡´æ€§å’Œå¯æ¯”æ€§ã€‚ 5ã€åŠ å¼ºæ²Ÿé€šå’ŒåŸ¹è®­ ï¼šåŠ å¼ºå›¢é˜Ÿæˆå‘˜ä¹‹é—´çš„æ²Ÿé€šå’Œåä½œèƒ½åŠ›ï¼ŒåŸ¹è®­ä»–ä»¬ä½¿ç”¨PLMç³»ç»Ÿå’Œéµå¾ªååŒå·¥ä½œæµç¨‹ã€‚æä¾›åŸ¹è®­å’Œæ”¯æŒï¼Œå¸®åŠ©å›¢é˜Ÿæˆå‘˜ç†Ÿæ‚‰å’ŒæŒæ¡ååŒå·¥ä½œå’Œæ•°æ®å…±äº«çš„æŠ€å·§å’Œæ–¹æ³•ã€‚ ååŒå·¥ä½œä¸æ•°æ®å…±äº«æ˜¯PLMç³»ç»Ÿä¸­BOMç®¡ç†çš„é‡è¦æŒ‘æˆ˜ä¹‹ä¸€ï¼Œå®ƒæ¶‰åŠåˆ°è·¨éƒ¨é—¨åä½œã€æ•°æ®ä¸€è‡´æ€§å’Œå‡†ç¡®æ€§ã€æ•°æ®è®¿é—®å’Œæƒé™æ§åˆ¶ï¼Œä»¥åŠå®æ—¶æ•°æ®æ›´æ–°å’ŒåŒæ­¥ç­‰æ–¹é¢ã€‚é€šè¿‡å¼•å…¥PLMç³»ç»Ÿã€è§„èŒƒååŒå·¥ä½œæµç¨‹ã€å»ºç«‹æ•°æ®æ ‡å‡†ã€åŠ å¼ºæ²Ÿé€šå’ŒåŸ¹è®­ï¼Œå¯ä»¥æœ‰æ•ˆåœ°åº”å¯¹è¿™äº›æŒ‘æˆ˜ï¼Œæé«˜BOMç®¡ç†çš„æ•ˆç‡å’Œå‡†ç¡®æ€§ã€‚ å››ã€PLMç³»ç»Ÿä¸­çš„BOMç®¡ç†åŠŸèƒ½ ï¼ˆä¸€ï¼‰BOMçš„åˆ›å»ºä¸ç»´æŠ¤ åœ¨PLMç³»ç»Ÿä¸­ï¼ŒBOMï¼ˆBill of Materialsï¼‰çš„åˆ›å»ºä¸ç»´æŠ¤æ˜¯ä¸€ä¸ªå…³é”®çš„åŠŸèƒ½ã€‚BOMçš„åˆ›å»ºæ¶‰åŠåˆ°äº§å“çš„ç»„æˆç»“æ„å’Œç›¸å…³ä¿¡æ¯çš„å½•å…¥å’Œç®¡ç†ã€‚é€šè¿‡PLMç³»ç»Ÿï¼Œç”¨æˆ·å¯ä»¥æ–¹ä¾¿åœ°åˆ›å»ºBOMï¼Œå¹¶æ·»åŠ å„ä¸ªç»„æˆéƒ¨åˆ†çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚ç‰©æ–™ç¼–ç ã€æè¿°ã€æ•°é‡ã€å•ä½ç­‰ã€‚åŒæ—¶ï¼ŒPLMç³»ç»Ÿè¿˜æä¾›äº†BOMçš„ç»´æŠ¤åŠŸèƒ½ï¼Œå¯ä»¥å¯¹BOMè¿›è¡Œä¿®æ”¹ã€æ›´æ–°å’Œåˆ é™¤ï¼Œä»¥é€‚åº”äº§å“çš„å˜åŒ–å’Œæ¼”è¿›ã€‚ ï¼ˆäºŒï¼‰BOMçš„ç‰ˆæœ¬ç®¡ç† åœ¨äº§å“çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼ŒBOMé€šå¸¸ä¼šéšç€äº§å“çš„è®¾è®¡ã€åˆ¶é€ å’Œå˜æ›´è€Œå‘ç”Ÿå¤šä¸ªç‰ˆæœ¬çš„å˜åŒ–ã€‚å› æ­¤ï¼ŒPLMç³»ç»Ÿæä¾›äº†BOMçš„ç‰ˆæœ¬ç®¡ç†åŠŸèƒ½ã€‚é€šè¿‡ç‰ˆæœ¬ç®¡ç†ï¼Œå¯ä»¥è®°å½•å’Œè·Ÿè¸ªä¸åŒç‰ˆæœ¬çš„BOMï¼ŒåŒ…æ‹¬ç‰ˆæœ¬å·ã€åˆ›å»ºæ—¥æœŸã€ä¿®æ”¹è®°å½•ç­‰ä¿¡æ¯ã€‚ç”¨æˆ·å¯ä»¥æ ¹æ®éœ€è¦æŸ¥çœ‹å’Œæ¯”è¾ƒä¸åŒç‰ˆæœ¬çš„BOMï¼Œäº†è§£æ¯ä¸ªç‰ˆæœ¬çš„å˜åŒ–å’Œå·®å¼‚ã€‚åŒæ—¶ï¼Œç‰ˆæœ¬ç®¡ç†è¿˜æä¾›äº†å›æ»šå’Œè¿˜åŸçš„åŠŸèƒ½ï¼Œå¯ä»¥æ¢å¤åˆ°å…ˆå‰çš„BOMç‰ˆæœ¬ã€‚ ï¼ˆä¸‰ï¼‰BOMçš„å˜æ›´æ§åˆ¶ åœ¨äº§å“çš„å¼€å‘å’Œåˆ¶é€ è¿‡ç¨‹ä¸­ï¼Œä¸å¯é¿å…åœ°ä¼šå‘ç”ŸBOMçš„å˜æ›´ã€‚è¿™äº›å˜æ›´å¯èƒ½æ¶‰åŠåˆ°ç»„æˆéƒ¨åˆ†çš„æ›¿æ¢ã€æ•°é‡çš„è°ƒæ•´ã€ç‰¹æ€§çš„æ”¹å˜ç­‰ã€‚PLMç³»ç»Ÿæä¾›äº†BOMçš„å˜æ›´æ§åˆ¶åŠŸèƒ½ï¼Œå¯ä»¥è®°å½•å’Œç®¡ç†BOMçš„å˜æ›´è¯·æ±‚ã€å®¡æ‰¹æµç¨‹å’Œå˜æ›´è®°å½•ã€‚ç”¨æˆ·å¯ä»¥æäº¤BOMçš„å˜æ›´è¯·æ±‚ï¼Œå¹¶ç»è¿‡ç›¸åº”çš„å®¡æ‰¹æµç¨‹ï¼Œç¡®ä¿å˜æ›´çš„åˆç†æ€§å’Œå‡†ç¡®æ€§ã€‚å˜æ›´æ§åˆ¶è¿˜å¯ä»¥è·Ÿè¸ªå’Œè®°å½•æ¯ä¸ªBOMçš„å˜æ›´å†å²ï¼Œä»¥ä¾¿è¿›è¡Œå®¡è®¡å’Œè¿½æº¯ã€‚ ï¼ˆå››ï¼‰BOMä¸CADæ•°æ®çš„é›†æˆ BOMå’ŒCADï¼ˆComputer-Aided Designï¼‰æ•°æ®ä¹‹é—´çš„é›†æˆæ˜¯PLMç³»ç»Ÿä¸­çš„é‡è¦åŠŸèƒ½ä¹‹ä¸€ã€‚CADæ•°æ®åŒ…å«äº†äº§å“çš„è®¾è®¡å›¾çº¸å’Œæ¨¡å‹ï¼Œè€ŒBOMåˆ™è®°å½•äº†äº§å“çš„ç»„æˆç»“æ„å’Œç›¸å…³ä¿¡æ¯ã€‚PLMç³»ç»Ÿå¯ä»¥å®ç°BOMå’ŒCADæ•°æ®çš„å…³è”å’Œé›†æˆï¼Œå°†CADæ•°æ®ä¸BOMå…³è”èµ·æ¥ã€‚è¿™æ ·ï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥ä»BOMä¸­è®¿é—®å’ŒæŸ¥çœ‹ç›¸åº”çš„CADæ•°æ®ï¼Œç¡®ä¿è®¾è®¡ä¸BOMçš„ä¸€è‡´æ€§å’Œæ­£ç¡®æ€§ã€‚åŒæ—¶ï¼ŒBOMçš„å˜æ›´ä¹Ÿå¯ä»¥åŒæ­¥åˆ°CADæ•°æ®ä¸­ï¼Œä¿æŒä¸¤è€…ä¹‹é—´çš„ä¸€è‡´æ€§ã€‚ ï¼ˆäº”ï¼‰BOMçš„æŸ¥è¯¢ä¸è·Ÿè¸ª PLMç³»ç»Ÿè¿˜æä¾›äº†BOMçš„æŸ¥è¯¢ä¸è·Ÿè¸ªåŠŸèƒ½ï¼Œæ–¹ä¾¿ç”¨æˆ·å¿«é€ŸæŸ¥æ‰¾å’Œè·Ÿè¸ªBOMçš„ç›¸å…³ä¿¡æ¯ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡å…³é”®è¯ã€ç‰©æ–™ç¼–ç ã€äº§å“å‹å·ç­‰è¿›è¡ŒBOMçš„æŸ¥è¯¢ï¼Œå¿«é€Ÿå®šä½æ‰€éœ€çš„BOMã€‚åŒæ—¶ï¼ŒPLMç³»ç»Ÿè¿˜å¯ä»¥è·Ÿè¸ªå’Œè®°å½•BOMçš„ä½¿ç”¨æƒ…å†µï¼ŒåŒ…æ‹¬äº§å“çš„åˆ¶é€ è¿‡ç¨‹ã€é”€å”®è®¢å•ã€å”®åæœåŠ¡ç­‰ã€‚è¿™æ ·ï¼Œç”¨æˆ·å¯ä»¥äº†è§£æ¯ä¸ªBOMçš„ä½¿ç”¨æƒ…å†µå’Œå˜æ›´å†å²ï¼Œè¿›è¡Œæ•°æ®åˆ†æå’Œå†³ç­–æ”¯æŒã€‚ äº”ã€ç»“è®º BOMï¼ˆBill of Materialsï¼‰æ˜¯äº§å“å¼€å‘å’Œåˆ¶é€ è¿‡ç¨‹ä¸­çš„å…³é”®ä¿¡æ¯ä¹‹ä¸€ã€‚åœ¨PLMç³»ç»Ÿä¸­è¿›è¡ŒBOMç®¡ç†ï¼Œå¯ä»¥å¸®åŠ©ä¼ä¸šå®ç°äº§å“çš„å¿«é€Ÿå¼€å‘ã€é«˜æ•ˆåˆ¶é€ å’ŒæŒç»­æ”¹è¿›ã€‚æœ¬æ–‡é€šè¿‡å¯¹BOMå®šä¹‰ä¸åˆ†ç±»çš„è¯¦ç»†ä»‹ç»ï¼Œä»¥åŠPLMç³»ç»Ÿä¸­BOMç®¡ç†çš„åŠŸèƒ½å’ŒæŒ‘æˆ˜çš„æ¢è®¨ï¼Œå¼ºè°ƒäº†BOMå®šä¹‰ä¸åˆ†ç±»çš„é‡è¦æ€§ã€‚ é¦–å…ˆï¼ŒBOMçš„å®šä¹‰ä¸ºäº§å“çš„ç»„æˆç»“æ„å’Œç›¸å…³ä¿¡æ¯æä¾›äº†æ¸…æ™°çš„æè¿°å’Œè®°å½•ã€‚é€šè¿‡å¯¹äº§å“çš„å„ä¸ªç»„æˆéƒ¨åˆ†è¿›è¡Œåˆ†ç±»ã€å‘½åå’Œç¼–ç ï¼Œå¯ä»¥å»ºç«‹èµ·BOMçš„å±‚æ¬¡ç»“æ„ï¼Œæ–¹ä¾¿åç»­çš„ç®¡ç†å’Œä½¿ç”¨ã€‚BOMçš„å®šä¹‰ä¹Ÿä¸ºäº§å“çš„è®¾è®¡ã€åˆ¶é€ ã€é‡‡è´­å’Œå”®åæœåŠ¡ç­‰ç¯èŠ‚æä¾›äº†åŸºç¡€æ•°æ®ï¼Œç¡®ä¿å„ä¸ªå›¢é˜Ÿä¹‹é—´çš„ååŒå·¥ä½œå’Œä¿¡æ¯å…±äº«ã€‚ å…¶æ¬¡ï¼ŒBOMçš„åˆ†ç±»å¯ä»¥ä»ä¸åŒçš„è§’åº¦å¯¹äº§å“çš„ç»„æˆéƒ¨åˆ†è¿›è¡Œåˆ†ç±»å’Œå½’ç±»ã€‚æ ¹æ®äº§å“å±‚çº§çš„åˆ†ç±»ï¼Œå¯ä»¥å°†BOMåˆ†ä¸ºæ€»è£…BOMã€å­è£…BOMå’Œé›¶éƒ¨ä»¶BOMï¼Œä¾¿äºç»„ç»‡å’Œç®¡ç†å¤æ‚çš„äº§å“ç»“æ„ã€‚æ ¹æ®ç»„æˆä»¶ç±»å‹çš„åˆ†ç±»ï¼Œå¯ä»¥å°†BOMåˆ†ä¸ºæœºæ¢°BOMã€ç”µæ°”BOMã€è½¯ä»¶BOMç­‰ï¼Œæ–¹ä¾¿ä¸åŒå›¢é˜Ÿä¹‹é—´çš„åä½œå’Œæ²Ÿé€šã€‚æ ¹æ®ç”Ÿå‘½å‘¨æœŸé˜¶æ®µçš„åˆ†ç±»ï¼Œå¯ä»¥å°†BOMåˆ†ä¸ºè®¾è®¡BOMã€å·¥ç¨‹BOMã€åˆ¶é€ BOMå’Œç»´æŠ¤BOMï¼Œæœ‰åŠ©äºè·Ÿè¸ªå’Œç®¡ç†ä¸åŒé˜¶æ®µçš„BOMæ•°æ®ã€‚ åœ¨PLMç³»ç»Ÿä¸­ï¼ŒBOMç®¡ç†é¢ä¸´ç€å¤šå±‚æ¬¡BOMç®¡ç†ã€ç‰©æ–™å˜æ›´æ§åˆ¶ã€ç‰©æ–™ç‰ˆæœ¬æ§åˆ¶å’ŒååŒå·¥ä½œä¸æ•°æ®å…±äº«ç­‰æŒ‘æˆ˜ã€‚é’ˆå¯¹è¿™äº›æŒ‘æˆ˜ï¼Œå¯ä»¥é€šè¿‡å¼•å…¥PLMç³»ç»Ÿã€è§„èŒƒååŒå·¥ä½œæµç¨‹ã€å»ºç«‹æ•°æ®æ ‡å‡†å’ŒåŠ å¼ºæ²Ÿé€šå’ŒåŸ¹è®­ç­‰æªæ–½æ¥åº”å¯¹ã€‚PLMç³»ç»Ÿä¸­çš„BOMç®¡ç†åŠŸèƒ½åŒ…æ‹¬BOMçš„åˆ›å»ºä¸ç»´æŠ¤ã€ç‰ˆæœ¬ç®¡ç†ã€å˜æ›´æ§åˆ¶ã€ä¸CADæ•°æ®çš„é›†æˆï¼Œä»¥åŠæŸ¥è¯¢ä¸è·Ÿè¸ªç­‰ï¼Œå¸®åŠ©ä¼ä¸šå®ç°BOMçš„æœ‰æ•ˆç®¡ç†å’Œåˆ©ç”¨ã€‚ æ€»è€Œè¨€ä¹‹ï¼ŒPLMç³»ç»Ÿä¸­BOMç®¡ç†æ˜¯äº§å“å¼€å‘å’Œåˆ¶é€ è¿‡ç¨‹ä¸­çš„é‡è¦ç¯èŠ‚ã€‚é€šè¿‡å¯¹BOMçš„å®šä¹‰ä¸åˆ†ç±»ï¼Œä¼ä¸šå¯ä»¥å»ºç«‹èµ·æ¸…æ™°çš„äº§å“ç»“æ„å’ŒåŸºç¡€æ•°æ®ï¼Œä¸ºäº§å“çš„å¼€å‘ã€åˆ¶é€ å’ŒæœåŠ¡æä¾›æ”¯æŒã€‚åœ¨PLMç³»ç»Ÿçš„å¸®åŠ©ä¸‹ï¼ŒBOMç®¡ç†å¯ä»¥æ›´åŠ é«˜æ•ˆã€å‡†ç¡®å’Œå¯è¿½æº¯ï¼Œä¸ºä¼ä¸šæä¾›äº†ç«äº‰ä¼˜åŠ¿ã€‚å› æ­¤ï¼Œå¯¹BOMçš„å®šä¹‰ä¸åˆ†ç±»çš„é‡è¦æ€§ä¸å¯å¿½è§†ï¼Œä¼ä¸šåº”é‡è§†BOMç®¡ç†ï¼Œå¹¶é€šè¿‡PLMç³»ç»Ÿçš„åº”ç”¨æ¥æå‡ç®¡ç†æ°´å¹³å’Œæ•ˆç‡ã€‚ ","link":"https://tianxiawuhao.github.io/k0goe8fBf/"},{"title":"å·¥å‚ä¸šåŠ¡åè¯","content":"å·¥å‚å¸¸ç”¨è½¯ä»¶ æœ¯è¯­ å†…å®¹ æ ¸å¿ƒåŠŸèƒ½æ¨¡å— å…¸å‹å‚å®¶ OAï¼ˆåŠå…¬è‡ªåŠ¨åŒ–ï¼‰Office Automation å°†ç°ä»£åŒ–åŠå…¬å’Œè®¡ç®—æœºæŠ€æœ¯ç»“åˆèµ·æ¥çš„ä¸€ç§æ–°å‹çš„åŠå…¬æ–¹å¼ã€‚åŠå…¬è‡ªåŠ¨åŒ–æ²¡æœ‰ç»Ÿä¸€çš„å®šä¹‰ï¼Œå‡¡æ˜¯åœ¨ä¼ ç»Ÿçš„åŠå…¬å®¤ä¸­é‡‡ç”¨å„ç§æ–°æŠ€æœ¯ã€æ–°æœºå™¨ã€æ–°è®¾å¤‡ä»äº‹åŠå…¬ä¸šåŠ¡ï¼Œéƒ½å±äºåŠå…¬è‡ªåŠ¨åŒ–çš„é¢†åŸŸã€‚é€šè¿‡å®ç°åŠå…¬è‡ªåŠ¨åŒ–ï¼Œæˆ–è€…è¯´å®ç°æ•°å­—åŒ–åŠå…¬ï¼Œå¯ä»¥ä¼˜åŒ–ç°æœ‰çš„ç®¡ç†ç»„ç»‡ç»“æ„ï¼Œè°ƒæ•´ç®¡ç†ä½“åˆ¶ï¼Œåœ¨æé«˜æ•ˆç‡çš„åŸºç¡€ä¸Šï¼Œå¢åŠ ååŒåŠå…¬èƒ½åŠ›ï¼Œå¼ºåŒ–å†³ç­–çš„ä¸€è‡´æ€§ å…¬æ–‡ç®¡ç†ã€æµç¨‹è§„èŒƒã€é‚®ä»¶ã€å®¡æ‰¹ã€é€šçŸ¥å…¬å‘Š å¾®è½¯ã€IBMã€é£ä¹¦ã€é’‰é’‰ CRMï¼ˆå®¢æˆ·å…³ç³»ç®¡ç†ï¼‰Customer Relationship Management æŒ‡ä¼ä¸šä¸ºæé«˜æ ¸å¿ƒç«äº‰åŠ›ï¼Œåˆ©ç”¨ç›¸åº”çš„ä¿¡æ¯æŠ€æœ¯ä»¥åŠäº’è”ç½‘æŠ€æœ¯åè°ƒä¼ä¸šä¸é¡¾å®¢é—´åœ¨é”€å”®ã€è¥é”€å’ŒæœåŠ¡ä¸Šçš„äº¤äº’ï¼Œä»è€Œæå‡å…¶ç®¡ç†æ–¹å¼ï¼Œå‘å®¢æˆ·æä¾›åˆ›æ–°å¼çš„ä¸ªæ€§åŒ–çš„å®¢æˆ·äº¤äº’å’ŒæœåŠ¡çš„è¿‡ç¨‹ã€‚å…¶æœ€ç»ˆç›®æ ‡æ˜¯å¸å¼•æ–°å®¢æˆ·ã€ä¿ç•™è€å®¢æˆ·ä»¥åŠå°†å·²æœ‰å®¢æˆ·è½¬ä¸ºå¿ å®å®¢æˆ·ï¼Œå¢åŠ å¸‚åœº çº¿ç´¢ç®¡ç†ã€å®¢æˆ·ç®¡ç†ã€å•†æœºç®¡ç†ã€å®¢æˆ·å…¬æµ·ã€å®¢æˆ·ç”»åƒã€äº¤æ˜“ç®¡ç†ã€è¥é”€ç®¡ç† çº·äº«é”€å®¢ã€é”€å”®æ˜“ã€ç¥å·äº‘åŠ¨ã€é”€å¸®å¸®ã€çº¢åœˆã€Salesforceã€hubspotã€zoho SCRMï¼ˆç¤¾ä¼šåŒ–å®¢æˆ·å…³ç³»ç®¡ç†ï¼‰Social Customer Relationship Management æ˜¯ä¸€ç§åŸºäºç¤¾äº¤åª’ä½“çš„å®¢æˆ·å…³ç³»ç®¡ç†ç³»ç»Ÿï¼Œå…¶ç›®çš„æ˜¯é€šè¿‡ç¤¾äº¤åª’ä½“å¹³å°å®ç°ä¼ä¸šä¸å®¢æˆ·ä¹‹é—´çš„æœ‰æ•ˆæ²Ÿé€šå’Œäº’åŠ¨ï¼Œä»è€Œæé«˜å®¢æˆ·æ»¡æ„åº¦å’Œå¿ è¯šåº¦ï¼Œå¢åŠ ä¼ä¸šçš„é”€å”®é¢å’Œå¸‚åœºä»½é¢ çº¿ç´¢æ¥å…¥ã€å¤šåœºæ™¯è·å®¢ã€æ¸ é“ROIåˆ†æå®¢æˆ·ç®¡ç†ã€ç´ æåº“ç®¡ç†ã€äº¤æ˜“ç®¡ç† å°˜é”‹SCRMã€æ¢é©¬SCRMã€å¿«é²¸SCRMã€å¾®ä¼´åŠ©æ‰‹ã€å«ç“´SCRM SRMï¼ˆä¾›åº”å•†å…³ç³»ç®¡ç†ï¼‰Supplier Relationship Management æ˜¯ç”¨æ¥æ”¹å–„ä¸ä¾›åº”é“¾ä¸Šæ¸¸ä¾›åº”å•†çš„å…³ç³»çš„ï¼Œå®ƒæ˜¯ä¸€ç§è‡´åŠ›äºå®ç°ä¸ä¾›åº”å•†å»ºç«‹å’Œç»´æŒé•¿ä¹…ã€ç´§å¯†ä¼™ä¼´å…³ç³»çš„ç®¡ç†æ€æƒ³å’Œè½¯ä»¶æŠ€æœ¯çš„è§£å†³æ–¹æ¡ˆï¼Œå®ƒæ—¨åœ¨æ”¹å–„ä¼ä¸šä¸ä¾›åº”å•†ä¹‹é—´å…³ç³»çš„æ–°å‹ç®¡ç†æœºåˆ¶ï¼Œå®æ–½äºå›´ç»•ä¼ä¸šé‡‡è´­ä¸šåŠ¡ç›¸å…³çš„é¢†åŸŸï¼Œç›®æ ‡æ˜¯é€šè¿‡ä¸ä¾›åº”å•†å»ºç«‹é•¿æœŸã€ç´§å¯†çš„ä¸šåŠ¡å…³ç³»ï¼Œå¹¶é€šè¿‡å¯¹åŒæ–¹èµ„æºå’Œç«äº‰ä¼˜åŠ¿çš„æ•´åˆæ¥å…±åŒå¼€æ‹“å¸‚åœºï¼Œæ‰©å¤§å¸‚åœºéœ€æ±‚å’Œä»½é¢ï¼Œé™ä½äº§å“å‰æœŸçš„é«˜é¢æˆæœ¬ï¼Œå®ç°åŒèµ¢çš„ä¼ä¸šç®¡ç†æ¨¡å¼ å¯»æºæ¯”ä»·ã€æ‹›æŠ•æ ‡ç®¡ç†ã€é‡‡è´­ç”³è¯·ã€é‡‡è´­ç®¡ç†ã€ä¾›åº”å•†ç®¡ç†ã€ä¾›åº”å•†ç»©æ•ˆç®¡ç†ã€é‡‡è´­åˆ°è´§ç®¡ç†ã€å…¥åº“ç®¡ç†ã€é‡‡è´­ç»“ç®— ç”„äº‘ã€ä¼ä¼é€š SCMï¼ˆä¾›åº”é“¾ç®¡ç†ï¼‰Supply Chain Management æ˜¯ä¸€ä¸ªç»¼åˆæ€§çš„ä¾›åº”é“¾ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œæ—¨åœ¨åè°ƒå’Œä¼˜åŒ–ä¼ä¸šå†…éƒ¨å’Œå¤–éƒ¨çš„ä¾›åº”é“¾æ´»åŠ¨ã€‚å®ƒæ¶µç›–äº†ä»åŸææ–™é‡‡è´­åˆ°äº§å“äº¤ä»˜çš„æ•´ä¸ªä¾›åº”é“¾æµç¨‹ï¼ŒåŒ…æ‹¬ä¾›åº”å•†ç®¡ç†ã€ç‰©æµç®¡ç†ã€åº“å­˜ç®¡ç†ã€è®¢å•ç®¡ç†ç­‰ã€‚SCMç³»ç»Ÿå¸®åŠ©ä¼ä¸šå®ç°ä¾›åº”é“¾çš„å¯è§†åŒ–ã€ååŒå’Œä¼˜åŒ–ï¼Œæé«˜ä¾›åº”é“¾çš„æ•ˆç‡å’Œçµæ´»æ€§ï¼Œé™ä½æˆæœ¬å¹¶æä¾›æ›´å¥½çš„å®¢æˆ·æœåŠ¡ ä¾›åº”å•†ç®¡ç†ã€é‡‡è´­ç®¡ç†ã€ç‰©æµé…é€ç®¡ç†ã€äº¤è´§è®¡åˆ’ã€æ”¶å‘è´§ç®¡ç†ã€éªŒæ”¶ç®¡ç†ã€åº“å­˜ç®¡ç†ã€é”€å”®è®¢å•ç®¡ç†ã€å®¢æˆ·ç®¡ç†ã€ä¾›åº”å•†ååŒã€å®¢æˆ·ååŒ ä¸Šæµ·ä¼å…° ERPï¼ˆä¼ä¸šèµ„æºè®¡åˆ’ï¼‰Enterprise Resource Planning æŒ‡å»ºç«‹åœ¨ä¿¡æ¯æŠ€æœ¯åŸºç¡€ä¸Šï¼Œä»¥ç³»ç»ŸåŒ–çš„ç®¡ç†æ€æƒ³ï¼Œä¸ºä¼ä¸šå†³ç­–å±‚åŠå‘˜å·¥æä¾›å†³ç­–è¿è¡Œæ‰‹æ®µçš„ç®¡ç†å¹³å° ä¾›åº”é“¾ç®¡ç†ã€ç”Ÿäº§åˆ¶é€ ç®¡ç†ï¼ˆMRPï¼‰ã€è´¨é‡ç®¡ç†ã€äººåŠ›èµ„æºç®¡ç†ã€è´¢åŠ¡ç®¡ç† ç”¨å‹ã€é‡‘è¶ã€é¼æ·ã€ç®¡å®¶å©†ã€èšæ°´æ½­ã€oracleã€SAP MESï¼ˆç”Ÿäº§æ‰§è¡Œç³»ç»Ÿï¼‰Manufacturing Execution System æ˜¯ä¸€å¥—é¢å‘åˆ¶é€ ä¼ä¸šè½¦é—´æ‰§è¡Œå±‚çš„ç”Ÿäº§ä¿¡æ¯åŒ–ç®¡ç†ç³»ç»Ÿ åˆ¶é€ æ•°æ®ç®¡ç†ã€è®¡åˆ’æ’ç¨‹ç®¡ç†ã€ç”Ÿäº§è°ƒåº¦ç®¡ç†ã€è´¨é‡ç®¡ç†ã€äººåŠ›èµ„æºç®¡ç†ã€å·¥ä½œä¸­å¿ƒ/è®¾å¤‡ç®¡ç†ã€å·¥å…·å·¥è£…ç®¡ç†ã€æˆæœ¬ç®¡ç†ã€é¡¹ç›®çœ‹æ¿ç®¡ç†ã€ç”Ÿäº§è¿‡ç¨‹æ§åˆ¶ã€åº•å±‚æ•°æ®é›†æˆåˆ†æã€ä¸Šå±‚æ•°æ®é›†æˆåˆ†è§£ç­‰ç®¡ç†æ¨¡å— é¼æ·ã€å®ä¿¡ã€æŸæ¥šã€èµ›æ„ã€è¥¿é—¨å­ã€éœå°¼éŸ¦å°” MOMï¼ˆåˆ¶é€ è¿è¥ç®¡ç†ï¼‰Manufacturing Operation Management ç¾å›½ä»ªå™¨ã€ç³»ç»Ÿå’Œè‡ªåŠ¨åŒ–åä¼šäº2000å¹´å¼€å§‹å‘å¸ƒISA-SP95æ ‡å‡†ï¼Œé¦–æ¬¡ç¡®ç«‹äº†åˆ¶é€ è¿è¡Œç®¡ç†çš„æ¦‚å¿µï¼Œé’ˆå¯¹æ›´å¹¿ä¹‰çš„åˆ¶é€ è¿è¥ç®¡ç†åˆ’å®šè¾¹ç•Œï¼Œä½œä¸ºè¯¥é¢†åŸŸçš„é€šç”¨ç ”ç©¶å¯¹è±¡å’Œå†…å®¹ï¼Œå¹¶æ„å»ºé€šç”¨æ´»åŠ¨æ¨¡å‹åº”ç”¨äºç”Ÿäº§ã€ç»´æŠ¤ã€è´¨é‡å’Œåº“å­˜4ç±»ä¸»è¦è¿è¡ŒåŒºåŸŸï¼Œè¯¦ç»†å®šä¹‰äº†å„ç±»è¿è¡Œç³»ç»Ÿçš„åŠŸèƒ½åŠå„åŠŸèƒ½æ¨¡å—ä¹‹é—´çš„ç›¸äº’å…³ç³» è®¾å¤‡ç®¡ç†ã€ç”Ÿäº§ç®¡ç†ã€è®¡åˆ’æ’äº§ã€å“è´¨ç®¡ç†ã€ä»“åº“ç®¡ç†ã€èµ„æºç®¡ç†ã€ç³»ç»ŸåŸºç¡€ç®¡ç†åŠç³»ç»Ÿé›†æˆç­‰åŠŸèƒ½æ¨¡å— å›½æœºã€é”åˆ¶ã€å…ƒå·¥ã€æ ‘æ ¹äº’è” APSï¼ˆé«˜çº§è®¡åˆ’ä¸æ’ç¨‹ï¼‰Advanced Planning and Scheduling æ˜¯è§£å†³ç”Ÿäº§æ’ç¨‹å’Œç”Ÿäº§è°ƒåº¦é—®é¢˜ï¼Œå¸¸è¢«ç§°ä¸ºæ’åºé—®é¢˜æˆ–èµ„æºåˆ†é…é—®é¢˜ã€‚åœ¨ç¦»æ•£è¡Œä¸šï¼ŒAPSæ˜¯ä¸ºè§£å†³å¤šå·¥åºã€å¤šèµ„æºçš„ä¼˜åŒ–è°ƒåº¦é—®é¢˜ï¼›è€Œæµç¨‹è¡Œä¸šï¼ŒAPSåˆ™æ˜¯ä¸ºè§£å†³é¡ºåºä¼˜åŒ–é—®é¢˜ã€‚å®ƒé€šè¿‡ä¸ºæµç¨‹å’Œç¦»æ•£çš„æ··åˆæ¨¡å‹åŒæ—¶è§£å†³é¡ºåºå’Œè°ƒåº¦çš„ä¼˜åŒ–é—®é¢˜ï¼Œä»è€Œå¯¹é¡¹ç›®ç®¡ç†ä¸é¡¹ç›®åˆ¶é€ è§£å†³å…³é”®é“¾å’Œæˆæœ¬æ—¶é—´æœ€å°åŒ–ï¼Œå…·æœ‰é‡è¦æ„ä¹‰ã€‚ ç”Ÿäº§è®¡åˆ’ã€MRPè¿ç®—ã€ç‰©æ–™æ§åˆ¶ã€æ•°å­—åŒ–æ’äº§ã€é½å¥—è®¡ç®—ã€ç‰©æ–™ç®¡ç†ã€BOMç®¡ç†ã€å·¥è‰ºè·¯çº¿ç®¡ç†ã€ç³»ç»Ÿé…ç½®ã€é›†æˆç®¡ç† å®‰è¾¾å‘ã€æ˜“æ™®ä¼˜ã€è¥¿é—¨å­ã€ç¿Ÿå°¼éŸ¦å°” PLMï¼ˆäº§å“ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼‰Product Lifecycle Management æ˜¯ä¸€ç§åº”ç”¨äºåœ¨å•ä¸€åœ°ç‚¹çš„ä¼ä¸šå†…éƒ¨ã€åˆ†æ•£åœ¨å¤šä¸ªåœ°ç‚¹çš„ä¼ä¸šå†…éƒ¨ï¼Œä»¥åŠåœ¨äº§å“ç ”å‘é¢†åŸŸå…·æœ‰åä½œå…³ç³»çš„ä¼ä¸šä¹‹é—´çš„ï¼Œæ”¯æŒäº§å“å…¨ç”Ÿå‘½å‘¨æœŸçš„ä¿¡æ¯çš„åˆ›å»ºã€ç®¡ç†ã€åˆ†å‘å’Œåº”ç”¨çš„ä¸€ç³»åˆ—åº”ç”¨è§£å†³æ–¹æ¡ˆï¼Œå®ƒèƒ½å¤Ÿé›†æˆä¸äº§å“ç›¸å…³çš„äººåŠ›èµ„æºã€æµç¨‹ã€åº”ç”¨ç³»ç»Ÿå’Œä¿¡æ¯ ç‰©æ–™ç®¡ç†ã€äº§å“ç®¡ç†ã€è¯•éªŒç®¡ç†ã€é…æ–¹ç®¡ç†ã€é¡¹ç›®ç®¡ç†ã€å·¥è‰ºç®¡ç†ã€æ–‡æ¡£ç®¡ç†ã€éœ€æ±‚ç®¡ç†ã€æˆæœ¬ç®¡ç†ã€é›†æˆç®¡ç† æ€æ™®ã€æ•°ç å¤§æ–¹ã€å¤©å–»ã€è¾¾ç´¢ç³»ç»Ÿenoviaã€è¥¿é—¨å­ã€SAPæ€çˆ±æ™® QMSï¼ˆè´¨é‡ç®¡ç†ä½“ç³»ï¼‰Quality Management System æ˜¯æŒ‡åœ¨è´¨é‡æ–¹é¢æŒ‡æŒ¥å’Œæ§åˆ¶ç»„ç»‡çš„ç®¡ç†ä½“ç³»ã€‚è´¨é‡ç®¡ç†ä½“ç³»æ˜¯ç»„ç»‡å†…éƒ¨å»ºç«‹çš„ã€ä¸ºå®ç°è´¨é‡ç›®æ ‡æ‰€å¿…éœ€çš„ã€ç³»ç»Ÿçš„è´¨é‡ç®¡ç†æ¨¡å¼ï¼Œæ˜¯ç»„ç»‡çš„ä¸€é¡¹æˆ˜ç•¥å†³ç­– æ ·å“ç®¡ç†ã€ä»ªå™¨è®¾å¤‡ç®¡ç†ã€æ£€æµ‹é…ç½®ã€äººå‘˜ç»©æ•ˆè€ƒæ ¸ã€å®¢æˆ·è´¨é‡ç®¡ç†ã€è´¨é‡åˆ†æã€å˜æ›´ç®¡ç†ã€æ ‡ç­¾ç®¡ç†ã€è´¨é‡æŠ¥å‘Šç®¡ç†ã€SPCã€åŸºç¡€é…ç½®ç­‰ æµ·å…‹æ–¯åº·ã€åä¼šã€ä¸‡ç‰©ã€å®‰å¿…å…´ã€äº‘è´¨ã€è¥¿é—¨å­ã€åº“å¾—å…‹ WMSï¼ˆä»“å‚¨ç®¡ç†ç³»ç»Ÿï¼‰Warehouse Management System æ˜¯ä¸€ä¸ªå®æ—¶çš„è®¡ç®—æœºè½¯ä»¶ç³»ç»Ÿï¼Œå®ƒèƒ½å¤ŸæŒ‰ç…§è¿ä½œçš„ä¸šåŠ¡è§„åˆ™å’Œè¿ç®—æ³•åˆ™ï¼Œå¯¹ä¿¡æ¯ã€èµ„æºã€è¡Œä¸ºã€å­˜è´§å’Œåˆ†é”€è¿ä½œè¿›è¡Œæ›´å®Œç¾åœ°ç®¡ç†ï¼Œæé«˜æ•ˆç‡ å…¥åº“ç®¡ç†ï¼šæ‰¹æ¬¡å…¥åº“/éƒ¨åˆ†å…¥åº“/é€€è´§å…¥åº“/ä¸€å“å¤šä½/ä¸€ä½å¤šå“/æ¨èä¸Šæ¶ã€‚åº“å­˜ç®¡ç†ï¼šåŠ¨æ€/å¾ªç¯ç›˜ç‚¹ï¼šåº“å­˜è°ƒæ•´/åº“å­˜ç§»åŠ¨ï¼šåº“å­˜è½¬ç§»ã€‚å‡ºåº“ç®¡ç†ï¼šè®¢å•åˆ†é…ï¼šä»»åŠ¡åŒ…è·é€‰/æ‰“å°å•ç®±/å¤šç®±å¤æ ¸ï¼šç§°é‡äº¤æ¥ã€‚ç®¡ç†å·¥å…·ï¼šåº“å­˜æµæ°´æŸ¥è¯¢/æ¥å£æµæ°´æŸ¥è¯¢/å…¥åº“å•å–æ¶ˆ/å‡ºå²¸å•å¼‚å¸¸å–æ¶ˆã€‚è§„åˆ™é…ç½®ï¼šè´§ä¸»/è´§ç±»æ‰¹æ¬¡è§„åˆ™åˆ†é…/ä¸Šæ¶/è¡¥è´§/æ³¢æ¬¡è§„åˆ™ä»»åŠ¡åŒ…/æ•°æ®æ¥æº/æ‰“å°æµç¨‹/åº—é“ºã€‚åŸºç¡€èµ„æ–™ï¼šè´§ä¸»/è´§ç±»/è´§å“ä»“åº“/å²¸åŒº/åº“ä½ï¼šç”¨æˆ·/è§’è‰² å¯Œå‹’ã€å·¨æ²ƒã€ç§‘ç®­ã€æ™®ç½—æ ¼ã€Infor TMSï¼ˆè¿è¾“ç®¡ç†ç³»ç»Ÿï¼‰Transportation Management System æ˜¯ä¸€ç§â€œä¾›åº”é“¾â€åˆ†ç»„ä¸‹çš„ï¼ˆåŸºäºç½‘ç»œçš„ï¼‰æ“ä½œè½¯ä»¶ã€‚å®ƒèƒ½é€šè¿‡å¤šç§æ–¹æ³•å’Œå…¶ä»–ç›¸å…³çš„æ“ä½œä¸€èµ·æé«˜ç‰©æµçš„ç®¡ç†èƒ½åŠ›ï¼›åŒ…æ‹¬ç®¡ç†è£…è¿å•ä½ï¼ŒæŒ‡å®šä¼ä¸šå†…ã€å›½å†…å’Œå›½å¤–çš„å‘è´§è®¡åˆ’ï¼Œç®¡ç†è¿è¾“æ¨¡å‹ã€åŸºå‡†å’Œè´¹ç”¨ï¼Œç»´æŠ¤è¿è¾“æ•°æ®ï¼Œç”Ÿæˆæå•ï¼Œä¼˜åŒ–è¿è¾“è®¡åˆ’ï¼Œé€‰æ‹©æ‰¿è¿äººåŠæœåŠ¡æ–¹å¼ï¼Œæ‹›æ ‡å’ŒæŠ•æ ‡ï¼Œå®¡è®¡å’Œæ”¯ä»˜è´§è¿è´¦å•ï¼Œå¤„ç†è´§æŸç´¢èµ”ï¼Œå®‰æ’åŠ³åŠ›å’Œåœºæ‰€ï¼Œç®¡ç†æ–‡ä»¶ï¼ˆå°¤å…¶å½“å›½é™…è¿è¾“æ—¶ï¼‰å’Œç®¡ç†ç¬¬ä¸‰æ–¹ç‰©æµ èµ„æºç®¡ç†ï¼ˆæ‰¿è¿å•†ç®¡ç†ã€å¸æœºç®¡ç†ã€è½¦è¾†ç®¡ç†ï¼‰ã€å®¢æˆ·ç®¡ç†ã€è¿è¾“ç®¡ç†ï¼ˆè®¢å•ç®¡ç†ã€è¿å•ç®¡ç†ã€é…è½½ä¸­å¿ƒã€å›å•ç®¡ç†ï¼‰ã€æŠ¥ä»·ç®¡ç†ã€åˆåŒç®¡ç†ã€ç»“ç®—ç®¡ç†ã€è´¢åŠ¡ç®¡ç†ã€é›†æˆç®¡ç†ç­‰ã€‚æ‰¿è¿å•†ç«¯ã€å¸æœºç«¯ å”¯æ™ºã€é€—å·ç§‘æŠ€ã€ç§‘ç®­ã€äº‘é¢†æ™ºèƒ½ã€åˆ›äº‘ç§‘æŠ€ã€ å¯Œå‹’ CMSï¼ˆå†…å®¹ç®¡ç†ç³»ç»Ÿï¼‰Content Management System æ˜¯ä¸€ç§ä½äºWEBå‰ç«¯ï¼ˆWebæœåŠ¡å™¨ï¼‰å’Œåç«¯åŠå…¬ç³»ç»Ÿæˆ–æµç¨‹ï¼ˆå†…å®¹åˆ›ä½œã€ç¼–è¾‘ï¼‰ä¹‹é—´çš„è½¯ä»¶ç³»ç»Ÿã€‚å†…å®¹çš„åˆ›ä½œäººå‘˜ã€ç¼–è¾‘äººå‘˜ã€å‘å¸ƒäººå‘˜ä½¿ç”¨å†…å®¹ç®¡ç†ç³»ç»Ÿæ¥æäº¤ã€ä¿®æ”¹ã€å®¡æ‰¹ã€å‘å¸ƒå†…å®¹ã€‚ æ ç›®ç®¡ç†ã€æ ‡ç­¾ç®¡ç†ã€æ–‡ç« ç®¡ç†ã€å¹¿å‘Šç®¡ç†ã€ç«™ç‚¹ç®¡ç†ã€ç´ æç®¡ç†ã€æ¨¡æ¿ç®¡ç† ç»‡æ¢¦ã€å‡¡ç§‘ã€å¸å›½ã€ WordPressã€Drupalã€Sitecore HRMï¼ˆäººåŠ›èµ„æºç®¡ç†ï¼‰Human Resource Management æ˜¯æŒ‡å¯¹ä¼ä¸šçš„äººåŠ›èµ„æºç®¡ç†æ–¹æ–¹é¢é¢è¿›è¡Œåˆ†æã€è§„åˆ’ã€å®æ–½ã€è°ƒæ•´ï¼Œæé«˜ä¼ä¸šäººåŠ›èµ„æºç®¡ç†æ°´å¹³çš„ä¸€æ¬¾äººåŠ›èµ„æºç®¡ç†è½¯ä»¶ï¼Œèƒ½å¤Ÿå¸®åŠ©ä¼ä¸šåœ¨æ­£ç¡®çš„æ—¶é—´é‡Œï¼Œé€‰æ‹©åˆ°æ­£ç¡®çš„äººï¼Œå®‰æ’åˆ°æ­£ç¡®çš„èŒä½ä¸Šï¼Œå‘æŒ¥å…¶æ­£ç¡®çš„ä½œç”¨ï¼Œä»è€Œå®ç°ä¼ä¸šæ­£ç¡®çš„æˆ˜ç•¥ç›®æ ‡å’Œæœ€å¤§åŒ–çš„ç»æµæ•ˆç›Š ç»„ç»‡ç®¡ç†ã€å‘˜å·¥ç®¡ç†ã€è€ƒå‹¤ç®¡ç†ã€æ‹›è˜ç®¡ç†ã€åŸ¹è®­ç®¡ç†ã€ç»©æ•ˆç®¡ç†ã€è–ªé…¬ç®¡ç†ã€åˆåŒæ¡£æ¡ˆç®¡ç†ç­‰ åŒ—æ£®ã€æ™ºè€…äº‘ã€æ‚Ÿç©º LIMSï¼ˆå®éªŒå®¤ä¿¡æ¯ç®¡ç†ç³»ç»Ÿï¼‰laboratory information management system æ˜¯ä»¥æ•°æ®åº“ä¸ºæ ¸å¿ƒçš„ä¿¡æ¯åŒ–æŠ€æœ¯ä¸å®éªŒå®¤ç®¡ç†éœ€æ±‚ç›¸ç»“åˆçš„ä¿¡æ¯åŒ–ç®¡ç†ç³»ç»Ÿ å§”æ‰˜ç®¡ç†ã€æ”¶æ ·ç®¡ç†ã€ä»»åŠ¡ç®¡ç†ã€æ ·å“æµè½¬ã€æŠ¥å‘Šç®¡ç†ã€è‡ªåŠ¨é‡‡é›†ã€è´¢åŠ¡å’Œå·¥èµ„ç®¡ç†ã€æ ‡ç­¾ç®¡ç†ã€è®¾å¤‡ç®¡ç†ã€å®éªŒå®¤æ•°æ®ç®¡ç† å…ƒå®‡ã€æ¾è™ã€èµ›å°ã€åšä»€å…°ã€ç™½ç ã€ç‰µç¿¼äº‘ BIï¼ˆå•†ä¸šæ™ºèƒ½ï¼‰Business Intelligence æŒ‡ç”¨ç°ä»£æ•°æ®ä»“åº“æŠ€æœ¯ã€çº¿ä¸Šåˆ†æå¤„ç†æŠ€æœ¯ã€æ•°æ®æŒ–æ˜å’Œæ•°æ®å±•ç°æŠ€æœ¯è¿›è¡Œæ•°æ®åˆ†æä»¥å®ç°å•†ä¸šä»·å€¼ è‡ªåŠ©åˆ†æã€å¯è§†åŒ–å¤§å±ã€ä¸­å›½å¼æŠ¥è¡¨ã€å¯è§†åŒ–ETL å¸†è½¯ã€smartBlã€powerBl OMSï¼ˆè®¢å•ç®¡ç†ç³»ç»Ÿï¼‰Ordering Management System æ˜¯æ¥å—å®¢æˆ·è®¢å•ä¿¡æ¯ï¼Œä»¥åŠä»“å‚¨ç®¡ç†ç³»ç»Ÿå‘æ¥çš„åº“å­˜ä¿¡æ¯ï¼Œç„¶åæŒ‰å®¢æˆ·å’Œç´§è¦ç¨‹åº¦ç»™è®¢å•å½’ç±»ï¼Œå¯¹ä¸åŒä»“å‚¨åœ°ç‚¹çš„åº“å­˜è¿›è¡Œé…ç½®ï¼Œå¹¶ç¡®å®šäº¤ä»˜æ—¥æœŸçš„ç³»ç»Ÿ è®¢å•ç®¡ç†ã€è¥é”€ç®¡æ§ã€å•†å“ç®¡ç†ã€åº“å­˜ç®¡ç†ã€åˆ†é”€ç®¡ç†ã€ç»“ç®—ç®¡æ§ã€é…é€å¼‚å¸¸å¤„ç†è®¢å•æ‹†åˆ†åˆå¹¶ã€å‘ç¥¨ç®¡ç† å•†æ´¾ã€å·¨ç›Šã€ç™¾èƒœ SCADA (ç›‘æ§æ§åˆ¶ä¸æ•°æ®è·å–)Supervisory Control And Data Aquisition å·¥å‚é‡Œçš„è®¾å¤‡ç§ç±»å¤šã€æ•°é‡å¤šï¼ŒSCADAç³»ç»Ÿå…·æœ‰é‡‡é›†ã€æ§åˆ¶åˆ†æ•£ï¼›ç®¡ç†é›†ä¸­çš„â€œé›†æ•£æ§åˆ¶ç³»ç»Ÿâ€çš„ç‰¹å¾ã€‚ SCADAå¯ä»¥ç†è§£ä¸ºä¸åŒå‚å®¶çš„ç®¡ç†ç›‘æ§ç³»ç»Ÿï¼ˆä¸Šä½ï¼‰å¯¹æ§åˆ¶éƒ¨åˆ†ï¼ˆä¸‹ä½ï¼‰çš„æ•°æ®é‡‡é›†ä¸ç›‘æ§ç®¡ç† è¥¿é—¨å­ï¼ˆSiemensï¼‰,æ¬§å§†é¾™ï¼ˆOmronï¼‰,ä¸‰è±ç”µæœºï¼ˆMitsubishi Electricï¼‰ ,å¨å›¾ï¼ˆWonderwareï¼‰ è¿›é”€å­˜ ç§°ä¸ºè´­é”€é“¾ï¼Œæ˜¯æŒ‡ä¼ä¸šç®¡ç†è¿‡ç¨‹ä¸­é‡‡è´­ï¼ˆè¿›ï¼‰-å…¥åº“ï¼ˆå­˜ï¼‰-é”€å”®ï¼ˆé”€ï¼‰çš„åŠ¨æ€ç®¡ç†è¿‡ç¨‹ã€‚è¿›ï¼šæŒ‡è¯¢ä»·ã€é‡‡è´­åˆ°å…¥åº“ä¸ä»˜æ¬¾çš„è¿‡ç¨‹ã€‚é”€ï¼šæŒ‡æŠ¥ä»·ã€é”€å”®åˆ°å‡ºåº“ä¸æ”¶æ¬¾çš„è¿‡ç¨‹ã€‚å­˜ï¼šæŒ‡é™¤å…¥åº“ä¹‹å¤–ï¼ŒåŒ…æ‹¬é¢†æ–™ã€é€€è´§ã€ç›˜ç‚¹ã€æŸç›Šã€å€Ÿå…¥ã€å€Ÿå‡ºã€è°ƒæ‹¨ç­‰å½±å“åº“å­˜æ•°é‡çš„åŠ¨ä½œ é‡‡è´­ç®¡ç†ã€é”€å”®ç®¡ç†ã€åº“å­˜ç®¡ç†ã€èµ„é‡‘ç®¡ç† ç®¡å®¶å©†ã€ç”¨å‹å¥½ç”Ÿæ„ã€é‡‘è¶ç²¾æ–—äº‘ã€ç™½è‰è¿›é”€å­˜ åœ¨çº¿å®¢æœç³»ç»Ÿ åœ¨çº¿å®¢æœæˆ–ç§°åšç½‘ä¸Šå‰å°æ˜¯ä¸€ç§ä»¥ç½‘ç«™ä¸ºåª’ä»‹ï¼Œå‘äº’è”ç½‘è®¿å®¢ä¸ç½‘ç«™å†…éƒ¨å‘˜å·¥æä¾›å³æ—¶æ²Ÿé€šçš„é¡µé¢é€šä¿¡æŠ€æœ¯ã€‚åœ¨çº¿å®¢æœæ˜¯ç½‘ç»œè¥é”€çš„åŸºç¡€ æ¸ é“æ¥å…¥ã€ä¼šè¯åˆ†é…ã€åå¸­ç®¡ç†ã€æ—¥ç¨‹ç®¡ç†ã€å¿«æ·å›å¤ã€çŸ¥è¯†åº“ç®¡ç†ã€å·¥å•ç³»ç»Ÿã€æ™ºèƒ½å®¢æœã€å‘¼å«ä¸­å¿ƒ å®¹è”ä¸ƒé™Œã€ç½‘æ˜“ä¸ƒé±¼ã€æ™ºé½¿å®¢æœã€å¿«å•†é€š MESï¼ˆåˆ¶é€ æ‰§è¡Œç³»ç»Ÿï¼‰ PLMï¼ˆäº§å“ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼‰ ERPï¼ˆä¼ä¸šèµ„æºè§„åˆ’ï¼‰ SCMï¼ˆä¾›åº”é“¾ç®¡ç†ï¼‰ WMSï¼ˆä»“åº“ç®¡ç†ç³»ç»Ÿï¼‰ APSï¼ˆé«˜çº§è®¡åˆ’å’Œæ’ç¨‹ï¼‰ SCADAï¼ˆç›‘æ§æ§åˆ¶ä¸æ•°æ®è·å–ï¼‰ QMSï¼ˆè´¨é‡ç®¡ç†ç³»ç»Ÿï¼‰ CRMï¼ˆå®¢æˆ·å…³ç³»ç®¡ç†ï¼‰ EAMï¼ˆä¼ä¸šèµ„äº§ç®¡ç†ï¼‰ è¿™äº›ç³»ç»Ÿå„è‡ªé’ˆå¯¹ä¼ä¸šçš„ä¸åŒè¿è¥æ–¹é¢æä¾›ä¸“é—¨çš„ç®¡ç†å’Œæ§åˆ¶åŠŸèƒ½ã€‚å®ƒä»¬å¯ä»¥ç›¸äº’è¡¥å……å’Œé›†æˆï¼Œå½¢æˆä¸€ä¸ªå…¨é¢ã€é«˜æ•ˆå’ŒååŒçš„ä¼ä¸šè¿è¥ç¯å¢ƒã€‚ ERP å’Œå…¶ä»–ç³»ç»Ÿï¼šERP ç³»ç»Ÿæ˜¯ä¼ä¸šçš„ä¸­æ¢ï¼Œè´Ÿè´£æ•´åˆè´¢åŠ¡ã€äººåŠ›èµ„æºã€ç”Ÿäº§ã€ä¾›åº”é“¾ã€é”€å”®ç­‰æ–¹é¢çš„ä¿¡æ¯ã€‚å®ƒä¸ MESã€WMSã€SCM ç­‰ç³»ç»Ÿé›†æˆï¼Œä»¥è·å–ç”Ÿäº§ç°åœºçš„å®æ—¶æ•°æ®ã€åº“å­˜ä¿¡æ¯å’Œä¾›åº”é“¾çŠ¶æ€ï¼Œå®ç°ä¼ä¸šèµ„æºçš„æœ‰æ•ˆè§„åˆ’å’Œç®¡ç†ã€‚ MES å’Œ ERP/SCADAï¼šMES ç›´æ¥ä¸ç”Ÿäº§çº¿æ“ä½œç›¸å…³ï¼Œå®ƒæ¡¥æ¥äº† ERP ç³»ç»Ÿå’Œç”Ÿäº§è¿‡ç¨‹ï¼Œæä¾›è½¦é—´å±‚é¢çš„å®æ—¶æ•°æ®ç»™ ERP ç³»ç»Ÿï¼ŒåŒæ—¶ä» SCADA ç³»ç»Ÿæ”¶é›†è®¾å¤‡å’Œè¿‡ç¨‹æ•°æ®ï¼Œä»¥ä¼˜åŒ–ç”Ÿäº§æ‰§è¡Œã€‚ SCM å’Œ ERP/WMSï¼šSCM ç³»ç»Ÿç®¡ç†ä¾›åº”é“¾çš„å„ä¸ªç¯èŠ‚ï¼Œä»åŸææ–™é‡‡è´­åˆ°æˆå“äº¤ä»˜ã€‚å®ƒä¸ ERP ç³»ç»Ÿé›†æˆï¼Œä»¥ç¡®ä¿è´¢åŠ¡å’Œè®¢å•ç®¡ç†çš„ä¸€è‡´æ€§ï¼›ä¸ WMS é›†æˆï¼Œä¼˜åŒ–åº“å­˜ç®¡ç†å’Œç‰©æµæ“ä½œã€‚ WMS å’Œ ERP/SCMï¼šWMS è´Ÿè´£ç®¡ç†ä»“åº“å†…çš„ç‰©æµæ´»åŠ¨ï¼Œä¸ ERP ç³»ç»Ÿé›†æˆå¯ä»¥ç¡®ä¿åº“å­˜æ•°æ®çš„å‡†ç¡®æ€§å’ŒåŠæ—¶æ›´æ–°ï¼Œä¸ SCM é›†æˆåˆ™æ”¯æŒæ•´ä¸ªä¾›åº”é“¾çš„æ•ˆç‡ã€‚ APS å’Œ ERP/MESï¼šAPS ä¸ºç”Ÿäº§è®¡åˆ’å’Œæ’ç¨‹æä¾›é«˜çº§åŠŸèƒ½ï¼Œä¸ ERP ç³»ç»Ÿé›†æˆå¯ä»¥ç¡®ä¿ç”Ÿäº§è®¡åˆ’çš„èµ„æºå¯ç”¨æ€§ï¼Œä¸ MES é›†æˆåˆ™å¯ä¼˜åŒ–ç”Ÿäº§è¿‡ç¨‹çš„æ‰§è¡Œã€‚ PLM å’Œ ERP/QMSï¼šPLM ç®¡ç†äº§å“ä»æ¦‚å¿µåˆ°é€€å¸‚çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œå®ƒä¸ ERP ç³»ç»Ÿé›†æˆï¼Œç¡®ä¿äº§å“ä¿¡æ¯åœ¨ä¼ä¸šå†…éƒ¨å…±äº«ï¼›ä¸ QMS é›†æˆåˆ™ä¿è¯äº§å“è´¨é‡çš„ç®¡ç†å’Œç›‘æ§ã€‚ QMS å’Œ ERP/PLMï¼šQMS ç¡®ä¿äº§å“å’ŒæœåŠ¡æ»¡è¶³è´¨é‡æ ‡å‡†å’Œå®¢æˆ·è¦æ±‚ï¼Œä¸ ERP é›†æˆå¯æå‡è´¨é‡æ•°æ®çš„è´¢åŠ¡å’Œè¿è¥ç®¡ç†ï¼Œä¸ PLM é›†æˆåˆ™æ”¯æŒäº§å“å¼€å‘å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†çš„è´¨é‡æ§åˆ¶ã€‚ CRM å’Œ ERPï¼šCRM ç³»ç»Ÿç®¡ç†å®¢æˆ·ä¿¡æ¯å’Œäº’åŠ¨ï¼Œä¸ ERP ç³»ç»Ÿé›†æˆå¯ä»¥æé«˜å®¢æˆ·è®¢å•çš„å¤„ç†æ•ˆç‡å’Œè´¢åŠ¡ç®¡ç†ã€‚ EAM å’Œ ERP/SCADAï¼šEAM ç³»ç»Ÿç®¡ç†ä¼ä¸šçš„ç‰©ç†èµ„äº§ï¼Œä¸ ERP ç³»ç»Ÿé›†æˆå¯ä»¥ä¼˜åŒ–è´¢åŠ¡å’Œè¿è¥å†³ç­–ï¼Œä¸ SCADA é›†æˆåˆ™å¯ä»¥å®æ—¶ç›‘æ§è®¾å¤‡çŠ¶æ€å’Œç»´æŠ¤éœ€æ±‚ã€‚ SCADAå…¸å‹æ¶æ„ å…¸å‹çš„SCADAåƒä¸‹å›¾ï¼Œåˆ†ä¸ºåœºç«™ç«¯å’Œç®¡ç†ç«¯ã€‚ åœºç«™ç«¯ï¼šä¸»è¦æ˜¯ä¸‰éƒ¨åˆ†ï¼šä¸‹ä½æœºã€é€šä¿¡ç½‘ç»œã€ä¸Šä½æœºã€‚ ç®¡ç†ç«¯ï¼šä¸€èˆ¬åŒ…æ‹¬å‰ç½®é‡‡é›†ã€SCADAåº”ç”¨ã€‚ åœºç«™ç«¯ï¼š ä¸‹ä½æœºï¼šä¾§é‡é‡‡é›†å’Œæ§åˆ¶ã€‚ä¸€èˆ¬ç”±RTUå’ŒPLCç»„æˆã€‚ é€šä¿¡ç½‘ç»œï¼šå®ç°ä¸Šã€ä¸‹ä½æœºä¹‹é—´æ•°æ®äº¤æµã€‚ ä¸Šä½æœºï¼šä¾§é‡ç›‘æ§åŠŸèƒ½ã€‚ä¸€èˆ¬ç”±ç”µè„‘å’ŒæœåŠ¡ç»„æˆï¼Œä¸»è¦èµ·åˆ°è¿œç¨‹ç›‘æ§ã€æŠ¥è­¦å¤„ç†ã€æ•°æ®å­˜å‚¨ä»¥åŠä¸å…¶ä»–ç³»ç»Ÿé›†åˆçš„ä½œç”¨ã€‚ å·¥å‚ç€é‡å…³é”®å‚æ•° LOB(LineOf Balance)ï¼šæ˜¯ç”Ÿäº§çº¿å¹³è¡¡çš„å®šä¹‰ã€‚ å½“ä¸€ä¸ªæµç¨‹ä¸­å„ä¸ªå·¥åºçš„èŠ‚æ‹ä¸ä¸€è‡´æ—¶ï¼Œç“¶é¢ˆå·¥åºä»¥å¤–çš„å…¶å®ƒå·¥åºå°±ä¼šäº§ç”Ÿç©ºé—²æ—¶é—´ï¼Œ è¿™å°±éœ€è¦å¯¹ç”Ÿäº§å·¥è‰ºè¿›è¡Œå¹³è¡¡ã€‚ å…¬å¼ä¸€ï¼š LOB=Î£å·¥åºèŠ‚æ‹/ç“¶é¢ˆå·¥åºèŠ‚æ‹/å·¥åºæ•° æ³¨ï¼š 1ã€è‡ªåŠ¨çº¿ä¸€èˆ¬åº”æŒ‰ç…§å¤šä¸ªå·¥åºæ¥è®¡ç®—ï¼› 2ã€ä¸€ä¸ªå·¥åºæœ‰å¤šå°‘è®¾å¤‡å’Œå¤šå°‘äººä»¥ç†è®ºå®‰æ’ä¸ºå‡† 3ã€è½¬æ¢å§¿æ€ç±»çš„è¾…åŠ©è®¾å¤‡ä¸ä½œä¸ºç‹¬ç«‹å·¥åºè€ƒè™‘ (å¦‚ç¿»è½¬æœº) 4ã€æ„ä¹‰ï¼šè¯„ä»·ç”Ÿäº§çº¿å¸ƒå±€çš„åˆç†æ€§ï¼Œåæ˜ å·¥åºå¹³è¡¡çŠ¶å†µ 5ã€é€‚ç”¨èŒƒå›´ï¼šä¸»è¦ç”¨äºç”Ÿäº§çº¿è®¾è®¡ã€è®¾å¤‡å¸ƒå±€æ—¶ï¼Œæˆ–è€…åæœŸå¯¹ç”Ÿäº§çº¿è®¾è®¡è¿›è¡Œè¯„ä»· å…¬å¼äºŒï¼š LOB=Î£å²—ä½èŠ‚æ‹/ç“¶é¢ˆå²—ä½èŠ‚æ‹/å²—ä½æ•° æ³¨ï¼š 1ã€æ„ä¹‰ï¼šè¯„ä»·å²—ä½è®¾ç½®çš„åˆç†æ€§ï¼Œååº”å²—ä½èŠ‚æ‹å¹³è¡¡çŠ¶å†µ 2ã€é€‚ç”¨èŒƒå›´ï¼šä¸»è¦ç”¨äºç”Ÿäº§çº¿å²—ä½è®¾ç½®ï¼Œå¯ä»¥éšéœ€æ±‚å˜åŒ–(èŠ‚æ‹æ—¶é—´Takt time)è¿›è¡Œä¸€å®šç¨‹åº¦ä¸Šçš„å˜åŒ–ã€‚ å…¬å¼ä¸‰ï¼š LOB=Î£(å²—ä½èŠ‚æ‹Ã—å²—ä½äººæ•°)/ç“¶é¢ˆå²—ä½èŠ‚æ‹/æ€»äººæ•° æ³¨ï¼š 1ã€ä¸€ä¸ªå²—ä½æœ‰å¤šäººçš„ï¼Œæ¯äººéƒ½æŒ‰ç…§1ä¸ªå²—ä½èŠ‚æ‹çº³å…¥è®¡ç®— 2ã€æ„ä¹‰ï¼šè¯„ä»·ä½œä¸šäººå‘˜å®‰æ’åˆç†æ€§ï¼Œåæ˜ çš„ä½œä¸šäººå‘˜èŠ‚æ‹å¹³è¡¡çŠ¶å†µ(å«è®¾å¤‡ï¼‰ 3ã€é€‚ç”¨èŒƒå›´ï¼šä¸»è¦ç”¨äºäººå‘˜å®‰æ’ï¼Œå¯ä»¥éšéœ€æ±‚å˜åŒ–(èŠ‚æ‹æ—¶é—´Takt time)è¿›è¡Œä¸€å®šç¨‹åº¦ä¸Šçš„å˜åŒ– ç“¶é¢ˆCT(Cycle Time)ï¼šç“¶é¢ˆå¾ªç¯æ—¶é—´ åªè¦äº§å“æ˜¯ç»è¿‡å¤šé“å·¥åºåŠ å·¥çš„ï¼Œå¿…ç„¶æœ‰ä¸€é“å·¥åºäº§èƒ½æœ€ä½ï¼Œè¿™é“å·¥åºå°±æ˜¯ç”Ÿäº§ç“¶é¢ˆã€‚ç“¶é¢ˆå·¥åºåŠ å·¥ä¸€ä»¶äº§å“çš„å¾ªç¯æ—¶é—´ï¼ˆCycle Timeï¼‰ç§°ä¹‹ä¸ºç“¶é¢ˆCTã€‚ OEE(Overall Equipment Effectiveness)ï¼šè®¾å¤‡ç»¼åˆæ•ˆç‡ ä¸€èˆ¬ï¼Œæ¯ä¸€ä¸ªç”Ÿäº§è®¾å¤‡éƒ½æœ‰è‡ªå·±çš„ç†è®ºäº§èƒ½ï¼Œè¦å®ç°è¿™ä¸€ç†è®ºäº§èƒ½å¿…é¡»ä¿è¯æ²¡æœ‰ä»»ä½•å¹²æ‰°å’Œè´¨é‡æŸè€—ã€‚OEEå°±æ˜¯ç”¨æ¥è¡¨ç°å®é™…çš„ç”Ÿäº§èƒ½åŠ›ç›¸å¯¹äºç†è®ºäº§èƒ½çš„æ¯”ç‡ï¼Œå®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æµ‹é‡å·¥å…·ã€‚ OEEæ˜¯ç”±å¯ç”¨ç‡ï¼Œè¡¨ç°æ€§ä»¥åŠè´¨é‡æŒ‡æ•°ä¸‰ä¸ªå…³é”®è¦ç´ ç»„æˆï¼š OEE=å¯ç”¨ç‡Ã—è¡¨ç°æŒ‡æ•°Ã—è´¨é‡æŒ‡æ•° å…¶ä¸­ï¼š å¯ç”¨ç‡=æ“ä½œæ—¶é—´/è®¡åˆ’å·¥ä½œæ—¶é—´ å®ƒæ˜¯ç”¨æ¥è¯„ä»·åœå·¥æ‰€å¸¦æ¥çš„æŸå¤±ï¼ŒåŒ…æ‹¬å¼•èµ·è®¡åˆ’ç”Ÿäº§å‘ç”Ÿåœå·¥çš„ä»»ä½•äº‹ä»¶ï¼Œä¾‹å¦‚è®¾å¤‡æ•…éšœï¼ŒåŸææ–™çŸ­ç¼ºä»¥åŠç”Ÿäº§æ–¹æ³•çš„æ”¹å˜ç­‰ã€‚ è¡¨ç°æŒ‡æ•°=ç†æƒ³å‘¨æœŸæ—¶é—´/å®é™…å‘¨æœŸæ—¶é—´=ç†æƒ³å‘¨æœŸæ—¶é—´/ï¼ˆæ“ä½œæ—¶é—´/æ€»äº§é‡ï¼‰=ï¼ˆæ€»äº§é‡/æ“ä½œæ—¶é—´ï¼‰/ç”Ÿäº§é€Ÿç‡ è¡¨ç°æ€§æ˜¯ç”¨æ¥è¯„ä»·ç”Ÿäº§é€Ÿåº¦ä¸Šçš„æŸå¤±ã€‚åŒ…æ‹¬ä»»ä½•å¯¼è‡´ç”Ÿäº§ä¸èƒ½ä»¥æœ€å¤§é€Ÿåº¦è¿è¡Œçš„å› ç´ ï¼Œä¾‹å¦‚è®¾å¤‡çš„ç£¨æŸï¼Œææ–™çš„ä¸åˆæ ¼ä»¥åŠæ“ä½œäººå‘˜çš„å¤±è¯¯ç­‰ã€‚ è´¨é‡æŒ‡æ•°=è‰¯å“/æ€»äº§é‡ è´¨é‡æŒ‡æ•°æ˜¯ç”¨æ¥è¯„ä»·è´¨é‡çš„æŸå¤±ï¼Œå®ƒç”¨æ¥åæ˜ æ²¡æœ‰æ»¡è¶³è´¨é‡è¦æ±‚çš„äº§å“ï¼ˆåŒ…æ‹¬è¿”å·¥çš„äº§å“ï¼‰ã€‚ OEEçš„å¦ä¸€ç§è®¡ç®—å…¬å¼ OEE=æ—¶é—´å¼€åŠ¨ç‡Ã—æ€§èƒ½å¼€åŠ¨ç‡Ã—åˆæ ¼å“ç‡ å…¶ä¸­ï¼Œæ—¶é—´å¼€åŠ¨ç‡ = å¼€åŠ¨æ—¶é—´/è´Ÿè·æ—¶é—´ è€Œï¼Œè´Ÿè·æ—¶é—´ = æ—¥å†å·¥ä½œæ—¶é—´-è®¡åˆ’åœæœºæ—¶é—´ å¼€åŠ¨æ—¶é—´ = è´Ÿè·æ—¶é—´ - æ•…éšœåœæœºæ—¶é—´ - è®¾å¤‡è°ƒæ•´åˆå§‹åŒ–æ—¶é—´ï¼ˆåŒ…æ‹¬æ›´æ¢äº§å“è§„æ ¼ã€æ›´æ¢å·¥è£…æ¨¡å…·ã€æ›´æ¢åˆ€å…·ç­‰æ´»åŠ¨æ‰€ç”¨æ—¶é—´ï¼‰ æ€§èƒ½å¼€åŠ¨ç‡ = å‡€å¼€åŠ¨ç‡Ã—é€Ÿåº¦å¼€åŠ¨ç‡ è€Œï¼Œå‡€å¼€åŠ¨ç‡ = åŠ å·¥æ•°é‡Ã—å®é™…åŠ å·¥å‘¨æœŸ/å¼€åŠ¨æ—¶é—´ é€Ÿåº¦å¼€åŠ¨ç‡ = ç†è®ºåŠ å·¥å‘¨æœŸ/å®é™…åŠ å·¥å‘¨æœŸ åˆæ ¼å“ç‡ = åˆæ ¼å“æ•°é‡/ åŠ å·¥æ•°é‡ å…¨å±€è®¾å¤‡æ•ˆç‡OEEæ˜¯ä¸€ç§ç®€å•å®ç”¨çš„ç”Ÿäº§ç®¡ç†å·¥å…·ï¼Œåœ¨æ¬§ç¾çš„åˆ¶é€ ä¸šå’Œä¸­å›½çš„è·¨å›½ä¼ä¸šä¸­å·²å¾—åˆ°å¹¿æ³›çš„åº”ç”¨ï¼Œå…¨å±€è®¾å¤‡æ•ˆç‡æŒ‡æ•°å·²æˆä¸ºè¡¡é‡ä¼ä¸šç”Ÿäº§æ•ˆç‡çš„é‡è¦æ ‡å‡†ï¼Œä¹Ÿæ˜¯TPMï¼ˆTotal Productive Maintenanceï¼‰å®æ–½çš„é‡è¦æ‰‹æ³•ä¹‹ä¸€ã€‚ ","link":"https://tianxiawuhao.github.io/EJTDQH5ex/"},{"title":"jenkinsé›†æˆç¼–è¯‘å‘å¸ƒ","content":"å®‰è£…jdk17 1 æ‰“å¼€è™šæ‹Ÿæœº åˆ›å»ºjdkçš„ç›®å½• mkdir /home/jdk17 2 ä¸‹è½½jdk17å¹¶å°†å…¶æ”¾åˆ°æˆ‘ä»¬æ‰€å»ºç«‹çš„ç›®å½•ä¸­ wget https://download.oracle.com/java/17/latest/jdk-17_linux-x64_bin.tar.gz -P /home/jdk17/ 3 è§£å‹æ–‡ä»¶ tar xf /home/jdk17/jdk-17_linux-x64_bin.tar.gz -C /home/jdk17/ 4 æŸ¥çœ‹å®‰è£…çš„jdkå…·ä½“çš„ç‰ˆæœ¬æ˜¯ä»€ä¹ˆ ls /home/jdk17/ 5 ä¿®æ”¹ç¯å¢ƒå˜é‡ vim /etc/profile æ³¨æ„javahomeçš„è·¯å¾„æ˜¯æˆ‘ä»¬åˆšåˆšè®¾ç½®çš„ï¼Œé‚£ä¸ªæ–‡ä»¶å¤¹ #jdk17 export JAVA_HOME=/home/jdk17/jdk-17.0.10 export CLASSPATH=.:$JAVA_HOME/lib/tools.jar:$JAVA_HOME/lib/dt.jar export PATH=$JAVA_HOME/bin:$PATH åˆ·æ–°ç¯å¢ƒå˜é‡ source /etc/profile 6 æµ‹è¯•æ˜¯å¦å®‰è£…æˆåŠŸ java -version å®‰è£…maven 1 åˆ›å»ºjdkçš„ç›®å½• mkdir /home/maven 2 ä¸‹è½½jdk17å¹¶å°†å…¶æ”¾åˆ°æˆ‘ä»¬æ‰€å»ºç«‹çš„ç›®å½•ä¸­ wget https://mirrors.tuna.tsinghua.edu.cn/apache/maven/maven-3/3.8.4/binaries/apache-maven-3.8.4-bin.tar.gz -P /home/maven/ æˆ–è€…å»å®˜ç½‘ä¸‹è½½ Maven â€“ Download Apache Maven 3 è§£å‹æ–‡ä»¶ tar xf /home/maven/apache-maven-3.8.4-bin.tar.gz -C /home/maven/ 4 æŸ¥çœ‹å®‰è£…çš„jdkå…·ä½“çš„ç‰ˆæœ¬æ˜¯ä»€ä¹ˆ cd /home/maven/ ls 5 ä¿®æ”¹ç¯å¢ƒå˜é‡ vim /etc/profile æ³¨æ„javahomeçš„è·¯å¾„æ˜¯æˆ‘ä»¬åˆšåˆšè®¾ç½®çš„ï¼Œé‚£ä¸ªæ–‡ä»¶å¤¹ #maven export MAVEN_HOME=/home/maven/apache-maven-3.8.8 export PATH=$MAVEN_HOME/bin:$PATH åˆ·æ–°ç¯å¢ƒå˜é‡ source /etc/profile 6 æµ‹è¯•æ˜¯å¦å®‰è£…æˆåŠŸ mvn -version 7 ä¿®æ”¹æ•°æ®æº vim conf/settings.xml æ·»åŠ æ•°æ®æº &lt;!--é˜¿é‡Œäº‘é•œåƒ--&gt; &lt;mirror&gt; &lt;id&gt;nexus-aliyun&lt;/id&gt; &lt;mirrorOf&gt;central&lt;/mirrorOf&gt; &lt;name&gt;Nexus aliyun&lt;/name&gt; &lt;url&gt;https://maven.aliyun.com/repository/public&lt;/url&gt; &lt;/mirror&gt; &lt;mirror&gt; &lt;id&gt;repo2&lt;/id&gt; &lt;name&gt;Mirror from Maven Repo2&lt;/name&gt; &lt;url&gt;https://repo.maven.apache.org/maven2/&lt;/url&gt; &lt;mirrorOf&gt;central&lt;/mirrorOf&gt; &lt;/mirror&gt; &lt;mirror&gt; &lt;id&gt;ui&lt;/id&gt; &lt;name&gt;Mirror from UK&lt;/name&gt; &lt;url&gt;http://uk.maven.org/maven2/&lt;/url&gt; &lt;mirrorOf&gt;central&lt;/mirrorOf&gt; &lt;/mirror&gt; &lt;mirror&gt; &lt;id&gt;jboss-public-repository-group&lt;/id&gt; &lt;mirrorOf&gt;central&lt;/mirrorOf&gt; &lt;name&gt;JBoss Public Repository Group&lt;/name&gt; &lt;url&gt;http://repository.jboss.org/nexus/content/groups/public&lt;/url&gt; &lt;/mirror&gt; å®‰è£…git yum install git 1 é…ç½®ç”¨æˆ·åå’Œé‚®ç®±ï¼š git config --global user.name &quot;Your Name&quot; git config --global user.email &quot;your-email@example.com&quot; 2 æŸ¥çœ‹é…ç½®ä¿¡æ¯ï¼š git config --list ä»¥ä¸Šå‘½ä»¤å°†åˆ—å‡ºå½“å‰Gitçš„é…ç½®ä¿¡æ¯ã€‚ å®‰è£…jenkins 1 æŸ¥è¯¢é•œåƒ docker search jenkins 2 ä¸‹è½½é•œåƒ docker pull jenkins/jenkins 3 ç¼–å†™docker-compose.yml version : '3' services: jenkins: user: root restart: always image: jenkins/jenkins container_name: jenkins ports: - 8080:8080 - 50000:50000 volumes: - /home/jenkins/jenkins_home/:/var/jenkins_home/ - /var/run/docker.sock:/var/run/docker.sock - /usr/bin/docker:/usr/bin/docker - /home/jdk17/jdk-17.0.10:/home/jdk17/jdk-17.0.10 - /home/maven/apache-maven-3.8.8:/home/maven/apache-maven-3.8.8 - /root/.ssh:/root/.ssh docker run -di -p 8080:8080 -p 50000:50000 --name jenkins --restart=always -v /home/jenkins/jenkins_home/:/var/jenkins_home/ -v /var/run/docker.sock:/var/run/docker.sock -v/usr/bin/docker:/usr/bin/docker -v /home/jdk17/jdk-17.0.10:/home/jdk17/jdk-17.0.10 -v /home/maven/apache-maven-3.8.8:/home/maven/apache-maven-3.8.8 -v /root/.ssh:/root/.ssh jenkins/jenkins 5 è®¾ç½®æƒé™ chown -R 1000:1000 /home/jenkins/jenkins_home chown -R 1000:1000 /home/maven é»˜è®¤æƒ…å†µä¸‹ï¼Œdocker å‘½ä»¤ä¼šä½¿ç”¨ Unix socket ä¸ Docker å¼•æ“é€šè®¯ã€‚è€Œåªæœ‰ root ç”¨æˆ·å’Œ docker ç»„çš„ç”¨æˆ·æ‰å¯ä»¥è®¿é—® Docker å¼•æ“çš„ Unix socketã€‚å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œä¸€èˆ¬ Linux ç³»ç»Ÿä¸Šä¸ä¼šç›´æ¥ä½¿ç”¨ root ç”¨æˆ·ã€‚å³æˆ‘ä»¬å½“å‰çš„ç”¨æˆ·ä¸æ˜¯rootç”¨æˆ·ã€‚ è§£å†³åŠæ³•ï¼šæŠŠæˆ‘ä»¬å½“å‰çš„ç”¨æˆ·æ·»åŠ åˆ°dockerç»„ä¸­å°±å¯ä»¥äº†ã€‚ ç¬¬ä¸€æ­¥ï¼šsudo gpasswd -a username docker #å°†æ™®é€šç”¨æˆ·usernameåŠ å…¥åˆ°dockerç»„ä¸­ï¼Œusernameè¿™ä¸ªå­—æ®µä¹Ÿå¯ä»¥ç›´æ¥æ¢æˆ$USERã€‚ ç¬¬äºŒæ­¥ï¼šnewgrp docker #æ›´æ–°dockerç»„ 4 å¯åŠ¨å®¹å™¨ Jenkinséœ€è¦ä¸‹è½½å¤§é‡å†…å®¹ï¼Œä½†æ˜¯ç”±äºé»˜è®¤ä¸‹è½½åœ°å€ä¸‹è½½é€Ÿåº¦è¾ƒæ…¢ï¼Œå¦‚æœ‰éœ€è¦å¯ä»¥è®¾ç½®ä¸‹è½½åœ°å€ä¸ºå›½å†…é•œåƒç«™ cd /home/jenkins/jenkins_home/ cat hudson.model.UpdateCenter.xml ä¿®æ”¹æ•°æ®å·ä¸­çš„hudson.model.UpdateCenter.xmlæ–‡ä»¶ # ä¿®æ”¹æ•°æ®å·ä¸­çš„hudson.model.UpdateCenter.xmlæ–‡ä»¶ &lt;?xml version='1.1' encoding='UTF-8'?&gt; &lt;sites&gt; &lt;site&gt; &lt;id&gt;default&lt;/id&gt; &lt;url&gt;https://updates.jenkins.io/update-center.json&lt;/url&gt; &lt;/site&gt; &lt;/sites&gt; # å°†ä¸‹è½½åœ°å€æ›¿æ¢ä¸ºhttp://mirror.esuni.jp/jenkins/updates/update-center.json &lt;?xml version='1.1' encoding='UTF-8'?&gt; &lt;sites&gt; &lt;site&gt; &lt;id&gt;default&lt;/id&gt; &lt;url&gt;http://mirror.esuni.jp/jenkins/updates/update-center.json&lt;/url&gt; &lt;/site&gt; &lt;/sites&gt; # æ¸…åå¤§å­¦çš„æ’ä»¶æºä¹Ÿå¯ä»¥https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json 4 å¯åŠ¨å®¹å™¨ #åœ¨docker-compose.ymlæ‰€åœ¨ç›®å½•å¯åŠ¨ docker-compose up -d jenkins 5 è®¿é—®jenkins 1ã€å¯åŠ¨ä¹‹åä½¿ç”¨http://ip:ç«¯å£è®¿é—®jenkinsã€‚ å¤åˆ¶ç®¡ç†å‘˜å¯†ç  [root@localhost ROOT]# cat /root/.jenkins/secrets/initialAdminPassword 86b8a38ce6d44c12941b86a727b7dcc8 æ›´æ–°jenkins 1 ä¸‹è½½æœ€æ–°çš„waråŒ… https://mirrors.jenkins.io/war-stable/ 2 æ‹·è´æ›¿æ¢ [root@iZ8vbi9mx98t2q4hbta56aZ war]# docker cp jenkins.war jenkins:/root/ [root@iZ8vbi9mx98t2q4hbta56aZ war]# docker exec -u root -it jenkins bash [root@47faa9548aa0 /]# cd /root/ [root@47faa9548aa0 ~]# ps -ef|grep java jenkins 7 1 0 Mar12 ? 00:04:22 java -Duser.home=/var/jenkins_home -Djenkins.model.Jenkins.slaveAgentPort=50000 -jar /usr/share/jenkins/jenkins.war root 1012 994 0 16:35 pts/0 00:00:00 grep --color=auto java [root@47faa9548aa0 ~]# cd /usr/share/jenkins/ [root@47faa9548aa0 jenkins]# cp jenkins.war jenkins.war.22.3.17.bak [root@47faa9548aa0 jenkins]# ls jenkins.war jenkins.war.22.3.17.bak ref [root@47faa9548aa0 jenkins]# mkdir other-version [root@47faa9548aa0 jenkins]# cd other-version/ [root@47faa9548aa0 other-version]# cp /root/jenkins.war . [root@47faa9548aa0 other-version]# cd /usr/share/jenkins [root@47faa9548aa0 jenkins]# ls jenkins.war jenkins.war.22.3.17.bak other-version ref [root@47faa9548aa0 jenkins]# rm jenkins.war rm: remove regular file 'jenkins.war'? y [root@47faa9548aa0 jenkins]# cd other-version [root@47faa9548aa0 other-version]# mv jenkins.war ../ [root@47faa9548aa0 other-version]# cd .. [root@47faa9548aa0 jenkins]# ls jenkins.war jenkins.war.22.3.17.bak other-version ref éƒ¨ç½² 1 åˆ›å»ºé¡¹ç›® 2 ç”¨æˆ·å¯†ç ç±»å‹ 1åˆ›å»ºå‡­è¯ é€‰æ‹©&quot;Username with password&quot;ï¼Œè¾“å…¥Gitlabçš„ç”¨æˆ·åå’Œå¯†ç ï¼Œç‚¹å‡»&quot;ç¡®å®š&quot;ã€‚ 2 é…ç½®æºç ç®¡ç†ï¼Œä»gitlabæ‹‰å–ä»£ç  ç¼–è¯‘æ‰“åŒ… æ„å»º-&gt;æ·»åŠ æ„å»ºæ­¥éª¤-&gt;Executor Shell echo â€œå¼€å§‹ç¼–è¯‘å’Œæ‰“åŒ…â€ mvn clean install -DskipTests VERSION=`date +%Y%m%d%H%M` echo $VERSION echo &quot;=============== ç™»å½•Harbor ===============&quot; cd dt-os-plat/ docker login -u 11111 -p 11111 https://registry2-qingdao.cosmoplat.com echo &quot;=============== æ‰“åŒ…Dockeré•œåƒ ï¼š &quot; registry2-qingdao.cosmoplat.com/62_d3os/dt-co-simulation:$VERSION &quot;===============&quot; docker build -t registry2-qingdao.cosmoplat.com/62_d3os/dt-co-simulation:$VERSION . echo &quot;=============== æ¨é€åˆ°é•œåƒä»“åº“ ===============&quot; docker push registry2-qingdao.cosmoplat.com/62_d3os/dt-co-simulation:$VERSION echo &quot;=============== ç™»å‡º ===============&quot; docker logout echo â€œç¼–è¯‘å’Œæ‰“åŒ…ç»“æŸâ€ æ¨é€æ”¯çš„ä»£ç ï¼Œ è‡ªåŠ¨æ‰§è¡Œjenkins 1 jenkinsä¸­Gitlabæ’ä»¶ 2 è§¦å‘åŠŸèƒ½é…ç½® æ‰“å¼€ä¸€ä¸ªä»»åŠ¡é…ç½®ï¼Œæ„å»ºè§¦å‘å™¨ä¸­å‹¾é€‰&quot;Build when a change is pushed to GitLab.&quot;å¹¶è¿‡æ»¤æŒ‡å®šåˆ†æ”¯, è¿™é‡Œéœ€è¦è®°ä¸‹GitLab webhook URLä¸€ä¼šå„¿é…ç½®åˆ°gitlabä¸Š 3 gitlabä¸­æ·»åŠ é…ç½®webhook ç½‘å€ï¼šhttp://10.206.73.157:8080/project/dt-sim è§¦å‘åˆ†æ”¯ï¼šdt-release-simulation ","link":"https://tianxiawuhao.github.io/telBe8GLz/"},{"title":"ä¸ƒå¤§æŸ¥è¯¢ç®—æ³•","content":"å‰è¨€ åœ¨éæ•°å€¼è¿ç®—é—®é¢˜ä¸­ï¼Œæ•°æ®å­˜å‚¨é‡ä¸€èˆ¬å¾ˆå¤§ï¼Œä¸ºäº†åœ¨å¤§é‡ä¿¡æ¯ä¸­æ‰¾åˆ°æŸäº›å€¼ï¼Œéœ€è¦ç”¨åˆ°æŸ¥æ‰¾æŠ€æœ¯ï¼Œä¸ºäº†æé«˜æŸ¥æ‰¾æ•ˆç‡ï¼Œéœ€è¦å¯¹ä¸€äº›æ•°æ®è¿›è¡Œæ’åºã€‚æŸ¥æ‰¾å’Œæ’åºçš„æ•°æ®å¤„ç†é‡å æœ‰éå¸¸å¤§çš„æ¯”é‡ï¼Œæ•…æŸ¥æ‰¾å’Œæ’åºçš„æœ‰æ•ˆæ€§ç›´æ¥å½±å“åˆ°ç®—æ³•çš„æ€§èƒ½ï¼Œå› è€ŒæŸ¥æ‰¾å’Œæ’åºæ˜¯é‡è¦çš„å¤„ç†æŠ€æœ¯ã€‚ å‡ ä¸ªä¸æŸ¥æ‰¾æœ‰å…³çš„åŸºæœ¬æ¦‚å¿µï¼š æŸ¥æ‰¾è¡¨ï¼šç”±åŒä¸€ç±»å‹çš„æ•°æ®å…ƒç´ æ„æˆçš„é›†åˆã€‚ç”±äºæ•°æ®å…ƒç´ ä¹‹é—´å­˜åœ¨ç€å®Œå…¨æ¾æ•£çš„å…³ç³»ï¼Œå› æ­¤æŸ¥æ‰¾è¡¨æ˜¯ä¸€ç§éå¸¸çµæ´»çš„ç»“æ„ï¼Œå¯ä»¥åˆ©ç”¨ä»»æ„æ•°æ®ç»“æ„å®ç°ã€‚ å…³é”®å­—ï¼šæ•°æ®å…ƒç´ çš„æŸä¸ªæ•°æ®é¡¹çš„å€¼ï¼Œç”¨å®ƒå¯ä»¥æ ‡è¯†æŸ¥æ‰¾è¡¨ä¸­ä¸€ä¸ªæˆ–ä¸€ç»„æ•°æ®å…ƒç´ ã€‚å¦‚æœä¸€ä¸ªå…³é”®å­—å¯ä»¥å”¯ä¸€æ ‡è¯†æŸ¥æ‰¾è¡¨ä¸­çš„ä¸€ä¸ªæ•°æ®å…ƒç´ ï¼Œåˆ™ç§°å…¶ä¸º ä¸»å…³é”®å­—ï¼Œå¦åˆ™ä¸ºæ¬¡å…³é”®å­—ã€‚å½“æ•°æ®å…ƒç´ ä»…æœ‰ä¸€ä¸ªæ•°æ®é¡¹æ—¶ï¼Œå…¶å…³é”®å­—å³ä¸ºè¯¥æ•°æ®å…ƒç´ çš„å€¼ã€‚ æŸ¥æ‰¾ï¼šæ ¹æ®ç»™å®šçš„å…³é”®å­—å€¼ï¼Œåœ¨æŸ¥æ‰¾è¡¨ä¸­ç¡®å®šä¸€ä¸ªå…³é”®å­—ä¸ç»™å®šå€¼ç›¸åŒçš„æ•°æ®å…ƒç´ ï¼Œå¹¶è¿”å›è¯¥æ•°æ®å…ƒç´ åœ¨æŸ¥æ‰¾è¡¨ä¸­çš„ä½ç½®ã€‚è‹¥æ‰¾åˆ°ç›¸åº”æ•°æ®å…ƒç´ ï¼Œåˆ™ç§°æŸ¥æ‰¾æˆåŠŸï¼Œå¦åˆ™ç§°æŸ¥æ‰¾å¤±è´¥ï¼Œæ­¤æ—¶è¿”å›ç©ºåœ°å€ã€‚ å¹³å‡æŸ¥æ‰¾é•¿åº¦ï¼šä¸ºç¡®å®šæ•°æ®å…ƒç´ åœ¨æŸ¥æ‰¾è¡¨ä¸­çš„ä½ç½®ï¼Œéœ€è¦å’Œç»™å®šçš„å€¼è¿›è¡Œæ¯”è¾ƒçš„å…³é”®å­—ä¸ªæ•°çš„æœŸæœ›å€¼ï¼Œç§°ä¸ºæŸ¥æ‰¾ç®—æ³•åœ¨æŸ¥æ‰¾æˆåŠŸæ—¶çš„å¹³å‡æŸ¥æ‰¾é•¿åº¦ã€‚ æŸ¥æ‰¾ä¸¤ç§å¸¸è§çš„åˆ†ç±»ï¼š ç±»åˆ« ç‰¹ç‚¹ é™æ€æŸ¥æ‰¾ åªåšæŸ¥æ‰¾æ“ä½œçš„æŸ¥æ‰¾è¡¨ï¼Œå³ï¼š 1ã€æŸ¥è¯¢æŸä¸ªâ€œç‰¹å®šçš„â€æ•°æ®å…ƒç´ æ˜¯å¦åœ¨è¡¨ä¸­ 2ã€æ£€ç´¢æŸä¸ªâ€œç‰¹å®šçš„â€æ•°æ®å…ƒç´ å’Œå„ç§å±æ€§ åŠ¨æ€æŸ¥æ‰¾ åœ¨æŸ¥æ‰¾ä¸­åŒæ—¶è¿›è¡Œæ’å…¥æˆ–åˆ é™¤ç­‰æ“ä½œ ç±»åˆ« ç‰¹ç‚¹ æ— åºæŸ¥æ‰¾ è¢«æŸ¥æ‰¾æ•°åˆ—æœ‰åºæ— åºå‡å¯ æœ‰åºæŸ¥æ‰¾ è¢«æŸ¥æ‰¾æ•°åˆ—ä¸ºæœ‰åºæ•°åˆ— æŸ¥æ‰¾ç®—æ³•æœ‰ä¸ƒç§ï¼Œåˆ†åˆ«ä¸ºï¼šé¡ºåºæŸ¥æ‰¾ã€äºŒåˆ†æŸ¥æ‰¾ã€æ’å€¼æŸ¥æ‰¾ã€æ–æ³¢é‚£å¥‘æŸ¥æ‰¾ã€æ ‘è¡¨æŸ¥æ‰¾ã€åˆ†å—æŸ¥æ‰¾ã€å“ˆå¸ŒæŸ¥æ‰¾ã€‚ åŸºäºçº¿æ€§ç»“æ„çš„æŸ¥æ‰¾ï¼Œæœ‰ä¸¤ç§æœ€å¸¸è§çš„æŸ¥æ‰¾æ–¹æ³•ï¼šé¡ºåºæŸ¥æ‰¾å’ŒæŠ˜åŠæŸ¥æ‰¾ã€‚ é¡ºåºæŸ¥æ‰¾ é¡ºåºæŸ¥æ‰¾çš„ç‰¹ç‚¹æ˜¯ï¼Œç”¨æ‰€ç»™çš„å…³é”®å­—ä¸çº¿æ€§è¡¨ä¸­å„å…ƒç´ çš„å…³é”®å­—é€ä¸ªè¿›è¡Œæ¯”è¾ƒï¼Œç›´åˆ°æˆåŠŸæˆ–å¤±è´¥ã€‚ æŠ˜åŠæŸ¥æ‰¾ æŠ˜åŠæŸ¥æ‰¾åˆç§°ä¸ºäºŒåˆ†æŸ¥æ‰¾ï¼Œè¿™ç§æŸ¥æ‰¾æ–¹æ³•éœ€è¦å¾…æŸ¥çš„æŸ¥æ‰¾è¡¨æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼šé¦–å…ˆï¼ŒæŸ¥æ‰¾è¡¨å¿…é¡»ä½¿ç”¨é¡ºåºçš„å­˜å‚¨ç»“æ„ï¼›å…¶æ¬¡ï¼ŒæŸ¥æ‰¾è¡¨å¿…é¡»æŒ‰å…³é”®å­—å¤§å°æœ‰åºæ’åˆ—ã€‚ç®—æ³•çš„åŸºæœ¬æ€æƒ³æ˜¯ï¼šé¦–å…ˆï¼Œå°†æŸ¥æ‰¾è¡¨ä¸­é—´ä½ç½®æ•°æ®å…ƒç´ çš„å…³é”®å­—ä¸ç»™å®šå…³é”®å­—æ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰åˆ™æŸ¥æ‰¾æˆåŠŸï¼›å¦åˆ™åˆ©ç”¨ä¸­é—´å…ƒç´ å°†è¡¨ä¸€åˆ†ä¸ºäºŒï¼Œå¦‚æœä¸­é—´å…ƒç´ å…³é”®å­—å¤§äºç»™å®šå…³é”®å­—ï¼Œåˆ™åœ¨å‰ä¸€å­è¡¨ä¸­è¿›è¡ŒæŠ˜åŠæŸ¥æ‰¾ï¼Œå¦åˆ™åœ¨åä¸€å­è¡¨ä¸­è¿›è¡ŒæŠ˜åŠæŸ¥æ‰¾ã€‚é‡å¤ä»¥ä¸Šè¿‡ç¨‹ï¼Œç›´åˆ°æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„å…ƒç´ ï¼Œåˆ™æŸ¥æ‰¾æˆåŠŸï¼›æˆ–ç›´åˆ°å­è¡¨ä¸ºç©ºä¸ºæ­¢ï¼Œæ­¤æ—¶æŸ¥æ‰¾ä¸æˆåŠŸã€‚ ä¸€ã€é¡ºåºæŸ¥æ‰¾ 1.1 é¡ºåºæŸ¥æ‰¾ä»‹ç» é¡ºåºæŸ¥æ‰¾åˆç§°ä¸ºçº¿æ€§æŸ¥æ‰¾ï¼Œæ˜¯ä¸€ç§æœ€ç®€å•çš„æŸ¥æ‰¾æ–¹æ³•ã€‚é€‚ç”¨äºçº¿æ€§è¡¨çš„é¡ºåºå­˜å‚¨ç»“æ„å’Œé“¾å¼å­˜å‚¨ç»“æ„ã€‚ åŸºæœ¬æ€è·¯ ä»ç¬¬ä¸€ä¸ªå…ƒç´ må¼€å§‹é€ä¸ªä¸éœ€è¦æŸ¥æ‰¾çš„å…ƒç´ xè¿›è¡Œæ¯”è¾ƒï¼Œå½“æ¯”è¾ƒåˆ°å…ƒç´ å€¼ç›¸åŒ(å³m=x)æ—¶è¿”å›å…ƒç´ mçš„ä¸‹æ ‡ï¼Œå¦‚æœæ¯”è¾ƒåˆ°æœ€åéƒ½æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™è¿”å›-1ã€‚ å¤æ‚åº¦åˆ†æ æŸ¥æ‰¾æˆåŠŸæ—¶çš„å¹³å‡æŸ¥æ‰¾é•¿åº¦ä¸ºï¼š ASL = æ¯ä¸ªå…ƒç´ è¢«æŸ¥æ‰¾çš„æ¦‚ç‡ * æ€»çš„å…ƒç´ çš„ä¸ªæ•°=1/n*(1+2+3+â€¦+n) = (n+1)/2 ; å½“æŸ¥æ‰¾ä¸æˆåŠŸæ—¶ï¼Œéœ€è¦n+1æ¬¡æ¯”è¾ƒï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(n)ï¼Œæ‰€ä»¥ï¼Œé¡ºåºæŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(n)ã€‚ ä¼˜ç¼ºç‚¹ ç¼ºç‚¹ï¼šæ˜¯å½“n å¾ˆå¤§æ—¶ï¼Œå¹³å‡æŸ¥æ‰¾é•¿åº¦è¾ƒå¤§ï¼Œæ•ˆç‡ä½ï¼› ä¼˜ç‚¹ï¼šæ˜¯å¯¹è¡¨ä¸­æ•°æ®å…ƒç´ çš„å­˜å‚¨æ²¡æœ‰è¦æ±‚ã€‚å¦å¤–ï¼Œå¯¹äºçº¿æ€§é“¾è¡¨ï¼Œåªèƒ½è¿›è¡Œé¡ºåºæŸ¥æ‰¾ã€‚ 1.2 é¡ºåºæŸ¥æ‰¾å®ç° ç”¨Javaä»£ç å®ç°é¡ºåºæŸ¥æ‰¾ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š private static int sequenceSearch(int[] array,int target){ for(int i=0;i&lt;array.length;i++){ if(target==array[i]) return i; } return -1; } 1.3 é¡ºåºæŸ¥æ‰¾ä¼˜åŒ– åœ¨ç®—æ³•ä¸­ï¼Œæ¯”è¾ƒå’Œèµ‹å€¼æ˜¯æ¯”è¾ƒè€—æ—¶çš„ã€‚åœ¨ä¸Šé¢çš„é¡ºåºæŸ¥æ‰¾å®ç°ä»£ç ä¸­ï¼Œå­˜åœ¨ç€æ•°ç»„ä¸‹æ ‡å’Œç›®æ ‡å€¼ä¸¤ç§æ¯”è¾ƒï¼Œé‚£ä¹ˆèƒ½ä¸èƒ½è½¬å˜ä¸ºä¸€ç§æ¯”è¾ƒå‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œä¸è¿‡è¦è¿›è¡Œæ•°æ®é¢„å¤„ç†ï¼Œå°†æŸ¥æ‰¾å€¼ä¹Ÿæ”¾åˆ°æ•°åˆ—ä¸­ã€‚æ¯”å¦‚å°†è¦æŸ¥æ‰¾çš„å…ƒç´ æ”¾åœ¨åŸæ•°åˆ—ä¸­çš„ç¬¬ä¸€ä½æˆ–æœ€åä¸€ä½(å¦‚æœéœ€è¦æ‰©å®¹å°±è¿›è¡Œæ‰©å®¹)ã€‚æ­¤å¤„å°†è¦æŸ¥æ‰¾çš„ç›®æ ‡å…ƒç´ æ”¾åœ¨ç¬¬ä¸€ä½ï¼Œé¢„å¤„ç†ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š int[] array = {12,3,43,5,9}; int target = 43; int[] newArray = new int[array.length+1]; newArray[0] = target; for(int i=0;i&lt;array.length;i++){ newArray[i+1] = array[i]; } ä¹Ÿè®¸æœ‰äººä¼šé—®ï¼Œè¿™æ ·é¢„å¤„ç†ä¸€éæ•°æ®ï¼Œéœ€è¦å°†æ•°ç»„ä¸­æ‰€æœ‰æ•°ç»„éƒ½ç§»åŠ¨ä¸€éï¼Œå²‚ä¸æ˜¯æ›´èŠ±è´¹æ—¶é—´ï¼Ÿä»æ€»ä½“ä¸Šæ¥çœ‹ï¼Œç¡®å®æ˜¯è¿™æ ·çš„ã€‚ä½†æ˜¯ï¼Œé¢ä¸´å¤§é‡çš„æ•°æ®è¦å¤„ç†æ—¶ï¼Œå¸¸å¸¸è¦è¿›è¡Œé¢„å¤„ç†ã€æ¸…æ´—ç­‰æ“ä½œï¼Œè¿™æ ·ä¼šä»¤çº¯ç²¹å¤„ç†æ•°æ®ï¼ˆåœ¨è¯¥ä¾‹å­ä¸­å°±æ˜¯æœç´¢å›ºå®šå…ƒç´ ï¼‰çš„æ—¶é—´å˜çš„æ›´å°‘ï¼Œæ›´æœ‰æ•ˆã€‚å½“æ•°æ®è¿›è¡Œé¢„å¤„ç†åï¼Œæœç´¢æ—¶å°±å¯ä»¥ä¸ç”¨å†æ¯”è¾ƒä¸¤æ¬¡ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š public static int sequenceSearchPlus(int[] arr,int key){ int n=arr.length-1; arr[0]=key; while(arr[n]!=key){ n--; } return n; } å®Œæ•´çš„æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š public class BasicTest { public static void main(String[] args){ int[] array = {12,3,43,5,9}; int target = 43; int[] newArray = new int[array.length+1]; newArray[0] = target; for(int i=0;i&lt;array.length;i++){ newArray[i+1] = array[i]; } int result = sequenceSearchPlus(newArray,target)-1; if(result != -1){ System.out.println(&quot;è¦æŸ¥æ‰¾çš„å…ƒç´ ,åœ¨æ•°ç»„ä¸­çš„ä¸‹æ ‡æ˜¯ï¼š&quot;+result); }else{ System.out.println(&quot;è¦æŸ¥æ‰¾çš„å…ƒç´ ä¸åœ¨æ•°ç»„ä¸­&quot;); } } public static int sequenceSearchPlus(int[] arr,int key){ int n=arr.length-1; arr[0]=key; while(arr[n]!=key){ n--; } return n; } æµ‹è¯•ç»“æœä¸ºï¼š è¦æŸ¥æ‰¾çš„å…ƒç´ ,åœ¨æ•°ç»„ä¸­çš„ä¸‹æ ‡æ˜¯ï¼š2 äºŒã€äºŒåˆ†æŸ¥æ‰¾ 2.1 äºŒåˆ†æŸ¥æ‰¾ä»‹ç» äºŒåˆ†æŸ¥æ‰¾ï¼Œæ˜¯ä¸€ç§åœ¨æœ‰åºæ•°ç»„ä¸­æŸ¥æ‰¾æŸä¸€ç‰¹å®šå…ƒç´ çš„æŸ¥æ‰¾ç®—æ³•ã€‚ åŸºæœ¬æ€è·¯ ç”¨ç»™å®šå€¼kå…ˆä¸ä¸­é—´ç»“ç‚¹çš„å…³é”®å­—æ¯”è¾ƒï¼Œä¸­é—´ç»“ç‚¹æŠŠçº¿å½¢è¡¨åˆ†æˆä¸¤ä¸ªå­è¡¨ï¼Œè‹¥ç›¸ç­‰åˆ™æŸ¥æ‰¾æˆåŠŸï¼›è‹¥ä¸ç›¸ç­‰ï¼Œå†æ ¹æ®kä¸è¯¥ä¸­é—´ç»“ç‚¹å…³é”®å­—çš„æ¯”è¾ƒç»“æœç¡®å®šä¸‹ä¸€æ­¥æŸ¥æ‰¾å“ªä¸ªå­è¡¨ï¼Œè¿™æ ·é€’å½’è¿›è¡Œï¼Œç›´åˆ°æŸ¥æ‰¾åˆ°æˆ–æŸ¥æ‰¾ç»“æŸå‘ç°è¡¨ä¸­æ²¡æœ‰è¿™æ ·çš„ç»“ç‚¹ã€‚ **å¤æ‚åº¦åˆ†æ ** å‡è®¾æ•°æ®å¤§å°æ˜¯ nï¼Œæ¯æ¬¡æŸ¥æ‰¾åæ•°æ®éƒ½ä¼šç¼©å°ä¸ºåŸæ¥çš„ä¸€åŠï¼Œä¹Ÿå°±æ˜¯ä¼šé™¤ä»¥ 2ã€‚æœ€åæƒ…å†µä¸‹ï¼Œç›´åˆ°æŸ¥æ‰¾åŒºé—´è¢«ç¼©å°ä¸ºç©ºï¼Œæ‰åœæ­¢ã€‚è¢«æŸ¥æ‰¾åŒºé—´çš„å¤§å°å˜åŒ–ä¸ºï¼šn, n/2, n/4, n/8, â€¦, n/(2k)ã€‚ å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™æ˜¯ä¸€ä¸ªç­‰æ¯”æ•°åˆ—ã€‚å…¶ä¸­ n/(2^k)=1 æ—¶ï¼Œk çš„å€¼å°±æ˜¯æ€»å…±ç¼©å°çš„æ¬¡æ•°ã€‚è€Œæ¯ä¸€æ¬¡ç¼©å°æ“ä½œåªæ¶‰åŠä¸¤ä¸ªæ•°æ®çš„å¤§å°æ¯”è¾ƒï¼Œæ‰€ä»¥ï¼Œç»è¿‡äº† k æ¬¡åŒºé—´ç¼©å°æ“ä½œï¼Œæ—¶é—´å¤æ‚åº¦å°±æ˜¯ O(k)ã€‚é€šè¿‡n/(2^k)=1 ï¼Œæˆ‘ä»¬å¯ä»¥æ±‚å¾— k=log2n ï¼Œæ‰€ä»¥æ—¶é—´å¤æ‚åº¦å°±æ˜¯ O(logn)ã€‚ç©ºé—´å¤æ‚åº¦ï¼šO(1)ã€‚ ä¼˜ç¼ºç‚¹åˆ†æ å½“æŸ¥æ‰¾è¡¨ä¸ä¼šé¢‘ç¹æœ‰æ›´æ–°ã€åˆ é™¤æ“ä½œæ—¶ï¼Œä½¿ç”¨æŠ˜åŠæŸ¥æ‰¾æ˜¯æ¯”è¾ƒç†æƒ³çš„ã€‚å¦‚æœæŸ¥æ‰¾è¡¨æœ‰è¾ƒé¢‘ç¹çš„æ›´æ–°ã€åˆ é™¤æ“ä½œï¼Œç»´æŠ¤è¡¨çš„æœ‰åºä¼šèŠ±è´¹æ¯”è¾ƒå¤§çš„ç²¾åŠ›ï¼Œä¸å»ºè®®ä½¿ç”¨è¯¥æŸ¥æ‰¾æ–¹å¼ã€‚ 2.2 äºŒåˆ†æŸ¥æ‰¾å®ç° ç”¨Javaä»£ç å®ç°æŠ˜åŠæŸ¥æ‰¾ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼šè¿­ä»£æ³•å’Œé€’å½’æ³•ã€‚è¿­ä»£æ³•ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š static int binarySearch1(int arr[],int len,int target){ /*åˆå§‹åŒ–å·¦å³æœç´¢è¾¹ç•Œ*/ int left=0,right=len-1; int mid; while(left&lt;=right){ /*ä¸­é—´ä½ç½®ï¼šä¸¤è¾¹ç•Œå…ƒç´ ä¹‹å’Œ/2å‘ä¸‹å–æ•´*/ mid=(left+right)/2; /*arr[mid]å¤§äºtargetï¼Œå³è¦å¯»æ‰¾çš„å…ƒç´ åœ¨å·¦åŠè¾¹ï¼Œæ‰€ä»¥éœ€è¦è®¾å®šå³è¾¹ç•Œä¸ºmid-1ï¼Œæœç´¢å·¦åŠè¾¹*/ if(target&lt;arr[mid]){ right=mid-1; /*arr[mid]å°äºtargetï¼Œå³è¦å¯»æ‰¾çš„å…ƒç´ åœ¨å³åŠè¾¹ï¼Œæ‰€ä»¥éœ€è¦è®¾å®šå·¦è¾¹ç•Œä¸ºmid+1ï¼Œæœç´¢å³åŠè¾¹*/ }else if(target&gt;arr[mid]){ left=mid+1; /*æœç´¢åˆ°å¯¹åº”å…ƒç´ */ }else if(target==arr[mid]){ return mid; } } /*æœç´¢ä¸åˆ°è¿”å›-1*/ return -1; } é€’å½’æ³•ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š static int binarySearch2(int array[],int left,int right,int target){ if(left&lt;=right){ int mid=(left+right)/2; /*æœç´¢åˆ°å¯¹åº”å…ƒç´ */ if(array[mid]==target){ return mid; }else if(array[mid]&lt;target){ /*array[mid]å°äºtargetï¼Œå³è¦å¯»æ‰¾çš„å…ƒç´ åœ¨å³åŠè¾¹ï¼Œæ‰€ä»¥éœ€è¦è®¾å®šå·¦è¾¹ç•Œä¸ºmid+1ï¼Œæœç´¢å³åŠè¾¹*/ return binarySearch2(array,mid+1,right,target); }else{ /*array[mid]å¤§äºtargetï¼Œå³è¦å¯»æ‰¾çš„å…ƒç´ åœ¨å·¦åŠè¾¹ï¼Œæ‰€ä»¥éœ€è¦è®¾å®šå³è¾¹ç•Œä¸ºmid-1ï¼Œæœç´¢å·¦åŠè¾¹*/ return binarySearch2(array,left,mid-1,target); } }else{ return -1; } } 2.3 äºŒåˆ†æŸ¥æ‰¾å˜ä½“ äºŒåˆ†æŸ¥æ‰¾ç®—æ³•å››ç§å¸¸è§çš„å˜å½¢é—®é¢˜ï¼Œåˆ†åˆ«æ˜¯ï¼š æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå€¼ç­‰äºç»™å®šå€¼çš„å…ƒç´ ã€‚ æŸ¥æ‰¾æœ€åä¸€ä¸ªå€¼ç­‰äºç»™å®šå€¼çš„å…ƒç´ ã€‚ æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå¤§äºç­‰äºç»™å®šå€¼çš„å…ƒç´ ã€‚ æŸ¥æ‰¾æœ€åä¸€ä¸ªå°äºç­‰äºç»™å®šå€¼çš„å…ƒç´ ã€‚ 1ã€æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå€¼ç­‰äºç»™å®šå€¼çš„å…ƒç´  public static int search(int[] nums, int val) { int n = nums.length; int low = 0, high = n - 1; while (low &lt;= high) { int mid = (low + high) &gt;&gt;&gt; 1; if (nums[mid] &lt; val) { low = mid + 1; } else if (nums[mid] &gt; val) { high = mid - 1; } else { // å¦‚æœnums[mid]æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæˆ–è€…nums[mid-1]ä¸ç­‰äºval // è¯´æ˜nums[mid]å°±æ˜¯ç¬¬ä¸€ä¸ªå€¼ä¸ºç»™å®šå€¼çš„å…ƒç´  if (mid == 0 || nums[mid - 1] != val) { return mid; } high = mid - 1; } } return -1; } 2ã€æŸ¥æ‰¾æœ€åä¸€ä¸ªå€¼ç­‰äºç»™å®šå€¼çš„å…ƒç´  public static int search(int[] nums, int val) { int n = nums.length; int low = 0, high = n - 1; while (low &lt;= high) { int mid = (low + high) &gt;&gt;&gt; 1; if (nums[mid] &lt; val) { low = mid + 1; } else if (nums[mid] &gt; val) { high = mid - 1; } else { // å¦‚æœnums[mid]æ˜¯æœ€åä¸€ä¸ªå…ƒç´ ï¼Œæˆ–è€…nums[mid+1]ä¸ç­‰äºval // è¯´æ˜nums[mid]å°±æ˜¯æœ€åä¸€ä¸ªå€¼ä¸ºç»™å®šå€¼çš„å…ƒç´  if (mid == n - 1 || nums[mid + 1] != val) { return mid; } low = mid + 1; } } return -1; } 3ã€æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå¤§äºç­‰äºç»™å®šå€¼çš„å…ƒç´  public static int search(int[] nums, int val) { int low = 0, high = nums.length - 1; while (low &lt;= high) { int mid = (low + high) &gt;&gt;&gt; 1; if (nums[mid] &lt; val) { low = mid + 1; } else { // å¦‚æœnums[mid]æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæˆ–è€…nums[mid-1]å°äºval // è¯´æ˜nums[mid]å°±æ˜¯ç¬¬ä¸€ä¸ªå¤§äºç­‰äºç»™å®šå€¼çš„å…ƒç´  if (mid == 0 || nums[mid - 1] &lt; val) { return mid; } high = mid - 1; } } return -1; } 4ã€æŸ¥æ‰¾æœ€åä¸€ä¸ªå°äºç­‰äºç»™å®šå€¼çš„å…ƒç´  public static int search(int[] nums, int val) { int n = nums.length; int low = 0, high = n - 1; while (low &lt;= high) { int mid = (low + high) &gt;&gt;&gt; 1; if (nums[mid] &gt; val) { high = mid - 1; } else { // å¦‚æœnums[mid]æ˜¯æœ€åä¸€ä¸ªå…ƒç´ ï¼Œæˆ–è€…nums[mid+1]å¤§äºval // è¯´æ˜nums[mid]å°±æ˜¯æœ€åä¸€ä¸ªå°äºç­‰äºç»™å®šå€¼çš„å…ƒç´  if (mid == n - 1 || nums[mid + 1] &gt; val) { return mid; } low = mid + 1; } } return -1; } ä¸‰ã€æ’å€¼æŸ¥æ‰¾ 3.1 æ’å€¼æŸ¥æ‰¾ä»‹ç» åœ¨äºŒåˆ†æŸ¥æ‰¾ä¸­ï¼Œæ¯æ¬¡éƒ½æ˜¯ä»å¾…æŸ¥æ‰¾åºåˆ—çš„ä¸­é—´ç‚¹å¼€å§‹æŸ¥æ‰¾ï¼Œè¿™æ ·çš„åšæ³•åœ¨æ­£ç¡®æ€§ä¸Šå›ºç„¶æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†å‡å¦‚è¦æŸ¥æ‰¾çš„å€¼è·ç¦»æŸä¸ªè¾¹ç•Œæ¯”è¾ƒè¿‘ï¼Œè¿˜ä»ä¸­é—´ç‚¹å¼€å§‹æŸ¥æ‰¾ï¼Œå°±æœ‰ç‚¹æµªè´¹æ—¶é—´äº†ã€‚ä¸¾ä¸ªä¾‹å­æ¥è¯´è¯´æ˜ï¼Œå‡å¦‚åœ¨åœ¨ä¸€ä¸ª{1,2â€¦,100}çš„æ•°ç»„ä¸­ï¼Œè¦æŸ¥æ‰¾88è¿™ä¸ªå€¼ï¼Œè¿˜ä¸€ç›´é‡‡ç”¨å’Œä¸­é—´ç‚¹æ¯”è¾ƒçš„ç­–ç•¥ï¼Œå°±æ˜¾å¾—ä¸å¤ªæ˜æ™ºï¼Œå› ä¸ºæ˜æ˜¾å¯ä»¥æ˜æ˜¾ä»è¾ƒä¸ºé åçš„ä½ç½®å»æ£€ç´¢ã€‚ä¸ºäº†å…‹æœè¿™ç§å¼Šç«¯ï¼Œ å¼•å…¥äº†æ’å€¼æŸ¥æ‰¾ã€‚ åŸºæœ¬æ€è·¯ æ’å€¼æŸ¥æ‰¾æ˜¯æ ¹æ®è¦æŸ¥æ‰¾çš„å…³é”®å­—keyä¸æŸ¥æ‰¾è¡¨ä¸­æœ€å¤§æœ€å°è®°å½•çš„å…³é”®å­—æ¯”è¾ƒåçš„ æŸ¥æ‰¾æ–¹æ³•ï¼Œå…¶æ ¸å¿ƒå°±åœ¨äºæ’å€¼çš„è®¡ç®—å…¬å¼ (key-array[low])/(array[high]-array[low])*(high-low)ã€‚ç®€è€Œè¨€ä¹‹ï¼ŒåŸºäºäºŒåˆ†æŸ¥æ‰¾ç®—æ³•ï¼Œå°†æŸ¥æ‰¾ç‚¹çš„é€‰æ‹©æ”¹è¿›ä¸ºè‡ªé€‚åº”é€‰æ‹©ã€‚ å¤æ‚åº¦åˆ†æ æ—¶é—´å¤æ‚æ€§ï¼šå¦‚æœå…ƒç´ å‡åŒ€åˆ†å¸ƒï¼Œåˆ™O(log(logn))ï¼Œåœ¨æœ€åçš„æƒ…å†µä¸‹å¯èƒ½éœ€è¦O(n)ã€‚ ç©ºé—´å¤æ‚åº¦ï¼šO(1)ã€‚ ä¼˜ç¼ºç‚¹åˆ†æ å¯¹äºé•¿åº¦æ¯”è¾ƒé•¿ã€å…³é”®å­—åˆ†å¸ƒåˆæ¯”è¾ƒå‡åŒ€çš„æŸ¥æ‰¾è¡¨æ¥è¯´ï¼Œæ’å€¼æŸ¥æ‰¾ç®—æ³•çš„å¹³å‡æ€§èƒ½æ¯”æŠ˜åŠæŸ¥æ‰¾è¦å¥½çš„å¤šã€‚åä¹‹ï¼Œæ•°ç»„ä¸­å¦‚æœåˆ†å¸ƒéå¸¸ä¸å‡åŒ€ï¼Œé‚£ä¹ˆæ’å€¼æŸ¥æ‰¾æœªå¿…æ˜¯å¾ˆåˆé€‚çš„é€‰æ‹©ã€‚ 3.2 æ’å€¼æŸ¥æ‰¾å®ç° ä¸Šé¢çš„è¯´æ³•æ˜¯æ€»ä½“ä»‹ç»ï¼Œè½å®åˆ°å…·ä½“ä»£ç ä¸Šçš„è¯ï¼Œå†æ…¢æ…¢åˆ†æã€‚åœ¨äºŒåˆ†æŸ¥æ‰¾ä¸­ï¼Œmidçš„è®¡ç®—æ–¹å¼å¦‚ä¸‹ï¼š â€‹ å°†lowä»åˆ†æ•°ä¸­æå–å‡ºæ¥ï¼Œmidçš„è®¡ç®—å°±å˜æˆäº†ï¼š â€‹ åœ¨æ’å€¼æŸ¥æ‰¾ä¸­ï¼Œmidçš„è®¡ç®—æ–¹å¼è½¬æ¢æˆäº†ï¼š â€‹ æœ‰äº†ä¸Šé¢çš„ç®—æœ¯ï¼Œå°±å¯ä»¥å†™ä»£ç äº†ï¼Œè¿­ä»£æ³•æ’å€¼æŸ¥æ‰¾ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š private static int insertSearch1(int arr[],int target){ /*åˆå§‹åŒ–å·¦å³æœç´¢è¾¹ç•Œ*/ int left=0,right=arr.length-1; int mid; while(left&lt;=right){ mid=left+(target-arr[left])/(arr[right]-arr[left])*(right-left); /*arr[mid]å¤§äºtargetï¼Œå³è¦å¯»æ‰¾çš„å…ƒç´ åœ¨å·¦åŠè¾¹ï¼Œæ‰€ä»¥éœ€è¦è®¾å®šå³è¾¹ç•Œä¸ºmid-1ï¼Œæœç´¢å·¦åŠè¾¹*/ if(target&lt;arr[mid]){ right=mid-1; /*arr[mid]å°äºtargetï¼Œå³è¦å¯»æ‰¾çš„å…ƒç´ åœ¨å³åŠè¾¹ï¼Œæ‰€ä»¥éœ€è¦è®¾å®šå·¦è¾¹ç•Œä¸ºmid+1ï¼Œæœç´¢å³åŠè¾¹*/ }else if(target&gt;arr[mid]){ left=mid+1; /*æœç´¢åˆ°å¯¹åº”å…ƒç´ */ }else if(target==arr[mid]){ return mid; } } /*æœç´¢ä¸åˆ°è¿”å›-1*/ return -1; } é€’å½’æ³•æ’å€¼æŸ¥æ‰¾ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š private static int insertSearch2(int array[],int left,int right,int target){ if(left&lt;=right){ int mid=left+(target-array[left])/(array[right]-array[left])*(right-left); /*æœç´¢åˆ°å¯¹åº”å…ƒç´ */ if(array[mid]==target){ return mid; }else if(array[mid]&lt;target){ /*array[mid]å°äºtargetï¼Œå³è¦å¯»æ‰¾çš„å…ƒç´ åœ¨å³åŠè¾¹ï¼Œæ‰€ä»¥éœ€è¦è®¾å®šå·¦è¾¹ç•Œä¸ºmid+1ï¼Œæœç´¢å³åŠè¾¹*/ return insertSearch2(array,mid+1,right,target); }else{ /*array[mid]å¤§äºtargetï¼Œå³è¦å¯»æ‰¾çš„å…ƒç´ åœ¨å·¦åŠè¾¹ï¼Œæ‰€ä»¥éœ€è¦è®¾å®šå³è¾¹ç•Œä¸ºmid-1ï¼Œæœç´¢å·¦åŠè¾¹*/ return insertSearch2(array,left,mid-1,target); } }else{ return -1; } } å››ã€æ–æ³¢é‚£å¥‘æŸ¥æ‰¾ 4.1 æ–æ³¢é‚£å¥‘æŸ¥æ‰¾ä»‹ç» å’Œå‰é¢çš„äºŒåˆ†æŸ¥æ‰¾ã€æ’å€¼æŸ¥æ‰¾ç›¸æ¯”ï¼Œæ–æ³¢é‚£å¥‘æŸ¥æ‰¾æ˜¯ç±»ä¼¼çš„ï¼Œä¸è¿‡æ¢äº†ä¸€ç§å¯»æ‰¾midç‚¹çš„æ–¹æ³•ã€‚é¡¾åæ€ä¹‰ï¼Œè¯¥ç§æŸ¥æ‰¾æ–¹æ³•ä¸­ï¼Œä½¿ç”¨åˆ°äº†æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼Œæ–æ³¢é‚£å¥‘æ•°åˆ—çš„å½¢å¼æ˜¯ï¼š1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89â€¦â€¦.ï¼ˆä»ç¬¬ä¸‰ä¸ªæ•°å¼€å§‹ï¼Œåè¾¹æ¯ä¸€ä¸ªæ•°éƒ½æ˜¯å‰ä¸¤ä¸ªæ•°çš„å’Œï¼‰ã€‚ åŸºæœ¬æ€è·¯ åœ¨æ–æ³¢é‚£å¥‘æ•°åˆ—ä¸­çš„å…ƒç´ æ»¡è¶³è¿™æ ·çš„å…³ç³»ï¼šF[k]=F[k-1]+F[k-2]ï¼Œæ­¤å¤„å°†è¿™ä¸ªæ•°ç»„ç¨å¾®æ”¹ä¸€ä¸‹ï¼Œæ”¹æˆï¼šï¼ˆF[k]-1ï¼‰=ï¼ˆF[k-1]-1ï¼‰+ï¼ˆF[k-2]-1ï¼‰+1ï¼Œå›¾ç¤ºå¦‚ä¸‹ï¼š é€šè¿‡ä¸Šé¢çš„å›¾ï¼Œåº”è¯¥å°±å¯ä»¥çœ‹å‡ºä¸ºä»€ä¹ˆè¦è¿™æ ·åˆ†å‰²æ•°ç»„äº†ï¼Œå› ä¸ºè¦æ‰¾å‡ºä¸€ä¸ªä¸­é—´midå€¼ï¼Œä»¥ä¾¿å°†æ•°ç»„æŒ‰æ–æ³¢é‚£å¥‘æ•°åˆ—çš„è§„å¾‹ï¼Œåˆ†å‰²æˆä¸¤éƒ¨åˆ†ã€‚ å¤æ‚åº¦åˆ†æ æœ€åæƒ…å†µä¸‹ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(logn)ï¼Œä¸”å…¶æœŸæœ›å¤æ‚åº¦ä¹Ÿä¸ºO(logn)ã€‚ 4.2 æ–æ³¢é‚£å¥‘æŸ¥æ‰¾å®ç° ä¸Šé¢ä»‹ç»äº†åˆ†å‰²çš„æ–¹æ³•ï¼Œä½†è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æ–æ³¢é‚£å¥‘æ•°åˆ—ä¸­çš„æ•°å€¼éƒ½æ˜¯å›ºå®šçš„ï¼Œä½†è¦æŸ¥æ‰¾çš„æ•°ç»„çš„é•¿åº¦ä¸å›ºå®šï¼Œè¿™æ ·æƒ…å†µè¦æ€ä¹ˆåŠï¼Ÿæ­¤æ—¶éœ€è¦çš„æ˜¯åˆ›å»ºæ–°æ•°ç»„ï¼Œä½¿æ–°æ•°ç»„çš„é•¿åº¦æ˜¯æ–æ³¢é‚£å¥‘æ•°åˆ—ä¸­çš„å€¼ï¼Œå¹¶ä¸”æ˜¯æ¯”åŸæ•°ç»„é•¿åº¦ç•¥å¤§çš„å€¼ï¼ˆæ­¤å¤„åªèƒ½æ˜¯ç•¥å¤§ï¼Œå› ä¸ºç•¥å°çš„è¯ï¼Œå°±ä¼šå¯¼è‡´åŸæ•°ç»„å…ƒç´ ä¸¢å¤±)ï¼Œå¤šå‡ºæ¥çš„å…ƒç´ ç”¨åŸæ•°ç»„æœ€é«˜ä½å…ƒç´ è¡¥å……ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š int high = arr.length - 1; int f[] = fib(); /*è·å–æœ€ç›¸é‚»çš„æ–æ³¢é‚£å¥‘æ•°ç»„ä¸­å…ƒç´ çš„å€¼ï¼Œè¯¥å€¼ç•¥å¤§äºæ•°ç»„çš„é•¿åº¦*/ while(high &gt; f[k] - 1) { k++; } /*å› ä¸º f[k]å€¼å¯èƒ½å¤§äºarrçš„é•¿åº¦ã€‚å¦‚æœå¤§äºæ—¶ï¼Œéœ€è¦æ„é€ ä¸€ä¸ªæ–°çš„æ•°ç»„temp[]ï¼Œå°†arræ•°ç»„ä¸­çš„å…ƒç´ æ‹·è´è¿‡å»ï¼Œä¸è¶³çš„éƒ¨åˆ†ä¼šä½¿ç”¨0å¡«å……*/ int[] temp=Arrays.copyOf(arr, f[k]); /*ç„¶åå°†tempåé¢å¡«å……çš„0ï¼Œæ›¿æ¢ä¸ºæœ€åä¸€ä½æ•°å­— *å¦‚å°†tempæ•°ç»„ç”±{1,8,10,89,100,134,0,0}å˜æ¢ä¸º{1,8,10,89,100,134,134,134}*/ for(int i = high + 1; i &lt; temp.length; i++) { temp[i] = arr[high]; } è§£å†³äº†å¦‚ä½•åˆ†å‰²ã€å¦‚æœåˆ›å»ºä¸´æ—¶æ–°æ•°ç»„åï¼Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼šæ€ä¹ˆåˆ¤æ–­æœ€åtarget == arr[i]æ—¶ï¼Œè¿™ä¸ªarr[i]æ˜¯åŸæ¥çš„æ•°ç»„ä¸­çš„å…ƒç´ ï¼Œè¿˜æ˜¯åœ¨æ–°æ•°ç»„ä¸­æ‰©å±•å‡ºæ¥çš„å…ƒç´ ï¼Ÿå¦‚æœæ˜¯æ–°æ•°ç»„ä¸­æ‰©å±•å‡ºæ¥çš„å…ƒç´ ï¼Œè¯¥å…ƒç´ çš„ä¸‹æ ‡æ˜¯å¤§äºåŸæ•°ç»„å…ƒç´ çš„æœ€å¤§ä¸‹æ ‡çš„ï¼Œè‚¯å®šä¸æ˜¯è¦å¯»æ‰¾çš„ä½ç½®ã€‚å…¶å®è¯¥é—®é¢˜å®¹æ˜“è§£å†³ï¼Œå°±æ˜¯å½“target == arr[i]æ—¶ï¼Œå¦‚æœarr[i]çš„ä¸‹æ ‡&gt;åŸæ•°ç»„æœ€å¤§ä¸‹æ ‡æ—¶ï¼Œç›´æ¥è¿”å›å…ƒæ•°ç»„æœ€å¤§ä¸‹æ ‡å³å¯ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š /*åŸarræ•°ç»„ä¸­çš„å€¼*/ if(mid &lt;= high){ return mid; /*åœ¨tempä¸­ï¼Œæ‰©å±•å‡ºæ¥çš„é«˜ä½çš„å€¼*/ }else{ return high; } å®Œæ•´æ–æ³¢é‚£å¥‘æŸ¥æ‰¾ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š public class FibonacciSearch { public static int FLENGTH = 20; public static void main(String[] args) { int [] arr = {1,8,10,89,100,134}; int target = 89; System.out.println(&quot;ç›®æ ‡å…ƒç´ åœ¨æ•°ç»„ä¸­ä½ç½®æ˜¯ï¼š&quot; + fibSearch(arr, target)); } public static int[] fib() { int[] f = new int[FLENGTH]; f[0] = 1; f[1] = 1; for (int i = 2; i &lt; FLENGTH; i++) { f[i] = f[i-1] + f[i-2]; } return f; } public static int fibSearch(int[] arr, int target) { int low = 0; int high = arr.length - 1; int k = 0; int mid = 0; int f[] = fib(); /*è·å–æœ€ç›¸é‚»çš„æ–æ³¢é‚£å¥‘æ•°ç»„ä¸­å…ƒç´ çš„å€¼ï¼Œè¯¥å€¼ç•¥å¤§äºæ•°ç»„çš„é•¿åº¦*/ while(high &gt; f[k] - 1) { k++; } /*å› ä¸º f[k]å€¼å¯èƒ½å¤§äºarrçš„é•¿åº¦ã€‚å¦‚æœå¤§äºæ—¶ï¼Œéœ€è¦æ„é€ ä¸€ä¸ªæ–°çš„æ•°ç»„temp[]ï¼Œå°†arræ•°ç»„ä¸­çš„å…ƒç´ æ‹·è´è¿‡å»ï¼Œä¸è¶³çš„éƒ¨åˆ†ä¼šä½¿ç”¨0å¡«å……*/ int[] temp=Arrays.copyOf(arr, f[k]); /*ç„¶åå°†tempåé¢å¡«å……çš„0ï¼Œæ›¿æ¢ä¸ºæœ€åä¸€ä½æ•°å­— *å¦‚å°†tempæ•°ç»„ç”±{1,8,10,89,100,134,0,0}å˜æ¢ä¸º{1,8,10,89,100,134,134,134}*/ for(int i = high + 1; i &lt; temp.length; i++) { temp[i] = arr[high]; } while (low &lt;= high) { mid = low + f[k - 1] - 1; if(target &lt; temp[mid]) { high = mid - 1; /*å› ä¸ºf[k]=f[k-1]+f[k-2]ï¼Œæ‰€ä»¥k--å°±ç›¸å½“äºå–tempæ•°ç»„çš„å·¦è¾¹éƒ¨åˆ†*/ k--; } else if ( target &gt; temp[mid]) { low = mid + 1; /*åŒç†ï¼Œf[k]=f[k-1]+f[k-2]ï¼Œk -= 2å°±ç›¸å½“äºå–tempæ•°ç»„çš„å³è¾¹éƒ¨åˆ†*/ k -= 2; } else { /*åŸarræ•°ç»„ä¸­çš„å€¼*/ if(mid &lt;= high){ return mid; /*åœ¨tempä¸­ï¼Œæ‰©å±•å‡ºæ¥çš„é«˜ä½çš„å€¼*/ }else{ return high; } } } return -1; } } äº”ã€æ ‘è¡¨æŸ¥æ‰¾ åŸºäºæ ‘çš„æŸ¥æ‰¾æ–¹æ³•æ˜¯å°†å¾…æŸ¥è¡¨ç»„ç»‡æˆç‰¹å®šçš„æ ‘ç»“æ„ï¼Œå¹¶åœ¨æ ‘ç»“æ„çš„åŸºç¡€ä¸Šå®ç°æŸ¥æ‰¾çš„æ–¹æ³•ã€‚ 5.1 äºŒå‰æ ‘æŸ¥æ‰¾ äºŒå‰æ’åºæ ‘ï¼ˆäºŒå‰æŸ¥æ‰¾æ ‘ï¼‰æ˜¯æœ€ç®€å•çš„æ ‘è¡¨æŸ¥æ‰¾ç®—æ³•ï¼Œè¯¥ç®—æ³•éœ€è¦åˆ©ç”¨å¾…æŸ¥æ‰¾çš„æ•°æ®ï¼Œè¿›è¡Œç”Ÿæˆæ ‘ï¼Œç¡®ä¿æ ‘çš„å·¦åˆ†æ”¯çš„å€¼å°äºå³åˆ†æ”¯çš„å€¼ï¼Œç„¶ååœ¨å°±è¡Œå’Œæ¯ä¸ªèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æ¯”è¾ƒå¤§å°ï¼Œç„¶åå†è¿›è¡ŒæŸ¥æ‰¾ã€‚ äºŒå‰æ’åºæ ‘çš„æ€§è´¨ äºŒå‰æ’åºæ ‘æˆ–è€…æ˜¯ä¸€æ£µç©ºæ ‘ï¼Œæˆ–è€…æ˜¯å…·æœ‰ä¸‹åˆ—æ€§è´¨çš„äºŒå‰æ ‘ï¼š - 1&gt;è‹¥å·¦å­æ ‘ä¸ç©ºï¼Œåˆ™å·¦å­æ ‘ä¸Šæ‰€æœ‰ç»“ç‚¹çš„é”®å€¼å‡å°äºæˆ–ç­‰äºå®ƒçš„æ ¹ç»“ç‚¹çš„é”®å€¼ã€‚ - 2&gt;è‹¥å³å­æ ‘ä¸ç©ºï¼Œåˆ™å³å­æ ‘ä¸Šæ‰€æœ‰ç»“ç‚¹çš„é”®å€¼å‡å¤§äºæˆ–ç­‰äºå®ƒçš„æ ¹ç»“ç‚¹çš„é”®å€¼ã€‚ - 3&gt;å·¦ã€å³å­æ ‘ä¹Ÿåˆ†åˆ«ä¸ºäºŒå‰æ’åºæ ‘ã€‚ 5.1.1 äºŒå‰æ’åºæ ‘ä¸­åºéå† äºŒå‰æ’åºæ ‘æœ‰ä¸åŒçš„éå†æ–¹å¼ï¼Œä¸­åºéå†çš„ç»“æœæ¯”è¾ƒç›´è§‚ã€‚äºŒå‰æ ‘ç¤ºä¾‹ï¼š äºŒå‰æ ‘ä¸Šä¸­åºéå†çš„æ–¹å¼æ˜¯ï¼šå·¦èŠ‚ç‚¹ã€æ ¹èŠ‚ç‚¹ã€å³èŠ‚ç‚¹ã€‚è¯¥äºŒå‰æ ‘çš„éå†ç»“æœä¸ºï¼š1ã€3ã€4ã€6ã€7ã€8ã€10ã€13ã€14ã€‚ 5.1.2 äºŒå‰æ ‘æŸ¥æ‰¾å®ç° 1ã€åˆ›å»ºäºŒå‰æ ‘ é¦–å…ˆï¼Œè¦åˆ›å»ºä¸€ä¸ªæ ‘çš„èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹ä¸­è¦æœ‰è¯¥èŠ‚ç‚¹å‚¨å­˜çš„å€¼ï¼Œç„¶åèµ·å·¦å³å­æ ‘ã€‚ç¤ºä¾‹ä»£ç ï¼š class BinaryTree{ int value; BinaryTree left; BinaryTree right; public BinaryTree(int value){ this.value = value; } } æ¥ä¸‹æ¥å°±è¦åˆ›å»ºäºŒå‰æ’åºæ ‘ï¼Œåˆ›å»ºäºŒå‰æ’åºæ ‘æ˜¯ä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹ï¼Œéœ€è¦å°†åºåˆ—ä¸­çš„å€¼ä¸€ä¸ªä¸€ä¸ªæ·»åŠ åˆ°äºŒå‰æ ‘ä¸­ã€‚æ–¹ä¾¿èµ·è§ï¼Œå¯ä»¥åˆ©ç”¨åºåˆ—ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ ä½œä¸ºæ ¹èŠ‚ç‚¹ï¼Œå†æŒç»­æ·»åŠ èŠ‚ç‚¹ï¼Œç¤ºä¾‹ä»£ç ï¼š int[] array = {35,76,6,22,16,49,49,98,46,9,40}; BinaryTree root = new BinaryTree(array[0]); for(int i = 1; i &lt; array.length; i++){ createBST(root, array[i]); } å…·ä½“åˆ›å»ºæ ‘çš„è¿‡ç¨‹ï¼Œå°±æ˜¯ä¸€ä¸ªä¸æ–­ä¸æ ¹èŠ‚ç‚¹æ¯”è¾ƒï¼Œç„¶åæ·»åŠ åˆ°å·¦ä¾§ã€å³ä¾§æˆ–ä¸æ·»åŠ çš„è¿‡ç¨‹ã€‚å› ä¸ºåœ¨äºŒå‰æ’åºæ ‘ä¸­ï¼Œä¸å­˜åœ¨é‡å¤å…ƒç´ ï¼Œæœ‰ç›¸ç­‰å…ƒç´ å·²ç»åœ¨æ ‘ä¸­æ—¶ï¼Œç›´æ¥å¿½ç•¥åç»­ç›¸ç­‰å…ƒç´ ã€‚ç¤ºä¾‹ä»£ç ï¼š public static void createBST(BinaryTree root, int element){ BinaryTree newNode = new BinaryTree(element); if(element &gt; root.value){ if(root.right == null) root.right = newNode; else createBST(root.right, element); }else if(element &lt; root.value){ if(root.left == null) root.left = newNode; else createBST(root.left, element); }else{ System.out.println(&quot;è¯¥èŠ‚ç‚¹&quot; + element + &quot;å·²å­˜åœ¨&quot;); return; } } 2ã€äºŒå‰æ ‘æŸ¥æ‰¾ æŸ¥æ‰¾å…ƒç´ æ˜¯å¦åœ¨æ ‘ä¸­çš„è¿‡ç¨‹ï¼Œå°±æ˜¯ä¸€ä¸ªäºŒåˆ†æŸ¥æ‰¾çš„è¿‡ç¨‹ï¼Œä¸è¿‡æŸ¥æ‰¾çš„å¯¹è±¡ä»å·¦å³å­åºåˆ—è½¬æ¢æˆäº†å·¦å³å­æ ‘è€Œå·²ã€‚ç¤ºä¾‹ä»£ç ï¼š public static void searchBST(BinaryTree root, int target, BinaryTree p){ if(root == null){ System.out.println(&quot;æŸ¥æ‰¾&quot;+target+&quot;å¤±è´¥&quot;); }else if(root.value == target){ System.out.println(&quot;æŸ¥æ‰¾&quot;+target+&quot;æˆåŠŸ&quot;); }else if(root.value &gt;= target){ searchBST(root.left, target, root); }else{ searchBST(root.right, target, root); } } å®Œæ•´ç¤ºä¾‹ä»£ç ï¼š â€‹ public class BinarySortTree { public static void main(String[] args) { int[] array = {35,76,6,22,16,49,49,98,46,9,40}; BinaryTree root = new BinaryTree(array[0]); for(int i = 1; i &lt; array.length; i++){ createBST(root, array[i]); } System.out.println(&quot;ä¸­åºéå†ç»“æœï¼š&quot;); midOrderPrint(root); System.out.println(); searchBST(root, 22, null); searchBST(root, 100, null); } /*åˆ›å»ºäºŒå‰æ’åºæ ‘*/ public static void createBST(BinaryTree root, int element){ BinaryTree newNode = new BinaryTree(element); if(element &gt; root.value){ if(root.right == null) root.right = newNode; else createBST(root.right, element); }else if(element &lt; root.value){ if(root.left == null) root.left = newNode; else createBST(root.left, element); }else{ System.out.println(&quot;è¯¥èŠ‚ç‚¹&quot; + element + &quot;å·²å­˜åœ¨&quot;); return; } } /*äºŒå‰æ ‘ä¸­æŸ¥æ‰¾å…ƒç´ */ public static void searchBST(BinaryTree root, int target, BinaryTree p){ if(root == null){ System.out.println(&quot;æŸ¥æ‰¾&quot;+target+&quot;å¤±è´¥&quot;); }else if(root.value == target){ System.out.println(&quot;æŸ¥æ‰¾&quot;+target+&quot;æˆåŠŸ&quot;); }else if(root.value &gt;= target){ searchBST(root.left, target, root); }else{ searchBST(root.right, target, root); } } /*äºŒå‰æ ‘çš„ä¸­åºéå†*/ public static void midOrderPrint(BinaryTree rt){ if(rt != null){ midOrderPrint(rt.left); System.out.print(rt.value + &quot; &quot;); midOrderPrint(rt.right); } } } æµ‹è¯•ç»“æœä¸ºï¼š è¯¥èŠ‚ç‚¹49å·²å­˜åœ¨ ä¸­åºéå†ç»“æœï¼š 6 9 16 22 35 40 46 49 76 98 æŸ¥æ‰¾22æˆåŠŸ æŸ¥æ‰¾100å¤±è´¥ å…­ã€åˆ†å—æŸ¥æ‰¾ 6.1 åˆ†å—æŸ¥æ‰¾ä»‹ç» åˆ†å—æŸ¥æ‰¾ï¼Œé¡¾åæ€ä¹‰ï¼Œè¦å…ˆå°†æ‰€æœ‰å…ƒç´ æŒ‰å¤§å°è¿›è¡Œåˆ†å—ï¼Œç„¶ååœ¨å—å†…è¿›è¡ŒæŸ¥æ‰¾ã€‚åœ¨åˆ†å—æ—¶ï¼Œå—å†…çš„å…ƒç´ ä¸ä¸€å®šæ˜¯æœ‰åºçš„ï¼Œåªè¦ä¸€ä¸ªå—å†…çš„å…ƒç´ åœ¨åŒä¸€åŒºé—´å°±è¡Œã€‚ç”¨è¾ƒæ ‡å‡†çš„è¯­è¨€æè¿°æ˜¯ï¼šç®—æ³•çš„æ€æƒ³æ˜¯å°†nä¸ªæ•°æ®å…ƒç´ &quot;æŒ‰å—æœ‰åº&quot;åˆ’åˆ†ä¸ºmå—ï¼ˆmâ‰¤nï¼‰ã€‚æ¯ä¸€å—ä¸­çš„ç»“ç‚¹ä¸å¿…æœ‰åºï¼Œä½†å—ä¸å—ä¹‹é—´å¿…é¡»&quot;æŒ‰å—æœ‰åº&quot;ï¼Œæ¯ä¸ªå—å†…çš„çš„æœ€å¤§å…ƒç´ å°äºä¸‹ä¸€å—æ‰€æœ‰å…ƒç´ çš„ä»»æ„ä¸€ä¸ªå€¼ã€‚ æ‰€ä»¥ï¼Œåœ¨ä½¿ç”¨åˆ†å—æŸ¥æ‰¾æ—¶ï¼Œåˆ†æˆäº†ä¸¤æ­¥ï¼š - 1&gt;æ‰¾åˆ°å…ƒç´ å¯èƒ½åœ¨çš„å—ã€‚ - 2&gt;åœ¨å¯¹åº”çš„å—å†…æŸ¥æ‰¾å…ƒç´ ã€‚ 6.2 åˆ†å—æŸ¥æ‰¾å®ç° åœ¨ä¸Šä¸ªç« èŠ‚è¯´åˆ°ï¼Œè¯¥æ–¹æ³•è¦å…ˆåˆ†å—ï¼Œé‚£ä¹ˆå—åº”è¯¥å…·æœ‰æ€æ ·çš„å±æ€§å‘¢ï¼Ÿè‡³å°‘è¦æœ‰ä»¥ä¸‹å…ƒç´ ï¼š - 1&gt;é•¿åº¦ ä¸€èˆ¬æ˜¯å›ºå®šçš„é•¿åº¦ã€‚ - 2&gt;èµ·å§‹ä½ç½® å½“å—çš„é•¿åº¦å›ºå®šåï¼Œéœ€è¦ç¡®å®šèµ·å§‹ä½ç½®æ‰èƒ½å›ºå®šä¸åŒçš„å—è¡¨ç¤ºçš„å…ƒç´ çš„ä½ç½®èŒƒå›´ã€‚ - 3&gt;å—æ ‡è¯† è¯¥æ ‡è¯†ç”¨æ¥æ ‡è¯†å—å†…å…ƒç´ çš„èŒƒå›´ï¼Œå¯ä»¥ç”¨æœ€å¤§å€¼ã€æœ€å°å€¼ã€å¹³å‡å€¼ç­‰å¤šç§æ–¹å¼æ¥è¡¨ç¤ºã€‚ ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š public class Block { /*blockçš„ç´¢å¼•ï¼Œç”¨æ¥æ ‡è¯†å—ä¸­å…ƒç´ */ public int index; /*è¯¥blockçš„å¼€å§‹ä½ç½®*/ public int start; /*å—å…ƒç´ é•¿åº¦ï¼Œåœ¨è¯¥ä¾‹å­ä¸­0ä»£è¡¨ç©ºå…ƒç´ ï¼Œä¸è®¡å…¥blocké•¿åº¦*/ public int length; public Block(int index, int start, int length) { this.index = index; this.start = start; this.length = length; } } åœ¨è¯¥ä¾‹å­ä¸­ï¼Œå®šä¹‰å…ƒç´ æ•°ç»„å’Œå—æ•°ç»„ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š /*ä¸»è¡¨*/ static int[] valueList = new int[]{ 104, 101, 103, 105,102, 0, 0, 0, 0, 0, 201, 202, 204, 203,0, 0, 0, 0, 0, 0, 303, 301, 302, 0, 0, 0, 0, 0, 0, 0 }; /*ç´¢å¼•è¡¨*/ static Block[] indexList = new Block[]{ new Block(1, 0, 5), new Block(2, 10, 4), new Block(3, 20, 3) }; valueListä¸­çš„0ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºå—å†…çš„ç©ºå…ƒç´ ï¼›indexListä¸­çš„1,2,3ä»£è¡¨å—å†…å…ƒç´ çš„å–å€¼èŒƒå›´ï¼Œç¬¬ä¸€ä¸ªå—å†…æ˜¯100-200ä¹‹é—´çš„å…ƒç´ ï¼Œç¬¬2ä¸ªå—å†…æ˜¯200-300ä¹‹é—´çš„å…ƒç´ ï¼Œä»¥æ­¤ç±»æ¨ã€‚ åœ¨è¿›è¡Œå…ƒç´ æŸ¥æ‰¾æ—¶ï¼Œå…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨å…ƒç´ å¯èƒ½å­˜åœ¨çš„å—ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š /*ç¡®å®šæ’å…¥åˆ°å“ªä¸ªå—ä¸­ï¼Œåœ¨è¯¥ä¾‹å­ä¸­ï¼Œç¬¬ä¸€ä¸ªblockä¸­æ”¾çš„æ˜¯100-200ä¹‹é—´çš„æ•°ï¼Œç¬¬äºŒä¸ªblockä¸­æ”¾çš„æ˜¯200-300ä¹‹é—´çš„æ•°ï¼Œä»¥æ­¤ç±»æ¨*/ int index = key/100; /*æ‰¾åˆ°å¯¹åº”çš„block*/ for(int i = 0;i &lt; indexList.length; i++) { if(indexList[i].index == index) { indexItem = indexList[i]; break; } } /*å¦‚æœæ•°ç»„ä¸­ä¸å­˜åœ¨å¯¹åº”çš„å—ï¼Œåˆ™è¿”å›-1ï¼ŒæŸ¥æ‰¾å¤±è´¥*/ if(indexItem == null) return -1; æ‰¾åˆ°å†…å¯¹çš„å—åï¼Œå°±åœ¨è¯¥å—å†…è¿›è¡Œæœç´¢ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š /*åœ¨å¯¹åº”çš„blockä¸­æŸ¥æ‰¾*/ for(int i = indexItem.start; i &lt; indexItem.start + indexItem.length; i++) { if(valueList[i] == key) return i; } return -1; å¦‚æœéœ€è¦åœ¨æ•°ç»„ä¸­æ’å…¥å…ƒç´ ï¼ŒåŒæ ·éœ€è¦éœ€è¦å…ˆæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨å¯¹åº”çš„å—ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™è¿½åŠ åˆ°è¯¥å—ä¸­å…ƒç´ çš„å°¾éƒ¨ã€‚ å®Œæ•´ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š public class BlockSearch { /*ä¸»è¡¨*/ static int[] valueList = new int[]{ 104, 101, 103, 105,102, 0, 0, 0, 0, 0, 201, 202, 204, 203,0, 0, 0, 0, 0, 0, 303, 301, 302, 0, 0, 0, 0, 0, 0, 0 }; /*ç´¢å¼•è¡¨*/ static Block[] indexList = new Block[]{ new Block(1, 0, 5), new Block(2, 10, 4), new Block(3, 20, 3) }; public static void main(String[] args) { System.out.println(&quot;åŸå§‹ä¸»è¡¨ï¼š&quot;); printElemts(valueList); /*åˆ†å—æŸ¥æ‰¾*/ int searchValue = 203; System.out.println(&quot;å…ƒç´ &quot;+searchValue+&quot;ï¼Œåœ¨åˆ—è¡¨ä¸­çš„ç´¢å¼•ä¸ºï¼š&quot;+blockSearch(searchValue)+&quot;\\n&quot;); /*æ’å…¥æ•°æ®å¹¶æŸ¥æ‰¾*/ int insertValue = 106; /*æ’å…¥æˆåŠŸï¼ŒæŸ¥æ‰¾æ’å…¥ä½ç½®*/ if (insertBlock(insertValue)) { System.out.println(&quot;æ’å…¥å…ƒç´ &quot;+insertValue+&quot;åçš„ä¸»è¡¨ï¼š&quot;); printElemts(valueList); System.out.println(&quot;å…ƒç´ &quot; + insertValue + &quot;åœ¨åˆ—è¡¨ä¸­çš„ç´¢å¼•ä¸ºï¼š&quot; + blockSearch(insertValue)); } } public static void printElemts(int[] array) { for(int i = 0; i &lt; array.length; i++){ System.out.print(array[i]+&quot; &quot;); if ((i+1)%10 == 0) { System.out.println(); } } } â€‹ /*æ’å…¥æ•°æ®*/ public static boolean insertBlock(int key) { Block item = null; /*ç¡®å®šæ’å…¥åˆ°å“ªä¸ªå—ä¸­ï¼Œåœ¨è¯¥ä¾‹å­ä¸­ï¼Œç¬¬ä¸€ä¸ªblockä¸­æ”¾çš„æ˜¯100-200ä¹‹é—´çš„æ•°ï¼Œç¬¬äºŒä¸ªblockä¸­æ”¾çš„æ˜¯200-300ä¹‹é—´çš„æ•°ï¼Œä»¥æ­¤ç±»æ¨*/ int index = key/100; int i = 0; /*æ‰¾åˆ°å¯¹åº”çš„block*/ for (i = 0; i &lt; indexList.length; i++) { if (indexList[i].index == index) { item = indexList[i]; break; } } /*å¦‚æœæ•°ç»„ä¸­ä¸å­˜åœ¨å¯¹åº”çš„å—ï¼Œåˆ™ä¸èƒ½æ’å…¥è¯¥æ•°æ®*/ if (item == null) { return false; } /*å°†å…ƒç´ æ’å…¥åˆ°æ¯ä¸ªå—çš„æœ€å*/ valueList[item.start + item.length] = key; /*æ›´æ–°è¯¥å—çš„é•¿åº¦*/ indexList[i].length++; return true; } public static int blockSearch(int key) { Block indexItem = null; /*ç¡®å®šæ’å…¥åˆ°å“ªä¸ªå—ä¸­ï¼Œåœ¨è¯¥ä¾‹å­ä¸­ï¼Œç¬¬ä¸€ä¸ªblockä¸­æ”¾çš„æ˜¯100-200ä¹‹é—´çš„æ•°ï¼Œç¬¬äºŒä¸ªblockä¸­æ”¾çš„æ˜¯200-300ä¹‹é—´çš„æ•°ï¼Œä»¥æ­¤ç±»æ¨*/ int index = key/100; /*æ‰¾åˆ°å¯¹åº”çš„block*/ for(int i = 0;i &lt; indexList.length; i++) { if(indexList[i].index == index) { indexItem = indexList[i]; break; } } /*å¦‚æœæ•°ç»„ä¸­ä¸å­˜åœ¨å¯¹åº”çš„å—ï¼Œåˆ™è¿”å›-1ï¼ŒæŸ¥æ‰¾å¤±è´¥*/ if(indexItem == null) return -1; /*åœ¨å¯¹åº”çš„blockä¸­æŸ¥æ‰¾*/ for(int i = indexItem.start; i &lt; indexItem.start + indexItem.length; i++) { if(valueList[i] == key) return i; } return -1; } } æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š åŸå§‹ä¸»è¡¨ï¼š 104 101 103 105 102 0 0 0 0 0 201 202 204 203 0 0 0 0 0 0 303 301 302 0 0 0 0 0 0 0 å…ƒç´ 203ï¼Œåœ¨åˆ—è¡¨ä¸­çš„ç´¢å¼•ä¸ºï¼š13 æ’å…¥å…ƒç´ 106åçš„ä¸»è¡¨ï¼š 104 101 103 105 102 106 0 0 0 0 201 202 204 203 0 0 0 0 0 0 303 301 302 0 0 0 0 0 0 0 å…ƒç´ 106åœ¨åˆ—è¡¨ä¸­çš„ç´¢å¼•ä¸ºï¼š5 ä¸ƒã€å“ˆå¸ŒæŸ¥æ‰¾ 7.1 å“ˆå¸ŒæŸ¥æ‰¾ä»‹ç» è¦äº†è§£å“ˆå¸ŒæŸ¥æ‰¾ï¼Œå°±è¦å…ˆäº†è§£ä¸€ä¸‹å“ˆå¸Œè¡¨å’Œå“ˆå¸Œå‡½æ•°ã€‚å…ˆçœ‹ä¸‹æ ‡å‡†çš„å®šä¹‰ï¼šå“ˆå¸Œè¡¨ï¼Œæ˜¯æ ¹æ®å…³é”®å€¼è€Œç›´æ¥è¿›è¡Œè®¿é—®çš„æ•°æ®ç»“æ„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒé€šè¿‡æŠŠå…³é”®ç å€¼æ˜ å°„åˆ°è¡¨ä¸­ä¸€ä¸ªä½ç½®æ¥è®¿é—®è®°å½•ï¼Œä»¥åŠ å¿«æŸ¥æ‰¾çš„é€Ÿåº¦ã€‚è¿™ä¸ªæ˜ å°„å‡½æ•°å«åšæ•£åˆ—å‡½æ•°ï¼Œå­˜æ”¾è®°å½•çš„æ•°ç»„å«åšæ•£åˆ—è¡¨ï¼ˆå“ˆå¸Œè¡¨ï¼‰ã€‚ ä»ä¸Šé¢çš„å®šä¹‰å¯ä»¥çœ‹å‡ºï¼šå“ˆå¸ŒæŸ¥æ‰¾ä¸çº¿æ€§è¡¨æŸ¥æ‰¾å’Œæ ‘è¡¨æŸ¥æ‰¾æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼Œä¸ç”¨æ•°å€¼æ¯”è¾ƒã€‚ 7.1.1 æ„é€ å“ˆå¸Œè¡¨ è¦ä½¿ç”¨å“ˆå¸ŒæŸ¥æ‰¾ï¼Œå°±è¦å…ˆæœ‰å“ˆå¸Œè¡¨ï¼Œæ‰€ä»¥éœ€è¦å…ˆä»‹ç»ä¸€ä¸‹å“ˆå¸Œè¡¨çš„æ„é€ æ–¹æ³•ã€‚å¸¸è§çš„æ„é€ æ–¹æ³•æœ‰å¦‚ä¸‹å‡ ç§ï¼š 1ã€ç›´æ¥å®šå€æ³• å“ˆå¸Œåœ°å€ï¼šf(key) = a*key+b (aã€bä¸ºå¸¸æ•°)ã€‚ è¿™ç§æ–¹æ³•çš„ä¼˜ç‚¹æ˜¯ï¼šç®€å•ã€å‡åŒ€ã€ä¸ä¼šäº§ç”Ÿå†²çªã€‚ä½†æ˜¯éœ€è¦äº‹å…ˆçŸ¥é“ key çš„åˆ†å¸ƒæƒ…å†µï¼Œé€‚åˆæŸ¥æ‰¾è¡¨è¾ƒå°å¹¶ä¸”è¿ç»­çš„æƒ…å†µã€‚ 2ã€æ•°å­—åˆ†ææ³• å‡è®¾å…³é”®å­—æ˜¯Rè¿›åˆ¶æ•°ï¼ˆå¦‚åè¿›åˆ¶ï¼‰ã€‚å¹¶ä¸”å“ˆå¸Œè¡¨ä¸­å¯èƒ½å‡ºç°çš„å…³é”®å­—éƒ½æ˜¯äº‹å…ˆçŸ¥é“çš„ï¼Œåˆ™å¯é€‰å–å…³é”®å­—çš„è‹¥å¹²æ•°ä½ç»„æˆå“ˆå¸Œåœ°å€ã€‚é€‰å–çš„åŸåˆ™æ˜¯ä½¿å¾—åˆ°çš„å“ˆå¸Œåœ°å€å°½é‡é¿å…å†²çªï¼Œå³æ‰€é€‰æ•°ä½ä¸Šçš„æ•°å­—å°½å¯èƒ½æ˜¯éšæœºçš„ã€‚ ä¸¾ä¸ªä¾‹å­ï¼šæ¯”å¦‚11ä½æ‰‹æœºå·ç â€œ136xxxx5889â€ï¼Œå…¶ä¸­å‰ä¸‰ä½æ˜¯æ¥å…¥å·ï¼Œä¸€èˆ¬å¯¹åº”ä¸åŒè¿è¥å…¬å¸çš„å­å“ç‰Œï¼Œä¸­é—´å››ä½è¡¨ç¤ºå½’å±åœ°ï¼Œæœ€åå››ä½æ‰æ˜¯ç”¨æˆ·å·ï¼Œæ­¤æ—¶å°±å¯ä»¥ç”¨å4ä½æ¥ä½œä¸ºå“ˆå¸Œåœ°å€ã€‚ 3ã€å¹³æ–¹å–ä¸­æ³• å–keyå¹³æ–¹åçš„ä¸­é—´å‡ ä½ä¸ºå“ˆå¸Œåœ°å€ã€‚é€šå¸¸åœ¨é€‰å®šå“ˆå¸Œå‡½æ•°æ—¶ä¸ä¸€å®šèƒ½çŸ¥é“å…³é”®å­—çš„å…¨éƒ¨æƒ…å†µï¼Œä»…å–å…¶ä¸­çš„å‡ ä½ä¸ºåœ°å€ä¸ä¸€å®šåˆé€‚ã€‚è€Œä¸€ä¸ªæ•°å¹³æ–¹åçš„ä¸­é—´å‡ ä½æ•°å’Œæ•°çš„æ¯ä¸€ä½éƒ½ç›¸å…³ï¼Œ ç”±æ­¤å¾—åˆ°çš„å“ˆå¸Œåœ°å€éšæœºæ€§æ›´å¤§ã€‚å¦‚keyæ˜¯1234ï¼Œé‚£ä¹ˆå®ƒçš„å¹³æ–¹å°±æ˜¯1522756ï¼Œå†æŠ½å–ä¸­é—´çš„3ä½å°±æ˜¯227ä½œä¸º f(key) ã€‚ 4ã€æŠ˜å æ³• æŠ˜å æ³•æ˜¯å°† key ä»å·¦åˆ°å³åˆ†å‰²æˆä½æ•°ç›¸ç­‰çš„å‡ ä¸ªéƒ¨åˆ†(æœ€åä¸€éƒ¨åˆ†ä½æ•°ä¸å¤Ÿå¯ä»¥çŸ­äº›)ï¼Œç„¶åå°†è¿™å‡ éƒ¨åˆ†å åŠ æ±‚å’Œï¼Œå¹¶æŒ‰å“ˆå¸Œè¡¨çš„è¡¨é•¿ï¼Œå–åå‡ ä½ä½œä¸º f(key) ã€‚ æ¯”å¦‚keyæ˜¯9876543210ï¼Œå“ˆå¸Œè¡¨çš„è¡¨é•¿ä¸º3ä½ï¼Œæˆ‘ä»¬å°† key åˆ†ä¸º4ç»„ï¼Œ987 | 654 | 321 | 0 ï¼Œç„¶åå°†å®ƒä»¬å åŠ æ±‚å’Œ 987+654+321+0=1962ï¼Œå†å–å3ä½å³å¾—åˆ°å“ˆå¸Œä½ç½®æ˜¯ï¼š962 ã€‚ 5ã€é™¤ç•™ä½™æ•°æ³• å–å…³é”®å­—è¢«æŸä¸ªä¸å¤§äºå“ˆå¸Œè¡¨è¡¨é•¿ m çš„æ•° p é™¤åæ‰€å¾—çš„ä½™æ•°ä¸ºå“ˆå¸Œåœ°å€ã€‚å³ f(key) = key % p (p â‰¤ m)ã€‚è¿™ç§æ–¹æ³•æ˜¯æœ€å¸¸ç”¨çš„å“ˆå¸Œå‡½æ•°æ„é€ æ–¹æ³•ã€‚ 6ã€éšæœºæ•°æ³• å“ˆå¸Œåœ°å€ï¼šrandom(key) ï¼Œè¿™é‡Œrandomæ˜¯éšæœºå‡½æ•°ï¼Œå½“ key çš„é•¿åº¦ä¸ç­‰æ—¶ï¼Œé‡‡ç”¨è¿™ç§æ–¹æ³•æ¯”è¾ƒåˆé€‚ã€‚ 7.1.2 è§£å†³å†²çª åœ¨ä½¿ç”¨ä»¥ä¸Šæ–¹æ³•è®¡ç®—keyå¯¹åº”çš„å“ˆå¸Œåœ°å€æ—¶ï¼Œéš¾å…ä¼šé‡åˆ°ä¸¤ä¸ªkeyä¸ç›¸ç­‰ï¼Œåˆ°è®¡ç®—å‡ºæ¥çš„å“ˆå¸Œåœ°å€ç›¸åŒçš„æƒ…å†µï¼Œè¯¥æƒ…å†µå°±è¢«ç§°ä¸ºâ€œå†²çªâ€ã€‚åœ¨æ„é€ å“ˆå¸Œè¡¨ï¼Œå¸¸ç”¨å¦‚ä¸‹æ–¹å¼è§£å†³å†²çªï¼š 1ã€å¼€æ”¾å®šå€æ³• è¯¥æ–¹æ³•æŒ‡çš„æ˜¯ä¸¤ä¸ªkeyåœ¨è®¡ç®—å‡ºç›¸åŒçš„å“ˆå¸Œåœ°å€æ—¶ï¼Œåè€…ç»§ç»­åœ¨å“ˆå¸Œè¡¨ä¸­å‘åå¯»æ‰¾ç©ºä½ç½®ï¼Œå­˜æ”¾æ”¹keyçš„æ–¹æ³•ã€‚ä¸¾ä¸ªä¾‹å­ï¼šå‡å¦‚åŸå§‹çš„keyä¸­æœ‰8ã€15ä¸¤ä¸ªå…ƒç´ ï¼Œå“ˆå¸Œè¡¨ä¸­çš„é•¿åº¦ä¸º7ï¼Œå½“ä½¿ç”¨key % lengthæ±‚ä½™æ—¶ï¼Œä¸¤ä¸ªkeyä¼šè®¡ç®—å‡ºç›¸åŒçš„å“ˆå¸Œä½ç½®ã€‚å‡è®¾å“ˆå¸Œè¡¨ä¸­çš„1ä½ç½®å·²ç»å­˜æ”¾äº†8ï¼Œé‚£ä¹ˆ15å°±è¦ä»1ä½ç½®å¾€åå¯»æ‰¾ç©ºä½ï¼Œå‡å¦‚2ä½ç½®æ˜¯ç©ºçš„ï¼Œå°±å¯ä»¥æŠŠ15å­˜æ”¾åˆ°2ä½ç½®ï¼›å‡å¦‚2ä½ç½®ä¸ç©ºï¼Œå°±è¦å¾€3ä½ç½®å¯»æ‰¾ï¼Œä»¥æ­¤ç±»æ¨ã€‚ 2ã€æ‹‰é“¾æ³• è¯¥æ–¹æ³•ä¸­å¤„ç†ç›¸åŒä½ç½®çš„æ–¹å¼æ˜¯ï¼šåˆ›å»ºä¸€ä¸ªListï¼Œå­˜å‚¨ç›¸åŒä½ç½®ä¸Šä¸åŒå€¼çš„keyï¼Œæ­¤å¤„å€Ÿç”¨ç½‘ä¸Šçš„ä¸€å¼ å›¾æ¥è¡¨ç¤ºï¼š 7.2 å“ˆå¸ŒæŸ¥æ‰¾å®ç° ä¾æ®ä¸Šæ–‡ä»‹ç»ï¼Œå…ˆæ„å»ºå“ˆå¸Œè¡¨ã€‚è€Œè¦æ„å»ºå“ˆå¸Œè¡¨ï¼Œå°±è¦å…ˆæœ‰è®¡ç®—åœ°å€çš„æ–¹æ³•ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š /*ç”¨é™¤ç•™ä½™æ•°æ³•è®¡ç®—è¦æ’å…¥å…ƒç´ çš„åœ°å€*/ public static int hash(int[] hashTable, int data) { return data % hashTable.length; } æœ‰äº†è®¡ç®—å“ˆå¸Œåœ°å€çš„æ–¹æ³•åï¼Œå‰©ä¸‹çš„å°±æ˜¯å°†åŸå§‹çš„å…ƒç´ æ’å…¥åˆ°å“ˆå¸Œè¡¨ä¸­ï¼Œä¹Ÿå°±æ˜¯å…ˆåˆ©ç”¨keyè®¡ç®—ä¸€ä¸ªåœ°å€ï¼Œå¦‚æœè¿™ä¸ªåœ°å€ä»¥åŠæœ‰å…ƒç´ äº†ï¼Œå°±ç»§ç»­å‘åå¯»æ‰¾ã€‚æ­¤å¤„å¯ä»¥å¾ªç¯è®¡ç®—åœ°å€ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š /*å°†å…ƒç´ æ’å…¥åˆ°å“ˆå¸Œè¡¨ä¸­*/ public static void insertHashTable(int[] hashTable, int target) { int hashAddress = hash(hashTable, target); /*å¦‚æœä¸ä¸º0ï¼Œåˆ™è¯´æ˜å‘ç”Ÿå†²çª*/ while (hashTable[hashAddress] != 0) { /*åˆ©ç”¨å¼€æ”¾å®šå€æ³•è§£å†³å†²çªï¼Œå³å‘åå¯»æ‰¾æ–°åœ°å€*/ hashAddress = (++hashAddress) % hashTable.length; } /*å°†å…ƒç´ æ’å…¥åˆ°å“ˆå¸Œè¡¨ä¸­*/ hashTable[hashAddress] = target; } å“ˆå¸Œè¡¨æ„å»ºåï¼Œå°±æ˜¯åœ¨å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾å…ƒç´ äº†ã€‚åœ¨æŸ¥æ‰¾å…ƒç´ æ—¶ï¼Œå®¹æ˜“æƒ³åˆ°çš„æƒ…å†µæ˜¯ï¼šåœ¨ç›´æ¥è®¡ç®—å‡ºçš„å“ˆå¸Œåœ°å€åŠå…¶åç»­ä½ç½®æŸ¥æ‰¾å…ƒç´ ã€‚ç‰¹æ®Šçš„æ˜¯ï¼Œä¸Šä¸€æ­¥ä¸­ï¼Œæœ‰å¾ªç¯è®¡ç®—åœ°å€çš„æ“ä½œï¼Œæ‰€ä»¥æ­¤å¤„è®¡ç®—åˆ°åŸå§‹åœ°å€æ—¶ï¼Œä¹Ÿä»£è¡¨æŸ¥æ‰¾å¤±è´¥ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š public static int searchHashTable(int[] hashTable, int target) { int hashAddress = hash(hashTable, target); while (hashTable[hashAddress] != target) { /*å¯»æ‰¾åŸå§‹åœ°å€åé¢çš„ä½ç½®*/ hashAddress = (++hashAddress) % hashTable.length; /*æŸ¥æ‰¾åˆ°å¼€æ”¾å•å…ƒ(æœªå­˜æ”¾å…ƒç´ çš„ä½ç½®)æˆ– å¾ªç¯å›åˆ°åŸç‚¹ï¼Œè¡¨ç¤ºæŸ¥æ‰¾å¤±è´¥*/ if (hashTable[hashAddress] == 0 || hashAddress == hash(hashTable, target)) { return -1; } } return hashAddress; } å®Œæ•´ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š public class HashSearch { /*å¾…æŸ¥æ‰¾åºåˆ—*/ static int[] array = {13, 29, 27, 28, 26, 30, 38}; /* åˆå§‹åŒ–å“ˆå¸Œè¡¨é•¿åº¦ï¼Œæ­¤å¤„å“ˆå¸Œè¡¨å®¹é‡è®¾ç½®çš„å’Œarrayé•¿åº¦ä¸€æ ·ã€‚ * å…¶å®æ­£å¸¸æƒ…å†µä¸‹ï¼Œå“ˆå¸Œè¡¨é•¿åº¦åº”è¯¥è¦é•¿äºarrayé•¿åº¦ï¼Œå› ä¸ºä½¿ç”¨ * å¼€æ”¾åœ°å€æ³•æ—¶ï¼Œå¯èƒ½ä¼šå¤šä½¿ç”¨ä¸€äº›ç©ºä½ç½® */ static int hashLength = 7; static int[] hashTable = new int[hashLength]; public static void main(String[] args) { /*å°†å…ƒç´ æ’å…¥åˆ°å“ˆå¸Œè¡¨ä¸­*/ for (int i = 0; i &lt; array.length; i++) { insertHashTable(hashTable, array[i]); } System.out.println(&quot;å“ˆå¸Œè¡¨ä¸­çš„æ•°æ®ï¼š&quot;); printHashTable(hashTable); int data = 28; System.out.println(&quot;\\nè¦æŸ¥æ‰¾çš„æ•°æ®&quot;+data); int result = searchHashTable(hashTable, data); if (result == -1) { System.out.println(&quot;å¯¹ä¸èµ·ï¼Œæ²¡æœ‰æ‰¾åˆ°ï¼&quot;); } else { System.out.println(&quot;åœ¨å“ˆå¸Œè¡¨ä¸­çš„ä½ç½®æ˜¯ï¼š&quot; + result); } } /*å°†å…ƒç´ æ’å…¥åˆ°å“ˆå¸Œè¡¨ä¸­*/ public static void insertHashTable(int[] hashTable, int target) { int hashAddress = hash(hashTable, target); /*å¦‚æœä¸ä¸º0ï¼Œåˆ™è¯´æ˜å‘ç”Ÿå†²çª*/ while (hashTable[hashAddress] != 0) { /*åˆ©ç”¨å¼€æ”¾å®šå€æ³•è§£å†³å†²çªï¼Œå³å‘åå¯»æ‰¾æ–°åœ°å€*/ hashAddress = (++hashAddress) % hashTable.length; } /*å°†å…ƒç´ æ’å…¥åˆ°å“ˆå¸Œè¡¨ä¸­*/ hashTable[hashAddress] = target; } public static int searchHashTable(int[] hashTable, int target) { int hashAddress = hash(hashTable, target); while (hashTable[hashAddress] != target) { /*å¯»æ‰¾åŸå§‹åœ°å€åé¢çš„ä½ç½®*/ hashAddress = (++hashAddress) % hashTable.length; /*æŸ¥æ‰¾åˆ°å¼€æ”¾å•å…ƒ(æœªå­˜æ”¾å…ƒç´ çš„ä½ç½®)æˆ– å¾ªç¯å›åˆ°åŸç‚¹ï¼Œè¡¨ç¤ºæŸ¥æ‰¾å¤±è´¥*/ if (hashTable[hashAddress] == 0 || hashAddress == hash(hashTable, target)) { return -1; } } return hashAddress; } /*ç”¨é™¤ç•™ä½™æ•°æ³•è®¡ç®—è¦æ’å…¥å…ƒç´ çš„åœ°å€*/ public static int hash(int[] hashTable, int data) { return data % hashTable.length; } public static void printHashTable(int[] hashTable) { for(int i=0;i&lt;hashTable.length;i++) System.out.print(hashTable[i]+&quot; &quot;); } } æµ‹è¯•ç»“æœï¼š å“ˆå¸Œè¡¨ä¸­çš„æ•°æ®ï¼š 27 29 28 30 38 26 13 è¦æŸ¥æ‰¾çš„æ•°æ®28 åœ¨å“ˆå¸Œè¡¨ä¸­çš„ä½ç½®æ˜¯ï¼š2 ","link":"https://tianxiawuhao.github.io/L2uhkBI__/"},{"title":"git-worktree","content":"åç§° git-worktree - ç®¡ç†é™„åŠ åˆ°åŒä¸€å­˜å‚¨åº“çš„å¤šä¸ªå·¥ä½œæ ‘ã€‚ è¯­æ³• git worktree add [-f] [--detach] [--checkout] [--lock [--reason &lt;string&gt;]] [-b &lt;new-branch&gt;] &lt;path&gt; [&lt;commit-ish&gt;] git worktree list [--porcelain] git worktree lock [--reason &lt;string&gt;] &lt;worktree&gt; git worktree move &lt;worktree&gt; &lt;new-path&gt; git worktree prune [-n] [-v] [--expire &lt;expire&gt;] git worktree remove [-f] &lt;worktree&gt; git worktree repair [&lt;path&gt;â€¦] git worktree unlock &lt;worktree&gt; æè¿° ç®¡ç†é™„åŠ åˆ°åŒä¸€å­˜å‚¨åº“çš„å¤šä¸ªå·¥ä½œæ ‘ã€‚ä¸€ä¸ª git å­˜å‚¨åº“å¯ä»¥æ”¯æŒå¤šä¸ªå·¥ä½œæ ‘ï¼Œå…è®¸æ‚¨ä¸€æ¬¡æ£€å‡ºå¤šä¸ªåˆ†æ”¯ã€‚ ä½¿ç”¨ git worktree æ·»åŠ ä¸€ä¸ªæ–°çš„å·¥ä½œæ ‘ä¸å­˜å‚¨åº“ç›¸å…³è”ã€‚ è¿™ä¸ªæ–°çš„å·¥ä½œæ ‘è¢«ç§°ä¸ºâ€œé“¾æ¥å·¥ä½œæ ‘â€ï¼Œè€Œä¸æ˜¯ git-init(1) æˆ– git-clone(1) å‡†å¤‡çš„â€œä¸»å·¥ä½œæ ‘â€ã€‚ ä¸€ä¸ªå­˜å‚¨åº“æœ‰ä¸€ä¸ªä¸»å·¥ä½œæ ‘ï¼ˆå¦‚æœå®ƒä¸æ˜¯ä¸€ä¸ªè£¸å­˜å‚¨åº“ï¼‰å’Œé›¶ä¸ªæˆ–å¤šä¸ªé“¾æ¥å·¥ä½œæ ‘ã€‚ å®Œæˆé“¾æ¥å·¥ä½œæ ‘åï¼Œä½¿ç”¨ git worktree remove å°†å…¶åˆ é™¤ã€‚ åœ¨æœ€ç®€å•çš„å½¢å¼ä¸­ï¼Œ git worktree add ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°åˆ†æ”¯ï¼Œå…¶åç§°æ˜¯ çš„æœ€åä¸€ä¸ªç»„æˆéƒ¨åˆ†ï¼Œå¦‚æœæ‚¨æ‰“ç®—å¤„ç†ä¸€ä¸ªæ–°ä¸»é¢˜ï¼Œè¿™å¾ˆæ–¹ä¾¿ã€‚ ä¾‹å¦‚ï¼Œ git worktree add ../hotfix åˆ›å»ºæ–°çš„åˆ†æ”¯ hotfix å¹¶åœ¨è·¯å¾„ ../hotfix å¤„æ£€å‡ºã€‚ è¦æ”¹ä¸ºåœ¨æ–°å·¥ä½œæ ‘ä¸­çš„ç°æœ‰åˆ†æ”¯ä¸Šå·¥ä½œï¼Œè¯·ä½¿ç”¨ git worktree add ã€‚ å¦ä¸€æ–¹é¢ï¼Œå¦‚æœæ‚¨åªæ˜¯æ‰“ç®—è¿›è¡Œä¸€äº›å®éªŒæ€§æ›´æ”¹æˆ–åœ¨ä¸å¹²æ‰°ç°æœ‰å¼€å‘çš„æƒ…å†µä¸‹è¿›è¡Œæµ‹è¯•ï¼Œé‚£ä¹ˆåˆ›å»ºä¸€ä¸ªä¸ä¸ä»»ä½•åˆ†æ”¯å…³è”çš„ä¸€æ¬¡æ€§å·¥ä½œæ ‘é€šå¸¸ä¼šå¾ˆæ–¹ä¾¿ã€‚ ä¾‹å¦‚ï¼Œ git worktree add -d åœ¨ä¸å½“å‰åˆ†æ”¯ç›¸åŒçš„æäº¤å¤„åˆ›å»ºä¸€ä¸ªå…·æœ‰åˆ†ç¦» HEAD çš„æ–°å·¥ä½œæ ‘ å¦‚æœåœ¨ä¸ä½¿ç”¨ git worktree remove çš„æƒ…å†µä¸‹åˆ é™¤äº†å·¥ä½œæ ‘ï¼Œåˆ™å…¶ä½äºå­˜å‚¨åº“ä¸­çš„ç›¸å…³ç®¡ç†æ–‡ä»¶ï¼ˆè¯·å‚é˜…ä¸‹é¢çš„â€œè¯¦ç»†ä¿¡æ¯â€ï¼‰æœ€ç»ˆå°†è¢«è‡ªåŠ¨åˆ é™¤ï¼ˆè¯·å‚é˜… git-config(1) ä¸­çš„ gc.worktreePruneExpireï¼‰ï¼Œ æˆ–è€…æ‚¨å¯ä»¥åœ¨ä¸»å·¥ä½œæ ‘æˆ–ä»»ä½•é“¾æ¥çš„å·¥ä½œæ ‘ä¸­è¿è¡Œ git worktree prune æ¥æ¸…ç†ä»»ä½•é™ˆæ—§çš„ç®¡ç†æ–‡ä»¶ã€‚ å¦‚æœé“¾æ¥çš„å·¥ä½œæ ‘å­˜å‚¨åœ¨ä¸æ€»æ˜¯æŒ‚è½½çš„ä¾¿æºå¼è®¾å¤‡æˆ–ç½‘ç»œå…±äº«ä¸Šï¼Œæ‚¨å¯ä»¥é€šè¿‡å‘å‡º git worktree lock å‘½ä»¤æ¥é˜²æ­¢å…¶ç®¡ç†æ–‡ä»¶è¢«ä¿®å‰ªï¼Œå¯é€‰åœ°æŒ‡å®š --reason æ¥è§£é‡Šå·¥ä½œæ ‘è¢«é”å®šçš„åŸå›  . åˆå§‹åŒ–ä¸€ä¸ªä»“åº“ $ git init Initialized empty Git repository in D:/VSCode/testGit/.git/ user@NAME MINGW64 /d/VSCode/testGit (master) $ git status $ git add . $ git commit -m 'f commit' [master (root-commit) f7f05d0] f commit 3 files changed, 18 insertions(+) create mode 100644 blob.config create mode 100644 copy.sh create mode 100644 fff.txt ## æ–°å»ºä¸¤ä¸ªåˆ†æ”¯å user@NAME MINGW64 /d/VSCode/testGit (master) $ git branch -a dev * master release æ–°å»ºå·¥ä½œæ ‘ add git worktree add [-f] [--detach] [--checkout] [--lock [--reason &lt;string&gt;]] [-b &lt;new-branch&gt;] &lt;path&gt; [&lt;commit-ish&gt;] ## åˆ›å»ºä¸€ä¸ªæ–°å·¥ä½œæ ‘wtree1 $ git worktree add ./wtree1 Preparing worktree (new branch 'wtree1') HEAD is now at f7f05d0 f commit user@NAME MINGW64 /d/VSCode/testGit (master) $ git worktree list D:/VSCode/testGit f7f05d0 [master] D:/VSCode/testGit/wtree1 f7f05d0 [wtree1] é”å®šï¼ˆè§£é”ï¼‰å·¥ä½œæ ‘ lock/unlock é”å®šçš„å·¥ä½œæ ‘å¯ä»¥é˜²æ­¢è¢«ä¿®å‰ªï¼ˆpruneï¼‰ user@NAME MINGW64 /d/VSCode/testGit (master) $ git worktree lock --reason='lock reason' wtdev user@NAME MINGW64 /d/VSCode/testGit (master) $ git worktree list D:/VSCode/testGit f4c1226 [master] D:/VSCode/wt/wtdev 8ec2b56 [dev] locked D:/VSCode/wt/wtree1 e14fd71 [wtree1] D:/VSCode/wt/wtree2 8ec2b56 [dev] D:/VSCode/wt/wtree3 e3a3c4c (detached HEAD) D:/VSCode/wt/wtree4 e4b08e3 [nb-wtree4] ## è§£é” user@NAME MINGW64 /d/VSCode/wt/wtree5 (wtree5) $ git worktree unlock wtdev å±•ç¤ºå·¥ä½œæ ‘åˆ—è¡¨ list ## git worktree list [--porcelain] user@NAME MINGW64 /d/VSCode/testGit (master) $ git worktree list D:/VSCode/testGit f4c1226 [master] D:/VSCode/wt/wtdev 2c05e7a [dev] D:/VSCode/wt/wtree1 e14fd71 [wtree1] D:/VSCode/wt/wtree2 2c05e7a [dev] D:/VSCode/wt/wtree3 e3a3c4c (detached HEAD) D:/VSCode/wt/wtree4 e4b08e3 [nb-wtree4] D:/VSCode/wt/wtree5 f4c1226 [wtree5] locked D:/VSCode/wt/wtrele 7f91b4d [release] åˆ é™¤å·¥ä½œæ ‘ remove $ git worktree remove wtree2 fatal: 'wtree2' contains modified or untracked files, use --force to delete it ## ä½¿ç”¨ -f å¼ºåˆ¶åˆ é™¤ user@NAME MINGW64 /d/VSCode/testGit (master) $ git worktree remove -f wtree2 ä¿®å‰ªå·¥ä½œæ ‘ prune ## å½“å‰ä»“åº“ä¸­çš„å·¥ä½œæ ‘çŠ¶æ€ï¼Œwtree5 è¢«é”å®š $ git worktree list D:/VSCode/testGit f4c1226 [master] D:/VSCode/wt/wtdev 2c05e7a [dev] D:/VSCode/wt/wtree1 e14fd71 [wtree1] D:/VSCode/wt/wtree3 e3a3c4c (detached HEAD) D:/VSCode/wt/wtree4 e4b08e3 [nb-wtree4] D:/VSCode/wt/wtree5 f4c1226 [wtree5] locked D:/VSCode/wt/wtrele 7f91b4d [release] ## æ‰‹åŠ¨åˆ é™¤å·¥ä½œæ ‘ç›®å½• D:/VSCode/wt/wtrele ä¸” æŠŠwtree4ã€wtree5 ç§»åŠ¨åˆ°å…¶ä»–ç›®å½• åçš„çŠ¶æ€ $ git worktree list D:/VSCode/testGit f4c1226 [master] D:/VSCode/wt/wtdev 2c05e7a [dev] D:/VSCode/wt/wtree1 e14fd71 [wtree1] D:/VSCode/wt/wtree3 e3a3c4c (detached HEAD) D:/VSCode/wt/wtree4 e4b08e3 [nb-wtree4] prunable ## å¯ä¿®å‰ª D:/VSCode/wt/wtree5 f4c1226 [wtree5] locked D:/VSCode/wt/wtrele 7f91b4d [release] prunable ## å¯ä¿®å‰ª ## ä¿®å‰ªå çš„å·¥ä½œæ ‘ï¼Œè¢«é”å®šçš„å·¥ä½œæ ‘æ²¡æœ‰å˜åŒ– ï¼Œå…¶ä»–â€˜å¯ä¿®å‰ªâ€™å·¥ä½œæ ‘è¢«åˆ é™¤ $ git worktree prune $ git worktree list D:/VSCode/testGit f4c1226 [master] D:/VSCode/wt/wtdev 2c05e7a [dev] D:/VSCode/wt/wtree1 e14fd71 [wtree1] D:/VSCode/wt/wtree3 e3a3c4c (detached HEAD) D:/VSCode/wt/wtree5 f4c1226 [wtree5] locked é‡æ–°å…³è”å·¥ä½œæ ‘ repair ## è¢«ä¿®å‰ªæ‰äº†çš„å·¥ä½œæ ‘æ— æ³•è¢«é‡æ–°å…³è” user@NAME MINGW64 /d/VSCode/wt/wtinner/wtree4 $ git worktree repair ../../../testGit/ fatal: not a git repository: D:/VSCode/testGit/.git/worktrees/wtree4 ## è¢«é”å®šçš„å·¥ä½œæ ‘æ²¡æœ‰è¢«ä¿®å‰ªï¼ˆpruneï¼‰æ‰ï¼Œæ‰€æœ‰é‡æ–°å…³è”ä¸Šäº† user@NAME MINGW64 /d/VSCode/wt/wtinner/wtree5 (wtree5) $ git worktree repair ../../../testGit/ ## ç°åœ¨æŠŠ wtree3 ç§»åŠ¨åˆ°å…¶ä»–ç›®å½• $ git worktree list D:/VSCode/testGit f4c1226 [master] D:/VSCode/wt/wtdev 2c05e7a [dev] D:/VSCode/wt/wtree1 e14fd71 [wtree1] D:/VSCode/wt/wtree3 e3a3c4c (detached HEAD) prunable ## å¯ä¿®å‰ª D:/VSCode/wt/wtree5 f4c1226 [wtree5] locked ## åœ¨ä¿®å‰ªä¹‹å‰ç›´æ¥repair ,ä¹Ÿå¯ä»¥æˆåŠŸå…³è” $ cd wt/wtinner/wtree3 user@NAME MINGW64 /d/VSCode/wt/wtinner/wtree3 ((e3a3c4c...)) $ git worktree repair ../../../testGit/ ","link":"https://tianxiawuhao.github.io/uA0v93Wq7/"},{"title":"ç‹æ ‘æ£®æ·±åº¦å¼ºåŒ–å­¦ä¹ ç¬”è®°12ï¼šç­–ç•¥æ¢¯åº¦ä¸­çš„åŸºå‡†ï¼ˆPolicy Gradient with Baselineï¼‰","content":"æˆ‘ä»¬åœ¨ç­–ç•¥æ¢¯åº¦ä¸­åŠ å…¥Baselineå¯ä»¥é™ä½æ–¹å·®ï¼Œè®©ç­–ç•¥å‡½æ•°æ”¶æ•›æ›´å¿«ï¼Œæˆ‘ä»¬ç”¨è¿™ç§ç­–ç•¥æ¢¯åº¦æ¥å­¦ä¹ ç­–ç•¥ç½‘ç»œã€‚ é¦–å…ˆæ¥å›é¡¾ä¸€ä¸‹ç­–ç•¥æ¢¯åº¦ï¼š ä¸€ã€åŸºå‡†ï¼ˆBaselineï¼‰ æˆ‘ä»¬é‡‡ç”¨baselineæ¥é™ä½æ–¹å·®ï¼Œå¯ä»¥è®©æ”¶æ•›æ›´å¿«ã€‚baselineè®°ä¸ºbï¼Œå®ƒå¯ä»¥æ˜¯ä»»ä½•æ•°ï¼Œä½†ä¸èƒ½ä¾èµ–äºåŠ¨ä½œAã€‚ æ¥ä¸‹æ¥è¯æ˜baselineçš„ç†è®ºæ€§è´¨ï¼š è¿™é‡Œæˆ‘ä»¬å‘ç°ï¼Œå¦‚æœbä¸åŠ¨ä½œAæ— å…³ï¼Œç­‰å¼=0 é‚£ä¹ˆæˆ‘ä»¬å°±å¾—åˆ°äº†ç­–ç•¥æ¢¯åº¦çš„baselineå½¢å¼ï¼š bä¸ä¼šå½±å“ç­–ç•¥æ¢¯åº¦ï¼Œä½†ä¼šå½±å“åˆ°è’™ç‰¹å¡æ´›è¿‘ä¼¼ã€‚å¦‚æœbçš„å–å€¼æ¥è¿‘QÏ€ï¼Œé‚£ä¹ˆbä¼šè®©è’™ç‰¹å¡æ´›è¿‘ä¼¼çš„æ–¹å·®é™ä½ï¼Œæ”¶æ•›é€Ÿåº¦æ›´å¿«ã€‚ äºŒã€è’™ç‰¹å¡æ´›è¿‘ä¼¼ï¼ˆMonte Carlo Approximationï¼‰ è¿™ä¸ªå…¬å¼ï¼Œæ˜¯æˆ‘ä»¬åˆšåˆšæ¨å¯¼çš„å¸¦æœ‰baselineçš„ç­–ç•¥æ¢¯åº¦å…¬å¼ï¼š å› æ­¤è¿™é‡Œæˆ‘ä»¬è®°ï¼ŒæœŸæœ›å†…éƒ¨çš„æ•°å€¼ä¸ºgï¼ˆAtï¼‰ï¼Œæˆ‘ä»¬æ ¹æ®ç­–ç•¥Ï€å¯¹aè¿›è¡Œä¸€æ¬¡éšæœºæŠ½æ ·å¾—åˆ°atï¼Œå¹¶è®¡ç®—g(at)ã€‚ è¿™é‡Œçš„g(at)æ˜¯å…³äºç­–ç•¥æ¢¯åº¦çš„ä¸€ä¸ªæ— åä¼°è®¡ï¼š å› è€Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªéšæœºç­–ç•¥æ¢¯åº¦ï¼Œå¹¶é‡‡ç”¨éšæœºæ¢¯åº¦ä¸Šå‡æ¥è·å–åˆ°æœ€ä¼˜ç­–ç•¥ æˆ‘ä»¬è¯æ˜baselineä¸ä¼šå½±å“åˆ°E[g(At)]ï¼Œä½†æ ¹æ®ä¸Šå¼æˆ‘ä»¬å‘ç°bå®é™…æ˜¯å½±å“å®ƒçš„è’™ç‰¹å¡æ´›è¿‘ä¼¼ï¼Œå³å®é™…è§‚æµ‹åˆ°çš„g(at)ã€‚å› æ­¤ï¼Œä¸€ä¸ªå¥½çš„bå¯ä»¥å‡å°æ–¹å·®å¹¶åŠ é€Ÿæ”¶æ•›ã€‚ ä¸‰ã€åŸºå‡†çš„é€‰æ‹©ï¼ˆChoice of Baselineï¼‰ 1ï¼‰Choice 1ï¼šb = 0 2ï¼‰Choice 2ï¼šb = VÏ€(st) ","link":"https://tianxiawuhao.github.io/cFQZiMqpR/"},{"title":"ç‹æ ‘æ£®æ·±åº¦å¼ºåŒ–å­¦ä¹ ç¬”è®°11ï¼šDueling Network","content":"ä¸€ã€ä¼˜åŠ¿å‡½æ•°ï¼ˆAdvantage Functionï¼‰ é¦–å…ˆå›é¡¾æŠ˜æ‰£å›æŠ¥ã€åŠ¨ä½œä»·å€¼å‡½æ•°å’ŒçŠ¶æ€ä»·å€¼å‡½æ•°ï¼š æ¥ä¸‹æ¥æ˜¯æœ€ä¼˜åŠ¨ä½œä»·å€¼å‡½æ•°å’Œæœ€ä¼˜çŠ¶æ€ä»·å€¼å‡½æ•°ï¼š è¿™é‡Œæˆ‘ä»¬å¼•å…¥ä¸€ä¸ªæ–°çš„æ¦‚å¿µï¼šæœ€ä¼˜ä¼˜åŠ¿å‡½æ•°ã€‚å®ƒæ˜¯ç”±æœ€ä¼˜åŠ¨ä½œä»·å€¼å‡½æ•°å’Œæœ€ä¼˜çŠ¶æ€ä»·å€¼å‡½æ•°ç¡®å®šçš„ã€‚è¿™é‡ŒæŠŠæœ€ä¼˜çŠ¶æ€ä»·å€¼å‡½æ•°ä½œä¸ºbaselineï¼Œå®ƒçš„å®é™…æ„ä¹‰æ˜¯åŠ¨ä½œaç›¸å¯¹äºbaselineçš„ä¼˜åŠ¿ï¼ŒåŠ¨ä½œaè¶Šå¥½ï¼Œä¼˜åŠ¿å°±è¶Šå¤§ã€‚ ä¸ºäº†æ¨å¯¼å‡ºDueling Networkï¼Œæˆ‘ä»¬éœ€è¦åˆ†æä¼˜åŠ¿å‡½æ•°çš„ä¸€ä¸ªç†è®ºæ€§è´¨ã€‚ è¿™éœ€è¦ä¸€ä¸ªå®šç†ï¼š è¿™é‡Œæœ‰ä¸€ä¸ªæ¨å¯¼ï¼š å°†A*(s,a)å˜æ¢ä¸€ä¸‹ï¼Œå¯ä»¥å¾—åˆ°ï¼š åˆå› ä¸ºmaxA*=0ï¼Œæ‰€ä»¥å¯ä»¥å¾—åˆ°ï¼šå®šç†2 äºŒã€Dueling Network å›é¡¾ä¸€ä¸‹DQNï¼š è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨ä¸€ä¸ªç¥ç»ç½‘ç»œå¯¹ä¼˜åŠ¿å‡½æ•°A*(s,a;w^A)çš„è¿‘ä¼¼ï¼š æˆ‘ä»¬éœ€è¦ä¸€ä¸ªç¥ç»ç½‘ç»œæ¥è¿‘ä¼¼æœ€ä¼˜çŠ¶æ€ä»·å€¼å‡½æ•°V*(s;w^V) æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸¤ä¸ªç¥ç»ç½‘ç»œéƒ½æœ‰ç€ç›¸ä¼¼çš„ç»“æ„ï¼Œå³åˆ©ç”¨å·ç§¯å±‚å¯¹è¾“å…¥æå–ç‰¹å¾ã€‚é‚£ä¹ˆæˆ‘ä»¬åœ¨çœŸæ­£å®ç°è¿™ä¸¤ä¸ªç¥ç»ç½‘ç»œæ—¶å°±å¯ä»¥è®©ä»–ä»¬å…±äº«ç¥ç»ç½‘ç»œå‚æ•°ã€‚ æœ‰äº†è¿™ä¸¤ä¸ªè¿‘ä¼¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°è¿™å¦‚ä¸‹å…¬å¼ï¼š è¿™é‡Œçš„Q(s,a;wA,wV)å³Dueling Networkï¼Œè¿™é‡Œç”¨wæ¥ä»£æ›¿(wA,wV) å¦‚ä¸‹å°±æ˜¯æ•´ä½“æµç¨‹ï¼š Dueling Networkä¸DQNçš„ç»“æ„ç›¸ä¼¼ï¼Œä½†Dueling Networkæ¯”DQNçš„ç¥ç»ç½‘ç»œç»“æ„æ›´å¥½ï¼Œæ•ˆæœä¹Ÿæ›´å¥½ã€‚ å€¼å¾—ä¸€æçš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨è®­ç»ƒDueling Networkæ—¶ï¼Œå¯ä»¥é‡‡ç”¨çš„è®­ç»ƒæ–¹æ³•ï¼šPER,DDQN,Multi-Step TD targetç­‰ ä¸‰ã€è§£å†³ä¸å”¯ä¸€æ€§ï¼ˆOvercome Non-identifiabilityï¼‰ å¦‚æœä¸åŠ æœ€å¤§åŒ–ï¼Œå¯èƒ½ä¼šå‡ºç°Vå’ŒAéƒ½è®­ç»ƒä¸å¥½ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœè®°V' = V*+10ï¼ŒA' = A*-10ï¼Œå®ƒä»¬çš„å’Œå¹¶ä¸ä¼šå¯¹Qäº§ç”Ÿå½±å“ï¼Œä½†å®é™…ä¸Šï¼ŒVå’ŒAéƒ½äº§ç”Ÿäº†å¾ˆå¤§çš„æ³¢åŠ¨ï¼Œé€ æˆäº†Vå’ŒAå¯¹åº”çš„ç¥ç»ç½‘ç»œéƒ½è®­ç»ƒä¸å¥½çš„ç»“æœã€‚ è€ŒåŠ äº†æœ€å¤§åŒ–è¿™ä¸€é¡¹ï¼Œå¯ä»¥å¾ˆå¥½çš„ä¿æŒVå’ŒAå¯¹åº”çš„ç¥ç»ç½‘ç»œçš„å¹³è¡¡ å››ã€æ€»ç»“ï¼ˆSummaryï¼‰ MARKï¼šè¦æŠŠDueling Networkå½“æˆä¸€ä¸ªæ•´ä½“å»è®­ç»ƒè€Œä¸æ˜¯åˆ†åˆ«å•ç‹¬çš„å»è®­ç»ƒå¯¹åº”çš„ç¥ç»ç½‘ç»œ ","link":"https://tianxiawuhao.github.io/HCoq7nVQ7/"},{"title":"ç‹æ ‘æ£®æ·±åº¦å¼ºåŒ–å­¦ä¹ ç¬”è®°10ï¼šé«˜ä¼°é—®é¢˜ã€ç›®æ ‡ç½‘ç»œã€DDQNï¼ˆOverestimateã€Target Networkã€Double DQNï¼‰","content":"ä¸€ã€è‡ªä¸¾é—®é¢˜ï¼ˆBootstrappingï¼‰ åœ¨å¼ºåŒ–å­¦ä¹ ä¸­ï¼ŒBootstrappingçš„æ„æ€æ˜¯ç”¨ä¸€ç§ä¼°ç®—å»æ›´æ–°åŒç±»çš„ä¼°ç®—ã€‚ é¦–å…ˆæ¥ï¼Œçœ‹ä¸€ä¸‹TD target ytï¼Œå®ƒåŒ…å«å½“å‰è§‚æµ‹åˆ°çš„å¥–åŠ±rtå’ŒDQNå¯¹ä¸‹ä¸€æ­¥çŠ¶æ€å’ŒåŠ¨ä½œçš„é¢„æµ‹å€¼ã€‚ ç„¶åæˆ‘ä»¬é‡‡ç”¨éšæœºæ¢¯åº¦ä¸‹é™ï¼ˆSGDï¼‰æ¥æ›´æ–°DQNæ¨¡å‹å‚æ•°wã€‚è¿™é‡Œä½¿ç”¨çš„SGDç”¨åˆ°äº†ytï¼Œè€Œytåˆéƒ¨åˆ†åŸºäºDQNåœ¨t+1æ—¶åˆ»çš„ä¼°è®¡ã€‚å› æ­¤ï¼Œé‡‡ç”¨TDç®—æ³•æ¥æ›´æ–°DQNå°±æ˜¯ä¸€ä¸ªbootstrappingçš„ä¸€ä¸ªä¾‹å­ã€‚ äºŒã€é«˜ä¼°é—®é¢˜ï¼ˆProblem of Overestimationï¼‰ é¦–å…ˆï¼Œæˆ‘ä»¬è¦çŸ¥é“ï¼šTDç®—æ³•å¯èƒ½ä¼šå¯¼è‡´é«˜ä¼°çœŸå®çš„åŠ¨ä½œä»·å€¼ã€‚é€ æˆé«˜ä¼°çš„ä¸»è¦åŸå› æœ‰ä¸¤ä¸ªï¼š â‘ åŸå› ä¸€ï¼šè®¡ç®—TD targetæ—¶ä½¿ç”¨äº†æœ€å¤§åŒ–ï¼ˆThe Maximizationï¼‰ è¯æ˜å¦‚ä¸‹ï¼š é¦–å…ˆæˆ‘ä»¬è·å–åˆ°ä¸€äº›è§‚æµ‹åˆ°çœŸå®æ•°æ®ï¼šx1,x2,...,xnã€‚ç„¶ååœ¨è¿™äº›è§‚æµ‹å€¼ä¸­åŠ å…¥ä¸€äº›å‡å€¼ä¸º0çš„éšæœºå™ªå£°Q1,Q2,...,Qnã€‚ç”±äºå™ªå£°çš„å‡å€¼ä¸º0ï¼Œæ‰€ä»¥å¯¹Qçš„å‡å€¼æ±‚æœŸæœ›ï¼Œå°±ç­‰äºå¯¹xæ±‚æœŸæœ›ã€‚ç„¶è€Œï¼ŒQæœ€å¤§å€¼çš„æœŸæœ›å´ä¼šå¤§äºç­‰äºxçš„æœ€å¤§å€¼ï¼Œä¸”Qæœ€å°å€¼çš„æœŸæœ›ä¹Ÿä¼šå°äºç­‰äºxçš„æœ€å°å€¼ã€‚ è¿™é‡Œæˆ‘ä»¬å›åˆ°DQNçš„é«˜ä¼°é—®é¢˜ï¼šå‡è®¾æˆ‘ä»¬å¾—åˆ°äº†ä¸€äº›åŠ¨ä½œä»·å€¼ï¼Œx(a1),...,x(an)ï¼Œä¸”æœ‰ä¸€äº›DQNçš„å™ªå£°ä¼°è®¡Q(s,a1;w),...,Q(s,an;w)ã€‚è¿™é‡Œæˆ‘ä»¬å‡è®¾ä¼°è®¡æ˜¯æ— åçš„ï¼Œä¹Ÿå°±æ˜¯ä¸Šè¿°ä¸­Qçš„å‡å€¼ä¸º0ã€‚é‚£ä¹ˆè¿™é‡Œçš„qä½œä¸ºQ(s,a;w)çš„æœ€å¤§å€¼ï¼Œå°±ä¼šäº§ç”Ÿä¸Šè¿°çš„é«˜ä¼°é—®é¢˜ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ä¸Šé¢æˆ‘ä»¬å·²ç»çŸ¥é“äº†ï¼Œqæ˜¯x(a)çš„é«˜ä¼°ï¼Œå› æ­¤æˆ‘ä»¬è¿™é‡Œå‡è®¾qt+1æ˜¯å¯¹t+1æ—¶åˆ»çœŸå®çš„åŠ¨ä½œä»·å€¼çš„é¢„æµ‹ï¼Œå› æ­¤å®ƒæ˜¯é«˜ä¼°çš„ã€‚ç„¶è€Œæˆ‘ä»¬çš„TD targetæ˜¯å–å†³äºå½“å‰è§‚æµ‹åˆ°çš„å¥–åŠ±rtå’ŒDQNå¯¹qt+1çš„é¢„æµ‹ï¼Œå› æ­¤ä¹Ÿæ˜¯é«˜ä¼°çš„ã€‚è€ŒTDç®—æ³•çš„ç›®çš„å°±æ˜¯ä½¿Q(st,at;w)å‘TD targeté€¼è¿‘ï¼Œè€Œytæ˜¯ä¸€ä¸ªé«˜ä¼°çš„é‡ï¼Œç»§è€Œå¯¼è‡´Q(st,at;w)ä¹Ÿä¼šé«˜ä¼°çœŸå®çš„åŠ¨ä½œä»·å€¼ã€‚ â‘¡åŸå› äºŒï¼šè‡ªä¸¾äº§ç”Ÿçš„é«˜ä¼°é—®é¢˜ï¼ˆBootstrappingï¼‰ å¦‚æœå·²ç»äº§ç”Ÿäº†é«˜ä¼°ï¼Œé‚£ä¹ˆå†è¿›è¡ŒBootstrappingï¼Œé«˜ä¼°å°±ä¼šè¶Šæ¥è¶Šå¤§ã€‚ è¿™é‡Œè®¨è®ºä¸ºä»€ä¹ˆBootstrappingä¼šå¯¼è‡´é«˜ä¼°ï¼š æˆ‘ä»¬çŸ¥é“TD targetå®é™…ä¸Šæ˜¯ä½¿ç”¨äº†ä¸‹é¢çš„ä¸€ä¸ªæœ€å¤§åŒ–çš„å…¬å¼ï¼Œä¸”æˆ‘ä»¬ä½¿ç”¨TD targetç”¨äºæ›´æ–°Q(st,at;w)ã€‚å‡è®¾DQNå·²ç»äº§ç”Ÿäº†é«˜ä¼°çš„åŠ¨ä½œä»·å€¼ï¼Œé‚£ä¹ˆQ(st,at;w)å°±å·²ç»æ˜¯ä¸€ä¸ªé«˜ä¼°çš„é‡ã€‚ç„¶è€Œæˆ‘ä»¬é‡‡ç”¨äº†ä¸€ä¸ªæœ€å¤§åŒ–å…¬å¼ï¼Œä¼šä½¿qt+1æ›´å¤§ï¼Œè€Œæˆ‘ä»¬å†ä½¿ç”¨qt+1å»æ›´æ–°Q(st,at;w)å³å°†é«˜ä¼°çš„é‡ä¼ å›DQNç”¨äºæ›´æ–°æ¨¡å‹å‚æ•°ã€‚å› æ­¤ï¼Œé«˜ä¼°é—®é¢˜ä¼šè¶Šæ¥è¶Šä¸¥é‡ã€‚ æ€»ç»“ä¸€ä¸‹ï¼šç›´æ¥ä¸Šå›¾ é«˜ä¼°ä¸æ˜¯é—®é¢˜ã€‚æˆ‘ä»¬åœ¨é‡‡ç”¨æœ€å¤§åŒ–æ—¶ï¼Œå‚è€ƒçš„æ˜¯ç›¸å¯¹å€¼ï¼Œè€Œä¸æ˜¯ç»å¯¹å€¼ï¼Œå› æ­¤å¦‚æœæ˜¯å‡åŒ€çš„é«˜ä¼°å¹¶ä¸å½±å“å®é™…ç»“æœã€‚æœ‰é—®é¢˜çš„æ˜¯éå‡åŒ€çš„é«˜ä¼°ã€‚ è¿™é‡Œæœ‰ä¸¤ç§æ–¹æ³•ç”¨äºç¼“è§£é«˜ä¼°é—®é¢˜ï¼š â‘ ä½¿ç”¨ç›®æ ‡ç½‘ç»œï¼ˆTarget Networkï¼‰ â‘¡ä½¿ç”¨åŒDQN(Double DQN) ä¸‰ã€ç›®æ ‡ç½‘ç»œï¼ˆTarget Networkï¼‰ ç›¸æ¯”äºDQNï¼ŒTarget Networkæ˜¯ç‹¬ç«‹äºDQNçš„ã€‚å®ƒä¸DQNæœ‰ç€ç›¸åŒçš„ç¥ç»ç½‘ç»œç»“æ„ï¼Œä½†æœ‰ä¸åŒçš„å‚æ•°ï¼Œè®°ä½œw-ã€‚ æˆ‘ä»¬ä½¿ç”¨Q(s,a;w)æ¥æ§åˆ¶Agentå¹¶ä¸”æ”¶é›†ç»éªŒå³transition{(st,at,rt,st+1)}ã€‚ ä½¿ç”¨Q(s,q;w-)æ¥è®¡ç®—TD targetã€‚ ä»¥å‰ä½¿ç”¨DQNæ¥è®¡ç®—ytï¼Œç”¨ytæ¥æ›´æ–°DQNçš„å‚æ•°ã€‚è¿™ä¼šäº§ç”Ÿè‡ªä¸¾ã€‚ç°åœ¨æˆ‘ä»¬ä½¿ç”¨Target Networkï¼Œç”¨Target Networkæ¥è®¡ç®—ytã€‚è¿™æ ·å°±å¯ä»¥ç¼“è§£é«˜ä¼°é—®é¢˜ã€‚ æ³¨æ„ä¸€ä¸‹ï¼Œè¿™é‡Œè®¡ç®—TD targeté‡‡ç”¨çš„Target Networkï¼Œå‚æ•°ä¸ºw-ï¼Œè€Œéšæœºæ¢¯åº¦ä¸‹é™ï¼ˆSGDï¼‰ä»…ç”¨äºæ›´æ–°DQNçš„ç¥ç»ç½‘ç»œå‚æ•°w è¿™é‡Œç”¨å‡ ç§æ–¹æ³•ç”¨äºæ›´æ–°w- å¯¹æ¯”ä¸€ä¸‹ä¸¤ç§æ›´æ–°DQNçš„æ–¹æ³•ï¼š åŸå§‹æ–¹æ³•åˆ©ç”¨è‡ªä¸¾ï¼Œè¿™ä¼šé€ æˆé«˜ä¼°ã€‚ è€Œé‡‡ç”¨äº†Target Networkå¯ä»¥ç¼“è§£é«˜ä¼°é—®é¢˜ã€‚ å°½ç®¡é‡‡ç”¨ä¸Šè¿°æ–¹æ³•å¯ä»¥ç¼“è§£DQNæœ€å¤§åŒ–å’Œè‡ªä¸¾äº§ç”Ÿçš„é«˜ä¼°é—®é¢˜ï¼Œä½†ä»ä¸å¯é¿å…TDç®—æ³•æ‰€äº§ç”Ÿçš„é«˜ä¼°é—®é¢˜ã€‚ä¸‹é¢çš„åŒDQNï¼ˆDouble DQNï¼‰æ–¹æ³•å¯ä»¥æ›´æœ‰æ•ˆåœ°é¿å…é«˜ä¼°é—®é¢˜ã€‚ å››ã€åŒDQNï¼ˆDouble DQNï¼‰ 1ï¼‰ä¼ ç»ŸDQN ä¸ºäº†è¯´æ˜åŸå§‹DQNï¼ŒTarget Networkå’ŒDDQNä¹‹é—´çš„åŒºåˆ«ï¼Œè¿™é‡ŒæŠŠæ±‚æœ€å¤§åŒ–çš„è¿‡ç¨‹æ‹†æˆä¸¤æ­¥ï¼š TD targetçš„ç¬¬ä¸€æ­¥æ˜¯åšé€‰æ‹©ï¼š ç¬¬äºŒæ­¥æ˜¯è®¡ç®—TD targetï¼š è¿™ç§è®­ç»ƒæ–¹å¼æ•ˆæœæœ€å·®ã€‚ 2ï¼‰Target Network 3ï¼‰DDQN DDQNåœ¨ç¬¬ä¸€æ­¥æ±‚æœ€å¤§åŒ–çš„åŠ¨ä½œæ—¶ï¼Œé‡‡ç”¨äº†ä¼ ç»Ÿçš„DQNæ–¹æ³•ï¼Œè¿›è¡Œæ±‚å–æœ€ä¼˜åŠ¨ä½œa*ã€‚è€Œåœ¨ç¬¬äºŒæ­¥è¯„ä¼°TD targetæ—¶ï¼Œé‡‡ç”¨äº†Target Networkï¼Œå¾ˆå®¹æ˜“å¾—åˆ°å¦‚ä¸‹ä¸ç­‰å¼ï¼š äº”ã€æ€»ç»“ï¼ˆSummaryï¼‰ å¯¹æ¯”ä¸€ä¸‹ä¸‰ç§æ–¹æ³•è®¡ç®—TD Targetï¼š ","link":"https://tianxiawuhao.github.io/FrqjohR4Q/"},{"title":"ç‹æ ‘æ£®æ·±åº¦å¼ºåŒ–å­¦ä¹ ç¬”è®°9ï¼šç»éªŒå›æ”¾ Experience Replay","content":"ä¸€ã€å›é¡¾æ·±åº¦Qç½‘ç»œå’Œæ—¶åºå·®åˆ†ç®—æ³•ï¼ˆRevisiting DQN and TD Learningï¼‰ 1ï¼‰Deep Q Networkï¼ˆDQNï¼‰ DQNé‡‡ç”¨ä»·å€¼ç½‘ç»œQ(s,a;w)æ¥è¿‘ä¼¼æœ€ä¼˜åŠ¨ä½œä»·å€¼å‡½æ•°Q*(s,a) 2ï¼‰TD Learning æˆ‘ä»¬é€šå¸¸ä½¿ç”¨TDç®—æ³•æ¥è®­ç»ƒDQNï¼Œè¿™é‡Œæˆ‘ä»¬å›é¡¾ä¸€ä¸‹TDç®—æ³•çš„æ­¥éª¤ï¼š â‘ Agentåœ¨tæ—¶åˆ»è§‚æµ‹åˆ°ä¸€ä¸ªçŠ¶æ€stå¹¶åšå‡ºåŠ¨ä½œat â‘¡Agentä¸ç¯å¢ƒäº¤äº’è·å¾—äº†ä¸€ä¸ªæ–°çš„çŠ¶æ€st+1å¹¶ä¸”è·å¾—äº†ä¸€ä¸ªå¥–åŠ±rt â‘¢æ­¤æ—¶ï¼Œæˆ‘ä»¬å¾—åˆ°äº†TD Target yt â‘£ç»§è€Œå†™å‡ºTD error Î´t æˆ‘ä»¬çš„ç›®æ ‡æ˜¯è®©qtæ¥è¿‘ytï¼Œå³ä½¿TD error Î´tå°½é‡çš„å° å› æ­¤TDç®—æ³•å°±æ˜¯å¯»æ‰¾ä¸€ä¸ªç¥ç»ç½‘ç»œå‚æ•°wä½¿æŸå¤±å‡½æ•°ï¼ˆLoss Functionï¼‰L(w)å°½å¯èƒ½çš„å° â‘¤é‡‡ç”¨æ¢¯åº¦ä¸‹é™æ¥ä½¿wtä¸æ–­é€¼è¿‘w* (st,at,rt,st+1)æ˜¯ä¸€ä¸ªå››å…ƒç»„ï¼Œè¿™æ˜¯ä¸€ä¸ªtransitionï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ä¸€æ¡è®­ç»ƒæ•°æ®ï¼Œä¼ ç»Ÿç®—æ³•åœ¨ä½¿ç”¨å®Œè¯¥è®­ç»ƒæ•°æ®åå°±æŠŠå®ƒä¸¢æ‰ï¼Œä¸å†ä½¿ç”¨ï¼Œè¿™ç§å¯¹äºDQNçš„è®­ç»ƒæ•ˆæœå¹¶ä¸å¥½ã€‚ äºŒã€ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç»éªŒå›æ”¾ï¼ˆWhy use the Experience Replayï¼‰ å…¶å®ï¼Œå…³äºè®¨è®ºä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç»éªŒå›æ”¾ï¼Œå…¶å®å°±æ˜¯åœ¨è®¨è®ºä¸ä½¿ç”¨ç»éªŒå›æ”¾ä¼šæœ‰ä»€ä¹ˆç¼ºç‚¹ï¼Œä»¥åŠä½¿ç”¨äº†ç»éªŒå›æ”¾æœ‰ä»€ä¹ˆæœ‰ç‚¹ã€‚ 1ï¼‰ç¼ºç‚¹ä¸€ï¼šæµªè´¹ç»éªŒï¼ˆShortcoming 1ï¼šWatse of Experienceï¼‰ ä¼ ç»Ÿçš„TDç®—æ³•æ¯æ¬¡ä»…ä½¿ç”¨ä¸€ä¸ªtransitionï¼Œä½¿ç”¨å®Œåå°±ä¸¢æ‰ï¼Œä¸å†ä½¿ç”¨ï¼Œè¿™ä¼šé€ æˆæµªè´¹ 2ï¼‰ç¼ºç‚¹äºŒï¼šå…³è”æ€§æ›´æ–°ï¼ˆShortcoming 2ï¼šCorrelated Updatesï¼‰ ä¼ ç»ŸTDç®—æ³•ä¼šæŒ‰ç…§é¡ºåºä½¿ç”¨transition(st,at,rt,st+1)ï¼Œå‰åä¸¤æ¡transitionä¹‹é—´æœ‰å¾ˆå¼ºçš„å…³è”æ€§ï¼Œå³stå’Œst+1éå¸¸æ¥è¿‘ï¼Œå®éªŒè¡¨æ˜è¿™å¹¶ä¸åˆ©äºæŠŠDQNè®­ç»ƒçš„å¾ˆå¥½ã€‚ ä¸‰ã€ç»éªŒå›æ”¾ï¼ˆExperience Replayï¼‰ 1ï¼‰å›æ”¾ç¼“å†²åŒºï¼ˆReplay Bufferï¼‰ æˆ‘ä»¬åœ¨ä½¿ç”¨å®Œä¸€ä¸ªtransitionæ—¶ï¼Œä¼šæŠŠä¸€ä¸ªtransitionæ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—é‡Œï¼Œè¿™ä¸ªé˜Ÿåˆ—è¢«ç§°ä¹‹ä¸ºå›æ”¾ç¼“å†²åŒºï¼ˆReplay Bufferï¼‰ï¼Œå®ƒçš„å®¹é‡æ˜¯ä¸€ä¸ªè¶…å‚æ•°ï¼ˆHyper Parameterï¼‰nï¼ŒReplay Bufferå¯ä»¥å­˜å‚¨næ¡transitionsã€‚ å¦‚æœReplay Bufferæ»¡äº†ï¼Œé‚£ä¹ˆæ–°æ¥çš„transitionä¼šæ›¿ä»£è€çš„transition 2ï¼‰TDç®—æ³•ä¸­ç»éªŒå›æ”¾ï¼ˆTD with Experience Replayï¼‰ æˆ‘ä»¬é€šè¿‡æ‰¾åˆ°ç¥ç»ç½‘ç»œå‚æ•°wæ¥æœ€å°åŒ–æŸå¤±å‡½æ•°Loss Functionã€‚ æˆ‘ä»¬æ˜¯ç”¨éšæœºæ¢¯åº¦ä¸‹é™ï¼ˆStochastic Gradient Descent SGDï¼‰æ¥æœ€å°åŒ–æŸå¤±å‡½æ•°Loss Functionï¼šä»bufferä¸­éšæœºæŠ½å–ä¸€ä¸ªtransitionï¼ˆsi,ai,ri,si+1ï¼‰,ç„¶åè®¡ç®—TD error Î´iï¼Œå†ç®—å‡ºéšæœºæ¢¯åº¦ï¼ˆStochastic Gradientï¼‰giï¼Œä½¿ç”¨éšæœºæ¢¯åº¦ä¸‹é™(SGD)æ¥è°ƒæ•´ç¥ç»ç½‘ç»œå‚æ•°wã€‚ å€¼å¾—ä¸€æçš„æ˜¯ï¼Œå®è·µä¸­ï¼Œé€šå¸¸ä½¿ç”¨mini-batch SGD,å³æ¯æ¬¡æŠ½å–å¤šä¸ªtransitionsï¼Œç®—å‡ºå¤šä¸ªéšæœºæ¢¯åº¦ï¼Œåˆ©ç”¨è¿™å¤šä¸ªéšæœºæ¢¯åº¦çš„å¹³å‡æ¥æ›´æ–°ç¥ç»ç½‘ç»œå‚æ•°wã€‚ 3ï¼‰ç»éªŒå›æ”¾çš„ä¼˜åŠ¿ï¼ˆBenefits of Experience Replayï¼‰ â‘ æ‰“ç ´äº†ç»éªŒçš„ç›¸å…³æ€§ â‘¡é‡å¤åˆ©ç”¨è¿‡å»çš„ç»éªŒ å››ã€ä¼˜å…ˆç»éªŒå›æ”¾ï¼ˆPrioritized Experience Replayï¼‰ 1ï¼‰åŸºç¡€æ€æƒ³ï¼ˆBasic Ideaï¼‰ å¯¹äºAgentè€Œè¨€ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„transitionéƒ½æ˜¯åŒç­‰é‡è¦çš„ã€‚ä¾‹å¦‚åœ¨è¶…çº§ç›ä¸½æ¸¸æˆä¸­ï¼Œå·¦ä¾§çš„æ™®é€šå…³å¡å’Œå³ä¾§çš„bosså…³å¡ï¼Œå®ƒä»¬çš„é‡è¦æ€§å°±ä¸ä¸€æ ·ï¼šæ™®é€šå…³å¡å¾ˆå¸¸è§ï¼Œè€Œbosså…³å¡éœ€è¦é€šè¿‡å¾ˆå¤šæ™®é€šå…³å¡åæ‰èƒ½è¿›è¡Œã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»è®©Agentçæƒœæ•°é‡æ›´å°‘çš„bosså…³å¡ï¼Œå³è®©Agentå……åˆ†åˆ©ç”¨bosså…³å¡çš„è¿™ä¸€ç»éªŒã€‚ å®é™…è®­ç»ƒä¸­ï¼Œæˆ‘ä»¬æ€ä¹ˆæ ·è®©AgentçŸ¥é“å“ªä¸ªtransitionæ˜¯é‡è¦çš„å‘¢ï¼Ÿ å¯ä»¥ä½¿ç”¨TD errorçš„L1èŒƒå¼ï¼Œå³|Î´t|æ¥åˆ¤æ–­å®ƒçš„é‡è¦ã€‚|Î´t|è¶Šå¤§ï¼Œå°±è¯´æ˜transitionå°±è¶Šé‡è¦ï¼Œåº”è¯¥ç»™è¿™ä¸ªtransitionæ›´é«˜çš„ä¼˜å…ˆçº§ã€‚ è§£é‡Šä¸€ä¸‹ï¼šè®­ç»ƒå‡ºçš„DQNå¯¹äºæ•°é‡è¾ƒå°‘çš„åœºæ™¯ä¸ç†Ÿæ‚‰ï¼Œæ‰€ä»¥é¢„æµ‹å°±ä¼šåç¦»TD Targetï¼Œå› æ­¤äº§ç”Ÿçš„TD errorå°±æ¯”è¾ƒå¤§ï¼Œå³|Î´t|å°±å¤§ã€‚æ­£å› ä¸ºDQNä¸ç†Ÿæ‚‰æ•°é‡è¾ƒå°‘çš„åœºæ™¯ï¼Œæ‰€ä»¥è¦è®©DQNç»™è¿™äº›åœºæ™¯æ›´é«˜çš„ä¼˜å…ˆçº§ï¼Œè®©å®ƒæ›´å¥½çš„åº”å¯¹è¿™æ ·çš„åœºæ™¯ã€‚ 2ï¼‰æ ¸å¿ƒæƒ³æ³•ï¼ˆCore Ideaï¼‰ ä¼˜å…ˆç»éªŒå›æ”¾ï¼ˆPrioritized Experience Replayï¼‰çš„æ ¸å¿ƒåœ¨äºï¼šä½¿ç”¨éå‡åŒ€æŠ½æ ·ä»£æ›¿å‡åŒ€æŠ½æ ·ã€‚è¿™é‡Œæœ‰ä¸¤ç§æŠ½æ ·æ–¹å¼ï¼š â‘ æŠ½æ ·æ¦‚ç‡ptæ­£æ¯”äº|Î´t|+Îµ å…¶ä¸­ï¼ŒÎµæ˜¯ä¸€ä¸ªå¾ˆå°çš„æ•°ï¼Œé¿å…æŠ½æ ·æ¦‚ç‡ptç­‰äº0 â‘¡å¯¹|Î´t|æ’åº |Î´t|è¶Šå¤§è¶Šé å‰ï¼Œ|Î´t|è¶Šå°è¶Šé å ä¸¤ç§æ–¹æ³•çš„åŸç†éƒ½æ˜¯ä¸€æ ·çš„ï¼š|Î´t|è¶Šå¤§ï¼Œå°±æŠ½æ ·æ¦‚ç‡ptå°±è¶Šå¤§ã€‚ 3ï¼‰è°ƒæ•´å­¦ä¹ ç‡ï¼ˆScaling Learning Rateï¼‰ TDç®—æ³•é‡‡ç”¨SGDæ¥æ›´æ–°ç¥ç»ç½‘ç»œå‚æ•°wï¼ŒÎ±æ˜¯å­¦ä¹ ç‡ã€‚ å¦‚æœåšå‡åŒ€æŠ½æ ·ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„transitionsçš„å­¦ä¹ ç‡Î±éƒ½ç›¸åŒï¼›å¦‚æœåšéå‡åŒ€æŠ½æ ·ï¼Œé‚£ä¹ˆå°±è¦æ ¹æ®æ¯ä¸ªtransitionçš„é‡è¦æ€§æ¥è°ƒæ•´å­¦ä¹ ç‡ã€‚ å¦‚æœä¸€ä¸ªtransitionæœ‰ä¸€ä¸ªè¾ƒå¤§çš„æŠ½æ ·æ¦‚ç‡ptï¼Œé‚£ä¹ˆå¯¹è¿™ä¸ªtransitionçš„å­¦ä¹ ç‡å°±åº”è¯¥è°ƒå°ï¼Œå¯ä»¥é‡‡ç”¨å¦‚ä¸‹åœˆå‡ºçš„æ–¹æ³•æ¥è‡ªé€‚åº”è°ƒæ•´å­¦ä¹ ç‡çš„å› å­ï¼šå¦‚æœptå¾ˆå¤§ï¼Œé‚£ä¹ˆå­¦ä¹ ç‡å°±ä¼šå˜å° 4ï¼‰æ›´æ–°TD Errorï¼ˆUpdate TD Errorï¼‰ ä¸ºäº†åšä¼˜å…ˆç»éªŒå›æ”¾ï¼ˆPERï¼‰ï¼Œæˆ‘ä»¬è¦å¯¹æ¯ä¸€ä¸ªtransitionæ ‡è®°ä¸ŠTD error Î´tã€‚Î´tå†³å®šäº†è¿™æ¡transitionçš„é‡è¦æ€§ï¼Œå†³å®šäº†å®ƒè¢«æŠ½æ ·çš„æ¦‚ç‡ã€‚ å¦‚æœä¸€ä¸ªtransitionåˆšåˆšè¢«æ”¶é›†åˆ°ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“å®ƒçš„Î´tï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ç›´æ¥æŠŠå®ƒçš„Î´tè®¾ç½®ä¸ºæœ€å¤§å€¼ï¼Œè®©å®ƒæœ‰æœ€é«˜çš„ä¼˜å…ˆçº§ã€‚ æ¯æ¬¡ä»bufferä¸­æŠ½å–ä¸€ä¸ªtransitionï¼Œéƒ½è¦å¯¹å®ƒçš„Î´tè¿›è¡Œä¸€æ¬¡æ›´æ–° äº”ã€æ€»ç»“ï¼ˆSummaryï¼‰ ç›¸æ¯”äºä¼ ç»Ÿçš„ç»éªŒå›æ”¾ï¼ˆERï¼‰ï¼Œä¼˜å…ˆç»éªŒå›æ”¾ï¼ˆPERï¼‰åœ¨æ¯ä¸ªtransitionä¸­æ ‡æ³¨äº†Î´tï¼Œå¹¶æ ¹æ®Î´tçš„ä¸åŒæ¥ç¡®å®šä¸åŒçš„æŠ½æ ·æ¦‚ç‡å’Œå­¦ä¹ ç‡ï¼Œä»è€Œè¾¾åˆ°éå‡åŒ€æŠ½æ ·çš„æ•ˆæœã€‚ ç›´æ¥é™„å›¾ï¼š ","link":"https://tianxiawuhao.github.io/BOSW3NMIw/"},{"title":"ç‹æ ‘æ£®æ·±åº¦å¼ºåŒ–å­¦ä¹ ç¬”è®°8ï¼šMulti-Step TD Target","content":"ä¸€ã€Sarsaç®—æ³•ä¸Q-Learningç®—æ³•ï¼ˆSarsa versus Q-Learningï¼‰ 1ï¼‰Sarsa â‘ Sarsaç®—æ³•ç›®çš„æ˜¯ä¸ºäº†è®­ç»ƒåŠ¨ä½œä»·å€¼å‡½æ•°QÏ€(s,a) â‘¡TD Targetè®°ä½œytï¼Œå®ƒæ˜¯å½“å‰è§‚æµ‹åˆ°çš„å¥–åŠ±rtå’ŒåŠ¨ä½œä»·å€¼å‡½æ•°å¯¹äºä¸‹ä¸€çŠ¶æ€å’Œä¸‹ä¸€åŠ¨ä½œçš„é¢„æµ‹å€¼ä¹˜ä»¥æŠ˜æ‰£å› å­Î³ä¹‹å’Œ â‘¢æˆ‘ä»¬ä½¿ç”¨Sarsaç®—æ³•æ¥æ›´æ–°ä»·å€¼ç½‘ç»œï¼Œå³ACç®—æ³•ä¸­çš„Criticç½‘ç»œã€‚ 2ï¼‰Q-Learning â‘ Q-Learningæ˜¯ç”¨äºå­¦ä¹ æœ€ä¼˜åŠ¨ä½œä»·å€¼å‡½æ•°Q*(s,a) â‘¡TD Targetè®°ä½œytï¼Œæ˜¯å½“å‰è§‚æµ‹åˆ°çš„å¥–åŠ±rtä¸ä»·å€¼å‡½æ•°å¯¹äºä¸‹ä¸€æ­¥çŠ¶æ€ä¸‹æœ€ä¼˜åŠ¨ä½œçš„é¢„æµ‹å€¼ä¹˜ä»¥æŠ˜æ‰£å› å­Î³ä¹‹å’Œ â‘¢æˆ‘ä»¬ç”¨Q-Learningç®—æ³•æ¥æ›´æ–°DQNã€‚ ä¸ç®¡æ˜¯Sarsaè¿˜æ˜¯Q-Learningï¼Œå®ƒä»¬éƒ½åªä½¿ç”¨ä¸€ä¸ªå¥–åŠ±rtï¼Œå³åªä½¿ç”¨ä¸€ä¸ªtransitionä¸­çš„å¥–åŠ±rtï¼Œä¸‹ä¸€æ¬¡ä½¿ç”¨å¦ä¸ªtransitionæ¥æ›´æ–°åŠ¨ä½œä»·å€¼QÏ€ï¼Œè¿™ç§æ–¹å¼ç®—å‡ºæ¥çš„TD Targetå«åšOne-Step TD Targetã€‚ äºŒã€å¤šæ­¥TD Targetï¼ˆMulti-Step TD Targetï¼‰ å…¶å®ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤šä¸ªå¥–åŠ±ï¼Œå¦‚rt,rt+1ï¼Œå³ä½¿ç”¨å¤šä¸ªtransitionä¸­çš„å¥–åŠ±å»æ›´æ–°åŠ¨ä½œä»·å€¼QÏ€ï¼Œè¿™ç§æ–¹æ³•è®¡ç®—å‡ºæ¥çš„TD Targetå«åšMulti-Step TD Targetï¼Œ 1ï¼‰æ¨å¯¼å¤šæ­¥å›æŠ¥ï¼ˆDerive Mutil-Step Returnï¼‰ æˆ‘ä»¬å·²ç»çŸ¥é“çš„Utä¸Ut+1çš„å…³ç³»ï¼Œç„¶åå†è¿›è¡Œä¸€æ¬¡é€’å½’ï¼Œå°†Ut+1ç”¨Ut+2è¡¨ç¤ºï¼Œç»è¿‡å¤šæ­¥è¿­ä»£ï¼Œå› è€Œäº§ç”Ÿäº†Utä¸Ut+mçš„å…³ç³»ï¼Œè¿™ä¸ªå…¬å¼æˆ‘ä»¬å°±ç§°ä¹‹ä¸ºå¤šæ­¥å›æŠ¥ï¼ˆMutil-Step Returnï¼‰ 2ï¼‰Sarsaç®—æ³•ä¸­çš„å¤šæ­¥TD Targetï¼ˆm-Step TD Target for Sarsaï¼‰ â‘ å¤šæ­¥TD target â‘¡è‹¥m=1ï¼Œå³å•æ­¥TD targetï¼Œä¹Ÿå°±æ˜¯ç»å…¸çš„TDç®—æ³• éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§å•æ­¥çš„TD Targetçš„è®­ç»ƒæ•ˆæœå¾€å¾€ä¸å¦‚å¤šæ­¥çš„TD Targetçš„è®­ç»ƒæ•ˆæœ 3ï¼‰Q-Learningç®—æ³•ä¸­çš„å¤šæ­¥TD Targetï¼ˆm-Step TD Target for Q-Learningï¼‰ â‘ å¤šæ­¥TD target â‘¡è‹¥m=1ï¼Œå³å•æ­¥TD targetï¼Œä¹Ÿå°±æ˜¯ç»å…¸çš„TDç®—æ³• éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§å•æ­¥çš„TD Targetçš„è®­ç»ƒæ•ˆæœå¾€å¾€ä¸å¦‚å¤šæ­¥çš„TD Targetçš„è®­ç»ƒæ•ˆæœ ä¸‰ã€å•æ­¥TD Targetä¸å¤šæ­¥TD Targetå¯¹æ¯”ï¼ˆComparison of One-step TD target and Multi-step TD targetï¼‰ Multi-Step TD targetçš„è¡¨ç°æ›´å¥½ï¼Œæ›´æ¥è¿‘çœŸå®æ•°æ®ï¼Œåå·®æ›´å°ï¼Œç»“æœä¹Ÿæ›´ç¨³å®šï¼›è€Œå•æ­¥æ˜¯å¤šæ­¥çš„ç‰¹ä¾‹ã€‚ ","link":"https://tianxiawuhao.github.io/xWqlayf1I/"},{"title":"ç‹æ ‘æ£®æ·±åº¦å¼ºåŒ–å­¦ä¹ ç¬”è®°7ï¼šQ-Learningç®—æ³•","content":"ä¸€ã€Sarsaç®—æ³•ä¸Q-Learningç®—æ³•å¯¹æ¯” é¦–å…ˆæ¥å¯¹æ¯”ä¸€ä¸‹Sarsaå’ŒQ-Learning 1ï¼‰Sarsaç®—æ³• â‘ Sarsaç®—æ³•ç›®çš„æ˜¯ä¸ºäº†è®­ç»ƒåŠ¨ä½œä»·å€¼å‡½æ•°QÏ€(s,a) â‘¡TD Targetè®°ä½œytï¼Œå®ƒæ˜¯å½“å‰è§‚æµ‹åˆ°çš„å¥–åŠ±rtå’ŒåŠ¨ä½œä»·å€¼å‡½æ•°å¯¹äºä¸‹ä¸€çŠ¶æ€å’Œä¸‹ä¸€åŠ¨ä½œçš„é¢„æµ‹å€¼ä¹˜ä»¥æŠ˜æ‰£å› å­Î³ä¹‹å’Œ â‘¢æˆ‘ä»¬ä½¿ç”¨Sarsaç®—æ³•æ¥æ›´æ–°ä»·å€¼ç½‘ç»œï¼Œå³ACç®—æ³•ä¸­çš„Criticç½‘ç»œã€‚ 2ï¼‰Q-Learningç®—æ³• â‘ Q-Learningæ˜¯ç”¨äºå­¦ä¹ æœ€ä¼˜åŠ¨ä½œä»·å€¼å‡½æ•°Q*(s,a) â‘¡TD Targetè®°ä½œytï¼Œæ˜¯å½“å‰è§‚æµ‹åˆ°çš„å¥–åŠ±rtä¸ä»·å€¼å‡½æ•°å¯¹äºä¸‹ä¸€æ­¥çŠ¶æ€ä¸‹æœ€ä¼˜åŠ¨ä½œçš„é¢„æµ‹å€¼ä¹˜ä»¥æŠ˜æ‰£å› å­Î³ä¹‹å’Œ â‘¢æˆ‘ä»¬ç”¨Q-Learningç®—æ³•æ¥æ›´æ–°DQN äºŒã€æ¨å¯¼TD Targetï¼ˆDeriveTD Targetï¼‰ æˆ‘ä»¬å·²ç»çŸ¥é“å¯¹äºæ‰€æœ‰çš„Ï€ï¼Œå·²ç»æœ‰äº†å¦‚ä¸‹çš„ç­‰å¼ï¼š å¦‚æœè¿™é‡Œçš„Ï€æ˜¯æœ€ä¼˜ç­–ç•¥Ï€*ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰å¦‚ä¸‹çš„ç­‰å¼: æˆ‘ä»¬å¾€å¾€é‡‡ç”¨Qå»æ›¿æ¢Q_Ï€ï¼Œå› æ­¤æœ‰äº†å¦‚ä¸‹çš„ç­‰å¼ï¼š æˆ‘ä»¬æ¨å¯¼ä¸€ä¸‹è¿™ä¸ªå¼å­ï¼Œç”±äºQ*(St+1,At+1)æ˜¯å¯¹ä¸‹ä¸€æ­¥çŠ¶æ€ä¸‹æœ€ä¼˜åŠ¨ä½œçš„åŠ¨ä½œä»·å€¼å‡½æ•°ï¼Œå› æ­¤ï¼Œè¿™é‡Œçš„At+1å¿…ç„¶è¦é€‰æ‹©ä½¿Q*(St+1,At+1)æœ€å¤§åŒ–çš„åŠ¨ä½œa*ï¼Œå› æ­¤æœ‰äº†å¦‚ä¸‹çš„ç»“è®ºï¼š ä»£å…¥ä¸Šé¢çš„ç­‰å¼ï¼Œå°±å¯ä»¥å¾—åˆ°å¦‚ä¸‹ç­‰å¼ï¼š ç„¶è€Œï¼Œç›´æ¥æ±‚å¼å­ä¸­çš„æœŸæœ›ååˆ†å›°éš¾ï¼Œå› æ­¤è¿™é‡Œé‡‡ç”¨è’™ç‰¹å¡æ´›è¿‘ä¼¼ï¼š å°†Rtè¿‘ä¼¼ä¸ºè§‚æµ‹åˆ°çš„rtï¼Œç”¨è§‚æµ‹åˆ°çš„ä¸‹ä¸€çŠ¶æ€st+1å»è¿‘ä¼¼St+1ï¼Œå› æ­¤è’™ç‰¹å¡æ´›è¿‘ä¼¼åçš„å¼å­å¦‚ä¸‹ï¼š è‡³æ­¤ï¼Œæˆ‘ä»¬å¾—åˆ°äº†TD Target yt ä¸‰ã€è¡¨æ ¼å½¢å¼çš„Q-Learningï¼ˆQ-Learningï¼šTabular Versionï¼‰ å…·ä½“æ­¥éª¤å¦‚ä¸‹ â‘ è§‚æµ‹åˆ°ä¸€ä¸ªå››å…ƒç»„(st,at,rt,st+1)ï¼Œè¿™é‡Œç§°ä¹‹ä¸ºä¸€ä¸ªtransition â‘¡æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚å·²ç»æ¨å¯¼å‡ºTD Targetã€‚å®é™…ä¸Šï¼Œè¿™é‡Œçš„Qæ˜¯ä¸€å¼ è¡¨æ ¼ï¼Œæˆ‘ä»¬è¦æ‰¾åˆ°å¯¹åº”çš„çŠ¶æ€st+1å¹¶æ‰¾åˆ°æœ€å¤§çš„åŠ¨ä½œä»·å€¼å‡½æ•°Q(st+1,a*),ç”¨äºè®¡ç®—TD Target ytã€‚ â‘¢æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è®¡ç®—TD error Î´t â‘£æœ€åï¼Œæˆ‘ä»¬åˆ©ç”¨å¦‚ä¸‹å…¬å¼æ¥æ›´æ–°è¡¨æ ¼ä¸­çš„Q*(st,at) å››ã€ç¥ç»ç½‘ç»œå½¢å¼çš„Q-Learningï¼ˆQ-Learningï¼šDQN Versionï¼‰ æˆ‘ä»¬é‡‡ç”¨DQN Q(s,a;w)æ¥è¿‘ä¼¼æœ€ä¼˜åŠ¨ä½œä»·å€¼å‡½æ•°Q*(s,a) DQNé‡‡ç”¨å¦‚ä¸‹å…¬å¼æ¥æ§åˆ¶Agentï¼Œè€Œæˆ‘ä»¬å°±æ˜¯å¸®åŠ©DQNæ¥å­¦ä¹ åˆ°æ›´å¥½çš„ç¥ç»ç½‘ç»œå‚æ•°w å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š â‘  è§‚æµ‹åˆ°ä¸€ä¸ªå››å…ƒç»„(st,at,rt,st+1)ï¼Œè¿™é‡Œç§°ä¹‹ä¸ºä¸€ä¸ªtransition â‘¡TD Target ytï¼Œä¸ä¸Šä¸€å°èŠ‚ç±»ä¼¼ï¼Œè¿™é‡Œåªæ˜¯å°†è¡¨æ ¼ä¸­çš„Q(st+1,a)æ¢æˆäº†Q(st+1,a*;w) â‘¢TD error Î´tç±»ä¼¼ â‘£æœ€åï¼Œæˆ‘ä»¬é‡‡ç”¨æ¢¯åº¦ä¸‹é™æ¥æ›´æ–°ç¥ç»ç½‘ç»œå‚æ•°w äº”ã€æ€»ç»“ï¼ˆSummaryï¼‰ è¿™é‡Œè¦æ³¨æ„Q-Learningä¸Sarsaçš„åŒºåˆ«ï¼šSarsaç®—æ³•æ˜¯å­¦ä¹ åŠ¨ä½œä»·å€¼å‡½æ•°QÏ€ï¼›è€ŒQ-Learningæ˜¯å­¦ä¹ æœ€ä¼˜åŠ¨ä½œä»·å€¼å‡½æ•°Q*ã€‚ä½†å…¶ç›®çš„éƒ½æ˜¯è®©Agentè·å¾—åˆ°æ›´é«˜çš„åˆ†æ•°ã€‚ æœ€åé™„å›¾ï¼š ","link":"https://tianxiawuhao.github.io/Qnqlnnzkz/"},{"title":"ç‹æ ‘æ£®æ·±åº¦å¼ºåŒ–å­¦ä¹ ç¬”è®°6ï¼šSARSAç®—æ³•","content":"ä¸€ã€æ¨å¯¼TD Targetï¼ˆDerive TD Targetï¼‰ é¦–å…ˆå›é¡¾ä¸€ä¸‹æŠ˜æ‰£å›æŠ¥ï¼ˆDiscounted Returnï¼‰ï¼Œå…¶ä¸­Î³æ˜¯æŠ˜æ‰£ç‡ å½“æˆ‘ä»¬æå–å‡ºä¸€ä¸ªÎ³ï¼Œä¼šå‘ç°æœ‰å¦‚ä¸‹ç­‰å¼ï¼Œä¸”æ‹¬å·å†…éƒ¨çš„æ˜¯ä¸‹ä¸€æ­¥çš„æŠ˜æ‰£å›æŠ¥ï¼ˆUt+1ï¼‰ ç”±æ­¤ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªç­‰å¼ï¼Œæ¥åæ˜ ç›¸é‚»ä¸¤ä¸ªå›æŠ¥ä¹‹é—´çš„å…³ç³» æˆ‘ä»¬é€šå¸¸è®¤ä¸ºï¼Œå¥–åŠ±Rtå–å†³äºå½“å‰çš„çŠ¶æ€stï¼Œå½“å‰çš„åŠ¨ä½œatä»¥åŠä¸‹ä¸€çŠ¶æ€st+1 æ ¹æ®å®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°QÏ€(st,at)æ˜¯å›æŠ¥Utçš„æ¡ä»¶æœŸæœ›ï¼Œè¿™é‡Œåˆ©ç”¨ä¸Šè¿°å…¬å¼ä»£æ¢æ‰Utï¼Œé‚£ä¹ˆå°±å¯ä»¥å¾—åˆ°å¦‚ä¸‹å¼å­ï¼š ä¹Ÿè®¸ä¼šæœ‰é—®é¢˜ï¼Œåšä¸»åœ¨çœ‹çš„æ—¶å€™ä¹Ÿæœ‰è¿™ä¸ªé—®é¢˜ã€‚å¯¹Ut+1æ±‚æœŸæœ›ä¸å·²ç»æ˜¯QÏ€(St+1,At+1)äº†ä¹ˆï¼Œä½†å®é™…ä¸Šæ˜¯è¿™æ ·çš„ï¼šQÏ€(S_t+1,A_t+1) æ˜¯æœŸæœ›ï¼ŒæœŸæœ›æ˜¯å¯¹ s{t+2}, a{t+2}, s{t+3}, a{t+3}... è¿™äº›å˜é‡æ±‚çš„ï¼Œæ‰€ä»¥ QÏ€(S_t+1,A_t+1) è·Ÿè¿™äº›å˜é‡æ— å…³ã€‚QÏ€(S_t+1,A_t+1) è¿˜ä¾èµ–äºå˜é‡St+1,At+1ã€‚E[QÏ€(S_t+1,A_t+1)] è¿›ä¸€æ­¥æ¶ˆæ‰ St+1,At+1 è¿™ä¸¤ä¸ªå˜é‡ã€‚ å› æ­¤æˆ‘ä»¬å¯ä»¥å¾—åˆ°è¿™æ ·çš„ç­‰å¼ï¼š è¿‘ä¼¼æ–¹æ³•å¦‚ä¸‹ï¼š å› æ­¤ï¼ŒTD learningå°±æ˜¯è®©QÏ€(st,at)ä¸æ–­æ¥è¿‘æˆ‘ä»¬çš„TD target yt äºŒã€è¡¨æ ¼å½¢å¼çš„Sarsaï¼ˆSarsaï¼šTabular Versionï¼‰ å¦‚æœæˆ‘ä»¬æƒ³å­¦ä¹ åŠ¨ä½œä»·å€¼å‡½æ•°QÏ€(s,a)ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå¦‚æœè¾“å…¥çš„çŠ¶æ€å’ŒåŠ¨ä½œæ˜¯æœ‰é™çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç”»ä¸€ä¸ªè¡¨æ ¼ï¼šä¸€è¡Œå¯¹åº”ä¸€ä¸ªçŠ¶æ€s_iï¼Œä¸€åˆ—å¯¹åº”ä¸€ä¸ªåŠ¨ä½œa_jï¼Œé‚£ä¹ˆè¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ åˆ™å¯¹åº”ç€åœ¨è¯¥çŠ¶æ€å’Œè¯¥åŠ¨ä½œä¸‹çš„åŠ¨ä½œä»·å€¼QÏ€(s_i,a_j)ã€‚æˆ‘ä»¬è¦åšçš„å°±æ˜¯ç”¨Sarsaç®—æ³•å»æ›´æ–°è¡¨æ ¼ï¼Œæ¯æ¬¡æ›´æ–°ä¸€ä¸ªå…ƒç´ ã€‚ å½“æˆ‘ä»¬è§‚æµ‹åˆ°ä¸€ä¸ªå››å…ƒç»„ï¼ˆst,at,rt,st+1ï¼‰ï¼Œè¿™æ ·çš„ä¸€ä¸ªå››å…ƒç»„è¢«ç§°ä¸ºtransitionã€‚ç„¶åé‡‡ç”¨ç­–ç•¥å‡½æ•°Ï€å»é‡‡æ ·ä¸€ä¸ªat+1ï¼Œæ¥ç€è®¡ç®—TD target ytã€‚è¿™é‡Œå‡è®¾st+1ä¸ºs2ï¼Œat+1ç»è¿‡é‡‡æ ·ä¸ºa3ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç»è¿‡æŸ¥è¡¨è·å–åˆ°äº†å¯¹åº”çš„QÏ€(st+1,at+1)ã€‚ åŒæ—¶æˆ‘ä»¬ä¹Ÿèƒ½è®¡ç®—å‡ºTD error Î´t ç„¶ååˆ©ç”¨Î´tæ›´æ–°QÏ€(st,at)ï¼Œå…¶ä¸­Î±æ˜¯å­¦ä¹ ç‡ ä¸‰ã€ç¥ç»ç½‘ç»œå½¢å¼çš„Sarsaï¼ˆSarsa:Neural Network Versionï¼‰ æˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä»·å€¼ç½‘ç»œæ¥è¿‘ä¼¼QÏ€(s,a)ï¼Œè®°ä¸ºq(s,a;w)ã€‚æ³¨æ„ï¼ŒåŠ¨ä½œä»·å€¼å‡½æ•°QÏ€å’Œä»·å€¼ç½‘ç»œqéƒ½ä¸ç­–ç•¥Ï€æœ‰å…³ï¼Œç­–ç•¥Ï€çš„å¥½åä¼šå½±å“è¿™ä¸¤ä¸ªå‡½æ•°ã€‚ ç¥ç»ç½‘ç»œq(s,a;w)è¢«ç§°ä¸ºä»·å€¼ç½‘ç»œï¼Œå®ƒçš„è¾“å…¥æ˜¯ä¸€ä¸ªçŠ¶æ€sï¼Œè¾“å‡ºæ˜¯çŠ¶æ€sä¸‹å¯¹åº”åŠ¨ä½œçš„ä»·å€¼ã€‚å¦‚æœæœ‰nä¸ªåŠ¨ä½œï¼Œé‚£ä¹ˆä»·å€¼ç½‘ç»œqå°±ä¼šè¾“å‡ºä¸€ä¸ªnç»´å‘é‡ï¼Œå‘é‡å…ƒç´ å¯¹åº”åœ¨çŠ¶æ€sä¸‹ï¼Œå„åŠ¨ä½œaçš„ä»·å€¼ã€‚ TD targetï¼Œè®°ä½œytï¼Œæ˜¯å®é™…è§‚æµ‹çš„å¥–åŠ±rtä¸æŠ˜æ‰£ä»·å€¼ç½‘ç»œçš„é¢„æµ‹å€¼Î³Â·q(st+1,at+1;w)ä¹‹å’Œ TD errorï¼Œè®°ä½œÎ´tï¼Œæ˜¯ä»·å€¼ç½‘ç»œå¯¹å½“å‰çŠ¶æ€å’ŒåŠ¨ä½œçš„ä¼°è®¡q(st,at;w)ä¸TD targetä¹‹å·®ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒè¶Šå°è¶Šå¥½ Lossï¼Œè®°ä½œLï¼Œä»¥1/2å€Î´tçš„L2èŒƒå¼ä½œä¸ºLossï¼Œæˆ‘ä»¬å¸Œæœ›é€šè¿‡æ›´æ–°ä»·å€¼ç½‘ç»œçš„å‚æ•°wæ¥å‡å°Loss Gradientï¼ŒLosså¯¹wæ±‚æ¢¯åº¦ï¼Œåˆ©ç”¨æ¢¯åº¦ä¸‹é™æ¥è·å–åˆ°Lossçš„å±€éƒ¨æœ€å°å€¼ Gradient descentï¼Œæ¢¯åº¦ä¸‹é™ç®—æ³•ï¼Œç”¨äºæ›´æ–°ä»·å€¼ç½‘ç»œå‚æ•°w å››ã€æ€»ç»“ï¼ˆSummaryï¼‰ æˆ‘ä»¬é‡‡ç”¨Sarsaç®—æ³•ä¸»è¦æ˜¯ç”¨äºå­¦ä¹ åŠ¨ä½œä»·å€¼å‡½æ•°QÏ€(s,a) è¿™é‡Œæœ‰ä¸¤ç§å½¢å¼ï¼š â‘ è¡¨æ ¼å½¢å¼ï¼ˆç›´æ¥å­¦ä¹ QÏ€ï¼‰ è¿™ç§å½¢å¼å¯¹äºæœ‰é™ä¸ªçŠ¶æ€å’ŒåŠ¨ä½œä¸”æ•°é‡ä¸å¤§ã€‚é€šè¿‡ä¸€å¼ è¡¨æ ¼è®°å½•æ¯ç§çŠ¶æ€å’ŒåŠ¨ä½œå¯¹åº”çš„QÏ€(s,a)çš„å€¼ï¼Œé€šè¿‡é‡‡ç”¨TDç®—æ³•æ›´æ–°è¡¨ä¸­æ¯ä¸ªQÏ€(s,a)çš„å€¼ã€‚ â‘¡ç¥ç»ç½‘ç»œå½¢å¼ï¼ˆé‡‡ç”¨å‡½æ•°è¿‘ä¼¼ï¼‰ è¿™ç§å½¢å¼å¹¶ä¸æ˜¯ç›´æ¥è·å–QÏ€(s,a)ï¼Œè€Œæ˜¯é€šè¿‡ä»·å€¼ç½‘ç»œq(s,a;w)æ¥è¿‘ä¼¼åŠ¨ä½œä»·å€¼å‡½æ•°QÏ€(s,a)ã€‚å®ƒå®é™…ä¸ŠTDç®—æ³•æ¥æ›´æ–°ä»·å€¼ç½‘ç»œå‚æ•°wï¼Œä½¿ä»·å€¼ç½‘ç»œq(s,a;w)æ›´å¥½ã€‚åº”ç”¨æœ‰å­¦ä¹ ç¬”è®°4çš„ACç®—æ³•ä¸­çš„Criticç½‘ç»œã€‚ ç›´æ¥é™„å›¾ï¼š ","link":"https://tianxiawuhao.github.io/02-wFwlBm/"},{"title":"ç‹æ ‘æ£®æ·±åº¦å¼ºåŒ–å­¦ä¹ ç¬”è®°5ï¼šè’™ç‰¹å¡æ´›ç®—æ³• Monte Carlo Algorithms","content":"Actor-Criticæ–¹æ³•ï¼Œæ˜¯ç­–ç•¥å­¦ä¹ å’Œä»·å€¼å­¦ä¹ ç»“åˆçš„ä¸€ç§æ–¹æ³•ã€‚ Actoræ˜¯ç­–ç•¥ç½‘ç»œï¼Œç”¨æ¥æ§åˆ¶Agentè¿åŠ¨ï¼Œå¯ä»¥çœ‹åšâ€œè¿åŠ¨å‘˜â€ã€‚ Criticæ˜¯ä»·å€¼ç½‘ç»œï¼Œç”¨æ¥ç»™åŠ¨ä½œæ‰“åˆ†ï¼Œå¯ä»¥çœ‹åšâ€œè£åˆ¤â€ã€‚ ä¸€ã€ä»·å€¼ç½‘ç»œå’Œç­–ç•¥ç½‘ç»œï¼ˆValue Network and Policy Networkï¼‰ é¦–å…ˆå›é¡¾çŠ¶æ€ä»·å€¼å‡½æ•°VÏ€(s)ï¼Œå®ƒæ˜¯åŠ¨ä½œçŠ¶æ€å‡½æ•°QÏ€(s,a)çš„æ•°å­¦æœŸæœ›ï¼Œå¦‚æœåŠ¨ä½œæ˜¯ç¦»æ•£çš„ï¼Œé‚£ä¹ˆå®ƒæ˜¯ç”±ç­–ç•¥å‡½æ•°Ï€(a|s)ä½œä¸ºæƒé‡ç³»æ•°ï¼Œå’ŒåŠ¨ä½œä»·å€¼å‡½æ•°QÏ€(s,a)[å¯ä»¥è¯„ä»·åŠ¨ä½œçš„å¥½åç¨‹åº¦]ç›¸ä¹˜å¹¶å¯¹aåšæ±‚å’Œå¾—åˆ°ã€‚å¦‚æœåŠ¨ä½œæ˜¯è¿ç»­çš„ï¼Œé‚£ä¹ˆå°±è¦å¯¹aæ±‚ç§¯åˆ†ã€‚ **â‘ Policy networkï¼ˆActorï¼‰ğŸ˜—*æ§åˆ¶Agentè¿åŠ¨ï¼Œå³åœ¨æŸä¸€çŠ¶æ€såšå‡ºåŠ¨ä½œa æˆ‘ä»¬åˆ©ç”¨ç­–ç•¥ç½‘ç»œÏ€(a|s;Î¸)æ¥è¿‘ä¼¼ç­–ç•¥å‡½æ•°Ï€(a|s)ï¼ŒÎ¸æ˜¯ä¸€ä¸ªå¯è®­ç»ƒçš„ç¥ç»ç½‘ç»œå‚æ•°ã€‚ **â‘¡Value networkï¼ˆCriticï¼‰ğŸ˜—*ä¸æ§åˆ¶Agentè¿åŠ¨ï¼Œä»…ç»™Agentæ‰“åˆ† æˆ‘ä»¬åˆ©ç”¨ä»·å€¼ç½‘ç»œq(s,a;w)æ¥è¿‘ä¼¼ä»·å€¼å‡½æ•°QÏ€(s,a)ï¼Œwæ˜¯ä¸€ä¸ªå¯è®­ç»ƒçš„ç¥ç»ç½‘ç»œå‚æ•° 1ï¼‰ç­–ç•¥ç½‘ç»œï¼ˆPolicy Networkï¼‰ï¼ˆActorï¼‰ ä»¥è¶…çº§ç›ä¸½ä¸ºä¾‹ï¼š è¯¥ç½‘ç»œæœ‰ä¸€ä¸ªè¾“å…¥ï¼šçŠ¶æ€s å°†è¶…çº§ç›ä¸½çš„ä¸€å¸§ç”»é¢ä¼ è¾“åˆ°ç­–ç•¥ç½‘ç»œä¸­ï¼Œå³è¾“å…¥ä¸€ä¸ªçŠ¶æ€sã€‚ ä»·å€¼ç½‘ç»œä¸­åŒ…å«ï¼šä¸€ä¸ªå·ç§¯å±‚ï¼Œå°†ä¸€å¸§ç”»é¢å˜æˆç‰¹å¾å‘é‡ï¼›å…¨è¿æ¥å±‚ï¼Œå°†ç‰¹å¾å‘é‡è½¬å˜ä¸ºç›¸å¯¹äºåŠ¨ä½œç©ºé—´ï¼ˆAction Spaceï¼‰ä¸­å…ƒç´ ä¸ªæ•°å¯¹åº”çš„å‘é‡ï¼›å†é‡‡ç”¨Softmaxæ¿€æ´»å‡½æ•°å°†å…¶è½¬æ¢ä¸ºæ±‚å’Œä¸º1çš„å€¼ï¼Œå³ä¸€ç­–ç•¥çš„æ¦‚ç‡å¯†åº¦ã€‚ 2ï¼‰ä»·å€¼ç½‘ç»œï¼ˆValue Networkï¼‰ï¼ˆCriticï¼‰ ä»¥è¶…çº§ç›ä¸½ä¸ºä¾‹ï¼š è¯¥ç½‘ç»œæœ‰ä¸¤ä¸ªè¾“å…¥ï¼šçŠ¶æ€så’ŒåŠ¨ä½œa å°†è¶…çº§ç›ä¸½çš„ä¸€å¸§ç”»é¢ä¼ è¾“åˆ°ä»·å€¼ç½‘ç»œä¸­ï¼Œå³è¾“å…¥ä¸€ä¸ªçŠ¶æ€sï¼›ä»¥åŠç­–ç•¥ç½‘ç»œï¼ˆActorï¼‰åšå‡ºçš„ä¸€ä¸ªåŠ¨ä½œaä¼ å…¥åˆ°ä»·å€¼ç½‘ç»œä¸­ï¼Œå³è¾“å…¥ä¸€ä¸ªåŠ¨ä½œaã€‚å¯¹äºç¦»æ•£åŠ¨ä½œè€Œè¨€ï¼Œè¿™é‡Œå¯ä»¥é‡‡ç”¨ç‹¬çƒ­ç¼–ç ï¼ˆone-hot encodingï¼‰ï¼Œå…·ä½“å¯ä»¥å‚è€ƒå­¦ä¹ ç¬”è®° | ç‹¬çƒ­ç¼–ç (One-Hot Encoding)ï¼Œè¿™é‡Œä¸å†å¯¹ç‹¬çƒ­ç¼–ç è¿›è¡Œè¿‡å¤šä»‹ç»ã€‚ å¯¹äºä¸¤ä¸ªä¸åŒçš„è¾“å…¥ï¼Œå¤„ç†æ–¹æ³•å¦‚ä¸‹ï¼š é’ˆå¯¹äºçŠ¶æ€sï¼Œé‡‡ç”¨ä¸€ä¸ªå·ç§¯å±‚ï¼Œä»è¾“å…¥ä¸­æå–ç‰¹å¾ï¼Œè·å¾—ä¸€ä¸ªçŠ¶æ€ç‰¹å¾å‘é‡ é’ˆå¯¹äºåŠ¨ä½œaï¼Œé‡‡ç”¨ä¸€ä¸ªå…¨è¿æ¥å±‚ï¼Œä»è¾“å…¥ä¸­æå–ç‰¹å¾ï¼Œè·å¾—ä¸€ä¸ªåŠ¨ä½œç‰¹å¾å‘é‡ ç„¶åå°†ä¸¤ä¸ªç‰¹å¾å‘é‡è¿›è¡Œæ‹¼æ¥ï¼Œå¾—åˆ°ä¸€ä¸ªæ›´é«˜ç»´çš„ç‰¹å¾å‘é‡ï¼Œå†é€šè¿‡ä¸€ä¸ªå…¨è¿æ¥å±‚è¾“å‡ºä¸€ä¸ªå®æ•°q(s,a;w)ï¼Œå³Criticå¯¹äºAgentå¤„äºçŠ¶æ€sä¸‹åšå‡ºåŠ¨ä½œaçš„è¯„ä»·ã€‚ å€¼å¾—ä¸€æçš„æ˜¯ï¼Œä»·å€¼ç½‘ç»œå’Œç­–ç•¥ç½‘ç»œä¸­çš„å‚æ•°æ˜¯å¯ä»¥å…±äº«çš„ï¼›å½“ç„¶ï¼Œå…¶ä¸­çš„å‚æ•°ä¹Ÿå¯ä»¥å„è‡ªç‹¬ç«‹ã€‚ åŒæ—¶è®­ç»ƒä»·å€¼ç½‘ç»œå’Œç­–ç•¥ç½‘ç»œå°±æ˜¯Actor-Critic Methodï¼ˆAC Methodï¼‰ äºŒã€è®­ç»ƒç¥ç»ç½‘ç»œï¼ˆTrain the Neural Networkï¼‰ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ç­–ç•¥ç½‘ç»œå’Œä»·å€¼ç½‘ç»œæ¥è¿‘ä¼¼çŠ¶æ€ä»·å€¼å‡½æ•°ã€‚ é’ˆå¯¹äºä¸¤ä¸ªç½‘ç»œçš„å‚æ•°Î¸å’Œwï¼Œæˆ‘ä»¬çš„æ›´æ–°æ–¹æ³•æ˜¯ä¸ä¸€æ ·çš„ï¼š å¯¹äºÎ¸ï¼Œå®ƒæ˜¯ç­–ç•¥ç½‘ç»œçš„å‚æ•°ã€‚æˆ‘ä»¬æ›´æ–°å‚æ•°Î¸æ˜¯ä¸ºäº†è®©çŠ¶æ€ä»·å€¼å‡½æ•°V(s;Î¸,w)çš„å€¼å¢åŠ ï¼ŒV(s;Î¸,w)æ˜¯å¯¹ç­–ç•¥Ï€å’ŒçŠ¶æ€sçš„è¯„ä»·ã€‚å¦‚æœå›ºå®šçŠ¶æ€sï¼Œé‚£ä¹ˆV(s;Î¸,w)è¶Šå¤§ï¼Œæ„å‘³ç€ç­–ç•¥Ï€è¶Šå¥½ï¼›åŒç†ï¼Œå¦‚æœå›ºå®šç­–ç•¥Ï€ï¼ŒV(s;Î¸,w)è¶Šå¤§ï¼Œåˆ™çŠ¶æ€sè¶Šå¥½ã€‚ å¯¹äºwï¼Œå®ƒæ˜¯ä»·å€¼ç½‘ç»œçš„å‚æ•°ã€‚æˆ‘ä»¬æ›´æ–°å‚æ•°wæ˜¯ä¸ºäº†è®©ä»·å€¼ç½‘ç»œå¯¹äºåŠ¨ä½œçš„æ‰“åˆ†æ›´ç²¾å‡†ï¼Œä»è€Œæ›´å¥½åœ°ä¼°è®¡æœªæ¥å¥–åŠ±çš„æ€»å’Œã€‚å®ƒç›¸å½“äºæ˜¯è£åˆ¤ï¼Œä¸€å¼€å§‹å¹¶æ²¡æœ‰æ‰“åˆ†èƒ½åŠ›ï¼Œå› æ­¤åœ¨åˆå§‹é˜¶æ®µï¼ŒCriticçš„æ‰“åˆ†éƒ½æ˜¯ççŒœçš„ï¼Œå®ƒä¼šé€šè¿‡ç¯å¢ƒç»™çš„å¥–åŠ±Rewardæ¥æ›´æ–°wï¼Œæœ€åCriticçš„æ‰“åˆ†ä¼šè¶Šæ¥è¶Šç²¾å‡†ã€‚ åˆ©ç”¨å¦‚ä¸‹äº”ä¸ªæ­¥éª¤æ¥å¯¹ä¸¤ä¸ªç¥ç»ç½‘ç»œåšä¸€æ¬¡æ›´æ–°ï¼š 1ï¼‰ ä½¿ç”¨æ—¶åºå·®åˆ†ç®—æ³•æ›´æ–°ä»·å€¼ç½‘ç»œqï¼ˆUpdate Value Network q Using TDï¼‰ è§£é‡Šä¸€ä¸‹ï¼Œæµç¨‹å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š å½“æˆ‘ä»¬ä½¿ç”¨TDç®—æ³•å»æ›´æ–°ä»·å€¼ç½‘ç»œqæ—¶ï¼Œè¦é¦–å…ˆè·å–åˆ°Actorç»™å‡ºçš„tæ—¶åˆ»å’Œt+1æ—¶åˆ»çš„çŠ¶æ€stã€st+1ä»¥åŠåŠ¨ä½œatã€a~t+1ï¼Œæ­¤æ—¶Criticç½‘ç»œä¸­çš„å‚æ•°ä¸ºwtã€‚å› æ­¤æˆ‘ä»¬å°±èƒ½å¾—åˆ°æˆ‘ä»¬çš„TD targetï¼šytï¼Œæœ‰äº†TD targetå’Œtæ—¶åˆ»çš„è§‚æµ‹å€¼ï¼Œå³å¯å†™å‡ºLoss L(w)ï¼Œä¸”ä»¥L2èŒƒå¼å½¢å¼è¡¨ç¤ºï¼Œç„¶ååˆ©ç”¨æ¢¯åº¦ä¸‹é™ï¼ˆGradient Descentï¼‰å»æ›´æ–°Criticç½‘ç»œä¸­çš„å‚æ•°wï¼Œè®°ä¸ºwt+1ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒAgentå¹¶ä¸ä¼šåšå‡ºa~t+1è¿™ä¸ªåŠ¨ä½œï¼Œä»…ä»…æ˜¯ç”¨äºCriticç”¨äºTDç®—æ³•çš„å‚æ•°æ›´æ–° ç›´æ¥é™„å›¾ï¼š 2ï¼‰ä½¿ç”¨ç­–ç•¥æ¢¯åº¦æ›´æ–°ç­–ç•¥ç½‘ç»œÏ€ï¼ˆUpdate Policy Network Ï€ Using Policy Gradientï¼‰ é¦–å…ˆå›é¡¾ä¸€ä¸‹ç­–ç•¥æ¢¯åº¦ï¼š ç­–ç•¥æ¢¯åº¦æ˜¯å¯¹è‡ªå®šä¹‰å‡½æ•°g(A,Î¸)å…³äºAæ±‚æœŸæœ›ï¼Œç”±äºä¸€ä¸ªg(A,Î¸)æ˜¯å¯¹æ•´ä½“çš„g(A,Î¸)çš„ä¸€ä¸ªæ— åä¼°è®¡ï¼Œå› æ­¤è¿™é‡Œç”¨äº†è’™ç‰¹å¡æ´›è¿‘ä¼¼ã€‚ è§£é‡Šä¸€ä¸‹ï¼Œæµç¨‹å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š æ ¹æ®ç­–ç•¥Ï€å¯¹åŠ¨ä½œaè¿›è¡Œä¸€æ¬¡éšæœºæŠ½æ ·ï¼Œç„¶åé’ˆå¯¹è¯¥åŠ¨ä½œaè¿›è¡Œä¸€æ¬¡éšæœºæ¢¯åº¦ä¸Šå‡ï¼ˆStochastic Gradient Ascent SGAï¼‰ï¼Œç”¨äºæ›´æ–°Î¸ï¼Œè®°ä¸ºÎ¸t+1ã€‚ ACæ–¹æ³•çš„æ•´ä½“æµç¨‹å’Œå¯¹åº”å…³ç³»ï¼š 3ï¼‰ç®—æ³•æ€»ç»“ï¼ˆSummary of Algorithmï¼‰ ç›´æ¥ä¸Šå›¾ï¼Œéå¸¸æ¸…æ™°ï¼š å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨è®ºæ–‡å’Œæ•™ç§‘ä¹¦ä¸­ï¼Œæœ€åä¸€æ­¥å¾€å¾€ä¸é€‚ç”¨qtï¼Œè€Œé‡‡ç”¨çš„æ˜¯TD error Î´tã€‚ä½¿ç”¨Î´tå«åšåŸºçº¿ç­–ç•¥æ¢¯åº¦ï¼ˆPolicy Gradient with Baselineï¼‰ï¼Œå…¶æ•ˆæœæ›´å¥½ã€‚å¥½çš„baselineå¯ä»¥é™ä½æ–¹å·®ï¼Œä½¿ç®—æ³•æ”¶æ•›æ›´å¿«ã€‚ Baselineï¼šä»»ä½•æ¥è¿‘qtçš„æ•°éƒ½å¯ä»¥æ˜¯baselineï¼Œä½†å®ƒä¸èƒ½æ˜¯atçš„å‡½æ•°ï¼Œå³ä¸ä¸atå­˜åœ¨æ˜ å°„å…³ç³»ã€‚ ä¸‰ã€æ€»ç»“ï¼ˆSummaryï¼‰ ","link":"https://tianxiawuhao.github.io/syanmQ0CA/"},{"title":"ç‹æ ‘æ£®æ·±åº¦å¼ºåŒ–å­¦ä¹ ç¬”è®°4ï¼šActor-Critic Methodï¼ˆAC Methodï¼‰","content":"Actor-Criticæ–¹æ³•ï¼Œæ˜¯ç­–ç•¥å­¦ä¹ å’Œä»·å€¼å­¦ä¹ ç»“åˆçš„ä¸€ç§æ–¹æ³•ã€‚ Actoræ˜¯ç­–ç•¥ç½‘ç»œï¼Œç”¨æ¥æ§åˆ¶Agentè¿åŠ¨ï¼Œå¯ä»¥çœ‹åšâ€œè¿åŠ¨å‘˜â€ã€‚ Criticæ˜¯ä»·å€¼ç½‘ç»œï¼Œç”¨æ¥ç»™åŠ¨ä½œæ‰“åˆ†ï¼Œå¯ä»¥çœ‹åšâ€œè£åˆ¤â€ã€‚ ä¸€ã€ä»·å€¼ç½‘ç»œå’Œç­–ç•¥ç½‘ç»œï¼ˆValue Network and Policy Networkï¼‰ é¦–å…ˆå›é¡¾çŠ¶æ€ä»·å€¼å‡½æ•°VÏ€(s)ï¼Œå®ƒæ˜¯åŠ¨ä½œçŠ¶æ€å‡½æ•°QÏ€(s,a)çš„æ•°å­¦æœŸæœ›ï¼Œå¦‚æœåŠ¨ä½œæ˜¯ç¦»æ•£çš„ï¼Œé‚£ä¹ˆå®ƒæ˜¯ç”±ç­–ç•¥å‡½æ•°Ï€(a|s)ä½œä¸ºæƒé‡ç³»æ•°ï¼Œå’ŒåŠ¨ä½œä»·å€¼å‡½æ•°QÏ€(s,a)[å¯ä»¥è¯„ä»·åŠ¨ä½œçš„å¥½åç¨‹åº¦]ç›¸ä¹˜å¹¶å¯¹aåšæ±‚å’Œå¾—åˆ°ã€‚å¦‚æœåŠ¨ä½œæ˜¯è¿ç»­çš„ï¼Œé‚£ä¹ˆå°±è¦å¯¹aæ±‚ç§¯åˆ†ã€‚ **â‘ Policy networkï¼ˆActorï¼‰ğŸ˜—*æ§åˆ¶Agentè¿åŠ¨ï¼Œå³åœ¨æŸä¸€çŠ¶æ€såšå‡ºåŠ¨ä½œa æˆ‘ä»¬åˆ©ç”¨ç­–ç•¥ç½‘ç»œÏ€(a|s;Î¸)æ¥è¿‘ä¼¼ç­–ç•¥å‡½æ•°Ï€(a|s)ï¼ŒÎ¸æ˜¯ä¸€ä¸ªå¯è®­ç»ƒçš„ç¥ç»ç½‘ç»œå‚æ•°ã€‚ **â‘¡Value networkï¼ˆCriticï¼‰ğŸ˜—*ä¸æ§åˆ¶Agentè¿åŠ¨ï¼Œä»…ç»™Agentæ‰“åˆ† æˆ‘ä»¬åˆ©ç”¨ä»·å€¼ç½‘ç»œq(s,a;w)æ¥è¿‘ä¼¼ä»·å€¼å‡½æ•°QÏ€(s,a)ï¼Œwæ˜¯ä¸€ä¸ªå¯è®­ç»ƒçš„ç¥ç»ç½‘ç»œå‚æ•° 1ï¼‰ç­–ç•¥ç½‘ç»œï¼ˆPolicy Networkï¼‰ï¼ˆActorï¼‰ ä»¥è¶…çº§ç›ä¸½ä¸ºä¾‹ï¼š è¯¥ç½‘ç»œæœ‰ä¸€ä¸ªè¾“å…¥ï¼šçŠ¶æ€s å°†è¶…çº§ç›ä¸½çš„ä¸€å¸§ç”»é¢ä¼ è¾“åˆ°ç­–ç•¥ç½‘ç»œä¸­ï¼Œå³è¾“å…¥ä¸€ä¸ªçŠ¶æ€sã€‚ ä»·å€¼ç½‘ç»œä¸­åŒ…å«ï¼šä¸€ä¸ªå·ç§¯å±‚ï¼Œå°†ä¸€å¸§ç”»é¢å˜æˆç‰¹å¾å‘é‡ï¼›å…¨è¿æ¥å±‚ï¼Œå°†ç‰¹å¾å‘é‡è½¬å˜ä¸ºç›¸å¯¹äºåŠ¨ä½œç©ºé—´ï¼ˆAction Spaceï¼‰ä¸­å…ƒç´ ä¸ªæ•°å¯¹åº”çš„å‘é‡ï¼›å†é‡‡ç”¨Softmaxæ¿€æ´»å‡½æ•°å°†å…¶è½¬æ¢ä¸ºæ±‚å’Œä¸º1çš„å€¼ï¼Œå³ä¸€ç­–ç•¥çš„æ¦‚ç‡å¯†åº¦ã€‚ 2ï¼‰ä»·å€¼ç½‘ç»œï¼ˆValue Networkï¼‰ï¼ˆCriticï¼‰ ä»¥è¶…çº§ç›ä¸½ä¸ºä¾‹ï¼š è¯¥ç½‘ç»œæœ‰ä¸¤ä¸ªè¾“å…¥ï¼šçŠ¶æ€så’ŒåŠ¨ä½œa å°†è¶…çº§ç›ä¸½çš„ä¸€å¸§ç”»é¢ä¼ è¾“åˆ°ä»·å€¼ç½‘ç»œä¸­ï¼Œå³è¾“å…¥ä¸€ä¸ªçŠ¶æ€sï¼›ä»¥åŠç­–ç•¥ç½‘ç»œï¼ˆActorï¼‰åšå‡ºçš„ä¸€ä¸ªåŠ¨ä½œaä¼ å…¥åˆ°ä»·å€¼ç½‘ç»œä¸­ï¼Œå³è¾“å…¥ä¸€ä¸ªåŠ¨ä½œaã€‚å¯¹äºç¦»æ•£åŠ¨ä½œè€Œè¨€ï¼Œè¿™é‡Œå¯ä»¥é‡‡ç”¨ç‹¬çƒ­ç¼–ç ï¼ˆone-hot encodingï¼‰ï¼Œå…·ä½“å¯ä»¥å‚è€ƒå­¦ä¹ ç¬”è®° | ç‹¬çƒ­ç¼–ç (One-Hot Encoding)ï¼Œè¿™é‡Œä¸å†å¯¹ç‹¬çƒ­ç¼–ç è¿›è¡Œè¿‡å¤šä»‹ç»ã€‚ å¯¹äºä¸¤ä¸ªä¸åŒçš„è¾“å…¥ï¼Œå¤„ç†æ–¹æ³•å¦‚ä¸‹ï¼š é’ˆå¯¹äºçŠ¶æ€sï¼Œé‡‡ç”¨ä¸€ä¸ªå·ç§¯å±‚ï¼Œä»è¾“å…¥ä¸­æå–ç‰¹å¾ï¼Œè·å¾—ä¸€ä¸ªçŠ¶æ€ç‰¹å¾å‘é‡ é’ˆå¯¹äºåŠ¨ä½œaï¼Œé‡‡ç”¨ä¸€ä¸ªå…¨è¿æ¥å±‚ï¼Œä»è¾“å…¥ä¸­æå–ç‰¹å¾ï¼Œè·å¾—ä¸€ä¸ªåŠ¨ä½œç‰¹å¾å‘é‡ ç„¶åå°†ä¸¤ä¸ªç‰¹å¾å‘é‡è¿›è¡Œæ‹¼æ¥ï¼Œå¾—åˆ°ä¸€ä¸ªæ›´é«˜ç»´çš„ç‰¹å¾å‘é‡ï¼Œå†é€šè¿‡ä¸€ä¸ªå…¨è¿æ¥å±‚è¾“å‡ºä¸€ä¸ªå®æ•°q(s,a;w)ï¼Œå³Criticå¯¹äºAgentå¤„äºçŠ¶æ€sä¸‹åšå‡ºåŠ¨ä½œaçš„è¯„ä»·ã€‚ å€¼å¾—ä¸€æçš„æ˜¯ï¼Œä»·å€¼ç½‘ç»œå’Œç­–ç•¥ç½‘ç»œä¸­çš„å‚æ•°æ˜¯å¯ä»¥å…±äº«çš„ï¼›å½“ç„¶ï¼Œå…¶ä¸­çš„å‚æ•°ä¹Ÿå¯ä»¥å„è‡ªç‹¬ç«‹ã€‚ åŒæ—¶è®­ç»ƒä»·å€¼ç½‘ç»œå’Œç­–ç•¥ç½‘ç»œå°±æ˜¯Actor-Critic Methodï¼ˆAC Methodï¼‰ äºŒã€è®­ç»ƒç¥ç»ç½‘ç»œï¼ˆTrain the Neural Networkï¼‰ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ç­–ç•¥ç½‘ç»œå’Œä»·å€¼ç½‘ç»œæ¥è¿‘ä¼¼çŠ¶æ€ä»·å€¼å‡½æ•°ã€‚ é’ˆå¯¹äºä¸¤ä¸ªç½‘ç»œçš„å‚æ•°Î¸å’Œwï¼Œæˆ‘ä»¬çš„æ›´æ–°æ–¹æ³•æ˜¯ä¸ä¸€æ ·çš„ï¼š å¯¹äºÎ¸ï¼Œå®ƒæ˜¯ç­–ç•¥ç½‘ç»œçš„å‚æ•°ã€‚æˆ‘ä»¬æ›´æ–°å‚æ•°Î¸æ˜¯ä¸ºäº†è®©çŠ¶æ€ä»·å€¼å‡½æ•°V(s;Î¸,w)çš„å€¼å¢åŠ ï¼ŒV(s;Î¸,w)æ˜¯å¯¹ç­–ç•¥Ï€å’ŒçŠ¶æ€sçš„è¯„ä»·ã€‚å¦‚æœå›ºå®šçŠ¶æ€sï¼Œé‚£ä¹ˆV(s;Î¸,w)è¶Šå¤§ï¼Œæ„å‘³ç€ç­–ç•¥Ï€è¶Šå¥½ï¼›åŒç†ï¼Œå¦‚æœå›ºå®šç­–ç•¥Ï€ï¼ŒV(s;Î¸,w)è¶Šå¤§ï¼Œåˆ™çŠ¶æ€sè¶Šå¥½ã€‚ å¯¹äºwï¼Œå®ƒæ˜¯ä»·å€¼ç½‘ç»œçš„å‚æ•°ã€‚æˆ‘ä»¬æ›´æ–°å‚æ•°wæ˜¯ä¸ºäº†è®©ä»·å€¼ç½‘ç»œå¯¹äºåŠ¨ä½œçš„æ‰“åˆ†æ›´ç²¾å‡†ï¼Œä»è€Œæ›´å¥½åœ°ä¼°è®¡æœªæ¥å¥–åŠ±çš„æ€»å’Œã€‚å®ƒç›¸å½“äºæ˜¯è£åˆ¤ï¼Œä¸€å¼€å§‹å¹¶æ²¡æœ‰æ‰“åˆ†èƒ½åŠ›ï¼Œå› æ­¤åœ¨åˆå§‹é˜¶æ®µï¼ŒCriticçš„æ‰“åˆ†éƒ½æ˜¯ççŒœçš„ï¼Œå®ƒä¼šé€šè¿‡ç¯å¢ƒç»™çš„å¥–åŠ±Rewardæ¥æ›´æ–°wï¼Œæœ€åCriticçš„æ‰“åˆ†ä¼šè¶Šæ¥è¶Šç²¾å‡†ã€‚ åˆ©ç”¨å¦‚ä¸‹äº”ä¸ªæ­¥éª¤æ¥å¯¹ä¸¤ä¸ªç¥ç»ç½‘ç»œåšä¸€æ¬¡æ›´æ–°ï¼š 1ï¼‰ ä½¿ç”¨æ—¶åºå·®åˆ†ç®—æ³•æ›´æ–°ä»·å€¼ç½‘ç»œqï¼ˆUpdate Value Network q Using TDï¼‰ è§£é‡Šä¸€ä¸‹ï¼Œæµç¨‹å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š å½“æˆ‘ä»¬ä½¿ç”¨TDç®—æ³•å»æ›´æ–°ä»·å€¼ç½‘ç»œqæ—¶ï¼Œè¦é¦–å…ˆè·å–åˆ°Actorç»™å‡ºçš„tæ—¶åˆ»å’Œt+1æ—¶åˆ»çš„çŠ¶æ€stã€st+1ä»¥åŠåŠ¨ä½œatã€a~t+1ï¼Œæ­¤æ—¶Criticç½‘ç»œä¸­çš„å‚æ•°ä¸ºwtã€‚å› æ­¤æˆ‘ä»¬å°±èƒ½å¾—åˆ°æˆ‘ä»¬çš„TD targetï¼šytï¼Œæœ‰äº†TD targetå’Œtæ—¶åˆ»çš„è§‚æµ‹å€¼ï¼Œå³å¯å†™å‡ºLoss L(w)ï¼Œä¸”ä»¥L2èŒƒå¼å½¢å¼è¡¨ç¤ºï¼Œç„¶ååˆ©ç”¨æ¢¯åº¦ä¸‹é™ï¼ˆGradient Descentï¼‰å»æ›´æ–°Criticç½‘ç»œä¸­çš„å‚æ•°wï¼Œè®°ä¸ºwt+1ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒAgentå¹¶ä¸ä¼šåšå‡ºa~t+1è¿™ä¸ªåŠ¨ä½œï¼Œä»…ä»…æ˜¯ç”¨äºCriticç”¨äºTDç®—æ³•çš„å‚æ•°æ›´æ–° ç›´æ¥é™„å›¾ï¼š 2ï¼‰ä½¿ç”¨ç­–ç•¥æ¢¯åº¦æ›´æ–°ç­–ç•¥ç½‘ç»œÏ€ï¼ˆUpdate Policy Network Ï€ Using Policy Gradientï¼‰ é¦–å…ˆå›é¡¾ä¸€ä¸‹ç­–ç•¥æ¢¯åº¦ï¼š ç­–ç•¥æ¢¯åº¦æ˜¯å¯¹è‡ªå®šä¹‰å‡½æ•°g(A,Î¸)å…³äºAæ±‚æœŸæœ›ï¼Œç”±äºä¸€ä¸ªg(A,Î¸)æ˜¯å¯¹æ•´ä½“çš„g(A,Î¸)çš„ä¸€ä¸ªæ— åä¼°è®¡ï¼Œå› æ­¤è¿™é‡Œç”¨äº†è’™ç‰¹å¡æ´›è¿‘ä¼¼ã€‚ è§£é‡Šä¸€ä¸‹ï¼Œæµç¨‹å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š æ ¹æ®ç­–ç•¥Ï€å¯¹åŠ¨ä½œaè¿›è¡Œä¸€æ¬¡éšæœºæŠ½æ ·ï¼Œç„¶åé’ˆå¯¹è¯¥åŠ¨ä½œaè¿›è¡Œä¸€æ¬¡éšæœºæ¢¯åº¦ä¸Šå‡ï¼ˆStochastic Gradient Ascent SGAï¼‰ï¼Œç”¨äºæ›´æ–°Î¸ï¼Œè®°ä¸ºÎ¸t+1ã€‚ ACæ–¹æ³•çš„æ•´ä½“æµç¨‹å’Œå¯¹åº”å…³ç³»ï¼š 3ï¼‰ç®—æ³•æ€»ç»“ï¼ˆSummary of Algorithmï¼‰ ç›´æ¥ä¸Šå›¾ï¼Œéå¸¸æ¸…æ™°ï¼š å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨è®ºæ–‡å’Œæ•™ç§‘ä¹¦ä¸­ï¼Œæœ€åä¸€æ­¥å¾€å¾€ä¸é€‚ç”¨qtï¼Œè€Œé‡‡ç”¨çš„æ˜¯TD error Î´tã€‚ä½¿ç”¨Î´tå«åšåŸºçº¿ç­–ç•¥æ¢¯åº¦ï¼ˆPolicy Gradient with Baselineï¼‰ï¼Œå…¶æ•ˆæœæ›´å¥½ã€‚å¥½çš„baselineå¯ä»¥é™ä½æ–¹å·®ï¼Œä½¿ç®—æ³•æ”¶æ•›æ›´å¿«ã€‚ Baselineï¼šä»»ä½•æ¥è¿‘qtçš„æ•°éƒ½å¯ä»¥æ˜¯baselineï¼Œä½†å®ƒä¸èƒ½æ˜¯atçš„å‡½æ•°ï¼Œå³ä¸ä¸atå­˜åœ¨æ˜ å°„å…³ç³»ã€‚ ä¸‰ã€æ€»ç»“ï¼ˆSummaryï¼‰ ","link":"https://tianxiawuhao.github.io/UWk0iL6Ex/"},{"title":"ç‹æ ‘æ£®æ·±åº¦å¼ºåŒ–å­¦ä¹ ç¬”è®°3ï¼šç­–ç•¥å­¦ä¹  Policy-Based Learning","content":"ä¸€ã€ç­–ç•¥å‡½æ•°è¿‘ä¼¼ï¼ˆPolicy Function Approximationï¼‰ 1ï¼‰ç­–ç•¥å‡½æ•°ï¼ˆPolicy Functionï¼‰ ç­–ç•¥å‡½æ•°ï¼ˆPolicy Functionï¼‰Ï€(a|s) æ˜¯ä¸€ä¸ªæ¦‚ç‡å¯†åº¦å‡½æ•°ï¼Œå…¶è¾“å…¥æ˜¯æŸä¸ªçŠ¶æ€sï¼Œè¾“å‡ºæ˜¯åœ¨è¯¥çŠ¶æ€ä¸‹å¯èƒ½äº§ç”Ÿçš„åŠ¨ä½œaçš„æ¦‚ç‡å€¼ã€‚å‡è®¾åœ¨çŠ¶æ€stä¸‹ï¼ŒAgentå¯èƒ½åšå‡ºçš„åŠ¨ä½œatå¯èƒ½æœ‰nä¸ªï¼Œé‚£ä¹ˆÏ€(at|st)å³è¾“å‡ºä¸€ä¸ªnç»´å‘é‡ï¼Œå…¶å…ƒç´ å¯¹åº”æ¯ä¸ªå¯èƒ½åšå‡ºåŠ¨ä½œatçš„æ¦‚ç‡å€¼ã€‚æœ‰äº†è¿™nä¸ªæ¦‚ç‡å€¼ï¼ŒAgentå°±ä¼šåœ¨è¿™ä¸ªå‘é‡ä¸­åšä¸€æ¬¡éšæœºæŠ½æ ·ï¼ˆRandom Samplingï¼‰ï¼Œå¹¶åšå‡ºéšæœºæŠ½æ ·æ‰€å¾—çš„åŠ¨ä½œai 2ï¼‰ç­–ç•¥ç½‘ç»œï¼ˆPolicy Networkï¼‰ ç­–ç•¥ç½‘ç»œï¼ˆPolicy Networkï¼‰Ï€(a|s;Î¸)åˆ™æ˜¯ä½¿ç”¨äº†ç¥ç»ç½‘ç»œï¼ˆNeural Network NNï¼‰å»è¿‘ä¼¼ç­–ç•¥å‡½æ•°Ï€(a|s)ï¼Œå…¶ä¸­Î¸æ˜¯ç¥ç»ç½‘ç»œä¸­çš„ä¸€ä¸ªå¯è®­ç»ƒå‚æ•° ç­–ç•¥ç½‘ç»œï¼ˆPolicy Networkï¼‰Ï€(a|s;Î¸)æœ‰ç€å¦‚ä¸‹æ€§è´¨ï¼š ç”±äºç­–ç•¥ç½‘ç»œå¯¹äºåœ¨åŠ¨ä½œç©ºé—´Aä¸­æ‰€æœ‰å¯èƒ½å–åˆ°çš„aæ‰€å¯¹åº”çš„æ¦‚ç‡ä¹‹å’Œå¿…é¡»ç­‰äº1ï¼Œå› æ­¤åœ¨ç­–ç•¥ç½‘ç»œçš„æœ€åä¸€å±‚å¿…é¡»åŠ ä¸Šä¸€ä¸ªSotmaxè¿™ä¸ªActivation Functionã€‚ äºŒã€çŠ¶æ€ä»·å€¼å‡½æ•°è¿‘ä¼¼ï¼ˆState-Value Function Approximationï¼‰ 1ï¼‰çŠ¶æ€ä»·å€¼å‡½æ•°ï¼ˆAction-Value Functionï¼‰ é¦–å…ˆå›é¡¾ä¸Šä¸€ç« çš„ä¸‰ç±»å‡½æ•°ï¼š è¿™é‡Œæ³¨æ„ï¼šå¼3è¡¨ç¤ºç¦»æ•£åŠ¨ä½œçš„æœŸæœ›æ±‚æ³•ï¼›è‹¥ä¸ºè¿ç»­åŠ¨ä½œï¼Œåˆ™å¯¹åŠ¨ä½œç©ºé—´ä¸­çš„æ‰€æœ‰aè¿›è¡Œç§¯åˆ†ã€‚ ç±»æ¯”State-Value Functionå’ŒApproximation State-Value Functionï¼ŒåŒºåˆ«åœ¨äºï¼šå°†ç­–ç•¥Ï€(a|st)æ¢æˆäº†ç­–ç•¥ç½‘ç»œÏ€(a|st;Î¸) Vå¯ä»¥è¯„ä»·çŠ¶æ€så’Œç­–ç•¥ç½‘ç»œÏ€(a|st;Î¸)çš„å¥½åã€‚è‹¥ç»™å®šçŠ¶æ€sï¼Œç­–ç•¥ç½‘ç»œè¶Šå¥½ï¼Œé‚£ä¹ˆVçš„å€¼è¶Šå¤§ã€‚å› æ­¤ï¼Œæˆ‘ä»¬é‡‡ç”¨Vå…³äºÎ¸çš„éšæœºæ¢¯åº¦ä¸Šå‡çš„æ–¹æ³•æ›´æ–°å‚æ•°Î¸ï¼Œåˆ™æœ‰ä»¥ä¸‹å®šä¹‰ï¼šJ(Î¸) è¿™ç±»æ–¹æ³•å³ç­–ç•¥æ¢¯åº¦ä¸Šå‡çš„æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬å®šä¹‰ç­–ç•¥æ¢¯åº¦ï¼ˆPolicy Gradientï¼‰æ˜¯è¿‘ä¼¼çŠ¶æ€ä»·å€¼å‡½æ•°V(s;Î¸)å…³äºÎ¸çš„æ¢¯åº¦ã€‚ 2ï¼‰ç­–ç•¥æ¢¯åº¦ï¼ˆPolicy Gradientï¼‰ è¿™é‡Œæ”¾ä¸Šç­–ç•¥æ¢¯åº¦çš„æ¨å¯¼ï¼š è¿™é‡Œå‡è®¾QÏ€ä¸ä¾èµ–äºÎ¸ï¼Œå› æ­¤èƒ½å¤Ÿç›¸å½“äºä¸€ä¸ªå¸¸æ•°æå‡ºæ¥ã€‚ä½†åœ¨å®é™…ä¸­ï¼Œç”±äºQÏ€ä¾èµ–äºÏ€ï¼Œè€ŒÏ€æ˜¯ç”±ç¥ç»ç½‘ç»œå‚æ•°Î¸æ‰€å†³å®šçš„ï¼Œå› æ­¤å¾€å¾€QÏ€ä¸èƒ½è¢«æå‡ºã€‚ å› æ­¤ï¼Œç­–ç•¥æ¢¯åº¦çš„ä¸€ç§å½¢å¼å¯ä»¥è¢«å†™æˆå¦‚ä¸‹å½¢å¼ï¼š è¿™é‡Œï¼Œå¦‚æœåŠ¨ä½œaæ˜¯ç¦»æ•£çš„ï¼Œé‚£ä¹ˆåªéœ€è¦å¯¹aè¿›è¡Œè¿åŠ å°±å¯ä»¥å°†ç­–ç•¥æ¢¯åº¦ç®—å‡ºæ¥ã€‚ ç„¶è€Œå®é™…åº”ç”¨ä¸­å¾€å¾€ä¸ä¼šç”¨è¿™ä¸ªå…¬å¼æ¥è®¡ç®—ç­–ç•¥æ¢¯åº¦ï¼Œè€Œæ˜¯ä½¿ç”¨è’™ç‰¹å¡æ´›è¿‘ä¼¼çš„æ–¹æ³•æ¥è¿‘ä¼¼ã€‚ è¿™é‡Œå¯¹è’™ç‰¹å¡æ´›è¿‘ä¼¼æ¨å¯¼ï¼š è¿™é‡Œï¼Œæœ‰å¿…è¦è§£é‡Šä¸€ä¸‹ï¼Œè¿™é‡Œåˆ©ç”¨äº†logå‡½æ•°çš„æ±‚å¯¼æ€§è´¨ï¼Œæœ‰å¾®ç§¯åˆ†åŸºç¡€çš„åº”è¯¥æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œå¦‚æœä»…æœ‰é«˜ä¸­æ°´å¹³çš„æœ‹å‹å¯ä»¥è‡ªå·±ä¸Šæ‰‹æ±‚ä¸€ä¸‹å¯¼ï¼Œæ­£ç€çœ‹æˆ–è®¸æœ‰ç‚¹é—®é¢˜ï¼Œå¯ä»¥åè¿‡æ¥æ¨å¯¼ï¼Œå¦‚ä¸Šå›¾ç´«è‰²å­—ä½“ã€‚ è‡³æ­¤ï¼Œæˆ‘ä»¬è¯æ˜äº†è¿™ä¸¤é¡¹æ˜¯ç›¸ç­‰çš„ï¼š è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è’™ç‰¹å¡æ´›è¿‘ä¼¼ï¼Œæ¨å¯¼å‡ºå¦‚ä¸‹ç­‰å¼ï¼š ä¸Šé¢æåˆ°äº†è¿™ä¸ªæ¨å¯¼ä¸ä¸¥è°¨ï¼ŒåŸå› æ˜¯å› ä¸ºQÏ€ä¸ç­–ç•¥Ï€æœ‰å…³ï¼Œå› è€Œä¸ç¥ç»ç½‘ç»œå‚æ•°Î¸æœ‰å…³ï¼Œä½†äº‹å®ä¸Šï¼Œæœ€åçš„QÏ€å¯¹Î¸ä¹Ÿæ±‚åå¯¼ï¼Œæœ€åä¹Ÿèƒ½å¾—åˆ°è¿™ä¸ªå¼å­ã€‚ è‡³æ­¤ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ç­–ç•¥æ¢¯åº¦çš„ä¸¤ç§ç­‰ä»·å½¢å¼ï¼š å¯¹äºç¦»æ•£çš„åŠ¨ä½œï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ç¬¬ä¸€ç§å½¢å¼ï¼š ç”±äºç¬¬ä¸€ç§å½¢å¼çš„ä½¿ç”¨å¯¹è±¡çš„å±€é™æ€§ï¼Œå› è€Œç¬¬äºŒç§å½¢å¼æ¯”ç¬¬ä¸€ç§å½¢å¼æ›´ä¸ºå¸¸ç”¨ï¼Œè¿™é‡Œä¸¾äº†è¿ç»­åŠ¨ä½œçš„ä¸€ç§ç­–ç•¥æ¢¯åº¦çš„ä¾‹å­ï¼š æ˜¾ç„¶ï¼Œè¿™é‡Œå¯¹g(A,Î¸)å…³äºAæ±‚æœŸæœ›å°±æ˜¯ç­–ç•¥æ¢¯åº¦ï¼›ä¸”aæ˜¯æ ¹æ®ç­–ç•¥Ï€ä¸­éšæœºæŠ½æ ·å¾—åˆ°çš„ï¼Œæ•…g(a,Î¸)æ˜¯ç­–ç•¥æ¢¯åº¦çš„ä¸€ä¸ªæ— åä¼°è®¡ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨g(a^,Î¸)å»è¿‘ä¼¼ç­–ç•¥æ¢¯åº¦ï¼Œå³è’™ç‰¹å¡æ´›è¿‘ä¼¼ï¼ˆMonte Carlo Approximationï¼‰ã€‚å…·ä½“æ¨å¯¼å¯ä»¥å‚è€ƒè’™ç‰¹å¡æ´›è¿‘ä¼¼ã€‚ ä¸‰ã€ä½¿ç”¨ç­–ç•¥æ¢¯åº¦æ›´æ–°ç­–ç•¥ç½‘ç»œ é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•ä¼°è®¡åŠ¨ä½œä»·å€¼å‡½æ•°QÏ€(st,at)ï¼Ÿ ç»™å‡ºäº†è¿™ä¸¤ç§æ–¹æ³•ï¼š REINFORCEï¼šå¿…é¡»è·å–åˆ°ä¸€ä¸ªå®Œæ•´çš„trajectoryæ‰èƒ½è¿›è¡Œä¸€æ¬¡æ¨¡å‹å‚æ•°çš„æ›´æ–°ï¼Œä¹Ÿå°±æ˜¯è’™ç‰¹å¡ç½—æ–¹æ³•ï¼ˆMC Methodï¼‰æ¥ä¼°è®¡Q Actor-Criticï¼ˆACï¼‰ï¼šä½¿ç”¨å¦ä¸€ä¸ªç¥ç»ç½‘ç»œæ¥è¿‘ä¼¼QÏ€ å››ã€æ€»ç»“ï¼ˆSummaryï¼‰ ç›´æ¥é™„å›¾ å¼•å‡ºä¸‹æ–‡ï¼šå°†ä»·å€¼å­¦ä¹ å’Œç­–ç•¥å­¦ä¹ ç»“åˆèµ·æ¥å°±èƒ½å¾—åˆ°éå¸¸é‡è¦çš„Actor-Criticæ–¹æ³•ï¼ˆAC Methodï¼‰ ","link":"https://tianxiawuhao.github.io/0gyURSJ-J/"},{"title":"ç‹æ ‘æ£®æ·±åº¦å¼ºåŒ–å­¦ä¹ ç¬”è®°2ï¼šä»·å€¼å­¦ä¹  Value-Based Learning","content":"ä¸€ã€æ·±åº¦Qç½‘ç»œï¼ˆDeep Q-Network DQNï¼‰ 1ï¼‰è¿‘ä¼¼Qå‡½æ•°ï¼ˆApproximate the Q* Functionï¼‰ Q*(s,a)å¯ä»¥è¢«çœ‹æˆä¸€ä¸ªå…ˆçŸ¥ï¼Œå®ƒå¯ä»¥å‘Šè¯‰Agentå¦‚ä½•é€‰æ‹©ä¸€ä¸ªæœ€å¥½çš„åŠ¨ä½œaï¼Œä½†Q*(s,a)å¹¶ä¸çŸ¥é“ï¼Œå› æ­¤è¿™é‡Œéœ€è¦è¿‘ä¼¼Q*ï¼ˆs,aï¼‰ DQNæ˜¯ä¸€ç§ä»·å€¼å­¦ä¹ çš„æ–¹æ³•ï¼Œåˆ©ç”¨ä¸€ä¸ªç¥ç»ç½‘ç»œï¼ˆNeural Network NNï¼‰å»è¿‘ä¼¼ä¸€ä¸ªQ*(s,a)ï¼Œè®°ä¸ºQ(s,a;w) å¯¹äºä¸åŒé—®é¢˜ï¼ŒDQNä¹Ÿè®¸ä¸ä¸€æ ·ï¼Œä»¥è¶…çº§ç›ä¸½ä¸ºä¾‹ï¼š DQNçš„è®­ç»ƒAgentçš„ä¸€ä¸ªtrajectoryå¦‚ä¸‹å›¾ï¼š 2ï¼‰æ—¶åºå·®åˆ†æ–¹æ³•ï¼ˆTemporal Difference Learning TD-Learningï¼‰ ### é‡è¦ é‡è¦ éå¸¸é‡è¦ ### ä»¥æˆ‘è‡ªå·±çš„æƒ³æ³•å¤è¿°ä¸€éç‹æ ‘æ£®è€å¸ˆçš„ä¾‹å­ï¼šå¦‚æœæˆ‘æƒ³è¦ä»çº½çº¦åˆ°äºšç‰¹å…°å¤§ï¼Œä¸”æ¨¡å‹*Q(w)*é¢„æµ‹äº†æ¶ˆè€—çš„æ—¶é—´æ˜¯1000åˆ†é’Ÿï¼Œè¿™ä¸ªæ¨¡å‹ä¸€å¼€å§‹æ˜¯éšæœºçš„ã€‚ é‚£ä¹ˆå¦‚ä½•æ›´æ–°æ¨¡å‹ï¼Œä½¿æ¨¡å‹çš„é¢„æµ‹å€¼å˜å¾—è¶Šæ¥è¶Šå‡†ç¡®ï¼Ÿ â‘ é¦–å…ˆåšå‡ºä¸€ä¸ªé¢„æµ‹ï¼šq=Q(w) â†’ q=1000 â‘¡å®Œæˆè¿™æ®µè·¯ç¨‹å¾—åˆ°çœŸå®å€¼yï¼šy=860 è¿™æ—¶ï¼Œäº§ç”Ÿäº†ä¸€ä¸ªåå·®ï¼ˆq-yï¼‰ æˆ‘ä»¬è®°æŸå¤±Lossä¸ºï¼šL=1/2*(q-y)Â²ï¼Œå³L2èŒƒå¼ï¼Œå‰é¢çš„1/2å¯ä»¥ç†è§£ä¸ºæ–¹ä¾¿è®¡ç®—æ¢¯åº¦ï¼Œçº¿æ€§å˜æ¢å¹¶ä¸ä¼šå½±å“æ•°æ®æ•´ä½“çš„ç›¸å¯¹å€¼ï¼Œä¾‹å¦‚ï¼Œ1ç›¸å¯¹äº2æ˜¯1/2å€çš„å…³ç³»ï¼Œ0.5ç›¸å¯¹äº1æ˜¯1/2å€çš„å…³ç³»ã€‚ï¼ˆè‹¥æœ‰é—®é¢˜ï¼Œæ¬¢è¿å¤§ä½¬æŒ‡ç‚¹ï¼‰ é‚£ä¹ˆï¼Œä¸ºäº†æ˜¯é¢„æµ‹å€¼å°½å¯èƒ½çš„é€¼è¿‘çœŸå®å€¼ï¼Œæˆ‘ä»¬å¿…é¡»éœ€è¦è®©Losså–åˆ°æœ€å°å€¼ã€‚å› æ­¤è¿™é‡Œå°±å¼•å…¥äº†Lå¯¹wçš„æ¢¯åº¦Gradientï¼Œä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯æ±‚å¯¼ã€‚ä½¿ç”¨åå¾®åˆ†çš„é“¾å¼æ³•åˆ™ï¼Œæˆ‘ä»¬å¯ä»¥æ¨å¯¼å‡ºLå¯¹wæ¢¯åº¦çš„è¡¨è¾¾å¼ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š è¿™æ ·ï¼Œæˆ‘ä»¬åœ¨è¿›è¡Œå‚æ•°æ›´æ–°æ—¶ï¼Œé‡‡ç”¨æ¢¯åº¦ä¸‹é™ç®—æ³•ï¼ˆGradient Descentï¼‰å³å¯ä½¿å‚æ•°wä¸æ–­æ¥è¿‘çœŸå®å€¼å¯¹åº”çš„å‚æ•°w*ã€‚ è€Œç°åœ¨ï¼Œè‹¥åˆ°è¾¾ä¸äº†ç›®çš„åœ°ï¼Œä¸è·å–åˆ°çœŸå®çš„å…¨è·¯ç¨‹çš„çœŸå®å€¼ï¼Œå°±å¯ä»¥åˆ©ç”¨TDç®—æ³•æ¥æ›´æ–°æ¨¡å‹å‚æ•°ã€‚ å‡è®¾æˆ‘ä»¬ä»çº½çº¦æƒ³äºšç‰¹å…°å¤§å‡ºå‘ï¼Œé€”ä¸­ç»è¿‡åç››é¡¿ï¼Œè€Œåœ¨åç››é¡¿åœä½ä¸èµ°ï¼Œé‚£ä¹ˆæ­¤æ—¶çš„é¢„æµ‹å°±ä¸å†èƒ½ä½¿ç”¨æ•´æ¡è·¯çš„çœŸå®å€¼æ¥æ›´æ–°é¢„æµ‹å€¼äº†ã€‚ å› æ­¤ï¼Œè¿™é‡Œé‡‡ç”¨TDç®—æ³• æˆ‘ä»¬å·²çŸ¥æ¨¡å‹åšå‡ºä¸€ä¸ªé¢„æµ‹ï¼šq=Q(w) â†’ q=1000 è€Œä»æˆ‘ä»¬ä»çº½çº¦ç»è¿‡åç››é¡¿åœä½ä¸èµ°ï¼Œé‚£ä¹ˆä¾¿æœ‰ä¸€ä¸ªä»çº½çº¦åˆ°åç››é¡¿çš„çœŸå®å€¼ï¼šy1=300 è€Œä»åç››é¡¿åˆ°äºšç‰¹å…°å¤§æœ‰ä¸€ä¸ªæ¨¡å‹é¢„æµ‹å€¼ï¼šq1=Q(w1)â†’q=600 é‚£ä¹ˆæ­¤æ—¶æˆ‘ä»¬å®šä¹‰TD targetä¸º y=y1+q1=900,è¿™é‡Œçš„TD targetæ¯”åŸæœ¬çš„æ¨¡å‹é¢„æµ‹å€¼1000æ›´åŠ å¯é ã€‚ æˆ‘ä»¬è®°æŸå¤±Lossä¸ºï¼šL=1/2*(q-y)Â²ï¼Œå®šä¹‰TD errorä¸ºÎ´=q-y=1000-900ï¼›æ­¤å¤„ä¹Ÿå¯ä»¥ç†è§£æˆæ¨¡å‹å¯¹çº½çº¦åˆ°åç››é¡¿çš„é¢„æµ‹å€¼ä¸º400ï¼Œè€ŒçœŸå®å€¼æ˜¯300ï¼ŒÎ´=400-300=100 ç±»ä¼¼åœ°ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°Loss Functionå…³äºwçš„ä¸€ä¸ªå‡½æ•°ï¼Œå¯¹wæ±‚æ¢¯åº¦ï¼Œå¾—åˆ°Lossçš„æœ€å°å€¼å¯¹åº”çš„wç”¨äºæ›´æ–°å‚æ•°ï¼ˆé‡‡ç”¨æ¢¯åº¦ä¸‹é™æ–¹æ³•Gradient Descentï¼‰ æˆ‘ä»¬å¿…é¡»ä½¿TD errorå°½å¯èƒ½åœ°å°ï¼Œå½“TD error=0æ—¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è·å¾—äº†æœ€ä¼˜çš„æ¨¡å‹ äºŒã€TD Learning+DQN å¦‚ä½•å°†TDç®—æ³•ç”¨äºå­¦ä¹ DQN å¯¹äºä¸Šè¿°ä¾‹å­ï¼Œæˆ‘ä»¬æœ‰äº†è¿™æ ·çš„æ–¹ç¨‹ ç±»ä¼¼åœ°ï¼Œåœ¨æ·±åº¦å¼ºåŒ–å­¦ä¹ ä¸­ï¼Œæœ‰å¦‚ä¸‹æ–¹ç¨‹ï¼Œå³æ˜¯ç”¨TDç®—æ³•å­¦ä¹ DQNçš„æ–¹ç¨‹ï¼š å…¶ä¸­ï¼Œæ–¹ç¨‹å·¦è¾¹æ˜¯DQNåœ¨tæ—¶åˆ»å¯¹çŠ¶æ€å’ŒåŠ¨ä½œï¼ˆstï¼Œatï¼‰è¿›è¡Œçš„ä¸€æ¬¡ä¼°è®¡ï¼›ç­‰å¼å³è¾¹æ˜¯åœ¨tæ—¶åˆ»çœŸå®è§‚æµ‹åˆ°çš„å¥–åŠ±ï¼Œä»¥åŠDQNåœ¨t+1æ—¶åˆ»å¯¹äºçŠ¶æ€å’ŒåŠ¨ä½œï¼ˆst+1,at+1ï¼‰è¿›è¡Œçš„ä¸€æ¬¡ä¼°è®¡ã€‚ æ¨å¯¼å¦‚ä¸‹ï¼š å› æ­¤ï¼Œå°†TDç®—æ³•ä¸DQNç»“åˆï¼š ç­‰å¼å·¦è¾¹å¯ä»¥è®¤ä¸ºæ˜¯æ¨¡å‹å¯¹äºæ—¶åˆ»tå…³äºå‚æ•°wçš„é¢„æµ‹å€¼ï¼ˆPredictionï¼‰ï¼›å³è¾¹åˆ™æ˜¯çœŸå®å€¼+æ¨¡å‹å¯¹äºæ—¶åˆ»t+1å…³äºå‚æ•°wçš„é¢„æµ‹å€¼ï¼Œå’Œå¼è®°ä¸ºTD targetã€‚ ä¸ªäººç†è§£ï¼Œè¿™æ˜¯ä¸€ä¸ªè´å°”æ›¼æ–¹ç¨‹ï¼Œå…·ä½“å¯ä»¥å‚ç…§å¿†è‡»ï¼šé©¬å°”ç§‘å¤«å†³ç­–è¿‡ç¨‹ä¹‹Bellman Equationï¼ˆè´å°”æ›¼æ–¹ç¨‹ï¼‰ ä¸‰ã€æ€»ç»“ï¼ˆSummaryï¼‰ ç›´æ¥é™„å›¾ï¼š TDç®—æ³•ç”¨äºå­¦ä¹ DQNçš„ä¸€æ¬¡è¿­ä»£ï¼š å¤šæ¬¡è¿›è¡Œè¿­ä»£ï¼Œæœ€åå°±å¯ä»¥å°†TD erroré€æ¸å‡å°ï¼›æ¢å¥è¯è¯´ï¼Œæ¨¡å‹é¢„æµ‹å€¼è¶Šæ¥è¶Šæ¥è¿‘TD targetã€‚ ","link":"https://tianxiawuhao.github.io/IGO_-1Id1/"},{"title":"ç‹æ ‘æ£®æ·±åº¦å¼ºåŒ–å­¦ä¹ ç¬”è®°1ï¼šåŸºæœ¬æ¦‚å¿µ","content":"ä¸€ã€æ•°å­¦çŸ¥è¯† 1ï¼‰éšæœºå˜é‡ï¼ˆRandom Variableï¼‰ ç»Ÿè®¡å­¦ä¸­å¾€å¾€ç”¨å­—æ¯çš„å¤§å°å†™æ¥åŒºåˆ†éšæœºå˜é‡å’Œè§‚æµ‹å€¼ï¼Œä¾‹å¦‚Xè¡¨ç¤ºéšæœºå˜é‡ï¼Œxè¡¨ç¤ºè§‚æµ‹å€¼ 2ï¼‰æ¦‚ç‡å¯†åº¦å‡½æ•°(Probability Density Function) æ¦‚ç‡å¯†åº¦å‡½æ•°(Probability Density Function)æœ‰è¿™æ ·çš„æ€§è´¨ï¼š 3ï¼‰æœŸæœ›ï¼ˆExpectationï¼‰ ç®€å•æ¥è¯´ï¼Œå¯¹æŸä¸€éšæœºå˜é‡æ±‚æœŸæœ›å°±æ˜¯åœ¨æ±‚å®ƒçš„å¹³å‡ã€‚æœ‰å¾®ç§¯åˆ†åŸºç¡€çš„å¯ä»¥ç†è§£ï¼šå¯¹äºè¿ç»­çš„éšæœºå˜é‡å¯ä»¥é‡‡ç”¨æ±‚æŸä¸€æ®µç§¯åˆ†æ¥è·å¾—æœŸæœ›ï¼›è€Œå¯¹äºç¦»æ•£çš„éšæœºå˜é‡åªéœ€æ±‚å’Œå…¬å¼å³å¯ã€‚ æœŸæœ›ï¼ˆExpectationï¼‰æœ‰å¦‚ä¸‹æ€§è´¨ï¼š 4ï¼‰éšæœºæŠ½æ ·ï¼ˆRandom Samplingï¼‰ ä¸¾ä¸ªä¾‹å­ï¼Œå¯¹äºæŸä¸€éšæœºå˜é‡Xï¼Œå¯èƒ½Xäº§ç”Ÿçš„å€¼æœ‰['R', 'G', 'B']ï¼Œé‚£ä¹ˆéšæœºæŠ½æ ·çš„è¿‡ç¨‹å°±æ˜¯åœ¨Xå¯èƒ½äº§ç”Ÿçš„å€¼['R', 'G', 'B']æŠ½å–çš„è¿‡ç¨‹ äºŒã€ä¸“ä¸šæœ¯è¯­ï¼ˆTerminologyï¼‰ 1ï¼‰çŠ¶æ€å’ŒåŠ¨ä½œï¼ˆState and Actionï¼‰ çŠ¶æ€ï¼ˆState sï¼‰ Agentï¼ˆæ™ºèƒ½ä½“ï¼‰åœ¨æŸä¸€æ—¶åˆ»tæ‰€å¤„çš„çŠ¶æ€ï¼Œå³ä¸ºState sï¼Œå¸¸å¸¸è®°ä¸ºst åŠ¨ä½œï¼ˆAction aï¼‰ Agentï¼ˆæ™ºèƒ½ä½“ï¼‰åœ¨æŸä¸€æ—¶åˆ»tè¿›å…¥çŠ¶æ€ï¼Œåšå‡ºç›¸åº”çš„åŠ¨ä½œï¼Œå³ä¸ºAction a ï¼Œå¸¸å¸¸å³ä¸ºat 2ï¼‰ç­–ç•¥ï¼ˆPolicy Ï€ï¼‰ åœ¨æ•°å­¦ä¸Šï¼Œç­–ç•¥æ˜¯ä¸€ä¸ªæ¦‚ç‡å¯†åº¦å‡½æ•°(Probability Density Function)ï¼Œåœ¨æŸä¸€çŠ¶æ€æ—¶ï¼Œç­–ç•¥æ§åˆ¶Agentåšå‡ºåŠ¨ä½œï¼Œè¿™é‡Œåšå‡ºçš„åŠ¨ä½œæ˜¯éšæœºæŠ½æ ·å¾—åˆ°çš„ã€‚ 3ï¼‰å¥–åŠ±ï¼ˆRewardï¼‰ Agentåœ¨æŸä¸€çŠ¶æ€ä¸­åšå‡ºä¸€ä¸ªåŠ¨ä½œï¼Œå°±ä¼šè·å¾—ä¸€ä¸ªå¥–åŠ± 4ï¼‰çŠ¶æ€è½¬ç§»ï¼ˆState Transitionï¼‰ ä¸€ä¸ªçŠ¶æ€è½¬ç§»åˆ°å¦ä¸€ä¸ªçŠ¶æ€çš„è¿‡ç¨‹å«åšçŠ¶æ€è½¬ç§» 5ï¼‰æ™ºèƒ½ä½“ç¯å¢ƒäº¤äº’è¿‡ç¨‹ 6ï¼‰å¼ºåŒ–å­¦ä¹ ä¸­çš„ä¸¤ç§éšæœºæ€§ ç­–ç•¥å¯¹åŠ¨ä½œè¿›è¡ŒéšæœºæŠ½æ ·ï¼ŒçŠ¶æ€è½¬ç§»å‡½æ•°å¯¹çŠ¶æ€è¿›è¡ŒéšæœºæŠ½æ · 7ï¼‰å¼ºåŒ–å­¦ä¹ çš„è®­ç»ƒè¿‡ç¨‹ï¼ˆä¸€ä¸ªtrajectoryï¼‰ 8ï¼‰å›æŠ¥ï¼ˆReturnï¼‰ å®šä¹‰ä¸ºï¼šæœªæ¥å¥–åŠ±çš„æ€»å’Œï¼ˆCumulative Future Rewardï¼‰ï¼Œè®°ä½œUtï¼Œç”±äºæ¯ä¸€æ­¥æˆ‘ä»¬å¹¶ä¸çŸ¥é“Utçš„å¤§å°ï¼ŒUtå› æ­¤æ˜¯éšæœºå˜é‡ ç”±äºæœªæ¥å¥–åŠ±çš„ä¸ç¡®å®šæ€§ï¼Œå› æ­¤å¼ºåŒ–å­¦ä¹ ä¸­å¾€å¾€é‡‡ç”¨æŠ˜æ‰£å›æŠ¥ï¼ˆDiscounted Returnï¼‰ å®šä¹‰ä¸ºï¼šæŠ˜æ‰£æ€§æœªæ¥å¥–åŠ±çš„æ€»å’Œï¼ˆCumulative Discounted Future Rewardï¼‰ å›æŠ¥çš„éšæœºæ€§ï¼ˆRandomness in Returnsï¼‰ ç”±äºå›æŠ¥å–å†³äºå¥–åŠ±ï¼Œè€Œå¥–åŠ±åˆæ˜¯ç”±Agentæ‰€è¿›å…¥çš„çŠ¶æ€å’Œåšå‡ºçš„åŠ¨ä½œè¿›è¡Œæ‰“åˆ†è€Œå¾—åˆ°çš„ï¼Œä¸Šæ–‡å·²ç»æåˆ°äº†åœ¨å¼ºåŒ–å­¦ä¹ ä¸­çŠ¶æ€å’ŒåŠ¨ä½œå‡å…·æœ‰éšæœºæ€§ï¼Œå› æ­¤å›æŠ¥ï¼ˆReturnï¼‰ä¹Ÿå…·æœ‰éšæœºæ€§ã€‚ 9ï¼‰åŠ¨ä½œä»·å€¼å‡½æ•°ï¼ˆAction-Value Functionï¼‰Q(s,a) ä¸Šé¢è®²åˆ°äº†ï¼ŒUtæ˜¯ä¸€ä¸ªéšæœºå˜é‡ï¼Œä¾èµ–äºæœªæ¥æ‰€æœ‰çš„åŠ¨ä½œAå’ŒçŠ¶æ€Sï¼Œå› æ­¤ä¸ºäº†æ— æ³•è¯„ä¼°å½“å‰å½¢åŠ¿ã€‚æ•…å¼•å…¥åŠ¨ä½œä»·å€¼å‡½æ•°ï¼Œç”¨å¯¹Utæ±‚æœŸæœ›ï¼Œç”¨ç§¯åˆ†å°†éšæœºæ€§ç§¯æ‰ï¼Œè¿™æ ·å°±èƒ½å¾—åˆ°ä¸€ä¸ªå®æ•°ï¼Œç”¨äºè¯„ä¼°å½¢åŠ¿ã€‚ æœŸæœ›çš„æ±‚å–æ–¹æ³•ï¼šå°†Utå½“æˆæœªæ¥æ‰€æœ‰çŠ¶æ€Aå’ŒSçš„ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥é™¤äº†å½“å‰çš„åŠ¨ä½œatå’ŒçŠ¶æ€stï¼Œå…¶ä½™æ‰€æœ‰çš„çŠ¶æ€å’ŒåŠ¨ä½œéƒ½è¢«ç§¯æ‰äº†ï¼Œå› æ­¤è¿™é‡Œçš„å¯¹äºç­–ç•¥Ï€çš„åŠ¨ä½œä»·å€¼å‡½æ•°QÏ€ï¼ˆstï¼Œatï¼‰åªå–å†³äºå½“å‰çš„åŠ¨ä½œatå’ŒçŠ¶æ€stçš„è§‚æµ‹å€¼ æœ€ä¼˜åŠ¨ä½œä»·å€¼å‡½æ•°ï¼ˆOptimal Action-Value Functionï¼‰ï¼šèƒ½è®©åŠ¨ä½œä»·å€¼å‡½æ•°*QÏ€ï¼ˆstï¼Œatï¼‰*æœ€å¤§åŒ–çš„é‚£ä¸ª Q*ï¼ˆst,atï¼‰,è¿™é‡Œä¸Ï€æ— å…³ å¯¹äºåŠ¨ä½œçŠ¶æ€ä»·å€¼å‡½æ•°çš„ç†è§£ 10ï¼‰çŠ¶æ€ä»·å€¼å‡½æ•°ï¼ˆState-Value Functionï¼‰ VÏ€ï¼ˆstï¼‰å¯ä»¥å‘Šè¯‰æˆ‘ä»¬å½“å‰çš„å½¢åŠ¿çš„å¥½å è¿™é‡Œçš„VÏ€éœ€è¦åŒºåˆ†è¿ç»­åŠ¨ä½œå’Œç¦»æ•£åŠ¨ä½œï¼š å¯¹äºçŠ¶æ€ä»·å€¼å‡½æ•°çš„ç†è§£ï¼š ä¸‰ã€å¦‚ä½•åˆ©ç”¨AIçš„å¼ºåŒ–å­¦ä¹ æ§åˆ¶æ™ºèƒ½ä½“è®­ç»ƒ 1ï¼‰ä»·å€¼å­¦ä¹ ï¼ˆValue-Based Learningï¼‰ é‡‡ç”¨æœ€ä¼˜åŠ¨ä½œä»·å€¼å‡½æ•°Q*(s,a) 2ï¼‰ç­–ç•¥å­¦ä¹ ï¼ˆPolicy-Based Learningï¼‰ é‡‡ç”¨ç­–ç•¥Ï€(a|s) å››ã€æ€»ç»“ï¼ˆsummaryï¼‰ ç›´æ¥é™„ä¸Šç‹æ ‘æ£®å¤§ç¥çš„Summaryçš„å›¾ï¼š å¼ºåŒ–å­¦ä¹ çš„ä¸€ä¸ªæ€»ä½“è¿‡ç¨‹ï¼š ","link":"https://tianxiawuhao.github.io/D4PTCIT2N/"},{"title":"Docker overlay2ç£ç›˜å ç”¨è¿‡é«˜","content":"Docker overlay2ç£ç›˜å ç”¨è¿‡é«˜ Docker overlay2ç£ç›˜å ç”¨è¿‡é«˜ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ä¸ªåŸå› ï¼š - 1ã€å®¹å™¨æ—¥å¿—æ–‡ä»¶è¿‡å¤§ï¼Œæœªä½œé™åˆ¶ - 2ã€dockeræœªç”¨å®¹å™¨ã€é•œåƒã€ç¼“å­˜ç­‰è¿‡å¤š - 3ã€dockeré»˜è®¤è·¯å¾„å­˜æ”¾ä¸åˆç† ä¸€ã€ç£ç›˜å®¹é‡æŸ¥è¯¢ é€šè¿‡ä»¥ä¸‹ä¸¤æ¡å‘½ä»¤å¯ä»¥å®šä½ç£ç›˜å ç”¨è¿‡é«˜åŸå› ï¼Œå¯æ ¹æ®æŸ¥è¯¢ç»“æœåšç›¸åº”å¤„ç½®ã€‚ 1ã€df -h å®¹é‡æŸ¥è¯¢ [root@hostname ~]# df -h Filesystem Size Used Avail Use% Mounted on /dev/vda1 50G 50G 35M 100% / overlay 50G 50G 35M 100% /data/docker/overlay2/770abd1b64f51f05a0f7c5c71d7349f54c9c152c8f58263ea9dda4960a722d61/merged overlay 50G 50G 35M 100% /data/docker/overlay2/19de54ababc18c2eb4c0d011434ac785480169a4e694c736dcbe938d497b5b3f/merged overlay 50G 50G 35M 100% /data/docker/overlay2/78f613526719dd1eabd3fe1f383ca55f065182e538f81cb719dd53d01055e849/merged overlay 50G 50G 35M 100% /data/docker/overlay2/a18694da44feba8f8379f422fdf67c00a1ac97efb281f8578770b7da4d55ad6a/merged 2ã€du -sh * æ–‡ä»¶å¤§å°æŸ¥è¯¢ #é€çº§æ’æŸ¥å¤§æ–‡ä»¶ä½ç½® [root@hostname ~]# du -sh /* 7.2G /var [root@hostname ~]# du -sh /var/* 37G /opt/open [root@hostname ~]# du -sh /var/lib/* 6.6G /var/lib/docker äºŒã€ç£ç›˜å ç”¨è¿‡é«˜å¤„ç†æ–¹æ³• 1ã€æ—¥å¿—æ–‡ä»¶æ¸…ç† dockerå®¹å™¨è¿è¡Œæ—¶ä¼šäº§ç”Ÿå¤§é‡æ—¥å¿—ï¼Œé»˜è®¤è·¯å¾„ï¼š/var/lib/docker/containers/id-json.logï¼Œéšç€å®¹å™¨è¿è¡Œè¯¥æ—¥å¿—æ–‡ä»¶ä¼šå ç”¨å¤§é‡ç£ç›˜ç©ºé—´ã€‚ 1.1 æ—¥å¿—æ¸…ç©º [root@test ~]# echo '' &gt; å®¹å™¨id-json.log æ³¨ï¼šä¸è¦ç›´æ¥åˆ é™¤æ—¥å¿—æ–‡ä»¶ï¼Œå¦åˆ™å¯èƒ½ä¼šå½±å“æ–°æ—¥å¿—äº§ç”Ÿã€‚ 1.2 é™åˆ¶æ—¥å¿—æ–‡ä»¶å¤§å° ä»¥ä¸Šæ–¹æ³•åªèƒ½æš‚æ—¶è§£å†³æ—¥å¿—å ç”¨ç©ºé—´è¿‡å¤§é—®é¢˜ï¼Œå¦‚æœæƒ³ä¸€åŠ³æ°¸é€¸å¯ä¿®æ”¹dockeré…ç½®æ–‡ä»¶ï¼Œå¢åŠ æ—¥å¿—æ–‡ä»¶å¤§å°é™åˆ¶ã€‚ [root@test ~]# vi /etc/docker/daemon.json { &quot;log-driver&quot;:&quot;json-file&quot;, &quot;log-opts&quot;:{ &quot;max-size&quot; :&quot;50m&quot;, &quot;max-file&quot;:&quot;1&quot; } } 1.3 é‡å¯dokcer [root@test ~]# systemctl daemon-reload [root@test ~]# systemctl restart docker æ³¨ï¼šå·²å­˜åœ¨çš„å®¹å™¨ä¸ä¼šç”Ÿæ•ˆï¼Œéœ€è¦é‡å»ºè¯¥å®¹å™¨æ‰å¯ä»¥ä½¿é…ç½®ç”Ÿæ•ˆ 2ã€å†å²æ•°æ®æ¸…ç† Dockeré•¿æ—¶é—´è¿è¡Œï¼Œä¼šäº§ç”Ÿå¤§é‡æ— ç”¨çš„é•œåƒã€å®¹å™¨ã€ç½‘ç»œç­‰ç¼“å­˜ä¿¡æ¯ï¼Œå ç”¨å¤§é‡ç£ç›˜ç©ºé—´ã€‚æ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨pruneå‘½ä»¤æ¸…ç†ã€‚ 2.1 é‡Šæ”¾æ‰€æœ‰æœªä½¿ç”¨èµ„æº [root@test ~]# docker system prune WARNING! This will remove: - all stopped containers //æ¸…ç†åœæ­¢å®¹å™¨ - all networks not used by at least one container //æ¸…ç†æœªä½¿ç”¨ç½‘ç»œ - all dangling images //æ¸…ç†åºŸå¼ƒé•œåƒ - all dangling build cache //æ¸…ç†æ„å»ºç¼“å­˜ Are you sure you want to continue? [y/N] y Deleted Containers: 7a7fdd019a89eb68325d45ee6821c3f6f9a0b68b5631a21665ec484d59c8a44a Total reclaimed space: 202.4kB æ³¨ï¼šæ•°æ®æ¸…ç†å‰ä¸€å®šè¦æ£€æŸ¥æ˜¯å¦è¿˜æœ‰éœ€è¦ä½¿ç”¨çš„å®¹å™¨å’Œé•œåƒï¼Œé¿å…è¯¯æ¸…ç†ã€‚ 2.2 æŒ‰éœ€æ¸…ç† [root@test ~]# docker image prune //æ¸…ç†åºŸå¼ƒé•œåƒ [root@test ~]# docker container prune //æ¸…ç†åœæ­¢å®¹å™¨ [root@test ~]# docker network prune //æ¸…ç†æœªä½¿ç”¨ç½‘ç»œ [root@test ~]# docker system prune //æ¸…ç†æ„å»ºç¼“å­˜ 3ã€ä¿®æ”¹Dockerè¿è¡Œè·¯å¾„ æ³¨ï¼šæ­¤æ–¹æ³•éœ€åœæ­¢å®¹å™¨ï¼Œè¿ç§»dockerè¿è¡Œç›®å½•ï¼Œè¯·åœ¨ä¸šåŠ¡ç©ºé—²æœŸï¼Œå¤‡ä»½å¥½æ•°æ®åæ“ä½œã€‚ Dockerè¿è¡Œæ—¶ä½¿ç”¨çš„ç›®å½•é»˜è®¤ â€œ/var/lib/dockerâ€ï¼Œè¯¥ç›®å½•å ç”¨æ ¹ç›®å½•ç£ç›˜ç©ºé—´ï¼Œæ ¹ç›®å½•ç£ç›˜å®¹é‡æ™®éè¾ƒå°ã€‚æ—¥å¸¸ç”Ÿæˆç¯å¢ƒLinuxå¸¸ä¼šæŒ‚è½½å¤§å®¹é‡æ•°æ®ç›˜ï¼Œ å¯ä»¥å°†Dockeré»˜è®¤è¿è¡Œç›®å½•ä¿®æ”¹åˆ°æ•°æ®ç›˜ã€‚ ä¿®æ”¹Dockerè¿è¡Œè·¯å¾„æœ‰ä¸¤ç§æ–¹æ³•ï¼š - 1ã€è¿ç§»/var/lib/dockeræ•°æ®ï¼Œåˆ›å»ºè½¯è¿æ¥ã€‚æ­¤ç§æ–¹æ³•ä¸éœ€è¦æ”¹é…ç½®æ–‡ä»¶ã€‚ - 2ã€è¿ç§»/var/lib/dockeræ•°æ®ï¼Œä¿®æ”¹dockeré…ç½®æ–‡ä»¶ã€‚ 3.1 è¿ç§»/var/lib/dockeræ•°æ®ï¼Œåˆ›å»ºè½¯è¿æ¥ #dockerè¿è¡Œç›®å½•åœ¨/var/lib/dockerä¸‹ [root@test ~]# df -h æ–‡ä»¶ç³»ç»Ÿ å®¹é‡ å·²ç”¨ å¯ç”¨ å·²ç”¨% æŒ‚è½½ç‚¹ overlay 50G 5.8G 45G 12% /var/lib/docker/overlay2/c9de256d8ded736cf99dddda4c4f68e9c5e5162e1b7e70abdb0cd3fbfbbb7a19/merged overlay 50G 5.8G 45G 12% /var/lib/docker/overlay2/4e844541eb13d9c7af1c01f0b4681915e617c650c22a20e52f4b77e1e90dc369/merged overlay 50G 5.8G 45G 12% /var/lib/docker/overlay2/176c72f3913eea50a7bded4ad65363280680615c083140c725cfa63e4287cc51/merged #åœæ­¢æ‰€æœ‰å®¹å™¨ï¼Œé¿å…è¿ç§»æ—¶å½±å“ä¸šåŠ¡ [root@test ~]# docker stop $(docker ps -a | awk '{ print $1}' | tail -n +2) #å°†dockeré»˜è®¤è¿è¡Œç›®å½•å‰ªåˆ‡åˆ°optç›®å½• [root@test ~]# mv /var/lib/docker /opt/ #æŸ¥è¯¢æ˜¯å¦å·²å‰ªåˆ‡å®Œæˆ [root@test ~]# ls /opt/ containerd docker hio rh #æ–°è¿è¡Œç›®å½•åˆ›å»ºè½¯è¿æ¥ [root@test ~]# ln -s /opt/docker /var/lib/docker #é‡å¯dockeræœåŠ¡ [root@test ~]# systemctl restart docker #å¯åŠ¨æ‰€æœ‰å®¹å™¨ [root@test ~]# docker start $(docker ps -a | awk '{ print $1}' | tail -n +2) #æ£€æŸ¥åŸé•œåƒæ˜¯å¦å­˜åœ¨ [root@test ~]# docker images #æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿è¡Œæ­£å¸¸ [root@test ~]# docker ps #æ£€æŸ¥dockeré»˜è®¤è·¯å¾„æ˜¯å¦åˆ‡æ¢æˆåŠŸï¼Œå·²åˆ‡æ¢åˆ°/opt/dockerä¸‹ [root@test ~]# df -h æ–‡ä»¶ç³»ç»Ÿ å®¹é‡ å·²ç”¨ å¯ç”¨ å·²ç”¨% æŒ‚è½½ç‚¹ overlay 50G 5.8G 45G 12% /opt/docker/overlay2/176c72f3913eea50a7bded4ad65363280680615c083140c725cfa63e4287cc51/merged overlay 50G 5.8G 45G 12% /opt/docker/overlay2/4e844541eb13d9c7af1c01f0b4681915e617c650c22a20e52f4b77e1e90dc369/merged overlay 50G 5.8G 45G 12% /opt/docker/overlay2/c9de256d8ded736cf99dddda4c4f68e9c5e5162e1b7e70abdb0cd3fbfbbb7a19/merged 3.2 è¿ç§»/var/lib/dockeræ•°æ®ï¼Œä¿®æ”¹dockeré…ç½® #dockerè¿è¡Œç›®å½•åœ¨/var/lib/dockerä¸‹ [root@test ~]# df -h æ–‡ä»¶ç³»ç»Ÿ å®¹é‡ å·²ç”¨ å¯ç”¨ å·²ç”¨% æŒ‚è½½ç‚¹ overlay 50G 5.8G 45G 12% /var/lib/docker/overlay2/c9de256d8ded736cf99dddda4c4f68e9c5e5162e1b7e70abdb0cd3fbfbbb7a19/merged overlay 50G 5.8G 45G 12% /var/lib/docker/overlay2/4e844541eb13d9c7af1c01f0b4681915e617c650c22a20e52f4b77e1e90dc369/merged overlay 50G 5.8G 45G 12% /var/lib/docker/overlay2/176c72f3913eea50a7bded4ad65363280680615c083140c725cfa63e4287cc51/merged #åœæ­¢æ‰€æœ‰å®¹å™¨ï¼Œé¿å…è¿ç§»æ—¶å½±å“ä¸šåŠ¡ [root@test ~]# docker stop $(docker ps -a | awk '{ print $1}' | tail -n +2) #å°†dockeré»˜è®¤è¿è¡Œç›®å½•å‰ªåˆ‡åˆ°optç›®å½• [root@test ~]# mv /var/lib/docker /opt/ #æŸ¥è¯¢æ˜¯å¦å·²å‰ªåˆ‡å®Œæˆ [root@test ~]# ls /opt/ containerd docker hio rh #ä¿®æ”¹dockeré…ç½®æ–‡ä»¶ï¼Œæ·»åŠ  &quot;data-root&quot;è·¯å¾„ [root@test ~]# vi /etc/docker/daemon.json { &quot;data-root&quot;: &quot;/opt/docker&quot; } #é‡å¯dockeræœåŠ¡ [root@test ~]# systemctl daemon-reload [root@test ~]# systemctl restart docker #å¯åŠ¨æ‰€æœ‰å®¹å™¨ [root@test ~]# docker start $(docker ps -a | awk '{ print $1}' | tail -n +2) #æ£€æŸ¥åŸé•œåƒæ˜¯å¦å­˜åœ¨ [root@test ~]# docker images #æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿è¡Œæ­£å¸¸ [root@test ~]# docker ps #æ£€æŸ¥dockeré»˜è®¤è·¯å¾„æ˜¯å¦åˆ‡æ¢æˆåŠŸï¼Œå·²åˆ‡æ¢åˆ°/opt/dockerä¸‹ [root@test ~]# df -h æ–‡ä»¶ç³»ç»Ÿ å®¹é‡ å·²ç”¨ å¯ç”¨ å·²ç”¨% æŒ‚è½½ç‚¹ overlay 50G 5.8G 45G 12% /opt/docker/overlay2/176c72f3913eea50a7bded4ad65363280680615c083140c725cfa63e4287cc51/merged overlay 50G 5.8G 45G 12% /opt/docker/overlay2/4e844541eb13d9c7af1c01f0b4681915e617c650c22a20e52f4b77e1e90dc369/merged overlay 50G 5.8G 45G 12% /opt/docker/overlay2/c9de256d8ded736cf99dddda4c4f68e9c5e5162e1b7e70abdb0cd3fbfbbb7a19/merged ","link":"https://tianxiawuhao.github.io/qvR3ZWwD8/"},{"title":"CompletableFuture","content":"å‰è¨€ CompletableFutureç»§æ‰¿äºjava.util.concurrent.Futureï¼Œå®ƒæœ¬èº«å…·å¤‡Futureçš„æ‰€æœ‰ç‰¹æ€§ï¼Œå¹¶ä¸”åŸºäºJDK1.8çš„æµå¼ç¼–ç¨‹ä»¥åŠLambdaè¡¨è¾¾å¼ç­‰å®ç°ä¸€å…ƒæ“ä½œç¬¦ã€å¼‚æ­¥æ€§ä»¥åŠäº‹ä»¶é©±åŠ¨ç¼–ç¨‹æ¨¡å‹ï¼Œå¯ä»¥ç”¨æ¥å®ç°å¤šçº¿ç¨‹çš„ä¸²è¡Œå…³ç³»ï¼Œå¹¶è¡Œå…³ç³»ï¼Œèšåˆå…³ç³»ã€‚å®ƒçš„çµæ´»æ€§å’Œæ›´å¼ºå¤§çš„åŠŸèƒ½æ˜¯Futureæ— æ³•æ¯”æ‹Ÿçš„ã€‚ ä¸€ã€åˆ›å»ºæ–¹å¼ 1. ç”¨é»˜è®¤çº¿ç¨‹æ±  CompletableFuture&lt;String&gt; future = new CompletableFuture&lt;&gt;(); é»˜è®¤ä½¿ç”¨ ForkJoinPool.commonPool()ï¼ŒcommonPoolæ˜¯ä¸€ä¸ªä¼šè¢«å¾ˆå¤šä»»åŠ¡ å…±äº« çš„çº¿ç¨‹æ± ï¼Œæ¯”å¦‚åŒä¸€ JVM ä¸Šçš„æ‰€æœ‰ CompletableFutureã€å¹¶è¡Œ Stream éƒ½å°†å…±äº« commonPoolï¼ŒcommonPool è®¾è®¡æ—¶çš„ç›®æ ‡åœºæ™¯æ˜¯è¿è¡Œ éé˜»å¡çš„ CPU å¯†é›†å‹ä»»åŠ¡ï¼Œä¸ºæœ€å¤§åŒ–åˆ©ç”¨ CPUï¼Œå…¶çº¿ç¨‹æ•°é»˜è®¤ä¸º CPU æ•°é‡ - 1ã€‚ 2. ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ±  ThreadPoolExecutor pool = new ThreadPoolExecutor(2, 4, 3, TimeUnit.SECONDS, new ArrayBlockingQueue&lt;Runnable&gt;(3), new ThreadPoolExecutor.DiscardOldestPolicy()); CompletableFuture.runAsync(() -&gt; System.out.println(&quot;Hello World!&quot;), pool); äºŒã€ä½¿ç”¨ç¤ºä¾‹ 1. æ„å»ºå¼‚æ­¥ä»»åŠ¡ æ–¹æ³• æœ‰æ— è¿”å›å€¼ æè¿° runAsync æ—  è¿›è¡Œæ•°æ®å¤„ç†ï¼Œæ¥æ”¶å‰ä¸€æ­¥éª¤ä¼ é€’çš„æ•°æ®ï¼Œæ— è¿”å›å€¼ã€‚ supplyAsync æœ‰ è¿›è¡Œæ•°æ®å¤„ç†ï¼Œæ¥æ”¶å‰ä¸€æ­¥éª¤ä¼ é€’çš„æ•°æ®ï¼Œå¤„ç†åŠ å·¥åè¿”å›ã€‚è¿”å›æ•°æ®ç±»å‹å¯ä»¥å’Œå‰ä¸€æ­¥éª¤è¿”å›çš„æ•°æ®ç±»å‹ä¸åŒã€‚ ï¼ˆ1ï¼‰runAsync public static CompletableFuture&lt;Void&gt; runAsync(Runnable runnable) { return asyncRunStage(asyncPool, runnable); } ç¤ºä¾‹ public static void runAsync() { //ä½¿ç”¨é»˜è®¤çº¿ç¨‹æ±  CompletableFuture cf = CompletableFuture.runAsync(() -&gt; System.out.println(&quot;Hello World!&quot;)); assertFalse(cf.isDone()); //ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ±  CompletableFuture.runAsync(() -&gt; System.out.println(&quot;Hello World!&quot;), Executors.newSingleThreadExecutor()); } ï¼ˆ2ï¼‰supplyAsync public static &lt;U&gt; CompletableFuture&lt;U&gt; supplyAsync(Supplier&lt;U&gt; supplier) { return asyncSupplyStage(asyncPool, supplier); } ç¤ºä¾‹ public static void supplyAsync() throws ExecutionException, InterruptedException { CompletableFuture&lt;String&gt; f = CompletableFuture.supplyAsync(() -&gt; { try { //ForkJoinPool.commonPool-worker-1çº¿ç¨‹ System.out.println(Thread.currentThread().getName()); Thread.sleep(3000); } catch (InterruptedException e) { e.printStackTrace(); } return &quot;hello&quot;; }); //é˜»å¡ç­‰å¾…3ç§’ String result = f.get(); //mainçº¿ç¨‹ System.out.println(Thread.currentThread().getName()); System.out.println(result); } 2. å•ä»»åŠ¡ç»“æœæ¶ˆè´¹ æ–¹æ³• æœ‰æ— è¿”å›å€¼ æè¿° thenApply æœ‰ åœ¨å‰ä¸€ä¸ªé˜¶æ®µä¸Šåº”ç”¨thenApplyå‡½æ•°ï¼Œå°†ä¸Šä¸€é˜¶æ®µå®Œæˆçš„ç»“æœä½œä¸ºå½“å‰é˜¶æ®µçš„å…¥å‚ thenAccept æ— è¿”å›å€¼ æ¶ˆè´¹å‰ä¸€é˜¶æ®µçš„ç»“æœ thenRun æ— è¿”å›å€¼ï¼Œå¹¶ä¸”æ— å…¥å‚ å½“ä¸Šä¸€é˜¶æ®µå®Œæˆåï¼Œæ‰§è¡Œæœ¬é˜¶æ®µçš„ä»»åŠ¡ ï¼ˆ1ï¼‰thenApply public &lt;U&gt; CompletableFuture&lt;U&gt; thenApplyAsync( Function&lt;? super T,? extends U&gt; fn) { return uniApplyStage(asyncPool, fn); } ç¤ºä¾‹ csharpå¤åˆ¶ä»£ç public static void thenApply() throws ExecutionException, InterruptedException { CompletableFuture cf = CompletableFuture.completedFuture(&quot;message&quot;).thenApplyAsync(s -&gt; { System.out.println(s); return s.toUpperCase(); }).thenApply(s-&gt;{ System.out.println(s); return s + &quot;:body&quot;; }); System.out.println(cf.get()); } thenæ„å‘³ç€è¿™ä¸ªé˜¶æ®µçš„åŠ¨ä½œå‘ç”Ÿå½“å‰çš„é˜¶æ®µæ­£å¸¸å®Œæˆä¹‹åã€‚æœ¬ä¾‹ä¸­ï¼Œå½“å‰èŠ‚ç‚¹å®Œæˆï¼Œè¿”å›å­—ç¬¦ä¸²messageã€‚ Applyæ„å‘³ç€è¿”å›çš„é˜¶æ®µå°†ä¼šå¯¹ç»“æœå‰ä¸€é˜¶æ®µçš„ç»“æœåº”ç”¨ä¸€ä¸ªå‡½æ•°ã€‚ å‡½æ•°çš„æ‰§è¡Œä¼šè¢«é˜»å¡ ï¼ˆ2ï¼‰thenAccept public static &lt;U&gt; CompletableFuture&lt;U&gt; supplyAsync(Supplier&lt;U&gt; supplier) { return asyncSupplyStage(asyncPool, supplier); } ç¤ºä¾‹ public static void thenAccept() throws InterruptedException { CompletableFuture&lt;Void&gt; future = CompletableFuture.supplyAsync(() -&gt; { return &quot;message&quot;; }).thenAccept((consumer) -&gt; { System.out.println(consumer); }); } ï¼ˆ3ï¼‰thenRun public CompletableFuture&lt;Void&gt; thenRun(Runnable action) { return uniRunStage(null, action); } ç¤ºä¾‹ public static void thenRun() throws InterruptedException { CompletableFuture.supplyAsync(() -&gt; { //æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ System.out.println(&quot;æ‰§è¡Œä»»åŠ¡&quot;); try { Thread.sleep(1000); } catch (InterruptedException e) { e.printStackTrace(); } return &quot;success&quot;; }).thenRun(() -&gt; { // Computation Finished. System.out.println(&quot;ä¸Šä¸€é˜¶æ®µä»»åŠ¡æ‰§è¡Œå®Œæˆ&quot;); }); Thread.sleep(2000); } 3. åˆå¹¶ç»“æœæ¶ˆè´¹ æ–¹æ³• æœ‰æ— è¿”å›å€¼ æè¿° thenCombine æœ‰ åˆå¹¶å¦å¤–ä¸€ä¸ªä»»åŠ¡ï¼Œä¸¤ä¸ªä»»åŠ¡éƒ½å®Œæˆåï¼Œæ‰§è¡ŒBiFunctionï¼Œå…¥å‚ä¸ºä¸¤ä¸ªä»»åŠ¡ç»“æœï¼Œè¿”å›æ–°ç»“æœ thenAcceptBoth æ—  åˆå¹¶å¦å¤–ä¸€ä¸ªä»»åŠ¡ï¼Œä¸¤ä¸ªä»»åŠ¡éƒ½å®Œæˆåï¼Œæ‰§è¡Œè¿™ä¸ªæ–¹æ³•ç­‰å¾…ç¬¬ä¸€ä¸ªé˜¶æ®µçš„å®Œæˆ(å¤§å†™è½¬æ¢)ï¼Œ å®ƒçš„ç»“æœä¼ ç»™ä¸€ä¸ªæŒ‡å®šçš„è¿”å›CompletableFutureå‡½æ•°ï¼Œå®ƒçš„ç»“æœå°±æ˜¯è¿”å›çš„CompletableFutureçš„ç»“æœï¼Œå…¥å‚ä¸ºä¸¤ä¸ªä»»åŠ¡ç»“æœï¼Œä¸è¿”å›æ–°ç»“æœ runAfterBoth æ— è¿”å›å€¼æ— å…¥å‚ åˆå¹¶å¦å¤–ä¸€ä¸ªä»»åŠ¡ï¼Œä¸¤ä¸ªä»»åŠ¡éƒ½å®Œæˆåï¼Œæ‰§è¡ŒRunnableï¼Œæ³¨æ„ï¼Œè¿™é‡Œçš„ä¸¤ä¸ªä»»åŠ¡æ˜¯åŒæ—¶æ‰§è¡Œ ï¼ˆ1ï¼‰thenCombine å¦‚æœCompletableFutureä¾èµ–ä¸¤ä¸ªå‰é¢é˜¶æ®µçš„ç»“æœï¼Œ å®ƒå¤åˆä¸¤ä¸ªé˜¶æ®µçš„ç»“æœå†è¿”å›ä¸€ä¸ªç»“æœï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨thenCombine()å‡½æ•°ã€‚æ•´ä¸ªæµæ°´çº¿æ˜¯åŒæ­¥çš„ã€‚ public &lt;U,V&gt; CompletableFuture&lt;V&gt; thenCombine(CompletionStage&lt;? extends U&gt; other, BiFunction&lt;? super T,? super U,? extends V&gt; fn) { return biApplyStage(null, other, fn); } ç¤ºä¾‹ public static void thenCombine() { CompletableFuture&lt;String&gt; cfA = CompletableFuture.supplyAsync(() -&gt; { System.out.println(&quot;processing a...&quot;); return &quot;hello&quot;; }); CompletableFuture&lt;String&gt; cfB = CompletableFuture.supplyAsync(() -&gt; { System.out.println(&quot;processing b...&quot;); return &quot; world&quot;; }); CompletableFuture&lt;String&gt; cfC = CompletableFuture.supplyAsync(() -&gt; { System.out.println(&quot;processing c...&quot;); return &quot;, I'm CodingTao!&quot;; }); cfA.thenCombine(cfB, (resultA, resultB) -&gt; { System.out.println(resultA + resultB); // hello world return resultA + resultB; }).thenCombine(cfC, (resultAB, resultC) -&gt; { System.out.println(resultAB + resultC); // hello world, I'm CodingTao! return resultAB + resultC; }); } ï¼ˆ2ï¼‰thenAcceptBoth public &lt;U&gt; CompletableFuture&lt;Void&gt; thenAcceptBoth(CompletionStage&lt;? extends U&gt; other, BiConsumer&lt;? super T, ? super U&gt; action) { return biAcceptStage(null, other, action); } ç¤ºä¾‹ private static void thenAcceptBoth() { CompletableFuture&lt;String&gt; cfA = CompletableFuture.supplyAsync(() -&gt; &quot;resultA&quot;); CompletableFuture&lt;String&gt; cfB = CompletableFuture.supplyAsync(() -&gt; &quot;resultB&quot;); cfA.thenAcceptBoth(cfB, (resultA, resultB) -&gt; { //resultA,resultB System.out.println(resultA+&quot;,&quot;+resultB); }); } ï¼ˆ3ï¼‰runAfterBoth public CompletableFuture&lt;Void&gt; runAfterBoth(CompletionStage&lt;?&gt; other, Runnable action) { return biRunStage(null, other, action); } ç¤ºä¾‹ private static void runAfterBoth() { CompletableFuture&lt;String&gt; cfA = CompletableFuture.supplyAsync(() -&gt; { try { Thread.sleep(5000); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(&quot;process a&quot;); return &quot;resultA&quot;; }); CompletableFuture&lt;String&gt; cfB = CompletableFuture.supplyAsync(() -&gt; { try { Thread.sleep(5000); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(&quot;process b&quot;); return &quot;resultB&quot;; }); cfB.runAfterBoth(cfA, () -&gt; { //resultA,resultB System.out.println(&quot;ä»»åŠ¡Aå’Œä»»åŠ¡BåŒæ—¶å®Œæˆ&quot;); }); try { Thread.sleep(6000); } catch (InterruptedException e) { e.printStackTrace(); } } 4. ä»»ä¸€ç»“æœæ¶ˆè´¹ æ–¹æ³• æœ‰æ— è¿”å›å€¼ æè¿° applyToEither æœ‰ å…¶ä¸­ä»»ä¸€ä»»åŠ¡å®Œæˆåï¼Œæ‰§è¡ŒFunctionï¼Œç»“æœè½¬æ¢ï¼Œå…¥å‚ä¸ºå·²å®Œæˆçš„ä»»åŠ¡ç»“æœã€‚è¿”å›æ–°ç»“æœï¼Œè¦æ±‚ä¸¤ä¸ªä»»åŠ¡ç»“æœä¸ºåŒä¸€ç±»å‹ acceptEither æ—  å…¶ä¸­ä»»ä¸€ä»»åŠ¡å®Œæˆåï¼Œæ‰§è¡ŒConsumerï¼Œæ¶ˆè´¹ç»“æœï¼Œå…¥å‚ä¸ºå·²å®Œæˆçš„ä»»åŠ¡ç»“æœã€‚ä¸è¿”å›æ–°ç»“æœï¼Œè¦æ±‚ä¸¤ä¸ªä»»åŠ¡ç»“æœä¸ºåŒä¸€ç±»å‹ runAfterEither æ— è¿”å›å€¼æ— å…¥å‚ å…¶ä¸­ä»»ä¸€ä»»åŠ¡å®Œæˆåï¼Œæ‰§è¡ŒRunnableï¼Œæ¶ˆè´¹ç»“æœï¼Œæ— å…¥å‚ã€‚ä¸è¿”å›æ–°ç»“æœï¼Œä¸è¦æ±‚ä¸¤ä¸ªä»»åŠ¡ç»“æœä¸ºåŒä¸€ç±»å‹ åœºæ™¯ å‡è®¾æŸ¥è¯¢å•†å“aï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼ŒAå’ŒBï¼Œä½†æ˜¯Aå’ŒBçš„æ‰§è¡Œé€Ÿåº¦ä¸ä¸€æ ·ï¼Œå¸Œæœ›å“ªä¸ªå…ˆè¿”å›å°±ç”¨é‚£ä¸ªçš„è¿”å›å€¼ã€‚ ï¼ˆ1ï¼‰applyToEither public &lt;U&gt; CompletableFuture&lt;U&gt; applyToEither(CompletionStage&lt;? extends T&gt; other, Function&lt;? super T, U&gt; fn) { return orApplyStage(null, other, fn); } ç¤ºä¾‹ private static void applyToEither() throws ExecutionException, InterruptedException { CompletableFuture&lt;String&gt; futureA = CompletableFuture.supplyAsync(() -&gt; { try { Thread.sleep(1000); } catch (InterruptedException e) { e.printStackTrace(); } return &quot;é€šè¿‡æ–¹å¼Aè·å–å•†å“a&quot;; }); CompletableFuture&lt;String&gt; futureB = CompletableFuture.supplyAsync(() -&gt; { try { Thread.sleep(2000); } catch (InterruptedException e) { e.printStackTrace(); } return &quot;é€šè¿‡æ–¹å¼Bè·å–å•†å“a&quot;; }); CompletableFuture&lt;String&gt; futureC = futureA.applyToEither(futureB, product -&gt; &quot;ç»“æœ:&quot; + product); //ç»“æœ:é€šè¿‡æ–¹å¼Aè·å–å•†å“a System.out.println(futureC.get()); } ï¼ˆ2ï¼‰acceptEither ï¼ˆ3ï¼‰runAfterEither 5. çº§è”ä»»åŠ¡ æ–¹æ³• æœ‰æ— è¿”å›å€¼ æè¿° thenCompose æœ‰ å½“åŸä»»åŠ¡å®Œæˆåï¼Œä»¥å…¶ç»“æœä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ä»»åŠ¡ï¼ˆè€Œä¸æ˜¯æ–°ç»“æœï¼Œç±»ä¼¼flatMapï¼‰ ï¼ˆ1ï¼‰thenCompose è¿™ä¸ªæ–¹æ³•ç­‰å¾…ç¬¬ä¸€ä¸ªé˜¶æ®µçš„å®Œæˆ(å¤§å†™è½¬æ¢)ï¼Œ å®ƒçš„ç»“æœä¼ ç»™ä¸€ä¸ªæŒ‡å®šçš„è¿”å›CompletableFutureå‡½æ•°ï¼Œå®ƒçš„ç»“æœå°±æ˜¯è¿”å›çš„CompletableFutureçš„ç»“æœã€‚ public &lt;U&gt; CompletableFuture&lt;U&gt; thenCompose( Function&lt;? super T, ? extends CompletionStage&lt;U&gt;&gt; fn) { return uniComposeStage(null, fn); } ç¤ºä¾‹ private static void thenCompose() { String original = &quot;Message&quot;; CompletableFuture cf = CompletableFuture.completedFuture(original).thenApply(s -&gt; delayedUpperCase(s)) .thenCompose(upper -&gt; CompletableFuture.completedFuture(original).thenApply(s -&gt; delayedLowerCase(s)) .thenApply(s -&gt; upper + s)); // MESSAGEmessage System.out.println(cf.join()); } 6. å•ä»»åŠ¡ç»“æœæˆ–å¼‚å¸¸æ¶ˆè´¹ æ–¹æ³• æœ‰æ— è¿”å›å€¼ æè¿° handle æœ‰ ä»»åŠ¡å®Œæˆåæ‰§è¡ŒBiFunctionï¼Œç»“æœè½¬æ¢ï¼Œå…¥å‚ä¸ºç»“æœæˆ–è€…å¼‚å¸¸ï¼Œè¿”å›æ–°ç»“æœ whenComplete æ—  ä»»åŠ¡å®Œæˆåæ‰§è¡ŒBiConsumerï¼Œç»“æœæ¶ˆè´¹ï¼Œå…¥å‚ä¸ºç»“æœæˆ–è€…å¼‚å¸¸ï¼Œä¸è¿”å›æ–°ç»“æœ exceptionally æ—  ä»»åŠ¡å¼‚å¸¸ï¼Œåˆ™æ‰§è¡ŒFunctionï¼Œå¼‚å¸¸è½¬æ¢ï¼Œå…¥å‚ä¸ºåŸä»»åŠ¡çš„å¼‚å¸¸ä¿¡æ¯ï¼Œè‹¥åŸä»»åŠ¡æ— å¼‚å¸¸ï¼Œåˆ™è¿”å›åŸä»»åŠ¡ç»“æœï¼Œå³ä¸æ‰§è¡Œè½¬æ¢ å¼‚å¸¸æµç¨‹ CompletableFuture.supplyAsync(() -&gt; &quot;resultA&quot;) .thenApply(resultA -&gt; resultA + &quot; resultB&quot;) .thenApply(resultB -&gt; resultB + &quot; resultC&quot;) .thenApply(resultC -&gt; resultC + &quot; resultD&quot;); ä¸Šé¢çš„ä»£ç ä¸­ï¼Œä»»åŠ¡ Aã€Bã€Cã€D ä¾æ¬¡æ‰§è¡Œï¼Œå¦‚æœä»»åŠ¡ A æŠ›å‡ºå¼‚å¸¸ï¼ˆå½“ç„¶ä¸Šé¢çš„ä»£ç ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼‰ï¼Œé‚£ä¹ˆåé¢çš„ä»»åŠ¡éƒ½å¾—ä¸åˆ°æ‰§è¡Œã€‚å¦‚æœä»»åŠ¡ C æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆä»»åŠ¡ D å¾—ä¸åˆ°æ‰§è¡Œã€‚ é‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆå¤„ç†å¼‚å¸¸å‘¢ï¼Ÿçœ‹ä¸‹é¢çš„ä»£ç ï¼Œæˆ‘ä»¬åœ¨ä»»åŠ¡ A ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œå¹¶å¯¹å…¶è¿›è¡Œå¤„ç†ï¼š ï¼ˆ1ï¼‰handle ç¤ºä¾‹ private static void handle() { CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; &quot;resultA&quot;) .thenApply(resultA -&gt; resultA + &quot; resultB&quot;) // ä»»åŠ¡ C æŠ›å‡ºå¼‚å¸¸ .thenApply(resultB -&gt; {throw new RuntimeException();}) // å¤„ç†ä»»åŠ¡ C çš„è¿”å›å€¼æˆ–å¼‚å¸¸ .handle(new BiFunction&lt;Object, Throwable, Object&gt;() { @Override public Object apply(Object re, Throwable throwable) { if (throwable != null) { return &quot;errorResultC&quot;; } return re; } }) .thenApply(resultC -&gt; { System.out.println(&quot;resultC:&quot; + resultC); return resultC + &quot; resultD&quot;; }); System.out.println(future.join()); } ï¼ˆ2ï¼‰whenComplete ç¤ºä¾‹ private static void whenComplete() throws ExecutionException, InterruptedException { // åˆ›å»ºå¼‚æ­¥æ‰§è¡Œä»»åŠ¡: CompletableFuture&lt;Double&gt; cf = CompletableFuture.supplyAsync(()-&gt;{ System.out.println(Thread.currentThread()+&quot;job1 start,time-&gt;&quot;+System.currentTimeMillis()); try { Thread.sleep(2000); } catch (InterruptedException e) { } if(true){ throw new RuntimeException(&quot;test&quot;); }else{ System.out.println(Thread.currentThread()+&quot;job1 exit,time-&gt;&quot;+System.currentTimeMillis()); return 1.2; } }); //cfæ‰§è¡Œå®Œæˆåä¼šå°†æ‰§è¡Œç»“æœå’Œæ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºçš„å¼‚å¸¸ä¼ å…¥å›è°ƒæ–¹æ³• // å¦‚æœæ˜¯æ­£å¸¸æ‰§è¡Œï¼Œa=1.2ï¼Œbåˆ™ä¼ å…¥çš„å¼‚å¸¸ä¸ºnull //å¦‚æœå¼‚å¸¸æ‰§è¡Œï¼Œa=nullï¼Œbåˆ™ä¼ å…¥å¼‚å¸¸ä¿¡æ¯ CompletableFuture&lt;Double&gt; cf2=cf.whenComplete((a,b)-&gt;{ System.out.println(Thread.currentThread()+&quot;job2 start,time-&gt;&quot;+System.currentTimeMillis()); try { Thread.sleep(2000); } catch (InterruptedException e) { } if(b!=null){ System.out.println(&quot;error stack trace-&gt;&quot;); b.printStackTrace(); }else{ System.out.println(&quot;run succ,result-&gt;&quot;+a); } System.out.println(Thread.currentThread()+&quot;job2 exit,time-&gt;&quot;+System.currentTimeMillis()); }); //ç­‰å¾…å­ä»»åŠ¡æ‰§è¡Œå®Œæˆ System.out.println(&quot;main thread start wait,time-&gt;&quot;+System.currentTimeMillis()); //å¦‚æœcfæ˜¯æ­£å¸¸æ‰§è¡Œçš„ï¼Œcf2.getçš„ç»“æœå°±æ˜¯cfæ‰§è¡Œçš„ç»“æœ //å¦‚æœcfæ˜¯æ‰§è¡Œå¼‚å¸¸ï¼Œåˆ™cf2.getä¼šæŠ›å‡ºå¼‚å¸¸ System.out.println(&quot;run result-&gt;&quot;+cf2.get()); System.out.println(&quot;main thread exit,time-&gt;&quot;+System.currentTimeMillis()); } ï¼ˆ3ï¼‰exceptionally 7. åˆå¹¶å¤šä¸ªcompleteä¸ºä¸€ä¸ª æ–¹æ³• æè¿° allOf åˆå¹¶å¤šä¸ªcompleteä¸ºä¸€ä¸ªï¼Œç­‰å¾…å…¨éƒ¨å®Œæˆ anyOf åˆå¹¶å¤šä¸ªcompleteä¸ºä¸€ä¸ªï¼Œç­‰å¾…å…¶ä¸­ä¹‹ä¸€å®Œæˆ ï¼ˆ1ï¼‰allOf æˆ‘ä»¬åœ¨å¤„ç†ä¸šåŠ¡æ—¶ï¼Œæœ‰æ—¶ä¼šæœ‰å¤šä»»åŠ¡å¼‚æ­¥å¤„ç†ï¼ŒåŒæ­¥è¿”å›ç»“æœçš„æƒ…å†µ é‡‡ç”¨å¤šçº¿ç¨‹æ‰§å¼‚æ­¥è¡ŒæŸç§ä»»åŠ¡ï¼Œæ¯”å¦‚åœ¨ä¸åŒä¸»æœºæŸ¥è¯¢ç£ç›˜åˆ—è¡¨ä¿¡æ¯ã€‚ å°†æ‰§è¡Œç»“æœæœé›†ï¼Œåˆ†ç»„åˆ†ç±»ï¼Œå¤„ç†ã€‚ å°†å¤„ç†ä»¥åçš„ç»“æœç»™äºˆå±•ç¤ºã€‚ ç¤ºä¾‹ // åˆ›å»ºå¼‚æ­¥æ‰§è¡Œä»»åŠ¡: CompletableFuture&lt;Double&gt; cf = CompletableFuture.supplyAsync(()-&gt;{ System.out.println(Thread.currentThread()+&quot; start job1,time-&gt;&quot;+System.currentTimeMillis()); try { Thread.sleep(2000); } catch (InterruptedException e) { } System.out.println(Thread.currentThread()+&quot; exit job1,time-&gt;&quot;+System.currentTimeMillis()); return 1.2; }); CompletableFuture&lt;Double&gt; cf2 = CompletableFuture.supplyAsync(()-&gt;{ System.out.println(Thread.currentThread()+&quot; start job2,time-&gt;&quot;+System.currentTimeMillis()); try { Thread.sleep(1500); } catch (InterruptedException e) { } System.out.println(Thread.currentThread()+&quot; exit job2,time-&gt;&quot;+System.currentTimeMillis()); return 3.2; }); CompletableFuture&lt;Double&gt; cf3 = CompletableFuture.supplyAsync(()-&gt;{ System.out.println(Thread.currentThread()+&quot; start job3,time-&gt;&quot;+System.currentTimeMillis()); try { Thread.sleep(1300); } catch (InterruptedException e) { } // throw new RuntimeException(&quot;test&quot;); System.out.println(Thread.currentThread()+&quot; exit job3,time-&gt;&quot;+System.currentTimeMillis()); return 2.2; }); //allofç­‰å¾…æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆæ‰æ‰§è¡Œcf4ï¼Œå¦‚æœæœ‰ä¸€ä¸ªä»»åŠ¡å¼‚å¸¸ç»ˆæ­¢ï¼Œåˆ™cf4.getæ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œéƒ½æ˜¯æ­£å¸¸æ‰§è¡Œï¼Œcf4.getè¿”å›null //anyOfæ˜¯åªæœ‰ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œæ— è®ºæ˜¯æ­£å¸¸æ‰§è¡Œæˆ–è€…æ‰§è¡Œå¼‚å¸¸ï¼Œéƒ½ä¼šæ‰§è¡Œcf4ï¼Œcf4.getçš„ç»“æœå°±æ˜¯å·²æ‰§è¡Œå®Œæˆçš„ä»»åŠ¡çš„æ‰§è¡Œç»“æœ CompletableFuture cf4=CompletableFuture.allOf(cf,cf2,cf3).whenComplete((a,b)-&gt;{ if(b!=null){ System.out.println(&quot;error stack trace-&gt;&quot;); b.printStackTrace(); }else{ System.out.println(&quot;run succ,result-&gt;&quot;+a); } }); System.out.println(&quot;main thread start cf4.get(),time-&gt;&quot;+System.currentTimeMillis()); //ç­‰å¾…å­ä»»åŠ¡æ‰§è¡Œå®Œæˆ System.out.println(&quot;cf4 run result-&gt;&quot;+cf4.get()); System.out.println(&quot;main thread exit,time-&gt;&quot;+System.currentTimeMillis()); è·å–è¿”å›å€¼æ–¹æ³• public &lt;T&gt; CompletableFuture&lt;List&lt;T&gt;&gt; allOf(List&lt;CompletableFuture&lt;T&gt;&gt; futuresList) { CompletableFuture&lt;Void&gt; allFuturesResult = CompletableFuture.allOf(futuresList.toArray(new CompletableFuture[futuresList.size()])); return allFuturesResult.thenApply(v -&gt; futuresList.stream(). map(future -&gt; future.join()). collect(Collectors.&lt;T&gt;toList()) ); } ï¼ˆ2ï¼‰anyOf CompletableFuture.anyOf()å’Œå…¶åå­—ä»‹ç»çš„ä¸€æ ·ï¼Œå½“ä»»ä½•ä¸€ä¸ªCompletableFutureå®Œæˆçš„æ—¶å€™ã€ç›¸åŒçš„ç»“æœç±»å‹ã€‘ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„CompletableFutureã€‚ ç¤ºä¾‹ private static void anyOf() throws ExecutionException, InterruptedException { CompletableFuture&lt;String&gt; future1 = CompletableFuture.supplyAsync(() -&gt; { try { TimeUnit.SECONDS.sleep(2); } catch (InterruptedException e) { throw new IllegalStateException(e); } return &quot;Result of Future 1&quot;; }); CompletableFuture&lt;String&gt; future2 = CompletableFuture.supplyAsync(() -&gt; { try { TimeUnit.SECONDS.sleep(1); } catch (InterruptedException e) { throw new IllegalStateException(e); } return &quot;Result of Future 2&quot;; }); CompletableFuture&lt;String&gt; future3 = CompletableFuture.supplyAsync(() -&gt; { try { TimeUnit.SECONDS.sleep(3); } catch (InterruptedException e) { throw new IllegalStateException(e); } return &quot;Result of Future 3&quot;; }); CompletableFuture&lt;Object&gt; anyOfFuture = CompletableFuture.anyOf(future1, future2, future3); System.out.println(anyOfFuture.get()); // Result of Future 2 } ä¸‰ã€å…¶ä»–ç›¸å…³api 1. futureæ¥å£ ï¼ˆ1ï¼‰isDone() åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å®Œæˆã€‚ä¸‰ç§å®Œæˆæƒ…å†µï¼šnormallyï¼ˆæ­£å¸¸æ‰§è¡Œå®Œæ¯•ï¼‰ã€exceptionallyï¼ˆæ‰§è¡Œå¼‚å¸¸ï¼‰ã€via cancellationï¼ˆå–æ¶ˆï¼‰ ï¼ˆ2ï¼‰get() é˜»å¡è·å–ç»“æœæˆ–æŠ›å‡ºå—æ£€æµ‹å¼‚å¸¸ï¼Œéœ€è¦æ˜¾ç¤ºè¿›è¡Œtry...catchå¤„ç†ã€‚ ï¼ˆ3ï¼‰get(long timeout,TimeUnit unit) è¶…æ—¶é˜»å¡è·å–ç»“æœ ï¼ˆ4ï¼‰cancel(boolean mayInterruptIfRunning) å–æ¶ˆä»»åŠ¡ï¼Œè‹¥ä¸€ä¸ªä»»åŠ¡æœªå®Œæˆï¼Œåˆ™ä»¥CancellationExceptionå¼‚å¸¸ã€‚å…¶ç›¸å…³æœªå®Œæˆçš„å­ä»»åŠ¡ä¹Ÿä¼šä»¥CompletionExceptionç»“æŸ ï¼ˆ5ï¼‰isCancelled() æ˜¯å¦å·²å–æ¶ˆï¼Œåœ¨ä»»åŠ¡æ­£å¸¸æ‰§è¡Œå®Œæˆå‰å–æ¶ˆï¼Œæ‰ä¸ºtrueã€‚å¦åˆ™ä¸ºfalseã€‚ 2. CompletableFutureæ¥å£ ï¼ˆ1ï¼‰join â€‹ é˜»å¡è·å–ç»“æœæˆ–æŠ›å‡ºéå—æ£€å¼‚å¸¸ã€‚ ï¼ˆ2ï¼‰getNow(T valueIfAbsent) â€‹ è‹¥å½“å‰ä»»åŠ¡æ— ç»“æœï¼Œåˆ™è¿”å›valueIfAbsentï¼Œå¦åˆ™è¿”å›å·²å®Œæˆä»»åŠ¡çš„ç»“æœã€‚ ï¼ˆ3ï¼‰complete(T value) â€‹ è®¾ç½®ä»»åŠ¡ç»“æœï¼Œä»»åŠ¡æ­£å¸¸ç»“æŸï¼Œä¹‹åçš„ä»»åŠ¡çŠ¶æ€ä¸ºå·²å®Œæˆã€‚ ï¼ˆ4ï¼‰completeExceptionally(Throwable ex) â€‹ è®¾ç½®ä»»åŠ¡å¼‚å¸¸ç»“æœï¼Œä»»åŠ¡å¼‚å¸¸ç»“æŸï¼Œä¹‹åçš„ä»»åŠ¡çŠ¶æ€ä¸ºå·²å®Œæˆã€‚ ï¼ˆ5ï¼‰isCompletedExceptionally() â€‹ åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å¼‚å¸¸ç»“æŸã€‚å¼‚å¸¸å¯èƒ½çš„åŸå› æœ‰ï¼šå–æ¶ˆã€æ˜¾ç¤ºè®¾ç½®ä»»åŠ¡å¼‚å¸¸ç»“æœã€ä»»åŠ¡åŠ¨ä½œæ‰§è¡Œå¼‚å¸¸ç­‰ã€‚ ï¼ˆ6ï¼‰getNumberOfDependents() â€‹ è¿”å›ä¾èµ–å½“å‰ä»»åŠ¡çš„ä»»åŠ¡æ•°é‡ï¼Œä¸»è¦ç”¨äºç›‘æ§ã€‚ ï¼ˆ7ï¼‰orTimeout(long timeout,TimeUnit unit) jdk9 â€‹ è®¾ç½®ä»»åŠ¡å®Œæˆè¶…æ—¶æ—¶é—´ï¼Œè‹¥åœ¨æŒ‡å®šæ—¶é—´å†…æœªæ­£å¸¸å®Œæˆï¼Œåˆ™ä»»åŠ¡ä¼šä»¥å¼‚å¸¸(TimeoutException)ç»“æŸã€‚ ï¼ˆ8ï¼‰completeOnTimeout(T value,long timeout,TimeUnit unit) jdk9 â€‹ è®¾ç½®ä»»åŠ¡å®Œæˆè¶…æ—¶æ—¶é—´ï¼Œè‹¥åœ¨æŒ‡å®šæ—¶é—´å†…æœªæ­£å¸¸å®Œæˆï¼Œåˆ™ä»¥ç»™å®šçš„valueä¸ºä»»åŠ¡ç»“æœ å››ã€å®æˆ˜ 1. APIç½‘å…³åšæ¥å£çš„èšåˆ //è¿™ä¸¤ä¸ªå‚æ•°ä»å¤–éƒ¨è·å¾— Long userId = 10006L; String orderId = &quot;XXXXXXXXXXXXXXXXXXXXXX&quot;; //ä»ç”¨æˆ·æœåŠ¡è·å–ç”¨æˆ·ä¿¡æ¯ UserInfo userInfo = userService.getUserInfo(userId); //ä»ç”¨è®¢å•åŠ¡è·å–è®¢å•ä¿¡æ¯ OrderInfo orderInfo = orderService.getOrderInfo(orderId); //è¿”å›ä¸¤è€…çš„èšåˆDTO return new OrderDetailDTO(userInfo,orderInfo); â€‹ ä¸‹é¢ä¸‰ä¸ªå¤–éƒ¨æ¥å£çš„ä¿¡æ¯ä¸€å®šæ˜¯ä¸ç›¸å…³è”çš„ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å¹¶è¡Œè·å–ï¼Œä¸‰ä¸ªæ¥å£çš„ç»“æœéƒ½è·å–å®Œæ¯•ä¹‹ååšä¸€æ¬¡æ•°æ®èšåˆåˆ°DTOå³å¯ï¼Œä¹Ÿå°±æ˜¯èšåˆçš„è€—æ—¶å¤§è‡´æ˜¯è¿™ä¸‰ä¸ªæ¥å£ä¸­è€—æ—¶æœ€é•¿çš„æ¥å£çš„å“åº”æ—¶é—´ @Service public class OrderDetailService { /** * å»ºç«‹ä¸€ä¸ªçº¿ç¨‹æ± ä¸“é—¨äº¤ç»™CompletableFutureä½¿ç”¨ */ private final ThreadPoolExecutor executor = new ThreadPoolExecutor(10, 20, 0, TimeUnit.SECONDS, new ArrayBlockingQueue&lt;&gt;(100)); @Autowired private UserService userService; @Autowired private OrderService orderService; public OrderDetailDTO getOrderDetail(Long userId, String orderId) throws Exception { CompletableFuture&lt;UserInfo&gt; userInfoCompletableFuture = CompletableFuture.supplyAsync(() -&gt; userService.getUserInfo(userId), executor); CompletableFuture&lt;OrderInfo&gt; orderInfoCompletableFuture = CompletableFuture.supplyAsync(() -&gt; orderService.getOrderInfo(orderId), executor); CompletableFuture&lt;OrderDetailDTO&gt; result = userInfoCompletableFuture.thenCombineAsync(orderInfoCompletableFuture, OrderDetailDTO::new, executor); return result.get(); } } äº”ã€åŒºåˆ« ï¼ˆ1ï¼‰whenCompleteå’ŒhandleåŒºåˆ« whenComplete ä¸ handle æ–¹æ³•å°±ç±»ä¼¼äº try..catch..finanlly ä¸­ finally ä»£ç å—ã€‚æ— è®ºæ˜¯å¦å‘ç”Ÿå¼‚å¸¸ï¼Œéƒ½å°†ä¼šæ‰§è¡Œçš„ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•åŒºåˆ«åœ¨äº handle æ”¯æŒè¿”å›ç»“æœã€‚ ï¼ˆ2ï¼‰thenApplyä¸thenComposeçš„å¼‚åŒ â€‹ å¯¹äºthenApplyï¼Œfnå‡½æ•°æ˜¯ä¸€ä¸ªå¯¹ä¸€ä¸ªå·²å®Œæˆçš„stageæˆ–è€…è¯´CompletableFutureçš„çš„è¿”å›å€¼è¿›è¡Œè®¡ç®—ã€æ“ä½œï¼› â€‹ å¯¹äºthenComposeï¼Œfnå‡½æ•°æ˜¯å¯¹å¦ä¸€ä¸ªCompletableFutureè¿›è¡Œè®¡ç®—ã€æ“ä½œã€‚ ï¼ˆ3ï¼‰æœ‰æ— Asyncçš„åŒºåˆ« æ²¡æœ‰Asyncçš„åœ¨CompleteableFutureè°ƒç”¨å®ƒçš„çº¿ç¨‹å®šä¹‰çš„çº¿ç¨‹ä¸Šè¿è¡Œï¼Œå› æ­¤é€šå¸¸ä¸çŸ¥é“åœ¨å“ªé‡Œæ‰§è¡Œè¯¥çº¿ç¨‹ã€‚å¦‚æœç»“æœå·²ç»å¯ç”¨ï¼Œå®ƒå¯èƒ½ä¼šç«‹å³æ‰§è¡Œã€‚ â€‹ æœ‰Asyncçš„æ— è®ºç¯å¢ƒå¦‚ä½•ï¼Œéƒ½åœ¨ç¯å¢ƒå®šä¹‰çš„æ‰§è¡Œç¨‹åºä¸Šè¿è¡Œã€‚ä¸ºæ­¤CompletableFutureé€šå¸¸ForkJoinPool.commonPool()ã€‚ ","link":"https://tianxiawuhao.github.io/iPMnLKVAT/"},{"title":"GoåŸºç¡€-ç±»å‹æ–­è¨€ Type Assertion","content":"Type Assertion ç±»å‹æ–­è¨€(Type Assertion)æ˜¯ä¸€ä¸ªä½¿ç”¨åœ¨æ¥å£å€¼ä¸Šçš„æ“ä½œï¼Œç”¨äºæ£€æŸ¥æ¥å£ç±»å‹å˜é‡æ‰€æŒæœ‰çš„å€¼æ˜¯å¦å®ç°äº†æœŸæœ›çš„æ¥å£æˆ–è€…å…·ä½“çš„ç±»å‹ã€‚ åŠŸèƒ½ 1.æ£€æŸ¥xæ˜¯å¦ä¸ºnil 2.æ£€æŸ¥xå‚¨å­˜çš„å€¼æ˜¯å¦ä¸ºæŸä¸ªç±»å‹ goä¸­ç±»å‹æ–­è¨€å†™æ³•: value, ok := x.(T) å…¶ä¸­xä¸ºinterface{}æ¥å£ç±»å‹ï¼ŒTæ˜¯è¦æ–­è¨€çš„ç±»å‹ï¼›okè‹¥ä¸ºtrueåˆ™è¡¨ç¤ºæ–­è¨€æˆåŠŸï¼Œä¸ºfalseåˆ™è¡¨ç¤ºæ–­è¨€å¤±è´¥ã€‚ ä¸¾ä¸ªä¾‹å­ï¼š ç¬¬ä¸€ç§ï¼š t := x.(T) è¯¥è¡¨è¾¾å¼å¯ä»¥æ–­è¨€ä¸€ä¸ªæ¥å£å¯¹è±¡xé‡Œä¸æ˜¯ nilï¼Œå¹¶ä¸”æ¥å£å¯¹è±¡xå­˜å‚¨çš„å€¼çš„ç±»å‹æ˜¯ Tï¼Œå¦‚æœæ–­è¨€æˆåŠŸï¼Œå°±ä¼šè¿”å›å€¼ç»™ tï¼Œå¦‚æœæ–­è¨€å¤±è´¥ï¼Œå°±ä¼šè§¦å‘ panic package main import &quot;fmt&quot; func main() { var x interface{} = 24 t1 := x.(int) fmt.Println(t1) fmt.Println(&quot;=====åˆ†éš”çº¿=====&quot;) t2 := x.(string) fmt.Println(t2) } è¿è¡Œåè¾“å‡ºå¦‚ä¸‹ï¼Œåœ¨æ‰§è¡Œç¬¬äºŒæ¬¡æ–­è¨€çš„æ—¶å€™å¤±è´¥äº†ï¼Œå¹¶ä¸”è§¦å‘äº† panic 24 =åˆ†éš”çº¿= panic: interface conversion: interface {} is int, not string goroutine 1 [running]: main.main() D:/Development/GoWorkspace/SRC/main.go:19 +0x10d exit status 2 å¦‚æœè¦æ–­è¨€çš„æ¥å£å€¼æ˜¯ nilï¼Œä¹Ÿä¼šè§¦å‘panicã€‚ ç¬¬äºŒç§ï¼š t, ok:= x.(T) è¯¥è¡¨è¾¾å¼ä¸ç¬¬ä¸€ç§ä¸åŒçš„æ˜¯å½“æ–­è¨€å¤±è´¥æ—¶ä¸ä¼šè§¦å‘panicï¼Œè€Œæ˜¯å°† ok çš„å€¼è®¾ä¸º false ï¼Œè¡¨ç¤ºæ–­è¨€å¤±è´¥ï¼Œæ­¤æ—¶t ä¸º T çš„é›¶å€¼ã€‚ package main import &quot;fmt&quot; func main() { var i interface{} = 10 t1, ok := i.(int) fmt.Printf(&quot;%d-%t\\n&quot;, t1, ok) fmt.Println(&quot;=====åˆ†éš”çº¿1=====&quot;) t2, ok := i.(string) fmt.Printf(&quot;%s-%t\\n&quot;, t2, ok) fmt.Println(&quot;=====åˆ†éš”çº¿2=====&quot;) var k interface{} // nil t3, ok := k.(interface{}) fmt.Println(t3, &quot;-&quot;, ok) fmt.Println(&quot;=====åˆ†éš”çº¿3=====&quot;) k = 10 t4, ok := k.(interface{}) fmt.Printf(&quot;%d-%t\\n&quot;, t4, ok) t5, ok := k.(int) fmt.Printf(&quot;%d-%t\\n&quot;, t5, ok) } è¿è¡Œåè¾“å‡ºå¦‚ä¸‹ï¼Œå¯ä»¥å‘ç°åœ¨æ‰§è¡Œç¬¬äºŒæ¬¡æ–­è¨€çš„æ—¶å€™ï¼Œè™½ç„¶å¤±è´¥äº†ï¼Œä½†å¹¶æ²¡æœ‰è§¦å‘äº† panicã€‚ 10-true =====åˆ†éš”çº¿1===== -false =====åˆ†éš”çº¿2===== &lt;nil&gt; - false =====åˆ†éš”çº¿3===== 10-true 10-true éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç¬¬äºŒç»„å¹¶éæ²¡æœ‰è¾“å‡ºä»»ä½•å€¼ï¼Œè€Œæ˜¯t2å€¼ä¸º&quot;&quot;ï¼Œæ˜¯ç©ºå€¼æ²¡æœ‰ä»»ä½•é•¿åº¦æ‰€ä»¥æ— æ³•çœ‹å‡ºå…¶è¾“å‡ºã€‚ Type Switch å¦‚æœéœ€è¦åŒºåˆ†å¤šç§ç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨Type Switchæ–­è¨€æ›´åŠ é«˜æ•ˆã€ä¾¿æ·ã€‚ package main import &quot;fmt&quot; func findType(i interface{}) { switch x := i.(type) { case int: fmt.Println(x, &quot;is int&quot;) case string: fmt.Println(x, &quot;is string&quot;) case nil: fmt.Println(x, &quot;is nil&quot;) default: fmt.Println(x, &quot;not type matched&quot;) } } func main() { findType(10) // int findType(&quot;hello&quot;) // string var k interface{} // nil findType(k) findType(10.23) //float64 } è¾“å‡ºå¦‚ä¸‹ï¼š 10 is int hello is string &lt;nil&gt; is nil 10.23 not type matched æ³¨æ„ï¼š ç±»å‹æ–­è¨€ï¼Œä»…èƒ½å¯¹é™æ€ç±»å‹ä¸ºç©ºæ¥å£ï¼ˆinterface{}ï¼‰çš„å¯¹è±¡è¿›è¡Œæ–­è¨€ï¼Œå¦åˆ™ä¼šæŠ›å‡ºé”™è¯¯ã€‚ ç±»å‹æ–­è¨€å®Œæˆåï¼Œå®é™…ä¸Šä¼šè¿”å›é™æ€ç±»å‹ä¸ºä½ æ–­è¨€çš„ç±»å‹çš„å¯¹è±¡ï¼Œè€Œè¦æ¸…æ¥šåŸæ¥çš„é™æ€ç±»å‹ä¸ºç©ºæ¥å£ç±»å‹ï¼ˆinterface{}ï¼‰ï¼Œè¿™æ˜¯ Go çš„éšå¼è½¬æ¢ã€‚ ","link":"https://tianxiawuhao.github.io/z-YRElc0W/"},{"title":"GraalVM","content":"GraalVM + Native-Image + Springboot3ï¼ˆå®æˆ˜ï¼‰ ä¸€ã€é¦–å…ˆï¼Œæˆ‘ä»¬è‚¯å®šéœ€è¦å‡†å¤‡ä¸€ä¸ªSpringbooté¡¹ç›® 1ã€æ–°å»ºä¸€ä¸ªé¡¹ç›®ï¼ŒJDKä½¿ç”¨graalvm-jdk17ï¼š Springbootç‰ˆæœ¬æˆ‘é€‰æ‹©3.1.1ï¼Œä»¥ä¸€ä¸ªwebé¡¹ç›®ä¸ºä¾‹ï¼š è‡ªåŠ¨ç”Ÿæˆæ ¸å¿ƒçš„pom.xmlæ–‡ä»¶ï¼š &lt;!-- é‡ç‚¹å°±æ˜¯è¿™ä¸ªæ’ä»¶ --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; 2ã€ç¼–å†™ä¸€ä¸ªç®€å•çš„Controllerï¼š import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.RestController; @RestController public class graalController { @GetMapping(&quot;/&quot;) public String demo(){ return &quot;Hello Springboot3 AOT&quot;; } } 3ã€å¸¸è§„è¿è¡Œè®¿é—®è¯¥demoæ¥å£ï¼š é¡¹ç›®æ— é—®é¢˜ï¼Œå¯ç”¨äºæµ‹è¯•ï¼ äºŒã€ä½¿ç”¨native-imageå‘½ä»¤ç¼–è¯‘Springbooté¡¹ç›®ï¼ˆWindowsï¼‰ æ ¸å¿ƒå‘½ä»¤ï¼š 1ã€å…ˆå¯¹åŸé¡¹ç›®è¿›è¡Œä¸€æ¬¡packageæ‰“åŒ…ï¼šmvn clean package -DskipTests 2ã€è¿è¡Œaotæå‰å¤„ç†å‘½ä»¤ï¼šmvn spring-boot:process-aot 3ã€è¿è¡Œnativeæ‰“åŒ…ï¼šmvn -Pnative native:build å½“ç„¶ï¼Œä¹Ÿå¯ä»¥åœ¨Ideaçš„ç•Œé¢ä¸Šè¿›è¡Œæ“ä½œï¼ 1ã€ä½†æ˜¯å¦‚æœåœ¨Windowsç¯å¢ƒä¸‹ï¼Œç›´æ¥è¿è¡Œ native:build å‘½ä»¤ï¼Œä¼šæŠ¥å¦‚ä¸‹çš„é”™è¯¯ï¼š Execution of C:\\installation\\graalvm-jdk17\\graalvm-community-openjdk-17.0.8\\bin\\native-image.cmd @target\\tmp\\native-image-16043596690894935382.args returned non-zero result è¿™ä¸ªé”™è¯¯è§£å†³èµ·æ¥ï¼Œè¿˜æŒºéº»çƒ¦çš„ï¼éœ€è¦é…ç½®ä¸€äº›åˆ—çš„ç¯å¢ƒå˜é‡ï¼ éœ€è¦ä¿®æ”¹3ä¸ªç¯å¢ƒå˜é‡ï¼š*Pathã€INCLUDEã€lib* *æˆ‘ä»¬éœ€è¦çŸ¥é“è‡ªå·±çš„Visual Studioå’ŒWindows KitsåŒ…çš„å®‰è£…ä½ç½®ï¼Œæˆ‘çš„ï¼š* Visual Studioå®‰è£…ç›®å½•ï¼šC:\\Program Files\\Microsoft Visual Studio\\2022\\Community å…¶ä¸­MSVCçš„includeç›®å½•ä½ç½®ï¼šC:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\14.35.32215\\include å…¶ä¸­MSVCçš„libç›®å½•ä½ç½®ï¼šC:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\14.35.32215\\lib\\x64 Windowså·¥å…·åŒ…çš„includeç›®å½•ä½ç½®ï¼šC:\\Program Files (x86)\\Windows Kits\\10\\Include\\10.0.22000.0 Windowså·¥å…·åŒ…çš„libç›®å½•ä½ç½®ï¼šC:\\Program Files (x86)\\Windows Kits\\10\\Lib\\10.0.22000.0 é…ç½®ç¬¬1ä¸ªç¯å¢ƒå˜é‡ï¼Œåœ¨Pathä¸­æ·»åŠ ï¼š C:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\14.33.31629\\bin\\Hostx64\\x64 é…ç½®ç¬¬2ä¸ªç¯å¢ƒå˜é‡ï¼Œæ–°å¢INCLUDEç¯å¢ƒå˜é‡ï¼š C:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\14.35.32215\\include; C:\\Program Files (x86)\\Windows Kits\\10\\Include\\10.0.22000.0\\shared; C:\\Program Files (x86)\\Windows Kits\\10\\Include\\10.0.22000.0\\ucrt; C:\\Program Files (x86)\\Windows Kits\\10\\Include\\10.0.22000.0\\um; C:\\Program Files (x86)\\Windows Kits\\10\\Include\\10.0.22000.0\\winrt; é…ç½®ç¬¬3ä¸ªç¯å¢ƒå˜é‡ï¼Œæ–°å¢libç¯å¢ƒå˜é‡ï¼š C:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\14.35.32215\\lib\\x64; C:\\Program Files (x86)\\Windows Kits\\10\\Lib\\10.0.22000.0\\um\\x64; C:\\Program Files (x86)\\Windows Kits\\10\\Lib\\10.0.22000.0\\ucrt\\x64; 2ã€ä¸Šé¢çš„ç¯å¢ƒå˜é‡æ­£ç¡®é…ç½®å®Œæˆåï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‰§è¡Œæœ€åˆçš„å‘½ä»¤äº†ï¼š ä¸ºäº†ä¿é™©èµ·è§ï¼Œæˆ‘ä»¬å°†åœ¨æœ¬åœ°nativeå·¥å…·ä¸­æ‰§è¡Œnativeç¼–è¯‘æ“ä½œï¼š ------------------------------------------------------------------------------------------------------------------------ Recommendations: HEAP: Set max heap for improved and more predictable memory usage. CPU: Enable more CPU features with '-march=native' for improved performance. ------------------------------------------------------------------------------------------------------------------------ 8.1s (14.0% of total time) in 178 GCs | Peak RSS: 2.58GB | CPU load: 7.70 ------------------------------------------------------------------------------------------------------------------------ Produced artifacts: C:\\study\\minio-java-master\\graalvm\\target\\graalvm.exe (executable) ======================================================================================================================== Finished generating 'graalvm' in 57.1s. [INFO] ------------------------------------------------------------------------ [INFO] BUILD SUCCESS [INFO] ------------------------------------------------------------------------ [INFO] Total time: 59.968 s [INFO] Finished at: 2023-08-31T11:21:48+08:00 [INFO] ------------------------------------------------------------------------ æœ€ç»ˆç”Ÿæˆäº†ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ graalvm.exe æ–‡ä»¶ï¼ 3ã€æˆ‘ä»¬ç›´æ¥åŒå‡»è¿è¡Œ graalvm.exe æ–‡ä»¶ï¼ŒéªŒè¯æ‰“åŒ…æ˜¯å¦æˆåŠŸï¼š æ•´ä¸ªé¡¹ç›®åœ¨0.1ç§’å†…å®Œæˆäº†å¯åŠ¨ï¼Œè¿™ä¹Ÿå°±éªŒè¯äº†ï¼Œä¸ºä»€ä¹ˆè¯´AOTæ‰“æˆå¯æ‰§è¡Œæ–‡ä»¶åï¼Œè¿è¡Œé€Ÿåº¦éå¸¸å¿«ï¼ ","link":"https://tianxiawuhao.github.io/xWe8SRVUm/"},{"title":"Golangåç¨‹è°ƒåº¦å™¨å’ŒGMPæ¨¡å‹","content":" å…ˆä¼šè¿‡ä¸€ä¸ªåˆçº§ä½†æ˜¯å¾ˆé‡è¦çš„æ¦‚å¿µï¼ˆåœ¨Javaå¤šçº¿ç¨‹ä¸­ä¹Ÿä¸åœåœ°å¼ºè°ƒï¼‰ï¼š å¹¶è¡Œï¼šå¤šä¸ªå¤„ç†å™¨åŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡ï¼Œæ— è®ºåœ¨å®è§‚è¿˜æ˜¯å¾®è§‚ä¸Šï¼Œæ¯ä¸€æ—¶å€™éƒ½æ˜¯å¤šä¸ªä»»åŠ¡åŒæ—¶è¢«æ‰§è¡Œï¼› å¹¶å‘ï¼šç”±å•ä¸ªå¤„ç†å™¨åŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡ï¼Œåœ¨å®è§‚ä¸Šä»¿ä½›å¤šä¸ªä»»åŠ¡åœ¨è¢«åŒæ—¶æ‰§è¡Œï¼Œå…¶å®å¾®è§‚ä¸Šï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªä»»åŠ¡è¢«æ‰§è¡Œï¼Œåªæ˜¯æ—¶é—´è¢«åˆ’åˆ†ä¸ºå¾ˆå¤šä¸ªå°çš„æ—¶é—´ç‰‡ï¼Œå¤„ç†å™¨ä¸åœåœ°äº¤æ›¿æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼› å¹¶è¡Œå’Œå¹¶å‘ï¼Œéƒ½æ˜¯ä¸ºäº†å……åˆ†åˆ©ç”¨å’Œæé«˜CPUçš„ä½¿ç”¨ç‡ï¼ ä¸€ã€Golangåç¨‹è°ƒåº¦å™¨çš„ç”±æ¥ 1ã€å•è¿›ç¨‹æ—¶ä»£ä¸éœ€è¦è°ƒåº¦å™¨ï¼š æ—©æœŸçš„æ“ä½œç³»ç»Ÿæ¯ä¸ªç¨‹åºå°±æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œç›´åˆ°ä¸€ä¸ªç¨‹åºè¿è¡Œå®Œï¼Œæ‰èƒ½è¿›è¡Œä¸‹ä¸€ä¸ªè¿›ç¨‹ï¼Œå°±æ˜¯â€œå•è¿›ç¨‹æ—¶ä»£â€ï¼›ï¼ˆæ€§èƒ½æå…¶ä½ä¸‹ï¼‰ å•è·¯çš„æ‰§è¡Œæµç¨‹ï¼Œè®¡ç®—æœºåªèƒ½ä¸€ä¸ªä¸€ä¸ªåœ°å¤„ç†ä»»åŠ¡ï¼› ä¸‡ä¸€æŸä¸ªä»»åŠ¡è¿›ç¨‹é˜»å¡äº†ï¼Œå°†å¸¦æ¥å¤§é‡çš„CPUæ—¶é—´æµªè´¹ï¼› é‚£ä¹ˆèƒ½ä¸èƒ½ç”±å¤šä¸ªè¿›ç¨‹ï¼ˆåœ¨å®è§‚è§’åº¦ï¼‰ä¸€èµ·æ¥æ‰§è¡Œå¤šä¸ªä»»åŠ¡å‘¢ï¼Ÿâ€”â€” å¹¶å‘ 2ã€å¤šè¿›ç¨‹/å¤šçº¿ç¨‹æ—¶ä»£æœ‰äº†è°ƒåº¦å™¨éœ€æ±‚ï¼š Linuxæ“ä½œç³»ç»Ÿåº•å±‚åŸºç¡€çŸ¥è¯†æ‰«ç›² è¿›ç¨‹è°ƒåº¦çš„åˆ†ç±»ï¼š éæŠ¢å å¼ï¼šé™¤éä¸»åŠ¨è®©å‡ºï¼Œå¦åˆ™ä¸€ç›´è¿è¡Œï¼› æŠ¢å å¼ï¼šç”±â€œè¿›ç¨‹è°ƒåº¦å™¨â€å¼ºåˆ¶å®‰æ’ï¼› è¿›ç¨‹è°ƒåº¦çš„ç­–ç•¥ï¼š ç»å…¸Unix(0) è°ƒåº¦ç­–ç•¥ï¼šï¼ˆçœ‹ä¼¼å…¬å¹³ï¼Œå…¶å®æœ‰å¯èƒ½æµªè´¹ï¼‰ CFSå®Œå…¨å…¬å¹³è°ƒåº¦ç­–ç•¥ï¼šï¼ˆæ ¹æ®ä¼˜å…ˆçº§ï¼Œè°ƒæ•´æ—¶é—´ç‰‡æ¯”ä¾‹ï¼‰ Linuxä¸­é»˜è®¤çš„è°ƒåº¦ç­–è®ºç­–ç•¥ï¼ˆæ··åˆï¼‰ï¼š å¯¹äºâ€œæ™®é€šè¿›ç¨‹â€ï¼šå®Œå…¨å…¬å¹³è°ƒåº¦ç­–ç•¥ï¼ˆCFSï¼‰â€”â€” æ™®é€šé—¨è¯Š å¯¹äºâ€œå®æ—¶è¿›ç¨‹â€ï¼šæ€¥è¯Šï¼Œä½†æ˜¯æ€¥è¯Šè¿˜åˆ†ä¸ºï¼šæ™®é€šæ€¥è¯Š å’Œ æœ€æ€¥çš„æ€¥è¯Šï¼š æ™®é€šæ€¥è¯Šï¼šSCHED_RRï¼š åŒä¼˜å…ˆçº§çš„å®æ—¶è¿›ç¨‹ä¸­ï¼Œæ¯ä¸ªè¿›ç¨‹åˆæ˜¯é€šè¿‡è·å¾—æ—¶é—´ç‰‡æ¥åˆ†æ—¶è¿è¡Œã€‚ ä¸åŒä¼˜å…ˆçº§çš„å®æ—¶è¿›ç¨‹ï¼Œé«˜ä¼˜å…ˆçº§çš„å®æ—¶è¿›ç¨‹èƒ½å¤ŸæŠ¢å ä½ä¼˜å…ˆçº§çš„å®æ—¶è¿›ç¨‹ã€‚ æœ€æ€¥çš„æ€¥è¯Šï¼šSCHED_FIFOï¼š åŒä¼˜å…ˆçº§çš„å®æ—¶è¿›ç¨‹ï¼Œåè¿›å…¥çš„è¿›ç¨‹è¦ç­‰å‰ä¸€ä¸ªè¿›ç¨‹é‡Šæ”¾äº†CPUï¼Œæ‰èƒ½å¤Ÿè¿è¡Œã€‚ï¼ˆæ²¡æœ‰æ—¶é—´ç‰‡ï¼‰ ä¸åŒä¼˜å…ˆçº§çš„å®æ—¶è¿›ç¨‹ï¼Œé«˜ä¼˜å…ˆçº§çš„å®æ—¶è¿›ç¨‹èƒ½å¤ŸæŠ¢å ä½ä¼˜å…ˆçº§çš„å®æ—¶è¿›ç¨‹ã€‚ è€Œå¯¹äºLinuxæ“ä½œç³»ç»Ÿæ¥è¯´ï¼Œçº¿ç¨‹çš„æœ¬è´¨å°±æ˜¯ä¸€ä¸ªè½»é‡çº§çš„è¿›ç¨‹ï¼Œæ‰€ä»¥ï¼Œçº¿ç¨‹è°ƒåº¦ä¹Ÿå°±æ˜¯è¿›ç¨‹è°ƒåº¦ï¼›è€Œå¯¹äºJavaæ¥è¯´ï¼Œä¸€ä¸ªç”¨æˆ·æ€çº¿ç¨‹ä¹Ÿå°±æ˜¯å¯¹åº”äº†ä¸€ä¸ªå†…æ ¸æ€çº¿ç¨‹ ä½†æ–°çš„é—®é¢˜å°±åˆå‡ºç°äº†ï¼Œè¿›ç¨‹æ‹¥æœ‰å¤ªå¤šçš„èµ„æºï¼Œè¿›ç¨‹çš„åˆ›å»ºã€åˆ‡æ¢ã€é”€æ¯ï¼Œéƒ½ä¼šå ç”¨å¾ˆé•¿çš„æ—¶é—´ï¼ŒCPUè™½ç„¶åˆ©ç”¨èµ·æ¥äº†ï¼Œä½†å¦‚æœè¿›ç¨‹è¿‡å¤šï¼ŒCPUæœ‰å¾ˆå¤§çš„ä¸€éƒ¨åˆ†éƒ½è¢«ç”¨æ¥è¿›è¡Œè¿›ç¨‹è°ƒåº¦å’Œè¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰åˆ‡æ¢äº†ã€‚ 3ã€åç¨‹æ¥å†æ¬¡æé«˜CPUåˆ©ç”¨ç‡ï¼ˆå‡å°‘è¿›ç¨‹åˆ‡æ¢ï¼‰ï¼š å¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹å·²ç»æé«˜äº†ç³»ç»Ÿçš„å¹¶å‘èƒ½åŠ›ï¼Œä½†æ˜¯åœ¨å½“ä»Šäº’è”ç½‘é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œä¸ºæ¯ä¸ªä»»åŠ¡éƒ½åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ˜¯å¾ˆä¸ç°å®çš„ï¼š ä¼šæ¶ˆè€—å¤§é‡çš„å†…å­˜ï¼š è¿›ç¨‹ï¼šè¿›ç¨‹è™šæ‹Ÿå†…å­˜ï¼ˆ4GB = 1GBå†…æ ¸ç©ºé—´ + 3GBç”¨æˆ·ç©ºé—´ï¼‰ çº¿ç¨‹ï¼šæ¯ä¸ªçº¿ç¨‹å¯åŠ¨å‰åï¼Œä¼šæ¶ˆè€—2MBå·¦å³çš„å†…å­˜ï¼› å¤§é‡çš„è¿›ç¨‹/çº¿ç¨‹è°ƒåº¦æµªè´¹CPUèµ„æºï¼š æœ€å¼€å§‹çš„åç¨‹æ¨¡å‹å’Œçº¿ç¨‹æ¨¡å‹æ˜¯ä¸€æ ·çš„ï¼Œçº¿ç¨‹:åç¨‹ = 1:Nï¼Œå³ä¸€ä¸ªç”¨æˆ·æ€çš„çº¿ç¨‹/åç¨‹ å¯¹åº”ä¸€ä¸ªå†…æ ¸æ€çº¿ç¨‹ï¼š æ€è€ƒï¼šæ—¢ç„¶ä¸€ä¸ªåç¨‹(co-routine)å¯ä»¥ç»‘å®šä¸€ä¸ªçº¿ç¨‹(thread)ï¼Œé‚£ä¹ˆèƒ½ä¸èƒ½å°†å¤šä¸ªåç¨‹(co-routine)åŒæ—¶ç»‘å®šåˆ°ä¸€ä¸ªçº¿ç¨‹(thread)ä¸Šå‘¢ï¼Ÿ äºæ˜¯å°±æœ‰äº† çº¿ç¨‹:åç¨‹ = 1:N æ¨¡å‹ï¼š ä¼˜ç‚¹ï¼šåç¨‹åœ¨ç”¨æˆ·æ€çº¿ç¨‹å³å®Œæˆåˆ‡æ¢ï¼Œä¸ä¼šé™·å…¥åˆ°å†…æ ¸æ€ï¼Œè¿™ç§åˆ‡æ¢éå¸¸çš„è½»é‡å¿«é€Ÿï¼› ç¼ºç‚¹ï¼š1ä¸ªè¿›ç¨‹çš„æ‰€æœ‰åç¨‹éƒ½ç»‘å®šåœ¨1ä¸ªçº¿ç¨‹ä¸Šï¼ŒæŸäº›ç¨‹åºç”¨ä¸äº†ç¡¬ä»¶çš„å¤šæ ¸åŠ é€Ÿèƒ½åŠ›ï¼Œä¸€æ—¦æŸåç¨‹é˜»å¡ï¼Œé€ æˆçº¿ç¨‹é˜»å¡ï¼Œæœ¬è¿›ç¨‹çš„å…¶ä»–åç¨‹éƒ½æ— æ³•æ‰§è¡Œäº†ï¼Œé™çº§ä¸ºå•çº¿ç¨‹æ¨¡å‹ï¼› æ€è€ƒï¼šæˆ‘ä»¬å¯å¦è®©ä¸€ä¸ªç”¨æˆ·ç¨‹åºçš„å¤šä¸ªåç¨‹ï¼Œé€šè¿‡åç¨‹è°ƒåº¦å™¨ï¼ŒåŒæ—¶ç»‘å®šåˆ°å¤šä¸ªå†…æ ¸çº¿ç¨‹ä¸Šå‘¢ï¼Ÿ äºæ˜¯ï¼Œå°±æœ‰äº†æˆ‘ä»¬æœ€ç»ˆçš„ çº¿ç¨‹:åç¨‹ = M:N æ¨¡å‹ï¼š æ­¤ M:N æ¨¡å‹å…‹æœäº†ä»¥ä¸Š 1:1ï¼Œ1:N ä¸¤ç§æ¨¡å‹çš„ç¼ºç‚¹ï¼Œä½†æ˜¯å®ç°ä¹Ÿå˜å¾—æ›´åŠ çš„å¤æ‚ï¼Œå‹åŠ›ç»™åˆ°â€œåç¨‹è°ƒåº¦å™¨â€ï¼ 4ã€Golangä¸­çš„åç¨‹Goroutineï¼š Goä¸­ï¼Œåç¨‹è¢«ç§°ä¸ºgoroutineï¼Œå®ƒéå¸¸è½»é‡ï¼Œä¸€ä¸ªgoroutineåªå å¤§æ¦‚4KBï¼Œå¹¶ä¸”è¿™4KBå°±è¶³å¤Ÿgoroutineè¿è¡Œå®Œï¼Œè¿™å°±èƒ½åœ¨æœ‰é™çš„å†…å­˜ç©ºé—´å†…æ”¯æŒå¤§é‡goroutineï¼Œæ”¯æŒäº†æ›´å¤šçš„å¹¶å‘ã€‚ è™½ç„¶ä¸€ä¸ªgoroutineçš„æ ˆåªå å‡ KBï¼Œä½†å®é™…æ˜¯å¯ä¼¸ç¼©çš„ï¼Œå¦‚æœéœ€è¦æ›´å¤šå†…å®¹ï¼Œruntimeä¼šè‡ªåŠ¨ä¸ºgoroutineåˆ†é…ã€‚ Goroutineç‰¹ç‚¹ï¼š å ç”¨å†…å­˜æ›´å°ï¼ˆå¤§æ¦‚4kbï¼‰ï¼› è°ƒåº¦æ›´çµæ´»(runtimeè°ƒåº¦)ï¼› äºŒã€Goroutineåç¨‹è°ƒåº¦å™¨ Golangç§å‡ºç°è¿‡2ç§åç¨‹è°ƒåº¦å™¨æ¨¡å‹ï¼ŒGM å’Œ GMPï¼› åœ¨12å¹´çš„go1.1ç‰ˆæœ¬ä¹‹å‰ç”¨çš„éƒ½æ˜¯GMæ¨¡å‹ï¼Œä½†æ˜¯ç”±äºGMæ¨¡å‹æ€§èƒ½ä¸å¥½ï¼Œé¥±å—ç”¨æˆ·è¯Ÿç—…ã€‚ä¹‹åå®˜æ–¹å¯¹è°ƒåº¦å™¨è¿›è¡Œäº†æ”¹è¿›ï¼Œå˜æˆäº†æˆ‘ä»¬ç°åœ¨ç”¨çš„GMPæ¨¡å‹ï¼› ç½‘ä¸Šå…³äºGM å’ŒGMPçš„å¯¹æ¯”ä»‹ç»æ–‡ç« ä¹Ÿå¾ˆå¤šï¼Œéšä¾¿è´´ä¸€ä¸ªï¼šGMåˆ°GMPï¼ŒGolangç»å†äº†ä»€ä¹ˆï¼Ÿ 1ã€ç®€å•å¿«é€Ÿåœ°è®¤è¯†ä¸‹ GM æ¨¡å‹ï¼š GMæ¨¡å‹ä¸­çš„Gå…¨ç§°ä¸ºGoroutineåç¨‹ï¼ŒMå…¨ç§°ä¸ºMachineå†…æ ¸çº§çº¿ç¨‹ï¼ æ ¹æ®ä¸Šå›¾ã€‚æˆ‘ä»¬å¾ˆå®¹æ˜“çŸ¥é“ï¼ŒMçº¿ç¨‹ æƒ³è¦ æ‰§è¡Œ/æ”¾å› G éƒ½å¿…é¡»è®¿é—® å…¨å±€Gé˜Ÿåˆ— ï¼Œå¹¶ä¸”Mæœ‰å¤šä¸ªï¼Œè€Œæˆ‘ä»¬çŸ¥é“ï¼Œä¸ºäº†ç¡®ä¿å®‰å…¨ï¼Œå¤šçº¿ç¨‹è®¿é—®åŒä¸€èµ„æºæ—¶éœ€è¦åŠ é”ï¼Œæ‰€ä»¥å…¨å±€Gé˜Ÿåˆ—æ˜¯æœ‰äº’æ–¥é”è¿›è¡Œä¿æŠ¤çš„ã€‚ æ˜¾ç„¶ï¼Œè¿™ç§æ¨¡å‹æœ‰å¾ˆä¸¥é‡çš„ç¼ºç‚¹ï¼š æ¿€çƒˆçš„é”ç«äº‰ï¼šçº¿ç¨‹Måœ¨ åˆ›å»ºã€é”€æ¯ã€è°ƒåº¦Géƒ½éœ€è¦å…ˆè·å–é”ï¼› å¾ˆå·®çš„ç¨‹åºå±€éƒ¨æ€§ï¼šæ¯”å¦‚å½“Gä¸­åŒ…å«åˆ›å»ºæ–°åç¨‹çš„æ—¶å€™ï¼Œæ¯”å¦‚æ–°åç¨‹å«G'ï¼Œä¸ºäº†ç»§ç»­æ‰§è¡ŒGï¼Œå°±éœ€è¦å°†G'äº¤ç»™å¦ä¸€ä¸ªçº¿ç¨‹M' æ‰§è¡Œï¼Œè¿™å°±é€ æˆäº†å¾ˆå·®çš„ç¨‹åºå±€éƒ¨æ€§ï¼Œå› ä¸ºG'å’ŒGæ˜¯ç›¸å…³çš„ï¼Œæœ€å¥½æ”¾åœ¨Mä¸Šæ‰§è¡Œï¼Œè€Œä¸æ˜¯å…¶ä»–M'ï¼› ç³»ç»Ÿè°ƒç”¨çº¿ç¨‹åˆ‡æ¢å¼€é”€å¤§ï¼šCPUåœ¨Mä¹‹é—´çš„åˆ‡æ¢ï¼Œå¯¼è‡´é¢‘ç¹çš„çº¿ç¨‹é˜»å¡å’Œå–æ¶ˆé˜»å¡æ“ä½œå¢åŠ äº†ç³»ç»Ÿå¼€é”€ï¼ˆæˆ‘ä»¬çŸ¥é“çº¿ç¨‹åˆ‡æ¢æ˜¯éœ€è¦ç”¨æˆ·æ€/å†…æ ¸æ€è½¬æ¢çš„ï¼Œå¼€é”€æ˜¯å¾ˆå¤§çš„ï¼‰ï¼› 2ã€é‡ç‚¹å­¦ä¹ ä¸‹ GMP æ¨¡å‹ï¼š Gå…¨ç§°ä¸ºGoroutineåç¨‹ï¼ŒMå…¨ç§°ä¸ºMachineå†…æ ¸çº§çº¿ç¨‹ï¼ŒPå…¨ç§°ä¸ºProcessoråç¨‹è¿è¡Œæ‰€éœ€çš„èµ„æºï¼ ä»–åœ¨GMæ¨¡å‹çš„åŸºç¡€ä¸Šå¢åŠ äº†ä¸€ä¸ªPå±‚ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä»–æ˜¯å¦‚ä½•è®¾è®¡çš„ï¼š Måˆ—è¡¨ï¼šgoç¨‹åºå¯åŠ¨æ—¶ï¼Œä¼šè®¾ç½®Mçš„æœ€å¤§æ•°é‡ï¼Œé»˜è®¤10000ã€‚ä½†æ˜¯å†…æ ¸å¾ˆéš¾åˆ›å»ºå‡ºå¦‚æ­¤å¤šçš„çº¿ç¨‹ï¼Œå› æ­¤é»˜è®¤æƒ…å†µä¸‹Mçš„æœ€å¤§æ•°é‡å–å†³äºå†…æ ¸ã€‚ä¹Ÿå¯ä»¥è°ƒç”¨runtime/debugä¸­çš„SetMaxThreadså‡½æ•°ï¼Œæ‰‹åŠ¨è®¾ç½®Mçš„æœ€å¤§æ•°é‡ï¼› Påˆ—è¡¨ï¼šæ‰€æœ‰çš„Péƒ½åœ¨ç¨‹åºå¯åŠ¨æ—¶åˆ›å»ºï¼Œå¹¶ä¿å­˜åœ¨æ•°ç»„ä¸­ï¼Œæœ€å¤šæœ‰GOMAXPROCS(å¯é…ç½®)ä¸ª Pçš„æœ¬åœ°é˜Ÿåˆ—ï¼šPå†…ç½®çš„Gé˜Ÿåˆ—ï¼Œå­˜çš„æ•°é‡æœ‰é™ï¼Œä¸è¶…è¿‡256ä¸ªï¼› å…¨å±€é˜Ÿåˆ—ï¼šå½“Pä¸­çš„æœ¬åœ°é˜Ÿåˆ—ä¸­æœ‰åç¨‹Gæº¢å‡ºæ—¶ï¼Œä¼šè¢«æ”¾åˆ°å…¨å±€é˜Ÿåˆ—ä¸­ï¼› çº¿ç¨‹Mæƒ³è¦è¿è¡Œåç¨‹Gï¼Œéƒ½æ˜¯æ‰¾Pç´¢è¦ï¼Œä¸€ä¸ªPä¸€æ¬¡åªèƒ½æä¾›ä¸€ä¸ªGåç¨‹ä»»åŠ¡ï¼›æ•´ä¸ªç¨‹åºæœ€ç»ˆçš„åç¨‹å¹¶è¡Œåº¦ï¼Œå…¶å®å°±æ˜¯Pçš„æ•°é‡ï¼Œå³GOMAXPROCSè®¾ç½®çš„å€¼ï¼ æœ¬åœ°é˜Ÿåˆ—ä¼˜å…ˆï¼šå½“é˜Ÿåˆ—P1ä¸­çš„G1åœ¨è¿è¡Œè¿‡ç¨‹ä¸­æ–°å»ºG2æ—¶ï¼ŒG2ä¼˜å…ˆå­˜æ”¾åˆ°P1çš„æœ¬åœ°é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™ä¼šæŠŠP1é˜Ÿåˆ—ä¸­ä¸€åŠçš„Gç§»åŠ¨åˆ°å…¨å±€é˜Ÿåˆ—ä¸­ï¼› å·¥ä½œçªƒå–æœºåˆ¶ï¼šå¦‚æœPçš„æœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºï¼Œé‚£ä¹ˆä»–ä¼šå…ˆåˆ°å…¨å±€é˜Ÿåˆ—ä¸­è·å–Gï¼Œå¦‚æœå…¨å±€é˜Ÿåˆ—ä¸­ä¹Ÿæ²¡æœ‰Gï¼Œåˆ™ä¼šå°è¯•ä»å…¶ä»–çº¿ç¨‹ç»‘å®šçš„Pä¸­å·å–ä¸€åŠçš„Gï¼› Mé€šè¿‡Pè·å¾—Gçš„ä¼˜å…ˆçº§é¡ºåºï¼šæœ¬åœ°é˜Ÿåˆ—ï¼ˆæ— é”ï¼‰-&gt;å…¨å±€é˜Ÿåˆ—ï¼ˆé”ï¼‰-&gt;netpolläº‹ä»¶-&gt;å»å…¶ä»–é˜Ÿåˆ—é‡Œå·ï¼ˆCASï¼Œæ— é”ï¼‰ 3ã€GMPè°ƒåº¦å™¨çš„è®¾è®¡ç­–ç•¥è¯¦è§£ï¼š å¤ç”¨çº¿ç¨‹ï¼š work stealingæœºåˆ¶ï¼šå·¥ä½œçªƒå–æœºåˆ¶ï¼Œä¸Šé¢å·²ç»è®²è§£äº†ï¼› hand offæœºåˆ¶ï¼šåˆ†æ‰‹æœºåˆ¶ï¼Œå½“æœ¬çº¿ç¨‹å› ä¸ºGè¿›è¡Œç³»ç»Ÿè°ƒç”¨é˜»å¡æ—¶ï¼Œå¦‚è¯»å†™ç£ç›˜ï¼Œçº¿ç¨‹é‡Šæ”¾ç»‘å®šçš„Pï¼ŒæŠŠPè½¬ç§»ç»™å…¶ä»–ç©ºé—²çš„çº¿ç¨‹æ‰§è¡Œï¼› åˆ©ç”¨å¹¶è¡Œï¼š å¯ä»¥é€šè¿‡é…ç½®GOMAXPROCSé™å®šPçš„ä¸ªæ•° æŠ¢å ï¼š ç°åœ¨çš„è°ƒåº¦å™¨å‡ ä¹éƒ½æ˜¯æŠ¢å å¼çš„ï¼ŒéæŠ¢å å¼çš„ å…¨å±€Gé˜Ÿåˆ—ï¼š ç›¸å½“äºæ˜¯å¯¹work stealingæœºåˆ¶çš„ä¸€ä¸ªè¡¥å……ï¼Œå½“æœ¬åœ°é˜Ÿåˆ—æ»¡äº†åï¼Œå°±å°†æº¢å‡ºçš„Gæ”¾åˆ°å…¨å±€é˜Ÿåˆ—ä¸­ï¼ å› ä¸ºå…¨å±€é˜Ÿåˆ—æ˜¯å…±äº«çš„ï¼Œæ‰€ä»¥ æ”¾/å– éƒ½æ˜¯è¦åŠ é”çš„ï¼Œæ€§èƒ½ç›¸å½“äºPçš„æœ¬åœ°é˜Ÿåˆ—æ›´æ…¢ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆâ€œæœ¬åœ°é˜Ÿåˆ—ä¼˜å…ˆâ€ï¼ 4ã€é€šè¿‡go func() å¯åŠ¨ä¸€ä¸ªgoroutineçš„è¿‡ç¨‹è¯¦è§£ï¼š åœ¨Golangä¸­æƒ³åˆ›å»ºä¸€ä¸ªgoroutineåç¨‹éå¸¸å®¹æ˜“ï¼Œåªéœ€è¦åœ¨ func() æ–¹æ³•è°ƒç”¨å‰ï¼ŒåŠ ä¸Š go å…³é”®å­—å³å¯ï¼› æ–°åˆ›å»ºçš„goroutineä¼šä¼˜å…ˆä¿å­˜åœ¨Pçš„æœ¬åœ°é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœæœ¬åœ°é˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™ä¼šæ”¾åœ¨å…¨å±€é˜Ÿåˆ—ä¸­ï¼› G(goroutine)åªèƒ½è¿è¡Œåœ¨M(Machine)ä¸­ï¼ŒM:P = 1:1ï¼Œå½“Méœ€è¦è¿è¡ŒGæ—¶ï¼Œä¸ä¼šè‡ªå·±å»å–ï¼Œè€Œæ˜¯æ‰¾P(Processor)è¦ï¼› Pè·å–Gçš„ä¼˜å…ˆçº§æ˜¯ï¼šæœ¬åœ°é˜Ÿåˆ— â€”&gt; å…¨å±€é˜Ÿåˆ— â€”&gt; å…¶ä»–Pçš„æœ¬åœ°é˜Ÿåˆ—çªƒå–ï¼› Mæ‰§è¡ŒGçš„è¿‡ç¨‹æ˜¯ä¸€ä¸ªæ— é™å¾ªç¯ï¼› å¦‚æœMåœ¨æ‰§è¡ŒGçš„è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°äº†é˜»å¡æ“ä½œï¼Œåˆ™ä¼šè§¦å‘â€œhand offæœºåˆ¶â€ï¼Œè®©Pä¸å½“å‰Måˆ†æ‰‹ï¼Œæ–°å»ºæˆ–ä»ä¼‘çœ Mé˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªMçº¿ç¨‹ï¼Œå°†åˆšåˆšçš„Pä¸æ–°å¾—åˆ°çš„Mçº¿ç¨‹è¿›è¡Œç»‘å®šï¼Œç»§ç»­åç»­Gçš„å¤„ç†å·¥ä½œï¼ å½“åˆšåˆšç”±äºé˜»å¡æ“ä½œï¼Œä¸Påˆ†æ‰‹çš„Må®Œæˆé˜»å¡æ“ä½œåï¼Œç”±äºåˆšåˆšçš„Gè¿˜æ²¡æœ‰è¢«å®Œå…¨æ‰§è¡Œå®Œæˆï¼Œæ‰€ä»¥å®ƒä¼šå»æ‰¾ä¸€ä¸ªç©ºé—²çš„Pï¼Œå°†è¿™ä¸ªGæ”¾åˆ°ç©ºé—²Pçš„æœ¬åœ°é˜Ÿåˆ—ä¸­ï¼›å¦‚æœè·å–ä¸åˆ°ç©ºé—²Pï¼Œé‚£ä¹ˆMçº¿ç¨‹å°†å˜æˆä¼‘çœ çŠ¶æ€ï¼Œæ·»åŠ åˆ°ä¼‘çœ Mé˜Ÿåˆ—ä¸­ï¼ŒåŒæ—¶å°†Gæ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­ï¼ 5ã€P å’Œ M çš„æ•°é‡é—®é¢˜ï¼Ÿ Pçš„æ•°é‡ï¼šç”±å¯åŠ¨æ—¶ç¯å¢ƒå˜é‡$GOMAXPROCSæˆ–è€…æ˜¯ç”±runtimeçš„æ–¹æ³•GOMAXPROCS()å†³å®šï¼Œè¿™æ„å‘³ç€åœ¨ç¨‹åºæ‰§è¡Œçš„ä»»æ„æ—¶åˆ»éƒ½åªæœ‰$GOMAXPROCSä¸ªgoroutineåœ¨åŒæ—¶è¿è¡Œï¼› Mçš„æ•°é‡ï¼š goè¯­è¨€æœ¬èº«çš„é™åˆ¶ï¼Œgoç¨‹åºå¯åŠ¨æ—¶ï¼Œä¼šè®¾ç½®Mçš„æœ€å¤§æ•°é‡ï¼Œé»˜è®¤10000ï¼Œä½†æ˜¯å†…æ ¸å¾ˆéš¾æ”¯æŒè¿™ä¹ˆå¤šçš„çº¿ç¨‹æ•°ï¼Œæ‰€ä»¥è¿™ä¸ªé™åˆ¶å¯ä»¥å¿½ç•¥ï¼› è°ƒç”¨runtime/debugä¸­çš„SetMaxThreads()ï¼Œè®¾ç½®Mçš„æœ€å¤§æ•°é‡ï¼› ä¸€ä¸ªMé˜»å¡äº†ï¼Œä¼šåˆ›å»ºæ–°çš„Mï¼› 6ã€P å’Œ M ä½•æ—¶è¢«åˆ›å»ºï¼Ÿ Pä½•æ—¶è¢«åˆ›å»ºï¼ˆé¥¿æ±‰ï¼‰ï¼šåœ¨ç¡®å®šäº†Pçš„æœ€å¤§æ•°é‡nåï¼Œè¿è¡Œæ—¶ç³»ç»Ÿä¼šæ ¹æ®è¿™ä¸ªæ•°é‡åˆ›å»ºnä¸ªP â€”â€” ç¨‹åºå¯åŠ¨æ—¶ï¼Œå³åˆ›å»ºå¥½ Mä½•æ—¶è¢«åˆ›å»ºï¼ˆæ‡’æ±‰ï¼‰ï¼šæ²¡æœ‰è¶³å¤Ÿçš„Mæ¥å…³è”På¹¶è¿è¡Œå…¶ä¸­çš„å¯è¿è¡Œçš„Gï¼›æ¯”å¦‚æ‰€æœ‰çš„Mæ­¤æ—¶éƒ½é˜»å¡ä½äº†ï¼Œè€ŒPä¸­è¿˜æœ‰å¾ˆå¤šå°±ç»ªä»»åŠ¡ï¼Œå°±ä¼šå»å¯»æ‰¾ç©ºé—²çš„Mï¼Œè€Œæ²¡æœ‰ç©ºé—²çš„ï¼Œå°±ä¼šå»åˆ›å»ºæ–°çš„Mã€‚ ","link":"https://tianxiawuhao.github.io/QplCLDgXh/"},{"title":"ä½¿ç”¨java å®ç°mqttä¸¤ç§æ–¹å¼","content":"åœ¨å¼€å‘MQTTæ—¶æœ‰ä¸¤ç§æ–¹å¼ä¸€ç§æ˜¯ä½¿ç”¨Paho Java åŸç”Ÿåº“æ¥å®Œæˆï¼Œä¸€ç§æ˜¯ä½¿ç”¨spring boot æ¥å®Œæˆã€‚ Paho Java åº“å®ç° Eclipse Paho Java Client (opens new window)æ˜¯ç”¨ Java ç¼–å†™çš„ MQTT å®¢æˆ·ç«¯åº“ï¼ˆMQTT Java Clientï¼‰ï¼Œå¯ç”¨äº JVM æˆ–å…¶ä»– Java å…¼å®¹å¹³å°ï¼ˆä¾‹å¦‚Androidï¼‰ã€‚ Eclipse Paho Java Client æä¾›äº†MqttAsyncClient å’Œ MqttClient å¼‚æ­¥å’ŒåŒæ­¥ API é€šè¿‡ Maven å®‰è£… Paho Java &lt;dependency&gt; &lt;groupId&gt;org.eclipse.paho&lt;/groupId&gt; &lt;artifactId&gt;org.eclipse.paho.client.mqttv3&lt;/artifactId&gt; &lt;version&gt;1.2.2&lt;/version&gt; &lt;/dependency&gt; Paho Java ä½¿ç”¨ç¤ºä¾‹ Java ä½“ç³»ä¸­ Paho Java æ˜¯æ¯”è¾ƒç¨³å®šã€å¹¿æ³›åº”ç”¨çš„ MQTT å®¢æˆ·ç«¯åº“ï¼Œæœ¬ç¤ºä¾‹åŒ…å« Java è¯­è¨€çš„ Paho Java è¿æ¥ EMQX Brokerï¼Œå¹¶è¿›è¡Œæ¶ˆæ¯æ”¶å‘å®Œæ•´ä»£ç ï¼š package io.emqx; import org.eclipse.paho.client.mqttv3.MqttClient; import org.eclipse.paho.client.mqttv3.MqttConnectOptions; import org.eclipse.paho.client.mqttv3.MqttException; import org.eclipse.paho.client.mqttv3.MqttMessage; import org.eclipse.paho.client.mqttv3.persist.MemoryPersistence; public class App { public static void main(String[] args) { String subTopic = &quot;testtopic/#&quot;; String pubTopic = &quot;testtopic/1&quot;; String content = &quot;Hello World&quot;; int qos = 2; String broker = &quot;tcp://broker.emqx.io:1883&quot;; String clientId = &quot;emqx_test&quot;; MemoryPersistence persistence = new MemoryPersistence(); try { MqttClient client = new MqttClient(broker, clientId, persistence); // MQTT è¿æ¥é€‰é¡¹ MqttConnectOptions connOpts = new MqttConnectOptions(); connOpts.setUserName(&quot;emqx_test&quot;); connOpts.setPassword(&quot;emqx_test_password&quot;.toCharArray()); // ä¿ç•™ä¼šè¯ connOpts.setCleanSession(true); // è®¾ç½®å›è°ƒ client.setCallback(new PushCallback()); // å»ºç«‹è¿æ¥ System.out.println(&quot;Connecting to broker: &quot; + broker); client.connect(connOpts); System.out.println(&quot;Connected&quot;); System.out.println(&quot;Publishing message: &quot; + content); // è®¢é˜… client.subscribe(subTopic); // æ¶ˆæ¯å‘å¸ƒæ‰€éœ€å‚æ•° MqttMessage message = new MqttMessage(content.getBytes()); message.setQos(qos); client.publish(pubTopic, message); System.out.println(&quot;Message published&quot;); client.disconnect(); System.out.println(&quot;Disconnected&quot;); client.close(); System.exit(0); } catch (MqttException me) { System.out.println(&quot;reason &quot; + me.getReasonCode()); System.out.println(&quot;msg &quot; + me.getMessage()); System.out.println(&quot;loc &quot; + me.getLocalizedMessage()); System.out.println(&quot;cause &quot; + me.getCause()); System.out.println(&quot;excep &quot; + me); me.printStackTrace(); } } } å›è°ƒæ¶ˆæ¯å¤„ç†ç±» OnMessageCallback.java package io.emqx; import org.eclipse.paho.client.mqttv3.IMqttDeliveryToken; import org.eclipse.paho.client.mqttv3.MqttCallback; import org.eclipse.paho.client.mqttv3.MqttMessage; public class OnMessageCallback implements MqttCallback { public void connectionLost(Throwable cause) { // è¿æ¥ä¸¢å¤±åï¼Œä¸€èˆ¬åœ¨è¿™é‡Œé¢è¿›è¡Œé‡è¿ System.out.println(&quot;è¿æ¥æ–­å¼€ï¼Œå¯ä»¥åšé‡è¿&quot;); } public void messageArrived(String topic, MqttMessage message) throws Exception { // subscribeåå¾—åˆ°çš„æ¶ˆæ¯ä¼šæ‰§è¡Œåˆ°è¿™é‡Œé¢ System.out.println(&quot;æ¥æ”¶æ¶ˆæ¯ä¸»é¢˜:&quot; + topic); System.out.println(&quot;æ¥æ”¶æ¶ˆæ¯Qos:&quot; + message.getQos()); System.out.println(&quot;æ¥æ”¶æ¶ˆæ¯å†…å®¹:&quot; + new String(message.getPayload())); } public void deliveryComplete(IMqttDeliveryToken token) { System.out.println(&quot;deliveryComplete---------&quot; + token.isComplete()); } } å¥½çš„ä¸Šè¿°å°±å®ç°äº†ç®€å•çš„ MQTTçš„è¿æ¥å’Œæ¶ˆæ¯æ”¶å‘ã€‚ spring booté›†æˆmqtt spring boot ç¯å¢ƒ spring-boot ç‰ˆæœ¬ 2.2.2 spring-integrationçš„ç‰ˆæœ¬ä¸ºï¼š5.4.3 Spring Integrationæä¾›äº†å…¥ç«™é€‚é…å™¨å’Œå‡ºç«™é€‚é…å™¨ä»¥æ”¯æŒMQTTåè®®ã€‚ Maven ä¾èµ–: &lt;!-- https://mvnrepository.com/artifact/org.springframework.integration/spring-integration-mqtt --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-integration&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.integration&lt;/groupId&gt; &lt;artifactId&gt;spring-integration-mqtt&lt;/artifactId&gt; &lt;version&gt;5.4.3&lt;/version&gt; &lt;/dependency&gt; é…ç½®æ–‡ä»¶ application.ymlï¼š spring: mqtt: username: password: url: tcp://ip:port clientId: clientId topic: default completionTimeout: 2000 æ ¸å¿ƒä»£ç  é…ç½®ç±» @Data @Configuration @ConfigurationProperties(prefix = &quot;spring.mqtt&quot;) public class MqttConfiguration { private String username; private String password; private String url; private String clientId; private String topic = &quot;TOPIC_DEFAULT&quot;; private Integer completionTimeout = 2000; /** * æ³¨å†ŒMQTTå®¢æˆ·ç«¯å·¥å‚ * @return */ @Bean public MqttPahoClientFactory mqttClientFactory(){ DefaultMqttPahoClientFactory factory = new DefaultMqttPahoClientFactory(); MqttConnectOptions options = new MqttConnectOptions(); //å¦‚æœè®¾ç½®ä¸º falseï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å°†åœ¨å®¢æˆ·ç«¯ã€æœåŠ¡å™¨å’Œè¿æ¥é‡æ–°å¯åŠ¨æ—¶ä¿æŒçŠ¶æ€ã€‚éšç€çŠ¶æ€çš„ä¿æŒï¼š // å³ä½¿å®¢æˆ·ç«¯ã€æœåŠ¡å™¨æˆ–è¿æ¥é‡æ–°å¯åŠ¨ï¼Œæ¶ˆæ¯ä¼ é€’ä¹Ÿå°†å¯é åœ°æ»¡è¶³æŒ‡å®šçš„ QOSã€‚æœåŠ¡å™¨å°†è®¢é˜…è§†ä¸ºæŒä¹…çš„ã€‚ // å¦‚æœè®¾ç½®ä¸º trueï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å°†ä¸ä¼šåœ¨å®¢æˆ·ç«¯ã€æœåŠ¡å™¨æˆ–è¿æ¥é‡æ–°å¯åŠ¨æ—¶ä¿æŒçŠ¶æ€ã€‚ options.setCleanSession(true); //è¯¥å€¼ä»¥ç§’ä¸ºå•ä½ï¼Œå¿…é¡»&gt;0ï¼Œå®šä¹‰äº†å®¢æˆ·ç«¯ç­‰å¾…ä¸ MQTT æœåŠ¡å™¨å»ºç«‹ç½‘ç»œè¿æ¥çš„æœ€å¤§æ—¶é—´é—´éš”ã€‚ // é»˜è®¤è¶…æ—¶ä¸º 30 ç§’ã€‚å€¼ 0 ç¦ç”¨è¶…æ—¶å¤„ç†ï¼Œè¿™æ„å‘³ç€å®¢æˆ·ç«¯å°†ç­‰å¾…ç›´åˆ°ç½‘ç»œè¿æ¥æˆåŠŸæˆ–å¤±è´¥ã€‚ options.setConnectionTimeout(0); //æ­¤å€¼ä»¥ç§’ä¸ºå•ä½ï¼Œå®šä¹‰å‘é€æˆ–æ¥æ”¶æ¶ˆæ¯ä¹‹é—´çš„æœ€å¤§æ—¶é—´é—´éš”ï¼Œå¿…é¡»&gt;0 options.setKeepAliveInterval(90); //è‡ªåŠ¨é‡æ–°è¿æ¥ options.setAutomaticReconnect(true); options.setUserName(this.getUsername()); options.setPassword(this.getPassword().toCharArray()); options.setServerURIs(new String[]{this.getUrl()}); factory.setConnectionOptions(options); return factory; } } @Slf4j @AllArgsConstructor @Configuration @IntegrationComponentScan public class MqttInboundConfiguration { private MqttConfiguration mqttConfig; private MqttPahoClientFactory factory; private MqttMessageReceiver mqttMessageReceiver; /** * æ­¤å¤„å¯ä»¥ä½¿ç”¨å…¶ä»–æ¶ˆæ¯é€šé“ * Spring Integrationé»˜è®¤çš„æ¶ˆæ¯é€šé“ï¼Œå®ƒå…è®¸å°†æ¶ˆæ¯å‘é€ç»™ä¸€ä¸ªè®¢é˜…è€…ï¼Œç„¶åé˜»ç¢å‘é€ç›´åˆ°æ¶ˆæ¯è¢«æ¥æ”¶ã€‚ * * @return */ @Bean public MessageChannel mqttInBoundChannel() { return new DirectChannel(); } /** * é€‚é…å™¨, ä¸¤ä¸ªtopicå…±ç”¨ä¸€ä¸ªadapter * å®¢æˆ·ç«¯ä½œä¸ºæ¶ˆè´¹è€…ï¼Œè®¢é˜…ä¸»é¢˜ï¼Œæ¶ˆè´¹æ¶ˆæ¯ * * @param * @param * @return */ @Bean public MessageProducerSupport mqttInbound() { MqttPahoMessageDrivenChannelAdapter adapter = new MqttPahoMessageDrivenChannelAdapter(mqttConfig.getClientId()+&quot;-&quot;+System.currentTimeMillis(), factory, mqttConfig.getTopic()); adapter.setCompletionTimeout(60000); adapter.setConverter(new DefaultPahoMessageConverter()); adapter.setRecoveryInterval(10000); adapter.setQos(0); adapter.setOutputChannel(mqttInBoundChannel()); return adapter; } /** * mqttå…¥ç«™æ¶ˆæ¯å¤„ç†å·¥å…·ï¼Œå¯¹äºæŒ‡å®šæ¶ˆæ¯å…¥ç«™é€šé“æ¥æ”¶åˆ°ç”Ÿäº§è€…ç”Ÿäº§çš„æ¶ˆæ¯åå¤„ç†æ¶ˆæ¯çš„å·¥å…·ã€‚ * * @return */ @Bean @ServiceActivator(inputChannel = &quot;mqttInBoundChannel&quot;) public MessageHandler mqttMessageHandler() { return this.mqttMessageReceiver; } } æ•°æ®æ¥æ”¶ @Slf4j @AllArgsConstructor @Component public class MqttMessageReceiver implements MessageHandler { @Override public void handleMessage(Message&lt;?&gt; message) throws MessagingException { try { MessageHeaders headers = message.getHeaders(); //è·å–æ¶ˆæ¯Topic String receivedTopic = (String) headers.get(MqttHeaders.RECEIVED_TOPIC); log.info(&quot;[è·å–åˆ°çš„æ¶ˆæ¯çš„topic :]{} &quot;, receivedTopic); //è·å–æ¶ˆæ¯ä½“ String payload = (String) message.getPayload(); log.info(&quot;[è·å–åˆ°çš„æ¶ˆæ¯çš„payload :]{} &quot;, payload); //todo .... } catch (Exception e) { e.printStackTrace(); } } } @Slf4j @AllArgsConstructor @Configuration public class MqttOutboundConfiguration { private MqttConfiguration mqttConfig; private MqttPahoClientFactory factory; @Bean public MessageChannel mqttOutboundChannel() { return new DirectChannel(); } @Bean @ServiceActivator(inputChannel = &quot;mqttOutboundChannel&quot;) public MessageHandler mqttOutbound() { MqttPahoMessageHandler messageHandler = new MqttPahoMessageHandler( mqttConfig.getClientId()+&quot;-&quot;+System.currentTimeMillis() + System.currentTimeMillis(), factory); messageHandler.setDefaultQos(0); //å¼€å¯å¼‚æ­¥ messageHandler.setAsync(true); messageHandler.setDefaultTopic(mqttConfig.getTopic()); return messageHandler; } } å‘é€è€… @Component @MessagingGateway(defaultRequestChannel = &quot;mqttOutboundChannel&quot;) public interface MqttGateway { /** * å‘é€mqttæ¶ˆæ¯ * @param topic ä¸»é¢˜ * @param payload å†…å®¹ * @return void */ void sendToMqtt(@Header(MqttHeaders.TOPIC) String topic, String payload); /** * å‘é€åŒ…å«qosçš„æ¶ˆæ¯ * @param topic ä¸»é¢˜ * @param qos å¯¹æ¶ˆæ¯å¤„ç†çš„å‡ ç§æœºåˆ¶ã€‚ * * 0 è¡¨ç¤ºçš„æ˜¯è®¢é˜…è€…æ²¡æ”¶åˆ°æ¶ˆæ¯ä¸ä¼šå†æ¬¡å‘é€ï¼Œæ¶ˆæ¯ä¼šä¸¢å¤±ã€‚&lt;br&gt; * * 1 è¡¨ç¤ºçš„æ˜¯ä¼šå°è¯•é‡è¯•ï¼Œä¸€ç›´åˆ°æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œä½†è¿™ç§æƒ…å†µå¯èƒ½å¯¼è‡´è®¢é˜…è€…æ”¶åˆ°å¤šæ¬¡é‡å¤æ¶ˆæ¯ã€‚&lt;br&gt; * * 2 å¤šäº†ä¸€æ¬¡å»é‡çš„åŠ¨ä½œï¼Œç¡®ä¿è®¢é˜…è€…æ”¶åˆ°çš„æ¶ˆæ¯æœ‰ä¸€æ¬¡ã€‚ * @param payload æ¶ˆæ¯ä½“ * @return void */ void sendToMqtt(@Header(MqttHeaders.TOPIC) String topic, @Header(MqttHeaders.QOS) int qos, String payload); /** * å‘é€åŒ…å«qosçš„æ¶ˆæ¯ * @param topic ä¸»é¢˜ * @param qos å¯¹æ¶ˆæ¯å¤„ç†çš„å‡ ç§æœºåˆ¶ã€‚ * * 0 è¡¨ç¤ºçš„æ˜¯è®¢é˜…è€…æ²¡æ”¶åˆ°æ¶ˆæ¯ä¸ä¼šå†æ¬¡å‘é€ï¼Œæ¶ˆæ¯ä¼šä¸¢å¤±ã€‚&lt;br&gt; * * 1 è¡¨ç¤ºçš„æ˜¯ä¼šå°è¯•é‡è¯•ï¼Œä¸€ç›´åˆ°æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œä½†è¿™ç§æƒ…å†µå¯èƒ½å¯¼è‡´è®¢é˜…è€…æ”¶åˆ°å¤šæ¬¡é‡å¤æ¶ˆæ¯ã€‚&lt;br&gt; * * 2 å¤šäº†ä¸€æ¬¡å»é‡çš„åŠ¨ä½œï¼Œç¡®ä¿è®¢é˜…è€…æ”¶åˆ°çš„æ¶ˆæ¯æœ‰ä¸€æ¬¡ã€‚ * @param payload æ¶ˆæ¯ä½“ * @return void */ void sendToMqtt(@Header(MqttHeaders.TOPIC) String topic, @Header(MqttHeaders.QOS) int qos, byte[] payload); } @Component @AllArgsConstructor public class MqttMessageSender { private MqttGateway mqttGateway; /** * å‘é€mqttæ¶ˆæ¯ * @param topic ä¸»é¢˜ * @param message å†…å®¹ * @return void */ public void send(String topic, String message) { mqttGateway.sendToMqtt(topic, message); } /** * å‘é€åŒ…å«qosçš„æ¶ˆæ¯ * @param topic ä¸»é¢˜ * @param qos è´¨é‡ * @param messageBody æ¶ˆæ¯ä½“ * @return void */ public void send(String topic, int qos, JSONObject messageBody){ mqttGateway.sendToMqtt(topic, qos, messageBody.toString()); } /** * å‘é€åŒ…å«qosçš„æ¶ˆæ¯ * @param topic ä¸»é¢˜ * @param qos è´¨é‡ * @param message æ¶ˆæ¯ä½“ * @return void */ public void send(String topic, int qos, byte[] message){ mqttGateway.sendToMqtt(topic, qos, message); } } ","link":"https://tianxiawuhao.github.io/R-yFR9BFl/"},{"title":"Dockeræ‰§è¡Œå°æŠ€å·§ï¼ˆæ‰¹é‡è„šæœ¬ï¼‰","content":"ä¸€ã€æ‰¹é‡ä¸‹è½½dockeré•œåƒå¹¶æ‰¹é‡å¯¼å…¥å¯¼å‡ºåˆ°å…¶å®ƒåœ°æ–¹ èµ·å› æ˜¯æˆ‘éœ€è¦ä¸‹è½½ä¸€æ‰¹é•œåƒï¼Œä½†æ˜¯æˆ‘ä½¿ç”¨å¾—Linuxæœºå™¨ä¸Šæ— æ³•ä¸‹è½½ï¼Œå› ä¸ºæ¶‰åŠå¤–ç½‘ï¼Œæ‰€ä»¥æˆ‘è®¡åˆ’åœ¨å¦ä¸€å°å¤–ç½‘æœºå™¨ä¸Šå®Œæˆæ‰€æœ‰é•œåƒçš„ä¸‹è½½åï¼Œå†æ‰¹é‡å¯¼å‡ºã€å¯¼å…¥åˆ°ç›®æ ‡æœºå™¨ä¸Šï¼Œå¼€å¹²ï¼ 1ã€ç¼–å†™ä¸€ä¸ªè„šæœ¬ images.sh æ–‡ä»¶ï¼š #!/bin/bash images=( docker.io/cockpit/kubernetes:latest docker.io/openshift/origin-haproxy-router:v3.11 docker.io/openshift/origin-node:v3.11 docker.io/openshift/origin-control-plane:v3.11 docker.io/openshift/origin-deployer:v3.11.0 docker.io/openshift/origin-pod:v3.11.0 docker.io/openshift/origin-web-console:v3.11 docker.io/openshift/origin-docker-registry:v3.11 docker.io/openshift/origin-metrics-server:v3.11 docker.io/openshift/origin-console:v3.11 docker.io/openshift/origin-metrics-heapster:v3.11 docker.io/openshift/origin-metrics-hawkular-metrics:v3.11 docker.io/openshift/origin-metrics-schema-installer:v3.11 docker.io/openshift/origin-metrics-cassandra:v3.11 quay.io/coreos/cluster-monitoring-operator:v0.1.1 quay.io/coreos/prometheus-config-reloader:v0.23.2 quay.io/coreos/prometheus-operator:v0.23.2 docker.io/openshift/prometheus-alertmanager:v0.15.2 docker.io/openshift/prometheus-node-exporter:v0.16.0 docker.io/openshift/prometheus:v2.3.2 docker.io/grafana/grafana:5.2.1 quay.io/coreos/kube-rbac-proxy:v0.3.1 quay.io/coreos/etcd:v3.2.22 quay.io/coreos/kube-state-metrics:v1.3.1 docker.io/openshift/oauth-proxy:v1.1.0 quay.io/coreos/configmap-reload:v0.0.1 quay.io/openshift/origin-node:v3.11 quay.io/openshift/origin-pod:v3.11 ) for imageName in ${images[@]} ; do docker pull $imageName done 2ã€æˆäºˆæ‰§è¡Œæƒé™ï¼š chmod +x images.sh 3ã€æ‰§è¡Œè„šæœ¬å¹¶æ‰“å°æ—¥å¿—ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥æ‰§è¡Œï¼š nohup ./images.sh &gt; log.file 2&gt;&amp;1 &amp; ä¸‹è½½å®Œæˆåï¼ŒæŸ¥çœ‹æ‰€æœ‰çš„é•œåƒæ˜¯å¦å®Œæ•´ï¼š [root@VM-0-12-centos jiguiquan]# docker images --format &quot;table {{.Repository}}\\t{{.Tag}}\\t{{.ID}}&quot; REPOSITORY TAG IMAGE ID openshift/origin-node v3.11 983f6b1c6bd4 openshift/origin-control-plane v3.11 7a2f8e6e6a15 openshift/origin-deployer v3.11.0 e6d4226c7cc0 openshift/origin-haproxy-router v3.11 e3afcd798b00 openshift/origin-pod v3.11.0 560ab7ad8bbe cockpit/kubernetes latest 736c0218e939 openshift/origin-docker-registry v3.11 9dffb2abf1dd openshift/origin-console v3.11 ab1db955ef9e openshift/origin-web-console v3.11 be30b6cce5fa openshift/origin-metrics-server v3.11 8c99f32f40d3 openshift/origin-metrics-heapster v3.11 69421c019449 openshift/origin-metrics-hawkular-metrics v3.11 59e2258250c4 openshift/origin-metrics-schema-installer v3.11 342f50fded7d openshift/origin-metrics-cassandra v3.11 8176cfabc16b quay.io/coreos/cluster-monitoring-operator v0.1.1 4488a207a5bc quay.io/coreos/prometheus-config-reloader v0.23.2 2ed5973a47af quay.io/coreos/prometheus-operator v0.23.2 835a7e260b35 openshift/prometheus-alertmanager v0.15.2 68bbd0006378 openshift/prometheus-node-exporter v0.16.0 f9f775bf6d0e openshift/prometheus v2.3.2 e362c322f000 grafana/grafana 5.2.1 1bfead9ff707 quay.io/coreos/kube-rbac-proxy v0.3.1 992ac1a5e7c7 quay.io/coreos/etcd v3.2.22 ff5dd2137a4f quay.io/coreos/kube-state-metrics v1.3.1 a9c8f313b7aa openshift/oauth-proxy v1.1.0 90c45954eb03 quay.io/coreos/configmap-reload v0.0.1 3129a2ca29d7 4ã€ä¸€é”®å¯¼å‡ºæ‰€æœ‰é•œåƒåˆ° openshift.tar åŒ…ï¼š docker save $(docker images | grep -v REPOSITORY | awk 'BEGIN{OFS=&quot;:&quot;;ORS=&quot; &quot;}{print $1,$2}') -o openshift.tar 5ã€å°†taråŒ…æ‹·è´åˆ°ç›®æ ‡æœåŠ¡å™¨ä¸Šï¼Œæ‰§è¡Œ load å¯¼å…¥å‘½ä»¤ï¼š docker load -i openshift.tar äºŒã€å°†å½“å‰è¿è¡ŒçŠ¶æ€çš„dockerå®¹å™¨çŠ¶æ€å¯¼å‡ºä¸ºé•œåƒï¼Œä¿å­˜èµ·æ¥ èµ·å› æ˜¯å› ä¸ºï¼Œæˆ‘é€šè¿‡å®˜æ–¹æ•™ç¨‹ï¼Œå¿«é€Ÿéƒ¨ç½²äº†ä¸€ä¸ªå¤§å¹³å°ï¼Œè¿™ä¸ªå¹³å°æ˜¯ç”±å¾ˆå¤šå®¹å™¨ä¸€èµ·å·¥ä½œæ‰èƒ½æ”¯æ’‘ï¼Œæˆ‘éœ€è¦ä¿®æ”¹å‰ç«¯é¡µé¢çš„ä¸€äº›ä¸œè¥¿ï¼Œå¤§æˆæœ¬çš„æ–¹æ¡ˆè‚¯å®šæ˜¯ä¸‹è½½å®˜æ–¹æºç é‡æ–°è¿›è¡Œæ”¹é€ ç¼–è¯‘æ‰“åŒ…é•œåƒç­‰æ“ä½œï¼› ä½†æ˜¯é‚£æ ·å¤ªçƒ¦äº†ï¼Œæˆ‘å°±ç›´æ¥è¿›å…¥å®¹å™¨å†…éƒ¨ä¿®æ”¹äº†ä¸€äº›ä¸œè¥¿ï¼Œè¿è¡Œæ­£å¸¸åï¼Œæˆ‘å°†å½“å‰çŠ¶æ€å¯¼å‡ºä¸ºè‡ªå·±çš„é•œåƒä¿å­˜ä¸‹æ¥ï¼Œä»¥åå†éƒ¨ç½²å°±ä¸ç”¨å†è¿›å…¥ä¿®æ”¹å•¦ã€‚ docker commit 163950a65bfb registry.cn-hangzhou.aliyuncs.com/jgqk8s/jgq-console:v3.1.1 docker commitå‘½ä»¤å‚æ•° å‚æ•° æè¿° -a, --author string ä½œè€…ã€‚ -c, --change list åº”ç”¨ dockerfile æŒ‡ä»¤æ¥åˆ›å»ºå›¾åƒã€‚ -m, --message string æäº¤ä¿¡æ¯ã€‚ -p, --pause æäº¤æœŸé—´æš‚åœå®¹å™¨ï¼ˆé»˜è®¤ä¸ºtrueï¼‰ã€‚ ","link":"https://tianxiawuhao.github.io/n4qWAww-f/"},{"title":"Goä¸­çš„é¢å‘å¯¹è±¡","content":"ç›¸ä¿¡ä»ä½ åˆšå¼€å§‹å­¦ä¹ Goæ—¶ï¼Œä»¥åŠä½¿ç”¨Goå‚ä¸é¡¹ç›®ï¼Œéƒ½çŸ¥é“Goä¸­æ²¡æœ‰é¢å‘å¯¹è±¡è¿™æ ·çš„æ¦‚å¿µã€‚ä½†åœ¨å®é™…çš„é¡¹ç›®å¼€å‘ä¸­ï¼Œä¸ºäº†æé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§ã€å¯æ‰©å±•æ€§å’Œå¯å¤ç”¨æ€§ç­‰ç‰¹ç‚¹ï¼Œä½ ä¸å¾—ä¸ä½¿ç”¨é¢å‘å¯¹è±¡çš„è®¾è®¡ç†å¿µæ¥ç¼–ç ã€‚ é‚£è¯¥æ€ä¹ˆå®ç°å‘¢ï¼Œç­”æ¡ˆå°±æ˜¯ä½¿ç”¨Goä¸­ç»“æ„ä½“æ¥å®ç°ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœ¬æ–‡ä¸ä¼šå•ç‹¬å»è®²ç»“æ„ä½“çš„è¯­æ³•å†…å®¹ã€‚é‡ç‚¹æ˜¯æ€»ç»“ç»“æ„ä½“ä¸é¢å‘å¯¹è±¡çš„åŒºåˆ«ã€‚ ä»€ä¹ˆæ˜¯ç»“æ„ä½“ åœ¨Goè¯­è¨€ä¸­ï¼Œç»“æ„ä½“ï¼ˆStructï¼‰æ˜¯ä¸€ç§è‡ªå®šä¹‰æ•°æ®ç±»å‹ï¼Œç”¨äºç»„ç»‡å’Œå­˜å‚¨ä¸€ç»„ç›¸å…³å­—æ®µçš„é›†åˆã€‚å®ƒç±»ä¼¼äºå…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸­çš„ç±»æˆ–å¯¹è±¡ï¼Œæ˜¯ä¸€ç§å°†æ•°æ®å’Œç›¸å…³æ–¹æ³•ç»„åˆåœ¨ä¸€èµ·çš„å®¹å™¨ã€‚ ç»“æ„ä½“çš„å­—æ®µå°±ç±»ä¼¼äºé¢å‘å¯¹è±¡ä¸­çš„å±æ€§ã€‚ ç»“æ„ä½“çš„æ–¹æ³•å°±ç±»ä¼¼äºé¢å‘å¯¹è±¡ä¸­çš„æ–¹æ³•ã€‚ è¦å®šä¹‰ä¸€ä¸ªç»“æ„ä½“éå¸¸çš„ç®€å•ï¼Œå…¶è¯­æ³•æ ¼å¼å¦‚ä¸‹: type ç»“æ„ä½“åç§° struct { å­—æ®µå å­—æ®µå±æ€§ } func (æ¥å—è€…) æ–¹æ³•åç§°([æ–¹æ³•å‚æ•°]) [æ–¹æ³•è¿”å›å€¼] { } ä¸‹é¢æˆ‘ä»¬å°±æ¥å®é™…å®šä¹‰ä¸€ä¸ªç»“æ„ä½“ã€‚ package main import &quot;fmt&quot; type Animal struct { name string age string height float64 weight float64 } func (u Animal) run() { fmt.Println(u.name, &quot;è·‘æ­¥çš„é€Ÿåº¦å¾ˆå¿«&quot;) } func main() { animal1 := &amp;Animal{ name: &quot;é¸µé¸Ÿ&quot;, } animal1.run() // output:é¸µé¸Ÿ è·‘æ­¥çš„é€Ÿåº¦å¾ˆå¿« } å®šä¹‰ä¸€ä¸ªåä¸ºAnimalçš„ç»“æ„ä½“ï¼Œå°±ç›¸å½“äºé¢å‘å¯¹è±¡ä¸­çš„ç±»ã€‚ å®šä¹‰nameã€ageç­‰å­—æ®µï¼Œå°±ç›¸å½“äºé¢å‘å¯¹è±¡ä¸­çš„å±æ€§ã€‚ å®šä¹‰run()æ–¹æ³•ï¼Œå°±ç›¸å½“äºé¢å‘å¯¹è±¡ä¸­çš„æ–¹æ³•ã€‚è®°ä½ï¼šæ–¹æ³•ä¸€å®šæ˜¯è¦æœ‰ä¸€ä¸ªæ¥æ”¶è€…çš„ï¼Œè¿™é‡Œçš„æ¥æ”¶è€…ä¸ºç»“æ„ä½“Animalï¼Œå…¶å®å°±æ˜¯å°†è¿™ä¸ªæ–¹æ³•å½’å±åˆ°ç»“æ„ä½“Animalã€‚å°±å¥½æ¯”åœ¨ç±»ä¸­å®šä¹‰ä¸€ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯å±äºè¿™ä¸ªç±»ã€‚ ä½¿ç”¨&amp;Animal{}ï¼Œå°±ç›¸å½“äºé¢å‘å¯¹è±¡çš„å®ä¾‹åŒ–ç±»çš„è¿‡ç¨‹ã€‚ ä½¿ç”¨animal1.run()ï¼Œå°±ç›¸å½“äºå®ä¾‹åŒ–äº†ä¸€ä¸ªå¯¹è±¡ï¼Œé€šè¿‡å¯¹è±¡å»è°ƒç”¨æ–¹æ³•ã€‚ æ˜¯ä¸æ˜¯å‘ç°ä½¿ç”¨structï¼Œå®ç°é¢å‘å¯¹è±¡æ˜¯éå¸¸ç®€å•ã€‚ å¯¹è±¡ç»§æ‰¿ åœ¨å…·æœ‰é¢å‘å¯¹è±¡çš„å¼€å‘è¯­è¨€ä¸­ï¼Œä½¿ç”¨å¯¹è±¡ç»§æ‰¿ï¼Œéƒ½æ˜¯ä½¿ç”¨å…³é”®å­—extendå…³é”®å­—æ¥å®ç°ã€‚åœ¨Goä¸­ï¼Œå¯ä»¥ä½¿ç”¨ç»“æ„ä½“åµŒå¥—çš„æ–¹å¼æ¥å®ç°ç»§æ‰¿å…³ç³»ã€‚ package main import &quot;fmt&quot; type Animal struct { name string age string height float64 weight float64 } type Dog struct { Animal color string } func (u Animal) run() { fmt.Println(u.name, &quot;è·‘æ­¥çš„é€Ÿåº¦å¾ˆå¿«&quot;) } func (d Dog) sleep() { fmt.Println(d.name, &quot;æ™šä¸Šå¾ˆå°‘ç¡è§‰&quot;) } func main() { dog := &amp;Dog{ Animal{name: &quot;å°ç‹—&quot;}, } dog.sleep() dog.run() } ä¸Šè¿°å®šä¹‰äº†ä¸€ä¸ªAnimalçš„ç»“æ„ä½“ï¼Œä½œä¸ºçˆ¶ç±»ç»“æ„ä½“ã€‚åŒæ—¶å®šä¹‰äº†ä¸€ä¸ªrun()æ–¹æ³•ï¼Œå½“åšçˆ¶ç±»çš„æ–¹æ³•ï¼Œå®šä¹‰äº†4ä¸ªå­—æ®µå½“åšçˆ¶ç±»çš„å±æ€§ã€‚ æ¥ç€å®šä¹‰äº†ä¸€ä¸ªDogç»“æ„ä½“ï¼ŒåµŒå…¥äº†ä¸€ä¸ªAnimalçš„ç»“æ„ä½“ï¼Œæ­¤æ—¶ä¸¤ä¸ªç»“æ„ä½“å°±å®ç°äº†ä¸€ä¸ªç»§æ‰¿çš„å…³ç³»ã€‚ Dogç»“æ„ä½“è‡ªèº«ä¹Ÿå®šä¹‰äº†ä¸€ä¸ªsleep()çš„æ–¹æ³•ã€‚è¿™æ—¶ï¼ŒDogç»“æ„ä½“å…·å¤‡çˆ¶ç±»ç»“æ„ä½“çš„æ‰€æœ‰æ–¹æ³•å’Œå±æ€§ï¼ŒåŒæ—¶ä¹Ÿæœ‰è‡ªå·±çš„å±æ€§å’Œæ–¹æ³•ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç»“æ„ä½“çš„åµŒå¥—ï¼Œå¯ä»¥æ˜¯å¤–éƒ¨åŒ…ï¼Œä¹Ÿå¯ä»¥æ˜¯æœ¬åŒ…ã€‚æ–¹æ³•çš„æ¥æ”¶è€…å¿…é¡»æ˜¯æœ¬åŒ…çš„ç»“æ„ä½“ï¼Œä¸èƒ½æ˜¯å¤–éƒ¨åŒ…ã€‚ æ­¤è‡´ï¼Œç»“æ„ä½“å®ç°å¯¹è±¡çš„ç‰¹æ€§ï¼Œå°±æ€»ç»“çš„å·®ä¸å¤šäº†ã€‚è®°ä½Goä¸­çš„æœºæ„ä½“ä¸ä»…èƒ½å®ç°é¢å‘å¯¹è±¡çš„ç‰¹æ€§ï¼ŒåŒæ—¶è¿˜å…·æœ‰å…¶ä»–æ›´å¼ºå¤§çš„åŠŸèƒ½ã€‚è¿™é‡Œç®€å•çš„ä¸¾ä¾‹ã€‚ type user struct { name string `json:&quot;name&quot;` } ä¸Šé¢çš„å†™æ³•ï¼Œç›¸ä¿¡å¤§å®¶åœ¨å¾ˆå¤šçš„ç¬¬ä¸‰æ–¹åŒ…ï¼Œä»¥åŠé¡¹ç›®å¼€å‘ä¸­éƒ½èƒ½é‡åˆ°ã€‚é€šè¿‡å®šä¹‰ä¸€ä¸ªtagï¼Œå¯ä»¥å°†å…ƒæ•°æ®é€šè¿‡tagçš„å®šä¹‰æ–¹å¼ï¼Œæš´éœ²ç»™å¤–éƒ¨ã€‚ æ€»ç»“ åœ¨Goè¯­è¨€ä¸­ï¼Œstructæ˜¯ä¸€ç§ç”¨æˆ·è‡ªå®šä¹‰çš„æ•°æ®ç±»å‹ï¼Œç”¨äºç»„ç»‡å’Œå­˜å‚¨ä¸åŒå­—æ®µç±»å‹çš„æ•°æ®ã€‚å®ƒç±»ä¼¼äºå…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸­çš„ç»“æ„ä½“ï¼Œä½†åœ¨Goä¸­ï¼Œstructä¸å…·å¤‡é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ç±»çš„æ‰€æœ‰ç‰¹æ€§ã€‚ä»¥ä¸‹æ˜¯structä¸é¢å‘å¯¹è±¡çš„ä¸»è¦åŒºåˆ«ï¼š ç»§æ‰¿ï¼šGoè¯­è¨€ä¸­çš„structä¸æ”¯æŒç»§æ‰¿ï¼Œæ— æ³•é€šè¿‡ä¸€ä¸ªstructæ¥ç»§æ‰¿å¦ä¸€ä¸ªstructçš„æˆå‘˜å’Œæ–¹æ³•ã€‚è€Œé¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ï¼Œç±»ä¹‹é—´å¯ä»¥é€šè¿‡ç»§æ‰¿æ¥å…±äº«å’Œæ‰©å±•åŠŸèƒ½ã€‚ å°è£…ï¼šåœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ï¼Œç±»çš„æˆå‘˜å’Œæ–¹æ³•å¯ä»¥è¿›è¡Œå°è£…ï¼Œé€šè¿‡è®¿é—®ä¿®é¥°ç¬¦æ¥æ§åˆ¶å…¶å¯è§æ€§ã€‚è€Œåœ¨Goä¸­ï¼Œstructçš„æˆå‘˜é»˜è®¤æ˜¯å…¬å¼€çš„ï¼Œå¯ä»¥è¢«å¤–éƒ¨è®¿é—®ï¼Œæ— æ³•åƒç±»ä¸€æ ·è¿›è¡Œä¸¥æ ¼å°è£…ã€‚ å¤šæ€ï¼šé¢å‘å¯¹è±¡ç¼–ç¨‹æ”¯æŒå¤šæ€æ€§ï¼Œä¸€ä¸ªå¯¹è±¡å¯ä»¥æ ¹æ®ä¸åŒçš„ä¸Šä¸‹æ–‡è¡¨ç°å‡ºä¸åŒçš„è¡Œä¸ºã€‚è€ŒGoè¯­è¨€ä¸­çš„structä¸ç›´æ¥æ”¯æŒå¤šæ€ï¼Œä½†å¯ä»¥é€šè¿‡æ¥å£æ¥å®ç°ç±»ä¼¼çš„æ•ˆæœã€‚ æ€»çš„æ¥è¯´ï¼Œè™½ç„¶Goè¯­è¨€çš„structä¸åŒäºä¼ ç»Ÿçš„é¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€ä¸­çš„ç±»ï¼Œä½†é€šè¿‡ç»“åˆä½¿ç”¨æ¥å£ã€åµŒå…¥ç­‰è¯­è¨€ç‰¹æ€§ï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥åœ¨Goä¸­å®ç°ç±»ä¼¼é¢å‘å¯¹è±¡çš„è®¾è®¡å’Œç¼–ç¨‹èŒƒå¼ã€‚ ","link":"https://tianxiawuhao.github.io/0yq48V3py/"},{"title":"Hadoop3.3.5å®‰è£…","content":"Hadoop3.3.5å®‰è£…(Windows) å®‰è£…JDK1.8(è‡ªè¡ŒæŸ¥é˜…) 1. ä¸‹è½½Hadoop ç›´æ¥è®¿é—®å®˜ç½‘ [Hadoopä¸‹è½½åœ°å€](Index of /hadoop/common/hadoop-3.3.5 (apache.org)) 2. é…ç½®ç¯å¢ƒå˜é‡ å°†ä¸‹è½½çš„å‹ç¼©åŒ…è§£å‹åˆ°å…¶ä»–ç›˜ï¼Œåœ¨ç¯å¢ƒå˜é‡ä¸­é…ç½®å¥½Hadoopçš„ç¯å¢ƒå˜é‡ï¼Œæ–°å»ºHADOOP_HOMEï¼Œå¦‚ä¸‹ pathä¹Ÿè¦åŠ  3. ä¿®æ”¹é…ç½®æ–‡ä»¶ åœ¨hadoop-3.3.5ç›®å½•ä¸‹æ–°å»ºdataå’Œtmpä¸¤ä¸ªæ–‡ä»¶å¤¹ï¼Œåœ¨dataç›®å½•ä¸‹æ–°å»ºdatanodeã€namenodeã€snnä¸‰ä¸ªæ–‡ä»¶å¤¹ã€‚æ‰“å¼€hadoop-3.3.5\\etc\\hadoopç›®å½•ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ core-site.xmlæ–‡ä»¶ &lt;configuration&gt; &lt;property&gt; &lt;name&gt;fs.default.name&lt;/name&gt; &lt;value&gt;hdfs://localhost:9000&lt;/value&gt; &lt;/property&gt; &lt;/configuration&gt; hdfs-site.xmlæ–‡ä»¶ &lt;configuration&gt; &lt;!-- å•æœºç‰ˆé…ç½®ä¸º1 --&gt; &lt;property&gt; &lt;name&gt;dfs.replication&lt;/name&gt; &lt;value&gt;1&lt;/value&gt; &lt;/property&gt; &lt;property&gt; &lt;name&gt;dfs.permissions&lt;/name&gt; &lt;value&gt;false&lt;/value&gt; &lt;/property&gt; &lt;property&gt; &lt;name&gt;dfs.namenode.name.dir&lt;/name&gt; &lt;value&gt;file:/D:/A-Enviroment/hadoop-3.3.5/data/namenode&lt;/value&gt; &lt;/property&gt; &lt;property&gt; &lt;name&gt;fs.checkpoint.dir&lt;/name&gt; &lt;value&gt;file:/D:/A-Enviroment/hadoop-3.3.5/data/snn&lt;/value&gt; &lt;/property&gt; &lt;property&gt; &lt;name&gt;fs.checkpoint.edits.dir&lt;/name&gt; &lt;value&gt;file:/D:/A-Enviroment/hadoop-3.3.5/data/snn&lt;/value&gt; &lt;/property&gt; &lt;property&gt; &lt;name&gt;dfs.datanode.data.dir&lt;/name&gt; &lt;value&gt;file:/D:/A-Enviroment/hadoop-3.3.5/data/datanode&lt;/value&gt; &lt;/property&gt; &lt;/configuration&gt; mapred-site.xmlæ–‡ä»¶ &lt;configuration&gt; &lt;property&gt; &lt;name&gt;mapreduce.framework.name&lt;/name&gt; &lt;value&gt;yarn&lt;/value&gt; &lt;/property&gt; &lt;/configuration&gt; yarn-site.xmlæ–‡ä»¶ &lt;configuration&gt; &lt;property&gt; &lt;name&gt;yarn.nodemanager.aux-services&lt;/name&gt; &lt;value&gt;mapreduce_shuffle&lt;/value&gt; &lt;/property&gt; &lt;property&gt; &lt;name&gt;yarn.nodemanager.aux-services.mapreduce.shuffle.class&lt;/name&gt; &lt;value&gt;org.apache.hadoop.mapred.ShuffleHandler&lt;/value&gt; &lt;/property&gt; &lt;property&gt; &lt;name&gt;yarn.nodemanager.local-dirs&lt;/name&gt; &lt;value&gt;/D:/A-Enviroment/hadoop-3.3.5/tmp&lt;/value&gt; &lt;/property&gt; &lt;/configuration&gt; 4. æ·»åŠ åŠ¨æ€åº“ åœ¨hadoop-3.3.5/binç›®å½•ä¸‹æ·»åŠ hadoop.dllå’Œwinutils.exeæ–‡ä»¶ï¼Œå¯ä»¥ä»https://github.com/cdarlint/winutilså’Œhttps://github.com/steveloughran/winutilsè·å–å¯¹åº”ç‰ˆæœ¬çš„æ–‡ä»¶ã€‚ winutils-master.zip 5. éªŒè¯ ä»¥ç®¡ç†å‘˜èº«ä»½æ‰“å¼€å‘½ä»¤æç¤ºç¬¦ æ‰§è¡Œhadoop versionæŸ¥çœ‹hadoopæ˜¯å¦å®‰è£…/é…ç½®æˆåŠŸï¼Œå¦‚ä¸‹å›¾ï¼š æŠ¥é”™ åŸå› æ˜¯Hadoopé‡Œçš„Javaè·¯å¾„é…ç½®ä¸å¯¹ã€‚æ‰“å¼€C:hadoop-3.3.5\\etc\\hadoop\\hadoop-env.cmdè¿™ä¸ªæ–‡ä»¶ï¼Œå‘ç°åœ¨ç¬¬25è¡Œï¼Œé…ç½®çš„JAVA_HOMEæ˜¯ç³»ç»Ÿé‡Œçš„ç¯å¢ƒå˜é‡ã€‚ å»ç³»ç»Ÿå˜é‡é‡ŒæŸ¥çœ‹JAVA_HOMEï¼Œå‘ç°è·¯å¾„æ˜¯C:Program Filesï¼Œå…¶ä¸­åŒ…å«äº†ç©ºæ ¼ï¼Œå› æ­¤hadoopæŠ¥é”™ æŠŠJDKç§»åŠ¨åˆ°å¦ä¸€ä¸ªä¸åŒ…å«ç©ºæ ¼åç§°çš„æ–‡ä»¶å¤¹ä¸‹ï¼Œä¾‹å¦‚D:\\jdk-17.0.1ï¼ˆå®‰è£…jdk1.8ï¼‰ã€‚è¾“å…¥å‘½ä»¤ï¼ŒæˆåŠŸå¯åŠ¨Hadoop æ‰§è¡Œhdfs namenode -formatéªŒè¯é…ç½®æ–‡ä»¶æ˜¯å¦ä¿®æ”¹æˆåŠŸ æˆåŠŸ å¯åŠ¨ åœ¨sbinç›®å½•ä¸‹ï¼Œä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œstart-all.cmd ä¼šå¼¹å‡ºå››ä¸ªçª—å£ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å¦‚ä¸Šé¢æ˜¯å¯åŠ¨å¤±è´¥ï¼Œè¿™æ˜¯å› ä¸ºhadoop.dllå’Œwinutils.exeä¸ä½ çš„ç‰ˆæœ¬ä¸åŒ¹é…çš„é—®é¢˜ï¼Œè‡ªè¡Œç™¾åº¦æ‰¾ç‰ˆæœ¬ï¼Œå°†hadoop.dllæ”¾åˆ°C:\\window\\system32ç›®å½•ä¸‹ï¼Œå†å°†hadoop.dllå’Œwinutils.exeæ·»åŠ åˆ°hadoop-3.3.5/binä¸‹ï¼Œä»¥ç®¡ç†å‘˜èº«ä»½é‡æ–°è¿è¡Œstart-all.cmdå³å¯è¿è¡ŒæˆåŠŸã€‚ æµè§ˆå™¨ä¸­è¾“å…¥åœ°å€ï¼šhttp://localhost:8088 æµè§ˆå™¨ä¸­è¾“å…¥åœ°å€ï¼šhttp://localhost:9870 ","link":"https://tianxiawuhao.github.io/ZkyB61S7B/"},{"title":"Docker+Jenkins(blueocean)+Giteeæ„å»ºCICDæµæ°´çº¿å®æˆ˜","content":"éœ€æ±‚: ä½¿ç”¨jenkinsæ­å»ºæµæ°´çº¿å®ç°æŒç»­é›†æˆæŒç»­éƒ¨ç½² ä¸€ã€ç¼–å†™docker-compose.ymlå®‰è£…jenkins, jenkinsçš„ç‰ˆæœ¬æ˜¯å¸¦blueoceanæ’ä»¶çš„ç‰ˆæœ¬ version: '3' services: mysql: image: mysql:8.0.29 container_name: mysql restart: always ports: - 3306:3306 privileged: true environment: TZ: Asia/Shanghai MYSQL_ROOT_PASSWORD: 123456 command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci --explicit_defaults_for_timestamp=true --lower_case_table_names=1 volumes: - /mydata/mysql/data/db:/var/lib/mysql #æ•°æ®æ–‡ä»¶æŒ‚è½½ - /mydata/mysql/data/conf:/etc/mysql/conf.d #é…ç½®æ–‡ä»¶æŒ‚è½½ - /mydata/mysql/log:/var/log/mysql #æ—¥å¿—æ–‡ä»¶æŒ‚è½½ redis: image: redis:7 container_name: redis restart: always command: redis-server --requirepass 1234566 --appendonly yes volumes: - /mydata/redis/data:/data - /etc/localtime:/etc/localtime:ro ports: - 6379:6379 nginx: image: nginx:1.22 container_name: nginx restart: always volumes: - /mydata/nginx/nginx.conf:/etc/nginx/nginx.conf #é…ç½®æ–‡ä»¶æŒ‚è½½ - /mydata/nginx/html:/usr/share/nginx/html #é™æ€èµ„æºæ ¹ç›®å½•æŒ‚è½½ - /mydata/nginx/log:/var/log/nginx #æ—¥å¿—æ–‡ä»¶æŒ‚è½½ - /etc/localtime:/etc/localtime:ro ports: - 80:80 rabbitmq: image: rabbitmq:3.9-management container_name: rabbitmq restart: always ports: - 5672:5672 - 15672:15672 environment: TZ: Asia/Shanghai volumes: - /mydata/rabbitmq/data:/var/lib/rabbitmq #æ•°æ®æ–‡ä»¶æŒ‚è½½ - /etc/localtime:/etc/localtime:ro mongo: image: mongo:4 container_name: mongo restart: always volumes: - /mydata/mongo/db:/data/db ports: - 27017:27017 environment: TZ: Asia/Shanghai MONGO_INITDB_ROOT_USERNAME: root MONGO_INITDB_ROOT_PASSWORD: 123456 command: --auth jenkins: image: jenkinsci/blueocean container_name: jenkins restart: always user: root ports: - 8080:8080 - 50000:50000 volumes: - /mydata/jenkins_home:/var/jenkins_home - /etc/localtime:/etc/localtime:ro - /var/run/docker.sock:/var/run/docker.sock åœ¨/mydata/jenkins_home/appconfig/maven/settings.xmlç›®å½•é…ç½®mavençš„é˜¿é‡Œæº &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;settings xmlns=&quot;http://maven.apache.org/SETTINGS/1.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd&quot;&gt; &lt;pluginGroups&gt; &lt;/pluginGroups&gt; &lt;proxies&gt; &lt;/proxies&gt; &lt;servers&gt; &lt;/servers&gt; &lt;mirrors&gt; &lt;mirror&gt; &lt;id&gt;nexus-aliyun&lt;/id&gt; &lt;mirrorOf&gt;central&lt;/mirrorOf&gt; &lt;name&gt;Nexus aliyun&lt;/name&gt; &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public&lt;/url&gt; &lt;/mirror&gt; &lt;/mirrors&gt; &lt;localRepository&gt;/root/.m2&lt;/localRepository&gt; &lt;profiles&gt; &lt;profile&gt; &lt;id&gt;jdk-1.8&lt;/id&gt; &lt;activation&gt; &lt;jdk&gt;1.8&lt;/jdk&gt; &lt;/activation&gt; &lt;properties&gt; &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt; &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt; &lt;maven.compiler.compilerVersion&gt;1.8&lt;/maven.compiler.compilerVersion&gt; &lt;/properties&gt; &lt;/profile&gt; &lt;/profiles&gt; &lt;/settings&gt; äºŒã€ç™»å½•xxx:8080é…ç½®jenkins 1ã€åˆå§‹å¯†ç ä½¿ç”¨ docker logs jenkins æŸ¥çœ‹è·å– 2ã€å®‰è£…æ’ä»¶ Docker Pipeline, åé¢æ„å»ºæµæ°´çº¿éœ€è¦ 3ã€å‡†å¤‡ä¸€ä¸ªé¡¹ç›®ï¼Œæäº¤åˆ°Gitee åˆ›å»ºä¸¤ä¸ªæ–‡ä»¶ Jenkinsfileå’ŒDockerfile pipeline{ agent any environment { WS = &quot;${WORKSPACE}&quot; IMAGE_NAME = &quot;java-devops-demo&quot; } //å®šä¹‰æµæ°´çº¿çš„åŠ å·¥æµç¨‹ stages { //æµæ°´çº¿çš„æ‰€æœ‰é˜¶æ®µ stage('1.ç¯å¢ƒæ£€æŸ¥'){ steps { sh 'pwd &amp;&amp; ls -alh' sh 'printenv' sh 'docker version' sh 'java -version' sh 'git --version' } } stage('2.ç¼–è¯‘'){ agent { docker { image 'maven:3-alpine' args '-v maven-repository:/root/.m2' } } steps { sh 'pwd &amp;&amp; ls -alh' sh 'mvn -v' sh 'cd ${WS} &amp;&amp; mvn clean package -s &quot;/var/jenkins_home/appconfig/maven/settings.xml&quot; -Dmaven.test.skip=true' } } stage('3.æ‰“åŒ…'){ steps { sh 'pwd &amp;&amp; ls -alh' sh 'docker build -t ${IMAGE_NAME} .' } } stage('4.éƒ¨ç½²'){ // åˆ é™¤å®¹å™¨å’Œè™šæ‚¬é•œåƒ steps { sh 'pwd &amp;&amp; ls -alh' sh 'docker rm -f ${IMAGE_NAME} &amp;&amp; docker rmi $(docker images -q -f dangling=true)' sh 'docker run -d -p 8888:8080 --name ${IMAGE_NAME} -v /mydata/logs/${IMAGE_NAME}:/logs/${IMAGE_NAME} ${IMAGE_NAME}' } } } } FROM openjdk:8-jre-alpine # å°†å½“å‰ç›®å½•ä¸‹çš„jaråŒ…å¤åˆ¶åˆ°dockerå®¹å™¨çš„/ç›®å½•ä¸‹ COPY target/*.jar /app.jar # è¿è¡Œè¿‡ç¨‹ä¸­åˆ›å»ºä¸€ä¸ªxx.jaræ–‡ä»¶ RUN touch /app.jar; ENV TZ=Asia/Shanghai JAVA_OPTS=&quot;-Xms128m -Xmx256m -Djava.security.egd=file:/dev/./urandom&quot; ENV PARAMS=&quot;&quot; # å£°æ˜æœåŠ¡è¿è¡Œåœ¨8080ç«¯å£ EXPOSE 8080 # æŒ‡å®šdockerå®¹å™¨å¯åŠ¨æ—¶è¿è¡ŒjaråŒ… ENTRYPOINT [ &quot;sh&quot;, &quot;-c&quot;, &quot;java $JAVA_OPTS -jar /app.jar $PARAMS&quot; ] 4ã€jenkinsé¦–é¡µé¦–é¡µå·¦ä¾§çš„æ–°å»ºä»»åŠ¡ï¼Œè¾“å…¥ä»»åŠ¡åç§°ï¼Œé€‰æ‹©æµæ°´çº¿ 5ã€é…ç½®æµæ°´çº¿ 6ã€è¿”å›é¦–é¡µç‚¹å‡»'æ‰“å¼€ Blue Ocean'é€‰æ‹©è¿è¡Œ åˆ°æ­¤æ•´ä½“åŠŸèƒ½å·²ç»å®Œæˆ ä¸‰ã€æµ‹è¯• å››ã€è§¦å‘è¿œç¨‹æ„å»º åˆ›å»ºä¸€ä¸ªjenkinsè´¦å·ç”¨æ¥è§¦å‘è¿œç¨‹æ„å»º æ„å»ºmavené¡¹ç›® ","link":"https://tianxiawuhao.github.io/uTx-7SqyQ/"},{"title":"Springboot+å¾®ä¿¡å°ç¨‹åºâ€”â€”å¾®ä¿¡æˆæƒç™»å½•","content":"åœ¨å®é™…å°ç¨‹åºå¼€å‘ä¸­ï¼Œå¤§éƒ¨åˆ†çš„å‰åå°äº¤äº’ä¸šåŠ¡æ“ä½œä¸å‰åç«¯åˆ†ç¦»çš„webappæ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œéƒ½æ˜¯è°ƒç”¨åå°æ¥å£ï¼Œä½¿ç”¨JSONæ•°æ®ä¼ é€’ï¼Œåªæœ‰åœ¨ä¸€äº›ç‰¹æ®Šçš„ç¯èŠ‚æ‰ä¼šæ„Ÿè§‰åˆ°å¾®ä¿¡çš„å­˜åœ¨ï¼Œæ¯”å¦‚å¾®ä¿¡æˆæƒç™»å½•ã€å¾®ä¿¡æ”¯ä»˜ã€å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯æ¨é€ç­‰åœºæ™¯ï¼› è¿™äº›åœºæ™¯å¦‚æœç†è§£äº†åŸç†ï¼Œå…¶å®ä¹Ÿéƒ½ä¸å¤æ‚ï¼Œæœ¬èŠ‚åšæ–‡ä¸»è¦è®²è§£ï¼Œå¦‚ä½•ä½¿ç”¨springbootåå°å¤„ç†å¾®ä¿¡æˆæƒç™»å½•ï¼š åœ¨å¤„ç†å¾®ä¿¡å°ç¨‹åºæˆæƒç™»å½•ä¹‹å‰ï¼Œæœ€åå¯ä»¥å…ˆäº†è§£ä¸€ä¸‹Oauth2.0æˆæƒåè®®ï¼Œå¦‚æœç¡®å®ä¸æ¸…æ¥šï¼Œé‚£ä¹ˆä¹Ÿæ²¡äº‹ï¼Œç›´æ¥çœ‹å¾®ä¿¡å°ç¨‹åºå¼€å‘å®˜æ–¹æ–‡æ¡£ç›¸å…³ç« èŠ‚ï¼šå°ç¨‹åºç™»å½•æ—¶åºå›¾ è¯´æ˜ï¼š è°ƒç”¨ wx.login() è·å– ä¸´æ—¶ç™»å½•å‡­è¯code ï¼Œå¹¶å›ä¼ åˆ°å¼€å‘è€…æœåŠ¡å™¨ï¼› è°ƒç”¨ auth.code2Session æ¥å£ï¼Œæ¢å– ç”¨æˆ·å”¯ä¸€æ ‡è¯† OpenID å’Œ ä¼šè¯å¯†é’¥ session_keyï¼› ä¹‹åå¼€å‘è€…æœåŠ¡å™¨å¯ä»¥æ ¹æ®ç”¨æˆ·æ ‡è¯†æ¥ç”Ÿæˆè‡ªå®šä¹‰ç™»å½•æ€ï¼Œç”¨äºåç»­ä¸šåŠ¡é€»è¾‘ä¸­å‰åç«¯äº¤äº’æ—¶è¯†åˆ«ç”¨æˆ·èº«ä»½ï¼› æ³¨æ„ï¼š ä¼šè¯å¯†é’¥ session_key æ˜¯å¯¹ç”¨æˆ·æ•°æ®è¿›è¡Œ åŠ å¯†ç­¾å çš„å¯†é’¥ã€‚ä¸ºäº†åº”ç”¨è‡ªèº«çš„æ•°æ®å®‰å…¨ï¼Œå¼€å‘è€…æœåŠ¡å™¨ä¸åº”è¯¥æŠŠä¼šè¯å¯†é’¥ä¸‹å‘åˆ°å°ç¨‹åºï¼Œä¹Ÿä¸åº”è¯¥å¯¹å¤–æä¾›è¿™ä¸ªå¯†é’¥ï¼› ä¸´æ—¶ç™»å½•å‡­è¯ code åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼› ä¸Šé¢æŠŠæµç¨‹ç†æ¸…äº†ï¼Œé‚£ä¹ˆä¸‹é¢å°±å¼€å§‹ç”¨ä»£ç å®ç°å§ï¼šspringbootéƒ¨åˆ†ï¼šä¸ºäº†å‡å°‘åšæ–‡çš„ç¯‡å¹…ï¼Œæˆ‘å°±ä¸å°†æ‰€æœ‰çš„ä»£ç éƒ½è´´åœ¨è¿™é‡Œäº†ï¼ŒåªæŒ‘æ ¸å¿ƒçš„è´´ï¼š éœ€è¦ç”¨åˆ°çš„æ ¸å¿ƒæŠ€æœ¯ï¼ŒHttpClientå’ŒjwtTokenï¼Œéœ€è¦åœ¨åŸæœ‰ä¾èµ–çš„åŸºç¡€ä¸Šå¢åŠ è¿™ä¸¤ä¸ªmavenä¾èµ–ï¼š &lt;!-- httpclient --&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.httpcomponents&lt;/groupId&gt; &lt;artifactId&gt;httpclient&lt;/artifactId&gt; &lt;/dependency&gt; &lt;!-- jwt-token --&gt; &lt;dependency&gt; &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt; &lt;artifactId&gt;jjwt&lt;/artifactId&gt; &lt;version&gt;0.7.0&lt;/version&gt; &lt;/dependency&gt; ä¸ºHttpClientå’ŒjwtTokenå°è£…å·¥å…·ç±»ï¼š HttpClientUtil.java package com.wx.video.utils; import java.io.IOException; import java.net.URI; import java.util.ArrayList; import java.util.List; import java.util.Map; import org.apache.http.client.entity.UrlEncodedFormEntity; import org.apache.http.client.methods.CloseableHttpResponse; import org.apache.http.client.methods.HttpGet; import org.apache.http.client.methods.HttpPost; import org.apache.http.client.utils.URIBuilder; import org.apache.http.entity.ContentType; import org.apache.http.entity.StringEntity; import org.apache.http.impl.client.CloseableHttpClient; import org.apache.http.impl.client.HttpClients; import org.apache.http.message.BasicNameValuePair; import org.apache.http.util.EntityUtils; public class HttpClientUtil { public static String doGet(String url, Map&lt;String, String&gt; param) { // åˆ›å»ºHttpclientå¯¹è±¡ CloseableHttpClient httpclient = HttpClients.createDefault(); String resultString = &quot;&quot;; CloseableHttpResponse response = null; try { // åˆ›å»ºuri URIBuilder builder = new URIBuilder(url); if (param != null) { for (String key : param.keySet()) { builder.addParameter(key, param.get(key)); } } URI uri = builder.build(); // åˆ›å»ºhttp GETè¯·æ±‚ HttpGet httpGet = new HttpGet(uri); // æ‰§è¡Œè¯·æ±‚ response = httpclient.execute(httpGet); // åˆ¤æ–­è¿”å›çŠ¶æ€æ˜¯å¦ä¸º200 if (response.getStatusLine().getStatusCode() == 200) { resultString = EntityUtils.toString(response.getEntity(), &quot;UTF-8&quot;); } } catch (Exception e) { e.printStackTrace(); } finally { try { if (response != null) { response.close(); } httpclient.close(); } catch (IOException e) { e.printStackTrace(); } } return resultString; } public static String doGet(String url) { return doGet(url, null); } public static String doPost(String url, Map&lt;String, String&gt; param) { // åˆ›å»ºHttpclientå¯¹è±¡ CloseableHttpClient httpClient = HttpClients.createDefault(); CloseableHttpResponse response = null; String resultString = &quot;&quot;; try { // åˆ›å»ºHttp Postè¯·æ±‚ HttpPost httpPost = new HttpPost(url); // åˆ›å»ºå‚æ•°åˆ—è¡¨ if (param != null) { List&lt;BasicNameValuePair&gt; paramList = new ArrayList&lt;&gt;(); for (String key : param.keySet()) { paramList.add(new BasicNameValuePair(key, param.get(key))); } // æ¨¡æ‹Ÿè¡¨å• UrlEncodedFormEntity entity = new UrlEncodedFormEntity(paramList); httpPost.setEntity(entity); } // æ‰§è¡Œhttpè¯·æ±‚ response = httpClient.execute(httpPost); resultString = EntityUtils.toString(response.getEntity(), &quot;utf-8&quot;); } catch (Exception e) { e.printStackTrace(); } finally { try { response.close(); } catch (IOException e) { e.printStackTrace(); } } return resultString; } public static String doPost(String url) { return doPost(url, null); } public static String doPostJson(String url, String json) { // åˆ›å»ºHttpclientå¯¹è±¡ CloseableHttpClient httpClient = HttpClients.createDefault(); CloseableHttpResponse response = null; String resultString = &quot;&quot;; try { // åˆ›å»ºHttp Postè¯·æ±‚ HttpPost httpPost = new HttpPost(url); // åˆ›å»ºè¯·æ±‚å†…å®¹ StringEntity entity = new StringEntity(json, ContentType.APPLICATION_JSON); httpPost.setEntity(entity); // æ‰§è¡Œhttpè¯·æ±‚ response = httpClient.execute(httpPost); resultString = EntityUtils.toString(response.getEntity(), &quot;utf-8&quot;); } catch (Exception e) { e.printStackTrace(); } finally { try { response.close(); } catch (IOException e) { e.printStackTrace(); } } return resultString; } } UserClaims.java package com.wx.video.utils; import java.util.Date; import io.jsonwebtoken.Claims; import io.jsonwebtoken.RequiredTypeException; import io.jsonwebtoken.impl.JwtMap; public class UserClaims extends JwtMap implements Claims { private String grantType = &quot;password&quot;; private Integer uid; private String openid; public Integer getUid() { return uid; } public void setUid(Integer uid) { this.uid = uid; setValue(&quot;uid&quot;, uid); } public String getOpenid() { return openid; } public void setOpenid(String openid) { this.openid = openid; setValue(&quot;openid&quot;, openid); } public String getGrantType() { return grantType; } public void setGrantType(String grantType) { this.grantType = grantType; setValue(&quot;grantType&quot;, this.grantType); } @Override public String getIssuer() { return getString(ISSUER); } @Override public Claims setIssuer(String iss) { setValue(ISSUER, iss); return this; } @Override public String getSubject() { return getString(SUBJECT); } @Override public Claims setSubject(String sub) { setValue(SUBJECT, sub); return this; } @Override public String getAudience() { return getString(AUDIENCE); } @Override public Claims setAudience(String aud) { setValue(AUDIENCE, aud); return this; } @Override public Date getExpiration() { return get(Claims.EXPIRATION, Date.class); } @Override public Claims setExpiration(Date exp) { setDate(Claims.EXPIRATION, exp); return this; } @Override public Date getNotBefore() { return get(Claims.NOT_BEFORE, Date.class); } @Override public Claims setNotBefore(Date nbf) { setDate(Claims.NOT_BEFORE, nbf); return this; } @Override public Date getIssuedAt() { return get(Claims.ISSUED_AT, Date.class); } @Override public Claims setIssuedAt(Date iat) { setDate(Claims.ISSUED_AT, iat); return this; } @Override public String getId() { return getString(ID); } @Override public Claims setId(String jti) { setValue(Claims.ID, jti); return this; } @Override public &lt;T&gt; T get(String claimName, Class&lt;T&gt; requiredType) { Object value = get(claimName); if (value == null) { return null; } if (Claims.EXPIRATION.equals(claimName) || Claims.ISSUED_AT.equals(claimName) || Claims.NOT_BEFORE.equals(claimName)) { value = getDate(claimName); } if (requiredType == Date.class &amp;&amp; value instanceof Long) { value = new Date((Long) value); } if (!requiredType.isInstance(value)) { throw new RequiredTypeException(&quot;Expected value to be of type: &quot; + requiredType + &quot;, but was &quot; + value.getClass()); } return requiredType.cast(value); } } JwtTokenProvider.java package com.wx.video.utils; import javax.crypto.spec.SecretKeySpec; import com.alibaba.fastjson.JSONObject; import io.jsonwebtoken.Claims; import io.jsonwebtoken.CompressionCodecs; import io.jsonwebtoken.Jwts; import io.jsonwebtoken.SignatureAlgorithm; public class JwtTokenProvider { private SecretKeySpec key; public JwtTokenProvider(String key) { SecretKeySpec secretKeySpec = new SecretKeySpec(key.getBytes(), SignatureAlgorithm.HS512.getJcaName()); this.key = secretKeySpec; } public String createToken(Claims claims) { String compactJws = Jwts.builder().setPayload(JSONObject.toJSONString(claims)) .compressWith(CompressionCodecs.DEFLATE).signWith(SignatureAlgorithm.HS512, key).compact(); return compactJws; } public Claims parseToken(String token) { try { return Jwts.parser().setSigningKey(key).parseClaimsJws(token).getBody(); } catch (Exception e) { e.printStackTrace(); } return null; } } JwtUtils.java package com.wx.video.utils; import javax.servlet.http.HttpServletRequest; import org.springframework.beans.factory.annotation.Value; import org.springframework.stereotype.Component; import io.jsonwebtoken.Claims; @Component public class JwtUtils { @Value(&quot;${auth.jwtKey}&quot;) private String jwtKey; /** ** æ ¹æ®UserClaimsåˆ›å»ºJwtToken * @param userClaims * @return */ public String createToken(UserClaims userClaims) { JwtTokenProvider tokenProvider = new JwtTokenProvider(jwtKey); return tokenProvider.createToken(userClaims); } /** ** æ ¹æ®tokenè§£æå‡ºClaim * @param token * @return */ public Claims parseToken(String token) { JwtTokenProvider tokenProvider = new JwtTokenProvider(jwtKey); return tokenProvider.parseToken(token); } /** ** æ ¹æ®requestè¯·æ±‚ç›´æ¥è§£æå‡ºClaim * @param request * @return */ public Claims getUserClaim(HttpServletRequest request) { String token = request.getHeader(&quot;Authorization&quot;); JwtTokenProvider tokenProvider = new JwtTokenProvider(jwtKey); return tokenProvider.parseToken(token); } } æœ‰äº†ä¸Šé¢çš„å·¥å…·ç±»ï¼Œæ­£åœ¨çš„æˆæƒç™»å½•ä»£ç å°±å¾ˆç®€å•å•¦ï¼Œä»£ç å¦‚ä¸‹ï¼ˆä¸ºäº†æ–¹ä¾¿ç›´æ¥é˜…è¯»ï¼Œå°‘è´´ä¸€äº›ä»£ç ï¼Œé‡Œé¢éœ€è¦ç”¨åˆ°çš„å¸¸é‡ï¼Œæˆ‘å°±ä¸æå–ä¸å°è£…å•¦ï¼Œå®é™…å·¥ä½œå·¥ç¨‹ä¸­ï¼Œå¯ä»¥ä¸“é—¨åšä¸€ä¸ªç±»ï¼Œå­˜æ”¾æ‰€æœ‰çš„å¸¸é‡ï¼Œå¦‚appidï¼Œsecretç­‰ï¼Œç»Ÿä¸€ç®¡ç†ï¼‰ï¼š @Controller @RequestMapping(&quot;/api&quot;) public class UserController { @Autowired private UserService userService; @Autowired private VorderService vorderService; @Autowired private JwtUtils jwtUtils; @Autowired private RedisOperator redis; @PostMapping(&quot;/wxlogin&quot;) @ResponseBody public JsonResult wxlogin(@RequestBody Map&lt;String, Object&gt; map){ // é…ç½®è¯·æ±‚å‚æ•° Map&lt;String, String&gt; param = new HashMap&lt;&gt;(); param.put(&quot;appid&quot;, &quot;wx0fb11123456897544&quot;); param.put(&quot;secret&quot;, &quot;5c5e5efae856768878yb53976b&quot;); param.put(&quot;js_code&quot;, map.get(&quot;code&quot;).toString()); param.put(&quot;grant_type&quot;, &quot;authorization_code&quot;); // å‘é€è¯·æ±‚ String url = &quot;https://api.weixin.qq.com/sns/jscode2session&quot;; String wxResult = HttpClientUtil.doGet(url, param); JSONObject jsonObject = JSONObject.parseObject(wxResult); // è·å–å‚æ•°è¿”å›çš„ String sessionkey = jsonObject.get(&quot;session_key&quot;).toString(); String openid = jsonObject.get(&quot;openid&quot;).toString(); // æ ¹æ®è¿”å›çš„userå®ä½“ç±»ï¼Œåˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ˜¯æ–°ç”¨æˆ·ï¼Œä¸æ˜¯çš„è¯ï¼Œæ›´æ–°æœ€æ–°ç™»å½•æ—¶é—´ï¼Œæ˜¯çš„è¯ï¼Œå°†ç”¨æˆ·ä¿¡æ¯å­˜åˆ°æ•°æ®åº“ User user = userService.selectByOpenId(openid); System.out.println(&quot;æŸ¥è¯¢ç”¨æˆ·ç»“æœ&quot;+user); if(user != null){ user.setUname(map.get(&quot;uname&quot;).toString()); user.setUavatar(map.get(&quot;uavatar&quot;).toString()); user.setUgender(map.get(&quot;ugender&quot;).toString()); user.setUaddress(map.get(&quot;address&quot;).toString()); user.setSessionkey(sessionkey); //ä¿®æ”¹sessionKey user.setUpdateTime(new Date()); //ä¿®æ”¹æ›´æ–°æ—¶é—´ //æ›´æ–°æ•°æ®åº“ userService.update(user); }else{ User newUser = new User(); newUser.setOpenid(openid); newUser.setSessionkey(sessionkey); newUser.setUname(map.get(&quot;uname&quot;).toString()); newUser.setUavatar(map.get(&quot;uavatar&quot;).toString()); newUser.setUgender(map.get(&quot;ugender&quot;).toString()); newUser.setUaddress(map.get(&quot;address&quot;).toString()); newUser.setCreateTime(new Date()); // æ·»åŠ åˆ°æ•°æ®åº“ int count = userService.insert(newUser); if(count &lt; 0){ return JsonResult.error(&quot;æ’å…¥æ•°æ®å¤±è´¥&quot;); } } //è·å–åˆ°å½“å‰ç”¨æˆ·çš„æ•°æ®åº“uid User user1 = userService.selectByOpenId(openid); //ç”ŸæˆJWTtoken UserClaims userClaims = new UserClaims(); userClaims.setUid(user1.getUid()); userClaims.setOpenid(openid); String jwttoken = jwtUtils.createToken(userClaims); System.out.println(jwttoken); //å°†tokenå­˜å…¥Redis redis.set(jwttoken, sessionkey); // å°è£…è¿”å›å°ç¨‹åº Map&lt;String, String&gt; result = new HashMap&lt;&gt;(); result.put(&quot;token&quot;, jwttoken); return JsonResult.successs(result); } } æ³¨æ„ï¼š 1ã€ä¸Šæ–‡ä¸­ç”¨åˆ°çš„appidå’Œsecretéƒ½æ˜¯æˆ‘å†™çš„å‡å€¼ï¼Œéœ€è¦æ›¿æ¢ä¸ºè‡ªå·±çš„ï¼› 2ã€ç»Ÿä¸€è¿”å›ç»“æœæ•°æ®ç»“æ„ï¼Œè¿™ç§å®ç°æ–¹å¼å¾ˆå¤šï¼Œå°±æ˜¯æˆ‘é‡Œé¢å‡ºç°çš„JsonResultç±»ï¼› 3ã€éœ€è¦ç”¨åˆ°çš„Rediså·¥å…·ç±»ä¹Ÿè‡ªå·±å°è£…ä¸€ä¸‹ï¼Œè¿™ä¸ªå®ç°æ–¹æ³•ä¹Ÿä¸éº»çƒ¦ï¼Œä¸å½±å“æˆ‘ä»¬çš„æˆæƒç™»å½•æµç¨‹ï¼› ä¸Šé¢çš„ä»£ç å°±è¶³ä»¥å®Œæˆå¾®ä¿¡å°ç¨‹åºæˆæƒç™»é™†å•¦ï¼Œå°ç¨‹åºè·å–åˆ°tokenåï¼Œè®°å¾—å°†tokenå­˜å…¥æœ¬åœ°storageï¼Œåé¢è¿›è¡Œç™»å½•æ€æ ¡éªŒçš„è¯·æ±‚ï¼Œåœ¨Headerå¤´ä¸­è®¾ç½®Authorizationå€¼ä¸ºtokenï¼›åå°ä½¿ç”¨å°è£…å¥½çš„JwtUtilså·¥å…·ç±»ä¸­çš„getUserClaimæ–¹æ³•ï¼Œå°±å¯ä»¥ä»requestä¸­ç›´æ¥è§£æå‡ºClaimså¯¹è±¡ï¼Œé‡Œé¢å­˜æ”¾ç€æˆ‘ä»¬å°è£…è¿›å»çš„uidå’Œopenidï¼Œç„¶åå¼€å§‹å¤„ç†æˆ‘ä»¬çš„æ­£å¸¸ä¸šåŠ¡å•¦ï¼› ","link":"https://tianxiawuhao.github.io/pR59olYKQ/"},{"title":"ä¸€æ–‡å½»åº•å¼„æ‡‚ctx.close()å’Œctx.channel().close()çš„åŒºåˆ«","content":"ä¸€æ–‡å½»åº•å¼„æ‡‚ctx.close()å’Œctx.channel().close()çš„åŒºåˆ« å…ˆè¯´ç»“è®ºï¼š ctx.close()ï¼šåªä¼šæ€»å½“å‰å¤„ç†å™¨BHandlerå‡ºå‘ï¼Œå‘å‰å¯»æ‰¾å‡ºç«™Handlerï¼Œå¹¶è°ƒç”¨å®ƒä»¬çš„close()æ–¹æ³•ï¼› ctx.channel().close()ï¼šå°†ä»æ•´ä¸ªpipelineçš„tailå°¾éƒ¨å‘å‰å¯»æ‰¾æ‰€æœ‰çš„å‡ºç«™Handlerï¼Œå¹¶è°ƒç”¨å®ƒä»¬çš„close()æ–¹æ³•ï¼ ä¸€ã€ç¼–å†™æµ‹è¯•ä»£ç ï¼š 1ã€éœ€è¦å¼•å…¥çš„ä¾èµ–ï¼š &lt;dependency&gt; &lt;groupId&gt;io.netty&lt;/groupId&gt; &lt;artifactId&gt;netty-all&lt;/artifactId&gt; &lt;version&gt;4.1.70.Final&lt;/version&gt; &lt;/dependency&gt; 2ã€ç¼–å†™ä¸€ä¸ªåŒå‘å¤„ç†å™¨ZidanHandlerï¼š /** * ChannelDuplexHandlerï¼šåŒå‘å¤„ç†å™¨ï¼š * æ—¢ç»§æ‰¿äº†ChannelInboundHandlerAdapterç±»ï¼Œ * åˆå®ç°äº†ChannelOutboundHandleræ¥å£ã€‚ */ public class ZidanHandler extends ChannelDuplexHandler { @Override public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception { System.out.println(ctx.name() + &quot; channelRead: &quot; + msg); String result = (String) msg; if ((&quot;ctx.close.&quot; + ctx.name()).equals(result)) { ctx.close(); } else if ((&quot;ctx.channel.close.&quot; + ctx.name()).equals(result)) { ctx.channel().close(); } else { ctx.fireChannelRead(msg); } } @Override public void close(ChannelHandlerContext ctx, ChannelPromise promise) throws Exception { System.out.println(ctx.name() + &quot; close&quot;); ctx.close(promise); } @Override public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception { System.out.println(ctx.name() + &quot; write&quot;); ctx.write(String.format(&quot;[%s]%s&quot;, ctx.name(), msg), promise); } } 3ã€ä¸»å…¥å£ç±»NettyServerï¼š public class NettyServer { public static void main(String[] args) throws InterruptedException { NioEventLoopGroup boss = new NioEventLoopGroup(1); NioEventLoopGroup worker = new NioEventLoopGroup(3); new ServerBootstrap() .channel(NioServerSocketChannel.class) .group(boss, worker) .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() { @Override protected void initChannel(SocketChannel socketChannel) throws Exception { socketChannel.pipeline() .addLast(&quot;decoder&quot;, new StringDecoder()) .addLast(&quot;encoder&quot;, new StringEncoder()) .addLast(&quot;A&quot;, new ZidanHandler()) .addLast(&quot;B&quot;, new ZidanHandler()) .addLast(&quot;C&quot;, new ZidanHandler()); } }).bind(8090).sync(); } } äºŒã€å¯åŠ¨é¡¹ç›®ï¼Œè¿›è¡Œæµ‹è¯•çœ‹ç°è±¡ 1ã€é¡¹ç›®å¯åŠ¨åï¼Œæˆ‘ä»¬ä½¿ç”¨æœ¬åœ°çš„telnetå‘½ä»¤ä½œä¸ºå®¢æˆ·ç«¯è¿›è¡Œäº¤äº’ï¼š C:\\Users\\admin&gt;telnet localhost 8090 # é‡ç‚¹ï¼Œè¿›å…¥telnetçª—å£åï¼Œæˆ‘ä»¬éœ€è¦æŒ‰ä¸‹ Ctrl + ]é”® æ¬¢è¿ä½¿ç”¨ Microsoft Telnet Client Escape å­—ç¬¦ä¸º 'CTRL+]' Microsoft Telnet&gt; 2ã€æˆ‘ä»¬å…ˆç”¨telnetå‘é€â€œctx.close.Bâ€å­—ç¬¦ä¸²ï¼š 3ã€æˆ‘ä»¬å†ç”¨telnetå‘é€â€œctx.channel.close.Bâ€å­—ç¬¦ä¸²ï¼š 4ã€æ ¹æ®ç°è±¡å¾—å‡ºç»“è®ºï¼š ctx.close()ï¼šåªä¼šæ€»å½“å‰å¤„ç†å™¨BHandlerå‡ºå‘ï¼Œå‘å‰å¯»æ‰¾å‡ºç«™Handlerï¼Œå¹¶è°ƒç”¨å®ƒä»¬çš„close()æ–¹æ³•ï¼› ctx.channel().close()ï¼šå°†ä»æ•´ä¸ªpipelineçš„tailå°¾éƒ¨å‘å‰å¯»æ‰¾æ‰€æœ‰çš„å‡ºç«™Handlerï¼Œå¹¶è°ƒç”¨å®ƒä»¬çš„close()æ–¹æ³•ï¼ ä¸‰ã€é€šè¿‡æºç å¼„æ˜ç™½ä¸ºä»€ä¹ˆ 1ã€ctx.close() çš„æºç ï¼š abstract class AbstractChannelHandlerContext implements ChannelHandlerContext, ResourceLeakHint { public ChannelFuture close() { return this.close(this.newPromise()); } public ChannelFuture close(final ChannelPromise promise) { if (this.isNotValidPromise(promise, false)) { return promise; } else { // è·å–ä¸‹ä¸€ä¸ªå‡ºç«™Handlerï¼ˆå‡ºç«™æ˜¯å‘å‰ï¼Œæ‰€ä»¥å®é™…æ˜¯å‰ä¸€ä¸ªï¼‰ final AbstractChannelHandlerContext next = this.findContextOutbound(4096); EventExecutor executor = next.executor(); if (executor.inEventLoop()) { next.invokeClose(promise); } else { safeExecute(executor, new Runnable() { public void run() { next.invokeClose(promise); } }, promise, (Object)null, false); } return promise; } } private AbstractChannelHandlerContext findContextOutbound(int mask) { AbstractChannelHandlerContext ctx = this; EventExecutor currentExecutor = this.executor(); do { // æ‰¾å‡ºå½“å‰handlerContextçš„prevå‰ä¸€ä¸ªhandlerContext // ä½†æ˜¯ä¼šè·³è¿‡ä¸æ˜¯Outboundçš„é‚£äº›handler ctx = ctx.prev; } while(skipContext(ctx, currentExecutor, mask, 130560)); return ctx; } } 2ã€ctx.channel().close() çš„æºç ï¼š public abstract class AbstractChannel extends DefaultAttributeMap implements Channel { public ChannelFuture close() { return this.pipeline.close(); } public final ChannelFuture close() { // å…¶å®åˆ°è¿™é‡Œå·²ç»å¾ˆæ¸…æ™°äº†ï¼Œä»å½“å‰æ•´ä¸ªpipelineä¸­çš„tailå°¾èŠ‚ç‚¹å¼€å§‹ï¼Œå‘å‰å¯»æ‰¾å‡ºç«™handlerï¼Œ // å¹¶æ‰§è¡Œä»–ä»¬çš„close()æ–¹æ³• return this.tail.close(); } } å››ã€æ€»ç»“ï¼š 1ã€é‚£ä¹ˆæˆ‘ä»¬ä½•æ—¶ä½¿ç”¨ctx.close()ï¼Œåˆä½•æ—¶ä½¿ç”¨ctx.channel().close()æ–¹æ³•å‘¢ï¼š å¦‚æœä½ æ­£å†™ä¸€ä¸ª ChannelHandler, å¹¶ä¸”åœ¨å¤„ç†é€»è¾‘æ—¶ï¼Œæƒ³åœ¨è¿™ä¸ª handler ä¸­å…³é—­ channel, åˆ™ç›´æ¥è°ƒç”¨ ctx.close()ï¼› å¦‚æœä½ æ­£å‡†å¤‡ä»ä¸€ä¸ªå¤–éƒ¨çš„ handler (ä¾‹å¦‚, ä½ æœ‰ä¸€ä¸ªåå°çš„éI/Oçº¿ç¨‹, å¹¶ä¸”ä½ æƒ³ä»è¯¥çº¿ç¨‹ä¸­å…³é—­è¿æ¥)ï¼Œé‚£ä¹ˆå°±å¯ä»¥è°ƒç”¨ctx.Channel.close()); ä½†æ˜¯è¿™ç§è§„åˆ™ä¹Ÿæ˜¯éç»å¯¹çš„ï¼ 2ã€å…¶ä»–ç±»ä¼¼çš„æ–¹æ³•å¯¹ï¼š ctx.write() ä¸ ctx.channel().write() ctx.writeAndFlush() ä¸ ctx.channel().writeAndFlush() ","link":"https://tianxiawuhao.github.io/RokgvWufI/"},{"title":"Actuatorç›‘æ§ï¼Œå¹¶é›†æˆPrometheus/Grafanaå±•ç¤ºï¼ˆå®æˆ˜ï¼‰","content":"ä¸€ã€åŸºç¡€æ¦‚å¿µ 1ã€ä½•ä¸ºâ€œå¯è§‚æµ‹æ€§Observabilityâ€ï¼Ÿ å¯è§‚æµ‹æ€§Observabilityï¼šå¯¹çº¿ä¸Šçš„åº”ç”¨è¿›è¡Œè§‚æµ‹ã€ç›‘æ§ã€é¢„è­¦ç­‰ï¼š å¥åº·çŠ¶å†µ Healthï¼šã€ç»„ä»¶çŠ¶æ€ã€å­˜è´§çŠ¶æ€ã€‘ç­‰ï¼› è¿è¡ŒæŒ‡æ ‡ Metricsï¼šã€cpuã€å†…å­˜ã€åƒåœ¾å›æ”¶ã€ååé‡ã€å“åº”æˆåŠŸç‡ã€‘ç­‰ï¼› é“¾è·¯è¿½è¸ªç­‰ï¼› 2ã€Springbootä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå¼€ç®±å³ç”¨çš„å¯è§‚æµ‹æ€§è§£å†³æ–¹æ¡ˆï¼š &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt; &lt;/dependency&gt; äºŒã€åˆå§‹åŒ–ä¸€ä¸ªSpringboot3é¡¹ç›® åˆ›å»ºå®Œæˆåçš„pom.xmlæ–‡ä»¶å¦‚ä¸‹ï¼š &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;parent&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt; &lt;version&gt;3.1.1&lt;/version&gt; &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt; &lt;/parent&gt; &lt;groupId&gt;com.jiguiquan.www&lt;/groupId&gt; &lt;artifactId&gt;actuator&lt;/artifactId&gt; &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt; &lt;name&gt;actuator&lt;/name&gt; &lt;description&gt;actuator&lt;/description&gt; &lt;properties&gt; &lt;java.version&gt;17&lt;/java.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;optional&gt;true&lt;/optional&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.graalvm.buildtools&lt;/groupId&gt; &lt;artifactId&gt;native-maven-plugin&lt;/artifactId&gt; &lt;/plugin&gt; &lt;plugin&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt; &lt;configuration&gt; &lt;excludes&gt; &lt;exclude&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;/exclude&gt; &lt;/excludes&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt; &lt;/project&gt; ä¸‰ã€æ¼”ç¤ºActuatorçš„ç®€å•ä½¿ç”¨/å¸¸ç”¨ç«¯ç‚¹ 1ã€åœ¨ application.yml ä¸­å¢åŠ å¦‚ä¸‹é…ç½®ï¼š management: endpoints: web: exposure: include: '*' # é€šè¿‡webæ–¹å¼ï¼Œæš´éœ²æ‰€æœ‰ç«¯ç‚¹ 2ã€æ­¤æ—¶æˆ‘ä»¬åœ¨è¿è¡Œï¼Œå³å¯çœ‹åˆ° /actuator æ¥å£æš´éœ²äº†å¾ˆå¤šç«¯ç‚¹ï¼š å…¶ä¸­ï¼Œä¸€åˆ‡å¸¸ç”¨çš„ç«¯ç‚¹ä»‹ç»ï¼š /actuator/healthï¼šå¥åº·çŠ¶å†µçš„ç«¯ç‚¹ï¼› /actuator/metricsï¼šæŒ‡æ ‡æ•°æ®ï¼› /actuator/beansï¼šå½“å‰IOCå®¹å™¨ä¸­æœ‰å¤šå°‘Beanï¼› /actuator/cachesï¼šæœåŠ¡å½“å‰çš„ç¼“å­˜æƒ…å†µï¼› /actuator/conditionï¼šå½“å‰æœåŠ¡ä¸­æ¶‰åŠåˆ°çš„æ¡ä»¶ï¼Œå“ªäº›æ¡ä»¶æ˜¯æ»¡è¶³çš„ï¼Œå“ªäº›æ¡ä»¶æ˜¯æ²¡æ»¡è¶³çš„ï¼› å…¶ä¸­æœ€é‡è¦çš„ï¼š/actuator/metrics æŒ‡æ ‡ä¿¡æ¯ï¼š å¦‚æœæˆ‘ä»¬æƒ³çœ‹æŸä¸ªæŒ‡æ ‡çš„è¯¦ç»†ä¿¡æ¯ï¼š/actuator/metrics/æŒ‡æ ‡å æœ‰äº†è¿™äº›æŒ‡æ ‡ä¿¡æ¯ï¼Œæˆ‘ä»¬ä»¥åæ„å»ºè‡ªå·±çš„ç›‘æ§å¹³å°é¢æ¿å°†ä¼šå˜å¾—éå¸¸å®¹æ˜“ï¼ 3ã€ä»¥ä¸‹ä»¥è¡¨æ ¼å½¢å¼åˆ—ä¸¾æˆ‘ä»¬å·¥ä½œä¸­å¯èƒ½ä¼šç”¨åˆ°çš„ç«¯ç‚¹ï¼š **ç«¯ç‚¹ ** æè¿° auditevents æš´éœ²å½“å‰åº”ç”¨ç¨‹åºçš„å®¡æ ¸äº‹ä»¶ä¿¡æ¯ã€‚éœ€è¦ä¸€ä¸ªAuditEventRepositoryç»„ä»¶ã€‚ beans æ˜¾ç¤ºåº”ç”¨ç¨‹åºä¸­æ‰€æœ‰Spring Beançš„å®Œæ•´åˆ—è¡¨ã€‚ caches æš´éœ²å½“å‰çš„ç¼“å­˜æƒ…å†µã€‚ conditions æ˜¾ç¤ºè‡ªåŠ¨é…ç½®çš„æ‰€æœ‰æ¡ä»¶ä¿¡æ¯ï¼ŒåŒ…æ‹¬åŒ¹é…æˆ–ä¸åŒ¹é…çš„åŸå› ã€‚ configprops æ˜¾ç¤ºæ‰€æœ‰@ConfigurationPropertiesã€‚ env æš´éœ²Springçš„å±æ€§ConfigurableEnvironment flyway æ˜¾ç¤ºå·²åº”ç”¨çš„æ‰€æœ‰Flywayæ•°æ®åº“è¿ç§»ï¼Œéœ€è¦ä¸€ä¸ªæˆ–å¤šä¸ªFlywayç»„ä»¶ã€‚ health æ˜¾ç¤ºåº”ç”¨ç¨‹åºè¿è¡ŒçŠ¶å†µä¿¡æ¯ã€‚ httptrace æ˜¾ç¤ºHTTPè·Ÿè¸ªä¿¡æ¯ï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼Œæœ€è¿‘100ä¸ªHTTPè¯·æ±‚-å“åº”ï¼‰ã€‚éœ€è¦ä¸€ä¸ªHttpTraceRepositoryç»„ä»¶ã€‚ info æ˜¾ç¤ºåº”ç”¨ç¨‹åºä¿¡æ¯ã€‚ integrationgraph æ˜¾ç¤ºSpring integrationgraph ã€‚éœ€è¦ä¾èµ–spring-integration-coreã€‚ loggers æ˜¾ç¤ºå’Œä¿®æ”¹åº”ç”¨ç¨‹åºä¸­æ—¥å¿—çš„é…ç½®ã€‚ liquibase æ˜¾ç¤ºå·²åº”ç”¨çš„æ‰€æœ‰Liquibaseæ•°æ®åº“è¿ç§»ã€‚éœ€è¦ä¸€ä¸ªæˆ–å¤šä¸ªLiquibaseç»„ä»¶ã€‚ metrics æ˜¾ç¤ºå½“å‰åº”ç”¨ç¨‹åºçš„â€œæŒ‡æ ‡â€ä¿¡æ¯ã€‚ mappings æ˜¾ç¤ºæ‰€æœ‰@RequestMappingè·¯å¾„åˆ—è¡¨ã€‚ scheduledtasks æ˜¾ç¤ºåº”ç”¨ç¨‹åºä¸­çš„è®¡åˆ’ä»»åŠ¡ã€‚ sessions å…è®¸ä»Spring Sessionæ”¯æŒçš„ä¼šè¯å­˜å‚¨ä¸­æ£€ç´¢å’Œåˆ é™¤ç”¨æˆ·ä¼šè¯ã€‚éœ€è¦ä½¿ç”¨Spring Sessionçš„åŸºäºServletçš„Webåº”ç”¨ç¨‹åºã€‚ shutdown ä½¿åº”ç”¨ç¨‹åºæ­£å¸¸å…³é—­ã€‚é»˜è®¤ç¦ç”¨ã€‚ startup æ˜¾ç¤ºç”±ApplicationStartupæ”¶é›†çš„å¯åŠ¨æ­¥éª¤æ•°æ®ã€‚éœ€è¦ä½¿ç”¨SpringApplicationè¿›è¡Œé…ç½®BufferingApplicationStartupã€‚ threaddump æ‰§è¡Œçº¿ç¨‹è½¬å‚¨ã€‚ heapdump è¿”å›hprofå †è½¬å‚¨æ–‡ä»¶ã€‚ jolokia é€šè¿‡HTTPæš´éœ²JMX beanï¼ˆéœ€è¦å¼•å…¥Jolokiaï¼Œä¸é€‚ç”¨äºWebFluxï¼‰ã€‚éœ€è¦å¼•å…¥ä¾èµ–jolokia-coreã€‚ logfile è¿”å›æ—¥å¿—æ–‡ä»¶çš„å†…å®¹ï¼ˆå¦‚æœå·²è®¾ç½®logging.file.nameæˆ–logging.file.pathå±æ€§ï¼‰ã€‚æ”¯æŒä½¿ç”¨HTTPRangeæ ‡å¤´æ¥æ£€ç´¢éƒ¨åˆ†æ—¥å¿—æ–‡ä»¶çš„å†…å®¹ã€‚ prometheus ä»¥PrometheusæœåŠ¡å™¨å¯ä»¥æŠ“å–çš„æ ¼å¼å…¬å¼€æŒ‡æ ‡ã€‚éœ€è¦ä¾èµ–micrometer-registry-prometheusã€‚ å››ã€è‡ªå®šä¹‰ç›‘æ§ç«¯ç‚¹ é¦–å…ˆï¼Œå¦‚æœæƒ³ç›‘æ§è¯¦ç»†çš„å¥åº·çŠ¶å†µï¼Œæˆ‘ä»¬é…ç½®æ–‡ä»¶ä¸­è¿˜å¾—å¢åŠ ä¸€äº›é…ç½®ï¼š management: endpoints: web: exposure: include: '*' # é€šè¿‡webæ–¹å¼ï¼Œæš´éœ²æ‰€æœ‰ç«¯ç‚¹ endpoint: health: # å¦‚æœæƒ³å±•ç¤ºæ‰€æœ‰ç»„ä»¶å¥åº·çŠ¶å†µçš„è¯¦ç»†ä¿¡æ¯ï¼Œä¸‹é¢ä¸¤é¡¹å¿…é¡»é…ç½®ï¼Œå¦åˆ™/healthç«¯ç‚¹åªä¼šå±•ç¤ºå½“å‰æœåŠ¡çš„å­˜æ´»æƒ…å†µ enabled: true show-details: always 1ã€è‡ªå®šä¹‰å¥åº·ç›‘æ§Healthç«¯ç‚¹ï¼ˆ å­˜æ´»/æ­»äº¡ ï¼‰ï¼šæ ¸å¿ƒ HealthIndicator ç›®æ ‡ï¼šç›‘æ§ ZidanService è¿™ä¸ªç»„ä»¶çš„å¥åº·çŠ¶å†µï¼š è¢«ç›‘æ§ç»„ä»¶ï¼šZidanService.javaï¼š @Service public class ZidanService { // éšæœºè¿”å›ä¸€ä¸ªæ•´æ•°ï¼Œä½œä¸ºå¥åº·æ£€æŸ¥çš„ä¾æ® public int check(){ return new Random().nextInt(); } } å¥åº·çŠ¶å†µç›‘æ§å™¨ç±»ï¼š /** * æ–¹æ³•1ã€åªéœ€è¦å®ç°HealthIndicatoræ¥å£ä¸­çš„health()æ–¹æ³•ï¼Œå³å¯æ¥å®šåˆ¶ç»„ä»¶çš„å¥åº·çŠ¶æ€ï¼› * æ–¹æ³•2ã€æˆ–è€…ç»§æ‰¿AbstractHealthIndicatoræŠ½è±¡ç±»ï¼Œå®ç°å…¶doHealthCheck()æŠ½è±¡æ–¹æ³•å³å¯ï¼ */ @Component //public class ZidanServiceHealthIndicator implements HealthIndicator { public class ZidanServiceHealthIndicator extends AbstractHealthIndicator { @Autowired private ZidanService zidanService; @Override protected void doHealthCheck(Health.Builder builder) throws Exception { // è°ƒç”¨è¿™ä¸ªç»„ä»¶çš„checkæ–¹æ³•ï¼Œç„¶åæ ¹æ®è¿”å›ç»“æœï¼Œæ„å»ºå‡ºä¸€ä¸ªå­˜æ´»ç»“æœ int result = zidanService.check(); // æˆ‘ä»¬å°±å‡è®¾ï¼Œå¦‚æœresultæ˜¯å¶æ•°ï¼Œåˆ™å­˜æ´»ï¼Œæ˜¯å¥‡æ•°ï¼Œåˆ™æ­»äº¡ if ((result % 2) == 0) { builder.up() .withDetail(&quot;code&quot;, &quot;200&quot;) .withDetail(&quot;msg&quot;, &quot;æ´»å¾—å¾ˆå¥½&quot;) .withDetail(&quot;data&quot;, &quot;æˆ‘æ˜¯å‰è€æ¿&quot;) .build(); } else { builder.down() .withDetail(&quot;code&quot;, &quot;500&quot;) .withDetail(&quot;msg&quot;, &quot;æˆ‘ä¸å¤ªå¥½&quot;) .withDetail(&quot;data&quot;, &quot;å˜¿å˜¿&quot;) .build(); } } } æ­¤æ—¶ï¼Œæˆ‘ä»¬å†è§è°ƒç”¨Healthç«¯ç‚¹ï¼Œå°±å¯ä»¥çœ‹åˆ°ZidanServiceè¿™ä¸ªç»„ä»¶çš„å¥åº·çŠ¶å†µäº†ï¼š 2ã€è‡ªå®šä¹‰æŒ‡æ ‡ç›‘æ§Metricsç«¯ç‚¹ï¼ˆ æ¬¡æ•°ã€ç‡ ï¼‰ï¼šæ ¸å¿ƒ MeterRegistry ç›®æ ‡ï¼šç›‘æ§DemoController.demo()æ–¹æ³•è¢«è°ƒç”¨äº†å¤šå°‘æ¬¡ï¼ DemoController.javaï¼š @RestController public class DemoController { Counter counter; // é€šè¿‡æ„é€ æ–¹æ³•ï¼Œæ³¨å…¥MeterRegistryï¼Œä»è€Œç»™counterè®¡æ•°å™¨èµ‹å€¼ public DemoController(MeterRegistry meterRegistry){ counter = meterRegistry.counter(&quot;jiguiquan.demo&quot;); } @GetMapping(&quot;/demo&quot;) public void demo(){ counter.increment(); System.out.println(&quot;demoæ¥å£è¢«è°ƒç”¨äº† &quot; + counter.count() + &quot; æ¬¡&quot;); } } æ­¤æ—¶ï¼Œæˆ‘ä»¬è®¿é—® /metrics/jiguiquan.demo ç«¯ç‚¹ï¼Œå°±èƒ½çœ‹åˆ°æˆ‘ä»¬è‡ªå®šä¹‰çš„è®¡æ•°æŒ‡æ ‡ä¿¡æ¯ï¼ äº”ã€æ•´åˆPrometheus + Grafana 1ã€éœ€è¦æ•´åˆPrometheusï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦åœ¨é¡¹ç›®ä¸­å¼•å…¥æ•´åˆPrometheusçš„ä¾èµ–ï¼š è¿™ä¸ªä¾èµ–å¯ä»¥æ˜¯ /metrics/prometheus ç«¯ç‚¹è¿”å›é€‚é…Prometheusçš„æ•°æ®ç»“æ„ï¼š &lt;dependency&gt; &lt;groupId&gt;io.micrometer&lt;/groupId&gt; &lt;artifactId&gt;micrometer-registry-prometheus&lt;/artifactId&gt; &lt;version&gt;1.10.6&lt;/version&gt; &lt;/dependency&gt; 2ã€æµ‹è¯• /prometheus çš„ç«¯ç‚¹æ˜¯å¦æ­£å¸¸è·å–åˆ°æ•°æ®ï¼š 3ã€æ²¡æœ‰é—®é¢˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç°åœ¨å°±å°†æˆ‘ä»¬çš„ä»£ç æ‹·è´åˆ°æœåŠ¡å™¨ä¸Šï¼Œè¿›è¡Œæ‰“åŒ…ç¼–è¯‘ï¼š # å°†ä»£ç æ‹·è´åˆ°æœåŠ¡å™¨çš„/code/ç›®å½•ä¸‹ [root actuator]# pwd /code/actuator [root actuator]# ls pom.xml src # 3ä¸ªå‘½ä»¤ï¼Œå°†actuatoré¡¹ç›®æ‰“åŒ…æˆäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼š mvn clean package -DskipTests mvn spring-boot:process-aot mvn -Pnative native:build 4ã€é€šè¿‡ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¿«é€Ÿå¯åŠ¨actuatoré¡¹ç›®ï¼š åå°å¯åŠ¨ï¼š # äºŒè¿›åˆ¶æ–‡ä»¶å¯åŠ¨ nohup target/actuator &gt;actuator.log 2&gt;&amp;1 &amp; ## å¦‚æœæ˜¯jaråŒ…ç›´æ¥å¯åŠ¨ï¼š nohup java -jar target/actuator-0.0.1-SNAPSHOT.jar &gt;actuator.log 2&gt;&amp;1 &amp; æœåŠ¡è¿è¡Œæ­£å¸¸ï¼ å…­ã€é…ç½®Prometheusï¼Œä»actuatoræœåŠ¡çš„/prometheusç«¯ç‚¹ä¸Šå®šæ—¶æ‹‰å–æ•°æ®ï¼š 1ã€å°†Prometheusä¸‹è½½å¹¶è§£å‹åˆ°æœåŠ¡å™¨çš„æŒ‡å®šä½ç½®ï¼š [root prometheus]# ls grafana-8.3.6 prometheus-2.37.8 [root prometheus]# cd prometheus-2.37.8/ [root prometheus-2.37.8]# ls console_libraries consoles LICENSE NOTICE prometheus prometheus.yml promtool 2ã€ä¿®æ”¹Prometheusçš„æ ¸å¿ƒé…ç½®æ–‡ä»¶prometheus.ymlï¼Œæ·»åŠ ä¸€ä¸ªæ–°ä»»åŠ¡ï¼š # my global config global: scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute. evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute. # scrape_timeout is set to the global default (10s). # Alertmanager configuration alerting: alertmanagers: - static_configs: - targets: # - alertmanager:9093 # Load rules once and periodically evaluate them according to the global 'evaluation_interval'. rule_files: # - &quot;first_rules.yml&quot; # - &quot;second_rules.yml&quot; # A scrape configuration containing exactly one endpoint to scrape: # Here it's Prometheus itself. scrape_configs: # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config. - job_name: &quot;prometheus&quot; static_configs: - targets: [&quot;localhost:9090&quot;] # è¿™å°±æ˜¯æˆ‘ä»¬çš„æœåŠ¡çš„ç«¯å£ï¼Œå› ä¸ºåŸå®šçš„9090å’Œprometheuså†²çªäº†ï¼Œæ‰€ä»¥æˆ‘è¿™é‡Œå·²ç»è°ƒæ•´äº†actuatorçš„ç«¯å£ - job_name: &quot;actuator&quot; metrics_path: '/actuator/prometheus' #æŒ‡å®šæŠ“å–çš„è·¯å¾„ static_configs: - targets: [&quot;localhost:10000&quot;] labels: nodename: 'actuator-demo' 3ã€nohupåå°å¯åŠ¨prometheusæœåŠ¡ï¼š nohup ./prometheus --config.file=prometheus.yml &gt; prometheus.log 2&gt;&amp;1 &amp; 4ã€è®¿é—® http://ip:9090/targetsç«¯ç‚¹ï¼Œå¯ä»¥æŸ¥çœ‹æ•°æ®é‡‡é›†æƒ…å†µï¼š æ•°æ®é‡‡é›†æ­£å¸¸ï¼ ä¸ƒã€é…ç½®Grafanaé¢æ¿ï¼Œå±•ç¤ºactuatoræœåŠ¡ç›‘æ§çŠ¶æ€ 1ã€ä¾ç„¶æ˜¾ç¤ºå°†Grafanaä¸‹è½½è§£å‹åˆ°æœåŠ¡å™¨çš„æŒ‡å®šä½ç½®ï¼š [root prometheus]# ls grafana-8.3.6 prometheus-2.37.8 [root prometheus]# cd grafana-8.3.6/ [root grafana-8.3.6]# ls bin conf LICENSE NOTICE.md plugins-bundled public README.md scripts VERSION 2ã€æš‚æ—¶æˆ‘ä»¬ä¸ä¿®æ”¹Gafanaçš„é…ç½®æ–‡ä»¶ï¼Œç›´æ¥nohupåå°è¿è¡Œï¼š nohup` `bin``/grafana-server` `&gt; grafana.log 2&gt;&amp;1 &amp; 3ã€é€šè¿‡ http://ip:3000 è®¿é—®GrafanaæœåŠ¡ï¼š Grafanaé»˜è®¤è´¦å·å¯†ç ä¸ºï¼šadmin ï¼šadminï¼Œç™»å½•æ—¶æˆ‘ä»¬å¯ä»¥ä¿®æ”¹ä¸‹æ¬¡å¯†ç ï¼Œä¹Ÿå¯ä»¥Skipè·³è¿‡ï¼ 4ã€ç™»å½•åï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å…ˆé…ç½®ä¸€ä¸ªPrometheusæ•°æ®æºï¼š 5ã€å»å®˜æ–¹Dashboardå¸‚åœºæ‰¾ä¸€ä¸ªå¥½çœ‹çš„ä»ªè¡¨æ¿ï¼ˆå¦‚æœæœ‰å®åŠ›ï¼Œä¹Ÿå¯ä»¥è‡ªå·±æ­å»ºï¼‰ï¼š å®˜ç½‘Dashboardä¸‹è½½é¡µé¢ï¼šhttps://grafana.com/grafana/dashboards/ æˆ‘é€‰æ‹©çš„æ˜¯è¿™ä¸ªï¼šhttps://grafana.com/grafana/dashboards/12900-springboot-apm-dashboard/ å¤åˆ¶å®ƒçš„Dashboard IDæˆ–è€…ä¸‹è½½JSONæ–‡ä»¶éƒ½å¯ä»¥ï¼š 6ã€åœ¨Grafanaä¸­å¯¼å…¥Dashboardï¼š 7ã€é…ç½®å®Œæˆåçš„æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š åˆ°è¿™é‡Œï¼Œæ•´ä¸ªSpringbooté¡¹ç›®çš„æŒ‡æ ‡ç›‘æ§å…¨æµç¨‹å°±èµ°é€šäº†ï¼Œä»¥åçš„é¡¹ç›®ä¸­ï¼Œå¯ä»¥é€‚å½“çš„æš´éœ²è¿™äº›ç›‘æ§ç«¯ç‚¹å“¦ï¼Œè¿˜å¯ä»¥è‡ªå®šä¹‰è‡ªå·±çš„â€œå¥åº·çŠ¶å†µâ€æˆ–â€œè¿è¡ŒæŒ‡æ ‡â€ä¿¡æ¯ï¼ ","link":"https://tianxiawuhao.github.io/VgW7Mfe6w/"},{"title":"åŸºäºPostgreSQLçš„æ—¶åºæ•°æ®åº“TimescaleDBçš„åŸºæœ¬ç”¨æ³•å’Œæ¦‚å¿µ","content":"æ—¶åºæ•°æ®æ˜¯æŒ‡æŒ‰ç…§æ—¶é—´é¡ºåºå­˜å‚¨çš„æ•°æ®,TimescaleDBæ˜¯ä¸€ä¸ªå¼€æºçš„ã€æ‰©å±•äº†PostgreSQLçš„æ—¶åºæ•°æ®åº“æ‰©å±•,æœ¬æ–‡å°±ç»™å¤§å®¶è¯¦ç»†çš„ä»‹ç»ä¸€ä¸‹åŸºäºPostgreSQLçš„æ—¶åºæ•°æ®åº“TimescaleDBçš„åŸºæœ¬ç”¨æ³•å’Œæ¦‚å¿µ,éœ€è¦çš„æœ‹å‹å¯ä»¥å‚è€ƒä¸‹ ç›®å½• ä¸€ã€TimescaleDBæ¦‚è¿° äºŒã€å®‰è£…å’Œé…ç½® ä¸‰ã€æ•°æ®å†™å…¥å’ŒæŸ¥è¯¢ å››ã€è¿ç»­èšé›†è¡¨ äº”ã€åˆ†åŒºç®¡ç† å…­. ç»¼åˆä½¿ç”¨ç¤ºä¾‹ ä¸ƒã€å°ç»“ä¸€ä¸‹ æ—¶åºæ•°æ®æ˜¯æŒ‡æŒ‰ç…§æ—¶é—´é¡ºåºå­˜å‚¨çš„æ•°æ®ã€‚å®ƒåœ¨å¾ˆå¤šé¢†åŸŸå¾—åˆ°å¹¿æ³›åº”ç”¨ï¼Œä¾‹å¦‚ç‰©è”ç½‘ã€æ—¥å¿—åˆ†æã€é‡‘èäº¤æ˜“ç­‰ã€‚ä¸ºäº†é«˜æ•ˆå¤„ç†æ—¶åºæ•°æ®ï¼ŒTimescaleDBåº”è¿è€Œç”Ÿã€‚TimescaleDBæ˜¯ä¸€ä¸ªå¼€æºçš„ã€æ‰©å±•äº†PostgreSQLçš„æ—¶åºæ•°æ®åº“æ‰©å±•ï¼Œå®ƒç»“åˆäº†å…³ç³»å‹æ•°æ®åº“å’Œæ—¶åºæ•°æ®åº“çš„ä¼˜åŠ¿ï¼Œæä¾›äº†æ›´å¥½çš„æ—¶åºæ•°æ®ç®¡ç†å’Œåˆ†æèƒ½åŠ›ã€‚ æ—¶é—´åºåˆ—æ•°æ®çš„æŒ‘æˆ˜ï¼š æ—¶é—´åºåˆ—æ•°æ®æ˜¯æŒ‡æŒ‰æ—¶é—´é¡ºåºæ”¶é›†å’Œè®°å½•çš„æ•°æ®ï¼Œå¦‚ä¼ æ„Ÿå™¨ã€æ—¥å¿—ã€é‡‘èæ•°æ®ç­‰ã€‚è¿™ç±»æ•°æ®åœ¨ç°å®ç”Ÿæ´»ä¸­å¹¿æ³›å­˜åœ¨ï¼Œä½†å¯¹äºä¼ ç»Ÿæ•°æ®åº“ç³»ç»Ÿæ¥è¯´ï¼Œå¤„ç†å¤§è§„æ¨¡å’Œé«˜æ€§èƒ½çš„æ—¶é—´åºåˆ—æ•°æ®æ˜¯ä¸€é¡¹å…·æœ‰æŒ‘æˆ˜æ€§çš„ä»»åŠ¡ã€‚ TimescaleDBçš„å‡ºç°ï¼š TimescaleDBæ˜¯ä¸€ä¸ªæ„å»ºåœ¨PostgreSQLä¹‹ä¸Šçš„å¼€æºæ—¶é—´åºåˆ—æ•°æ®åº“ï¼Œå®ƒé‡‡ç”¨äº†ä¸€ç§åˆ›æ–°çš„æ–¹æ³•æ¥è§£å†³ä¼ ç»Ÿæ•°æ®åº“åœ¨å¤„ç†æ—¶é—´åºåˆ—æ•°æ®æ–¹é¢çš„é™åˆ¶ã€‚TimescaleDBåˆ©ç”¨äº†PostgreSQLçš„å¼ºå¤§åŠŸèƒ½ï¼Œå¹¶é€šè¿‡æ‰©å±•è¶…çº§è¡¨çš„æ–¹å¼æä¾›äº†æ›´å¥½çš„æ€§èƒ½å’Œå¯æ‰©å±•æ€§ã€‚ ä¸€ã€TimescaleDBæ¦‚è¿° TimescaleDBæ˜¯ä¸€ä¸ªåœ¨PostgreSQLä¹‹ä¸Šæ„å»ºçš„æ—¶åºæ•°æ®åº“ï¼Œå®ƒåˆ©ç”¨äº†å…³ç³»å‹æ•°æ®åº“çš„æˆç†Ÿæ€§å’Œçµæ´»æ€§ï¼Œå¹¶é’ˆå¯¹æ—¶åºæ•°æ®è¿›è¡Œäº†ä¼˜åŒ–ã€‚TimescaleDBé€šè¿‡ä½¿ç”¨åˆ†åŒºè¡¨ï¼ˆhypertableï¼‰å’Œè¿ç»­èšé›†è¡¨ï¼ˆcontinuous aggregateï¼‰æ¥å¤„ç†æ—¶åºæ•°æ®ï¼Œä½¿å¾—æ•°æ®çš„å­˜å‚¨å’ŒæŸ¥è¯¢æ›´åŠ é«˜æ•ˆã€‚ äºŒã€å®‰è£…å’Œé…ç½® 1. å®‰è£…TimescaleDBæ’ä»¶ å®‰è£…TimescaleDBå¯ä»¥é€šè¿‡åœ¨PostgreSQLä¸ŠåŠ è½½TimescaleDBæ’ä»¶æ¥å®Œæˆã€‚é¦–å…ˆï¼Œç¡®ä¿å·²ç»å®‰è£…äº†PostgreSQLæ•°æ®åº“ï¼Œå¹¶ä¸”å…·æœ‰ç®¡ç†å‘˜æƒé™ã€‚ç„¶åï¼Œåœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š # æ·»åŠ TimescaleDBçš„APTæº curl https://packagecloud.io/timescale/timescaledb/gpgkey | sudo apt-key add - echo &quot;deb https://packagecloud.io/timescale/timescaledb/ubuntu/ focal main&quot; | sudo tee /etc/apt/sources.list.d/timescale_timescaledb.list # æ›´æ–°è½¯ä»¶æº sudo apt-get update # å®‰è£…TimescaleDBæ’ä»¶ sudo apt-get install timescaledb-postgresql-13 2. åˆ›å»ºTimescaleDBæ•°æ®åº“ TimescaleDBçš„å·¥ä½œæ–¹å¼ä¸ä¼ ç»Ÿçš„PostgreSQLæ•°æ®åº“ç›¸ä¼¼ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨createdbå‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“ï¼Œå¹¶åœ¨è¯¥æ•°æ®åº“ä¸ŠåŠ è½½TimescaleDBæ‰©å±•ï¼š # åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“ createdb mydatabase # è¿æ¥åˆ°è¯¥æ•°æ®åº“ psql mydatabase # åœ¨æ•°æ®åº“ä¸­åŠ è½½TimescaleDBæ‰©å±• CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE; 3. æ‰©å±•è¶…çº§è¡¨åŠŸèƒ½ TimescaleDBä¸­çš„åŸºæœ¬æ•°æ®ç®¡ç†å•å…ƒç§°ä¸ºè¶…çº§è¡¨ã€‚è¶…çº§è¡¨æ˜¯åŸºäºæ™®é€šè¡¨çš„ä¸€ç§ç‰¹æ®Šç±»å‹ï¼Œå®ƒå°†æ—¶é—´åºåˆ—æ•°æ®æ ¹æ®æ—¶é—´è¿›è¡Œåˆ†åŒºå’Œç»„ç»‡ï¼Œä»è€Œå®ç°æ›´é«˜æ•ˆçš„æŸ¥è¯¢æ€§èƒ½ã€‚ä»¥ä¸‹ç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•åˆ›å»ºä¸€ä¸ªè¶…çº§è¡¨ï¼š -- åˆ›å»ºè¶…çº§è¡¨ CREATE TABLE conditions ( time TIMESTAMPTZ NOT NULL, location TEXT NOT NULL, temperature DOUBLE PRECISION NULL, humidity DOUBLE PRECISION NULL ); -- å¯¹è¶…çº§è¡¨è¿›è¡Œåˆ†åŒº SELECT create_hypertable('table_name', 'time_column'); åˆ›å»ºHypertableï¼šTimescaleDBä¸­çš„æ ¸å¿ƒæ¦‚å¿µæ˜¯Hypertableï¼Œå®ƒæ˜¯ä¸€ä¸ªé€»è¾‘è¡¨ï¼Œè´Ÿè´£å°†æ™®é€šè¡¨åˆ’åˆ†æˆä¸åŒçš„æ—¶é—´æ®µã€‚å…¶ä¸­ï¼Œ'table_name'æ˜¯åŸå§‹è¡¨çš„åç§°ï¼Œ'time_column'æ˜¯å­˜å‚¨æ—¶é—´ä¿¡æ¯çš„åˆ—ã€‚ ä¸‰ã€æ•°æ®å†™å…¥å’ŒæŸ¥è¯¢ 1. åˆ›å»ºè¶…çº§è¡¨ è¶…çº§è¡¨çš„åˆ›å»ºä¸æ™®é€šè¡¨ç±»ä¼¼ï¼Œä½†éœ€è¦æŒ‡å®šæ—¶é—´åˆ—ã€‚ä»¥ä¸‹ç¤ºä¾‹åˆ›å»ºäº†ä¸€ä¸ªåŒ…å«æ—¶é—´åˆ—çš„è¶…çº§è¡¨ï¼š CREATE TABLE conditions ( time TIMESTAMPTZ NOT NULL, location TEXT NOT NULL, temperature DOUBLE PRECISION NULL, humidity DOUBLE PRECISION NULL ); 2. è¶…çº§è¡¨çš„åˆ†åŒº è¶…çº§è¡¨çš„åˆ†åŒºæ˜¯TimescaleDBçš„ä¸€ä¸ªé‡è¦ç‰¹æ€§ï¼Œå®ƒå¯ä»¥æ ¹æ®æ—¶é—´å°†æ•°æ®åˆ†æ•£åˆ°ä¸åŒçš„ç‰©ç†è¡¨ä¸­ã€‚é€šè¿‡åˆ†åŒºï¼ŒæŸ¥è¯¢æ“ä½œä»…éœ€è¦åœ¨ç›¸å…³çš„ç‰©ç†è¡¨ä¸Šæ‰§è¡Œï¼Œä»è€Œæé«˜æŸ¥è¯¢æ€§èƒ½ã€‚ä»¥ä¸‹ç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•ä¸ºè¶…çº§è¡¨æ·»åŠ åˆ†åŒºï¼š -- å¯¹è¶…çº§è¡¨conditionsæŒ‰æœˆä»½è¿›è¡Œåˆ†åŒº SELECT create_hypertable('conditions', 'time', chunk_time_interval =&gt; INTERVAL '1 month'); 3. è¶…çº§è¡¨çš„å¤åˆ¶å’Œå‰¯æœ¬ TimescaleDBæ”¯æŒå¤åˆ¶å’Œå‰¯æœ¬åŠŸèƒ½ï¼Œå¯ä»¥åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šåˆ›å»ºè¶…çº§è¡¨çš„å‰¯æœ¬ï¼Œå®ç°æ•°æ®å†—ä½™å’Œé«˜å¯ç”¨æ€§ã€‚ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•åˆ›å»ºä¸€ä¸ªè¶…çº§è¡¨çš„å‰¯æœ¬ï¼š -- åœ¨èŠ‚ç‚¹2ä¸Šåˆ›å»ºconditionsè¶…çº§è¡¨çš„å‰¯æœ¬ SELECT add_data_node('conditions', '2'); 4. æ’å…¥æ•°æ® å‘è¶…çº§è¡¨ä¸­æ’å…¥æ•°æ®ä¸å‘æ™®é€šè¡¨ä¸­æ’å…¥æ•°æ®ç±»ä¼¼ã€‚ä»¥ä¸‹ç¤ºä¾‹å‘è¶…çº§è¡¨conditionsæ’å…¥ä¸€è¡Œæ•°æ®ï¼š INSERT INTO conditions (time, location, temperature, humidity) VALUES ('2023-06-29 06:00:00', 'New York', 25.4, 60.2); 5. æ›´æ–°å’Œåˆ é™¤æ•°æ® åœ¨è¶…çº§è¡¨ä¸­æ›´æ–°å’Œåˆ é™¤æ•°æ®ä¸æ™®é€šè¡¨ç›¸åŒã€‚ä»¥ä¸‹ç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•æ›´æ–°å’Œåˆ é™¤ç¬¦åˆç‰¹å®šæ¡ä»¶çš„æ•°æ®ï¼š -- æ›´æ–°æ¸©åº¦å¤§äº30çš„è®°å½• UPDATE conditions SET temperature = 30.0 WHERE temperature &gt; 30.0; -- åˆ é™¤æ¹¿åº¦å°äº50çš„è®°å½• DELETE FROM conditions WHERE humidity &lt; 50.0; 6. æ—¶é—´åºåˆ—èšåˆå‡½æ•° TimescaleDBæä¾›äº†ä¸€ç³»åˆ—å†…ç½®çš„æ—¶é—´åºåˆ—èšåˆå‡½æ•°ï¼Œç”¨äºè®¡ç®—ç»™å®šæ—¶é—´èŒƒå›´å†…çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå¦‚å¹³å‡å€¼ã€æœ€å¤§å€¼ã€æœ€å°å€¼ç­‰ã€‚ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨æ—¶é—´åºåˆ—èšåˆå‡½æ•°ï¼š -- è®¡ç®—æœ€è¿‘ä¸€å°æ—¶çš„å¹³å‡æ¸©åº¦ SELECT time_bucket('1 hour', time) AS hour, AVG(temperature) AS average_temperature FROM conditions WHERE time &gt; NOW() - INTERVAL '1 hour' GROUP BY hour; 7. æŸ¥è¯¢å’Œè¿‡æ»¤æ•°æ® æŸ¥è¯¢å’Œè¿‡æ»¤æ•°æ®æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å¸¸è§„çš„SQLæŸ¥è¯¢è¯­å¥ã€‚ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•æŸ¥è¯¢è¶…çº§è¡¨ä¸­çš„æ•°æ®ï¼š -- æŸ¥è¯¢æ‰€æœ‰æ¸©åº¦å¤§äº25çš„è®°å½• SELECT * FROM conditions WHERE temperature &gt; 25.0; 8. å…¶ä»–æ•°æ®æŸ¥è¯¢ TimescaleDBæä¾›äº†è®¸å¤šç”¨äºæŸ¥è¯¢æ—¶åºæ•°æ®çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼š æŸ¥è¯¢æœ€è¿‘ä¸€å°æ—¶çš„æ•°æ®ï¼š SELECT * FROM table_name WHERE time_column &gt; NOW() - INTERVAL '1 hour'; èšåˆæŸ¥è¯¢ï¼š SELECT time_bucket('5 minutes', time_column) AS bucket, AVG(value_column) AS avg_value FROM table_name GROUP BY bucket ORDER BY bucket; ä»¥ä¸ŠæŸ¥è¯¢å°†ç»“æœæŒ‰5åˆ†é’Ÿä¸ºä¸€ä¸ªæ—¶é—´æ®µè¿›è¡Œèšåˆï¼Œå¹¶è®¡ç®—æ¯ä¸ªæ—¶é—´æ®µå†…çš„å¹³å‡å€¼ã€‚ å››ã€è¿ç»­èšé›†è¡¨ è¿ç»­èšé›†è¡¨æ˜¯TimescaleDBçš„ä¸€ä¸ªé‡è¦ç‰¹æ€§ï¼Œå®ƒå¯ä»¥åœ¨åå°è‡ªåŠ¨ç»´æŠ¤é¢„å®šä¹‰çš„èšåˆæ•°æ®ã€‚é€šè¿‡ä½¿ç”¨è¿ç»­èšé›†è¡¨ï¼Œå¯ä»¥æå¤§åœ°æé«˜å¤§è§„æ¨¡æ—¶åºæ•°æ®çš„æŸ¥è¯¢æ€§èƒ½ã€‚ä»¥ä¸‹æ˜¯åˆ›å»ºå’Œä½¿ç”¨è¿ç»­èšé›†è¡¨çš„ç¤ºä¾‹ï¼š 1. åˆ›å»ºè¿ç»­èšé›†è¡¨ï¼š SELECT create_continuous_aggregate('ca_table', 'SELECT time_bucket('5 minutes', time_column) AS bucket, AVG(value_column) AS avg_value FROM table_name GROUP BY bucket'); 2. æŸ¥è¯¢è¿ç»­èšé›†è¡¨ï¼š SELECT * FROM ca_table; äº”ã€åˆ†åŒºç®¡ç† TimescaleDBä½¿ç”¨åˆ†åŒºï¼ˆpartitioningï¼‰æ¥ç®¡ç†å¤§è§„æ¨¡çš„æ—¶åºæ•°æ®ã€‚å®ƒå¯ä»¥å°†è¡¨æŒ‰ç…§æ—¶é—´èŒƒå›´è¿›è¡Œè‡ªåŠ¨åˆ’åˆ†ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½å’Œæ•°æ®çš„å¯ç»´æŠ¤æ€§ã€‚ä»¥ä¸‹æ˜¯åˆ›å»ºå’Œç®¡ç†åˆ†åŒºçš„ç¤ºä¾‹ï¼š 1. åˆ›å»ºåˆ†åŒºï¼š SELECT add_hypertable_partition('table_name', TIMESTAMP '2023-06-01', TIMESTAMP '2023-07-01'); 2. ç®¡ç†åˆ†åŒºï¼š æŸ¥è¯¢æ‰€æœ‰åˆ†åŒºï¼š SELECT show_partitions('table_name'); åˆ é™¤åˆ†åŒºï¼š SELECT drop_partition('table_name', TIMESTAMP '2023-06-01'); 3. æ•°æ®è¿ç»­æ€§å’Œå­˜å‚¨ä¼˜åŒ– TimescaleDBé€šè¿‡æ•°æ®è¿ç»­æ€§æ¥ä¼˜åŒ–å­˜å‚¨ç©ºé—´å’ŒæŸ¥è¯¢æ€§èƒ½ã€‚æ•°æ®è¿ç»­æ€§æŒ‡çš„æ˜¯è°ƒæ•´è¶…çº§è¡¨çš„åˆ†åŒºå’Œå­˜å‚¨ç­–ç•¥ï¼Œä»¥ç¡®ä¿ç›¸é‚»æ—¶é—´æ®µçš„æ•°æ®å­˜å‚¨åœ¨ä¸€èµ·ï¼Œä»è€Œæé«˜æŸ¥è¯¢æ€§èƒ½ã€‚ 4. æ•°æ®ä¿ç•™ç­–ç•¥ TimescaleDBå…è®¸å®šä¹‰æ•°æ®çš„ä¿ç•™ç­–ç•¥ï¼Œä»¥è‡ªåŠ¨åˆ é™¤è¿‡æ—¶çš„æ•°æ®ã€‚é€šè¿‡è®¾ç½®ä¿ç•™ç­–ç•¥ï¼Œå¯ä»¥æ§åˆ¶è¶…çº§è¡¨ä¸­æ•°æ®çš„ä¿å­˜æ—¶é•¿ï¼Œä»¥åŠæ˜¯å¦è‡ªåŠ¨åˆ é™¤è¿‡æœŸæ•°æ®ã€‚ å…­. ç»¼åˆä½¿ç”¨ç¤ºä¾‹ 1. åˆ›å»ºè¶…çº§è¡¨å¹¶æ’å…¥æ•°æ® å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåä¸ºconditionsçš„è¶…çº§è¡¨ï¼ŒåŒ…å«æ—¶é—´ã€åœ°ç‚¹ã€æ¸©åº¦å’Œæ¹¿åº¦å­—æ®µã€‚ä»¥ä¸‹ç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•åˆ›å»ºè¯¥è¶…çº§è¡¨ï¼Œå¹¶å‘å…¶ä¸­æ’å…¥ä¸€äº›æ•°æ®ï¼š CREATE TABLE conditions ( time TIMESTAMPTZ NOT NULL, location TEXT NOT NULL, temperature DOUBLE PRECISION NULL, humidity DOUBLE PRECISION NULL ); SELECT create_hypertable('conditions', 'time'); INSERT INTO conditions (time, location, temperature, humidity) VALUES ('2023-06-29 06:00:00', 'New York', 25.4, 60.2), ('2023-06-29 07:00:00', 'New York', 26.8, 58.9), ('2023-06-29 08:00:00', 'New York', 28.3, 57.1); 2. æŸ¥è¯¢æœ€æ–°çš„Næ¡æ•°æ® å‡è®¾æˆ‘ä»¬æƒ³è¦æŸ¥è¯¢æœ€æ–°çš„3æ¡æ¸©åº¦æ•°æ®ã€‚ä»¥ä¸‹ç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨LIMITå­å¥å’ŒORDER BYå­å¥è¿›è¡ŒæŸ¥è¯¢ï¼š SELECT * FROM conditions ORDER BY time DESC LIMIT 3; 3. æ‰§è¡Œæ—¶é—´èŒƒå›´å†…çš„èšåˆæŸ¥è¯¢ å‡è®¾æˆ‘ä»¬æƒ³è¦è®¡ç®—è¿‡å»ä¸€å°æ—¶å†…æ¯åˆ†é’Ÿçš„å¹³å‡æ¸©åº¦ã€‚ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨æ—¶é—´åºåˆ—èšåˆå‡½æ•°å’Œæ—¶é—´æˆ³æ¡¶å‡½æ•°è¿›è¡ŒæŸ¥è¯¢ï¼š SELECT time_bucket('1 minute', time) AS minute, AVG(temperature) AS average_temperature FROM conditions WHERE time &gt; NOW() - INTERVAL '1 hour' GROUP BY minute; ä¸ƒã€å°ç»“ä¸€ä¸‹ é€šè¿‡ä½¿ç”¨TimescaleDBï¼Œæˆ‘ä»¬å¯ä»¥é«˜æ•ˆåœ°å­˜å‚¨å’ŒæŸ¥è¯¢æ—¶åºæ•°æ®ï¼Œå¹¶åˆ©ç”¨è¿ç»­èšé›†è¡¨å’Œåˆ†åŒºç®¡ç†åŠŸèƒ½è¿›ä¸€æ­¥æé«˜æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ã€‚ Timescale DBè·ŸåŒç±»çš„å…¶ä»–æ•°æ®åº“ç›¸æ¯”å…·æœ‰ä¸€äº›ä»¤äººå…´å¥‹çš„åŠŸèƒ½ï¼š å®ƒå»ºç«‹åœ¨PostgreSQLä¹‹ä¸Š(ç›®å‰æœ€å¥½çš„å¼€æºå…³ç³»æ•°æ®åº“)ã€‚å¦‚æœæ‚¨çš„é¡¹ç›®å·²ç»åœ¨è¿è¡ŒPostgreSQLï¼ŒTimescaleå¯ä»¥é‡ç‚¹è€ƒè™‘ã€‚ é€šè¿‡ç†Ÿæ‚‰çš„SQLè¯­æ³•è¿›è¡ŒæŸ¥è¯¢ï¼Œä»è€Œå‡å°‘äº†å­¦ä¹ éš¾åº¦ã€‚ æå¿«çš„å†™å…¥é€Ÿåº¦-æ¯ç§’æ•°ç™¾ä¸‡æ¬¡çš„æ’å…¥ã€‚ æ•°åäº¿è¡Œæˆ–PBçš„æ•°æ®ï¼Œå¯¹äºTimescaleæ¥è¯´æ²¡ä»€ä¹ˆå¤§ä¸äº†çš„ã€‚ æ¨¡å¼å…·æœ‰çœŸæ­£çš„çµæ´»æ€§-å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©å…³ç³»æ¨¡å¼æˆ–æ— æ¨¡å¼ã€‚ ","link":"https://tianxiawuhao.github.io/ZZ6BztHhQ/"},{"title":"PostgreSQLæ¦‚è¿°ä¸‰","content":"åã€äº‹åŠ¡ 10.1 ä»€ä¹ˆæ˜¯ACIDï¼Ÿï¼ˆå¸¸è¯†ï¼‰ åœ¨æ—¥å¸¸æ“ä½œä¸­ï¼Œå¯¹äºä¸€ç»„ç›¸å…³æ“ä½œï¼Œé€šå¸¸è¦æ±‚è¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥ã€‚åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œç§°è¿™ä¸€ç»„æ“ä½œä¸ºäº‹åŠ¡ã€‚ä¸ºäº†ä¿è¯æ•´ä½“äº‹åŠ¡çš„å®‰å…¨æ€§ï¼Œæœ‰ACIDè¿™ä¸€è¯´ï¼š åŸå­æ€§Aï¼šäº‹åŠ¡æ˜¯ä¸€ä¸ªæœ€å°çš„æ‰§è¡Œå•ä½ï¼Œä¸€æ¬¡äº‹åŠ¡ä¸­çš„æ“ä½œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥ã€‚ ä¸€è‡´æ€§Cï¼šåœ¨äº‹åŠ¡å®Œæˆæ—¶ï¼Œæ‰€æœ‰æ•°æ®å¿…é¡»ä¿æŒåœ¨ä¸€è‡´çš„çŠ¶æ€ã€‚ï¼ˆäº‹åŠ¡å®Œæˆåå—ï¼Œæœ€ç»ˆç»“æœå’Œé¢„æœŸç»“æœæ˜¯ä¸€è‡´çš„ï¼‰ éš”ç¦»æ€§ï¼šä¸€æ¬¡äº‹åŠ¡æ“ä½œï¼Œè¦ä¹ˆæ˜¯å…¶ä»–äº‹åŠ¡æ“ä½œå‰çš„çŠ¶æ€ï¼Œè¦ä¹ˆæ˜¯å…¶ä»–äº‹åŠ¡æ“ä½œåçš„çŠ¶æ€ï¼Œä¸å­˜åœ¨ä¸­é—´çŠ¶æ€ã€‚ æŒä¹…æ€§ï¼šäº‹åŠ¡æäº¤åï¼Œæ•°æ®ä¼šè½åˆ°æœ¬åœ°ç£ç›˜ï¼Œä¿®æ”¹æ˜¯æ°¸ä¹…æ€§çš„ã€‚ PostgreSQLä¸­ï¼Œåœ¨äº‹åŠ¡çš„å¹¶å‘é—®é¢˜é‡Œï¼Œä¹Ÿæ˜¯åŸºäºMVCCï¼Œå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶å»ç»´æŠ¤æ•°æ®çš„ä¸€è‡´æ€§ã€‚ç›¸æ¯”äºä¼ ç»Ÿçš„é”æ“ä½œï¼ŒMVCCæœ€å¤§çš„æœ‰ç‚¹å°±æ˜¯å¯ä»¥è®©è¯»å†™äº’ç›¸ä¸å†²çª ã€‚ å½“ç„¶ï¼ŒPostgreSQLä¹Ÿæ”¯æŒè¡¨é”å’Œè¡Œé”ï¼Œå¯ä»¥è§£å†³å†™å†™çš„å†²çªé—®é¢˜ã€‚ PostgreSQLç›¸æ¯”äºå…¶ä»–æ•°æ®ï¼Œæœ‰ä¸€ä¸ªæ¯”è¾ƒå¤§çš„ä¼˜åŒ–ï¼ŒDDLä¹Ÿå¯ä»¥åŒ…å«åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ã€‚æ¯”å¦‚é›†ç¾¤ä¸­çš„æ“ä½œï¼Œä¸€ä¸ªäº‹åŠ¡å¯ä»¥ä¿è¯å¤šä¸ªèŠ‚ç‚¹éƒ½æ„å»ºå‡ºä¸€ä¸ªè¡¨ï¼Œæ‰ç®—æˆåŠŸã€‚ 10.2 äº‹åŠ¡çš„åŸºæœ¬ä½¿ç”¨ é¦–å…ˆåŸºäºå‰é¢çš„å„ç§æ“ä½œï¼Œåº”è¯¥å·²ç»ä½“ä¼šåˆ°äº†ï¼ŒPostgreSQLæ˜¯è‡ªåŠ¨æäº¤äº‹åŠ¡ã€‚è·ŸMySQLæ˜¯ä¸€æ ·çš„ã€‚ å¯ä»¥åŸºäºå…³é—­PostgreSQLçš„è‡ªåŠ¨æäº¤äº‹åŠ¡æ¥è¿›è¡Œæ“ä½œã€‚ ä½†æ˜¯ä¸Šè¿°æ–¹å¼æ¯”è¾ƒéº»çƒ¦ï¼Œä¼ ç»Ÿçš„æ–¹å¼ã€‚ å°±æ˜¯ä¸‰ä¸ªå‘½ä»¤ï¼š beginï¼šå¼€å§‹äº‹åŠ¡ commitï¼šæäº¤äº‹åŠ¡ rollbackï¼šå›æ»šäº‹åŠ¡ -- å¼€å¯äº‹åŠ¡ begin; -- æ“ä½œ insert into test values (7,'bbb',12,5); -- æäº¤äº‹åŠ¡ commit; 10.3 ä¿å­˜ç‚¹ï¼ˆäº†è§£ï¼‰ æ¯”å¦‚é¡¹ç›®ä¸­æœ‰ä¸€ä¸ªå¤§äº‹åŠ¡æ“ä½œï¼Œä¸å¥½æ§åˆ¶ï¼Œè¶…æ—¶æœ‰å½±å“ï¼Œå›æ»šä¼šé€ æˆä¸€åˆ‡é‡æ¥ï¼Œæˆæœ¬å¤ªé«˜ã€‚ æˆ‘é’ˆå¯¹å¤§äº‹åŠ¡ï¼Œæ‹†åˆ†æˆå‡ ä¸ªéƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†å®Œæˆåï¼Œæ„å»ºä¸€ä¸ªä¿å­˜ç‚¹ã€‚å¦‚æœåé¢æ“ä½œå¤±è´¥äº†ï¼Œéœ€è¦å›æ»šï¼Œä¸éœ€è¦å…¨ç›˜å›æ»šï¼Œå›æ»šåˆ°ä¹‹å‰çš„ä¿å­˜ç‚¹ï¼Œç»§ç»­é‡è¯•ã€‚ æœ‰äººä¼šå‘ç°ï¼Œç ´åäº†æ•´ä½“äº‹åŠ¡çš„åŸå­æ€§ã€‚ Butï¼Œåªè¦æ“ä½œåˆç†ï¼Œå¯ä»¥åœ¨ä¿å­˜ç‚¹çš„ä¸¾å‡ºä¸Šï¼Œåšé‡è¯•ï¼Œåªè¦é‡è¯•ä¸æˆåŠŸï¼Œä¾ç„¶å¯ä»¥å…¨ç›˜å›æ»šã€‚ æ¯”å¦‚ä¸€ä¸ªç”µå•†é¡¹ç›®ï¼Œä¸‹è®¢å•ï¼Œæ‰£åº“å­˜ï¼Œåˆ›å»ºè®¢å•ï¼Œåˆ é™¤è´­ç‰©è½¦ï¼Œå¢åŠ ç”¨æˆ·ç§¯åˆ†ï¼Œé€šçŸ¥å•†å®¶â€¦â€¦â€¦â€¦ã€‚è¿™ä¸ªå…¶å®å°±æ˜¯ä¸€ä¸ªå¤§äº‹åŠ¡ã€‚å¯ä»¥å°†æ‰£åº“å­˜å’Œä¸‹è®¢å•è¿™ç§æ ¸å¿ƒåŠŸèƒ½å®Œæˆåï¼Œå¢åŠ ä¸€ä¸ªä¿å­˜ç‚¹ï¼Œå¦‚æœè¯´åç»­æ“ä½œæœ‰å¤±è´¥çš„ï¼Œå¯ä»¥ä»åˆ›å»ºè®¢å•æˆåŠŸåçš„é˜¶æ®µï¼Œå†åšé‡è¯•ã€‚ ä¸è¿‡å…¶å®ä¸Šè¿°çš„ä¸šåŠ¡ï¼ŒåŸºäºæœ€ç»ˆä¸€è‡´æ€§æœ‰æ›´å¥½çš„å¤„ç†æ–¹å¼ï¼Œå¯ä»¥ä¿è¯å¯ç”¨æ€§ã€‚ ç®€å•æ“ä½œä¸€ä¸‹ã€‚ -- savepointæ“ä½œ -- å¼€å¯äº‹åŠ¡ begin; -- æ’å…¥ä¸€æ¡æ•°æ® insert into test values (8,'é“ƒé“›',55,11); -- æ·»åŠ ä¸€ä¸ªä¿å­˜ç‚¹ savepoint ok1; -- å†æ’å…¥æ•°æ®,æ¯”å¦‚å‡ºäº†ä¸€åœº insert into test values (9,'å¤§å”å®˜åºœ',66,22); -- å›æ»šåˆ°ä¹‹å‰çš„æäº¤ç‚¹ rollback to savepoint ok1; -- å°±å¯ä»¥å¼€å§‹é‡è¯•æ“ä½œï¼Œé‡è¯•æˆåŠŸï¼Œcommitï¼Œå¤±è´¥å¯ä»¥rollback; commit; åä¸€ã€å¹¶å‘é—®é¢˜ 11.1 äº‹åŠ¡çš„éš”ç¦»çº§åˆ« åœ¨ä¸è€ƒè™‘éš”ç¦»æ€§çš„å‰æä¸‹ï¼Œäº‹åŠ¡çš„å¹¶å‘å¯èƒ½ä¼šå‡ºç°çš„é—®é¢˜ï¼š è„è¯»ï¼šè¯»åˆ°äº†å…¶ä»–äº‹åŠ¡æœªæäº¤çš„æ•°æ®ã€‚ï¼ˆå¿…é¡»é¿å…è¿™ç§æƒ…å†µï¼‰ ä¸å¯é‡å¤è¯»ï¼šåŒä¸€äº‹åŠ¡ä¸­ï¼Œå¤šæ¬¡æŸ¥è¯¢åŒä¸€æ•°æ®ï¼Œç»“æœä¸ä¸€è‡´ï¼Œå› ä¸ºå…¶ä»–äº‹åŠ¡ä¿®æ”¹é€ æˆçš„ã€‚ï¼ˆä¸€äº›ä¸šåŠ¡ä¸­è¿™ç§ä¸å¯é‡å¤è¯»ä¸æ˜¯é—®é¢˜ï¼‰ å¹»è¯»ï¼šåŒä¸€äº‹åŠ¡ä¸­ï¼Œå¤šæ¬¡æŸ¥è¯¢åŒä¸€æ•°æ®ï¼Œå› ä¸ºå…¶ä»–äº‹åŠ¡å¯¹æ•°æ®è¿›è¡Œäº†å¢åˆ å—ï¼Œå¯¼è‡´å‡ºç°äº†ä¸€äº›é—®é¢˜ã€‚ï¼ˆä¸€äº›ä¸šåŠ¡ä¸­è¿™ç§å¹»è¯»ä¸æ˜¯é—®é¢˜ï¼‰ é’ˆå¯¹è¿™äº›å¹¶å‘é—®é¢˜ï¼Œå…³ç³»å‹æ•°æ®åº“æœ‰ä¸€äº›äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ï¼Œä¸€èˆ¬ç”¨4ç§ã€‚ READ UNCOMMITTEDï¼šè¯»æœªæäº¤ï¼ˆå•¥ç”¨æ²¡ç”¨ï¼Œå¹¶ä¸”PGSQLæ²¡æœ‰ï¼Œæä¾›äº†åªæ˜¯ä¸ºäº†å®Œæ•´æ€§ï¼‰ READ COMMITTEDï¼šè¯»å·²æäº¤ï¼Œå¯ä»¥è§£å†³è„è¯»ï¼ˆPGSQLé»˜è®¤éš”ç¦»çº§åˆ«ï¼‰ REPEATABLE READï¼šå¯é‡å¤è¯»ï¼Œå¯ä»¥è§£å†³è„è¯»å’Œä¸å¯é‡å¤è¯»ï¼ˆMySQLé»˜è®¤æ˜¯è¿™ä¸ªéš”ç¦»çº§åˆ«ï¼ŒPGSQLä¹Ÿæä¾›äº†ï¼Œä½†æ˜¯è®¾ç½®ä¸ºå¯é‡å¤è¯»ï¼Œæ•ˆæœè¿˜æ˜¯ä¸²è¡ŒåŒ–ï¼‰ SERIALIZABLEï¼šä¸²è¡ŒåŒ–ï¼Œå•¥éƒ½èƒ½è§£å†³ï¼ˆé”ï¼Œæ•ˆç‡æ…¢ï¼‰ PGSQLåœ¨è€ç‰ˆæœ¬ä¸­ï¼Œåªæœ‰ä¸¤ä¸ªéš”ç¦»çº§åˆ«ï¼Œè¯»å·²æäº¤å’Œä¸²è¡ŒåŒ–ã€‚åœ¨PGSQLä¸­å°±ä¸å­˜åœ¨è„è¯»é—®é¢˜ã€‚ 11.2 MVCC é¦–å…ˆè¦æ¸…æ¥šï¼Œä¸ºå•¥è¦æœ‰MVCCã€‚ å¦‚æœä¸€ä¸ªæ•°æ®åº“ï¼Œé¢‘ç¹çš„è¿›è¡Œè¯»å†™æ“ä½œï¼Œä¸ºäº†ä¿è¯å®‰å…¨ï¼Œé‡‡ç”¨é”çš„æœºåˆ¶ã€‚ä½†æ˜¯å¦‚æœé‡‡ç”¨é”æœºåˆ¶ï¼Œå¦‚æœä¸€äº›äº‹åŠ¡åœ¨å†™æ•°æ®ï¼Œå¦å¤–ä¸€ä¸ªäº‹åŠ¡å°±æ— æ³•è¯»æ•°æ®ã€‚ä¼šé€ æˆè¯»å†™ä¹‹é—´ç›¸äº’é˜»å¡ã€‚ å¤§å¤šæ•°çš„æ•°æ®åº“éƒ½ä¼šé‡‡ç”¨ä¸€ä¸ªæœºåˆ¶ å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ MVCC æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ æ¯”å¦‚ä½ è¦æŸ¥è¯¢ä¸€è¡Œæ•°æ®ï¼Œä½†æ˜¯è¿™è¡Œæ•°æ®æ­£åœ¨è¢«ä¿®æ”¹ï¼Œäº‹åŠ¡è¿˜æ²¡æäº¤ï¼Œå¦‚æœæ­¤æ—¶å¯¹è¿™è¡Œæ•°æ®åŠ é”ï¼Œä¼šå¯¼è‡´å…¶ä»–çš„è¯»æ“ä½œé˜»å¡ï¼Œéœ€è¦ç­‰å¾…ã€‚å¦‚æœé‡‡ç”¨PostgreSQLï¼Œä»–çš„å†…éƒ¨ä¼šé’ˆå¯¹è¿™ä¸€è¡Œæ•°æ®ä¿å­˜å¤šä¸ªç‰ˆæœ¬ï¼Œå¦‚æœæ•°æ®æ­£åœ¨è¢«å†™å…¥ï¼ŒåŒ…å°±ä¿å­˜ä¹‹å‰çš„æ•°æ®ç‰ˆæœ¬ã€‚è®©è¯»æ“ä½œå»æŸ¥è¯¢ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œä¸éœ€è¦é˜»å¡ã€‚ç­‰å†™æ“ä½œçš„äº‹åŠ¡æäº¤äº†ï¼Œè¯»æ“ä½œæ‰èƒ½æŸ¥çœ‹åˆ°æœ€æ–°çš„æ•°æ®ã€‚ è¿™å‡ ä¸ªåŠæ—¶å¯ä»¥ç¡®ä¿ è¯»å†™æ“ä½œæ²¡æœ‰å†²çª ï¼Œè¿™ä¸ªå°±æ˜¯MVCCçš„ä¸»è¦ç‰¹ç‚¹ã€‚ å†™å†™æ“ä½œï¼Œå’ŒMVCCæ²¡å…³ç³»ï¼Œé‚£ä¸ªå°±æ˜¯åŠ é”çš„æ–¹å¼ï¼ Psï¼šè¿™é‡Œçš„MVCCæ˜¯åŸºäº è¯»å·²æäº¤ å»èŠçš„ï¼Œå¦‚æœæ˜¯ä¸²è¡ŒåŒ–ï¼Œé‚£å°±è¯»ä¸åˆ°äº†ã€‚ åœ¨æ“ä½œä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹PGSQLä¸­ï¼Œæ¯å¼ è¡¨éƒ½ä¼šè‡ªå¸¦ä¸¤ä¸ªå­—æ®µ xminï¼šç»™å½“å‰äº‹åŠ¡åˆ†é…çš„æ•°æ®ç‰ˆæœ¬ã€‚å¦‚æœæœ‰å…¶ä»–äº‹åŠ¡åšäº†å†™æ“ä½œï¼Œå¹¶ä¸”æäº¤äº‹åŠ¡äº†ï¼Œå°±ç»™xminåˆ†é…æ–°çš„ç‰ˆæœ¬ã€‚ xmaxï¼šå½“å‰äº‹åŠ¡æ²¡æœ‰å­˜åœ¨æ–°ç‰ˆæœ¬ï¼Œxmaxå°±æ˜¯0ã€‚å¦‚æœæœ‰å…¶ä»–äº‹åŠ¡åšäº†å†™æ“ä½œï¼Œæœªæäº¤äº‹åŠ¡ï¼Œå°†å†™æ“ä½œçš„ç‰ˆæœ¬æ”¾åˆ°xmaxä¸­ã€‚æäº¤äº‹åŠ¡åï¼Œxmaxä¼šåˆ†é…åˆ°xminä¸­ï¼Œç„¶åxmaxå½’0ã€‚ åŸºäºä¸Šå›¾çš„æ“ä½œæŸ¥çœ‹ä¸€æ³¢æ•ˆæœ äº‹åŠ¡A -- å·¦ï¼Œäº‹åŠ¡A --1ã€å¼€å¯äº‹åŠ¡ begin; --2ã€æŸ¥è¯¢æŸä¸€è¡Œæ•°æ®, xmin = 630,xmax = 0 select xmin,xmax,* from test where id = 8; --3ã€æ¯æ¬¡å¼€å¯äº‹åŠ¡åï¼Œä¼šåˆ†é…ä¸€ä¸ªäº‹åŠ¡ID äº‹åŠ¡id=631 select txid_current(); --7ã€ä¿®æ”¹idä¸º8çš„æ•°æ®ï¼Œç„¶ååœ¨æœ¬äº‹åŠ¡ä¸­æŸ¥è¯¢ xmin = 631, xmax = 0 update test set name = 'é“ƒé“›' where id = 8; select xmin,xmax,* from test where id = 8; --9ã€æäº¤äº‹åŠ¡ commit; äº‹åŠ¡B -- å³ï¼Œäº‹åŠ¡B --4ã€å¼€å¯äº‹åŠ¡ begin; --5ã€æŸ¥è¯¢æŸä¸€è¡Œæ•°æ®, xmin = 630,xmax = 0 select xmin,xmax,* from test where id = 8; --6ã€æ¯æ¬¡å¼€å¯äº‹åŠ¡åï¼Œä¼šåˆ†é…ä¸€ä¸ªäº‹åŠ¡ID äº‹åŠ¡id=632 select txid_current(); --8ã€äº‹åŠ¡Aä¿®æ”¹å®Œï¼Œäº‹åŠ¡Bå†æŸ¥è¯¢ xmin = 630 xmax = 631 select xmin,xmax,* from test where id = 8; --10ã€äº‹åŠ¡Aæäº¤åï¼Œäº‹åŠ¡Bå†æŸ¥è¯¢ xmin = 631 xmax = 0 select xmin,xmax,* from test where id = 8; åäºŒã€é” PostgreSQLä¸­ä¸»è¦æœ‰ä¸¤ç§é”ï¼Œä¸€ä¸ªè¡¨é”ä¸€ä¸ªè¡Œé” PostgreSQLä¸­ä¹Ÿæä¾›äº†é¡µé”ï¼Œå’¨è¯¢é”ï¼ŒButï¼Œè¿™ä¸ªä¸éœ€è¦å…³æ³¨ï¼Œä»–æ˜¯ä¸ºäº†é”çš„å®Œæ•´æ€§ 12.1 è¡¨é” è¡¨é”æ˜¾è€Œæ˜“è§ï¼Œå°±æ˜¯é”ä½æ•´å¼ è¡¨ã€‚è¡¨é”ä¹Ÿåˆ†ä¸ºå¾ˆå¤šä¸­æ¨¡å¼ã€‚ è¡¨é”çš„æ¨¡å¼å¾ˆå¤šï¼Œå…¶ä¸­æœ€æ ¸å¿ƒçš„ä¸¤ä¸ªï¼š ACCESS SHAREï¼šå…±äº«é”ï¼ˆè¯»é”ï¼‰ï¼Œè¯»è¯»æ“ä½œä¸é˜»å¡ï¼Œä½†æ˜¯ä¸å…è®¸å‡ºç°å†™æ“ä½œå¹¶è¡Œ ACCESS EXCLUSIVEï¼šäº’æ–¥é”ï¼ˆå†™é”ï¼‰ï¼Œæ— è®ºä»€ä¹ˆæ“ä½œè¿›æ¥ï¼Œéƒ½é˜»å¡ã€‚ å…·ä½“çš„å¯ä»¥æŸ¥çœ‹å®˜ç½‘æ–‡æ¡£ï¼šhttp://postgres.cn/docs/12/explicit-locking.html è¡¨é”çš„å®ç°ï¼š å…ˆæŸ¥çœ‹ä¸€æ³¢è¯­æ³• å°±æ˜¯åŸºäºLOCKå¼€å¯è¡¨é”ï¼ŒæŒ‡å®šè¡¨çš„åå­—nameï¼Œå…¶æ¬¡åœ¨MODEä¸­æŒ‡å®šé”çš„æ¨¡å¼ï¼ŒNOWAITå¯ä»¥æŒ‡å®šæ˜¯å¦åœ¨æ²¡æœ‰æ‹¿åˆ°é”æ—¶ï¼Œä¸€è‡´ç­‰å¾…ã€‚ -- 111å·è¿æ¥ -- åŸºäºäº’æ–¥é”ï¼Œé”ä½testè¡¨ -- å…ˆå¼€å¯äº‹åŠ¡ begin; -- åŸºäºé»˜è®¤çš„ACCESS EXCLUSIVEé”ä½testè¡¨ lock test in ACCESS SHARE mode; -- æ“ä½œ select * from test; -- æäº¤äº‹åŠ¡ï¼Œé”é‡Šæ”¾ commit; å½“111å·è¿æ¥åŸºäºäº‹åŠ¡å¼€å¯åï¼Œé”ä½å½“å‰è¡¨ä¹‹åï¼Œå¦‚æœä½¿ç”¨é»˜è®¤çš„ACCESS EXCLUSIVEï¼Œå…¶ä»–è¿æ¥æ“ä½œè¡¨æ—¶ï¼Œä¼šç›´æ¥é˜»å¡ä½ã€‚ å¦‚æœ111å·æ˜¯åŸºäºACCESS SHAREå…±äº«é”æ—¶ï¼Œå…¶ä»–çº¿ç¨‹æŸ¥è¯¢å½“å‰è¡¨æ˜¯ä¸ä¼šé”ä½å¾— 12.2 è¡Œé” PostgreSQLçš„è¡Œé”å’ŒMySQLçš„åŸºæœ¬æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼ŒåŸºäºselect for updateå°±å¯ä»¥æŒ‡å®šè¡Œé”ã€‚ MySQLä¸­æœ‰ä¸€ä¸ªæ¦‚å¿µï¼Œfor updateæ—¶ï¼Œå¦‚æœselectçš„æŸ¥è¯¢æ²¡æœ‰å‘½ä¸­ç´¢å¼•ï¼Œå¯èƒ½ä¼šé”è¡¨ã€‚ PostgerSQLæœ‰ä¸ªç‰¹ç‚¹ï¼Œä¸€èˆ¬æƒ…å†µï¼Œåœ¨selectçš„æŸ¥è¯¢æ²¡æœ‰å‘½ä¸­ç´¢å¼•æ—¶ï¼Œä»–ä¸ä¸€å®šä¼šé”è¡¨ï¼Œä¾ç„¶ä¼šå®ç°è¡Œé”ã€‚ PostgreSQLçš„è¡Œé”ï¼Œå°±ç©ä¿©ï¼Œä¸€ä¸ªfor updateï¼Œä¸€ä¸ªfor shareã€‚ åœ¨å¼€å¯äº‹åŠ¡ä¹‹åï¼Œç›´æ¥æ‰§è¡Œselect * from table where æ¡ä»¶ for update; -- å…ˆå¼€å¯äº‹åŠ¡ begin; -- åŸºäºfor update é”ä½idä¸º3çš„æ•°æ® select * from test where id = 3 for update; update test set name = 'v1' where id = 3; -- æäº¤äº‹åŠ¡ï¼Œé”é‡Šæ”¾ commit; å…¶ä»–çš„è¿æ¥è¦é”ä½å½“å‰è¡Œï¼Œä¼šé˜»å¡ä½ã€‚ åä¸‰ã€å¤‡ä»½&amp;æ¢å¤ é˜²æ­¢æ•°æ®ä¸¢å¤±çš„ç¬¬ä¸€é“é˜²çº¿å°±æ˜¯å¤‡ä»½ã€‚æ•°æ®ä¸¢å¤±æœ‰çš„æ˜¯ç¡¬ä»¶æŸåï¼Œè¿˜æœ‰äººä¸ºçš„è¯¯åˆ ä¹‹ç±»çš„ï¼Œä¹Ÿæœ‰BUGçš„åŸå› å¯¼è‡´è¯¯åˆ æ•°æ®ã€‚ æ­£å¸¸å¤‡ä»½å’Œæ¢å¤ï¼Œå¦‚æœå…¬å¸æœ‰DBAï¼Œä¸€èˆ¬å’±ä»¬ä¸ç”¨å‚ä¸ï¼ŒBUTï¼Œå­¦çš„Javaï¼Œå•¥éƒ½å¾—ä¼šç‚¹~~ åœ¨PostgreSQLä¸­ï¼Œæœ‰ä¸‰ç§å¤‡ä»½æ–¹å¼ï¼š SQLå¤‡ä»½ï¼ˆé€»è¾‘å¤‡ä»½ï¼‰ ï¼šå…¶å®å°±æ˜¯åˆ©ç”¨æ•°æ®åº“è‡ªå¸¦çš„ç±»ä¼¼dumpçš„å‘½ä»¤ï¼Œæˆ–è€…æ˜¯ä½ ç”¨å›¾å½¢åŒ–ç•Œé¢æ‰§è¡Œå¯¼å…¥å¯¼å‡ºæ—¶ï¼Œåº•å±‚å°±æ˜¯åŸºäºè¿™ä¸ªdumpå‘½ä»¤å®ç°çš„ã€‚å¤‡ä»½å‡ºæ¥ä¸€ä»½sqlæ–‡ä»¶ï¼Œè°éœ€è¦å°±å¤åˆ¶ç»™è°ã€‚ ä¼˜ç‚¹ï¼šç®€å•ï¼Œæ–¹ä¾¿æ“ä½œï¼Œæœ‰æ‰‹å°±è¡Œï¼Œè¿˜æŒºå¯é ã€‚ ç¼ºç‚¹ï¼šæ•°æ®æ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œè¿™ç§æ–¹å¼å·¨æ…¢ï¼Œå¯èƒ½å¯¼å‡ºä¸€å¤©ï¼Œéƒ½æ— æ³•å¯¼å‡ºå®Œæ‰€æœ‰æ•°æ®ã€‚ æ–‡ä»¶ç³»ç»Ÿå¤‡ä»½ï¼ˆç‰©ç†å¤‡ä»½ï¼‰ ï¼šå…¶å®å°±æ˜¯æ‰¾åˆ°å½“å‰æ•°æ®åº“ï¼Œæ•°æ®æ–‡ä»¶åœ¨ç£ç›˜å­˜å‚¨çš„ä½ç½®ï¼Œå°†æ•°æ®æ–‡ä»¶ç›´æ¥å¤åˆ¶ä¸€ä»½æˆ–å¤šä»½ï¼Œå­˜å‚¨åœ¨ä¸åŒçš„ç‰©ç†æœºä¸Šï¼Œå³ä¾¿ç‰©ç†æœºçˆ†ç‚¸ä¸€ä¸ªï¼Œè¿˜æœ‰å…¶ä»–ç‰©ç†æœºã€‚ ä¼˜ç‚¹ï¼šç›¸æ¯”é€»è¾‘å¤‡ä»½ï¼Œæ¢å¤çš„é€Ÿåº¦å¿«ã€‚ ç¼ºç‚¹ï¼šåœ¨å¤‡ä»½æ•°æ®æ—¶ï¼Œå¯èƒ½æ•°æ®è¿˜æ­£åœ¨å†™å…¥ï¼Œä¸€å®šç¨‹åº¦ä¸Šä¼šä¸¢å¤±æ•°æ®ã€‚ åœ¨æ¢å¤æ•°æ®æ—¶ï¼Œä¹Ÿéœ€è¦æ³¨æ„æ•°æ®åº“çš„ç‰ˆæœ¬å’Œç¯å¢ƒå¿…é¡»ä¿æŒé«˜åº¦çš„ä¸€è‡´ã€‚å¦‚æœæ˜¯çº¿ä¸Šæ­£åœ¨è¿è¡Œçš„æ•°æ®åº“ï¼Œè¿™ç§å¤åˆ¶çš„æ–¹å¼æ— æ³•åœ¨ç”Ÿäº§ç¯å¢ƒå®ç°ã€‚ å¦‚æœè¯´è¦åšæ•°æ®çš„è¿ç§»ï¼Œè¿™ç§æ–¹å¼è¿˜ä¸é”™æ»´ã€‚ å½’æ¡£å¤‡ä»½ï¼šï¼ˆä¹Ÿå±äºç‰©ç†å¤‡ä»½ï¼‰ å…ˆäº†è§£å‡ ä¸ªæ¦‚å¿µï¼Œåœ¨PostgreSQLæœ‰å¤šä¸ªå­è¿›ç¨‹æ¥è¾…åŠ©ä¸€äº›æ“ä½œ BgWriterè¿›ç¨‹ï¼šBgWriteræ˜¯å°†å†…å­˜ä¸­çš„æ•°æ®å†™åˆ°ç£ç›˜ä¸­çš„ä¸€ä¸ªè¾…åŠ©è¿›ç¨‹ã€‚å½“å‘æ•°æ®åº“ä¸­æ‰§è¡Œå†™æ“ä½œåï¼Œæ•°æ®ä¸ä¼šé©¬ä¸ŠæŒä¹…åŒ–åˆ°ç£ç›˜é‡Œã€‚è¿™ä¸ªä¸»è¦æ˜¯ä¸ºäº†æå‡æ€§èƒ½ã€‚BgWriterä¼šå‘¨æœŸæ€§çš„å°†å†…å­˜ä¸­çš„æ•°æ®å†™å…¥åˆ°ç£ç›˜ã€‚ä½†æ˜¯è¿™ä¸ªå‘¨æœŸæ—¶é—´ï¼Œé•¿äº†ä¸è¡Œï¼ŒçŸ­äº†ä¹Ÿä¸è¡Œã€‚ å¦‚æœå¿«äº†ï¼ŒIOæ“ä½œé¢‘ç¹ï¼Œæ•ˆç‡æ…¢ã€‚ å¦‚æœæ…¢äº†ï¼Œæœ‰æŸ¥è¯¢æ“ä½œéœ€è¦å†…å­˜ä¸­çš„æ•°æ®æ—¶ï¼Œéœ€è¦BgWriterç°æŠŠæ•°æ®ä»å†…å­˜å†™åˆ°ç£ç›˜ä¸­ï¼Œå†æä¾›ç»™æŸ¥è¯¢æ“ä½œä½œä¸ºè¿”å›ç»“æœã€‚ä¼šå¯¼è‡´æŸ¥è¯¢æ“ä½œæ•ˆç‡å˜ä½ã€‚ è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼š äº‹åŠ¡æäº¤äº†ï¼Œæ•°æ®æ²¡è½åˆ°ç£ç›˜ï¼Œè¿™æ—¶ï¼ŒæœåŠ¡å™¨å®•æœºäº†æ€ä¹ˆåŠï¼Ÿ WalWriterè¿›ç¨‹ï¼šWALå°±æ˜¯write ahead logçš„ç¼©å†™ï¼Œè¯´äººè¯å°±æ˜¯é¢„å†™æ—¥å¿—ï¼ˆredo logï¼‰ã€‚å…¶å®æ•°æ®è¿˜åœ¨å†…å­˜ä¸­æ—¶ï¼Œå…¶å®å·²ç»å†™å…¥åˆ°WALæ—¥å¿—ä¸­ä¸€ä»½ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå³ä¾¿BgWriterè¿›ç¨‹æ²¡å†™å…¥åˆ°ç£ç›˜ä¸­æ—¶ï¼Œæ•°æ®ä¹Ÿä¸ä¼šå­˜åœ¨ä¸¢å¤±çš„é—®é¢˜ã€‚ WALèƒ½å•ç‹¬åšå¤‡ä»½ä¹ˆï¼Ÿå•ç‹¬ä¸è¡Œï¼ ä½†æ˜¯WALæ—¥å¿—æœ‰ä¸ªé—®é¢˜ï¼Œè¿™ä¸ªæ—¥å¿—ä¼šå¾ªç¯ä½¿ç”¨ï¼ŒWALæ—¥å¿—æœ‰å¤§å°çš„çº¿ç¨‹ï¼Œåªèƒ½ä¿å­˜æŒ‡å®šæ—¶é—´çš„æ—¥å¿—ä¿¡æ¯ï¼Œå¦‚æœè¶…è¿‡äº†ï¼Œä¼šè¦†ç›–ä¹‹å‰çš„æ—¥å¿—ã€‚ PgArchè¿›ç¨‹ï¼šWALæ—¥å¿—ä¼šå¾ªç¯ä½¿ç”¨ï¼Œæ•°æ®ä¼šä¸¢å¤±ã€‚æ²¡å…³ç³»ï¼Œè¿˜æœ‰ä¸€ä¸ªå½’æ¡£çš„è¿›ç¨‹ï¼Œä¼šåœ¨åˆ‡æ¢walæ—¥å¿—å‰ï¼Œå°†WALæ—¥å¿—å¤‡ä»½å‡ºæ¥ã€‚PostgreSQLä¹Ÿæä¾›äº†ä¸€ä¸ªå…¨é‡å¤‡ä»½çš„æ“ä½œã€‚å¯ä»¥æ ¹æ®WALæ—¥å¿—ï¼Œé€‰æ‹©ä¸€ä¸ªäº‹ä»¶ç‚¹ï¼Œè¿›è¡Œæ¢å¤ã€‚ æŸ¥çœ‹ä¸€æ³¢WALæ—¥å¿—ï¼š è¿™äº›å°±æ˜¯å½’æ¡£æ—¥å¿— walæ—¥å¿—çš„åç§°ï¼Œæ˜¯ä¸‰å—å†…å®¹ç»„æˆï¼Œ æ¯8ä¸ªå­—ç¬¦åˆ†æˆä¸€ç»„ï¼Œç”¨16è¿›åˆ¶æ ‡è¯†çš„ 00000001 00000000 0000000A æ—¶é—´çº¿ é€»è¾‘id ç‰©ç†id æŸ¥è¯¢å½“å‰åº“ç”¨çš„æ˜¯å“ªä¸ªwalæ—¥å¿— -- æŸ¥çœ‹å½“å‰ä½¿ç”¨çš„walæ—¥å¿— æŸ¥è¯¢åˆ°çš„lsnï¼š0/47233270 select pg_current_wal_lsn(); -- åŸºäºlsnæŸ¥è¯¢å…·ä½“çš„walæ—¥å¿—åç§° 000000010000000000000047 select pg_walfile_name('0/47233270'); å½’æ¡£é»˜è®¤ä¸æ˜¯å¼€å¯çš„ï¼Œéœ€è¦æ‰‹åŠ¨å¼€å¯å½’æ¡£æ“ä½œï¼Œæ‰èƒ½ä¿è¯walæ—¥å¿—çš„å®Œæ•´æ€§ ä¿®æ”¹postgresql.confæ–‡ä»¶ # å¼€å¯walæ—¥å¿—çš„å†…å®¹ï¼Œæ³¨é‡Šå»æ‰å³å¯ wal_level = replica fsync = on # å¼€å¯å½’æ¡£æ“ä½œ archive_mode = on # ä¿®æ”¹ä¸€å°ä¸‹å‘½ä»¤ï¼Œä¿®æ”¹å­˜æ”¾å½’æ¡£æ—¥å¿—çš„è·¯å¾„ archive_command = 'test ! -f /archive/%f &amp;&amp; cp %p /archive/%f' ä¿®æ”¹å®Œä¸Šè¿°é…ç½®æ–‡ä»¶åï¼Œè®°å¾—é‡å¯postgreSQLè¿›ç¨‹ï¼Œæ‰ä¼šç”Ÿæ•ˆï¼ï¼ï¼ï¼ å½’æ¡£æ“ä½œæ‰§è¡Œæ—¶ï¼Œéœ€è¦ä¿è¯/archiveå­˜åœ¨ï¼Œå¹¶ä¸”postgresç”¨æˆ·æœ‰æƒé™è¿›è¡Œwæ“ä½œ æ„å»º/archiveè·¯å¾„ # postgresæ²¡æœ‰æƒé™åœ¨/ç›®å½•ä¸‹æ„å»ºç›®å½• # åˆ‡æ¢åˆ°rootï¼Œæ„å»ºç›®å½•ï¼Œå°†ç›®å½•çš„æ‹¥æœ‰è€…æ›´æ”¹ä¸ºpostgres mkdir /archive chown -R postgres. archive åœ¨å½“å‰åº“ä¸­åšå¤§é‡å†™æ“ä½œï¼Œæ¥å…¥åˆ°walæ—¥å¿—ï¼Œé‡ç½®åˆ‡æ¢walæ—¥å¿—ï¼Œå†æŸ¥çœ‹å½’æ¡£æƒ…å†µ å‘ç°ï¼Œå°†å½“å‰çš„æ­£åœ¨ä½¿ç”¨çš„walæ—¥å¿—å’Œæœ€æ–°çš„ä¸Šä¸€ä¸ªwalæ—¥å¿—å½’æ¡£è¿‡æ¥äº†ï¼Œä½†æ˜¯ä¹‹å‰çš„æ²¡å½’æ¡£ï¼Œä¸è¦æ…Œï¼ŒåæœŸå¤‡ä»½æ—¶ï¼Œä¼šæ‰§è¡Œå‘½ä»¤ï¼Œè¿™ä¸ªå‘½ä»¤ä¼šç›´æ¥è¦æ±‚walæ—¥å¿—ç«‹å³å½’æ¡£ï¼Œç„¶åæœ€å…¨é‡å¤‡ä»½ã€‚ 13.1 é€»è¾‘å¤‡ä»½&amp;æ¢å¤ PostgreSQLæä¾›äº†pg_dumpä»¥åŠpg_dumpallçš„å‘½ä»¤æ¥å®ç°é€»è¾‘å¤‡ä»½ã€‚ è¿™ä¸¤å‘½ä»¤å·®ä¸å¤šï¼Œçœ‹åå­—çŒœï¼ pg_dumpè¿™ç§å¤‡ä»½ï¼Œä¸ä¼šé€ æˆç”¨æˆ·å¯¹æ•°æ®çš„æ“ä½œå‡ºç°é˜»å¡ã€‚ æ•°æ®åº“ä¸æ˜¯å¾ˆå¤§çš„æ—¶å€™ï¼Œpg_dumpä¹Ÿä¸æ˜¯ä¸æˆï¼ æŸ¥çœ‹ä¸€æ³¢å‘½ä»¤ï¼š è¿™ä¸ªå‘½ä»¤ä»ä¸‰å—å»çœ‹ï¼šhttp://postgres.cn/docs/12/app-pgdump.html è¿æ¥çš„ä¿¡æ¯ï¼ŒæŒ‡å®šè¿æ¥å“ªä¸ªåº“ï¼Œç”¨å“ªä¸ªç”¨æˆ·~ optionçš„ä¿¡æ¯æœ‰å°±ç‚¹å¤šï¼ŒæŸ¥çœ‹å®˜ç½‘ã€‚ å¤‡ä»½çš„æ•°æ®åº“ï¼ æ“ä½œä¸€æ³¢ã€‚ å¤‡ä»½è€éƒ‘åº“ä¸­çš„å…¨éƒ¨æ•°æ®ã€‚ åˆ é™¤å½“å‰laozhengåº“ä¸­çš„è¡¨ç­‰ä¿¡æ¯ï¼Œç„¶åæ¢å¤æ•°æ® é™¤æ­¤ä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å›¾å½¢åŒ–ç•Œé¢å¤‡ä»½ï¼Œåœ¨åº“çš„ä½ç½®ç‚¹å‡»å¤‡ä»½å°±æˆï¼Œå¯¼å‡ºä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ã€‚ 13.2 ç‰©ç†å¤‡ä»½ï¼ˆå½’æ¡£+ç‰©ç†ï¼‰ è¿™é‡Œéœ€è¦åŸºäºå‰é¢çš„æ–‡ä»¶ç³»ç»Ÿçš„å¤‡ä»½å’Œå½’æ¡£å¤‡ä»½å®ç°æœ€ç»ˆçš„æ“ä½œ å•ç‹¬ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿçš„æ–¹å¼ï¼Œä¸æ¨èæ¯•ç«Ÿæ•°æ®ä¼šä¸¢å¤±ã€‚ è¿™é‡Œç›´æ¥ä¸ŠPostgreSQLæä¾›çš„pg_basebackupå‘½ä»¤æ¥å®ç°ã€‚ pg_basebackupä¼šåšä¸¤ä¸ªäº‹æƒ…ã€ ä¼šå°†å†…å­˜ä¸­çš„è„æ•°æ®è½åˆ°ç£ç›˜ä¸­ï¼Œç„¶åå°†æ•°æ®å…¨éƒ¨å¤‡ä»½ ä¼šå°†walæ—¥å¿—ç›´æ¥åšå½’æ¡£ï¼Œç„¶åå°†å½’æ¡£ä¹Ÿå¤‡èµ°ã€‚ æŸ¥çœ‹ä¸€æ³¢pg_basebackupå‘½ä»¤ å…ˆå‡†å¤‡ä¸€ä¸ªpg_basebackupçš„å¤‡ä»½å‘½ä»¤ # -D æŒ‡å®šå¤‡ä»½æ–‡ä»¶çš„å­˜å‚¨ä½ç½® # -Ft å¤‡ä»½æ–‡ä»¶æ‰“ä¸ªåŒ… # -Pv è¾“å‡ºå¤‡ä»½çš„è¯¦ç»†ä¿¡æ¯ # -U ç”¨æˆ·åï¼ˆè¦æ‹¥æœ‰å¤‡ä»½çš„æƒé™ï¼‰ # -h ipåœ°å€ -p ç«¯å£å· # -R å¤åˆ¶å†™é…ç½®æ–‡ä»¶ pg_basebackup -D /pg_basebackup -Ft -Pv -Upostgres -h 192.168.11.32 -p 5432 -R å‡†å¤‡æµ‹è¯•ï¼Œèµ°ä½ ~ æå‰å‡†å¤‡å‡º/pg_basebackupç›®å½•ã€‚è®°å¾—å°†æ‹¥æœ‰è€…èµ‹äºˆpostgresç”¨æˆ· mkdir /pg_basebackup chown -R postgres. /pg_basebackup/ ç»™postgresç”¨æˆ·æä¾›replicationçš„æƒé™ï¼Œä¿®æ”¹pg_hba.confï¼Œè®°å¾—é‡å¯ç”Ÿæ•ˆ æ‰§è¡Œå¤‡ä»½ pg_basebackup -D /pg_basebackup -Ft -Pv -Upostgres -h 192.168.11.32 -p 5432 -R éœ€è¦è¾“å…¥postgresçš„å¯†ç ï¼Œè¿™é‡Œå¯ä»¥è®¾ç½®ï¼Œé‡æ–°å¤‡ä»½ã€‚ æ‰§è¡Œå¤‡ä»½ 13.3 ç‰©ç†æ¢å¤ï¼ˆå½’æ¡£+ç‰©ç†ï¼‰ æ¨¡æ‹Ÿæ•°æ®åº“å´©ç›˜ï¼Œå…ˆåœæ­¢postgresqlæœåŠ¡ï¼Œç„¶åç›´æ¥åˆ æ‰dataç›®å½•ä¸‹çš„å…¨éƒ¨å†…å®¹ å°†ä¹‹å‰å¤‡ä»½çš„ä¸¤ä¸ªæ–‡ä»¶å‡†å¤‡å¥½ï¼Œä¸€ä¸ªbase.tarï¼Œä¸€ä¸ªpg_wal.tar ç¬¬ä¸€æ­¥ï¼šå°†base.tarä¸­çš„å†…å®¹ï¼Œå…¨éƒ¨è§£å‹åˆ° 12/data ç›®å½•ä¸‹ ç¬¬äºŒæ­¥ï¼šå°†pg_wal.tarä¸­çš„å†…å®¹ï¼Œå…¨éƒ¨è§£å‹åˆ° /archive ç›®å½•ä¸‹ ç¬¬ä¸‰æ­¥ï¼šåœ¨postgresql.auto.confæ–‡ä»¶ä¸­ï¼ŒæŒ‡å®šå½’æ¡£æ–‡ä»¶çš„å­˜å‚¨ä½ç½®ï¼Œä»¥åŠæ¢å¤æ•°æ®çš„æ–¹å¼ ç¬¬å››æ­¥ï¼šå¯åŠ¨postgresqlæœåŠ¡ systemctl start postgresql-12 ç¬¬äº”æ­¥ï¼šå¯åŠ¨åï¼Œå‘ç°æŸ¥è¯¢æ²¡é—®é¢˜ï¼Œä½†æ˜¯æ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œå‡ºé”™ï¼Œä¸è®©å†™ã€‚éœ€è¦æ‰§è¡Œä¸€ä¸ªå‡½æ•°ï¼Œå–æ¶ˆè¿™ç§æ¢å¤æ•°æ®åçš„çŠ¶æ€ï¼Œæ‰å…è®¸æ­£å¸¸çš„æ‰§è¡Œå†™æ“ä½œã€‚ select pg_wal_replay_resume(); 13.4 ç‰©ç†å¤‡ä»½&amp;æ¢å¤ï¼ˆPITR-Point in time Recoveryï¼‰ æ¨¡æ‹Ÿåœºæ™¯ åœºæ™¯ï¼šæ¯å¤©å‡Œæ™¨02:00ï¼Œå¼€å§‹åšå…¨å¤‡ï¼ˆPBKï¼‰ï¼Œåˆ°äº†ç¬¬äºŒå¤©ï¼Œå¦‚æœæœ‰äºº14:00åˆ†å°†æ•°æ®åšäº†è¯¯åˆ ï¼Œå¸Œæœ›å°†æ•°æ®æ¢å¤åˆ°14:00åˆ†è¯¯åˆ ä¹‹å‰çš„çŠ¶æ€ï¼Ÿ 1ã€æ¢å¤å…¨å¤‡æ•°æ®ï¼Œä½¿ç”¨PBKçš„å…¨å¤‡æ•°æ®æ¢å¤åˆ°å‡Œæ™¨02:00çš„æ•°æ®ã€‚ï¼ˆæ•°æ®ä¼šä¸¢å¤±å¾ˆå¤šï¼‰ 2ã€å½’æ¡£æ¢å¤ï¼šå¤‡ä»½ä¸­çš„å½’æ¡£ï¼Œæœ‰02:00~14:00ä¹‹é—´çš„é¢æ•°æ®ä¿¡æ¯ï¼Œå¯ä»¥åŸºäºå½’æ¡£æ—¥å¿—å°†æ•°æ®æ¢å¤åˆ°æŒ‡å®šçš„äº‹åŠ¡idæˆ–è€…æ˜¯æŒ‡å®šæ—¶é—´ç‚¹ï¼Œä»è€Œå®ç°æ•°æ®çš„å®Œæ•´æ¢å¤ã€‚ å‡†å¤‡åœºæ™¯å’Œå…·ä½“æ“ä½œ 1ã€æ„å»ºä¸€å¼ t3è¡¨æŸ¥è¯¢ä¸€äº›æ•°æ® -- æ„å»ºä¸€å¼ è¡¨ create table t3 (id int); insert into t3 values (1); insert into t3 values (11); 2ã€æ¨¡æ‹Ÿå‡Œæ™¨2ç‚¹å¼€å§‹åšå…¨å¤‡æ“ä½œ pg_basebackup -D /pg_basebackup -Ft -Pv -Upostgres -h 192.168.11.32 -p 5432 -R 3ã€å†æ¬¡åšä¸€äº›å†™æ“ä½œï¼Œç„¶åè¯¯åˆ æ•°æ® -- å‡Œæ™¨2ç‚¹å·²ç»å…¨å¤‡å®Œæ¯• -- æ¨¡æ‹Ÿç¬¬äºŒå¤©æ“ä½œ insert into t3 values (111); insert into t3 values (1111); -- è¯¯åˆ æ“ä½œ 2023å¹´3æœˆ20æ—¥20:13:26 delete from t3; 4ã€æ¢å¤æ•°æ®ï¼ˆç¡®è®¤æœ‰å½’æ¡£æ—¥å¿—ï¼‰ å°†å½“å‰æœåŠ¡çš„æ•°æ®å…¨éƒ¨å¹²æ‰ï¼ŒæŒ‰ç…§ä¹‹å‰çš„å…¨å¤‡æ¢å¤çš„å¥—è·¯å…ˆèµ°ç€ ç„¶åå°†å…¨å¤‡çš„å†…å®¹ä¸­çš„base.taræ‰”dataç›®å½•ä¸‹ï¼Œå½’æ¡£æ—¥å¿—ä¹Ÿæ‰”åˆ°/archiveä½ç½®ã€‚ 5ã€æŸ¥çœ‹å½’æ¡£æ—¥å¿—ï¼Œæ‰¾åˆ°æŒ‡å®šçš„äº‹åŠ¡id æŸ¥çœ‹å½’æ¡£æ—¥å¿—ï¼Œéœ€è¦åŸºäºpostgresqlæä¾›çš„ä¸€ä¸ªå‘½ä»¤ # å¦‚æœå‘½ä»¤æœªæ‰¾åˆ°ï¼Œè¯´æ˜ä¸¤ç§æƒ…å†µï¼Œè¦ä¹ˆæ²¡æœ‰è¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¦ä¹ˆæ˜¯æ–‡ä»¶åœ¨ï¼Œæ²¡è®¾ç½®ç¯å¢ƒå˜é‡ # å’±ä»¬è¿™æ˜¯åè€… pg_waldump # ä¹Ÿå¯ä»¥é‡‡ç”¨å…¨è·¯å¾„çš„æ–¹å¼ /usr/pgsql-12/bin/pg_waldump 6ã€ä¿®æ”¹dataç›®å½•ä¸‹çš„æ¢å¤æ•°æ®çš„æ–¹å¼ ä¿®æ”¹postgresql.auto.confæ–‡ä»¶ å°†ä¹‹å‰çš„æœ€å¤§æ¢å¤ï¼Œæ›´æ¢ä¸ºæŒ‡å®šçš„äº‹åŠ¡idæ¢å¤ åŸºäºæä¾›çš„é…ç½®ä¾‹å­ï¼Œå¦‚ä½•æŒ‡å®šäº‹åŠ¡id ä¿®æ”¹postgresql.auto.confæ–‡ä»¶æŒ‡å®šå¥½äº‹åŠ¡ID 7ã€å¯åŠ¨postgreSQLæœåŠ¡ï¼ŒæŸ¥çœ‹æ˜¯å¦æ¢å¤åˆ°æŒ‡å®šäº‹åŠ¡ID 8ã€è®°å¾—æ‰§è¡Œä¼šåçš„å‡½æ•°ï¼Œé¿å…æ— æ³•æ‰§è¡Œå†™æ“ä½œ select pg_wal_replay_resume(); åå››ã€æ•°æ®è¿ç§» PostgreSQLåšæ•°æ®è¿ç§»çš„æ’ä»¶éå¸¸å¤šï¼Œå¯ä»¥ä»MySQLè¿ç§»åˆ°PostgreSQLä¹Ÿå¯ä»¥åŸºäºå…¶ä»–æ•°æ®æºè¿ç§»åˆ°PostgreSQL è¿™ç§è¿ç§»çš„æ’ä»¶å¾ˆå¤šï¼Œè¿™é‡Œåªè¯´ä¸€ä¸ªï¼Œpgloaderï¼ˆå·¨æ–¹ä¾¿ï¼‰ ä»¥MySQLæ•°æ®è¿ç§»åˆ°PostgreSQLä¸ºä¾‹ï¼Œåˆ†ä¸ºå‡ ä¸ªæ“ä½œï¼š 1ã€å‡†å¤‡MySQLæœåŠ¡ï¼ˆé˜²ç«å¢™é—®é¢˜ï¼Œè¿œç¨‹è¿æ¥é—®é¢˜ï¼Œæƒé™é—®é¢˜ï¼‰ å‡†å¤‡äº†ä¸€ä¸ªsms_platformçš„åº“ï¼Œé‡Œé¢å¤§æ¦‚æœ‰26Wæ¡å·¦å³çš„æ•°æ® 2ã€å‡†å¤‡PostgreSQLçš„æœåŠ¡ï¼ˆä½¿ç”¨å½“å‰ä¸€ç›´ç©çš„PostgreSQLï¼‰ 3ã€å®‰è£…pgloader pgloaderå¯ä»¥å®‰è£…åœ¨ä»»ä½•ä½ç½®ï¼Œæ¯”å¦‚å®‰è£…åœ¨MySQLæ‰€åœ¨æœåŠ¡ï¼Œæˆ–è€…PostgreSQLæ‰€åœ¨æœåŠ¡ï¼Œå†æˆ–è€…ä¸€ä¸ªç‹¬ç«‹çš„æœåŠ¡éƒ½å¯ä»¥ æˆ‘å°±åœ¨PostgreSQLæ‰€åœ¨æœåŠ¡å®‰è£… # ç”¨rootç”¨æˆ·ä¸‹è½½ yum -y install pgloader 4ã€å‡†å¤‡pgloaderéœ€è¦çš„è„šæœ¬æ–‡ä»¶ å®˜æ–¹æ–‡æ¡£ï¼š https://pgloader.readthedocs.io/en/latest/ è®°ä½ï¼ŒPostgreSQLçš„æ•°æ®åº“éœ€è¦æå‰æ„å»ºå¥½æ‰å¯ä»¥ï¼ï¼ï¼ï¼ 5ã€æ‰§è¡Œè„šæœ¬ï¼Œå®Œæˆæ•°æ®è¿ç§» å…ˆç¡®è®¤pgloaderå‘½ä»¤å¯ä»¥ä½¿ç”¨ æ‰§è¡Œè„šæœ¬ï¼š pgloader åˆšåˆšå†™å¥½çš„è„šæœ¬æ–‡ä»¶ åäº”ã€ä¸»ä»æ“ä½œ PostgreSQLè‡ªèº«åªæ”¯æŒç®€å•çš„ä¸»ä»ï¼Œæ²¡æœ‰ä¸»ä»è‡ªåŠ¨åˆ‡æ¢ï¼Œä»¿ç…§ç±»ä¼¼Nginxçš„æ•ˆæœä¸€æ ·ï¼Œé‡‡ç”¨keepalivedçš„å½¢å¼ï¼Œåœ¨ä¸»èŠ‚ç‚¹å®•æœºåï¼Œé€šè¿‡è„šæœ¬çš„æ‰§è¡Œå®Œæˆä¸»ä»åˆ‡æ¢ã€‚ 15.1 ä¸»ä»å®ç°ï¼ˆå¼‚æ­¥æµå¤åˆ¶ï¼‰ æ“ä½œæ–¹å¼ç±»ä¼¼ä¸ä¹‹å‰çš„å¤‡ä»½å’Œæ¢å¤ **1ã€å‡†å¤‡ç¯å¢ƒï¼š**å‡†å¤‡ä¸¤å°è™šæ‹Ÿæœºï¼Œå®Œæˆä¸Šè¿°çš„ç¯å¢ƒå‡†å¤‡ è§’è‰² IP ç«¯å£ Master 192.168.11.66 5432 Standby 192.168.11.67 5432 ä¿®æ”¹å¥½ipï¼Œå®‰è£…å¥½postgresqlæœåŠ¡ 2ã€ç»™ä¸»å‡†å¤‡ä¸€äº›æ•°æ® create table t1 (id int); insert into t1 values (111); select * from t1; 3ã€é…ç½®ä¸»èŠ‚ç‚¹ä¿¡æ¯ï¼ˆä¸»ä»éƒ½é…ç½®ï¼Œå› ä¸ºåé¢ä¼šæœ‰ä¸»ä»åˆ‡æ¢çš„æ“ä½œï¼‰ ä¿®æ”¹ pg_hba.conf æ–‡ä»¶ ä¿®æ”¹ postgresql.conf æ–‡ä»¶ æå‰æ„å»ºå¥½å½’æ¡£æ—¥å¿—å’Œå¤‡ä»½ç›®å½•ï¼Œå¹¶ä¸”è®¾ç½®å¥½æ‹¥æœ‰è€… é‡å¯PostgreSQLæœåŠ¡ systemctl restart postgresql-12 4ã€ä»èŠ‚ç‚¹åŠ å…¥åˆ°ä¸»èŠ‚ç‚¹ å…³é—­ä»èŠ‚ç‚¹æœåŠ¡ systemctl stop postgresql-12 åˆ é™¤ä»èŠ‚ç‚¹æ•°æ®ï¼ˆåˆ é™¤dataç›®å½•ï¼‰ rm -rf ~/12/data/* åŸºäºpbkå»ä¸»èŠ‚ç‚¹å¤‡ä»½æ•°æ® # ç¡®è®¤å¥½å¤‡ä»½çš„è·¯å¾„ï¼Œè¿˜æœ‰ä¸»èŠ‚ç‚¹çš„ip pg_basebackup -D /pgbasebackup -Ft -Pv -Upostgres -h 192.168.11.66 -p 5432 -R æ¢å¤æ•°æ®æ“ä½œï¼Œè§£å‹taråŒ… cd /pgbasebackuo tar -xf base.tar -C ~/12/data tar -xf pg_wal.tar -C /archive ä¿®æ”¹postgresql.auto.confæ–‡ä»¶ # ç¡®è®¤æœ‰è¿™ä¸¤ä¸ªé…ç½®ï¼Œä¸€èˆ¬ç¬¬ä¸€ä¸ªéœ€è¦æ‰‹å†™ï¼Œç¬¬äºŒä¸ªä¼šè‡ªåŠ¨ç”Ÿæˆ restore_command = 'cp /archive/%f %p' primary_conninfo = 'user=postgres password=postgres host=192.168.11.66 port=5432 sslmode=prefer sslcompression=0 gssencmode=prefer krbsrvname=postgres target_session_attrs=any' ä¿®æ”¹standby.signalæ–‡ä»¶ï¼Œå¼€å¯ä»èŠ‚ç‚¹å¤‡ä»½æ¨¡å¼ # å¼€å¯ä»èŠ‚ç‚¹å¤‡ä»½ standby_mode = 'on' å¯åŠ¨ä»èŠ‚ç‚¹æœåŠ¡ systemctl restart postgresql-12 æŸ¥çœ‹ä¸»ä»ä¿¡æ¯ æŸ¥çœ‹ä»èŠ‚ç‚¹æ˜¯å¦æœ‰t1è¡¨ ä¸»èŠ‚ç‚¹æ·»åŠ ä¸€è¡Œæ•°æ®ï¼Œä»èŠ‚ç‚¹å†æŸ¥è¯¢ï¼Œå¯ä»¥çœ‹åˆ°æœ€æ–°çš„æ•°æ® ä»èŠ‚ç‚¹æ— æ³•å®Œæˆå†™æ“ä½œï¼Œä»–æ˜¯åªè¯»æ¨¡å¼ ä¸»èŠ‚ç‚¹æŸ¥çœ‹ä»èŠ‚ç‚¹ä¿¡æ¯ select * from pg_stat_replication ä»èŠ‚ç‚¹æŸ¥çœ‹ä¸»èŠ‚ç‚¹ä¿¡æ¯ select * from pg_stat_wal_receiver 15.2 ä¸»ä»åˆ‡æ¢ï¼ˆä¸è¿™ä¹ˆç©ï¼‰ å…¶å®ä¸»ä»çš„æœ¬è´¨å°±æ˜¯ä»èŠ‚ç‚¹å»ä¸»èŠ‚ç‚¹ä¸åœçš„å¤‡ä»½æ–°çš„æ•°æ®ã€‚ é…ç½®æ–‡ä»¶çš„ç³»ç»Ÿå…¶å®å°±æ˜¯ä¸¤ä¸ªï¼š standby.signalæ–‡ä»¶ï¼Œè¿™ä¸ªæ˜¯ä»èŠ‚ç‚¹å¼€å¯å¤‡ä»½ postgresql.auto.confæ–‡ä»¶ï¼Œè¿™ä¸ªä»èŠ‚ç‚¹æŒ‡å®šä¸»èŠ‚ç‚¹çš„åœ°å€ä¿¡æ¯ åˆ‡æ¢å°±æ˜¯åŸä¸»è¿½åŠ ä¸Šè¿°é…ç½®ï¼ŒåŸä»åˆ é™¤ä¸Šè¿°é…è¿½ 1ã€ä¸»ä»èŠ‚ç‚¹å…¨éƒ¨stopåœæ­¢ï¼šâ€¦â€¦â€¦â€¦â€¦â€¦ 2ã€åŸä»åˆ é™¤ä¸Šè¿°é…ç½®ï¼šâ€¦â€¦â€¦â€¦ 3ã€åŸä»æ–°ä¸»å¯åŠ¨æœåŠ¡ï¼šâ€¦â€¦â€¦ 4ã€åŸä¸»æ–°ä»å»åŸä»æ–°ä¸»å¤‡ä»½ä¸€æ¬¡æ•°æ®ï¼špg_basebackupæ“ä½œï¼ŒåŒæ—¶åšè§£å‹ï¼Œç„¶åä¿®æ”¹postgresql.confæ–‡ä»¶ä»¥åŠstandby.signalé…ç½®æ–‡ä»¶ 5ã€å¯åŠ¨åŸä¸»æ–°ä»æŸ¥çœ‹ä¿¡æ¯ 15.3 ä¸»ä»æ•…éšœåˆ‡æ¢ é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™é‡Œçš„ä¸»ä»å¤‡ä»½æ˜¯å¼‚æ­¥çš„ï¼Œå¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœä¸»èŠ‚ç‚¹å†™å…¥çš„æ•°æ®è¿˜æ²¡æœ‰å¤‡ä»½åˆ°ä»èŠ‚ç‚¹ï¼Œä¸»èŠ‚ç‚¹å¿½ç„¶å®•æœºäº†ï¼Œå¯¼è‡´åé¢å¦‚æœåŸºäºä¸Šè¿°æ–¹å¼å®ç°ä¸»ä»åˆ‡æ¢ï¼Œæ•°æ®å¯èƒ½ä¸¢å¤±ã€‚ PGSQLåœ¨9.5ç‰ˆæœ¬åæä¾›äº†ä¸€ä¸ªpg_rewindçš„æ“ä½œï¼ŒåŸºäºå½’æ¡£æ—¥å¿—å¸®å’±ä»¬åšä¸€ä¸ªæ¯”å¯¹ï¼Œæ¯”å¯¹å½’æ¡£æ—¥å¿—ï¼Œæ˜¯å¦æœ‰æ—¶é—´å·®å†²çªã€‚ å®ç°æ“ä½œï¼š 1ã€rewindéœ€è¦å¼€å¯ä¸€é¡¹é…ç½®æ‰å¯ä»¥ä½¿ç”¨ ä¿®æ”¹postgresql.confä¸­çš„ wal_log_hints = â€˜onâ€™ 2ã€ä¸ºäº†å¯ä»¥æ›´æ–¹ä¾¿çš„ä½¿ç”¨rewindï¼Œéœ€è¦è®¾ç½®ä¸€ä¸‹ /usr/pgsql-12/bin/ çš„ç¯å¢ƒå˜é‡ vi /etc/profile è¿½åŠ ä¿¡æ¯ export PATH=/usr/pgsql-12/bin/:$PATH source /etc/profile 3ã€æ¨¡æ‹Ÿä¸»åº“å®•æœºï¼Œç›´æ¥å¯¹ä¸»åº“å…³æœº 4ã€ä»èŠ‚ç‚¹åˆ‡æ¢ä¸ºä¸»èŠ‚ç‚¹ # å› ä¸ºä»–ä¼šå»æ‰¾$PGDATAï¼Œæˆ‘æ²¡é…ç½®ï¼Œå°±åŸºäº-DæŒ‡å®šä¸€ä¸‹PGSQLçš„dataç›®å½• pg_ctl promote -D ~/12/data/ 5ã€å°†åŸä¸»èŠ‚ç‚¹å¼€æœºï¼Œæ‰§è¡Œå‘½ä»¤ï¼Œæå®šå½’æ¡£æ—¥å¿—çš„åŒæ­¥ å¯åŠ¨è™šæ‹Ÿæœº åœæ­¢PGSQLæœåŠ¡ pg_ctl stop -D ~/12/data åŸºäºpg_rewindåŠ å…¥åˆ°é›†ç¾¤ pg_rewind -D ~/12/data/ --source-server='host=192.168.11.66 user=postgres password=postgres' å¦‚æœä¸Šè¿°å‘½ä»¤å¤±è´¥ï¼Œéœ€è¦å¯åŠ¨å†å…³é—­PGSQLï¼Œå¹¶ä¸”åœ¨æ‰§è¡Œï¼Œå®Œæˆå½’æ¡£æ—¥å¿—çš„åŒæ­¥ pg_ctl start -D ~/12/data pg_ctl stop -D ~/12/data pg_rewind -D ~/12/data/ --source-server='host=192.168.11.66 user=postgres password=postgres' 6ã€ä¿®æ”¹æ–°ä»èŠ‚ç‚¹çš„é…ç½®ï¼Œç„¶åå¯åŠ¨ æ„å»ºstandby.signal standby_mode = 'on' ä¿®æ”¹postgresql.auto.confæ–‡ä»¶ # æ³¨æ„ipåœ°å€ primary_conninfo = 'user=postgres password=postgres host=192.168.11.66 port=5432 sslmode=prefer sslcompression=0 gssencmode=prefer krbsrvname=postgres target_session_attrs=any' restore_command = 'cp /archive/%f %p' å¯åŠ¨æ–°çš„ä»èŠ‚ç‚¹ pg_ctl start -D ~/12/data/ ","link":"https://tianxiawuhao.github.io/uSSvVMkpS/"},{"title":"PostgreSQLæ¦‚è¿°äºŒ","content":"ä¸ƒã€æ•°æ®ç±»å‹ PGSQLæ”¯æŒçš„ç±»å‹ç‰¹åˆ«ä¸°å¯Œï¼Œå¤§å¤šæ•°çš„ç±»å‹å’ŒMySQLéƒ½æœ‰å¯¹åº”çš„å…³ç³» åç§° è¯´æ˜ å¯¹æ¯”MySQL å¸ƒå°”ç±»å‹ booleanï¼Œæ ‡å‡†çš„å¸ƒå°”ç±»å‹ï¼Œåªèƒ½å­˜å‚¨trueï¼Œfalse MySQLä¸­è™½ç„¶æ²¡æœ‰å¯¹åº”çš„booleanï¼Œä½†æ˜¯æœ‰æ›¿æ¢çš„ç±»å‹ï¼Œæ•°å€¼çš„tinyintç±»å‹ï¼Œå’ŒPGSQLçš„booleanéƒ½æ˜¯å 1ä¸ªå­—èŠ‚ã€‚ æ•´å‹ smallintï¼ˆ2å­—èŠ‚ï¼‰ï¼Œintegerï¼ˆ4å­—èŠ‚ï¼‰ï¼Œbigintï¼ˆ8å­—èŠ‚ï¼‰ è·ŸMySQLæ²¡å•¥åŒºåˆ«ã€‚ æµ®ç‚¹å‹ decimalï¼Œnumericï¼ˆå’Œdecimalä¸€æ ·ä¸€æ ·çš„ï¼Œç²¾å‡†æµ®ç‚¹å‹ï¼‰ï¼Œrealï¼ˆfloatï¼‰ï¼Œdouble precisionï¼ˆdoubleï¼‰ï¼Œmoneyï¼ˆè´§å¸ç±»å‹ï¼‰ å’ŒMySQLåŸºæœ¬ä¹Ÿæ²¡åŒºåˆ«ï¼ŒMySQLæ”¯æŒfloatï¼Œdoubleï¼Œdecimalã€‚MySQLæ²¡æœ‰è¿™ä¸ªè´§å¸ç±»å‹ã€‚ å­—ç¬¦ä¸²ç±»å‹ varchar(n)ï¼ˆcharacter varyingï¼‰ï¼Œchar(n)ï¼ˆcharacterï¼‰ï¼Œtext è¿™é‡Œå’ŒMySQLåŸºæœ¬æ²¡åŒºåˆ«ã€‚PGSQLå­˜å‚¨çš„varcharç±»å‹ï¼Œå¯ä»¥å­˜å‚¨ä¸€ä¸ªGã€‚MySQLå¥½åƒå­˜å‚¨64kbï¼ˆåº”è¯¥æ˜¯ï¼‰ã€‚ æ—¥æœŸç±»å‹ dateï¼ˆå¹´æœˆæ—¥ï¼‰ï¼Œtimeï¼ˆæ—¶åˆ†ç§’ï¼‰ï¼Œtimestampï¼ˆå¹´æœˆæ—¥æ—¶åˆ†ç§’ï¼‰ï¼ˆtimeå’Œtimestampå¯ä»¥è®¾ç½®æ—¶åŒºï¼‰ æ²¡å•¥è¯´çš„ï¼Œå’ŒMySQLåŸºæœ¬æ²¡åŒºåˆ«ã€‚MySQLæœ‰ä¸ªdatetimeã€‚ äºŒè¿›åˆ¶ç±»å‹ bytea-å­˜å‚¨äºŒè¿›åˆ¶ç±»å‹ MySQLä¹Ÿæ”¯æŒï¼ŒMySQLä¸­æ˜¯blob ä½å›¾ç±»å‹ bit(n)ï¼ˆå®šé•¿ä½å›¾ï¼‰ï¼Œbit varying(n)ï¼ˆå¯å˜é•¿åº¦ä½å›¾ï¼‰ å°±æ˜¯å­˜å‚¨0ï¼Œ1ã€‚MySQLä¹Ÿæœ‰ï¼Œåªæ˜¯è¿™ä¸ªç±»å‹ç”¨çš„ä¸å¤šã€‚ æšä¸¾ç±»å‹ enumï¼Œè·ŸJavaçš„enumä¸€æ · MySQLä¹Ÿæ”¯æŒã€‚ å‡ ä½•ç±»å‹ ç‚¹ï¼Œç›´çº¿ï¼Œçº¿æ®µï¼Œåœ†â€¦â€¦â€¦â€¦ MySQLæ²¡æœ‰ï¼Œä½†æ˜¯ä¸€èˆ¬å¼€å‘ä¹Ÿç”¨ä¸åˆ° æ•°ç»„ç±»å‹ åœ¨ç±»å‹åï¼Œè¿½åŠ []ï¼Œä»£è¡¨å­˜å‚¨æ•°ç»„ MySQLæ²¡æœ‰~~~ JSONç±»å‹ jsonï¼ˆå­˜å‚¨JSONæ•°æ®çš„æ–‡æœ¬ï¼‰ï¼Œjsonbï¼ˆå­˜å‚¨JSONäºŒè¿›åˆ¶ï¼‰ å¯ä»¥å­˜å‚¨JSONï¼ŒMySQL8.xä¹Ÿæ”¯æŒ ipç±»å‹ cidrï¼ˆå­˜å‚¨ipåœ°å€ï¼‰ MySQLä¹Ÿä¸æ”¯æŒ~ å…«ã€PostgreSQLåŸºæœ¬æ“ä½œ&amp;æ•°æ®ç±»å‹ 8.1 å•å¼•å·å’ŒåŒå¼•å· åœ¨PGSQLä¸­ï¼Œå†™SQLè¯­å¥æ—¶ï¼Œå•å¼•å·ç”¨æ¥æ ‡è¯†å®é™…çš„å€¼ã€‚åŒå¼•å·ç”¨æ¥æ ‡è¯†ä¸€ä¸ªå…³é”®å­—ï¼Œæ¯”å¦‚è¡¨åï¼Œå­—æ®µåã€‚ -- å•å¼•å·å†™å…·ä½“çš„å€¼ï¼ŒåŒå¼•å·ç±»ä¼¼MySQLçš„``æ ‡è®°ï¼Œç”¨æ¥å¡«å……å…³é”®å­— -- ä¸‹é¢çš„è‘¡è„ç‰™ä¼šæŠ¥é”™ï¼Œå› ä¸ºè‘¡è„ç‰™ä¸æ˜¯å…³é”®å­— select 1.414,'å¡å¡”å°”',&quot;è‘¡è„ç‰™&quot;; 8.2 æ•°æ®ç±»å‹è½¬æ¢ ç¬¬ä¸€ç§æ–¹å¼ï¼šåªéœ€è¦åœ¨å€¼çš„å‰é¢ï¼Œæ·»åŠ ä¸Šå…·ä½“çš„æ•°æ®ç±»å‹å³å¯ -- å°†å­—ç¬¦ä¸²è½¬æˆä½å›¾ç±»å‹ select bit '010101010101001'; ç¬¬äºŒç§æ–¹å¼ï¼šä¹Ÿå¯ä»¥åœ¨å…·ä½“å€¼çš„åé¢ï¼Œæ·»åŠ ä¸Š ::ç±»å‹ ï¼Œæ¥æŒ‡å®š -- æ•°æ®ç±»å‹ select '2011-11-11'::date; select '101010101001'::bit(20); select '13'::int; ç¬¬ä¸‰ç§æ–¹å¼ï¼šä½¿ç”¨CASTå‡½æ•° -- ç±»å‹è½¬æ¢çš„å®Œæ•´å†™æ³• select CAST(varchar '100' as int); 8.3 å¸ƒå°”ç±»å‹ å¸ƒå°”ç±»å‹ç®€å•çš„ä¸«æ‰¹ï¼Œå¯ä»¥å­˜å‚¨ä¸‰ä¸ªå€¼ï¼Œtrueï¼Œfalseï¼Œnull -- å¸ƒå°”ç±»å‹çš„çº¦æŸæ²¡æœ‰é‚£ä¹ˆå¼ºï¼Œtrueï¼Œfalseå¤§å°å†™éšæ„ï¼Œä»–ä¼šç»™ä½ è½¬ï¼ŒåŒæ—¶yesï¼Œnoè¿™ç§ä»–ä¹Ÿè®¤è¯†ï¼Œä½†æ˜¯éœ€è¦è½¬æ¢ select true,false,'yes'::boolean,boolean 'no',True,FaLse,NULL::boolean; booleanç±»å‹åœ¨åšandå’Œorçš„é€»è¾‘æ“ä½œæ—¶ï¼Œç»“æœ å­—æ®µA å­—æ®µB a and b a or b true true true true true false false true true NULL NULL true false false false false false NULL false NULL 8.4 æ•°å€¼ç±»å‹ 8.4.1 æ•´å‹ æ•´å‹æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯ä¸‰ä¸ªï¼š smallintã€int2ï¼š2å­—èŠ‚ integerã€intã€int4ï¼š4å­—èŠ‚ bigintã€int8ï¼š8å­—èŠ‚ æ­£å¸¸æ²¡å•¥äº‹å°±integerï¼Œå¦‚æœè¦å­˜ä¸»é”®ï¼Œæ¯”å¦‚é›ªèŠ±ç®—æ³•ï¼Œé‚£å°±bigintã€‚ç©ºé—´è¦èŠ‚çº¦ï¼Œæ ¹æ®æƒ…å†µsmallint 8.4.2 æµ®ç‚¹å‹ æµ®ç‚¹ç±»å‹å°±å…³æ³¨2ä¸ªï¼ˆå…¶å®æ˜¯ä¸€ä¸ªï¼‰ decimal(n,m)ï¼šæœ¬è´¨å°±æ˜¯numericï¼ŒPGSQLä¼šå¸®ä½ è½¬æ¢ numeric(n,m)ï¼šPGSQLæœ¬è´¨çš„æµ®ç‚¹ç±»å‹ é’ˆå¯¹æµ®ç‚¹ç±»å‹çš„æ•°æ®ï¼Œå°±ä½¿ç”¨ numeric 8.4.3 åºåˆ— MySQLä¸­çš„ä¸»é”®è‡ªå¢ï¼Œæ˜¯åŸºäºauto_incrementå»å®ç°ã€‚MySQLé‡Œæ²¡æœ‰åºåˆ—çš„å¯¹è±¡ã€‚ PGSQLå’ŒOracleååˆ†ç›¸ä¼¼ï¼Œæ”¯æŒåºåˆ—ï¼šsequenceã€‚ PGSQLå¯æ²¡æœ‰auto_incrementã€‚ åºåˆ—çš„æ­£å¸¸æ„å»ºæ–¹å¼ï¼š create sequence laozheng.table_id_seq; -- æŸ¥è¯¢ä¸‹ä¸€ä¸ªå€¼ select nextval('laozheng.table_id_seq'); -- æŸ¥è¯¢å½“å‰å€¼ select currval('laozheng.table_id_seq'); é»˜è®¤æƒ…å†µä¸‹ï¼Œseqeunceçš„èµ·å§‹å€¼æ˜¯0ï¼Œæ¯æ¬¡nextvalé€’å¢1ï¼Œæœ€å¤§å€¼9223372036854775807 å‘Šè¯‰ç¼“å­˜ï¼Œæ’å…¥çš„æ•°æ®æ¯”è¾ƒå¤šï¼Œå¯ä»¥æŒ‡å®šå‘Šè¯‰ç¼“å­˜ï¼Œä¸€æ¬¡æ€§è®¡ç®—å‡º20ä¸ªåç»­çš„å€¼ï¼Œnextvalæ—¶ï¼Œå°±ä¸å¯ä»¥ä¸å»è®¡ç®—ï¼Œç›´æ¥å»é«˜é€Ÿç¼“å­˜æ‹¿å€¼ï¼Œæ•ˆç‡ä¼šæœ‰ä¸€å†…å†…çš„æå‡ã€‚ åºåˆ—å¤§å¤šæ•°çš„åº”ç”¨ï¼Œæ˜¯ç”¨ä½œè¡¨çš„ä¸»é”®è‡ªå¢æ•ˆæœã€‚ -- è¡¨è‡ªå¢ create table laozheng.xxx( id int8 default nextval('laozheng.table_id_seq'), name varchar(16) ); insert into laozheng.xxx (name) values ('xxx'); select * from laozheng.xxx; ä¸Šé¢è¿™ç§å†™æ³•æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯å¾ˆä¸çˆ½~å¾ˆéº»çƒ¦ã€‚ PGSQLæä¾›äº†åºåˆ—çš„æ•°æ®ç±»å‹ï¼Œå¯ä»¥åœ¨å£°æ˜è¡¨ç»“æ„æ—¶ï¼Œç›´æ¥æŒ‡å®šåºåˆ—çš„ç±»å‹å³å¯ã€‚ bigserialç›¸å½“äºç»™bigintç±»å‹è®¾ç½®äº†åºåˆ—å®ç°è‡ªå¢ã€‚ smallserial serial bigserial -- è¡¨è‡ªå¢ï¼ˆçˆ½ï¼‰ create table laozheng.yyy( id bigserial, name varchar(16) ); insert into laozheng.yyy (name) values ('yyy'); åœ¨dropè¡¨ä¹‹åï¼Œåºåˆ—ä¸ä¼šè¢«åˆ é™¤ï¼Œä½†æ˜¯åºåˆ—ä¼šå˜ä¸ºä¸å¯ç”¨çš„çŠ¶æ€ã€‚ å› ä¸ºåºåˆ—åœ¨ä½¿ç”¨serialå»æ„å»ºæ—¶ï¼Œä¼šç»‘å®šåˆ°æŒ‡å®šè¡¨çš„æŒ‡å®šåˆ—ä¸Šã€‚ å¦‚æœæ˜¯å•ç‹¬æ„å»ºåºåˆ—ï¼Œå†æ„å»ºè¡¨ï¼Œä½¿ç”¨ä¼ ç»Ÿæ–¹å¼å®ç°ï¼Œåºåˆ—å’Œè¡¨å°±æ˜¯ç›¸å¯¹ç‹¬ç«‹çš„ã€‚ 8.4.4 æ•°å€¼çš„å¸¸è§æ“ä½œ é’ˆå¯¹æ•°å€¼å’±ä»¬å¯ä»¥å®ç°åŠ å‡ä¹˜é™¤å–ä½™è¿™5ä¸ªæ“ä½œ è¿˜æœ‰å…¶ä»–çš„æ“ä½œæ–¹å¼ æ“ä½œç¬¦ æè¿° ç¤ºä¾‹ ç»“æœ ^ å¹‚ 2 ^ 3 8 |/ å¹³æ–¹æ ¹ |/ 36 6 @ ç»å¯¹å€¼ @ -5 5 &amp; ä¸ 31 &amp; 16 16 | æˆ– 31|32 63 &lt;&lt; å·¦ç§» 1&lt;&lt;1 2 &gt;&gt; å³ç§» 16&gt;&gt;1 8 æ•°å€¼æ“ä½œä¹Ÿæä¾›äº†ä¸€äº›å‡½æ•°ï¼Œæ¯”å¦‚pi()ï¼Œround(æ•°å€¼ï¼Œä½æ•°)ï¼Œfloor()ï¼Œceil() 8.5 å­—ç¬¦ä¸²ç±»å‹ å­—ç¬¦ä¸²ç±»å‹ç”¨çš„æ˜¯æœ€å¤šçš„ä¸€ç§ï¼Œåœ¨PGSQLé‡Œï¼Œä¸»è¦æ”¯æŒä¸‰ç§ï¼š characterï¼ˆå°±æ˜¯MySQLçš„charç±»å‹ï¼‰ï¼Œå®šé•¿å­—ç¬¦ä¸²ã€‚ï¼ˆæœ€å¤§å¯ä»¥å­˜å‚¨1Gï¼‰ character varyingï¼ˆvarcharï¼‰ï¼Œå¯å˜é•¿åº¦çš„å­—ç¬¦ä¸²ã€‚ï¼ˆæœ€å¤§å¯ä»¥å­˜å‚¨1Gï¼‰ textï¼ˆè·ŸMySQLå¼‚å¸¸ï¼‰é•¿åº¦ç‰¹åˆ«é•¿çš„å­—ç¬¦ä¸²ã€‚ æ“ä½œæ²¡ä»€ä¹ˆè¯´çš„ï¼Œä½†æ˜¯å­—ç¬¦ä¸²å¸¸è§çš„å‡½æ•°ç‰¹åˆ«å¤šã€‚ å­—ç¬¦ä¸²çš„æ‹¼æ¥ä¸€è¦è¦ä½¿ç”¨||æ¥æ‹¼æ¥ã€‚ å…¶ä»–çš„å‡½æ•°ï¼Œå¯ä»¥æŸ¥çœ‹ http://www.postgres.cn/docs/12/functions-string.html 8.6 æ—¥æœŸç±»å‹ åœ¨PGSQLä¸­ï¼Œæ ¸å¿ƒçš„æ—¶é—´ç±»å‹ï¼Œå°±ä¸‰ä¸ªã€‚ timestampï¼ˆæ—¶é—´æˆ³ï¼Œè¦†ç›– å¹´æœˆæ—¥æ—¶åˆ†ç§’ï¼‰ dateï¼ˆå¹´æœˆæ—¥ï¼‰ timeï¼ˆæ—¶åˆ†ç§’ï¼‰ åœ¨PGSQLä¸­ï¼Œå£°æ˜æ—¶é—´çš„æ–¹å¼ã€‚ åªéœ€è¦ä½¿ç”¨å­—ç¬¦ä¸²æ­£å¸¸çš„ç¼–å†™ yyyy-MM-dd HH:mm:ss å°±å¯ä»¥è½¬æ¢ä¸ºæ—¶é—´ç±»å‹ã€‚ ç›´æ¥åœ¨å­—ç¬¦ä¸²ä½ç½®ä½¿ç”¨ä¹‹å‰è®²åˆ°çš„æ•°æ®ç±»å‹è½¬æ¢å°±å¯ä»¥äº†ã€‚ å½“å‰ç³»ç»Ÿæ—¶é—´ ï¼š å¯ä»¥ä½¿ç”¨nowä½œä¸ºå½“å‰ç³»ç»Ÿæ—¶é—´ï¼ˆæ²¡æœ‰æ—¶åŒºçš„æ¦‚å¿µï¼‰ select timestamp 'now'; -- ç›´æ¥æŸ¥è¯¢nowï¼Œæ²¡æœ‰æ—¶åŒºçš„æ¦‚å¿µ select time with time zone 'now' at time zone '08:00:00' ä¹Ÿå¯ä»¥ä½¿ç”¨current_timestampçš„æ–¹å¼è·å–ï¼ˆæ¨èï¼Œé»˜è®¤ä¸œå…«åŒºï¼‰ æ—¥æœŸç±»å‹çš„è¿ç®— æ­£å¸¸å¯¹dateç±»å‹åš+ï¼Œ-æ“ä½œï¼Œé»˜è®¤å•ä½å°±æ˜¯å¤©~ date + time = timestamp~~~ select date '2011-11-11' + time '12:12:12' ; å¯ä»¥é’ˆå¯¹timestampä½¿ç”¨intervalçš„æ–¹å¼è¿›è¡Œ +ï¼Œ-æ“ä½œï¼Œåœ¨æŸ¥è¯¢ä»¥æ—¶é—´èŒƒå›´ä¸ºæ¡ä»¶çš„å†…å®¹æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ select timestamp '2011-11-11 12:12:12' + interval '1day' + interval '1minute' + interval '1month'; 8.7 æšä¸¾ç±»å‹ æšä¸¾ç±»å‹MySQLä¹Ÿæ”¯æŒï¼Œåªæ˜¯æ²¡æ€ä¹ˆç”¨ï¼ŒPGSQLåŒæ ·æ”¯æŒè¿™ç§æ•°æ®ç±»å‹ å¯ä»¥å£°æ˜æšä¸¾ç±»å‹ä½œä¸ºè¡¨ä¸­çš„å­—æ®µç±»å‹ï¼Œè¿™æ ·å¯ä»¥æ— å½¢çš„ç»™è¡¨å­—æ®µè¿½åŠ è¯¡å¼‚çš„è§„èŒƒã€‚ -- å£°æ˜ä¸€ä¸ªæ˜ŸæœŸçš„æšä¸¾ï¼Œå€¼è‡ªç„¶åªæœ‰å‘¨ä¸€~å‘¨æ—¥ã€‚ create type week as enum ('Mon','Tues','Sun'); -- å£°æ˜ä¸€å¼ è¡¨ï¼Œè¡¨ä¸­çš„æŸä¸ªå­—æ®µçš„ç±»å‹æ˜¯ä¸Šé¢å£°æ˜çš„æšä¸¾ã€‚ drop table test; create table test( id bigserial , weekday week ); insert into test (weekday) values ('Mon'); insert into test (weekday) values ('Fri'); 8.8 IPç±»å‹ PGSQLæ”¯æŒIPç±»å‹çš„å­˜å‚¨ï¼Œæ”¯æŒIPv4ï¼ŒIPv6è¿™ç§ï¼Œç”šè‡³Macè¿™ç§è¯¡å¼‚ç±»å‹ä¹Ÿæ”¯æŒ è¿™ç§IPç±»å‹ï¼Œå¯ä»¥åœ¨å­˜å‚¨IPæ—¶ï¼Œå¸®åŠ©åšæ ¡éªŒï¼Œå…¶æ¬¡ä¹Ÿå¯ä»¥é’ˆå¯¹IPåšèŒƒå›´æŸ¥æ‰¾ã€‚ IPæ ¡éªŒçš„æ•ˆæœ IPä¹Ÿæ”¯æŒèŒƒå›´æŸ¥æ‰¾ã€‚ 8.9 JSON&amp;JSONBç±»å‹ JSONåœ¨MySQL8.xä¸­ä¹Ÿåšäº†æ”¯æŒï¼Œä½†æ˜¯MySQLæ”¯æŒçš„ä¸å¥½ï¼Œå› ä¸ºJSONç±»å‹åšæŸ¥è¯¢æ—¶ï¼ŒåŸºæœ¬æ— æ³•ç»™JSONå­—æ®µåšç´¢å¼•ã€‚ PGSQLæ”¯æŒJSONç±»å‹ä»¥åŠJSONBç±»å‹ã€‚ JSONå’ŒJSONBçš„ä½¿ç”¨åŸºæœ¬æ²¡åŒºåˆ«ã€‚ æ’‡å»JSONç±»å‹ï¼Œæœ¬è´¨ä¸ŠJSONæ ¼å¼å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ¯”å¦‚MySQL5.7ä¸æ”¯æŒJSONçš„æƒ…å†µçš„ä¸‹ï¼Œä½¿ç”¨textä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯å­—ç¬¦ä¸²ç±»å‹æ— æ³•æ ¡éªŒJSONçš„æ ¼å¼ï¼Œå…¶æ¬¡å•ç‹¬çš„å­—ç¬¦ä¸²æ²¡æœ‰åŠæ³•åªè·å–JSONä¸­æŸä¸ªkeyå¯¹åº”çš„valueã€‚ JSONå’ŒJSONBçš„åŒºåˆ«ï¼š JSONç±»å‹æ— æ³•æ„å»ºç´¢å¼•ï¼ŒJSONBç±»å‹å¯ä»¥åˆ›å»ºç´¢å¼•ã€‚ JSONç±»å‹çš„æ•°æ®ä¸­å¤šä½™çš„ç©ºæ ¼ä¼šè¢«å­˜å‚¨ä¸‹æ¥ã€‚JSONBä¼šè‡ªåŠ¨å–æ¶ˆå¤šä½™çš„ç©ºæ ¼ã€‚ JSONç±»å‹ç”šè‡³å¯ä»¥å­˜å‚¨é‡å¤çš„keyï¼Œä»¥æœ€åä¸€ä¸ªä¸ºå‡†ã€‚JSONBä¸ä¼šä¿ç•™å¤šä½™çš„é‡å¤keyï¼ˆä¿ç•™æœ€åä¸€ä¸ªï¼‰ã€‚ JSONä¼šä¿ç•™å­˜å‚¨æ—¶keyçš„é¡ºåºï¼ŒJSONBä¸ä¼šä¿ç•™åŸæœ‰é¡ºåºã€‚ JSONä¸­keyå¯¹åº”çš„valueçš„æ•°æ®ç±»å‹ JSON PGSQL String text number numeric boolean boolean null (none) [ {&quot;name&quot;: &quot;å¼ ä¸‰&quot;}, {&quot;name&quot;: { &quot;info&quot;: &quot;xxx&quot; }} ] æ“ä½œJSONï¼š ä¸Šè¿°çš„å››ç§JSONå­˜å‚¨çš„ç±»å‹ï¼š select '9'::JSON,'null'::JSON,'&quot;laozheng&quot;'::JSON,'true'::json; select '9'::JSONB,'null'::JSONB,'&quot;laozheng&quot;'::JSONB,'true'::JSONB; JSONæ•°ç»„ select '[9,true,null,&quot;æˆ‘æ˜¯å­—ç¬¦ä¸²&quot;]'::JSON; JSONå¯¹è±¡ select '{&quot;name&quot;: &quot;å¼ ä¸‰&quot;,&quot;age&quot;: 23,&quot;birthday&quot;: &quot;2011-11-11&quot;,&quot;gender&quot;: null}'::json; select '{&quot;name&quot;: &quot;å¼ ä¸‰&quot;,&quot;age&quot;: 23,&quot;birthday&quot;: &quot;2011-11-11&quot;,&quot;gender&quot;: null}'::jsonb; æ„å»ºè¡¨å­˜å‚¨JSON create table test( id bigserial, info json, infob jsonb ); insert into test (info,infob) values ('{&quot;name&quot;: &quot;å¼ ä¸‰&quot; ,&quot;age&quot;: 23,&quot;birthday&quot;: &quot;2011-11-11&quot;,&quot;gender&quot;: null}', '{&quot;name&quot;: &quot;å¼ ä¸‰&quot; ,&quot;age&quot;: 23,&quot;birthday&quot;: &quot;2011-11-11&quot;,&quot;gender&quot;: null}') select * from test; æ„å»ºç´¢å¼•çš„æ•ˆæœ create index json_index on test(info); create index jsonb_index on test(infob); JSONè¿˜æ”¯æŒå¾ˆå¤šå‡½æ•°ã€‚å¯ä»¥ç›´æ¥æŸ¥çœ‹ http://www.postgres.cn/docs/12/functions-json.html å‡½æ•°å¤ªå¤šäº†ï¼Œä¸åˆ†æäº†ã€‚ 8.10 å¤åˆç±»å‹ å¤åˆç±»å‹å°±å¥½åƒJavaä¸­çš„ä¸€ä¸ªå¯¹è±¡ï¼ŒJavaä¸­æœ‰ä¸€ä¸ªUserï¼ŒUserå’Œè¡¨åšäº†ä¸€ä¸ªæ˜ å°„ï¼ŒUserä¸­æœ‰ä¸ªäººä¿¡æ¯å¯¹è±¡ã€‚å¯ä»¥åŸºäºç¬¦åˆç±»å‹å¯¹æ˜ å°„ä¸Šä¸ªäººä¿¡æ¯ã€‚ public class User{ private Integer id; private Info info; } class Info{ private String name; private Integer age; } æŒ‰ç…§ä¸Šé¢çš„æƒ…å†µï¼Œå°†Infoæ„å»ºæˆä¸€ä¸ªå¤åˆç±»å‹ -- æ„å»ºå¤åˆç±»å‹ï¼Œæ˜ å°„ä¸ŠInfo create type info_type as (name varchar(32),age int); -- æ„å»ºè¡¨ï¼Œæ˜ å°„User create table tb_user( id serial, info info_type ); -- æ·»åŠ æ•°æ® insert into tb_user (info) values (('å¼ ä¸‰',23)); insert into tb_user (info) values (('éœ²ä¸',233)); insert into tb_user (info) values (('jack',33)); insert into tb_user (info) values (('æå››',24)); select * from tb_user; 8.11 æ•°ç»„ç±»å‹ æ•°ç»„è¿˜æ˜¯è¦ä¾èµ–å…¶ä»–ç±»å‹ï¼Œæ¯”å¦‚åœ¨è®¾ç½®ä½å€ï¼Œä½å€å¯èƒ½æœ‰å¤šä¸ªä½å€ï¼Œå¯ä»¥é‡‡ç”¨æ•°ç»„ç±»å‹å»ä¿®é¥°å­—ç¬¦ä¸²ã€‚ PGSQLä¸­ï¼ŒæŒ‡å®šæ•°ç»„çš„æ–¹å¼å°±æ˜¯[]ï¼Œå¯ä»¥æŒ‡å®šä¸€ç»´æ•°ç»„ï¼Œä¹Ÿæ”¯æŒäºŒç»´ç”šè‡³æ›´å¤šç»´æ•°ç»„ã€‚ æ„å»ºæ•°ç»„çš„æ–¹å¼ï¼š drop table test; create table test( id serial, col1 int[], col2 int[2], col3 int[][] ); -- æ„å»ºè¡¨æŒ‡å®šæ•°ç»„é•¿åº¦åï¼Œå¹¶ä¸æ˜¯è¯´æ•°ç»„å†…å®¹åªæœ‰2çš„é•¿åº¦ï¼Œå¯ä»¥æ’å…¥æ›´å¤šæ•°æ® -- ç”šè‡³åœ¨ä½ æ’å…¥æ•°æ®ï¼Œå¦‚æœå°†äºŒç»´æ•°ç»„ç»“æ„çš„æ•°ç»„æ‰”åˆ°ä¸€ç»´æ•°ç»„ä¸Šï¼Œä¹Ÿå¯ä»¥å­˜å‚¨ã€‚ -- æ•°ç»„ç¼–å†™æ–¹å¼ select '{{how,are},{are,you}}'::varchar[]; select array[[1,2],[3,4]]; insert into test (col1,col2,col3) values ('{1,2,3}','{4,5,6}','{7,8,9}'); insert into test (col1,col2,col3) values ('{1,2,3}','{4,5,6}',array[[1,2],[3,4]]); insert into test (col1,col2,col3) values ('{1,2,3}','{4,5,6}','{{1,2},{3,4}}'); select * from test; å¦‚æœç°åœ¨è¦å­˜å‚¨å­—ç¬¦ä¸²æ•°ç»„ï¼Œå¦‚æœå­˜å‚¨çš„æ•°ç»„ä¸­æœ‰åŒå¼•å·æ€ä¹ˆåŠï¼Œæœ‰å¤§æ‹¬å·æ€ä¹ˆåŠã€‚ -- å¦‚æœå­˜å‚¨çš„æ•°ç»„ä¸­çš„å€¼ï¼Œæœ‰å•å¼•å·æ€ä¹ˆåŠï¼Ÿ -- ä½¿ç”¨ä¸¤ä¸ªå•å¼•å·ï¼Œä½œä¸ºä¸€ä¸ªå•å¼•å·ä½¿ç”¨ select '{''how''}'::varchar[]; -- å¦‚æœå­˜å‚¨çš„æ•°ç»„ä¸­çš„å€¼ï¼Œæœ‰é€—å·æ€ä¹ˆåŠï¼Ÿ(PGSQLä¸­çš„æ•°ç»„ç´¢å¼•ä»1å¼€å§‹ç®—ï¼Œå†™0ä¹Ÿæ˜¯ä»1å¼€å§‹ç®—ã€‚) -- ç”¨åŒå¼•å·å°†æ•°ç»„çš„æ•°æ®åŒ…èµ·æ¥~ select ('{&quot;how,are&quot;}'::varchar[])[2]; -- å¦‚æœå­˜å‚¨çš„æ•°ç»„ä¸­çš„å€¼ï¼Œæœ‰åŒå¼•å·æ€ä¹ˆåŠï¼Ÿ -- å¦‚æœè¦æ·»åŠ åŒå¼•å·ï¼Œè®°å¾—è½¬ä¹‰ã€‚ select ('{&quot;\\&quot;how\\&quot;,are&quot;}'::varchar[])[1]; æ•°ç»„çš„æ¯”è¾ƒæ–¹å¼ -- åŒ…å« select array[1,2] @&gt; array[1]; -- è¢«åŒ…å« select array[1,2] &lt;@ array[1,2,4]; -- æ˜¯å¦æœ‰ç›¸åŒå…ƒç´  select array[2,4,4,45,1] &amp;&amp; array[1]; ä¹ã€è¡¨ è¡¨çš„æ„å»ºè¯­å¥ï¼ŒåŸºæœ¬éƒ½ä¼šã€‚ æ ¸å¿ƒåœ¨äºæ„å»ºè¡¨æ—¶ï¼Œè¦æŒ‡å®šä¸Šä¸€äº›çº¦æŸã€‚ 9.1 çº¦æŸ 9.1.1 ä¸»é”® -- ä¸»é”®çº¦æŸ drop table test; create table test( id bigserial primary key , name varchar(32) ); 9.1.2 éç©º -- éç©ºçº¦æŸ drop table test; create table test( id bigserial primary key , name varchar(32) not null ); 9.1.3 å”¯ä¸€ drop table test; create table test( id bigserial primary key , name varchar(32) not null, id_card varchar(32) unique ); insert into test (name,id_card) values ('å¼ ä¸‰','333333333333333333'); insert into test (name,id_card) values ('æå››','333333333333333333'); insert into test (name,id_card) values (NULL,'433333333333333333'); 9.1.4 æ£€æŸ¥ -- æ£€æŸ¥çº¦æŸ -- ä»·æ ¼çš„è¡¨ï¼Œpriceï¼Œdiscount_price drop table test; create table test( id bigserial primary key, name varchar(32) not null, price numeric check(price &gt; 0), discount_price numeric check(discount_price &gt; 0), check(price &gt;= discount_price) ); insert into test (name,price,discount_price) values ('ç²½å­',122,12); 9.1.5 å¤–é”®ï¼ˆä¸ç©ï¼‰ 9.1.6 é»˜è®¤å€¼ ä¸€èˆ¬å…¬å¸å†…ï¼Œè¦æ±‚è¡¨ä¸­é™¤äº†ä¸»é”®å’Œä¸šåŠ¡å­—æ®µä¹‹å¤–ï¼Œå¿…é¡»è¦æœ‰5ä¸ªå­—æ®µ createdï¼Œcreate_idï¼Œupdatedï¼Œupdate_idï¼Œis_delete -- é»˜è®¤å€¼ create table test( id bigserial primary key, created timestamp default current_timestamp ); 9.2 è§¦å‘å™¨ è§¦å‘å™¨Triggerï¼Œæ˜¯ç”±äº‹ä»¶å‡ºå‘çš„ä¸€ç§å­˜å‚¨è¿‡ç¨‹ å½“å¯¹æ ‡è¿›è¡Œinsertï¼Œupdateï¼Œdeleteï¼Œtruncateæ“ä½œæ—¶ï¼Œä¼šè§¦å‘è¡¨çš„Triggerï¼ˆçœ‹è§¦å‘å™¨çš„åˆ›å»ºæ—¶æŒ‡å®šçš„äº‹ä»¶ï¼‰ æ„å»ºä¸¤å¼ è¡¨ï¼Œå­¦ç”Ÿä¿¡æ¯è¡¨ï¼Œå­¦ç”Ÿåˆ†æ•°è¡¨ã€‚ åœ¨åˆ é™¤å­¦ç”Ÿä¿¡æ¯çš„åŒæ—¶ï¼Œè‡ªåŠ¨åˆ é™¤å­¦ç”Ÿçš„åˆ†æ•°ã€‚ å…ˆæ„å»ºè¡¨ä¿¡æ¯ï¼Œå¡«å……æ•°æ® create table student( id int, name varchar(32) ); create table score( id int, student_id int, math_score numeric, english_score numeric, chinese_score numeric ); insert into student (id,name) values (1,'å¼ ä¸‰'); insert into student (id,name) values (2,'æå››'); insert into score (id,student_id,math_score,english_score,chinese_score) values (1,1,66,66,66); insert into score (id,student_id,math_score,english_score,chinese_score) values (2,2,55,55,55); select * from student; select * from score; ä¸ºäº†å®Œæˆçº§è”åˆ é™¤çš„æ“ä½œï¼Œéœ€è¦ç¼–å†™pl/sqlã€‚ å…ˆæŸ¥çœ‹ä¸€ä¸‹PGSQLæ”¯æŒçš„plsqlï¼ŒæŸ¥çœ‹ä¸€ä¸‹PGSQLçš„plsqlè¯­æ³• [ &lt;&lt;label&gt;&gt; ] [ DECLARE declarations ] BEGIN statements END [ label ]; æ„å»ºä¸€ä¸ªå­˜å‚¨å‡½æ•°ï¼Œæµ‹è¯•ä¸€ä¸‹plsql -- ä¼˜å…ˆç©ä¸€ä¸‹plsql -- $$å¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ç§ç‰¹æ®Šçš„å•å¼•å·ï¼Œé¿å…ä½ åœ¨declareï¼Œbeginï¼Œendä¸­ä½¿ç”¨å•å¼•å·æ—¶ï¼Œå‡ºç°é—®é¢˜ï¼Œ -- éœ€è¦åœ¨ç¼–å†™åï¼Œåœ¨$$ä¹‹åæ·»åŠ ä¸Šå½“å‰å†…å®¹çš„è¯­è¨€ã€‚ create function test() returns int as $$ declare money int := 10; begin return money; end; $$ language plpgsql; select test(); åœ¨ç®€å•äº†è§£äº†ä¸€ä¸‹plpgsqlçš„è¯­æ³•åï¼Œç¼–å†™ä¸€ä¸ªè§¦å‘å™¨å‡½æ•°ã€‚ è§¦å‘å™¨å‡½æ•°å…è®¸ä½¿ç”¨ä¸€äº›ç‰¹æ®Šå˜é‡ NEW æ•°æ®ç±»å‹æ˜¯RECORDï¼›è¯¥å˜é‡ä¸ºè¡Œçº§è§¦å‘å™¨ä¸­çš„INSERT/UPDATEæ“ä½œä¿æŒæ–°æ•°æ®è¡Œã€‚åœ¨è¯­å¥çº§åˆ«çš„è§¦å‘å™¨ä»¥åŠDELETEæ“ä½œï¼Œè¿™ä¸ªå˜é‡æ˜¯nullã€‚ OLD æ•°æ®ç±»å‹æ˜¯RECORDï¼›è¯¥å˜é‡ä¸ºè¡Œçº§è§¦å‘å™¨ä¸­çš„UPDATE/DELETEæ“ä½œä¿æŒæ–°æ•°æ®è¡Œã€‚åœ¨è¯­å¥çº§åˆ«çš„è§¦å‘å™¨ä»¥åŠINSERTæ“ä½œï¼Œè¿™ä¸ªå˜é‡æ˜¯nullã€‚ æ„å»ºä¸€ä¸ªåˆ é™¤å­¦ç”Ÿåˆ†æ•°çš„è§¦å‘å™¨å‡½æ•°ã€‚ -- æ„å»ºä¸€ä¸ªåˆ é™¤å­¦ç”Ÿåˆ†æ•°çš„è§¦å‘å™¨å‡½æ•°ã€‚ create function trigger_function_delete_student_score() returns trigger as $$ begin delete from score where student_id = old.id; return old; end; $$ language plpgsql; å¼€å§‹æ„å»ºè§¦å‘å™¨ï¼Œåœ¨å­¦ç”Ÿä¿¡æ¯è¡¨åˆ é™¤æ—¶ï¼Œæ‰§è¡Œå‰é¢å£°æ˜çš„è§¦å‘å™¨å‡½æ•° CREATE [ OR REPLACE ] [ CONSTRAINT ] TRIGGER name { BEFORE | AFTER | INSTEAD OF } { event [ OR ... ] } ON table_name [ FROM referenced_table_name ] [ NOT DEFERRABLE | [ DEFERRABLE ] [ INITIALLY IMMEDIATE | INITIALLY DEFERRED ] ] [ REFERENCING { { OLD | NEW } TABLE [ AS ] transition_relation_name } [ ... ] ] [ FOR [ EACH ] { ROW | STATEMENT } ] [ WHEN ( condition ) ] EXECUTE { FUNCTION | PROCEDURE } function_name ( arguments ) where event can be one of: INSERT UPDATE [ OF column_name [, ... ] ] DELETE TRUNCATE å½“ CONSTRAINTé€‰é¡¹è¢«æŒ‡å®šï¼Œè¿™ä¸ªå‘½ä»¤ä¼šåˆ›å»ºä¸€ä¸ª çº¦æŸè§¦å‘å™¨ ã€‚è¿™å’Œä¸€ä¸ªå¸¸è§„è§¦å‘å™¨ç›¸åŒï¼Œä¸è¿‡è§¦å‘è¯¥è§¦å‘å™¨çš„æ—¶æœºå¯ä»¥ä½¿ç”¨SET CONSTRAINTSè°ƒæ•´ã€‚çº¦æŸè§¦å‘å™¨å¿…é¡»æ˜¯è¡¨ä¸Šçš„ AFTER ROWè§¦å‘å™¨ã€‚å®ƒä»¬å¯ä»¥åœ¨å¯¼è‡´è§¦å‘å™¨äº‹ä»¶çš„è¯­å¥æœ«å°¾è¢«å¼•å‘æˆ–è€…åœ¨åŒ…å«è¯¥è¯­å¥çš„äº‹åŠ¡æœ«å°¾è¢«å¼•å‘ã€‚åœ¨åä¸€ç§æƒ…å†µä¸­ï¼Œå®ƒä»¬è¢«ç§°ä½œæ˜¯è¢« å»¶è¿Ÿ ã€‚ä¸€ä¸ªå¾…å¤„ç†çš„å»¶è¿Ÿè§¦å‘å™¨çš„å¼•å‘ä¹Ÿå¯ä»¥ä½¿ç”¨ SET CONSTRAINTSç«‹å³å¼ºåˆ¶å‘ç”Ÿã€‚å½“çº¦æŸè§¦å‘å™¨å®ç°çš„çº¦æŸè¢«è¿èƒŒæ—¶ï¼Œçº¦æŸè§¦å‘å™¨åº”è¯¥æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚ æç»˜ä¸€æ³¢~~ -- ç¼–å†™è§¦å‘å™¨ï¼ŒæŒ‡å®šåœ¨åˆ é™¤æŸä¸€è¡Œå­¦ç”Ÿä¿¡æ¯æ—¶ï¼Œè§¦å‘å½“å‰è§¦å‘å™¨ï¼Œæ‰§è¡Œè§¦å‘å™¨å‡½æ•° create trigger trigger_student after delete on student for each row execute function trigger_function_delete_student_score(); -- æµ‹è¯•æ•ˆæœ select * from student; select * from score; delete from student where id = 1; 9.3 è¡¨ç©ºé—´ï¼ˆé—®é¢˜å¡«å‘ï¼‰ åœ¨å­˜å‚¨æ•°æ®æ—¶ï¼Œæ•°æ®è‚¯å®šè¦è½åˆ°ç£ç›˜ä¸Šï¼ŒåŸºäºæ„å»ºçš„tablespaceï¼ŒæŒ‡å®šæ•°æ®å­˜æ”¾åœ¨ç£ç›˜ä¸Šçš„ç‰©ç†åœ°å€ã€‚ å¦‚æœæ²¡æœ‰è‡ªå·±è®¾è®¡tablespaceï¼ŒPGSQLä¼šè‡ªåŠ¨æŒ‡å®šä¸€ä¸ªä½ç½®ä½œä¸ºé»˜è®¤çš„å­˜å‚¨ç‚¹ã€‚ å¯ä»¥é€šè¿‡ä¸€ä¸ªå‡½æ•°ï¼ŒæŸ¥çœ‹è¡¨çš„ç‰©ç†æ•°æ®å­˜æ”¾åœ¨äº†å“ªä¸ªç£ç›˜è·¯å¾„ä¸‹ã€‚ -- æŸ¥è¯¢è¡¨å­˜å‚¨çš„ç‰©ç†åœ°å€ select pg_relation_filepath('student'); è¿™ä¸ªä½ç½®æ˜¯åœ¨$PG_DATAåçš„å­˜æ”¾åœ°å€ $PG_DATA == /var/lib/pgsql/12/data/ 41000å…¶å®å°±æ˜¯å­˜å‚¨æ•°æ®çš„ç‰©ç†æ–‡ä»¶ æ„å»ºè¡¨ç©ºé—´ï¼ŒæŒ‡å®šæ•°æ®å­˜æ”¾ä½ç½® -- æ„å»ºè¡¨ç©ºé—´,æ„å»ºè¡¨ç©ºé—´éœ€è¦ç”¨æˆ·æƒé™æ˜¯è¶…çº§ç®¡ç†å‘˜ï¼Œå…¶æ¬¡éœ€è¦æŒ‡å®šçš„ç›®å½•å·²ç»å­˜åœ¨ create tablespace tp_test location '/var/lib/pgsql/12/tp_test'; æ„å»ºæ•°æ®åº“ï¼Œä»¥åŠè¡¨ï¼ŒæŒ‡å®šåˆ°è¿™ä¸ªè¡¨ç©ºé—´ä¸­ å…¶å®æŒ‡å®šè¡¨ç©ºé—´çš„å­˜å‚¨ä½ç½®åï¼ŒPGSQLä¼šåœ¨$PG_DATAç›®å½•ä¸‹å­˜å‚¨ä¸€ä»½ï¼ŒåŒæ—¶åœ¨å’±ä»¬æ„å»ºtablespaceæ—¶ï¼ŒæŒ‡å®šçš„è·¯å¾„ä¸‹ä¹Ÿå­˜å‚¨ä¸€ä»½ã€‚ è¿™ä¸¤ä¸ªç»å¯¹è·¯å¾„ä¸‹çš„æ–‡ä»¶éƒ½æœ‰å­˜å‚¨è¡¨ä¸­çš„æ•°æ®ä¿¡æ¯ã€‚ /var/lib/pgsql/12/data/pg_tblspc/41015/PG_12_201909212/41016/41020 /var/lib/pgsql/12/lz_tp_test/PG_12_201909212/41016/41020 è¿›ä¸€æ­¥ä¼šå‘ç°ï¼Œå…¶å®åœ¨PGSQLçš„é»˜è®¤ç›®å½•ä¸‹ï¼Œå­˜å‚¨çš„æ˜¯ä¸€ä¸ªlinkï¼Œè¿æ¥æ–‡ä»¶ï¼Œç±»ä¼¼ä¸€ä¸ªå¿«æ·æ–¹å¼ 9.4 è§†å›¾ è·ŸMySQLçš„æ²¡å•¥åŒºåˆ«ï¼ŒæŠŠä¸€äº›å¤æ‚çš„æ“ä½œå°è£…èµ·æ¥ï¼Œè¿˜å¯ä»¥éšè—ä¸€äº›æ•æ„Ÿæ•°æ®ã€‚ è§†å›¾å¯¹äºç”¨æˆ·æ¥è¯´ï¼Œå°±æ˜¯ä¸€å¼ çœŸå®çš„è¡¨ï¼Œå¯ä»¥ç›´æ¥åŸºäºè§†å›¾æŸ¥è¯¢ä¸€å¼ æˆ–è€…å¤šå¼ è¡¨çš„ä¿¡æ¯ã€‚ è§†å›¾å¯¹äºå¼€å‘æ¥è¯´ï¼Œå°±æ˜¯ä¸€æ¡SQLè¯­å¥ã€‚ åœ¨PGSQLä¸­ï¼Œç®€å•ï¼ˆå•è¡¨ï¼‰çš„è§†å›¾æ˜¯å…è®¸å†™æ“ä½œçš„ã€‚ ä½†æ˜¯å¼ºçƒˆä¸æ¨èå¯¹è§†å›¾è¿›è¡Œå†™æ“ä½œï¼Œè™½ç„¶PGSQLé»˜è®¤å…è®¸ï¼ˆç®€å•çš„è§†å›¾ï¼‰ã€‚ å†™å…¥çš„æ—¶å€™ï¼Œå…¶å®ä¿®æ”¹çš„æ˜¯è¡¨æœ¬èº« -- æ„å»ºä¸€ä¸ªç®€å•è§†å›¾ create view vw_score as (select id,math_score from score); select * from vw_score; update vw_score set math_score = 99 where id = 2; å¤šè¡¨è§†å›¾ -- å¤æ‚è§†å›¾(ä¸¤å¼ è¡¨å…³è”) create view vw_student_score as (select stu.id as id ,stu.name as name ,score.math_score from student stu,score score where stu.id = score.student_id); select * from vw_student_score; update vw_student_score set math_score =999 where id = 2; 9.5 ç´¢å¼• 9.5.1 ç´¢å¼•çš„åŸºæœ¬æ¦‚å¿µ å…ˆäº†è§£æ¦‚å¿µå’Œä½¿ç”¨ ç´¢å¼•æ˜¯æ•°æ®åº“ä¸­å¿«é€ŸæŸ¥è¯¢æ•°æ®çš„æ–¹æ³•ã€‚ ç´¢å¼•èƒ½æå‡æŸ¥è¯¢æ•ˆç‡çš„åŒæ—¶ï¼Œä¹Ÿä¼šå¸¦æ¥ä¸€äº›é—®é¢˜ å¢åŠ äº†å­˜å‚¨ç©ºé—´ å†™æ“ä½œæ—¶ï¼ŒèŠ±è´¹çš„æ—¶é—´æ¯”è¾ƒå¤š ç´¢å¼•å¯ä»¥æå‡æ•ˆç‡ï¼Œç”šè‡³è¿˜å¯ä»¥ç»™å­—æ®µåšä¸€äº›çº¦æŸ 9.5.2 ç´¢å¼•çš„åˆ†ç±» B-Treeç´¢å¼•ï¼šæœ€å¸¸ç”¨çš„ç´¢å¼•ã€‚ Hashç´¢å¼•ï¼šè·ŸMySQLç±»ä¼¼ï¼Œåšç­‰å€¼åˆ¤æ–­ï¼ŒèŒƒå›´å‡‰å‡‰~ GINç´¢å¼•ï¼šé’ˆå¯¹å­—æ®µçš„å¤šä¸ªå€¼çš„ç±»å‹ï¼Œæ¯”å¦‚æ•°ç»„ç±»å‹ã€‚ 9.5.3 åˆ›å»ºç´¢å¼•çœ‹æ•ˆæœ å‡†å¤‡å¤§é‡æµ‹è¯•æ•°æ®ï¼Œæ–¹ä¾¿æŸ¥çœ‹ç´¢å¼•æ•ˆæœ -- æµ‹è¯•ç´¢å¼•æ•ˆæœ create table tb_index( id bigserial primary key, name varchar(64), phone varchar(64)[] ); -- æ·»åŠ 300Wæ¡æ•°æ®æµ‹è¯•æ•ˆæœ do $$ declare i int := 0; begin while i &lt; 3000000 loop i = i + 1; insert into tb_index (name,phone) values (md5(random()::text || current_timestamp::text)::uuid,array[random()::varchar(64),random()::varchar(64)]); end loop; end; $$ language plpgsql; åœ¨æ²¡æœ‰ç´¢å¼•çš„æƒ…å†µä¸‹ï¼Œå…ˆåŸºäºnameåšç­‰å€¼æŸ¥è¯¢ï¼Œçœ‹æ—¶é—´ï¼ŒåŒæ—¶çœ‹æ‰§è¡Œè®¡åˆ’ -- c0064192-1836-b019-c649-b368c2be31ca select * from tb_index where id = 2222222; select * from tb_index where name = 'c0064192-1836-b019-c649-b368c2be31ca'; explain select * from tb_index where name = 'c0064192-1836-b019-c649-b368c2be31ca'; -- Seq Scan è¿™ä¸ªä»£è¡¨å…¨è¡¨æ‰«æ -- æ—¶é—´å¤§è‡´0.3ç§’å·¦å³ åœ¨æœ‰ç´¢å¼•çš„æƒ…å†µä¸‹ï¼Œå†åŸºäºnameåšç­‰å€¼æŸ¥è¯¢ï¼Œçœ‹æ—¶é—´ï¼ŒåŒæ—¶çœ‹æ‰§è¡Œè®¡åˆ’ -- nameå­—æ®µæ„å»ºç´¢å¼•ï¼ˆé»˜è®¤å°±æ˜¯b-treeï¼‰ create index index_tb_index_name on tb_index(name); -- æµ‹è¯•æ•ˆæœ select * from tb_index where name = 'c0064192-1836-b019-c649-b368c2be31ca'; explain select * from tb_index where name = 'c0064192-1836-b019-c649-b368c2be31ca'; -- Index Scan ä½¿ç”¨ç´¢å¼• -- 0.1så·¦å³ æµ‹è¯•GINç´¢å¼•æ•ˆæœ åœ¨æ²¡æœ‰ç´¢å¼•çš„æƒ…å†µä¸‹ï¼ŒåŸºäºphoneå­—æ®µåšåŒ…å«æŸ¥è¯¢ -- phoneï¼š{0.6925242730781953,0.8569644964711074} select * from tb_index where phone @&gt; array['0.6925242730781953'::varchar(64)]; explain select * from tb_index where phone @&gt; array['0.6925242730781953'::varchar(64)]; -- Seq Scan å…¨è¡¨æ‰«æ -- 0.5så·¦å³ ç»™phoneå­—æ®µæ„å»ºGINç´¢å¼•ï¼Œåœ¨æŸ¥è¯¢ -- ç»™phoneå­—ç¬¦ä¸²æ•°ç»„ç±»å‹å­—æ®µæ„å»ºä¸€ä¸ªGINç´¢å¼• create index index_tb_index_phone_gin on tb_index using gin(phone); -- æŸ¥è¯¢ select * from tb_index where phone @&gt; array['0.6925242730781953'::varchar(64)]; explain select * from tb_index where phone @&gt; array['0.6925242730781953'::varchar(64)]; -- Bitmap Index ä½å›¾æ‰«æ -- 0.1sä»¥å†…å®Œæˆ 9.6 ç‰©åŒ–è§†å›¾ å‰é¢è¯´è¿‡æ™®é€šè§†å›¾ï¼Œæœ¬è´¨å°±æ˜¯ä¸€ä¸ªSQLè¯­å¥ï¼Œæ™®é€šçš„è§†å›¾å¹¶ä¸ä¼šæœ¬åœ°ç£ç›˜å­˜å‚¨ä»»ä½•ç‰©ç†ã€‚ æ¯æ¬¡æŸ¥è¯¢è§†å›¾éƒ½æ˜¯æ‰§è¡Œè¿™ä¸ªSQLã€‚æ•ˆç‡æœ‰ç‚¹é—®é¢˜ã€‚ ç‰©åŒ–è§†å›¾ä»åå­—ä¸Šå°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œå¿…ç„¶æ˜¯è¦æŒä¹…åŒ–ä¸€ä»½æ•°æ®çš„ã€‚ä½¿ç”¨å¥—è·¯å’Œè§†å›¾åŸºæœ¬ä¸€è‡´ã€‚è¿™æ ·ä¸€æ¥æŸ¥è¯¢ç‰©åŒ–è§†å›¾ï¼Œå°±ç›¸å½“äºæŸ¥è¯¢ä¸€å¼ å•ç‹¬çš„è¡¨ã€‚ç›¸æ¯”ä¹‹å‰çš„æ™®é€šè§†å›¾ï¼Œç‰©åŒ–è§†å›¾å°±ä¸éœ€è¦æ¯æ¬¡éƒ½æŸ¥è¯¢å¤æ‚SQLï¼Œæ¯æ¬¡æŸ¥è¯¢çš„éƒ½æ˜¯çœŸå®çš„ç‰©ç†å­˜å‚¨åœ°å€ä¸­çš„ä¸€ä»½æ•°æ®ï¼ˆè¡¨ï¼‰ã€‚ ç‰©åŒ–è§†å›¾å› ä¸ºä¼šæŒä¹…åŒ–åˆ°æœ¬åœ°ï¼Œå®Œå…¨è„±ç¦»åŸæ¥çš„è¡¨ç»“æ„ã€‚ è€Œä¸”ç‰©åŒ–è§†å›¾æ˜¯å¯ä»¥å•ç‹¬è®¾ç½®ç´¢å¼•ç­‰ä¿¡æ¯æ¥æå‡ç‰©åŒ–è§†å›¾çš„æŸ¥è¯¢æ•ˆç‡ã€‚ Butï¼Œæœ‰å¥½å¤„å°±æœ‰åå¤„ï¼Œæ›´æ–°æ—¶é—´ä¸å¤ªå¥½æŠŠæ§ã€‚ å¦‚æœæ›´æ–°é¢‘ç¹ï¼Œå¯¹æ•°æ®åº“å‹åŠ›ä¹Ÿä¸å°ã€‚ å¦‚æœæ›´æ–°ä¸é¢‘ç¹ï¼Œä¼šé€ æˆæ•°æ®å­˜åœ¨å»¶è¿Ÿé—®é¢˜ï¼Œå®æ—¶æ€§å°±ä¸å¥½äº†ã€‚ å¦‚æœè¦æ›´æ–°ç‰©åŒ–è§†å›¾ï¼Œå¯ä»¥é‡‡ç”¨è§¦å‘å™¨çš„å½¢å¼ï¼Œå½“åŸè¡¨ä¸­çš„æ•°æ®è¢«å†™åï¼Œå¯ä»¥é€šè¿‡è§¦å‘å™¨æ‰§è¡ŒåŒæ­¥ç‰©åŒ–è§†å›¾çš„æ“ä½œã€‚æˆ–è€…å°±åŸºäºå®šæ—¶ä»»åŠ¡å»å®Œæˆç‰©åŒ–è§†å›¾çš„æ•°æ®åŒæ­¥ã€‚ look ä¸€ä¸‹è¯­æ³•ã€‚ å¹²æ´»ï¼ -- æ„å»ºç‰©åŒ–è§†å›¾ create materialized view mv_test as (select id,name,price from test); -- æ“ä½œç‰©åŒ–è§†å›¾å’Œæ“ä½œè¡¨çš„æ–¹å¼æ²¡å•¥åŒºåˆ«ã€‚ select * from mv_test; -- æ“ä½œåŸè¡¨æ—¶ï¼Œå¯¹ç‰©åŒ–è§†å›¾æ²¡ä»»ä½•å½±å“ insert into test values (4,'æœˆé¥¼',50,10); -- ç‰©åŒ–è§†å›¾çš„æ·»åŠ æ“ä½œ(ä¸å…è®¸å†™ç‰©åŒ–è§†å›¾)ï¼Œä¼šæŠ¥é”™ insert into mv_test values (5,'å¤§é˜…å…µ',66); ç‰©åŒ–è§†å›¾å¦‚ä½•ä»åŸè¡¨ä¸­è¿›è¡ŒåŒæ­¥æ“ä½œã€‚ PostgreSQLä¸­ï¼Œå¯¹ç‰©åŒ–è§†å›¾çš„åŒæ­¥ï¼Œæä¾›äº†ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯å…¨é‡æ›´æ–°ï¼Œå¦ä¸€ç§æ˜¯å¢é‡æ›´æ–°ã€‚ å…¨é‡æ›´æ–°è¯­æ³•ï¼Œæ²¡ä»€ä¹ˆé™åˆ¶ï¼Œç›´æ¥æ‰§è¡Œï¼Œå…¨é‡æ›´æ–° -- æŸ¥è¯¢åŸæ¥ç‰©åŒ–è§†å›¾çš„æ•°æ® select * from mv_test; -- å…¨é‡æ›´æ–°ç‰©åŒ–è§†å›¾ refresh materialized view mv_test; -- å†æ¬¡æŸ¥è¯¢ç‰©åŒ–è§†å›¾çš„æ•°æ® select * from mv_test; å¢é‡æ›´æ–°ï¼Œå¢é‡æ›´æ–°éœ€è¦ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ï¼Œæ¥åˆ¤æ–­å“ªäº›æ˜¯å¢é‡ï¼ŒåŒæ—¶ä¹Ÿä¼šæœ‰è¡Œæ•°æ®çš„ç‰ˆæœ¬å·çº¦æŸã€‚ -- æŸ¥è¯¢åŸæ¥ç‰©åŒ–è§†å›¾çš„æ•°æ® select * from mv_test; -- å¢é‡æ›´æ–°ç‰©åŒ–è§†å›¾ï¼Œå› ä¸ºç‰©åŒ–è§†å›¾æ²¡æœ‰å”¯ä¸€ç´¢å¼•ï¼Œæ— æ³•åˆ¤æ–­å‡ºå“ªäº›æ˜¯å¢é‡æ•°æ® refresh materialized view concurrently mv_test; -- ç»™ç‰©åŒ–è§†å›¾æ·»åŠ å”¯ä¸€ç´¢å¼•ã€‚ create unique index index_mv_test on mv_test(id); -- å¢é‡æ›´æ–°ç‰©åŒ–è§†å›¾ refresh materialized view concurrently mv_test; -- å†æ¬¡æŸ¥è¯¢ç‰©åŒ–è§†å›¾çš„æ•°æ® select * from mv_test; -- å¢é‡æ›´æ–°æ—¶ï¼Œå³ä¾¿æ˜¯ä¿®æ”¹æ•°æ®ï¼Œç‰©åŒ–è§†å›¾çš„åŒæ­¥ï¼Œä¹Ÿä¼šæ ¹æ®ä¸€ä¸ªxminå’Œxmaxçš„å­—æ®µåšæ­£å¸¸çš„æ•°æ®åŒæ­¥ update test set name = 'æ±¤åœ†' where id = 5; insert into test values (5,'çŒªå¤´è‚‰',99,40); select * from test; ","link":"https://tianxiawuhao.github.io/IKbaKSlgE/"},{"title":"PostgreSQLæ¦‚è¿°ä¸€","content":"ä¸€ã€PostgreSQLä»‹ç» PostgreSQLæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ å¼€æº çš„å…³ç³»å‹æ•°æ®åº“ã€‚åº•å±‚åŸºäºCå®ç°ã€‚ PostgreSQLçš„å¼€æºåè®®å’ŒLinuxå†…æ ¸ç‰ˆæœ¬çš„å¼€æºåè®®æ˜¯ä¸€æ ·çš„ã€‚ã€‚BDSåè®®ï¼Œè¿™ä¸ªåè®®åŸºæœ¬å’ŒMITå¼€æºåè®®ä¸€æ ·ï¼Œè¯´äººè¯ï¼Œå°±æ˜¯ä½ å¯ä»¥å¯¹PostgreSQLè¿›è¡Œä¸€äº›å°è£…ï¼Œç„¶åå•†ä¸šåŒ–æ˜¯æ”¶è´¹ã€‚ PostgreSQLçš„åå­—å’‹æ¥çš„ã€‚ä¹‹å‰å«Ingresï¼Œåé¢ä¸ºäº†è§£å†³ä¸€äº›ingresä¸­çš„ä¸€äº›é—®é¢˜ï¼Œä½œä¸ºåé¢çš„ingresï¼Œå°±èµ·åå«postgreã€‚ PostgreSQLç‰ˆæœ¬è¿­ä»£çš„é€Ÿåº¦æ¯”è¾ƒå¿«ï¼Œç°åœ¨æœ€æ–°çš„æ­£å¼çš„å‘å¸ƒç‰ˆæœ¬ï¼Œå·²ç»åˆ°äº†16.RELEASEã€‚ PGSQLçš„ç‰ˆæœ¬é€‰æ‹©ä¸€èˆ¬æœ‰ä¸¤ç§ï¼š å¦‚æœä¸ºäº†ç¨³å®šçš„è¿è¡Œï¼Œæ¨èä½¿ç”¨12.xç‰ˆæœ¬ã€‚ å¦‚æœæƒ³ä½“éªŒæ–°ç‰¹æ€§ï¼Œæ¨èä½¿ç”¨15.xç‰ˆæœ¬ã€‚ PGSQLå…è®¸è·¨ç‰ˆæœ¬å‡çº§ï¼Œè€Œä¸”æ²¡æœ‰ä»€ä¹ˆå¤§é—®é¢˜ã€‚ PGSQLç¤¾åŒºç‰¹åˆ«æ´»è·ƒï¼ŒåŸºæœ¬æ˜¯ä¸‰ä¸ªæœˆä¸€å‘ç‰ˆã€‚æ„å‘³ç€å¾ˆå¤šå¸¸è§çš„BUGéƒ½å¯ä»¥å¾—åˆ°åŠæ—¶çš„ä¿®å¤ã€‚ PGSQLå…¶å®åœ¨å›½å¤–ä½¿ç”¨çš„æ¯”è¾ƒå¤šï¼Œå›½å†…æš‚æ—¶è¿˜æ˜¯ä»¥MySQLä¸ºä¸»ã€‚ ä½†æ˜¯å›½å†…å¾ˆå¤šå›½äº§æ•°æ®åº“éƒ½æ˜¯åŸºäºPGSQLåšçš„äºŒæ¬¡å°è£…ï¼šæ¯”å¦‚åä¸ºGaussDBè¿˜æœ‰è…¾è®¯çš„Tbaseç­‰ç­‰ã€‚å…¶å®å¾ˆå¤šå…¬å¸åŸæ¥ç©çš„Oracleï¼Œç›´æ¥å¹³è½¬åˆ°PGSQLã€‚åŒæ—¶å›½å†…çš„å¾ˆå¤šäº‘äº§å“éƒ½æ”¯æŒPGSQLäº†ã€‚ PGSQLå› ä¸ºå¼€æºï¼Œæœ‰å¾ˆå¤šåšæ•°æ®è¿ç§»çš„å·¥å…·ï¼Œå¯ä»¥è®©ä½ å¿«é€Ÿçš„ä»MySQLï¼ŒSQLServerï¼ŒOracleç›´æ¥å¹³è½¬åˆ°PGSQLä¸­ï¼Œæ¯”å¦‚pgloaderè¿™æ ·çš„æ•°æ®è¿ç§»å·¥å…·ã€‚ PGSQLçš„å®˜æ–¹åœ°å€ï¼šhttps://www.postgresql.org/ PGSQLçš„å›½å†…ç¤¾åŒºï¼šhttp://www.postgres.cn/v2/home äºŒã€PostgreSQLå’ŒMySQLçš„åŒºåˆ« æŠ€æœ¯æ²¡æœ‰å¥½åä¹‹åˆ†ï¼ŒçŸ¥è¯†çœ‹ä¸€ä¸‹æ˜¯å¦ç¬¦åˆä½ çš„ä¸šåŠ¡ï¼Œèƒ½å¦è§£å†³ä½ çš„ä¸šåŠ¡éœ€æ±‚ã€‚å…¶æ¬¡ä¹Ÿè¦æŸ¥çœ‹ç¤¾åŒºçš„æ´»è·ƒåº¦ä»¥åŠæ›´æ–°çš„é¢‘æ¬¡ã€‚ MySQLä¸æ”¯æŒçš„å‡ ç‚¹å†…å®¹ï¼š MySQLçš„æ•°æ®ç±»å‹ä¸å¤Ÿä¸°å¯Œã€‚ MySQLä¸æ”¯æŒåºåˆ—æ¦‚å¿µï¼ŒSequenceã€‚ ä½¿ç”¨MySQLæ—¶ï¼Œç½‘ä¸Šç¼ºå°‘æ¯”è¾ƒå¥½ç”¨çš„æ’ä»¶ã€‚ MySQLçš„æ€§èƒ½ä¼˜åŒ–ç›‘æ§å·¥å…·ä¸æ˜¯å¾ˆå¤šï¼Œå®šä½é—®é¢˜çš„æˆæœ¬æ˜¯æ¯”è¾ƒé«˜ã€‚ MySQLçš„ä¸»ä»å¤åˆ¶æ²¡æœ‰ä¸€ä¸ªå®˜æ–¹çš„åŒæ­¥ç­–ç•¥ï¼ŒåŒæ­¥é—®é¢˜éš¾ä»¥è§£å†³ã€‚ MySQLè™½ç„¶å¼€æºï¼Œbutï¼Œä¸å¤Ÿå½»åº•ã€‚ PostgreSQLç›¸å¯¹MySQLä¸Šè¿°é—®é¢˜çš„ç‰¹ç‚¹ï¼š PostgreSQLçš„æ•°æ®ç±»å‹å˜å˜ä¸°å¯Œã€‚ PostgreSQLæ˜¯æœ‰åºåˆ—çš„æ¦‚å¿µçš„ã€‚ PostgreSQLçš„æ’ä»¶ç‰¹åˆ«ä¸°å¯Œã€‚ PostgreSQLæ”¯æŒä¸»ä»å¤åˆ¶çš„åŒæ­¥æ“ä½œï¼Œå¯ä»¥å®ç°æ•°æ®çš„0ä¸¢å¤±ã€‚ PostgreSQLçš„MVCCå®ç°å’ŒMySQLä¸å¤§ä¸€æ ·ã€‚PostgreSQLä¸€è¡Œæ•°æ®ä¼šå­˜å‚¨å¤šä¸ªç‰ˆæœ¬ã€‚æœ€å¤šå¯ä»¥å­˜å‚¨40äº¿ä¸ªäº‹åŠ¡ç‰ˆæœ¬ã€‚ ä¸‰ã€PostgreSQLçš„å®‰è£… å’±ä»¬åªåœ¨Linuxä¸­å®‰è£…ï¼Œä¸æ¨èå¤§å®¶åœ¨Windowsä¸‹å®‰è£…ã€‚ Linuxçš„ç‰ˆæœ¬å°½é‡ä½¿ç”¨7.xç‰ˆæœ¬ï¼Œæœ€å¥½æ˜¯7.6æˆ–è€…æ˜¯7.8ç‰ˆæœ¬ã€‚ å»å®˜ç½‘æ‰¾æŒ‰ç…§çš„æ–¹å¼ é€‰æ‹©å¥½PGSQLçš„ç‰ˆæœ¬ï¼Œå·²ç»Linuxçš„å‘è¡Œç‰ˆæœ¬ æ‹¿åˆ°å‘½ä»¤ï¼Œéº»ä¹Ÿä¸ç®¡ï¼Œç›´æ¥æ‰”åˆ°Linuxä¸­è¿è¡Œå³å¯ # ä¸‹è½½PGSQLçš„rpmåŒ… sudo yum install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm # å®‰è£…PGSQL12çš„è½¯ä»¶ç¨‹åºï¼Œéœ€è¦ä¸‹è½½ï¼Œéœ€è¦ç­‰ä¸€ä¼šï¼Œä¸€èˆ¬ä¸ä¼šå¤±è´¥ï¼Œå³ä¾¿å¤±è´¥ï¼Œä»–ä¹Ÿä¼šé‡æ–°å¸®ä½ æ‰¾é•œåƒ sudo yum install -y postgresql12-server # æ•°æ®åº“åˆå§‹åŒ– sudo /usr/pgsql-12/bin/postgresql-12-setup initdb # è®¾ç½®å¼€å¯å¯åŠ¨é¡¹ï¼Œå¹¶è®¾ç½®ä¸ºå¼€å¯è‡ªè¡Œå¯åŠ¨ sudo systemctl enable postgresql-12 # å¯åŠ¨PGSQL sudo systemctl start postgresql-12 è¿™ç§å±äºWindowsä¸‹çš„å‚»ç“œå¼å®‰è£…ï¼ŒåŸºæœ¬ä¸ä¼šå‡ºé”™ã€‚å¦‚æœå‡ºé”™ï¼Œå¯èƒ½æ˜¯é‚£äº›é—®é¢˜ï¼š å®‰è£…Linuxçš„æ—¶å€™ï¼Œä¸€å®šè¦é€‰æ‹©æœ€å°å®‰è£… ä½ çš„Linuxä¸èƒ½è¿æ¥å¤–ç½‘ Linuxä¸­çš„5432ç«¯å£ï¼Œå¯èƒ½è¢«å ç”¨äº† PostgreSQLä¸æ¨èä½¿ç”¨rootç®¡ç†ï¼Œåœ¨å®‰è£…æˆåŠŸpostgreSQLåï¼Œä»–é»˜è®¤ä¼šç»™ä½ åˆ›å»ºä¸€ä¸ªç”¨æˆ·ï¼špostgres ç©PGSQLå‰ï¼Œå…ˆåˆ‡æ¢åˆ°postgres su postgres åˆ‡æ¢åˆ°postgresç”¨æˆ·åï¼Œç›´æ¥è¾“å…¥psqlå³å¯è¿›å…¥åˆ°postgreSQLæä¾›çš„å®¢æˆ·ç«¯ # è¿›å…¥å‘½ä»¤è¡Œ psql # æŸ¥çœ‹æœ‰å“ªäº›åº“ï¼Œå¦‚æœæ˜¯æ–°å®‰è£…çš„ï¼Œæœ‰ä¸‰ä¸ªåº“ï¼Œä¸€ä¸ªæ˜¯postgresï¼Œtemplate0ï¼Œtemplate1she å…¶æ¬¡ä¸æ¨èä¸‹è½½Windowsç‰ˆæœ¬å»ç© å¦‚æœéè¦ä¸‹è½½ï¼šhttps://sbp.enterprisedb.com/getfile.jsp?fileid=1258242 å››ã€PostgreSQLçš„é…ç½® è¦æä¸¤ä¸ªé…ç½®ä¿¡æ¯ï¼Œä¸€ä¸ªå…³äºpostgreSQLçš„è¿œç¨‹è¿æ¥é…ç½®ä»¥åŠpostgreSQLçš„æ—¥å¿—é…ç½®ã€‚ PostgreSQLçš„ä¸»è¦é…ç½®æ”¾åœ¨æ•°æ®ç›®å½•ä¸‹çš„ï¼Œ postgresql.conf ä»¥åŠ pg_hba.conf é…ç½®æ–‡ä»¶ è¿™äº›é…ç½®æ–‡ä»¶éƒ½æ”¾åœ¨äº† # è¿™ä¸ªç›®å½•ä¸‹ /var/lib/pgsql/12/data ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼ŒpostgreSQLçš„æ ¸å¿ƒæ–‡ä»¶ï¼Œéƒ½å±äºpostgresç”¨æˆ·ï¼Œæ“ä½œçš„æ—¶å€™ï¼Œå°½å¯èƒ½çš„åˆ«ç”¨rootç”¨æˆ·ï¼Œå®¹æ˜“ç©å‡ºå‘ï¼Œå°½å¯èƒ½å…ˆåˆ‡æ¢åˆ°postgresç”¨æˆ·å»ç©ã€‚ 4.1 è¿œç¨‹è¿æ¥é…ç½® PostgreSQLé»˜è®¤æƒ…å†µä¸‹ä¸æ”¯æŒè¿œç¨‹è¿æ¥çš„ï¼Œè¿™ä¸ªè·ŸMySQLå‡ ä¹ä¸€æ · MySQLç»™mysql.userè¿½åŠ ç”¨æˆ·ï¼Œä¸€èˆ¬æ˜¯é‡‡ç”¨grantçš„å‘½ä»¤å»ç©ã€‚ PostgreSQLè¦åŸºäºé…ç½®æ–‡ä»¶ä¿®æ”¹ï¼Œæ‰èƒ½åˆ¶å®šç”¨æˆ·æ˜¯å¦å¯ä»¥è¿œç¨‹è¿æ¥ã€‚ ç›´æ¥å»ä¿®æ”¹pg_hba.confé…ç½®æ–‡ä»¶ ç”¨æˆ·ä»¥åŠå¯¹åº”æ•°æ®åº“å’Œè¿æ¥æ–¹å¼çš„ç¼–å†™æ¨¡æ¿ # ç¬¬ä¸€å— localï¼šä»£è¡¨æœ¬åœ°è¿æ¥ï¼Œhostä»£è¡¨å¯ä»¥æŒ‡å®šè¿æ¥çš„ADDRESS # ç¬¬äºŒå— databaseç¼–å†™æ•°æ®åº“åï¼Œå¦‚æœå†™allï¼Œä»£è¡¨æ‰€æœ‰åº“éƒ½å¯ä»¥è¿æ¥ # ç¬¬ä¸‰å— userç¼–å†™è¿æ¥çš„ç”¨æˆ·ï¼Œå¯ä»¥å†™allï¼Œä»£è¡¨æ‰€æœ‰ç”¨æˆ· # ç¬¬å››å— addressä»£è¡¨é‚£äº›IPåœ°å€å¯ä»¥è¿æ¥ # ç¬¬äº”å— methodåŠ å¯†æ–¹å¼ï¼Œè¿™å—ä¸ç”¨è¿‡å¤šå…³æ³¨ï¼Œç›´æ¥md5 # ç›´æ¥æ¥ä¸ªç—›å¿«çš„é…ç½®å—ï¼Œå…è®¸ä»»æ„åœ°å€çš„å…¨éƒ¨ç”¨æˆ·è¿æ¥æ‰€æœ‰æ•°æ®åº“ host all all 0.0.0.0/0 md5 ä¸ºäº†å®ç°è¿œç¨‹è¿æ¥ï¼Œé™¤äº†ç”¨æˆ·çº§åˆ«çš„è¿™ç§é…ç½®ï¼Œè¿˜è¦é’ˆå¯¹æœåŠ¡çº§åˆ«ä¿®æ”¹ä¸€ä¸ªé…ç½® æœåŠ¡çº§åˆ«çš„é…ç½®åœ¨postgresql.conf å‘ç°é»˜è®¤æƒ…å†µä¸‹ï¼ŒPGSQLåªå…è®¸localhostè¿æ¥ï¼Œç›´æ¥é…ç½®ä¸º*å³å¯è§£å†³é—®é¢˜ è®°å¾—ï¼Œä¸ºäº†ç”Ÿæ•ˆï¼Œä¸€å®šè¦é‡å¯ # postgreså¯†ç ä¸ç®¡ï¼Œç›´æ¥rootç”¨æˆ· sudo systemctl restart postgresql-12 4.2 é…ç½®æ•°æ®åº“çš„æ—¥å¿— æŸ¥çœ‹postgresql.confæ–‡ä»¶ postgreSQLé»˜è®¤æƒ…å†µä¸‹ï¼Œåªä¿å­˜7å¤©çš„æ—¥å¿—ï¼Œå¾ªç¯è¦†ç›–ã€‚ # ä»£è¡¨æ—¥å¿—æ˜¯å¼€å¯çš„ã€‚ logging_collector = on # æ—¥å¿—å­˜æ”¾çš„è·¯å¾„ï¼Œé»˜è®¤æ”¾åˆ°å½“å‰ç›®å½•ä¸‹çš„logé‡Œ log_directory = 'log' # æ—¥å¿—çš„æ–‡ä»¶åï¼Œé»˜è®¤æ˜¯postgresqlä¸ºå‰ç¼€ï¼Œæ˜ŸæœŸä½œä¸ºåç¼€ log_filename = 'postgresql-%a.log' # é»˜è®¤ä¸€å‘¨è¿‡åï¼Œæ—¥å¿—æ–‡ä»¶ä¼šè¢«è¦†ç›– log_truncate_on_rotation = on # ä¸€å¤©ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ log_rotation_age = 1d # ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œæ²¡æœ‰å¤§å°é™åˆ¶ log_rotation_size = 0 äº”ã€PostgreSQLçš„åŸºæ“ åªåœ¨psqlå‘½ä»¤è¡Œï¼ˆå®¢æˆ·ç«¯ï¼‰ä¸‹ï¼Œæ‰§è¡Œäº†ä¸€æ¬¡\\lï¼ŒæŸ¥çœ‹äº†æ‰€æœ‰çš„åº“ä¿¡æ¯ å¯ä»¥ç›´æ¥åŸºäºpsqlæŸ¥çœ‹ä¸€äº›ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥åŸºäºpsqlè¿›å…¥åˆ°å‘½ä»¤è¡Œåï¼Œå†åšå…·ä½“æ“ä½œ å¯ä»¥ç›´æ¥åŸºäºpsqlå»ç© å¯ä»¥æ•°æ®psql --helpï¼ŒæŸ¥çœ‹psqlçš„å‘½ä»¤ å¯ä»¥ç›´æ¥è¿›å…¥åˆ°å‘½ä»¤è¡Œçš„åŸå› ï¼Œæ˜¯psqlé»˜è®¤æƒ…å†µä¸‹ï¼Œå°±æ˜¯ä»¥postgresç”¨æˆ·å»è¿æ¥æœ¬åœ°çš„pgsqlï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è¿›å…¥ ä¸‹é¢çš„å›¾æ˜¯é»˜è®¤çš„è¿æ¥æ–¹å¼ åé¢éƒ½åŸºäºpsqlçš„å‘½ä»¤è¡Œï¼ˆå®¢æˆ·ç«¯ï¼‰å»è¿›è¡Œæ“ä½œ å‘½ä»¤ç»å¯¹ä¸è¦å»èƒŒï¼Œéœ€è¦ä½¿ç”¨çš„æ—¶å€™ï¼Œç›´æ¥æ‰¾å¸®åŠ©æ–‡æ¡£ï¼Œåœ¨psqlå‘½ä»¤è¡Œä¸­ï¼Œç›´æ¥æ³¨å…¥ \\helpï¼Œå³å¯æŸ¥çœ‹åˆ°æ•°æ®åº“çº§åˆ«çš„ä¸€äº›å‘½ä»¤ \\?ï¼Œå¯ä»¥æŸ¥çœ‹åˆ°æœåŠ¡çº§åˆ«çš„ä¸€äº›å‘½ä»¤ 5.1 ç”¨æˆ·æ“ä½œ æ„å»ºç”¨æˆ·å‘½ä»¤å·¨ç®€å• # åŒºåˆ«å°±æ˜¯create useré»˜è®¤æœ‰è¿æ¥æƒé™ï¼Œcreate roleæ²¡æœ‰ï¼Œä¸è¿‡å¯ä»¥åŸºäºé€‰é¡¹å»è®¾ç½® CREATE USER åç§° [ [ WITH ] é€‰é¡¹ [ ... ] ] create role åç§° [ [ WITH ] é€‰é¡¹ [ ... ] ] æ„å»ºä¸€ä¸ªè¶…çº§ç®¡ç†å‘˜ç”¨æˆ· create user root with SUPERUSER PASSWORD 'root'; é€€å‡ºpsqlå‘½ä»¤è¡Œ ç¼–å†™psqlå‘½ä»¤å°è¯•å»ç”¨rootç”¨æˆ·ç™»å½• psql -h 192.168.11.32 -p 5432 -U root -W å‘ç°ï¼Œå…‰æœ‰ç”¨æˆ·ä¸è®©ç™»å½•ï¼Œå¾—è®©ç”¨æˆ·æœ‰ä¸€ä¸ªæ•°æ®åº“ï¼Œç›´æ¥æ„å»ºä¸€ä¸ªrootåº“ create database root; å¯ä»¥åœ¨ä¸é€€å‡ºpsqlçš„å‰æä¸‹ï¼Œç›´æ¥åˆ‡æ¢æ•°æ®åº“ ä¹Ÿå¯ä»¥é€€å‡ºpsqlï¼Œé‡æ–°åŸºäºpsqlå‘½ä»¤å»åˆ‡æ¢ç”¨æˆ·ä»¥åŠæ•°æ®åº“ å¦‚æœè¦ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯ï¼Œæˆ–è€…åˆ é™¤ç”¨æˆ·ï¼Œå¯ä»¥æŸ¥çœ‹ # ä¿®æ”¹ç”¨æˆ·ï¼Œç›´æ¥åŸºäºALTERå‘½ä»¤æ“ä½œ # åˆ é™¤ç”¨æˆ·ï¼Œç›´æ¥åŸºäºDROPå‘½ä»¤æ“ä½œ å¦‚æœè¦æŸ¥çœ‹ç°åœ¨çš„å…¨éƒ¨ç”¨æˆ·ä¿¡æ¯ 5.2 æƒé™æ“ä½œ æƒé™æ“ä½œå‰ï¼Œè¦å…ˆæŒæ¡ä¸€ä¸‹PGSQLçš„é€»è¾‘ç»“æ„ å¯ä»¥çœ‹åˆ°PGSQLä¸€ä¸ªæ•°æ®åº“ä¸­æœ‰å¤šä¸ªschemaï¼Œåœ¨æ¯ä¸ªschemaä¸‹éƒ½æœ‰è‡ªå·±çš„ç›¸åº”çš„åº“è¡¨ä¿¡æ¯ï¼Œæƒé™ç²’åº¦ä¼šæ¯”MySQLæ›´ç»†ä¸€äº›ã€‚ åœ¨PGSQLä¸­ï¼Œæƒé™çš„ç®¡ç†åˆ†ä¸ºå¾ˆå¤šå¤šå±‚ serverã€clusterã€tablespaceçº§åˆ«ï¼šè¿™ä¸ªçº§åˆ«ä¸€èˆ¬æ˜¯åŸºäºpg_hba.confå»é…ç½® databaseçº§åˆ«ï¼šé€šè¿‡å‘½ä»¤çº§åˆ«æ“ä½œï¼Œgrant namespaceã€schemaçº§åˆ«ï¼šç©çš„ä¸å¤šâ€¦â€¦ä¸å»å¤šäº†è§£è¿™ä¸ª~~ å¯¹è±¡çº§åˆ«ï¼šé€šè¿‡grantå‘½ä»¤å»è®¾ç½® åé¢å¦‚æœéœ€è¦å¯¹databaseæˆ–è€…æ˜¯å¯¹è±¡çº§åˆ«åšæƒé™æ§åˆ¶ï¼Œç›´æ¥åŸºäºgrantå‘½ä»¤å»æ“ä½œå³å¯ # æŸ¥çœ‹grantå‘½ä»¤ \\help grant å°ä»»åŠ¡ æ„å»ºä¸€ä¸ªç”¨æˆ·ï¼ˆä½ è‡ªå·±åå­—ï¼‰ æ„å»ºä¸€ä¸ªæ•°æ®åº“ åœ¨è¿™ä¸ªæ•°æ®åº“ä¸‹æ„å»ºä¸€ä¸ªschemaï¼ˆæ•°æ®åº“é»˜è®¤æœ‰ä¸€ä¸ªpublicçš„schemaï¼‰ å°†è¿™ä¸ªschemaçš„æƒé™èµ‹äºˆç”¨æˆ· åœ¨è¿™ä¸ªschemaä¸‹æ„å»ºä¸€ä¸ªè¡¨ å°†è¡¨çš„selectï¼Œupdateï¼Œinsertæƒé™èµ‹äºˆç”¨æˆ· å®Œæˆä¸Šè¿°æ“ä½œ -- å‡†å¤‡ç”¨æˆ· create user laozheng with password 'laozheng'; -- å‡†å¤‡æ•°æ®åº“ create database laozheng; -- åˆ‡æ¢æ•°æ®åº“ \\c laozheng; -- æ„å»ºschema create schema laozheng; -- å°†schemaçš„æ‹¥æœ‰è€…ä¿®æ”¹ä¸ºlaozhengç”¨æˆ· alter schema laozheng owner to laozheng; -- å°†laozhengåº“ä¸‹çš„laozhengçš„schemaä¸­çš„è¡¨çš„å¢ï¼Œæ”¹ï¼ŒæŸ¥æƒé™èµ‹äºˆç»™laozhengç”¨æˆ· grant select,insert,update on all tables in schema laozheng to laozheng; -- ç”¨postgresç”¨æˆ·å…ˆæ„å»ºä¸€å¼ è¡¨ create table laozheng.test(id int); -- åˆ‡æ¢åˆ°laozhengç”¨æˆ·ã€‚ \\c laozheng -laozheng -- æŠ¥é”™ï¼š -- è‡´å‘½é”™è¯¯: å¯¹ç”¨æˆ·&quot;-laozheng&quot;çš„å¯¹ç­‰è®¤è¯å¤±è´¥ -- Previous connection kept -- ä¸Šè¿°æ–¹å¼ç›´æ¥å‡‰å‡‰ï¼ŒåŸå› æ˜¯åŒ¹é…è¿æ¥æ–¹å¼æ—¶ï¼ŒåŸºäºpg_hba.confæ–‡ä»¶å»ä»ä¸Šå¾€ä¸‹æ‰¾ -- æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªæ˜¯localï¼ŒåŒ¹é…ä¸Šçš„ã€‚å‘ç°è¿æ¥æ–¹å¼æ˜¯peerã€‚ -- peerä»£è¡¨ç”¨å½“å‰ç³»ç»Ÿç”¨æˆ·å»è¿æ¥PostgreSQL -- å½“å‰ç³»ç»Ÿç”¨æˆ·åªæœ‰postgresï¼Œæ²¡æœ‰laozhengï¼Œæ— æ³•ä½¿ç”¨peerè¿æ¥ -- æƒ³æ„å»ºlaozhengç”¨æˆ·æ—¶ï¼Œå‘ç°postgreSQLçš„æ‰€æœ‰æ–‡ä»¶æ‹¥æœ‰è€…å’Œæ‰€å±ç»„éƒ½æ˜¯postgresï¼Œå¹¶ä¸”èƒ½æ“ä½œçš„åªæœ‰æ‹¥æœ‰è€… -- åŸºäºä¸Šè¿°é—®é¢˜ï¼Œä¸é‡‡ç”¨æœ¬åœ°è¿æ¥å³å¯ã€‚ -- é‡‡ç”¨è¿œç¨‹è¿æ¥ã€‚ psql -h 192.168.11.32 -p 5432 -U laozheng -W -- è¿™æ ·ä¾èµ–ï¼Œè·³è¿‡äº†localé“¾æ¥æ–¹å¼çš„åŒ¹é…ï¼Œç›´æ¥é”å®šåˆ°åé¢çš„hostï¼Œhostçš„è¿æ¥æ–¹å¼æ˜¯md5ï¼Œmd5å…¶å®å°±æ˜¯å¯†ç åŠ å¯†äº†ã€‚ -- ç™»å½•åï¼Œç›´æ¥è¾“å…¥ \\dn -- æŸ¥çœ‹åˆ°å½“å‰databaseä¸‹æœ‰ä¸¤ä¸ªschema è¿™ç§æƒé™çš„èµ‹äºˆæ–¹å¼ï¼Œå¯ä»¥ç”¨ç®¡ç†å‘˜ç”¨æˆ·å»æ„å»ºæ•´ä½“è¡¨ç»“æ„ï¼Œå¦‚æ­¤ä¸€æ¥ï¼Œåˆ†é…æŒ‡å®šç”¨æˆ·ï¼Œèµ‹äºˆä¸åŒçš„æƒé™ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå°±ä¸æ€•ç”¨æˆ·è¯¯æ“äº†ã€‚ å…­ã€å›¾å½¢åŒ–ç•Œé¢å®‰è£… å›¾å½¢åŒ–ç•Œé¢å¯ä»¥è¿æ¥PGSQLçš„å¾ˆå¤šï¼ŒNavicatï¼ˆæ”¶è´¹ï¼‰ã€‚ ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨PostgreSQLå®˜æ–¹æä¾›çš„å›¾å½¢åŒ–ç•Œé¢ã€‚ï¼ˆå®Œå…¨å…è´¹ï¼‰ å®˜æ–¹æä¾›çš„ï¼šhttps://www.pgadmin.org/ ç›´æ¥ç‚¹å‡»å°±å¯ä»¥ä¸‹è½½~~~https://www.postgresql.org/ftp/pgadmin/pgadmin4/v6.9/windows/ å‚»ç“œå¼å®‰è£…~~~ æ‰“å¼€pgAdmin æ·»åŠ ä¸€ä¸ªæ–°çš„è¿æ¥ ç›´æ¥saveï¼Œå°±å¯ä»¥è¿æ¥åˆ°è€éƒ‘çš„ä¿¡æ¯ å¯ä»¥åˆ‡æ¢è¯­è¨€ ","link":"https://tianxiawuhao.github.io/IKbaKSlgE1/"},{"title":"Goè¯­è¨€æŒ‡é’ˆè¯¦è§£","content":"ä¸ Java å’Œ .NET ç­‰ç¼–ç¨‹è¯­è¨€ä¸åŒï¼ŒGoè¯­è¨€ä¸ºç¨‹åºå‘˜æä¾›äº†æ§åˆ¶æ•°æ®ç»“æ„æŒ‡é’ˆçš„èƒ½åŠ›ï¼Œä½†æ˜¯ï¼Œå¹¶ä¸èƒ½è¿›è¡ŒæŒ‡é’ˆè¿ç®—ã€‚Goè¯­è¨€å…è®¸ä½ æ§åˆ¶ç‰¹å®šé›†åˆçš„æ•°æ®ç»“æ„ã€åˆ†é…çš„æ•°é‡ä»¥åŠå†…å­˜è®¿é—®æ¨¡å¼ï¼Œè¿™å¯¹äºæ„å»ºè¿è¡Œè‰¯å¥½çš„ç³»ç»Ÿæ˜¯éå¸¸é‡è¦çš„ã€‚æŒ‡é’ˆå¯¹äºæ€§èƒ½çš„å½±å“ä¸è¨€è€Œå–»ï¼Œå¦‚æœä½ æƒ³è¦åšç³»ç»Ÿç¼–ç¨‹ã€æ“ä½œç³»ç»Ÿæˆ–è€…ç½‘ç»œåº”ç”¨ï¼ŒæŒ‡é’ˆæ›´æ˜¯ä¸å¯æˆ–ç¼ºçš„ä¸€éƒ¨åˆ†ã€‚ æŒ‡é’ˆï¼ˆpointerï¼‰åœ¨Goè¯­è¨€ä¸­å¯ä»¥è¢«æ‹†åˆ†ä¸ºä¸¤ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š ç±»å‹æŒ‡é’ˆï¼Œå…è®¸å¯¹è¿™ä¸ªæŒ‡é’ˆç±»å‹çš„æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œä¼ é€’æ•°æ®å¯ä»¥ç›´æ¥ä½¿ç”¨æŒ‡é’ˆï¼Œè€Œæ— é¡»æ‹·è´æ•°æ®ï¼Œç±»å‹æŒ‡é’ˆä¸èƒ½è¿›è¡Œåç§»å’Œè¿ç®—ã€‚ åˆ‡ç‰‡ï¼Œç”±æŒ‡å‘èµ·å§‹å…ƒç´ çš„åŸå§‹æŒ‡é’ˆã€å…ƒç´ æ•°é‡å’Œå®¹é‡ç»„æˆã€‚ å—ç›Šäºè¿™æ ·çš„çº¦æŸå’Œæ‹†åˆ†ï¼ŒGoè¯­è¨€çš„æŒ‡é’ˆç±»å‹å˜é‡å³æ‹¥æœ‰æŒ‡é’ˆé«˜æ•ˆè®¿é—®çš„ç‰¹ç‚¹ï¼Œåˆä¸ä¼šå‘ç”ŸæŒ‡é’ˆåç§»ï¼Œä»è€Œé¿å…äº†éæ³•ä¿®æ”¹å…³é”®æ€§æ•°æ®çš„é—®é¢˜ã€‚åŒæ—¶ï¼Œåƒåœ¾å›æ”¶ä¹Ÿæ¯”è¾ƒå®¹æ˜“å¯¹ä¸ä¼šå‘ç”Ÿåç§»çš„æŒ‡é’ˆè¿›è¡Œæ£€ç´¢å’Œå›æ”¶ã€‚ åˆ‡ç‰‡æ¯”åŸå§‹æŒ‡é’ˆå…·å¤‡æ›´å¼ºå¤§çš„ç‰¹æ€§ï¼Œè€Œä¸”æ›´ä¸ºå®‰å…¨ã€‚åˆ‡ç‰‡åœ¨å‘ç”Ÿè¶Šç•Œæ—¶ï¼Œè¿è¡Œæ—¶ä¼šæŠ¥å‡ºå®•æœºï¼Œå¹¶æ‰“å‡ºå †æ ˆï¼Œè€ŒåŸå§‹æŒ‡é’ˆåªä¼šå´©æºƒã€‚ C/C++ä¸­çš„æŒ‡é’ˆ è¯´åˆ° C/C++ ä¸­çš„æŒ‡é’ˆï¼Œä¼šè®©è®¸å¤šäººâ€œè°ˆè™è‰²å˜â€ï¼Œå°¤å…¶æ˜¯å¯¹æŒ‡é’ˆçš„åç§»ã€è¿ç®—å’Œè½¬æ¢ã€‚ å…¶å®ï¼ŒæŒ‡é’ˆæ˜¯ C/C++ è¯­è¨€æ‹¥æœ‰æé«˜æ€§èƒ½çš„æ ¹æœ¬æ‰€åœ¨ï¼Œåœ¨æ“ä½œå¤§å—æ•°æ®å’Œåšåç§»æ—¶å³æ–¹ä¾¿åˆä¾¿æ·ã€‚å› æ­¤ï¼Œæ“ä½œç³»ç»Ÿä¾ç„¶ä½¿ç”¨Cè¯­è¨€åŠæŒ‡é’ˆçš„ç‰¹æ€§è¿›è¡Œç¼–å†™ã€‚ C/C++ ä¸­æŒ‡é’ˆé¥±å—è¯Ÿç—…çš„æ ¹æœ¬åŸå› æ˜¯æŒ‡é’ˆçš„è¿ç®—å’Œå†…å­˜é‡Šæ”¾ï¼ŒC/C++ è¯­è¨€ä¸­çš„è£¸æŒ‡é’ˆå¯ä»¥è‡ªç”±åç§»ï¼Œç”šè‡³å¯ä»¥åœ¨æŸäº›æƒ…å†µä¸‹åç§»è¿›å…¥æ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒåŒºåŸŸï¼Œæˆ‘ä»¬çš„è®¡ç®—æœºæ“ä½œç³»ç»Ÿç»å¸¸éœ€è¦æ›´æ–°ã€ä¿®å¤æ¼æ´çš„æœ¬è´¨ï¼Œå°±æ˜¯ä¸ºè§£å†³æŒ‡é’ˆè¶Šç•Œè®¿é—®æ‰€å¯¼è‡´çš„â€œç¼“å†²åŒºæº¢å‡ºâ€çš„é—®é¢˜ã€‚ è¦æ˜ç™½æŒ‡é’ˆï¼Œéœ€è¦çŸ¥é“å‡ ä¸ªæ¦‚å¿µï¼šæŒ‡é’ˆåœ°å€ã€æŒ‡é’ˆç±»å‹å’ŒæŒ‡é’ˆå–å€¼ï¼Œä¸‹é¢å°†å±•å¼€è¯¦ç»†è¯´æ˜ã€‚ è®¤è¯†æŒ‡é’ˆåœ°å€å’ŒæŒ‡é’ˆç±»å‹ ä¸€ä¸ªæŒ‡é’ˆå˜é‡å¯ä»¥æŒ‡å‘ä»»ä½•ä¸€ä¸ªå€¼çš„å†…å­˜åœ°å€ï¼Œå®ƒæ‰€æŒ‡å‘çš„å€¼çš„å†…å­˜åœ°å€åœ¨ 32 å’Œ 64 ä½æœºå™¨ä¸Šåˆ†åˆ«å ç”¨ 4 æˆ– 8 ä¸ªå­—èŠ‚ï¼Œå ç”¨å­—èŠ‚çš„å¤§å°ä¸æ‰€æŒ‡å‘çš„å€¼çš„å¤§å°æ— å…³ã€‚å½“ä¸€ä¸ªæŒ‡é’ˆè¢«å®šä¹‰åæ²¡æœ‰åˆ†é…åˆ°ä»»ä½•å˜é‡æ—¶ï¼Œå®ƒçš„é»˜è®¤å€¼ä¸º nilã€‚æŒ‡é’ˆå˜é‡é€šå¸¸ç¼©å†™ä¸º ptrã€‚ æ¯ä¸ªå˜é‡åœ¨è¿è¡Œæ—¶éƒ½æ‹¥æœ‰ä¸€ä¸ªåœ°å€ï¼Œè¿™ä¸ªåœ°å€ä»£è¡¨å˜é‡åœ¨å†…å­˜ä¸­çš„ä½ç½®ã€‚Goè¯­è¨€ä¸­ä½¿ç”¨åœ¨å˜é‡åå‰é¢æ·»åŠ &amp;æ“ä½œç¬¦ï¼ˆå‰ç¼€ï¼‰æ¥è·å–å˜é‡çš„å†…å­˜åœ°å€ï¼ˆå–åœ°å€æ“ä½œï¼‰ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š ptr := &amp;v // v çš„ç±»å‹ä¸º T å…¶ä¸­ v ä»£è¡¨è¢«å–åœ°å€çš„å˜é‡ï¼Œå˜é‡ v çš„åœ°å€ä½¿ç”¨å˜é‡ ptr è¿›è¡Œæ¥æ”¶ï¼Œptr çš„ç±»å‹ä¸º*Tï¼Œç§°åš T çš„æŒ‡é’ˆç±»å‹ï¼Œ*ä»£è¡¨æŒ‡é’ˆã€‚ æŒ‡é’ˆå®é™…ç”¨æ³•ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„ä¾‹å­äº†è§£ï¼š package main import ( &quot;fmt&quot; ) func main() { var cat int = 1 var str string = &quot;banana&quot; fmt.Printf(&quot;%p %p&quot;, &amp;cat, &amp;str) } è¿è¡Œç»“æœï¼š 0xc042052088 0xc0420461b0 ä»£ç è¯´æ˜å¦‚ä¸‹ï¼š var cat int = 1ï¼Œå£°æ˜æ•´å‹å˜é‡ catã€‚ var str string = &quot;banana&quot;ï¼Œå£°æ˜å­—ç¬¦ä¸²å˜é‡ strã€‚ fmt.Printf(&quot;%p %p&quot;, &amp;cat, &amp;str)ï¼Œä½¿ç”¨ fmt.Printf çš„åŠ¨è¯%pæ‰“å° cat å’Œ str å˜é‡çš„å†…å­˜åœ°å€ï¼ŒæŒ‡é’ˆçš„å€¼æ˜¯å¸¦æœ‰0xåå…­è¿›åˆ¶å‰ç¼€çš„ä¸€ç»„æ•°æ®ã€‚ æç¤ºï¼šå˜é‡ã€æŒ‡é’ˆå’Œåœ°å€ä¸‰è€…çš„å…³ç³»æ˜¯ï¼Œæ¯ä¸ªå˜é‡éƒ½æ‹¥æœ‰åœ°å€ï¼ŒæŒ‡é’ˆçš„å€¼å°±æ˜¯åœ°å€ã€‚ ä»æŒ‡é’ˆè·å–æŒ‡é’ˆæŒ‡å‘çš„å€¼ å½“ä½¿ç”¨&amp;æ“ä½œç¬¦å¯¹æ™®é€šå˜é‡è¿›è¡Œå–åœ°å€æ“ä½œå¹¶å¾—åˆ°å˜é‡çš„æŒ‡é’ˆåï¼Œå¯ä»¥å¯¹æŒ‡é’ˆä½¿ç”¨*æ“ä½œç¬¦ï¼Œä¹Ÿå°±æ˜¯æŒ‡é’ˆå–å€¼ï¼Œä»£ç å¦‚ä¸‹ã€‚ package main import ( &quot;fmt&quot; ) func main() { // å‡†å¤‡ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹ var house = &quot;Malibu Point 10880, 90265&quot; // å¯¹å­—ç¬¦ä¸²å–åœ°å€, ptrç±»å‹ä¸º*string ptr := &amp;house // æ‰“å°ptrçš„ç±»å‹ fmt.Printf(&quot;ptr type: %T\\n&quot;, ptr) // æ‰“å°ptrçš„æŒ‡é’ˆåœ°å€ fmt.Printf(&quot;address: %p\\n&quot;, ptr) // å¯¹æŒ‡é’ˆè¿›è¡Œå–å€¼æ“ä½œ value := *ptr // å–å€¼åçš„ç±»å‹ fmt.Printf(&quot;value type: %T\\n&quot;, value) // æŒ‡é’ˆå–å€¼åå°±æ˜¯æŒ‡å‘å˜é‡çš„å€¼ fmt.Printf(&quot;value: %s\\n&quot;, value) } è¿è¡Œç»“æœï¼š ptr type: *string address: 0xc0420401b0 value type: string value: Malibu Point 10880, 90265 å–åœ°å€æ“ä½œç¬¦&amp;å’Œå–å€¼æ“ä½œç¬¦*æ˜¯ä¸€å¯¹äº’è¡¥æ“ä½œç¬¦ï¼Œ&amp;å–å‡ºåœ°å€ï¼Œ*æ ¹æ®åœ°å€å–å‡ºåœ°å€æŒ‡å‘çš„å€¼ã€‚ å˜é‡ã€æŒ‡é’ˆåœ°å€ã€æŒ‡é’ˆå˜é‡ã€å–åœ°å€ã€å–å€¼çš„ç›¸äº’å…³ç³»å’Œç‰¹æ€§å¦‚ä¸‹ï¼š å¯¹å˜é‡è¿›è¡Œå–åœ°å€æ“ä½œä½¿ç”¨&amp;æ“ä½œç¬¦ï¼Œå¯ä»¥è·å¾—è¿™ä¸ªå˜é‡çš„æŒ‡é’ˆå˜é‡ã€‚ æŒ‡é’ˆå˜é‡çš„å€¼æ˜¯æŒ‡é’ˆåœ°å€ã€‚ å¯¹æŒ‡é’ˆå˜é‡è¿›è¡Œå–å€¼æ“ä½œä½¿ç”¨*æ“ä½œç¬¦ï¼Œå¯ä»¥è·å¾—æŒ‡é’ˆå˜é‡æŒ‡å‘çš„åŸå˜é‡çš„å€¼ã€‚ ä½¿ç”¨æŒ‡é’ˆä¿®æ”¹å€¼ é€šè¿‡æŒ‡é’ˆä¸ä»…å¯ä»¥å–å€¼ï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹å€¼ã€‚ å‰é¢å·²ç»æ¼”ç¤ºäº†ä½¿ç”¨å¤šé‡èµ‹å€¼çš„æ–¹æ³•è¿›è¡Œæ•°å€¼äº¤æ¢ï¼Œä½¿ç”¨æŒ‡é’ˆåŒæ ·å¯ä»¥è¿›è¡Œæ•°å€¼äº¤æ¢ï¼Œä»£ç å¦‚ä¸‹ï¼š package main import &quot;fmt&quot; // äº¤æ¢å‡½æ•° func swap(a, b *int) { // å–aæŒ‡é’ˆçš„å€¼, èµ‹ç»™ä¸´æ—¶å˜é‡t t := *a // å–bæŒ‡é’ˆçš„å€¼, èµ‹ç»™aæŒ‡é’ˆæŒ‡å‘çš„å˜é‡ *a = *b // å°†aæŒ‡é’ˆçš„å€¼èµ‹ç»™bæŒ‡é’ˆæŒ‡å‘çš„å˜é‡ *b = t } func main() { // å‡†å¤‡ä¸¤ä¸ªå˜é‡, èµ‹å€¼1å’Œ2 x, y := 1, 2 // äº¤æ¢å˜é‡å€¼ swap(&amp;x, &amp;y) // è¾“å‡ºå˜é‡å€¼ fmt.Println(x, y) } è¿è¡Œç»“æœï¼š 2 1 *æ“ä½œç¬¦ä½œä¸ºå³å€¼æ—¶ï¼Œæ„ä¹‰æ˜¯å–æŒ‡é’ˆçš„å€¼ï¼Œä½œä¸ºå·¦å€¼æ—¶ï¼Œä¹Ÿå°±æ˜¯æ”¾åœ¨èµ‹å€¼æ“ä½œç¬¦çš„å·¦è¾¹æ—¶ï¼Œè¡¨ç¤º a æŒ‡é’ˆæŒ‡å‘çš„å˜é‡ã€‚å…¶å®å½’çº³èµ·æ¥ï¼Œ*æ“ä½œç¬¦çš„æ ¹æœ¬æ„ä¹‰å°±æ˜¯æ“ä½œæŒ‡é’ˆæŒ‡å‘çš„å˜é‡ã€‚å½“æ“ä½œåœ¨å³å€¼æ—¶ï¼Œå°±æ˜¯å–æŒ‡å‘å˜é‡çš„å€¼ï¼Œå½“æ“ä½œåœ¨å·¦å€¼æ—¶ï¼Œå°±æ˜¯å°†å€¼è®¾ç½®ç»™æŒ‡å‘çš„å˜é‡ã€‚ å¦‚æœåœ¨ swap() å‡½æ•°ä¸­äº¤æ¢æ“ä½œçš„æ˜¯æŒ‡é’ˆå€¼ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼Ÿå¯ä»¥å‚è€ƒä¸‹é¢ä»£ç ï¼š package main import &quot;fmt&quot; func swap(a, b *int) { b, a = a, b } func main() { x, y := 1, 2 swap(&amp;x, &amp;y) fmt.Println(x, y) } è¿è¡Œç»“æœï¼š 1 2 ç»“æœè¡¨æ˜ï¼Œäº¤æ¢æ˜¯ä¸æˆåŠŸçš„ã€‚ä¸Šé¢ä»£ç ä¸­çš„ swap() å‡½æ•°äº¤æ¢çš„æ˜¯ a å’Œ b çš„åœ°å€ï¼Œåœ¨äº¤æ¢å®Œæ¯•åï¼Œa å’Œ b çš„å˜é‡å€¼ç¡®å®è¢«äº¤æ¢ã€‚ä½†å’Œ aã€b å…³è”çš„ä¸¤ä¸ªå˜é‡å¹¶æ²¡æœ‰å®é™…å…³è”ã€‚è¿™å°±åƒå†™æœ‰ä¸¤åº§æˆ¿å­çš„å¡ç‰‡æ”¾åœ¨æ¡Œä¸Šä¸€å­—æ‘Šå¼€ï¼Œäº¤æ¢ä¸¤åº§æˆ¿å­çš„å¡ç‰‡åå¹¶ä¸ä¼šå¯¹ä¸¤åº§æˆ¿å­æœ‰ä»»ä½•å½±å“ã€‚ ç¤ºä¾‹ï¼šä½¿ç”¨æŒ‡é’ˆå˜é‡è·å–å‘½ä»¤è¡Œçš„è¾“å…¥ä¿¡æ¯ Goè¯­è¨€å†…ç½®çš„ flag åŒ…å®ç°äº†å¯¹å‘½ä»¤è¡Œå‚æ•°çš„è§£æï¼Œflag åŒ…ä½¿å¾—å¼€å‘å‘½ä»¤è¡Œå·¥å…·æ›´ä¸ºç®€å•ã€‚ ä¸‹é¢çš„ä»£ç é€šè¿‡æå‰å®šä¹‰ä¸€äº›å‘½ä»¤è¡ŒæŒ‡ä»¤å’Œå¯¹åº”çš„å˜é‡ï¼Œå¹¶åœ¨è¿è¡Œæ—¶è¾“å…¥å¯¹åº”çš„å‚æ•°ï¼Œç»è¿‡ flag åŒ…çš„è§£æåå³å¯è·å–å‘½ä»¤è¡Œçš„æ•°æ®ã€‚ ã€ç¤ºä¾‹ã€‘è·å–å‘½ä»¤è¡Œè¾“å…¥ï¼š package main // å¯¼å…¥ç³»ç»ŸåŒ… import ( &quot;flag&quot; &quot;fmt&quot; ) // å®šä¹‰å‘½ä»¤è¡Œå‚æ•° var mode = flag.String(&quot;mode&quot;, &quot;&quot;, &quot;process mode&quot;) func main() { // è§£æå‘½ä»¤è¡Œå‚æ•° flag.Parse() // è¾“å‡ºå‘½ä»¤è¡Œå‚æ•° fmt.Println(*mode) } å°†è¿™æ®µä»£ç å‘½åä¸º main.goï¼Œç„¶åä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¡Œè¿è¡Œï¼š go run main.go --mode=fast å‘½ä»¤è¡Œè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š fast ä»£ç è¯´æ˜å¦‚ä¸‹ï¼š var mode = flag.String(&quot;mode&quot;, &quot;&quot;, &quot;process mode&quot;)ï¼Œé€šè¿‡ flag.Stringï¼Œå®šä¹‰ä¸€ä¸ª mode å˜é‡ï¼Œè¿™ä¸ªå˜é‡çš„ç±»å‹æ˜¯ *stringã€‚åé¢ 3 ä¸ªå‚æ•°åˆ†åˆ«å¦‚ä¸‹ï¼š å‚æ•°åç§°ï¼šåœ¨å‘½ä»¤è¡Œè¾“å…¥å‚æ•°æ—¶ï¼Œä½¿ç”¨è¿™ä¸ªåç§°ã€‚ å‚æ•°å€¼çš„é»˜è®¤å€¼ï¼šä¸ flag æ‰€ä½¿ç”¨çš„å‡½æ•°åˆ›å»ºå˜é‡ç±»å‹å¯¹åº”ï¼ŒString å¯¹åº”å­—ç¬¦ä¸²ã€Int å¯¹åº”æ•´å‹ã€Bool å¯¹åº”å¸ƒå°”å‹ç­‰ã€‚ å‚æ•°è¯´æ˜ï¼šä½¿ç”¨ -help æ—¶ï¼Œä¼šå‡ºç°åœ¨è¯´æ˜ä¸­ã€‚ flag.Parse()ï¼Œè§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œå¹¶å°†ç»“æœå†™å…¥åˆ°å˜é‡ mode ä¸­ã€‚ fmt.Println(*mode)ï¼Œæ‰“å° mode æŒ‡é’ˆæ‰€æŒ‡å‘çš„å˜é‡ã€‚ ç”±äºä¹‹å‰å·²ç»ä½¿ç”¨ flag.String æ³¨å†Œäº†ä¸€ä¸ªåä¸º mode çš„å‘½ä»¤è¡Œå‚æ•°ï¼Œflag åº•å±‚çŸ¥é“æ€ä¹ˆè§£æå‘½ä»¤è¡Œï¼Œå¹¶ä¸”å°†å€¼èµ‹ç»™ mode*string æŒ‡é’ˆï¼Œåœ¨ Parse è°ƒç”¨å®Œæ¯•åï¼Œæ— é¡»ä» flag è·å–å€¼ï¼Œè€Œæ˜¯é€šè¿‡è‡ªå·±æ³¨å†Œçš„è¿™ä¸ª mode æŒ‡é’ˆè·å–åˆ°æœ€ç»ˆçš„å€¼ã€‚ä»£ç è¿è¡Œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ å›¾ï¼šå‘½ä»¤è¡Œå‚æ•°ä¸å˜é‡çš„å…³ç³» åˆ›å»ºæŒ‡é’ˆçš„å¦ä¸€ç§æ–¹æ³•â€”â€”new() å‡½æ•° Goè¯­è¨€è¿˜æä¾›äº†å¦å¤–ä¸€ç§æ–¹æ³•æ¥åˆ›å»ºæŒ‡é’ˆå˜é‡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š new(ç±»å‹) ä¸€èˆ¬è¿™æ ·å†™ï¼š str := new(string) *str = &quot;Goè¯­è¨€æ•™ç¨‹&quot; fmt.Println(*str) new() å‡½æ•°å¯ä»¥åˆ›å»ºä¸€ä¸ªå¯¹åº”ç±»å‹çš„æŒ‡é’ˆï¼Œåˆ›å»ºè¿‡ç¨‹ä¼šåˆ†é…å†…å­˜ï¼Œè¢«åˆ›å»ºçš„æŒ‡é’ˆæŒ‡å‘é»˜è®¤å€¼ã€‚ package main import &quot;fmt&quot; type A struct { Ptr1 *B Ptr2 *B Val B Val2 string Val3 int } type B struct { Str string } func main() { a := A{ Ptr1: &amp;B{&quot;ptr-str-1&quot;}, Ptr2: &amp;B{&quot;ptr-str-2&quot;}, Val: B{&quot;val-str&quot;}, Val2: &quot;main&quot;, Val3: 0, } fmt.Printf(&quot;main a addr: %p\\n&quot;, &amp;a) //aåœ°å€ fmt.Printf(&quot;main a addr: %p\\n&quot;, a) //aåœ°å€ fmt.Printf(&quot;main Ptr1 addr: %p, point to addr: %p, value: %v\\n&quot;, &amp;a.Ptr1, a.Ptr1, *a.Ptr1) //aåœ°å€ï¼Œptr1åœ°å€ï¼ŒBæ•°æ®ptr-str-1 fmt.Printf(&quot;main Ptr2 addr: %p, point to addr: %p, value: %v\\n&quot;, &amp;a.Ptr2, a.Ptr2, *a.Ptr2) //ptr2åœ°å€ï¼Œptr2-Båœ°å€ï¼ŒBæ•°æ®ptr-str-2 fmt.Printf(&quot;main Val addr: %p, value: %v\\n&quot;, &amp;a.Val, a.Val) //a.Valåœ°å€ï¼Œa.Valå€¼ fmt.Printf(&quot;main Val2 addr: %p, value: %v\\n&quot;, &amp;a.Val2, a.Val2) //a.Val2åœ°å€ï¼Œa.Val2å€¼ fmt.Printf(&quot;main Val3 addr: %p, value: %v\\n\\n&quot;, &amp;a.Val3, a.Val3) //a.Val3åœ°å€ï¼Œa.Val3å€¼ demo1(a) fmt.Println(&quot;after demo1:&quot;) fmt.Printf(&quot;main Ptr1 addr: %p, point to addr: %p, value: %v\\n&quot;, &amp;a.Ptr1, a.Ptr1, *a.Ptr1) fmt.Printf(&quot;main Ptr2 addr: %p, point to addr: %p, value: %v\\n&quot;, &amp;a.Ptr2, a.Ptr2, *a.Ptr2) fmt.Printf(&quot;main Val addr: %p, value: %v\\n&quot;, &amp;a.Val, a.Val) fmt.Printf(&quot;main Val2 addr: %p, value: %v\\n&quot;, &amp;a.Val2, a.Val2) fmt.Printf(&quot;main Val3 addr: %p, value: %v\\n\\n&quot;, &amp;a.Val3, a.Val3) demo2(&amp;a) fmt.Println(&quot;after demo2:&quot;) fmt.Printf(&quot;main Ptr1 addr: %p, point to addr: %p, value: %v\\n&quot;, &amp;a.Ptr1, a.Ptr1, *a.Ptr1) fmt.Printf(&quot;main Ptr2 addr: %p, point to addr: %p, value: %v\\n&quot;, &amp;a.Ptr2, a.Ptr2, *a.Ptr2) fmt.Printf(&quot;main Val addr: %p, value: %v\\n&quot;, &amp;a.Val, a.Val) fmt.Printf(&quot;main Val2 addr: %p, value: %v\\n&quot;, &amp;a.Val2, a.Val2) fmt.Printf(&quot;main Val3 addr: %p, value: %v\\n\\n&quot;, &amp;a.Val3, a.Val3) } func demo1(a A) { fmt.Printf(&quot;demo1 a addr:%p\\n&quot;, &amp;a) //aåœ°å€ // Update a value of a pointer and changes will persist a.Ptr1.Str = &quot;demo1-ptr-str1&quot; fmt.Printf(&quot;demo1 Ptr1 addr: %p, point to addr: %p, value: %v\\n&quot;, &amp;a.Ptr1, a.Ptr1, *a.Ptr1) //aåœ°å€ï¼ŒPtr1åœ°å€ï¼Œå€¼demo1-ptr-str1 // Use an entirely new B object and changes won't persist a.Ptr2 = &amp;B{&quot;demo1-ptr-str-2&quot;} fmt.Printf(&quot;demo1 Ptr2 addr: %p, point to addr: %p, value: %v\\n&quot;, &amp;a.Ptr2, a.Ptr2, *a.Ptr2) //a.Ptr2åœ°å€ï¼ŒPtr2åœ°å€ï¼Œå€¼demo1-ptr-str-2 //a.Val.Str = &quot;new-val-str&quot; a.Val = B{&quot;demo1-val-str&quot;} fmt.Printf(&quot;demo1 Val addr: %p, value: %v\\n&quot;, &amp;a.Val, a.Val) //a.Valåœ°å€ï¼Œdemo1-val-str fmt.Printf(&quot;demo1 Val2 before addr: %p, value: %v\\n&quot;, &amp;a.Val2, a.Val2) a.Val2 = &quot;demo1&quot; fmt.Printf(&quot;demo1 Val2 after addr: %p, value: %v\\n&quot;, &amp;a.Val2, a.Val2) //åœ°å€ä¸å˜ï¼Œå€¼å˜ fmt.Printf(&quot;demo1 Val3 before addr: %p, value: %v\\n&quot;, &amp;a.Val3, a.Val3) a.Val3 = 1 fmt.Printf(&quot;demo1 Val3 after addr: %p, value: %v\\n&quot;, &amp;a.Val3, a.Val3) //åœ°å€ä¸å˜ï¼Œå€¼å˜ } func demo2(a *A) { fmt.Printf(&quot;demo2 a addr:%p\\n&quot;, &amp;a) fmt.Printf(&quot;demo2 a point to addr:%p\\n&quot;, a) //åœ¨goè¯­è¨€ä¸­é€šè¿‡æŒ‡é’ˆå»è®¿é—®æŒ‡é’ˆæ‰€å¯¹åº”çš„åœ°å€å¤„çš„å€¼æ—¶ï¼Œ*å…è®¸ä¸å†™ã€‚ a.Ptr1.Str = &quot;demo2-ptr-str1&quot; fmt.Printf(&quot;demo1 Ptr1 addr: %p, point to addr: %p, value: %v\\n&quot;, &amp;a.Ptr1, a.Ptr1, *a.Ptr1) a.Ptr2 = &amp;B{&quot;demo2-ptr-str-2&quot;} fmt.Printf(&quot;demo2 Ptr2 addr: %p, point to addr: %p, value: %v\\n&quot;, &amp;a.Ptr2, a.Ptr2, *a.Ptr2) //a.Val.Str = &quot;new-val-str&quot; a.Val = B{&quot;demo2-val-str&quot;} fmt.Printf(&quot;demo2 Val addr: %p, value: %v\\n&quot;, &amp;a.Val, a.Val) a.Val2 = &quot;demo2&quot; fmt.Printf(&quot;demo2 Val2 addr: %p, value: %v\\n&quot;, &amp;a.Val2, a.Val2) a.Val3 = 2 fmt.Printf(&quot;demo2 Val3 addr: %p, value: %v\\n&quot;, &amp;a.Val3, a.Val3) } main a addr: 0xc000078040 main a addr: %!p(main.A={0xc00006c250 0xc00006c260 {val-str} main 0}) main Ptr1 addr: 0xc000078040, point to addr: 0xc00006c250, value: {ptr-str-1} main Ptr2 addr: 0xc000078048, point to addr: 0xc00006c260, value: {ptr-str-2} main Val addr: 0xc000078050, value: {val-str} main Val2 addr: 0xc000078060, value: main main Val3 addr: 0xc000078070, value: 0 demo1 a addr:0xc0000780c0 demo1 Ptr1 addr: 0xc0000780c0, point to addr: 0xc00006c250, value: {demo1-ptr-str1} demo1 Ptr2 addr: 0xc0000780c8, point to addr: 0xc00006c2c0, value: {demo1-ptr-str-2} demo1 Val addr: 0xc0000780d0, value: {demo1-val-str} demo1 Val2 before addr: 0xc0000780e0, value: main demo1 Val2 after addr: 0xc0000780e0, value: demo1 demo1 Val3 before addr: 0xc0000780f0, value: 0 demo1 Val3 after addr: 0xc0000780f0, value: 1 after demo1: main Ptr1 addr: 0xc000078040, point to addr: 0xc00006c250, value: {demo1-ptr-str1} main Ptr2 addr: 0xc000078048, point to addr: 0xc00006c260, value: {ptr-str-2} main Val addr: 0xc000078050, value: {val-str} main Val2 addr: 0xc000078060, value: main main Val3 addr: 0xc000078070, value: 0 demo2 a addr:0xc00000a030 demo2 a point to addr:0xc000078040 demo1 Ptr1 addr: 0xc000078040, point to addr: 0xc00006c250, value: {demo2-ptr-st tr1} demo2 Ptr2 addr: 0xc000078048, point to addr: 0xc00006c360, value: {demo2-ptr-st tr-2} demo2 Val addr: 0xc000078050, value: {demo2-val-str} demo2 Val2 addr: 0xc000078060, value: demo2 demo2 Val3 addr: 0xc000078070, value: 2 after demo2: main Ptr1 addr: 0xc000078040, point to addr: 0xc00006c250, value: {demo2-ptr-str r1} main Ptr2 addr: 0xc000078048, point to addr: 0xc00006c360, value: {demo2-ptr-str r-2} main Val addr: 0xc000078050, value: {demo2-val-str} main Val2 addr: 0xc000078060, value: demo2 main Val3 addr: 0xc000078070, value: 2 ","link":"https://tianxiawuhao.github.io/FPlmZ5XzY/"},{"title":"Goè¯­è¨€å­¦ä¹ ï¼ˆç®€å•ä¸Javaä½œæ¯”è¾ƒï¼‰","content":"åºè¨€ â€‹ ä¹‹å‰æœ‰è¿‡ä¸€å¹´å¤šçš„Javaå¼€å‘ç»éªŒï¼Œä¸»è¦å­¦ä¹ äº†JavaåŸºç¡€ï¼ˆåŒ…å«é¢å‘å¯¹è±¡è¯­è¨€ç‰¹ç‚¹â€”â€”å°è£…ç»§æ‰¿å¤šæ€ã€å¼‚å¸¸å¤„ç†ã€å¸¸ç”¨ç±»ã€æ•°ç»„å’Œé›†åˆã€IOæµï¼‰ï¼ŒJVMå†…å­˜æœºåˆ¶ï¼Œè®¾è®¡æ¨¡å¼ï¼Œæ•°æ®åº“è®¾è®¡ï¼Œä»¥åŠåœ¨å·¥ä½œä¸­ç”¨åˆ°çš„ä¸€äº›å¼€å‘æ¡†æ¶ï¼Œäº†è§£å¹¶ç†Ÿæ‚‰åˆ«äººçš„æ¡†æ¶æœ‰åŠ©äºç®€åŒ–è‡ªå·±çš„å¼€å‘ã€‚æœ¬ç¯‡æ–‡ä»¶è¾ƒä¸ºå•°å—¦ï¼Œä¸”æ— ä¾§é‡ç‚¹ï¼Œæ…å…¥ã€‚ ä¸ç®¡æ˜¯å­¦ä¹ Cè¯­è¨€ã€C++ã€Javaè¿˜æ˜¯Goã€Pythonï¼Œå‰é¢å­¦åˆ°çš„ä¸œè¥¿å¹¶ä¸ä¼šç™½è´¹ï¼Œæœ‰äº›æ—¶å€™åè€Œèƒ½äº’è¡¥ï¼Œæ¯”å¦‚æœ‰äº›è®¾è®¡æ€æƒ³ã€‚ æ­å»ºç¯å¢ƒé‚£éƒ½æ˜¯ä¸€æ ·çš„å°±ä¸è¯´äº†ã€‚ä¸‹é¢å°±ä¸»è¦ä»¥Javaå’ŒGoè¯­è¨€ä½œå¯¹æ¯”ï¼ŒJavaæ˜¯é¢å‘å¯¹è±¡çš„è¯­è¨€ï¼ŒGoè¯­è¨€æ—¢ä¸æ˜¯é¢å‘å¯¹è±¡çš„è¯­è¨€ä¹Ÿä¸æ˜¯é¢å‘è¿‡ç¨‹çš„è¯­è¨€ï¼Œä½†Goè¯­è¨€åœ¨å…¶ä»–è¯­è¨€çš„èº«ä¸Šèƒ½æ‰¾åˆ°è‡ªå·±çš„å½±å­ã€‚ Javaæ‰€æœ‰å¼€å‘éƒ½æ˜¯ä»¥å¯¹è±¡æ¥çš„ï¼Œè™½ç„¶Javaçš„åŸºæœ¬æ•°æ®ç±»å‹**charï¼Œbooleanï¼Œbyteï¼Œshortï¼Œintï¼Œlongï¼Œfloatï¼Œdoubleï¼Œ**ä½†å®ƒä»¬éƒ½æœ‰å¯¹è±¡åŒ…è£…ç±»â€”â€”**Characterï¼ŒBooleanï¼ŒByteï¼ŒShortï¼ŒIntegerï¼ŒLongï¼ŒFloatï¼ŒDoubleï¼Œ**å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡åªéœ€è¦newå‡ºæ¥ï¼Œå®ƒå°±èƒ½åˆ›å»ºåœ¨JVMçš„å †é‡Œï¼Œè‡³äºä½¿ç”¨å®Œäº†åƒåœ¾å›æ”¶å¤§å®¶å¯ä»¥è‡ªå·±å»æŸ¥é˜…èµ„æ–™ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„ä¸€ä¸ªåœ°æ–¹å°±æ˜¯ï¼ŒåŸºæœ¬ç±»å‹intè½¬æ¢ä¸ºåŒ…è£…ç±»å‹Integeræ—¶ï¼Œåœ¨[-128,127]å†…è½¬æ¢çš„æ•°æ®ç›¸ç­‰ï¼Œåœ¨å…¶ä»–èŒƒå›´ç›¸åŒçš„intæ•°æ®è½¬æ¢çš„åŒ…è£…ç±»å€¼ä¸ç›¸ç­‰ã€‚è¿™æ˜¯ç”±äºIntegerç±»ä¸ºå†…éƒ¨æ•´æ•°ç»´æŠ¤ä¸€ä¸ªå†…éƒ¨é™æ€ç±»IntegerCacheç¼“å­˜å¹¶ä¿å­˜ä»-128åˆ°127çš„æ•´æ•°å¯¹è±¡ï¼Œæ‰€ä»¥åœ¨è¿™åŒºé—´è½¬æ¢å‡ºæ¥çš„æ˜¯ç›¸ç­‰çš„å¯¹è±¡ã€‚ public static void main(String[] args) { System.out.println(&quot;å®ä¾‹åŒ–ç›¸åŒå€¼å¯¹è±¡ç»“æœ=&quot;+(new Integer(127) == new Integer(127))); // false System.out.println(&quot;å®ä¾‹åŒ–ç›¸åŒå€¼å¯¹è±¡ç»“æœ=&quot;+(new Integer(128) == new Integer(128))); //false System.out.println(&quot;å°†åŸºæœ¬ç±»å‹intè½¬æ¢ä¸ºåŒ…è£…ç±»å‹Integerç»“æœ=&quot;+(Integer.valueOf(127) == Integer.valueOf(127))); //true System.out.println(&quot;å°†åŸºæœ¬ç±»å‹intè½¬æ¢ä¸ºåŒ…è£…ç±»å‹Integerç»“æœ=&quot;+(Integer.valueOf(128) == Integer.valueOf(128))); //false Integer a1 = 127; Integer a2 = 127; Integer b1 = 128; Integer b2 = 128; System.out.println(a1 == a2); //true System.out.println(b1 == b2); //false } Javaå’ŒGoè¯­è¨€åŒºåˆ« æ•°æ®ç±»å‹ ä¸Šé¢å…¶å®ä¹Ÿæåˆ°è¿‡Javaçš„åŸºæœ¬æ•°æ®ç±»å‹ï¼Œå…¶å®Javaé™¤äº†å…«å¤§åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆcharï¼Œbooleanï¼Œbyteï¼Œshortï¼Œintï¼Œlongï¼Œfloatï¼Œdoubleï¼‰å¤–è¿˜æœ‰å¼•ç”¨æ•°æ®ç±»å‹ï¼Œå¦‚å¯¹è±¡ï¼ˆåŒ…å«stringï¼‰ã€æ•°ç»„ã€‚ Goè¯­è¨€æ•°æ®ç±»å‹åŒ…å«å¸ƒå°”å‹ï¼ˆboolï¼‰ï¼Œæ•°å­—å‹ï¼ˆuint8ã€uint16ã€uint32ã€uint64ã€int8ã€int16ã€int32ã€int64ã€float32ã€float64ã€complex64ã€complex128ï¼‰ï¼Œå­—ç¬¦ä¸²å‹ï¼Œæ´¾ç”Ÿç±»å‹ï¼ˆæŒ‡é’ˆPointerã€æ•°ç»„ã€ç»“æ„åŒ–ç±»å‹ã€Channelã€å‡½æ•°ã€åˆ‡ç‰‡ã€æ¥å£ã€Mapï¼‰ï¼Œå¸ƒå°”å‹ã€æ•°å­—å‹ã€å­—ç¬¦ä¸²å‹çš„é»˜è®¤å€¼å’ŒJavaå·®ä¸å¤šï¼Œä¸è¿‡Javaçš„å¼•ç”¨æ•°æ®ç±»å‹Javaæ˜¯nullï¼ŒGoçš„æ´¾ç”Ÿç±»å‹æ˜¯nilã€‚ Javaä¸­å ç”¨å­—èŠ‚å¤§å°ï¼šchar-2å­—èŠ‚ï¼Œboolean-1å­—èŠ‚ï¼ˆbooleanç±»å‹æ•°ç»„çš„è®¿é—®ä¸ä¿®æ”¹å…±ç”¨byteç±»å‹æ•°ç»„çš„baloadå’ŒbastoreæŒ‡ä»¤æ—¶ï¼Œbooleanæ•°ç»„æ˜¯1ä¸ªå­—èŠ‚ï¼›booleanå€¼åœ¨ç¼–è¯‘åä½¿ç”¨Javaè™šæ‹Ÿæœºä¸­çš„intæ•°æ®ç±»å‹æ¥ä»£æ›¿æ—¶booleanå€¼æ˜¯4ä¸ªå­—èŠ‚ï¼Œæ ¹æ®JVMæ˜¯å¦æŒ‰ç…§è§„èŒƒæ¥åˆ¤æ–­ï¼‰ï¼Œbyte-1å­—èŠ‚ï¼Œshort-2å­—èŠ‚ï¼Œint-4å­—èŠ‚ï¼Œlong-8å­—èŠ‚ï¼Œfloat-4å­—èŠ‚ï¼Œdouble-8å­—èŠ‚ã€‚Goä¸­çš„æ•°æ®ç±»å‹å å‡ ä¸ªå­—èŠ‚ç‰¹åˆ«å¥½ç®—å§ï¼Œç›´æ¥é™¤ä»¥8bitï¼Œæ¯”å¦‚uint16å³16/8=2å­—èŠ‚ã€‚ å˜é‡ã€æ–¹æ³•çš„è®¿é—®æ§åˆ¶ Javaä¼šæœ‰è®¿é—®æ§åˆ¶ç¬¦å’Œéè®¿é—®æ§åˆ¶ç¬¦ï¼Œè®¿é—®æ§åˆ¶ç¬¦å¯ä»¥ä½¿ç±»ã€å˜é‡ã€æ–¹æ³•å’Œæ„é€ æ–¹æ³•å…·æœ‰ä¸åŒçš„è®¿é—®æƒé™ï¼Œpublic &gt; protected &gt; default &gt; privateï¼ˆå½“å‰ç±»ã€åŒåŒ…å­ç±»ã€ä¸åŒåŒ…å­ç±»ã€ä¸åŒåŒ…å…¶ä»–ç±»çš„è®¿é—®ï¼‰ã€‚è€Œéè®¿é—®æ§åˆ¶ç¬¦æœ‰staticä¿®é¥°ç¬¦ï¼ˆå¯ä¿®é¥°ç±»ã€å˜é‡ã€æ–¹æ³•ï¼Œç”¨æ¥å£°æ˜ç‹¬ç«‹äºå¯¹è±¡çš„é™æ€å˜é‡ï¼‰ï¼Œfinalä¿®é¥°ç¬¦ï¼ˆç±»â€”â€”ä¸èƒ½è¢«ç»§æ‰¿ã€æ–¹æ³•â€”â€”ä¸èƒ½è¢«ç»§æ‰¿ç±»é‡å®šä¹‰ã€å˜é‡â€”â€”ä¸å¯ä¿®æ”¹ï¼‰ï¼Œabstractä¿®é¥°ç¬¦ï¼ˆåˆ›å»ºæŠ½è±¡ç±»å’ŒæŠ½è±¡æ–¹æ³•ï¼Œä¸èƒ½ä¸finalä¸€èµ·ç”¨ï¼‰ï¼Œsynchronizedä¿®é¥°ç¬¦ï¼ˆä¿è¯è¢«ä¿®é¥°çš„æ–¹æ³•çº¿ç¨‹å®‰å…¨ï¼‰ï¼Œtransientä¿®é¥°ç¬¦ï¼ˆå®ç°Serializeæ¥å£çš„ç±»ä¸­è¢«ä¿®é¥°çš„å˜é‡JVMä¸è¿›è¡Œåºåˆ—åŒ–ï¼Œä½†é™æ€å˜é‡ä¸ç®¡æœ‰æ²¡æœ‰ä¿®é¥°ç¬¦éƒ½ä¸èƒ½è¢«åºåˆ—åŒ–ï¼Œä¸”å®ç°Externalizableæ¥å£çš„ç±»ä¸transientæ— å…³ï¼‰ï¼Œvolatileä¿®é¥°ç¬¦ï¼ˆè¢«ä¿®é¥°çš„å˜é‡çº¿ç¨‹å…±äº«ï¼Œä¿è¯çº¿ç¨‹å¯è§æ€§å’Œç¦æ­¢æŒ‡ä»¤é‡æ’åºï¼‰ Goä¸­ä¸åŒåŒ…ä¸‹çš„ä¸åŒå˜é‡å’Œæ–¹æ³•åªéœ€è¦é€šè¿‡å¤§å°å†™å°±å¯ä»¥è¿›è¡Œè®¿é—®æ§åˆ¶ï¼Œå¤§å†™å­—æ¯å¼€å¤´çš„å˜é‡å’Œæ–¹æ³•æ˜¯å…¬å¼€çš„ï¼Œè€Œå°å†™çš„æ˜¯ç§æœ‰çš„ã€‚ ä»£ç å—æ‰§è¡Œé¡ºåº Javaä»£ç å—çš„æ‰§è¡Œé¡ºåºæ˜¯ï¼šçˆ¶ç±»é™æ€ä»£ç å—(1æ¬¡)â€”â€”&gt;å­ç±»é™æ€ä»£ç å—(1æ¬¡)â€”â€”&gt;çˆ¶ç±»éé™æ€ä»£ç å— â€”â€”&gt; çˆ¶ç±»æ„é€ å‡½æ•° â€”â€”&gt; å­ç±»éé™æ€ä»£ç å— â€”â€”&gt; å­ç±»æ„é€ å‡½æ•° Goä»£ç å—çš„æ‰§è¡Œé¡ºåºæ˜¯ï¼šå…¶ä»–åŒ…goæ–‡ä»¶å®šä¹‰å˜é‡åˆå§‹åŒ– â€”â€”&gt; å…¶ä»–åŒ…goæ–‡ä»¶å®šä¹‰çš„init()å‡½æ•°æ‰§è¡Œ â€”â€”&gt; æœ¬åŒ…goæ–‡ä»¶å®šä¹‰å˜é‡åˆå§‹åŒ– â€”â€”&gt; æœ¬åŒ…goæ–‡ä»¶å®šä¹‰çš„init()å‡½æ•°æ‰§è¡Œ â€”â€”&gt; æœ¬åŒ…goæ–‡ä»¶å®šä¹‰çš„main()å‡½æ•°æ‰§è¡Œ å¾ªç¯ç»“æ„ Javaå¾ªç¯ç»“æ„æœ‰whileå¾ªç¯ï¼Œdo...whileå¾ªç¯ï¼Œforå¾ªç¯ï¼Œç”¨åˆ°çš„æ§åˆ¶è¯­å¥æœ‰breakã€continueã€‚ Goè¯­è¨€ä¸­å¾ªç¯ç»“æ„ä¸»è¦å°±æ˜¯forå¾ªç¯ä»¥åŠå¾ªç¯åµŒå¥—ï¼Œé‡Œé¢ä¼šç”¨åˆ°çš„æ§åˆ¶è¯­å¥æœ‰breakã€continueã€gotoï¼Œå¤šäº†ä¸€æ¡gotoè¯­å¥ï¼Œå®ƒå¯ä»¥æ— æ¡ä»¶åœ°è½¬ç§»åˆ°è¿‡ç¨‹ä¸­æŒ‡å®šçš„è¡Œï¼Œä½†æ˜¯åœ¨ç»“æ„åŒ–ç¨‹åºè®¾è®¡ä¸­ä¸€èˆ¬ä¸ä¸»å¼ ä½¿ç”¨ goto è¯­å¥ï¼Œ ä»¥å…é€ æˆç¨‹åºæµç¨‹çš„æ··ä¹±ï¼Œä½¿ç†è§£å’Œè°ƒè¯•ç¨‹åºéƒ½äº§ç”Ÿå›°éš¾ã€‚ Goè¯­è¨€ä¸­çš„forå¾ªç¯é™¤äº†for (init;condition;increment){conditional code}å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨for (key,value := range oldMap){newMap[key] = value}å¯¹sliceã€mapã€æ•°ç»„ã€å­—ç¬¦ä¸²ç­‰è¿›è¡Œéå†ã€‚Goè¯­è¨€é‡Œ()å¯ä»¥çœç•¥ï¼Œæœ‰å…´è¶£çš„åŒå­¦è¿˜å¯ä»¥æ‹¿Goçš„for rangeéå†å’ŒJavaçš„Iteratorè¿­ä»£å™¨è¿›è¡Œæ¯”è¾ƒã€‚ æ¡ä»¶è¯­å¥ Javaçš„æ¡ä»¶è¯­å¥ä¸»è¦æœ‰ifè¯­å¥ï¼Œif...elseè¯­å¥ä»¥åŠifåµŒå¥—è¯­å¥ã€‚ Goçš„æ¡ä»¶è¯­å¥æœ‰ifè¯­å¥ï¼Œif...elseè¯­å¥ï¼ŒifåµŒå¥—è¯­å¥ï¼Œswitchè¯­å¥ï¼ˆswitch å˜é‡+caseåˆ†æ”¯+defaultåˆ†æ”¯ï¼Œé»˜è®¤åŒ¹é…åä¸ä¼šæ‰§è¡Œå…¶ä»–caseï¼Œä½¿ç”¨ fallthrough ä¼šå¼ºåˆ¶æ‰§è¡Œåé¢çš„ case è¯­å¥ï¼Œfallthrough ä¸ä¼šåˆ¤æ–­ä¸‹ä¸€æ¡ case çš„è¡¨è¾¾å¼ç»“æœæ˜¯å¦ä¸º trueï¼‰ï¼Œselectè¯­å¥ï¼ˆGoçš„ä¸€ä¸ªæ§åˆ¶ç»“æ„ï¼Œç±»ä¼¼switchï¼Œä½†å®ƒä¼šéšæœºæ‰§è¡Œä¸€ä¸ªå¯è¿è¡Œçš„ caseã€‚å¦‚æœæ²¡æœ‰ case å¯è¿è¡Œï¼Œå®ƒå°†é˜»å¡ï¼Œç›´åˆ°æœ‰ case å¯è¿è¡Œã€‚ä¸€ä¸ªé»˜è®¤çš„å­å¥åº”è¯¥æ€»æ˜¯å¯è¿è¡Œçš„ã€‚ï¼‰ å‡½æ•° Javaè™½ç„¶æ²¡æœ‰å‡½æ•°çš„æ¦‚å¿µï¼Œä½†æ˜¯é€šå¸¸å¯ä»¥ç”¨ç±»ä¸­çš„æ–¹æ³•å»è¿›è¡Œå®ç°å„ä¸ªåŠŸèƒ½æ¨¡å—ã€‚ Goè¯­è¨€ä¸­è‡³å°‘æœ‰ä¸€ä¸ªmain()å‡½æ•°ï¼Œä¹Ÿå¯ä»¥åŠ ä¸€ä¸ªinit()åˆå§‹åŒ–å‡½æ•°ã€‚ Goè¯­è¨€ä¸­å‡½æ•°å‚æ•°å¯ä»¥ç”¨æ˜¯å€¼ä¼ é€’ä¹Ÿå¯ä»¥æ˜¯å¼•ç”¨ä¼ é€’ï¼Œå€¼ä¼ é€’åœ¨å‡½æ•°å†…å¯¹å‚æ•°è¿›è¡Œä¿®æ”¹ä¸ä¼šå½±å“åˆ°å®é™…å‚æ•°ï¼Œå¼•ç”¨ä¼ é€’åœ¨å‡½æ•°å†…å¯¹å‚æ•°è¿›è¡Œä¿®æ”¹ä¼šå½±å“åˆ°å®é™…å‚æ•°ã€‚è¿™ä¸ªå’ŒJavaæ–¹æ³•å‚æ•°çš„å€¼ä¼ é€’ï¼ˆåŸºæœ¬æ•°æ®ç±»å‹ï¼‰å’Œå¼•ç”¨ä¼ é€’ï¼ˆå¼•ç”¨æ•°æ®ç±»å‹ï¼‰ä¸€æ ·ã€‚ Goè¯­è¨€å‡½æ•°ä¸€ä¸ªå‡½æ•°å¯ä»¥ä½œä¸ºå¦ä¸€ä¸ªå‡½æ•°çš„å®å‚ï¼Œå¦‚ä¸‹å›¾å·¦è¾¹æ˜¯å·¥å…·åŒ…é‡Œçš„goæ–‡ä»¶ï¼Œå£°æ˜äº†ä¸€ä¸ªå‡½æ•°ç±»å‹func(int) intï¼Œç¬¦åˆè¯¥å‡½æ•°ç±»å‹çš„æ‰€æœ‰å‡½æ•°éƒ½å¯ä»¥ä½œä¸ºTestCallBackçš„å‚æ•°ï¼Œå³è¾¹æ˜¯å‡½æ•°è°ƒç”¨ã€‚ package util import &quot;fmt&quot; //å£°æ˜ä¸€ä¸ªå‡½æ•°ç±»å‹ type callBackType func(int) int func CallBack(x int) int{ fmt.Printf(&quot;æˆ‘æ˜¯å›è°ƒå‡½æ•°ï¼Œxï¼š%d\\n&quot;,x) return x } func TestCallBack(x int, function callBackType){ function(x) } package main import( &quot;fmt&quot; &quot;godemo/src/gocode/callbackDemo/util&quot; ) func main(){ //CallBackå‡½æ•°ä½œä¸ºå®å‚ä¼ å…¥åˆ°TestCallBackå‡½æ•° util.TestCallBack(1, util.CallBack) //åŒ¿åå‡½æ•°ä½œä¸ºå®å‚ä¼ å…¥åˆ°TestCallBackå‡½æ•°ä¸­ï¼Œç±»ä¼¼äºJavaçš„åŒ¿åå†…éƒ¨ç±» util.TestCallBack(2, func(x int) int { fmt.Printf(&quot;æˆ‘æ˜¯å›è°ƒï¼Œxï¼š%d\\n&quot;, x) return x }) } Javaä¸­è™½ç„¶ä¸€ä¸ªæ–¹æ³•ä¸èƒ½ä½œä¸ºå¦ä¸€ä¸ªæ–¹æ³•çš„å®å‚ï¼Œä½†æ˜¯Java 8å¼•å…¥çš„æ–°ç‰¹æ€§å‡½æ•°å¼æ¥å£å¯ä»¥å°†ä¸åŒçš„æ¡ä»¶çš„æ–¹æ³•ä½œä¸ºå‚æ•°ã€‚Predicateæ¥å£é€šè¿‡@FunctionalInterfaceå®ç°å‡½æ•°å¼æ¥å£ï¼Œå®ƒå¯ä»¥å®šä¹‰ä¸€ç»„æ¡ä»¶å¹¶ç¡®å®šæŒ‡å®šå¯¹è±¡æ˜¯å¦ç¬¦åˆè¿™äº›æ¡ä»¶ã€‚ä¸‹é¢çš„evalæ–¹æ³•ä¸­çš„ç¬¬äºŒå‚æ•°å¯ä»¥ä¼ å…¥ä¸åŒçš„æ¡ä»¶ã€‚ public static void main(String args[]){ List&lt;Integer&gt; list = Arrays.asList(1, 2, 3, 4, 5, 6, 7, 8, 9); /** * Predicate&lt;Integer&gt; predicate = n -&gt; true * n æ˜¯ä¸€ä¸ªå‚æ•°ä¼ é€’åˆ° Predicate æ¥å£çš„ test æ–¹æ³• * n å¦‚æœå­˜åœ¨åˆ™ test æ–¹æ³•è¿”å› true */ System.out.print(&quot;è¾“å‡ºæ‰€æœ‰æ•°:&quot;); eval(list, n-&gt;true); /** * Predicate&lt;Integer&gt; predicate1 = n -&gt; n%2 == 0 * n æ˜¯ä¸€ä¸ªå‚æ•°ä¼ é€’åˆ° Predicate æ¥å£çš„ test æ–¹æ³• * å¦‚æœ n%2 ä¸º 0 test æ–¹æ³•è¿”å› true */ System.out.print(&quot;è¾“å‡ºæ‰€æœ‰å¶æ•°:&quot;); eval(list, n-&gt; n%2 == 0 ); // Predicate&lt;Integer&gt; predicate2 = n -&gt; n &gt; 3 // n æ˜¯ä¸€ä¸ªå‚æ•°ä¼ é€’åˆ° Predicate æ¥å£çš„ test æ–¹æ³• // å¦‚æœ n å¤§äº 3 test æ–¹æ³•è¿”å› true System.out.print(&quot;è¾“å‡ºå¤§äº 3 çš„æ‰€æœ‰æ•°å­—:&quot;); eval(list, n-&gt; n &gt; 3 ); } public static void eval(List&lt;Integer&gt; list, Predicate&lt;Integer&gt; predicate) { for(Integer n: list) { if(predicate.test(n)) { System.out.println(n + &quot; &quot;); } } System.out.println(); } } æ•°ç»„ Javaå’ŒGoçš„æ•°ç»„åŸºæœ¬ä¸Šæ˜¯æ²¡æœ‰åŒºåˆ«çš„ï¼Œå£°æ˜å’Œåˆå§‹åŒ–æ•°ç»„çš„æ–¹å¼åŸºæœ¬ç±»ä¼¼ï¼Œä¹Ÿéƒ½æ˜¯é€šè¿‡ç´¢å¼•è®¿é—®æ•°ç»„çš„å…ƒç´ ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚ æŒ‡é’ˆ Javaä¸­æ˜¯æ²¡æœ‰æŒ‡é’ˆæ¦‚å¿µçš„ï¼ŒJavaè¯­è¨€æƒ³è®©ç¨‹åºå‘˜æ›´å…³æ³¨äºä¸šåŠ¡ï¼Œä¸€ä¸ªå¯¹è±¡ä¸å®ä¾‹åŒ–å®ƒå°±æ˜¯nullä¸ä¼šå ç”¨å†…å­˜ç©ºé—´ï¼Œä¹Ÿå°±ä¸ä¼šæœ‰å†…å­˜åœ°å€ã€‚å®ä¾‹åŒ–çš„å¯¹è±¡å®ƒä»¬çš„åœ°å€ä¹Ÿæœ‰å¯èƒ½å‘ç”Ÿå˜åŒ–ï¼Œæ¯”å¦‚GCå¤åˆ¶ç®—æ³•åœ¨è¿›è¡Œå¯¹è±¡çš„åƒåœ¾å›æ”¶æ—¶ï¼Œæœ‰äº›è¿˜åœ¨ä½¿ç”¨çš„å¯¹è±¡çš„åœ°å€å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚Javaä¸­çš„unsafeç±»å¯ä»¥è·å–ç›¸å¯¹åˆå§‹åœ°å€çš„åç§»é‡æ¥æŸ¥çœ‹å½“å‰å¯¹è±¡ç›®å‰çš„åœ°å€ï¼Œä¸€èˆ¬ä¸éœ€è¦å…³æ³¨ã€‚ Goè¯­è¨€ä¸­å’ŒC/C++ä¸€æ ·ä¹Ÿç”¨åˆ°äº†æŒ‡é’ˆï¼Œä½¿ç”¨æŒ‡é’ˆå¯ä»¥æ›´ç®€å•çš„æ‰§è¡Œä»»åŠ¡ï¼ŒæŒ‡é’ˆä¹Ÿå¸¦æ¥äº†æ›´é«˜çš„æ•ˆç‡ã€‚æŒ‡é’ˆè¢«å®šä¹‰åæ²¡æœ‰åˆ†é…åˆ°ä»»ä½•å˜é‡æ—¶å®ƒå°±æ˜¯nilæŒ‡é’ˆã€‚ Javaä¸­å¯¹æŸä¸ªå¯¹è±¡/æ•°ç»„è¿›è¡Œä¿®æ”¹æ—¶ï¼Œéœ€è¦é€šè¿‡æ–¹æ³•çš„è¿”å›å€¼çš„å¯¹è±¡/æ•°ç»„æ¥æ¥æ”¶æ–°çš„å¯¹è±¡/æ•°ç»„ï¼Œè€ŒGoè¯­è¨€æœ‰æŒ‡é’ˆåå¯ä»¥å‘å‡½æ•°ä¼ å…¥æŒ‡é’ˆï¼Œç›´æ¥é€šè¿‡æŒ‡é’ˆä¿®æ”¹å¯¹åº”çš„å€¼ã€‚ ç»“æ„ä½“ Goä¸­ç»“æ„ä½“ç”¨æ¥å®šä¹‰ä¸åŒçš„æ•°æ®ç±»å‹ï¼Œè¯­æ³•type struct_name struct{member definition ... member definition ... } åˆ‡ç‰‡ Goè¯­è¨€åˆ‡ç‰‡æ˜¯å¯¹æ•°ç»„çš„æŠ½è±¡ã€‚æ•°ç»„é•¿åº¦ä¸å¯å˜ï¼Œä½†åˆ‡ç‰‡é•¿åº¦å’Œå®¹é‡æ˜¯å¯å˜çš„ã€‚ åˆ‡ç‰‡åŒ…å«ä¸‰ä¸ªå±æ€§ï¼šæŒ‡é’ˆï¼ˆPointerï¼‰ã€é•¿åº¦ï¼ˆLengthï¼‰ã€å®¹é‡ï¼ˆCapacityï¼‰ï¼Œå¯ä»¥ä½¿ç”¨å†…å»ºå‡½æ•°make([]type, length, capacity)åˆ›å»ºç‰¹å®šç±»å‹çš„åˆ‡ç‰‡ï¼Œä¹Ÿå¯ä»¥ä»å…¶ä»–åˆ‡ç‰‡ä¸­è¿›è¡Œæˆªå–ã€‚ è¿™é‡Œéœ€è¦åŒºåˆ†ä¸€ä¸‹æ•°ç»„å’Œåˆ‡ç‰‡ï¼Œæ•°ç»„æ˜¯é•¿åº¦ä¸å¯å˜çš„ï¼Œè€Œåˆ‡ç‰‡æ˜¯é•¿åº¦å¯å˜çš„ã€‚æ•°ç»„çš„ç±»å‹æ˜¯[length] typeï¼Œåˆ‡ç‰‡çš„ç±»å‹æ˜¯[] typeã€‚ åˆ›å»ºä¸€ä¸ªåˆ‡ç‰‡äº‹å®ä¸Šæ˜¯æŒ‡å‘ä¸€ä¸ªåº•å±‚æ•°ç»„ï¼Œå¦‚æœå¯¹åˆ‡ç‰‡è¿›è¡Œæˆªå–åï¼Œä¿®æ”¹æˆªå–åçš„åˆ‡ç‰‡çš„å…ƒç´ å€¼å®é™…ä¸Šæ”¹å˜çš„æ˜¯åº•å±‚æ•°ç»„çš„å…ƒç´ å€¼ï¼Œæˆªå–å‰çš„åˆ‡ç‰‡å…ƒç´ å€¼ä¹Ÿä¼šå‘ç”Ÿæ”¹å˜ã€‚ åˆ‡ç‰‡å¯ä»¥é€šè¿‡å†…å»ºå‡½æ•°copy()å’Œappend()è¿›è¡Œåˆ‡ç‰‡æ‹·è´ä»¥åŠåˆ‡ç‰‡å…ƒç´ è¿½åŠ ã€‚ åˆ‡ç‰‡å…ƒç´ è¿½åŠ æ—¶éœ€è¦æ³¨æ„ï¼Œå¦‚æœåŸåˆ‡ç‰‡çš„å®¹é‡å¤§äºé•¿åº¦ï¼Œåˆ™ç›´æ¥åœ¨åŸåˆ‡ç‰‡çš„åŸºç¡€ä¸Šè¿½åŠ ï¼Œåˆ‡ç‰‡å®¹é‡ä¸å˜ä¸”é•¿åº¦+1ï¼›å¦‚æœåŸåˆ‡ç‰‡çš„å®¹é‡ç­‰äºé•¿åº¦ï¼Œåˆ™ä¼šå¯¹åŸåˆ‡ç‰‡è¿›è¡Œ2å€æ‰©å®¹ä¸”é•¿åº¦+1ï¼Œè¿™æ—¶å°†ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„åº•å±‚æ•°ç»„ï¼Œå³åŸåˆ‡ç‰‡å’Œæ‰©å®¹åçš„åˆ‡ç‰‡ä¸å†æ˜¯å…±ç”¨ä¸€ä¸ªåº•å±‚æ•°ç»„ï¼Œä¿®æ”¹æ‰©å®¹åçš„åˆ‡ç‰‡çš„å…ƒç´ å€¼å°†ä¸ä¼šå½±å“åŸåˆ‡ç‰‡çš„å…ƒç´ å€¼ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼Œ old_slice := []int{11,22,33,44,55,66,77,88} test_slice := old_slice[1:3:3] //ä»1å¼€å§‹åˆ‡ï¼Œé•¿åº¦3-1ï¼Œå®¹é‡3-1ï¼Œå³{22,33} fmt.Printf(&quot;è¿½åŠ å‰çš„slice=%v,é•¿åº¦=%v,å®¹é‡=%v\\n&quot;,test_slice,len(test_slice),cap(test_slice)) app_slice := append(test_slice, 100) fmt.Printf(&quot;è¿½åŠ åçš„slice=%v,é•¿åº¦=%v,å®¹é‡=%v\\n&quot;,app_slice,len(app_slice),cap(app_slice)) app_slice[0] = 300 fmt.Printf(&quot;ä¿®æ”¹æ‰©å®¹åçš„åˆ‡ç‰‡çš„ç¬¬ä¸€ä¸ªå…ƒç´ åï¼Œè¿½åŠ å‰slice=%v, è¿½åŠ åslice=%v\\n&quot;,test_slice, app_slice) è¿˜éœ€æ³¨æ„çš„æ˜¯åº•å±‚æ•°ç»„æ‰©å®¹æ—¶ï¼Œé•¿åº¦ä¸è¶…è¿‡1024åˆ™æŒ‰ç…§å½“å‰åº•å±‚æ•°ç»„çš„é•¿åº¦çš„2å€è¿›è¡Œæ‰©å®¹ï¼Œå¹¶ç”Ÿæˆæ–°æ•°ç»„ï¼›é•¿åº¦è¶…è¿‡1024æ—¶ï¼ŒæŒ‰ç…§25%çš„æ¯”ç‡æ‰©å®¹ï¼Œä¹Ÿå°±æ˜¯1024ä¸ªå…ƒç´ å­˜åœ¨æ—¶ï¼Œå®¹é‡æ‰©å±•ä¸º1280ï¼ˆæœ¬æœºçš„goç‰ˆæœ¬æ˜¯1.15.7ï¼‰ Mapé›†åˆ -å®ƒæ˜¯ä¸€ç§æ— åºçš„é”®å€¼å¯¹é›†åˆã€‚ä½†æ˜¯å…¶åº•å±‚å®ç°æ˜¯ä¸€ä¸ªæ•£åˆ—è¡¨ï¼Œæ•£åˆ—è¡¨ä¸­æœ‰ä¸¤ä¸ªç»“æ„ä½“hmapï¼ˆa header for a go mapï¼‰+ bmapï¼ˆa bucket for a go mapï¼Œé€šå¸¸ä¹Ÿå«bucketï¼‰ã€‚ Goä¸­å®ƒæ˜¯æ•°ç»„+é“¾è¡¨ï¼Œä½¿ç”¨é“¾è¡¨çš„åŸå› å’ŒJavaä¸€æ ·æ˜¯ä¸ºäº†é¿å…å“ˆå¸Œå†²çªã€‚ è€ŒJavaåœ¨Jdk1.8åæ˜¯æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘ï¼Œåœ¨æ¡¶å…ƒç´ ä¸ªæ•°å¤§äº64æˆ–å°äº6æ—¶ä¼šä»é“¾è¡¨å’Œçº¢é»‘æ ‘ç»“æ„ç›¸äº’è½¬æ¢ï¼Œå¼•å…¥çº¢é»‘æ ‘ä¸»è¦æ˜¯ä¸ºäº†æé«˜æŸ¥è¯¢æ•ˆç‡ã€‚ Go mapè¿›è¡Œæ‰©å®¹æ—¶ä¹Ÿæ˜¯æ ¹æ®åŠ è½½å› å­ï¼ˆloadFactorï¼‰è¿›è¡Œåˆ¤æ–­çš„ï¼ŒGoè¯­è¨€ä¸­çš„åŠ è½½å› å­=mapé•¿åº¦/2^B(Bä»£è¡¨bmapæ•°ç»„çš„é•¿åº¦ï¼ŒBæ˜¯é€šè¿‡keyè¿›è¡Œhashè¿ç®—çš„ä½ä½çš„ä½æ•°)ï¼Œè€ŒJavaè¯­è¨€ä¸­çš„åŠ è½½å› å­é»˜è®¤æ˜¯0.75fã€‚ é€’å½’å‡½æ•° é€’å½’ï¼Œå°±æ˜¯åœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­è°ƒç”¨è‡ªå·±ã€‚ ä¸ç®¡æ˜¯Goã€Javaã€è¿˜æ˜¯å…¶ä»–è¯­è¨€éƒ½å¯ä»¥å®ç°é€’å½’è°ƒç”¨ï¼Œæœ€å¸¸è§çš„é€’å½’æ¡ˆä¾‹å°±æ˜¯å®ç°æ–æ³¢é‚£å¥‘æ•°åˆ—ã€‚ æ¥å£ Goçš„æ¥å£æ˜¯å¯¹å…¶ä»–ç±»å‹è¡Œä¸ºçš„æŠ½è±¡å’Œæ¦‚æ‹¬ï¼›å®ƒé€šè¿‡type interface_name interfaceå®šä¹‰ã€‚è€ŒJavaä¸­æ¥å£è¦ä¼˜å…ˆäºå®ç°ç±»ï¼Œé€šè¿‡implements å…³é”®å­—ç»‘å®šæ¥å£å’Œå®ç°ç±»çš„å…³ç³»ã€‚ Goæ˜¯é€šè¿‡func(struct_name_variable struct_name) method_name()[return_type]{ //æ–¹æ³•å®ç°}æ¥é‡å†™æ–¹æ³•çš„ã€‚Javaæ˜¯é€šè¿‡æ¥å£å®ç°ç±»å»å®ç°æ¥å£å¹¶é‡å†™ï¼ˆOverrideï¼‰æ–¹æ³•çš„ã€‚ å¼‚å¸¸å¤„ç† æˆ‘ä»¬çŸ¥é“Javaå¼‚å¸¸åˆ†ä¸ºErrorï¼ˆç¨‹åºæ— æ³•å¤„ç†çš„ä¸¥é‡é”™è¯¯ï¼Œç¼–è¯‘å™¨ä¸åšæ£€æŸ¥ï¼Œé€šå¸¸JVMä¼šç»ˆæ­¢çº¿ç¨‹çš„åŠ¨ä½œï¼‰å’ŒExceptionï¼ˆè¿è¡Œæ—¶å¼‚å¸¸å’Œç¼–è¯‘æœŸå¼‚å¸¸ä»¥åŠè‡ªå®šä¹‰å¼‚å¸¸ï¼‰ï¼Œè€ŒExceptionå¼‚å¸¸é€šå¸¸å¯ä»¥é€šè¿‡try{}catch(Exception){}è¯­å¥è¿›è¡Œæ•è·å¤„ç†ã€‚ Goè¯­è¨€ä¸­è¿›è¡Œå¼‚å¸¸å¤„ç†æ—¶ï¼Œå¯ä»¥é€šè¿‡defer+recover()+panic()æ¥å¤„ç†å¼‚å¸¸ã€‚deferæ˜¯å»¶è¿Ÿè¯­å¥ï¼Œå½“ä¸»å‡½æ•°é€€å‡ºåæ‰è¿›è¡Œè°ƒç”¨ï¼Œéµå¾ªFIFOåŸåˆ™ï¼›recover()å’Œpanic()éƒ½æ˜¯builtinåŒ…ä¸‹çš„å†…å»ºå‡½æ•°ã€‚åœ¨deferçš„å‡½æ•°ä¸­ï¼Œæ‰§è¡Œrecover()å‡½æ•°è°ƒç”¨ä¼šå–å›ä¼ è‡³panicè°ƒç”¨çš„é”™è¯¯å€¼ï¼Œæ¢å¤æ­£å¸¸æ‰§è¡Œï¼Œåœæ­¢ææ…Œè¿‡ç¨‹ï¼ˆå¯ä»¥ç†è§£ä¸ºJavaä¸­çš„ä¸­æ–­ï¼‰ï¼Œè‹¥recoveråœ¨deferçš„å‡½æ•°ä¹‹å¤–è¢«è°ƒç”¨ï¼Œå®ƒå°†ä¸ä¼šåœæ­¢ææ…Œè¿‡ç¨‹åºåˆ—ï¼›panic()å‡½æ•°è°ƒç”¨åä¼šç»ˆæ­¢ç¨‹åºï¼Œé”™è¯¯æƒ…å†µä¼šè¢«æŠ¥å‘Šï¼ŒåŒ…æ‹¬å¼•å‘è¯¥ææ…Œçš„å®å‚å€¼ã€‚ ä¸‹é¢ç»™å‡ºä¸€ä¸ªGoè¯­è¨€ä½¿ç”¨defer+recover()æ•è·å’Œå¤„ç†è¿è¡Œæ—¶å¼‚å¸¸çš„æ —å­ï¼ˆå‡ºç°å¼‚å¸¸åï¼Œä¸»å‡½æ•°åé¢çš„è¯­å¥å°†æ­£å¸¸æ‰§è¡Œï¼‰ï¼š import( &quot;fmt&quot; &quot;errors&quot; ) func test(){ //ä½¿ç”¨defer+recoveræ•è·å’Œå¤„ç†å¼‚å¸¸ defer catchError() num1 := 10 num2 := 0 res := num1/num2 fmt.Println(&quot;res = &quot;,res) } //æ•è·å¼‚å¸¸ func catchError(){ err := recover() //recover()ä¹Ÿæ˜¯å†…å»ºå‡½æ•° if err!=nil{ //err!=nilè¯´æ˜æ•è·åˆ°å¼‚å¸¸ fmt.Println(&quot;å¼‚å¸¸ä¿¡æ¯=&quot;,err) } } func main(){ test() fmt.Println(&quot;main()ä¸‹é¢çš„ä»£ç ......&quot;) } ä¸‹é¢ç»™å‡ºä¸€ä¸ªè‡ªå®šä¹‰å¼‚å¸¸çš„å¤„ç†ï¼Œç›´æ¥ä½¿ç”¨panic()å†…å»ºå‡½æ•°ç»ˆæ­¢ç¨‹åºï¼Œä¼šè¾“å‡ºè‡ªå®šä¹‰é”™è¯¯ï¼Œä½†åé¢çš„ä»£ç å°†ä¸ä¼šå†æ‰§è¡Œï¼š import( &quot;fmt&quot; &quot;errors&quot; ) //æ”¯æŒè‡ªå®šä¹‰é”™è¯¯ï¼Œä½¿ç”¨errors.Newå’Œpanicå†…å»ºå‡½æ•° func readConf(name string)(err error){ if name == &quot;config.ini&quot;{ return nil //è¯»å–è¿”å›ç©º... } else{ return errors.New(&quot;è¯»å–æ–‡ä»¶é”™è¯¯...&quot;) } } func test(){ err := readConf(&quot;confi.ini&quot;) if err != nil{ panic(err) //å¦‚æœè¯»å–æ–‡ä»¶å‘ç”Ÿé”™è¯¯ï¼Œè¾“å‡ºé”™è¯¯å¹¶ç»ˆæ­¢ç¨‹åº } fmt.Println(&quot;test()ç»§ç»­æ‰§è¡Œ...&quot;) } func main(){ test() fmt.Println(&quot;main()ä¸‹é¢çš„ä»£ç ......&quot;) } å¹¶å‘ Javaä¸­æˆ‘ä»¬åªéœ€è¦äº†è§£è¿›ç¨‹å’Œçº¿ç¨‹ï¼Œè€ŒGoè¯­è¨€é‡Œæˆ‘ä»¬éœ€è¦çŸ¥é“è¿›ç¨‹ã€çº¿ç¨‹å’Œåç¨‹ã€‚è¿›ç¨‹æ˜¯ä»»åŠ¡è°ƒåº¦çš„æœ€å°å•ä½ï¼Œæ¯ä¸ªè¿›ç¨‹å„è‡ªéƒ½ç‹¬ç«‹ä¸€å—å†…å­˜ï¼›çº¿ç¨‹æ˜¯ç¨‹åºæ‰§è¡Œæµçš„æœ€å°å•ä½ï¼Œæ˜¯å¤„ç†å™¨è°ƒåº¦å’Œåˆ†æ´¾çš„æœ€å°å•ä½ï¼›åç¨‹æ˜¯ä¸€ç§ç”¨æˆ·æ€çš„è½»é‡çº§çº¿ç¨‹ï¼Œåç¨‹æ‹¥æœ‰è‡ªå·±çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆï¼› çº¿ç¨‹å’Œè¿›ç¨‹éƒ½æ˜¯åŒæ­¥æœºåˆ¶ï¼Œè€Œåç¨‹æ˜¯å¼‚æ­¥ï¼›åç¨‹èƒ½ä¿ç•™ä¸Šä¸€æ¬¡è°ƒç”¨æ—¶çš„çŠ¶æ€ï¼Œæ¯æ¬¡é‡å…¥ç›¸å½“è¿›å…¥ä¸Šä¸€æ¬¡çš„çŠ¶æ€ã€‚ goroutineæ˜¯åç¨‹çš„goè¯­è¨€å®ç°ï¼Œå®ƒæ˜¯è½»é‡çº§çº¿ç¨‹ï¼Œgoroutine çš„è°ƒåº¦æ˜¯ç”± Golang è¿è¡Œæ—¶è¿›è¡Œç®¡ç†çš„ã€‚ Javaè¯­è¨€é€šè¿‡Threadç±»å»åˆ›å»ºçº¿ç¨‹ï¼Œè€ŒGoè¯­è¨€é€šè¿‡ go è¯­å¥å¼€å¯ä¸€ä¸ªæ–°çš„è¿è¡ŒæœŸçº¿ç¨‹ï¼Œ å³ goroutineã€‚ Goè¯­è¨€å¯ç”¨é€šé“æ¥ä¼ é€’æ•°æ®ï¼Œchannelå°±æ˜¯ç”¨äºä¸¤ä¸ª goroutine ä¹‹é—´é€šè¿‡ä¼ é€’ä¸€ä¸ªæŒ‡å®šç±»å‹çš„å€¼æ¥åŒæ­¥è¿è¡Œå’Œé€šè®¯ã€‚é»˜è®¤çš„é€šé“æ˜¯ä¸å¸¦ç¼“å†²åŒºçš„ï¼Œå¦‚æœéœ€è¦è®¾ç½®ç¼“å†²åŒºå¯ä»¥é€šè¿‡make()å‡½æ•°å»è®¾ç½®ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯å‡ºç°åç¨‹æ­»é”çš„æƒ…å†µï¼ˆfatal error: all goroutines are asleep - deadlockï¼‰ï¼Œæ— ç¼“å†²ä¿¡é“ä¸ä¼šç”¨æ¥å­˜å‚¨æ•°æ®ï¼Œåªä¼šç”¨æ¥ç»™ä¸åŒåç¨‹ä¼ è¾“æ•°æ®ã€‚ä¸»å‡½æ•°ä¹Ÿæ˜¯ä¸€ä¸ªåç¨‹ï¼ˆmain goroutineï¼‰ã€‚ä¸‹é¢ç»™å‡ºä¸€ä¸ªç®€å•çš„demoã€‚ package utils import( &quot;fmt&quot; &quot;time&quot; ) func SaySomething(s string){ for i:=0;i&lt;5;i++{ time.Sleep(100 * time.Millisecond) fmt.Printf(&quot;è¿™æ˜¯æŸæŸç¬¬%væ¬¡è¯´%v\\n&quot;,i+1,s) } } func Sum(s []int, c chan int){ sum := 0 for _,v := range s{ sum += v } //æŠŠsumå‘é€åˆ°é€šé“c c &lt;- sum } func Fibonacci(n int, c chan int){ x, y := 0, 1 for i:=0;i&lt;n;i++{ //æŠŠxå‘é€åˆ°é€šé“cä¸­ c &lt;- x x, y = y, x+y } close(c) } package main import( &quot;fmt&quot; &quot;goDemo/src/gocode/goroutine/utils&quot; ) func main(){ str1 := &quot;hello&quot; str2 := &quot;world&quot; //è¾“å‡ºçš„ hello å’Œ world æ˜¯æ²¡æœ‰å›ºå®šå…ˆåé¡ºåºã€‚å› ä¸ºå®ƒä»¬æ˜¯ä¸¤ä¸ª goroutine åœ¨æ‰§è¡Œ go utils.SaySomething(str1) utils.SaySomething(str2) fmt.Println(&quot;then I can say&quot;) //é€šè¿‡ä¸¤ä¸ª goroutine æ¥è®¡ç®—æ•°å­—ä¹‹å’Œï¼Œåœ¨ goroutine å®Œæˆè®¡ç®—åï¼Œå®ƒä¼šè®¡ç®—ä¸¤ä¸ªç»“æœçš„å’Œï¼š s := []int{7, 2, 8, -9, 4, 0} c := make(chan int) fmt.Printf(&quot;ä¿¡é“åœ°å€=%v,ä¿¡é“å®¹é‡=%v\\n&quot;,c, cap(c)) go utils.Sum(s[:len(s)/2],c) go utils.Sum(s[len(s)/2:],c) //ä»é€šé“cæ¥æ”¶æ•°æ®å¹¶èµ‹å€¼ç»™xï¼Œy x, y := &lt;- c , &lt;- c fmt.Printf(&quot;ååŠéƒ¨åˆ†æ±‚å’Œ=%v,å‰åŠéƒ¨åˆ†æ±‚å’Œ=%v,æ€»å’Œ=%v\\n&quot;,x,y,x+y) // è¿™é‡Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå¯ä»¥å­˜å‚¨æ•´æ•°ç±»å‹çš„å¸¦ç¼“å†²é€šé“ï¼Œç¼“å†²åŒºå¤§å°ä¸º2 ch := make(chan int, 2) // å› ä¸º ch æ˜¯å¸¦ç¼“å†²çš„é€šé“ï¼Œæˆ‘ä»¬å¯ä»¥åŒæ—¶å‘é€ä¸¤ä¸ªæ•°æ® // è€Œä¸ç”¨ç«‹åˆ»éœ€è¦å»åŒæ­¥è¯»å–æ•°æ® ch &lt;- 1 ch &lt;- 2 // ch &lt;- 3 //å¦‚æœå†å‘é€ä¸€ä¸ªæ•°æ®åˆ™ä¼šå‡ºç°å¼‚å¸¸ fatal error: all goroutines are asleep - deadlock! // è·å–è¿™ä¸¤ä¸ªæ•°æ® fmt.Println(&lt;-ch) fmt.Println(&lt;-ch) // æ¥æ”¶äº†æ•°æ®ä¹‹åç¼“å­˜é‡Œæ‰èƒ½ç»§ç»­ç¼“å†²æ•°æ®ï¼Œå¦åˆ™å°±ä¼šå‡ºç°åç¨‹æ­»é” ch &lt;- 3 //goéå†é€šé“å’Œå…³é—­é€šé“ cc := make(chan int,10) go utils.Fibonacci(cap(cc), cc) for i := range cc{ fmt.Printf(&quot;%v\\t&quot;,i) } //æ— ç¼“å†²ä¿¡é“ä¸ä¼šç”¨æ¥å­˜å‚¨æ•°æ®ï¼Œåªè´Ÿè´£æ•°æ®çš„æµé€šï¼Œä¸¤ä¸ªgoroutineå¯ä»¥ç”¨æ— ç¼“å†²ä¿¡é“ä¼ è¾“æ•°æ® go func(){c &lt;- 1}() test := &lt;- c fmt.Println(test) // c &lt;- 1 //æ— ç¼“å†²ä¿¡é“å®¹é‡ä¸º0ï¼Œä¸èƒ½åœ¨main goroutineä¸­ä¼ æ•°æ®ï¼Œå¦åˆ™ä¼šå‡ºç°deadlock } ","link":"https://tianxiawuhao.github.io/4lr2-CaPP/"},{"title":"Centos7éƒ¨ç½²FastDFS","content":"ä¸€ã€FastDFSçš„ä»‹ç»ä¸åŸç† å®˜æ–¹Githubåœ°å€ï¼šhttps://github.com/happyfish100 FastDFS æ˜¯ä¸€ä¸ªå¼€æºçš„é«˜æ€§èƒ½åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼ˆDFSï¼‰ã€‚ å®ƒçš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼šæ–‡ä»¶å­˜å‚¨ï¼Œæ–‡ä»¶åŒæ­¥å’Œæ–‡ä»¶è®¿é—®ï¼Œä»¥åŠé«˜å®¹é‡å’Œè´Ÿè½½å¹³è¡¡ã€‚ ä¸»è¦è§£å†³äº†æµ·é‡æ•°æ®å­˜å‚¨é—®é¢˜ï¼Œç‰¹åˆ«é€‚åˆä»¥ä¸­å°æ–‡ä»¶ï¼ˆå»ºè®®èŒƒå›´ï¼š4KB &lt; file_size &lt;500MBï¼‰ä¸ºè½½ä½“çš„åœ¨çº¿æœåŠ¡ã€‚ FastDFS ç³»ç»Ÿæœ‰ä¸‰ä¸ªè§’è‰²ï¼šè·Ÿè¸ªæœåŠ¡å™¨(Tracker Server)ã€å­˜å‚¨æœåŠ¡å™¨(Storage Server)å’Œå®¢æˆ·ç«¯(Client)ã€‚ **Tracker Serverï¼š**è·Ÿè¸ªæœåŠ¡å™¨ï¼Œä¸»è¦åšè°ƒåº¦å·¥ä½œï¼Œèµ·åˆ°å‡è¡¡çš„ä½œç”¨ï¼›è´Ÿè´£ç®¡ç†æ‰€æœ‰çš„ storage serverå’Œ groupï¼Œæ¯ä¸ª storage åœ¨å¯åŠ¨åä¼šè¿æ¥ Trackerï¼Œå‘ŠçŸ¥è‡ªå·±æ‰€å± group ç­‰ä¿¡æ¯ï¼Œå¹¶ä¿æŒå‘¨æœŸæ€§å¿ƒè·³ã€‚ **Storage Serverï¼š**å­˜å‚¨æœåŠ¡å™¨ï¼Œä¸»è¦æä¾›å®¹é‡å’Œå¤‡ä»½æœåŠ¡ï¼›ä»¥ group ä¸ºå•ä½ï¼Œæ¯ä¸ª group å†…å¯ä»¥æœ‰å¤šå° storage serverï¼Œæ•°æ®äº’ä¸ºå¤‡ä»½ã€‚ **Clientï¼š**å®¢æˆ·ç«¯ï¼Œä¸Šä¼ ä¸‹è½½æ•°æ®çš„æœåŠ¡å™¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è‡ªå·±çš„é¡¹ç›®æ‰€éƒ¨ç½²åœ¨çš„æœåŠ¡å™¨ï¼Œåœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œåªéœ€è¦é…ç½®Trankerçš„åœ°å€å³å¯ã€‚ äºŒã€FastDFSçš„å®‰è£…å‰ç¯å¢ƒå‡†å¤‡ éœ€è¦ç”¨åˆ°çš„ç›¸å…³è½¯ä»¶ä¸ç®€å•ä»‹ç» centos 7.x libfatscommon FastDFSåˆ†ç¦»å‡ºçš„ä¸€äº›å…¬ç”¨å‡½æ•°åŒ… FastDFS FastDFSæœ¬ä½“ fastdfs-nginx-module FastDFSå’Œnginxçš„å…³è”æ¨¡å— nginx nginx1.20.2 1ã€æ£€æŸ¥å®‰è£…ç¼–è¯‘ç¯å¢ƒï¼š yum install git gcc gcc-c++ make automake autoconf libtool pcre pcre-devel zlib zlib-devel openssl-devel wget vim -y 2ã€ç»Ÿä¸€å‡†å¤‡å¥½æ–‡ä»¶å¤¹ä½ç½®ï¼š è¯´æ˜ ä½ç½® æ‰€æœ‰å®‰è£…åŒ… /usr/local/fastdfs æ•°æ®å­˜å‚¨ä½ç½® /data/fastdfs/ data/logséƒ½å­˜åœ¨äº†dfs [root@tcosmo-test-szls-baas01 /]# mkdir /usr/local/fastdfs [root@tcosmo-test-szls-baas01 /]# mkdir -p /data/fastdfs ## è¿›å…¥ [root@tcosmo-test-szls-baas01 fastdfs]# cd /usr/local/fastdfs/ ä¸‰ã€å®‰è£…FastDFSçš„å››å¤§è½¯ä»¶ ç”±äºgithubç»å¸¸æ— æ³•è®¿é—®ï¼Œæˆ‘ä»¬å¯ä»¥æå‰ä¸‹è½½å¥½ï¼Œæ‹·è´è¿›/usr/local/fastdfsç›®å½•ä¸‹ 1ã€ä¸‹è½½å¹¶å®‰è£…libfatscommonï¼š git clone https://github.com/happyfish100/libfastcommon.git --depth 1 cd libfastcommon/ ./make.sh &amp;&amp; ./make.sh install #ç¼–è¯‘å®‰è£… 2ã€å®‰è£…FastDFSæœ¬ä½“ï¼š git clone https://github.com/happyfish100/fastdfs.git --depth 1 cd fastdfs/ ./make.sh &amp;&amp; ./make.sh install #ç¼–è¯‘å®‰è£… # æŸ¥çœ‹é»˜è®¤æä¾›çš„é…ç½®æ–‡ä»¶ï¼š [root@tcosmo-test-szls-baas01 fdfs]# ll /etc/fdfs/ total 32 -rw-r--r-- 1 root root 1909 Feb 14 11:25 client.conf -rw-r--r-- 1 root root 10246 Feb 14 11:25 storage.conf -rw-r--r-- 1 root root 620 Feb 14 11:25 storage_ids.conf -rw-r--r-- 1 root root 9138 Feb 14 11:25 tracker.conf # æå‰å°†nginxçš„é…ç½®æ–‡ä»¶ä¹Ÿæ‹·è´åˆ°fdfsçš„é…ç½®æ–‡ä»¶æ–‡ä»¶å¤¹ä¸‹ï¼š cp /usr/local/fastdfs/fastdfs/conf/http.conf /etc/fdfs/ #ä¾›nginxè®¿é—®ä½¿ç”¨ cp /usr/local/fastdfs/fastdfs/conf/mime.types /etc/fdfs/ #ä¾›nginxè®¿é—®ä½¿ç”¨ å½“fastdfså®‰è£…å®Œæˆåï¼Œä¼šåœ¨ /usr/local/fastdfs/fastdfs/init.d ç›®å½•ä¸‹ç”Ÿæˆå¯¹åº”çš„è¿è¡Œè„šæœ¬ï¼š [root@i-zqovu8av init.d]# ll /usr/local/fastdfs/fastdfs/init.d total 8 -rwxrwxrwx 1 root root 961 Dec 31 02:52 fdfs_storaged -rwxrwxrwx 1 root root 963 Dec 31 02:52 fdfs_trackerd å¦‚æœæ²¡æœ‰è¿è¡Œæƒé™ï¼Œæˆ‘ä»¬å°±æ‰‹åŠ¨chmodï¼ 3ã€å®‰è£…fastdfs-nginx-moduleï¼š git clone https://github.com/happyfish100/fastdfs-nginx-module.git --depth 1 cp /usr/local/fastdfs/fastdfs-nginx-module/src/mod_fastdfs.conf /etc/fdfs 4ã€å®‰è£…Nginxå¹¶æ·»åŠ fastdfs-nginx-moduleï¼š ## ä¸‹è½½ wget ## è§£å‹ &amp; è¿›å…¥ï¼š tar -zxvf nginx-1.20.2.tar.gz cd nginx-1.20.2/ ## æ·»åŠ fastdfs-nginx-moduleæ¨¡å— ./configure --add-module=/usr/local/fastdfs/fastdfs-nginx-module/src/ ## ç¼–è¯‘å®‰è£… make &amp;&amp; make install å››ã€FastDFSçš„å•æœºéƒ¨ç½²é…ç½® 1ã€trackerçš„é…ç½®ï¼š #æœåŠ¡å™¨ipä¸º 139.198.191.246 vim /etc/fdfs/tracker.conf #éœ€è¦ä¿®æ”¹çš„å†…å®¹å¦‚ä¸‹ port=22122 # trackeræœåŠ¡å™¨ç«¯å£ï¼ˆé»˜è®¤22122,ä¸€èˆ¬ä¸ä¿®æ”¹ï¼‰ base_path=/data/fastdfs # å­˜å‚¨æ—¥å¿—å’Œæ•°æ®çš„æ ¹ç›®å½• 2ã€storageçš„é…ç½®ï¼š vim /etc/fdfs/storage.conf #éœ€è¦ä¿®æ”¹çš„å†…å®¹å¦‚ä¸‹ port=23000 # storageæœåŠ¡ç«¯å£ï¼ˆé»˜è®¤23000,ä¸€èˆ¬ä¸ä¿®æ”¹ï¼‰ base_path=/data/fastdfs # æ•°æ®å’Œæ—¥å¿—æ–‡ä»¶å­˜å‚¨æ ¹ç›®å½• store_path0=/data/fastdfs # ç¬¬ä¸€ä¸ªå­˜å‚¨ç›®å½• tracker_server=139.198.191.246:22122 # trackeræœåŠ¡å™¨IPå’Œç«¯å£ http.server_port=8888 # httpè®¿é—®æ–‡ä»¶çš„ç«¯å£(é»˜è®¤8888,çœ‹æƒ…å†µä¿®æ”¹,å’Œnginxä¸­ä¿æŒä¸€è‡´) 3ã€nginxçš„é…ç½®ï¼š vim /etc/fdfs/mod_fastdfs.conf #éœ€è¦ä¿®æ”¹çš„å†…å®¹å¦‚ä¸‹ tracker_server=139.198.191.246:22122 #trackeræœåŠ¡å™¨IPå’Œç«¯å£ url_have_group_name=true store_path0=/data/fastdfs #é…ç½®nginx.config vim /usr/local/nginx/conf/nginx.conf #æ·»åŠ å¦‚ä¸‹é…ç½® server { listen 8888; ## è¯¥ç«¯å£ä¸ºstorage.confä¸­çš„http.server_portç›¸åŒ server_name localhost; location ~/group[0-9]/ { ngx_fastdfs_module; } error_page 500 502 503 504 /50x.html; location = /50x.html { root html; } } 4ã€å¯åŠ¨æœåŠ¡ï¼š # å…³é—­é˜²ç«å¢™ systemctl stop firewalld.service # å¯åŠ¨tracker /usr/local/fastdfs/fastdfs/init.d/fdfs_trackerd start Starting FastDFS tracker server: # å¯åŠ¨storage /usr/local/fastdfs/fastdfs/init.d/fdfs_storaged start Starting FastDFS storage server: # é‡å¯nginx nginx -s reload äº”ã€ä½¿ç”¨è‡ªå¸¦çš„clientæµ‹è¯•æ–‡ä»¶çš„ä¸Šä¼ ä¸è®¿é—® 1ã€é…ç½®è‡ªå¸¦çš„clientçš„é…ç½®æ–‡ä»¶ï¼š vim /etc/fdfs/client.conf #éœ€è¦ä¿®æ”¹çš„å†…å®¹å¦‚ä¸‹ base_path=/data/fastdfs tracker_server=139.198.191.246:22122 #trackeræœåŠ¡å™¨IPå’Œç«¯å£ 2ã€æµ‹è¯•ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶ï¼Œæˆ‘ä»¬äº‹å…ˆåœ¨æŸä¸ªä½ç½®å‡†å¤‡ä¸€å¼ å›¾ç‰‡å³å¯ï¼š [root@i-zqovu8av fdfs]# fdfs_upload_file /etc/fdfs/client.conf /root/testfdfs.jpg group1/M00/00/00/i8a_9mIKAMKAPKgPAAA2E69InJY486.jpg #è¿”å›å›¾ç‰‡ä½ç½®ï¼Œåˆ™è¡¨ç¤ºæˆåŠŸã€‚ 3ã€ä¸Šä¼ æˆåŠŸåï¼Œæˆ‘ä»¬å°±èƒ½åœ¨ /data/fastdfs ç›®å½•ä¸‹ï¼Œçœ‹åˆ°æˆ‘ä»¬ä¸Šä¼ çš„æ–‡ä»¶ï¼š [root@i-zqovu8av 00]# pwd /data/fastdfs/data/00/00 [root@i-zqovu8av 00]# ls i8a_9mIKAMKAPKgPAAA2E69InJY486.jpg 4ã€æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡é…ç½®çš„Nginxå¯¹æ–‡ä»¶è¿›è¡Œç›´æ¥è®¿é—®ï¼š http://139.198.191.246:8888/group1/M00/00/00/i8a_9mIKAMKAPKgPAAA2E69InJY486.jpg è‡³æ­¤ï¼ŒFastDFSçš„å•æœºç‰ˆå®‰è£…ä¸æµ‹è¯•å®Œæˆ. è¡¥å……ä¸€ï¼šFastDFSä¸Nginxçš„å¼€æœºè‡ªå¯åŠ¨ è€ƒè™‘åˆ°æ¯æ¬¡å¯åŠ¨ä¹‹åéƒ½è¦é‡æ–°å¯åŠ¨ä¸€ä¸‹fastdfs å’Œ nginxæœåŠ¡ï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œæ‰€ä»¥å¢åŠ å¼€æœºè‡ªå¯åŠ¨ 1ã€é…ç½® rc.local æ–‡ä»¶ï¼š vim /etc/rc.d/rc.local # å¢åŠ fastdfs start /usr/bin/fdfs_trackerd /etc/fdfs/tracker.conf restart /usr/bin/fdfs_storaged /etc/fdfs/storage.conf restart # å¢åŠ nginx start /usr/local/nginx/sbin/nginx 2ã€ç”±äºåœ¨centos7ä¸­, /etc/rc.d/rc.local æ–‡ä»¶çš„æƒé™è¢«é™ä½äº†ï¼Œéœ€è¦ç»™rc.local æ–‡ä»¶å¢åŠ å¯æ‰§è¡Œçš„æƒé™ï¼š chmod +x /etc/rc.d/rc.local ","link":"https://tianxiawuhao.github.io/8j32dqs0d/"},{"title":"åœ¨Centos7.9æ‰‹åŠ¨å®‰è£…Nexus3","content":" dockerså®‰è£…å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬ä¸å¯ä»¥é€‰æ‹©dockerå®‰è£…çš„æ—¶å€™ï¼Œå°±æ‰‹åŠ¨å®‰è£…å§ã€‚ ä¸€ã€å®‰è£…JDK é¦–å…ˆæ–°çš„ç¯å¢ƒè™šæ‹Ÿæœºæœ‰è‡ªå·±è‡ªå¸¦çš„openjdkï¼Œåœ¨å®‰è£…jdkå‰éœ€è¦å…ˆæŠŠè™šæ‹Ÿæœºçš„å¸æ‰ï¼Œé˜²æ­¢å¤šä¸ªjdkå†²çªï¼Œä¸‹é¢æ˜¯å¸è½½æ­¥éª¤ï¼š #æŸ¥çœ‹å·²å®‰è£…çš„openjdkï¼š rpm -qa | grep openjdk #ç»“æœæ˜¾ç¤ºå­˜åœ¨çš„openjdkï¼š java-1.8.0-openjdk-1.8.0.161-2.b14.el7.x86_64 #ç‰ˆæœ¬æ˜¾ç¤ºä¸ä¸€ #æ‰§è¡Œæ‰¹é‡åˆ é™¤å‘½ä»¤ï¼Œåˆ é™¤ openjdk rpm -qa | grep openjdk |xargs rpm -e --nodeps #å†æ¬¡æŸ¥çœ‹rpm -qa | grep openjdk æ˜¯å¦è¿˜å­˜åœ¨ ä¸‹è½½åœ°å€ï¼šJava Downloads | Oracle #è§£å‹å‘½ä»¤ tar -zxvf jdk-8u181-linux-x64.tar.gz #é‡å‘½å mv jdk-8u181-linux-x64 JAVA é…ç½®ç¯å¢ƒå˜é‡ #é…ç½®JDKç¯å¢ƒå˜é‡ vim /etc/profile,åœ¨æ–‡ä»¶æœ«è¿½åŠ å¦‚ä¸‹å†…å®¹: export JAVA_HOME=jdkçš„æ ¹ç›®å½• export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar export PATH=$PATH:$JAVA_HOME/bin ä¿å­˜é€€å‡º #ä½¿æ·»åŠ åœ¨æ–‡ä»¶ä¸­çš„é…ç½®ä¿¡æ¯é©¬ä¸Šç”Ÿæ•ˆ: source /etc/profile #æŸ¥çœ‹JDKå®‰è£…æ˜¯å¦æˆåŠŸï¼š java -version äºŒã€å®‰è£…MAVEN è¿›å…¥mavenå®˜ç½‘ä¸‹è½½æœ€æ–°mavenï¼Œä¸‹è½½åæ”¾åˆ°/usr/localç›®å½•ï¼Œè§£å‹ï¼ˆå…·ä½“ç‰ˆæœ¬å·æ”¹ä¸ºä¸‹è½½å¯¹åº”çš„ï¼‰ 1. è§£å‹ tar -xzf apache-maven-3.9.0-bin.tar.gz 2. ç§»åŠ¨ç›®å½• mv apache-maven-3.9.0 /opt/maven 3. é…ç½®ç¯å¢ƒå˜é‡ vi /etc/profile export MAVEN_HOME=/opt/maven/ export PATH=$MAVEN_HOME/bin:$PATH #åŠ è½½ source /etc/profile 4. æŸ¥çœ‹mavenæ˜¯å¦é…ç½®æˆåŠŸ mvn -v 5. é…ç½® cd /opt/maven/conf vi settings.xml &lt;localRepository&gt;/usr/local/maven/repo&lt;/localRepository&gt; 6. é…ç½®é˜¿é‡Œäº‘é•œåƒ &lt;mirror&gt; &lt;id&gt;alimaven&lt;/id&gt; &lt;name&gt;aliyun maven&lt;/name&gt; &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt; &lt;mirrorOf&gt;central&lt;/mirrorOf&gt; &lt;/mirror&gt; ä¸‰ã€ä¸‹è½½å®‰è£…Nexus3 1ã€ä¸‹è½½æœ€æ–°Nexus3å®‰è£…åŒ… https://my.sonatype.com/ åœ¨ Latest Releases æ ‡ç­¾ä¸‹ï¼Œ ä¸‹è½½æœ€æ–°nexus repositoryå®‰è£…åŒ… 2ã€è§£å‹åˆ° /usr/local/nexus/ ç›®å½•ä¸‹ tar -zxvf nexus-3.37.3-02-unix.tar.gz [root@tcosmo-szls01 nexus]# pwd /usr/local/nexus # è§£å‹å®Œä¼šæœ‰ä¸¤ä¸ªç›®å½•: [root@tcosmo-szls01 nexus]# ll total 0 drwxr-xr-x. 10 root root 181 Jan 26 11:08 nexus-3.37.3-02 ## åŒ…å«äº† Nexus è¿è¡Œæ‰€éœ€è¦çš„æ–‡ä»¶ã€‚æ˜¯ Nexus è¿è¡Œå¿…é¡»çš„ drwxr-xr-x. 3 root root 20 Jan 26 11:08 sonatype-work ## åŒ…å«äº† Nexus ç”Ÿæˆçš„é…ç½®æ–‡ä»¶ã€æ—¥å¿—æ–‡ä»¶ã€ä»“åº“æ–‡ä»¶ç­‰ã€‚å½“æˆ‘ä»¬éœ€è¦å¤‡ä»½ Nexus çš„æ—¶å€™é»˜è®¤å¤‡ä»½æ­¤ç›®å½•å³å¯ 3ã€é…ç½®ç¯å¢ƒå˜é‡ï¼Œå¹¶ä½¿å…¶ç”Ÿæ•ˆ [root@tcosmo-szls01 nexus]# vim /etc/profile export NEXUS_HOME=/usr/local/nexus/nexus-3.37.3-02 export PATH=$PATH:$NEXUS_HOME/bin [root@tcosmo-szls01 nexus]# source /etc/profile [root@tcosmo-szls01 nexus]# nexus -version WARNING: ************************************************************ WARNING: Detected execution as &quot;root&quot; user. This is NOT recommended! WARNING: ************************************************************ Usage: /usr/local/nexus/nexus-3.37.3-02/bin/nexus {start|stop|run|run-redirect|status|restart|force-reload} 4ã€ä¿®æ”¹é»˜è®¤å¯åŠ¨ç”¨æˆ· vim /usr/local/nexus/nexus-3.37.3-02/bin/nexus.rc run_as_user=&quot;root&quot; #å†…å®¹å°±è¿™ä¸€è¡Œï¼Œæ”¾å¼€æ³¨é‡Šï¼Œå¡«å†™ç”¨æˆ·å³å¯ 5ã€ä¿®æ”¹å¯åŠ¨ç«¯å£ vim /usr/local/nexus/nexus-3.37.3-02/etc/nexus-default.properties #é»˜è®¤å°±æ˜¯8081ï¼Œå¯ä»¥ä¸ä¿®æ”¹ 6ã€å¯åŠ¨nexuså¹¶æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ [root@tcosmo-szls01 nexus]# nexus start WARNING: ************************************************************ WARNING: Detected execution as &quot;root&quot; user. This is NOT recommended! WARNING: ************************************************************ Starting nexus [root@tcosmo-szls01 nexus]# nexus status WARNING: ************************************************************ WARNING: Detected execution as &quot;root&quot; user. This is NOT recommended! WARNING: ************************************************************ nexus is running. 7ã€è®¿é—®ç³»ç»Ÿ è®¿é—®http://ip:8081ï¼Œç™»é™†ç”¨æˆ·admin å¯†ç å­˜æ”¾åœ¨ï¼š/usr/local/nexus/sonatype-work/nexus3/admin.password ç›®å½• [root@tcosmo-szls01 nexus]# cat /usr/local/nexus/sonatype-work/nexus3/admin.password easdsccc-64ab-45c4-9d8a-abh******jfe19 8ã€é…ç½®nexuså¼€æœºè‡ªå¯åŠ¨ vim /etc/rc.d/rc.local /usr/local/nexus/nexus-3.18.1/bin/nexus start #æ·»åŠ è¿™ä¸€è¡Œå†…å®¹ chmod 755 /etc/rc.d/rc.local å››ã€Nexus3çš„ä½¿ç”¨ 1ã€åœ¨mvné…ç½®ä¸­æ·»åŠ nexusçš„è®¤è¯ä¿¡æ¯ &lt;server&gt; &lt;id&gt;mynexus-releases&lt;/id&gt; &lt;username&gt;admin&lt;/username&gt; &lt;password&gt;******&lt;/password&gt; &lt;/server&gt; &lt;server&gt; &lt;id&gt;mynexus-snapshots&lt;/id&gt; &lt;username&gt;admin&lt;/username&gt; &lt;password&gt;******&lt;/password&gt; &lt;/server&gt; 2ã€åœ¨é¡¹ç›®çš„pom.xmlä¸­æ·»åŠ nexusçš„ä»“åº“åœ°å€ ï¼ˆå¦‚æœæ˜¯å¤šmoduleåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åœ¨çˆ¶pomé‡Œé¢é…ç½®ï¼‰ &lt;distributionManagement&gt; &lt;repository&gt; &lt;id&gt;mynexus-releases&lt;/id&gt; &lt;name&gt;maven-releases&lt;/name&gt; &lt;url&gt;http://10.206.73.157:8081/repository/maven-releases/&lt;/url&gt; &lt;/repository&gt; &lt;snapshotRepository&gt; &lt;id&gt;mynexus-snapshots&lt;/id&gt; &lt;name&gt;maven-snapshots&lt;/name&gt; &lt;url&gt;http://10.206.73.157:8081/repository/maven-snapshots/&lt;/url&gt; &lt;/snapshotRepository&gt; &lt;/distributionManagement&gt; 3ã€æ‰§è¡Œdeployå‘½ä»¤ï¼Œå®Œæˆæ‰“åŒ…ä¸æ¨é€ mvn clean deploy # å¦‚æœåƒå¼ºè¡Œè¦æ±‚ä½¿ç”¨è€…æ›´æ–°æœ¬åœ°ä¾èµ–ï¼Œå¯ä»¥ -U ![1643178542(https://tianxiawuhao.github.io/post-images/1643178548537135.png) 4ã€ç°åœ¨å¯ä»¥åœ¨maven-publicä¸­æŸ¥çœ‹åˆ°æˆ‘ä»¬æ¨é€çš„jaråŒ… 5ã€åœ¨Mavené¡¹ç›®ä¸­çš„ä½¿ç”¨ å¦‚æœæˆ‘ä»¬åªæœ‰ä¸ªåˆ«ä¾èµ–éœ€è¦ä»æˆ‘ä»¬è‡ªå·±çš„nexusä¸‹è½½ï¼Œé‚£ä¹ˆåªéœ€è¦åœ¨é¡¹ç›®çš„pom.xmlæ–‡ä»¶ä¸­è¿›è¡Œé…ç½®å³å¯ï¼š &lt;repositories&gt; &lt;repository&gt; &lt;id&gt;releases&lt;/id&gt; &lt;name&gt;maven-public&lt;/name&gt; &lt;url&gt;http://10.206.73.157:8081/repository/maven-public/&lt;/url&gt; &lt;/repository&gt; &lt;/repositories&gt; å¦‚æœæˆ‘ä»¬æœ‰å¾ˆå¤šä¾èµ–éƒ½éœ€è¦ä»æˆ‘ä»¬è‡ªå·±çš„nexusä¸‹è½½ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ä¿®æ”¹mavençš„é…ç½®æ–‡ä»¶ï¼Œsetting.xmlå¢åŠ é•œåƒæ¥å®ç°ï¼› &lt;mirror&gt; &lt;id&gt;myNexus&lt;/id&gt; &lt;mirrorOf&gt;*&lt;/mirrorOf&gt; &lt;name&gt;myNexus&lt;/name&gt; &lt;url&gt;http://10.206.73.157:8081/repository/maven-public/&lt;/url&gt; &lt;/mirror&gt; ä½†æ˜¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼š å½“mavençš„ç‰ˆæœ¬é«˜äº3.6ä¹‹åï¼Œæˆ‘ä»¬åœ¨é¡¹ç›®pom.xmlä¸­æ˜¯æ²¡æœ‰åŠæ³•ä½¿ç”¨httpåè®®çš„ä»“åº“åœ°å€çš„ï¼Œä¼šæŠ¥é”™ï¼š maven-default-http-blocker (http://0.0.0.0/): Blocked mirror for repositories æ­¤æ—¶ï¼Œæˆ‘ä»¬è¦ä¹ˆä½¿ç”¨httpsåè®®çš„ä»“åº“åœ°å€ï¼Œè¦ä¹ˆåœ¨mavençš„setting.xmlä¸­è¿›è¡Œé…ç½®ï¼› å½“mavençš„é…ç½®setting.xmlä¸­é…ç½®äº†å¤šä¸ªmirroré•œåƒçš„æ—¶å€™ï¼Œæ˜¯æ²¡æœ‰åŠæ³•åŒæ—¶ç”Ÿæ•ˆï¼Œä¾æ¬¡æ£€æŸ¥çš„ï¼Œåªæœ‰ç¬¬ä¸€ä¸ªä¼šç”Ÿæ•ˆï¼› è¿™å¾ˆå°´å°¬ï¼Œå› ä¸ºæˆ‘ä»¬ä¸€èˆ¬ä¼šå–œæ¬¢åœ¨setting.xmlä¸­é…ç½®é˜¿é‡Œäº‘çš„é•œåƒä»“åº“ï¼Œä¸æƒ³å®Œå…¨æ›¿æ¢æˆæˆ‘ä»¬è‡ªå·±çš„ã€‚ è¡¥å……1ï¼šNexusä¸­é»˜è®¤çš„é‚£äº›ä»“åº“åˆ†åˆ«æ˜¯ä»€ä¹ˆä½œç”¨ï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ Typeç±»å‹çš„ç†è§£ï¼š proxyï¼šæ˜¯è¿œç¨‹ä»“åº“çš„ä»£ç†ã€‚æ¯”å¦‚è¯´åœ¨nexusä¸­é…ç½®äº†ä¸€ä¸ªcentral repositoryçš„proxyï¼Œå½“ç”¨æˆ·å‘è¿™ä¸ªproxyè¯·æ±‚ä¸€ä¸ªartifactï¼Œè¿™ä¸ªproxyå°±ä¼šå…ˆåœ¨æœ¬åœ°æŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾ä¸åˆ°çš„è¯ï¼Œå°±ä¼šä»è¿œç¨‹ä»“åº“ä¸‹è½½ï¼Œç„¶åè¿”å›ç»™ç”¨æˆ·ï¼Œç›¸å½“äºèµ·åˆ°ä¸€ä¸ªä¸­è½¬çš„ä½œç”¨ã€‚ Hostedï¼šæ˜¯å®¿ä¸»ä»“åº“ï¼Œç”¨æˆ·å¯ä»¥æŠŠè‡ªå·±çš„ä¸€äº›æ„ä»¶ï¼Œdeployåˆ°hostedä¸­ï¼Œä¹Ÿå¯ä»¥æ‰‹å·¥ä¸Šä¼ æ„ä»¶åˆ°hostedé‡Œã€‚æ¯”å¦‚è¯´oracleçš„é©±åŠ¨ç¨‹åºï¼Œojdbc6.jarï¼Œåœ¨central repositoryæ˜¯è·å–ä¸åˆ°çš„ï¼Œå°±éœ€è¦æ‰‹å·¥ä¸Šä¼ åˆ°hostedé‡Œï¼Œä¸€èˆ¬ç”¨æ¥å­˜æ”¾å…¬å¸è‡ªå·±çš„jaråŒ…ï¼› Groupï¼šæ˜¯ä»“åº“ç»„ï¼Œåœ¨mavené‡Œæ²¡æœ‰è¿™ä¸ªæ¦‚å¿µï¼Œæ˜¯nexusç‰¹æœ‰çš„ã€‚ç›®çš„æ˜¯å°†ä¸Šè¿°å¤šä¸ªä»“åº“èšåˆï¼Œå¯¹ç”¨æˆ·æš´éœ²ç»Ÿä¸€çš„åœ°å€ï¼Œè¿™æ ·ç”¨æˆ·å°±ä¸éœ€è¦åœ¨pomä¸­é…ç½®å¤šä¸ªåœ°å€ï¼Œåªè¦ç»Ÿä¸€é…ç½®groupçš„åœ°å€å°±å¯ä»¥äº†å³è¾¹é‚£ä¸ªRepository Pathå¯ä»¥ç‚¹å‡»è¿›å»ï¼Œçœ‹åˆ°ä»“åº“ä¸­artifactåˆ—è¡¨ã€‚ä¸è¿‡è¦æ³¨æ„æµè§ˆå™¨ç¼“å­˜ï¼Œå½“ä½ çš„é¡¹ç›®å¸Œæœ›åœ¨å¤šä¸ªrepositoryä½¿ç”¨èµ„æºæ—¶å°±ä¸éœ€è¦å¤šæ¬¡å¼•ç”¨äº†ï¼Œåªéœ€è¦å¼•ç”¨ä¸€ä¸ªgroupå³å¯ã€‚ å››å¤§ä»“åº“çš„ç†è§£ï¼š maven-centralï¼šä»£ç†ä»“åº“ï¼Œä½¿ç”¨äº†proxyæ¨¡å¼ï¼› maven-releaseï¼šç”¨æ¥å­˜æ”¾releaseç‰ˆæœ¬çš„jaråŒ…ï¼›ï¼ˆæˆ‘ä¸Šé¢å°±æ˜¯æ¨é€åˆ°äº†releaseåº“é‡Œé¢ï¼‰ maven-snapshotï¼šç”¨æ¥å­˜æ”¾snapshotç‰ˆæœ¬çš„jaråŒ…ï¼› maven-publicï¼šmaven-centralã€maven-releaseå’Œmaven-snapshotä¸‰ä¸ªåº“çš„åˆé›†ï¼Œå¯¹å¤–ä½¿ç”¨ï¼Œåªè¦æä¾›è¿™ä¸€ä¸ªgroupçš„åœ°å€å³å¯ã€‚ è¡¥å……äºŒï¼šæ–‡ä»¶æè¿°ç¬¦Ulimité—®é¢˜ä¿®å¤ vim /etc/security/limits.conf # æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼ˆå¦‚æœæˆ‘ä»¬æ˜¯rootç”¨æˆ·å¯åŠ¨çš„è¯ï¼‰ï¼š @root - nofile 65536 ## ä¿å­˜åé‡å¯ç³»ç»Ÿï¼š reboot ä¹‹åï¼Œæ­¤é—®é¢˜å³å¯è¢«ä¿®å¤ï¼ ","link":"https://tianxiawuhao.github.io/vdJWpe4ZR/"},{"title":"å›¾çš„éå†æ–¹æ³•","content":"ä»å›¾ä¸­æŸä¸€é¡¶ç‚¹å‡ºå‘è®¿éå›¾ä¸­å…¶ä½™é¡¶ç‚¹ï¼Œä¸”ä½¿æ¯ä¸€ä¸ªé¡¶ç‚¹ä»…è¢«è®¿é—®ä¸€æ¬¡ï¼Œè¿™ä¸€è¿‡ç¨‹å°±å«åšå›¾çš„éå†ï¼ˆTraversing Graphï¼‰ è®¿é—®è¿‡çš„é¡¶ç‚¹æ‰“ä¸Šæ ‡è®°ï¼Œé¿å…è®¿é—®å¤šæ¬¡è€Œä¸è‡ªçŸ¥ï¼›å¯ä»¥é€šè¿‡è®¾ç½®ä¸€ä¸ªè®¿é—®æ•°ç»„visited[n]ï¼Œnæ˜¯å›¾ä¸­é¡¶ç‚¹ä¸ªæ•°ï¼Œåˆå€¼ä¸º0ï¼Œè®¿é—®ä¹‹åè®¾ç½®ä¸º1 å›¾éå†è¦é¿å…å› å›è·¯é™·å…¥æ­»å¾ªç¯ï¼Œé€šå¸¸æœ‰ä¸¤ç§éå†æ¬¡åºæ–¹æ¡ˆï¼š æ·±åº¦ä¼˜å…ˆéå† å¹¿åº¦ä¼˜å…ˆéå† æ·±åº¦ä¼˜å…ˆéå† æ·±åº¦ä¼˜å…ˆéå†ï¼ˆDepth_First_Searchï¼‰ï¼Œä¹Ÿæœ‰ç§°ä¸ºæ·±åº¦ä¼˜å…ˆæœç´¢ï¼Œç®€ç§°DFS å¦‚ä¸Šå›¾ï¼Œå¦‚ä½•ä»é¡¶ç‚¹Aå¼€å§‹èµ°éæ‰€æœ‰çš„å›¾é¡¶ç‚¹å¹¶ä½œä¸Šæ ‡è®°ï¼Ÿ ä»é¡¶ç‚¹Aå¼€å§‹ï¼Œå§‹ç»ˆå‘å³æ‰‹è¾¹èµ°ï¼Œæ³¨æ„ï¼Œèµ°åˆ°æœ€åï¼Œè¿˜æœ‰ä¸€ä¸ªIé¡¶ç‚¹æ²¡èµ°ã€‚ æ·±åº¦ä¼˜å…ˆéå†å…¶å®å°±æ˜¯ä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹ï¼Œä»å›¾å³è¾¹è·¯å¾„å¯ä»¥çœ‹å‡ºç±»ä¼¼ä¸€æ£µæ ‘çš„å‰åºéå†ï¼Œç¡®å®å¦‚æ­¤ã€‚ ä»å›¾ä¸­æŸä¸ªé¡¶ç‚¹vå‡ºå‘ï¼Œè®¿é—®æ­¤é¡¶ç‚¹ï¼Œç„¶åä»vçš„æœªè¢«è®¿é—®çš„é‚»æ¥ç‚¹å‡ºå‘æ·±åº¦ä¼˜å…ˆéå†å›¾ï¼Œç›´è‡³å›¾ä¸­æ‰€æœ‰å’Œvæœ‰è·¯å¾„æƒ³é€šçš„é¡¶ç‚¹éƒ½è¢«è®¿é—®åˆ°ã€‚ éè¿é€šå›¾ï¼Œåªéœ€è¦å¯¹å®ƒçš„è¿é€šåˆ†é‡åˆ†åˆ«è¿›è¡Œæ·±åº¦ä¼˜å…ˆéå†ï¼Œå³åœ¨å…ˆå‰ä¸€ä¸ªé¡¶ç‚¹è¿›è¡Œä¸€æ¬¡æ·±åº¦ä¼˜å…ˆéå†åï¼Œè‹¥å›¾ä¸­å°šæœ‰é¡¶ç‚¹æœªè¢«è®¿é—®ï¼Œåˆ™é€‰å›¾ä¸­ä¸€ä¸ªæœªè¢«è®¿é—®çš„é¡¶ç‚¹ä½œèµ·å§‹ç‚¹ï¼Œé‡å¤ä¸Šè¿°è¿‡ç¨‹ï¼Œç›´è‡³å›¾ä¸­æ‰€æœ‰é¡¶ç‚¹éƒ½è¢«è®¿é—®åˆ°ä¸ºæ­¢ã€‚ é‚»æ¥çŸ©é˜µæ·±åº¦ä¼˜å…ˆéå† é‚»æ¥çŸ©é˜µè¡¨ç¤ºå¦‚ä¸‹å›¾ï¼š /** * é‚»æ¥çŸ©é˜µçš„æ·±åº¦ä¼˜å…ˆéå†ï¼ˆæ³¨æ„Iç‚¹çš„éå†æ¯”è¾ƒç‰¹æ®Šï¼‰ */ public class DFSTest { Boolean[] visited = new Boolean[9]; //é‚»æ¥çŸ©é˜µçš„æ·±åº¦ä¼˜å…ˆé€’å½’ç®—æ³• void DFS(Graph graph,int i){ int j; visited[i] = true; System.out.println(graph.verxs[i]);//æ‰“å°é¡¶ç‚¹,ä¹Ÿå¯ä»¥è¿›è¡Œå…¶ä»–æ“ä½œ for(j = 0;j&lt;graph.numVertexes;j++){ if(graph.arc[i][j] == 1 &amp;&amp; !visited[j]){ DFS(graph, j); } } } //é‚»æ¥çŸ©é˜µçš„æ·±åº¦éå†æ“ä½œ void DFSTraverse(Graph graph){ int i; for(i = 0;i&lt;graph.numVertexes;i++){ visited[i] = false;//åˆå§‹åŒ–æ‰€æœ‰é¡¶ç‚¹çŠ¶æ€éƒ½æ˜¯æœªè®¿é—®çŠ¶æ€ } for(i=0;i&lt;graph.numVertexes;i++){ if(!visited[i]){//å¯¹æœªè®¿é—®è¿‡çš„é¡¶ç‚¹è°ƒç”¨DFSï¼Œè‹¥æ˜¯è¿é€šå›¾ï¼Œåˆ™åªä¼šæ‰§è¡Œä¸€æ¬¡ DFS(graph, i); } } } } é‚»æ¥è¡¨æ·±åº¦ä¼˜å…ˆéå† public class DFSTest { //é‚»æ¥è¡¨æ·±åº¦ä¼˜å…ˆé€’å½’ç®—æ³• void DFS(GraphAdjList gl,int i){ EdgeNode p = null; visited[i] = true; System.out.println(gl.vertexNodes[i].data);//æ‰“å°é¡¶ç‚¹ p = gl.vertexNodes[i].firstEdge; while(p != null){ if(!visited[p.next.adjvex]){ DFS(gl, p.next.adjvex); } p = p.next; } } //é‚»æ¥è¡¨çš„æ·±åº¦éå†æ“ä½œ void DFSTraverse(GraphAdjList gl){ int i; for(i = 0;i&lt;gl.numVertexes;i++){ visited[i] = false;//åˆå§‹åŒ–æ‰€æœ‰é¡¶ç‚¹çŠ¶æ€éƒ½æ˜¯æœªè®¿é—®çŠ¶æ€ } for(i=0;i&lt;gl.numVertexes;i++){ if(!visited[i]){//å¯¹æœªè®¿é—®è¿‡çš„é¡¶ç‚¹è°ƒç”¨DFSï¼Œè‹¥æ˜¯è¿é€šå›¾ï¼Œåˆ™åªä¼šæ‰§è¡Œä¸€æ¬¡ DFS(gl, i); } } } } æ€»ç»“ï¼šä¸¤ä¸ªä¸åŒå­˜å‚¨ç»“æ„æ·±åº¦ä¼˜å…ˆéå†ç®—æ³• é‚»æ¥çŸ©é˜µæ˜¯äºŒç»´æ•°ç»„ï¼Œè¦æŸ¥æ‰¾æ¯ä¸ªé¡¶ç‚¹çš„é‚»æ¥ç‚¹éœ€è¦è®¿é—®çŸ©é˜µä¸­çš„å…ƒç´ ï¼Œå› æ­¤éœ€è¦O(n^2)çš„æ—¶é—´ é‚»æ¥è¡¨åšå­˜å‚¨ç»“æ„ï¼Œéœ€è¦æ—¶é—´å–å†³äºé¡¶ç‚¹å’Œè¾¹çš„æ•°é‡ï¼Œæ‰€ä»¥æ˜¯O(n+e) æ˜¾ç„¶å¯¹äºç‚¹å¤šè¾¹å°‘çš„ç¨€ç–å›¾æ¥è¯´ï¼Œé‚»æ¥è¡¨ç»“æ„ä½¿å¾—ç®—æ³•åœ¨æ—¶é—´æ•ˆç‡ä¸Šå¤§å¤§æé«˜ã€‚ å¹¿åº¦ä¼˜å…ˆéå† å¹¿åº¦ä¼˜å…ˆéå†ï¼ˆBreadth First Searchï¼‰ï¼Œåˆç§°å¹¿åº¦ä¼˜å…ˆæœç´¢ï¼Œç®€ç§°BFSã€‚ æ·±åº¦ä¼˜å…ˆéå†æœªå¿…æ˜¯æœ€ä½³æ–¹æ¡ˆï¼Œå®ƒæ„å‘³ç€è¦å½»åº•æŸ¥æ‰¾å®Œä¸€ä¸ªåœ°æ–¹ï¼Œç„¶åæ‰æŸ¥æ‰¾å¦ä¸€ä¸ªåœ°æ–¹ã€‚ DFSç±»ä¼¼äºæ ‘çš„å‰åºéå†ï¼ŒBFSç±»ä¼¼äºæ ‘çš„å±‚åºéå†ã€‚ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œé¡¶ç‚¹Aä½œä¸ºç¬¬ä¸€å±‚ï¼ŒAçš„æ‰€æœ‰è¾¹é¡¶ç‚¹BFä½œä¸ºç¬¬äºŒå±‚ï¼ŒBFçš„æ‰€æœ‰è¾¹é¡¶ç‚¹CIGEä½œä¸ºç¬¬ä¸‰å±‚ï¼Œä¾æ¬¡ç±»æ¨ã€‚ é‚»æ¥çŸ©é˜µå¹¿åº¦ä¼˜å…ˆéå† public class BFSTest { //é‚»æ¥è¡¨æ·±åº¦ä¼˜å…ˆé€’å½’ç®—æ³• //é‚»æ¥çŸ©é˜µå¹¿åº¦éå†ç®—æ³• void BFSTraverse(Graph g){ int i,j; Queue&lt;Integer&gt; q; for(i=0;i&lt;g.numVertexes;i++){ visited[i] = false; } q = new LinkedList&lt;Integer&gt;(); for(i=0;i&lt;g.numVertexes;i++){ if(!visited[i]){//æœªè®¿é—®å°±å¤„ç† visited[i] = true; System.out.println(g.verxs[i]);//æ‰“å°é¡¶ç‚¹ q.offer(i);//æ­¤é¡¶ç‚¹å…¥é˜Ÿ while(!q.isEmpty()){//è‹¥å½“å‰é˜Ÿåˆ—ä¸ä¸ºç©º i = q.poll();//å‡ºé˜Ÿå¹¶è®°å½•æ­¤é¡¶ç‚¹åœ¨æ•°ç»„ä¸­çš„ä¸‹æ ‡ for(j=0;j&lt;g.numVertexes;j++){ //åˆ¤æ–­å…¶ä»–é¡¶ç‚¹è‹¥ä¸å½“å‰é¡¶ç‚¹å­˜åœ¨è¾¹ï¼Œå¹¶ä¸”ä»æœªè®¿é—®è¿‡ if(g.arc[i][j] == 1 &amp;&amp; !visited[j]){ visited[j] = true; //æ‰“å°é¡¶ç‚¹ System.out.println(g.verxs[j]); //å°†æ‰¾åˆ°çš„é¡¶ç‚¹å…¥é˜Ÿåˆ— q.offer(j); } } } } } } } é‚»æ¥è¡¨å¹¿åº¦ä¼˜å…ˆéå† public class BFSTest { //é‚»æ¥è¡¨å¹¿åº¦éå†ç®—æ³• void BFSTraverse(GraphAdjList g){ int i; EdgeNode p; Queue&lt;Integer&gt; q; for(i=0;i&lt;g.numVertexes;i++){ visited[i] = false; } q = new LinkedList&lt;Integer&gt;(); for(i=0;i&lt;g.numVertexes;i++){ if(!visited[i]){ visited[i] = true; //æ‰“å°é¡¶ç‚¹ System.out.println(g.vertexNodes[i].data); q.offer(i); while(!q.isEmpty()){ i = q.poll(); //æ‰¾åˆ°å½“å‰é¡¶ç‚¹è¾¹è¡¨é“¾è¡¨å¤´æŒ‡é’ˆ p = g.vertexNodes[i].firstEdge; while(p != null){ if(!visited[p.adjvex]){ visited[p.adjvex] = true; System.out.println(g.vertexNodes[p.adjvex].data); q.offer(p.adjvex); } p = p.next;//æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªé‚»æ¥ç‚¹ } } } } } } æ€»ç»“ ä¸¤ç§éå†æ—¶é—´å¤æ‚åº¦æ˜¯ç›¸åŒçš„ï¼Œä¸åŒçš„æ˜¯å¯¹é¡¶ç‚¹çš„è®¿é—®é¡ºåºä¸åŒã€‚ ä¸¤ç§ç®—æ³•æ²¡æœ‰ä¼˜åŠ£ä¹‹åˆ†ï¼Œè§†ä¸åŒçš„æƒ…å†µé€‰æ‹©ä¸åŒçš„ç®—æ³•ã€‚ æ·±åº¦ä¼˜å…ˆæ›´é€‚åˆç›®æ ‡æ¯”è¾ƒæ˜ç¡®ï¼Œä»¥æ‰¾åˆ°ç›®æ ‡ä¸ºä¸»è¦ç›®çš„çš„æƒ…å†µ å¹¿åº¦ä¼˜å…ˆæ›´é€‚åˆåœ¨ä¸æ–­æ‰©å¤§éå†èŒƒå›´æ—¶æ‰¾åˆ°ç›¸å¯¹æœ€ä¼˜è§£çš„æƒ…å†µ ","link":"https://tianxiawuhao.github.io/w4yOxhPAW/"},{"title":"Centos7éƒ¨ç½²MinIO","content":" è‹±æ–‡å®˜ç½‘ï¼šhttps://min.io/ ä¸­æ–‡å®˜ç½‘ï¼šhttp://minio.org.cn/ï¼ˆæ›´æ–°ä¸åŠæ—¶ï¼Œå®¹æ˜“è¢«å‘ï¼‰ ä¸€ã€ä¸ºä»€ä¹ˆè¦ä½¿ç”¨MinIO å…¶å®æŠ›å¼€Cephè¿™ç±»å¤æ‚çš„å­˜å‚¨è§£å†³æ–¹æ¡ˆå¤–ï¼Œå°å…¬å¸å°å›¢é˜Ÿçš„é€‰æ‹©ä¸€èˆ¬éƒ½ä¼šæ˜¯FastDFSæˆ–è€…MinIOï¼Œé‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬å°±ç®€å•å¯¹æ¯”ä¸‹MinIOç›¸è¾ƒäºFastDFSçš„ä¼˜åŠ¿ï¼ 1ã€å®‰è£…éƒ¨ç½²(è¿ç»´)å¤æ‚åº¦ è™½ç„¶æˆ‘è§‰å¾—FastDFSå®‰è£…ä¹Ÿä¸ç®—å¾ˆå¤æ‚ï¼Œä½†æ˜¯MinIOçš„å®‰è£…å¯ä»¥è¯´æ›´ç®€å•ï¼› FastDFSå®‰è£…ï¼š 2ã€æ–‡æ¡£ FastDFSå¯ä»¥è¯´å‘å±•äº†åå‡ å¹´å‡ ä¹æ²¡æœ‰å®˜æ–¹æ–‡æ¡£ï¼Œéƒ½æ˜¯é çƒ­å¿ƒç½‘å‹æŠ•ç¨¿ï¼› è€ŒMinIOæ–‡æ¡£è¿˜æ˜¯æ¯”è¾ƒå…¨çš„ï¼Œä¸­æ–‡æ–‡æ¡£ï¼šhttp://docs.minio.org.cn/docs/master/minio-monitoring-guide 3ã€å¼€æºé¡¹ç›®è¿è¥ç»„ç»‡ FastDFSæ˜¯é˜¿é‡Œä½™åº†å¤§ç¥çš„ä¸ªäººé¡¹ç›®ï¼Œè€ŒMinIOèƒŒé çš„æ˜¯Apacheå¼€æºç»„ç»‡ï¼› 4ã€UIç•Œé¢ FastDFSé»˜è®¤æ˜¯ä¸å¸¦UIç•Œé¢çš„ï¼Œè€ŒMinIOæœåŠ¡éƒ¨ç½²æ—¶å€™ï¼Œæ˜¯è‡ªå¸¦UIç•Œé¢çš„ï¼Œå¼€ç®±å³ç”¨ï¼› 5ã€æ€§èƒ½ MinIOå·ç§°æ˜¯ä¸–ç•Œä¸Šé€Ÿåº¦æœ€å¿«çš„å¯¹è±¡å­˜å‚¨æœåŠ¡å™¨ï¼Œæ ‡å‡†ç¡¬ä»¶è®¾å¤‡ä¸Šï¼Œè¯»/å†™é€Ÿåº¦éƒ½æ˜¯GBçº§åˆ«çš„ï¼›FastDFSå·®å¤šäº†ï¼› 6ã€å®¹å™¨åŒ–æ”¯æŒ MinIOæä¾›äº†ä¸k8sã€etcdã€dockerç­‰å®¹å™¨åŒ–æŠ€æœ¯æ·±åº¦é›†æˆæ–¹æ¡ˆï¼Œå¯ä»¥è¯´å°±æ˜¯ä¸ºäº†äº‘ç¯å¢ƒè€Œç”Ÿçš„ã€‚è¿™ç‚¹æ˜¯FastDFSä¸å…·å¤‡çš„ã€‚ 7ã€ä¸°å¯Œçš„SDKæ”¯æŒ MinIOæ”¯æŒçš„ä¸åŒè¯­è¨€SDKå¤šäºFastDFSï¼Œå°¤å…¶æ–‡æ¡£ï¼Œæ›´æ˜¯å®Œèƒœï¼› 8ã€AWS S3æ ‡å‡†å…¼å®¹ Amazonçš„S3 APIæ˜¯å¯¹è±¡å­˜å‚¨é¢†åŸŸçš„äº‹å®æ ‡å‡†ã€‚MinIOæ˜¯S3å…¼å®¹æ€§çš„äº‹å®ä¸Šçš„æ ‡å‡†ï¼Œæ˜¯ç¬¬ä¸€ä¸ªé‡‡ç”¨APIå’Œç¬¬ä¸€ä¸ªæ·»åŠ å¯¹S3 Selectæ”¯æŒçš„æ ‡å‡†ä¹‹ä¸€ã€‚åŒ…æ‹¬å¾®è½¯Azureåœ¨å†…çš„750å¤šå®¶å…¬å¸ä½¿ç”¨MinIOçš„S3ç½‘å…³ï¼Œè¿™ä¸€æ•°å­—è¶…è¿‡äº†ä¸šå†…å…¶ä»–å…¬å¸çš„æ€»å’Œã€‚ ä»€ä¹ˆæ„æ€ï¼Ÿå°±æ˜¯è¯´ä½ ç°åœ¨ä¸ºäº†èŠ‚çº¦æˆæœ¬ä½¿ç”¨MinIOï¼Œç­‰ä½ çš„å…¬å¸å£®å¤§äº†ã€æœ‰é’±äº†ã€‚ä¸æƒ³è‡ªå·±è¿ç»´åŸºç¡€è®¾æ–½äº†ï¼Œä½ å°±å¯ä»¥æŠŠå¯¹è±¡å­˜å‚¨æ”¾åˆ°äº‘ä¸Šï¼Œåªè¦äº‘å‚å•†æ”¯æŒS3æ ‡å‡†ï¼Œä½ çš„åº”ç”¨ç¨‹åºæ˜¯ä¸éœ€è¦é‡æ–°å¼€å‘çš„ã€‚ äºŒã€MinIOçš„éƒ¨ç½²ä¹‹Centoså•æœºéƒ¨ç½² æ­¤å•æœºæ¨¡å¼ï¼Œæ¯ä¸€ä»½å¯¹è±¡æ•°æ®ï¼Œminioç›´æ¥åœ¨dataç›®å½•ä¸‹å­˜å‚¨ä¸€ä»½æ•°æ®ï¼Œä¸ä¼šå»ºç«‹å‰¯æœ¬ï¼Œä¹Ÿä¸ä¼šå¯ç”¨çº åˆ ç æœºåˆ¶ï¼ˆæ•°æ®æ¢å¤ï¼‰ï¼Œå­˜åœ¨å•ç‚¹æ•…éšœï¼› 1ã€ç›´æ¥ä¸‹è½½äºŒè¿›åˆ¶æ‰§è¡Œæ–‡ä»¶ï¼Œå¹¶å¯åŠ¨ï¼š æ–‡ä»¶ä¸‹è½½åœ°å€ï¼šhttps://min.io/download#/linux wget https://dl.min.io/server/minio/release/linux-amd64/minio chmod +x minio MINIO_ROOT_USER=admin MINIO_ROOT_PASSWORD=password ./minio server /mnt/data --console-address &quot;:9001&quot; åç«¯è°ƒç”¨å°±æ˜¯9000ç«¯å£ï¼Œè®¿é—®å‰ç«¯é¡µé¢å°±æ˜¯9001ç«¯å£ï¼š ä¸€åˆ‡éƒ½æ˜¯å¦‚æ­¤çš„ç®€å•ï¼ ç¼–å†™ä¸€ä¸ªåå°è¿è¡Œçš„nohupè„šæœ¬runminio.sh: #!/bin/bash export MINIO_ROOT_USER=admin export MINIO_ROOT_PASSWORD=Haier2022 nohup /usr/local/minio/minio server /mnt/data --console-address &quot;:9001&quot; &gt; log.file 2&gt;&amp;1 &amp; #é»˜è®¤æœåŠ¡ç«¯å£ä¸º9000ï¼Œå¦‚æœç«¯å£å†²çªï¼Œå¯ä»¥ä¿®æ”¹ç«¯å£ nohup /usr/local/minio/minio server /mnt/data --address &quot;:9999&quot; --console-address &quot;:9001&quot; &gt; log.file 2&gt;&amp;1 &amp; nohupå‘½ä»¤ å…³é—­å½“å‰sessionä¸ä¼šä¸­æ–­ç¨‹åºï¼Œå¯ä»¥é€šè¿‡killç­‰å‘½ä»¤ç»ˆæ­¢ã€‚ ç¤ºä¾‹åŠè¯´æ˜ nohup command &gt; output.log 2&gt;&amp;1 &amp; å…¶ä¸­ 2&gt;&amp;1æ˜¯ç”¨æ¥å°†æ ‡å‡†é”™è¯¯2é‡å®šå‘åˆ°æ ‡å‡†è¾“å‡º1ä¸­ã€‚1å‰é¢çš„&amp;æ˜¯ä¸ºäº†è®©bashå°†1è§£é‡Šæˆæ ‡å‡†è¾“å‡ºè€Œä¸æ˜¯æ–‡ä»¶1ã€‚è€Œæœ€åä¸€ä¸ª&amp;æ˜¯ä¸ºäº†è®©bashåœ¨åå°æ‰§è¡Œã€‚ 2ã€é…ç½®Minioçš„å¼€æœºè‡ªå¯ï¼š åˆ›å»ºé…ç½®æ–‡ä»¶ï¼šminio.conf [root@localhost minio]# mkdir /usr/local/minio/conf [root@localhost minio]# vim /usr/local/minio/conf/minio.conf MINIO_VOLUMES=&quot;/data/minio&quot; MINIO_OPTS=&quot;--console-address :9001&quot; MINIO_ROOT_USER=&quot;admin&quot; MINIO_ROOT_PASSWORD=&quot;Wolong2022&quot; MINIO_SERVER_URL=&quot;http://192.168.0.117:9000&quot; åœ¨/etc/systemd/systemç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªæœåŠ¡minio.service [root@localhost minio]# vim /etc/systemd/system/minio.service [Unit] Description=MinIO Documentation=https://docs.min.io Wants=network-online.target After=network-online.target AssertFileIsExecutable=/usr/local/minio/minio [Service] User=root Group=root EnvironmentFile=/usr/local/minio/conf/minio.conf ExecStart=/usr/local/minio/minio server $MINIO_OPTS $MINIO_VOLUMES # Let systemd restart this service always Restart=always # Specifies the maximum file descriptor number that can be opened by this process LimitNOFILE=65536 # Disable timeout logic and wait until process is stopped TimeoutStopSec=infinity SendSIGKILL=no [Install] WantedBy=multi-user.target 3ã€å¯åŠ¨minioå¹¶è®¾ç½®å¼€æœºè‡ªå¯ï¼š [root@localhost minio]# systemctl start minio [root@localhost minio]# systemctl enable minio Created symlink from /etc/systemd/system/multi-user.target.wants/minio.service to /etc/systemd/system/minio.service. [root@localhost minio]# systemctl status minio â— minio.service - MinIO Loaded: loaded (/etc/systemd/system/minio.service; enabled; vendor preset: disabled) Active: active (running) since äºŒ 2022-11-01 15:19:19 CST; 14s ago Docs: https://docs.min.io Main PID: 34443 (minio) CGroup: /system.slice/minio.service â””â”€34443 /usr/local/minio/minio server --console-address :9001 /data/minio ä¸‰ã€MinIOçš„éƒ¨ç½²ä¹‹Dockerå•æœºéƒ¨ç½² æ­¤å•æœºæ¨¡å¼ï¼Œæ¯ä¸€ä»½å¯¹è±¡æ•°æ®ï¼Œminioç›´æ¥åœ¨dataç›®å½•ä¸‹å­˜å‚¨ä¸€ä»½æ•°æ®ï¼Œä¸ä¼šå»ºç«‹å‰¯æœ¬ï¼Œä¹Ÿä¸ä¼šå¯ç”¨çº åˆ ç æœºåˆ¶ï¼ˆæ•°æ®æ¢å¤ï¼‰ï¼Œå­˜åœ¨å•ç‚¹æ•…éšœï¼› ç›´æ¥æ‰§è¡Œdockerå‘½ä»¤ï¼š docker run -d \\ -p 9000:9000 \\ -p 9001:9001 \\ --name minio \\ -e &quot;MINIO_ROOT_USER=admin&quot; \\ -e &quot;MINIO_ROOT_PASSWORD=password&quot; \\ -v /mnt/data:/data \\ -v /mnt/config:/root/.minio \\ quay.io/minio/minio server /data --console-address &quot;:9001&quot; å››ã€MinIOçš„éƒ¨ç½²ä¹‹çº åˆ ç æ¨¡å¼éƒ¨ç½² è¯¥éƒ¨ç½²æ¨¡å¼ä½¿ç”¨çº åˆ ç ï¼ˆReasure Codeï¼‰å’Œæ ¡éªŒchecksumæ¥ä¿æŠ¤æ•°æ®å…å—ç¡¬ä»¶æ•…éšœæˆ–æ— å£°æ•°æ®æŸåï¼Œå³ä½¿ä½ ä¸¢äº†ä¸€èˆ¬æ•°é‡ï¼ˆN/2ï¼‰çš„ç¡¬ç›˜ï¼Œä½ ä»å¯ä»¥æ¢å¤æ•°æ®ï¼ çº åˆ ç æŠ€æœ¯çš„å®˜æ–¹æè¿°èµ„æ–™ï¼šhttp://docs.minio.org.cn/docs/master/minio-erasure-code-quickstart-guide ä½¿ç”¨dockerè¿›è¡Œå•æœºç‰ˆçš„çº åˆ ç æ¨¡å¼éƒ¨ç½²ï¼š docker run -d \\ -p 9000:9000 \\ -p 9001:9001 \\ --name minio \\ -e &quot;MINIO_ROOT_USER=admin&quot; \\ -e &quot;MINIO_ROOT_PASSWORD=password&quot; \\ -v /mnt/data1:/data1 \\ -v /mnt/data2:/data2 \\ -v /mnt/data3:/data3 \\ -v /mnt/data4:/data4 \\ -v /mnt/data5:/data5 \\ -v /mnt/data6:/data6 \\ -v /mnt/data7:/data7 \\ -v /mnt/data8:/data8 \\ -v /mnt/config:/root/.minio \\ quay.io/minio/minio server /data{1...8} --console-address &quot;:9001&quot; æ‰§è¡ŒæˆåŠŸåï¼Œæˆ‘ä»¬ç™»å½•åˆ°åå°ï¼Œç„¶åä¸Šä¼ å‡ ä¸ªæ–‡ä»¶çœ‹çœ‹æ•ˆæœï¼š [root@node2 /]# tree /mnt /mnt â”œâ”€â”€ config â”‚ â””â”€â”€ certs â”‚ â””â”€â”€ CAs â”œâ”€â”€ data â”‚ â””â”€â”€ haier â”‚ â”œâ”€â”€ harbor-offline-installer-v1.10.10.tgz â”‚ â”œâ”€â”€ maven.jpeg â”‚ â””â”€â”€ nexus3.jpg â”œâ”€â”€ data1 â”‚ â””â”€â”€ haier â”‚ â”œâ”€â”€ maven.jpeg â”‚ â”‚ â””â”€â”€ xl.meta â”‚ â””â”€â”€ nexus3.jpg â”‚ â””â”€â”€ xl.meta â”œâ”€â”€ data2 â”‚ â””â”€â”€ haier â”‚ â”œâ”€â”€ maven.jpeg â”‚ â”‚ â””â”€â”€ xl.meta â”‚ â””â”€â”€ nexus3.jpg â”‚ â””â”€â”€ xl.meta â”œâ”€â”€ data3 â”‚ â””â”€â”€ haier â”‚ â”œâ”€â”€ maven.jpeg â”‚ â”‚ â””â”€â”€ xl.meta â”‚ â””â”€â”€ nexus3.jpg â”‚ â””â”€â”€ xl.meta â”œâ”€â”€ data4 â”‚ â””â”€â”€ haier â”‚ â”œâ”€â”€ maven.jpeg â”‚ â”‚ â””â”€â”€ xl.meta â”‚ â””â”€â”€ nexus3.jpg â”‚ â””â”€â”€ xl.meta â”œâ”€â”€ data5 â”‚ â””â”€â”€ haier â”‚ â”œâ”€â”€ maven.jpeg â”‚ â”‚ â””â”€â”€ xl.meta â”‚ â””â”€â”€ nexus3.jpg â”‚ â””â”€â”€ xl.meta â”œâ”€â”€ data6 â”‚ â””â”€â”€ haier â”‚ â”œâ”€â”€ maven.jpeg â”‚ â”‚ â””â”€â”€ xl.meta â”‚ â””â”€â”€ nexus3.jpg â”‚ â””â”€â”€ xl.meta â”œâ”€â”€ data7 â”‚ â””â”€â”€ haier â”‚ â”œâ”€â”€ maven.jpeg â”‚ â”‚ â””â”€â”€ xl.meta â”‚ â””â”€â”€ nexus3.jpg â”‚ â””â”€â”€ xl.meta â””â”€â”€ data8 â””â”€â”€ haier â”œâ”€â”€ maven.jpeg â”‚ â””â”€â”€ xl.meta â””â”€â”€ nexus3.jpg â””â”€â”€ xl.meta 37 directories, 19 files æ­¤æ—¶ï¼Œæˆ‘åšäº†ä¸€æ¬¡ç®€å•çš„æµ‹è¯•ï¼Œåˆ ç›˜ï¼ˆå…¶å®æ˜¯åˆ é™¤æ–‡ä»¶å¤¹ï¼‰ï¼š å½“æˆ‘åˆ é™¤4ä¸ªæ–‡ä»¶å¤¹æ—¶å€™ï¼Œæ•°æ®ä¾ç„¶å¯ä»¥æ­£å¸¸è®¿é—®ï¼› å½“æˆ‘åˆ é™¤ç¬¬5ä¸ªæ–‡ä»¶å¤¹æ—¶å€™ï¼Œæ•°æ®æ–‡æ³•æ­£å¸¸è®¿é—®ï¼ŒUIé¡µé¢æ— æ³•ç™»å½•ï¼ŒæŠ¥é”™ï¼š äº”ã€MinIOçš„éƒ¨ç½²ä¹‹åˆ†éƒ¨ç½²é›†ç¾¤éƒ¨ç½² å¯åŠ¨ä¸€ä¸ªåˆ†å¸ƒå¼Minioå®ä¾‹ï¼Œä½ åªéœ€è¦æŠŠç¡¬ç›˜ä½ç½®åšä¸ºå‚æ•°ä¼ ç»™minio serverå‘½ä»¤å³å¯ï¼Œç„¶åï¼Œä½ éœ€è¦åœ¨æ‰€æœ‰å…¶å®ƒèŠ‚ç‚¹è¿è¡ŒåŒæ ·çš„å‘½ä»¤ã€‚ åˆ†å¸ƒå¼Minioé‡Œæ‰€æœ‰çš„èŠ‚ç‚¹éœ€è¦æœ‰åŒæ ·çš„accessç§˜é’¥å’Œsecretç§˜é’¥ï¼Œè¿™æ ·è¿™äº›èŠ‚ç‚¹æ‰èƒ½å»ºç«‹è”æ¥ã€‚ä¸ºäº†å®ç°è¿™ä¸ªï¼Œä½ éœ€è¦åœ¨æ‰§è¡Œminio serverå‘½ä»¤ä¹‹å‰ï¼Œå…ˆå°†accessç§˜é’¥å’Œsecretç§˜é’¥exportæˆç¯å¢ƒå˜é‡ï¼Œæ–°ç‰ˆæœ¬ä½¿ç”¨MINIO_ROOT_USER å’Œ MINIO_ROOT_PASSWORDã€‚ åˆ†å¸ƒå¼Minioä½¿ç”¨çš„ç£ç›˜é‡Œå¿…é¡»æ˜¯å¹²å‡€çš„ï¼Œé‡Œé¢æ²¡æœ‰æ•°æ®ã€‚ ä¸‹é¢ç¤ºä¾‹é‡Œçš„IPä»…ä¾›ç¤ºä¾‹å‚è€ƒï¼Œä½ éœ€è¦æ”¹æˆä½ çœŸå®ç”¨åˆ°çš„IPå’Œæ–‡ä»¶å¤¹è·¯å¾„ã€‚ åˆ†å¸ƒå¼Minioé‡Œçš„èŠ‚ç‚¹æ—¶é—´å·®ä¸èƒ½è¶…è¿‡3ç§’ï¼Œä½ å¯ä»¥ä½¿ç”¨NTP æ¥ä¿è¯æ—¶é—´ä¸€è‡´ã€‚ åœ¨Windowsä¸‹è¿è¡Œåˆ†å¸ƒå¼Minioå¤„äºå®éªŒé˜¶æ®µï¼Œè¯·æ‚ ç€ç‚¹ä½¿ç”¨ã€‚ æ¯”å¦‚æˆ‘æ‰“ç®—ç”¨ä¸‰å°æœºå™¨éƒ¨ç½²åˆ†å¸ƒå¼é›†ç¾¤ï¼ŒæŒ‚è½½6å—ç›˜ 1ã€é¦–å…ˆï¼Œåœ¨ä¸‰å°æœºå™¨çš„ /usr/local/minio ç›®å½•ä¸‹ä¸‹è½½å¥½æˆ‘ä»¬çš„minioç¨‹åºï¼Œå¹¶æ·»åŠ ç¯å¢ƒå˜é‡ï¼š chmod +x minio export MINIO_ROOT_USER=admin export MINIO_ROOT_PASSWORD=Haier2022 2ã€åœ¨æ¯å°æœºå™¨ä¸Šï¼Œéƒ½æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå¯åŠ¨é›†ç¾¤ï¼š nohup /usr/local/minio/minio server --config-dir /minio/config --address ':9000' --console-address ':9001' \\ http://10.206.73.154/minio/data1 http://10.206.73.154/minio/data2\\ http://10.206.73.155/minio/data1 http://10.206.73.155/minio/data2\\ http://10.206.73.156/minio/data1 http://10.206.73.156/minio/data2&gt; /usr/local/minio/log.file 2&gt;&amp;1 &amp; ä½†æ˜¯å½“æˆ‘ä»¬æ‰§è¡Œæ—¶ï¼Œç»å¸¸ä¼šç¢°åˆ°è¿™ä¸ªé—®é¢˜ï¼š å³å¿…é¡»è¦ä½¿ç”¨æ–°çš„æŒ‚è½½ç£ç›˜ï¼Œä¸å¯ä»¥ä½¿ç”¨ä¸ç³»ç»Ÿrootç›®å½•ç›¸åŒçš„ç£ç›˜ï¼›è¿™æ—¶å€™æˆ‘ä»¬å°±è¦æƒ³åŠæ³•å…ˆç»™ç³»ç»ŸæŒ‚è½½ä¸€å—æ–°ç£ç›˜åˆ° /minio ç›®å½•ä¸Šï¼Œä¹‹åæ‰èƒ½è¿›è¡Œä¹‹åçš„æ“ä½œäº†ï¼ 3ã€æŒ‚è½½å®Œäº†ï¼Œä½†æ˜¯æˆ‘åªæœ‰ä¸€å—æœºå™¨æœ‰ç£ç›˜ï¼Œå°†å°±ä¸€ä¸‹ï¼š nohup /usr/local/minio/minio server --config-dir /minio/config --address ':9000' --console-address ':9001' \\ http://10.206.73.156/minio/data1 http://10.206.73.156/minio/data2 \\ http://10.206.73.156/minio/data3 http://10.206.73.156/minio/data4 \\ http://10.206.73.156/minio/data5 http://10.206.73.156/minio/data6&gt; /usr/local/minio/log.file 2&gt;&amp;1 &amp; 4ã€åœ¨minioçš„9001é¢æ¿ä¸­ï¼Œå¯¹æœåŠ¡è¿›è¡Œç›‘æ§ï¼š ","link":"https://tianxiawuhao.github.io/CIqmuU7wS/"},{"title":"å­˜å‚¨ç³»ç»Ÿæ­å»ºâ€”Cephé›†ç¾¤","content":"ä¸€ã€CephåŸºç¡€ç®€ä»‹ nfså­˜å‚¨æ–¹å¼åªèƒ½ç”¨äºå¼€å‘æµ‹è¯•ï¼Œç”Ÿäº§ç¯èŠ‚ç»å¯¹ä¸å¯ä»¥ç”¨ï¼Œæˆ‘ä»¬é€‰æ‹©Cephï¼ 1ã€Cephç®€ä»‹ Cephæ˜¯ä¸€ç§ä¸ºä¼˜ç§€çš„æ€§èƒ½ã€å¯é æ€§å’Œå¯æ‰©å±•æ€§è€Œè®¾è®¡çš„ç»Ÿä¸€çš„ã€åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿã€‚ 2ã€Cephé›†ç¾¤çš„å®‰è£…æ–¹å¼é€‰æ‹© å®˜æ–¹å®‰è£…æ–‡æ¡£ï¼šhttps://docs.ceph.com/en/pacific/install Cephadmå®‰è£…ï¼ˆæ¨èï¼‰ï¼š Rookå®‰è£…ï¼ˆæ¨èï¼‰ï¼šä½¿ç”¨Rookéƒ¨ç½²ä¸€ä¸ªèƒ½ç®¡ç†Cephé›†ç¾¤çš„ç³»ç»Ÿï¼Œä¸€æ­¥åˆ°ä½ï¼Rookå®˜ç½‘ï¼š å…¶ä»–æ–¹å¼ï¼ˆæ‰‹åŠ¨-ä¸æ¨èï¼‰ 3ã€Rookç®€ä»‹ï¼šhttps://www.rook.io/docs/rook/v1.7/quickstart.html Rookï¼šå­˜å‚¨ç¼–æ’ç³»ç»Ÿï¼› K8sï¼šå®¹å™¨ç¼–æ’ç³»ç»Ÿï¼› Rookçš„å·¥ä½œåŸç†ï¼š Rookçš„æ¶æ„è®¾è®¡ï¼š äºŒã€Rook+Cephçš„å®‰è£… 1ã€æŸ¥çœ‹å‰ææ¡ä»¶â€”â€”ç¡¬ä»¶è¦æ±‚ Raw devices (no partitions or formatted filesystems)ï¼› åŸå§‹ç£ç›˜ï¼Œæ— åˆ†åŒºæˆ–è€…æ ¼å¼åŒ– Raw partitions (no formatted filesystem)ï¼›åŸå§‹åˆ†åŒºï¼Œæ— æ ¼å¼åŒ–æ–‡ä»¶ç³»ç»Ÿ æ„æ€å°±æ˜¯ä¸è¦ä½¿ç”¨è‡ªå·±ç³»ç»Ÿå·²ç»ç”¨è¿‡çš„ç£ç›˜ï¼Œæœ€å¥½æ˜¯å¹²å‡€çš„å‡ å—ç£ç›˜ï¼Œå› ä¸ºCephåº•å±‚æœ‰è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆæ˜¯åŸºäºLVM2å¯æ‹“å±•çš„æ–‡ä»¶ç³»ç»Ÿï¼‰ fdisk -l æ‰¾åˆ°è‡ªå·±æŒ‚è½½çš„ç£ç›˜ å¦‚ï¼š Disk /dev/vdc: 107.4 GB, 107374182400 bytes, 209715200 sectors # æŸ¥çœ‹æ»¡è¶³è¦æ±‚çš„ lsblk -f ## ç»“æœï¼š vda â””â”€vda1 xfs 9cff3d69-3769-4ad9-8460-9c54050583f9 / vdb swap YUNIFYSWAP 48eb1df6-1663-4a52-ab30-040d552c2d76 vdc #æ²¡æœ‰ä»»ä½•æ–‡ä»¶ç³»ç»Ÿçš„å¹²å‡€ç£ç›˜ï¼Œå¯ç”¨ #äº‘å‚å•†éƒ½è¿™ä¹ˆç£ç›˜æ¸…0 dd if=/dev/zero of=/dev/vdc bs=1M status=progress 2ã€å‡çº§å†…æ ¸ å‡çº§å†…æ ¸ï¼ˆå¯é€‰ï¼‰ å¦‚æœä½ å°†ä½¿ç”¨ Ceph å…±äº«æ–‡ä»¶ç³»ç»Ÿï¼ˆCephFSï¼‰æ¥åˆ›å»ºå·ï¼ˆVolumesï¼‰ï¼Œåˆ™ rook å®˜æ–¹å»ºè®®ä½¿ç”¨è‡³å°‘ 4.17 ç‰ˆæœ¬çš„ Linux å†…æ ¸ã€‚å¦‚æœä½ ä½¿ç”¨çš„å†…æ ¸ç‰ˆæœ¬ä½äº 4.17ï¼Œåˆ™è¯·æ±‚çš„ Persistent Volume Claimï¼ˆPVCï¼‰å¤§å°å°†ä¸ä¼šè¢«å¼ºåˆ¶æ‰§è¡Œã€‚å­˜å‚¨é…é¢ï¼ˆStorage quotasï¼‰åªèƒ½åœ¨è¾ƒæ–°çš„å†…æ ¸ä¸Šå¾—åˆ°å¼ºåˆ¶æ‰§è¡Œã€‚ åœ¨ Kubernetes ä¸­ï¼ŒPVC ç”¨äºå‘å­˜å‚¨ç³»ç»Ÿè¯·æ±‚æŒ‡å®šå¤§å°çš„å­˜å‚¨ç©ºé—´ã€‚å¦‚æœè¯·æ±‚çš„ PVC å¤§å°æ— æ³•å¾—åˆ°å¼ºåˆ¶æ‰§è¡Œï¼Œåˆ™æ— æ³•ä¿è¯æ‰€è¯·æ±‚çš„å­˜å‚¨ç©ºé—´å¤§å°ã€‚ç”±äºå­˜å‚¨é…é¢åœ¨è¾ƒæ—§çš„å†…æ ¸ä¸Šæ— æ³•å¾—åˆ°å¼ºåˆ¶æ‰§è¡Œï¼Œå› æ­¤åœ¨ä½¿ç”¨ CephFS åˆ›å»ºå·æ—¶ï¼Œå¦‚æœä½¿ç”¨è¾ƒæ—§çš„å†…æ ¸ç‰ˆæœ¬ï¼Œåˆ™å¯èƒ½æ— æ³•æ­£ç¡®åœ°ç®¡ç†å’Œåˆ†é…å­˜å‚¨ç©ºé—´ã€‚å› æ­¤ï¼Œrook å®˜æ–¹å»ºè®®ä½¿ç”¨è‡³å°‘ 4.17 ç‰ˆæœ¬çš„å†…æ ¸ã€‚ åœ¨æ‰€æœ‰k8sèŠ‚ç‚¹å‡çº§å†…æ ¸ï¼Œä¹‹å‰å¿˜è®°è€ƒè™‘è¿™ä¸ªäº‹æƒ…ï¼Œä»¥åå¾—æå‰å‡çº§å¥½å†…æ ¸å†æ­å»ºk8sé›†ç¾¤ï¼Œè¿™ç§æƒ…å†µä¸‹å‡çº§å†…æ ¸ï¼Œå¾ˆéš¾ä¿è¯ä¸ä¼šå¯¹k8sé›†ç¾¤å¸¦æ¥ç›´æ¥å½±å“ã€‚æ³¨æ„äº†ï¼Œç”Ÿäº§ç¯å¢ƒå¯ä¸èƒ½è¿™ä¹ˆç©ï¼Œå¾—æå‰åšå¥½è§„åˆ’å’Œå‡†å¤‡ã€‚ æˆ‘çš„centos7å†…æ ¸å½“å‰ç‰ˆæœ¬ï¼š [root@k8s-a-node01 ~]# uname -r 3.10.0-1160.el7.x86_64 å¼€å§‹å‡çº§ rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org rpm -Uvh https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm yum --enablerepo=elrepo-kernel install kernel-ml-devel kernel-ml-headers kernel-ml -y grub2-set-default 0 grub2-mkconfig -o /boot/grub2/grub.cfg reboot uname -sr # å‡çº§å®ŒæˆåæŸ¥çœ‹å†…æ ¸ï¼Œå·²ç»æ»¡è¶³æ¡ä»¶ [root@k8s-a-node10 ~]# uname -sr Linux 6.2.9-1.el7.elrepo.x86_64 # çœ‹çœ‹k8sæ˜¯å¦æ­£å¸¸ï¼Œæˆ‘çš„æ²¡é—®é¢˜ï¼Œéå¸¸é¡ºåˆ©ã€‚ kubectl get nodes kubectl get pod -n kube-system 3ã€å…‹éš†Rookçš„gitä»“åº“ä»£ç  git clone --single-branch --branch v1.11.2 https://github.com/rook/rook.git cd rook/deploy/examples 4ã€ä¿®æ”¹å®‰è£…operator.yamlï¼š æŠŠæ–‡ä»¶ä¸­çš„é»˜è®¤é•œåƒä¿®æ”¹ä¸ºè‡ªå·±çš„ï¼š ##é¦–å…ˆæŠŠcephé•œåƒæ¢æˆæˆ‘ä»¬è‡ªå·±çš„ rook/ceph:v1.6.3 æ¢æˆ xxxx/rook-ceph:v1.6.3 ## å»ºè®®ä¿®æ”¹ä»¥ä¸‹çš„ä¸œè¥¿ã€‚åœ¨operator.yamlé‡Œé¢ ROOK_CSI_CEPH_IMAGE: &quot;xxxx/cephcsi:v3.3.1&quot; ROOK_CSI_REGISTRAR_IMAGE: &quot;xxxx/csi-node-driver-registrar:v2.0.1&quot; ROOK_CSI_RESIZER_IMAGE: &quot;xxxx/csi-resizer:v1.0.1&quot; ROOK_CSI_PROVISIONER_IMAGE: &quot;xxxx/csi-provisioner:v2.0.4&quot; ROOK_CSI_SNAPSHOTTER_IMAGE: &quot;xxxx/csi-snapshotter:v4.0.0&quot; ROOK_CSI_ATTACHER_IMAGE: &quot;xxxx/csi-attacher:v3.0.2&quot; å®‰è£…operatorï¼š kubectl create -f crds.yaml -f common.yaml -f operator.yaml # åœ¨ç»§ç»­æ“ä½œä¹‹å‰ï¼ŒéªŒè¯ rook-ceph-operator æ˜¯å¦æ­£å¸¸è¿è¡Œ kubectl get deployment -n rook-ceph kubectl get pod -n rook-ceph 5ã€ä¿®æ”¹ cluster.yamlä¸­çš„é›†ç¾¤ä¿¡æ¯ï¼š å› ä¸ºé»˜è®¤æ˜¯ä½¿ç”¨æ‰€æœ‰èŠ‚ç‚¹ï¼Œå¦‚æœæˆ‘ä»¬ä¸é€‚ç”¨æ‰€æœ‰èŠ‚ç‚¹ï¼Œåˆ™éœ€è¦åšä»¥ä¸‹ä¿®æ”¹ï¼š storage: # cluster level storage configuration and selection # resources ç”Ÿäº§ç¯å¢ƒå°½é‡é…ç½®å¤§ä¸€ç‚¹ï¼Œæµ‹è¯•ç¯å¢ƒä¸ç”¨åŠ¨ã€‚ # useAllNodes: false æ˜¯å¦ç”¨æ‰€æœ‰èŠ‚ç‚¹ é»˜è®¤ç”¨æ‰€æœ‰ # useAllDevices: false æ˜¯å¦ç”¨æ‰€æœ‰è®¾å¤‡ é»˜è®¤ç”¨æ‰€æœ‰ useAllNodes: false useAllDevices: false config: osdsPerDevice: &quot;3&quot; #æ¯ä¸ªè®¾å¤‡osdæ•°é‡ nodes: - name: &quot;k8s-node3&quot; devices: - name: &quot;vdc&quot; - name: &quot;k8s-node1&quot; devices: - name: &quot;vdc&quot; - name: &quot;k8s-node2&quot; devices: - name: &quot;vdc&quot; 6ã€æ­£å¼å®‰è£…é›†ç¾¤ï¼š kubectl apply -f cluster.yaml æ¼«é•¿ç­‰å¾…ï¼Œéƒ¨ç½²æˆåŠŸåçš„podæ•°é‡ï¼š [root@master01 examples]# kubectl get pod -n rook-ceph NAME READY STATUS RESTARTS AGE IP NODE csi-cephfsplugin-74xkg 3/3 Running 0 125m 10.233.96.16 node2 csi-cephfsplugin-98xmt 3/3 Running 0 125m 10.233.90.14 node1 csi-cephfsplugin-provisioner-5d498c4bdd-vq2pc 6/6 Running 0 125m 10.233.90.15 node1 csi-cephfsplugin-provisioner-5d498c4bdd-x97g7 6/6 Running 0 125m 10.233.96.17 node2 csi-cephfsplugin-zknsc 3/3 Running 0 118m 10.233.70.14 master csi-rbdplugin-provisioner-7bd657db4c-6cl6r 6/6 Running 0 125m 10.233.96.15 node2 csi-rbdplugin-provisioner-7bd657db4c-tg4d2 6/6 Running 0 125m 10.233.90.13 node1 csi-rbdplugin-skx2m 3/3 Running 0 118m 10.233.70.12 master csi-rbdplugin-t86nx 3/3 Running 0 125m 10.233.96.14 node2 csi-rbdplugin-vww89 3/3 Running 0 125m 10.233.90.12 node1 rook-ceph-crashcollector-master-58b49b5db6-m9m5v 1/1 Running 0 11m 10.233.70.21 master rook-ceph-crashcollector-node1-5965f9db96-ncgm8 1/1 Running 0 12m 10.233.90.28 node1 rook-ceph-crashcollector-node2-7d67bb865-sh2ch 1/1 Running 0 11m 10.233.96.39 node2 rook-ceph-mgr-a-7bd599b466-bgkqg 1/1 Running 0 12m 10.233.96.35 node2 rook-ceph-mon-a-6ff5f6b6cb-99mcz 1/1 Running 0 18m 10.233.90.25 node1 rook-ceph-mon-c-5cf8b995b5-pxssc 1/1 Running 0 14m 10.233.96.33 node2 rook-ceph-mon-d-6cd9c57459-pr5dp 1/1 Running 0 11m 10.233.70.22 master rook-ceph-operator-5bbbb569df-5nbh9 1/1 Running 0 150m 10.233.96.12 node2 rook-ceph-osd-0-64b57fd54c-trmt5 1/1 Running 0 11m 10.233.90.29 node1 rook-ceph-osd-1-6b7568d5c7-bzt9v 1/1 Running 0 11m 10.233.96.38 node2 rook-ceph-osd-prepare-node1-2vhbd 0/1 Completed 0 10m 10.233.90.33 node1 rook-ceph-osd-prepare-node2-646sj 0/1 Completed 0 10m 10.233.96.41 node2 7ã€éªŒè¯cephé›†ç¾¤ è¦éªŒè¯ç¾¤é›†æ˜¯å¦å¤„äºæ­£å¸¸çŠ¶æ€ï¼Œå¯ä»¥è¿æ¥åˆ° toolbox å·¥å…·ç®±å¹¶è¿è¡Œå‘½ä»¤ kubectl create -f toolbox.yaml kubectl -n rook-ceph exec -it deploy/rook-ceph-tools -- bash # è¿›å»ä¹‹åå°±å¯ä»¥æ‰§è¡Œå„ç§å‘½ä»¤äº†ï¼š ceph status ceph osd status ceph df rados df # çœ‹çœ‹æˆ‘çš„ [root@k8s-a-master examples]kubectl -n rook-ceph exec -it deploy/rook-ceph-tools -- bash bash-4.4$ ceph -s cluster: id: 0b64957b-9aaa-43ef-9946-211ca911dc92 health: HEALTH_OK services: mon: 3 daemons, quorum a,b,c (age 3m) mgr: a(active, since 64s), standbys: b osd: 3 osds: 3 up (since 116s), 3 in (since 2m) data: pools: 1 pools, 1 pgs objects: 2 objects, 449 KiB usage: 234 MiB used, 9.8 TiB / 9.8 TiB avail pgs: 1 active+clean bash-4.4$ ceph osd status ID HOST USED AVAIL WR OPS WR DATA RD OPS RD DATA STATE 0 k8s-a-node02 23.9M 999G 0 0 0 0 exists,up 1 k8s-a-node03 20.9M 999G 0 0 0 0 exists,up 2 k8s-a-node01 23.8M 999G 0 0 0 0 exists,up æ¯ä¸ª OSD éƒ½æœ‰ä¸€ä¸ªçŠ¶æ€ï¼Œå¯ä»¥æ˜¯ä»¥ä¸‹å‡ ç§ä¹‹ä¸€ï¼š upï¼šè¡¨ç¤ºè¯¥ OSD æ­£å¸¸è¿è¡Œï¼Œå¹¶ä¸”å¯ä»¥å¤„ç†æ•°æ®è¯·æ±‚ã€‚ downï¼šè¡¨ç¤ºè¯¥ OSD å½“å‰æ— æ³•è¿è¡Œæˆ–ä¸å¯ç”¨ï¼Œå¯èƒ½ç”±äºç¡¬ä»¶æ•…éšœæˆ–è½¯ä»¶é—®é¢˜ã€‚ outï¼šè¡¨ç¤ºè¯¥ OSD ä¸å‚ä¸æ•°æ®å­˜å‚¨æˆ–æ¢å¤ï¼Œè¿™é€šå¸¸æ˜¯ç”±äºç®¡ç†å‘˜æ‰‹åŠ¨å°†å…¶æ ‡è®°ä¸ºä¸å¯ç”¨ã€‚ existsï¼šè¡¨ç¤ºè¯¥ OSD é…ç½®å­˜åœ¨ï¼Œä½†å°šæœªå¯åŠ¨æˆ–åŠ å…¥é›†ç¾¤ã€‚ 8ã€ç¡®ä¿mgr-dashboardè¿™ä¸ªserviceæ˜¯å¯ä»¥è®¿é—®çš„ [root@master ceph]# kubectl get svc -n rook-ceph NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE csi-cephfsplugin-metrics ClusterIP 10.233.24.242 &lt;none&gt; 8080/TCP,8081/TCP 129m csi-rbdplugin-metrics ClusterIP 10.233.1.189 &lt;none&gt; 8080/TCP,8081/TCP 129m rook-ceph-mgr ClusterIP 10.233.57.190 &lt;none&gt; 9283/TCP 15m rook-ceph-mgr-dashboard ClusterIP 10.233.59.74 &lt;none&gt; 8443/TCP 15m rook-ceph-mon-a ClusterIP 10.233.2.171 &lt;none&gt; 6789/TCP,3300/TCP 22m rook-ceph-mon-c ClusterIP 10.233.51.168 &lt;none&gt; 6789/TCP,3300/TCP 18m rook-ceph-mon-d ClusterIP 10.233.58.171 &lt;none&gt; 6789/TCP,3300/TCP 14m rook-ceph-mgrï¼šæ˜¯ Ceph çš„ç®¡ç†è¿›ç¨‹ï¼ˆManagerï¼‰ï¼Œè´Ÿè´£é›†ç¾¤çš„ç›‘æ§ã€çŠ¶æ€æŠ¥å‘Šã€æ•°æ®åˆ†æã€è°ƒåº¦ç­‰åŠŸèƒ½ï¼Œå®ƒé»˜è®¤ç›‘å¬ 9283 ç«¯å£ï¼Œå¹¶æä¾›äº† Prometheus æ ¼å¼çš„ç›‘æ§æŒ‡æ ‡ï¼Œå¯ä»¥è¢« Prometheus æ‹‰å–å¹¶ç”¨äºé›†ç¾¤ç›‘æ§ã€‚ rook-ceph-mgr-dashboardï¼šæ˜¯ Rook æä¾›çš„ä¸€ä¸ª Web ç•Œé¢ï¼Œç”¨äºæ–¹ä¾¿åœ°æŸ¥çœ‹ Ceph é›†ç¾¤çš„ç›‘æ§ä¿¡æ¯ã€çŠ¶æ€ã€æ€§èƒ½æŒ‡æ ‡ç­‰ã€‚ rook-ceph-monï¼šæ˜¯ Ceph Monitor è¿›ç¨‹çš„ Kubernetes æœåŠ¡ã€‚Ceph Monitor æ˜¯ Ceph é›†ç¾¤çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œè´Ÿè´£ç»´æŠ¤ Ceph é›†ç¾¤çš„çŠ¶æ€ã€æ‹“æ‰‘ç»“æ„ã€æ•°æ®åˆ†å¸ƒç­‰ä¿¡æ¯ï¼Œæ˜¯ Ceph é›†ç¾¤çš„ç®¡ç†èŠ‚ç‚¹ã€‚ 9ã€ä½¿ç”¨ NodePort ç±»å‹çš„Serviceæš´éœ²dashboard dashboard-external-https.yaml apiVersion: v1 kind: Service metadata: name: rook-ceph-mgr-dashboard-external-https namespace: rook-ceph labels: app: rook-ceph-mgr rook_cluster: rook-ceph spec: ports: - name: dashboard port: 8443 protocol: TCP targetPort: 8443 selector: app: rook-ceph-mgr rook_cluster: rook-ceph sessionAffinity: None type: NodePort 10ã€åˆ›å»ºåNodePortç±»çš„svcåæŸ¥çœ‹ [root@k8s-a-master examples]# kubectl get svc -n rook-ceph NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE rook-ceph-mgr ClusterIP 10.96.58.93 &lt;none&gt; 9283/TCP 28m rook-ceph-mgr-dashboard ClusterIP 10.103.131.77 &lt;none&gt; 8443/TCP 28m # è®°å¾—å¹²æ‰ rook-ceph-mgr-dashboard-external-https NodePort 10.107.247.53 &lt;none&gt; 8443:32564/TCP 9m38s rook-ceph-mon-a ClusterIP 10.98.168.35 &lt;none&gt; 6789/TCP,3300/TCP 29m rook-ceph-mon-b ClusterIP 10.103.127.134 &lt;none&gt; 6789/TCP,3300/TCP 29m rook-ceph-mon-c ClusterIP 10.111.46.187 &lt;none&gt; 6789/TCP,3300/TCP 29m ä¸‰ã€Cephçš„åç»­ä½¿ç”¨ Cephçš„åå°çš„ç®¡ç†å‘˜è´¦å·ä¸ºadminï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘è¿˜æ˜¯æ¢æˆäº†NodePortçš„æ–¹å¼æš´éœ²Dashboardäº†ï¼ 1ã€è·å–Cephåå°çš„é»˜è®¤è®¿é—®å¯†ç ï¼š [root@master ceph]# kubectl -n rook-ceph get secret rook-ceph-dashboard-password -o jsonpath=&quot;{['data']['password']}&quot; | base64 --decode &amp;&amp; echo JXr&quot;@`8)_?]7%GwP,(C^ åå°å¦‚å›¾ï¼š ç™»å½•å®Œï¼Œå³ä¸Šè§’ä¿®æ”¹ä»¥ä¸‹å¯†ç ï¼ 2ã€åˆ›å»ºå­˜å‚¨æ± +StorageClassâ€”â€”block-ceph.yamlâ€”â€”ç”¨äºå—å­˜å‚¨çš„StorageClass apiVersion: ceph.rook.io/v1 kind: CephBlockPool metadata: name: replicapool namespace: rook-ceph spec: failureDomain: host #å®¹ç¾æ¨¡å¼ï¼Œhostæˆ–è€…osd replicated: size: 2 #æ•°æ®å‰¯æœ¬æ•°é‡ --- apiVersion: storage.k8s.io/v1 kind: StorageClass #å­˜å‚¨é©±åŠ¨ metadata: name: rook-ceph-block # Change &quot;rook-ceph&quot; provisioner prefix to match the operator namespace if needed provisioner: rook-ceph.rbd.csi.ceph.com parameters: # clusterID is the namespace where the rook cluster is running clusterID: rook-ceph # Ceph pool into which the RBD image shall be created pool: replicapool # (optional) mapOptions is a comma-separated list of map options. # For krbd options refer # https://docs.ceph.com/docs/master/man/8/rbd/#kernel-rbd-krbd-options # For nbd options refer # https://docs.ceph.com/docs/master/man/8/rbd-nbd/#options # mapOptions: lock_on_read,queue_depth=1024 # (optional) unmapOptions is a comma-separated list of unmap options. # For krbd options refer # https://docs.ceph.com/docs/master/man/8/rbd/#kernel-rbd-krbd-options # For nbd options refer # https://docs.ceph.com/docs/master/man/8/rbd-nbd/#options # unmapOptions: force # RBD image format. Defaults to &quot;2&quot;. imageFormat: &quot;2&quot; # RBD image features. Available for imageFormat: &quot;2&quot;. CSI RBD currently supports only `layering` feature. imageFeatures: layering # The secrets contain Ceph admin credentials. csi.storage.k8s.io/provisioner-secret-name: rook-csi-rbd-provisioner csi.storage.k8s.io/provisioner-secret-namespace: rook-ceph csi.storage.k8s.io/controller-expand-secret-name: rook-csi-rbd-provisioner csi.storage.k8s.io/controller-expand-secret-namespace: rook-ceph csi.storage.k8s.io/node-stage-secret-name: rook-csi-rbd-node csi.storage.k8s.io/node-stage-secret-namespace: rook-ceph # Specify the filesystem type of the volume. If not specified, csi-provisioner # will set default as `ext4`. Note that `xfs` is not recommended due to potential deadlock # in hyperconverged settings where the volume is mounted on the same node as the osds. csi.storage.k8s.io/fstype: ext4 # Delete the rbd volume when a PVC is deleted reclaimPolicy: Delete allowVolumeExpansion: true 3ã€*åˆ›å»ºå­˜å‚¨æ± **+StorageClass**â€”â€”cephfs-ceph.yamlâ€”â€”ç”¨äºå…±äº«æ–‡ä»¶å­˜å‚¨çš„StorageClass* apiVersion: ceph.rook.io/v1 kind: CephFilesystem metadata: name: myfs namespace: rook-ceph # namespace:cluster spec: # The metadata pool spec. Must use replication. metadataPool: replicated: size: 2 requireSafeReplicaSize: true parameters: # Inline compression mode for the data pool # Further reference: https://docs.ceph.com/docs/nautilus/rados/configuration/bluestore-config-ref/#inline-compression compression_mode: none # gives a hint (%) to Ceph in terms of expected consumption of the total cluster capacity of a given pool # for more info: https://docs.ceph.com/docs/master/rados/operations/placement-groups/#specifying-expected-pool-size #target_size_ratio: &quot;.5&quot; # The list of data pool specs. Can use replication or erasure coding. dataPools: - failureDomain: host replicated: size: 2 # Disallow setting pool with replica 1, this could lead to data loss without recovery. # Make sure you're *ABSOLUTELY CERTAIN* that is what you want requireSafeReplicaSize: true parameters: # Inline compression mode for the data pool # Further reference: https://docs.ceph.com/docs/nautilus/rados/configuration/bluestore-config-ref/#inline-compression compression_mode: none # gives a hint (%) to Ceph in terms of expected consumption of the total cluster capacity of a given pool # for more info: https://docs.ceph.com/docs/master/rados/operations/placement-groups/#specifying-expected-pool-size #target_size_ratio: &quot;.5&quot; # Whether to preserve filesystem after CephFilesystem CRD deletion preserveFilesystemOnDelete: true # The metadata service (mds) configuration metadataServer: # The number of active MDS instances activeCount: 1 # Whether each active MDS instance will have an active standby with a warm metadata cache for faster failover. # If false, standbys will be available, but will not have a warm cache. activeStandby: true # The affinity rules to apply to the mds deployment placement: # nodeAffinity: # requiredDuringSchedulingIgnoredDuringExecution: # nodeSelectorTerms: # - matchExpressions: # - key: role # operator: In # values: # - mds-node # topologySpreadConstraints: # tolerations: # - key: mds-node # operator: Exists # podAffinity: podAntiAffinity: requiredDuringSchedulingIgnoredDuringExecution: - labelSelector: matchExpressions: - key: app operator: In values: - rook-ceph-mds # topologyKey: kubernetes.io/hostname will place MDS across different hosts topologyKey: kubernetes.io/hostname preferredDuringSchedulingIgnoredDuringExecution: - weight: 100 podAffinityTerm: labelSelector: matchExpressions: - key: app operator: In values: - rook-ceph-mds # topologyKey: */zone can be used to spread MDS across different AZ # Use &lt;topologyKey: failure-domain.beta.kubernetes.io/zone&gt; in k8s cluster if your cluster is v1.16 or lower # Use &lt;topologyKey: topology.kubernetes.io/zone&gt; in k8s cluster is v1.17 or upper topologyKey: topology.kubernetes.io/zone # A key/value list of annotations annotations: # key: value # A key/value list of labels labels: # key: value resources: # The requests and limits set here, allow the filesystem MDS Pod(s) to use half of one CPU core and 1 gigabyte of memory # limits: # cpu: &quot;500m&quot; # memory: &quot;1024Mi&quot; # requests: # cpu: &quot;500m&quot; # memory: &quot;1024Mi&quot; # priorityClassName: my-priority-class mirroring: enabled: false --- apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: rook-cephfs # annotations: # storageclass.kubernetes.io/is-default-class: &quot;true&quot; # Change &quot;rook-ceph&quot; provisioner prefix to match the operator namespace if needed provisioner: rook-ceph.cephfs.csi.ceph.com parameters: # clusterID is the namespace where operator is deployed. clusterID: rook-ceph # CephFS filesystem name into which the volume shall be created fsName: myfs # Ceph pool into which the volume shall be created # Required for provisionVolume: &quot;true&quot; pool: myfs-data0 # The secrets contain Ceph admin credentials. These are generated automatically by the operator # in the same namespace as the cluster. csi.storage.k8s.io/provisioner-secret-name: rook-csi-cephfs-provisioner csi.storage.k8s.io/provisioner-secret-namespace: rook-ceph csi.storage.k8s.io/controller-expand-secret-name: rook-csi-cephfs-provisioner csi.storage.k8s.io/controller-expand-secret-namespace: rook-ceph csi.storage.k8s.io/node-stage-secret-name: rook-csi-cephfs-node csi.storage.k8s.io/node-stage-secret-namespace: rook-ceph reclaimPolicy: Delete allowVolumeExpansion: true ä¸Šé¢ä¸¤ä¸ªStorageClasséƒ½åˆ›å»ºå®Œæˆåï¼Œå¯ä»¥å†åå°å­˜å‚¨æ± ä¸­çœ‹åˆ°ï¼š 4ã€å½“StorageClasséƒ½å‡†å¤‡å¥½ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æŸ¥çœ‹åˆ°äº†ï¼š [root@master ceph]# kubectl get sc -A NAME PROVISIONER RECLAIMPOLICY VOLUMEBINDINGMODE ALLOWVOLUMEEXPANSION AGE local (default) openebs.io/local Delete WaitForFirstConsumer false 24h rook-ceph-block rook-ceph.rbd.csi.ceph.com Delete Immediate true 22m rook-cephfs rook-ceph.cephfs.csi.ceph.com Delete Immediate true 3m26s ä¹‹åï¼Œåœ¨ç”³è¯·pvcçš„æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦æŒ‡å®šå¯¹åº”çš„StorageClasså³å¯ï¼ ","link":"https://tianxiawuhao.github.io/nfaGbmKb_/"},{"title":"Clickhouseä¼˜ç¼ºç‚¹åŠæ€§èƒ½æƒ…å†µ","content":"ä¼˜ç‚¹ï¼š 1ï¼Œä¸ºäº†é«˜æ•ˆçš„ä½¿ç”¨CPUï¼Œæ•°æ®ä¸ä»…ä»…æŒ‰åˆ—å­˜å‚¨ï¼ŒåŒæ—¶è¿˜æŒ‰å‘é‡è¿›è¡Œå¤„ç†ï¼› 2ï¼Œæ•°æ®å‹ç¼©ç©ºé—´å¤§ï¼Œå‡å°‘IOï¼›å¤„ç†å•æŸ¥è¯¢é«˜ååé‡æ¯å°æœåŠ¡å™¨æ¯ç§’æœ€å¤šæ•°åäº¿è¡Œï¼› 3ï¼Œç´¢å¼•éBæ ‘ç»“æ„ï¼Œä¸éœ€è¦æ»¡è¶³æœ€å·¦åŸåˆ™ï¼›åªè¦è¿‡æ»¤æ¡ä»¶åœ¨ç´¢å¼•åˆ—ä¸­åŒ…å«å³å¯ï¼›å³ä½¿åœ¨ä½¿ç”¨çš„æ•°æ®ä¸åœ¨ç´¢å¼•ä¸­ï¼Œç”±äºå„ç§å¹¶è¡Œå¤„ç†æœºåˆ¶ClickHouseå…¨è¡¨æ‰«æçš„é€Ÿåº¦ä¹Ÿå¾ˆå¿«ï¼› 4ï¼Œå†™å…¥é€Ÿåº¦éå¸¸å¿«ï¼Œ50-200M/sï¼Œå¯¹äºå¤§é‡çš„æ•°æ®æ›´æ–°éå¸¸é€‚ç”¨ã€‚ ç¼ºç‚¹ï¼š 1ï¼Œä¸æ”¯æŒäº‹åŠ¡ï¼Œä¸æ”¯æŒçœŸæ­£çš„åˆ é™¤/æ›´æ–°ï¼› 2ï¼Œä¸æ”¯æŒé«˜å¹¶å‘ï¼Œå®˜æ–¹å»ºè®®qpsä¸º100ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶å¢åŠ è¿æ¥æ•°ï¼Œä½†æ˜¯åœ¨æœåŠ¡å™¨è¶³å¤Ÿå¥½çš„æƒ…å†µä¸‹ï¼› 3ï¼ŒSQLæ»¡è¶³æ—¥å¸¸ä½¿ç”¨80%ä»¥ä¸Šçš„è¯­æ³•ï¼Œjoinå†™æ³•æ¯”è¾ƒç‰¹æ®Šï¼›æœ€æ–°ç‰ˆå·²æ”¯æŒç±»ä¼¼SQLçš„joinï¼Œä½†æ€§èƒ½ä¸å¥½ï¼› 4ï¼Œå°½é‡åš1000æ¡ä»¥ä¸Šæ‰¹é‡çš„å†™å…¥ï¼Œé¿å…é€è¡Œinsertæˆ–å°æ‰¹é‡çš„insertï¼Œupdateï¼Œdeleteæ“ä½œï¼Œå› ä¸ºClickHouseåº•å±‚ä¼šä¸æ–­çš„åšå¼‚æ­¥çš„æ•°æ®åˆå¹¶ï¼Œä¼šå½±å“æŸ¥è¯¢æ€§èƒ½ï¼Œè¿™ä¸ªåœ¨åšå®æ—¶æ•°æ®å†™å…¥çš„æ—¶å€™è¦å°½é‡é¿å¼€ï¼› 5ï¼ŒClickhouseå¿«æ˜¯å› ä¸ºé‡‡ç”¨äº†å¹¶è¡Œå¤„ç†æœºåˆ¶ï¼Œå³ä½¿ä¸€ä¸ªæŸ¥è¯¢ï¼Œä¹Ÿä¼šç”¨æœåŠ¡å™¨ä¸€åŠçš„CPUå»æ‰§è¡Œï¼Œæ‰€ä»¥ClickHouseä¸èƒ½æ”¯æŒé«˜å¹¶å‘çš„ä½¿ç”¨åœºæ™¯ï¼Œé»˜è®¤å•æŸ¥è¯¢ä½¿ç”¨CPUæ ¸æ•°ä¸ºæœåŠ¡å™¨æ ¸æ•°çš„ä¸€åŠï¼Œå®‰è£…æ—¶ä¼šè‡ªåŠ¨è¯†åˆ«æœåŠ¡å™¨æ ¸æ•°ï¼Œå¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶ä¿®æ”¹è¯¥å‚æ•°ã€‚ å…¨é‡æ•°æ®å¯¼å…¥ï¼šæ•°æ®å¯¼å…¥ä¸´æ—¶è¡¨ -&gt; å¯¼å…¥å®Œæˆåï¼Œå°†åŸè¡¨æ”¹åä¸ºtmp1 -&gt; å°†ä¸´æ—¶è¡¨æ”¹åä¸ºæ­£å¼è¡¨ -&gt; åˆ é™¤åŸè¡¨ å¢é‡æ•°æ®å¯¼å…¥ï¼š å¢é‡æ•°æ®å¯¼å…¥ä¸´æ—¶è¡¨ -&gt; å°†åŸæ•°æ®é™¤å¢é‡å¤–çš„ä¹Ÿå¯¼å…¥ä¸´æ—¶è¡¨ -&gt; å¯¼å…¥å®Œæˆåï¼Œå°†åŸè¡¨æ”¹åä¸ºtmp1-&gt; å°†ä¸´æ—¶è¡¨æ”¹æˆæ­£å¼è¡¨-&gt; åˆ é™¤åŸæ•°æ®è¡¨ ç›¸å…³ä¼˜åŒ–ï¼š 1ï¼Œå…³é—­è™šæ‹Ÿå†…å­˜ï¼Œç‰©ç†å†…å­˜å’Œè™šæ‹Ÿå†…å­˜çš„æ•°æ®äº¤æ¢ï¼Œä¼šå¯¼è‡´æŸ¥è¯¢å˜æ…¢ã€‚ 2ï¼Œä¸ºæ¯ä¸€ä¸ªè´¦æˆ·æ·»åŠ join_use_nullsé…ç½®ï¼Œå·¦è¡¨ä¸­çš„ä¸€æ¡è®°å½•åœ¨å³è¡¨ä¸­ä¸å­˜åœ¨ï¼Œå³è¡¨çš„ç›¸åº”å­—æ®µä¼šè¿”å›è¯¥å­—æ®µç›¸åº”æ•°æ®ç±»å‹çš„é»˜è®¤å€¼ï¼Œè€Œä¸æ˜¯æ ‡å‡†SQLä¸­çš„Nullå€¼ã€‚ 3ï¼ŒJOINæ“ä½œæ—¶ä¸€å®šè¦æŠŠæ•°æ®é‡å°çš„è¡¨æ”¾åœ¨å³è¾¹ï¼ŒClickHouseä¸­æ— è®ºæ˜¯Left Join ã€Right Joinè¿˜æ˜¯Inner Joinæ°¸è¿œéƒ½æ˜¯æ‹¿ç€å³è¡¨ä¸­çš„æ¯ä¸€æ¡è®°å½•åˆ°å·¦è¡¨ä¸­æŸ¥æ‰¾è¯¥è®°å½•æ˜¯å¦å­˜åœ¨ï¼Œæ‰€ä»¥å³è¡¨å¿…é¡»æ˜¯å°è¡¨ã€‚ 4ï¼Œæ‰¹é‡å†™å…¥æ•°æ®æ—¶ï¼Œå¿…é¡»æ§åˆ¶æ¯ä¸ªæ‰¹æ¬¡çš„æ•°æ®ä¸­æ¶‰åŠåˆ°çš„åˆ†åŒºçš„æ•°é‡ï¼Œåœ¨å†™å…¥ä¹‹å‰æœ€å¥½å¯¹éœ€è¦å¯¼å…¥çš„æ•°æ®è¿›è¡Œæ’åºã€‚æ— åºçš„æ•°æ®æˆ–è€…æ¶‰åŠçš„åˆ†åŒºå¤ªå¤šï¼Œä¼šå¯¼è‡´ClickHouseæ— æ³•åŠæ—¶å¯¹æ–°å¯¼å…¥çš„æ•°æ®è¿›è¡Œåˆå¹¶ï¼Œä»è€Œå½±å“æŸ¥è¯¢æ€§èƒ½ã€‚ 5ï¼Œå°½é‡å‡å°‘JOINæ—¶çš„å·¦å³è¡¨çš„æ•°æ®é‡ï¼Œå¿…è¦æ—¶å¯ä»¥æå‰å¯¹æŸå¼ è¡¨è¿›è¡Œèšåˆæ“ä½œï¼Œå‡å°‘æ•°æ®æ¡æ•°ã€‚æœ‰äº›æ—¶å€™ï¼Œå…ˆGROUP BYå†JOINæ¯”å…ˆJOINå†GROUP BYæŸ¥è¯¢æ—¶é—´æ›´çŸ­ã€‚ 6ï¼ŒClickHouseçš„åˆ†å¸ƒå¼è¡¨æ€§èƒ½æ€§ä»·æ¯”ä¸å¦‚ç‰©ç†è¡¨é«˜ï¼Œå»ºè¡¨åˆ†åŒºå­—æ®µå€¼ä¸å®œè¿‡å¤šï¼Œé˜²æ­¢æ•°æ®å¯¼å…¥è¿‡ç¨‹ç£ç›˜å¯èƒ½ä¼šè¢«æ‰“æ»¡ã€‚ 7ï¼ŒCPUä¸€èˆ¬åœ¨50%å·¦å³ä¼šå‡ºç°æŸ¥è¯¢æ³¢åŠ¨ï¼Œè¾¾åˆ°70%ä¼šå‡ºç°å¤§èŒƒå›´çš„æŸ¥è¯¢è¶…æ—¶ï¼ŒCPUæ˜¯æœ€å…³é”®çš„æŒ‡æ ‡ï¼Œè¦éå¸¸å…³æ³¨ã€‚ æ€§èƒ½æƒ…å†µ 1,å•ä¸ªæŸ¥è¯¢ååé‡ï¼šå¦‚æœæ•°æ®è¢«æ”¾ç½®åœ¨page cacheä¸­ï¼Œåˆ™ä¸€ä¸ªä¸å¤ªå¤æ‚çš„æŸ¥è¯¢åœ¨å•ä¸ªæœåŠ¡å™¨ä¸Šå¤§çº¦èƒ½å¤Ÿä»¥2-10GBï¼sï¼ˆæœªå‹ç¼©ï¼‰çš„é€Ÿåº¦è¿›è¡Œå¤„ç†ï¼ˆå¯¹äºç®€å•çš„æŸ¥è¯¢ï¼Œé€Ÿåº¦å¯ä»¥è¾¾åˆ°30GBï¼sï¼‰ã€‚å¦‚æœæ•°æ®æ²¡æœ‰åœ¨page cacheä¸­çš„è¯ï¼Œé‚£ä¹ˆé€Ÿåº¦å°†å–å†³äºä½ çš„ç£ç›˜ç³»ç»Ÿå’Œæ•°æ®çš„å‹ç¼©ç‡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªç£ç›˜å…è®¸ä»¥400MBï¼sçš„é€Ÿåº¦è¯»å–æ•°æ®ï¼Œå¹¶ä¸”æ•°æ®å‹ç¼©ç‡æ˜¯3ï¼Œåˆ™æ•°æ®çš„å¤„ç†é€Ÿåº¦ä¸º1.2GB/sã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœä½ æ˜¯åœ¨æå–ä¸€ä¸ª10å­—èŠ‚çš„åˆ—ï¼Œé‚£ä¹ˆå®ƒçš„å¤„ç†é€Ÿåº¦å¤§çº¦æ˜¯1-2äº¿è¡Œæ¯ç§’ã€‚å¯¹äºåˆ†å¸ƒå¼å¤„ç†ï¼Œå¤„ç†é€Ÿåº¦å‡ ä¹æ˜¯çº¿æ€§æ‰©å±•çš„ï¼Œä½†è¿™å—é™äºèšåˆæˆ–æ’åºçš„ç»“æœä¸æ˜¯é‚£ä¹ˆå¤§çš„æƒ…å†µä¸‹ã€‚ 2ï¼Œå¤„ç†çŸ­æŸ¥è¯¢çš„å»¶æ—¶æ—¶é—´ï¼šæ•°æ®è¢«page cacheç¼“å­˜çš„æƒ…å†µä¸‹ï¼Œå®ƒçš„å»¶è¿Ÿåº”è¯¥å°äº50æ¯«ç§’(æœ€ä½³æƒ…å†µä¸‹åº”è¯¥å°äº10æ¯«ç§’)ã€‚ å¦åˆ™ï¼Œå»¶è¿Ÿå–å†³äºæ•°æ®çš„æŸ¥æ‰¾æ¬¡æ•°ã€‚å»¶è¿Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹å…¬å¼è®¡ç®—å¾—çŸ¥ï¼š æŸ¥æ‰¾æ—¶é—´ï¼ˆ10 msï¼‰ * æŸ¥è¯¢çš„åˆ—çš„æ•°é‡ * æŸ¥è¯¢çš„æ•°æ®å—çš„æ•°é‡ã€‚ 3ï¼Œå¤„ç†å¤§é‡çŸ­æŸ¥è¯¢ï¼šClickHouseå¯ä»¥åœ¨å•ä¸ªæœåŠ¡å™¨ä¸Šæ¯ç§’å¤„ç†æ•°ç™¾ä¸ªæŸ¥è¯¢ï¼ˆåœ¨æœ€ä½³çš„æƒ…å†µä¸‹æœ€å¤šå¯ä»¥å¤„ç†æ•°åƒä¸ªï¼‰ã€‚ä½†æ˜¯ç”±äºè¿™ä¸é€‚ç”¨äºåˆ†æå‹åœºæ™¯ã€‚å»ºè®®æ¯ç§’æœ€å¤šæŸ¥è¯¢100æ¬¡ã€‚ 4ï¼Œæ•°æ®å†™å…¥æ€§èƒ½ï¼šå»ºè®®æ¯æ¬¡å†™å…¥ä¸å°‘äº1000è¡Œçš„æ‰¹é‡å†™å…¥ï¼Œæˆ–æ¯ç§’ä¸è¶…è¿‡ä¸€ä¸ªå†™å…¥è¯·æ±‚ã€‚å½“ä½¿ç”¨tab-separatedæ ¼å¼å°†ä¸€ä»½æ•°æ®å†™å…¥åˆ°MergeTreeè¡¨ä¸­æ—¶ï¼Œå†™å…¥é€Ÿåº¦å¤§çº¦ä¸º50åˆ°200MB/sã€‚å¦‚æœæ‚¨å†™å…¥çš„æ•°æ®æ¯è¡Œä¸º1Kbï¼Œé‚£ä¹ˆå†™å…¥çš„é€Ÿåº¦ä¸º50ï¼Œ000åˆ°200ï¼Œ000è¡Œæ¯ç§’ã€‚å¦‚æœæ‚¨çš„è¡Œæ›´å°ï¼Œé‚£ä¹ˆå†™å…¥é€Ÿåº¦å°†æ›´é«˜ã€‚ä¸ºäº†æé«˜å†™å…¥æ€§èƒ½ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å¤šä¸ªINSERTè¿›è¡Œå¹¶è¡Œå†™å…¥ï¼Œè¿™å°†å¸¦æ¥çº¿æ€§çš„æ€§èƒ½æå‡ã€‚ count: åƒä¸‡çº§åˆ«ï¼Œ500æ¯«ç§’ï¼Œ1äº¿ 800æ¯«ç§’ 2äº¿ 900æ¯«ç§’ 3äº¿ 1.1ç§’ group: ç™¾ä¸‡çº§åˆ« 200æ¯«ç±³ï¼Œåƒä¸‡ 1ç§’ï¼Œ1äº¿ 10ç§’ï¼Œ2äº¿ 20ç§’ï¼Œ3äº¿ 30ç§’ joinï¼šåƒä¸‡-10ä¸‡ 600 æ¯«ç§’ï¼Œ åƒä¸‡ -ç™¾ä¸‡ï¼š10ç§’ï¼Œåƒä¸‡-åƒä¸‡ 150ç§’ ClickHouseå¹¶éæ— æ‰€ä¸èƒ½ï¼ŒæŸ¥è¯¢è¯­å¥éœ€è¦ä¸æ–­çš„è°ƒä¼˜ï¼Œå¯èƒ½ä¸æŸ¥è¯¢æ¡ä»¶æœ‰å…³ï¼Œä¸åŒçš„æŸ¥è¯¢æ¡ä»¶è¡¨æ˜¯å·¦joinè¿˜æ˜¯å³joinä¹Ÿæ˜¯å¾ˆæœ‰è®²ç©¶çš„ã€‚ å…¶ä»–è¡¥å……ï¼š 1ï¼ŒMySQLå•æ¡SQLæ˜¯å•çº¿ç¨‹çš„ï¼Œåªèƒ½è·‘æ»¡ä¸€ä¸ªcoreï¼ŒClickHouseç›¸åï¼Œæœ‰å¤šå°‘CPUï¼Œåƒå¤šå°‘èµ„æºï¼Œæ‰€ä»¥é£å¿«ï¼› 2ï¼ŒClickHouseä¸æ”¯æŒäº‹åŠ¡ï¼Œä¸å­˜åœ¨éš”ç¦»çº§åˆ«ã€‚ClickHouseçš„å®šä½æ˜¯åˆ†ææ€§æ•°æ®åº“ï¼Œè€Œä¸æ˜¯ä¸¥æ ¼çš„å…³ç³»å‹æ•°æ®åº“ã€‚ 3ï¼ŒIOæ–¹é¢ï¼ŒMySQLæ˜¯è¡Œå­˜å‚¨ï¼ŒClickHouseæ˜¯åˆ—å­˜å‚¨ï¼Œåè€…åœ¨count()è¿™ç±»æ“ä½œå¤©ç„¶æœ‰ä¼˜åŠ¿ï¼ŒåŒæ—¶ï¼Œåœ¨IOæ–¹é¢ï¼ŒMySQLéœ€è¦å¤§é‡éšæœºIOï¼ŒClickHouseåŸºæœ¬æ˜¯é¡ºåºIOã€‚ æœ‰äººå¯èƒ½è§‰å¾—ä¸Šé¢çš„æ•°æ®å¯¼å…¥çš„æ—¶å€™ï¼Œæ•°æ®è‚¯å®šç¼“å­˜åœ¨å†…å­˜é‡Œäº†ï¼Œè¿™ä¸ªçš„ç¡®ï¼Œä½†æ˜¯ClickHouseåŸºæœ¬ä¸Šæ˜¯é¡ºåºIOã€‚å¯¹IOåŸºæœ¬æ²¡æœ‰å¤ªé«˜è¦æ±‚ï¼Œå½“ç„¶ï¼Œç£ç›˜è¶Šå¿«ï¼Œä¸Šå±‚å¤„ç†è¶Šå¿«ï¼Œä½†æ˜¯99%çš„æƒ…å†µæ˜¯ï¼ŒCPUå…ˆè·‘æ»¡äº†ï¼ˆæ•°æ®åº“é‡Œå¤ªå°‘è§äº†ï¼Œå¤§å¤šæ•°éƒ½æ˜¯IOä¸å¤Ÿç”¨ï¼‰ã€‚ ","link":"https://tianxiawuhao.github.io/lhZ2-aE1I/"},{"title":"Centos7å®‰è£…Harbor","content":" Harborä½œä¸ºdockeré•œåƒä»“åº“ï¼Œè‡ªç„¶æ˜¯è¦ä¾èµ–äºdockerç¯å¢ƒçš„ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨å®‰è£…Harborä¹‹å‰ï¼Œå¿…é¡»è¦å®‰è£…dockerç¯å¢ƒï¼ŒåŒæ—¶å†å®‰è£…ä¸‹docker-composeï¼ dockerä¸docker-composeçš„å®‰è£…æ•™ç¨‹å‚è€ƒï¼šDockerã€Docker-composeçš„å®‰è£… ä¸€ã€Harborçš„ç¦»çº¿å®‰è£… 1ã€ä¸‹è½½Harborçš„ç¦»çº¿å®‰è£…åŒ…ï¼š ä¸‹è½½åœ°å€ï¼šhttps://github.com/goharbor/harbor/releases æˆ‘ä¸‹è½½çš„æ˜¯å½“å‰æœ€æ–°ç‰ˆï¼šv1.10.10 2ã€ä¸Šä¼ å¹¶è§£å‹åˆ° /usr/local/ç›®å½•ä¸‹ï¼š [root@node1 ~]# tar -zxvf harbor-offline-installer-v1.10.10.tgz [root@node1 ~]# mv harbor /usr/local/ [root@node1 ~]# cd /usr/local/harbor/ [root@node1 harbor]# ls common.sh harbor.v1.10.10.tar.gz harbor.yml install.sh LICENSE prepare 3ã€ä¿®æ”¹harborçš„æ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼š [root@node1 harbor]# vim harbor.yml ## å”¯ä¸€å¿…é¡»ä¿®æ”¹é¡¹ hostname: 10.206.73.155 #å¦‚æœæœ‰è®¡åˆ’å¥½çš„åŸŸåï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨åŸŸå # http related config http: # port for http, default is 80. If https enabled, this port will redirect to https port port: 80 # å› ä¸ºæˆ‘æš‚æ—¶ä¸éœ€è¦httpsè®¿é—®ï¼Œæ‰€ä»¥httpsçš„é…ç½®å»é™¤ #https: #port: 443 #certificate: /your/certificate/path #private_key: /your/private/key/path harbor_admin_password: Harbor12345 #éœ€è¦ä¿®æ”¹ 4ã€æ£€æŸ¥å¹¶å®‰è£…ï¼š # æ£€æŸ¥ ./prepare # å®‰è£… ./install å¦‚æœç¢°åˆ°iptableç›¸å…³çš„errorï¼Œå…³é—­ firewalldï¼Œå¹¶é‡å¯dockeræœåŠ¡ systemctl stop firewalld service docker restart 5ã€æŸ¥çœ‹ã€å¯åŠ¨ã€åœæ­¢ï¼š åœ¨harborç›®å½•ä¸‹ä½¿ç”¨docker-composeå‘½ä»¤ï¼š ## æŸ¥çœ‹ [root@node1 harbor]# docker-compose ps Name Command State Ports --------------------------------------------------------------------------------------------- harbor-core /harbor/harbor_core Up (healthy) harbor-db /docker-entrypoint.sh Up (healthy) 5432/tcp harbor-jobservice /harbor/harbor_jobservice ... Up (healthy) harbor-log /bin/sh -c /usr/local/bin/ ... Up (healthy) 127.0.0.1:1514-&gt;10514/tcp harbor-portal nginx -g daemon off; Up (healthy) 8080/tcp nginx nginx -g daemon off; Up (healthy) 0.0.0.0:80-&gt;8080/tcp redis redis-server /etc/redis.conf Up (healthy) 6379/tcp registry /home/harbor/entrypoint.sh Up (healthy) 5000/tcp registryctl /home/harbor/start.sh Up (healthy) # docker-compose stop ## åœæ­¢ # docker-compose up -d ## åå°å¯åŠ¨ 6ã€é€šè¿‡ymlä¸­é…ç½®çš„ip+portï¼Œä»¥åŠadminçš„è´¦å·å¯†ç è®¿é—®Harborï¼š è¡¥å……ä¸€ã€å†…éƒ¨ä½¿ç”¨Harboræ—¶ï¼Œåªæœ‰ipç«¯å£ï¼Œæ²¡æœ‰åŸŸåæ€ä¹ˆåŠï¼Ÿ Error response from daemon: Get https://10.206.73.155/v2/: dial tcp 10.206.73.155:443: connect: connection refused æˆ‘ä»¬å¯ä»¥åœ¨dockerçš„æ ¸å¿ƒé…ç½®æ–‡ä»¶ä¸­ï¼Œå¢åŠ ä¸Šå¯¹ç‰¹å®šipçš„å…è®¸å³å¯ï¼š [root@master ~]# vim /etc/docker/daemon.json { &quot;registry-mirrors&quot;:[ &quot;https://otvq3lq9.mirror.aliyuncs.com&quot; ], &quot;insecure-registries&quot;:[ &quot;10.206.73.155&quot; ], &quot;max-concurrent-downloads&quot;:10, &quot;log-driver&quot;:&quot;json-file&quot;, &quot;log-level&quot;:&quot;warn&quot;, &quot;log-opts&quot;:{ &quot;max-size&quot;:&quot;50m&quot;, &quot;max-file&quot;:&quot;3&quot; }, &quot;data-root&quot;:&quot;/var/lib/docker&quot; } é‡å¯dockerå®ˆæŠ¤çº¿ç¨‹å’ŒdockeræœåŠ¡ï¼š [root@node2 ~]# systemctl daemon-reload [root@node2 ~]# systemctl restart docker ","link":"https://tianxiawuhao.github.io/XWPPx5pbS/"},{"title":"GitLabçš„å®‰è£…ä¸ç®€å•ä½¿ç”¨","content":"Gitlabæ˜¯ä»€ä¹ˆå°±ä¸ç”¨å¤šè®²äº†ï¼Œç›´æ¥ä¸Šæ‰‹å®‰è£…â€”â€”ä½¿ç”¨Dockerå®‰è£…ï¼Œå‚è€ƒå®˜æ–¹æ–‡æ¡£ ä¸€ã€Gitlabçš„å®‰è£… 1ã€åœ¨å®¿ä¸»æœºåˆ›å»ºé…ç½®ã€æ—¥å¿—ã€æ•°æ®çš„ç›®å½•ï¼š mkdir -p /home/gitlab/config åˆ›å»ºconfigç›®å½• mkdir -p /home/gitlab/logs åˆ›å»ºlogsç›®å½• mkdir -p /home/gitlab/data åˆ›å»ºdataç›®å½• 2ã€ä½¿ç”¨ä»¥ä¸‹å°†æœ¬æ‹‰å–å¹¶å¯åŠ¨gitlabï¼š docker run --detach \\ --hostname 192.168.56.11 \\ --publish 443:443 --publish 80:80 --publish 222:22 \\ --name gitlab \\ --restart always \\ --volume /home/gitlab/config:/etc/gitlab \\ --volume /home/gitlab/logs:/var/log/gitlab \\ --volume /home/gitlab/data:/var/opt/gitlab \\ gitlab/gitlab-ce:latest æ‹‰å–é•œåƒæ—¶é—´è¾ƒé•¿ï¼Œéœ€è€å¿ƒç­‰å¾…ï¼Œé•œåƒå¤§å°è¾¾2.29Gï¼ ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶å€™ï¼Œç”±äºè¦å®‰è£…å¾ˆå¤šä¸œè¥¿ï¼Œè€Œä¸”è¿˜è¦æ£€æŸ¥å¥åº·çŠ¶å†µï¼Œæ‰€ä»¥ä¼šéå¸¸æ…¢ï¼Œè€å¿ƒï¼ 3ã€è·å¾—Gitlabåˆå§‹rootè´¦å·å¯†ç ï¼š [root@mycentos2 ~]# sudo docker exec -it gitlab grep 'Password:' /etc/gitlab/initial_root_password Password: Ho0rM3Gm9LpuIARVnNE/6YoQrXC05g+JwYITLm0y2oo= ç™»å½•æˆåŠŸåï¼Œç«‹å³ä¿®æ”¹æ‰rootå¯†ç ï¼š é‡æ–°ç™»å½•ï¼ äºŒã€Gitlabçš„ä½¿ç”¨å°å¦™æ‹› 1ã€å¿«é€Ÿè¿ç§»gitä»“åº“ï¼ˆæ‰€æœ‰åˆ†æ”¯ï¼‰ git clone --mirror &lt;URL to my OLD repo location&gt; cd æ–‡ä»¶å¤¹ä¸‹ git remote set-url origin &lt;URL to my NEW repo location&gt; git push -f origin ä¸‰ã€åˆ›å»ºæ–°é¡¹ç›® å…¨å±€è®¾ç½® git config --global user.name &quot;xxx&quot; git config --global user.email &quot;xxx@163.com&quot; åœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ªæ–°çš„gitä»“åº“ git clone git@qdxwgitlab.qingdao.cosmoplat.com:jiguiquan/openiot-k8s.git cd openiot-k8s touch README.md git add README.md git commit -m &quot;add README&quot; git push -u origin master ä¸Šä¼ ç°æœ‰æ–‡ä»¶å¤¹ cd existing_folder git init git remote add origin git@qdxwgitlab.qingdao.cosmoplat.com:xxx/openiot-k8s.git git add . git commit -m &quot;Initial commit&quot; git push -u origin master ä¸Šä¼ ç°æœ‰æœ¬åœ°ä»“åº“ cd existing_repo git remote rename origin old-origin git remote add origin git@qdxwgitlab.qingdao.cosmoplat.com:xxx/openiot-k8s.git git push -u origin --all git push -u origin --tags å››ã€é…ç½®gitçš„sshå¯†é’¥ é»˜è®¤çš„å¯†é’¥å¯¹åœ¨: ç”¨æˆ·ç›®å½•/.ssh/ ä¸‹ 1ã€ä»»æ„åœ°æ–¹cmdæ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼Œç”Ÿæˆå…¬é’¥ç§é’¥å¯†é’¥å¯¹ï¼š ssh-keygen -t rsa -C &quot;jiguiquan@haier.com&quot; éœ€è¦è¾“å…¥çš„åœ°æ–¹éƒ½ç›´æ¥å›è½¦å³å¯ï¼ 2ã€åˆ°githubæˆ–è€…gitlabä¸Šæ·»åŠ sshå‡­è¯å³å¯ï¼ äº”ã€gitæäº¤æ—¶å€™çš„CRLFè½¬åŒ–é—®é¢˜ 1ã€å½“æˆ‘ä»¬æäº¤git addçš„æ—¶å€™ï¼Œgitä¼šç»™å‡ºæç¤ºï¼š $ git add . warning: LF will be replaced by CRLF in .env. The file will have its original line endings in your working directory warning: LF will be replaced by CRLF in .idea/.gitignore. The file will have its original line endings in your working directory 2ã€æœ‰æ—¶å€™æˆ‘ä»¬ä¸å¸Œæœ›è‡ªåŠ¨è½¬åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…³é—­è‡ªåŠ¨è½¬åŒ–çš„åŠŸèƒ½ æå‰å…¨å±€è®¾ç½®gitconfigï¼Œå…³é—­æ­¤åŠŸèƒ½ï¼› git config --global core.autocrlf false ","link":"https://tianxiawuhao.github.io/dpVtZ7y41/"},{"title":"Gitlabçš„æ‰‹åŠ¨å®‰è£…","content":" å¯¹äºè¿™ä¸€ç±»çš„åŸºç¡€æœåŠ¡ï¼Œæˆ‘è¿˜æ˜¯ç»å¾—æ‰‹åŠ¨å®‰è£…å¾—æ–¹å¼æ›´èƒ½è®©æˆ‘å¿ƒå®‰ï¼ dockerå®‰è£…çš„æ–‡ç« ï¼Œå‚è€ƒè¿™é‡Œï¼š GitLabçš„å®‰è£…ä¸ç®€å•ä½¿ç”¨ ä¸€ã€ä½¿ç”¨æ¸…åé•œåƒæºå®‰è£… æ¸…åé•œåƒæºï¼šhttps://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/ æ¸…åé•œåƒæºç»™çš„ä½¿ç”¨æ•™ç¨‹ï¼šhttps://mirror.tuna.tsinghua.edu.cn/help/gitlab-ce/ å¼€å§‹å®‰è£…ï¼ 1ã€é…ç½®yumæºï¼š vim /etc/yum.repos.d/gitlab-ce.repo # å¤åˆ¶ç²˜è´´ä»¥ä¸‹å†…å®¹ï¼š [gitlab-ce] name=Gitlab CE Repository baseurl=https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el$releasever/ gpgcheck=0 enabled=1 2ã€å†æ‰§è¡Œä»¥ä¸‹ä¸¤æ­¥ï¼š sudo yum makecache sudo yum install gitlab-ce #è‡ªåŠ¨å®‰è£…æœ€æ–°ç‰ˆ # sudo yum install gitlab-ce-x.x.x #å®‰è£…æŒ‡å®šç‰ˆæœ¬ #æŸ¥çœ‹gitlabçš„ç‰ˆæœ¬ï¼š cat /opt/gitlab/embedded/service/gitlab-rails/VERSION #å¸è½½å½“å‰ç‰ˆæœ¬ï¼š gitlab-ctl uninstall yum remove gitlab-ce #å®‰è£…æŒ‡å®šç‰ˆæœ¬ï¼š #å…·ä½“ç‰ˆæœ¬ä¿¡æ¯å¯é€šè¿‡è¯¥é“¾æ¥æŸ¥çœ‹ï¼šhttps://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/ sudo yum install gitlab-ce-14.7.0-ce.0.el7.x86_64 äºŒã€Gitlabçš„å¯åŠ¨å’Œå¸¸ç”¨å‘½ä»¤ 1ã€Gitlabçš„é…ç½®æ–‡ä»¶ä½ç½®ï¼š/etc/gitlab/gitlab.rb vim /etc/gitlab/gitlab.rb é…ç½®å¤–éƒ¨è®¿é—®åŸŸåï¼š external_url 'http://gitlab.jiguiquan.com' 2ã€ä½¿é…ç½®é‡æ–°ç”Ÿæ•ˆå¹¶å¯åŠ¨ gitlab-ctl reconfigure # å…³äºåˆå§‹è´¦å·å¯†ç çš„æç¤ºï¼š Notes: Default admin account has been configured with following details: Username: root Password: You didn't opt-in to print initial root password to STDOUT. Password stored to /etc/gitlab/initial_root_password. This file will be cleaned up in first reconfigure run after 24 hours. # æŸ¥çœ‹çŠ¶æ€ gitlab-ctl status 3ã€gitlabçš„å…¶å®ƒå¸¸ç”¨å‘½ä»¤ï¼š gitlab-ctl start # å¯åŠ¨æ‰€æœ‰ gitlab ç»„ä»¶ï¼› gitlab-ctl stop # åœæ­¢æ‰€æœ‰ gitlab ç»„ä»¶ï¼› gitlab-ctl restart # é‡å¯æ‰€æœ‰ gitlab ç»„ä»¶ï¼› gitlab-ctl status # æŸ¥çœ‹æœåŠ¡çŠ¶æ€ï¼› vim /etc/gitlab/gitlab.rb # ä¿®æ”¹gitlabé…ç½®æ–‡ä»¶ï¼› gitlab-ctl reconfigure # é‡æ–°ç¼–è¯‘gitlabçš„é…ç½®ï¼› gitlab-rake gitlab:check SANITIZE=true --trace # æ£€æŸ¥gitlabï¼› gitlab-ctl tail # æŸ¥çœ‹æ—¥å¿—ï¼› gitlab-ctl tail nginx/gitlab_access.log ä¸‰ã€Gitlab502é—®é¢˜è§£å†³æ€è·¯ å› ä¸ºGitlabé‡Œé¢æ¶‰åŠåˆ°çš„æœåŠ¡å¤ªå¤šäº†ï¼Œæ‰€ä»¥å¯èƒ½å¯¼è‡´çš„åŸå› å¾ˆå¤šå¾ˆå¤šï¼Œæ‰€ä»¥åªå°†æ€è·¯ï¼› 1ã€çº¯ç²¹å°±æ˜¯å¯åŠ¨æ…¢ï¼Œä¸€å®šè¦ç»™å®ƒæ—¶é—´ï¼ 2ã€æ­£å¸¸æƒ…å†µä¸‹æœ€å®¹æ˜“ç¢°åˆ°çš„é—®é¢˜æ˜¯ï¼Œç«¯å£è¢«å ç”¨ï¼š 2.1ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€ [root@tcosmo-szls01 gitlab]# gitlab-ctl status run: alertmanager: (pid 47345) 3083s; run: log: (pid 39732) 4609s run: gitaly: (pid 47374) 3083s; run: log: (pid 38290) 4745s run: gitlab-exporter: (pid 47436) 3083s; run: log: (pid 39461) 4629s run: gitlab-workhorse: (pid 47464) 3082s; run: log: (pid 39111) 4650s run: grafana: (pid 60395) 567s; run: log: (pid 40223) 4561s run: logrotate: (pid 47533) 3081s; run: log: (pid 38080) 4763s run: nginx: (pid 60308) 568s; run: log: (pid 39286) 4645s run: node-exporter: (pid 47624) 3080s; run: log: (pid 39395) 4635s run: postgres-exporter: (pid 47630) 3080s; run: log: (pid 39834) 4605s run: postgresql: (pid 47640) 3080s; run: log: (pid 38465) 4733s run: prometheus: (pid 47644) 3079s; run: log: (pid 39641) 4617s run: puma: (pid 62674) 27s; run: log: (pid 38876) 4664s run: redis: (pid 47731) 3079s; run: log: (pid 38133) 4752s run: redis-exporter: (pid 47740) 3078s; run: log: (pid 39567) 4621s run: sidekiq: (pid 60222) 585s; run: log: (pid 38910) 4658s 2.2ã€çœ‹åˆ°pumaæœåŠ¡å¯åŠ¨æ—¶é—´ä¸æ­£å¸¸ï¼Œæ‰€ä»¥æˆ‘ä»¬è¯¦ç»†çš„æŸ¥çœ‹pumaæœåŠ¡çš„æ—¥å¿—ï¼š [root@tcosmo-szls01 gitlab]# gitlab-ctl tail puma 2022-01-25_04:25:18.93538 /opt/gitlab/embedded/bin/puma:23:in `&lt;top (required)&gt;' 2022-01-25_04:25:19.82282 {&quot;timestamp&quot;:&quot;2022-01-25T04:25:19.822Z&quot;,&quot;pid&quot;:62825,&quot;message&quot;:&quot;Puma starting in cluster mode...&quot;} 2022-01-25_04:25:19.82285 {&quot;timestamp&quot;:&quot;2022-01-25T04:25:19.822Z&quot;,&quot;pid&quot;:62825,&quot;message&quot;:&quot;* Puma version: 5.5.2 (ruby 2.7.5-p203) (\\&quot;Zawgyi\\&quot;)&quot;} 2022-01-25_04:25:19.82285 {&quot;timestamp&quot;:&quot;2022-01-25T04:25:19.822Z&quot;,&quot;pid&quot;:62825,&quot;message&quot;:&quot;* Min threads: 4&quot;} 2022-01-25_04:25:19.82286 {&quot;timestamp&quot;:&quot;2022-01-25T04:25:19.822Z&quot;,&quot;pid&quot;:62825,&quot;message&quot;:&quot;* Max threads: 4&quot;} 2022-01-25_04:25:19.82286 {&quot;timestamp&quot;:&quot;2022-01-25T04:25:19.822Z&quot;,&quot;pid&quot;:62825,&quot;message&quot;:&quot;* Environment: production&quot;} 2022-01-25_04:25:19.82287 {&quot;timestamp&quot;:&quot;2022-01-25T04:25:19.822Z&quot;,&quot;pid&quot;:62825,&quot;message&quot;:&quot;* Master PID: 62825&quot;} 2022-01-25_04:25:19.82289 {&quot;timestamp&quot;:&quot;2022-01-25T04:25:19.822Z&quot;,&quot;pid&quot;:62825,&quot;message&quot;:&quot;* Workers: 80&quot;} 2022-01-25_04:25:19.82290 {&quot;timestamp&quot;:&quot;2022-01-25T04:25:19.822Z&quot;,&quot;pid&quot;:62825,&quot;message&quot;:&quot;* Restarts: (âœ”) hot (âœ–) phased&quot;} 2022-01-25_04:25:19.82293 {&quot;timestamp&quot;:&quot;2022-01-25T04:25:19.822Z&quot;,&quot;pid&quot;:62825,&quot;message&quot;:&quot;* Preloading application&quot;} 2022-01-25_04:25:53.14976 {&quot;timestamp&quot;:&quot;2022-01-25T04:25:53.149Z&quot;,&quot;pid&quot;:62825,&quot;message&quot;:&quot;* Listening on unix:///var/opt/gitlab/gitlab-rails/sockets/gitlab.socket&quot;} 2022-01-25_04:25:53.14993 bundler: failed to load command: puma (/opt/gitlab/embedded/bin/puma) 2022-01-25_04:25:53.14999 Errno::EADDRINUSE: Address already in use - bind(2) for &quot;127.0.0.1&quot; port 8080 ## ç½ªé­ç¥¸é¦–åœ¨è¿™é‡Œï¼ŒpumaæœåŠ¡é»˜è®¤éœ€è¦ä½¿ç”¨8080ç«¯å£ï¼Œä½†æ˜¯8080ç«¯å£è¢«å ç”¨äº† 2.3ã€è§£å†³é—®é¢˜ å¦‚æœä¸æ˜¯ä¸»è¦æœåŠ¡ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠé‚£ä¸ªæœåŠ¡åœæ‰ï¼› å¦‚æœä¸èƒ½åœï¼Œé‚£æˆ‘ä»¬å°±å»ä¿®æ”¹pumaæœåŠ¡é»˜è®¤çš„ç«¯å£ vim /etc/gitlab/gitlab.rb # ä¿®æ”¹pumaæœåŠ¡é»˜è®¤çš„ç«¯å£ ### Advanced settings # puma['listen'] = '127.0.0.1' puma['port'] = 8090 ## è¿™é‡Œ # puma['socket'] = '/var/opt/gitlab/gitlab-rails/sockets/gitlab.socket' # puma['somaxconn'] = 1024 # ä¹‹åæˆ‘ä»¬è®©é…ç½®ç”Ÿæ•ˆå¹¶é‡å¯æœåŠ¡ gitlab-ctl reconfigure ä¹‹åæœåŠ¡å°±å¯ä»¥æ­£å¸¸è®¿é—®äº†ï¼š å››ã€Gitlabçš„ä½¿ç”¨ 1ã€è·å¾—åˆå§‹å¯†ç ï¼Œå¹¶ä¿®æ”¹åˆå§‹rootå¯†ç ï¼š [root@tcosmo-szls01 gitlab]# cat /etc/gitlab/initial_root_password|grep Password: Password: bimCiS46btIEfFn/03A0gVA8EuriTjuRrqtJhwvl5vo= ç™»å½•åç«‹å³ä¿®æ”¹åˆå§‹å¯†ç ï¼š 2ã€Gitlabçš„å‡ ä¸ªé‡è¦ç›®å½• é…ç½®æ–‡ä»¶ç›®å½•ï¼š/etc/gitlab/ æ—¥å¿—æ–‡ä»¶ç›®å½•ï¼š/var/log/gitlab/ dataæ•°æ®ç›®å½•ï¼š/var/opt/gitlab/ è¡¥å……ä¸€ï¼šé‡è¦ï¼šGitlabçš„æ•°æ®å¤‡ä»½ï¼š 1ã€æ‰‹åŠ¨å¤‡ä»½ï¼š gitlab-rake gitlab:backup:create # ä¸Šé¢çš„å‘½ä»¤ä¼šå°†gitlabçš„æ•°æ®å¤‡ä»½åˆ°//var/opt/gitlab/backupsç›®å½•ä¸‹ï¼ŒåŒ…å«ï¼šgitlabä»“åº“ã€æ•°æ®åº“ã€ç”¨æˆ·ã€ç”¨æˆ·ç»„ã€ç”¨æˆ·å¯†é’¥ã€æƒé™ç­‰å®Œæ•´ä¿¡æ¯ã€‚ [root@tcosmo-szls01 backups]# pwd /var/opt/gitlab/backups [root@tcosmo-szls01 backups]# ll -h total 243M -rw------- 1 git git 243M Apr 19 18:19 1650363597_2022_04_19_14.7.0_gitlab_backup.tar 2ã€è‡ªåŠ¨å¤‡ä»½ï¼ˆæ¯å¤©å‡Œæ™¨4ç‚¹æ‰§è¡Œå¤‡ä»½ï¼Œä¸”åªä¿ç•™7å¤©ï¼‰ 2.1ã€ä¿®æ”¹å¤‡ä»½æœ‰æ•ˆæœŸï¼Œåªä¿ç•™7å¤© vim /etc/gitlab/gitlab.rb # æ˜¾ç¤ºè¡Œå· :set nu # å¤§æ¦‚åœ¨564è¡Œï¼š gitlab_rails['backup_keep_time'] = 604800 ##é…ç½®ä¸º7å¤© é…ç½®å®Œæˆåï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä½¿é…ç½®ç”Ÿæ•ˆï¼š gitlab-ctl reconfigure 2.2ã€å€ŸåŠ©ç³»ç»Ÿcrontabå‘½ä»¤å®ç°æ¯å¤©å‡Œæ™¨4ç‚¹å®šæ—¶å¤‡ä»½ï¼š vim /etc/crontab 0 4 * * * root /opt/gitlab/bin/gitlab-rake gitlab:backup:create CRON=1 é‡å¯crontabæœåŠ¡ï¼š systemctl restart crond 3ã€æ¥ä¸‹æ¥å°±æ˜¯é‡è¦çš„æ¢å¤æ—¶åˆ»å•¦ï¼š 3.1ã€é¦–å…ˆå°†å…¶å®ƒåœ°æ–¹çš„å¤‡ä»½æ–‡ä»¶æ‹·è´åˆ°ç›®æ ‡gitlabçš„ /var/opt/gitlab/backups/ ç›®å½•ä¸‹ï¼š [root@tcosmo-szlstb03 backups]# pwd /var/opt/gitlab/backups [root@tcosmo-szlstb03 backups]# chmod 777 1652558427_2022_05_15_14.7.0_gitlab_backup.tar #ä¿®æ”¹ä¸‹æ­¤æ–‡ä»¶çš„æƒé™ [root@tcosmo-szlstb03 backups]# ll total 463020 -rwxrwxrwx 1 root root 474132480 May 15 14:00 1652558427_2022_05_15_14.7.0_gitlab_backup.tar 3.2ã€åœæ­¢æ•°æ®åº“è¿æ¥æœåŠ¡ï¼š [root@tcosmo-szlstb03 backups]# gitlab-ctl stop puma &amp;&amp; gitlab-ctl stop sidekiq ok: down: puma: 0s, normally up ok: down: sidekiq: 0s, normally up [root@tcosmo-szlstb03 backups]# gitlab-ctl status run: alertmanager: (pid 127725) 2368s; run: log: (pid 125865) 2462s run: gitaly: (pid 127446) 2376s; run: log: (pid 124540) 2594s run: gitlab-exporter: (pid 127391) 2379s; run: log: (pid 125602) 2482s run: gitlab-kas: (pid 134202) 1829s; run: log: (pid 124881) 2579s run: gitlab-workhorse: (pid 127361) 2380s; run: log: (pid 125421) 2499s run: grafana: (pid 134276) 1828s; run: log: (pid 126913) 2407s run: logrotate: (pid 124415) 2609s; run: log: (pid 124450) 2608s run: nginx: (pid 134237) 1828s; run: log: (pid 125463) 2493s run: node-exporter: (pid 127384) 2380s; run: log: (pid 125570) 2488s run: postgres-exporter: (pid 127739) 2367s; run: log: (pid 126033) 2456s run: postgresql: (pid 124683) 2586s; run: log: (pid 124695) 2585s run: prometheus: (pid 131596) 2155s; run: log: (pid 125676) 2470s down: puma: 29s, normally up; run: log: (pid 125345) 2511s run: redis: (pid 124479) 2603s; run: log: (pid 124491) 2602s run: redis-exporter: (pid 127393) 2379s; run: log: (pid 125625) 2476s down: sidekiq: 29s, normally up; run: log: (pid 125370) 2505s 3.3ã€ä¹‹å‰restoreå¤‡ä»½æ¢å¤æ“ä½œï¼š [root@tcosmo-szlstb03 backups]# gitlab-rake gitlab:backup:restore BACKUP=1652558427_2022_05_15_14.7.0 2022-05-15 14:15:58 +0800 -- Unpacking backup ... 2022-05-15 14:15:59 +0800 -- Unpacking backup ... done GitLab version mismatch: Your current GitLab version (14.10.2) differs from the GitLab version in the backup! Please switch to the following version and try again: version: 14.7.0 è¿™é‡Œçš„æ„æ€æ˜¯ï¼Œç›®æ ‡GItlabç‰ˆæœ¬ä¸å¤‡ä»½æ–‡ä»¶ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œæ‰€ä»¥Gitlabçš„å¤‡ä»½æ¢å¤å¿…é¡»ä¿æŒGitlabç‰ˆæœ¬ä¸€è‡´ï¼ ä¹–ä¹–åˆ‡æ¢å¯¹åº”çš„Gitlabç‰ˆæœ¬å§ï¼ 3.4ã€æœ€åé‡å¯ä¸‹Gitlabå§ï¼š gitlab-ctl start è¡¥å……äºŒã€Gitlabä¸€äº›ç»†èŠ‚é…ç½® 1ã€Gitlabä»“åº“å…è®¸çš„æœ€å¤§ä¸Šä¼ æ–‡ä»¶é…ç½®ï¼š ä¿®æ”¹æ ¸å¿ƒé…ç½®æ–‡ä»¶/etc/gitlab/gitlab.rbä¸­çš„Nginxé…ç½®ï¼š vim /etc/gitlab/gitlab.rb nginx['client_max_body_size'] = '1024m' #ç„¶åé‡å¯æœåŠ¡ gitlab-ctl reconfigure è¡¥å……ä¸‰ã€Gitlabä¹‹Git LFSå¤§æ–‡ä»¶å­˜å‚¨ 1ã€ä¿®æ”¹gitlabæ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼š vim config/gitlab.yml: ### Git LFS gitlab_rails['lfs_enabled'] = true #é»˜è®¤ä½ç½®ï¼š`/var/opt/gitlab/gitlab-rails/shared/lfs-objects` gitlab_rails['lfs_storage_path'] = &quot;/data/gitlab/lfs-objects&quot; 2ã€é‡å¯gitlabï¼š gitlab-ctl reconfigure 3ã€ä¹‹åæ­£å¸¸æƒ…å†µä¸‹ï¼Œæ‰€æœ‰çš„é¡¹ç›®å°±éƒ½æ”¯æŒLFSäº†ï¼Œä¹Ÿå¯ä»¥å…³é—­ï¼š 4ã€é€šè¿‡ç®¡ç†å‘˜è´¦å·Admin Areaâ€”â€”&gt;overviewâ€”â€”&gt;projectæ—¶ï¼Œè¿˜å¯ä»¥çœ‹åˆ°é¡¹ç›®çš„è¯¦ç»†é¢„è§ˆä¿¡æ¯ï¼š 5ã€åœ¨æ¨é€ä»£ç æ—¶ï¼Œéœ€è¦æ‰§è¡Œgit lfs track å‘½ä»¤æŒ‡å®šå­˜å…¥lfsçš„æ–‡ä»¶åç¼€ï¼š ç°åœ¨æˆ‘å°†è¦æµ‹è¯•ä¸Šä¼ ä¸€ä¸ªå¤§æ–‡ä»¶ + å°æ–‡ä»¶åˆ°gitlabï¼ŒåŒæ—¶è®©å¤§æ–‡ä»¶å­˜æ”¾åˆ°â€œ/data/gitlab/lfs-objectsâ€ # æ ‡è®°å“ªäº›æ–‡ä»¶éœ€è¦é€šè¿‡lfså­˜å‚¨ $ git lfs track &quot;*.vep&quot; Tracking &quot;*.vep&quot; # æŸ¥çœ‹è‡ªåŠ¨ç”Ÿæˆå¾—.gitattributesæ–‡ä»¶ $ cat .gitattributes *.vep filter=lfs diff=lfs merge=lfs -text # æ·»åŠ æ–‡ä»¶ $ git add . # commitæäº¤ $ git commit -m &quot;first test large file&quot; [main 3357c89] first test large file 3 files changed, 5 insertions(+) create mode 100644 .gitattributes create mode 100644 big-file.vep create mode 100644 small-file.txt # pushåˆ°è¿œç¨‹gitlab $ git push origin main info: detecting host provider for 'http://10.206.73.159/'... info: detecting host provider for 'http://10.206.73.159/'... info: detecting host provider for 'http://10.206.73.159/'... info: detecting host provider for 'http://10.206.73.159/'... Locking support detected on remote &quot;origin&quot;. Consider enabling it with: $ git config lfs.http://10.206.73.159/jiguiquan/test-big-file.git/info/lfs.locksverify true Uploading LFS objects: 0% (0/1), 37 MB | 3.3 MB/s ... Uploading LFS objects: 0% (0/1), 862 MB | 3.6 MB/s ... Uploading LFS objects: 100% (1/1), 1.3 GB | 3.7 MB/s, done. Enumerating objects: 6, done. Counting objects: 100% (6/6), done. Delta compression using up to 4 threads Compressing objects: 100% (3/3), done. Writing objects: 100% (5/5), 540 bytes | 270.00 KiB/s, done. Total 5 (delta 0), reused 0 (delta 0), pack-reused 0 To http://10.206.73.159/jiguiquan/test-big-file.git ac6319f..3357c89 main -&gt; main 6ã€ä¸Šä¼ æ–‡æˆåï¼Œæˆ‘ä»¬å»Gitlabä¸­æŸ¥çœ‹ï¼Œå¯ä»¥çœ‹åˆ°å¯¹åº”çš„å¤§æ–‡ä»¶æœ‰ä¸ªç‰¹æ®Šå°æ ‡å¿—ï¼š åŒæ—¶ï¼ŒLFSå¤§æ–‡ä»¶æ—¶æ— æ³•åœ¨ä»£ç ä¸­ç›´æ¥åˆ é™¤çš„ï¼ 7ã€åˆ°æˆ‘ä»¬é…ç½®å¾—LFSè·¯å¾„ä¸‹çœ‹çœ‹ï¼Œæ˜¯ä¸æ˜¯ç¡®å®æœ‰è¿™ä¸ªå¤§æ–‡ä»¶ï¼š [root@node1 lfs-objects]# pwd /data/gitlab/lfs-objects [root@node1 lfs-objects]# ls a9 tmp [root@node1 lfs-objects]# tree . â”œâ”€â”€ a9 â”‚ â””â”€â”€ d3 â”‚ â””â”€â”€ 9518c7f4f5426781bbbd90cf50169581e03b2f265d0b2443dff35c81ce80 â””â”€â”€ tmp â”œâ”€â”€ cache â”œâ”€â”€ uploads â””â”€â”€ work 6 directories, 1 file [root@node1 lfs-objects]# cd a9/d3/ [root@node1 d3]# ll -h total 1.3G -rw-r--r--. 1 git git 1.3G Jul 14 16:43 9518c7f4f5426781bbbd90cf50169581e03b2f265d0b2443dff35c81ce80 é€šè¿‡æ–‡ä»¶å¤§å°ç›´åˆ°ï¼Œè‚¯å®šå³ä½¿æˆ‘ä»¬ä¸Šä¼ å¾—é‚£ä¸ªå¤§æ–‡ä»¶ï¼ 8ã€æœ€åï¼Œè‚¯å®šè¿˜å¾—è¦æµ‹ä¸€ä¸‹cloneä¸‹è½½æ­£ä¸æ­£å¸¸ï¼ˆgit lfs clone â€¦ï¼‰ï¼š # é€šè¿‡git lfs clone å®Œæˆå¯¹åŒ…å«LFSçš„é¡¹ç›®çš„clone $ git lfs clone http://10.206.73.159/jiguiquan/test-big-file.git WARNING: 'git lfs clone' is deprecated and will not be updated with new flags from 'git clone' 'git clone' has been updated in upstream Git to have comparable speeds to 'git lfs clone'. Cloning into 'test-big-file'... info: detecting host provider for 'http://10.206.73.159/'... info: detecting host provider for 'http://10.206.73.159/'... remote: Enumerating objects: 8, done. remote: Counting objects: 100% (8/8), done. remote: Compressing objects: 100% (4/4), done. remote: Total 8 (delta 0), reused 0 (delta 0), pack-reused 0 Receiving objects: 100% (8/8), done. info: detecting host provider for 'http://10.206.73.159/'... info: detecting host provider for 'http://10.206.73.159/'... Downloading LFS objects: 0% (0/1), 92 MB | 3.7 MB/s ... Downloading LFS objects: 0% (0/1), 501 MB | 2.0 MB/s ... Receiving objects: 100% (8/8), done. info: detecting host provider for 'http://10.206.73.159/'... info: detecting host provider for 'http://10.206.73.159/'... Downloading LFS objects: 100% (1/1), 1.3 GB | 1.6 MB/s å¤§æ–‡ä»¶Cloneæ­£å¸¸ï¼š ","link":"https://tianxiawuhao.github.io/DfTPV-OWf/"},{"title":"easeCode","content":"controller.java.vm ##å®šä¹‰åˆå§‹å˜é‡ #set($tableName = $tool.append($tableInfo.name, &quot;Controller&quot;)) ##è®¾ç½®å›è°ƒ $!callback.setFileName($tool.append($tableName, &quot;.java&quot;)) $!callback.setSavePath($tool.append($tableInfo.savePath, &quot;/controller&quot;)) ##æ‹¿åˆ°ä¸»é”® #if(!$tableInfo.pkColumn.isEmpty()) #set($pk = $tableInfo.pkColumn.get(0)) #end #if($tableInfo.savePackageName)package $!{tableInfo.savePackageName}.#{end}controller; import $!{tableInfo.savePackageName}.entity.$!{tableInfo.name}; import $!{tableInfo.savePackageName}.entity.to.$!{tableInfo.name}TO; import $!{tableInfo.savePackageName}.exception.basic.APIResponse; import $!{tableInfo.savePackageName}.service.$!{tableInfo.name}Service; import com.haier.dtsimrs.entity.PageInfo; import io.swagger.v3.oas.annotations.Operation; import io.swagger.v3.oas.annotations.tags.Tag; import jakarta.annotation.Resource; import jakarta.validation.Valid; import org.springframework.web.bind.annotation.*; import java.util.List; /** * $!{tableInfo.comment}($!{tableInfo.name})è¡¨æ§åˆ¶å±‚ * * @author wuhao * @since $!time.currTime() */ @Tag(name = &quot;$!{tableInfo.comment}&quot;,description = &quot;$!{tableInfo.comment}&quot;) @RestController @RequestMapping(&quot;$!tool.firstLowerCase($tableInfo.name)&quot;) public class $!{tableName} { /** * æœåŠ¡å¯¹è±¡ */ @Resource private $!{tableInfo.name}Service $!tool.firstLowerCase($tableInfo.name)Service; /** * é€šè¿‡æ¡ä»¶æŸ¥è¯¢æ•°æ® * * @param id ç­›é€‰æ¡ä»¶ * @return å®ä¾‹å¯¹è±¡ */ @GetMapping(value = &quot;/queryByOne&quot;) @Operation(summary = &quot;æ ¹æ®æ¡ä»¶è·å–å•æ¡æ•°æ®&quot;, description = &quot;æ ¹æ®æ¡ä»¶è·å–å•æ¡æ•°æ®&quot;) public APIResponse&lt;$!{tableInfo.name}&gt; queryById(@PathVariable(&quot;id&quot;) $!pk.shortType id) { return APIResponse.ok(this.$!{tool.firstLowerCase($tableInfo.name)}Service.getById(id)); } /** * åˆ†é¡µæŸ¥è¯¢ * * @param $!{tool.firstLowerCase($tableInfo.name)} ç­›é€‰æ¡ä»¶ * @return æŸ¥è¯¢ç»“æœ */ @PostMapping(value = &quot;/queryByPage&quot;) @Operation(summary = &quot;è·å–åˆ†é¡µæ•°æ®&quot;, description = &quot;è·å–åˆ†é¡µæ•°æ®&quot;) public APIResponse&lt;PageInfo&lt;$!{tableInfo.name}&gt;&gt; queryByPage(@RequestBody $!{tableInfo.name}TO $!{tool.firstLowerCase($tableInfo.name)}) { return APIResponse.ok(this.$!{tool.firstLowerCase($tableInfo.name)}Service.queryByPage($!{tool.firstLowerCase($tableInfo.name)})); } /** * é€šè¿‡æ¡ä»¶æŸ¥è¯¢æ‰¹é‡æ•°æ® * * @param $!{tool.firstLowerCase($tableInfo.name)} ç­›é€‰æ¡ä»¶ * @return å•æ¡æ•°æ® */ @PostMapping(value = &quot;/queryByList&quot;) @Operation(summary = &quot;é€šè¿‡æ¡ä»¶æŸ¥è¯¢æ‰¹é‡æ•°æ®&quot;, description = &quot;é€šè¿‡æ¡ä»¶æŸ¥è¯¢æ‰¹é‡æ•°æ®&quot;) public APIResponse&lt;List&lt;$!{tableInfo.name}&gt;&gt; queryByList(@RequestBody $!{tableInfo.name} $!{tool.firstLowerCase($tableInfo.name)}) { return APIResponse.ok(this.$!{tool.firstLowerCase($tableInfo.name)}Service.queryByList($!{tool.firstLowerCase($tableInfo.name)})); } /** * æ–°å¢æ•°æ® * * @param $!{tool.firstLowerCase($tableInfo.name)} å®ä½“ * @return æ–°å¢ç»“æœ */ @PostMapping(value = &quot;/saveOrUpdate&quot;) @Operation(summary = &quot;æ–°å¢æˆ–ç¼–è¾‘æ•°æ®&quot;, description = &quot;æ–°å¢æˆ–ç¼–è¾‘æ•°æ®&quot;) public APIResponse&lt;Boolean&gt; saveOrUpdate(@RequestBody @Valid $!{tableInfo.name} $!{tool.firstLowerCase($tableInfo.name)}) { return APIResponse.ok(this.$!{tool.firstLowerCase($tableInfo.name)}Service.saveOrUpdate($!{tool.firstLowerCase($tableInfo.name)})); } /** * æ‰¹é‡æ–°å¢æ•°æ® * * @param list å®ä½“ * @return æ–°å¢ç»“æœ */ @PostMapping(value = &quot;/saveOrUpdateBatch&quot;) @Operation(summary = &quot;æ‰¹é‡æ–°å¢æˆ–ç¼–è¾‘æ•°æ®&quot;, description = &quot;æ‰¹é‡æ–°å¢æˆ–ç¼–è¾‘æ•°æ®&quot;) public APIResponse&lt;Boolean&gt; saveOrUpdateBatch(@RequestBody @Valid List&lt;$!{tableInfo.name}&gt; list) { return APIResponse.ok(this.$!{tool.firstLowerCase($tableInfo.name)}Service.saveOrUpdateBatch(list)); } /** * åˆ é™¤æ•°æ® * * @param id ä¸»é”® * @return åˆ é™¤æ˜¯å¦æˆåŠŸ */ @DeleteMapping(value = &quot;/deleteById&quot;) @Operation(summary = &quot;æ ¹æ®ä¸»é”®åˆ é™¤æ•°æ®&quot;, description = &quot;æ ¹æ®ä¸»é”®åˆ é™¤æ•°æ®&quot;) public APIResponse&lt;Boolean&gt; deleteById($!pk.shortType id) { return APIResponse.ok(this.$!{tool.firstLowerCase($tableInfo.name)}Service.removeById(id)); } /** * æ‰¹é‡åˆ é™¤æ•°æ® * * @param ids ä¸»é”® * @return åˆ é™¤æ˜¯å¦æˆåŠŸ */ @DeleteMapping(value = &quot;/removeByIds&quot;) @Operation(summary = &quot;æ ¹æ®ä¸»é”®æ‰¹é‡åˆ é™¤æ•°æ®&quot;, description = &quot;æ ¹æ®ä¸»é”®æ‰¹é‡åˆ é™¤æ•°æ®&quot;) public APIResponse&lt;Boolean&gt; deleteById(List&lt;$!pk.shortType&gt; ids) { return APIResponse.ok(this.$!{tool.firstLowerCase($tableInfo.name)}Service.removeByIds(ids)); } } service.java.vm ##å®šä¹‰åˆå§‹å˜é‡ #set($tableName = $tool.append($tableInfo.name, &quot;Service&quot;)) ##è®¾ç½®å›è°ƒ $!callback.setFileName($tool.append($tableName, &quot;.java&quot;)) $!callback.setSavePath($tool.append($tableInfo.savePath, &quot;/service&quot;)) ##æ‹¿åˆ°ä¸»é”® #if(!$tableInfo.pkColumn.isEmpty()) #set($pk = $tableInfo.pkColumn.get(0)) #end #if($tableInfo.savePackageName)package $!{tableInfo.savePackageName}.#{end}service; import $!{tableInfo.savePackageName}.entity.$!{tableInfo.name}; import $!{tableInfo.savePackageName}.entity.to.$!{tableInfo.name}TO; import com.baomidou.mybatisplus.extension.service.IService; import java.util.List; import com.haier.dtsimrs.entity.PageInfo; /** * $!{tableInfo.comment}($!{tableInfo.name})è¡¨æœåŠ¡æ¥å£ * * @author wuhao * @since $!time.currTime() */ public interface $!{tableName} extends IService&lt;$!{tableInfo.name}&gt;{ /** * é€šè¿‡æ¡ä»¶æŸ¥è¯¢æ‰¹é‡æ•°æ® * * @param $!tool.firstLowerCase($!{tableInfo.name}) ç­›é€‰æ¡ä»¶ * @return æŸ¥è¯¢ç»“æœ */ List&lt;$!{tableInfo.name}&gt; queryByList($!{tableInfo.name} $!tool.firstLowerCase($!{tableInfo.name})); /** * åˆ†é¡µæŸ¥è¯¢ * * @param $!tool.firstLowerCase($!{tableInfo.name}) ç­›é€‰æ¡ä»¶ * @return æŸ¥è¯¢ç»“æœ */ PageInfo&lt;$!{tableInfo.name}&gt; queryByPage($!{tableInfo.name}TO $!{tool.firstLowerCase($tableInfo.name)}); } serviceImpl.java.vm ##å®šä¹‰åˆå§‹å˜é‡ #set($tableName = $tool.append($tableInfo.name, &quot;ServiceImpl&quot;)) ##è®¾ç½®å›è°ƒ $!callback.setFileName($tool.append($tableName, &quot;.java&quot;)) $!callback.setSavePath($tool.append($tableInfo.savePath, &quot;/service/impl&quot;)) ##æ‹¿åˆ°ä¸»é”® #if(!$tableInfo.pkColumn.isEmpty()) #set($pk = $tableInfo.pkColumn.get(0)) #end #if($tableInfo.savePackageName)package $!{tableInfo.savePackageName}.#{end}service.impl; import $!{tableInfo.savePackageName}.entity.$!{tableInfo.name}; import $!{tableInfo.savePackageName}.entity.to.$!{tableInfo.name}TO; import $!{tableInfo.savePackageName}.mapper.$!{tableInfo.name}Mapper; import $!{tableInfo.savePackageName}.service.$!{tableInfo.name}Service; import com.baomidou.mybatisplus.core.toolkit.Wrappers; import com.baomidou.mybatisplus.extension.plugins.pagination.Page; import com.haier.dtsimrs.entity.PageInfo; import org.springframework.stereotype.Service; import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl; import jakarta.annotation.Resource; import java.util.List; import java.util.Objects; import org.springframework.util.StringUtils; import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper; import org.springframework.beans.BeanUtils; /** * $!{tableInfo.comment}($!{tableInfo.name})è¡¨æœåŠ¡å®ç°ç±» * * @author wuhao * @since $!time.currTime() */ @Service(&quot;$!tool.firstLowerCase($!{tableInfo.name})Service&quot;) public class $!{tableName} extends ServiceImpl&lt;$!{tableInfo.name}Mapper, $!{tableInfo.name}&gt; implements $!{tableInfo.name}Service { @Resource private $!{tableInfo.name}Mapper $!tool.firstLowerCase($!{tableInfo.name})Mapper; /** * é€šè¿‡æ¡ä»¶æŸ¥è¯¢æ‰¹é‡æ•°æ® * * @param $!tool.firstLowerCase($!{tableInfo.name}) ç­›é€‰æ¡ä»¶ * @return å®ä¾‹å¯¹è±¡ */ @Override public List&lt;$!{tableInfo.name}&gt; queryByList($!{tableInfo.name} $!tool.firstLowerCase($!{tableInfo.name})) { return this.$!{tool.firstLowerCase($!{tableInfo.name})}Mapper.selectList(getWrapper($!tool.firstLowerCase($!{tableInfo.name}))); } /** * åˆ†é¡µæŸ¥è¯¢ * * @param $!{tool.firstLowerCase($tableInfo.name)} ç­›é€‰æ¡ä»¶ * @return æŸ¥è¯¢ç»“æœ */ @Override public PageInfo&lt;$!{tableInfo.name}&gt; queryByPage($!{tableInfo.name}TO $!{tool.firstLowerCase($tableInfo.name)}) { //å¼€å¯åˆ†é¡µ Page&lt;$!{tableInfo.name}&gt; page = new Page&lt;&gt;($!{tool.firstLowerCase($tableInfo.name)}.getPage(), $!{tool.firstLowerCase($tableInfo.name)}.getSize()); $!{tableInfo.name} build = $!{tableInfo.name}.builder().build(); BeanUtils.copyProperties($!{tool.firstLowerCase($tableInfo.name)},build); return new PageInfo&lt;&gt;(this.$!{tool.firstLowerCase($tableInfo.name)}Mapper.selectPage(page, getWrapper(build))); } private LambdaQueryWrapper getWrapper($!{tableInfo.name} $!tool.firstLowerCase($!{tableInfo.name})){ return Wrappers.&lt;$!{tableInfo.name}&gt;lambdaQuery() #foreach($column in $tableInfo.fullColumn) #if($!{tool.getClsNameByFullName($column.type)}==&quot;String&quot;) .eq(StringUtils.hasLength($!{tool.firstLowerCase($!{tableInfo.name})}.get$!{tool.firstUpperCase($!{column.name})}()), $!{tableInfo.name}::get$!{tool.firstUpperCase($!{column.name})}, $!{tool.firstLowerCase($!{tableInfo.name})}.get$!{tool.firstUpperCase($!{column.name})}()) #end #if($!{tool.getClsNameByFullName($column.type)}!=&quot;String&quot;) .eq(Objects.nonNull($!{tool.firstLowerCase($!{tableInfo.name})}.get$!{tool.firstUpperCase($!{column.name})}()), $!{tableInfo.name}::get$!{tool.firstUpperCase($!{column.name})},$!{tool.firstLowerCase($!{tableInfo.name})}.get$!{tool.firstUpperCase($!{column.name})}()) #end #end ; } } mapper.java.vm ##å¼•å…¥mybatisæ”¯æŒ $!{mybatisSupport.vm} ##è®¾ç½®ä¿å­˜åç§°ä¸ä¿å­˜ä½ç½® $!callback.setFileName($tool.append($!{tableInfo.name}, &quot;Mapper.xml&quot;)) $!callback.setSavePath($tool.append($modulePath, &quot;/src/main/resources/mapper&quot;)) ##æ‹¿åˆ°ä¸»é”® #if(!$tableInfo.pkColumn.isEmpty()) #set($pk = $tableInfo.pkColumn.get(0)) #end &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt; &lt;mapper namespace=&quot;$!{tableInfo.savePackageName}.mapper.$!{tableInfo.name}Mapper&quot;&gt; &lt;resultMap type=&quot;$!{tableInfo.savePackageName}.entity.$!{tableInfo.name}&quot; id=&quot;$!{tableInfo.name}Map&quot;&gt; #foreach($column in $tableInfo.fullColumn) &lt;result property=&quot;$!column.name&quot; column=&quot;$!column.obj.name&quot; jdbcType=&quot;$!column.ext.jdbcType&quot;/&gt; #end &lt;/resultMap&gt; &lt;!--æŸ¥è¯¢æŒ‡å®šè¡Œæ•°æ®--&gt; &lt;select id=&quot;queryAllByLimit&quot; resultMap=&quot;$!{tableInfo.name}Map&quot;&gt; select #allSqlColumn() from $!tableInfo.obj.name &lt;where&gt; #foreach($column in $tableInfo.fullColumn) &lt;if test=&quot;$!column.name != null#if($column.type.equals(&quot;java.lang.String&quot;)) and $!column.name != ''#end&quot;&gt; and $!column.obj.name = #{$!column.name} &lt;/if&gt; #end &lt;/where&gt; &lt;/select&gt; &lt;insert id=&quot;insertBatch&quot; keyProperty=&quot;$!pk.name&quot; useGeneratedKeys=&quot;true&quot;&gt; insert into $!{tableInfo.obj.name}(#foreach($column in $tableInfo.otherColumn)$!column.obj.name#if($velocityHasNext), #end#end) values &lt;foreach collection=&quot;entities&quot; item=&quot;entity&quot; separator=&quot;,&quot;&gt; (#foreach($column in $tableInfo.otherColumn)#{entity.$!{column.name}}#if($velocityHasNext), #end#end) &lt;/foreach&gt; &lt;/insert&gt; &lt;!--éœ€è¦é€šè¿‡åœ¨æ•°æ®åº“è¿æ¥URLä¸­æŒ‡å®šallowMultiQuerieså‚æ•°å€¼ä¸ºtrueå‘Šè¯‰æ•°æ®åº“ä»¥æ”¯æŒâ€;&quot;å·åˆ†éš”çš„å¤šæ¡è¯­å¥çš„æ‰§è¡Œ--&gt; &lt;update id=&quot;updateBatch&quot;&gt; &lt;foreach collection=&quot;entities&quot; item=&quot;entity&quot; separator=&quot;;&quot;&gt; update $!{tableInfo.obj.name} &lt;set&gt; #foreach($column in $tableInfo.otherColumn) &lt;if test=&quot;entity.$!column.name != null#if($column.type.equals(&quot;java.lang.String&quot;)) and entity.$!column.name != ''#end&quot;&gt; $!column.obj.name = #{entity.$!column.name}, &lt;/if&gt; #end &lt;/set&gt; where $!pk.obj.name = #{entity.$!pk.name} &lt;/foreach&gt; &lt;/update&gt; &lt;/mapper&gt; dao.java.vm ##å®šä¹‰åˆå§‹å˜é‡ #set($tableName = $tool.append($tableInfo.name, &quot;Mapper&quot;)) ##è®¾ç½®å›è°ƒ $!callback.setFileName($tool.append($tableName, &quot;.java&quot;)) $!callback.setSavePath($tool.append($tableInfo.savePath, &quot;/mapper&quot;)) ##æ‹¿åˆ°ä¸»é”® #if(!$tableInfo.pkColumn.isEmpty()) #set($pk = $tableInfo.pkColumn.get(0)) #end #if($tableInfo.savePackageName)package $!{tableInfo.savePackageName}.#{end}mapper; import $!{tableInfo.savePackageName}.entity.$!{tableInfo.name}; import com.baomidou.mybatisplus.core.mapper.BaseMapper; import org.apache.ibatis.annotations.Mapper; import org.apache.ibatis.annotations.Param; import java.util.List; /** * $!{tableInfo.comment}($!{tableInfo.name})è¡¨æ•°æ®åº“è®¿é—®å±‚ * * @author wuhao * @since $!time.currTime() */ @Mapper public interface $!{tableInfo.name}Mapper extends BaseMapper&lt;$!{tableInfo.name}&gt;{ } entity.java.vm ##å¼•å…¥å®å®šä¹‰ $!{define.vm} ##ä½¿ç”¨å®å®šä¹‰è®¾ç½®å›è°ƒï¼ˆä¿å­˜ä½ç½®ä¸æ–‡ä»¶åç¼€ï¼‰ #save(&quot;/entity&quot;, &quot;.java&quot;) ##ä½¿ç”¨å®å®šä¹‰è®¾ç½®åŒ…åç¼€ #setPackageSuffix(&quot;entity&quot;) ##ä½¿ç”¨å…¨å±€å˜é‡å®ç°é»˜è®¤åŒ…å¯¼å…¥ $!{autoImport.vm} import com.baomidou.mybatisplus.annotation.IdType; import com.baomidou.mybatisplus.annotation.TableId; import jakarta.persistence.*; import lombok.*; import lombok.experimental.Accessors; import io.swagger.v3.oas.annotations.media.Schema; import java.io.Serializable; ##ä½¿ç”¨å®å®šä¹‰å®ç°ç±»æ³¨é‡Šä¿¡æ¯ #tableComment(&quot;å®ä½“ç±»&quot;) @Data @EqualsAndHashCode(callSuper = false) @Accessors(chain = true) @Schema(title=&quot;$!{tableInfo.name}å¯¹è±¡&quot;, description=&quot;$!{tableInfo.comment}&quot;) @Builder @AllArgsConstructor @NoArgsConstructor @Entity @Table(name = &quot;$!{tool.hump2Underline($tableInfo.name)}&quot;, schema = &quot;$!{tableInfo.comment}&quot;) public class $!{tableInfo.name} implements Serializable { private static final long serialVersionUID = $!tool.serial(); #foreach($column in $tableInfo.fullColumn) #if(${column.comment})/** * ${column.comment} */#end #if($!{column.name}==&quot;id&quot;)@Schema(title = &quot;${column.comment}&quot;) @TableId(value = &quot;id&quot;, type = IdType.AUTO) @Id @GeneratedValue(strategy = GenerationType.IDENTITY) private $!{tool.getClsNameByFullName($column.type)} $!{column.name}; #end#if($!{column.name}!=&quot;id&quot;)@Schema(title = &quot;${column.comment}&quot;) #if($!{column.shortType}==&quot;String&quot;) @Column(columnDefinition = &quot;varchar(255) COMMENT '$!{column.comment}'&quot;, name = &quot;$!{tool.hump2Underline($column.name)}&quot;) #end #if($!{column.shortType}==&quot;Integer&quot;) @Column(columnDefinition = &quot;int COMMENT '$!{column.comment}'&quot;, name = &quot;$!{tool.hump2Underline($column.name)}&quot;) #end #if($!{column.shortType}==&quot;Long&quot;) @Column(columnDefinition = &quot;bigint COMMENT '$!{column.comment}'&quot;, name = &quot;$!{tool.hump2Underline($column.name)}&quot;) #end #if($!{column.shortType}==&quot;Double&quot;) @Column(columnDefinition = &quot;double(5, 3) COMMENT '$!{column.comment}'&quot;, name = &quot;$!{tool.hump2Underline($column.name)}&quot;) #end #if($!{column.shortType}==&quot;Date&quot;) @Column(columnDefinition = &quot;datetime COMMENT '$!{column.comment}'&quot;, name = &quot;$!{tool.hump2Underline($column.name)}&quot;) #end #if($!{column.shortType}==&quot;DateTime&quot;) @Column(columnDefinition = &quot;datetime COMMENT '$!{column.comment}'&quot;, name = &quot;$!{tool.hump2Underline($column.name)}&quot;) #end #if($!{column.shortType}==&quot;LocalDateTime&quot;) @Column(columnDefinition = &quot;datetime COMMENT '$!{column.comment}'&quot;, name = &quot;$!{tool.hump2Underline($column.name)}&quot;) #end #if($!{column.shortType}==&quot;Boolean&quot;) @Column(columnDefinition = &quot;int(1) COMMENT '$!{column.comment}'&quot;, name = &quot;$!{tool.hump2Underline($column.name)}&quot;) #end private $!{tool.getClsNameByFullName($column.type)} $!{column.name}; #end #end } entityTO.java.vm ##å¼•å…¥å®å®šä¹‰ $!{define.vm} ##ä½¿ç”¨å®å®šä¹‰è®¾ç½®å›è°ƒï¼ˆä¿å­˜ä½ç½®ä¸æ–‡ä»¶åç¼€ï¼‰ #save(&quot;/entity/to&quot;, &quot;TO.java&quot;) ##ä½¿ç”¨å®å®šä¹‰è®¾ç½®åŒ…åç¼€ #setPackageSuffix(&quot;entity.to&quot;) ##ä½¿ç”¨å…¨å±€å˜é‡å®ç°é»˜è®¤åŒ…å¯¼å…¥ $!{autoImport.vm} import com.baomidou.mybatisplus.annotation.IdType; import com.baomidou.mybatisplus.annotation.TableId; import com.haier.dtsimrs.entity.SearchPage; import lombok.*; import lombok.experimental.Accessors; import io.swagger.v3.oas.annotations.media.Schema; import java.io.Serializable; ##ä½¿ç”¨å®å®šä¹‰å®ç°ç±»æ³¨é‡Šä¿¡æ¯ #tableComment(&quot;å®ä½“TOç±»&quot;) @Data @EqualsAndHashCode(callSuper = false) @Accessors(chain = true) @Schema(title=&quot;$!{tableInfo.name}TOå¯¹è±¡&quot;, description=&quot;$!{tableInfo.comment}&quot;) @Builder @AllArgsConstructor @NoArgsConstructor public class $!{tableInfo.name}TO extends SearchPage implements Serializable { private static final long serialVersionUID = $!tool.serial(); #foreach($column in $tableInfo.fullColumn) #if(${column.comment})/** * ${column.comment} */#end #if($!{column.name}==&quot;id&quot;)@Schema(title = &quot;${column.comment}&quot;) @TableId(value = &quot;id&quot;, type = IdType.AUTO) private $!{tool.getClsNameByFullName($column.type)} $!{column.name}; #end#if($!{column.name}!=&quot;id&quot;)@Schema(title = &quot;${column.comment}&quot;) private $!{tool.getClsNameByFullName($column.type)} $!{column.name}; #end #end } entityVO.java.vm ##å¼•å…¥å®å®šä¹‰ $!{define.vm} ##ä½¿ç”¨å®å®šä¹‰è®¾ç½®å›è°ƒï¼ˆä¿å­˜ä½ç½®ä¸æ–‡ä»¶åç¼€ï¼‰ #save(&quot;/entity/vo&quot;, &quot;VO.java&quot;) ##ä½¿ç”¨å®å®šä¹‰è®¾ç½®åŒ…åç¼€ #setPackageSuffix(&quot;entity.vo&quot;) ##ä½¿ç”¨å…¨å±€å˜é‡å®ç°é»˜è®¤åŒ…å¯¼å…¥ $!{autoImport.vm} import com.baomidou.mybatisplus.annotation.IdType; import com.baomidou.mybatisplus.annotation.TableId; import lombok.*; import lombok.experimental.Accessors; import io.swagger.v3.oas.annotations.media.Schema; import java.io.Serializable; ##ä½¿ç”¨å®å®šä¹‰å®ç°ç±»æ³¨é‡Šä¿¡æ¯ #tableComment(&quot;å®ä½“VOç±»&quot;) @Data @EqualsAndHashCode(callSuper = false) @Accessors(chain = true) @Schema(title=&quot;$!{tableInfo.name}VOå¯¹è±¡&quot;, description=&quot;$!{tableInfo.comment}&quot;) @Builder @AllArgsConstructor @NoArgsConstructor public class $!{tableInfo.name}VO implements Serializable { private static final long serialVersionUID = $!tool.serial(); #foreach($column in $tableInfo.fullColumn) #if(${column.comment})/** * ${column.comment} */#end #if($!{column.name}==&quot;id&quot;)@Schema(title = &quot;${column.comment}&quot;) @TableId(value = &quot;id&quot;, type = IdType.AUTO) private $!{tool.getClsNameByFullName($column.type)} $!{column.name}; #end#if($!{column.name}!=&quot;id&quot;)@Schema(title = &quot;${column.comment}&quot;) private $!{tool.getClsNameByFullName($column.type)} $!{column.name}; #end #end } APIResponse import cn.hutool.core.util.StrUtil; import com.fasterxml.jackson.annotation.JsonIgnore; import io.swagger.annotations.ApiModel; import io.swagger.annotations.ApiModelProperty; import lombok.AllArgsConstructor; import lombok.Data; import lombok.experimental.Accessors; import java.io.Serializable; @Data @Accessors(chain = true) @AllArgsConstructor @ApiModel(&quot;åŸºç¡€å“åº”ä¿¡æ¯&quot;) public class APIResponse&lt;E&gt; implements Serializable { @ApiModelProperty(value = &quot;å“åº”ç  200:æˆåŠŸï¼Œå…¶ä»–:å¤±è´¥&quot;, required = true) private Integer code; @ApiModelProperty(value = &quot;å“åº”ä¿¡æ¯&quot;) private String msg; @ApiModelProperty(value = &quot;å“åº”æ•°æ®&quot;) private E data; @JsonIgnore private Object[] args; /** * è·å–å“åº”æ¶ˆæ¯ * @return å“åº”æ¶ˆæ¯ */ public String getMsg() { return (null != args &amp;&amp; null != msg) ? StrUtil.format(msg, args) : msg; } public APIResponse() { this.code = ResponseCode.SUCCESS.getCode(); } private APIResponse(ResponseCode code) { this.code = code.getCode(); this.msg = code.getMsg(); } public static APIResponse ok() { return new APIResponse(ResponseCode.SUCCESS); } public static &lt;E&gt; APIResponse&lt;E&gt; ok(E data) { APIResponse&lt;E&gt; res = new APIResponse(ResponseCode.SUCCESS); res.setData(data); return res; } public static &lt;E&gt; APIResponse&lt;E&gt; ok(E data, String msg) { APIResponse res = ok(data); res.setMsg(msg); return res; } private static APIResponse fail() { return new APIResponse(ResponseCode.FAIL); } /** * å¤±è´¥å“åº” * @param responseCode å¼‚å¸¸ç  * @return */ public static APIResponse fail(IResponseCode responseCode) { return fail(responseCode.getCode(), responseCode.getMsg()); } /** * å¤±è´¥å“åº” * @param responseCode å¼‚å¸¸ç  * @param args å‚æ•° * @return */ public static APIResponse fail(IResponseCode responseCode, Object... args) { APIResponse res = fail(responseCode.getCode(), responseCode.getMsg()); res.setArgs(args); return res; } @Deprecated public static APIResponse fail(String msg) { APIResponse res = fail(); res.setMsg(msg); return res; } @Deprecated public static APIResponse fail(String format, Object... msg) { APIResponse res = fail(); res.setMsg(StrUtil.format(format, msg)); return res; } public static APIResponse fail(Integer code, String msg) { APIResponse res = fail(msg); res.setCode(code); return res; } public APIResponse msg(String msg) { this.msg = msg; return this; } /** * å“åº”æ˜¯å¦æˆåŠŸ * * @return */ @ApiModelProperty(value = &quot;è¯·æ±‚æ˜¯å¦æˆåŠŸ&quot;, hidden = true) public boolean isOk() { return this.code == ResponseCode.SUCCESS.getCode(); } } IResponseCode public interface IResponseCode { /** * è·å–å“åº”ç  * @return */ int getCode(); /** * è·å–å“åº”ä¿¡æ¯ * * @return */ String getMsg(); } IResponseCode import lombok.Getter; @Getter public enum ResponseCode implements IResponseCode { SUCCESS(&quot;æˆåŠŸ&quot;, 200), NEED_CHANGE_PAAS(&quot;éœ€è¦ä¿®æ”¹åˆå§‹å¯†ç &quot;, 220), FAIL(&quot;å¤±è´¥&quot;, 500), EXCEPTION(&quot;å¼‚å¸¸&quot;, 505), TOKEN_INVALID(&quot;tokenå¤±æ•ˆ&quot;, 501), ILLEGAL_TOKEN(&quot;éæ³•token&quot;, 502), NOTFUND_TOKEN(&quot;è¯·æ±‚å¤´ç¼ºå°‘token&quot;, 503), FORBIDDEN_ACCESS(&quot;æ— è®¿é—®æƒé™&quot;, 403), ACCOUNT_NOTFOUND( &quot;è´¦å·ä¸å­˜åœ¨&quot;,404), ACCOUNT_EXIST( &quot;è´¦å·å·²å­˜åœ¨&quot;,410), LOGIN_INVALID(&quot;è´¦å·æˆ–å¯†ç é”™è¯¯&quot;,405), ACCOUNT_EXPIRED(&quot;è´¦å·è¿‡æœŸ&quot;,406), PASSWORD_EXPIRED( &quot;å¯†ç è¿‡æœŸ&quot;,407), LICENSE_OUTTIME(&quot;licenseè®¸å¯å·²ç»è¿‡æœŸ&quot;,408), ACCOUNT_LOCKED( &quot;æ— æ³•ç™»å½•ï¼Œè¯·ä¸ç®¡ç†å‘˜è”ç³»&quot;,409), CODE_NOT_SEND( &quot;çŸ­ä¿¡éªŒè¯ç æœªå‘é€&quot;,411), CODE_ERROR( &quot;çŸ­ä¿¡éªŒè¯ç é”™è¯¯&quot;,412), ; int code; String msg; ResponseCode(int code) { this.code = code; } ResponseCode(String msg,int code) { this(code); this.msg = msg; } @Override public int getCode() { return code; } @Override public String getMsg() { return msg; } } SearchPage import io.swagger.annotations.ApiModelProperty; import lombok.AllArgsConstructor; import lombok.Data; import lombok.EqualsAndHashCode; import lombok.NoArgsConstructor; import lombok.experimental.Accessors; @Data @EqualsAndHashCode(callSuper = false) @Accessors(chain = true) @AllArgsConstructor @NoArgsConstructor public class SearchPage { @ApiModelProperty(value = &quot;é¡µæ•°&quot;) private int page = 0; @ApiModelProperty(value = &quot;æ¯é¡µæ¡æ•°&quot;) private int size = 10; } page import com.baomidou.mybatisplus.extension.plugins.pagination.Page; import lombok.Data; import java.util.List; @Data public class PageInfo&lt;T&gt;{ protected long total; protected List&lt;? extends T&gt; list; public static final int DEFAULT_NAVIGATE_PAGES = 8; private long pageNum; private long pageSize; private long startRow; private long endRow; public PageInfo(Page&lt;T&gt; page) { this.list = page.getRecords(); this.total = page.getTotal(); this.pageNum = page.getCurrent(); this.pageSize = page.getSize(); this.startRow = 0L; this.endRow = page.getTotal() &gt; 0 ? (page.getTotal()/page.getSize()) : 0L; } public String toString() { String sb = &quot;PageInfo{&quot; + &quot;pageNum=&quot; + this.pageNum + &quot;, pageSize=&quot; + this.pageSize + &quot;, startRow=&quot; + this.startRow + &quot;, endRow=&quot; + this.endRow + &quot;, total=&quot; + this.total + &quot;, list=&quot; + this.list + '}'; return sb; } } xml spring: jpa: hibernate: ddl-auto: update show-sql: true properties: hibernate: hbm2ddl: auto: update ","link":"https://tianxiawuhao.github.io/OxvAGnY87/"},{"title":"Javaå®ç°Licenseæˆæƒè®¸å¯å’ŒéªŒè¯","content":"TrueLicense TrueLicenseæ˜¯ä¸€ä¸ªå¼€æºçš„è¯ä¹¦ç®¡ç†å¼•æ“ï¼Œä½¿ç”¨åœºæ™¯ï¼šå½“é¡¹ç›®äº¤ä»˜ç»™å®¢æˆ·ä¹‹åç”¨ç­¾åæ¥ä¿è¯å®¢æˆ·ä¸èƒ½éšæ„ä½¿ç”¨é¡¹ç›® é»˜è®¤æ ¡éªŒäº†å¼€å§‹ç»“æŸæ—¶é—´ï¼Œå¯æ‰©å±•å¢åŠ macåœ°å€æ ¡éªŒç­‰ã€‚ å…¶ä¸­è¿˜æœ‰ftpçš„æ ¡éªŒæ²¡æœ‰å°è¯•ï¼Œæœ¬demoè¯¦ç»†ä»‹ç»çš„æ˜¯æœ¬åœ°æ ¡éªŒ licenseæˆæƒæœºåˆ¶çš„åŸç†ï¼š ç”Ÿæˆå¯†é’¥å¯¹ï¼Œæ–¹æ³•æœ‰å¾ˆå¤šã€‚æˆ‘ä»¬ä½¿ç”¨trueLicenseæ¥åšè½¯ä»¶äº§å“çš„ä¿æŠ¤ï¼Œæˆ‘ä»¬ä¸»è¦ä½¿ç”¨å®ƒçš„LicenseManagerç±»æ¥ç”Ÿæˆè¯ä¹¦æ–‡ä»¶ã€å®‰è£…è¯ä¹¦æ–‡ä»¶ã€éªŒè¯è¯ä¹¦æ–‡ä»¶. åŸç† é¦–å…ˆéœ€è¦ç”Ÿæˆå¯†é’¥å¯¹ï¼Œæ–¹æ³•æœ‰å¾ˆå¤šï¼ŒJDKä¸­æä¾›çš„KeyToolå³å¯ç”Ÿæˆã€‚ æˆæƒè€…ä¿ç•™ç§é’¥ï¼Œä½¿ç”¨ç§é’¥å¯¹åŒ…å«æˆæƒä¿¡æ¯ï¼ˆå¦‚æˆªæ­¢æ—¥æœŸï¼ŒMACåœ°å€ç­‰ï¼‰çš„licenseè¿›è¡Œæ•°å­—ç­¾åã€‚ å…¬é’¥äº¤ç»™ä½¿ç”¨è€…ï¼ˆæ”¾åœ¨éªŒè¯çš„ä»£ç ä¸­ä½¿ç”¨ï¼‰ï¼Œç”¨äºéªŒè¯licenseæ˜¯å¦ç¬¦åˆä½¿ç”¨æ¡ä»¶ã€‚ ä½¿ç”¨Keytoolå‘½ä»¤ç”Ÿæˆå¯†é’¥å¯¹ Keytool æ˜¯ä¸€ä¸ªJava æ•°æ®è¯ä¹¦çš„ç®¡ç†å·¥å…· ,Keytool å°†å¯†é’¥ï¼ˆkeyï¼‰å’Œè¯ä¹¦ï¼ˆcertificatesï¼‰å­˜åœ¨ä¸€ä¸ªç§°ä¸ºkeystoreçš„æ–‡ä»¶ä¸­ åœ¨keystoreé‡Œï¼ŒåŒ…å«ä¸¤ç§æ•°æ®ï¼š å¯†é’¥å®ä½“ï¼ˆKey entityï¼‰â€”â€”å¯†é’¥ï¼ˆsecret keyï¼‰åˆæˆ–è€…æ˜¯ç§é’¥å’Œé…å¯¹å…¬é’¥ï¼ˆé‡‡ç”¨éå¯¹ç§°åŠ å¯†ï¼‰ å¯ä¿¡ä»»çš„è¯ä¹¦å®ä½“ï¼ˆtrusted certificate entriesï¼‰â€”â€”åªåŒ…å«å…¬é’¥ åœ¨æ¥è§¦ä»£ç å‰ï¼Œæˆ‘ä»¬å…ˆæ¥å¤§æ¦‚ç†Ÿæ‚‰ä¸‹å¯†é’¥ç”Ÿæˆçš„æµç¨‹å§ é¦–å…ˆè¦ç”¨KeyToolå·¥å…·æ¥ç”Ÿæˆç§åŒ™åº“ï¼šï¼ˆ-aliasåˆ«å â€“validity 3650è¡¨ç¤º10å¹´æœ‰æ•ˆï¼‰ keytool -genkey -alias privatekey -keystore privateKeys.store -keysize 1024 -validity 3650 -storepass &quot;XXXX&quot; -keypass &quot;XXXX&quot; -dname &quot;CN=test, OU=test, O=Space, L=SH, ST=SH, C=CN&quot; è¿™é‡Œå¯†ç æˆ‘ä½¿ç”¨XXXX æ³¨æ„ï¼ï¼ï¼é»˜è®¤çš„å¯†ç ç­–ç•¥æ˜¯6ä½æ•°å­—ä¸å­—æ¯ï¼Œå¦‚æœä¸éµå®ˆä¼šæŠ¥é”™ è¿™ä¸ªæ—¶å€™ï¼Œä¼šåœ¨æ‰“å¼€å‘½ä»¤è¡Œçš„åœ°æ–¹åˆ›å»ºå‡ºä¸€ä¸ªæ–‡ä»¶ï¼ŒprivateKeys.store ç„¶åæŠŠç§åŒ™åº“å†…çš„è¯ä¹¦å¯¼å‡ºåˆ°ä¸€ä¸ªæ–‡ä»¶å½“ä¸­ï¼š keytool -export -alias privatekey -file certfile.cer -keystore privateKeys.store ç”Ÿæˆcertfile.cer(è¯ä¹¦)ï¼Œç”Ÿæˆå…¬é’¥åº“åå°±æ²¡ä»€ä¹ˆç”¨äº† ç„¶åå†æŠŠè¿™ä¸ªè¯ä¹¦æ–‡ä»¶å¯¼å…¥åˆ°å…¬åŒ™åº“ï¼š keytool -import -alias publiccert -file certfile.cer -keystore publicCerts.store ç”Ÿæˆ publicCerts.store privateKeys.keystoreï¼šç§é’¥ï¼Œè¿™ä¸ªæˆ‘ä»¬è‡ªå·±ç•™ç€ï¼Œä¸èƒ½æ³„éœ²ç»™åˆ«äººã€‚ publicCerts.keystoreï¼šå…¬é’¥ï¼Œè¿™ä¸ªç»™å®¢æˆ·ç”¨çš„ã€‚åœ¨æˆ‘ä»¬ç¨‹åºé‡Œé¢å°±æ˜¯ç”¨ä»–é…åˆlicenseè¿›è¡Œæˆæƒä¿¡æ¯çš„æ ¡éªŒçš„ã€‚ certfile.cerï¼šè¿™ä¸ªæ–‡ä»¶æ²¡å•¥ç”¨ï¼Œå¯ä»¥åˆ æ‰ã€‚ æœ€åè‡ªè¡Œå°†ç”Ÿæˆæ–‡ä»¶privateKeys.storeã€publicCerts.storeæ‹·è´å‡ºæ¥å¤‡ç”¨ã€‚ å®ç°ä»£ç  - è¯ä¹¦ç”Ÿæˆ mavenä¾èµ– &lt;!--truelicense ä¾èµ–--&gt; &lt;!-- https://mvnrepository.com/artifact/de.schlichtherle.truelicense/truelicense-core --&gt; &lt;dependency&gt; &lt;groupId&gt;de.schlichtherle.truelicense&lt;/groupId&gt; &lt;artifactId&gt;truelicense-core&lt;/artifactId&gt; &lt;version&gt;1.33&lt;/version&gt; &lt;/dependency&gt; é¦–å…ˆä»æ•´ä¸ªæµç¨‹ä¸Šæ¥è®²ï¼Œç°åœ¨è¿™æ­¥æ˜¯è¯ä¹¦ç”Ÿæˆï¼Œè¯ä¹¦ç”Ÿæˆéœ€è¦ç§é’¥åº“å’Œè¯ä¹¦å‚æ•° åœ¨è¿™ä¸ªå¼•æ“ä¸­ï¼Œå…¬/ç§é’¥åº“é»˜è®¤æ˜¯å­˜å‚¨åœ¨é¡¹ç›®ä¸­çš„ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œéƒ½æ˜¯å°†é…ç½®æ–‡ä»¶ç­‰è„±ç¦»é¡¹ç›®éƒ¨ç½²çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é‡å†™å®ƒè·å–å…¬/ç§é’¥åº“çš„åœ°æ–¹ã€‚ CustomKeyStoreParam.java import de.schlichtherle.license.AbstractKeyStoreParam; import org.springframework.util.ResourceUtils; import java.io.*; /** * è‡ªå®šä¹‰KeyStoreParamï¼Œç”¨äºå°†å…¬ç§é’¥å­˜å‚¨æ–‡ä»¶å­˜æ”¾åˆ°å…¶ä»–ç£ç›˜ä½ç½®è€Œä¸æ˜¯é¡¹ç›®ä¸­ã€‚ç°åœºä½¿ç”¨çš„æ—¶å€™å…¬é’¥å¤§éƒ¨åˆ†éƒ½ä¸ä¼šæ”¾åœ¨é¡¹ç›®ä¸­çš„ */ public class CustomKeyStoreParam extends AbstractKeyStoreParam { /** * å…¬é’¥/ç§é’¥åœ¨ç£ç›˜ä¸Šçš„å­˜å‚¨è·¯å¾„ */ private final String storePath; private final String alias; private final String storePwd; private final String keyPwd; public CustomKeyStoreParam(Class clazz, String resource, String alias, String storePwd, String keyPwd) { super(clazz, resource); this.storePath = resource; this.alias = alias; this.storePwd = storePwd; this.keyPwd = keyPwd; } @Override public String getAlias() { return alias; } @Override public String getStorePwd() { return storePwd; } @Override public String getKeyPwd() { return keyPwd; } /** * AbstractKeyStoreParamé‡Œé¢çš„getStream()æ–¹æ³•é»˜è®¤æ–‡ä»¶æ˜¯å­˜å‚¨çš„é¡¹ç›®ä¸­ã€‚ * ç”¨äºå°†å…¬ç§é’¥å­˜å‚¨æ–‡ä»¶å­˜æ”¾åˆ°å…¶ä»–ç£ç›˜ä½ç½®è€Œä¸æ˜¯é¡¹ç›®ä¸­ */ @Override public InputStream getStream() throws IOException { // return new FileInputStream(new File(storePath)); File file = ResourceUtils.getFile(storePath); if (file.exists()) { return new FileInputStream(file); } else { throw new FileNotFoundException(storePath); } } } è¯ä¹¦å‚æ•°å¯ä»¥ç”¨é…ç½®æ–‡ä»¶é…ç½®ï¼Œä¹Ÿå¯ä»¥å†™æˆç±»ï¼Œè¿™ä¸ªæ–¹æ³•ç”¨çš„å°±æ˜¯ç±»çš„æ–¹å¼ License.java import lombok.Data; import java.io.Serializable; import java.util.Date; /** * Licenseç”Ÿæˆç±»éœ€è¦çš„å‚æ•° */ @Data public class License implements Serializable { private static final long serialVersionUID = -7793154252684580872L; /** * è¯ä¹¦subject */ private String subject; /** * ç§é’¥åˆ«ç§° */ private String privateAlias; /** * ç§é’¥å¯†ç ï¼ˆéœ€è¦å¦¥å–„ä¿ç®¡ï¼Œä¸èƒ½è®©ä½¿ç”¨è€…çŸ¥é“ï¼‰ */ private String keyPass; /** * è®¿é—®ç§é’¥åº“çš„å¯†ç  */ private String storePass; /** * è¯ä¹¦ç”Ÿæˆè·¯å¾„ */ private String licensePath; /** * ç§é’¥åº“å­˜å‚¨è·¯å¾„ */ private String privateKeysStorePath; /** * è¯ä¹¦ç”Ÿæ•ˆæ—¶é—´ */ private Date issuedTime = new Date(); /** * è¯ä¹¦å¤±æ•ˆæ—¶é—´ */ private Date expiryTime; /** * ç”¨æˆ·ç±»å‹ */ private String consumerType = &quot;user&quot;; /** * ç”¨æˆ·æ•°é‡ */ private Integer consumerAmount = 1; /** * æè¿°ä¿¡æ¯ */ private String description = &quot;&quot;; /** * é¢å¤–çš„æœåŠ¡å™¨ç¡¬ä»¶æ ¡éªŒä¿¡æ¯ */ private LicenseExtraModel licenseExtraModel; } å…¶ä¸­çš„æ‰©å±•å‚æ•°ç±» /** * è‡ªå®šä¹‰éœ€è¦æ ¡éªŒçš„Licenseå‚æ•°ï¼Œå¯ä»¥å¢åŠ ä¸€äº›é¢å¤–éœ€è¦æ ¡éªŒçš„å‚æ•°ï¼Œæ¯”å¦‚é¡¹ç›®ä¿¡æ¯ï¼Œipåœ°å€ä¿¡æ¯ç­‰ç­‰ï¼Œå¾…å®Œå–„ */ public class LicenseExtraModel { // è¿™é‡Œå¯ä»¥æ·»åŠ ä¸€äº›å¾€å¤–çš„è‡ªå®šä¹‰ä¿¡æ¯ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥å¢åŠ é¡¹ç›®éªŒè¯ï¼Œå®¢æˆ·ç”µè„‘snç çš„éªŒè¯ç­‰ç­‰ } ç”±äºå¼•æ“æœ¬èº«é»˜è®¤åªéªŒè¯äº†æœ‰æ•ˆæœŸï¼Œå½“æˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªç»§æ‰¿äºLicenseManagerçš„è‡ªå®šä¹‰è¯ä¹¦ç®¡ç†å™¨ã€‚ é¢å¤–çš„ä¿¡æ¯çš„æ ¡éªŒå¯ä»¥åŠ åœ¨validate()æ–¹æ³•é‡Œ CustomLicenseManager.java import de.schlichtherle.license.*; import de.schlichtherle.xml.GenericCertificate; import de.schlichtherle.xml.XMLConstants; import org.apache.logging.log4j.LogManager; import org.apache.logging.log4j.Logger; import java.beans.XMLDecoder; import java.io.BufferedInputStream; import java.io.ByteArrayInputStream; import java.io.UnsupportedEncodingException; import java.util.Date; /** * è‡ªå®šä¹‰LicenseManagerï¼Œç”¨äºå¢åŠ é¢å¤–çš„ä¿¡æ¯æ ¡éªŒ(é™¤äº†LicenseManagerçš„æ ¡éªŒï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨è¿™ä¸ªç±»é‡Œé¢æ·»åŠ é¢å¤–çš„æ ¡éªŒä¿¡æ¯) */ public class CustomLicenseManager extends LicenseManager { private static Logger logger = LogManager.getLogger(CustomLicenseManager.class); public CustomLicenseManager(LicenseParam param) { super(param); } /** * å¤å†™createæ–¹æ³• */ @Override protected synchronized byte[] create(LicenseContent content, LicenseNotary notary) throws Exception { initialize(content); this.validateCreate(content); final GenericCertificate certificate = notary.sign(content); return getPrivacyGuard().cert2key(certificate); } /** * å¤å†™installæ–¹æ³•ï¼Œå…¶ä¸­validateæ–¹æ³•è°ƒç”¨æœ¬ç±»ä¸­çš„validateæ–¹æ³•ï¼Œæ ¡éªŒIPåœ°å€ã€Macåœ°å€ç­‰å…¶ä»–ä¿¡æ¯ */ @Override protected synchronized LicenseContent install(final byte[] key, final LicenseNotary notary) throws Exception { final GenericCertificate certificate = getPrivacyGuard().key2cert(key); notary.verify(certificate); final LicenseContent content = (LicenseContent) this.load(certificate.getEncoded()); this.validate(content); setLicenseKey(key); setCertificate(certificate); return content; } /** * å¤å†™verifyæ–¹æ³•ï¼Œè°ƒç”¨æœ¬ç±»ä¸­çš„validateæ–¹æ³•ï¼Œæ ¡éªŒIPåœ°å€ã€Macåœ°å€ç­‰å…¶ä»–ä¿¡æ¯ */ @Override protected synchronized LicenseContent verify(final LicenseNotary notary) throws Exception { // Load license key from preferences, final byte[] key = getLicenseKey(); if (null == key) { throw new NoLicenseInstalledException(getLicenseParam().getSubject()); } GenericCertificate certificate = getPrivacyGuard().key2cert(key); notary.verify(certificate); final LicenseContent content = (LicenseContent) this.load(certificate.getEncoded()); this.validate(content); setCertificate(certificate); return content; } /** * æ ¡éªŒç”Ÿæˆè¯ä¹¦çš„å‚æ•°ä¿¡æ¯ */ protected synchronized void validateCreate(final LicenseContent content) throws LicenseContentException { final LicenseParam param = getLicenseParam(); final Date now = new Date(); final Date notBefore = content.getNotBefore(); final Date notAfter = content.getNotAfter(); if (null != notAfter &amp;&amp; now.after(notAfter)) { throw new LicenseContentException(&quot;è¯ä¹¦å¤±æ•ˆæ—¶é—´ä¸èƒ½æ—©äºå½“å‰æ—¶é—´&quot;); } if (null != notBefore &amp;&amp; null != notAfter &amp;&amp; notAfter.before(notBefore)) { throw new LicenseContentException(&quot;è¯ä¹¦ç”Ÿæ•ˆæ—¶é—´ä¸èƒ½æ™šäºè¯ä¹¦å¤±æ•ˆæ—¶é—´&quot;); } final String consumerType = content.getConsumerType(); if (null == consumerType) { throw new LicenseContentException(&quot;ç”¨æˆ·ç±»å‹ä¸èƒ½ä¸ºç©º&quot;); } } /** * å¤å†™validateæ–¹æ³•ï¼Œç”¨äºå¢åŠ æˆ‘ä»¬é¢å¤–çš„æ ¡éªŒä¿¡æ¯ */ @Override protected synchronized void validate(final LicenseContent content) throws LicenseContentException { //1. é¦–å…ˆè°ƒç”¨çˆ¶ç±»çš„validateæ–¹æ³• super.validate(content); //2. ç„¶åæ ¡éªŒè‡ªå®šä¹‰çš„Licenseå‚æ•°ï¼Œå»æ ¡éªŒæˆ‘ä»¬çš„licenseä¿¡æ¯ // LicenseExtraModel expectedCheckModel = (LicenseExtraModel) content.getExtra(); // åšæˆ‘ä»¬è‡ªå®šä¹‰çš„æ ¡éªŒ } /** * é‡å†™XMLDecoderè§£æXML */ private Object load(String encoded) { BufferedInputStream inputStream = null; XMLDecoder decoder = null; try { inputStream = new BufferedInputStream(new ByteArrayInputStream(encoded.getBytes(XMLConstants.XML_CHARSET))); decoder = new XMLDecoder(new BufferedInputStream(inputStream, XMLConstants.DEFAULT_BUFSIZE), null, null); return decoder.readObject(); } catch (UnsupportedEncodingException e) { e.printStackTrace(); } finally { try { if (decoder != null) { decoder.close(); } if (inputStream != null) { inputStream.close(); } } catch (Exception e) { logger.error(&quot;XMLDecoderè§£æXMLå¤±è´¥&quot;, e); } } return null; } } å‰é¢çš„æ‰€æœ‰å¯ä»¥è¯´éƒ½æ˜¯ä¸ºäº†æ•´ä¸ªæµç¨‹åœ¨é“ºå«ï¼Œç°åœ¨å¼€å§‹æ˜¯çœŸæ­£å¼€å§‹ç”ŸæˆLicenseè¯ä¹¦çš„ä»£ç  LicenseCreator.java import de.schlichtherle.license.*; import org.apache.logging.log4j.LogManager; import org.apache.logging.log4j.Logger; import javax.security.auth.x500.X500Principal; import java.io.File; import java.text.MessageFormat; import java.util.prefs.Preferences; /** * Licenseç”Ÿæˆç±» -- ç”¨äºlicenseç”Ÿæˆ */ public class LicenseCreator { private final static X500Principal DEFAULT_HOLDER_AND_ISSUER = new X500Principal(&quot;CN=Haier, OU=Haier, O=Space, L=SH, ST=SH, C=CN&quot;); private static final Logger logger = LogManager.getLogger(LicenseCreator.class); private final License license; public LicenseCreator(License license) { this.license = license; } /** * ç”ŸæˆLicenseè¯ä¹¦ */ public boolean generateLicense() { try { LicenseManager licenseManager = new CustomLicenseManager(initLicenseParam()); LicenseContent licenseContent = initLicenseContent(); licenseManager.store(licenseContent, new File(license.getLicensePath())); return true; } catch (Exception e) { logger.error(MessageFormat.format(&quot;è¯ä¹¦ç”Ÿæˆå¤±è´¥ï¼š{0}&quot;, license), e); return false; } } /** * åˆå§‹åŒ–è¯ä¹¦ç”Ÿæˆå‚æ•° */ private LicenseParam initLicenseParam() { Preferences preferences = Preferences.userNodeForPackage(LicenseCreator.class); //è®¾ç½®å¯¹è¯ä¹¦å†…å®¹åŠ å¯†çš„ç§˜é’¥ CipherParam cipherParam = new DefaultCipherParam(license.getStorePass()); KeyStoreParam privateStoreParam = new CustomKeyStoreParam(LicenseCreator.class, license.getPrivateKeysStorePath(), license.getPrivateAlias(), license.getStorePass(), license.getKeyPass()); return new DefaultLicenseParam(license.getSubject(), preferences, privateStoreParam, cipherParam); } /** * è®¾ç½®è¯ä¹¦ç”Ÿæˆæ­£æ–‡ä¿¡æ¯ */ private LicenseContent initLicenseContent() { LicenseContent licenseContent = new LicenseContent(); licenseContent.setHolder(DEFAULT_HOLDER_AND_ISSUER); licenseContent.setIssuer(DEFAULT_HOLDER_AND_ISSUER); licenseContent.setSubject(license.getSubject()); licenseContent.setIssued(license.getIssuedTime()); licenseContent.setNotBefore(license.getIssuedTime()); licenseContent.setNotAfter(license.getExpiryTime()); licenseContent.setConsumerType(license.getConsumerType()); licenseContent.setConsumerAmount(license.getConsumerAmount()); licenseContent.setInfo(license.getDescription()); //æ‰©å±•æ ¡éªŒï¼Œè¿™é‡Œå¯ä»¥è‡ªå®šä¹‰ä¸€äº›é¢å¤–çš„æ ¡éªŒä¿¡æ¯(ä¹Ÿå¯ä»¥ç”¨jsonå­—ç¬¦ä¸²ä¿å­˜) if (license.getLicenseExtraModel() != null) { licenseContent.setExtra(license.getLicenseExtraModel()); } return licenseContent; } } æµ‹è¯• - è¯ä¹¦ç”Ÿæˆ ç¯å¢ƒå·¥å…·ç±»éƒ½å‡†å¤‡å¥½äº†ï¼Œæ¥ä¸‹æ¥ç›´æ¥å¼€å§‹æµ‹è¯•ï¼Œçœ‹çœ‹èƒ½å¦ç”Ÿæˆ @Test void generateLicense() { // ç”Ÿæˆlicenseéœ€è¦çš„ä¸€äº›å‚æ•° License param = new License(); // è¯ä¹¦æˆæƒä¸»ä½“ param.setSubject(&quot;licenseTest&quot;); // ç§é’¥åˆ«å param.setPrivateAlias(&quot;privateKey&quot;); // ç§é’¥å¯†ç ï¼ˆéœ€è¦å¦¥å–„ä¿ç®¡ï¼Œä¸èƒ½è®©ä½¿ç”¨è€…çŸ¥é“ï¼‰ param.setKeyPass(&quot;xxxx&quot;); // è®¿é—®ç§é’¥åº“çš„å¯†ç  param.setStorePass(&quot;xxxx&quot;); // è¯ä¹¦å­˜å‚¨åœ°å€ param.setLicensePath(&quot;E:\\\\license2\\\\license.lic&quot;); // ç§é’¥åº“æ‰€åœ¨åœ°å€ param.setPrivateKeysStorePath(&quot;E:\\\\license\\\\privateKeys.store&quot;); // è¯ä¹¦ç”Ÿæ•ˆæ—¶é—´ Calendar issueCalendar = Calendar.getInstance(); param.setIssuedTime(issueCalendar.getTime()); // è¯ä¹¦å¤±æ•ˆæ—¶é—´ Calendar expiryCalendar = Calendar.getInstance(); // è®¾ç½®å½“å‰æ—¶é—´ expiryCalendar.setTime(new Date()); // å¾€åå»¶é•¿ä¸€å¹´ = æˆæƒä¸€å¹´æ—¶é—´ expiryCalendar.add(Calendar.YEAR,1); param.setExpiryTime(expiryCalendar.getTime()); // ç”¨æˆ·ç±»å‹ param.setConsumerType(&quot;user&quot;); // ç”¨æˆ·æ•°é‡ param.setConsumerAmount(1); // æè¿° param.setDescription(&quot;æµ‹è¯•&quot;); LicenseCreator licenseCreator = new LicenseCreator(param); // ç”Ÿæˆlicense licenseCreator.generateLicense(); } ä»£ç å®ç° - è¯ä¹¦å®‰è£…å’Œæ ¡éªŒ å°±åƒè¯ä¹¦ç”Ÿæˆï¼ŒéªŒè¯ä¹Ÿéœ€è¦ä¸€ä¸ªä¸“é—¨çš„ç±» LicenseVerify.java import de.schlichtherle.license.*; import org.apache.logging.log4j.LogManager; import org.apache.logging.log4j.Logger; import java.io.File; import java.text.DateFormat; import java.text.MessageFormat; import java.text.SimpleDateFormat; import java.util.prefs.Preferences; /** * Licenseæ ¡éªŒç±» */ public class LicenseVerify { private static Logger logger = LogManager.getLogger(LicenseVerify.class); /** * è¯ä¹¦subject */ private final String subject; /** * å…¬é’¥åˆ«ç§° */ private final String publicAlias; /** * è®¿é—®å…¬é’¥åº“çš„å¯†ç  */ private final String storePass; /** * è¯ä¹¦ç”Ÿæˆè·¯å¾„ */ private final String licensePath; /** * å¯†é’¥åº“å­˜å‚¨è·¯å¾„ */ private final String publicKeysStorePath; /** * LicenseManager */ private LicenseManager licenseManager; /** * æ ‡è¯†è¯ä¹¦æ˜¯å¦å®‰è£…æˆåŠŸ */ private boolean installSuccess; public LicenseVerify(String subject, String publicAlias, String storePass, String licensePath, String publicKeysStorePath) { this.subject = subject; this.publicAlias = publicAlias; this.storePass = storePass; this.licensePath = licensePath; this.publicKeysStorePath = publicKeysStorePath; } /** * å®‰è£…Licenseè¯ä¹¦ï¼Œè¯»å–è¯ä¹¦ç›¸å…³çš„ä¿¡æ¯, åœ¨beanåŠ å…¥å®¹å™¨çš„æ—¶å€™è‡ªåŠ¨è°ƒç”¨ */ public void installLicense() { try { Preferences preferences = Preferences.userNodeForPackage(LicenseVerify.class); CipherParam cipherParam = new DefaultCipherParam(storePass); KeyStoreParam publicStoreParam = new CustomKeyStoreParam(LicenseVerify.class, publicKeysStorePath, publicAlias, storePass, null); LicenseParam licenseParam = new DefaultLicenseParam(subject, preferences, publicStoreParam, cipherParam); licenseManager = new CustomLicenseManager(licenseParam); licenseManager.uninstall(); LicenseContent licenseContent = licenseManager.install(new File(licensePath)); DateFormat format = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;); installSuccess = true; logger.info(&quot;------------------------------- è¯ä¹¦å®‰è£…æˆåŠŸ -------------------------------&quot;); logger.info(MessageFormat.format(&quot;è¯ä¹¦æœ‰æ•ˆæœŸï¼š{0} - {1}&quot;, format.format(licenseContent.getNotBefore()), format.format(licenseContent.getNotAfter()))); } catch (Exception e) { installSuccess = false; logger.error(&quot;------------------------------- è¯ä¹¦å®‰è£…å¤±è´¥ -------------------------------&quot;); logger.error(e); } } /** * å¸è½½è¯ä¹¦ï¼Œåœ¨beanä»å®¹å™¨ç§»é™¤çš„æ—¶å€™è‡ªåŠ¨è°ƒç”¨ */ public void unInstallLicense() { if (installSuccess) { try { licenseManager.uninstall(); } catch (Exception e) { // ignore } } } /** * æ ¡éªŒLicenseè¯ä¹¦ */ public boolean verify() { try { licenseManager.verify(); return true; } catch (Exception e) { return false; } } } æˆ‘ä»¬ä¹‹å‰è¯´äº†ï¼Œé™¤äº†é¡¹ç›®è®¸å¤šçš„é…ç½®æ–‡ä»¶æˆ‘ä»¬ä¸€èˆ¬æ˜¯éœ€è¦æ”¾åœ¨æœåŠ¡å™¨å•ç‹¬çš„è·¯å¾„ä¸‹çš„ï¼Œé™¤äº†å…¬é’¥å’Œç§é’¥åº“ï¼Œè¿˜æœ‰æˆ‘ä»¬éªŒè¯éœ€è¦é…ç½®çš„ä¸€äº›å‚æ•° application.yml #Licenseç›¸å…³é…ç½® license: subject: licenseTest #ä¸»ä½“ - æ³¨æ„ä¸»ä½“è¦ä¸ç”Ÿæˆè¯ä¹¦çš„ä¸»ä½“ä¸€è‡´ä¸€è‡´ï¼Œä¸ç„¶éªŒè¯é€šè¿‡ä¸äº† publicAlias: publicCert #å…¬é’¥åˆ«ç§° storePass: 123456q #è®¿é—®å…¬é’¥çš„å¯†ç  licensePath: E:\\license2\\license.lic #licenseä½ç½® publicKeysStorePath: E:\\license\\publicCerts.store #å…¬é’¥ä½ç½® è¿™äº›å‚æ•°ä»£ç è·å–å¦‚ä¸‹ LicenseConfig.java import lombok.Data; import org.springframework.boot.context.properties.ConfigurationProperties; import org.springframework.context.annotation.Bean; import org.springframework.stereotype.Component; @Data @Component @ConfigurationProperties(prefix = &quot;license&quot;) public class LicenseConfig { /** * è¯ä¹¦subject */ private String subject; /** * å…¬é’¥åˆ«ç§° */ private String publicAlias; /** * è®¿é—®å…¬é’¥åº“çš„å¯†ç  */ private String storePass; /** * è¯ä¹¦ç”Ÿæˆè·¯å¾„ */ private String licensePath; /** * å¯†é’¥åº“å­˜å‚¨è·¯å¾„ */ private String publicKeysStorePath; @Bean(initMethod = &quot;installLicense&quot;, destroyMethod = &quot;unInstallLicense&quot;) public LicenseVerify licenseVerify() { return new LicenseVerify(subject, publicAlias, storePass, licensePath, publicKeysStorePath); } } ä»¥ä¸Šä»£ç æ˜¯è¯»å–ymlçš„é…ç½®ï¼Œä»¥åŠå°†LicenseConfigåŠ å…¥Springå®¹å™¨ï¼Œåœ¨åŠ å…¥Springå®¹å™¨çš„åŒæ—¶ï¼Œæ‰§è¡ŒlicenseVerifyé‡Œçš„å®‰è£…æ–¹æ³• è¿™æ ·ï¼Œç¨‹åºå°±ä¼šåœ¨å¯åŠ¨æ—¶ï¼Œè‡ªåŠ¨å®‰è£…è¯ä¹¦ï¼Œæ ¡éªŒæ—¶å°±å¯ä»¥ç”¨äº† @SpringBootTest @RunWith(SpringRunner.class) public class LicenseVerifyTest { private LicenseVerify licenseVerify; @Autowired public void setLicenseVerify(LicenseVerify licenseVerify) { this.licenseVerify = licenseVerify; } @Test public void licenseVerify() { System.out.println(&quot;liceseæ˜¯å¦æœ‰æ•ˆï¼š&quot; + licenseVerify.verify()); } } ","link":"https://tianxiawuhao.github.io/GEPNPC2k-/"},{"title":"åˆ‡é¢é“¾å®ç°","content":"åˆ‡é¢é“¾å®ç° /** * æœåŠ¡åˆ‡é¢æ¥å£ï¼Œç”¨æ¥å¹²é¢„æœåŠ¡ */ public interface ServiceAspect { /** * ä¸Šä¼ ï¼ŒæˆåŠŸè¿”å›æ–‡ä»¶ä¿¡æ¯ï¼Œå¤±è´¥è¿”å› null */ default serviceInfo serviceAround(ServiceAspectChain chain,ServiceInfo serviceInfo) { return chain.next(service); } } /** * æœåŠ¡çš„åˆ‡é¢è°ƒç”¨é“¾ */ @Getter @Setter public class ServiceAspectChain { private ServiceAspectChainCallback callback; private Iterator&lt;serviceAspect&gt; aspectIterator; public UploadAspectChain(Iterable&lt;ServiceAspect&gt; aspects,ServiceAspectChainCallback callback) { this.aspectIterator = aspects.iterator(); this.callback = callback; } /** * è°ƒç”¨ä¸‹ä¸€ä¸ªåˆ‡é¢(éå†æ‰§è¡Œæœ€åä¸€ä¸ª) */ public ServiceInfo next(ServiceInfo serviceInfo) { if (aspectIterator.hasNext()) {//è¿˜æœ‰ä¸‹ä¸€ä¸ª return aspectIterator.next().serviceAround(this,serviceInfo); } else { return callback.run(serviceInfo); } } /** * è°ƒç”¨ä¸‹ä¸€ä¸ªåˆ‡é¢(éå†æ‰§è¡Œæ‰€æœ‰) */ public ServiceInfo next(ServiceInfo serviceInfo) { if (aspectIterator.hasNext()) {//è¿˜æœ‰ä¸‹ä¸€ä¸ª service = aspectIterator.next().serviceAround(this,serviceInfo); return callback.run(serviceInfo); } else { return callback.run(serviceInfo); } } } /** * åˆ‡é¢è°ƒç”¨é“¾ç»“æŸå›è°ƒ */ public interface ServiceAspectChainCallback { ServiceInfo run(ServiceInfo serviceInfo); } private CopyOnWriteArrayList&lt;serviceAspect&gt; aspectList; private ServiceInfo serviceInfo; //å¤„ç†åˆ‡é¢ new ServiceAspectChain(aspectList,(_serviceInfo) -&gt; { //ä¸šåŠ¡é€»è¾‘ return _serviceInfo; }).next(serviceInfo); /** * æ¥å£å®ç°,ä½¿ç”¨åˆ‡é¢æ‰“å°æ—¥å¿— */ @Slf4j @Component public class LogServiceAspect implements ServiceAspect { @Override public serviceInfo serviceAround(ServiceAspectChain chain,ServiceInfo serviceInfo) { log.info(&quot;ä¸Šä¼ æ–‡ä»¶ before -&gt; {}&quot;,serviceInfo); serviceInfo = chain.next(serviceInfo); log.info(&quot;ä¸Šä¼ æ–‡ä»¶ after -&gt; {}&quot;,serviceInfo); return serviceInfo; } } { //è·å¾—åˆ‡é¢ List CopyOnWriteArrayList&lt;ServiceAspect&gt; list = new ArrayList(); //å¢åŠ  LogServiceAspect aspect = new LogServiceAspect(); list.add(aspect); //åˆ é™¤ list.remove(aspect); //æ¡ä»¶åˆ é™¤ list.removeIf(item -&gt; item instanceof LogServiceAspect); } ","link":"https://tianxiawuhao.github.io/DCnCuY10S/"},{"title":"å‘å¸ƒJARåŒ…åˆ°è¿œç¨‹ä¸­å¤®ä»“åº“","content":"å£°æ˜ï¼šç»è¿‡ä¸‹é¢ä¸€ç³»åˆ—æ“ä½œä¹‹åï¼Œä»¥åæƒ³å‘å¸ƒæ–°ç‰ˆæœ¬ï¼Œåªè¦ä¿®æ”¹å¥½è¦å‡çº§çš„ç‰ˆæœ¬ï¼Œç„¶ååœ¨ Mavençš„ Lifecycle é‡ŒåŒå‡» deploy å³å¯~ å‰è¨€ è‡ªä½¿ç”¨mavenä»¥æ¥ï¼Œæ²¡å°‘ä½¿ç”¨mavenä¸­å¤®ä»“åº“ä¸­çš„å„ç§jaråŒ…ï¼Œæ–¹ä¾¿æœ‰æ•ˆï¼Œä½†æ˜¯å’±ä»¬ä¹Ÿä¸èƒ½æ€»æ˜¯åªå–ä¸äºˆï¼Œä¹Ÿåº”è¯¥æ‡‚å¾—å¥‰çŒ®ï¼Œå½“ä½ å†™å¥½äº†ä¸€ä¸ªååˆ†å¥½ç”¨çš„jaråŒ…ï¼Œæƒ³è´¡çŒ®å‡ºå»ç»™å¤§å®¶ä½¿ç”¨çš„æ—¶å€™ï¼Œåº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿå½“ç„¶æ˜¯å‘å¸ƒåˆ°mavençš„ä¸­å¤®ä»“åº“äº†ï¼Œä¸è¿‡è¦è¯´è¿™ä¸ªå‘å¸ƒè¿‡ç¨‹ï¼Œè¿˜çœŸæ˜¯æ¯”è¾ƒå¤æ‚ï¼Œæœ¬æ–‡å°±æ¥è¯¦ç»†è¯´ä¸‹å¦‚ä½•å‘å¸ƒjaråŒ…åˆ°mavenä¸­å¤®ä»“åº“ã€‚ æ³¨æ„äº‹é¡¹ å·¥å•ç®¡ç†ï¼šâ€‹ â€‹https://issues.sonatype.org/secure/Dashboard.jspaâ€‹â€‹ è¯´æ˜ï¼šæ³¨å†Œè´¦å·ã€åˆ›å»ºå’Œç®¡ç†issueï¼ŒJaråŒ…çš„å‘å¸ƒæ˜¯ä»¥è§£å†³issueçš„æ–¹å¼èµ·æ­¥çš„ã€‚è¿™é‡Œçš„ç”¨æˆ·åä¸å¯†ç æ˜¯éå¸¸é‡è¦çš„ï¼Œåé¢ä¼šç”¨åˆ°ï¼Œä¸€å®šè¦ä¿å­˜å¥½ã€‚ æ„ä»¶ä»“åº“ï¼šâ€‹ â€‹https://oss.sonatype.org/#welcomeâ€‹â€‹ è¯´æ˜ï¼šç®—æ˜¯æ­£å¼å‘å¸ƒå‰çš„ä¸€ä¸ªè¿‡æ®µä»“åº“ï¼Œä½¿ç”¨mavenæäº¤åçš„jaråŒ…å…ˆåˆ°è¿™ä¸ªåº“ä¸­ã€‚ é•œåƒä»“åº“ï¼šâ€‹ â€‹http://search.maven.orgâ€‹â€‹ è¯´æ˜ï¼šæœ€ç»ˆæˆåŠŸå‘å¸ƒçš„jarå¯ä»¥åœ¨è¿™é‡Œæœåˆ°ã€‚ ä¸€ã€åˆ›å»ºå·¥å• åœ¨ä¸Šè¿°çš„â€‹â€‹å·¥å•ç®¡ç†â€‹â€‹â€‹çš„åœ°å€ä¸­è¿›è¡Œåˆ›å»ºï¼Œå¦‚æœæ²¡æœ‰è´¦å·ï¼Œéœ€è¦å…ˆæ³¨å†Œä¸€ä¸ªï¼Œè®°ä½ç”¨æˆ·åå¯†ç ï¼Œåè¾¹è¦é…ç½®åˆ°â€‹â€‹setting.xmlâ€‹â€‹ä¸­ã€‚ Create Issue å¡«å†™å†…å®¹è¯´æ˜ï¼š ===Step 1=== Projectï¼šCommunity Support - Open Source Project Repository Hosting Issue Typeï¼šNew Project ===Step 2=== Summaryï¼šJARåŒ…åç§°ï¼Œå¦‚ï¼šrequestjson Group Idï¼šä½ æ‡‚å¾—ï¼Œä¸ç”¨å¤šè¯´ï¼Œå¦‚com.luxsuen Project URLï¼šé¡¹ç›®ç«™ç‚¹ï¼Œå¦‚ï¼šhttps://github.com/LuxSun/requestjson SCM urlï¼šé¡¹ç›®æºç ä»“åº“ï¼Œå¦‚ï¼šhttps://github.com/LuxSun/requestjson.git å…¶ä»–å†…å®¹ä¸ç”¨å¡«å†™ï¼Œåˆ›å»ºIssueåéœ€è¦ç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼ŒSonatypeçš„å·¥ä½œäººå‘˜å®¡æ ¸å¤„ç†ï¼Œé€Ÿåº¦è¿˜æ˜¯å¾ˆå¿«çš„ï¼Œä¸€èˆ¬ä¸€ä¸ªå·¥ä½œæ—¥ä»¥å†…ï¼Œå½“Issueçš„Statuså˜ä¸ºRESOLVEDåï¼Œå°±å¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œäº†ï¼Œå¦åˆ™ï¼Œå°±ç­‰å¾…â€¦ åˆ°è¿™é‡Œï¼Œéœ€è¦è·Ÿå®¢æœå” å—‘ä¸€ä¸‹~ï¼ˆä»¥å‰è¿™ä¸€æ­¥å®¡æ ¸å¾ˆç®€å•ï¼Œè·Ÿå®¢æœè¯´æ˜¯ä½ çš„å³å¯ï¼Œç°åœ¨å¼€å§‹è¦æä¾›è¯æ˜ï¼‰ å¦‚æœæ˜¯ç”¨Githubï¼Œå°±æ— éœ€æ³¨å†ŒåŸŸåï¼Œç›´æ¥æ ¹æ®å®¢æœæç¤ºè¯æ˜ä¸€ä¸‹å³å¯ï¼ˆæ–°æ‰‹æ¨èï¼‰ã€‚ å¦‚æœæ˜¯ç”¨è‡ªå·±çš„åŸŸåï¼Œå°±éœ€è¦æ ¹æ®å®¢æœçš„æç¤ºé…ç½®ä¸‹DNSã€‚ â€‹ Psï¼šæ— è®ºä»¥ä¸Šæ˜¯å“ªç§æƒ…å†µï¼Œæœ€ååªè¦å‘ˆç°å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå³ä»£è¡¨æˆåŠŸï¼ äºŒã€é…ç½®Mavenï¼ˆpom.xmlï¼‰ æ¥ä¸‹æ¥å°±æ˜¯é‡å¤´æˆäº†ï¼Œpom.xmlæ˜¯ä¸€ä¸ªmavené¡¹ç›®çš„é‡ç‚¹é…ç½®ï¼Œä¸€ä¸ªé¡¹ç›®çš„æ‰€æœ‰é…ç½®éƒ½å¯ä»¥ç”±è¿™ä¸ªæ–‡ä»¶æ¥æè¿°ï¼Œæ–‡ä»¶ä¸­çš„æ‰€æœ‰é…ç½®éƒ½æœ‰é»˜è®¤å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰çš„é…ç½®éƒ½æ˜¯å¯é€‰é…ç½®ï¼Œä½†æ˜¯ä¸ºäº†æŠŠæ„ä»¶å‘å¸ƒåˆ°ä¸­å¤®ä»“åº“ï¼Œæˆ‘ä»¬å¿…é¡»é…ç½®ä¸€äº›å…³é”®ä¿¡æ¯ï¼Œå¦åˆ™å†å‘å¸ƒæ—¶æ˜¯ä¸ä¼šé€šè¿‡äº†ã€‚ åœ¨å·¥ç¨‹çš„pom.xmlæ–‡ä»¶ä¸­ï¼Œå¼•å…¥Sonatypeå®˜æ–¹çš„ä¸€ä¸ªé€šç”¨é…ç½®â€‹â€‹oss-parentâ€‹â€‹ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯å¾ˆå¤špom.xmlçš„å‘å¸ƒé…ç½®ä¸éœ€è¦è‡ªå·±é…ç½®äº†ï¼š &lt;parent&gt; &lt;groupId&gt;org.sonatype.oss&lt;/groupId&gt; &lt;artifactId&gt;oss-parent&lt;/artifactId&gt; &lt;version&gt;7&lt;/version&gt; &lt;/parent&gt; å¹¶å¢åŠ Licensesã€SCMã€Developersä¿¡æ¯ï¼š &lt;licenses&gt; &lt;license&gt; &lt;name&gt;The Apache Software License, Version 2.0&lt;/name&gt; &lt;url&gt;http://www.apache.org/licenses/LICENSE-2.0.txt&lt;/url&gt; &lt;distribution&gt;repo&lt;/distribution&gt; &lt;/license&gt; &lt;/licenses&gt; &lt;developers&gt; &lt;developer&gt; &lt;name&gt;Lux Sun&lt;/name&gt; &lt;email&gt;28554482@qq.com&lt;/email&gt; &lt;organization&gt;Lux Sun&lt;/organization&gt; &lt;url&gt;https://github.com/LuxSun&lt;/url&gt; &lt;/developer&gt; &lt;/developers&gt; &lt;scm&gt; &lt;url&gt;https://github.com/LuxSun/requestjson&lt;/url&gt; &lt;connection&gt;https://github.com/LuxSun/requestjson.git&lt;/connection&gt; &lt;/scm&gt; ä¿®æ”¹mavené…ç½®æ–‡ä»¶setting.xmlï¼Œåœ¨serversä¸­å¢åŠ serveré…ç½®ã€‚ &lt;servers&gt; &lt;server&gt; &lt;id&gt;sonatype-nexus-snapshots&lt;/id&gt; &lt;username&gt;Sonatype è´¦å·&lt;/username&gt; &lt;password&gt;Sonatype å¯†ç &lt;/password&gt; &lt;/server&gt; &lt;server&gt; &lt;id&gt;sonatype-nexus-staging&lt;/id&gt; &lt;username&gt;Sonatype è´¦å·&lt;/username&gt; &lt;password&gt;Sonatype å¯†ç &lt;/password&gt; &lt;/server&gt; &lt;/servers&gt; æ ¹æ®å®˜æ–¹æŒ‡å—ï¼Œè¿™é‡Œéœ€è¦4ä¸ªæ’ä»¶ï¼Œ maven-source-plugin ç”¨æ¥ç”ŸæˆSource Jaræ–‡ä»¶ maven-javadoc-plugin ç”¨æ¥ç”Ÿæˆ javadoc æ–‡æ¡£ maven-gpg-plugin ç”¨æ¥å¯¹å·¥ç¨‹æ–‡ä»¶è¿›è¡Œè‡ªåŠ¨ç­¾å nexus-staging-maven-plugin ç”¨æ¥å°†å·¥ç¨‹å‘å¸ƒåˆ°ä¸­å¤®ä»“åº“ å¦å¤–æ³¨æ„ç”Ÿæˆjavadocæ–‡æ¡£æ—¶éœ€è¦æŒ‡å®šå…³é—­doclintï¼Œä¸ç„¶å¯èƒ½å› ä¸ºä½¿ç”¨äº†ä¸è§„èŒƒçš„javadocæ³¨è§£è€Œå¯¼è‡´å¤±è´¥ï¼Œå®Œæ•´é…ç½®å¦‚ä¸‹ã€‚ å®Œæ•´ç‰ˆ &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;groupId&gt;com.luxsuen&lt;/groupId&gt; &lt;artifactId&gt;requestjson&lt;/artifactId&gt; &lt;version&gt;1.0.1&lt;/version&gt; &lt;packaging&gt;jar&lt;/packaging&gt; &lt;name&gt;requestjson&lt;/name&gt; &lt;description&gt;RequestJson&lt;/description&gt; &lt;url&gt;https://github.com/LuxSun/requestjson&lt;/url&gt; &lt;properties&gt; &lt;spring.version&gt;4.3.2.RELEASE&lt;/spring.version&gt; &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt; &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt; &lt;maven.compiler.encoding&gt;UTF-8&lt;/maven.compiler.encoding&gt; &lt;/properties&gt; &lt;licenses&gt; &lt;license&gt; &lt;name&gt;The Apache Software License, Version 2.0&lt;/name&gt; &lt;url&gt;http://www.apache.org/licenses/LICENSE-2.0.txt&lt;/url&gt; &lt;distribution&gt;repo&lt;/distribution&gt; &lt;/license&gt; &lt;/licenses&gt; &lt;developers&gt; &lt;developer&gt; &lt;name&gt;Lux Sun&lt;/name&gt; &lt;email&gt;28554482@qq.com&lt;/email&gt; &lt;organization&gt;Lux Sun&lt;/organization&gt; &lt;url&gt;https://github.com/LuxSun&lt;/url&gt; &lt;/developer&gt; &lt;/developers&gt; &lt;scm&gt; &lt;url&gt;https://github.com/LuxSun/requestjson&lt;/url&gt; &lt;connection&gt;https://github.com/LuxSun/requestjson.git&lt;/connection&gt; &lt;/scm&gt; &lt;distributionManagement&gt; &lt;snapshotRepository&gt; &lt;id&gt;ossrh&lt;/id&gt; &lt;name&gt;oss Snapshots Repository&lt;/name&gt; &lt;url&gt;https://oss.sonatype.org/content/repositories/snapshots&lt;/url&gt; &lt;/snapshotRepository&gt; &lt;repository&gt; &lt;id&gt;ossrh&lt;/id&gt; &lt;name&gt;oss Staging Repository&lt;/name&gt; &lt;url&gt;https://oss.sonatype.org/service/local/staging/deploy/maven2/&lt;/url&gt; &lt;/repository&gt; &lt;/distributionManagement&gt; &lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt; &lt;version&gt;3.1&lt;/version&gt; &lt;configuration&gt; &lt;source&gt;1.8&lt;/source&gt; &lt;target&gt;1.8&lt;/target&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt; &lt;version&gt;3.0.2&lt;/version&gt; &lt;executions&gt; &lt;execution&gt; &lt;id&gt;default-jar&lt;/id&gt; &lt;phase&gt;package&lt;/phase&gt; &lt;goals&gt; &lt;goal&gt;jar&lt;/goal&gt; &lt;/goals&gt; &lt;/execution&gt; &lt;/executions&gt; &lt;configuration&gt; &lt;excludes&gt; &lt;exclude&gt;**/spring/&lt;/exclude&gt; &lt;exclude&gt;**/com/luxsuen/requestjson/entity/&lt;/exclude&gt; &lt;exclude&gt;**/com/luxsuen/requestjson/web/&lt;/exclude&gt; &lt;exclude&gt;**/META-INF/*.kotlin_module&lt;/exclude&gt; &lt;/excludes&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt; &lt;profiles&gt; &lt;profile&gt; &lt;id&gt;release&lt;/id&gt; &lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-source-plugin&lt;/artifactId&gt; &lt;version&gt;2.2.1&lt;/version&gt; &lt;executions&gt; &lt;execution&gt; &lt;id&gt;attach-sources&lt;/id&gt; &lt;goals&gt; &lt;goal&gt;jar-no-fork&lt;/goal&gt; &lt;/goals&gt; &lt;/execution&gt; &lt;/executions&gt; &lt;configuration&gt; &lt;excludes&gt; &lt;exclude&gt;**/spring/&lt;/exclude&gt; &lt;exclude&gt;**/com/luxsuen/requestjson/entity/&lt;/exclude&gt; &lt;exclude&gt;**/com/luxsuen/requestjson/web/&lt;/exclude&gt; &lt;exclude&gt;**/META-INF/*.kotlin_module&lt;/exclude&gt; &lt;/excludes&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-javadoc-plugin&lt;/artifactId&gt; &lt;version&gt;2.9.1&lt;/version&gt; &lt;executions&gt; &lt;execution&gt; &lt;id&gt;attach-javadocs&lt;/id&gt; &lt;goals&gt; &lt;goal&gt;jar&lt;/goal&gt; &lt;/goals&gt; &lt;/execution&gt; &lt;/executions&gt; &lt;configuration&gt; &lt;excludePackageNames&gt;com.luxsuen.requestjson.entity:com.luxsuen.requestjson.web&lt;/excludePackageNames&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-gpg-plugin&lt;/artifactId&gt; &lt;version&gt;1.5&lt;/version&gt; &lt;executions&gt; &lt;execution&gt; &lt;id&gt;sign-artifacts&lt;/id&gt; &lt;phase&gt;verify&lt;/phase&gt; &lt;goals&gt; &lt;goal&gt;sign&lt;/goal&gt; &lt;/goals&gt; &lt;/execution&gt; &lt;/executions&gt; &lt;/plugin&gt; &lt;plugin&gt; &lt;groupId&gt;org.sonatype.plugins&lt;/groupId&gt; &lt;artifactId&gt;nexus-staging-maven-plugin&lt;/artifactId&gt; &lt;version&gt;1.6.7&lt;/version&gt; &lt;extensions&gt;true&lt;/extensions&gt; &lt;configuration&gt; &lt;serverId&gt;ossrh&lt;/serverId&gt; &lt;nexusUrl&gt;https://oss.sonatype.org/&lt;/nexusUrl&gt; &lt;autoReleaseAfterClose&gt;true&lt;/autoReleaseAfterClose&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt; &lt;/profile&gt; &lt;/profiles&gt; &lt;/project&gt; æ³¨æ„1ï¼šä»¥ä¸Š pom.xml å¿…é¡»åŒ…æ‹¬ï¼šnameã€descriptionã€urlã€licensesã€developersã€scm ç­‰åŸºæœ¬ä¿¡æ¯ï¼Œæ­¤å¤–ï¼Œä½¿ç”¨äº† Maven çš„ profile åŠŸèƒ½ï¼Œåªæœ‰åœ¨ release çš„æ—¶å€™ï¼Œåˆ›å»ºæºç åŒ…ã€åˆ›å»ºæ–‡æ¡£åŒ…ã€ä½¿ç”¨ GPG è¿›è¡Œæ•°å­—ç­¾åã€‚æ­¤å¤–ï¼ŒsnapshotRepository ä¸ repository ä¸­çš„ id ä¸€å®šè¦ä¸ setting.xml ä¸­ server çš„ id ä¿æŒä¸€è‡´ã€‚ æ³¨æ„2ï¼šè¿™é‡Œåœ¨ nexus-staging-maven-plugin æ’ä»¶é‡Œå¼€å¯äº†è‡ªåŠ¨ Releaseã€‚ä¹Ÿå¯ä»¥å…³æ‰ï¼Œç„¶åç™»å½•æ„ä»¶ä»“åº“ â€‹ â€‹https://oss.sonatype.orgâ€‹â€‹ æ‰‹åŠ¨å» close ç„¶å relseaeã€‚ ä¸‰ã€é…ç½®gpg-key 1ã€å¯è§†åŒ–é…ç½® Windowsçš„è¯å…ˆåˆ° â€‹ â€‹https://gpg4win.org/download.htmlâ€‹â€‹ ä¸‹è½½æœ€æ–°çš„ç‰ˆæœ¬ï¼Œç›´æ¥å®‰è£…å³å¯æ‰“å¼€å³å¯ã€‚ 1.1ã€æ–°å»ºå¯†é’¥å¯¹ï¼ˆOpenPGPç±»å‹ï¼‰ è¿™é‡Œéœ€è¦å¡«å…¥åå­—å’Œç”µå­é‚®ä»¶ï¼Œç„¶åæ³¨æ„å¯ä»¥åœ¨é«˜çº§è®¾ç½®é‚£é‡Œå°†æœ‰æ•ˆæœŸä¸€æ çš„å°å‹¾å–æ¶ˆæ‰ï¼Œå³æœ‰æ•ˆæœŸæ— é™ï¼Œå¦‚ä¸‹ã€‚ 1.2ã€ç¡®è®¤ä¿¡æ¯å¹¶è¾“å…¥å¯†ç  1.3ã€é€‰æ‹©å°†å…¬é’¥ä¸Šä¼ åˆ°ç›®å½•æœåŠ¡ æ³¨æ„ï¼šå¦‚æœè¿™é‡Œä¸ç‚¹çš„è¯åé¢åˆ†å‘åå°†æ— æ³•åœ¨æœåŠ¡å™¨æ‰¾åˆ°å¯¹åº”å…¬é’¥ã€‚ 1.4ã€å³é”®é€‰æ‹©ç”Ÿæˆçš„è¯ä¹¦åœ¨æœåŠ¡å™¨ä¸Šå‘å¸ƒ 1.5ã€æ ¹æ®å¯†é’¥IDåœ¨æœåŠ¡å™¨ä¸ŠæŸ¥æ‰¾å…¬é’¥ æœ€ç»ˆå¿…é¡»ä¿è¯è¿™ä¸€æ­¥æˆåŠŸï¼å¦‚ä¸‹ã€‚ Psï¼šæ³¨æ„ï¼šè¿™é‡Œæœ‰ä¸ªbugï¼Œå¦‚æœç”Ÿæˆçš„å¯†é’¥IDçš„ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯æ•°å­—0çš„è¯ï¼Œåœ¨ä¸‹é¢ä½¿ç”¨maven-gpgæ’ä»¶çš„æ—¶å€™å¯èƒ½ä¼šè¢«è‡ªåŠ¨å»æ‰å¯¼è‡´å¯†é’¥æ‰¾ä¸åˆ°ï¼Œæ‰€ä»¥ä¿é™©èµ·è§é‡åˆ°è¿™ç§æƒ…å†µå°±é‡æ–°ç”Ÿæˆè¯ä¹¦ã€‚ 2ã€å‘½ä»¤è¡Œé…ç½® Psï¼šWindowsç³»ç»Ÿä½¿ç”¨â€œgpgâ€å‘½ä»¤å¼€å¤´ï¼Œè€ŒMacç³»ç»Ÿä½¿ç”¨â€œgpg2â€å‘½ä»¤å¼€å¤´ã€‚ å¦‚æœæ˜¯ä½¿ç”¨çš„windowsï¼Œå¯ä»¥ä¸‹è½½gpg4winï¼Œåœ°å€ï¼šâ€‹â€‹https://www.gpg4win.org/download.htmlâ€‹â€‹â€‹ï¼Œå®‰è£…ååœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œ â€‹â€‹gpg --gen-keyâ€‹â€‹ç”Ÿæˆï¼Œè¿‡ç¨‹ä¸­éœ€è¦å¡«å†™åå­—ã€é‚®ç®±ç­‰ï¼Œå…¶ä»–æ­¥éª¤å¯ä»¥ä½¿ç”¨é»˜è®¤å€¼ï¼Œä¸è¿‡æœ‰ä¸ªå«ï¼šPassphaseçš„å‚æ•°éœ€è¦è®°ä½ï¼Œè¿™ä¸ªç›¸å½“äºæ˜¯æ˜¯å¯†é’¥çš„å¯†ç ï¼Œä¸‹ä¸€æ­¥å‘å¸ƒè¿‡ç¨‹ä¸­è¿›è¡Œç­¾åæ“ä½œçš„æ—¶å€™ä¼šç”¨åˆ°ã€‚ å»ºè®®å¤§å®¶ä¸‹è½½ Gpg4win-Vanilla ç‰ˆæœ¬ï¼Œå› ä¸ºå®ƒä»…åŒ…æ‹¬ GnuPGï¼Œè¿™ä¸ªå·¥å…·æ‰æ˜¯æˆ‘ä»¬æ‰€éœ€è¦çš„ã€‚ å®‰è£… GPG è½¯ä»¶åï¼Œæ‰“å¼€å‘½ä»¤è¡Œçª—å£ï¼Œä¾æ¬¡åšä»¥ä¸‹æ“ä½œï¼š 2.1ã€æŸ¥çœ‹æ˜¯å¦å®‰è£…æˆåŠŸ gpg --version èƒ½å¤Ÿæ˜¾ç¤º GPG çš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œè¯´æ˜å®‰è£…æˆåŠŸäº†ã€‚ 2.2ã€ç”Ÿæˆå¯†é’¥å¯¹ gpg --gen-key æ­¤æ—¶éœ€è¦è¾“å…¥å§“åã€é‚®ç®±ç­‰å­—æ®µï¼Œå…¶å®ƒå­—æ®µå¯ä½¿ç”¨é»˜è®¤å€¼ï¼Œæ­¤å¤–ï¼Œè¿˜éœ€è¦è¾“å…¥ä¸€ä¸ª Passphaseï¼Œç›¸å½“äºä¸€ä¸ªå¯†é’¥åº“çš„å¯†ç ï¼Œä¸€å®šä¸è¦å¿˜äº†ï¼Œä¹Ÿä¸è¦å‘Šè¯‰åˆ«äººï¼Œæœ€å¥½è®°ä¸‹æ¥ï¼Œå› ä¸ºåé¢ä¼šç”¨åˆ°ã€‚ 2.3ã€æŸ¥çœ‹å…¬é’¥ gpg --list-keys è¾“å‡ºå¦‚ä¸‹ä¿¡æ¯ï¼ˆæ–°ç‰ˆæœ¬å¯èƒ½æ ¼å¼ä¼šæœ‰ç‚¹åŒºåˆ«ï¼Œä¸ç”¨æ‹…å¿ƒï¼Œæ˜¯æ­£å¸¸çš„ï¼‰ï¼š C:/Users/huangyong/AppData/Roaming/gnupg/pubring.gpg ---------------------------------------------------- pub 2048R/82DC852E 2014-04-24 uid hy_think &lt;hy_think@163.com&gt; sub 2048R/3ACA39AF 2014-04-24 å¯è§è¿™é‡Œçš„å…¬é’¥çš„ ID æ˜¯ï¼š82DC852Eï¼Œå¾ˆæ˜æ˜¾æ˜¯ä¸€ä¸ª 16 è¿›åˆ¶çš„æ•°å­—ï¼Œé©¬ä¸Šå°±ä¼šç”¨åˆ°ã€‚ 2.4ã€å°†å…¬é’¥å‘å¸ƒåˆ° PGP å¯†é’¥æœåŠ¡å™¨ï¼ˆåé¢è¿˜éœ€è¦æ“ä½œæ­¤æ­¥éª¤ï¼‰ gpg --keyserver hkp://pool.sks-keyservers.net --send-keys 82DC852E æ­¤åï¼Œå¯ä½¿ç”¨æœ¬åœ°çš„ç§é’¥æ¥å¯¹ä¸Šä¼ æ„ä»¶è¿›è¡Œæ•°å­—ç­¾åï¼Œè€Œä¸‹è½½è¯¥æ„ä»¶çš„ç”¨æˆ·å¯é€šè¿‡ä¸Šä¼ çš„å…¬é’¥æ¥éªŒè¯ç­¾åï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¤§å®¶å¯ä»¥éªŒè¯è¿™ä¸ªæ„ä»¶æ˜¯å¦ç”±æœ¬äººä¸Šä¼ çš„ï¼Œå› ä¸ºæœ‰å¯èƒ½è¯¥æ„ä»¶è¢«åäººç»™ç¯¡æ”¹äº†ã€‚ 2.5ã€æŸ¥è¯¢å…¬é’¥æ˜¯å¦å‘å¸ƒæˆåŠŸ gpg --keyserver hkp://pool.sks-keyservers.net --recv-keys 82DC852E å®é™…ä¸Šå°±æ˜¯ä» key server ä¸Šé€šè¿‡å…¬é’¥ ID æ¥æ¥æ”¶å…¬é’¥ï¼Œæ­¤å¤–ï¼Œä¹Ÿå¯ä»¥åˆ° sks-keyservers.net ä¸Šé€šè¿‡å…¬é’¥ ID å»æŸ¥è¯¢ã€‚ å››ã€ä¸Šä¼ æ„ä»¶åˆ° OSS ä¸­ è¿™æ­¥å°±ç®€å•äº†ï¼Œå°±æ˜¯ä¸€å¥—å‘½ä»¤ï¼š mvn clean deploy -P sonatype-oss-release -Darguments=&quot;gpg.passphrase=å¯†é’¥å¯†ç &quot; å¦‚æœä½¿ç”¨eclipseçš„mvnæ’ä»¶å‘å¸ƒçš„è¯ï¼Œé…ç½®å¦‚ä¸‹ï¼ˆIDEAç±»ä¼¼ï¼‰ï¼š å¦‚æœå‘å¸ƒæˆåŠŸï¼Œå°±å¯ä»¥åˆ°æ„ä»¶ä»“åº“ä¸­æŸ¥çœ‹äº†ã€‚ æˆ–è€… å…ˆé€šè¿‡ cmd è¿›å…¥åˆ°é¡¹ç›®çš„è¿™ä¸ªç›®å½•ä¸‹ã€‚ å†æ‰§è¡Œä¸‹é¢å‘½ä»¤ã€‚ mvn clean deploy -P release å½“æ‰§è¡Œä»¥ä¸Š Maven å‘½ä»¤æ—¶ï¼Œä¼šè‡ªåŠ¨å¼¹å‡ºä¸€ä¸ªå¯¹è¯æ¡†ï¼Œéœ€è¦è¾“å…¥ä¸Šé¢æåˆ°çš„ Passphaseï¼Œå®ƒå°±æ˜¯é€šè¿‡ GPG å¯†é’¥å¯¹çš„å¯†ç ï¼Œåªæœ‰è‡ªå·±æ‰çŸ¥é“ã€‚éšåä¼šçœ‹åˆ°å¤§é‡çš„ upload ä¿¡æ¯ï¼Œè€Œä¸”é€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œç»å¸¸ä¼š timeoutï¼Œéœ€è¦åå¤å°è¯•ã€‚ æ³¨æ„ï¼šæ­¤æ—¶ä¸Šä¼ çš„æ„ä»¶å¹¶æœªæ­£å¼å‘å¸ƒåˆ°ä¸­å¤®ä»“åº“ä¸­ï¼Œåªæ˜¯éƒ¨ç½²åˆ° OSS ä¸­äº†ï¼Œä¸‹é¢æ‰æ˜¯çœŸæ­£çš„å‘å¸ƒã€‚ äº”ã€åœ¨ OSS ä¸­å‘å¸ƒæ„ä»¶ è¿›å…¥â€‹â€‹https://oss.sonatype.org/#stagingRepositoriesâ€‹â€‹â€‹æŸ¥çœ‹å‘å¸ƒå¥½çš„æ„ä»¶ï¼Œç‚¹å‡»å·¦ä¾§çš„â€‹â€‹Staging Repositoriesâ€‹â€‹â€‹ï¼Œä¸€èˆ¬æœ€åä¸€ä¸ªå°±æ˜¯åˆšåˆšå‘å¸ƒçš„jaräº†ï¼Œæ­¤æ—¶çš„æ„ä»¶çŠ¶æ€ä¸ºâ€‹â€‹openâ€‹â€‹ã€‚ æ‰“å¼€å‘½ä»¤è¡Œçª—å£ï¼ŒæŸ¥çœ‹gpg keyå¹¶ä¸Šä¼ åˆ°ç¬¬ä¸‰æ–¹çš„keyéªŒè¯åº“ï¼š E:\\98_code\\workSpace\\marathon-client&gt;gpg --list-keys C:/Users/VF/AppData/Roaming/gnupg/pubring.gpg --------------------------------------------- pub 2048R/824B4D7A 2016-01-06 uid [ultimate] cloudnil &lt;cloudnil@126.com&gt; sub 2048R/7A10AD69 2016-01-06 E:\\98_code\\workSpace\\marathon-client&gt;gpg --keyserver hkp://keyserver.ubuntu.com:11371 --send-keys 824B4D7A gpg: sending key 824B4D7A to hkp server keyserver.ubuntu.com E:\\98_code\\workSpace\\marathon-client&gt; å›åˆ° â€‹ â€‹https://oss.sonatype.org/#stagingRepositoriesâ€‹â€‹ï¼Œé€‰ä¸­åˆšæ‰å‘å¸ƒçš„æ„ä»¶ï¼Œå¹¶ç‚¹å‡»ä¸Šæ–¹çš„closeâ€“&gt;Confirmï¼Œåœ¨ä¸‹è¾¹çš„Activityé€‰é¡¹å¡ä¸­æŸ¥çœ‹çŠ¶æ€ï¼Œå½“çŠ¶æ€å˜æˆclosedåï¼Œæ‰§è¡ŒReleaseâ€“&gt;Confirmï¼Œå¹¶åœ¨ä¸‹è¾¹çš„Activityé€‰é¡¹å¡ä¸­æŸ¥çœ‹çŠ¶æ€ï¼ŒæˆåŠŸåæ„ä»¶è‡ªåŠ¨åˆ é™¤ã€‚ éœ€è¦åœ¨æ›¾ç»åˆ›å»ºçš„ Issue ä¸‹é¢å›å¤ä¸€æ¡â€œæ„ä»¶å·²æˆåŠŸå‘å¸ƒâ€çš„è¯„è®ºï¼Œè¿™æ˜¯ä¸ºäº†é€šçŸ¥ Sonatype çš„å·¥ä½œäººå‘˜ä¸ºéœ€è¦å‘å¸ƒçš„æ„ä»¶åšå®¡æ‰¹ï¼Œå‘å¸ƒåä¼šå…³é—­è¯¥ Issueã€‚ ä¸€å°æ®µæ—¶é—´ï¼ˆçº¦1-2ä¸ªå°æ—¶ï¼‰åå³å¯åŒæ­¥åˆ°â€‹ â€‹https://search.maven.orgâ€‹â€‹â€‹ä¸­å¤®ä»“åº“ï¼ˆMavenä¸­å¤®ä»“åº“å¯èƒ½éœ€è¦24-48å°æ—¶ï¼šâ€‹ â€‹https://mvnrepository.comâ€‹â€‹ï¼‰ã€‚ Psï¼šæ³¨æ„è¿™é‡Œæœ‰ä¸ªå¤§å‘ï¼Œä¹‹å‰å¾ˆå¤šæ•™ç¨‹éƒ½ä¼šæŠŠè¿™ä¸ªæ­¥éª¤æå‰åˆ°æœ€å¼€å§‹ï¼ˆæˆ‘ä¸æ˜¯è¯´ç”Ÿæˆå¯†é’¥è¿™ä¸ªç¯èŠ‚ï¼Œè¿™ä¸ªå¯†é’¥ç”Ÿæˆç¯èŠ‚çš„ç¡®æ˜¯ä¸€å¼€å§‹å°±å¯ä»¥å¼„äº†çš„ï¼‰ï¼Œä½†ä¸‹é¢è¿™å¥è§£æéœ€è¦åˆ°è¿™ä¸€æ­¥å†å¼€å§‹æï¼Œä¹‹å‰ä¸€ç›´åœ¨https://oss.sonatype.org/#stagingRepositoriesè¿™é‡Œå®¡æ ¸ä¸€ç›´å¤±è´¥ï¼Œå¤§å‘å‘€~ æœ€åï¼Œæƒ³è¯´ä¸€å¥ï¼šç¬¬ä¸€æ¬¡éƒ½æ˜¯å¾ˆç—›çš„ï¼Œä»¥åå°±èˆ’æœäº†ã€‚æ²¡é”™ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡å‘å¸ƒæ‰å¦‚æ­¤ç—›è‹¦ï¼Œä»¥å deploy çš„æ„ä»¶ä¼šè‡ªåŠ¨éƒ¨å‘å¸ƒåˆ°ä¸­å¤®ä»“åº“ï¼Œæ— éœ€å†è¿™æ ·æŠ˜è…¾äº†ã€‚ï¼ˆé™„åŠ ï¼šæˆåŠŸæ•ˆæœå›¾ï¼‰ é™„ï¼š åœ¨ç¼–ç è¿‡ç¨‹ä¸­ï¼Œæœ‰äº›é€šç”¨çš„ä»£ç æ¨¡å—ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬ä¸æƒ³é€šè¿‡å¤åˆ¶æ‹·è´æ¥ç²—æš´åœ°å¤ç”¨ï¼Œå› ä¸ºè¿™æ ·ä¸ä»…ä½“ç°ä¸äº†å˜åŒ–ï¼Œä¹Ÿä¸åˆ©äºç»Ÿä¸€ç®¡ç†ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨maven deployçš„æ–¹å¼ï¼Œå°†é€šç”¨çš„æ¨¡å—æ‰“æˆjaråŒ…ï¼Œå‘å¸ƒåˆ°nexusï¼Œè®©å…¶ä»–çš„é¡¹ç›®æ¥å¼•ç”¨ï¼Œä»¥æ›´ç®€æ´é«˜æ•ˆçš„æ–¹å¼æ¥å®ç°å¤ç”¨å’Œç®¡ç†ã€‚ ç¬¬ä¸€ï¼šmavençš„settings.xmlæ–‡ä»¶ä¸­è®¾ç½®æ ‡ç­¾ &lt;server&gt; &lt;id&gt;my-deploy-release&lt;/id&gt; &lt;username&gt;admin&lt;/username&gt; &lt;password&gt;admin123&lt;/password&gt; &lt;/server&gt; &lt;server&gt; &lt;id&gt;my-deploy-snapshot&lt;/id&gt; &lt;username&gt;admin&lt;/username&gt; &lt;password&gt;admin123&lt;/password&gt; &lt;/server&gt; æ­¤å¤„è®¾ç½®çš„ç”¨æˆ·åå’Œå¯†ç éƒ½æ˜¯nexusçš„ç™»é™†é…ç½®ã€‚ ç¬¬äºŒï¼šåœ¨é¡¹ç›®çš„pom.xmlæ–‡ä»¶ä¸­è®¾ç½® &lt;distributionManagement&gt; &lt;repository&gt; &lt;id&gt;my-deploy-release&lt;/id&gt; &lt;url&gt;http://192.168.1.123:8081/nexus/content/repositories/releases/&lt;/url&gt; &lt;/repository&gt; &lt;snapshotRepository&gt; &lt;id&gt;my-deploy-snapshot&lt;/id&gt; &lt;url&gt;http://192.168.1.123:8081/nexus/content/repositories/snapshots/&lt;/url&gt; &lt;/snapshotRepository&gt; &lt;/distributionManagement&gt; åœ¨æ­¤ï¼Œurléƒ½æ˜¯nexusç›¸åº”ä»“åº“çš„é“¾æ¥åœ°å€ï¼Œè¿™ä¸€æ­¥åšå®Œä¹‹åï¼Œå·²ç»å®Œæˆäº†å‘å¸ƒæ‰€éœ€è¦çš„åŸºæœ¬é…ç½®ã€‚ã€è¯•è¯•å‘½ä»¤ï¼šmvn deployã€‘ æ³¨æ„ï¼šä¸­çš„è¦å’Œã€çš„ä¸€è‡´ï¼Œmavenåœ¨å‘å¸ƒæ—¶ï¼Œä¼šæ ¹æ®æ­¤idæ¥æŸ¥æ‰¾ç›¸åº”çš„ç”¨æˆ·åå¯†ç è¿›è¡Œç™»å½•éªŒè¯å¹¶ä¸Šä¼ æ–‡ä»¶ã€‚ ç¬¬ä¸‰ï¼šå‘å¸ƒçš„çµæ´»æ€§é…ç½® mavenä¼šåˆ¤æ–­ç‰ˆæœ¬åé¢æ˜¯å¦å¸¦äº†-SNAPSHOTï¼Œå¦‚æœå¸¦äº†å°±å‘å¸ƒåˆ°snapshotsä»“åº“ï¼Œå¦åˆ™å‘å¸ƒåˆ°releaseä»“åº“ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥åœ¨pom.xmlæ–‡ä»¶ä¸­ï¼Œè®¾ç½®ã€‚ &lt;groupId&gt;com.test&lt;/groupId&gt; &lt;artifactId&gt;my-test&lt;/artifactId&gt; &lt;packaging&gt;jar&lt;/packaging&gt; &lt;version&gt;${project.release.version}&lt;/version&gt; &lt;properties&gt; &lt;java.version&gt;1.8&lt;/java.version&gt; &lt;project.release.version&gt;1.0-SNAPSHOT&lt;/project.release.version&gt; &lt;/properties&gt; &lt;profiles&gt; &lt;profile&gt; &lt;id&gt;product&lt;/id&gt; &lt;properties&gt; &lt;project.release.version&gt;1.0&lt;/project.release.version&gt; &lt;/properties&gt; &lt;/profile&gt; &lt;/profiles&gt; è¯´æ˜ï¼šé€šè¿‡å ä½ç¬¦${project.release.version}æ¥æ§åˆ¶éœ€è¦å‘å¸ƒçš„ç‰ˆæœ¬ï¼Œç”¨å‘½ä»¤mvn deploy -P productï¼Œå‘å¸ƒmy-testçš„1.0ç‰ˆæœ¬åˆ°releasesåº“ã€‚å¦‚æœä½¿ç”¨å‘½ä»¤mvn deployï¼Œåˆ™é»˜è®¤ä½¿ç”¨ 1.0-SNAPSHOTç‰ˆæœ¬å·ï¼Œå°†å‘å¸ƒmy-testçš„1.0-SNAPSHOTç‰ˆæœ¬åˆ°snapshotsåº“ã€‚ ç¬¬å››ï¼šå‘å¸ƒæ—¶é‡åˆ°çš„ä¸€äº›é—®é¢˜ éƒ¨ç½²åˆ°snapshotä»“åº“æ—¶ï¼ŒjaråŒ…ä¼šå¸¦ä¸Šæ—¶é—´æˆ³ï¼Œè¿™æ²¡å…³ç³»ï¼Œmavenä¼šè‡ªåŠ¨å–ç›¸åº”ç‰ˆæœ¬æœ€æ–°çš„jaråŒ…ï¼› Failed to execute goal org.apache.maven.plugins:maven-deploy-plugin:2.8.2:deploy (default-deploy) on project my-test: Failed to deploy artifacts: Could not transfer artifact...from/to release...éƒ¨ç½²åˆ°releaseä»“åº“æ—¶ï¼Œç›¸åŒç‰ˆæœ¬çš„jaråŒ…ä¸èƒ½æäº¤ã€‚ åŸå› ï¼šå› ä¸ºreleaseçš„éƒ¨ç½²ç­–ç•¥æ˜¯ã€disable redeployã€‘ï¼Œä¸å…è®¸è¦†ç›–æ›´æ–°ç»„ä»¶ã€‚ è§£å†³åŠæ³•ï¼šä¿®æ”¹ä¸€ä¸‹ç‰ˆæœ¬å·ï¼Œå†æäº¤å³å¯ã€‚ä¹‹å‰å…¶å®è¿˜å¯ä»¥é€šè¿‡äººå·¥å®¢æœèŠå¤©å¸®å¿™åˆ é™¤ä¸æƒ³è¦çš„JaråŒ…ï¼Œä½†æ˜¯ç°åœ¨ä¸è¡Œäº†ï¼Œåªèƒ½é€šè¿‡ä¸Šä¼ æ–°ç‰ˆæœ¬ï¼Œæ‰€ä»¥æœ‰äº›ç«¥é‹æƒ³åšæµ‹è¯•çš„éœ€è¦æ³¨æ„è¿™ä¸€ç‚¹ã€‚ æ‰“åŒ…æŒ‡å®šçš„æ–‡ä»¶/æ–‡ä»¶å¤¹åœ¨ä»£ç ä¸­ä¹Ÿæœ‰ä½“ç°ï¼ˆå«ï¼šdocã€sourcesã€classï¼‰ã€‚ Maven deploy æ—¶ï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰ç”Ÿæˆå¯¹åº”çš„ javadoc å’Œ sources ï¼ˆå‰æå·²ç»æœ‰æ’ä»¶éƒ¨ç½²å¥½ï¼‰ï¼Ÿ ","link":"https://tianxiawuhao.github.io/vU42syr2A/"},{"title":"Kubernetesçš„å­˜å‚¨","content":"ä¸€ã€K8sçš„å­˜å‚¨çš„åŸºç¡€çŸ¥è¯†ä¸åˆ†ç±» å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šhttps://kubernetes.io/zh/docs/concepts/storage/ 1ã€åŸºç¡€çŸ¥è¯†ï¼š K8sçš„åŸºæœ¬å•ä½ä¸ºPodï¼Œä½†æ˜¯ä¸€ä¸ªPodä¸­å®é™…å·¥ä½œçš„æ˜¯å®¹å™¨containersï¼Œæ‰€ä»¥è¦æŒ‚è½½çš„å·å…¶å®ä¹Ÿæ˜¯ç»™å®¹å™¨ä½¿ç”¨çš„ï¼›K8så·çš„è®¾è®¡ï¼š å®¹å™¨Containerï¼šç”³è¯·å®¹å™¨å†…çš„å“ªä¸ªç›®å½•/æ–‡ä»¶å°†è¢«æŒ‚è½½å‡ºæ¥ï¼›ï¼ˆä½†æ˜¯å¦‚ä½•æŒ‚è½½ï¼Œä»–ä¸åšç»†èŠ‚å¹²æ¶‰ï¼‰ Podï¼šä¸ºå…¶ä¸­çš„æ¯ä¸ªå®¹å™¨å£°æ˜å‡ºæ¥çš„æŒ‚è½½ï¼ŒæŒ‡å®šè¯¦ç»†çš„æŒ‚è½½è¯¦æƒ…ï¼›ï¼ˆæœ‰å¾ˆå¤šç§æŒ‚è½½æ¨¡å¼ï¼Œå¯ä»¥æ˜¯æœ¬åœ°çš„ã€å¯ä»¥æ˜¯è¿œç¨‹çš„ã€ç”šè‡³è¿˜å¯ä»¥æ˜¯äº‘æœåŠ¡ä¸Šæä¾›çš„å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼‰ 2ã€æ•°æ®å·åˆ†ç±»ï¼š æ•°æ®å·å®ç°åˆ†ç±»æœ‰å¾ˆå¤šï¼Œå¯é€šè¿‡explainæŸ¥çœ‹æ‰€æœ‰æš‚æ—¶æ”¯æŒçš„å®ç°åˆ†ç±»ï¼ˆå¤šè¾¾30ç§ï¼‰ kubectl explain pod.spec.volumes ä½†æ˜¯æˆ‘ä»¬å¤§æ¦‚å¯ä»¥ç²—åˆ†ä¸ºä»¥ä¸‹ä¸‰å¤§ç±»ï¼š é…ç½®ä¿¡æ¯ï¼šç±»ä¼¼äºç‹¬ç«‹ç¯å¢ƒå˜é‡æ–‡ä»¶çš„æ–¹å¼ï¼Œå°†æ–‡ä»¶ç§çš„é”®å€¼å¯¹æŒ‚è½½åˆ°å®¹å™¨å†…ï¼› ä¸´æ—¶å­˜å‚¨ï¼šè¿™äº›å­˜å‚¨è™½ç„¶æŒ‚å‡ºæ¥äº†ï¼Œä½†æ˜¯å¦‚æœå®¹å™¨è¢«åˆ é™¤ï¼Œæˆ–è€…åœ¨å…¶ä»–æœºå™¨ä¸Šè¢«æ‹‰èµ·ï¼Œè¿™äº›æŒ‚è½½æ–‡ä»¶å°†æ— æ³•ç»§ç»­è¢«è¯»å–åˆ°ï¼› æŒä¹…åŒ–å­˜å‚¨ï¼šçœŸæ­£çš„æŒä¹…åŒ–ï¼ŒK8så°†è‡ªå·±ä¸æ“…é•¿çš„å­˜å‚¨å®ç°ï¼Œäº¤ç»™äº†åˆ«çš„æ“…é•¿äºå­˜å‚¨çš„æœåŠ¡å•†æˆ–è½¯ä»¶ï¼›â€”â€”è¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä»¥åå­¦ä¹ çš„é‡ç‚¹éš¾ç‚¹ï¼ äºŒã€NFSç½‘ç»œæ–‡ä»¶ç³»ç»Ÿçš„å®‰è£…ä¸è°ƒè¯• NFSï¼ˆNetwork File Systemï¼‰å³ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒå…è®¸ç½‘ç»œä¸­çš„è®¡ç®—æœºä¹‹é—´é€šè¿‡ç½‘ç»œå…±äº«èµ„æºã€‚å°†NFSä¸»æœºåˆ†äº«çš„ç›®å½•ï¼ŒæŒ‚è½½åˆ°æœ¬åœ°å®¢æˆ·ç«¯å½“ä¸­ï¼Œæœ¬åœ°NFSçš„å®¢æˆ·ç«¯åº”ç”¨å¯ä»¥é€æ˜åœ°è¯»å†™ä½äºè¿œç«¯NFSæœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶ï¼Œåœ¨å®¢æˆ·ç«¯ç«¯çœ‹èµ·æ¥ï¼Œå°±åƒè®¿é—®æœ¬åœ°æ–‡ä»¶ä¸€æ ·ã€‚ NFSè®¾è®¡æˆC/Sæ¶æ„ï¼Œé€šè¿‡RPCè¿œç¨‹è¿‡ç¨‹è°ƒç”¨çš„æ–¹å¼å®ç°æ•°æ®åŒæ­¥ï¼ 1ã€åœ¨MasterèŠ‚ç‚¹å®‰è£…NFS Serverï¼ˆå½“ç„¶ï¼Œå…¶ä»–èŠ‚ç‚¹ä¹Ÿå¯ä»¥ï¼‰ yum install -y nfs-utils #æ‰§è¡Œå‘½ä»¤ vi /etc/exportsï¼Œåˆ›å»º exports æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š echo &quot;/nfs/data/ *(insecure,rw,sync,no_root_squash)&quot; &gt; /etc/exports # æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå¯åŠ¨ nfs æœåŠ¡;åˆ›å»ºå…±äº«ç›®å½• mkdir -p /nfs/data systemctl enable rpcbind systemctl enable nfs-server systemctl start rpcbind systemctl start nfs-server exportfs -r #æ£€æŸ¥é…ç½®æ˜¯å¦ç”Ÿæ•ˆ [root@k8s-01 /]# exportfs /nfs/data &lt;world&gt; ## è¯´æ˜å·²ç»nfs-serveræœåŠ¡å·²ç»å¯åŠ¨ï¼Œç”Ÿæ•ˆ 2ã€åœ¨æˆ‘ä»¬ä¸¤å°éœ€è¦å…±äº«nfs serverçš„æœºå™¨ä¸Šï¼Œå®‰è£…NFS Client yum install -y nfs-utils #æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ nfs æœåŠ¡å™¨ç«¯æ˜¯å¦æœ‰è®¾ç½®å…±äº«ç›®å½• # showmount -e $(nfsæœåŠ¡å™¨çš„IP) showmount -e 192.168.56.20 # è¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤º Export list for 192.168.56.20 /nfs/data * #æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æŒ‚è½½ nfs æœåŠ¡å™¨ä¸Šçš„å…±äº«ç›®å½•åˆ°æœ¬æœºè·¯å¾„ /root/nfsmount mkdir /root/nfsmount # mount -t nfs $(nfsæœåŠ¡å™¨çš„IP):/root/nfs_root /root/nfsmount mount -t nfs 192.168.56.20:/nfs/data /root/nfsmount 3ã€æµ‹è¯•NFSæœåŠ¡æ˜¯å¦åœ¨3å°æœåŠ¡å™¨ä¸Šå·²ç»ç”Ÿæ•ˆ #1ã€ clientèŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤ï¼Œçœ‹æœ¬åœ°çš„æ–‡ä»¶ç³»ç»Ÿåˆ—è¡¨ï¼š [root@k8s-02 ~]# df -Th Filesystem Type Size Used Avail Use% Mounted on devtmpfs devtmpfs 1.9G 0 1.9G 0% /dev tmpfs tmpfs 1.9G 0 1.9G 0% /dev/shm tmpfs tmpfs 1.9G 9.4M 1.9G 1% /run tmpfs tmpfs 1.9G 0 1.9G 0% /sys/fs/cgroup /dev/sda1 xfs 40G 11G 30G 27% / tmpfs tmpfs 379M 0 379M 0% /run/user/0 192.168.56.20:/nfs/data nfs4 40G 6.3G 34G 16% /root/nfsmount ## å¯ä»¥çœ‹åˆ°ï¼Œæœ‰ä¸€ä¸ªæ˜¯è¿œç¨‹çš„ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼ŒæŒ‚è½½äº†æˆ‘ä»¬è‡ªå·±æœ¬åœ°çš„/root/nfsmount ç›®å½•ä¸Š #2ã€åœ¨serverä¸Šç›®å½•ç§åˆ›å»ºæ–‡ä»¶aaa.txt #3ã€åœ¨clinetä¸Šç›®å½•ä¸­åˆ›å»ºæ–‡ä»¶bbb.txt å¯ä»¥çœ‹åˆ°ï¼Œ3å°ä¸»æœºä¸Šå¯¹åº”çš„æ–‡ä»¶å·²ç»ç«‹å³å¾—åˆ°äº†åŒæ­¥ï¼ 4ã€è¡¥å……ï¼Œæœ‰æ—¶å€™ï¼Œæˆ‘ä»¬å³ä½¿å®‰è£…äº†nfs-utilsï¼Œä¾ç„¶æ— æ³•ä½¿ç”¨showmount -e ip æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨å®¢æˆ·ç«¯é…ç½®fstabæŒ‚è½½ï¼š vi /etc/fstab ##è¿½åŠ nfs masterçš„ä¿¡æ¯ 10.130.59.50:/nfs/data /nfs/data nfs defaults 0 0 æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè®©ä¿®æ”¹åçš„fstabç”Ÿæ•ˆï¼š mount -a ä¹‹åæŸ¥çœ‹ï¼š df -Th ##å­˜åœ¨ä»¥ä¸‹è¡Œï¼š 10.130.59.50:/nfs/data nfs4 50G 4.4G 46G 9% /nfs/data ä¹‹ååˆ›å»ºæ–‡ä»¶ï¼Œæµ‹è¯•æ­£å¸¸ï¼ ä¸‰ã€ä½¿ç”¨ä¸€ä¸ªNginxæµ‹è¯•Podä½¿ç”¨NFSè¿›è¡ŒæŒ‚è½½ 1ã€åˆ›å»ºnginxnfs.yamlæ–‡ä»¶ï¼š #æµ‹è¯•Podç›´æ¥æŒ‚è½½NFSäº† apiVersion: v1 kind: Pod metadata: name: vol-nfs namespace: mytest spec: containers: - name: mynginx image: nginx volumeMounts: - name: html mountPath: /usr/share/nginx/html/ volumes: - name: html nfs: path: /nfs/data server: 192.168.56.20 2ã€æ‰§è¡Œæ­¤yamlæ–‡ä»¶ï¼Œéƒ¨ç½²ä¸€å°nginxï¼š [root@k8s-01 mytest]# kubectl apply -f nginxnfs.yaml pod/vol-nfs created [root@k8s-01 mytest]# kubectl get pod -n mytest -owide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES vol-nfs 1/1 Running 0 68s 10.244.165.226 k8s-03 &lt;none&gt; &lt;none&gt; 3ã€nfs serverçš„å¯¹åº”ç›®å½•ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ªindex.htmlæ–‡ä»¶ï¼Œç„¶åè®¿é—®ï¼š [root@k8s-01 mytest]# echo 12345 &gt; /nfs/data/index.html [root@k8s-01 mytest]# curl 10.244.165.226 12345 å¯ä»¥çœ‹åˆ°ï¼Œæ˜æ˜éƒ¨ç½²åœ¨k8s-03èŠ‚ç‚¹ä¸Šé¢çš„podï¼Œä¾ç„¶å¯ä»¥æ­£å¸¸ä½¿ç”¨k8s-01èŠ‚ç‚¹ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œæ–‡ä»¶æŒ‚è½½ï¼ å››ã€PVã€PVCã€StorageClassçš„åŸºç¡€çŸ¥è¯† èƒŒæ™¯ï¼šä¸ºä»€ä¹ˆè¦æŠŠä¸€ä¸ªå­˜å‚¨äº‹æƒ…åˆ†æˆè¿™ä¹ˆå¤šå±‚ï¼Ÿå¦‚æ­¤å¤æ‚ï¼Ÿ ç­”ï¼šå­˜å‚¨çš„ç®¡ç†æ˜¯ä¸€ä¸ªä¸è®¡ç®—å®ä¾‹çš„ç®¡ç†å®Œå…¨ä¸åŒçš„é—®é¢˜ã€‚ å› ä¸ºæ•´ä¸ªPodéƒ¨ç½²çš„yamlæ–‡ä»¶å¯èƒ½éƒ½æ˜¯ç”±æˆ‘ä»¬å¼€å‘äººå‘˜ç¼–å†™çš„ï¼Œä½†æ˜¯æˆ‘ä»¬ä»¥åéƒ¨ç½²çš„æœåŠ¡å™¨ä»€ä¹ˆæƒ…å†µæˆ‘ä»¬è‚¯å®šæ˜¯ä¸çŸ¥é“çš„ï¼ŒæœåŠ¡å™¨ä¸Šèƒ½æ”¯æŒçš„æ–‡ä»¶å­˜å‚¨æ–¹å¼æˆ‘ä»¬ä¹Ÿæ˜¯ä¸çŸ¥é“çš„ï¼Œé‚£æˆ‘ä»¬çš„Podè‚¯å®šæ²¡æœ‰åŠæ³•ä¸€æ°”å‘µæˆåœ°å®Œæˆæ‰€æœ‰çš„äº‹æƒ…ï¼ æœ‰äº†PVï¼ˆPersistent Volumeï¼‰ã€PVCï¼ˆPersistent Volume Claimï¼‰åï¼Œæˆ‘ä»¬å°±å¯ä»¥è®©è¿ç»´äººå‘˜æå‰å‡†å¤‡å¥½å¾ˆå¤šçš„PVï¼Œè¿™æ ·æˆ‘ä»¬åœ¨éƒ¨ç½²Podçš„yamlæ–‡ä»¶ç§ï¼Œåªéœ€è¦æ·»åŠ ä¸€ä¸ªPVCï¼ˆPVçš„ä½¿ç”¨ç”³è¯·ï¼‰ï¼Œè¿™æ ·K8så°±èƒ½å¤Ÿè‡ªåŠ¨åœ°ä¸ºPodåŒ¹é…ä¸Šå¯ä»¥ä½¿ç”¨çš„PVå­˜å‚¨å·äº†ï¼› ****ç¨‹åºå‘˜ï¼š****è´Ÿè´£Pod + PVCçš„yamlæ–‡ä»¶å³å¯ï¼› **K8sè¿ç»´äººå‘˜ï¼š**è´Ÿè´£å‡†å¤‡å¥½PVï¼›â€”â€” è¿™é‡Œè¿˜åˆ†ä¸ºé™æ€ä¾›åº”ã€è‡ªåŠ¨ä¾›åº” ä¸¤ç±»ï¼› 1ã€ä»€ä¹ˆæ˜¯PVï¼ˆ*Persistent Volume æŒä¹…åŒ–å­˜å‚¨å·*ï¼‰ï¼Ÿ PV å·çš„ä¾›åº”æœ‰ä¸¤ç§æ–¹å¼ï¼šé™æ€ä¾›åº”æˆ–åŠ¨æ€ä¾›åº”ã€‚ é™æ€ä¾›åº”ï¼šæ‰€æœ‰çš„äº‹æƒ…ï¼Œå°¤å…¶æ˜¯PVçš„åˆ›å»ºï¼Œæˆ‘æ˜¯ç”±ç®¡ç†å‘˜æ‰‹åŠ¨åˆ›å»ºçš„ï¼Œå¦‚æœæ²¡æœ‰ç°æˆçš„å¯ç”¨çš„PVå­˜åœ¨ï¼Œæˆ‘ä»¬çš„PVCç”³è¯·å°†ä¸€ç›´å¤„äºPendingçŠ¶æ€ï¼› åŠ¨æ€ä¾›åº”ï¼šPVçš„åˆ›å»ºæ˜¯è‡ªåŠ¨åŒ–å®Œæˆçš„ï¼Œä¸»è¦ä¾èµ–äºåº•å±‚çš„StorageClassæ¥å®ç°ï¼›â€”â€” åé¢è¯¦è¿° æ‰‹åŠ¨åˆ›å»ºPVï¼ˆmypv.yamlï¼‰â€”â€” æˆ‘ä¸€æ¬¡åˆ›å»ºäº†3ä¸ªPVï¼š apiVersion: v1 kind: PersistentVolume metadata: name: mypv-10m labels: type: local spec: storageClassName: my-nfs-storage capacity: storage: 10m accessModes: - ReadWriteOnce nfs: #ä½¿ç”¨nfså­˜å‚¨ç³»ç»Ÿï¼ŒæŒ‚è½½çš„ç›®å½•ä¸º192.168.56.20:/nfs/data/one server: 192.168.56.20 path: /nfs/data/one --- apiVersion: v1 kind: PersistentVolume metadata: name: mypv-20m labels: type: local spec: storageClassName: my-nfs-storage capacity: storage: 20m accessModes: - ReadWriteOnce nfs: #ä½¿ç”¨nfså­˜å‚¨ç³»ç»Ÿï¼ŒæŒ‚è½½çš„ç›®å½•ä¸º192.168.56.20:/nfs/data/one server: 192.168.56.20 path: /nfs/data/two --- apiVersion: v1 kind: PersistentVolume metadata: name: mypv-50m labels: type: local spec: storageClassName: my-nfs-storage capacity: storage: 50m accessModes: - ReadWriteOnce nfs: #ä½¿ç”¨nfså­˜å‚¨ç³»ç»Ÿï¼ŒæŒ‚è½½çš„ç›®å½•ä¸º192.168.56.20:/nfs/data/one server: 192.168.56.20 path: /nfs/data/three åº”ç”¨æ­¤yamlæ–‡ä»¶åï¼Œå°†äº§ç”Ÿ3ä¸ªpvå­˜å‚¨å·ï¼š [root@k8s-01 mytest]# kubectl apply -f mypv.yaml persistentvolume/mypv-10m created persistentvolume/mypv-20m created persistentvolume/mypv-50m created [root@k8s-01 mytest]# kubectl get pv -n mytest NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE mypv-10m 10m RWO Retain Available my-nfs-storage 11s mypv-20m 20m RWO Retain Available my-nfs-storage 11s mypv-50m 50m RWO Retain Available my-nfs-storage 11s æ³¨ï¼šå…¶ä¸­é‡è¦çš„å­—æ®µï¼š ACCESS MODESï¼šè®¿é—®æ¨¡å¼ RWO â€“ ReadWriteOnceï¼šå…è®¸å•èŠ‚ç‚¹è¯»å†™ ROX â€“ ReadOnlyManyï¼šå…è®¸å¤šèŠ‚ç‚¹åªè¯»ï¼ˆè¯»å†™åˆ†ç¦»æ—¶å¯ç”¨ï¼‰ RWX â€“ ReadWriteManyï¼šå…è®¸å¤šèŠ‚ç‚¹è¯»å†™ï¼ˆé›†ç¾¤å¸¸ç”¨ï¼‰ RWOP â€“ ReadWriteOncePodï¼šåªå…è®¸å•Podè¯»å†™ï¼ˆæ¯”RWOæ›´ç²¾ç»†ï¼‰ RECLAIM POLICYï¼šå›æ”¶ç­–ç•¥ Retain â€” æ‰‹åŠ¨å›æ”¶ï¼ŒPVCè¢«åˆ é™¤ï¼ŒPVçº¹ä¸ä¸åŠ¨ï¼Œè‡ªå·±æ‰‹åŠ¨æ§åˆ¶ï¼Œæœ€å®‰å…¨ï¼› Recycle â€” åŸºæœ¬æ“¦é™¤ (rm -rf /thevolume/*)ï¼Œå·é‡Œé¢çš„å†…å®¹å°†ä¼šè¢«æ¸…é™¤ï¼Œå·å˜ä¸ºReleasedçŠ¶æ€ï¼Œä¾ç„¶æ— æ³•è¢«å…¶ä»–å…¶ä»–PVCç”³é¢†ï¼› Delete â€” è¯¸å¦‚ AWS EBSã€GCE PDã€Azure Disk æˆ– OpenStack Cinder å·è¿™ç±»å…³è”å­˜å‚¨èµ„äº§ä¹Ÿè¢«åˆ é™¤ï¼› ç›®å‰ï¼Œä»… NFS å’Œ HostPath æ”¯æŒå›æ”¶ï¼ˆRecycleï¼‰ã€‚ AWS EBSã€GCE PDã€Azure Disk å’Œ Cinder å·éƒ½æ”¯æŒåˆ é™¤ï¼ˆDeleteï¼‰ã€‚ï¼š pvè‡ªå·±ä¹Ÿè·Ÿç€åˆ é™¤ STATUSï¼šå½“å‰çŠ¶æ€ Availableï¼ˆå¯ç”¨ï¼‰â€“ å·æ˜¯ä¸€ä¸ªç©ºé—²èµ„æºï¼Œå°šæœªç»‘å®šåˆ°ä»»ä½•ç”³é¢†ï¼› Boundï¼ˆå·²ç»‘å®šï¼‰â€“ è¯¥å·å·²ç»ç»‘å®šåˆ°æŸç”³é¢†ï¼› Releasedï¼ˆå·²é‡Šæ”¾ï¼‰â€“ æ‰€ç»‘å®šçš„PVCå·²è¢«åˆ é™¤ï¼Œä½†æ˜¯èµ„æºå°šæœªè¢«é›†ç¾¤å›æ”¶ï¼› Failedï¼ˆå¤±è´¥ï¼‰â€“ å·çš„è‡ªåŠ¨å›æ”¶æ“ä½œå¤±è´¥ã€‚ CLAIMï¼šå½“å‰æ­£è¢«å“ªä¸ªPVCç»‘å®š â€”â€” å½“æŸä¸ªPVè¢«PVCç”³é¢†ä¹‹åï¼Œè¯¥åˆ—å°±ä¼šæœ‰æ•°å€¼äº†ï¼ STORAGECLASSï¼šå­˜å‚¨ç±»â€”â€”åŠ¨æ€ä¾›åº”çš„é‡ç‚¹ï¼Œæ¯ä¸ªStorageClasséƒ½å¯¹åº”ç€è‡ªå·±çš„ä¸€å¥—è‡ªå·±çš„å­˜å‚¨å®ç°ï¼› 2ã€ä»€ä¹ˆæ˜¯PVCï¼ˆPersistent Volume Claim æŒä¹…åŒ–å­˜å‚¨å·ç”³æ˜/ç”³è¯·ï¼‰ï¼Ÿ PVCå…¶å®å°±æ˜¯æˆ‘ä»¬ç¨‹åºå‘˜ç¼–å†™çš„ï¼Œå¯¹äºPVèµ„æºçš„ä¸€ä¸ªç”³è¯·ï¼Œå½“æœ‰åˆé€‚çš„PVçš„æ—¶å€™ï¼Œæˆ‘ä»¬å³å¯ä»¥è¿›è¡Œç»‘å®šï¼Œå¦‚æœæ²¡æœ‰åˆé€‚çš„PVï¼Œæˆ‘ä»¬ç”³è¯·çš„PVCå°†ä¸€ç›´å¤„äºPendingçŠ¶æ€ï¼Œç›´åˆ°æœ‰åˆé€‚çš„PVè¢«åˆ›å»ºå‡ºæ¥ï¼ æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªPVCï¼ˆmypvc.yamlï¼‰ apiVersion: v1 kind: PersistentVolumeClaim metadata: name: mypvc namespace: mytest labels: app: nginx-pvc spec: storageClassName: my-nfs-storage #å¿…é¡»ä¸PVçš„è¯¥é¡¹å¯¹åº”ï¼ŒK8så°†ä¼šä»è¯¥SCå¯¹åº”çš„pvèµ„æºç§ä¸ºæˆ‘ä»¬åŒ¹é…åˆé€‚çš„èµ„æº accessModes: - ReadWriteOnce resources: requests: storage: 15m #æˆ‘æ•…æ„å†™çš„15mï¼Œçœ‹çœ‹K8sæ˜¯å¦ä¼šå¸®æˆ‘ä»¬æŒ‘é€‰ä¸€ä¸ªæœ€åˆé€‚çš„PVèµ„æº æˆ‘ä»¬åº”ç”¨æ­¤yamlæ–‡ä»¶åï¼ŒæŸ¥çœ‹pvcå’Œpvçš„çŠ¶æ€ï¼š [root@k8s-01 mytest]# kubectl apply -f mypvc.yaml persistentvolumeclaim/mypvc created [root@k8s-01 mytest]# kubectl get pvc -n mytest NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE mypvc Bound mypv-20m 20m RWO my-nfs-storage 14s [root@k8s-01 mytest]# kubectl get pv -n mytest NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE mypv-10m 10m RWO Retain Available my-nfs-storage 2m36s mypv-20m 20m RWO Retain Bound mytest/mypvc my-nfs-storage 2m36s mypv-50m 50m RWO Retain Available my-nfs-storage 2m36s å¯ä»¥çœ‹åˆ°ï¼Œpvå’Œpvcçš„çŠ¶æ€éƒ½å˜ä¸ºäº†BoundçŠ¶æ€ï¼›åŒæ—¶ï¼ŒK8sä¸ºæˆ‘ä»¬æŒ‘é€‰çš„æ—¶æœ€åˆé€‚çš„PVèµ„æºï¼› 3ã€æˆ‘ä»¬å†ç¼–å†™ä¸€ä¸ªNginxçš„Podï¼Œæ¥ä½¿ç”¨ä¸Šé¢åˆ›å»ºçš„pvcç”³è¯·ï¼ˆpvcnginx.yamlï¼‰ apiVersion: v1 kind: Pod metadata: name: &quot;mypvc-nginx&quot; namespace: mytest labels: app: &quot;mypvc-nginx&quot; spec: containers: - name: mypvc-nginx image: &quot;nginx&quot; ports: - containerPort: 80 name: http volumeMounts: - name: localtime mountPath: /etc/localtime - name: html mountPath: /usr/share/nginx/html volumes: - name: localtime hostPath: path: /usr/share/zoneinfo/Asia/Shanghai - name: html persistentVolumeClaim: claimName: mypvc #æˆ‘è‡ªå·±åˆ›å»ºçš„pvcçš„åå­— restartPolicy: Always æˆ‘ä»¬åº”ç”¨æ­¤yamlåï¼Œå¯¹åº”çš„nginxå³å¯è¢«åˆ›å»ºï¼Œç„¶åæˆ‘ä»¬åœ¨å¯¹åº”çš„twoæ–‡ä»¶å¤¹ç§åˆ›å»ºindex.htmlæ–‡ä»¶å³å¯çœ‹åˆ°æ•ˆæœï¼š [[root@k8s-01 mytest]# kubectl get all -n mytest NAME READY STATUS RESTARTS AGE pod/mypvc-nginx 1/1 Running 0 3m55s pod/vol-nfs 1/1 Running 0 5h25m [root@k8s-01 mytest]# echo mypvc-nginx &gt; /nfs/data/two/index.html [root@k8s-01 mytest]# curl 10.244.165.227 mypvc-nginx è¿™æ ·ï¼Œæ•´ä¸ªâ€é™æ€ä¾›åº”â€œçš„æµç¨‹å°±å®Œæˆäº†ï¼ 4ã€ä»€ä¹ˆæ˜¯StorageClassï¼ˆå­˜å‚¨ç±»ï¼‰ï¼Ÿ æ•´ä¸ªé™æ€ä¾›åº”çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¥½åƒéƒ½æ²¡æœ‰ StorageClass ä»€ä¹ˆäº‹æƒ…ï¼Œé™¤äº†å°±ç”¨å®ƒæ¥éš”ç»PVèµ„æºä¸€æ ·ï¼Œæ²¡æœ‰äº†å…¶ä»–ä½œç”¨ï¼ æ¯ä¸ª StorageClass éƒ½åŒ…å« provisionerã€parameters å’Œ reclaimPolicy å­—æ®µï¼Œ è¿™äº›å­—æ®µä¼šåœ¨ StorageClass éœ€è¦åŠ¨æ€åˆ†é… PersistentVolume æ—¶ä¼šä½¿ç”¨åˆ°ã€‚ provisionerï¼šæˆ‘ä»¬ä¸€èˆ¬ç§°ä¹‹ä¸º ä¾›åº”å•†ï¼› å½“æˆ‘ä»¬åˆ›å»ºStorageClassçš„æ—¶å€™ï¼Œä¼šæŒ‡å®šä½¿ç”¨å“ªä¸ªprovisioneræ¥ä¸ºæˆ‘ä»¬ä¾›åº”æœåŠ¡ï¼ˆè‡ªåŠ¨åˆ›å»ºPVï¼‰ è€Œåœ¨æˆ‘ä»¬çš„PVCä¸­ï¼Œæˆ‘ä»¬ä¼šé€‰æ‹©ä½¿ç”¨å“ªä¸€ä¸ªStorageClassæ¥ä¸ºæˆ‘ä»¬æœåŠ¡ï¼› è¿™æ ·ï¼Œæ•´ä¸ªâ€åŠ¨æ€ä¾›åº”â€œçš„æ¨¡å‹å°±å‡ºæ¥äº†ï¼æˆ‘ä»¬ç¨‹åºå‘˜åªéœ€è¦ç¼–å†™ Podã€PVCçš„yamlæ–‡ä»¶ï¼Œåœ¨PVCä¸­æŒ‡å®šStorageClassNameå³å¯ï¼Œè‡³äºStorageClasså¯¹åº”çš„æ˜¯è‡ªåŠ¨ä¾›åº”PVï¼Œè¿˜æ˜¯æ‰‹åŠ¨åˆ›å»ºPVï¼Œéƒ½è·Ÿæˆ‘ä»¬æ²¡æœ‰å…³ç³»äº†ï¼ äº”ã€å€ŸåŠ©NFSå­˜å‚¨æœåŠ¡å®ç°ä¸€ä¸ªåŠ¨æ€ä¾›åº”æ¡ˆä¾‹ å†æ¥å›é¡¾ä¸€ä¸‹â€åŠ¨æ€ä¾›åº”â€œçš„æµç¨‹ï¼šï¼ˆå…¶ä¸­é‡ç‚¹å°±æ˜¯ï¼šå½“æ²¡æœ‰åˆé€‚çš„PVæ—¶å€™ï¼ŒK8sä¼šè·å–StorageClassä¿¡æ¯ï¼Œå¸®æˆ‘ä»¬åˆ›å»ºåˆé€‚çš„PVèµ„æºï¼‰ 1ã€å‚è€ƒ nfs-subdir-external-provisioner åŠ¨æ€ä¾›åº”çš„æ–‡æ¡£åˆ›å»ºyaml å®˜æ–¹æ–‡æ¡£åœ°å€ï¼šhttps://github.com/kubernetes-sigs/nfs-subdir-external-provisioner æˆ‘ä»¬æŠŠè¿™ä¸‰ä¸ªæ–‡ä»¶å†™åœ¨åŒä¸€ä¸ª pvc-provisioner.yaml æ–‡ä»¶ä¸­ï¼Œä¾¿äºç§»æ¤ï¼š apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: managed-nfs-storage annotations: storageclass.kubernetes.io/is-default-class: &quot;true&quot; provisioner: k8s-sigs.io/nfs-subdir-external-provisioner parameters: archiveOnDelete: &quot;true&quot; --- apiVersion: apps/v1 kind: Deployment metadata: name: nfs-client-provisioner labels: app: nfs-client-provisioner # replace with namespace where provisioner is deployed namespace: mynfs spec: replicas: 1 strategy: type: Recreate selector: matchLabels: app: nfs-client-provisioner template: metadata: labels: app: nfs-client-provisioner spec: serviceAccountName: nfs-client-provisioner containers: - name: nfs-client-provisioner image: registry.cn-hangzhou.aliyuncs.com/jgqk8s/nfs-subdir-external-provisioner:v4.0.2 volumeMounts: - name: nfs-client-root mountPath: /persistentvolumes env: - name: PROVISIONER_NAME value: k8s-sigs.io/nfs-subdir-external-provisioner - name: NFS_SERVER value: 10.206.114.4 - name: NFS_PATH value: /nfs/data volumes: - name: nfs-client-root nfs: server: 10.206.114.4 path: /nfs/data --- apiVersion: v1 kind: ServiceAccount metadata: name: nfs-client-provisioner # replace with namespace where provisioner is deployed namespace: mynfs --- kind: ClusterRole apiVersion: rbac.authorization.k8s.io/v1 metadata: name: nfs-client-provisioner-runner rules: - apiGroups: [&quot;&quot;] resources: [&quot;nodes&quot;] verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;] - apiGroups: [&quot;&quot;] resources: [&quot;persistentvolumes&quot;] verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;delete&quot;] - apiGroups: [&quot;&quot;] resources: [&quot;persistentvolumeclaims&quot;] verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;update&quot;] - apiGroups: [&quot;storage.k8s.io&quot;] resources: [&quot;storageclasses&quot;] verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;] - apiGroups: [&quot;&quot;] resources: [&quot;events&quot;] verbs: [&quot;create&quot;, &quot;update&quot;, &quot;patch&quot;] --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: run-nfs-client-provisioner subjects: - kind: ServiceAccount name: nfs-client-provisioner # replace with namespace where provisioner is deployed namespace: mynfs roleRef: kind: ClusterRole name: nfs-client-provisioner-runner apiGroup: rbac.authorization.k8s.io --- kind: Role apiVersion: rbac.authorization.k8s.io/v1 metadata: name: leader-locking-nfs-client-provisioner # replace with namespace where provisioner is deployed namespace: mynfs rules: - apiGroups: [&quot;&quot;] resources: [&quot;endpoints&quot;] verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;] --- kind: RoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: leader-locking-nfs-client-provisioner # replace with namespace where provisioner is deployed namespace: mynfs subjects: - kind: ServiceAccount name: nfs-client-provisioner # replace with namespace where provisioner is deployed namespace: mynfs roleRef: kind: Role name: leader-locking-nfs-client-provisioner apiGroup: rbac.authorization.k8s.io 2ã€æ‰§è¡Œä¸Šé¢çš„yamlæ–‡ä»¶ï¼š [root@k8s-01 mytest]# kubectl apply -f pvc-provisioner.yaml storageclass.storage.k8s.io/managed-nfs-storage created deployment.apps/nfs-client-provisioner created serviceaccount/nfs-client-provisioner created clusterrole.rbac.authorization.k8s.io/nfs-client-provisioner-runner created clusterrolebinding.rbac.authorization.k8s.io/run-nfs-client-provisioner created role.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created rolebinding.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created [root@k8s-01 mytest]# kubectl get storageclass NAME PROVISIONER RECLAIMPOLICY VOLUMEBINDINGMODE ALLOWVOLUMEEXPANSION AGE managed-nfs-storage (default) k8s-sigs.io/nfs-subdir-external-provisioner Delete Immediate false 94s å…¶ä¸­çš„defaultï¼Œå°±ä»£è¡¨è¯¥StorageClassä¸ºé»˜è®¤SCï¼› å¦‚æœåˆšå¼€å§‹çš„Yamlæ–‡ä»¶ä¸­é…ç½®é…ç½®ä¸º default é»˜è®¤SCï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼ä¿®æ”¹ï¼› é€šè¿‡ kubectl edit å‘½ä»¤ä¿®æ”¹ï¼š kubectl edit sc managed-nfs-storage é€šè¿‡ kubectl patch å‘½ä»¤ä¿®æ”¹ï¼š kubectl patch storageclass managed-nfs-storage -p '{&quot;metadata&quot;: {&quot;annotations&quot;:{&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;true&quot;}}}' 3ã€åˆ›å»ºä¸€ä¸ªPod + PVCï¼Œä½¿ç”¨ä¸Šé¢çš„ SC å®ŒæˆåŠ¨æ€ä¾›åº” apiVersion: v1 kind: Pod metadata: name: &quot;auto-pv-nginx&quot; namespace: mytest labels: app: &quot;auto-pv-nginx&quot; spec: containers: - name: auto-pv-nginx image: &quot;nginx&quot; ports: - containerPort: 80 name: http volumeMounts: - name: localtime mountPath: /etc/localtime - name: html mountPath: /usr/share/nginx/html volumes: - name: localtime hostPath: path: /usr/share/zoneinfo/Asia/Shanghai - name: html persistentVolumeClaim: claimName: auto-pvc #ä¸‹æ–¹å¯¹åº”çš„pvcçš„åå­— restartPolicy: Always --- apiVersion: v1 kind: PersistentVolumeClaim metadata: name: auto-pvc namespace: mytest labels: app: auto-pvc spec: storageClassName: managed-nfs-storage #å¦‚æœæˆ‘ä»¬å·²ç»é…ç½®äº†é»˜è®¤çš„StorageClassï¼Œè¯¥è¡Œå¯ä»¥ç¼ºçœ accessModes: - ReadWriteOnce resources: requests: storage: 30m #å¾…ä¼šçœ‹çœ‹æ˜¯ä¸æ˜¯ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª30mçš„PVèµ„æº åº”ç”¨è¯¥yamlåï¼Œçœ‹çœ‹æ˜¯å¦è‡ªåŠ¨åˆ›å»ºäº†ä¸€ä¸ª30mçš„PVèµ„æºï¼š [root@k8s-01 mytest]# kubectl apply -f auto-pv-nginx.yaml pod/auto-pv-nginx created persistentvolumeclaim/auto-pvc created [root@k8s-01 mytest]# kubectl get pv NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE mypv-10m 10m RWO Retain Available my-nfs-storage 78m mypv-20m 20m RWO Retain Bound mytest/mypvc my-nfs-storage 78m mypv-50m 50m RWO Retain Available my-nfs-storage 78m pvc-b7ecbdff-89f4-4135-91b9-cf8d227ce86f 30m RWO Delete Bound mytest/auto-pvc managed-nfs-storage 26s 4ã€æˆ‘ä»¬å°†åˆšåˆšéƒ¨ç½²çš„æµ‹è¯•ç”¨çš„podå’Œpvcåˆ é™¤ï¼Œæ£€éªŒè¯¥SCçš„å›æ”¶ç­–ç•¥ï¼Ÿ [root@k8s-01 mytest]# ls /nfs/data/ aaa.txt bbb.txt index.html mytest-auto-pvc-pvc-b7ecbdff-89f4-4135-91b9-cf8d227ce86f one three two [root@k8s-01 mytest]# kubectl delete -f auto-pv-nginx.yaml pod &quot;auto-pv-nginx&quot; deleted persistentvolumeclaim &quot;auto-pvc&quot; deleted [root@k8s-01 mytest]# ls /nfs/data/ aaa.txt archived-mytest-auto-pvc-pvc-b7ecbdff-89f4-4135-91b9-cf8d227ce86f bbb.txt index.html one three two ä¸Šé¢çš„ç°è±¡è¶³ä»¥è¯æ˜ï¼š æˆ‘ä»¬æ­¤StorageClassåˆ›å»ºå‡ºæ¥çš„PVçš„å›æ”¶ç­–ç•¥ä¸ºDELETEï¼ˆPVCåˆ é™¤æ—¶å€™ï¼ŒPVä¹Ÿè¢«åˆ é™¤ï¼‰ ä½†æ˜¯è™½ç„¶PVè¢«åˆ é™¤äº†ï¼Œä½†æ˜¯åˆ é™¤å‰ï¼Œè¯¥SCå¸®æˆ‘ä»¬åšäº†æ•°æ®å¤‡ä»½ï¼›ï¼ˆåŸæ–‡ä»¶å¤¹å‰å¢åŠ äº†archived-å‰ç¼€ï¼‰â€”â€” archiveOnDelete å­—æ®µä¸ºtrue ","link":"https://tianxiawuhao.github.io/Ija68kq2u/"},{"title":"åºåˆ—åŒ–å·¥å…·Protobuf","content":"Nettyçš„ç¼–ç å’Œè§£ç  ç¼–å†™ç½‘ç»œåº”ç”¨ç¨‹åºæ—¶ï¼Œå› ä¸ºæ•°æ®åœ¨ç½‘ç»œä¸­ä¼ è¾“çš„éƒ½æ˜¯äºŒè¿›åˆ¶å­—èŠ‚ç æ•°æ®ï¼Œåœ¨å‘é€æ•°æ®æ—¶å°±éœ€è¦ç¼–ç ï¼Œæ¥æ”¶æ•°æ®æ—¶å°±éœ€è¦è§£ç  codec(ç¼–è§£ç å™¨) çš„ç»„æˆéƒ¨åˆ†æœ‰ä¸¤ä¸ªï¼šdecoder(è§£ç å™¨)å’Œ encoder(ç¼–ç å™¨)ã€‚encoder è´Ÿè´£æŠŠä¸šåŠ¡æ•°æ®è½¬æ¢æˆå­—èŠ‚ç æ•°æ®ï¼Œdecoder è´Ÿè´£æŠŠå­—èŠ‚ç æ•°æ®è½¬æ¢æˆä¸šåŠ¡æ•°æ®ã€‚ Nettyæä¾›çš„ç¼–ç å™¨å’Œè§£ç å™¨ Netty æä¾›çš„ç¼–ç å™¨ StringEncoderï¼Œå¯¹å­—ç¬¦ä¸²æ•°æ®è¿›è¡Œç¼–ç  ObjectEncoderï¼Œå¯¹ Java å¯¹è±¡è¿›è¡Œç¼–ç  Netty æä¾›çš„è§£ç å™¨ StringDecoder, å¯¹å­—ç¬¦ä¸²æ•°æ®è¿›è¡Œè§£ç  ObjectDecoderï¼Œå¯¹ Java å¯¹è±¡è¿›è¡Œè§£ç  Nettyæœ¬èº«çš„ç¼–è§£ç çš„æœºåˆ¶å’Œé—®é¢˜åˆ†æ Netty æœ¬èº«è‡ªå¸¦çš„ ObjectDecoder å’Œ ObjectEncoder å¯ä»¥ç”¨æ¥å®ç° POJO å¯¹è±¡æˆ–å„ç§ä¸šåŠ¡å¯¹è±¡çš„ç¼–ç å’Œè§£ç ï¼Œåº•å±‚ä½¿ç”¨çš„ä»æ˜¯ Java åºåˆ—åŒ–æŠ€æœ¯ , è€ŒJava åºåˆ—åŒ–æŠ€æœ¯æœ¬èº«æ•ˆç‡å°±ä¸é«˜ï¼Œå­˜åœ¨å¦‚ä¸‹é—®é¢˜ æ— æ³•è·¨è¯­è¨€ åºåˆ—åŒ–åçš„ä½“ç§¯å¤ªå¤§ï¼Œæ˜¯äºŒè¿›åˆ¶ç¼–ç çš„ 5 å€å¤šã€‚ åºåˆ—åŒ–æ€§èƒ½å¤ªä½ Protobufç®€ä»‹ Protobufæ˜¯ç”¨æ¥å°†å¯¹è±¡åºåˆ—åŒ–çš„ï¼Œç›¸ç±»ä¼¼çš„æŠ€æœ¯è¿˜æœ‰Jsonåºåˆ—åŒ–ç­‰ç­‰ã€‚å®ƒæ˜¯ä¸€ç§é«˜æ•ˆçš„ç»“æ„åŒ–æ•°æ®å­˜å‚¨æ ¼å¼ï¼Œå¯ä»¥ç”¨äºç»“æ„åŒ–æ•°æ®ä¸²è¡ŒåŒ–ï¼ˆåºåˆ—åŒ–ï¼‰ã€‚ Protobuf æ˜¯ä»¥ message çš„æ–¹å¼æ¥ç®¡ç†æ•°æ®çš„ æ”¯æŒè·¨å¹³å°ã€è·¨è¯­è¨€ï¼Œå³[å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯å¯ä»¥æ˜¯ä¸åŒçš„è¯­è¨€ç¼–å†™çš„] ï¼ˆæ”¯æŒç›®å‰ç»å¤§å¤šæ•°è¯­è¨€ï¼Œä¾‹å¦‚ C++ã€C#ã€Javaã€python ç­‰ é«˜æ€§èƒ½ï¼Œé«˜å¯é æ€§ ä½¿ç”¨ protobuf ç¼–è¯‘å™¨èƒ½è‡ªåŠ¨ç”Ÿæˆä»£ç ï¼ŒProtobuf æ˜¯å°†ç±»çš„å®šä¹‰ä½¿ç”¨.proto æ–‡ä»¶è¿›è¡Œæè¿°ã€‚è¯´æ˜ï¼Œåœ¨idea ä¸­ç¼–å†™ .proto æ–‡ä»¶æ—¶ï¼Œä¼šè‡ªåŠ¨æç¤ºæ˜¯å¦ä¸‹è½½ .ptotot ç¼–å†™æ’ä»¶. å¯ä»¥è®©è¯­æ³•é«˜äº®ã€‚ ç„¶åé€šè¿‡ protoc.exe ç¼–è¯‘å™¨æ ¹æ®.proto è‡ªåŠ¨ç”Ÿæˆ.java æ–‡ä»¶ Protobuf.exeä¸‹è½½ https://github.com/protocolbuffers/protobuf/releases protobufä¸­çš„å˜é‡ç±»å‹å’Œå…¶ä»–è¯­è¨€å¯¹ç…§è¡¨ Protobufçš„ä½¿ç”¨ å®šä¹‰protoæ–‡ä»¶ syntax = &quot;proto3&quot;; //ç‰ˆæœ¬ option optimize_for = SPEED; //åŠ å¿«è§£æ option java_outer_classname = &quot;MyDataInfo&quot;; //ç”Ÿæˆçš„å¤–éƒ¨ç±»åï¼ŒåŒæ—¶ä¹Ÿæ˜¯æ–‡ä»¶å message MyMessage { //å®šä¹‰ä¸€ä¸ªæšä¸¾ç±»å‹ enum DateType { StudentType = 0; //åœ¨proto3ä¸­ï¼Œè¦æ±‚enumçš„ç¼–å·ä»0å¼€å§‹ WorkerType = 1; } //ç›¸å½“äºmessageçš„å±æ€§ï¼Œç”¨data_typeæ¥æ ‡è¯†ä¼ çš„æ˜¯å“ªä¸€ä¸ªæšä¸¾ç±»å‹ï¼Œ1è¡¨ç¤ºå±æ€§åºå·1 DateType data_type = 1; //æ ‡è¯†æ¯æ¬¡æšä¸¾ç±»å‹æœ€å¤šåªèƒ½å‡ºç°å…¶ä¸­çš„ä¸€ä¸ªç±»å‹ï¼ŒèŠ‚çœç©ºé—´ oneof dataBody { Student stuent = 2; Worker worker = 3; } } message Student { //ä¼šåœ¨StudentPojo å¤–éƒ¨ç±»ç”Ÿæˆä¸€ä¸ªå†…éƒ¨ç±»Studentï¼Œä»–æ˜¯çœŸæ­£å‘é€çš„pojoå¯¹è±¡ int32 id = 1; //Studentç±»ä¸­æœ‰ä¸€ä¸ªå±æ€§åå­—ä¸ºIDï¼Œç±»å‹ä¸ºint32ï¼ˆprotobufç±»å‹ï¼‰ï¼Œ1è¡¨ç¤ºåºå·ï¼Œä¸æ˜¯å€¼ string name = 2; } message Worker { string name = 1; int32 age = 2; } ç”Ÿæˆjavaæ–‡ä»¶ protoc.exe --java_out=. xxx.proto pom &lt;!--åºåˆ—åŒ–å·¥å…·protobuf--&gt; &lt;dependency&gt; &lt;groupId&gt;com.google.protobuf&lt;/groupId&gt; &lt;artifactId&gt;protobuf-java&lt;/artifactId&gt; &lt;version&gt;3.15.3&lt;/version&gt; &lt;/dependency&gt; æ³¨æ„protoc.exeä¸‹è½½çš„ç‰ˆæœ¬æ˜¯3.15.3ï¼Œè¿™é‡Œprotobufçš„pomä¾èµ–ä¹Ÿå¾—æ˜¯å¯¹åº”çš„ç‰ˆæœ¬ï¼Œå¦åˆ™protoc.exeç”Ÿæˆçš„javaæ–‡ä»¶æ”¾å…¥é¡¹ç›®ä¸­æŠ¥é”™ã€‚ å®¢æˆ·ç«¯ public class Client { //å±æ€§ private final String host; private final int port; public Client(String host, int port) { this.port = port; this.host = host; } public void run() throws InterruptedException { NioEventLoopGroup eventExecutors = new NioEventLoopGroup(); try { Bootstrap bootstrap = new Bootstrap() .group(eventExecutors) .channel(NioSocketChannel.class) .handler(new ChannelInitializer&lt;SocketChannel&gt;() { @Override protected void initChannel(SocketChannel ch) throws Exception { ChannelPipeline pipeline = ch.pipeline(); //åŠ å…¥Handler pipeline.addLast(&quot;encoder&quot;,new ProtobufEncoder()); pipeline.addLast(new GroupChatClientHandler()); } }); ChannelFuture channelFuture = bootstrap.connect(host, port).sync(); //å¾—åˆ°channel Channel channel = channelFuture.channel(); System.out.println(&quot;--------&quot; + channel.localAddress() + &quot;---------&quot;); //å®¢æˆ·ç«¯éœ€è¦è¾“å…¥ä¿¡æ¯ï¼Œåˆ›å»ºä¸€ä¸ªæ‰«æå™¨ Scanner scanner = new Scanner(System.in); MyDataInfo.MyMessage message = null; while (scanner.hasNextLine()){ String msg = scanner.nextLine(); if (&quot;1&quot;.equals(msg)){ message = MyDataInfo.MyMessage. newBuilder(). setDataType(MyDataInfo.MyMessage.DateType.StudentType) .setStuent(MyDataInfo.Student .newBuilder() .setId(5) .setName(&quot;ç‹äº”&quot;) .build()) .build(); }else { message = MyDataInfo.MyMessage. newBuilder(). setDataType(MyDataInfo.MyMessage.DateType.WorkerType). setWorker(MyDataInfo.Worker. newBuilder(). setName(&quot;æå››&quot;). setAge(11). build()).build(); } channel.writeAndFlush(message); } } finally { eventExecutors.shutdownGracefully(); } } public static void main(String[] args) throws InterruptedException { new Client(&quot;127.0.0.1&quot;, 7000).run(); } } æœåŠ¡ç«¯ package com.pl.netty.protobuf; public class Server { private int port; public Server(int port) { this.port = port; } public void run(){ //bossGroup ç”¨äºæ¥æ”¶è¿æ¥ NioEventLoopGroup bossGroup = new NioEventLoopGroup(1); //workerGroup ç”¨äºå…·ä½“çš„å¤„ç† NioEventLoopGroup workerGroup = new NioEventLoopGroup(); try { // Bootstrap ç±»æ˜¯å®¢æˆ·ç«¯ç¨‹åºçš„å¯åŠ¨å¼•å¯¼ç±»ï¼ŒServerBootstrap æ˜¯æœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼ç±» ServerBootstrap serverBootstrap = new ServerBootstrap(); serverBootstrap.group(bossGroup,workerGroup) //Netty ç½‘ç»œé€šä¿¡çš„ç»„ä»¶ï¼Œèƒ½å¤Ÿç”¨äºæ‰§è¡Œç½‘ç»œ I/O æ“ä½œã€‚ é€‰æ‹©å“ªç§channel å¼‚æ­¥çš„æœåŠ¡å™¨ç«¯ TCP Socket è¿æ¥ .channel(NioServerSocketChannel.class) //ChannelOption.SO_BACKLOG å¯¹åº” TCP/IP åè®® listen å‡½æ•°ä¸­çš„ backlog å‚æ•°ï¼Œç”¨æ¥åˆå§‹åŒ–æœåŠ¡å™¨å¯è¿æ¥é˜Ÿåˆ—å¤§å°ã€‚ //æœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚æ˜¯é¡ºåºå¤„ç†çš„ï¼Œæ‰€ä»¥åŒä¸€æ—¶é—´åªèƒ½å¤„ç†ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ã€‚å¤šä¸ªå®¢æˆ·ç«¯æ¥çš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯å°†ä¸èƒ½å¤„ç†çš„å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚æ”¾åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…å¤„ç†ï¼Œbacklog å‚æ•°æŒ‡å®šäº†é˜Ÿåˆ—çš„å¤§å°ã€‚ //Socketå‚æ•°ï¼ŒæœåŠ¡ç«¯æ¥å—è¿æ¥çš„é˜Ÿåˆ—é•¿åº¦ï¼Œå¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œå®¢æˆ·ç«¯è¿æ¥å°†è¢«æ‹’ç»ã€‚é»˜è®¤å€¼ï¼ŒWindowsä¸º200ï¼Œå…¶ä»–ä¸º128ã€‚ .option(ChannelOption.SO_BACKLOG,128) //Nettyä¸­çš„optionä¸»è¦æ˜¯è®¾ç½®çš„ServerChannelçš„ä¸€äº›é€‰é¡¹ï¼Œè€ŒchildOptionä¸»è¦æ˜¯è®¾ç½®çš„ServerChannelçš„å­Channelçš„é€‰é¡¹ã€‚ //SO_KEEPALIVE è¿æ¥ä¿æ´»ï¼Œé»˜è®¤å€¼ä¸ºFalseã€‚å¯ç”¨è¯¥åŠŸèƒ½æ—¶ï¼ŒTCPä¼šä¸»åŠ¨æ¢æµ‹ç©ºé—²è¿æ¥çš„æœ‰æ•ˆæ€§ã€‚å¯ä»¥å°†æ­¤åŠŸèƒ½è§†ä¸ºTCPçš„å¿ƒè·³æœºåˆ¶ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼šé»˜è®¤çš„å¿ƒè·³é—´éš”æ˜¯7200så³2å°æ—¶ã€‚Nettyé»˜è®¤å…³é—­è¯¥åŠŸèƒ½ã€‚ .childOption(ChannelOption.SO_KEEPALIVE, true) //å®šä¹‰worker .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() { @Override protected void initChannel(SocketChannel socketChannel) throws Exception { ChannelPipeline pipeline = socketChannel.pipeline(); pipeline.addLast(&quot;decoder&quot;,new ProtobufDecoder(MyDataInfo.MyMessage.getDefaultInstance())); pipeline.addLast(new GroupChatServerHandler()); } }); System.out.println(&quot;netty æœåŠ¡ç«¯å¯åŠ¨&quot;); //Netty ä¸­æ‰€æœ‰çš„ IO æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä¸èƒ½ç«‹åˆ»å¾—çŸ¥æ¶ˆæ¯æ˜¯å¦è¢«æ­£ç¡®å¤„ç†ã€‚ä½†æ˜¯å¯ä»¥è¿‡ä¸€ä¼šç­‰å®ƒæ‰§è¡Œå®Œæˆæˆ–è€…ç›´æ¥æ³¨å†Œä¸€ä¸ªç›‘å¬ï¼Œå…·ä½“çš„å®ç°å°±æ˜¯é€šè¿‡ Future å’Œ ChannelFuturesï¼Œä»–ä»¬å¯ä»¥æ³¨å†Œä¸€ä¸ªç›‘å¬ï¼Œå½“æ“ä½œæ‰§è¡ŒæˆåŠŸæˆ–å¤±è´¥æ—¶ç›‘å¬ä¼šè‡ªåŠ¨è§¦å‘æ³¨å†Œçš„ç›‘å¬äº‹ä»¶ ChannelFuture channelFuture = serverBootstrap.bind(port).sync(); //ç›‘å¬å…³é—­äº‹ä»¶ channelFuture.channel().closeFuture().sync(); }catch (InterruptedException e) { e.printStackTrace(); }finally { bossGroup.shutdownGracefully(); workerGroup.shutdownGracefully(); } } public static void main(String[] args) { Server server = new Server(7000); server.run(); } } GroupChatServerHandler package com.pl.netty.protobuf; /** * @Description: TODO * @ClassName GroupchatServerHandler ç»§æ‰¿ SimpleChannelInboundHandler å…¥æ ˆï¼ŒæŒ‡å®šä¿¡æ¯æ³›å‹ä¸ºMyDataInfo.MyMessage * @Version V1.0.0 */ public class GroupChatServerHandler extends SimpleChannelInboundHandler&lt;MyDataInfo.MyMessage&gt; { //å®šä¹‰ä¸€ä¸ªChannelç»„ï¼Œç®¡ç†æ‰€æœ‰çš„channel //GlobalEventExecutor.INSTANCE æ˜¯å…¨å±€äº‹ä»¶æ‰§è¡Œå™¨ï¼Œæ˜¯ä¸€ä¸ªå•ä¾‹ private static ChannelGroup channelGroup = new DefaultChannelGroup(GlobalEventExecutor.INSTANCE); SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;); //æ­¤æ–¹æ³•è¡¨ç¤ºè¿æ¥å»ºç«‹ï¼Œä¸€æ—¦å»ºç«‹è¿æ¥ï¼Œå°±ç¬¬ä¸€ä¸ªè¢«æ‰§è¡Œ @Override public void handlerAdded(ChannelHandlerContext ctx) throws Exception { Channel channel = ctx.channel(); //è¯¥æ–¹æ³•ä¼šå°† channelGroup ä¸­æ‰€æœ‰ channel éå†ï¼Œå¹¶å‘é€æ¶ˆæ¯ï¼Œè€Œä¸éœ€è¦æˆ‘ä»¬è‡ªå·±å»éå† channelGroup.writeAndFlush(&quot;[å®¢æˆ·ç«¯]&quot; + channel.remoteAddress() + sdf.format(new Date()) + &quot;åŠ å…¥èŠå¤©\\n&quot;); //å°†å½“å‰çš„ChannelåŠ å…¥åˆ° ChannelGroup channelGroup.add(channel); } //è¡¨ç¤º channel å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œæç¤º xxx ä¸Šçº¿ @Override public void channelActive(ChannelHandlerContext ctx) throws Exception { System.out.println(ctx.channel().remoteAddress() + &quot; &quot; + sdf.format(new Date()) + &quot;ä¸Šçº¿äº†~&quot;); } //è¡¨ç¤º channel å¤„äºä¸æ´»åŠ¨çŠ¶æ€ï¼Œæç¤º xxx ç¦»çº¿ @Override public void channelInactive(ChannelHandlerContext ctx) throws Exception { System.out.println(ctx.channel().remoteAddress() + &quot; &quot; + sdf.format(new Date()) + &quot;ç¦»çº¿äº†~&quot;); } @Override protected void channelRead0(ChannelHandlerContext channelHandlerContext, MyDataInfo.MyMessage msg) throws Exception { MyDataInfo.MyMessage.DateType dataType = msg.getDataType(); if (dataType == MyDataInfo.MyMessage.DateType.StudentType){ MyDataInfo.Student student = msg.getStuent(); System.out.println(&quot;å­¦ç”ŸId = &quot; + student.getId() + student.getName()); }else if (dataType == MyDataInfo.MyMessage.DateType.WorkerType){ MyDataInfo.Worker worker = msg.getWorker(); System.out.println(&quot;å·¥äººï¼šname = &quot; + worker.getName() + worker.getAge()); }else { System.out.println(&quot;è¾“å…¥çš„ç±»å‹ä¸æ­£ç¡®&quot;); } } } ","link":"https://tianxiawuhao.github.io/A4ZOEAhc9/"},{"title":"minioæ–°ç‰ˆæ­å»ºå’Œæ•°æ®è¿ç§»","content":"MinIO æ˜¯ä¸€ä¸ªåŸºäºApache License v2.0å¼€æºåè®®çš„å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼Œæ˜¯ä¸€ä¸ªéå¸¸è½»é‡çº§çš„æœåŠ¡ï¼Œéå¸¸é€‚åˆäºå­˜å‚¨å¤§å®¹é‡éç»“æ„åŒ–çš„æ•°æ®ï¼Œä¾‹å¦‚å›¾ç‰‡ã€è§†é¢‘ã€æ—¥å¿—æ–‡ä»¶ã€å¤‡ä»½æ•°æ®å’Œå®¹å™¨/è™šæ‹Ÿæœºé•œåƒç­‰ï¼Œè€Œä¸€ä¸ªå¯¹è±¡æ–‡ä»¶å¯ä»¥æ˜¯ä»»æ„å¤§å°ï¼Œä»å‡ kbåˆ°æœ€å¤§5Tä¸ç­‰ minioæ­å»º è·å–æœ€æ–°ç‰ˆæœ¬minio docker pull minio/minio å¯åŠ¨minio docker run --name minio -p 9000:9000 -p 9090:9090 -d --restart=always -e &quot;MINIO_ROOT_USER=admin&quot; -e &quot;MINIO_ROOT_PASSWORD=admin123&quot; -v C:\\installation\\minio\\data:/data -v C:\\installation\\minio\\config:/root/.minio minio/minio server /data --console-address &quot;:9000&quot; --address &quot;:9090&quot; æ•°æ®è¿ç§» Rclone Rclone æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œç¨‹åºï¼Œç”¨äºç®¡ç†äº‘å­˜å‚¨ä¸Šçš„æ–‡ä»¶ã€‚å®ƒæ˜¯äº‘ä¾›åº”å•† Web å­˜å‚¨æ¥å£çš„åŠŸèƒ½ä¸°å¯Œçš„æ›¿ä»£å“ã€‚è¶…è¿‡ 40 ç§äº‘å­˜å‚¨äº§å“æ”¯æŒ rcloneï¼ŒåŒ…æ‹¬ S3 å¯¹è±¡å­˜å‚¨ã€å•†ä¸šå’Œæ¶ˆè´¹è€…æ–‡ä»¶å­˜å‚¨æœåŠ¡ä»¥åŠæ ‡å‡†ä¼ è¾“åè®®ã€‚ Rclone å¹¿æ³›ç”¨äº Linuxã€Windows å’Œ Macã€‚ç¬¬ä¸‰æ–¹å¼€å‘äººå‘˜ä½¿ç”¨ rclone å‘½ä»¤è¡Œæˆ– API åˆ›å»ºåˆ›æ–°çš„å¤‡ä»½ã€æ¢å¤ã€GUI å’Œä¸šåŠ¡æµç¨‹è§£å†³æ–¹æ¡ˆã€‚ å°†æ–‡ä»¶å¤‡ä»½ï¼ˆå’ŒåŠ å¯†ï¼‰åˆ°äº‘å­˜å‚¨ ä»äº‘å­˜å‚¨æ¢å¤ï¼ˆå’Œè§£å¯†ï¼‰æ–‡ä»¶ å°†äº‘æ•°æ®é•œåƒåˆ°å…¶ä»–äº‘æœåŠ¡æˆ–æœ¬åœ° å°†æ•°æ®è¿ç§»åˆ°äº‘ç«¯ï¼Œæˆ–åœ¨äº‘å­˜å‚¨ä¾›åº”å•†ä¹‹é—´è¿ç§» å°†å¤šä¸ªã€åŠ å¯†ã€ç¼“å­˜æˆ–å¤šæ ·åŒ–çš„äº‘å­˜å‚¨æŒ‚è½½ä¸ºç£ç›˜ ä½¿ç”¨lsfã€ljsonã€sizeã€ncduåˆ†æå’Œè¯´æ˜äº‘å­˜å‚¨ä¸­ä¿å­˜çš„æ•°æ® å°†æ–‡ä»¶ç³»ç»Ÿè”åˆåœ¨ä¸€èµ·ä»¥å°†å¤šä¸ªæœ¬åœ°å’Œ/æˆ–äº‘æ–‡ä»¶ç³»ç»Ÿå‘ˆç°ä¸ºä¸€ä¸ª å®‰è£…Rclone curl https://rclone.org/install.sh | sudo bash å¦‚æœç½‘ç»œä¸å¥½å»ºè®®å…ˆä¸‹è½½åˆ°æœ¬åœ°ï¼Œç„¶åä¸Šä¼ åˆ°æœåŠ¡å™¨ # ä¸‹è½½æ–‡ä»¶ wget https://downloads.rclone.org/v1.57.0/rclone-v1.57.0-linux-amd64.zip # è§£å‹æ–‡ä»¶ unzip rclone-v1.57.0-linux-amd64.zip # ç»™ä¸€ä¸‹æƒé™ chmod 0755 ./rclone-v1.57.0-linux-amd64/rclone # æ‹·è´åˆ° /usr/bin/ å¯ä»¥ç›´æ¥ä½¿ç”¨ rcloneå‘½ä»¤ cp ./rclone-v1.57.0-linux-amd64p/rclone /usr/bin/ # åˆ é™¤æºæ–‡ä»¶ rm -rf ./rclone-v1.56.0-linux-amd64.zip windowsä¸‹è½½ #å®˜ç½‘ä¸‹è½½ï¼š http://rclone.org/downloads/ #GitHubä¸‹è½½ï¼š http://github.com/rclone/rclone é…ç½® rclone config - è¿›å…¥äº¤äº’å¼é…ç½®é€‰é¡¹ï¼Œè¿›è¡Œæ·»åŠ ã€åˆ é™¤ã€ç®¡ç†ç½‘ç›˜ç­‰æ“ä½œã€‚ rclone config file - æ˜¾ç¤ºé…ç½®æ–‡ä»¶çš„è·¯å¾„ï¼Œä¸€èˆ¬é…ç½®æ–‡ä»¶åœ¨ ~/.config/rclone/rclone.confï¼Œæ›´æ¢æœåŠ¡å™¨å¯ç›´æ¥copyè¯¥æ–‡ä»¶ã€‚ rclone config show - æ˜¾ç¤ºé…ç½®æ–‡ä»¶ä¿¡æ¯ cat ~/.config/rclone/rclone.conf # å¤‡æ³¨ï¼šå¯ä»¥åœ¨ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­é…ç½®å¤šä»½ï¼Œä½¿ç”¨[name]æ¥åŒºåˆ† [oldminio] type = s3 provider = Minio env_auth = false access_key_id = minio secret_access_key = 123 region = cn-east-1 endpoint = http://IP:PORT location_constraint = server_side_encryption = [newminio] type = s3 provider = Minio env_auth = false access_key_id = minio secret_access_key = 123 region = cn-east-1 endpoint = http://IP:PORT location_constraint = server_side_encryption = rclone sync checksum oldminio:model-file-bucket newminio:model-file-bucket å¸¸ç”¨åŠŸèƒ½ # å°†é˜¿é‡Œäº‘minioçš„æ•°æ®è¿ç§»åˆ°è…¾è®¯çš„cosä¸Š # aliyun é…ç½®æ–‡ä»¶çš„åç§° # wechat-root-files å­˜å‚¨æ¡¶åç§° # files è¦ä¼ è¾“çš„æ–‡ä»¶ # -P æ˜¾ç¤ºå®æ—¶ä¼ è¾“è¿›åº¦ # --transfers=N - å¹¶è¡Œæ–‡ä»¶æ•°ï¼Œé»˜è®¤ä¸º 4ã€‚åœ¨æ¯”è¾ƒå°çš„å†…å­˜çš„ VPS ä¸Šå»ºè®®è°ƒå°è¿™ä¸ªå‚æ•°ï¼Œæ¯”å¦‚ 128M çš„å°é¸¡ä¸Šä½¿ç”¨å»ºè®®è®¾ç½®ä¸º 1 ./rclone sync aliyun:wechat-root-files/files tencent:sj-data-testwechat-1307267266/files -P --transfers=200 # åˆ é™¤æ–‡ä»¶ ./rclone delete tencent:sj-data-testwechat-1307267266/wechat-root-files -P --transfers=100 å¸¸ç”¨åŠŸèƒ½é€‰é¡¹ rclone copy - å¤åˆ¶ rclone move - ç§»åŠ¨ï¼Œå¦‚æœè¦åœ¨ç§»åŠ¨ååˆ é™¤ç©ºæºç›®å½•ï¼Œè¯·åŠ ä¸Š --delete-empty-src-dirs å‚æ•° rclone sync - åŒæ­¥ï¼šå°†æºç›®å½•åŒæ­¥åˆ°ç›®æ ‡ç›®å½•ï¼Œåªæ›´æ”¹ç›®æ ‡ç›®å½•ã€‚ rclone delete - åˆ é™¤è·¯å¾„ä¸‹çš„æ–‡ä»¶å†…å®¹ã€‚ rclone purge - åˆ é™¤è·¯å¾„åŠå…¶æ‰€æœ‰æ–‡ä»¶å†…å®¹ã€‚ rclone mkdir - åˆ›å»ºç›®å½•ã€‚ rclone rmdir - åˆ é™¤ç›®å½•ã€‚ rclone rmdirs - åˆ é™¤æŒ‡å®šçµå¢ƒä¸‹çš„ç©ºç›®å½•ã€‚å¦‚æœåŠ ä¸Š --leave-root å‚æ•°ï¼Œåˆ™ä¸ä¼šåˆ é™¤æ ¹ç›®å½•ã€‚ rclone check - æ£€æŸ¥æºå’Œç›®çš„åœ°å€æ•°æ®æ˜¯å¦åŒ¹é…ã€‚ rclone ls - åˆ—å‡ºæŒ‡å®šè·¯å¾„ä¸‹çš„æ‰€æœ‰çš„æ–‡ä»¶ä»¥åŠæ–‡ä»¶å¤§å°å’Œè·¯å¾„ã€‚ rclone lsl - æ¯”ä¸Šé¢å¤šä¸€ä¸ªæ˜¾ç¤ºä¸Šä¼ æ—¶é—´ã€‚ rclone lsd åˆ—å‡ºæŒ‡å®šè·¯å¾„ä¸‹çš„ç›®å½• rclone lsf - åˆ—å‡ºæŒ‡å®šè·¯å¾„ä¸‹çš„ç›®å½•å’Œæ–‡ä»¶ # æ—¥å¿— # rclone æœ‰ 4 ä¸ªçº§åˆ«çš„æ—¥å¿—è®°å½•ï¼ŒERRORï¼ŒNOTICEï¼ŒINFO å’Œ DEBUGã€‚ # é»˜è®¤æƒ…å†µä¸‹ï¼Œrclone å°†ç”Ÿæˆ ERROR å’Œ NOTICE çº§åˆ«æ¶ˆæ¯ã€‚ å¸¸ç”¨å‚æ•° -n = --dry-run - æµ‹è¯•è¿è¡Œï¼Œç”¨æ¥æŸ¥çœ‹ rclone åœ¨å®é™…è¿è¡Œä¸­ä¼šè¿›è¡Œå“ªäº›æ“ä½œã€‚ -P = --progress - æ˜¾ç¤ºå®æ—¶ä¼ è¾“è¿›åº¦ã€‚ --cache-chunk-size SizeSuffi - å—çš„å¤§å°ï¼Œé»˜è®¤ 5Mï¼Œç†è®ºä¸Šæ˜¯è¶Šå¤§ä¸Šä¼ é€Ÿåº¦è¶Šå¿«ï¼ŒåŒæ—¶å ç”¨å†…å­˜ä¹Ÿè¶Šå¤šã€‚å¦‚æœè®¾ç½®å¾—å¤ªå¤§ï¼Œå¯èƒ½ä¼šå¯¼è‡´è¿›ç¨‹ä¸­æ–­ã€‚ --cache-chunk-total-size SizeSuffix - å—å¯ä»¥åœ¨æœ¬åœ°ç£ç›˜ä¸Šå ç”¨çš„æ€»å¤§å°ï¼Œé»˜è®¤ 10Gã€‚ --transfers=N - å¹¶è¡Œæ–‡ä»¶æ•°ï¼Œé»˜è®¤ä¸º 4ã€‚åœ¨æ¯”è¾ƒå°çš„å†…å­˜çš„ VPS ä¸Šå»ºè®®è°ƒå°è¿™ä¸ªå‚æ•°ï¼Œæ¯”å¦‚ 128M çš„å°é¸¡ä¸Šä½¿ç”¨å»ºè®®è®¾ç½®ä¸º 1ã€‚ --config string - æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„ï¼Œstring ä¸ºé…ç½®æ–‡ä»¶è·¯å¾„ã€‚æ¯”å¦‚åœ¨ä½¿ç”¨å®å¡”é¢æ¿è¾“å…¥å‘½ä»¤æ“ä½œæ—¶å¯èƒ½ä¼šé‡åˆ°æ‰¾ä¸åˆ°é…ç½®æ–‡ä»¶çš„é—®é¢˜ï¼Œè¿™æ—¶å°±éœ€è¦æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„ã€‚ --s3-provider Other --max-backlog #N # åœ¨ sync/copy/move æ—¶ä½¿ç”¨ï¼Œå ç”¨ N å€ KB å†…å­˜ --buffer-size=SIZE # åŠ é€Ÿ sync/copy/move --bwlimit UP:DOWN # ä¸Šä¼ ä¸‹è½½é™é€Ÿï¼Œb|k|M|G --size-only ä½¿ç”¨syncåŠŸèƒ½é…åˆæ­¤å‚æ•°ï¼Œè¡¨ç¤ºåªæœ‰æ–‡ä»¶å¤§å°æœ‰å˜åŒ–æ‰ä¼šåŒæ­¥æ–‡ä»¶ï¼Œå¯èƒ½å­˜åœ¨æ–‡ä»¶å¤§å°æœªå˜ä½†æ˜¯æ–‡ä»¶å·²ç»å‘ç”Ÿå˜åŒ–ï¼Œä¸æ¨èä½¿ç”¨ï¼› --checksum é€šè¿‡md5åˆ¤æ–­æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–ï¼Œmd5å‘ç”Ÿå˜åŒ–æ—¶æ‰ä¼šåŒæ­¥æ–‡ä»¶ï¼›å¦‚æœsourceæ˜¯æœ¬åœ°ç£ç›˜ï¼Œè¿™ä¼šå¸¦æ¥è¾ƒå¤šçš„ç£ç›˜å’ŒCPUæ¶ˆè€—ï¼›å¦‚æœsourceå’Œdestinationéƒ½æ˜¯å¯¹è±¡å­˜å‚¨ï¼Œåˆ™æ¨èä½¿ç”¨è¿™ä¸ªå‚æ•°ï¼› --update --use-server-modtime é€šè¿‡mtimeåˆ¤æ–­æ–‡ä»¶æ˜¯å¦å˜åŒ–ï¼Œåªæœ‰å½“æœ¬åœ°æ–‡ä»¶çš„mtimeè¾ƒæ–°æ—¶ï¼Œæ–‡ä»¶æ‰ä¼šä¸Šä¼  --fast-list rcloneé»˜è®¤çš„éå†æ–¹å¼æ˜¯å•ç‹¬å¤„ç†æ¯ä¸ªç›®å½•ï¼Œæ¯ä¸ªç›®å½•è°ƒç”¨1æ¬¡APIã€‚ä½¿ç”¨è¿™ä¸ªå‚æ•°å°†ä¼šå°†æ‰€æœ‰æ–‡ä»¶ä¿¡æ¯åŠ å…¥å†…å­˜ï¼ˆ1000ä¸ªæ–‡ä»¶è¿›è¡Œ1æ¬¡APIè°ƒç”¨ï¼‰ï¼Œ1ä¸ªæ–‡ä»¶æ¶ˆè€—1kå†…å­˜ã€‚ --no-traverse å½“destinationä¸­æ–‡ä»¶è¾ƒå¤šæ—¶ï¼Œä½¿ç”¨æ­¤å‚æ•°å°†ä¼šç›´æ¥æŸ¥æ‰¾è¿™ä¸ªæ–‡ä»¶ï¼Œè€Œä¸æ˜¯é€šè¿‡æ–‡ä»¶åˆ—è¡¨ --max-age é™åˆ¶æ–‡ä»¶æœ€å¤§ageï¼Œç”¨æ¥ä¸Šä¼ æœ€è¿‘çš„æ–‡ä»¶ --s3-no-head é»˜è®¤ä¸Šä¼ åä¼šé€šè¿‡headæ£€æµ‹æ–‡ä»¶æ˜¯å¦å·²ç»ä¸Šä¼ ï¼Œé€šè¿‡æ­¤å‚æ•°å¯å…³é—­ã€‚ --s3-upload-cutoff æ–‡ä»¶å¤§äºè¿™ä¸ªå€¼ä¼šä½¿ç”¨åˆ†ç‰‡ä¸Šä¼ ï¼Œé»˜è®¤å€¼æ˜¯200Mï¼Œæœ€å¤§å€¼æ˜¯5G https:ã€ã€rclone.org/s3/ #s3-upload-cutoff --s3-disable-checksum ä¸è®¡ç®—md5 --s3-upload-concurrency é»˜è®¤å€¼4ï¼Œæœ‰å¤šå°‘chunckåŒæ—¶ä¸Šä¼ ï¼Œå¦‚æœä¼ å°‘é‡å¤§æ–‡ä»¶ï¼Œæé«˜è¿™ä¸ªå‚æ•°å¯ä»¥æå‡å¸¦å®½ã€‚ --s3-chunk-size é»˜è®¤å€¼ 5M --s3-max-upload-parts é»˜è®¤å€¼10000 --s3-force-path-style é»˜è®¤å€¼true --s3-v2-auth é»˜è®¤å€¼false --s3-list-chunk é»˜è®¤å€¼1000ï¼Œæ¯æ¬¡listè¿”å›çš„keyæ•°é‡ æ—¥å¿— # rclone æœ‰ 4 ä¸ªçº§åˆ«çš„æ—¥å¿—è®°å½•ï¼ŒERRORï¼ŒNOTICEï¼ŒINFO å’Œ DEBUGã€‚ # é»˜è®¤æƒ…å†µä¸‹ï¼Œrclone å°†ç”Ÿæˆ ERROR å’Œ NOTICE çº§åˆ«æ¶ˆæ¯ã€‚ # -q rclone å°†ä»…ç”Ÿæˆ ERROR æ¶ˆæ¯ã€‚ # -v rclone å°†ç”Ÿæˆ ERRORï¼ŒNOTICE å’Œ INFO æ¶ˆæ¯ï¼Œæ¨èæ­¤é¡¹ã€‚ # -vv rclone å°†ç”Ÿæˆ ERRORï¼ŒNOTICEï¼ŒINFO å’Œ DEBUG æ¶ˆæ¯ã€‚ # --log-level LEVEL æ ‡å¿—æ§åˆ¶æ—¥å¿—çº§åˆ«ã€‚ # è¾“å‡ºæ—¥å¿—åˆ°æ–‡ä»¶ # ä½¿ç”¨ --log-file=FILE é€‰é¡¹ï¼Œrclone ä¼šå°† Errorï¼ŒInfo å’Œ Debug æ¶ˆæ¯ä»¥åŠæ ‡å‡†é”™è¯¯é‡å®šå‘åˆ° FILEï¼Œè¿™é‡Œçš„ FILE æ˜¯ä½ æŒ‡å®šçš„æ—¥å¿—æ–‡ä»¶è·¯å¾„ã€‚ # å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ç³»ç»Ÿçš„æŒ‡å‘å‘½ä»¤ï¼Œæ¯”å¦‚ # rclone sync -v Onedrive:/DRIVEX Gdrive:/DRIVEX &gt; &quot;~/DRIVEX.log&quot; 2&gt;&amp;1 # æ–‡ä»¶è¿‡æ»¤ # --exclude æ’é™¤æ–‡ä»¶æˆ–ç›®å½•ã€‚æ¯”å¦‚ --exclude *.bakï¼Œæ’é™¤æ‰€æœ‰ bak æ–‡ä»¶ã€‚ # --include åŒ…å«æ–‡ä»¶æˆ–ç›®å½•ã€‚æ¯”å¦‚ --include *.{png,jpg} ï¼ŒåŒ…å«æ‰€æœ‰ png å’Œ jpg æ–‡ä»¶ï¼Œæ’é™¤å…¶ä»–æ–‡ä»¶ã€‚ # --delete-excluded åˆ é™¤æ’é™¤çš„æ–‡ä»¶ã€‚éœ€é…åˆè¿‡æ»¤å‚æ•°ä½¿ç”¨ï¼Œå¦åˆ™æ— æ•ˆã€‚ # ç›®å½•è¿‡æ»¤ # --exclude .git/ æ’é™¤æ‰€æœ‰ç›®å½•ä¸‹çš„ .git ç›®å½•ã€‚ # --exclude /.git/ åªæ’é™¤æ ¹ç›®å½•ä¸‹çš„ .git ç›®å½•ã€‚ ","link":"https://tianxiawuhao.github.io/SznSzjoX7/"},{"title":"springå¯åŠ¨æµç¨‹","content":"Springçš„å¯åŠ¨æµç¨‹å¯ä»¥å½’çº³ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š 1ã€åˆå§‹åŒ–Springå®¹å™¨ï¼Œæ³¨å†Œå†…ç½®BeanPostProcessorçš„BeanDefinitionåˆ°å®¹å™¨ä¸­ 2ã€å°†é…ç½®ç±»çš„BeanDefinitionæ³¨å†Œåˆ°å®¹å™¨ä¸­ 3ã€è°ƒç”¨refresh()æ–¹æ³•åˆ·æ–°å®¹å™¨ å› ä¸ºæ˜¯åŸºäº java-config æŠ€æœ¯åˆ†ææºç ï¼Œæ‰€ä»¥è¿™é‡Œçš„å…¥å£æ˜¯ AnnotationConfigApplicationContext ï¼Œå¦‚æœæ˜¯ä½¿ç”¨ xml åˆ†æï¼Œé‚£ä¹ˆå…¥å£å³ä¸º ClassPathXmlApplicationContext ï¼Œå®ƒä»¬ä¿©çš„å…±åŒç‰¹å¾ä¾¿æ˜¯éƒ½ç»§æ‰¿äº† AbstractApplicationContext ç±»ï¼Œè€Œå¤§åé¼é¼çš„ refresh()ä¾¿æ˜¯åœ¨è¿™ä¸ªç±»ä¸­å®šä¹‰çš„ã€‚æˆ‘ä»¬æ¥ç€åˆ†æ AnnotationConfigApplicationContext ç±»ï¼Œæºç å¦‚ä¸‹ï¼š // åˆå§‹åŒ–å®¹å™¨ public AnnotationConfigApplicationContext(Class&lt;?&gt;... annotatedClasses) { // æ³¨å†Œ Spring å†…ç½®åç½®å¤„ç†å™¨çš„ BeanDefinition åˆ°å®¹å™¨ this(); // æ³¨å†Œé…ç½®ç±» BeanDefinition åˆ°å®¹å™¨ register(annotatedClasses); // åŠ è½½æˆ–è€…åˆ·æ–°å®¹å™¨ä¸­çš„Bean refresh(); } æ‰€ä»¥æ•´ä¸ªSpringå®¹å™¨çš„å¯åŠ¨æµç¨‹å¯ä»¥ç»˜åˆ¶æˆå¦‚ä¸‹æµç¨‹å›¾ï¼š æ¥ç€æˆ‘ä»¬ä¸»è¦ä»è¿™ä¸‰ä¸ªå…¥å£è¯¦ç»†åˆ†æä¸€ä¸‹Springçš„å¯åŠ¨æµç¨‹ï¼š ä¸€ã€åˆå§‹åŒ–æµç¨‹ï¼š 1ã€springå®¹å™¨çš„åˆå§‹åŒ–æ—¶ï¼Œé€šè¿‡this()è°ƒç”¨äº†æ— å‚æ„é€ å‡½æ•°ï¼Œä¸»è¦åšäº†ä»¥ä¸‹ä¸‰ä¸ªäº‹æƒ…ï¼š ï¼ˆ1ï¼‰å®ä¾‹åŒ–BeanFactoryã€DefaultListableBeanFactoryã€‘å·¥å‚ï¼Œç”¨äºç”ŸæˆBeanå¯¹è±¡ ï¼ˆ2ï¼‰å®ä¾‹åŒ–BeanDefinitionReaderæ³¨è§£é…ç½®è¯»å–å™¨ï¼Œç”¨äºå¯¹ç‰¹å®šæ³¨è§£ï¼ˆå¦‚@Serviceã€@Repositoryï¼‰çš„ç±»è¿›è¡Œè¯»å–è½¬åŒ–æˆ BeanDefinition å¯¹è±¡ï¼Œï¼ˆBeanDefinition æ˜¯ Spring ä¸­æå…¶é‡è¦çš„ä¸€ä¸ªæ¦‚å¿µï¼Œå®ƒå­˜å‚¨äº† bean å¯¹è±¡çš„æ‰€æœ‰ç‰¹å¾ä¿¡æ¯ï¼Œå¦‚æ˜¯å¦å•ä¾‹ï¼Œæ˜¯å¦æ‡’åŠ è½½ï¼ŒfactoryBeanName ç­‰ï¼‰ ï¼ˆ3ï¼‰å®ä¾‹åŒ–ClassPathBeanDefinitionScannerè·¯å¾„æ‰«æå™¨ï¼Œç”¨äºå¯¹æŒ‡å®šçš„åŒ…ç›®å½•è¿›è¡Œæ‰«ææŸ¥æ‰¾ bean å¯¹è±¡ 2ã€æ ¸å¿ƒä»£ç å‰–æï¼š ï¼ˆ1ï¼‰å‘å®¹å™¨æ·»åŠ å†…ç½®ç»„ä»¶ï¼šorg.springframework.context.annotation.AnnotationConfigUtils#registerAnnotationConfigProcessorsï¼š æ ¹æ®ä¸Šå›¾åˆ†æï¼Œä»£ç è¿è¡Œåˆ°è¿™é‡Œæ—¶å€™ï¼ŒSpring å®¹å™¨å·²ç»æ„é€ å®Œæ¯•ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä¸ºå®¹å™¨æ·»åŠ ä¸€äº›å†…ç½®ç»„ä»¶äº†ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„ç»„ä»¶ä¾¿æ˜¯ ConfigurationClassPostProcessor å’Œ AutowiredAnnotationBeanPostProcessor ï¼Œå‰è€…æ˜¯ä¸€ä¸ª beanFactory åç½®å¤„ç†å™¨ï¼Œç”¨æ¥å®Œæˆ bean çš„æ‰«æä¸æ³¨å…¥å·¥ä½œï¼Œåè€…æ˜¯ä¸€ä¸ª bean åç½®å¤„ç†å™¨ï¼Œç”¨æ¥å®Œæˆ @AutoWired è‡ªåŠ¨æ³¨å…¥ã€‚ äºŒã€æ³¨å†ŒSpringConfigé…ç½®ç±»åˆ°å®¹å™¨ä¸­ï¼š 1ã€å°†SpringConfigæ³¨å†Œåˆ°å®¹å™¨ä¸­ï¼šorg.springframework.context.annotation.AnnotatedBeanDefinitionReader#doRegisterBeanï¼š è¿™ä¸ªæ­¥éª¤ä¸»è¦æ˜¯ç”¨æ¥è§£æç”¨æˆ·ä¼ å…¥çš„ Spring é…ç½®ç±»ï¼Œè§£ææˆä¸€ä¸ª BeanDefinition ç„¶åæ³¨å†Œåˆ°å®¹å™¨ä¸­ï¼Œä¸»è¦æºç å¦‚ä¸‹ï¼š &lt;T&gt; void doRegisterBean(Class&lt;T&gt; annotatedClass, @Nullable Supplier&lt;T&gt; instanceSupplier, @Nullable String name, @Nullable Class&lt;? extends Annotation&gt;[] qualifiers, BeanDefinitionCustomizer... definitionCustomizers) { // è§£æä¼ å…¥çš„é…ç½®ç±»ï¼Œå®é™…ä¸Šè¿™ä¸ªæ–¹æ³•æ—¢å¯ä»¥è§£æé…ç½®ç±»ï¼Œä¹Ÿå¯ä»¥è§£æ Spring bean å¯¹è±¡ AnnotatedGenericBeanDefinition abd = new AnnotatedGenericBeanDefinition(annotatedClass); // åˆ¤æ–­æ˜¯å¦éœ€è¦è·³è¿‡ï¼Œåˆ¤æ–­ä¾æ®æ˜¯æ­¤ç±»ä¸Šæœ‰æ²¡æœ‰ @Conditional æ³¨è§£ if (this.conditionEvaluator.shouldSkip(abd.getMetadata())) { return; } abd.setInstanceSupplier(instanceSupplier); ScopeMetadata scopeMetadata = this.scopeMetadataResolver.resolveScopeMetadata(abd); abd.setScope(scopeMetadata.getScopeName()); String beanName = (name != null ? name : this.beanNameGenerator.generateBeanName(abd, this.registry)); // å¤„ç†ç±»ä¸Šçš„é€šç”¨æ³¨è§£ AnnotationConfigUtils.processCommonDefinitionAnnotations(abd); if (qualifiers != null) { for (Class&lt;? extends Annotation&gt; qualifier : qualifiers) { if (Primary.class == qualifier) { abd.setPrimary(true); } else if (Lazy.class == qualifier) { abd.setLazyInit(true); } else { abd.addQualifier(new AutowireCandidateQualifier(qualifier)); } } } // å°è£…æˆä¸€ä¸ª BeanDefinitionHolder for (BeanDefinitionCustomizer customizer : definitionCustomizers) { customizer.customize(abd); } BeanDefinitionHolder definitionHolder = new BeanDefinitionHolder(abd, beanName); // å¤„ç† scopedProxyMode definitionHolder = AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, this.registry); // æŠŠ BeanDefinitionHolder æ³¨å†Œåˆ° registry BeanDefinitionReaderUtils.registerBeanDefinition(definitionHolder, this.registry); } ä¸‰ã€refresh()å®¹å™¨åˆ·æ–°æµç¨‹ï¼š refresh()ä¸»è¦ç”¨äºå®¹å™¨çš„åˆ·æ–°ï¼ŒSpring ä¸­çš„æ¯ä¸€ä¸ªå®¹å™¨éƒ½ä¼šè°ƒç”¨ refresh() æ–¹æ³•è¿›è¡Œåˆ·æ–°ï¼Œæ— è®ºæ˜¯ Spring çš„çˆ¶å­å®¹å™¨ï¼Œè¿˜æ˜¯ Spring Cloud Feign ä¸­çš„ feign éš”ç¦»å®¹å™¨ï¼Œæ¯ä¸€ä¸ªå®¹å™¨éƒ½ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•å®Œæˆåˆå§‹åŒ–ã€‚refresh()å¯åˆ’åˆ†ä¸º12ä¸ªæ­¥éª¤ï¼Œå…¶ä¸­æ¯”è¾ƒé‡è¦çš„æ­¥éª¤ä¸‹é¢ä¼šæœ‰è¯¦ç»†è¯´æ˜ã€‚ 1ã€refresh()æ–¹æ³•çš„æºç ï¼šorg.springframework.context.support.AbstractApplicationContext#refreshï¼š public void refresh() throws BeansException, IllegalStateException { synchronized (this.startupShutdownMonitor) { // 1. åˆ·æ–°å‰çš„é¢„å¤„ç† prepareRefresh(); // 2. è·å– beanFactoryï¼Œå³å‰é¢åˆ›å»ºçš„ã€DefaultListableBeanFactoryã€‘ ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory(); // 3. é¢„å¤„ç† beanFactoryï¼Œå‘å®¹å™¨ä¸­æ·»åŠ ä¸€äº›ç»„ä»¶ prepareBeanFactory(beanFactory); try { // 4. å­ç±»é€šè¿‡é‡å†™è¿™ä¸ªæ–¹æ³•å¯ä»¥åœ¨ BeanFactory åˆ›å»ºå¹¶ä¸å‡†å¤‡å®Œæˆä»¥ååšè¿›ä¸€æ­¥çš„è®¾ç½® postProcessBeanFactory(beanFactory); // 5. æ‰§è¡Œ BeanFactoryPostProcessor æ–¹æ³•ï¼ŒbeanFactory åç½®å¤„ç†å™¨ invokeBeanFactoryPostProcessors(beanFactory); // 6. æ³¨å†Œ BeanPostProcessorsï¼Œbean åç½®å¤„ç†å™¨ registerBeanPostProcessors(beanFactory); // 7. åˆå§‹åŒ– MessageSource ç»„ä»¶ï¼ˆåšå›½é™…åŒ–åŠŸèƒ½ï¼›æ¶ˆæ¯ç»‘å®šï¼Œæ¶ˆæ¯è§£æï¼‰ initMessageSource(); // 8. åˆå§‹åŒ–äº‹ä»¶æ´¾å‘å™¨ï¼Œåœ¨æ³¨å†Œç›‘å¬å™¨æ—¶ä¼šç”¨åˆ° initApplicationEventMulticaster(); // 9. ç•™ç»™å­å®¹å™¨ï¼ˆå­ç±»ï¼‰ï¼Œå­ç±»é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œåœ¨å®¹å™¨åˆ·æ–°çš„æ—¶å€™å¯ä»¥è‡ªå®šä¹‰é€»è¾‘ï¼Œweb åœºæ™¯ä¸‹ä¼šä½¿ç”¨ onRefresh(); // 10. æ³¨å†Œç›‘å¬å™¨ï¼Œæ´¾å‘ä¹‹å‰æ­¥éª¤äº§ç”Ÿçš„ä¸€äº›äº‹ä»¶ï¼ˆå¯èƒ½æ²¡æœ‰ï¼‰ registerListeners(); // 11. åˆå§‹åŒ–æ‰€æœ‰çš„éå•å®ä¾‹ bean finishBeanFactoryInitialization(beanFactory); // 12. å‘å¸ƒå®¹å™¨åˆ·æ–°å®Œæˆäº‹ä»¶ finishRefresh(); } ... } } æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹refresh()æ–¹æ³•æ¯ä¸€æ­¥ä¸»è¦çš„åŠŸèƒ½ 1,prepareRefresh()åˆ·æ–°å‰çš„é¢„å¤„ç†ï¼š ï¼ˆ1ï¼‰initPropertySources()ï¼šåˆå§‹åŒ–ä¸€äº›å±æ€§è®¾ç½®ï¼Œå­ç±»è‡ªå®šä¹‰ä¸ªæ€§åŒ–çš„å±æ€§è®¾ç½®æ–¹æ³•ï¼› ï¼ˆ2ï¼‰getEnvironment().validateRequiredProperties()ï¼šæ£€éªŒå±æ€§çš„åˆæ³•æ€§ ï¼ˆ3ï¼‰earlyApplicationEvents = new LinkedHashSet()ï¼šä¿å­˜å®¹å™¨ä¸­çš„ä¸€äº›æ—©æœŸçš„äº‹ä»¶ï¼› 2,obtainFreshBeanFactory()ï¼šè·å–åœ¨å®¹å™¨åˆå§‹åŒ–æ—¶åˆ›å»ºçš„BeanFactoryï¼š ï¼ˆ1ï¼‰refreshBeanFactory()ï¼šåˆ·æ–°BeanFactoryï¼Œè®¾ç½®åºåˆ—åŒ–IDï¼› ï¼ˆ2ï¼‰getBeanFactory()ï¼šè¿”å›åˆå§‹åŒ–ä¸­çš„GenericApplicationContextåˆ›å»ºçš„BeanFactoryå¯¹è±¡ï¼Œå³ã€DefaultListableBeanFactoryã€‘ç±»å‹ 3,prepareBeanFactory(beanFactory)ï¼šBeanFactoryçš„é¢„å¤„ç†å·¥ä½œï¼Œå‘å®¹å™¨ä¸­æ·»åŠ ä¸€äº›ç»„ä»¶ï¼š ï¼ˆ1ï¼‰è®¾ç½®BeanFactoryçš„ç±»åŠ è½½å™¨ã€è®¾ç½®è¡¨è¾¾å¼è§£æå™¨ç­‰ç­‰ ï¼ˆ2ï¼‰æ·»åŠ BeanPostProcessorã€ApplicationContextAwareProcessorã€‘ ï¼ˆ3ï¼‰è®¾ç½®å¿½ç•¥è‡ªåŠ¨è£…é…çš„æ¥å£ï¼šEnvironmentAwareã€EmbeddedValueResolverAwareã€ResourceLoaderAwareã€ApplicationEventPublisherAwareã€MessageSourceAwareã€ApplicationContextAwareï¼› ï¼ˆ4ï¼‰æ³¨å†Œå¯ä»¥è§£æçš„è‡ªåŠ¨è£…é…ç±»ï¼Œå³å¯ä»¥åœ¨ä»»æ„ç»„ä»¶ä¸­é€šè¿‡æ³¨è§£è‡ªåŠ¨æ³¨å…¥ï¼šBeanFactoryã€ResourceLoaderã€ApplicationEventPublisherã€ApplicationContext ï¼ˆ5ï¼‰æ·»åŠ BeanPostProcessorã€ApplicationListenerDetectorã€‘ ï¼ˆ6ï¼‰æ·»åŠ ç¼–è¯‘æ—¶çš„AspectJï¼› ï¼ˆ7ï¼‰ç»™BeanFactoryä¸­æ³¨å†Œçš„3ä¸ªç»„ä»¶ï¼šenvironmentã€ConfigurableEnvironmentã€‘ã€systemPropertiesã€Map&lt;String, Object&gt;ã€‘ã€systemEnvironmentã€Map&lt;String, Object&gt;ã€‘ 4,postProcessBeanFactory(beanFactory)ï¼šå­ç±»é‡å†™è¯¥æ–¹æ³•ï¼Œå¯ä»¥å®ç°åœ¨BeanFactoryåˆ›å»ºå¹¶é¢„å¤„ç†å®Œæˆä»¥ååšè¿›ä¸€æ­¥çš„è®¾ç½® 5,invokeBeanFactoryPostProcessors(beanFactory)ï¼šåœ¨BeanFactoryæ ‡å‡†åˆå§‹åŒ–ä¹‹åæ‰§è¡ŒBeanFactoryPostProcessorçš„æ–¹æ³•ï¼Œå³BeanFactoryçš„åç½®å¤„ç†å™¨ï¼š ï¼ˆ1ï¼‰å…ˆæ‰§è¡ŒBeanDefinitionRegistryPostProcessorï¼š postProcessor.postProcessBeanDefinitionRegistry(registry) â‘  è·å–æ‰€æœ‰çš„å®ç°äº†BeanDefinitionRegistryPostProcessoræ¥å£ç±»å‹çš„é›†åˆ â‘¡ å…ˆæ‰§è¡Œå®ç°äº†PriorityOrderedä¼˜å…ˆçº§æ¥å£çš„BeanDefinitionRegistryPostProcessor â‘¢ å†æ‰§è¡Œå®ç°äº†Orderedé¡ºåºæ¥å£çš„BeanDefinitionRegistryPostProcessor â‘£ æœ€åæ‰§è¡Œæ²¡æœ‰å®ç°ä»»ä½•ä¼˜å…ˆçº§æˆ–è€…æ˜¯é¡ºåºæ¥å£çš„BeanDefinitionRegistryPostProcessors ï¼ˆ2ï¼‰å†æ‰§è¡ŒBeanFactoryPostProcessorçš„æ–¹æ³•ï¼špostProcessor.postProcessBeanFactory(beanFactory) â‘  è·å–æ‰€æœ‰çš„å®ç°äº†BeanFactoryPostProcessoræ¥å£ç±»å‹çš„é›†åˆ â‘¡ å…ˆæ‰§è¡Œå®ç°äº†PriorityOrderedä¼˜å…ˆçº§æ¥å£çš„BeanFactoryPostProcessor â‘¢ å†æ‰§è¡Œå®ç°äº†Orderedé¡ºåºæ¥å£çš„BeanFactoryPostProcessor â‘£ æœ€åæ‰§è¡Œæ²¡æœ‰å®ç°ä»»ä½•ä¼˜å…ˆçº§æˆ–è€…æ˜¯é¡ºåºæ¥å£çš„BeanFactoryPostProcessor 6,registerBeanPostProcessors(beanFactory)ï¼šå‘å®¹å™¨ä¸­æ³¨å†ŒBeançš„åç½®å¤„ç†å™¨BeanPostProcessorï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯å¹²é¢„Springåˆå§‹åŒ–beançš„æµç¨‹ï¼Œä»è€Œå®Œæˆä»£ç†ã€è‡ªåŠ¨æ³¨å…¥ã€å¾ªç¯ä¾èµ–ç­‰åŠŸèƒ½ ï¼ˆ1ï¼‰è·å–æ‰€æœ‰å®ç°äº†BeanPostProcessoræ¥å£ç±»å‹çš„é›†åˆï¼š ï¼ˆ2ï¼‰å…ˆæ³¨å†Œå®ç°äº†PriorityOrderedä¼˜å…ˆçº§æ¥å£çš„BeanPostProcessorï¼› ï¼ˆ3ï¼‰å†æ³¨å†Œå®ç°äº†Orderedä¼˜å…ˆçº§æ¥å£çš„BeanPostProcessorï¼› ï¼ˆ4ï¼‰æœ€åæ³¨å†Œæ²¡æœ‰å®ç°ä»»ä½•ä¼˜å…ˆçº§æ¥å£çš„BeanPostProcessorï¼› ï¼ˆ5ï¼‰æœ€rç»ˆæ³¨å†ŒMergedBeanDefinitionPostProcessorç±»å‹çš„BeanPostProcessorï¼šbeanFactory.addBeanPostProcessor(postProcessor); ï¼ˆ6ï¼‰ç»™å®¹å™¨æ³¨å†Œä¸€ä¸ªApplicationListenerDetectorï¼šç”¨äºåœ¨Beanåˆ›å»ºå®Œæˆåæ£€æŸ¥æ˜¯å¦æ˜¯ApplicationListenerï¼Œå¦‚æœæ˜¯ï¼Œå°±æŠŠBeanæ”¾åˆ°å®¹å™¨ä¸­ä¿å­˜èµ·æ¥ï¼šapplicationContext.addApplicationListener((ApplicationListener&lt;?&gt;) bean); æ­¤æ—¶å®¹å™¨ä¸­é»˜è®¤æœ‰6ä¸ªé»˜è®¤çš„BeanProcessor(æ— ä»»ä½•ä»£ç†æ¨¡å¼ä¸‹)ï¼šã€ApplicationContextAwareProcessorã€‘ã€ã€ConfigurationClassPostProcessorsAwareBeanPostProcessorã€‘ã€ã€PostProcessorRegistrationDelegateã€‘ã€ã€CommonAnnotationBeanPostProcessorã€‘ã€ã€AutowiredAnnotationBeanPostProcessorã€‘ã€ã€ApplicationListenerDetectorã€‘ 7,initMessageSource()ï¼šåˆå§‹åŒ–MessageSourceç»„ä»¶ï¼Œä¸»è¦ç”¨äºåšå›½é™…åŒ–åŠŸèƒ½ï¼Œæ¶ˆæ¯ç»‘å®šä¸æ¶ˆæ¯è§£æï¼š ï¼ˆ1ï¼‰çœ‹BeanFactoryå®¹å™¨ä¸­æ˜¯å¦æœ‰idä¸ºmessageSource å¹¶ä¸”ç±»å‹æ˜¯MessageSourceçš„ç»„ä»¶ï¼šå¦‚æœæœ‰ï¼Œç›´æ¥èµ‹å€¼ç»™messageSourceï¼›å¦‚æœæ²¡æœ‰ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªDelegatingMessageSourceï¼› ï¼ˆ2ï¼‰æŠŠåˆ›å»ºå¥½çš„MessageSourceæ³¨å†Œåœ¨å®¹å™¨ä¸­ï¼Œä»¥åè·å–å›½é™…åŒ–é…ç½®æ–‡ä»¶çš„å€¼çš„æ—¶å€™ï¼Œå¯ä»¥è‡ªåŠ¨æ³¨å…¥MessageSourceï¼› 8,initApplicationEventMulticaster()ï¼šåˆå§‹åŒ–äº‹ä»¶æ´¾å‘å™¨ï¼Œåœ¨æ³¨å†Œç›‘å¬å™¨æ—¶ä¼šç”¨åˆ°ï¼š ï¼ˆ1ï¼‰çœ‹BeanFactoryå®¹å™¨ä¸­æ˜¯å¦å­˜åœ¨è‡ªå®šä¹‰çš„ApplicationEventMulticasterï¼šå¦‚æœæœ‰ï¼Œç›´æ¥ä»å®¹å™¨ä¸­è·å–ï¼›å¦‚æœæ²¡æœ‰ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªSimpleApplicationEventMulticaster ï¼ˆ2ï¼‰å°†åˆ›å»ºçš„ApplicationEventMulticasteræ·»åŠ åˆ°BeanFactoryä¸­ï¼Œä»¥åå…¶ä»–ç»„ä»¶å°±å¯ä»¥ç›´æ¥è‡ªåŠ¨æ³¨å…¥ 9,onRefresh()ï¼šç•™ç»™å­å®¹å™¨ã€å­ç±»é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œåœ¨å®¹å™¨åˆ·æ–°çš„æ—¶å€™å¯ä»¥è‡ªå®šä¹‰é€»è¾‘ 10,registerListeners()ï¼šæ³¨å†Œç›‘å¬å™¨ï¼šå°†å®¹å™¨ä¸­æ‰€æœ‰çš„ApplicationListeneræ³¨å†Œåˆ°äº‹ä»¶æ´¾å‘å™¨ä¸­ï¼Œå¹¶æ´¾å‘ä¹‹å‰æ­¥éª¤äº§ç”Ÿçš„äº‹ä»¶ï¼š ï¼ˆ1ï¼‰ä»å®¹å™¨ä¸­æ‹¿åˆ°æ‰€æœ‰çš„ApplicationListener ï¼ˆ2ï¼‰å°†æ¯ä¸ªç›‘å¬å™¨æ·»åŠ åˆ°äº‹ä»¶æ´¾å‘å™¨ä¸­ï¼šgetApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName); ï¼ˆ3ï¼‰æ´¾å‘ä¹‹å‰æ­¥éª¤äº§ç”Ÿçš„äº‹ä»¶applicationEventsï¼šgetApplicationEventMulticaster().multicastEvent(earlyEvent); 11,finishBeanFactoryInitialization(beanFactory)ï¼šåˆå§‹åŒ–æ‰€æœ‰å‰©ä¸‹çš„éå•å®ä¾‹beanï¼Œæ ¸å¿ƒæ–¹æ³•æ˜¯preInstantiateSingletons()ï¼Œä¼šè°ƒç”¨getBean()æ–¹æ³•åˆ›å»ºå¯¹è±¡ï¼› ï¼ˆ1ï¼‰è·å–å®¹å™¨ä¸­çš„æ‰€æœ‰beanDefinitionNameï¼Œä¾æ¬¡è¿›è¡Œåˆå§‹åŒ–å’Œåˆ›å»ºå¯¹è±¡ ï¼ˆ2ï¼‰è·å–Beançš„å®šä¹‰ä¿¡æ¯RootBeanDefinitionï¼Œå®ƒè¡¨ç¤ºè‡ªå·±çš„BeanDefinitionå’Œå¯èƒ½å­˜åœ¨çˆ¶ç±»çš„BeanDefinitionåˆå¹¶åçš„å¯¹è±¡ ï¼ˆ3ï¼‰å¦‚æœBeanæ»¡è¶³è¿™ä¸‰ä¸ªæ¡ä»¶ï¼šéæŠ½è±¡çš„ï¼Œå•å®ä¾‹ï¼Œéæ‡’åŠ è½½ï¼Œåˆ™æ‰§è¡Œå•ä¾‹Beanåˆ›å»ºæµç¨‹ï¼š ï¼ˆ4ï¼‰æ‰€æœ‰Beanéƒ½åˆ©ç”¨getBean()åˆ›å»ºå®Œæˆä»¥åï¼Œæ£€æŸ¥æ‰€æœ‰çš„Beanæ˜¯å¦ä¸ºSmartInitializingSingletonæ¥å£çš„ï¼Œå¦‚æœæ˜¯ï¼›å°±æ‰§è¡ŒafterSingletonsInstantiated()ï¼› 12,finishRefresh()ï¼šå‘å¸ƒBeanFactoryå®¹å™¨åˆ·æ–°å®Œæˆäº‹ä»¶ï¼š ï¼ˆ1ï¼‰initLifecycleProcessor()ï¼šåˆå§‹åŒ–å’Œç”Ÿå‘½å‘¨æœŸæœ‰å…³çš„åç½®å¤„ç†å™¨ï¼šé»˜è®¤ä»å®¹å™¨ä¸­æ‰¾æ˜¯å¦æœ‰lifecycleProcessorçš„ç»„ä»¶ã€LifecycleProcessorã€‘ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªDefaultLifecycleProcessor()åŠ å…¥åˆ°å®¹å™¨ï¼› ï¼ˆ2ï¼‰getLifecycleProcessor().onRefresh()ï¼šæ‹¿åˆ°å‰é¢å®šä¹‰çš„ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨ï¼ˆLifecycleProcessorï¼‰å›è°ƒonRefresh()æ–¹æ³• ï¼ˆ3ï¼‰publishEvent(new ContextRefreshedEvent(this))ï¼šå‘å¸ƒå®¹å™¨åˆ·æ–°å®Œæˆäº‹ä»¶ï¼› ï¼ˆ4ï¼‰liveBeansView.registerApplicationContext(this); ","link":"https://tianxiawuhao.github.io/E_iSRsJL1/"},{"title":"gitlabä½¿ç”¨runnerå®ŒæˆCI","content":"gitlabå®‰è£… dockerä¸‹è½½é•œåƒ docker pull gitlab/gitlab-ce:latest gitlabå®¹å™¨éƒ¨ç½² docker run -d -p 8443:443 -p 80:80 -p 8022:22 --restart always --name gitlab -v C:\\installation\\gitlab\\config:/etc/gitlab -v C:\\installation\\gitlab\\logs:/var/log/gitlab -v C:\\installation\\gitlab\\data:/var/opt/gitlab ä¿®æ”¹é…ç½® vi /etc/gitlab/gitlab.rb ------------------------------------------------- # gitlabè®¿é—®åœ°å€ï¼Œå¯ä»¥å†™åŸŸåã€‚å¦‚æœç«¯å£ä¸å†™çš„è¯é»˜è®¤ä¸º80ç«¯å£ external_url 'http://gitlab.test' # sshä¸»æœºip gitlab_rails['gitlab_ssh_host'] = 'gitlab.test' # sshè¿æ¥ç«¯å£ gitlab_rails['gitlab_shell_ssh_port'] = 8022 # æ˜¯å¦å¯ç”¨ gitlab_rails['smtp_enable'] = true # SMTPæœåŠ¡çš„åœ°å€ gitlab_rails['smtp_address'] = &quot;smtp.qq.com&quot; # ç«¯å£ gitlab_rails['smtp_port'] = 465 # ä½ çš„QQé‚®ç®±ï¼ˆå‘é€è´¦å·ï¼‰ gitlab_rails['smtp_user_name'] = &quot;*******@qq.com&quot; # æˆæƒç  gitlab_rails['smtp_password'] = &quot;********&quot; # åŸŸå gitlab_rails['smtp_domain'] = &quot;smtp.qq.com&quot; # ç™»å½•éªŒè¯ gitlab_rails['smtp_authentication'] = &quot;login&quot; # ä½¿ç”¨äº†465ç«¯å£ï¼Œå°±éœ€è¦é…ç½®ä¸‹é¢ä¸‰é¡¹ gitlab_rails['smtp_enable_starttls_auto'] = true gitlab_rails['smtp_tls'] = true gitlab_rails['smtp_openssl_verify_mode'] = 'none' # ä½ çš„QQé‚®ç®±ï¼ˆå‘é€è´¦å·ï¼‰ gitlab_rails['gitlab_email_from'] = '********@qq.com' # ä¿®æ”¹httpå’Œsshé…ç½® vi /opt/gitlab/embedded/service/gitlab-rails/config/gitlab.yml -------------------------------------------------------------- gitlab: host: gitlab.test port: 80 https: false #ä¿®æ”¹hosts c:\\windows\\system32\\drivers\\etc 127.0.0.1 gitlab.test gitlab-runnerå®‰è£… urlå’Œtokené€šè¿‡gitlabçš„CI/CDèœå•é¡¹æŸ¥çœ‹ docker exec -it gitlab-runner gitlab-runner register -n --url http://172.17.0.2/ --registration-token GR1348941smuNaFuN-Cf68ne2X-tP --executor docker --description &quot;Docker Runner&quot; --docker-image=maven:latest --tag-list=&quot;dev-release&quot; æ³¨å†Œrunner docker exec -it gitlab-runner gitlab-runner register -n --url http://172.17.0.2/ --registration-token GR1348941smuNaFuN-Cf68ne2X-tP --executor docker --description &quot;Docker Runner&quot; --docker-image=maven:latest --tag-list=&quot;allen-devolop-tag&quot; é¡¹ç›®æ·»åŠ .gitlab-ci.ymlæ–‡ä»¶ # runnerä½¿ç”¨dokeræ—¶æŒ‡å®šé•œåƒ image: maven:3.6.3-jdk-8 # å®šä¹‰ç¼“å­˜ # å¦‚æœgitlab runneræ˜¯shellæˆ–è€…dockerï¼Œæ­¤ç¼“å­˜åŠŸèƒ½æ²¡æœ‰é—®é¢˜ # å¦‚æœæ˜¯k8sç¯å¢ƒï¼Œè¦ç¡®ä¿å·²ç»è®¾ç½®äº†åˆ†å¸ƒå¼æ–‡ä»¶æœåŠ¡ä½œä¸ºç¼“å­˜ cache: key: minio paths: - .m2/repository/ - minio/target/*.jar # æœ¬æ¬¡æ„å»ºçš„é˜¶æ®µï¼šbuild package stages: - package - build # ç”Ÿäº§jarçš„job make_jar: tags: - dev-release only: - dev-release image: maven:3.6.3-jdk-8 stage: package script: - echo &quot;=============== å¼€å§‹ç¼–è¯‘æºç ï¼Œåœ¨targetç›®å½•ç”Ÿæˆjaræ–‡ä»¶ ===============&quot; - mvn clean &amp;&amp; mvn package -Dmaven.test.skip=true - echo &quot;targetæ–‡ä»¶å¤¹&quot; `ls minio/target/` # ç”Ÿäº§é•œåƒçš„job make_image: tags: - dev-release only: - dev-release image: docker:latest stage: build script: - VERSION=`date +%Y%m%d%H%M` - echo &quot;VERSION=$VERSION&quot; &gt; .version - echo $VERSION - echo &quot;ä»ç¼“å­˜ä¸­æ¢å¤çš„targetæ–‡ä»¶å¤¹&quot; `ls minio/target/` - echo &quot;=============== ç™»å½•Harbor ===============&quot; - cd minio - docker login -u user -p password https://harbor.com - echo &quot;=============== æ‰“åŒ…Dockeré•œåƒ ï¼š &quot; harbor.com/test/minio-connect:$VERSION &quot;===============&quot; - docker build -t harbor.com/test/minio-connect:$VERSION . - echo &quot;=============== æ¨é€åˆ°é•œåƒä»“åº“ ===============&quot; - docker push harbor.com/test/minio-connect:$VERSION - echo &quot;=============== ç™»å‡º ===============&quot; - docker logout - echo &quot;æ¸…ç†æ‰æœ¬æ¬¡æ„å»ºçš„jaræ–‡ä»¶&quot; - rm -rf target/*.jar ","link":"https://tianxiawuhao.github.io/0SH2PgZRJ/"},{"title":"springbootå¯åŠ¨æµç¨‹","content":"SpringBoot å¯åŠ¨æµç¨‹ new SpringApplicationé˜¶æ®µ ä¸€èˆ¬çš„springbootçš„å¯åŠ¨ç±»é•¿è¿™ä¸ªæ ·å­ã€‚ @SpringBootApplication public class SampleApplication { public static void main(String[] args) { SpringApplication.run(SampleApplication.class, args); } } å¯ä»¥çœ‹åˆ°è¿™ä¸ªmainæ–¹æ³•é‡Œé¢åªæœ‰ç®€å•çš„ä¸€è¡Œcodeï¼Œè¿™ä¸€è¡Œå°±æ˜¯ç†è§£springbootå¯åŠ¨è¿‡ç¨‹çš„å…¥å£äº†ã€‚ç‚¹è¿›å»çœ‹ä¸€çœ‹å®ƒåšäº†ä»€ä¹ˆäº‹æƒ…ï¼Œå¤§è‡´ä¸Šå¯ä»¥è®¤ä¸ºåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œé¦–å…ˆæ˜¯newäº†ä¸€ä¸ªSpringApplicationå¯¹è±¡ï¼Œç„¶åè°ƒç”¨äº†å®ƒçš„runæ–¹æ³•ã€‚ /** * Static helper that can be used to run a {@link SpringApplication} from the * specified source using default settings. * @param primarySource the primary source to load * @param args the application arguments (usually passed from a Java main method) * @return the running {@link ApplicationContext} */ public static ConfigurableApplicationContext run(Class&lt;?&gt; primarySource, String... args) { return run(new Class&lt;?&gt;[] { primarySource }, args); } /** * Static helper that can be used to run a {@link SpringApplication} from the * specified sources using default settings and user supplied arguments. * @param primarySources the primary sources to load * @param args the application arguments (usually passed from a Java main method) * @return the running {@link ApplicationContext} */ public static ConfigurableApplicationContext run(Class&lt;?&gt;[] primarySources, String[] args) { return new SpringApplication(primarySources).run(args); } new SpringApplication é˜¶æ®µåšäº†å“ªäº›äº‹æƒ… ç»“åˆcodeæˆ‘ä»¬çœ‹ä¸€ä¸‹åœ¨new SpringApplicationæ—¶ï¼ŒSpringBootæ¡†æ¶åšäº†å“ªäº›äº‹æƒ… public SpringApplication(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources) { this.resourceLoader = resourceLoader; Assert.notNull(primarySources, &quot;PrimarySources must not be null&quot;); //è®¾ç½®primarySources this.primarySources = new LinkedHashSet&lt;&gt;(Arrays.asList(primarySources)); //ç¡®å®šapplicationç±»å‹ this.webApplicationType = WebApplicationType.deduceFromClasspath(); //è¯»å–é…ç½®åœ¨spring.factoriesæ–‡ä»¶ä¸­çš„ApplicationContextInitializerï¼Œéœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢ï¼Œspringbootä¼šå¼€å§‹è¯»å–spring.factoriesé‡Œé¢çš„é…ç½®å¹¶ä¸”æ ¹æ®ClassLoaderçš„ä¸åŒï¼Œç¼“å­˜åˆ°å†…å­˜ä¸­ã€‚è¿™ä¸ªä¹‹åå†å±•å¼€è®²ã€‚ setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class)); //è¯»å–é…ç½®åœ¨spring.factoriesæ–‡ä»¶ä¸­çš„ApplicationListenerã€‚ setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class)); //ç¡®å®šå…¥å£ç±» this.mainApplicationClass = deduceMainApplicationClass(); } ç¡®å®šåº”ç”¨ç¨‹åºç±»å‹(servlet) é¦–å…ˆå°±æ˜¯ç¡®å®šä¸€ä¸‹æˆ‘ä»¬è¿™ä¸ªé¡¹ç›®çš„ç±»å‹ åˆ¤æ–­æ–¹æ³•æ¯”è¾ƒç®€å•ç²—æš´ï¼Œå°±æ˜¯çœ‹ä¸€ä¸‹ä½ é¡¹ç›®ä¸­æœ‰æ²¡æœ‰å¯¹åº”ç±»å‹çš„æ ‡å¿—æ€§çš„ç±»ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ æœ‰WEBFLUX_INDICATOR_CLASSè¿™ä¸ªç±»çš„è¯ï¼Œå°±è®¤ä¸ºä½ çš„é¡¹ç›®ç±»å‹æ˜¯REACTIVEã€‚ private static final String WEBMVC_INDICATOR_CLASS = &quot;org.springframework.web.servlet.DispatcherServlet&quot;; private static final String WEBFLUX_INDICATOR_CLASS = &quot;org.springframework.web.reactive.DispatcherHandler&quot;; private static final String JERSEY_INDICATOR_CLASS = &quot;org.glassfish.jersey.servlet.ServletContainer&quot;; private static final String SERVLET_APPLICATION_CONTEXT_CLASS = &quot;org.springframework.web.context.WebApplicationContext&quot;; private static final String REACTIVE_APPLICATION_CONTEXT_CLASS = &quot;org.springframework.boot.web.reactive.context.ReactiveWebApplicationContext&quot;; static WebApplicationType deduceFromClasspath() { if (ClassUtils.isPresent(WEBFLUX_INDICATOR_CLASS, null) &amp;&amp; !ClassUtils.isPresent(WEBMVC_INDICATOR_CLASS, null) &amp;&amp; !ClassUtils.isPresent(JERSEY_INDICATOR_CLASS, null)) { return WebApplicationType.REACTIVE; } for (String className : SERVLET_INDICATOR_CLASSES) { if (!ClassUtils.isPresent(className, null)) { return WebApplicationType.NONE; } } return WebApplicationType.SERVLET; } spiåŠ è½½spring.factories ç„¶åå°±æ˜¯é€šè¿‡SPIæœºåˆ¶è·å–spring.factoriesçš„é…ç½® åœ¨æ„é€ å™¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°æœ‰ä¸¤æ¬¡å¯¹äºgetSpringFactoriesInstancesæ–¹æ³•çš„è°ƒç”¨ï¼Œè¿™ä¸ªæ–¹æ³•å…œå…œè½¬è½¬ï¼Œæœ€åä¼šè°ƒç”¨åˆ°SpringFactoriesLoaderçš„loadSpringFactoriesçš„æ–¹æ³•ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œå¯¹äºç›¸åŒçš„classsloaderï¼Œåªä¼šå°è¯•loadä¸€æ¬¡spring.factoriesæ–‡ä»¶ä¸­çš„é…ç½®ã€‚ private static Map&lt;String, List&lt;String&gt;&gt; loadSpringFactories(@Nullable ClassLoader classLoader) { MultiValueMap&lt;String, String&gt; result = cache.get(classLoader); if (result != null) { return result; } try { Enumeration&lt;URL&gt; urls = (classLoader != null ? classLoader.getResources(FACTORIES_RESOURCE_LOCATION) : ClassLoader.getSystemResources(FACTORIES_RESOURCE_LOCATION)); result = new LinkedMultiValueMap&lt;&gt;(); while (urls.hasMoreElements()) { URL url = urls.nextElement(); UrlResource resource = new UrlResource(url); Properties properties = PropertiesLoaderUtils.loadProperties(resource); for (Map.Entry&lt;?, ?&gt; entry : properties.entrySet()) { String factoryTypeName = ((String) entry.getKey()).trim(); for (String factoryImplementationName : StringUtils.commaDelimitedListToStringArray((String) entry.getValue())) { result.add(factoryTypeName, factoryImplementationName.trim()); } } } cache.put(classLoader, result); return result; } catch (IOException ex) { throw new IllegalArgumentException(&quot;Unable to load factories from location [&quot; + FACTORIES_RESOURCE_LOCATION + &quot;]&quot;, ex); } } åŠ è½½ApplicationContextInitializer(åˆå§‹åŒ–å™¨)å’ŒApplicationListener(ç›‘å¬å™¨) ä»loadå¥½çš„spring.factorieä¸­è·å–é…ç½®å¥½çš„ApplicationContextInitializerå’ŒApplicationListener è¿™ä¸ªå°±æ²¡å•¥å¥½è¯´äº†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™äº›ApplicationListeneræ˜¯åœ¨è°ƒç”¨runæ–¹æ³•ä¹‹å‰å°±å·²ç»åŠ è½½è¿›æ¥çš„ï¼Œæ‰€ä»¥è¿™äº›ApplicationListenerä¸ä»…ä»…èƒ½å¤Ÿæ¥æ”¶ApplicationStartedEventä»¥åŠä¹‹åçš„ApplicationEventï¼Œä¹‹å‰çš„æ¯”å¦‚ApplicationStartingEventã€ApplicationEnvironmentPreparedEventç­‰ç­‰äº‹ä»¶ç±»å‹ä¹Ÿéƒ½å¯ä»¥æ¥æ”¶åˆ°ã€‚ ç¡®å®šä¸»ç±» è¿™ä¸ªçš„é€»è¾‘ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆè·å–å½“å‰çš„æ–¹æ³•è°ƒç”¨æ ˆï¼ˆè¿™ç‚¹è¿˜æ˜¯æœ‰ç–‘é—®ä¸ºå•¥ä¸é€šè¿‡Thread.currentThread().getStackTrace()è¿™ç§çœ‹èµ·æ¥æ›´åŠ æ­£å¼çš„æ–¹æ³•æ¥è·å–stackTraceï¼‰ã€‚ç„¶åä»æ ˆé¡¶ä¸€ä¸ªä¸€ä¸ªæ‰¾ä¸‹å»ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªåå­—ä¸ºmainçš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ‰€å¯¹åº”çš„ç±»å°±å¯ä»¥è®¤ä¸ºæ˜¯ä¸»ç±»äº†ã€‚ private Class&lt;?&gt; deduceMainApplicationClass() { try { StackTraceElement[] stackTrace = new RuntimeException().getStackTrace(); for (StackTraceElement stackTraceElement : stackTrace) { if (&quot;main&quot;.equals(stackTraceElement.getMethodName())) { return Class.forName(stackTraceElement.getClassName()); } } } catch (ClassNotFoundException ex) { // Swallow and continue } return null; } ä¸ºäº†éªŒè¯æˆ‘ä¹Ÿå†™ä¸ªäº†sample public class Test { public static void main(String[] args) { SampleApplication.main(args); } } @SpringBootApplication public class SampleApplication { public static void main(String[] args) { SpringApplication.run(SampleApplication.class, args); } } å‘ç°è°ƒç”¨Test.mainæ–¹æ³•ä¹‹åï¼Œå®šä½å‡ºæ¥çš„mainclassç¡®å®æ˜¯SampleApplicationã€‚ run()æ–¹æ³• run()æ–¹æ³•åšäº†å“ªäº›äº‹æƒ… è¿˜æ˜¯å…ˆçœ‹è¿™äº›ç¨å¾®åŠ äº†ç‚¹æ³¨é‡Šçš„æºç  public ConfigurableApplicationContext run(String... args) { //èµ·äº†ä¸ªtimerï¼Œç”¨äºè®¡æ—¶ï¼Œä¸ç”¨ç®¡ StopWatch stopWatch = new StopWatch(); stopWatch.start(); ConfigurableApplicationContext context = null; Collection&lt;SpringBootExceptionReporter&gt; exceptionReporters = new ArrayList&lt;&gt;(); //è¿™ä¸ªå°±æ˜¯é…ç½®ä¸ªç³»ç»Ÿç¯å¢ƒå˜é‡ java.awt.headless configureHeadlessProperty(); //è·å–SpringApplicationRunListenersï¼Œè¿™ä¸ªå’Œä¹‹å‰æåˆ°çš„ApplicationListeneræ˜¯ä¸¤ä¸ªä¸åŒçš„æ¥å£ã€‚ä¸¤è€…é—´çš„è”ç³»åœ¨äºï¼Œ //åœ¨springbootçš„é»˜è®¤å®ç°ä¸­ï¼Œæœ‰ä¸€ä¸ªç‰¹æ®Šçš„ç±»EventPublishingRunListenerä¼šç»§æ‰¿SpringApplicationRunListenersï¼Œ //ä»–ä¼šåœ¨springbootçš„ç‰¹æ®Šé˜¶æ®µå‘å¸ƒå¯¹åº”çš„ApplicationEventï¼Œå¹¶ä¸”è¢«ApplicationListeneræ¥æ”¶ã€‚ SpringApplicationRunListeners listeners = getRunListeners(args); //è¿›å…¥startingé˜¶æ®µï¼Œå‘å¸ƒApplicationStartingEventäº‹ä»¶ã€‚ listeners.starting(); try { //åŒ…è£…å¯åŠ¨å‚æ•° ApplicationArguments applicationArguments = new DefaultApplicationArguments(args); //å‡†å¤‡environmentï¼Œç¡®å®špropertiesSourceã€‚å‘å¸ƒApplicationEnvironmentPreparedEventã€‚ ConfigurableEnvironment environment = prepareEnvironment(listeners, applicationArguments); //é…ç½®ç¯å¢ƒå˜é‡spring.beaninfo.ignore configureIgnoreBeanInfo(environment); Banner printedBanner = printBanner(environment); //åˆ›å»ºåº”ç”¨ä¸Šä¸‹æ–‡ context = createApplicationContext(); //è·å–SpringBootExceptionReporter exceptionReporters = getSpringFactoriesInstances(SpringBootExceptionReporter.class, new Class[] { ConfigurableApplicationContext.class }, context); //å‘å¸ƒApplicationContextInitializedEventäº‹ä»¶å’ŒApplicationPreparedEventäº‹ä»¶ prepareContext(context, environment, listeners, applicationArguments, printedBanner); /åˆ’é‡ç‚¹ï¼Œè¿›è¡Œbeançš„åˆå§‹åŒ–å·¥ä½œ refreshContext(context); //æš‚æ—¶æ˜¯ä¸ªç©ºfunctionã€‚ afterRefresh(context, applicationArguments); //å…³é—­è®¡ç®—å™¨ï¼Œä¹Ÿå°±æ˜¯å‰é¢åˆ›å»ºçš„é‚£ä¸ªtimer stopWatch.stop(); if (this.logStartupInfo) { new StartupInfoLogger(this.mainApplicationClass).logStarted(getApplicationLog(), stopWatch); } //å‘å¸ƒApplicationStartedEventäº‹ä»¶ listeners.started(context); //è¿è¡ŒApplicationRunnerå’ŒCommandLineRunner callRunners(context, applicationArguments); } catch (Throwable ex) { handleRunFailure(context, ex, exceptionReporters, listeners); throw new IllegalStateException(ex); } try { //å‘å¸ƒApplicationReadyEventäº‹ä»¶ listeners.running(context); } catch (Throwable ex) { handleRunFailure(context, ex, exceptionReporters, null); throw new IllegalStateException(ex); } return context; } å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒå¤æ‚ï¼ŒåŸºæœ¬ä¸Šæ¯ä¸€è¡Œè¯­å¥éƒ½å¯¹åº”ç€ä¸€ä¸ªå‡½æ•°ã€‚ä¸ºäº†æ›´åŠ æ–¹ä¾¿åœ°æ‹æ¸…æ¥šæ•´ä¸ªflowï¼Œæˆ‘ä»¬è·Ÿç€SpringApplicationRunListenerï¼Œçœ‹ä¸€ä¸‹å®ƒçš„æ¯ä¸ªæ–¹æ³•éƒ½åœ¨ä»€ä¹ˆæ—¶å€™è¢«triggerï¼Œä¸¤ä¸ªæ–¹æ³•ä¹‹é—´éƒ½åšäº†ä»€ä¹ˆäº‹æƒ…ã€‚ é¦–å…ˆçœ‹ä¸€ä¸‹SpringApplicationRunListener(s)æœ‰å“ªäº›æ–¹æ³• SpringApplicationRunListenerå¹¶æ²¡æœ‰ç›´æ¥è¢«SpringApplicationè°ƒç”¨ï¼Œè€Œæ˜¯ä½œä¸ºä¸€ä¸ªæ•´ä½“SpringApplicationRunListenersè¢«ç»Ÿä¸€è°ƒç”¨ï¼Œå®ƒæœ‰startingã€environmentPreparedã€contextPreparedã€contextLoadedã€startedã€runningã€failedç­‰ä¸ƒä¸ªæ–¹æ³•ã€‚ç”±äºè¿™ä¸€ç¯‡æˆ‘ä»¬åªè®²SpringBootçš„å¯åŠ¨æµç¨‹ï¼Œå› æ­¤åªè®¨è®ºå‰å…­ä¸ªæ–¹æ³•ï¼Œçœ‹ä»–ä»¬çš„è°ƒç”¨æ—¶æœºã€‚ public interface SpringApplicationRunListener { /** * Called immediately when the run method has first started. Can be used for very * early initialization. */ default void starting() { } /** * Called once the environment has been prepared, but before the * {@link ApplicationContext} has been created. * @param environment the environment */ default void environmentPrepared(ConfigurableEnvironment environment) { } /** * Called once the {@link ApplicationContext} has been created and prepared, but * before sources have been loaded. * @param context the application context */ default void contextPrepared(ConfigurableApplicationContext context) { } /** * Called once the application context has been loaded but before it has been * refreshed. * @param context the application context */ default void contextLoaded(ConfigurableApplicationContext context) { } /** * The context has been refreshed and the application has started but * {@link CommandLineRunner CommandLineRunners} and {@link ApplicationRunner * ApplicationRunners} have not been called. * @param context the application context. * @since 2.0.0 */ default void started(ConfigurableApplicationContext context) { } /** * Called immediately before the run method finishes, when the application context has * been refreshed and all {@link CommandLineRunner CommandLineRunners} and * {@link ApplicationRunner ApplicationRunners} have been called. * @param context the application context. * @since 2.0.0 */ default void running(ConfigurableApplicationContext context) { } /** * Called when a failure occurs when running the application. * @param context the application context or {@code null} if a failure occurred before * the context was created * @param exception the failure * @since 2.0.0 */ default void failed(ConfigurableApplicationContext context, Throwable exception) { } } åœ¨startingæ–¹æ³•ä¹‹å‰ springbootåœ¨è°ƒç”¨runæ–¹æ³•åï¼ŒåŸºæœ¬ä¸Šç¬¬ä¸€æ—¶é—´å°±triggeräº†listenerçš„startingæ–¹å¼ï¼Œåœ¨è¿™ä¹‹å‰ï¼ŒåŸºæœ¬ä¸Šæ²¡åšå•¥äº‹ã€‚ StopWatch stopWatch = new StopWatch(); stopWatch.start(); ConfigurableApplicationContext context = null; Collection&lt;SpringBootExceptionReporter&gt; exceptionReporters = new ArrayList&lt;&gt;(); configureHeadlessProperty(); SpringApplicationRunListeners listeners = getRunListeners(args); å¼€å¯è®¡æ—¶å™¨ ä¸€ä¸ªæ˜¯åˆ›å»ºäº†ä¸€ä¸ªtimerï¼ˆStopWatchï¼‰ç”¨æ¥ä¹‹åè®¡ç®—å¯åŠ¨è€—æ—¶ï¼Œä¸‹é¢è¿™æ®µæ—¥å¿—å°±æ˜¯å®ƒåŠŸèƒ½çš„ä½“ç°ã€‚ 2021-09-22 16:29:38.241 INFO 8044 --- [ main] com.sample.app.SampleApplication : Started SampleApplication in 32.023 seconds (JVM running for 121.055) headless=true è®¾ç½®æ— å¤–æ¥è®¾å¤‡å¯åŠ¨ ä¸€ä¸ªæ˜¯è°ƒç”¨configureHeadlessPropertyæ–¹æ³•æ¥è®¾ç½®java.awt.headlessçš„ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼Œè¿™ä¸ªé»˜è®¤å€¼æ˜¯trueã€‚ private boolean headless = true; private void configureHeadlessProperty() { System.setProperty(SYSTEM_PROPERTY_JAVA_AWT_HEADLESS, System.getProperty(SYSTEM_PROPERTY_JAVA_AWT_HEADLESS, Boolean.toString(this.headless))); } è·å–å¹¶å¯ç”¨ç›‘å¬å™¨ å†æœ‰å°±æ˜¯ä»ä¹‹å‰è§£æå¥½çš„spring.factoriesä¸­è¯»å–æ‰€æœ‰çš„SpringApplicationRunListenersã€‚ private SpringApplicationRunListeners getRunListeners(String[] args) { Class&lt;?&gt;[] types = new Class&lt;?&gt;[] { SpringApplication.class, String[].class }; return new SpringApplicationRunListeners(logger, getSpringFactoriesInstances(SpringApplicationRunListener.class, types, this, args)); } åœ¨startingæ–¹æ³• EventPublishingRunListenerå‘å¸ƒApplicationStartingEventäº‹ä»¶ public void starting() { this.initialMulticaster.multicastEvent(new ApplicationStartingEvent(this.application, this.args)); } è®¢é˜…äº†è¿™ä¸ªäº‹ä»¶çš„ApplicationListenerå€’æ˜¯æ‰¾åˆ°äº†å‡ ä¸ªï¼Œé™¤äº†LogbackLoggingSystemè¿›è¡Œäº†ä¸€äº›ä¸logç›¸å…³çš„ç®€å•æ“ä½œå¤–ï¼Œéƒ½æ²¡åšå•¥äº‹ã€‚ LiquibaseServiceLocatorApplicationListener DelegatingApplicationListener LogbackLoggingSystem BackgroundPreinitializer è®¾ç½®åº”ç”¨ç¨‹åºå‚æ•° staringä¹‹åï¼ŒenvironmentPreparedä¹‹å‰ å¯¹åº”çš„ä»£ç åœ¨runæ–¹æ³•é‡Œå¯¹åº”ä¸¤è¡Œï¼Œå…¶ä¸­ç¬¬ä¸€è¡Œæ˜¯æŠŠç³»ç»Ÿå‚æ•°åŒ…è£…ä¸€ä¸‹ï¼Œä½¿å¾—ç”¨èµ·æ¥æ›´åŠ æ–¹ä¾¿ã€‚ç¬¬äºŒè¡Œåˆ™æ˜¯è¿›è¡Œä¸€äº›ç¯å¢ƒçš„å‡†å¤‡å·¥ä½œã€‚ ApplicationArguments applicationArguments = new DefaultApplicationArguments(args); ConfigurableEnvironment environment = prepareEnvironment(listeners, applicationArguments); å‡†å¤‡ç¯å¢ƒå˜é‡ æˆ‘ä»¬é‡ç‚¹çœ‹prepareEnvironmentè¿™ä¸ªæ–¹æ³•ä¸­åšäº†å“ªäº›å·¥ä½œã€‚ private ConfigurableEnvironment prepareEnvironment(SpringApplicationRunListeners listeners, ApplicationArguments applicationArguments) { // Create and configure the environment ConfigurableEnvironment environment = getOrCreateEnvironment(); configureEnvironment(environment, applicationArguments.getSourceArgs()); ConfigurationPropertySources.attach(environment); listeners.environmentPrepared(environment); bindToSpringApplication(environment); if (!this.isCustomEnvironment) { environment = new EnvironmentConverter(getClassLoader()).convertEnvironmentIfNecessary(environment, deduceEnvironmentClass()); } ConfigurationPropertySources.attach(environment); return environment; } å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°ï¼Œåœ¨è°ƒç”¨listeners.environmentPrepared(environment);æ–¹æ³•ä¹‹å‰ï¼Œåªæœ‰ä¸‰è¡Œcodeï¼Œåˆ†åˆ«åšäº†ä¸‰ä»¶äº‹æƒ…ã€‚ getOrCreateEnvironmentæ ¹æ®åº”ç”¨ç±»å‹æ¥åˆ›å»ºConfigurableEnvironment private ConfigurableEnvironment getOrCreateEnvironment() { if (this.environment != null) { return this.environment; } switch (this.webApplicationType) { case SERVLET: return new StandardServletEnvironment(); case REACTIVE: return new StandardReactiveWebEnvironment(); default: return new StandardEnvironment(); } } configureEnvironment æ¥é…ç½®propertiesSourceå’Œprofiles è¿™é‡Œé¢å…¶å®åšäº†ä¸‰ä»¶äº‹æƒ…ï¼Œé™¤äº†ä¸Šé¢è¯´çš„propertiesSourceå’Œprofilesä¹‹å¤–è¿˜æœ‰å¯¹conversionServiceçš„é…ç½®ï¼Œä½†æ˜¯æˆ‘è¿˜ä¸æ¸…æ¥šconversionServiceè¿™ä¸ªä¸œè¥¿åˆ°åº•æ˜¯å¹²å•¥ç”¨çš„ï¼Œæ‰€ä»¥å…ˆç©ºç€å§ã€‚å…ˆè§£é‡Šå‰©ä¸‹çš„ä¸¤ä¸ªå§ã€‚ protected void configureEnvironment(ConfigurableEnvironment environment, String[] args) { if (this.addConversionService) { ConversionService conversionService = ApplicationConversionService.getSharedInstance(); environment.setConversionService((ConfigurableConversionService) conversionService); } configurePropertySources(environment, args); configureProfiles(environment, args); } å…¶ä¸­ï¼ŒconfigurePropertySourcesæ˜¯é…ç½®environmentä¸­çš„propertySourceså±æ€§ã€‚propertySourcesæ˜¯ç”¨äºè®°å½•ç³»ç»Ÿçš„é…ç½®å‚æ•°å¯ä»¥ä»å“ªé‡Œè¯»å–ï¼Œå„ä¸ªpropertySourceåœ¨å…¶ä¸­çš„å…ˆåé¡ºåºä½“ç°äº†ä»–ä»¬å½¼æ­¤çš„ä¼˜å…ˆçº§ã€‚é»˜è®¤çš„propertySourcesåŒ…æ‹¬systemPropertieså’ŒsystemEnvironmentä¸¤ä¸ªã€‚åœ¨configurePropertySourcesæ­¥éª¤ä¸­æ ¹æ®ä»£ç æˆ–è€…å‚æ•°çš„ä¸åŒï¼Œå¯èƒ½ä¼šé¢å¤–åŠ ä¸ŠdefaultPropertieså’ŒcommandLineArgsä¸¤ä¸ªpropertySourceã€‚ protected void configurePropertySources(ConfigurableEnvironment environment, String[] args) { MutablePropertySources sources = environment.getPropertySources(); if (this.defaultProperties != null &amp;&amp; !this.defaultProperties.isEmpty()) { sources.addLast(new MapPropertySource(&quot;defaultProperties&quot;, this.defaultProperties)); } if (this.addCommandLineProperties &amp;&amp; args.length &gt; 0) { String name = CommandLinePropertySource.COMMAND_LINE_PROPERTY_SOURCE_NAME; if (sources.contains(name)) { PropertySource&lt;?&gt; source = sources.get(name); CompositePropertySource composite = new CompositePropertySource(name); composite.addPropertySource( new SimpleCommandLinePropertySource(&quot;springApplicationCommandLineArgs&quot;, args)); composite.addPropertySource(source); sources.replace(name, composite); } else { sources.addFirst(new SimpleCommandLinePropertySource(args)); } } } configureProfilesåˆ™æ˜¯è¯•å›¾ä»ç°æœ‰çš„propertySourcesä¸­å°è¯•è·å–spring.profiles.activeå‚æ•°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ­¤æ—¶çš„propertySourceså¹¶ä¸åŒ…å«ä¸ä½ çš„é…ç½®æ–‡ä»¶ï¼ˆæ¯”å¦‚application.propertiesï¼‰ç›¸å¯¹åº”çš„propertySourceï¼Œæ‰€ä»¥æ— è®ºä½ çš„é…ç½®æ–‡ä»¶æ€ä¹ˆé…ç½®ï¼Œå¯¹è¿™ä¸ªé˜¶æ®µéƒ½ä¸é€ æˆå½±å“ã€‚ protected void configureProfiles(ConfigurableEnvironment environment, String[] args) { Set&lt;String&gt; profiles = new LinkedHashSet&lt;&gt;(this.additionalProfiles); profiles.addAll(Arrays.asList(environment.getActiveProfiles())); environment.setActiveProfiles(StringUtils.toStringArray(profiles)); } ConfigurationPropertySources.attach(environment)å°†è‡ªå·±ç½®äºpropertySourcesçš„ç¬¬ä¸€ä¸ªçš„ä½ç½® å‰é¢ä¹Ÿè®²äº†ï¼Œå„ä¸ªPropertySourceåœ¨propertySourcesä¸­çš„å…ˆåé¡ºåºå†³å®šäº†ä¼˜å…ˆçº§ï¼Œç°åœ¨æŠŠConfigurationPropertySourcesæ”¾åˆ°ç¬¬ä¸€ä½ï¼Œä¹Ÿå°±æ„å‘³ç€å®ƒçš„ä¼˜å…ˆçº§æ˜¯æœ€é«˜çš„ã€‚ç»†å¿ƒçš„äººåº”è¯¥ä¹Ÿä¼šæ³¨æ„åˆ°ConfigurationPropertySources.attach(environment)è¿™ä¸€è¡Œå‰åè°ƒç”¨äº†ä¸¤æ¬¡ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ä¸ºäº†ç¡®ä¿ConfigurationPropertySourcesä¼˜å…ˆåŠ è½½çš„é¡ºåºã€‚ public static void attach(Environment environment) { Assert.isInstanceOf(ConfigurableEnvironment.class, environment); MutablePropertySources sources = ((ConfigurableEnvironment) environment).getPropertySources(); PropertySource&lt;?&gt; attached = sources.get(ATTACHED_PROPERTY_SOURCE_NAME); if (attached != null &amp;&amp; attached.getSource() != sources) { sources.remove(ATTACHED_PROPERTY_SOURCE_NAME); attached = null; } if (attached == null) { sources.addFirst(new ConfigurationPropertySourcesPropertySource(ATTACHED_PROPERTY_SOURCE_NAME, new SpringConfigurationPropertySources(sources))); } } åœ¨environmentPreparedæ–¹æ³• EventPublishingRunListenerå‘å¸ƒApplicationEnvironmentPreparedEventäº‹ä»¶ public void starting() { this.initialMulticaster.multicastEvent(new ApplicationStartingEvent(this.application, this.args)); } è®¢é˜…äº†è¿™ä¸ªäº‹ä»¶çš„ApplicationListenerä¹Ÿæ‰¾åˆ°äº†å‡ ä¸ªï¼Œæˆ‘ä»¬å…ˆè®°å½•ä¸‹æ¥ã€‚ ConfigFileApplicationListener AnsiOutputApplicationListener LoggingApplicationListener ClasspathLoggingApplicationListener BackgroundPreinitializer DelegatingApplicationListener FileEncodingApplicationListener å…¶ä¸­æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯ConfigFileApplicationListenerï¼Œå› æ­¤æˆ‘ä»¬å±•å¼€è®²ä¸€ä¸‹ï¼Œå‰©ä¸‹çš„ç­‰æœ‰ç©ºäº†å†è¯´ã€‚ åœ¨æ¥æ”¶åˆ°ApplicationEnvironmentPreparedEventä¹‹åï¼Œåšäº†è¿™ä»¶äº‹ private void onApplicationEnvironmentPreparedEvent(ApplicationEnvironmentPreparedEvent event) { // åŠ è½½æ‰€æœ‰EnvironmentPostProcessorå¹¶æ’åº List&lt;EnvironmentPostProcessor&gt; postProcessors = loadPostProcessors(); postProcessors.add(this); AnnotationAwareOrderComparator.sort(postProcessors); //ä¾æ¬¡è°ƒç”¨EnvironmentPostProcessorçš„postProcessEnvironmentæ–¹æ³• for (EnvironmentPostProcessor postProcessor : postProcessors) { postProcessor.postProcessEnvironment(event.getEnvironment(), event.getSpringApplication()); } } åœ¨è¿™å—é€»è¾‘ä¸­ï¼Œä¼šè°ƒç”¨å®ƒè‡ªèº«çš„postProcessEnvironmentæ–¹æ³•ï¼Œä»è€Œå®ç°é…ç½®æ–‡ä»¶çš„åŠ è½½ @Override public void postProcessEnvironment(ConfigurableEnvironment environment, SpringApplication application) { addPropertySources(environment, application.getResourceLoader()); } /** * Add config file property sources to the specified environment. * @param environment the environment to add source to * @param resourceLoader the resource loader * @see #addPostProcessors(ConfigurableApplicationContext) */ protected void addPropertySources(ConfigurableEnvironment environment, ResourceLoader resourceLoader) { RandomValuePropertySource.addToEnvironment(environment); new Loader(environment, resourceLoader).load(); } å…¶ä¸­ï¼Œloaderçš„loadæ–¹æ³•æˆ‘ä»¬ä¹Ÿè®°å½•ä¸€ä¸‹ void load() { FilteredPropertySource.apply(this.environment, DEFAULT_PROPERTIES, LOAD_FILTERED_PROPERTY, (defaultProperties) -&gt; { this.profiles = new LinkedList&lt;&gt;(); this.processedProfiles = new LinkedList&lt;&gt;(); this.activatedProfiles = false; this.loaded = new LinkedHashMap&lt;&gt;(); initializeProfiles(); while (!this.profiles.isEmpty()) { Profile profile = this.profiles.poll(); if (isDefaultProfile(profile)) { addProfileToEnvironment(profile.getName()); } load(profile, this::getPositiveProfileFilter, addToLoaded(MutablePropertySources::addLast, false)); this.processedProfiles.add(profile); } load(null, this::getNegativeProfileFilter, addToLoaded(MutablePropertySources::addFirst, true)); addLoadedPropertySources(); applyActiveProfiles(defaultProperties); }); } å¿½ç•¥beanä¿¡æ¯ private void configureIgnoreBeanInfo(ConfigurableEnvironment environment) { if (System.getProperty( CachedIntrospectionResults.IGNORE_BEANINFO_PROPERTY_NAME) == null) { Boolean ignore = environment.getProperty(&quot;spring.beaninfo.ignore&quot;, Boolean.class, Boolean.TRUE); System.setProperty(CachedIntrospectionResults.IGNORE_BEANINFO_PROPERTY_NAME, ignore.toString()); } } æ‰“å°bannerä¿¡æ¯ æ˜¾è€Œæ˜“è§ï¼Œè¿™ä¸ªæµç¨‹å°±æ˜¯ç”¨æ¥æ‰“å°æ§åˆ¶å°é‚£ä¸ªå¾ˆå¤§çš„springçš„bannerçš„ï¼Œå°±æ˜¯ä¸‹é¢è¿™ä¸ªä¸œä¸œ é‚£ä»–åœ¨å“ªé‡Œæ‰“å°çš„å‘¢ï¼Ÿä»–åœ¨ SpringBootBanner.java é‡Œé¢æ‰“å°çš„ï¼Œè¿™ä¸ªç±»å®ç°äº†Banner æ¥å£ï¼Œ è€Œä¸”bannerä¿¡æ¯æ˜¯ç›´æ¥åœ¨ä»£ç é‡Œé¢å†™æ­»çš„ï¼› æœ‰äº›å…¬å¸å–œæ¬¢è‡ªå®šä¹‰bannerä¿¡æ¯ï¼Œå¦‚æœæƒ³è¦æ”¹æˆè‡ªå·±å–œæ¬¢çš„å›¾æ ‡è¯¥æ€ä¹ˆåŠå‘¢ï¼Œå…¶å®å¾ˆç®€å•,åªéœ€è¦åœ¨resourcesç›®å½•ä¸‹æ·»åŠ ä¸€ä¸ª banner.txt çš„æ–‡ä»¶å³å¯ï¼Œä¸€å®šè¦æ·»åŠ åˆ°resourcesç›®å½•ä¸‹ï¼Œåˆ«åŠ é”™äº† åˆ›å»ºåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ environmentPreparedä¹‹åï¼ŒcontextPreparedä¹‹å‰ è¿™éƒ¨åˆ†åœ¨SpringApplicationå¯¹åº”çš„ä»£ç ä¸»è¦æ˜¯è¿™ä¹ˆä¸‰è¡Œ //åˆå§‹åŒ– context = createApplicationContext(); exceptionReporters = getSpringFactoriesInstances(SpringBootExceptionReporter.class, new Class[] { ConfigurableApplicationContext.class }, context); prepareContext(context, environment, listeners, applicationArguments, printedBanner); ç¬¬ä¸€è¡Œæ˜¯æ ¹æ®åº”ç”¨ç±»å‹ï¼Œåˆ›å»ºApplicationContextçš„å®ä¾‹ protected ConfigurableApplicationContext createApplicationContext() { Class&lt;?&gt; contextClass = this.applicationContextClass; if (contextClass == null) { try { switch (this.webApplicationType) { case SERVLET: contextClass = Class.forName(DEFAULT_SERVLET_WEB_CONTEXT_CLASS); break; case REACTIVE: contextClass = Class.forName(DEFAULT_REACTIVE_WEB_CONTEXT_CLASS); break; default: contextClass = Class.forName(DEFAULT_CONTEXT_CLASS); } } catch (ClassNotFoundException ex) { throw new IllegalStateException( &quot;Unable create a default ApplicationContext, please specify an ApplicationContextClass&quot;, ex); } } return (ConfigurableApplicationContext) BeanUtils.instantiateClass(contextClass); } å®ä¾‹åŒ–å¼‚å¸¸æŠ¥å‘Šå™¨ ç¬¬äºŒè¡Œå°±æ˜¯è·å–SpringBootExceptionReporterçš„å®ä¾‹ã€‚ å¼‚å¸¸æŠ¥å‘Šå™¨æ˜¯ç”¨æ¥æ•æ‰å…¨å±€å¼‚å¸¸ä½¿ç”¨çš„ï¼Œå½“springbootåº”ç”¨ç¨‹åºåœ¨å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œå¼‚å¸¸æŠ¥å‘Šå™¨ä¼šå°†å…¶æ•æ‰å¹¶åšç›¸åº”å¤„ç†ï¼Œåœ¨spring.factories æ–‡ä»¶é‡Œé…ç½®äº†é»˜è®¤çš„å¼‚å¸¸æŠ¥å‘Šå™¨ï¼Œ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªå¼‚å¸¸æŠ¥å‘Šå™¨åªä¼šæ•è·å¯åŠ¨è¿‡ç¨‹æŠ›å‡ºçš„å¼‚å¸¸ï¼Œå¦‚æœæ˜¯åœ¨å¯åŠ¨å®Œæˆåï¼Œåœ¨ç”¨æˆ·è¯·æ±‚æ—¶æŠ¥é”™ï¼Œå¼‚å¸¸æŠ¥å‘Šå™¨ä¸ä¼šæ•è·è¯·æ±‚ä¸­å‡ºç°çš„å¼‚å¸¸ï¼Œ äº†è§£åŸç†äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è‡ªå·±é…ç½®ä¸€ä¸ªå¼‚å¸¸æŠ¥å‘Šå™¨æ¥ç©ç©ï¼› MyExceptionReporter.java ç»§æ‰¿ SpringBootExceptionReporter æ¥å£ package com.spring.application; import org.springframework.boot.SpringBootExceptionReporter; import org.springframework.context.ConfigurableApplicationContext; public class MyExceptionReporter implements SpringBootExceptionReporter { private ConfigurableApplicationContext context; // å¿…é¡»è¦æœ‰ä¸€ä¸ªæœ‰å‚çš„æ„é€ å‡½æ•°ï¼Œå¦åˆ™å¯åŠ¨ä¼šæŠ¥é”™ MyExceptionReporter(ConfigurableApplicationContext context) { this.context = context; } @Override public boolean reportException(Throwable failure) { System.out.println(&quot;è¿›å…¥å¼‚å¸¸æŠ¥å‘Šå™¨&quot;); failure.printStackTrace(); // è¿”å›falseä¼šæ‰“å°è¯¦ç»†springbooté”™è¯¯ä¿¡æ¯ï¼Œè¿”å›trueåˆ™åªæ‰“å°å¼‚å¸¸ä¿¡æ¯ return false; } } åœ¨ spring.factories æ–‡ä»¶ä¸­æ³¨å†Œå¼‚å¸¸æŠ¥å‘Šå™¨ # Error Reporters å¼‚å¸¸æŠ¥å‘Šå™¨ org.springframework.boot.SpringBootExceptionReporter=\\ com.spring.application.MyExceptionReporter æ¥ç€æˆ‘ä»¬åœ¨application.yml ä¸­ æŠŠç«¯å£å·è®¾ç½®ä¸ºä¸€ä¸ªå¾ˆå¤§çš„å€¼ï¼Œè¿™æ ·è‚¯å®šä¼šæŠ¥é”™ï¼Œ server: port: 80828888 å¯åŠ¨åï¼Œæ§åˆ¶å°æ‰“å°å¦‚ä¸‹å›¾ å‡†å¤‡ä¸Šä¸‹æ–‡ç¯å¢ƒ ç¬¬ä¸‰è¡Œæ‰€å¯¹åº”çš„æ–¹æ³•æ¯”è¾ƒå¤æ‚ï¼Œå’Œæˆ‘ä»¬è¿™ä¸ªé˜¶æ®µå¯¹åº”çš„ä¸»è¦æ˜¯è¿™ä¹ˆå‡ è¡Œã€‚ private void prepareContext(ConfigurableApplicationContext context, ConfigurableEnvironment environment, SpringApplicationRunListeners listeners, ApplicationArguments applicationArguments, Banner printedBanner) { context.setEnvironment(environment); postProcessApplicationContext(context); applyInitializers(context); .... } å…¶ä¸­applyInitializers(context)è¿™è¡Œå°±æ˜¯å¯¹æˆ‘ä»¬åœ¨new SpringApplication()æ—¶æ‰¾åˆ°çš„ApplicationContextInitializerè¿›è¡Œåˆå§‹åŒ–å·¥ä½œã€‚è¿™éƒ¨åˆ†åŒ…å«ä¸¤ä¸ªç‰¹æ®Šçš„ApplicationContextInitializerï¼Œä»–ä»¬ä¼šå¢åŠ å¯¹åº”çš„BeanFactoryPostProcessorã€‚BeanFactoryPostProcessorè¿™ä¸ªç±»æ¯”è¾ƒé‡è¦ï¼Œå®ƒå¯ä»¥è¯»å–å¹¶è¦†ç›–åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ä¸­é…ç½®çš„beanå±æ€§ã€‚ class SharedMetadataReaderFactoryContextInitializer implements ApplicationContextInitializer&lt;ConfigurableApplicationContext&gt;, Ordered { ... @Override public void initialize(ConfigurableApplicationContext applicationContext) { applicationContext.addBeanFactoryPostProcessor(new CachingMetadataReaderFactoryPostProcessor()); } ... } public class ConfigurationWarningsApplicationContextInitializer implements ApplicationContextInitializer&lt;ConfigurableApplicationContext&gt; { ... @Override public void initialize(ConfigurableApplicationContext context) { context.addBeanFactoryPostProcessor(new ConfigurationWarningsPostProcessor(getChecks())); } ... } åœ¨contextPreparedæ–¹æ³• EventPublishingRunListenerå‘å¸ƒApplicationContextInitializedEventäº‹ä»¶ public void contextPrepared(ConfigurableApplicationContext context) { this.initialMulticaster .multicastEvent(new ApplicationContextInitializedEvent(this.application, this.args, context)); } è®¢é˜…äº†è¿™ä¸ªäº‹ä»¶çš„ApplicationListeneråªæ‰¾åˆ°ä¸ªä¸¤ä¸ªï¼Œæˆ‘ä»¬å…ˆè®°å½•ä¸‹æ¥ã€‚éƒ½æ²¡åšå•¥äº‹ BackgroundPreinitializer DelegatingApplicationListener contextPrepared ä¹‹åï¼ŒcontextLoadedä¹‹å‰ è¿™ä¸ªéƒ¨åˆ†codeéƒ½è¢«åŒ…å«åœ¨prepareContextè¿™ä¸ªSpringApplicationçš„ç§æœ‰æ–¹æ³•ä¸­äº†ã€‚ å…¶ä¸­æ¯”è¾ƒé‡è¦çš„load(context, sources.toArray(new Object[0]))è¿™ä¸€è¡Œã€‚è¿™ä¸€è¡Œä¼šä¸ºä¹‹åbeançš„æ‰«æè·¯å¾„åšå¥½å‡†å¤‡ã€‚ åœ¨contextLoadedæ–¹æ³• EventPublishingRunListenerå°†listeneræ³¨å†Œåˆ°åˆ›å»ºå¥½çš„ApplicationContextä¹‹ä¸­ï¼Œä¹‹åå‘å¸ƒApplicationPreparedEventäº‹ä»¶ã€‚ public void contextLoaded(ConfigurableApplicationContext context) { for (ApplicationListener&lt;?&gt; listener : this.application.getListeners()) { if (listener instanceof ApplicationContextAware) { ((ApplicationContextAware) listener).setApplicationContext(context); } context.addApplicationListener(listener); } this.initialMulticaster.multicastEvent(new ApplicationPreparedEvent(this.application, this.args, context)); } è®¢é˜…äº†è¿™ä¸ªäº‹ä»¶çš„ApplicationListenerï¼Œæˆ‘ä»¬è®°å½•ä¸‹æ¥ã€‚å…¶ä¸­æ¯”è¾ƒç‰¹æ®Šçš„æ˜¯ConfigFileApplicationListenerï¼Œå®ƒæ³¨å†Œäº†ä¸€ä¸ªPropertySourceOrderingPostProcessorçš„BeanFactoryPostProcessorå®ä¾‹åˆ°contextä¸­ã€‚ CloudFoundryVcapEnvironmentPostProcessor ConfigFileApplicationListener LoggingApplicationListener BackgroundPreinitializer DelegatingApplicationListener åˆ·æ–°ä¸Šä¸‹æ–‡ contextLoadedä¹‹åï¼Œstartedä¹‹å‰ è¿™ä¸ªåœ¨runæ–¹æ³•ä¸­åªå¯¹åº”äº†ä¸€è¡Œä»£ç refreshContext(context);ã€‚å®ƒä¼šé—´æ¥çš„å¯¹ApplicationContextçš„refreshæ–¹æ³•è¿›è¡Œè°ƒç”¨ã€‚ç”±äºæˆ‘ä»¬ç°åœ¨debugçš„æ˜¯ä¸€ä¸ªwebé¡¹ç›®ï¼Œå› æ­¤èµ°è¿›å»å¯¹åº”çš„ApplicationContextçš„å®ç°ç±»æ˜¯ServletWebServerApplicationContextã€‚å®ƒçš„refreshæ–¹æ³•å¯ä»¥ç®€å•çš„è§†ä¸ºå¯¹çˆ¶ç±»refreshæ–¹æ³•çš„è°ƒç”¨ï¼Œå®ƒçš„onRefreshæ–¹æ³•åˆ™åœ¨çˆ¶ç±»(AbstractApplicationContext)çš„æ–¹æ³•ä¹‹ä¸Šåˆ›å»ºäº†WebServerã€‚ @Override public final void refresh() throws BeansException, IllegalStateException { try { super.refresh(); } catch (RuntimeException ex) { WebServer webServer = this.webServer; if (webServer != null) { webServer.stop(); } throw ex; } } @Override protected void onRefresh() { super.onRefresh(); try { createWebServer(); } catch (Throwable ex) { throw new ApplicationContextException(&quot;Unable to start web server&quot;, ex); } } æˆ‘ä»¬çœ‹ä¸€ä¸‹åœ¨çˆ¶ç±»çš„refreshæ–¹æ³•ä¸­åšäº†å“ªäº›äº‹æƒ… public void refresh() throws BeansException, IllegalStateException { synchronized (this.startupShutdownMonitor) { //è¿™ä¸ªæ­¥éª¤ä¼šæ¸…é™¤ç¼“å­˜ï¼Œæ£€æŸ¥æ˜¯å¦ç¼ºå°‘ç¯å¢ƒå‚æ•°ï¼Œä¿å­˜å‰æœŸåŠ è½½çš„ApplicationListenerå®ä¾‹(ä»applicationListenerså±æ€§åˆ°earlyApplicationListeners) // Prepare this context for refreshing. prepareRefresh(); // Tell the subclass to refresh the internal bean factory. ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory(); //è¿™ä¸ªæ­¥éª¤é€šè¿‡è°ƒç”¨ignoreDependencyInterfaceï¼ŒregisterResolvableDependencyï¼ŒaddBeanPostProcessorç­‰æ–¹æ³•å®ŒæˆbeanFactoryçš„ä¸€äº›é…ç½®ã€‚å…¶ä¸­addBeanPostProcessoræ–¹æ³•ä¼šè¢«è°ƒç”¨è‡³å°‘ä¸¤æ¬¡ï¼Œä¼ å‚åˆ†åˆ«ä¸ºApplicationContextAwareProcessorå’ŒApplicationListenerDetector // Prepare the bean factory for use in this context. prepareBeanFactory(beanFactory); //è¿™ä¸ªæ­¥éª¤ä¼šæ¸…é™¤ç¼“å­˜ï¼Œæ£€æŸ¥æ˜¯å¦ç¼ºå°‘ç¯å¢ƒå‚æ•°ï¼Œä¿å­˜å‰æœŸåŠ è½½çš„ApplicationListenerå®ä¾‹(ä»applicationListenerså±æ€§åˆ°earlyApplicationListeners) // Prepare this context for refreshing. prepareRefresh(); // Tell the subclass to refresh the internal bean factory. ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory(); //è¿™ä¸ªæ­¥éª¤é€šè¿‡è°ƒç”¨ignoreDependencyInterfaceï¼ŒregisterResolvableDependencyï¼ŒaddBeanPostProcessorç­‰æ–¹æ³•å®ŒæˆbeanFactoryçš„ä¸€äº›é…ç½®ã€‚å…¶ä¸­addBeanPostProcessoræ–¹æ³•ä¼šè¢«è°ƒç”¨è‡³å°‘ä¸¤æ¬¡ï¼Œä¼ å‚åˆ†åˆ«ä¸ºApplicationContextAwareProcessorå’ŒApplicationListenerDetector // Prepare the bean factory for use in this context. prepareBeanFactory(beanFactory); try { // Allows post-processing of the bean factory in context subclasses. postProcessBeanFactory(beanFactory); //è¿™ä¸ªæ­¥éª¤ä¼šåŠ è½½beançš„definition // Invoke factory processors registered as beans in the context. invokeBeanFactoryPostProcessors(beanFactory); // Register bean processors that intercept bean creation. registerBeanPostProcessors(beanFactory); // Initialize message source for this context. initMessageSource(); // Initialize event multicaster for this context. initApplicationEventMulticaster(); //Webç±»å‹çš„Appå°†åœ¨è¿™ä¸ªæ­¥éª¤åˆ›å»ºWebServerï¼Œä½†æ˜¯WebServeræ­¤æ—¶å¹¶ä¸ä¼šç«‹åˆ»å¯åŠ¨ // Initialize other special beans in specific context subclasses. onRefresh(); //æ³¨å†Œç›‘å¬ // Check for listener beans and register them. registerListeners(); //è¿™ä¸ªæ—¶å€™ä¼šæ ¹æ®ä¹‹å‰è·å–çš„çš„beançš„definitionï¼Œè¿›è¡Œbeançš„åˆå§‹åŒ– // Instantiate all remaining (non-lazy-init) singletons. finishBeanFactoryInitialization(beanFactory); //Webç±»å‹çš„Appå°†åœ¨è¿™ä¸ªæ­¥éª¤å¯åŠ¨ä¹‹å‰åˆ›å»ºå¥½çš„WebServer // Last step: publish corresponding event. finishRefresh(); } catch (BeansException ex) { if (logger.isWarnEnabled()) { logger.warn(&quot;Exception encountered during context initialization - &quot; + &quot;cancelling refresh attempt: &quot; + ex); } // Destroy already created singletons to avoid dangling resources. destroyBeans(); // Reset 'active' flag. cancelRefresh(ex); // Propagate exception to caller. throw ex; } finally { // Reset common introspection caches in Spring's core, since we // might not ever need metadata for singleton beans anymore... resetCommonCaches(); } } } åˆ·æ–°ä¸Šä¸‹æ–‡åç½®å¤„ç† afterRefresh æ–¹æ³•æ˜¯å¯åŠ¨åçš„ä¸€äº›å¤„ç†ï¼Œç•™ç»™ç”¨æˆ·æ‰©å±•ä½¿ç”¨ï¼Œç›®å‰è¿™ä¸ªæ–¹æ³•é‡Œé¢æ˜¯ç©ºçš„ï¼Œ /** * Called after the context has been refreshed. * @param context the application context * @param args the application arguments */ protected void afterRefresh(ConfigurableApplicationContext context, ApplicationArguments args) { } ç»“æŸè®¡æ—¶å™¨ å‘å¸ƒä¸Šä¸‹æ–‡å‡†å¤‡å°±ç»ªäº‹ä»¶ startedä¹‹åï¼Œrunningä¹‹å‰ è¿™ä¸ªéƒ¨åˆ†å°±æ¯”è¾ƒç®€å•äº†ï¼Œä¸»è¦æ˜¯invokeäº†ApplicationRunnerå’ŒCommandLineRunner private void callRunners(ApplicationContext context, ApplicationArguments args) { List&lt;Object&gt; runners = new ArrayList&lt;&gt;(); runners.addAll(context.getBeansOfType(ApplicationRunner.class).values()); runners.addAll(context.getBeansOfType(CommandLineRunner.class).values()); AnnotationAwareOrderComparator.sort(runners); for (Object runner : new LinkedHashSet&lt;&gt;(runners)) { if (runner instanceof ApplicationRunner) { callRunner((ApplicationRunner) runner, args); } if (runner instanceof CommandLineRunner) { callRunner((CommandLineRunner) runner, args); } } } è¿™æ˜¯ä¸€ä¸ªæ‰©å±•åŠŸèƒ½ï¼ŒcallRunners(context, applicationArguments) å¯ä»¥åœ¨å¯åŠ¨å®Œæˆåæ‰§è¡Œè‡ªå®šä¹‰çš„runæ–¹æ³•ï¼›æœ‰2ä¸­æ–¹å¼å¯ä»¥å®ç°ï¼š å®ç° ApplicationRunner æ¥å£ å®ç° CommandLineRunner æ¥å£ æ¥ä¸‹æ¥æˆ‘ä»¬éªŒè¯ä¸€æŠŠï¼Œä¸ºäº†æ–¹ä¾¿ä»£ç å¯è¯»æ€§ï¼Œæˆ‘æŠŠè¿™2ç§æ–¹å¼éƒ½æ”¾åœ¨åŒä¸€ä¸ªç±»é‡Œé¢ package com.spring.init; import org.springframework.boot.ApplicationArguments; import org.springframework.boot.ApplicationRunner; import org.springframework.boot.CommandLineRunner; import org.springframework.stereotype.Component; /** * è‡ªå®šä¹‰runæ–¹æ³•çš„2ç§æ–¹å¼ */ @Component public class MyRunner implements ApplicationRunner, CommandLineRunner { @Override public void run(ApplicationArguments args) throws Exception { System.out.println(&quot; æˆ‘æ˜¯è‡ªå®šä¹‰çš„runæ–¹æ³•1ï¼Œå®ç° ApplicationRunner æ¥å£æ—¢å¯è¿è¡Œ&quot; ); } @Override public void run(String... args) throws Exception { System.out.println(&quot; æˆ‘æ˜¯è‡ªå®šä¹‰çš„runæ–¹æ³•2ï¼Œå®ç° CommandLineRunner æ¥å£æ—¢å¯è¿è¡Œ&quot; ); } } å¯åŠ¨springbootåå°±å¯ä»¥çœ‹åˆ°æ§åˆ¶å°æ‰“å°çš„ä¿¡æ¯äº† ","link":"https://tianxiawuhao.github.io/Tm9S6oyiS/"},{"title":"æ ‘å½¢ç»“æ„æŸ¥è¯¢","content":"æ ‘å‹å±‚çº§ç»“æ„æŸ¥è¯¢ æ•°æ®sql CREATE TABLE `sys_company` ( `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®', `code` varchar(36) NOT NULL COMMENT 'æ ‡è¯†ä¸»é”®', `company_name` varchar(255) NOT NULL COMMENT 'ç»„ç»‡åç§°', `pid` int(10) DEFAULT NULL COMMENT 'ä¸Šçº§ç»„ç»‡id', `pname` varchar(255) DEFAULT NULL COMMENT 'ä¸Šçº§ç»„ç»‡åç§°', `sort` int(4) DEFAULT '0' COMMENT 'æ’åº', `state` int(2) DEFAULT '0' COMMENT 'æ˜¯å¦å¯ç”¨ï¼Œ0å¯ç”¨ï¼Œ1ç¦ç”¨', `create_by` varchar(50) DEFAULT NULL COMMENT 'åˆ›å»ºè€…', `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´', `update_by` varchar(50) DEFAULT NULL COMMENT 'ä¿®æ”¹è€…', `update_time` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, PRIMARY KEY (`id`) USING BTREE, KEY `code_index` (`code`) USING BTREE COMMENT 'ç®€å•ç´¢å¼•' ) ENGINE=InnoDB AUTO_INCREMENT=119 DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC COMMENT='ç»„ç»‡è¯¦æƒ…' DTO @Data @EqualsAndHashCode(callSuper = false) @Accessors(chain = true) @AllArgsConstructor @NoArgsConstructor @Builder public class CompanyDTO { @ApiModelProperty(value = &quot;ä¸»é”®&quot;) private Integer id; @ApiModelProperty(value = &quot;æ ‡è¯†ä¸»é”®&quot;) private String code; @ApiModelProperty(value = &quot;ç»„ç»‡åç§°&quot;) private String companyName; @ApiModelProperty(value = &quot;ä¸Šçº§ç»„ç»‡id&quot;) private Integer pid; @ApiModelProperty(value = &quot;ä¸Šçº§ç»„ç»‡åç§°&quot;) private String pname; @ApiModelProperty(value = &quot;æ’åº&quot;) private Integer sort; @ApiModelProperty(value = &quot;æ˜¯å¦å¯ç”¨ï¼Œ0å¯ç”¨ï¼Œ1ç¦ç”¨&quot;) private Integer state; @ApiModelProperty(value = &quot;åˆ›å»ºè€…&quot;) private String createBy; @ApiModelProperty(value = &quot;åˆ›å»ºæ—¶é—´&quot;) private Date createTime; @ApiModelProperty(value = &quot;ä¿®æ”¹è€…&quot;) private String updateBy; @ApiModelProperty(value = &quot;ä¿®æ”¹æ—¶é—´&quot;) private Date updateTime; @ApiModelProperty(value = &quot;å­å…¬å¸ç»„ç»‡&quot;) private List&lt;CompanyDTO&gt; children; @ApiModelProperty(value = &quot;ç¼–è¾‘åˆ é™¤æ“ä½œæƒé™æ ‡è¯† true:æœ‰ false:æ— &quot;) private Boolean modAndDelFlag = false; private CompanyDTO CompanyDTO; } service public List&lt;CompanyDTO&gt; getCompanyList(Integer companyId) { CompanyDTO companyDTO = sysCompanyMapper.queryTopData(companyId); while (companyDTO.getCompanyDTO()!=null){ companyDTO = companyDTO.getCompanyDTO(); } List&lt;CompanyDTO&gt; companyDTO = sysCompanyMapper.querySimpleTopData(companyDTO.getId()); } xml &lt;resultMap id=&quot;BaseResultAllMap&quot; type=&quot;com.haier.dtosplat.entity.DTO.company.CompanyDTO&quot;&gt; &lt;id column=&quot;id&quot; property=&quot;id&quot; /&gt; &lt;result column=&quot;code&quot; property=&quot;code&quot; /&gt; &lt;result column=&quot;company_name&quot; property=&quot;companyName&quot; /&gt; &lt;result column=&quot;pid&quot; property=&quot;pid&quot; /&gt; &lt;result column=&quot;pname&quot; property=&quot;pname&quot; /&gt; &lt;result column=&quot;sort&quot; property=&quot;sort&quot; /&gt; &lt;result column=&quot;state&quot; property=&quot;state&quot; /&gt; &lt;result column=&quot;create_by&quot; property=&quot;createBy&quot; /&gt; &lt;result column=&quot;create_time&quot; property=&quot;createTime&quot; /&gt; &lt;result column=&quot;update_by&quot; property=&quot;updateBy&quot; /&gt; &lt;result column=&quot;update_time&quot; property=&quot;updateTime&quot; /&gt; &lt;association property=&quot;companyDTO&quot; column=&quot;{pid = pid}&quot; select=&quot;querySuper&quot;&gt; &lt;/association&gt; &lt;/resultMap&gt; &lt;resultMap id=&quot;BaseResultMap&quot; type=&quot;com.haier.dtosplat.entity.DTO.company.CompanyDTO&quot;&gt; &lt;id column=&quot;id&quot; property=&quot;id&quot; /&gt; &lt;result column=&quot;code&quot; property=&quot;code&quot; /&gt; &lt;result column=&quot;company_name&quot; property=&quot;companyName&quot; /&gt; &lt;result column=&quot;pid&quot; property=&quot;pid&quot; /&gt; &lt;result column=&quot;pname&quot; property=&quot;pname&quot; /&gt; &lt;result column=&quot;sort&quot; property=&quot;sort&quot; /&gt; &lt;result column=&quot;state&quot; property=&quot;state&quot; /&gt; &lt;result column=&quot;create_by&quot; property=&quot;createBy&quot; /&gt; &lt;result column=&quot;create_time&quot; property=&quot;createTime&quot; /&gt; &lt;result column=&quot;update_by&quot; property=&quot;updateBy&quot; /&gt; &lt;result column=&quot;update_time&quot; property=&quot;updateTime&quot; /&gt; &lt;collection property=&quot;children&quot; ofType=&quot;com.haier.dtosplat.entity.DTO.company.CompanyDTO&quot; column=&quot;{id = id}&quot; select=&quot;querySon&quot;&gt; &lt;/collection&gt; &lt;/resultMap&gt; &lt;select id=&quot;queryTopData&quot; resultMap=&quot;BaseResultAllMap&quot;&gt; SELECT * FROM sys_company WHERE id = #{companyId} &lt;/select&gt; &lt;select id=&quot;querySimpleTopData&quot; resultMap=&quot;BaseResultMap&quot;&gt; SELECT * FROM sys_company WHERE id = #{companyId} &lt;/select&gt; &lt;select id=&quot;querySuper&quot; resultMap=&quot;BaseResultMap&quot;&gt; SELECT * FROM sys_company WHERE id = #{pid} &lt;/select&gt; &lt;select id=&quot;querySon&quot; resultMap=&quot;BaseResultMap&quot;&gt; SELECT * FROM sys_company WHERE pid = #{id} &lt;/select&gt; ","link":"https://tianxiawuhao.github.io/0yWpE16Ha/"},{"title":"Springä½¿ç”¨ThreadLocalå­˜å‚¨å†…å­˜æ³„éœ²é£é™©","content":"Springä½¿ç”¨ThreadLocalå­˜å‚¨å†…å­˜æ³„éœ²é£é™© Spring ä¸­æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦å­˜å‚¨ä¸€äº›å’Œ Request ç›¸å…³è”çš„å˜é‡ï¼Œä¾‹å¦‚ç”¨æˆ·çš„ç™»é™†æœ‰å…³ä¿¡æ¯ç­‰ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸå’Œ Request ç›¸åŒã€‚ ä¸€ä¸ªå®¹æ˜“æƒ³åˆ°çš„å®ç°åŠæ³•æ˜¯ä½¿ç”¨ThreadLocal @Slf4j public class CurrentUserHelper { //å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ private static final InheritableThreadLocal&lt;SysUser&gt; CURRENT_USER = new InheritableThreadLocal&lt;SysUser&gt;(); public static void setCurrentUser(SysUser currentUserInfo) { CURRENT_USER.set(currentUserInfo); } public static SysUser getCurrentUser() { return (SysUser)CURRENT_USER.get(); } public static void clear() { CURRENT_USER.remove(); } } ä½¿ç”¨ä¸€ä¸ªè‡ªå®šä¹‰çš„HandlerInterceptorå°†æœ‰å…³ä¿¡æ¯æ³¨å…¥è¿›å» @Slf4j @Component public class RequestInterceptor implements HandlerInterceptor { @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { try { CurrentUserHelper.setCurrentUser(retrieveUserInfo(request)); } catch (Exception ex) { log.warn(&quot;è¯»å–è¯·æ±‚ä¿¡æ¯å¤±è´¥&quot;, ex); } return true; } @Override public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, @Nullable ModelAndView modelAndView) throws Exception { CurrentUserHelper.clear(); } é€šè¿‡è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ Controller ä¸­ç›´æ¥ä½¿ç”¨è¿™ä¸ª contextï¼Œå¾ˆæ–¹ä¾¿çš„è·å–åˆ°æœ‰å…³ç”¨æˆ·çš„ä¿¡æ¯ @Slf4j @RestController class Controller { public Result get() { SysUser user = CurrentUserHelper.get(); // ... } } è¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯å¾ˆå¤šåšå®¢ä¸­ä½¿ç”¨çš„ã€‚ç„¶è€Œè¿™ä¸ªæ–¹æ³•å´å­˜åœ¨ç€ä¸€ä¸ªå¾ˆéšè”½çš„å‘ï¼š HandlerInterceptor çš„ postHandle å¹¶ä¸æ€»æ˜¯ä¼šè°ƒç”¨ã€‚ å½“Controllerä¸­å‡ºç°Exception @Slf4j @RestController class Controller { public Result get() { SysUser user = CurrentUserHelper.get(); // ... throw new RuntimeException(); } } æˆ–è€…åœ¨HandlerInterceptorçš„preHandleä¸­å‡ºç°Exception @Slf4j @Component public class RequestInterceptor implements HandlerInterceptor { @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { try { CurrentUserHelper.setCurrentUser(retrieveUserInfo(request)); } catch (Exception ex) { log.warn(&quot;è¯»å–è¯·æ±‚ä¿¡æ¯å¤±è´¥&quot;, ex); } // ... throw new RuntimeException(); //... return true; } } è¿™äº›æƒ…å†µä¸‹ï¼Œ postHandle å¹¶ä¸ä¼šè°ƒç”¨ã€‚è¿™å°±å¯¼è‡´äº† ThreadLocal å˜é‡ä¸èƒ½è¢«æ¸…ç†ã€‚ åœ¨å¹³å¸¸çš„ Java ç¯å¢ƒä¸­ï¼ŒThreadLocal å˜é‡éšç€ Thread æœ¬èº«çš„é”€æ¯ï¼Œæ˜¯å¯ä»¥è¢«é”€æ¯æ‰çš„ã€‚ä½† Spring ç”±äºé‡‡ç”¨äº†çº¿ç¨‹æ± çš„è®¾è®¡ï¼Œå“åº”è¯·æ±‚çš„çº¿ç¨‹å¯èƒ½ä¼šä¸€ç›´å¸¸é©»ï¼Œè¿™å°±å¯¼è‡´äº†å˜é‡ä¸€ç›´ä¸èƒ½è¢« GC å›æ”¶ã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œè¿™ä¸ªæ²¡æœ‰è¢«æ­£ç¡®å›æ”¶çš„å˜é‡ï¼Œç”±äºçº¿ç¨‹æ± å¯¹çº¿ç¨‹çš„å¤ç”¨ï¼Œå¯èƒ½ä¼šä¸²åˆ°åˆ«çš„ Request å½“ä¸­ï¼Œè¿›è€Œç›´æ¥å¯¼è‡´ä»£ç é€»è¾‘çš„é”™è¯¯ã€‚ ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Spring è‡ªå¸¦çš„ RequestContextHolder ï¼Œå®ƒèƒŒåçš„åŸç†ä¹Ÿæ˜¯ ThreadLocalï¼Œä¸è¿‡å®ƒæ€»ä¼šè¢«æ›´åº•å±‚çš„ Servlet çš„ Filter æ¸…ç†æ‰ï¼Œå› æ­¤ä¸å­˜åœ¨æ³„éœ²çš„é—®é¢˜ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨RequestContextHolderé‡å†™çš„ä¾‹å­ public class SecurityContextHolder { private static final String SECURITY_CONTEXT_ATTRIBUTES = &quot;SECURITY_CONTEXT&quot;; public static void setContext(SysUser context) { RequestContextHolder.currentRequestAttributes().setAttribute( SECURITY_CONTEXT_ATTRIBUTES, context, RequestAttributes.SCOPE_REQUEST); } public static SecurityContext get() { return (SysUser)RequestContextHolder.currentRequestAttributes() .getAttribute(SECURITY_CONTEXT_ATTRIBUTES, RequestAttributes.SCOPE_REQUEST); } } é¡¹ç›®ä¸­å®ç°WebMvcConfigureræ¥å£æˆ–è€…WebMvcConfigurationSupportæ¥å£å®ç°è·¨åŸŸèµ„æºè®¿é—®é…ç½®æ—¶ï¼Œè¦é‡å†™addInterceptorsæ–¹æ³• @Configuration public class CorsConfig implements WebMvcConfigurer { @Override public void addCorsMappings(CorsRegistry registry) { //é…ç½®å…è®¸è·¨åŸŸè®¿é—®çš„è·¯å¾„ registry.addMapping(&quot;/**&quot;) .allowedOrigins(&quot;*&quot;) // å…è®¸æäº¤è¯·æ±‚çš„æ–¹æ³•ï¼Œ*è¡¨ç¤ºå…¨éƒ¨å…è®¸ .allowedMethods(&quot;GET&quot;, &quot;POST&quot;, &quot;DELETE&quot;, &quot;PUT&quot;) .allowedHeaders(&quot;*&quot;) .exposedHeaders(&quot;Access-Control-Allow-Origin&quot;) //æ˜¯å¦å…è®¸è¯ä¹¦ ä¸å†é»˜è®¤å¼€å¯ .allowCredentials(true) .maxAge(3600); } @Override public void addInterceptors(InterceptorRegistry interceptor) { interceptor.addInterceptor(new RequestInterceptor()).addPathPatterns(&quot;/**&quot;); } } é™¤äº†ä½¿ç”¨ RequestContextHolder è¿˜å¯ä»¥ä½¿ç”¨ Request Scope çš„ Beanï¼Œæˆ–è€…ä½¿ç”¨ ThreadLocalTargetSource ï¼ŒåŸç†ä¸Šæ˜¯ç±»ä¼¼çš„ã€‚ éœ€è¦æ—¶åˆ»æ³¨æ„ ThreadLocal ç›¸å½“äºçº¿ç¨‹å†…éƒ¨çš„ static å˜é‡ï¼Œæ˜¯ä¸€ä¸ªéå¸¸å®¹æ˜“äº§ç”Ÿæ³„éœ²çš„ç‚¹ï¼Œå› æ­¤ä½¿ç”¨ ThreadLocal åº”è¯¥é¢å¤–å°å¿ƒã€‚ Threadlocalå¯èƒ½ä¼šäº§ç”Ÿå†…å­˜æ³„éœ²çš„é—®é¢˜åŠåŸç† åˆšé‡åˆ°ä¸€ä¸ªå…³äºthreadlocalçš„å†…å­˜æ³„æ¼é—®é¢˜ï¼Œåˆšå¥½æ€»ç»“ä¸€ä¸‹ æ¯”è¾ƒå¸¸ç”¨çš„è¿™é‡Œå…ˆä¸æï¼Œç›´æ¥ææ¯”è¾ƒé‡è¦çš„éƒ¨åˆ† ä¸ºä»€ä¹ˆä¼šäº§ç”Ÿå†…å­˜æ³„éœ²ï¼Ÿ public void set(T value) { Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) map.set(this, value); else createMap(t, value); } setæ–¹æ³•é‡Œé¢ï¼Œå…ˆè°ƒç”¨åˆ°å½“å‰çº¿ç¨‹threadï¼Œæ¯ä¸ªçº¿ç¨‹é‡Œéƒ½ä¼šæœ‰ä¸€ä¸ªthreadlocalsæˆå‘˜å˜é‡ï¼ŒæŒ‡å‘å¯¹åº”çš„ThreadLocalMap ï¼Œç„¶åä»¥newå‡ºæ¥çš„å¼•ç”¨ä½œä¸ºkeyï¼Œå’Œç»™å®šçš„valueä¸€å—ä¿å­˜èµ·æ¥ã€‚ å½“å¤–éƒ¨å¼•ç”¨è§£é™¤ä»¥åï¼Œå¯¹åº”çš„ThreadLocalå¯¹è±¡ç”±äºè¢«å†…éƒ¨ThreadLocalMap å¼•ç”¨ï¼Œä¸ä¼šGCï¼Œå¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„éœ²ã€‚ JVMè§£å†³çš„åŠæ³• static class Entry extends WeakReference&lt;ThreadLocal&lt;?&gt;&gt; { /** The value associated with this ThreadLocal. */ Object value; Entry(ThreadLocal&lt;?&gt; k, Object v) { super(k); value = v; } } ç»§æ‰¿äº†ä¸€ä¸ªè½¯å¼•ç”¨ï¼Œåœ¨ç³»ç»Ÿè¿›è¡Œgcçš„æ—¶å€™å°±å¯ä»¥å›æ”¶ ä½†æ˜¯å›æ”¶ä»¥åï¼Œkeyå˜æˆnullï¼Œvalueä¹Ÿæ— æ³•è¢«è®¿é—®åˆ°ï¼Œè¿˜æ˜¯å¯èƒ½å­˜åœ¨å†…å­˜æ³„éœ²ã€‚ å› æ­¤ä¸€æ—¦ä¸ç”¨äº†ï¼Œå¿…é¡»å¯¹é‡Œé¢çš„keyvalueå¯¹removeæ‰ï¼Œå¦åˆ™å°±ä¼šæœ‰å†…å­˜æ³„éœ²ï¼›è€Œä¸”åœ¨threadlocalæºç é‡Œé¢ï¼Œåœ¨æ¯æ¬¡getæˆ–è€…setçš„æ—¶å€™ä¼šæ¸…æ¥šé‡Œé¢keyä¸ºvalueçš„è®°å½• ","link":"https://tianxiawuhao.github.io/Y9SH6oPXI/"},{"title":"å·¥å…·ç±»","content":"å·¥å…·ç±» HttpUtil import cn.hutool.json.JSONObject; import cn.hutool.json.JSONUtil; import dt.logincenter.exception.BusinessException; import dt.logincenter.exception.basic.ResponseCode; import lombok.extern.slf4j.Slf4j; import org.springframework.http.*; import org.springframework.stereotype.Component; import org.springframework.web.client.RestTemplate; import javax.annotation.PostConstruct; import javax.annotation.Resource; import java.util.Iterator; import java.util.Map; @Component @Slf4j public class HttpUtil { @Resource private RestTemplate restTemplate; private static HttpUtil httpUtil; @PostConstruct public void init(){ httpUtil = this; httpUtil.restTemplate = this.restTemplate; } /** * å‘é€è¯·æ±‚Getè¯·æ±‚ * * @param url è¯·æ±‚æ¥å£ * @param param è¯·æ±‚å‚æ•° * @param paramType è¯·æ±‚å‚æ•°ç±»å‹ jsonï¼šfalse Stringï¼štrue */ public JSONObject sendGet(String url, String param, boolean paramType) throws Exception { JSONObject jsonObject = null; try { //è®¾ç½®è¯·æ±‚å¤´ HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); ResponseEntity&lt;String&gt; resEntity = null; if (!paramType) { HttpEntity httpEntity = new HttpEntity&lt;&gt;(param, headers); resEntity = restTemplate.exchange(url, HttpMethod.GET, httpEntity, String.class); }else { HttpEntity httpEntity = new HttpEntity&lt;&gt;(headers); resEntity = restTemplate.exchange(url, HttpMethod.GET, httpEntity, String.class, param); } jsonObject = JSONUtil.parseObj(resEntity.getBody()); } catch (Exception e) { if (e.toString().contains(&quot;timed out&quot;)) { throw new BusinessException(ResponseCode.CONNECTION_TIMEOUT); } log.error(&quot;æ¥å£è°ƒç”¨å¤±è´¥{}&quot;,e); throw new BusinessException(ResponseCode.GETDATA_FAIL); } return jsonObject; } /** * å‘é€è¯·æ±‚Getè¯·æ±‚ * * @param url è¯·æ±‚æ¥å£ * @param params è¯·æ±‚å‚æ•° */ public JSONObject sendGet(String url, Map&lt;Object, Object&gt; params){ StringBuffer stringBuffer = new StringBuffer(url); if (params instanceof Map) { Iterator iterator = ((Map) params).entrySet().iterator(); if (iterator.hasNext()) { stringBuffer.append(&quot;?&quot;); Object element; while (iterator.hasNext()) { element = iterator.next(); Map.Entry&lt;String, Object&gt; entry = (Map.Entry) element; if (entry.getValue() != null) { stringBuffer.append(element).append(&quot;&amp;&quot;); } url = stringBuffer.substring(0, stringBuffer.length() - 1); } } } else { throw new BusinessException(ResponseCode.REQUEST_PARAM_ERROR); } JSONObject jsonObject = null; try { //è®¾ç½®è¯·æ±‚å¤´ HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); ResponseEntity&lt;String&gt; resEntity = null; HttpEntity httpEntity = new HttpEntity&lt;&gt;(headers); resEntity = restTemplate.exchange(url, HttpMethod.GET, httpEntity, String.class); jsonObject = JSONUtil.parseObj(resEntity.getBody()); } catch (Exception e) { if (e.toString().contains(&quot;timed out&quot;)) { throw new BusinessException(ResponseCode.CONNECTION_TIMEOUT); } log.error(&quot;æ¥å£è°ƒç”¨å¤±è´¥{}&quot;,e); throw new BusinessException(ResponseCode.GETDATA_FAIL); } return jsonObject; } /** * å‘é€è¯·æ±‚Putè¯·æ±‚ * * @param url è¯·æ±‚æ¥å£ * @param param è¯·æ±‚å‚æ•° */ public JSONObject sendPut(String url, JSONObject param) { JSONObject jsonObject = null; try { //è®¾ç½®è¯·æ±‚å¤´ HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); HttpEntity httpEntity = new HttpEntity&lt;&gt;(param, headers); ResponseEntity&lt;String&gt; resEntity = restTemplate.exchange(url, HttpMethod.PUT, httpEntity, String.class); jsonObject = JSONUtil.parseObj(resEntity.getBody()); } catch (Exception e) { if (e.toString().contains(&quot;timed out&quot;)) { throw new BusinessException(String.valueOf(ResponseCode.CONNECTION_TIMEOUT)); } log.error(&quot;æ¥å£è°ƒç”¨å¤±è´¥{}&quot;,e); throw new BusinessException(String.valueOf(ResponseCode.GETDATA_FAIL)); } return jsonObject; } /** * å‘é€è¯·æ±‚Postè¯·æ±‚ * * @param url è¯·æ±‚æ¥å£ * @param param è¯·æ±‚å‚æ•° */ public JSONObject sendPost(String url, Object param) { JSONObject jsonObject = null; try { //è®¾ç½®è¯·æ±‚å¤´ HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); HttpEntity httpEntity = new HttpEntity&lt;&gt;(param, headers); jsonObject = restTemplate.postForObject(url, httpEntity, JSONObject.class); } catch (Exception e) { if (e.toString().contains(&quot;timed out&quot;)) { throw new BusinessException(String.valueOf(ResponseCode.CONNECTION_TIMEOUT)); } log.error(&quot;æ¥å£è°ƒç”¨å¤±è´¥{}&quot;,e); throw new BusinessException(String.valueOf(ResponseCode.GETDATA_FAIL)); } return jsonObject; } /** * å‘é€è¯·æ±‚Postè¯·æ±‚ * * @param url è¯·æ±‚æ¥å£ * @param param è¯·æ±‚å‚æ•° */ public JSONObject sendPost(String url, Object param,Map&lt;String,String&gt; header) { JSONObject jsonObject = null; try { //è®¾ç½®è¯·æ±‚å¤´ HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); header.keySet().forEach(item-&gt;{ headers.add(item,header.get(item)); }); HttpEntity httpEntity = new HttpEntity&lt;&gt;(param, headers); jsonObject = restTemplate.postForObject(url, httpEntity, JSONObject.class); } catch (Exception e) { if (e.toString().contains(&quot;timed out&quot;)) { throw new BusinessException(String.valueOf(ResponseCode.CONNECTION_TIMEOUT)); } log.error(&quot;æ¥å£è°ƒç”¨å¤±è´¥{}&quot;,e); throw new BusinessException(String.valueOf(ResponseCode.GETDATA_FAIL)); } return jsonObject; } /** * å‘é€è¯·æ±‚Getè¯·æ±‚è·å–æµæ–‡ä»¶ * * @param url è¯·æ±‚æ¥å£ */ public InputStream sendGet(String url) { try { String path=ResourceUtils.getURL(&quot;classpath:&quot;).getPath(); File file = new File(path); if (!file.exists()) { file.mkdirs(); } //åˆ›é€ æ–‡ä»¶ path=path+&quot;temp.excel&quot;; File tempFile = new File(path); if (!tempFile.exists()) { tempFile.createNewFile(); } ResponseEntity&lt;byte[]&gt; rsp = restTemplate.getForEntity(url, byte[].class); System.out.println(&quot;æ–‡ä»¶ä¸‹è½½è¯·æ±‚ç»“æœçŠ¶æ€ç ï¼š&quot; + rsp.getStatusCode()); // å°†ä¸‹è½½ä¸‹æ¥çš„æ–‡ä»¶å†…å®¹ä¿å­˜åˆ°æœ¬åœ° Files.write(Paths.get(path.substring(1)), Objects.requireNonNull(rsp.getBody(), &quot;æœªè·å–åˆ°ä¸‹è½½æ–‡ä»¶&quot;)); return new FileInputStream(path); } catch (Exception e) { if (e.toString().contains(&quot;timed out&quot;)) { throw new BusinessException(ResponseCode.CONNECTION_TIMEOUT); } log.error(&quot;æ¥å£è°ƒç”¨å¤±è´¥{}&quot;,e); throw new BusinessException(ResponseCode.GETDATA_FAIL); } } /** * å‘é€è¯·æ±‚Getè¯·æ±‚è·å–æµæ–‡ä»¶ * * @param url è¯·æ±‚æ¥å£ */ public InputStream sendGet(String url) { try { ResponseEntity&lt;byte[]&gt; entity = restTemplate.getForEntity(url, byte[].class); Objects.requireNonNull(entity.getBody()); String path=ResourceUtils.getURL(&quot;classpath:&quot;).getPath()+&quot;temp.excel&quot;; BufferedOutputStream bos; FileOutputStream fos; File file; File dir = new File(path); if (!dir.exists()) {// åˆ¤æ–­æ–‡ä»¶ç›®å½•æ˜¯å¦å­˜åœ¨ dir.mkdirs(); } file = new File(path); fos = new FileOutputStream(file); bos = new BufferedOutputStream(fos); bos.write(Objects.requireNonNull(entity.getBody())); bos.close(); fos.close(); return new FileInputStream(file); } catch (Exception e) { if (e.toString().contains(&quot;timed out&quot;)) { throw new BusinessException(ResponseCode.CONNECTION_TIMEOUT); } log.error(&quot;æ¥å£è°ƒç”¨å¤±è´¥{}&quot;,e); throw new BusinessException(ResponseCode.GETDATA_FAIL); } } } JavaScriptUtil import org.apache.tomcat.util.buf.StringUtils; import javax.script.*; import java.util.Map; import java.util.Set; /** * javaæ‰§è¡ŒjavaScriptä»£ç çš„å·¥å…·ç±» * * @author wuhao */ public class JavaScriptUtil { /** * å•ä¾‹çš„JavaScriptè§£æå¼•æ“ */ private static final ScriptEngine javaScriptEngine; static { ScriptEngineManager manager = new ScriptEngineManager(); ScriptEngine scriptEngine = manager.getEngineByName(&quot;js&quot;); if (scriptEngine == null) { throw new RuntimeException(&quot;è·å–JavaScriptè§£æå¼•æ“å¤±è´¥&quot;); } javaScriptEngine = scriptEngine; } /** * æ‰§è¡Œä¸€æ®µJavaScriptä»£ç  * * @param script JavaScriptçš„ä»£ç  * @return JavaScriptä»£ç è¿è¡Œç»“æœçš„å€¼ * @throws ScriptException JavaScriptä»£ç è¿è¡Œå¼‚å¸¸ */ public static Object execute(String script) throws ScriptException { return javaScriptEngine.eval(script); } /** * è¿è¡Œä¸€ä¸ªJavaScriptä»£ç æ®µ,å¹¶è·å–æŒ‡å®šå˜é‡åçš„å€¼ * * @param script ä»£ç æ®µ * @param attributeName å·²çŸ¥çš„å˜é‡å * @return æŒ‡å®šå˜é‡åå¯¹åº”çš„å€¼ * @throws ScriptException JavaScriptä»£ç è¿è¡Œå¼‚å¸¸ */ public static Object executeForAttribute(String script, String attributeName) throws ScriptException { javaScriptEngine.eval(script); return javaScriptEngine.getContext().getAttribute(attributeName); } /** * è·å–å½“å‰è¯­å¥è¿è¡Œåç¬¬ä¸€ä¸ªæœ‰å€¼å˜é‡çš„å€¼ * * @param script ä»£ç æ®µ * @return ç¬¬ä¸€ä¸ªæœ‰å€¼å˜é‡çš„å€¼ * @throws ScriptException JavaScriptä»£ç è¿è¡Œå¼‚å¸¸ */ public static Object executeForFirstAttribute(String script) throws ScriptException { //è¿™é‡Œé‡æ–°è·å–ä¸€ä¸ªJavaScriptè§£æå¼•æ“æ˜¯ä¸ºäº†é¿å…ä»£ç ä¸­æœ‰å…¶ä»–è°ƒç”¨å·¥å…·ç±»çš„åœ°æ–¹çš„å˜é‡å¹²æ‰° //é‡æ–°è·å–å,è¿™ä¸ªJavaScriptè§£æå¼•æ“åªæ‰§è¡Œäº†è¿™æ¬¡ä¼ å…¥çš„ä»£ç ,ä¸ä¼šä¿å­˜å…¶ä»–åœ°æ–¹çš„å˜é‡ //å…¨å±€çš„è§£æå™¨ä¸­ä¼šä¿å­˜æœ€å¤§200ä¸ªå˜é‡,JavaScriptè§£æå¼•æ“æœ¬èº«æœ€å¤§ä¿å­˜100ä¸ªå˜é‡ ScriptEngineManager manager = new ScriptEngineManager(); ScriptEngine scriptEngine = manager.getEngineByName(&quot;js&quot;); if (scriptEngine == null) { throw new RuntimeException(&quot;è·å–JavaScriptè§£æå¼•æ“å¤±è´¥&quot;); } scriptEngine.eval(script); ScriptContext context = scriptEngine.getContext(); if (context == null) { return null; } Bindings bindings = context.getBindings(ScriptContext.ENGINE_SCOPE); if (bindings == null) { return null; } Set&lt;Map.Entry&lt;String, Object&gt;&gt; entrySet = bindings.entrySet(); if (entrySet.isEmpty()) { return null; } for (Map.Entry&lt;String, Object&gt; entry : entrySet) { if (entry.getValue() != null) { return entry.getValue(); } } return null; } /** * æ‰§è¡Œä¸€æ®µJavaScriptä»£ç ï¼Œä¼ å…¥å‚æ•°ï¼Œè·å–è¿”å›å€¼ * String script = &quot;Math.pow(x, y)&quot;; * Map&lt;String, Object&gt; params = Maps.newHashMap(); * params.put(&quot;x&quot;, 10); * params.put(&quot;y&quot;, 2); * &lt;p&gt; * String script = â€if (company == 1) { * return true; * } else if (company == 2 &amp;&amp; amt &gt; 100) { * return true; * } else if (company == 3 &amp;&amp; amt &gt; 200) { * return true; * } else { * return false; * }â€œ * &lt;p&gt; * params.put(&quot;company&quot;, 1); * params.put(&quot;amt&quot;, 100); * * @param script * @param params * @return */ public static String execute(String script, Map&lt;String, Object&gt; params) { try { String paramsName = StringUtils.join(params.keySet(), ','); String executeScript = String.format(&quot;function execute(%s) { %s }&quot;, paramsName, script); javaScriptEngine.eval(executeScript); Invocable jsInvoke = (Invocable) javaScriptEngine; Object execute = jsInvoke.invokeFunction(&quot;execute&quot;, params.values().toArray()); return execute.toString(); } catch (ScriptException | NoSuchMethodException e) { System.out.println(&quot;è¡¨è¾¾å¼runtimeé”™è¯¯:&quot; + e.getMessage()); } return null; } } MinioUtil import io.minio.*; import io.minio.errors.*; import io.minio.http.Method; import io.minio.messages.Item; import io.minio.messages.Upload; import lombok.extern.slf4j.Slf4j; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.stereotype.Component; import org.springframework.util.StringUtils; import org.springframework.web.multipart.MultipartFile; import javax.crypto.SecretKey; import java.io.IOException; import java.io.InputStream; import java.security.InvalidKeyException; import java.security.NoSuchAlgorithmException; import java.util.ArrayList; import java.util.List; @Component @Slf4j public class MinioUtil { @Autowired private MinioClient minioClient; private static final int DEFAULT_EXPIRY_TIME = 7 * 24 * 3600; /** * æ£€æŸ¥å­˜å‚¨æ¡¶æ˜¯å¦å­˜åœ¨ * * @param bucketName å­˜å‚¨æ¡¶åç§° * @return * @throws Exception */ public boolean bucketExists(String bucketName) { try { return minioClient.bucketExists(BucketExistsArgs.builder().bucket(bucketName).build()); } catch (Exception e) { log.error(&quot;mino æœåŠ¡ç«¯è¿æ¥å¼‚å¸¸&quot;,e); throw new RuntimeException(&quot;mino æœåŠ¡ç«¯è¿æ¥å¼‚å¸¸&quot;); } } /** * åˆ›å»ºå­˜å‚¨æ¡¶ * * @param bucketName å­˜å‚¨æ¡¶åç§° * @return * @throws Exception */ public boolean makeBucket(String bucketName) throws Exception { boolean flag = bucketExists(bucketName); if (!flag) { minioClient.makeBucket(MakeBucketArgs.builder().bucket(bucketName).build()); return true; } return false; } /** * æ–‡ä»¶ä¸Šä¼  * * @param bucketName * @param multipartFile */ public void putObject(String bucketName, MultipartFile multipartFile, String filename, SecretKey secretKey) throws Exception { makeBucket(bucketName); PutObjectOptions putObjectOptions = new PutObjectOptions(multipartFile.getSize(), PutObjectOptions.MIN_MULTIPART_SIZE); putObjectOptions.setContentType(multipartFile.getContentType()); if (null != secretKey) { putObjectOptions.setSse(ServerSideEncryption.withCustomerKey(secretKey)); } minioClient.putObject(bucketName, filename, multipartFile.getInputStream(), putObjectOptions); } /** * æ™®é€šæ–‡ä»¶ä¸Šä¼  * @param bucketName * @param \\ */ public void putObject(String bucketName, InputStream inputStream, String filename, SecretKey secretKey,long fileSize) throws Exception { PutObjectOptions putObjectOptions = new PutObjectOptions(fileSize, 0); minioClient.putObject(bucketName, filename, inputStream, putObjectOptions); } /** * åˆ†äº«ã€‚ * * @param bucketName å­˜å‚¨æ¡¶åç§° * @param objectName å­˜å‚¨æ¡¶é‡Œçš„å¯¹è±¡åç§° * @param expires å¤±æ•ˆæ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ï¼Œé»˜è®¤æ˜¯7å¤©ï¼Œä¸å¾—å¤§äºä¸ƒå¤© * @return */ public String getPresignedObjectUrl(String bucketName, String objectName, Integer expires) throws Exception { boolean flag = bucketExists(bucketName); if (flag) { if (null == expires) { expires = DEFAULT_EXPIRY_TIME; } if (expires &lt; 1 || expires &gt; DEFAULT_EXPIRY_TIME) { throw new RuntimeException(&quot;expires must be in range of 1 to &quot; + DEFAULT_EXPIRY_TIME); } try { return minioClient.getPresignedObjectUrl(Method.GET, bucketName, objectName, expires, null); } catch (Exception e) { e.printStackTrace(); } } return null; } /** * è·å–ä¸€ä¸ªä¸´æ—¶å¯ä»¥ä¸Šä¼ çš„url * @param bucketName * @param objectName * @return * @throws Exception */ public String presignedPutObject(String bucketName, String objectName) { try { return minioClient.presignedPutObject(bucketName, objectName); } catch (Exception e) { throw new RuntimeException(&quot;è·å–ä¸´æ—¶æ–‡ä»¶ä¸Šä¼ åœ°å€å¼‚å¸¸&quot;); } } /** * åˆ—å‡ºæŸä¸ªå­˜å‚¨æ¡¶ä¸­çš„æ‰€æœ‰å¯¹è±¡ * * @param bucketName * @param objectNamePrefix å‰ç¼€ * @return * @throws Exception */ public List&lt;ComposeSource&gt; listObjectsSource(String bucketName, String objectNamePrefix) throws Exception { List&lt;ComposeSource&gt; sources = new ArrayList&lt;&gt;(); Iterable&lt;Result&lt;Item&gt;&gt; results = minioClient.listObjects(bucketName, objectNamePrefix); for (Result&lt;Item&gt; result : results) { Item item = result.get(); sources.add(ComposeSource.builder().bucket(bucketName).object(objectNamePrefix).build()); } // minioClient.listIncompleteUploads() return sources; } /** * æ–‡ä»¶åˆå¹¶ * * @param bucketName * @param objectName * @param sources * @param secretKey * @throws Exception */ public void composeObject(String bucketName, String objectName, List&lt;ComposeSource&gt; sources, SecretKey secretKey) throws Exception { List&lt;ComposeSource&gt; sourceObjectList = new ArrayList&lt;&gt;(sources.size()); for (int i=0;i&lt;sources.size();i++){ sourceObjectList.add( ComposeSource.builder() .bucket(bucketName) .object(sources.get(i).object()+&quot;_&quot; + i) .build() ); } ObjectWriteResponse objectWriteResponse = minioClient.composeObject( ComposeObjectArgs.builder() .bucket(bucketName) .object(objectName) .sources(sourceObjectList) .build()); for (ComposeSource source : sourceObjectList) { minioClient.removeObject(source.bucket(), source.object()); } } /** * æŸ¥è¯¢å·²ç»ä¸Šä¼ æˆåŠŸçš„æ–‡ä»¶ * @param bucketName * @param prefix */ public List&lt;Integer&gt; listIncompleteUploads(String bucketName,String prefix){ List&lt;Integer&gt; rslt=new ArrayList&lt;&gt;(); try { Iterable&lt;Result&lt;Item&gt;&gt; results=minioClient.listObjects( ListObjectsArgs.builder() .bucket(bucketName) .prefix(prefix) .maxKeys(1000) .build()); for (Result&lt;Item&gt; result : results) { String obectName = result.get().objectName(); String[] split = StringUtils.split(obectName, &quot;_&quot;); rslt.add(Integer.parseInt(split[split.length-1])); } }catch (Exception e) { log.error(&quot;è°ƒç”¨minioæŸ¥è¯¢å·²ç»åˆ†ç‰‡ä¸Šä¼ ä¿¡æ¯å¼‚å¸¸&quot;,e); throw new RuntimeException(&quot;è°ƒç”¨minioæŸ¥è¯¢å·²ç»åˆ†ç‰‡ä¸Šä¼ ä¿¡æ¯å¼‚å¸¸&quot;); } return rslt; } } ","link":"https://tianxiawuhao.github.io/uZBK7g699/"},{"title":"æ¶ˆæ¯æ¨é€çš„7ç§æ–¹æ¡ˆ","content":" ä»€ä¹ˆæ˜¯æ¶ˆæ¯æ¨é€ï¼ˆpushï¼‰ æ¨é€çš„åœºæ™¯æ¯”è¾ƒå¤šï¼Œæ¯”å¦‚æœ‰äººå…³æ³¨æˆ‘çš„å…¬ä¼—å·ï¼Œè¿™æ—¶æˆ‘å°±ä¼šæ”¶åˆ°ä¸€æ¡æ¨é€æ¶ˆæ¯ï¼Œä»¥æ­¤æ¥å¸å¼•æˆ‘ç‚¹å‡»æ‰“å¼€åº”ç”¨ã€‚ æ¶ˆæ¯æ¨é€(push)é€šå¸¸æ˜¯æŒ‡ç½‘ç«™çš„è¿è¥å·¥ä½œç­‰äººå‘˜ï¼Œé€šè¿‡æŸç§å·¥å…·å¯¹ç”¨æˆ·å½“å‰ç½‘é¡µæˆ–ç§»åŠ¨è®¾å¤‡APPè¿›è¡Œçš„ä¸»åŠ¨æ¶ˆæ¯æ¨é€ã€‚ æ¶ˆæ¯æ¨é€ä¸€èˆ¬åˆåˆ†ä¸ºwebç«¯æ¶ˆæ¯æ¨é€å’Œç§»åŠ¨ç«¯æ¶ˆæ¯æ¨é€ã€‚ webç«¯æ¶ˆæ¯æ¨é€å¸¸è§çš„è¯¸å¦‚ç«™å†…ä¿¡ã€æœªè¯»é‚®ä»¶æ•°é‡ã€ç›‘æ§æŠ¥è­¦æ•°é‡ç­‰ï¼Œåº”ç”¨çš„ä¹Ÿéå¸¸å¹¿æ³›ã€‚ åœ¨å…·ä½“å®ç°ä¹‹å‰ï¼Œå’±ä»¬å†æ¥åˆ†æä¸€ä¸‹å‰è¾¹çš„éœ€æ±‚ï¼Œå…¶å®åŠŸèƒ½å¾ˆç®€å•ï¼Œåªè¦è§¦å‘æŸä¸ªäº‹ä»¶ï¼ˆä¸»åŠ¨åˆ†äº«äº†èµ„æºæˆ–è€…åå°ä¸»åŠ¨æ¨é€æ¶ˆæ¯ï¼‰ï¼Œwebé¡µé¢çš„é€šçŸ¥å°çº¢ç‚¹å°±ä¼šå®æ—¶çš„+1å°±å¯ä»¥äº†ã€‚ é€šå¸¸åœ¨æœåŠ¡ç«¯ä¼šæœ‰è‹¥å¹²å¼ æ¶ˆæ¯æ¨é€è¡¨ï¼Œç”¨æ¥è®°å½•ç”¨æˆ·è§¦å‘ä¸åŒäº‹ä»¶æ‰€æ¨é€ä¸åŒç±»å‹çš„æ¶ˆæ¯ï¼Œå‰ç«¯ä¸»åŠ¨æŸ¥è¯¢ï¼ˆæ‹‰ï¼‰æˆ–è€…è¢«åŠ¨æ¥æ”¶ï¼ˆæ¨ï¼‰ç”¨æˆ·æ‰€æœ‰æœªè¯»çš„æ¶ˆæ¯æ•°ã€‚ æ¶ˆæ¯æ¨é€æ— éæ˜¯æ¨ï¼ˆpushï¼‰å’Œæ‹‰ï¼ˆpullï¼‰ä¸¤ç§å½¢å¼ï¼Œä¸‹è¾¹æˆ‘ä»¬é€ä¸ªäº†è§£ä¸‹ã€‚ çŸ­è½®è¯¢ è½®è¯¢(polling)åº”è¯¥æ˜¯å®ç°æ¶ˆæ¯æ¨é€æ–¹æ¡ˆä¸­æœ€ç®€å•çš„ä¸€ç§ï¼Œè¿™é‡Œæˆ‘ä»¬æš‚ä¸”å°†è½®è¯¢åˆ†ä¸ºçŸ­è½®è¯¢å’Œé•¿è½®è¯¢ã€‚ çŸ­è½®è¯¢å¾ˆå¥½ç†è§£ï¼ŒæŒ‡å®šçš„æ—¶é—´é—´éš”ï¼Œç”±æµè§ˆå™¨å‘æœåŠ¡å™¨å‘å‡ºHTTPè¯·æ±‚ï¼ŒæœåŠ¡å™¨å®æ—¶è¿”å›æœªè¯»æ¶ˆæ¯æ•°æ®ç»™å®¢æˆ·ç«¯ï¼Œæµè§ˆå™¨å†åšæ¸²æŸ“æ˜¾ç¤ºã€‚ ä¸€ä¸ªç®€å•çš„JSå®šæ—¶å™¨å°±å¯ä»¥æå®šï¼Œæ¯ç§’é’Ÿè¯·æ±‚ä¸€æ¬¡æœªè¯»æ¶ˆæ¯æ•°æ¥å£ï¼Œè¿”å›çš„æ•°æ®å±•ç¤ºå³å¯ã€‚ setInterval(() =&gt; { // æ–¹æ³•è¯·æ±‚ messageCount().then((res) =&gt; { if (res.code === 200) { this.messageCount = res.data } }) }, 1000); æ•ˆæœè¿˜æ˜¯å¯ä»¥çš„ï¼ŒçŸ­è½®è¯¢å®ç°å›ºç„¶ç®€å•ï¼Œç¼ºç‚¹ä¹Ÿæ˜¯æ˜¾è€Œæ˜“è§ï¼Œç”±äºæ¨é€æ•°æ®å¹¶ä¸ä¼šé¢‘ç¹å˜æ›´ï¼Œæ— è®ºåç«¯æ­¤æ—¶æ˜¯å¦æœ‰æ–°çš„æ¶ˆæ¯äº§ç”Ÿï¼Œå®¢æˆ·ç«¯éƒ½ä¼šè¿›è¡Œè¯·æ±‚ï¼ŒåŠ¿å¿…ä¼šå¯¹æœåŠ¡ç«¯é€ æˆå¾ˆå¤§å‹åŠ›ï¼Œæµªè´¹å¸¦å®½å’ŒæœåŠ¡å™¨èµ„æºã€‚ é•¿è½®è¯¢ é•¿è½®è¯¢æ˜¯å¯¹ä¸Šè¾¹çŸ­è½®è¯¢çš„ä¸€ç§æ”¹è¿›ç‰ˆæœ¬ï¼Œåœ¨å°½å¯èƒ½å‡å°‘å¯¹æœåŠ¡å™¨èµ„æºæµªè´¹çš„åŒæ—¶ï¼Œä¿è¯æ¶ˆæ¯çš„ç›¸å¯¹å®æ—¶æ€§ã€‚é•¿è½®è¯¢åœ¨ä¸­é—´ä»¶ä¸­åº”ç”¨çš„å¾ˆå¹¿æ³›ï¼Œæ¯”å¦‚Nacoså’Œapolloé…ç½®ä¸­å¿ƒï¼Œæ¶ˆæ¯é˜Ÿåˆ—kafkaã€RocketMQä¸­éƒ½æœ‰ç”¨åˆ°é•¿è½®è¯¢ã€‚ [nocasé•¿è½®è¯¢](nocasé•¿è½®è¯¢ | tianxia (tinaxiawuhao.github.io))ä¸€æ–‡ä¸­æˆ‘è¯¦ç»†ä»‹ç»è¿‡Nacosé•¿è½®è¯¢çš„å®ç°åŸç†ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥ç…ç…ã€‚ è¿™æ¬¡æˆ‘ä½¿ç”¨apolloé…ç½®ä¸­å¿ƒå®ç°é•¿è½®è¯¢çš„æ–¹å¼ï¼Œåº”ç”¨äº†ä¸€ä¸ªç±»DeferredResultï¼Œå®ƒæ˜¯åœ¨servelet3.0åç»è¿‡Springå°è£…æä¾›çš„ä¸€ç§å¼‚æ­¥è¯·æ±‚æœºåˆ¶ï¼Œç›´æ„å°±æ˜¯å»¶è¿Ÿç»“æœã€‚ DeferredResultå¯ä»¥å…è®¸å®¹å™¨çº¿ç¨‹å¿«é€Ÿé‡Šæ”¾å ç”¨çš„èµ„æºï¼Œä¸é˜»å¡è¯·æ±‚çº¿ç¨‹ï¼Œä»¥æ­¤æ¥å—æ›´å¤šçš„è¯·æ±‚æå‡ç³»ç»Ÿçš„ååé‡ï¼Œç„¶åå¯åŠ¨å¼‚æ­¥å·¥ä½œçº¿ç¨‹å¤„ç†çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¤„ç†å®Œæˆè°ƒç”¨DeferredResult.setResult(200)æäº¤å“åº”ç»“æœã€‚ ä¸‹è¾¹æˆ‘ä»¬ç”¨é•¿è½®è¯¢æ¥å®ç°æ¶ˆæ¯æ¨é€ã€‚ å› ä¸ºä¸€ä¸ªIDå¯èƒ½ä¼šè¢«å¤šä¸ªé•¿è½®è¯¢è¯·æ±‚ç›‘å¬ï¼Œæ‰€ä»¥æˆ‘é‡‡ç”¨äº†guavaåŒ…æä¾›çš„Multimapç»“æ„å­˜æ”¾é•¿è½®è¯¢ï¼Œä¸€ä¸ªkeyå¯ä»¥å¯¹åº”å¤šä¸ªvalueã€‚ä¸€æ—¦ç›‘å¬åˆ°keyå‘ç”Ÿå˜åŒ–ï¼Œå¯¹åº”çš„æ‰€æœ‰é•¿è½®è¯¢éƒ½ä¼šå“åº”ã€‚å‰ç«¯å¾—åˆ°éè¯·æ±‚è¶…æ—¶çš„çŠ¶æ€ç ï¼ŒçŸ¥æ™“æ•°æ®å˜æ›´ï¼Œä¸»åŠ¨æŸ¥è¯¢æœªè¯»æ¶ˆæ¯æ•°æ¥å£ï¼Œæ›´æ–°é¡µé¢æ•°æ®ã€‚ @Controller @RequestMapping(&quot;/polling&quot;) public class PollingController { // å­˜æ”¾ç›‘å¬æŸä¸ªIdçš„é•¿è½®è¯¢é›†åˆ // çº¿ç¨‹åŒæ­¥ç»“æ„ public static Multimap&lt;String, DeferredResult&lt;String&gt;&gt; watchRequests = Multimaps.synchronizedMultimap(HashMultimap.create()); /** * è®¾ç½®ç›‘å¬ */ @GetMapping(path = &quot;watch/{id}&quot;) @ResponseBody public DeferredResult&lt;String&gt; watch(@PathVariable String id) { // å»¶è¿Ÿå¯¹è±¡è®¾ç½®è¶…æ—¶æ—¶é—´ DeferredResult&lt;String&gt; deferredResult = new DeferredResult&lt;&gt;(TIME_OUT); // å¼‚æ­¥è¯·æ±‚å®Œæˆæ—¶ç§»é™¤ keyï¼Œé˜²æ­¢å†…å­˜æº¢å‡º deferredResult.onCompletion(() -&gt; { watchRequests.remove(id, deferredResult); }); // æ³¨å†Œé•¿è½®è¯¢è¯·æ±‚ watchRequests.put(id, deferredResult); return deferredResult; } /** * å˜æ›´æ•°æ® */ @GetMapping(path = &quot;publish/{id}&quot;) @ResponseBody public String publish(@PathVariable String id) { // æ•°æ®å˜æ›´ å–å‡ºç›‘å¬IDçš„æ‰€æœ‰é•¿è½®è¯¢è¯·æ±‚ï¼Œå¹¶ä¸€ä¸€å“åº”å¤„ç† if (watchRequests.containsKey(id)) { Collection&lt;DeferredResult&lt;String&gt;&gt; deferredResults = watchRequests.get(id); for (DeferredResult&lt;String&gt; deferredResult : deferredResults) { deferredResult.setResult(&quot;æˆ‘æ›´æ–°äº†&quot; + new Date()); } } return &quot;success&quot;; } å½“è¯·æ±‚è¶…è¿‡è®¾ç½®çš„è¶…æ—¶æ—¶é—´ï¼Œä¼šæŠ›å‡ºAsyncRequestTimeoutExceptionå¼‚å¸¸ï¼Œè¿™é‡Œç›´æ¥ç”¨@ControllerAdviceå…¨å±€æ•è·ç»Ÿä¸€è¿”å›å³å¯ï¼Œå‰ç«¯è·å–çº¦å®šå¥½çš„çŠ¶æ€ç åå†æ¬¡å‘èµ·é•¿è½®è¯¢è¯·æ±‚ï¼Œå¦‚æ­¤å¾€å¤è°ƒç”¨ã€‚ @ControllerAdvice public class AsyncRequestTimeoutHandler { @ResponseStatus(HttpStatus.NOT_MODIFIED) @ResponseBody @ExceptionHandler(AsyncRequestTimeoutException.class) public String asyncRequestTimeoutHandler(AsyncRequestTimeoutException e) { System.out.println(&quot;å¼‚æ­¥è¯·æ±‚è¶…æ—¶&quot;); return &quot;304&quot;; } } æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ï¼Œé¦–å…ˆé¡µé¢å‘èµ·é•¿è½®è¯¢è¯·æ±‚/polling/watch/10086ç›‘å¬æ¶ˆæ¯æ›´å˜ï¼Œè¯·æ±‚è¢«æŒ‚èµ·ï¼Œä¸å˜æ›´æ•°æ®ç›´è‡³è¶…æ—¶ï¼Œå†æ¬¡å‘èµ·äº†é•¿è½®è¯¢è¯·æ±‚ï¼›ç´§æ¥ç€æ‰‹åŠ¨å˜æ›´æ•°æ®/polling/publish/10086ï¼Œé•¿è½®è¯¢å¾—åˆ°å“åº”ï¼Œå‰ç«¯å¤„ç†ä¸šåŠ¡é€»è¾‘å®Œæˆåå†æ¬¡å‘èµ·è¯·æ±‚ï¼Œå¦‚æ­¤å¾ªç¯å¾€å¤ã€‚ é•¿è½®è¯¢ç›¸æ¯”äºçŸ­è½®è¯¢åœ¨æ€§èƒ½ä¸Šæå‡äº†å¾ˆå¤šï¼Œä½†ä¾ç„¶ä¼šäº§ç”Ÿè¾ƒå¤šçš„è¯·æ±‚ï¼Œè¿™æ˜¯å®ƒçš„ä¸€ç‚¹ä¸å®Œç¾çš„åœ°æ–¹ã€‚ iframeæµ iframeæµå°±æ˜¯åœ¨é¡µé¢ä¸­æ’å…¥ä¸€ä¸ªéšè—çš„&lt;iframe&gt;æ ‡ç­¾ï¼Œé€šè¿‡åœ¨srcä¸­è¯·æ±‚æ¶ˆæ¯æ•°é‡APIæ¥å£ï¼Œç”±æ­¤åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´åˆ›å»ºä¸€æ¡é•¿è¿æ¥ï¼ŒæœåŠ¡ç«¯æŒç»­å‘iframeä¼ è¾“æ•°æ®ã€‚ ä¼ è¾“çš„æ•°æ®é€šå¸¸æ˜¯HTMLã€æˆ–æ˜¯å†…åµŒçš„javascriptè„šæœ¬ï¼Œæ¥è¾¾åˆ°å®æ—¶æ›´æ–°é¡µé¢çš„æ•ˆæœã€‚ è¿™ç§æ–¹å¼å®ç°ç®€å•ï¼Œå‰ç«¯åªè¦ä¸€ä¸ª&lt;iframe&gt;æ ‡ç­¾æå®šäº† &lt;iframe src=&quot;/iframe/message&quot; style=&quot;display:none&quot;&gt;&lt;/iframe&gt; æœåŠ¡ç«¯ç›´æ¥ç»„è£…htmlã€jsè„šæœ¬æ•°æ®å‘responseå†™å…¥å°±è¡Œäº† @Controller @RequestMapping(&quot;/iframe&quot;) public class IframeController { @GetMapping(path = &quot;message&quot;) public void message(HttpServletResponse response) throws IOException, InterruptedException { while (true) { response.setHeader(&quot;Pragma&quot;, &quot;no-cache&quot;); response.setDateHeader(&quot;Expires&quot;, 0); response.setHeader(&quot;Cache-Control&quot;, &quot;no-cache,no-store&quot;); response.setStatus(HttpServletResponse.SC_OK); response.getWriter().print(&quot; &lt;script type=\\&quot;text/javascript\\&quot;&gt;\\n&quot; + &quot;parent.document.getElementById('clock').innerHTML = \\&quot;&quot; + count.get() + &quot;\\&quot;;&quot; + &quot;parent.document.getElementById('count').innerHTML = \\&quot;&quot; + count.get() + &quot;\\&quot;;&quot; + &quot;&lt;/script&gt;&quot;); } } } ä½†æˆ‘ä¸ªäººä¸æ¨èï¼Œå› ä¸ºå®ƒåœ¨æµè§ˆå™¨ä¸Šä¼šæ˜¾ç¤ºè¯·æ±‚æœªåŠ è½½å®Œï¼Œå›¾æ ‡ä¼šä¸åœæ—‹è½¬ï¼Œç®€ç›´æ˜¯å¼ºè¿«ç—‡æ€æ‰‹ã€‚ SSE (æˆ‘çš„æ–¹å¼) å¾ˆå¤šäººå¯èƒ½ä¸çŸ¥é“ï¼ŒæœåŠ¡ç«¯å‘å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯ï¼Œå…¶å®é™¤äº†å¯ä»¥ç”¨WebSocketè¿™ç§è€³ç†Ÿèƒ½è¯¦çš„æœºåˆ¶å¤–ï¼Œè¿˜æœ‰ä¸€ç§æœåŠ¡å™¨å‘é€äº‹ä»¶(Server-sent events)ï¼Œç®€ç§°SSEã€‚ SSEå®ƒæ˜¯åŸºäºHTTPåè®®çš„ï¼Œæˆ‘ä»¬çŸ¥é“ä¸€èˆ¬æ„ä¹‰ä¸Šçš„HTTPåè®®æ˜¯æ— æ³•åšåˆ°æœåŠ¡ç«¯ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯çš„ï¼Œä½†SSEæ˜¯ä¸ªä¾‹å¤–ï¼Œå®ƒå˜æ¢äº†ä¸€ç§æ€è·¯ã€‚ SSEåœ¨æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´æ‰“å¼€ä¸€ä¸ªå•å‘é€šé“ï¼ŒæœåŠ¡ç«¯å“åº”çš„ä¸å†æ˜¯ä¸€æ¬¡æ€§çš„æ•°æ®åŒ…è€Œæ˜¯text/event-streamç±»å‹çš„æ•°æ®æµä¿¡æ¯ï¼Œåœ¨æœ‰æ•°æ®å˜æ›´æ—¶ä»æœåŠ¡å™¨æµå¼ä¼ è¾“åˆ°å®¢æˆ·ç«¯ã€‚ æ•´ä½“çš„å®ç°æ€è·¯æœ‰ç‚¹ç±»ä¼¼äºåœ¨çº¿è§†é¢‘æ’­æ”¾ï¼Œè§†é¢‘æµä¼šè¿ç»­ä¸æ–­çš„æ¨é€åˆ°æµè§ˆå™¨ï¼Œä½ ä¹Ÿå¯ä»¥ç†è§£æˆï¼Œå®¢æˆ·ç«¯åœ¨å®Œæˆä¸€æ¬¡ç”¨æ—¶å¾ˆé•¿ï¼ˆç½‘ç»œä¸ç•…ï¼‰çš„ä¸‹è½½ã€‚ SSEä¸WebSocketä½œç”¨ç›¸ä¼¼ï¼Œéƒ½å¯ä»¥å»ºç«‹æœåŠ¡ç«¯ä¸æµè§ˆå™¨ä¹‹é—´çš„é€šä¿¡ï¼Œå®ç°æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯ï¼Œä½†è¿˜æ˜¯æœ‰äº›è®¸ä¸åŒï¼š SSE æ˜¯åŸºäºHTTPåè®®çš„ï¼Œå®ƒä»¬ä¸éœ€è¦ç‰¹æ®Šçš„åè®®æˆ–æœåŠ¡å™¨å®ç°å³å¯å·¥ä½œï¼›WebSocketéœ€å•ç‹¬æœåŠ¡å™¨æ¥å¤„ç†åè®®ã€‚ SSE å•å‘é€šä¿¡ï¼Œåªèƒ½ç”±æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å•å‘é€šä¿¡ï¼›webSocketå…¨åŒå·¥é€šä¿¡ï¼Œå³é€šä¿¡çš„åŒæ–¹å¯ä»¥åŒæ—¶å‘é€å’Œæ¥å—ä¿¡æ¯ã€‚ SSE å®ç°ç®€å•å¼€å‘æˆæœ¬ä½ï¼Œæ— éœ€å¼•å…¥å…¶ä»–ç»„ä»¶ï¼›WebSocketä¼ è¾“æ•°æ®éœ€åšäºŒæ¬¡è§£æï¼Œå¼€å‘é—¨æ§›é«˜ä¸€äº›ã€‚ SSE é»˜è®¤æ”¯æŒæ–­çº¿é‡è¿ï¼›WebSocketåˆ™éœ€è¦è‡ªå·±å®ç°ã€‚ SSE åªèƒ½ä¼ é€æ–‡æœ¬æ¶ˆæ¯ï¼ŒäºŒè¿›åˆ¶æ•°æ®éœ€è¦ç»è¿‡ç¼–ç åä¼ é€ï¼›WebSocketé»˜è®¤æ”¯æŒä¼ é€äºŒè¿›åˆ¶æ•°æ®ã€‚ SSE ä¸ WebSocket è¯¥å¦‚ä½•é€‰æ‹©ï¼Ÿ æŠ€æœ¯å¹¶æ²¡æœ‰å¥½åä¹‹åˆ†ï¼Œåªæœ‰å“ªä¸ªæ›´åˆé€‚ SSEå¥½åƒä¸€ç›´ä¸è¢«å¤§å®¶æ‰€ç†ŸçŸ¥ï¼Œä¸€éƒ¨åˆ†åŸå› æ˜¯å‡ºç°äº†WebSocketsï¼Œè¿™ä¸ªæä¾›äº†æ›´ä¸°å¯Œçš„åè®®æ¥æ‰§è¡ŒåŒå‘ã€å…¨åŒå·¥é€šä¿¡ã€‚å¯¹äºæ¸¸æˆã€å³æ—¶é€šä¿¡ä»¥åŠéœ€è¦åŒå‘è¿‘ä¹å®æ—¶æ›´æ–°çš„åœºæ™¯ï¼Œæ‹¥æœ‰åŒå‘é€šé“æ›´å…·å¸å¼•åŠ›ã€‚ ä½†æ˜¯ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸éœ€è¦ä»å®¢æˆ·ç«¯å‘é€æ•°æ®ã€‚è€Œä½ åªéœ€è¦ä¸€äº›æœåŠ¡å™¨æ“ä½œçš„æ›´æ–°ã€‚æ¯”å¦‚ï¼šç«™å†…ä¿¡ã€æœªè¯»æ¶ˆæ¯æ•°ã€çŠ¶æ€æ›´æ–°ã€è‚¡ç¥¨è¡Œæƒ…ã€ç›‘æ§æ•°é‡ç­‰åœºæ™¯ï¼ŒSEEä¸ç®¡æ˜¯ä»å®ç°çš„éš¾æ˜“å’Œæˆæœ¬ä¸Šéƒ½æ›´åŠ æœ‰ä¼˜åŠ¿ã€‚æ­¤å¤–ï¼ŒSSE å…·æœ‰WebSocketsåœ¨è®¾è®¡ä¸Šç¼ºä¹çš„å¤šç§åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼šè‡ªåŠ¨é‡æ–°è¿æ¥ã€äº‹ä»¶IDå’Œå‘é€ä»»æ„äº‹ä»¶çš„èƒ½åŠ›ã€‚ å‰ç«¯åªéœ€è¿›è¡Œä¸€æ¬¡HTTPè¯·æ±‚ï¼Œå¸¦ä¸Šå”¯ä¸€IDï¼Œæ‰“å¼€äº‹ä»¶æµï¼Œç›‘å¬æœåŠ¡ç«¯æ¨é€çš„äº‹ä»¶å°±å¯ä»¥äº† &lt;script&gt; let source = null; let userId = 7777 if (window.EventSource) { // å»ºç«‹è¿æ¥ source = new EventSource('http://localhost:7777/sse/sub/'+userId); setMessageInnerHTML(&quot;è¿æ¥ç”¨æˆ·=&quot; + userId); /** * è¿æ¥ä¸€æ—¦å»ºç«‹ï¼Œå°±ä¼šè§¦å‘openäº‹ä»¶ * å¦ä¸€ç§å†™æ³•ï¼šsource.onopen = function (event) {} */ source.addEventListener('open', function (e) { setMessageInnerHTML(&quot;å»ºç«‹è¿æ¥ã€‚ã€‚ã€‚&quot;); }, false); /** * å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨å‘æ¥çš„æ•°æ® * å¦ä¸€ç§å†™æ³•ï¼šsource.onmessage = function (event) {} */ source.addEventListener('message', function (e) { setMessageInnerHTML(e.data); }); } else { setMessageInnerHTML(&quot;ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒSSE&quot;); } &lt;/script&gt; æœåŠ¡ç«¯çš„å®ç°æ›´ç®€å•ï¼Œåˆ›å»ºä¸€ä¸ªSseEmitterå¯¹è±¡æ”¾å…¥sseEmitterMapè¿›è¡Œç®¡ç† private static Map&lt;String, SseEmitter&gt; sseEmitterMap = new ConcurrentHashMap&lt;&gt;(); /** * åˆ›å»ºè¿æ¥ * * @date: 2022/7/12 14:51 */ public static SseEmitter connect(String userId) { try { // è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œ0è¡¨ç¤ºä¸è¿‡æœŸã€‚é»˜è®¤30ç§’ SseEmitter sseEmitter = new SseEmitter(0L); // æ³¨å†Œå›è°ƒ sseEmitter.onCompletion(completionCallBack(userId)); sseEmitter.onError(errorCallBack(userId)); sseEmitter.onTimeout(timeoutCallBack(userId)); sseEmitterMap.put(userId, sseEmitter); count.getAndIncrement(); return sseEmitter; } catch (Exception e) { log.info(&quot;åˆ›å»ºæ–°çš„sseè¿æ¥å¼‚å¸¸ï¼Œå½“å‰ç”¨æˆ·ï¼š{}&quot;, userId); } return null; } /** * ç»™æŒ‡å®šç”¨æˆ·å‘é€æ¶ˆæ¯ * * @date: 2022/7/12 14:51 */ public static void sendMessage(String userId, String message) { if (sseEmitterMap.containsKey(userId)) { try { sseEmitterMap.get(userId).send(message); } catch (IOException e) { log.error(&quot;ç”¨æˆ·[{}]æ¨é€å¼‚å¸¸:{}&quot;, userId, e.getMessage()); removeUser(userId); } } } æˆ‘ä»¬æ¨¡æ‹ŸæœåŠ¡ç«¯æ¨é€æ¶ˆæ¯ï¼Œçœ‹ä¸‹å®¢æˆ·ç«¯æ”¶åˆ°äº†æ¶ˆæ¯ï¼Œå’Œæˆ‘ä»¬é¢„æœŸçš„æ•ˆæœä¸€è‡´ã€‚ æ³¨æ„ï¼š SSEä¸æ”¯æŒIEæµè§ˆå™¨ï¼Œå¯¹å…¶ä»–ä¸»æµæµè§ˆå™¨å…¼å®¹æ€§åšçš„è¿˜ä¸é”™ã€‚ MQTT ä»€ä¹ˆæ˜¯ MQTTåè®®ï¼Ÿ MQTT å…¨ç§°(Message Queue Telemetry Transport)ï¼šä¸€ç§åŸºäºå‘å¸ƒ/è®¢é˜…ï¼ˆpublish/subscribeï¼‰æ¨¡å¼çš„è½»é‡çº§é€šè®¯åè®®ï¼Œé€šè¿‡è®¢é˜…ç›¸åº”çš„ä¸»é¢˜æ¥è·å–æ¶ˆæ¯ï¼Œæ˜¯ç‰©è”ç½‘ï¼ˆInternet of Thingï¼‰ä¸­çš„ä¸€ä¸ªæ ‡å‡†ä¼ è¾“åè®®ã€‚ è¯¥åè®®å°†æ¶ˆæ¯çš„å‘å¸ƒè€…ï¼ˆpublisherï¼‰ä¸è®¢é˜…è€…ï¼ˆsubscriberï¼‰è¿›è¡Œåˆ†ç¦»ï¼Œå› æ­¤å¯ä»¥åœ¨ä¸å¯é çš„ç½‘ç»œç¯å¢ƒä¸­ï¼Œä¸ºè¿œç¨‹è¿æ¥çš„è®¾å¤‡æä¾›å¯é çš„æ¶ˆæ¯æœåŠ¡ï¼Œä½¿ç”¨æ–¹å¼ä¸ä¼ ç»Ÿçš„MQæœ‰ç‚¹ç±»ä¼¼ã€‚ TCPåè®®ä½äºä¼ è¾“å±‚ï¼ŒMQTT åè®®ä½äºåº”ç”¨å±‚ï¼ŒMQTT åè®®æ„å»ºäºTCP/IPåè®®ä¸Šï¼Œä¹Ÿå°±æ˜¯è¯´åªè¦æ”¯æŒTCP/IPåè®®æ ˆçš„åœ°æ–¹ï¼Œéƒ½å¯ä»¥ä½¿ç”¨MQTTåè®®ã€‚ ä¸ºä»€ä¹ˆè¦ç”¨ MQTTåè®®ï¼Ÿ MQTTåè®®ä¸ºä»€ä¹ˆåœ¨ç‰©è”ç½‘ï¼ˆIOTï¼‰ä¸­å¦‚æ­¤å—åçˆ±ï¼Ÿè€Œä¸æ˜¯å…¶å®ƒåè®®ï¼Œæ¯”å¦‚æˆ‘ä»¬æ›´ä¸ºç†Ÿæ‚‰çš„ HTTPåè®®å‘¢ï¼Ÿ é¦–å…ˆHTTPåè®®å®ƒæ˜¯ä¸€ç§åŒæ­¥åè®®ï¼Œå®¢æˆ·ç«¯è¯·æ±‚åéœ€è¦ç­‰å¾…æœåŠ¡å™¨çš„å“åº”ã€‚è€Œåœ¨ç‰©è”ç½‘ï¼ˆIOTï¼‰ç¯å¢ƒä¸­ï¼Œè®¾å¤‡ä¼šå¾ˆå—åˆ¶äºç¯å¢ƒçš„å½±å“ï¼Œæ¯”å¦‚å¸¦å®½ä½ã€ç½‘ç»œå»¶è¿Ÿé«˜ã€ç½‘ç»œé€šä¿¡ä¸ç¨³å®šç­‰ï¼Œæ˜¾ç„¶å¼‚æ­¥æ¶ˆæ¯åè®®æ›´ä¸ºé€‚åˆIOTåº”ç”¨ç¨‹åºã€‚ HTTPæ˜¯å•å‘çš„ï¼Œå¦‚æœè¦è·å–æ¶ˆæ¯å®¢æˆ·ç«¯å¿…é¡»å‘èµ·è¿æ¥ï¼Œè€Œåœ¨ç‰©è”ç½‘ï¼ˆIOTï¼‰åº”ç”¨ç¨‹åºä¸­ï¼Œè®¾å¤‡æˆ–ä¼ æ„Ÿå™¨å¾€å¾€éƒ½æ˜¯å®¢æˆ·ç«¯ï¼Œè¿™æ„å‘³ç€å®ƒä»¬æ— æ³•è¢«åŠ¨åœ°æ¥æ”¶æ¥è‡ªç½‘ç»œçš„å‘½ä»¤ã€‚ é€šå¸¸éœ€è¦å°†ä¸€æ¡å‘½ä»¤æˆ–è€…æ¶ˆæ¯ï¼Œå‘é€åˆ°ç½‘ç»œä¸Šçš„æ‰€æœ‰è®¾å¤‡ä¸Šã€‚HTTPè¦å®ç°è¿™æ ·çš„åŠŸèƒ½ä¸ä½†å¾ˆå›°éš¾ï¼Œè€Œä¸”æˆæœ¬æé«˜ã€‚ Websocket websocketåº”è¯¥æ˜¯å¤§å®¶éƒ½æ¯”è¾ƒç†Ÿæ‚‰çš„ä¸€ç§å®ç°æ¶ˆæ¯æ¨é€çš„æ–¹å¼ï¼Œä¸Šè¾¹æˆ‘ä»¬åœ¨è®²SSEçš„æ—¶å€™ä¹Ÿå’Œwebsocketè¿›è¡Œè¿‡æ¯”è¾ƒã€‚ WebSocketæ˜¯ä¸€ç§åœ¨TCPè¿æ¥ä¸Šè¿›è¡Œå…¨åŒå·¥é€šä¿¡çš„åè®®ï¼Œå»ºç«‹å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡æ¸ é“ã€‚æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä»…éœ€ä¸€æ¬¡æ¡æ‰‹ï¼Œä¸¤è€…ä¹‹é—´å°±ç›´æ¥å¯ä»¥åˆ›å»ºæŒä¹…æ€§çš„è¿æ¥ï¼Œå¹¶è¿›è¡ŒåŒå‘æ•°æ®ä¼ è¾“ã€‚ springbootæ•´åˆwebsocketï¼Œå…ˆå¼•å…¥websocketç›¸å…³çš„å·¥å…·åŒ…ï¼Œå’ŒSSEç›¸æ¯”é¢å¤–çš„å¼€å‘æˆæœ¬ã€‚ &lt;!-- å¼•å…¥websocket --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-websocket&lt;/artifactId&gt; &lt;/dependency&gt; æœåŠ¡ç«¯ä½¿ç”¨@ServerEndpointæ³¨è§£æ ‡æ³¨å½“å‰ç±»ä¸ºä¸€ä¸ªwebsocketæœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ws://localhost:7777/webSocket/10086æ¥è¿æ¥åˆ°WebSocketæœåŠ¡å™¨ç«¯ã€‚ @Component @Slf4j @ServerEndpoint(&quot;/websocket/{userId}&quot;) public class WebSocketServer { //ä¸æŸä¸ªå®¢æˆ·ç«¯çš„è¿æ¥ä¼šè¯ï¼Œéœ€è¦é€šè¿‡å®ƒæ¥ç»™å®¢æˆ·ç«¯å‘é€æ•°æ® private Session session; private static final CopyOnWriteArraySet&lt;WebSocketServer&gt; webSockets = new CopyOnWriteArraySet&lt;&gt;(); // ç”¨æ¥å­˜åœ¨çº¿è¿æ¥æ•° private static final Map&lt;String, Session&gt; sessionPool = new HashMap&lt;String, Session&gt;(); /** * é“¾æ¥æˆåŠŸè°ƒç”¨çš„æ–¹æ³• */ @OnOpen public void onOpen(Session session, @PathParam(value = &quot;userId&quot;) String userId) { try { this.session = session; webSockets.add(this); sessionPool.put(userId, session); log.info(&quot;websocketæ¶ˆæ¯: æœ‰æ–°çš„è¿æ¥ï¼Œæ€»æ•°ä¸º:&quot; + webSockets.size()); } catch (Exception e) { } } /** * æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯åè°ƒç”¨çš„æ–¹æ³• */ @OnMessage public void onMessage(String message) { log.info(&quot;websocketæ¶ˆæ¯: æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯:&quot; + message); } /** * æ­¤ä¸ºå•ç‚¹æ¶ˆæ¯ */ public void sendOneMessage(String userId, String message) { Session session = sessionPool.get(userId); if (session != null &amp;&amp; session.isOpen()) { try { log.info(&quot;websocketæ¶ˆ: å•ç‚¹æ¶ˆæ¯:&quot; + message); session.getAsyncRemote().sendText(message); } catch (Exception e) { e.printStackTrace(); } } } } å‰ç«¯åˆå§‹åŒ–æ‰“å¼€WebSocketè¿æ¥ï¼Œå¹¶ç›‘å¬è¿æ¥çŠ¶æ€ï¼Œæ¥æ”¶æœåŠ¡ç«¯æ•°æ®æˆ–å‘æœåŠ¡ç«¯å‘é€æ•°æ®ã€‚ &lt;script&gt; var ws = new WebSocket('ws://localhost:7777/webSocket/10086'); // è·å–è¿æ¥çŠ¶æ€ console.log('wsè¿æ¥çŠ¶æ€ï¼š' + ws.readyState); //ç›‘å¬æ˜¯å¦è¿æ¥æˆåŠŸ ws.onopen = function () { console.log('wsè¿æ¥çŠ¶æ€ï¼š' + ws.readyState); //è¿æ¥æˆåŠŸåˆ™å‘é€ä¸€ä¸ªæ•°æ® ws.send('test1'); } // æ¥å¬æœåŠ¡å™¨å‘å›çš„ä¿¡æ¯å¹¶å¤„ç†å±•ç¤º ws.onmessage = function (data) { console.log('æ¥æ”¶åˆ°æ¥è‡ªæœåŠ¡å™¨çš„æ¶ˆæ¯ï¼š'); console.log(data); //å®Œæˆé€šä¿¡åå…³é—­WebSocketè¿æ¥ ws.close(); } // ç›‘å¬è¿æ¥å…³é—­äº‹ä»¶ ws.onclose = function () { // ç›‘å¬æ•´ä¸ªè¿‡ç¨‹ä¸­websocketçš„çŠ¶æ€ console.log('wsè¿æ¥çŠ¶æ€ï¼š' + ws.readyState); } // ç›‘å¬å¹¶å¤„ç†erroräº‹ä»¶ ws.onerror = function (error) { console.log(error); } function sendMessage() { var content = $(&quot;#message&quot;).val(); $.ajax({ url: '/socket/publish?userId=10086&amp;message=' + content, type: 'GET', data: { &quot;id&quot;: &quot;7777&quot;, &quot;content&quot;: content }, success: function (data) { console.log(data) } }) } &lt;/script&gt; é¡µé¢åˆå§‹åŒ–å»ºç«‹websocketè¿æ¥ï¼Œä¹‹åå°±å¯ä»¥è¿›è¡ŒåŒå‘é€šä¿¡äº†ï¼Œæ•ˆæœè¿˜ä¸é”™ è‡ªå®šä¹‰æ¨é€ ä¸Šè¾¹æˆ‘ä»¬ç»™æˆ‘å‡ºäº†6ç§æ–¹æ¡ˆçš„åŸç†å’Œä»£ç å®ç°ï¼Œä½†åœ¨å®é™…ä¸šåŠ¡å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¸èƒ½ç›²ç›®çš„ç›´æ¥æ‹¿è¿‡æ¥ç”¨ï¼Œè¿˜æ˜¯è¦ç»“åˆè‡ªèº«ç³»ç»Ÿä¸šåŠ¡çš„ç‰¹ç‚¹å’Œå®é™…åœºæ™¯æ¥é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚ æ¨é€æœ€ç›´æ¥çš„æ–¹å¼å°±æ˜¯ä½¿ç”¨ç¬¬ä¸‰æ¨é€å¹³å°ï¼Œæ¯•ç«Ÿé’±èƒ½è§£å†³çš„éœ€æ±‚éƒ½ä¸æ˜¯é—®é¢˜ï¼Œæ— éœ€å¤æ‚çš„å¼€å‘è¿ç»´ï¼Œç›´æ¥å¯ä»¥ä½¿ç”¨ï¼Œçœæ—¶ã€çœåŠ›ã€çœå¿ƒï¼ŒåƒgoEasyã€æå…‰æ¨é€éƒ½æ˜¯å¾ˆä¸é”™çš„ä¸‰æ–¹æœåŠ¡å•†ã€‚ ä¸€èˆ¬å¤§å‹å…¬å¸éƒ½æœ‰è‡ªç ”çš„æ¶ˆæ¯æ¨é€å¹³å°ï¼Œåƒæˆ‘ä»¬æœ¬æ¬¡å®ç°çš„webç«™å†…ä¿¡åªæ˜¯å¹³å°ä¸Šçš„ä¸€ä¸ªè§¦ç‚¹è€Œå·²ï¼ŒçŸ­ä¿¡ã€é‚®ä»¶ã€å¾®ä¿¡å…¬ä¼—å·ã€å°ç¨‹åºå‡¡æ˜¯å¯ä»¥è§¦è¾¾åˆ°ç”¨æˆ·çš„æ¸ é“éƒ½å¯ä»¥æ¥å…¥è¿›æ¥ã€‚ æ¶ˆæ¯æ¨é€ç³»ç»Ÿå†…éƒ¨æ˜¯ç›¸å½“å¤æ‚çš„ï¼Œè¯¸å¦‚æ¶ˆæ¯å†…å®¹çš„ç»´æŠ¤å®¡æ ¸ã€åœˆå®šæ¨é€äººç¾¤ã€è§¦è¾¾è¿‡æ»¤æ‹¦æˆªï¼ˆæ¨é€çš„è§„åˆ™é¢‘æ¬¡ã€æ—¶æ®µã€æ•°é‡ã€é»‘ç™½åå•ã€å…³é”®è¯ç­‰ç­‰ï¼‰ã€æ¨é€å¤±è´¥è¡¥å¿éå¸¸å¤šçš„æ¨¡å—ï¼ŒæŠ€æœ¯ä¸Šæ¶‰åŠåˆ°å¤§æ•°æ®é‡ã€é«˜å¹¶å‘çš„åœºæ™¯ä¹Ÿå¾ˆå¤šã€‚æ‰€ä»¥æˆ‘ä»¬ä»Šå¤©çš„å®ç°æ–¹å¼åœ¨è¿™ä¸ªåºå¤§çš„ç³»ç»Ÿé¢å‰åªæ˜¯å°æ‰“å°é—¹ã€‚ ","link":"https://tianxiawuhao.github.io/GdjsuDFQV/"},{"title":"MQ æ¶ˆæ¯ä¸¢å¤±ã€é‡å¤ã€ç§¯å‹é—®é¢˜ï¼Œå¦‚ä½•è§£å†³","content":"é¢è¯•å®˜åœ¨é¢è¯•å€™é€‰äººæ—¶ï¼Œå¦‚æœå‘ç°å€™é€‰äººçš„ç®€å†ä¸­å†™äº†åœ¨é¡¹ç›®ä¸­ä½¿ç”¨äº† MQ æŠ€æœ¯ï¼ˆå¦‚ Kafkaã€RabbitMQã€RocketMQï¼‰ï¼ŒåŸºæœ¬éƒ½ä¼šæŠ›å‡ºä¸€ä¸ªé—®é¢˜ï¼šåœ¨ä½¿ç”¨ MQ çš„æ—¶å€™ï¼Œæ€ä¹ˆç¡®ä¿æ¶ˆæ¯ 100% ä¸ä¸¢å¤±ï¼Ÿ è¿™ä¸ªé—®é¢˜åœ¨å®é™…å·¥ä½œä¸­å¾ˆå¸¸è§ï¼Œæ—¢èƒ½è€ƒå¯Ÿå€™é€‰è€…å¯¹äº MQ ä¸­é—´ä»¶æŠ€æœ¯çš„æŒæ¡ç¨‹åº¦ï¼Œåˆèƒ½å¾ˆå¥½åœ°åŒºåˆ†å€™é€‰äººçš„èƒ½åŠ›æ°´å¹³ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ä»è¿™ä¸ªé—®é¢˜å‡ºå‘ï¼Œæ¢è®¨ä½ åº”è¯¥æŒæ¡çš„åŸºç¡€çŸ¥è¯†å’Œç­”é¢˜æ€è·¯ï¼Œä»¥åŠå»¶ä¼¸çš„é¢è¯•è€ƒç‚¹ã€‚ æ¡ˆä¾‹èƒŒæ™¯ ä»¥äº¬ä¸œç³»ç»Ÿä¸ºä¾‹ï¼Œç”¨æˆ·åœ¨è´­ä¹°å•†å“æ—¶ï¼Œé€šå¸¸ä¼šé€‰æ‹©ç”¨äº¬è±†æŠµæ‰£ä¸€éƒ¨åˆ†çš„é‡‘é¢ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œäº¤æ˜“æœåŠ¡å’Œäº¬è±†æœåŠ¡é€šè¿‡ MQ æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œé€šä¿¡ã€‚åœ¨ä¸‹å•æ—¶ï¼Œäº¤æ˜“æœåŠ¡å‘é€â€œæ‰£å‡è´¦æˆ· X 100 ä¸ªäº¬è±†â€çš„æ¶ˆæ¯ç»™ MQ æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè€Œäº¬è±†æœåŠ¡åˆ™åœ¨æ¶ˆè´¹ç«¯æ¶ˆè´¹è¿™æ¡å‘½ä»¤ï¼Œå®ç°çœŸæ­£çš„æ‰£å‡æ“ä½œã€‚ é‚£åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä½ ä¼šé‡åˆ°ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ æ¡ˆä¾‹åˆ†æ è¦çŸ¥é“ï¼Œåœ¨äº’è”ç½‘é¢è¯•ä¸­ï¼Œå¼•å…¥ MQ æ¶ˆæ¯ä¸­é—´ä»¶æœ€ç›´æ¥çš„ç›®çš„æ˜¯ï¼šåšç³»ç»Ÿè§£è€¦åˆæµé‡æ§åˆ¶ï¼Œè¿½å…¶æ ¹æºè¿˜æ˜¯ä¸ºäº†è§£å†³äº’è”ç½‘ç³»ç»Ÿçš„é«˜å¯ç”¨å’Œé«˜æ€§èƒ½é—®é¢˜ã€‚ ç³»ç»Ÿè§£è€¦ï¼šç”¨ MQ æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¯ä»¥éš”ç¦»ç³»ç»Ÿä¸Šä¸‹æ¸¸ç¯å¢ƒå˜åŒ–å¸¦æ¥çš„ä¸ç¨³å®šå› ç´ ï¼Œæ¯”å¦‚äº¬è±†æœåŠ¡çš„ç³»ç»Ÿéœ€æ±‚æ— è®ºå¦‚ä½•å˜åŒ–ï¼Œäº¤æ˜“æœåŠ¡ä¸ç”¨åšä»»ä½•æ”¹å˜ï¼Œå³ä½¿å½“äº¬è±†æœåŠ¡å‡ºç°æ•…éšœï¼Œä¸»äº¤æ˜“æµç¨‹ä¹Ÿå¯ä»¥å°†äº¬è±†æœåŠ¡é™çº§ï¼Œå®ç°äº¤æ˜“æœåŠ¡å’Œäº¬è±†æœåŠ¡çš„è§£è€¦ï¼Œåšåˆ°äº†ç³»ç»Ÿçš„é«˜å¯ç”¨ã€‚ æµé‡æ§åˆ¶ï¼šé‡åˆ°ç§’æ€ç­‰æµé‡çªå¢çš„åœºæ™¯ï¼Œé€šè¿‡ MQ è¿˜å¯ä»¥å®ç°æµé‡çš„â€œå‰Šå³°å¡«è°·â€çš„ä½œç”¨ï¼Œå¯ä»¥æ ¹æ®ä¸‹æ¸¸çš„å¤„ç†èƒ½åŠ›è‡ªåŠ¨è°ƒèŠ‚æµé‡ã€‚ ä¸è¿‡å¼•å…¥ MQ è™½ç„¶å®ç°äº†ç³»ç»Ÿè§£è€¦åˆæµé‡æ§åˆ¶ï¼Œä¹Ÿä¼šå¸¦æ¥å…¶ä»–é—®é¢˜ã€‚ å¼•å…¥ MQ æ¶ˆæ¯ä¸­é—´ä»¶å®ç°ç³»ç»Ÿè§£è€¦ï¼Œä¼šå½±å“ç³»ç»Ÿä¹‹é—´æ•°æ®ä¼ è¾“çš„ä¸€è‡´æ€§ã€‚ åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¦‚æœä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´å­˜åœ¨æ•°æ®åŒæ­¥ï¼Œå°±ä¼šå¸¦æ¥æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ã€‚åŒç†ï¼Œåœ¨è¿™ä¸€è®²ä½ è¦è§£å†³çš„å°±æ˜¯ï¼šæ¶ˆæ¯ç”Ÿäº§ç«¯å’Œæ¶ˆæ¯æ¶ˆè´¹ç«¯çš„æ¶ˆæ¯æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼ˆä¹Ÿå°±æ˜¯å¦‚ä½•ç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±ï¼‰ã€‚ è€Œå¼•å…¥ MQ æ¶ˆæ¯ä¸­é—´ä»¶è§£å†³æµé‡æ§åˆ¶ï¼Œ ä¼šä½¿æ¶ˆè´¹ç«¯å¤„ç†èƒ½åŠ›ä¸è¶³ä»è€Œå¯¼è‡´æ¶ˆæ¯ç§¯å‹ï¼Œè¿™ä¹Ÿæ˜¯ä½ è¦è§£å†³çš„é—®é¢˜ã€‚ æ‰€ä»¥ä½ èƒ½å‘ç°ï¼Œé—®é¢˜ä¸é—®é¢˜ä¹‹é—´å¾€å¾€æ˜¯ç¯ç¯ç›¸æ‰£çš„ï¼Œé¢è¯•å®˜ä¼šå€Ÿæœºè€ƒå¯Ÿä½ è§£å†³é—®é¢˜æ€è·¯çš„è¿è´¯æ€§å’ŒçŸ¥è¯†ä½“ç³»çš„æŒæ¡ç¨‹åº¦ã€‚ é‚£é¢å¯¹â€œåœ¨ä½¿ç”¨ MQ æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œå¦‚ä½•ç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±â€è¿™ä¸ªé—®é¢˜æ—¶ï¼Œä½ è¦æ€ä¹ˆå›ç­”å‘¢ï¼Ÿé¦–å…ˆï¼Œä½ è¦åˆ†æå…¶ä¸­æœ‰å‡ ä¸ªè€ƒç‚¹ï¼Œæ¯”å¦‚ï¼š å¦‚ä½•çŸ¥é“æœ‰æ¶ˆæ¯ä¸¢å¤±ï¼Ÿ å“ªäº›ç¯èŠ‚å¯èƒ½ä¸¢æ¶ˆæ¯ï¼Ÿ å¦‚ä½•ç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Ÿ å€™é€‰äººåœ¨å›ç­”æ—¶ï¼Œè¦å…ˆè®©é¢è¯•å®˜çŸ¥é“ä½ çš„åˆ†ææ€è·¯ï¼Œç„¶åå†æä¾›è§£å†³æ–¹æ¡ˆï¼šç½‘ç»œä¸­çš„æ•°æ®ä¼ è¾“ä¸å¯é ï¼Œæƒ³è¦è§£å†³å¦‚ä½•ä¸ä¸¢æ¶ˆæ¯çš„é—®é¢˜ï¼Œé¦–å…ˆè¦çŸ¥é“å“ªäº›ç¯èŠ‚å¯èƒ½ä¸¢æ¶ˆæ¯ï¼Œä»¥åŠæˆ‘ä»¬å¦‚ä½•çŸ¥é“æ¶ˆæ¯æ˜¯å¦ä¸¢å¤±äº†ï¼Œæœ€åæ‰æ˜¯è§£å†³æ–¹æ¡ˆï¼ˆè€Œä¸æ˜¯ä¸Šæ¥å°±ç›´æ¥è¯´è‡ªå·±çš„è§£å†³æ–¹æ¡ˆï¼‰ã€‚ å°±å¥½æ¯”â€œæ¶æ„è®¾è®¡â€â€œæ¶æ„â€ä½“ç°äº†æ¶æ„å¸ˆçš„æ€è€ƒè¿‡ç¨‹ï¼Œè€Œâ€œè®¾è®¡â€æ‰æ˜¯æœ€åçš„è§£å†³æ–¹æ¡ˆï¼Œä¸¤è€…ç¼ºä¸€ä¸å¯ã€‚ æ¡ˆä¾‹è§£ç­” æˆ‘ä»¬é¦–å…ˆæ¥çœ‹æ¶ˆæ¯ä¸¢å¤±çš„ç¯èŠ‚ï¼Œä¸€æ¡æ¶ˆæ¯ä»ç”Ÿäº§åˆ°æ¶ˆè´¹å®Œæˆè¿™ä¸ªè¿‡ç¨‹ï¼Œå¯ä»¥åˆ’åˆ†ä¸‰ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«ä¸ºæ¶ˆæ¯ç”Ÿäº§é˜¶æ®µï¼Œæ¶ˆæ¯å­˜å‚¨é˜¶æ®µå’Œæ¶ˆæ¯æ¶ˆè´¹é˜¶æ®µã€‚ æ¶ˆæ¯ç”Ÿäº§é˜¶æ®µï¼š ä»æ¶ˆæ¯è¢«ç”Ÿäº§å‡ºæ¥ï¼Œç„¶åæäº¤ç»™ MQ çš„è¿‡ç¨‹ä¸­ï¼Œåªè¦èƒ½æ­£å¸¸æ”¶åˆ° MQ Broker çš„ ack ç¡®è®¤å“åº”ï¼Œå°±è¡¨ç¤ºå‘é€æˆåŠŸï¼Œæ‰€ä»¥åªè¦å¤„ç†å¥½è¿”å›å€¼å’Œå¼‚å¸¸ï¼Œè¿™ä¸ªé˜¶æ®µæ˜¯ä¸ä¼šå‡ºç°æ¶ˆæ¯ä¸¢å¤±çš„ã€‚ æ¶ˆæ¯å­˜å‚¨é˜¶æ®µï¼š è¿™ä¸ªé˜¶æ®µä¸€èˆ¬ä¼šç›´æ¥äº¤ç»™ MQ æ¶ˆæ¯ä¸­é—´ä»¶æ¥ä¿è¯ï¼Œä½†æ˜¯ä½ è¦äº†è§£å®ƒçš„åŸç†ï¼Œæ¯”å¦‚ Broker ä¼šåšå‰¯æœ¬ï¼Œä¿è¯ä¸€æ¡æ¶ˆæ¯è‡³å°‘åŒæ­¥ä¸¤ä¸ªèŠ‚ç‚¹å†è¿”å› ackã€‚ æ¶ˆæ¯æ¶ˆè´¹é˜¶æ®µï¼š æ¶ˆè´¹ç«¯ä» Broker ä¸Šæ‹‰å–æ¶ˆæ¯ï¼Œåªè¦æ¶ˆè´¹ç«¯åœ¨æ”¶åˆ°æ¶ˆæ¯åï¼Œä¸ç«‹å³å‘é€æ¶ˆè´¹ç¡®è®¤ç»™ Brokerï¼Œè€Œæ˜¯ç­‰åˆ°æ‰§è¡Œå®Œä¸šåŠ¡é€»è¾‘åï¼Œå†å‘é€æ¶ˆè´¹ç¡®è®¤ï¼Œä¹Ÿèƒ½ä¿è¯æ¶ˆæ¯çš„ä¸ä¸¢å¤±ã€‚ æ–¹æ¡ˆçœ‹ä¼¼ä¸‡æ— ä¸€å¤±ï¼Œæ¯ä¸ªé˜¶æ®µéƒ½èƒ½ä¿è¯æ¶ˆæ¯çš„ä¸ä¸¢å¤±ï¼Œä½†åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ•…éšœä¸å¯é¿å…ï¼Œä½œä¸ºæ¶ˆæ¯ç”Ÿäº§ç«¯ï¼Œä½ å¹¶ä¸èƒ½ä¿è¯ MQ æ˜¯ä¸æ˜¯å¼„ä¸¢äº†ä½ çš„æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…æ˜¯å¦æ¶ˆè´¹äº†ä½ çš„æ¶ˆæ¯ï¼Œæ‰€ä»¥ï¼Œæœ¬ç€ Design for Failure çš„è®¾è®¡åŸåˆ™ï¼Œä½ è¿˜æ˜¯éœ€è¦ä¸€ç§æœºåˆ¶ï¼Œæ¥ Check æ¶ˆæ¯æ˜¯å¦ä¸¢å¤±äº†ã€‚ ç´§æ¥ç€ï¼Œä½ è¿˜å¯ä»¥å‘é¢è¯•å®˜é˜è¿°æ€ä¹ˆè¿›è¡Œæ¶ˆæ¯æ£€æµ‹ï¼Ÿ æ€»ä½“æ–¹æ¡ˆè§£å†³æ€è·¯ä¸ºï¼šåœ¨æ¶ˆæ¯ç”Ÿäº§ç«¯ï¼Œç»™æ¯ä¸ªå‘å‡ºçš„æ¶ˆæ¯éƒ½æŒ‡å®šä¸€ä¸ªå…¨å±€å”¯ä¸€ IDï¼Œæˆ–è€…é™„åŠ ä¸€ä¸ªè¿ç»­é€’å¢çš„ç‰ˆæœ¬å·ï¼Œç„¶ååœ¨æ¶ˆè´¹ç«¯åšå¯¹åº”çš„ç‰ˆæœ¬æ ¡éªŒã€‚ å…·ä½“æ€ä¹ˆè½åœ°å®ç°å‘¢ï¼Ÿä½ å¯ä»¥åˆ©ç”¨æ‹¦æˆªå™¨æœºåˆ¶ã€‚ åœ¨ç”Ÿäº§ç«¯å‘é€æ¶ˆæ¯ä¹‹å‰ï¼Œé€šè¿‡æ‹¦æˆªå™¨å°†æ¶ˆæ¯ç‰ˆæœ¬å·æ³¨å…¥æ¶ˆæ¯ä¸­ï¼ˆç‰ˆæœ¬å·å¯ä»¥é‡‡ç”¨è¿ç»­é€’å¢çš„ ID ç”Ÿæˆï¼Œä¹Ÿå¯ä»¥é€šè¿‡åˆ†å¸ƒå¼å…¨å±€å”¯ä¸€ IDç”Ÿæˆï¼‰ã€‚ç„¶ååœ¨æ¶ˆè´¹ç«¯æ”¶åˆ°æ¶ˆæ¯åï¼Œå†é€šè¿‡æ‹¦æˆªå™¨æ£€æµ‹ç‰ˆæœ¬å·çš„è¿ç»­æ€§æˆ–æ¶ˆè´¹çŠ¶æ€ï¼Œè¿™æ ·å®ç°çš„å¥½å¤„æ˜¯æ¶ˆæ¯æ£€æµ‹çš„ä»£ç ä¸ä¼šä¾µå…¥åˆ°ä¸šåŠ¡ä»£ç ä¸­ï¼Œå¯ä»¥é€šè¿‡å•ç‹¬çš„ä»»åŠ¡æ¥å®šä½ä¸¢å¤±çš„æ¶ˆæ¯ï¼Œåšè¿›ä¸€æ­¥çš„æ’æŸ¥ã€‚ è¿™é‡Œéœ€è¦ä½ æ³¨æ„ï¼šå¦‚æœåŒæ—¶å­˜åœ¨å¤šä¸ªæ¶ˆæ¯ç”Ÿäº§ç«¯å’Œæ¶ˆæ¯æ¶ˆè´¹ç«¯ï¼Œé€šè¿‡ç‰ˆæœ¬å·é€’å¢çš„æ–¹å¼å°±å¾ˆéš¾å®ç°äº†ï¼Œå› ä¸ºä¸èƒ½ä¿è¯ç‰ˆæœ¬å·çš„å”¯ä¸€æ€§ï¼Œæ­¤æ—¶åªèƒ½é€šè¿‡å…¨å±€å”¯ä¸€ ID çš„æ–¹æ¡ˆæ¥è¿›è¡Œæ¶ˆæ¯æ£€æµ‹ï¼Œå…·ä½“çš„å®ç°åŸç†å’Œç‰ˆæœ¬å·é€’å¢çš„æ–¹å¼ä¸€è‡´ã€‚ ç°åœ¨ï¼Œä½ å·²ç»çŸ¥é“äº†å“ªäº›ç¯èŠ‚ï¼ˆæ¶ˆæ¯å­˜å‚¨é˜¶æ®µã€æ¶ˆæ¯æ¶ˆè´¹é˜¶æ®µï¼‰å¯èƒ½ä¼šå‡ºé—®é¢˜ï¼Œå¹¶æœ‰äº†å¦‚ä½•æ£€æµ‹æ¶ˆæ¯ä¸¢å¤±çš„æ–¹æ¡ˆï¼Œç„¶åå°±è¦ç»™å‡ºè§£å†³é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±çš„è®¾è®¡æ–¹æ¡ˆã€‚ å›ç­”å®Œâ€œå¦‚ä½•ç¡®ä¿æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼Ÿâ€ ä¹‹åï¼Œé¢è¯•å®˜é€šå¸¸ä¼šè¿½é—®â€œæ€ä¹ˆè§£å†³æ¶ˆæ¯è¢«é‡å¤æ¶ˆè´¹çš„é—®é¢˜ï¼Ÿ â€ æ¯”å¦‚ï¼šåœ¨æ¶ˆæ¯æ¶ˆè´¹çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‡ºç°å¤±è´¥çš„æƒ…å†µï¼Œé€šè¿‡è¡¥å¿çš„æœºåˆ¶å‘é€æ–¹ä¼šæ‰§è¡Œé‡è¯•ï¼Œé‡è¯•çš„è¿‡ç¨‹å°±æœ‰å¯èƒ½äº§ç”Ÿé‡å¤çš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ è¿™ä¸ªé—®é¢˜å…¶å®å¯ä»¥æ¢ä¸€ç§è¯´æ³•ï¼Œå°±æ˜¯å¦‚ä½•è§£å†³æ¶ˆè´¹ç«¯å¹‚ç­‰æ€§é—®é¢˜ï¼ˆå¹‚ç­‰æ€§ï¼Œå°±æ˜¯ä¸€æ¡å‘½ä»¤ï¼Œä»»æ„å¤šæ¬¡æ‰§è¡Œæ‰€äº§ç”Ÿçš„å½±å“å‡ä¸ä¸€æ¬¡æ‰§è¡Œçš„å½±å“ç›¸åŒï¼‰ï¼Œåªè¦æ¶ˆè´¹ç«¯å…·å¤‡äº†å¹‚ç­‰æ€§ï¼Œé‚£ä¹ˆé‡å¤æ¶ˆè´¹æ¶ˆæ¯çš„é—®é¢˜ä¹Ÿå°±è§£å†³äº†ã€‚ æˆ‘ä»¬è¿˜æ˜¯æ¥çœ‹æ‰£å‡äº¬è±†çš„ä¾‹å­ï¼Œå°†è´¦æˆ· X çš„é‡‘è±†ä¸ªæ•°æ‰£å‡ 100 ä¸ªï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ”¹é€ ä¸šåŠ¡é€»è¾‘ï¼Œè®©å®ƒå…·å¤‡å¹‚ç­‰æ€§ã€‚ æœ€ç®€å•çš„å®ç°æ–¹æ¡ˆï¼Œå°±æ˜¯åœ¨æ•°æ®åº“ä¸­å»ºä¸€å¼ æ¶ˆæ¯æ—¥å¿—è¡¨ï¼Œ è¿™ä¸ªè¡¨æœ‰ä¸¤ä¸ªå­—æ®µï¼šæ¶ˆæ¯ ID å’Œæ¶ˆæ¯æ‰§è¡ŒçŠ¶æ€ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬æ¶ˆè´¹æ¶ˆæ¯çš„é€»è¾‘å¯ä»¥å˜ä¸ºï¼šåœ¨æ¶ˆæ¯æ—¥å¿—è¡¨ä¸­å¢åŠ ä¸€æ¡æ¶ˆæ¯è®°å½•ï¼Œç„¶åå†æ ¹æ®æ¶ˆæ¯è®°å½•ï¼Œå¼‚æ­¥æ“ä½œæ›´æ–°ç”¨æˆ·äº¬è±†ä½™é¢ã€‚ å› ä¸ºæˆ‘ä»¬æ¯æ¬¡éƒ½ä¼šåœ¨æ’å…¥ä¹‹å‰æ£€æŸ¥æ˜¯å¦æ¶ˆæ¯å·²å­˜åœ¨ï¼Œæ‰€ä»¥å°±ä¸ä¼šå‡ºç°ä¸€æ¡æ¶ˆæ¯è¢«æ‰§è¡Œå¤šæ¬¡çš„æƒ…å†µï¼Œè¿™æ ·å°±å®ç°äº†ä¸€ä¸ªå¹‚ç­‰çš„æ“ä½œã€‚å½“ç„¶ï¼ŒåŸºäºè¿™ä¸ªæ€è·¯ï¼Œä¸ä»…å¯ä»¥ä½¿ç”¨å…³ç³»å‹æ•°æ®åº“ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Redis æ¥ä»£æ›¿æ•°æ®åº“å®ç°å”¯ä¸€çº¦æŸçš„æ–¹æ¡ˆã€‚ åœ¨è¿™é‡Œæˆ‘å¤šè¯´ä¸€å¥ï¼Œæƒ³è¦è§£å†³â€œæ¶ˆæ¯ä¸¢å¤±â€å’Œâ€œæ¶ˆæ¯é‡å¤æ¶ˆè´¹â€çš„é—®é¢˜ï¼Œæœ‰ä¸€ä¸ªå‰ææ¡ä»¶å°±æ˜¯è¦å®ç°ä¸€ä¸ªå…¨å±€å”¯ä¸€ ID ç”Ÿæˆçš„æŠ€æœ¯æ–¹æ¡ˆã€‚è¿™ä¹Ÿæ˜¯é¢è¯•å®˜å–œæ¬¢è€ƒå¯Ÿçš„é—®é¢˜ï¼Œä½ ä¹Ÿè¦æŒæ¡ã€‚ åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå…¨å±€å”¯ä¸€ ID ç”Ÿæˆçš„å®ç°æ–¹æ³•æœ‰æ•°æ®åº“è‡ªå¢ä¸»é”®ã€UUIDã€Redisï¼ŒTwitter-Snowflake ç®—æ³•ï¼Œæˆ‘æ€»ç»“äº†å‡ ç§æ–¹æ¡ˆçš„ç‰¹ç‚¹ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹ã€‚ æˆ‘æé†’ä½ æ³¨æ„ï¼Œæ— è®ºå“ªç§æ–¹æ³•ï¼Œå¦‚æœä½ æƒ³åŒæ—¶æ»¡è¶³ç®€å•ã€é«˜å¯ç”¨å’Œé«˜æ€§èƒ½ï¼Œå°±è¦æœ‰å–èˆï¼Œæ‰€ä»¥ä½ è¦ç«™åœ¨å®é™…çš„ä¸šåŠ¡ä¸­ï¼Œè¯´æ˜ä½ çš„é€‰å‹æ‰€è€ƒè™‘çš„å¹³è¡¡ç‚¹æ˜¯ä»€ä¹ˆã€‚ æˆ‘ä¸ªäººåœ¨ä¸šåŠ¡ä¸­æ¯”è¾ƒå€¾å‘äºé€‰æ‹© Snowflake ç®—æ³•ï¼Œåœ¨é¡¹ç›®ä¸­ä¹Ÿè¿›è¡Œäº†ä¸€å®šçš„æ”¹é€ ï¼Œä¸»è¦æ˜¯è®©ç®—æ³•ä¸­çš„ ID ç”Ÿæˆè§„åˆ™æ›´åŠ ç¬¦åˆä¸šåŠ¡ç‰¹ç‚¹ï¼Œä»¥åŠä¼˜åŒ–è¯¸å¦‚æ—¶é’Ÿå›æ‹¨ç­‰é—®é¢˜ã€‚ å½“ç„¶ï¼Œé™¤äº†â€œæ€ä¹ˆè§£å†³æ¶ˆæ¯è¢«é‡å¤æ¶ˆè´¹çš„é—®é¢˜ï¼Ÿâ€ä¹‹å¤–ï¼Œé¢è¯•å®˜è¿˜ä¼šé—®åˆ°ä½ â€œæ¶ˆæ¯ç§¯å‹â€ã€‚ åŸå› åœ¨äºæ¶ˆæ¯ç§¯å‹åæ˜ çš„æ˜¯æ€§èƒ½é—®é¢˜ï¼Œè§£å†³æ¶ˆæ¯ç§¯å‹é—®é¢˜ï¼Œå¯ä»¥è¯´æ˜å€™é€‰è€…æœ‰èƒ½åŠ›å¤„ç†é«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ¶ˆè´¹èƒ½åŠ›é—®é¢˜ã€‚ ä½ åœ¨è§£ç­”è¿™ä¸ªé—®é¢˜æ—¶ï¼Œä¾æ—§è¦ä¼ é€’ç»™é¢è¯•å®˜ä¸€ä¸ªè¿™æ ·çš„æ€è€ƒè¿‡ç¨‹ï¼š å¦‚æœå‡ºç°ç§¯å‹ï¼Œé‚£ä¸€å®šæ˜¯æ€§èƒ½é—®é¢˜ï¼Œæƒ³è¦è§£å†³æ¶ˆæ¯ä»ç”Ÿäº§åˆ°æ¶ˆè´¹ä¸Šçš„æ€§èƒ½é—®é¢˜ï¼Œå°±é¦–å…ˆè¦çŸ¥é“å“ªäº›ç¯èŠ‚å¯èƒ½å‡ºç°æ¶ˆæ¯ç§¯å‹ï¼Œç„¶ååœ¨è€ƒè™‘å¦‚ä½•è§£å†³ã€‚ å› ä¸ºæ¶ˆæ¯å‘é€ä¹‹åæ‰ä¼šå‡ºç°ç§¯å‹çš„é—®é¢˜ï¼Œæ‰€ä»¥å’Œæ¶ˆæ¯ç”Ÿäº§ç«¯æ²¡æœ‰å…³ç³»ï¼Œåˆå› ä¸ºç»å¤§éƒ¨åˆ†çš„æ¶ˆæ¯é˜Ÿåˆ—å•èŠ‚ç‚¹éƒ½èƒ½è¾¾åˆ°æ¯ç§’é’Ÿå‡ ä¸‡çš„å¤„ç†èƒ½åŠ›ï¼Œç›¸å¯¹äºä¸šåŠ¡é€»è¾‘æ¥è¯´ï¼Œæ€§èƒ½ä¸ä¼šå‡ºç°åœ¨ä¸­é—´ä»¶çš„æ¶ˆæ¯å­˜å‚¨ä¸Šé¢ã€‚æ¯«æ— ç–‘é—®ï¼Œå‡ºé—®é¢˜çš„è‚¯å®šæ˜¯æ¶ˆæ¯æ¶ˆè´¹é˜¶æ®µï¼Œé‚£ä¹ˆä»æ¶ˆè´¹ç«¯å…¥æ‰‹ï¼Œå¦‚ä½•å›ç­”å‘¢ï¼Ÿ å¦‚æœæ˜¯çº¿ä¸Šçªå‘é—®é¢˜ï¼Œè¦ä¸´æ—¶æ‰©å®¹ï¼Œå¢åŠ æ¶ˆè´¹ç«¯çš„æ•°é‡ï¼Œä¸æ­¤åŒæ—¶ï¼Œé™çº§ä¸€äº›éæ ¸å¿ƒçš„ä¸šåŠ¡ã€‚é€šè¿‡æ‰©å®¹å’Œé™çº§æ‰¿æ‹…æµé‡ï¼Œè¿™æ˜¯ä¸ºäº†è¡¨æ˜ä½ å¯¹åº”æ€¥é—®é¢˜çš„å¤„ç†èƒ½åŠ›ã€‚ å…¶æ¬¡ï¼Œæ‰æ˜¯æ’æŸ¥è§£å†³å¼‚å¸¸é—®é¢˜ï¼Œå¦‚é€šè¿‡ç›‘æ§ï¼Œæ—¥å¿—ç­‰æ‰‹æ®µåˆ†ææ˜¯å¦æ¶ˆè´¹ç«¯çš„ä¸šåŠ¡é€»è¾‘ä»£ç å‡ºç°äº†é—®é¢˜ï¼Œä¼˜åŒ–æ¶ˆè´¹ç«¯çš„ä¸šåŠ¡å¤„ç†é€»è¾‘ã€‚ æœ€åï¼Œå¦‚æœæ˜¯æ¶ˆè´¹ç«¯çš„å¤„ç†èƒ½åŠ›ä¸è¶³ï¼Œå¯ä»¥é€šè¿‡æ°´å¹³æ‰©å®¹æ¥æä¾›æ¶ˆè´¹ç«¯çš„å¹¶å‘å¤„ç†èƒ½åŠ›ï¼Œä½†è¿™é‡Œæœ‰ä¸€ä¸ªè€ƒç‚¹éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼Œ é‚£å°±æ˜¯åœ¨æ‰©å®¹æ¶ˆè´¹è€…çš„å®ä¾‹æ•°çš„åŒæ—¶ï¼Œå¿…é¡»åŒæ­¥æ‰©å®¹ä¸»é¢˜ Topic çš„åˆ†åŒºæ•°é‡ï¼Œç¡®ä¿æ¶ˆè´¹è€…çš„å®ä¾‹æ•°å’Œåˆ†åŒºæ•°ç›¸ç­‰ã€‚å¦‚æœæ¶ˆè´¹è€…çš„å®ä¾‹æ•°è¶…è¿‡äº†åˆ†åŒºæ•°ï¼Œç”±äºåˆ†åŒºæ˜¯å•çº¿ç¨‹æ¶ˆè´¹ï¼Œæ‰€ä»¥è¿™æ ·çš„æ‰©å®¹å°±æ²¡æœ‰æ•ˆæœã€‚ æ¯”å¦‚åœ¨ Kafka ä¸­ï¼Œä¸€ä¸ª Topic å¯ä»¥é…ç½®å¤šä¸ª Partitionï¼ˆåˆ†åŒºï¼‰ï¼Œæ•°æ®ä¼šè¢«å†™å…¥åˆ°å¤šä¸ªåˆ†åŒºä¸­ï¼Œä½†åœ¨æ¶ˆè´¹çš„æ—¶å€™ï¼ŒKafka çº¦å®šä¸€ä¸ªåˆ†åŒºåªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼ŒTopic çš„åˆ†åŒºæ•°é‡å†³å®šäº†æ¶ˆè´¹çš„èƒ½åŠ›ï¼Œæ‰€ä»¥ï¼Œå¯ä»¥é€šè¿‡å¢åŠ åˆ†åŒºæ¥æé«˜æ¶ˆè´¹è€…çš„å¤„ç†èƒ½åŠ›ã€‚ æ€»ç»“ è‡³æ­¤ï¼Œæˆ‘ä»¬è®²è§£äº† MQ æ¶ˆæ¯é˜Ÿåˆ—çš„çƒ­é—¨é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼Œæ— è®ºæ˜¯åˆä¸­çº§è¿˜æ˜¯é«˜çº§ç ”å‘å·¥ç¨‹å¸ˆï¼Œæœ¬ç¯‡æ–‡ç« çš„å†…å®¹éƒ½æ˜¯ä½ éœ€è¦æŒæ¡çš„ï¼Œä½ éƒ½å¯ä»¥ä»è¿™å‡ ç‚¹å‡ºå‘ï¼Œä¸é¢è¯•å®˜è¿›è¡Œå‹å¥½çš„äº¤æµã€‚æˆ‘æ¥æ€»ç»“ä¸€ä¸‹ä»Šå¤©çš„é‡ç‚¹å†…å®¹ã€‚ å¦‚ä½•ç¡®ä¿æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼Ÿ ä½ è¦çŸ¥é“ä¸€æ¡æ¶ˆæ¯ä»å‘é€åˆ°æ¶ˆè´¹çš„æ¯ä¸ªé˜¶æ®µï¼Œæ˜¯å¦å­˜åœ¨ä¸¢æ¶ˆæ¯ï¼Œä»¥åŠå¦‚ä½•ç›‘æ§æ¶ˆæ¯æ˜¯å¦ä¸¢å¤±ï¼Œæœ€åæ‰æ˜¯å¦‚ä½•è§£å†³é—®é¢˜ï¼Œæ–¹æ¡ˆå¯ä»¥åŸºäºâ€œ MQ çš„å¯é æ¶ˆæ¯æŠ•é€’ â€çš„æ–¹å¼ã€‚ å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹ï¼Ÿ åœ¨è¿›è¡Œæ¶ˆæ¯è¡¥å¿çš„æ—¶å€™ï¼Œä¸€å®šä¼šå­˜åœ¨é‡å¤æ¶ˆæ¯çš„æƒ…å†µï¼Œé‚£ä¹ˆå¦‚ä½•å®ç°æ¶ˆè´¹ç«¯çš„å¹‚ç­‰æ€§å°±è¿™é“é¢˜çš„è€ƒç‚¹ã€‚ å¦‚ä½•å¤„ç†æ¶ˆæ¯ç§¯å‹é—®é¢˜ï¼Ÿ è¿™é“é¢˜çš„è€ƒç‚¹å°±æ˜¯å¦‚ä½•é€šè¿‡ MQ å®ç°çœŸæ­£çš„é«˜æ€§èƒ½ï¼Œå›ç­”çš„æ€è·¯æ˜¯ï¼Œæœ¬ç€è§£å†³çº¿ä¸Šå¼‚å¸¸ä¸ºæœ€é«˜ä¼˜å…ˆçº§ï¼Œç„¶åé€šè¿‡ç›‘æ§å’Œæ—¥å¿—è¿›è¡Œæ’æŸ¥å¹¶ä¼˜åŒ–ä¸šåŠ¡é€»è¾‘ï¼Œæœ€åæ˜¯æ‰©å®¹æ¶ˆè´¹ç«¯å’Œåˆ†ç‰‡çš„æ•°é‡ã€‚ åœ¨å›ç­”é—®é¢˜çš„æ—¶å€™ï¼Œä½ éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œè®©é¢è¯•å®˜äº†è§£åˆ°ä½ çš„æ€ç»´è¿‡ç¨‹ï¼Œè¿™ç§è§£å†³é—®é¢˜çš„èƒ½åŠ›æ˜¯é¢è¯•å®˜æ›´ä¸ºçœ‹ä¸­çš„ï¼Œæ¯”ä½ ç›´æ¥å›ç­”ä¸€é“é¢è¯•é¢˜æ›´æœ‰ä»·å€¼ã€‚ å¦å¤–ï¼Œå¦‚æœä½ åº”è˜çš„éƒ¨é—¨æ˜¯åŸºç¡€æ¶æ„éƒ¨ï¼Œé‚£ä¹ˆé™¤äº†è¦æŒæ¡æœ¬è®²ä¸­çš„å¸¸è§é—®é¢˜çš„ä¸»çº¿çŸ¥è¯†ä»¥å¤–ï¼Œè¿˜è¦æŒæ¡æ¶ˆæ¯ä¸­é—´ä»¶çš„å…¶ä»–çŸ¥è¯†ä½“ç³»ï¼Œå¦‚ï¼š å¦‚ä½•é€‰å‹æ¶ˆæ¯ä¸­é—´ä»¶ï¼Ÿ æ¶ˆæ¯ä¸­é—´ä»¶ä¸­çš„é˜Ÿåˆ—æ¨¡å‹ä¸å‘å¸ƒè®¢é˜…æ¨¡å‹çš„åŒºåˆ«ï¼Ÿ ä¸ºä»€ä¹ˆæ¶ˆæ¯é˜Ÿåˆ—èƒ½å®ç°é«˜ååï¼Ÿ åºåˆ—åŒ–ã€ä¼ è¾“åè®®ï¼Œä»¥åŠå†…å­˜ç®¡ç†ç­‰é—®é¢˜ ","link":"https://tianxiawuhao.github.io/-GeRQ4Ed-/"},{"title":"æ¶ˆæ¯æœåŠ¡ï¼šMQä½¿ç”¨åœºæ™¯ä¸é€‰å‹å¯¹æ¯”","content":"MQçš„ä½¿ç”¨åœºæ™¯ï¼Œå¼•å…¥MQåçš„æ³¨æ„äº‹é¡¹ä»¥åŠMQçš„é€‰å‹å¯¹æ¯”ã€‚ MQçš„ä½¿ç”¨åœºæ™¯ MQçš„è‹±æ–‡å…¨ç§°æ˜¯Message Queueï¼Œç¿»è¯‘æˆä¸­æ–‡å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—å®ç°äº†å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„æ¶ˆæ¯æ¨¡å‹ã€‚é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°å¤šä¸ªè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ï¼Œä¾‹å¦‚ï¼Œå¯ä»¥å®ç°å¤šä¸ªå¾®æœåŠ¡ä¹‹é—´çš„æ¶ˆæ¯é€šä¿¡ã€‚MQçš„æœ€ç®€æ¨¡å‹å°±æ˜¯ç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯ï¼Œå°†æ¶ˆæ¯å‘é€åˆ°MQï¼Œæ¶ˆæ¯æ¶ˆè´¹è€…è®¢é˜…MQï¼Œæ¶ˆè´¹æ¶ˆæ¯ã€‚ MQçš„ä½¿ç”¨åœºæ™¯é€šå¸¸åŒ…å«ï¼šå¼‚æ­¥è§£è€¦ã€æµé‡å‰Šå³°ã€‚ å¼‚æ­¥è§£è€¦ å…³äºå¼‚æ­¥çš„åœºæ™¯ï¼Œæˆ‘ä»¬è¿™é‡Œä¸¾ä¸€ä¸ªç”¨æˆ·ä¸‹å•æˆåŠŸåï¼Œå‘ç”¨æˆ·å‘é€é€šçŸ¥æ¶ˆæ¯ï¼Œä¸ºç”¨æˆ·å¢åŠ ç§¯åˆ†å’Œä¼˜æƒ åˆ¸çš„åœºæ™¯ã€‚ åŒæ­¥è€¦åˆåœºæ™¯åˆ†æ å¦‚æœæ˜¯åŒæ­¥è°ƒç”¨çš„åœºæ™¯ï¼Œåˆ™å…·ä½“ä¸šåŠ¡ä¸ºï¼šå½“ç”¨æˆ·æäº¤è®¢å•æˆåŠŸåï¼Œè®¢å•ç³»ç»Ÿä¼šè°ƒç”¨é€šçŸ¥ç³»ç»Ÿä¸ºç”¨æˆ·å‘é€æ¶ˆæ¯é€šçŸ¥ï¼Œå‘ŠçŸ¥ç”¨æˆ·ä¸‹å•æˆåŠŸï¼Œè®¢å•ç³»ç»Ÿè°ƒç”¨ç§¯åˆ†ç³»ç»Ÿä¸ºç”¨æˆ·å¢åŠ ç§¯åˆ†ï¼Œè®¢å•ç³»ç»Ÿè°ƒç”¨ä¼˜æƒ åˆ¸ç³»ç»Ÿä¸ºç”¨æˆ·å¢åŠ ä¼˜æƒ åˆ¸ã€‚æ•´ä¸ªè°ƒç”¨æµç¨‹å¦‚ä¸‹æ‰€ç¤ºã€‚ é€šè¿‡ä¸Šå›¾çš„åˆ†æï¼Œå¯ä»¥çœ‹åˆ°ï¼Œç”¨æˆ·è°ƒç”¨è®¢å•ç³»ç»Ÿä¸‹å•æ—¶ï¼Œæ€»å…±ä¼šç»è¿‡8ä¸ªæ­¥éª¤ã€‚å¹¶ä¸”æ¯ä¸ªæ­¥éª¤éƒ½æ˜¯ç´§å¯†è€¦åˆåœ¨ä¸€èµ·ä¸²è¡Œæ‰§è¡Œï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ æ­¤æ—¶ï¼Œè®¢å•ç³»ç»Ÿã€é€šçŸ¥ç³»ç»Ÿã€ç§¯åˆ†ç³»ç»Ÿå’Œä¼˜æƒ åˆ¸ç³»ç»Ÿæ˜¯ç´§å¯†è€¦åˆåœ¨ä¸€èµ·çš„ï¼Œè®¢å•ç³»ç»Ÿä¸‹å•ã€é€šçŸ¥ç³»ç»Ÿå‘é€šçŸ¥ã€ç§¯åˆ†ç³»ç»Ÿå‘ç§¯åˆ†å’Œä¼˜æƒ åˆ¸ç³»ç»Ÿå‘ä¼˜æƒ åˆ¸ï¼Œå››ä¸ªä»»åŠ¡å…¨éƒ¨å®Œæˆåï¼Œæ‰ä¼šç»™ç”¨æˆ·è¿”å›æäº¤è®¢å•çš„ç»“æœä¿¡æ¯ã€‚ ç”¨æˆ·æäº¤è®¢å•èŠ±è´¹çš„æ€»æ—¶é—´ä¸ºè°ƒç”¨è®¢å•ç³»ç»Ÿä¸‹å•çš„æ—¶é—´+è®¢å•ç³»ç»Ÿè°ƒç”¨é€šçŸ¥ç³»ç»Ÿå‘é€é€šçŸ¥çš„æ—¶é—´+è®¢å•ç³»ç»Ÿè°ƒç”¨ç§¯åˆ†ç³»ç»Ÿå‘æ”¾ç§¯åˆ†çš„æ—¶é—´+è®¢å•ç³»ç»Ÿè°ƒç”¨ä¼˜æƒ åˆ¸ç³»ç»Ÿå‘æ”¾ä¼˜æƒ åˆ¸çš„æ—¶é—´ã€‚ æ³¨æ„ï¼šè¿™é‡Œä¸ºäº†æ›´å¥½çš„è¯´æ˜ç³»ç»Ÿä¹‹é—´ä¸²è¡Œæ‰§è¡Œçš„é—®é¢˜ï¼Œå¿½ç•¥äº†ç½‘ç»œçš„å»¶è¿Ÿæ—¶é—´ã€‚ è¿™ç§ä¸²è¡ŒåŒ–çš„ç³»ç»Ÿæ‰§è¡Œæ–¹å¼ï¼Œåœ¨é«˜å¹¶å‘ã€å¤§æµé‡åœºæ™¯ä¸‹æ˜¯ä¸å¯å–çš„ã€‚å¦å¤–ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªç³»ç»Ÿå¼‚å¸¸æˆ–è€…å®•æœºï¼ŒåŠ¿å¿…ä¼šå½±å“åˆ°è®¢å•ç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚åœ¨ç³»ç»Ÿç»´æŠ¤ä¸Šï¼Œåªè¦ä»»æ„ä¸€ä¸ªç³»ç»Ÿçš„æ¥å£å‘ç”Ÿå˜åŠ¨ï¼Œè®¢å•ç³»ç»Ÿçš„é€»è¾‘ä¹Ÿè¦è·Ÿç€å‘ç”Ÿå˜åŠ¨ã€‚ å¼‚æ­¥è§£è€¦åœºæ™¯åˆ†æ æ—¢ç„¶åœ¨é«˜å¹¶å‘ã€å¤§æµé‡åœºæ™¯ä¸‹ä½¿ç”¨è®¢å•ç³»ç»Ÿç›´æ¥ä¸²è¡Œè°ƒç”¨é€šçŸ¥ç³»ç»Ÿã€ç§¯åˆ†ç³»ç»Ÿå’Œä¼˜æƒ åˆ¸ç³»ç»Ÿçš„æ–¹å¼ä¸å¯å–ã€‚é‚£æˆ‘ä»¬æ˜¯å¦èƒ½å¤Ÿä½¿ç”¨å¼‚æ­¥è§£è€¦çš„æ–¹å¼å‘¢ã€‚ å…¶å®ï¼Œåœ¨ç”¨æˆ·æäº¤è®¢å•çš„åœºæ™¯ä¸­ï¼Œç”¨æˆ·æœ€å…³å¿ƒçš„æ˜¯è‡ªå·±çš„è®¢å•æ˜¯å¦æäº¤æˆåŠŸï¼Œç”±äºä¸‹å•æ—¶ï¼Œè®¢å•ç³»ç»Ÿä¼šç›´æ¥è¿”å›æ˜¯å¦ä¸‹å•æˆåŠŸçš„æç¤ºã€‚ å¯¹äºé€šçŸ¥ã€ç§¯åˆ†å’Œä¼˜æƒ åˆ¸å¯ä»¥ä»¥å¼‚æ­¥çš„æ–¹å¼å»¶åä¸€å°æ®µæ—¶é—´æ‰§è¡Œã€‚å¹¶ä¸”é€šçŸ¥ç³»ç»Ÿã€ç§¯åˆ†ç³»ç»Ÿå’Œä¼˜æƒ åˆ¸ç³»ç»Ÿä¹‹é—´ä¸å­˜åœ¨å¿…ç„¶çš„ä¸šåŠ¡å…³è”é€»è¾‘ï¼Œå®ƒä»¬ä¹‹é—´å¯ä»¥ä»¥å¹¶è¡Œçš„æ–¹å¼æ‰§è¡Œã€‚ æ‰€ä»¥ï¼Œå¯ä»¥ä½¿ç”¨MQå°†è®¢å•ç³»ç»Ÿä¸é€šçŸ¥ç³»ç»Ÿã€ç§¯åˆ†ç³»ç»Ÿå’Œä¼˜æƒ åˆ¸ç³»ç»Ÿè¿›è¡Œè§£è€¦ï¼Œç”¨æˆ·è°ƒç”¨è®¢å•ç³»ç»Ÿçš„æ¥å£ä¸‹å•æ—¶ï¼Œè®¢å•ç³»ç»Ÿå‘æ•°æ®åº“å†™å…¥è®¢å•æ•°æ®åï¼Œå‘MQå†™å…¥æ¶ˆæ¯ï¼Œå°±å¯ä»¥ç›´æ¥è¿”å›ç»™ç”¨æˆ·ä¸‹å•æˆåŠŸçš„æç¤ºï¼Œæ­¤æ—¶é€šçŸ¥ç³»ç»Ÿã€ç§¯åˆ†ç³»ç»Ÿå’Œä¼˜æƒ åˆ¸ç³»ç»Ÿéƒ½è®¢é˜…MQä¸­çš„æ¶ˆæ¯ï¼Œæ”¶åˆ°æ¶ˆæ¯åå„è‡ªæ‰§è¡Œè‡ªèº«çš„ä¸šåŠ¡é€»è¾‘å³å¯ã€‚ å½“å¼•å…¥MQè¿›è¡Œå¼‚æ­¥è§£è€¦ä¹‹åï¼Œç”¨æˆ·è°ƒç”¨è®¢å•ç³»ç»Ÿçš„æ¥å£ä¸‹å•ï¼Œè®¢å•ç³»ç»Ÿæ‰§è¡Œå®Œä¸šåŠ¡é€»è¾‘å°†è®¢å•æ•°æ®å…¥å£ï¼Œä¼šå‘MQå‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œéšåä¾¿ç›´æ¥è¿”å›ç”¨æˆ·ä¸‹å•æˆåŠŸçš„æç¤ºã€‚é€šçŸ¥ç³»ç»Ÿã€ç§¯åˆ†ç³»ç»Ÿå’Œä¼˜æƒ åˆ¸ç³»ç»Ÿä¼šåŒæ—¶è®¢é˜…MQä¸­çš„æ¶ˆæ¯ï¼Œå½“æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œå®ƒä»¬å„è‡ªä¼šæ‰§è¡Œè‡ªèº«çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¹¶ä¸”å®ƒä»¬æ˜¯ä»¥å¹¶è¡Œçš„æ–¹å¼æ‰§è¡Œå„è‡ªçš„ä¸šåŠ¡é€»è¾‘ã€‚ ä»æ‰§è¡Œçš„æ—¶é—´çº¿ä¸Šå¯ä»¥çœ‹å‡ºï¼Œå½“å¼•å…¥MQè¿›è¡Œå¼‚æ­¥è§£è€¦ä¹‹åï¼Œé€šçŸ¥ç³»ç»Ÿã€ç§¯åˆ†ç³»ç»Ÿã€ä¼˜æƒ åˆ¸ç³»ç»Ÿå’Œè®¢å•ç³»ç»Ÿå›å¤å“åº”éƒ½æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œå¤§å¤§æé«˜ç³»ç»Ÿçš„æ‰§è¡Œæ€§èƒ½ã€‚ å¹¶ä¸”è§£è€¦åï¼Œä»»æ„ä¸€ä¸ªç³»ç»Ÿå¼‚å¸¸æˆ–è€…å®•æœºï¼Œéƒ½ä¸ä¼šå½±å“åˆ°è®¢å•ç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚åªè¦è®¢å•ç³»ç»Ÿä¸å…¶ä»–ç³»ç»Ÿæå‰çº¦å®šå¥½å‘é€çš„æ¶ˆæ¯æ ¼å¼å’Œæ¶ˆæ¯å†…å®¹ï¼Œåç»­ä»»æ„ä¸€ä¸ªç³»ç»Ÿçš„ä¸šåŠ¡é€»è¾‘å˜åŠ¨ï¼Œå‡ ä¹éƒ½ä¸ä¼šå½±å“åˆ°è®¢å•ç³»ç»Ÿçš„é€»è¾‘ã€‚ æµé‡å‰Šå³° MQåœ¨é«˜å¹¶å‘ã€å¤§æµé‡çš„åœºæ™¯ä¸‹å¯ä»¥ç”¨ä½œå‰Šå³°å¡«è°·çš„åˆ©å™¨ï¼Œä¾‹å¦‚ï¼Œ12306çš„æ˜¥è¿æŠ¢ç¥¨åœºæ™¯ã€é«˜å¹¶å‘ç§’æ€åœºæ™¯ã€åŒåä¸€å’Œ618çš„å¤§ä¿ƒåœºæ™¯ç­‰ã€‚ åœ¨é«˜å¹¶å‘ã€å¤§æµé‡ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œç¬é—´ä¼šæœ‰å¤§é‡ç”¨æˆ·çš„è¯·æ±‚æ¶Œå…¥ç³»ç»Ÿï¼Œå¦‚æœä¸å¯¹è¿™äº›æµé‡åšå¤„ç†çš„è¯ï¼Œç›´æ¥è®©è¿™äº›æµé‡è¿›å…¥ä¸‹æ¸¸ç³»ç»Ÿï¼Œåˆ™å¾ˆå¯èƒ½ç”±äºä¸‹æ¸¸ç³»ç»Ÿæ— æ³•æ”¯æ’‘å¦‚æ­¤é«˜çš„å¹¶å‘è€Œå¯¼è‡´ç³»ç»Ÿå´©æºƒæˆ–å®•æœºã€‚ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œå¯ä»¥å¼•å…¥MQè¿›è¡Œæµé‡çš„å‰Šå³°å¡«è°·ã€‚ å°†æµé‡å‘é€åˆ°MQä¸­åï¼Œä¸‹æ¸¸ç³»ç»Ÿæ ¹æ®è‡ªèº«çš„å¤„ç†èƒ½åŠ›è¿›è¡Œæ¶ˆè´¹å³å¯ã€‚ä¿è¯äº†ä¸‹æ¸¸ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§ã€‚ å¼•å…¥MQåçš„æ³¨æ„äº‹é¡¹ å¼•å…¥MQæœ€å¤§çš„ä¼˜ç‚¹å°±æ˜¯å¼‚æ­¥è§£è€¦å’Œæµé‡å‰Šå³°ï¼Œä½†æ˜¯å¼•å…¥MQåä¹Ÿæœ‰å¾ˆå¤šéœ€è¦æ³¨æ„çš„äº‹é¡¹å’Œé—®é¢˜ï¼Œä¸»è¦åŒ…æ‹¬ï¼šç³»ç»Ÿçš„æ•´ä½“å¯ç”¨æ€§é™ä½ã€ç³»ç»Ÿçš„å¤æ‚åº¦å˜é«˜ã€å¼•å…¥äº†æ¶ˆæ¯ä¸€è‡´æ€§çš„é—®é¢˜ã€‚ ç³»ç»Ÿçš„æ•´ä½“å¯ç”¨æ€§é™ä½ åœ¨å¯¹ä¸€ä¸ªç³»ç»Ÿè¿›è¡Œæ¶æ„è®¾è®¡æ—¶ï¼Œå¼•å…¥çš„å¤–éƒ¨ä¾èµ–è¶Šå¤šï¼Œç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯ç”¨æ€§å°±ä¼šé™ä½ã€‚ç³»ç»Ÿä¸­å¼•å…¥äº†MQï¼Œéƒ¨åˆ†ä¸šåŠ¡å°±ä¼šå‡ºç°å¼ºä¾èµ–MQçš„ç°è±¡ï¼Œæ­¤æ—¶ï¼Œå¦‚æœMQå®•æœºï¼Œåˆ™éƒ¨åˆ†ä¸šåŠ¡å°±ä¼šå˜å¾—ä¸å¯ç”¨ã€‚æ‰€ä»¥ï¼Œå¼•å…¥MQæ—¶ï¼Œæˆ‘ä»¬å°±è¦è€ƒè™‘å¦‚ä½•å®ç°MQçš„é«˜å¯ç”¨ã€‚ ç³»ç»Ÿçš„å¤æ‚åº¦å˜é«˜ å¼•å…¥MQåï¼Œä¼šä½¿ä¹‹å‰çš„åŒæ­¥æ¥å£è°ƒç”¨å˜æˆé€šè¿‡MQçš„å¼‚æ­¥è°ƒç”¨ï¼Œåœ¨å®é™…çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¼‚æ­¥è°ƒç”¨ä¼šæ¯”åŒæ­¥è°ƒç”¨å¤æ‚çš„å¤šã€‚å¹¶ä¸”å¼‚æ­¥è°ƒç”¨å‡ºç°é—®é¢˜åï¼Œé‡ç°é—®é¢˜ï¼Œå®šä½é—®é¢˜å’Œè§£å†³é—®é¢˜éƒ½ä¼šæ¯”åŒæ­¥è°ƒç”¨å¤æ‚çš„å¤šã€‚ å¹¶ä¸”å¼•å…¥MQåï¼Œè¿˜è¦è€ƒè™‘å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºç­‰é—®é¢˜ã€‚ æ¶ˆæ¯ä¸€è‡´æ€§é—®é¢˜ å¼•å…¥MQåï¼Œä¸å¾—ä¸è€ƒè™‘çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯æ¶ˆæ¯çš„ä¸€è‡´æ€§é—®é¢˜ã€‚è¿™æœŸé—´å°±è¦è€ƒè™‘å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Œæ¶ˆæ¯å¹‚ç­‰å’Œæ¶ˆæ¯æ•°æ®å¤„ç†çš„å¹‚ç­‰æ€§é—®é¢˜ã€‚ MQé€‰å‹å¯¹æ¯” ç›®å‰ï¼Œåœ¨è¡Œä¸šå†…ä½¿ç”¨çš„æ¯”è¾ƒå¤šçš„MQåŒ…å«RabbitMQã€Kafkaå’ŒRocketMQã€‚è¿™é‡Œï¼Œæˆ‘å°†ä¸‰è€…çš„å¯¹æ¯”ç®€å•æ•´ç†äº†ä¸ªè¡¨æ ¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ æ¶ˆæ¯ä¸­é—´ä»¶(MQ) ä¼˜ç‚¹ ç¼ºç‚¹ ä½¿ç”¨åœºæ™¯ RabbitMQ åŠŸèƒ½å…¨é¢ã€æ¶ˆæ¯çš„å¯é æ€§æ¯”è¾ƒé«˜ ååé‡ä½ï¼Œæ¶ˆæ¯å¤§é‡ç§¯ç´¯ä¼šå½±å“æ€§èƒ½ï¼Œä½¿ç”¨çš„å¼€å‘è¯­è¨€æ˜¯erlangï¼Œä¸å¥½å®šåˆ¶åŠŸèƒ½ã€‚ è§„æ¨¡ä¸å¤§çš„åœºæ™¯ Kafka ååé‡æœ€é«˜ï¼Œæ€§èƒ½æœ€å¥½ï¼Œé›†ç¾¤æ¨¡å¼ä¸‹é«˜å¯ç”¨ åŠŸèƒ½ä¸Šæ¯”è¾ƒå•ä¸€ï¼Œä¼šä¸¢å¤±éƒ¨åˆ†æ•°æ® æ—¥å¿—åˆ†æï¼Œå¤§æ•°æ®åœºæ™¯ RocketMQ ååé‡é«˜ï¼Œæ€§èƒ½é«˜ï¼Œå¯ç”¨æ€§é«˜ï¼ŒåŠŸèƒ½å…¨é¢ã€‚ä½¿ç”¨Javaè¯­è¨€å¼€å‘ï¼Œå®¹æ˜“å®šåˆ¶åŠŸèƒ½ã€‚ å¼€æºç‰ˆä¸å¦‚é˜¿é‡Œäº‘ä¸Šç‰ˆï¼Œæ–‡æ¡£æ¯”è¾ƒç®€å•ã€‚ å‡ ä¹æ”¯æŒæ‰€æœ‰åœºæ™¯ï¼ŒåŒ…å«å¤§æ•°æ®åœºæ™¯å’Œä¸šåŠ¡åœºæ™¯ã€‚ ","link":"https://tianxiawuhao.github.io/8FPjAXq14/"},{"title":"æ­å»ºå¹¶æ•´åˆSeata","content":"æ­å»ºå¹¶æ•´åˆSeata æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ­£å¼åœ¨é¡¹ç›®ä¸­æ•´åˆSeataæ¥å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬ä¸»è¦æ•´åˆSeataçš„ATæ¨¡å¼ã€‚ æ­å»ºSeataåŸºç¡€ç¯å¢ƒ ï¼ˆ1ï¼‰åˆ°https://github.com/seata/seata/releases/tag/v1.4.2é“¾æ¥ä¸‹è½½Seataçš„å®‰è£…åŒ…å’Œæºç ï¼Œè¿™é‡Œï¼Œä¸‹è½½çš„æ˜¯1.4.2ç‰ˆæœ¬ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ è¿™é‡Œæˆ‘ä¸‹è½½çš„éƒ½æ˜¯zipå‹ç¼©æ–‡ä»¶ã€‚ ï¼ˆ2ï¼‰è¿›å…¥Nacosï¼Œé€‰æ‹©çš„å‘½åç©ºé—´ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ç‚¹å‡»æ–°å»ºå‘½åç©ºé—´ï¼Œå¹¶å¡«å†™Seataç›¸å…³çš„ä¿¡æ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæˆ‘å¡«å†™çš„ä¿¡æ¯å¦‚ä¸‹æ‰€ç¤ºã€‚ å‘½åç©ºé—´IDï¼šseata_namespace_001ï¼Œå¦‚æœä¸å¡«çš„è¯Nacosä¼šè‡ªåŠ¨ç”Ÿæˆå‘½åç©ºé—´çš„IDã€‚ å‘½åç©ºé—´åï¼šseataã€‚ æè¿°ï¼šseataçš„å‘½åç©ºé—´ã€‚ ã€Œè¿™é‡Œï¼Œéœ€è¦è®°å½•ä¸‹å‘½åç©ºé—´çš„IDï¼šseata_namespace_001ï¼Œåœ¨åé¢çš„é…ç½®ä¸­ä¼šä½¿ç”¨åˆ°ã€‚ã€ ç‚¹å‡»ç¡®å®šåå¦‚ä¸‹æ‰€ç¤ºã€‚ å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œä¸ºSeataåœ¨Nacosä¸­åˆ›å»ºäº†å‘½åç©ºé—´ã€‚ ï¼ˆ3ï¼‰è§£å‹Seataå®‰è£…æ–‡ä»¶ï¼Œè¿›å…¥è§£å‹åçš„seata/seata-server-1.4.2/confç›®å½•ï¼Œä¿®æ”¹registry.confæ³¨å†Œæ–‡ä»¶ï¼Œä¿®æ”¹åçš„éƒ¨åˆ†æ–‡ä»¶å†…å®¹å¦‚ä¸‹æ‰€ç¤ºã€‚ registry { # file ã€nacos ã€eurekaã€redisã€zkã€consulã€etcd3ã€sofa type = &quot;nacos&quot; nacos { application = &quot;seata-server&quot; serverAddr = &quot;127.0.0.1:8848&quot; group = &quot;SEATA_GROUP&quot; namespace = &quot;seata_namespace_001&quot; cluster = &quot;default&quot; username = &quot;nacos&quot; password = &quot;nacos&quot; } } config { # fileã€nacos ã€apolloã€zkã€consulã€etcd3 type = &quot;nacos&quot; nacos { serverAddr = &quot;127.0.0.1:8848&quot; namespace = &quot;seata_namespace_001&quot; group = &quot;SEATA_GROUP&quot; username = &quot;nacos&quot; password = &quot;nacos&quot; dataId = &quot;seataServer.properties&quot; } } å…¶ä¸­ï¼Œnamespaceçš„å€¼å°±æ˜¯åœ¨Nacosä¸­é…ç½®çš„Seataçš„å‘½åç©ºé—´IDï¼šseata_namespace_001ã€‚ ã€Œæ³¨æ„ï¼šè¿™é‡Œåªåˆ—å‡ºäº†ä¿®æ”¹çš„éƒ¨åˆ†å†…å®¹ï¼Œå®Œæ•´çš„registry.confæ–‡ä»¶å¯ä»¥åˆ°é¡¹ç›®çš„doc/nacos/config/chapter25ç›®å½•ä¸‹è·å–ã€‚ã€ ï¼ˆ4ï¼‰ä¿®æ”¹Seataå®‰è£…æ–‡ä»¶çš„seata/seata-server-1.4.2/confç›®å½•ä¸‹çš„file.confæ–‡ä»¶ï¼Œä¿®æ”¹åçš„éƒ¨åˆ†é…ç½®å¦‚ä¸‹æ‰€ç¤ºã€‚ store { mode = &quot;db&quot; publicKey = &quot;&quot; db { datasource = &quot;druid&quot; dbType = &quot;mysql&quot; driverClassName = &quot;com.mysql.jdbc.Driver&quot; url = &quot;jdbc:mysql://127.0.0.1:3306/seata?useSSL=false&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;allowMultiQueries=true&amp;serverTimezone=Asia/Shanghai&quot; user = &quot;root&quot; password = &quot;root&quot; minConn = 5 maxConn = 100 globalTable = &quot;global_table&quot; branchTable = &quot;branch_table&quot; lockTable = &quot;lock_table&quot; queryLimit = 100 maxWait = 5000 } } ã€Œæ³¨æ„ï¼šè¿™é‡Œåªåˆ—å‡ºäº†ä¿®æ”¹çš„éƒ¨åˆ†å†…å®¹ï¼Œå®Œæ•´çš„file.confæ–‡ä»¶å¯ä»¥åˆ°é¡¹ç›®çš„doc/nacos/config/chapter25ç›®å½•ä¸‹è·å–ã€‚ã€ ï¼ˆ5ï¼‰åœ¨ä¸‹è½½çš„Seataæºç çš„seata-1.4.2/script/config-centerç›®å½•ä¸‹æ‰¾åˆ°config.txtæ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ å°†å…¶å¤åˆ¶åˆ°Seataå®‰è£…åŒ…è§£å‹çš„æ ¹ç›®å½•ä¸‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ æ¥ä¸‹æ¥ï¼Œä¿®æ”¹Seataå®‰è£…åŒ…è§£å‹çš„æ ¹ç›®å½•ä¸‹çš„config.txtæ–‡ä»¶ï¼Œè¿™é‡Œè¿˜æ˜¯åªåˆ—å‡ºä¿®æ”¹çš„éƒ¨åˆ†ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ service.vgroupMapping.server-order-tx_group=default service.vgroupMapping.server-product-tx_group=default store.mode=db store.publicKey=&quot;&quot; store.db.datasource=druid store.db.dbType=mysql store.db.driverClassName=com.mysql.jdbc.Driver store.db.url=jdbc:mysql://127.0.0.1:3306/seata?useSSL=false&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;allowMultiQueries=true&amp;serverTimezone=Asia/Shanghai store.db.user=root store.db.password=root store.redis.sentinel.masterName=&quot;&quot; store.redis.sentinel.sentinelHosts=&quot;&quot; store.redis.password=&quot;&quot; ã€Œæ³¨æ„ï¼šåœ¨config.txtä¸­ï¼Œéƒ¨åˆ†é…ç½®çš„ç­‰å·â€œ=â€åé¢ä¸ºç©ºï¼Œéœ€è¦åœ¨ç­‰å·â€œ=â€œåé¢æ·»åŠ ç©ºå­—ç¬¦ä¸²&quot;&quot;ã€‚åŒæ ·çš„ï¼Œå°ä¼™ä¼´ä»¬å¯ä»¥åˆ°é¡¹ç›®çš„doc/nacos/config/chapter25ç›®å½•ä¸‹è·å–å®Œæ•´çš„config.txtæ–‡ä»¶ã€‚ã€ ï¼ˆ6ï¼‰åœ¨ä¸‹è½½çš„Seataæºç çš„seata-1.4.2/script/config-center/nacosç›®å½•ä¸‹æ‰¾åˆ°nacos-config.shæ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ å°†nacos-config.shæ–‡ä»¶å¤åˆ¶åˆ°Seataå®‰è£…æ–‡ä»¶è§£å‹ç›®å½•çš„seata/seata-server-1.4.2/scriptsç›®å½•ä¸‹ï¼Œå…¶ä¸­scriptsç›®å½•éœ€è¦æ‰‹åŠ¨åˆ›å»ºï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ï¼ˆ7ï¼‰.shæ–‡ä»¶æ˜¯Linuxæ“ä½œç³»ç»Ÿä¸Šçš„è„šæœ¬æ–‡ä»¶ï¼Œå¦‚æœæƒ³åœ¨Windowsæ“ä½œç³»ç»Ÿä¸Šè¿è¡Œ.shæ–‡ä»¶ï¼Œå¯ä»¥åœ¨Windowsæ“ä½œç³»ç»Ÿä¸Šå®‰è£…Gitååœ¨è¿è¡Œ.shæ–‡ä»¶ã€‚ æ¥ä¸‹æ¥ï¼Œåœ¨Gitçš„Bashå‘½ä»¤è¡Œè¿›å…¥Seataå®‰è£…æ–‡ä»¶ä¸­nacos-config.shæ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ã€‚ sh nacos-config.sh -h 127.0.0.1 -p 8848 -g SEATA_GROUP -t seata_namespace_001 -u nacos -w nacos å…¶ä¸­ï¼Œå‘½ä»¤ä¸­çš„æ¯ä¸ªå‚æ•°å«ä¹‰å¦‚ä¸‹æ‰€ç¤ºã€‚ -hï¼šNacosæ‰€åœ¨çš„IPåœ°å€ã€‚ -pï¼šNacosçš„ç«¯å£å·ã€‚ -gï¼šåˆ†ç»„ã€‚ -tï¼šå‘½åç©ºé—´çš„IDï¼Œè¿™é‡Œæˆ‘ä»¬å¡«å†™åœ¨Nacosä¸­åˆ›å»ºçš„å‘½åç©ºé—´çš„IDï¼šseata_namespace_001ã€‚å¦‚æœä¸å¡«ï¼Œé»˜è®¤æ˜¯publicå‘½åç©ºé—´ã€‚ -uï¼šNacosçš„ç”¨æˆ·åã€‚ -wï¼šNacosçš„å¯†ç ã€‚ æ‰§è¡Œå‘½ä»¤åçš„ç»“æœä¿¡æ¯å¦‚ä¸‹æ‰€ç¤ºã€‚ ========================================================================= Complete initialization parameters, total-count:89 , failure-count:0 ========================================================================= Init nacos config finished, please start seata-server. å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªé…ç½®æ‰§è¡ŒæˆåŠŸã€‚ ï¼ˆ8ï¼‰æ‰“å¼€Nacosçš„é…ç½®ç®¡ç†-é…ç½®åˆ—è¡¨ç•Œé¢ï¼Œåˆ‡æ¢åˆ°seataå‘½åç©ºé—´ï¼Œå¯ä»¥çœ‹åˆ°æœ‰å…³Seataçš„é…ç½®éƒ½æ³¨å†Œåˆ°Nacosä¸­äº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ï¼ˆ9ï¼‰åœ¨MySQLæ•°æ®åº“ä¸­åˆ›å»ºseataæ•°æ®åº“ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ create database if not exists seata; æ¥ä¸‹æ¥ï¼Œåœ¨seataæ•°æ®åº“ä¸­æ‰§è¡ŒSeataæºç åŒ…seata-1.4.2/script/server/dbç›®å½•ä¸‹çš„mysql.sqlè„šæœ¬æ–‡ä»¶ï¼Œmysql.sqlè„šæœ¬çš„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºã€‚ -- -------------------------------- The script used when storeMode is 'db' -------------------------------- -- the table to store GlobalSession data CREATE TABLE IF NOT EXISTS `global_table` ( `xid` VARCHAR(128) NOT NULL, `transaction_id` BIGINT, `status` TINYINT NOT NULL, `application_id` VARCHAR(32), `transaction_service_group` VARCHAR(32), `transaction_name` VARCHAR(128), `timeout` INT, `begin_time` BIGINT, `application_data` VARCHAR(2000), `gmt_create` DATETIME, `gmt_modified` DATETIME, PRIMARY KEY (`xid`), KEY `idx_gmt_modified_status` (`gmt_modified`, `status`), KEY `idx_transaction_id` (`transaction_id`) ) ENGINE = InnoDB DEFAULT CHARSET = utf8; -- the table to store BranchSession data CREATE TABLE IF NOT EXISTS `branch_table` ( `branch_id` BIGINT NOT NULL, `xid` VARCHAR(128) NOT NULL, `transaction_id` BIGINT, `resource_group_id` VARCHAR(32), `resource_id` VARCHAR(256), `branch_type` VARCHAR(8), `status` TINYINT, `client_id` VARCHAR(64), `application_data` VARCHAR(2000), `gmt_create` DATETIME(6), `gmt_modified` DATETIME(6), PRIMARY KEY (`branch_id`), KEY `idx_xid` (`xid`) ) ENGINE = InnoDB DEFAULT CHARSET = utf8; -- the table to store lock data CREATE TABLE IF NOT EXISTS `lock_table` ( `row_key` VARCHAR(128) NOT NULL, `xid` VARCHAR(128), `transaction_id` BIGINT, `branch_id` BIGINT NOT NULL, `resource_id` VARCHAR(256), `table_name` VARCHAR(32), `pk` VARCHAR(36), `gmt_create` DATETIME, `gmt_modified` DATETIME, PRIMARY KEY (`row_key`), KEY `idx_branch_id` (`branch_id`) ) ENGINE = InnoDB DEFAULT CHARSET = utf8; è¿™é‡Œï¼Œä¹Ÿå°†mysql.sqlæ–‡ä»¶æ”¾åœ¨äº†é¡¹ç›®çš„doc/nacos/config/chapter25ç›®å½•ä¸‹ã€‚ ï¼ˆ10ï¼‰å¯åŠ¨SeataæœåŠ¡ï¼Œè¿›å…¥åœ¨å‘½ä»¤è¡Œè¿›å…¥Seataå®‰è£…æ–‡ä»¶çš„seata/seata-server-1.4.2/binç›®å½•ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ã€‚ seata-server.bat -p 8091 -h 127.0.0.1 -m db å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å¯åŠ¨Seataçš„å‘½ä»¤è¡Œè¾“å‡ºäº†å¦‚ä¸‹ä¿¡æ¯ã€‚ i.s.core.rpc.netty.NettyServerBootstrap : Server started, listen port: 8091 è¯´æ˜Seataå·²ç»å¯åŠ¨æˆåŠŸã€‚ è‡³æ­¤ï¼ŒSeataçš„åŸºç¡€ç¯å¢ƒæ­å»ºå®Œæ¯•ã€‚ é¡¹ç›®æ•´åˆSeata åœ¨æˆ‘ä»¬å¼€å‘çš„å¾®æœåŠ¡ç¨‹åºä¸­ï¼Œè®¢å•å¾®æœåŠ¡ä¸‹å•æˆåŠŸåä¼šè°ƒç”¨åº“å­˜å¾®æœåŠ¡æ‰£å‡å•†å“çš„åº“å­˜ä¿¡æ¯ï¼Œè€Œç”¨æˆ·å¾®æœåŠ¡åªæä¾›äº†æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯çš„æ¥å£ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬åœ¨å•†å“å¾®æœåŠ¡å’Œè®¢å•å¾®æœåŠ¡ä¸­æ•´åˆSeataã€‚ å¯¼å…¥unlogè¡¨ æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯Seataçš„ATæ¨¡å¼ï¼Œéœ€è¦æˆ‘ä»¬åœ¨æ¶‰åŠåˆ°ä½¿ç”¨Seataè§£å†³åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜çš„æ¯ä¸ªä¸šåŠ¡åº“ä¸­åˆ›å»ºä¸€ä¸ªSeataçš„undo_logæ•°æ®è¡¨ï¼ŒSeataä¸­æœ¬èº«æä¾›äº†åˆ›å»ºæ•°æ®è¡¨çš„SQLæ–‡ä»¶ï¼Œè¿™äº›SQLæ–‡ä»¶ä½äºSeataæºç åŒ…ä¸‹çš„seata-1.4.2/script/client/at/dbç›®å½•ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨mysql.sqlè„šæœ¬ã€‚mysql.sqlè„šæœ¬çš„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºã€‚ -- for AT mode you must to init this sql for you business database. the seata server not need it. CREATE TABLE IF NOT EXISTS `undo_log` ( `branch_id` BIGINT NOT NULL COMMENT 'branch transaction id', `xid` VARCHAR(128) NOT NULL COMMENT 'global transaction id', `context` VARCHAR(128) NOT NULL COMMENT 'undo_log context,such as serialization', `rollback_info` LONGBLOB NOT NULL COMMENT 'rollback info', `log_status` INT(11) NOT NULL COMMENT '0:normal status,1:defense status', `log_created` DATETIME(6) NOT NULL COMMENT 'create datetime', `log_modified` DATETIME(6) NOT NULL COMMENT 'modify datetime', UNIQUE KEY `ux_undo_log` (`xid`, `branch_id`) ) ENGINE = InnoDB AUTO_INCREMENT = 1 DEFAULT CHARSET = utf8 COMMENT ='AT transaction mode undo table'; æ³¨æ„ï¼Œè¿™é‡Œè¦åœ¨shopæ•°æ®åº“ä¸­æ‰§è¡Œmysql.sqlè„šæœ¬ï¼ŒåŒæ ·çš„ï¼Œæˆ‘ä¼šå°†è¿™é‡Œçš„mysql.sqlæ–‡ä»¶æ”¾åˆ°é¡¹ç›®çš„doc/nacos/config/chapter25ç›®å½•ä¸‹ï¼Œå¹¶é‡å‘½åä¸ºmysql_client.sqlã€‚ å•†å“å¾®æœåŠ¡æ•´åˆSeata ï¼ˆ1ï¼‰åœ¨å•†å“å¾®æœåŠ¡shop-productçš„pom.xmlæ–‡ä»¶ä¸­å¼•å…¥Seataä¾èµ–ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ &lt;dependency&gt; &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-alibaba-seata&lt;/artifactId&gt; &lt;/dependency&gt; ï¼ˆ2ï¼‰ä¿®æ”¹å•†å“å¾®æœåŠ¡shop-productçš„bootstrap.ymlï¼Œä¿®æ”¹åçš„æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºã€‚ spring: application: name: server-product cloud: nacos: config: server-addr: 127.0.0.1:8848 file-extension: yaml group: product_group shared-configs[0]: data_id: server-all.yaml group: all_group refresh: true discovery: server-addr: 127.0.0.1:8848 alibaba: seata: tx-service-group: ${spring.application.name}-tx_group profiles: active: dev seata: application-id: ${spring.application.name} service: vgroup-mapping: server-product-tx_group: default registry: nacos: server-addr: ${spring.cloud.nacos.discovery.server-addr} username: nacos password: nacos group: SEATA_GROUP namespace: seata_namespace_001 application: seata-server config: type: nacos nacos: server-addr: ${spring.cloud.nacos.discovery.server-addr} username: nacos password: nacos group: SEATA_GROUP namespace: seata_namespace_001 å…¶ä¸­ï¼Œé…ç½®çš„Nacosçš„namespaceä¸groupä¸registry.confæ–‡ä»¶ä¸­çš„ä¸€è‡´ã€‚ è®¢å•å¾®æœåŠ¡æ•´åˆSeata ï¼ˆ1ï¼‰åœ¨è®¢å•å¾®æœåŠ¡shop-productçš„pom.xmlæ–‡ä»¶ä¸­å¼•å…¥Seataä¾èµ–ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ &lt;dependency&gt; &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-alibaba-seata&lt;/artifactId&gt; &lt;/dependency&gt; ï¼ˆ2ï¼‰ä¿®æ”¹è®¢å•å¾®æœåŠ¡shop-orderçš„bootstrap.ymlï¼Œä¿®æ”¹åçš„æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºã€‚ spring: application: name: server-order cloud: nacos: config: server-addr: 127.0.0.1:8848 file-extension: yaml group: order_group shared-configs[0]: data_id: server-all.yaml group: all_group refresh: true discovery: server-addr: 127.0.0.1:8848 alibaba: seata: tx-service-group: ${spring.application.name}-tx_group profiles: active: dev seata: application-id: ${spring.application.name} service: vgroup-mapping: server-order-tx_group: default registry: nacos: server-addr: ${spring.cloud.nacos.discovery.server-addr} username: nacos password: nacos group: SEATA_GROUP namespace: seata_namespace_001 application: seata-server config: type: nacos nacos: server-addr: ${spring.cloud.nacos.discovery.server-addr} username: nacos password: nacos group: SEATA_GROUP namespace: seata_namespace_001 ï¼ˆ3ï¼‰ä¿®æ”¹è®¢å•å¾®æœåŠ¡çš„io.binghe.shop.order.service.impl.OrderServiceV8Implç±»çš„saveOrder()æ–¹æ³•ï¼Œåœ¨saveOrder()æ–¹æ³•ä¸Šæ·»åŠ Seataçš„@GlobalTransactionalæ³¨è§£ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ @Override @GlobalTransactional public void saveOrder(OrderParams orderParams) { //çœç•¥å…·ä½“æ–¹æ³•ä»£ç  } è‡³æ­¤ï¼Œæ­å»ºå¹¶æ•´åˆSeataå®Œæ¯•ï¼Œå°±æ˜¯è¿™ä¹ˆç®€å•ã€‚ éªŒè¯Seataäº‹åŠ¡ é‡ç½®æ•°æ®åº“æ•°æ® è¿™é‡Œï¼Œé¦–å…ˆå°†å•†å“æ•°æ®è¡¨t_productä¸­idä¸º1001çš„æ•°æ®çš„åº“å­˜ä¿¡æ¯é‡ç½®ä¸º100ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ update t_product set t_pro_stock = 100 where id = 1001; æŸ¥è¯¢æ•°æ®è¡¨æ•°æ® ï¼ˆ1ï¼‰æ‰“å¼€cmdç»ˆç«¯ï¼Œè¿›å…¥MySQLå‘½ä»¤è¡Œï¼Œå¹¶è¿›å…¥shopå•†åŸæ•°æ®åº“ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ C:\\Users\\binghe&gt;mysql -uroot -p Enter password: **** Welcome to the MySQL monitor. Commands end with ; or \\g. Your MySQL connection id is 15 Server version: 5.7.35 MySQL Community Server (GPL) Copyright (c) 2000, 2021, Oracle and/or its affiliates. Oracle is a registered trademark of Oracle Corporation and/or its affiliates. Other names may be trademarks of their respective owners. Type 'help;' or '\\h' for help. Type '\\c' to clear the current input statement. mysql&gt; use shop; Database changed ï¼ˆ2ï¼‰æŸ¥çœ‹å•†å“æ•°æ®è¡¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ mysql&gt; select * from t_product; +------+------------+-------------+-------------+ | id | t_pro_name | t_pro_price | t_pro_stock | +------+------------+-------------+-------------+ | 1001 | åä¸º | 2399.00 | 100 | | 1002 | å°ç±³ | 1999.00 | 100 | | 1003 | iphone | 4999.00 | 100 | +------+------------+-------------+-------------+ 3 rows in set (0.00 sec) è¿™é‡Œï¼Œæˆ‘ä»¬ä»¥idä¸º1001çš„å•†å“ä¸ºä¾‹ï¼Œæ­¤æ—¶å‘ç°å•†å“çš„åº“å­˜ä¸º100ã€‚ ï¼ˆ3ï¼‰æŸ¥è¯¢è®¢å•æ•°æ®è¡¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ mysql&gt; select * from t_order; Empty set (0.00 sec) å¯ä»¥å‘ç°è®¢å•æ•°æ®è¡¨ä¸ºç©ºã€‚ ï¼ˆ4ï¼‰æŸ¥è¯¢è®¢å•æ¡ç›®æ•°æ®è¡¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ mysql&gt; select * from t_order_item; Empty set (0.00 sec) å¯ä»¥çœ‹åˆ°ï¼Œè®¢å•æ¡ç›®æ•°æ®è¡¨ä¸ºç©ºã€‚ éªŒè¯Seataäº‹åŠ¡ ï¼ˆ1ï¼‰åˆ†åˆ«å¯åŠ¨Nacosã€Sentinelã€ZinKinã€RocketMQï¼ŒSeataï¼Œå¹¶å¯åŠ¨ç”¨æˆ·å¾®æœåŠ¡ï¼Œå•†å“å¾®æœåŠ¡ï¼Œè®¢å•å¾®æœåŠ¡å’ŒæœåŠ¡ç½‘å…³ã€‚æ‰“å¼€æµè§ˆå™¨è®¿é—®http://localhost:10001/server-order/order/submit_order?userId=1001&amp;productId=1001&amp;count=1ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ è¿”å›çš„åŸå§‹æ•°æ®å¦‚ä¸‹æ‰€ç¤ºã€‚ {&quot;code&quot;:500,&quot;codeMsg&quot;:&quot;æ‰§è¡Œå¤±è´¥&quot;,&quot;data&quot;:&quot;/ by zero&quot;} ï¼ˆ2ï¼‰æŸ¥çœ‹å„ä¸ªå¾®æœåŠ¡å’Œç½‘å…³è¾“å‡ºçš„æ—¥å¿—ä¿¡æ¯ï¼Œåˆ†åˆ«å¦‚ä¸‹æ‰€ç¤ºã€‚ ç”¨æˆ·å¾®æœåŠ¡è¾“å‡ºçš„æ—¥å¿—å¦‚ä¸‹æ‰€ç¤ºã€‚ è·å–åˆ°çš„ç”¨æˆ·ä¿¡æ¯ä¸ºï¼š{&quot;address&quot;:&quot;åŒ—äº¬&quot;,&quot;id&quot;:1001,&quot;password&quot;:&quot;c26be8aaf53b15054896983b43eb6a65&quot;,&quot;phone&quot;:&quot;13212345678&quot;,&quot;username&quot;:&quot;binghe&quot;} è¯´æ˜ç”¨æˆ·å¾®æœåŠ¡æ— å¼‚å¸¸ä¿¡æ¯ã€‚ å•†å“å¾®æœåŠ¡è¾“å‡ºçš„æ—¥å¿—å¦‚ä¸‹æ‰€ç¤ºã€‚ è·å–åˆ°çš„å•†å“ä¿¡æ¯ä¸ºï¼š{&quot;id&quot;:1001,&quot;proName&quot;:&quot;åä¸º&quot;,&quot;proPrice&quot;:2399.00,&quot;proStock&quot;:100} æ›´æ–°å•†å“åº“å­˜ä¼ é€’çš„å‚æ•°ä¸º: å•†å“id:1001, è´­ä¹°æ•°é‡:1 è¯´æ˜å•†å“å¾®æœåŠ¡æ— å¼‚å¸¸ä¿¡æ¯ã€‚ å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæ•´åˆSeataåï¼Œå•†å“å¾®æœåŠ¡åŒæ—¶è¾“å‡ºäº†å¦‚ä¸‹æ—¥å¿—ã€‚ rm handle branch rollback process:xid=192.168.0.111:8091:6638572304823066625,branchId=6638572304823066634,branchType=AT,resourceId=jdbc:mysql://localhost:3306/shop,applicationData=null Branch Rollbacking: 192.168.0.111:8091:6638572304823066625 6638572304823066634 jdbc:mysql://localhost:3306/shop xid 192.168.0.111:8091:6638572304823066625 branch 6638572304823066634, undo_log deleted with GlobalFinished Branch Rollbacked result: PhaseTwo_Rollbacked çœ‹ä¸Šå»åº”è¯¥æ˜¯æœ‰äº‹åŠ¡å›æ»šäº†ã€‚ è®¢å•å¾®æœåŠ¡è¾“å‡ºçš„æ—¥å¿—å¦‚ä¸‹æ‰€ç¤ºã€‚ æäº¤è®¢å•æ—¶ä¼ é€’çš„å‚æ•°:{&quot;count&quot;:1,&quot;empty&quot;:false,&quot;productId&quot;:1001,&quot;userId&quot;:1001} åº“å­˜æ‰£å‡æˆåŠŸ æœåŠ¡å™¨æŠ›å‡ºäº†å¼‚å¸¸ï¼š{} java.lang.ArithmeticException: / by zero è¯´æ˜è®¢å•å¾®æœåŠ¡æŠ›å‡ºäº†ArithmeticExceptionå¼‚å¸¸ã€‚ åŒæ—¶ï¼Œå•†å“å¾®æœåŠ¡ä¼šè¾“å‡ºå¦‚ä¸‹æ—¥å¿—ã€‚ Branch Rollbacked result: PhaseTwo_Rollbacked [192.168.0.111:8091:6638572304823066625] rollback status: Rollbacked çœ‹ä¸Šå»åº”è¯¥æ˜¯æœ‰äº‹åŠ¡å›æ»šäº†ã€‚ ç½‘å…³æœåŠ¡è¾“å‡ºçš„æ—¥å¿—å¦‚ä¸‹æ‰€ç¤ºã€‚ æ‰§è¡Œå‰ç½®è¿‡æ»¤å™¨é€»è¾‘ æ‰§è¡Œåç½®è¿‡æ»¤å™¨é€»è¾‘ è®¿é—®æ¥å£ä¸»æœº: localhost è®¿é—®æ¥å£ç«¯å£: 10001 è®¿é—®æ¥å£URL: /server-order/order/submit_order è®¿é—®æ¥å£URLå‚æ•°: userId=1001&amp;productId=1001&amp;count=1 è®¿é—®æ¥å£æ—¶é•¿: 1632ms å¯ä»¥çœ‹åˆ°ï¼Œç½‘å…³æœåŠ¡æ— å¼‚å¸¸ä¿¡æ¯ã€‚ é€šè¿‡å¾®æœåŠ¡æ‰“å°å‡ºçš„æ—¥å¿—ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæœ‰äº‹åŠ¡å›æ»šäº†ã€‚ æŸ¥è¯¢æ•°æ®è¡¨æ•°æ® ï¼ˆ1ï¼‰æ‰“å¼€cmdç»ˆç«¯ï¼Œè¿›å…¥MySQLå‘½ä»¤è¡Œï¼Œå¹¶è¿›å…¥shopå•†åŸæ•°æ®åº“ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ C:\\Users\\binghe&gt;mysql -uroot -p Enter password: **** Welcome to the MySQL monitor. Commands end with ; or \\g. Your MySQL connection id is 15 Server version: 5.7.35 MySQL Community Server (GPL) Copyright (c) 2000, 2021, Oracle and/or its affiliates. Oracle is a registered trademark of Oracle Corporation and/or its affiliates. Other names may be trademarks of their respective owners. Type 'help;' or '\\h' for help. Type '\\c' to clear the current input statement. mysql&gt; use shop; Database changed ï¼ˆ2ï¼‰æŸ¥çœ‹å•†å“æ•°æ®è¡¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ mysql&gt; select * from t_product; +------+------------+-------------+-------------+ | id | t_pro_name | t_pro_price | t_pro_stock | +------+------------+-------------+-------------+ | 1001 | åä¸º | 2399.00 | 100 | | 1002 | å°ç±³ | 1999.00 | 100 | | 1003 | iphone | 4999.00 | 100 | +------+------------+-------------+-------------+ 3 rows in set (0.00 sec) å¯ä»¥çœ‹åˆ°ï¼Œæ­¤æ—¶å•†å“æ•°æ®è¡¨ä¸­ï¼Œidä¸º1001çš„å•†å“åº“å­˜æ•°é‡ä»ç„¶ä¸º100ã€‚ ï¼ˆ3ï¼‰æŸ¥çœ‹è®¢å•æ•°æ®è¡¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ mysql&gt; select * from t_order; Empty set (0.00 sec) å¯ä»¥çœ‹åˆ°ï¼Œè®¢å•æ•°æ®è¡¨ä¸ºç©ºã€‚ ï¼ˆ4ï¼‰æŸ¥çœ‹è®¢å•æ¡ç›®æ•°æ®è¡¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ mysql&gt; select * from t_order_item; Empty set (0.00 sec) å¯ä»¥çœ‹åˆ°ï¼Œè®¢å•æ¡ç›®æ•°æ®è¡¨ä¸ºç©ºã€‚ è‡³æ­¤ï¼Œæˆ‘ä»¬æˆåŠŸåœ¨é¡¹ç›®ä¸­æ•´åˆäº†Seataè§£å†³äº†åˆ†å¸ƒå¼äº‹åŠ¡çš„é—®é¢˜ ","link":"https://tianxiawuhao.github.io/IMU3BaL0b/"},{"title":"Seata","content":"Seata æ˜¯ä»€ä¹ˆ? Seata æ˜¯ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œè‡´åŠ›äºæä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ã€‚Seata å°†ä¸ºç”¨æˆ·æä¾›äº† ATã€TCCã€SAGA å’Œ XA äº‹åŠ¡æ¨¡å¼ï¼Œä¸ºç”¨æˆ·æ‰“é€ ä¸€ç«™å¼çš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆã€‚ AT æ¨¡å¼ å‰æ åŸºäºæ”¯æŒæœ¬åœ° ACID äº‹åŠ¡çš„å…³ç³»å‹æ•°æ®åº“ã€‚ Java åº”ç”¨ï¼Œé€šè¿‡ JDBC è®¿é—®æ•°æ®åº“ã€‚ æ•´ä½“æœºåˆ¶ ä¸¤é˜¶æ®µæäº¤åè®®çš„æ¼”å˜ï¼š ä¸€é˜¶æ®µï¼šä¸šåŠ¡æ•°æ®å’Œå›æ»šæ—¥å¿—è®°å½•åœ¨åŒä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ä¸­æäº¤ï¼Œé‡Šæ”¾æœ¬åœ°é”å’Œè¿æ¥èµ„æºã€‚ äºŒé˜¶æ®µï¼š æäº¤å¼‚æ­¥åŒ–ï¼Œéå¸¸å¿«é€Ÿåœ°å®Œæˆã€‚ å›æ»šé€šè¿‡ä¸€é˜¶æ®µçš„å›æ»šæ—¥å¿—è¿›è¡Œåå‘è¡¥å¿ã€‚ å†™éš”ç¦» ä¸€é˜¶æ®µæœ¬åœ°äº‹åŠ¡æäº¤å‰ï¼Œéœ€è¦ç¡®ä¿å…ˆæ‹¿åˆ° ã€Œå…¨å±€é”ã€ ã€‚ æ‹¿ä¸åˆ° ã€Œå…¨å±€é”ã€ ï¼Œä¸èƒ½æäº¤æœ¬åœ°äº‹åŠ¡ã€‚ æ‹¿ ã€Œå…¨å±€é”ã€ çš„å°è¯•è¢«é™åˆ¶åœ¨ä¸€å®šèŒƒå›´å†…ï¼Œè¶…å‡ºèŒƒå›´å°†æ”¾å¼ƒï¼Œå¹¶å›æ»šæœ¬åœ°äº‹åŠ¡ï¼Œé‡Šæ”¾æœ¬åœ°é”ã€‚ ä»¥ä¸€ä¸ªç¤ºä¾‹æ¥è¯´æ˜ï¼š ä¸¤ä¸ªå…¨å±€äº‹åŠ¡ tx1 å’Œ tx2ï¼Œåˆ†åˆ«å¯¹ a è¡¨çš„ m å­—æ®µè¿›è¡Œæ›´æ–°æ“ä½œï¼Œm çš„åˆå§‹å€¼ 1000ã€‚ tx1 å…ˆå¼€å§‹ï¼Œå¼€å¯æœ¬åœ°äº‹åŠ¡ï¼Œæ‹¿åˆ°æœ¬åœ°é”ï¼Œæ›´æ–°æ“ä½œ m = 1000 - 100 = 900ã€‚æœ¬åœ°äº‹åŠ¡æäº¤å‰ï¼Œå…ˆæ‹¿åˆ°è¯¥è®°å½•çš„ ã€Œå…¨å±€é”ã€ ï¼Œæœ¬åœ°æäº¤é‡Šæ”¾æœ¬åœ°é”ã€‚tx2 åå¼€å§‹ï¼Œå¼€å¯æœ¬åœ°äº‹åŠ¡ï¼Œæ‹¿åˆ°æœ¬åœ°é”ï¼Œæ›´æ–°æ“ä½œ m = 900 - 100 = 800ã€‚æœ¬åœ°äº‹åŠ¡æäº¤å‰ï¼Œå°è¯•æ‹¿è¯¥è®°å½•çš„ ã€Œå…¨å±€é”ã€ ï¼Œtx1 å…¨å±€æäº¤å‰ï¼Œè¯¥è®°å½•çš„å…¨å±€é”è¢« tx1 æŒæœ‰ï¼Œtx2 éœ€è¦é‡è¯•ç­‰å¾… ã€Œå…¨å±€é”ã€ ã€‚ tx1 äºŒé˜¶æ®µå…¨å±€æäº¤ï¼Œé‡Šæ”¾ ã€Œå…¨å±€é”ã€ ã€‚tx2 æ‹¿åˆ° ã€Œå…¨å±€é”ã€ æäº¤æœ¬åœ°äº‹åŠ¡ã€‚ å¦‚æœ tx1 çš„äºŒé˜¶æ®µå…¨å±€å›æ»šï¼Œåˆ™ tx1 éœ€è¦é‡æ–°è·å–è¯¥æ•°æ®çš„æœ¬åœ°é”ï¼Œè¿›è¡Œåå‘è¡¥å¿çš„æ›´æ–°æ“ä½œï¼Œå®ç°åˆ†æ”¯çš„å›æ»šã€‚ æ­¤æ—¶ï¼Œå¦‚æœ tx2 ä»åœ¨ç­‰å¾…è¯¥æ•°æ®çš„ ã€Œå…¨å±€é”ã€ï¼ŒåŒæ—¶æŒæœ‰æœ¬åœ°é”ï¼Œåˆ™ tx1 çš„åˆ†æ”¯å›æ»šä¼šå¤±è´¥ã€‚åˆ†æ”¯çš„å›æ»šä¼šä¸€ç›´é‡è¯•ï¼Œç›´åˆ° tx2 çš„ ã€Œå…¨å±€é”ã€ ç­‰é”è¶…æ—¶ï¼Œæ”¾å¼ƒ ã€Œå…¨å±€é”ã€ å¹¶å›æ»šæœ¬åœ°äº‹åŠ¡é‡Šæ”¾æœ¬åœ°é”ï¼Œtx1 çš„åˆ†æ”¯å›æ»šæœ€ç»ˆæˆåŠŸã€‚ å› ä¸ºæ•´ä¸ªè¿‡ç¨‹ ã€Œå…¨å±€é”ã€ åœ¨ tx1 ç»“æŸå‰ä¸€ç›´æ˜¯è¢« tx1 æŒæœ‰çš„ï¼Œæ‰€ä»¥ä¸ä¼šå‘ç”Ÿ ã€Œè„å†™ã€ çš„é—®é¢˜ã€‚ è¯»éš”ç¦» åœ¨æ•°æ®åº“æœ¬åœ°äº‹åŠ¡éš”ç¦»çº§åˆ« ã€Œè¯»å·²æäº¤ï¼ˆRead Committedï¼‰ã€ æˆ–ä»¥ä¸Šçš„åŸºç¡€ä¸Šï¼ŒSeataï¼ˆAT æ¨¡å¼ï¼‰çš„é»˜è®¤å…¨å±€éš”ç¦»çº§åˆ«æ˜¯ ã€Œè¯»æœªæäº¤ï¼ˆRead Uncommittedï¼‰ã€ ã€‚ å¦‚æœåº”ç”¨åœ¨ç‰¹å®šåœºæ™¯ä¸‹ï¼Œå¿…éœ€è¦æ±‚å…¨å±€çš„ ã€Œè¯»å·²æäº¤ã€ ï¼Œç›®å‰ Seata çš„æ–¹å¼æ˜¯é€šè¿‡ SELECT FOR UPDATE è¯­å¥çš„ä»£ç†ã€‚ SELECT FOR UPDATE è¯­å¥çš„æ‰§è¡Œä¼šç”³è¯· ã€Œå…¨å±€é”ã€ ï¼Œå¦‚æœ ã€Œå…¨å±€é”ã€ è¢«å…¶ä»–äº‹åŠ¡æŒæœ‰ï¼Œåˆ™é‡Šæ”¾æœ¬åœ°é”ï¼ˆå›æ»š SELECT FOR UPDATE è¯­å¥çš„æœ¬åœ°æ‰§è¡Œï¼‰å¹¶é‡è¯•ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒæŸ¥è¯¢æ˜¯è¢« block ä½çš„ï¼Œç›´åˆ° ã€Œå…¨å±€é”ã€ æ‹¿åˆ°ï¼Œå³è¯»å–çš„ç›¸å…³æ•°æ®æ˜¯ ã€Œå·²æäº¤ã€ çš„ï¼Œæ‰è¿”å›ã€‚ å‡ºäºæ€»ä½“æ€§èƒ½ä¸Šçš„è€ƒè™‘ï¼ŒSeata ç›®å‰çš„æ–¹æ¡ˆå¹¶æ²¡æœ‰å¯¹æ‰€æœ‰ SELECT è¯­å¥éƒ½è¿›è¡Œä»£ç†ï¼Œä»…é’ˆå¯¹ FOR UPDATE çš„ SELECT è¯­å¥ã€‚ å·¥ä½œæœºåˆ¶ ä»¥ä¸€ä¸ªç¤ºä¾‹æ¥è¯´æ˜æ•´ä¸ª AT åˆ†æ”¯çš„å·¥ä½œè¿‡ç¨‹ã€‚ ä¸šåŠ¡è¡¨ï¼šproduct Field Type Key id bigint(20) PRI name varchar(100) since varchar(100) AT åˆ†æ”¯äº‹åŠ¡çš„ä¸šåŠ¡é€»è¾‘ï¼š update product set name = 'GTS' where name = 'TXC'; ã€Œä¸€é˜¶æ®µã€ è¿‡ç¨‹ï¼š è§£æ SQLï¼šå¾—åˆ° SQL çš„ç±»å‹ï¼ˆUPDATEï¼‰ï¼Œè¡¨ï¼ˆproductï¼‰ï¼Œæ¡ä»¶ï¼ˆwhere name = 'TXC'ï¼‰ç­‰ç›¸å…³çš„ä¿¡æ¯ã€‚ æŸ¥è¯¢å‰é•œåƒï¼šæ ¹æ®è§£æå¾—åˆ°çš„æ¡ä»¶ä¿¡æ¯ï¼Œç”ŸæˆæŸ¥è¯¢è¯­å¥ï¼Œå®šä½æ•°æ®ã€‚ select id, name, since from product where name = 'TXC'; å¾—åˆ°å‰é•œåƒï¼š id name since 1 TXC 2014 æ‰§è¡Œä¸šåŠ¡ SQLï¼šæ›´æ–°è¿™æ¡è®°å½•çš„ name ä¸º 'GTS'ã€‚ æŸ¥è¯¢åé•œåƒï¼šæ ¹æ®å‰é•œåƒçš„ç»“æœï¼Œé€šè¿‡ ã€Œä¸»é”®ã€ å®šä½æ•°æ®ã€‚ select id, name, since from product where id = 1; å¾—åˆ°åé•œåƒï¼š id name since 1 GTS 2014 æ’å…¥å›æ»šæ—¥å¿—ï¼šæŠŠå‰åé•œåƒæ•°æ®ä»¥åŠä¸šåŠ¡ SQL ç›¸å…³çš„ä¿¡æ¯ç»„æˆä¸€æ¡å›æ»šæ—¥å¿—è®°å½•ï¼Œæ’å…¥åˆ° UNDO_LOG è¡¨ä¸­ã€‚ { &quot;branchId&quot;: 641789253, &quot;undoItems&quot;: [{ &quot;afterImage&quot;: { &quot;rows&quot;: [{ &quot;fields&quot;: [{ &quot;name&quot;: &quot;id&quot;, &quot;type&quot;: 4, &quot;value&quot;: 1 }, { &quot;name&quot;: &quot;name&quot;, &quot;type&quot;: 12, &quot;value&quot;: &quot;GTS&quot; }, { &quot;name&quot;: &quot;since&quot;, &quot;type&quot;: 12, &quot;value&quot;: &quot;2014&quot; }] }], &quot;tableName&quot;: &quot;product&quot; }, &quot;beforeImage&quot;: { &quot;rows&quot;: [{ &quot;fields&quot;: [{ &quot;name&quot;: &quot;id&quot;, &quot;type&quot;: 4, &quot;value&quot;: 1 }, { &quot;name&quot;: &quot;name&quot;, &quot;type&quot;: 12, &quot;value&quot;: &quot;TXC&quot; }, { &quot;name&quot;: &quot;since&quot;, &quot;type&quot;: 12, &quot;value&quot;: &quot;2014&quot; }] }], &quot;tableName&quot;: &quot;product&quot; }, &quot;sqlType&quot;: &quot;UPDATE&quot; }], &quot;xid&quot;: &quot;xid:xxx&quot; } æäº¤å‰ï¼Œå‘ TC æ³¨å†Œåˆ†æ”¯ï¼šç”³è¯· product è¡¨ä¸­ï¼Œä¸»é”®å€¼ç­‰äº 1 çš„è®°å½•çš„ ã€Œå…¨å±€é”ã€ ã€‚ æœ¬åœ°äº‹åŠ¡æäº¤ï¼šä¸šåŠ¡æ•°æ®çš„æ›´æ–°å’Œå‰é¢æ­¥éª¤ä¸­ç”Ÿæˆçš„ UNDO LOG ä¸€å¹¶æäº¤ã€‚ å°†æœ¬åœ°äº‹åŠ¡æäº¤çš„ç»“æœä¸ŠæŠ¥ç»™ TCã€‚ ã€ŒäºŒé˜¶æ®µ-å›æ»šã€ æ”¶åˆ° TC çš„åˆ†æ”¯å›æ»šè¯·æ±‚ï¼Œå¼€å¯ä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ï¼Œæ‰§è¡Œå¦‚ä¸‹æ“ä½œã€‚ é€šè¿‡ XID å’Œ Branch ID æŸ¥æ‰¾åˆ°ç›¸åº”çš„ UNDO LOG è®°å½•ã€‚ æ•°æ®æ ¡éªŒï¼šæ‹¿ UNDO LOG ä¸­çš„åé•œä¸å½“å‰æ•°æ®è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœæœ‰ä¸åŒï¼Œè¯´æ˜æ•°æ®è¢«å½“å‰å…¨å±€äº‹åŠ¡ä¹‹å¤–çš„åŠ¨ä½œåšäº†ä¿®æ”¹ã€‚è¿™ç§æƒ…å†µï¼Œéœ€è¦æ ¹æ®é…ç½®ç­–ç•¥æ¥åšå¤„ç†ï¼Œè¯¦ç»†çš„è¯´æ˜åœ¨å¦å¤–çš„æ–‡æ¡£ä¸­ä»‹ç»ã€‚ æ ¹æ® UNDO LOG ä¸­çš„å‰é•œåƒå’Œä¸šåŠ¡ SQL çš„ç›¸å…³ä¿¡æ¯ç”Ÿæˆå¹¶æ‰§è¡Œå›æ»šçš„è¯­å¥ï¼š update product set name = 'TXC' where id = 1; æäº¤æœ¬åœ°äº‹åŠ¡ã€‚å¹¶æŠŠæœ¬åœ°äº‹åŠ¡çš„æ‰§è¡Œç»“æœï¼ˆå³åˆ†æ”¯äº‹åŠ¡å›æ»šçš„ç»“æœï¼‰ä¸ŠæŠ¥ç»™ TCã€‚ ã€ŒäºŒé˜¶æ®µ-æäº¤ã€ æ”¶åˆ° TC çš„åˆ†æ”¯æäº¤è¯·æ±‚ï¼ŒæŠŠè¯·æ±‚æ”¾å…¥ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡çš„é˜Ÿåˆ—ä¸­ï¼Œé©¬ä¸Šè¿”å›æäº¤æˆåŠŸçš„ç»“æœç»™ TCã€‚ å¼‚æ­¥ä»»åŠ¡é˜¶æ®µçš„åˆ†æ”¯æäº¤è¯·æ±‚å°†å¼‚æ­¥å’Œæ‰¹é‡åœ°åˆ é™¤ç›¸åº” UNDO LOG è®°å½•ã€‚ é™„å½• ã€Œå›æ»šæ—¥å¿—è¡¨ã€ UNDO_LOG Tableï¼šä¸åŒæ•°æ®åº“åœ¨ç±»å‹ä¸Šä¼šç•¥æœ‰å·®åˆ«ã€‚ ä»¥ MySQL ä¸ºä¾‹ï¼š Field Type branch_id bigint PK xid varchar(100) context varchar(128) rollback_info longblob log_status tinyint log_created datetime log_modified datetime -- æ³¨æ„æ­¤å¤„0.7.0+ å¢åŠ å­—æ®µ context CREATE TABLE `undo_log` ( `id` bigint(20) NOT NULL AUTO_INCREMENT, `branch_id` bigint(20) NOT NULL, `xid` varchar(100) NOT NULL, `context` varchar(128) NOT NULL, `rollback_info` longblob NOT NULL, `log_status` int(11) NOT NULL, `log_created` datetime NOT NULL, `log_modified` datetime NOT NULL, PRIMARY KEY (`id`), UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`) ) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8; TCC æ¨¡å¼ å›é¡¾æ€»è§ˆä¸­çš„æè¿°ï¼šä¸€ä¸ªåˆ†å¸ƒå¼çš„å…¨å±€äº‹åŠ¡ï¼Œæ•´ä½“æ˜¯ ã€Œä¸¤é˜¶æ®µæäº¤ã€ çš„æ¨¡å‹ã€‚å…¨å±€äº‹åŠ¡æ˜¯ç”±è‹¥å¹²åˆ†æ”¯äº‹åŠ¡ç»„æˆçš„ï¼Œåˆ†æ”¯äº‹åŠ¡è¦æ»¡è¶³ ã€Œä¸¤é˜¶æ®µæäº¤ã€ çš„æ¨¡å‹è¦æ±‚ï¼Œå³éœ€è¦æ¯ä¸ªåˆ†æ”¯äº‹åŠ¡éƒ½å…·å¤‡è‡ªå·±çš„ï¼š ä¸€é˜¶æ®µ prepare è¡Œä¸º äºŒé˜¶æ®µ commit æˆ– rollback è¡Œä¸º æ ¹æ®ä¸¤é˜¶æ®µè¡Œä¸ºæ¨¡å¼çš„ä¸åŒï¼Œæˆ‘ä»¬å°†åˆ†æ”¯äº‹åŠ¡åˆ’åˆ†ä¸º ã€ŒAutomatic (Branch) Transaction Modeã€ å’Œ ã€ŒManual (Branch) Transaction Modeã€. AT æ¨¡å¼ï¼ˆå‚è€ƒé“¾æ¥ TBDï¼‰åŸºäº ã€Œæ”¯æŒæœ¬åœ° ACID äº‹åŠ¡ã€ çš„ ã€Œå…³ç³»å‹æ•°æ®åº“ã€ï¼š ä¸€é˜¶æ®µ prepare è¡Œä¸ºï¼šåœ¨æœ¬åœ°äº‹åŠ¡ä¸­ï¼Œä¸€å¹¶æäº¤ä¸šåŠ¡æ•°æ®æ›´æ–°å’Œç›¸åº”å›æ»šæ—¥å¿—è®°å½•ã€‚ äºŒé˜¶æ®µ commit è¡Œä¸ºï¼šé©¬ä¸ŠæˆåŠŸç»“æŸï¼Œã€Œè‡ªåŠ¨ã€ å¼‚æ­¥æ‰¹é‡æ¸…ç†å›æ»šæ—¥å¿—ã€‚ äºŒé˜¶æ®µ rollback è¡Œä¸ºï¼šé€šè¿‡å›æ»šæ—¥å¿—ï¼Œã€Œè‡ªåŠ¨ã€ ç”Ÿæˆè¡¥å¿æ“ä½œï¼Œå®Œæˆæ•°æ®å›æ»šã€‚ ç›¸åº”çš„ï¼ŒTCC æ¨¡å¼ï¼Œä¸ä¾èµ–äºåº•å±‚æ•°æ®èµ„æºçš„äº‹åŠ¡æ”¯æŒï¼š ä¸€é˜¶æ®µ prepare è¡Œä¸ºï¼šè°ƒç”¨ ã€Œè‡ªå®šä¹‰ã€ çš„ prepare é€»è¾‘ã€‚ äºŒé˜¶æ®µ commit è¡Œä¸ºï¼šè°ƒç”¨ ã€Œè‡ªå®šä¹‰ã€ çš„ commit é€»è¾‘ã€‚ äºŒé˜¶æ®µ rollback è¡Œä¸ºï¼šè°ƒç”¨ ã€Œè‡ªå®šä¹‰ã€ çš„ rollback é€»è¾‘ã€‚ æ‰€è°“ TCC æ¨¡å¼ï¼Œæ˜¯æŒ‡æ”¯æŒæŠŠ ã€Œè‡ªå®šä¹‰ã€ çš„åˆ†æ”¯äº‹åŠ¡çº³å…¥åˆ°å…¨å±€äº‹åŠ¡çš„ç®¡ç†ä¸­ã€‚ Saga æ¨¡å¼ Sagaæ¨¡å¼æ˜¯SEATAæä¾›çš„é•¿äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œåœ¨Sagaæ¨¡å¼ä¸­ï¼Œä¸šåŠ¡æµç¨‹ä¸­æ¯ä¸ªå‚ä¸è€…éƒ½æäº¤æœ¬åœ°äº‹åŠ¡ï¼Œå½“å‡ºç°æŸä¸€ä¸ªå‚ä¸è€…å¤±è´¥åˆ™è¡¥å¿å‰é¢å·²ç»æˆåŠŸçš„å‚ä¸è€…ï¼Œä¸€é˜¶æ®µæ­£å‘æœåŠ¡å’ŒäºŒé˜¶æ®µè¡¥å¿æœåŠ¡éƒ½ç”±ä¸šåŠ¡å¼€å‘å®ç°ã€‚ ç†è®ºåŸºç¡€ï¼šHector &amp; Kenneth å‘è¡¨è®ºâ½‚ Sagas ï¼ˆ1987ï¼‰ é€‚ç”¨åœºæ™¯ ä¸šåŠ¡æµç¨‹é•¿ã€ä¸šåŠ¡æµç¨‹å¤š å‚ä¸è€…åŒ…å«å…¶å®ƒå…¬å¸æˆ–é—ç•™ç³»ç»ŸæœåŠ¡ï¼Œæ— æ³•æä¾› TCC æ¨¡å¼è¦æ±‚çš„ä¸‰ä¸ªæ¥å£ ä¼˜åŠ¿ ä¸€é˜¶æ®µæäº¤æœ¬åœ°äº‹åŠ¡ï¼Œæ— é”ï¼Œé«˜æ€§èƒ½ äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œå‚ä¸è€…å¯å¼‚æ­¥æ‰§è¡Œï¼Œé«˜åå è¡¥å¿æœåŠ¡æ˜“äºå®ç° ç¼ºç‚¹ ä¸ä¿è¯éš”ç¦»æ€§ ","link":"https://tianxiawuhao.github.io/XFKzbOO8H/"},{"title":"æœåŠ¡å®¹é”™ï¼šæœåŠ¡é›ªå´©ä¸å®¹é”™æ–¹æ¡ˆ","content":"æœ¬æ–‡ä¸»è¦å†…å®¹å¦‚ä¸‹æ‰€ç¤ºã€‚ å¹¶å‘å¯¹ç³»ç»Ÿçš„å½±å“ å½“ä¸€ä¸ªç³»ç»Ÿçš„æ¶æ„è®¾è®¡é‡‡ç”¨å¾®æœåŠ¡æ¶æ„æ¨¡å¼æ—¶ï¼Œä¼šå°†åºå¤§è€Œå¤æ‚çš„ä¸šåŠ¡æ‹†åˆ†æˆä¸€ä¸ªä¸ªå°çš„å¾®æœåŠ¡ï¼Œå„ä¸ªå¾®æœåŠ¡ä¹‹é—´ä»¥æ¥å£æˆ–è€…RPCçš„å½¢å¼è¿›è¡Œäº’ç›¸è°ƒç”¨ã€‚åœ¨è°ƒç”¨çš„è¿‡ç¨‹ä¸­ï¼Œå°±ä¼šæ¶‰åŠåˆ°ç½‘è·¯çš„é—®é¢˜ï¼Œå†åŠ ä¸Šå¾®æœåŠ¡è‡ªèº«çš„åŸå› ï¼Œä¾‹å¦‚å¾ˆéš¾åšåˆ°100%çš„é«˜å¯ç”¨ç­‰ã€‚å¦‚æœä¼—å¤šå¾®æœåŠ¡å½“ä¸­çš„æŸä¸ªæˆ–æŸäº›å¾®æœåŠ¡å‡ºç°é—®é¢˜ï¼Œä¸å¯ç”¨æˆ–è€…å®•æœºäº†ï¼Œé‚£ä¹ˆå…¶ä»–å¾®æœåŠ¡è°ƒç”¨è¿™äº›å¾®æœåŠ¡çš„æ¥å£æ—¶å°±ä¼šå‡ºç°å»¶è¿Ÿã€‚å¦‚æœæ­¤æ—¶æœ‰å¤§é‡è¯·æ±‚è¿›å…¥ç³»ç»Ÿï¼Œå°±ä¼šé€ æˆè¯·æ±‚ä»»åŠ¡çš„å¤§é‡å †ç§¯ï¼Œç”šè‡³ä¼šé€ æˆæ•´ä½“æœåŠ¡çš„ç˜«ç—ªã€‚ å‹æµ‹è¯´æ˜ ä¸ºäº†æ›´åŠ ç›´è§‚çš„è¯´æ˜å½“ç³»ç»Ÿæ²¡æœ‰å®¹é”™èƒ½åŠ›æ—¶ï¼Œé«˜å¹¶å‘ã€å¤§æµé‡åœºæ™¯å¯¹äºç³»ç»Ÿçš„å½±å“ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œæ¨¡æ‹Ÿä¸€ä¸ªå¹¶å‘çš„åœºæ™¯ã€‚åœ¨è®¢å•å¾®æœåŠ¡shop-orderçš„io.binghe.shop.order.controller.OrderControllerç±»ä¸­æ–°å¢ä¸€ä¸ªconcurrentRequest()æ–¹æ³•ï¼Œæºç å¦‚ä¸‹æ‰€ç¤ºã€‚ @GetMapping(value = &quot;/concurrent_request&quot;) public String concurrentRequest(){ log.info(&quot;æµ‹è¯•ä¸šåŠ¡åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹æ˜¯å¦å­˜åœ¨é—®é¢˜&quot;); return &quot;binghe&quot;; } æ¥ä¸‹æ¥ï¼Œä¸ºäº†æ›´å¥½çš„æ¼”ç¤ºæ•ˆæœï¼Œæˆ‘ä»¬é™åˆ¶ä¸‹Tomcatå¤„ç†è¯·æ±‚çš„æœ€å¤§å¹¶å‘æ•°ï¼Œåœ¨è®¢å•å¾®æœåŠ¡shop-orderçš„resourcesç›®å½•ä¸‹çš„application.ymlæ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ã€‚ server: port: 8080 tomcat: max-threads: 20 é™åˆ¶Tomcatä¸€æ¬¡æœ€å¤šåªèƒ½å¤„ç†20ä¸ªè¯·æ±‚ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨JMeterå¯¹ http://localhost:8080/order/submit_order æ¥å£è¿›è¡Œå‹æµ‹ï¼Œç”±äºè®¢å•å¾®æœåŠ¡ä¸­æ²¡æœ‰åšä»»ä½•çš„å®¹é”™å¤„ç†ï¼Œå½“å¯¹ http://localhost:8080/order/submit_order æ¥å£çš„è¯·æ±‚å‹åŠ›è¿‡å¤§æ—¶ï¼Œæˆ‘ä»¬å†è®¿é—®http://localhost:8080/order/concurrent_request æ¥å£æ—¶ï¼Œä¼šå‘ç°http://localhost:8080/order/concurrent_request æ¥å£ä¼šå—åˆ°å¹¶å‘è¯·æ±‚çš„å½±å“ï¼Œè®¿é—®å¾ˆæ…¢ç”šè‡³æ ¹æœ¬è®¿é—®ä¸åˆ°ã€‚ å‹æµ‹å®æˆ˜ ä½¿ç”¨JMeterå¯¹ http://localhost:8080/order/submit_order æ¥å£è¿›è¡Œå‹æµ‹ï¼ŒJMeterçš„é…ç½®è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºã€‚ ï¼ˆ1ï¼‰æ‰“å¼€JMeterçš„ä¸»ç•Œé¢ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ï¼ˆ2ï¼‰åœ¨JMeterä¸­å³é”®æµ‹è¯•è®¡åˆ’æ·»åŠ çº¿ç¨‹ç»„ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ï¼ˆ3ï¼‰åœ¨JMeterä¸­çš„çº¿ç¨‹ç»„ä¸­é…ç½®å¹¶å‘çº¿ç¨‹æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå°†çº¿ç¨‹æ•°é…ç½®æˆ50ï¼ŒRamp-Upæ—¶é—´é…ç½®æˆ0ï¼Œå¾ªç¯æ¬¡æ•°ä¸º100ã€‚è¡¨ç¤ºJMeteræ¯æ¬¡ä¼šåœ¨åŒä¸€æ—¶åˆ»å‘ç³»ç»Ÿå‘é€50ä¸ªè¯·æ±‚ï¼Œå‘é€100æ¬¡ä¸ºæ­¢ã€‚ ï¼ˆ4ï¼‰åœ¨JMeterä¸­å³é”®çº¿ç¨‹ç»„æ·»åŠ HTTPè¯·æ±‚ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ï¼ˆ5ï¼‰åœ¨JMeterä¸­é…ç½®HTTPè¯·æ±‚ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ å…·ä½“é…ç½®å¦‚ä¸‹æ‰€ç¤ºã€‚ åè®®ï¼šhttp æœåŠ¡å™¨åç§°æˆ–IPï¼šlocalhost ç«¯å£å·ï¼š8080 æ–¹æ³•ï¼šGET è·¯å¾„ï¼š/order/submit_order?userId=1001&amp;productId=1001&amp;count=1 å†…å®¹ç¼–ç ï¼šUTF-8 ï¼ˆ6ï¼‰é…ç½®å¥½JMeteråï¼Œç‚¹å‡»JMeterä¸Šçš„ç»¿è‰²å°ä¸‰è§’å¼€å§‹å‹æµ‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ç‚¹å‡»åä¼šå¼¹å‡ºéœ€è¦ä¿å­˜JMeterè„šæœ¬çš„å¼¹å‡ºæ¡†ï¼Œæ ¹æ®å®é™…éœ€è¦ç‚¹å‡»ä¿å­˜å³å¯ã€‚ ç‚¹å‡»ä¿å­˜åï¼Œå¼€å§‹å¯¹ http://localhost:8080/order/submit_order æ¥å£è¿›è¡Œå‹æµ‹ï¼Œåœ¨å‹æµ‹çš„è¿‡ç¨‹ä¸­ä¼šå‘ç°è®¢å•å¾®æœåŠ¡æ‰“å°æ—¥å¿—æ—¶ï¼Œä¼šæ¯”è¾ƒå¡é¡¿ï¼ŒåŒæ—¶åœ¨æµè§ˆå™¨æˆ–å…¶ä»–å·¥å…·ä¸­è®¿é—®http://localhost:8080/order/concurrent_request æ¥å£ä¼šå¡é¡¿ï¼Œç”šè‡³æ ¹æœ¬è®¿é—®ä¸åˆ°ã€‚ è¯´æ˜è®¢å•å¾®æœåŠ¡ä¸­çš„æŸä¸ªæ¥å£ä¸€æ—¦è®¿é—®çš„å¹¶å‘é‡è¿‡é«˜ï¼Œå…¶ä»–æ¥å£ä¹Ÿä¼šå—åˆ°å½±å“ï¼Œè¿›è€Œå¯¼è‡´è®¢å•å¾®æœåŠ¡æ•´ä½“ä¸å¯ç”¨ã€‚ä¸ºäº†è¯´æ˜è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹æœåŠ¡é›ªå´©æ˜¯ä¸ªä»€ä¹ˆé¬¼ã€‚ æœåŠ¡é›ªå´© ç³»ç»Ÿé‡‡ç”¨åˆ†å¸ƒå¼æˆ–å¾®æœåŠ¡çš„æ¶æ„æ¨¡å¼åï¼Œç”±äºç½‘ç»œæˆ–è€…æœåŠ¡è‡ªèº«çš„é—®é¢˜ï¼Œä¸€èˆ¬æœåŠ¡æ˜¯å¾ˆéš¾åšåˆ°100%é«˜å¯ç”¨çš„ã€‚å¦‚æœä¸€ä¸ªæœåŠ¡å‡ºç°é—®é¢˜ï¼Œå°±å¯èƒ½ä¼šå¯¼è‡´å…¶ä»–çš„æœåŠ¡çº§è”å‡ºç°é—®é¢˜ï¼Œè¿™ç§æ•…éšœæ€§é—®é¢˜ä¼šåœ¨æ•´ä¸ªç³»ç»Ÿä¸­ä¸æ–­æ‰©æ•£ï¼Œè¿›è€Œå¯¼è‡´æœåŠ¡ä¸å¯ç”¨ï¼Œç”šè‡³å®•æœºï¼Œæœ€ç»ˆä¼šå¯¹æ•´ä¸ªç³»ç»Ÿé€ æˆç¾éš¾æ€§åæœã€‚ ä¸ºäº†æœ€å¤§ç¨‹åº¦çš„é¢„é˜²æœåŠ¡é›ªå´©ï¼Œç»„æˆæ•´ä½“ç³»ç»Ÿçš„å„ä¸ªå¾®æœåŠ¡éœ€è¦æ”¯æŒæœåŠ¡å®¹é”™çš„åŠŸèƒ½ã€‚ æœåŠ¡å®¹é”™æ–¹æ¡ˆ æœåŠ¡å®¹é”™åœ¨ä¸€å®šç¨‹åº¦ä¸Šå°±æ˜¯å°½æœ€å¤§åŠªåŠ›æ¥å…¼å®¹é”™è¯¯æƒ…å†µçš„å‘ç”Ÿï¼Œå› ä¸ºåœ¨åˆ†å¸ƒå¼å’Œå¾®æœåŠ¡ç¯å¢ƒä¸­ï¼Œä¸å¯é¿å…çš„ä¼šå‡ºç°ä¸€äº›å¼‚å¸¸æƒ…å†µï¼Œæˆ‘ä»¬åœ¨è®¾è®¡åˆ†å¸ƒå¼å’Œå¾®æœåŠ¡ç³»ç»Ÿæ—¶ï¼Œå°±è¦è€ƒè™‘åˆ°è¿™äº›å¼‚å¸¸æƒ…å†µçš„å‘ç”Ÿï¼Œä½¿å¾—ç³»ç»Ÿå…·å¤‡æœåŠ¡å®¹é”™èƒ½åŠ›ã€‚ å¸¸è§çš„æœåŠ¡é”™è¯¯æ–¹æ¡ˆåŒ…å«ï¼šæœåŠ¡é™æµã€æœåŠ¡éš”ç¦»ã€æœåŠ¡è¶…æ—¶ã€æœåŠ¡ç†”æ–­å’ŒæœåŠ¡é™çº§ç­‰ã€‚ æœåŠ¡é™æµ æœåŠ¡é™æµå°±æ˜¯é™åˆ¶è¿›å…¥ç³»ç»Ÿçš„æµé‡ï¼Œä»¥é˜²æ­¢è¿›å…¥ç³»ç»Ÿçš„æµé‡è¿‡å¤§è€Œå‹å®ç³»ç»Ÿã€‚å…¶ä¸»è¦çš„ä½œç”¨å°±æ˜¯ä¿æŠ¤æœåŠ¡èŠ‚ç‚¹æˆ–è€…é›†ç¾¤åé¢çš„æ•°æ®èŠ‚ç‚¹ï¼Œé˜²æ­¢ç¬æ—¶æµé‡è¿‡å¤§ä½¿æœåŠ¡å’Œæ•°æ®å´©æºƒï¼ˆå¦‚å‰ç«¯ç¼“å­˜å¤§é‡å®æ•ˆï¼‰ï¼Œé€ æˆä¸å¯ç”¨ï¼›è¿˜å¯ç”¨äºå¹³æ»‘è¯·æ±‚ã€‚ é™æµç®—æ³•æœ‰ä¸¤ç§ï¼Œä¸€ç§å°±æ˜¯ç®€å•çš„è¯·æ±‚æ€»é‡è®¡æ•°ï¼Œä¸€ç§å°±æ˜¯æ—¶é—´çª—å£é™æµï¼ˆä¸€èˆ¬ä¸º1sï¼‰ï¼Œå¦‚ä»¤ç‰Œæ¡¶ç®—æ³•å’Œæ¼ç‰Œæ¡¶ç®—æ³•å°±æ˜¯æ—¶é—´çª—å£çš„é™æµç®—æ³•ã€‚ æœåŠ¡éš”ç¦» æœåŠ¡éš”ç¦»æœ‰ç‚¹ç±»ä¼¼äºç³»ç»Ÿçš„å‚ç›´æ‹†åˆ†ï¼Œå°±æŒ‰ç…§ä¸€å®šçš„è§„åˆ™å°†ç³»ç»Ÿåˆ’åˆ†æˆå¤šä¸ªæœåŠ¡æ¨¡å—ï¼Œå¹¶ä¸”æ¯ä¸ªæœåŠ¡æ¨¡å—ä¹‹é—´æ˜¯äº’ç›¸ç‹¬ç«‹çš„ï¼Œä¸ä¼šå­˜åœ¨å¼ºä¾èµ–çš„å…³ç³»ã€‚å¦‚æœæŸä¸ªæ‹†åˆ†åçš„æœåŠ¡å‘ç”Ÿæ•…éšœåï¼Œèƒ½å¤Ÿå°†æ•…éšœäº§ç”Ÿçš„å½±å“é™åˆ¶åœ¨æŸä¸ªå…·ä½“çš„æœåŠ¡å†…ï¼Œä¸ä¼šå‘å…¶ä»–æœåŠ¡æ‰©æ•£ï¼Œè‡ªç„¶ä¹Ÿå°±ä¸ä¼šå¯¹æ•´ä½“æœåŠ¡äº§ç”Ÿè‡´å‘½çš„å½±å“ã€‚ äº’è”ç½‘è¡Œä¸šå¸¸ç”¨çš„æœåŠ¡éš”ç¦»æ–¹å¼æœ‰ï¼šçº¿ç¨‹æ± éš”ç¦»å’Œä¿¡å·é‡éš”ç¦»ã€‚ æœåŠ¡è¶…æ—¶ æ•´ä¸ªç³»ç»Ÿé‡‡ç”¨åˆ†å¸ƒå¼å’Œå¾®æœåŠ¡æ¶æ„åï¼Œç³»ç»Ÿè¢«æ‹†åˆ†æˆä¸€ä¸ªä¸ªå°æœåŠ¡ï¼Œå°±ä¼šå­˜åœ¨æœåŠ¡ä¸æœåŠ¡ä¹‹é—´äº’ç›¸è°ƒç”¨çš„ç°è±¡ï¼Œä»è€Œå½¢æˆä¸€ä¸ªä¸ªè°ƒç”¨é“¾ã€‚å½¢æˆè°ƒç”¨é“¾å…³ç³»çš„ä¸¤ä¸ªæœåŠ¡ä¸­ï¼Œä¸»åŠ¨è°ƒç”¨å…¶ä»–æœåŠ¡æ¥å£çš„æœåŠ¡å¤„äºè°ƒç”¨é“¾çš„ä¸Šæ¸¸ï¼Œæä¾›æ¥å£ä¾›å…¶ä»–æœåŠ¡è°ƒç”¨çš„æœåŠ¡å¤„äºè°ƒç”¨é“¾çš„ä¸‹æ¸¸ã€‚ æœåŠ¡è¶…æ—¶å°±æ˜¯åœ¨ä¸Šæ¸¸æœåŠ¡è°ƒç”¨ä¸‹æ¸¸æœåŠ¡æ—¶ï¼Œè®¾ç½®ä¸€ä¸ªæœ€å¤§å“åº”æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªæœ€å¤§å“åº”æ—¶é—´ä¸‹æ¸¸æœåŠ¡è¿˜æœªè¿”å›ç»“æœï¼Œåˆ™æ–­å¼€ä¸Šæ¸¸æœåŠ¡ä¸ä¸‹æ¸¸æœåŠ¡ä¹‹é—´çš„è¯·æ±‚è¿æ¥ï¼Œé‡Šæ”¾èµ„æºã€‚ æœåŠ¡ç†”æ–­ åœ¨åˆ†å¸ƒå¼ä¸å¾®æœåŠ¡ç³»ç»Ÿä¸­ï¼Œå¦‚æœä¸‹æ¸¸æœåŠ¡å› ä¸ºè®¿é—®å‹åŠ›è¿‡å¤§å¯¼è‡´å“åº”å¾ˆæ…¢æˆ–è€…ä¸€ç›´è°ƒç”¨å¤±è´¥æ—¶ï¼Œä¸Šæ¸¸æœåŠ¡ä¸ºäº†ä¿è¯ç³»ç»Ÿçš„æ•´ä½“å¯ç”¨æ€§ï¼Œä¼šæš‚æ—¶æ–­å¼€ä¸ä¸‹æ¸¸æœåŠ¡çš„è°ƒç”¨è¿æ¥ã€‚è¿™ç§æ–¹å¼å°±æ˜¯ç†”æ–­ã€‚ æœåŠ¡ç†”æ–­ä¸€èˆ¬æƒ…å†µä¸‹ä¼šæœ‰ä¸‰ç§çŠ¶æ€ï¼šå…³é—­ã€å¼€å¯å’ŒåŠç†”æ–­ã€‚ å…³é—­çŠ¶æ€ï¼šæœåŠ¡ä¸€åˆ‡æ­£å¸¸ï¼Œæ²¡æœ‰æ•…éšœæ—¶ï¼Œä¸Šæ¸¸æœåŠ¡è°ƒç”¨ä¸‹æ¸¸æœåŠ¡æ—¶ï¼Œä¸ä¼šæœ‰ä»»ä½•é™åˆ¶ã€‚ å¼€å¯çŠ¶æ€ï¼šä¸Šæ¸¸æœåŠ¡ä¸å†è°ƒç”¨ä¸‹æ¸¸æœåŠ¡çš„æ¥å£ï¼Œä¼šç›´æ¥è¿”å›ä¸Šæ¸¸æœåŠ¡ä¸­é¢„å®šçš„æ–¹æ³•ã€‚ åŠç†”æ–­çŠ¶æ€ï¼šå¤„äºå¼€å¯çŠ¶æ€æ—¶ï¼Œä¸Šæ¸¸æœåŠ¡ä¼šæ ¹æ®ä¸€å®šçš„è§„åˆ™ï¼Œå°è¯•æ¢å¤å¯¹ä¸‹æ¸¸æœåŠ¡çš„è°ƒç”¨ã€‚æ­¤æ—¶ï¼Œä¸Šæ¸¸æœåŠ¡ä¼šä»¥æœ‰é™çš„æµé‡æ¥è°ƒç”¨ä¸‹æ¸¸æœåŠ¡ï¼ŒåŒæ—¶ï¼Œä¼šç›‘æ§è°ƒç”¨çš„æˆåŠŸç‡ã€‚å¦‚æœæˆåŠŸç‡è¾¾åˆ°é¢„æœŸï¼Œåˆ™è¿›å…¥å…³é—­çŠ¶æ€ã€‚å¦‚æœæœªè¾¾åˆ°é¢„æœŸï¼Œä¼šé‡æ–°è¿›å…¥å¼€å¯çŠ¶æ€ã€‚ æœåŠ¡é™çº§ æœåŠ¡é™çº§ï¼Œè¯´ç™½äº†å°±æ˜¯ä¸€ç§æœåŠ¡æ‰˜åº•æ–¹æ¡ˆï¼Œå¦‚æœæœåŠ¡æ— æ³•å®Œæˆæ­£å¸¸çš„è°ƒç”¨æµç¨‹ï¼Œå°±ä½¿ç”¨é»˜è®¤çš„æ‰˜åº•æ–¹æ¡ˆæ¥è¿”å›æ•°æ®ã€‚ä¾‹å¦‚ï¼Œåœ¨å•†å“è¯¦æƒ…é¡µä¸€èˆ¬éƒ½ä¼šå±•ç¤ºå•†å“çš„ä»‹ç»ä¿¡æ¯ï¼Œä¸€æ—¦å•†å“è¯¦æƒ…é¡µç³»ç»Ÿå‡ºç°æ•…éšœæ— æ³•è°ƒç”¨æ—¶ï¼Œä¼šç›´æ¥è·å–ç¼“å­˜ä¸­çš„å•†å“ä»‹ç»ä¿¡æ¯è¿”å›ç»™å‰ç«¯é¡µé¢ã€‚ ","link":"https://tianxiawuhao.github.io/WLM-Ra1r4/"},{"title":"nocasé•¿è½®è¯¢","content":"å‰è¨€ ä¼ ç»Ÿçš„é™æ€é…ç½®æ–¹å¼æƒ³è¦ä¿®æ”¹æŸä¸ªé…ç½®æ—¶ï¼Œå¿…é¡»é‡æ–°å¯åŠ¨ä¸€æ¬¡åº”ç”¨ï¼Œå¦‚æœæ˜¯æ•°æ®åº“è¿æ¥ä¸²çš„å˜æ›´ï¼Œé‚£å¯èƒ½è¿˜å®¹æ˜“æ¥å—ä¸€äº›ï¼Œä½†å¦‚æœå˜æ›´çš„æ˜¯ä¸€äº›è¿è¡Œæ—¶å®æ—¶æ„ŸçŸ¥çš„é…ç½®ï¼Œå¦‚æŸä¸ªåŠŸèƒ½é¡¹çš„å¼€å…³ï¼Œé‡å¯åº”ç”¨å°±æ˜¾å¾—æœ‰ç‚¹å¤§åŠ¨å¹²æˆˆäº†ã€‚ é…ç½®ä¸­å¿ƒæ­£æ˜¯ä¸ºäº†è§£å†³æ­¤ç±»é—®é¢˜åº”è¿è€Œç”Ÿçš„ï¼Œç‰¹åˆ«æ˜¯åœ¨å¾®æœåŠ¡æ¶æ„ä½“ç³»ä¸­ï¼Œæ›´å€¾å‘äºä½¿ç”¨é…ç½®ä¸­å¿ƒæ¥ç»Ÿä¸€ç®¡ç†é…ç½®ã€‚ é…ç½®ä¸­å¿ƒæœ€æ ¸å¿ƒçš„èƒ½åŠ›å°±æ˜¯é…ç½®çš„åŠ¨æ€æ¨é€ï¼Œå¸¸è§çš„é…ç½®ä¸­å¿ƒå¦‚ Nacosã€Apollo ç­‰éƒ½å®ç°äº†è¿™æ ·çš„èƒ½åŠ›ã€‚ åœ¨æ—©æœŸæ¥è§¦é…ç½®ä¸­å¿ƒæ—¶ï¼Œæˆ‘å°±å¾ˆå¥½å¥‡ï¼Œé…ç½®ä¸­å¿ƒæ˜¯å¦‚ä½•åšåˆ°æœåŠ¡ç«¯æ„ŸçŸ¥é…ç½®å˜åŒ–å®æ—¶æ¨é€ç»™å®¢æˆ·ç«¯çš„ï¼Ÿ åœ¨æ²¡æœ‰ç ”ç©¶è¿‡é…ç½®ä¸­å¿ƒçš„å®ç°åŸç†ä¹‹å‰ï¼Œæˆ‘ä¸€åº¦è®¤ä¸ºé…ç½®ä¸­å¿ƒæ˜¯é€šè¿‡é•¿è¿æ¥æ¥åšåˆ°é…ç½®æ¨é€çš„ã€‚ äº‹å®ä¸Šï¼Œç›®å‰æ¯”è¾ƒæµè¡Œçš„ä¸¤æ¬¾é…ç½®ä¸­å¿ƒï¼šNacos å’Œ Apollo æ°æ°éƒ½æ²¡æœ‰ä½¿ç”¨é•¿è¿æ¥ï¼Œè€Œæ˜¯ä½¿ç”¨çš„é•¿è½®è¯¢ã€‚ æœ¬æ–‡ä¾¿æ˜¯ä»‹ç»ä¸€ä¸‹é•¿è½®è¯¢è¿™ç§å¬èµ·æ¥å¥½åƒå·²ç»æ˜¯ä¸Šä¸ªä¸–çºªçš„æŠ€æœ¯ï¼Œè€æˆæ–°å”±ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½å“å‡ºåˆ«æ ·çš„éŸµå‘³ã€‚ æ–‡ä¸­ä¼šæœ‰ä»£ç ç¤ºä¾‹ï¼Œå‘ˆç°ä¸€ä¸ªç®€æ˜“çš„é…ç½®ç›‘å¬æµç¨‹ã€‚ æ•°æ®äº¤äº’æ¨¡å¼ ä¼—æ‰€å‘¨çŸ¥ï¼Œæ•°æ®äº¤äº’æœ‰ä¸¤ç§æ¨¡å¼ï¼šPushï¼ˆæ¨æ¨¡å¼ï¼‰å’Œ Pullï¼ˆæ‹‰æ¨¡å¼ï¼‰ã€‚ æ¨æ¨¡å¼æŒ‡çš„æ˜¯å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å»ºç«‹å¥½ç½‘ç»œé•¿è¿æ¥ï¼ŒæœåŠ¡æ–¹æœ‰ç›¸å…³æ•°æ®ï¼Œç›´æ¥é€šè¿‡é•¿è¿æ¥é€šé“æ¨é€åˆ°å®¢æˆ·ç«¯ã€‚ å…¶ä¼˜ç‚¹æ˜¯åŠæ—¶ï¼Œä¸€æ—¦æœ‰æ•°æ®å˜æ›´ï¼Œå®¢æˆ·ç«¯ç«‹é©¬èƒ½æ„ŸçŸ¥åˆ°ï¼›å¦å¤–å¯¹å®¢æˆ·ç«¯æ¥è¯´é€»è¾‘ç®€å•ï¼Œä¸éœ€è¦å…³å¿ƒæœ‰æ— æ•°æ®è¿™äº›é€»è¾‘å¤„ç†ã€‚ç¼ºç‚¹æ˜¯ä¸çŸ¥é“å®¢æˆ·ç«¯çš„æ•°æ®æ¶ˆè´¹èƒ½åŠ›ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ç§¯å‹åœ¨å®¢æˆ·ç«¯ï¼Œæ¥ä¸åŠå¤„ç†ã€‚ æ‹‰æ¨¡å¼æŒ‡çš„æ˜¯å®¢æˆ·ç«¯ä¸»åŠ¨å‘æœåŠ¡ç«¯å‘å‡ºè¯·æ±‚ï¼Œæ‹‰å–ç›¸å…³æ•°æ®ã€‚ å…¶ä¼˜ç‚¹æ˜¯æ­¤è¿‡ç¨‹ç”±å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼Œæ•…ä¸å­˜åœ¨æ¨æ¨¡å¼ä¸­æ•°æ®ç§¯å‹çš„é—®é¢˜ã€‚ç¼ºç‚¹æ˜¯å¯èƒ½ä¸å¤ŸåŠæ—¶ï¼Œå¯¹å®¢æˆ·ç«¯æ¥è¯´éœ€è¦è€ƒè™‘æ•°æ®æ‹‰å–ç›¸å…³é€»è¾‘ï¼Œä½•æ—¶å»æ‹‰ï¼Œæ‹‰çš„é¢‘ç‡æ€ä¹ˆæ§åˆ¶ç­‰ç­‰ã€‚ é•¿è½®è¯¢ä¸è½®è¯¢ åœ¨å¼€å¤´ï¼Œé‡ç‚¹ä»‹ç»ä¸€ä¸‹é•¿è½®è¯¢ï¼ˆLong Pollingï¼‰å’Œè½®è¯¢ï¼ˆPollingï¼‰çš„åŒºåˆ«ï¼Œä¸¤è€…éƒ½æ˜¯æ‹‰æ¨¡å¼çš„å®ç°ã€‚ ã€Œè½®è¯¢ã€æ˜¯æŒ‡ä¸ç®¡æœåŠ¡ç«¯æ•°æ®æœ‰æ— æ›´æ–°ï¼Œå®¢æˆ·ç«¯æ¯éš”å®šé•¿æ—¶é—´è¯·æ±‚æ‹‰å–ä¸€æ¬¡æ•°æ®ï¼Œå¯èƒ½æœ‰æ›´æ–°æ•°æ®è¿”å›ï¼Œä¹Ÿå¯èƒ½ä»€ä¹ˆéƒ½æ²¡æœ‰ã€‚ é…ç½®ä¸­å¿ƒå¦‚æœä½¿ç”¨ã€Œè½®è¯¢ã€å®ç°åŠ¨æ€æ¨é€ï¼Œä¼šæœ‰ä»¥ä¸‹é—®é¢˜ï¼š æ¨é€å»¶è¿Ÿã€‚å®¢æˆ·ç«¯æ¯éš” 5s æ‹‰å–ä¸€æ¬¡é…ç½®ï¼Œè‹¥é…ç½®å˜æ›´å‘ç”Ÿåœ¨ç¬¬ 6sï¼Œåˆ™é…ç½®æ¨é€çš„å»¶è¿Ÿä¼šè¾¾åˆ° 4sã€‚ æœåŠ¡ç«¯å‹åŠ›ã€‚é…ç½®ä¸€èˆ¬ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œé¢‘ç¹çš„è½®è¯¢ä¼šç»™æœåŠ¡ç«¯é€ æˆå¾ˆå¤§çš„å‹åŠ›ã€‚ æ¨é€å»¶è¿Ÿå’ŒæœåŠ¡ç«¯å‹åŠ›æ— æ³•ä¸­å’Œã€‚é™ä½è½®è¯¢çš„é—´éš”ï¼Œå»¶è¿Ÿé™ä½ï¼Œå‹åŠ›å¢åŠ ï¼›å¢åŠ è½®è¯¢çš„é—´éš”ï¼Œå‹åŠ›é™ä½ï¼Œå»¶è¿Ÿå¢é«˜ã€‚ ã€Œé•¿è½®è¯¢ã€åˆ™ä¸å­˜åœ¨ä¸Šè¿°çš„é—®é¢˜ã€‚ å®¢æˆ·ç«¯å‘èµ·é•¿è½®è¯¢ï¼Œå¦‚æœæœåŠ¡ç«¯çš„æ•°æ®æ²¡æœ‰å‘ç”Ÿå˜æ›´ï¼Œä¼š hold ä½è¯·æ±‚ï¼Œç›´åˆ°æœåŠ¡ç«¯çš„æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œæˆ–è€…ç­‰å¾…ä¸€å®šæ—¶é—´è¶…æ—¶æ‰ä¼šè¿”å›ã€‚è¿”å›åï¼Œå®¢æˆ·ç«¯åˆä¼šç«‹å³å†æ¬¡å‘èµ·ä¸‹ä¸€æ¬¡é•¿è½®è¯¢ã€‚ é…ç½®ä¸­å¿ƒä½¿ç”¨ã€Œé•¿è½®è¯¢ã€å¦‚ä½•è§£å†³ã€Œè½®è¯¢ã€é‡åˆ°çš„é—®é¢˜ä¹Ÿå°±æ˜¾è€Œæ˜“è§äº†ï¼š æ¨é€å»¶è¿Ÿã€‚æœåŠ¡ç«¯æ•°æ®å‘ç”Ÿå˜æ›´åï¼Œé•¿è½®è¯¢ç»“æŸï¼Œç«‹åˆ»è¿”å›å“åº”ç»™å®¢æˆ·ç«¯ã€‚ æœåŠ¡ç«¯å‹åŠ›ã€‚é•¿è½®è¯¢çš„é—´éš”æœŸä¸€èˆ¬å¾ˆé•¿ï¼Œä¾‹å¦‚ 30sã€60sï¼Œå¹¶ä¸”æœåŠ¡ç«¯ hold ä½è¿æ¥ä¸ä¼šæ¶ˆè€—å¤ªå¤šæœåŠ¡ç«¯èµ„æºã€‚ ä»¥ Nacos ä¸ºä¾‹çš„é•¿è½®è¯¢æµç¨‹å¦‚ä¸‹ï¼š å¯èƒ½æœ‰äººä¼šæœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆä¸€æ¬¡é•¿è½®è¯¢éœ€è¦ç­‰å¾…ä¸€å®šæ—¶é—´è¶…æ—¶ï¼Œè¶…æ—¶ååˆå‘èµ·é•¿è½®è¯¢ï¼Œä¸ºä»€ä¹ˆä¸è®©æœåŠ¡ç«¯ä¸€ç›´ hold ä½ï¼Ÿ ä¸»è¦æœ‰ä¸¤ä¸ªå±‚é¢çš„è€ƒè™‘ï¼Œä¸€æ˜¯è¿æ¥ç¨³å®šæ€§çš„è€ƒè™‘ï¼Œé•¿è½®è¯¢åœ¨ä¼ è¾“å±‚æœ¬è´¨ä¸Šè¿˜æ˜¯èµ°çš„ TCP åè®®ï¼Œå¦‚æœæœåŠ¡ç«¯å‡æ­»ã€fullgc ç­‰å¼‚å¸¸é—®é¢˜ï¼Œæˆ–è€…æ˜¯é‡å¯ç­‰å¸¸è§„æ“ä½œï¼Œé•¿è½®è¯¢æ²¡æœ‰åº”ç”¨å±‚çš„å¿ƒè·³æœºåˆ¶ï¼Œä»…ä»…ä¾é  TCP å±‚çš„å¿ƒè·³ä¿æ´»å¾ˆéš¾ç¡®ä¿å¯ç”¨æ€§ï¼Œæ‰€ä»¥ä¸€æ¬¡é•¿è½®è¯¢è®¾ç½®ä¸€å®šçš„è¶…æ—¶æ—¶é—´ä¹Ÿæ˜¯åœ¨ç¡®ä¿å¯ç”¨æ€§ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨é…ç½®ä¸­å¿ƒåœºæ™¯ï¼Œè¿˜æœ‰ä¸€å®šçš„ä¸šåŠ¡éœ€æ±‚éœ€è¦è¿™ä¹ˆè®¾è®¡ã€‚ åœ¨é…ç½®ä¸­å¿ƒçš„ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·å¯èƒ½éšæ—¶æ–°å¢é…ç½®ç›‘å¬ï¼Œè€Œåœ¨æ­¤ä¹‹å‰ï¼Œé•¿è½®è¯¢å¯èƒ½å·²ç»å‘å‡ºï¼Œæ–°å¢çš„é…ç½®ç›‘å¬æ— æ³•åŒ…å«åœ¨æ—§çš„é•¿è½®è¯¢ä¸­ï¼Œæ‰€ä»¥åœ¨é…ç½®ä¸­å¿ƒçš„è®¾è®¡ä¸­ï¼Œä¸€èˆ¬ä¼šåœ¨ä¸€æ¬¡é•¿è½®è¯¢ç»“æŸåï¼Œå°†æ–°å¢çš„é…ç½®ç›‘å¬ç»™æå¸¦ä¸Šï¼Œè€Œå¦‚æœé•¿è½®è¯¢æ²¡æœ‰è¶…æ—¶æ—¶é—´ï¼Œåªè¦é…ç½®ä¸€ç›´ä¸å‘ç”Ÿå˜åŒ–ï¼Œå“åº”å°±æ— æ³•è¿”å›ï¼Œæ–°å¢çš„é…ç½®ä¹Ÿå°±æ²¡æ³•è®¾ç½®ç›‘å¬äº†ã€‚ é…ç½®ä¸­å¿ƒé•¿è½®è¯¢è®¾è®¡ ä¸Šæ–‡çš„å›¾ä¸­ï¼Œä»‹ç»äº†é•¿è½®è¯¢çš„æµç¨‹ï¼Œæœ¬èŠ‚ä¼šè¯¦è§£é…ç½®ä¸­å¿ƒé•¿è½®è¯¢çš„è®¾è®¡ç»†èŠ‚ã€‚ å®¢æˆ·ç«¯å‘èµ·é•¿è½®è¯¢ å®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ª HTTP è¯·æ±‚ï¼Œè¯·æ±‚ä¿¡æ¯åŒ…å«é…ç½®ä¸­å¿ƒçš„åœ°å€ï¼Œä»¥åŠç›‘å¬çš„ dataIdï¼ˆæœ¬æ–‡å‡ºäºç®€åŒ–è¯´æ˜çš„è€ƒè™‘ï¼Œè®¤ä¸º dataId æ˜¯å®šä½é…ç½®çš„å”¯ä¸€é”®ï¼‰ã€‚è‹¥é…ç½®æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´ä¸€ç›´å¤„äºè¿æ¥çŠ¶æ€ã€‚ æœåŠ¡ç«¯ç›‘å¬æ•°æ®å˜åŒ– æœåŠ¡ç«¯ä¼šç»´æŠ¤ dataId å’Œé•¿è½®è¯¢çš„æ˜ å°„å…³ç³»ï¼Œå¦‚æœé…ç½®å‘ç”Ÿå˜åŒ–ï¼ŒæœåŠ¡ç«¯ä¼šæ‰¾åˆ°å¯¹åº”çš„è¿æ¥ï¼Œä¸ºå“åº”å†™å…¥æ›´æ–°åçš„é…ç½®å†…å®¹ã€‚å¦‚æœè¶…æ—¶å†…é…ç½®æœªå‘ç”Ÿå˜åŒ–ï¼ŒæœåŠ¡ç«¯æ‰¾åˆ°å¯¹åº”çš„è¶…æ—¶é•¿è½®è¯¢è¿æ¥ï¼Œå†™å…¥ 304 å“åº”ã€‚ 304 åœ¨ HTTP å“åº”ç ä¸­ä»£è¡¨â€œæœªæ”¹å˜â€ï¼Œå¹¶ä¸ä»£è¡¨é”™è¯¯ã€‚æ¯”è¾ƒå¥‘åˆé•¿è½®è¯¢æ—¶ï¼Œé…ç½®æœªå‘ç”Ÿå˜æ›´çš„åœºæ™¯ã€‚ å®¢æˆ·ç«¯æ¥æ”¶é•¿è½®è¯¢å“åº” é¦–å…ˆæŸ¥çœ‹å“åº”ç æ˜¯ 200 è¿˜æ˜¯ 304ï¼Œä»¥åˆ¤æ–­é…ç½®æ˜¯å¦å˜æ›´ï¼Œåšå‡ºç›¸åº”çš„å›è°ƒã€‚ä¹‹åå†æ¬¡å‘èµ·ä¸‹ä¸€æ¬¡é•¿è½®è¯¢ã€‚ æœåŠ¡ç«¯è®¾ç½®é…ç½®å†™å…¥çš„æ¥å…¥ç‚¹ ä¸»è¦ç”¨é…ç½®æ§åˆ¶å°å’Œ client å‘å¸ƒé…ç½®ï¼Œè§¦å‘é…ç½®å˜æ›´ è¿™å‡ ç‚¹ä¾¿æ˜¯é…ç½®ä¸­å¿ƒå®ç°é•¿è½®è¯¢çš„æ ¸å¿ƒæ­¥éª¤ï¼Œä¹Ÿæ˜¯æŒ‡å¯¼ä¸‹é¢ç« èŠ‚ä»£ç å®ç°çš„å…³é”®ã€‚ä½†åœ¨ç¼–ç ä¹‹å‰ï¼Œä»æœ‰ä¸€äº›å…¶ä»–çš„æ³¨æ„ç‚¹éœ€è¦å®ç°é˜æ˜ã€‚ é…ç½®ä¸­å¿ƒå¾€å¾€æ˜¯ä¸ºåˆ†å¸ƒå¼çš„é›†ç¾¤æä¾›æœåŠ¡çš„ï¼Œè€Œæ¯ä¸ªæœºå™¨ä¸Šéƒ¨ç½²çš„åº”ç”¨ï¼Œåˆä¼šæœ‰å¤šä¸ª dataId éœ€è¦ç›‘å¬ï¼Œå®ä¾‹çº§åˆ« * é…ç½®æ•°æ˜¯ä¸€ä¸ªä¸å°çš„æ•°å­—ï¼Œé…ç½®ä¸­å¿ƒæœåŠ¡ç«¯ç»´æŠ¤è¿™äº› dataId çš„é•¿è½®è¯¢è¿æ¥æ˜¾ç„¶ä¸èƒ½ç”¨çº¿ç¨‹ä¸€ä¸€å¯¹åº”ï¼Œå¦åˆ™ä¼šå¯¼è‡´æœåŠ¡ç«¯çº¿ç¨‹æ•°çˆ†ç‚¸å¼å¢é•¿ã€‚ ä¸€ä¸ª Tomcat é»˜è®¤ä¹Ÿå°± 200 ä¸ªçº¿ç¨‹ï¼Œé•¿è½®è¯¢ä¹Ÿä¸åº”è¯¥é˜»å¡ Tomcat çš„ä¸šåŠ¡çº¿ç¨‹ï¼Œæ‰€ä»¥éœ€è¦é…ç½®ä¸­å¿ƒåœ¨å®ç°é•¿è½®è¯¢æ—¶ï¼Œå¾€å¾€é‡‡ç”¨å¼‚æ­¥å“åº”çš„æ–¹å¼æ¥å®ç°ã€‚ è€Œæ¯”è¾ƒæ–¹ä¾¿å®ç°å¼‚æ­¥ HTTP çš„å¸¸è§æ‰‹æ®µä¾¿æ˜¯ Servlet3.0 æä¾›çš„ AsyncContext æœºåˆ¶ã€‚ Servlet3.0 å¹¶ä¸æ˜¯ä¸€ä¸ªç‰¹åˆ«æ–°çš„è§„èŒƒï¼Œå®ƒè·Ÿ Java 6 æ˜¯åŒä¸€æ—¶æœŸçš„äº§ç‰©ã€‚ä¾‹å¦‚ SpringBoot å†…åµŒçš„ Tomcat å¾ˆæ—©å°±æ”¯æŒäº† Servlet3.0ï¼Œä½ æ— éœ€æ‹…å¿ƒ AsyncContext æœºåˆ¶ä¸èµ·ä½œç”¨ã€‚ SpringMVC å®ç°äº† DeferredResult å’Œ Servlet3.0 æä¾›çš„ AsyncContext å…¶å®æ²¡æœ‰å¤šå¤§åŒºåˆ«ï¼Œæˆ‘å¹¶æ²¡æœ‰æ·±å…¥ç ”ç©¶è¿‡ä¸¤ä¸ªå®ç°èƒŒåçš„æºç ï¼Œä½†ä»ä½¿ç”¨å±‚é¢ä¸Šæ¥çœ‹ï¼ŒAsyncContext æ›´åŠ çš„çµæ´»ï¼Œä¾‹å¦‚å…¶å¯ä»¥è‡ªå®šä¹‰å“åº”ç ï¼Œè€Œ DeferredResult åœ¨ä¸Šå±‚åšäº†å°è£…ï¼Œå¯ä»¥å¿«é€Ÿçš„å¸®åŠ©å¼€å‘è€…å®ç°ä¸€ä¸ªå¼‚æ­¥å“åº”ï¼Œä½†æ²¡æ³•ç»†ç²’åº¦åœ°æ§åˆ¶å“åº”ã€‚ æ‰€ä»¥ä¸‹æ–‡çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘é€‰æ‹©äº† AsyncContextã€‚ é…ç½®ä¸­å¿ƒé•¿è½®è¯¢å®ç° &lt;!--æ³¨è§£å·¥å…·åŒ…--&gt; &lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;optional&gt;true&lt;/optional&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.httpcomponents&lt;/groupId&gt; &lt;artifactId&gt;httpclient&lt;/artifactId&gt; &lt;version&gt;4.5.2&lt;/version&gt; &lt;/dependency&gt; &lt;!-- https://mvnrepository.com/artifact/com.google.guava/guava --&gt; &lt;dependency&gt; &lt;groupId&gt;com.google.guava&lt;/groupId&gt; &lt;artifactId&gt;guava&lt;/artifactId&gt; &lt;version&gt;22.0&lt;/version&gt; &lt;/dependency&gt; å®¢æˆ·ç«¯å®ç° @Slf4j public class ConfigClient { private CloseableHttpClient httpClient; private RequestConfig requestConfig; public ConfigClient() { this.httpClient = HttpClientBuilder.create().build(); // â‘  httpClient å®¢æˆ·ç«¯è¶…æ—¶æ—¶é—´è¦å¤§äºé•¿è½®è¯¢çº¦å®šçš„è¶…æ—¶æ—¶é—´ this.requestConfig = RequestConfig.custom().setSocketTimeout(40000).build(); } @SneakyThrows public void longPolling(String url, String dataId) { String endpoint = url + &quot;?dataId=&quot; + dataId; HttpGet request = new HttpGet(endpoint); CloseableHttpResponse response = httpClient.execute(request); switch (response.getStatusLine().getStatusCode()) { case 200: { BufferedReader rd = new BufferedReader(new InputStreamReader(response.getEntity() .getContent())); StringBuilder result = new StringBuilder(); String line; while ((line = rd.readLine()) != null) { result.append(line); } response.close(); String configInfo = result.toString(); log.info(&quot;dataId: [{}] changed, receive configInfo: {}&quot;, dataId, configInfo); longPolling(url, dataId); break; } // â‘¡ 304 å“åº”ç æ ‡è®°é…ç½®æœªå˜æ›´ case 304: { log.info(&quot;longPolling dataId: [{}] once finished, configInfo is unchanged, longPolling again&quot;, dataId); longPolling(url, dataId); break; } default: { throw new RuntimeException(&quot;unExcepted HTTP status code&quot;); } } } public static void main(String[] args) { // httpClient ä¼šæ‰“å°å¾ˆå¤š debug æ—¥å¿—ï¼Œå…³é—­æ‰ Logger logger = (Logger)LoggerFactory.getLogger(&quot;org.apache.http&quot;); logger.setLevel(Level.INFO); logger.setAdditive(false); ConfigClient configClient = new ConfigClient(); // â‘¢ å¯¹ dataId: user è¿›è¡Œé…ç½®ç›‘å¬ configClient.longPolling(&quot;http://127.0.0.1:8080/listener&quot;, &quot;user&quot;); } } ä¸»è¦æœ‰ä¸‰ä¸ªæ³¨æ„ç‚¹ï¼š RequestConfig.custom().setSocketTimeout(40000).build() ã€‚httpClient å®¢æˆ·ç«¯è¶…æ—¶æ—¶é—´è¦å¤§äºé•¿è½®è¯¢çº¦å®šçš„è¶…æ—¶æ—¶é—´ã€‚å¾ˆå¥½ç†è§£ï¼Œä¸ç„¶è¿˜æ²¡ç­‰æœåŠ¡ç«¯è¿”å›ï¼Œå®¢æˆ·ç«¯ä¼šè‡ªè¡Œæ–­å¼€ HTTP è¿æ¥ã€‚ response.getStatusLine().getStatusCode() == 304 ã€‚å‰æ–‡ä»‹ç»è¿‡ï¼Œçº¦å®šä½¿ç”¨ 304 å“åº”ç æ¥æ ‡è¯†é…ç½®æœªå‘ç”Ÿå˜æ›´ï¼Œå®¢æˆ·ç«¯ç»§ç»­å‘èµ·é•¿è½®è¯¢ã€‚ configClient.longPolling(&quot;http://127.0.0.1:8080/listener&quot;, &quot;user&quot;)ã€‚åœ¨ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¤„äºç®€å•è€ƒè™‘ï¼Œä»…ä»…å¯åŠ¨ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œå¯¹å•ä¸€çš„ dataIdï¼šuser è¿›è¡Œç›‘å¬ï¼ˆæ³¨æ„ï¼Œéœ€è¦å…ˆå¯åŠ¨ server ç«¯ï¼‰ã€‚ æœåŠ¡ç«¯å®ç° @RestController @Slf4j @SpringBootApplication public class ConfigServer { @Data private static class AsyncTask { // é•¿è½®è¯¢è¯·æ±‚çš„ä¸Šä¸‹æ–‡ï¼ŒåŒ…å«è¯·æ±‚å’Œå“åº”ä½“ private AsyncContext asyncContext; // è¶…æ—¶æ ‡è®° private boolean timeout; public AsyncTask(AsyncContext asyncContext, boolean timeout) { this.asyncContext = asyncContext; this.timeout = timeout; } } // guava æä¾›çš„å¤šå€¼ Mapï¼Œä¸€ä¸ª key å¯ä»¥å¯¹åº”å¤šä¸ª value private Multimap&lt;String, AsyncTask&gt; dataIdContext = Multimaps.synchronizedSetMultimap(HashMultimap.create()); private ThreadFactory threadFactory = new ThreadFactoryBuilder().setNameFormat(&quot;longPolling-timeout-checker-%d&quot;) .build(); private ScheduledExecutorService timeoutChecker = new ScheduledThreadPoolExecutor(1, threadFactory); // é…ç½®ç›‘å¬æ¥å…¥ç‚¹ @RequestMapping(&quot;/listener&quot;) public void addListener(HttpServletRequest request, HttpServletResponse response) { String dataId = request.getParameter(&quot;dataId&quot;); // å¼€å¯å¼‚æ­¥ AsyncContext asyncContext = request.startAsync(request, response); AsyncTask asyncTask = new AsyncTask(asyncContext, true); // ç»´æŠ¤ dataId å’Œå¼‚æ­¥è¯·æ±‚ä¸Šä¸‹æ–‡çš„å…³è” dataIdContext.put(dataId, asyncTask); // å¯åŠ¨å®šæ—¶å™¨ï¼Œ30s åå†™å…¥ 304 å“åº” timeoutChecker.schedule(() -&gt; { if (asyncTask.isTimeout()) { dataIdContext.remove(dataId, asyncTask); response.setStatus(HttpServletResponse.SC_NOT_MODIFIED); asyncContext.complete(); } }, 30000, TimeUnit.MILLISECONDS); } // é…ç½®å‘å¸ƒæ¥å…¥ç‚¹ @RequestMapping(&quot;/publishConfig&quot;) @SneakyThrows public String publishConfig(String dataId, String configInfo) { log.info(&quot;publish configInfo dataId: [{}], configInfo: {}&quot;, dataId, configInfo); Collection&lt;AsyncTask&gt; asyncTasks = dataIdContext.removeAll(dataId); for (AsyncTask asyncTask : asyncTasks) { asyncTask.setTimeout(false); HttpServletResponse response = (HttpServletResponse)asyncTask.getAsyncContext().getResponse(); response.setStatus(HttpServletResponse.SC_OK); response.getWriter().println(configInfo); asyncTask.getAsyncContext().complete(); } return &quot;success&quot;; } public static void main(String[] args) { SpringApplication.run(ConfigServer.class, args); } } å¯¹ä¸Šè¿°å®ç°çš„ä¸€äº›è¯´æ˜ï¼š @RequestMapping(&quot;/listener&quot;) ï¼Œé…ç½®ç›‘å¬æ¥å…¥ç‚¹ï¼Œä¹Ÿæ˜¯é•¿è½®è¯¢çš„å…¥å£ã€‚åœ¨è·å– dataId ä¹‹åï¼Œä½¿ç”¨ request.startAsync å°†è¯·æ±‚è®¾ç½®ä¸ºå¼‚æ­¥ï¼Œè¿™æ ·åœ¨æ–¹æ³•ç»“æŸåï¼Œä¸ä¼šå ç”¨ Tomcat çš„çº¿ç¨‹æ± ã€‚ æ¥ç€ dataIdContext.put(dataId, asyncTask) ä¼šå°† dataId å’Œå¼‚æ­¥è¯·æ±‚ä¸Šä¸‹æ–‡ç»™å…³è”èµ·æ¥ï¼Œæ–¹ä¾¿é…ç½®å‘å¸ƒæ—¶ï¼Œæ‹¿åˆ°å¯¹åº”çš„ä¸Šä¸‹æ–‡ã€‚ æ³¨æ„è¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ª guava æä¾›çš„æ•°æ®ç»“æ„ Multimap&lt;String, AsyncTask&gt; dataIdContext ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¤šå€¼ Mapï¼Œä¸€ä¸ª key å¯ä»¥å¯¹åº”å¤šä¸ª valueï¼Œä½ ä¹Ÿå¯ä»¥ç†è§£ä¸º Map&lt;String,List&gt; ï¼Œä½†ä½¿ç”¨ Multimap ç»´æŠ¤èµ·æ¥å¯ä»¥æ›´æ–¹ä¾¿åœ°å¤„ç†ä¸€äº›å¹¶å‘é€»è¾‘ã€‚ è‡³äºä¸ºä»€ä¹ˆä¼šæœ‰å¤šå€¼ï¼Œå¾ˆå¥½ç†è§£ï¼Œå› ä¸ºé…ç½®ä¸­å¿ƒçš„ Server ç«¯ä¼šæ¥å—æ¥è‡ªå¤šä¸ªå®¢æˆ·ç«¯å¯¹åŒä¸€ä¸ª dataId çš„ç›‘å¬ã€‚ timeoutChecker.schedule() å¯åŠ¨å®šæ—¶å™¨ï¼Œ30s åå†™å…¥ 304 å“åº”ã€‚å†ç»“åˆä¹‹å‰å®¢æˆ·ç«¯çš„é€»è¾‘ï¼Œæ¥æ”¶åˆ° 304 ä¹‹åï¼Œä¼šé‡æ–°å‘èµ·é•¿è½®è¯¢ï¼Œå½¢æˆä¸€ä¸ªå¾ªç¯ã€‚ @RequestMapping(&quot;/publishConfig&quot;) ï¼Œé…ç½®å‘å¸ƒçš„å…¥å£ã€‚é…ç½®å˜æ›´åï¼Œæ ¹æ® dataId ä¸€æ¬¡æ‹¿å‡ºæ‰€æœ‰çš„é•¿è½®è¯¢ï¼Œä¸ºä¹‹å†™å…¥å˜æ›´çš„å“åº”ï¼ŒåŒæ—¶ä¸è¦å¿˜è®°å–æ¶ˆå®šæ—¶ä»»åŠ¡ã€‚è‡³æ­¤ï¼Œå®Œæˆäº†ä¸€ä¸ªé…ç½®å˜æ›´åæ¨é€çš„æµç¨‹ã€‚ å¯åŠ¨é…ç½®ç›‘å¬ å…ˆå¯åŠ¨ ConfigServerï¼Œå†å¯åŠ¨ ConfigClientã€‚å®¢æˆ·ç«¯æ‰“å°é•¿è½®è¯¢çš„æ—¥å¿—å¦‚ä¸‹ï¼š 22:18:09.185 [main] INFO moe.cnkirito.demo.ConfigClient - longPolling dataId: [user] once finished, configInfo is unchanged, longPolling again 22:18:39.197 [main] INFO moe.cnkirito.demo.ConfigClient - longPolling dataId: [user] once finished, configInfo is unchanged, longPolling again å‘å¸ƒä¸€æ¡é…ç½®ï¼Œcurl -X GET &quot;localhost:8080/publishConfig?dataId=user&amp;configInfo=helloworld&quot; æœåŠ¡ç«¯æ‰“å°æ—¥å¿—å¦‚ä¸‹ï¼š 22:18:50.801 INFO 73301 --- [nio-8080-exec-6] moe.cnkirito.demo.ConfigServer : publish configInfo dataId: [user], configInfo: helloworld å®¢æˆ·ç«¯æ¥å—é…ç½®æ¨é€ï¼š 22:18:50.806 [main] INFO moe.cnkirito.demo.ConfigClient - dataId: [user] changed, receive configInfo: helloworld å®ç°ç»†èŠ‚æ€è€ƒ ä¸ºä»€ä¹ˆéœ€è¦å®šæ—¶å™¨è¿”å› 304 ä¸Šè¿°çš„å®ç°ä¸­ï¼ŒæœåŠ¡ç«¯é‡‡ç”¨äº†ä¸€ä¸ªå®šæ—¶å™¨ï¼Œåœ¨é…ç½®æœªå‘ç”Ÿå˜æ›´æ—¶ï¼Œå®šæ—¶è¿”å› 304ï¼Œå®¢æˆ·ç«¯æ¥æ”¶åˆ° 304 ä¹‹åï¼Œé‡æ–°å‘èµ·é•¿è½®è¯¢ã€‚ åœ¨å‰æ–‡ï¼Œå·²ç»è§£é‡Šè¿‡äº†ä¸ºä»€ä¹ˆéœ€è¦è¶…æ—¶åé‡æ–°å‘èµ·é•¿è½®è¯¢ï¼Œè€Œä¸æ˜¯ç”±æœåŠ¡ç«¯ä¸€ç›´ holdï¼Œç›´åˆ°é…ç½®å˜æ›´å†è¿”å›ã€‚ ä½†å¯èƒ½æœ‰è¯»è€…è¿˜ä¼šæœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆä¸ç”±å®¢æˆ·ç«¯æ§åˆ¶è¶…æ—¶ï¼ŒæœåŠ¡ç«¯å»é™¤æ‰å®šæ—¶å™¨ï¼Œè¿™æ ·å®¢æˆ·ç«¯è¶…æ—¶åé‡æ–°å‘èµ·ä¸‹ä¸€æ¬¡é•¿è½®è¯¢ï¼Œè¿™æ ·çš„è®¾è®¡ä¸æ˜¯æ›´ç®€å•å—ï¼Ÿ æ— è®ºæ˜¯ Nacos è¿˜æ˜¯ Apollo éƒ½æœ‰è¿™æ ·çš„å®šæ—¶å™¨ï¼Œè€Œä¸æ˜¯é å®¢æˆ·ç«¯æ§åˆ¶è¶…æ—¶ï¼Œè¿™æ ·åšä¸»è¦æœ‰ä¸¤ç‚¹è€ƒè™‘ï¼š å’ŒçœŸæ­£çš„å®¢æˆ·ç«¯è¶…æ—¶åŒºåˆ†å¼€ã€‚ ä»…ä»…ä½¿ç”¨å¼‚å¸¸ï¼ˆExceptionï¼‰æ¥è¡¨è¾¾å¼‚å¸¸æµï¼Œè€Œä¸åº”è¯¥ç”¨å¼‚å¸¸æ¥è¡¨è¾¾æ­£å¸¸çš„ä¸šåŠ¡æµã€‚304 ä¸æ˜¯è¶…æ—¶å¼‚å¸¸ï¼Œè€Œæ˜¯é•¿è½®è¯¢ä¸­é…ç½®æœªå˜æ›´çš„ä¸€ç§æ­£å¸¸æµç¨‹ï¼Œä¸åº”è¯¥ä½¿ç”¨è¶…æ—¶å¼‚å¸¸æ¥è¡¨è¾¾ã€‚ å®¢æˆ·ç«¯è¶…æ—¶éœ€è¦å•ç‹¬é…ç½®ï¼Œä¸”éœ€è¦æ¯”æœåŠ¡ç«¯é•¿è½®è¯¢çš„è¶…æ—¶è¦é•¿ã€‚ æ­£å¦‚ä¸Šè¿°çš„ demo ä¸­å®¢æˆ·ç«¯è¶…æ—¶è®¾ç½®çš„æ˜¯ 40sï¼ŒæœåŠ¡ç«¯åˆ¤æ–­ä¸€æ¬¡é•¿è½®è¯¢è¶…æ—¶æ˜¯ 30sã€‚ è¿™ä¸¤ä¸ªå€¼åœ¨ Nacos ä¸­é»˜è®¤æ˜¯ 30s å’Œ 29.5sï¼Œåœ¨ Apollo ä¸­é»˜è®¤æ˜¯æ˜¯ 90s å’Œ 60sã€‚ é•¿è½®è¯¢åŒ…å«å¤šç»„ dataId åœ¨ä¸Šè¿°çš„ demo ä¸­ï¼Œä¸€ä¸ª dataId ä¼šå‘èµ·ä¸€æ¬¡é•¿è½®è¯¢ï¼Œåœ¨å®é™…é…ç½®ä¸­å¿ƒçš„è®¾è®¡ä¸­è‚¯å®šä¸èƒ½è¿™æ ·è®¾è®¡ï¼Œä¸€èˆ¬çš„ä¼˜åŒ–æ–¹å¼æ˜¯ï¼Œä¸€æ‰¹ dataId ç»„æˆä¸€ä¸ªç»„æ‰¹é‡åŒ…å«åœ¨ä¸€ä¸ªé•¿è½®è¯¢ä»»åŠ¡ä¸­ã€‚ åœ¨ Nacos ä¸­ï¼ŒæŒ‰ç…§ 3000 ä¸ª dataId ä¸ºä¸€ç»„åŒ…è£…æˆä¸€ä¸ªé•¿è½®è¯¢ä»»åŠ¡ã€‚ é•¿è½®è¯¢å’Œé•¿è¿æ¥ è®²å®Œå®ç°ç»†èŠ‚ï¼Œæœ¬æ–‡æœ€æ ¸å¿ƒçš„éƒ¨åˆ†å·²ç»ä»‹ç»å®Œäº†ã€‚ å†å›åˆ°æœ€å‰é¢æåˆ°çš„æ•°æ®äº¤äº’æ¨¡å¼ä¸Šæåˆ°çš„æ¨æ¨¡å‹å’Œæ‹‰æ¨¡å‹ï¼Œå…¶å®åœ¨å†™è¿™ç¯‡æ–‡ç« æ—¶ï¼Œæˆ‘æ›¾ç»é—®è¿‡äº¤æµç¾¤ä¸­çš„å°ä¼™ä¼´ä»¬â€œé…ç½®ä¸­å¿ƒå®ç°åŠ¨æ€æ¨é€çš„åŸç†â€ï¼Œä»–ä»¬ä¸­ç»å¤§å¤šæ•°äººè®¤ä¸ºæ˜¯é•¿è¿æ¥çš„æ¨æ¨¡å‹ã€‚ ç„¶è€Œäº‹å®ä¸Šï¼Œä¸»æµçš„é…ç½®ä¸­å¿ƒå‡ ä¹éƒ½æ˜¯ä½¿ç”¨äº†æœ¬æ–‡ä»‹ç»çš„é•¿è½®è¯¢æ–¹æ¡ˆï¼Œè¿™åˆæ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ æˆ‘ä¹Ÿç¿»é˜…äº†ä¸å°‘åšå®¢ï¼Œæ˜¾ç„¶ä»–ä»¬ç»™å‡ºçš„ç†ç”±å¹¶ä¸èƒ½è¯´æœæˆ‘ï¼Œæˆ‘å°è¯•ç€ä»è‡ªå·±çš„è§’åº¦åˆ†æäº†ä¸€ä¸‹è¿™ä¸ªæ—¢å®šçš„äº‹å®ã€‚ é•¿è½®è¯¢å®ç°èµ·æ¥æ¯”è¾ƒå®¹æ˜“ï¼Œå®Œå…¨ä¾èµ–äº HTTP ä¾¿å¯ä»¥å®ç°å…¨éƒ¨é€»è¾‘ï¼Œè€Œ HTTP æ˜¯æœ€èƒ½å¤Ÿè¢«å¤§ä¼—æ¥å—çš„é€šä¿¡æ–¹å¼ã€‚ é•¿è½®è¯¢ä½¿ç”¨ HTTPï¼Œä¾¿äºå¤šè¯­è¨€å®¢æˆ·ç«¯çš„ç¼–å†™ï¼Œå¤§å¤šæ•°è¯­è¨€éƒ½æœ‰ HTTP çš„å®¢æˆ·ç«¯ã€‚ é‚£ä¹ˆé•¿è¿æ¥æ˜¯ä¸æ˜¯çœŸçš„å°±ä¸é€‚åˆç”¨äºé…ç½®ä¸­å¿ƒåœºæ™¯å‘¢ï¼Ÿ æœ‰äººå¯èƒ½ä¼šè®¤ä¸ºç»´æŠ¤ä¸€æ¡é•¿è¿æ¥ä¼šæ¶ˆè€—å¤§é‡èµ„æºï¼Œè€Œé•¿è½®è¯¢å¯ä»¥æå‡ç³»ç»Ÿçš„ååé‡ï¼Œè€Œåœ¨é…ç½®ä¸­å¿ƒåœºæ™¯ï¼Œè¿™ä¸€å‡è®¾å¹¶æ²¡æœ‰å®é™…çš„å‹æµ‹æ•°æ®èƒ½å¤Ÿè®ºè¯ï¼Œbenchmark everythingï¼please~ å¦å¤–ï¼Œç¿»é˜…äº†ä¸€ä¸‹ Nacos 2.0 çš„ milestoneï¼Œæˆ‘å‘ç°äº†ä¸€ä¸ªæœ‰æ„æ€çš„è§„åˆ’ï¼ŒNacos çš„æ³¨å†Œä¸­å¿ƒï¼ˆç›®å‰æ˜¯çŸ­è½®è¯¢ + udp æ¨é€ï¼‰å’Œé…ç½®ä¸­å¿ƒï¼ˆç›®å‰æ˜¯é•¿è½®è¯¢ï¼‰éƒ½æœ‰è®¡åˆ’æ”¹é€ ä¸ºé•¿è¿æ¥æ¨¡å¼ã€‚ å†å›è¿‡å¤´æ¥çœ‹ï¼Œé•¿è½®è¯¢å®ç°å·²ç»å°†é…ç½®ä¸­å¿ƒè¿™ä¸ªç»„ä»¶æ”¯æ’‘çš„è¶³å¤Ÿå¥½äº†ï¼Œæ›¿æ¢æˆé•¿è¿æ¥ï¼Œä¸€å®šéœ€è¦æ‰¾åˆ°åˆé€‚çš„ç†ç”±æ‰è¡Œã€‚ æ€»ç»“ æœ¬æ–‡ä»‹ç»äº†é•¿è½®è¯¢ã€è½®è¯¢ã€é•¿è¿æ¥è¿™å‡ ç§æ•°æ®äº¤äº’æ¨¡å‹çš„å·®å¼‚æ€§ã€‚ åˆ†æäº† Nacos å’Œ Apollo ç­‰ä¸»æµé…ç½®ä¸­å¿ƒå‡æ˜¯é€šè¿‡é•¿è½®è¯¢çš„æ–¹å¼å®ç°é…ç½®çš„å®æ—¶æ¨é€çš„ã€‚å®æ—¶æ„ŸçŸ¥å»ºç«‹åœ¨å®¢æˆ·ç«¯æ‹‰çš„åŸºç¡€ä¸Šï¼Œå› ä¸ºæœ¬è´¨ä¸Šè¿˜æ˜¯é€šè¿‡ HTTP è¿›è¡Œçš„æ•°æ®äº¤äº’ï¼Œä¹‹æ‰€ä»¥æœ‰â€œæ¨â€çš„æ„Ÿè§‰ï¼Œæ˜¯å› ä¸ºæœåŠ¡ç«¯ hold ä½äº†å®¢æˆ·ç«¯çš„å“åº”ä½“ï¼Œå¹¶ä¸”åœ¨é…ç½®å˜æ›´åä¸»åŠ¨å†™å…¥äº†è¿”å› response å¯¹è±¡å†è¿›è¡Œè¿”å›ã€‚ é€šè¿‡ä¸€ä¸ªç®€å•çš„ demoï¼Œå®ç°äº†é•¿è½®è¯¢é…ç½®å®æ—¶æ¨é€çš„è¿‡ç¨‹æ¼”ç¤º ","link":"https://tianxiawuhao.github.io/t9Kci8xf6/"},{"title":"ZipKinæ ¸å¿ƒæ¶æ„","content":"ZipKinæ ¸å¿ƒæ¶æ„ Zipkin æ˜¯ Twitter çš„ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œå®ƒåŸºäºGoogle Dapperè®ºæ–‡å®ç°ï¼Œå¯ä»¥æ”¶é›†å¾®æœåŠ¡è¿è¡Œè¿‡ç¨‹ä¸­çš„å®æ—¶é“¾è·¯æ•°æ®ï¼Œå¹¶è¿›è¡Œå±•ç¤ºã€‚ ZipKinæ¦‚è¿° Zipkinæ˜¯ä¸€ç§åˆ†å¸ƒå¼é“¾è·¯è·Ÿè¸ªç³»ç»Ÿï¼Œèƒ½å¤Ÿæ”¶é›†å¾®æœåŠ¡è¿è¡Œè¿‡ç¨‹ä¸­çš„å®æ—¶è°ƒç”¨é“¾è·¯ä¿¡æ¯ï¼Œå¹¶èƒ½å¤Ÿå°†è¿™äº›è°ƒç”¨é“¾è·¯ä¿¡æ¯å±•ç¤ºåˆ°Webç•Œé¢ä¸Šä¾›å¼€å‘äººå‘˜åˆ†æï¼Œå¼€å‘äººå‘˜èƒ½å¤Ÿä»ZipKinä¸­åˆ†æå‡ºè°ƒç”¨é“¾è·¯ä¸­çš„æ€§èƒ½ç“¶é¢ˆï¼Œè¯†åˆ«å‡ºå­˜åœ¨é—®é¢˜çš„åº”ç”¨ç¨‹åºï¼Œè¿›è€Œå®šä½é—®é¢˜å’Œè§£å†³é—®é¢˜ã€‚ ZipKinæ ¸å¿ƒæ¶æ„ ZipKinçš„æ ¸å¿ƒæ¶æ„å›¾å¦‚ä¸‹æ‰€ç¤ºã€‚ æ³¨ï¼šå›¾ç‰‡æ¥æºï¼šzipkin.io/pages/architecture.html å…¶ä¸­ï¼ŒZipKinæ ¸å¿ƒç»„ä»¶çš„åŠŸèƒ½å¦‚ä¸‹æ‰€ç¤ºã€‚ Reporterï¼šZipKinä¸­ä¸ŠæŠ¥é“¾è·¯æ•°æ®çš„æ¨¡å—ï¼Œä¸»è¦é…ç½®åœ¨å…·ä½“çš„å¾®æœåŠ¡åº”ç”¨ä¸­ã€‚ Transportï¼šZipKinä¸­ä¼ è¾“é“¾è·¯æ•°æ®çš„æ¨¡å—ï¼Œæ­¤æ¨¡å—å¯ä»¥é…ç½®ä¸ºKafkaï¼ŒRocketMQã€RabbitMQç­‰ã€‚ Collectorï¼šZipKinä¸­æ”¶é›†å¹¶æ¶ˆè´¹é“¾è·¯æ•°æ®çš„æ¨¡å—ï¼Œé»˜è®¤æ˜¯é€šè¿‡httpåè®®æ”¶é›†ï¼Œå¯ä»¥é…ç½®ä¸ºKafkaæ¶ˆè´¹ã€‚ Storageï¼šZipKinä¸­å­˜å‚¨é“¾è·¯æ•°æ®çš„æ¨¡å—ï¼Œæ­¤æ¨¡å—çš„å…·ä½“å¯ä»¥é…ç½®ä¸ºElasticSearchã€Cassandraæˆ–è€…MySQLï¼Œç›®å‰ZipKinæ”¯æŒè¿™ä¸‰ç§æ•°æ®æŒä¹…åŒ–æ–¹å¼ã€‚ APIï¼šZipKinä¸­çš„API ç»„ä»¶ï¼Œä¸»è¦ç”¨æ¥æä¾›å¤–éƒ¨è®¿é—®æ¥å£ã€‚æ¯”å¦‚ç»™å®¢æˆ·ç«¯å±•ç¤ºè·Ÿè¸ªä¿¡æ¯ï¼Œæˆ–æ˜¯å¼€æ”¾ç»™å¤–éƒ¨ç³»ç»Ÿå®ç°ç›‘æ§ç­‰ã€‚ UIï¼šZipKinä¸­çš„UI ç»„ä»¶ï¼ŒåŸºäºAPIç»„ä»¶å®ç°çš„ä¸Šå±‚åº”ç”¨ã€‚é€šè¿‡UIç»„ä»¶ç”¨æˆ·å¯ä»¥æ–¹ä¾¿å¹¶ä¸”å¾ˆç›´è§‚åœ°æŸ¥è¯¢å’Œåˆ†æè·Ÿè¸ªä¿¡æ¯ã€‚ Zipkinåœ¨æ€»ä½“ä¸Šä¼šåˆ†ä¸ºä¸¤ä¸ªç«¯ï¼Œä¸€ä¸ªæ˜¯ZipkinæœåŠ¡ç«¯ï¼Œä¸€ä¸ªæ˜¯Zipkinå®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯ä¸»è¦æ˜¯é…ç½®åœ¨å¾®æœåŠ¡åº”ç”¨ä¸­ï¼Œæ”¶é›†å¾®æœåŠ¡ä¸­çš„è°ƒç”¨é“¾è·¯ä¿¡æ¯ï¼Œå°†æ•°æ®å‘é€ç»™ZipKinæœåŠ¡ç«¯ã€‚ é¡¹ç›®æ•´åˆZipKin Zipkinæ€»ä½“ä¸Šåˆ†ä¸ºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬éœ€è¦ä¸‹è½½å¹¶å¯åŠ¨ZipKinæœåŠ¡ç«¯çš„JaråŒ…ï¼Œåœ¨å¾®æœåŠ¡ä¸­é›†æˆZipKinçš„å®¢æˆ·ç«¯ã€‚ ä¸‹è½½å®‰è£…ZipKinæœåŠ¡ç«¯ ï¼ˆ1ï¼‰ä¸‹è½½ZipKinæœåŠ¡ç«¯Jaræ–‡ä»¶ï¼Œå¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­è¾“å…¥å¦‚ä¸‹é“¾æ¥è¿›è¡Œä¸‹è½½ã€‚ https://search.maven.org/remote_content?g=io.zipkin.java&amp;a=zipkin-server&amp;v=LATEST&amp;c=exec å¦‚æœå¤§å®¶ä½¿ç”¨çš„æ˜¯Linuxæ“ä½œç³»ç»Ÿï¼Œä¹Ÿå¯ä»¥åœ¨å‘½ä»¤è¡Œè¾“å…¥å¦‚ä¸‹å‘½ä»¤è¿›è¡Œä¸‹è½½ã€‚ wget https://search.maven.org/remote_content?g=io.zipkin.java&amp;a=zipkin-server&amp;v=LATEST&amp;c=exec è¿™é‡Œï¼Œæˆ‘é€šè¿‡æµè§ˆå™¨ä¸‹è½½çš„ZipKinæœåŠ¡ç«¯Jaræ–‡ä»¶ä¸ºï¼šzipkin-server-2.12.9-exec.jarã€‚ ï¼ˆ2ï¼‰åœ¨å‘½ä»¤è¡Œè¾“å…¥å¦‚ä¸‹å‘½ä»¤å¯åŠ¨ZipKinæœåŠ¡ç«¯ã€‚ java -jar zipkin-server-2.12.9-exec.jar ï¼ˆ3ï¼‰ç”±äºZipKinæœåŠ¡ç«¯å¯åŠ¨æ—¶ï¼Œé»˜è®¤ç›‘å¬çš„ç«¯å£å·ä¸º9411ï¼Œæ‰€ä»¥ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://localhost:9411é“¾æ¥å°±å¯ä»¥æ‰“å¼€ZipKinçš„ç•Œé¢ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ åœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://localhost:9411é“¾æ¥èƒ½å¤Ÿæ‰“å¼€ä¸Šè¿°é¡µé¢å°±è¯´æ˜ZipKinæœåŠ¡ç«¯å·²ç»å‡†å¤‡å¥½å•¦ã€‚ é¡¹ç›®æ•´åˆZipKinå®¢æˆ·ç«¯ ï¼ˆ1ï¼‰åœ¨æ¯ä¸ªå¾®æœåŠ¡ï¼ˆç”¨æˆ·å¾®æœåŠ¡shop-userï¼Œå•†å“å¾®æœåŠ¡shop-productï¼Œè®¢å•å¾®æœåŠ¡shop-orderï¼Œç½‘å…³æœåŠ¡shop-gatewayï¼‰ä¸­æ·»åŠ ZipKinä¾èµ–ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-zipkin&lt;/artifactId&gt; &lt;/dependency&gt; ï¼ˆ2ï¼‰åœ¨ç½‘å…³æœåŠ¡shop-gatewayçš„application.ymlæ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ã€‚ spring: sleuth: sampler: probability: 1.0 zipkin: base-url: http://127.0.0.1:9411 discovery-client-enabled: false å…¶ä¸­å„é…ç½®çš„è¯´æ˜å¦‚ä¸‹æ‰€ç¤ºã€‚ spring.sleuth.sampler.probabilityï¼šè¡¨ç¤ºSleuthçš„é‡‡æ ·ç™¾åˆ†æ¯”ã€‚ spring.zipkin.base-urlï¼šZipKinæœåŠ¡ç«¯çš„åœ°å€ã€‚ spring.zipkin.discovery-client-enabledï¼šé…ç½®æˆfalseï¼Œä½¿Nacoså°†å…¶å½“æˆä¸€ä¸ªURLï¼Œä¸è¦æŒ‰æœåŠ¡åå¤„ç†ã€‚ ï¼ˆ3ï¼‰åˆ†åˆ«å¯åŠ¨ç”¨æˆ·å¾®æœåŠ¡ï¼Œå•†å“å¾®æœåŠ¡ï¼Œè®¢å•å¾®æœåŠ¡å’ŒæœåŠ¡ç½‘å…³ï¼Œåœ¨æµè§ˆå™¨ä¸­è®¿é—®é“¾æ¥http://localhost:10001/server-order/order/submit_order?userId=1001&amp;productId=1001&amp;count=1ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ï¼ˆ4ï¼‰ç‚¹å‡»Zipkinç•Œé¢ä¸Šçš„æŸ¥æ‰¾æŒ‰é’®ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ç‚¹å‡»åçš„ç•Œé¢å¦‚ä¸‹æ‰€ç¤ºã€‚ å¯ä»¥çœ‹åˆ°ï¼Œç‚¹å‡»æŸ¥æ‰¾æŒ‰é’®åï¼Œä¼šå‡ºç°ä¸€ä¸ªè¯·æ±‚é“¾è·¯ï¼ŒåŒ…å«ï¼šç½‘å…³æœåŠ¡server-gatewayè€—æ—¶63.190æ¯«ç§’ï¼Œè®¢å•å¾®æœåŠ¡server-orderè€—æ—¶53.101æ¯«ç§’ï¼Œç”¨æˆ·å¾®æœåŠ¡server-userè€—æ—¶14.640æ¯«ç§’ï¼Œå•†å“å¾®æœåŠ¡server-productè€—æ—¶10.941æ¯«ç§’ã€‚ ï¼ˆ5ï¼‰ç‚¹å¼€ZipKinç•Œé¢ä¸Šæ˜¾ç¤ºçš„è°ƒç”¨é“¾è·¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ç‚¹å¼€åçš„ç•Œé¢å¦‚ä¸‹æ‰€ç¤ºã€‚ å¯ä»¥éå¸¸æ¸…æ™°çš„çœ‹åˆ°æ•´ä¸ªè°ƒç”¨çš„è®¿é—®é“¾è·¯ã€‚ æˆ‘ä»¬è¿˜å¯ä»¥ç‚¹å‡»å…·ä½“çš„èŠ‚ç‚¹æ¥æŸ¥çœ‹å…·ä½“çš„è°ƒç”¨ä¿¡æ¯ã€‚ ä¾‹å¦‚æˆ‘ä»¬ç‚¹å‡»ç½‘å…³å¾®æœåŠ¡æŸ¥çœ‹ç½‘å…³çš„å…·ä½“é“¾è·¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ç‚¹å¼€åçš„æ•ˆæœå¦‚ä¸‹æ‰€ç¤ºã€‚ æ¥ä¸‹æ¥ï¼ŒæŸ¥çœ‹ä¸‹è®¢å•å¾®æœåŠ¡çš„è°ƒç”¨é“¾è·¯å…·ä½“ä¿¡æ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ç‚¹å¼€åçš„æ•ˆæœå¦‚ä¸‹æ‰€ç¤ºã€‚ å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ZipKinèƒ½å¤ŸæŸ¥çœ‹æœåŠ¡çš„è°ƒç”¨é“¾è·¯ï¼Œå¹¶ä¸”èƒ½å¤ŸæŸ¥çœ‹å…·ä½“å¾®æœåŠ¡çš„è°ƒç”¨æƒ…å†µã€‚æˆ‘ä»¬å¯ä»¥åŸºäºZipKinæ¥åˆ†æç³»ç»Ÿçš„è°ƒç”¨é“¾è·¯æƒ…å†µï¼Œæ‰¾å‡ºç³»ç»Ÿçš„ç“¶é¢ˆç‚¹ï¼Œè¿›è€Œè¿›è¡Œé’ˆå¯¹æ€§çš„ä¼˜åŒ–ã€‚ å¦å¤–ï¼ŒZipKinä¸­ä¹Ÿæ”¯æŒä¸‹è½½ç³»ç»Ÿè°ƒç”¨é“¾è·¯çš„Jsonæ•°æ®ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ç‚¹å‡»JSONæŒ‰é’®åï¼Œæ•ˆæœå¦‚ä¸‹æ‰€ç¤ºã€‚ å…¶ä¸­ï¼Œæ˜¾ç¤ºçš„Jsonæ•°æ®å¦‚ä¸‹æ‰€ç¤ºã€‚ [ [ { &quot;traceId&quot;: &quot;9d244edbc1668d92&quot;, &quot;parentId&quot;: &quot;3f01ba499fac4ce9&quot;, &quot;id&quot;: &quot;5f0932b5d06fe757&quot;, &quot;kind&quot;: &quot;SERVER&quot;, &quot;name&quot;: &quot;get /get/{pid}&quot;, &quot;timestamp&quot;: 1652413758790051, &quot;duration&quot;: 10941, &quot;localEndpoint&quot;: { &quot;serviceName&quot;: &quot;server-product&quot;, &quot;ipv4&quot;: &quot;192.168.0.111&quot; }, &quot;remoteEndpoint&quot;: { &quot;ipv4&quot;: &quot;192.168.0.111&quot;, &quot;port&quot;: 54140 }, &quot;tags&quot;: { &quot;http.method&quot;: &quot;GET&quot;, &quot;http.path&quot;: &quot;/product/get/1001&quot;, &quot;mvc.controller.class&quot;: &quot;ProductController&quot;, &quot;mvc.controller.method&quot;: &quot;getProduct&quot; }, &quot;shared&quot;: true }, { &quot;traceId&quot;: &quot;9d244edbc1668d92&quot;, &quot;parentId&quot;: &quot;3f01ba499fac4ce9&quot;, &quot;id&quot;: &quot;c020c7f6e0fa1604&quot;, &quot;kind&quot;: &quot;SERVER&quot;, &quot;name&quot;: &quot;get /update_count/{pid}/{count}&quot;, &quot;timestamp&quot;: 1652413758808052, &quot;duration&quot;: 5614, &quot;localEndpoint&quot;: { &quot;serviceName&quot;: &quot;server-product&quot;, &quot;ipv4&quot;: &quot;192.168.0.111&quot; }, &quot;remoteEndpoint&quot;: { &quot;ipv4&quot;: &quot;192.168.0.111&quot;, &quot;port&quot;: 54140 }, &quot;tags&quot;: { &quot;http.method&quot;: &quot;GET&quot;, &quot;http.path&quot;: &quot;/product/update_count/1001/1&quot;, &quot;mvc.controller.class&quot;: &quot;ProductController&quot;, &quot;mvc.controller.method&quot;: &quot;updateCount&quot; }, &quot;shared&quot;: true }, { &quot;traceId&quot;: &quot;9d244edbc1668d92&quot;, &quot;parentId&quot;: &quot;9d244edbc1668d92&quot;, &quot;id&quot;: &quot;3f01ba499fac4ce9&quot;, &quot;kind&quot;: &quot;CLIENT&quot;, &quot;name&quot;: &quot;get&quot;, &quot;timestamp&quot;: 1652413758763816, &quot;duration&quot;: 54556, &quot;localEndpoint&quot;: { &quot;serviceName&quot;: &quot;server-gateway&quot;, &quot;ipv4&quot;: &quot;192.168.0.111&quot; }, &quot;remoteEndpoint&quot;: { &quot;ipv4&quot;: &quot;192.168.0.111&quot;, &quot;port&quot;: 8080 }, &quot;tags&quot;: { &quot;http.method&quot;: &quot;GET&quot;, &quot;http.path&quot;: &quot;/order/submit_order&quot; } }, { &quot;traceId&quot;: &quot;9d244edbc1668d92&quot;, &quot;parentId&quot;: &quot;9d244edbc1668d92&quot;, &quot;id&quot;: &quot;475ff483fb0973b1&quot;, &quot;kind&quot;: &quot;CLIENT&quot;, &quot;name&quot;: &quot;get&quot;, &quot;timestamp&quot;: 1652413758759023, &quot;duration&quot;: 59621, &quot;localEndpoint&quot;: { &quot;serviceName&quot;: &quot;server-gateway&quot;, &quot;ipv4&quot;: &quot;192.168.0.111&quot; }, &quot;tags&quot;: { &quot;http.method&quot;: &quot;GET&quot;, &quot;http.path&quot;: &quot;/order/submit_order&quot; } }, { &quot;traceId&quot;: &quot;9d244edbc1668d92&quot;, &quot;id&quot;: &quot;9d244edbc1668d92&quot;, &quot;kind&quot;: &quot;SERVER&quot;, &quot;name&quot;: &quot;get&quot;, &quot;timestamp&quot;: 1652413758757034, &quot;duration&quot;: 63190, &quot;localEndpoint&quot;: { &quot;serviceName&quot;: &quot;server-gateway&quot;, &quot;ipv4&quot;: &quot;192.168.0.111&quot; }, &quot;remoteEndpoint&quot;: { &quot;ipv4&quot;: &quot;127.0.0.1&quot;, &quot;port&quot;: 54137 }, &quot;tags&quot;: { &quot;http.method&quot;: &quot;GET&quot;, &quot;http.path&quot;: &quot;/server-order/order/submit_order&quot; } }, { &quot;traceId&quot;: &quot;9d244edbc1668d92&quot;, &quot;parentId&quot;: &quot;3f01ba499fac4ce9&quot;, &quot;id&quot;: &quot;a048eda8d5fd3dc9&quot;, &quot;kind&quot;: &quot;CLIENT&quot;, &quot;name&quot;: &quot;get&quot;, &quot;timestamp&quot;: 1652413758774201, &quot;duration&quot;: 12054, &quot;localEndpoint&quot;: { &quot;serviceName&quot;: &quot;server-order&quot;, &quot;ipv4&quot;: &quot;192.168.0.111&quot; }, &quot;tags&quot;: { &quot;http.method&quot;: &quot;GET&quot;, &quot;http.path&quot;: &quot;/user/get/1001&quot; } }, { &quot;traceId&quot;: &quot;9d244edbc1668d92&quot;, &quot;parentId&quot;: &quot;3f01ba499fac4ce9&quot;, &quot;id&quot;: &quot;5f0932b5d06fe757&quot;, &quot;kind&quot;: &quot;CLIENT&quot;, &quot;name&quot;: &quot;get&quot;, &quot;timestamp&quot;: 1652413758787924, &quot;duration&quot;: 12557, &quot;localEndpoint&quot;: { &quot;serviceName&quot;: &quot;server-order&quot;, &quot;ipv4&quot;: &quot;192.168.0.111&quot; }, &quot;tags&quot;: { &quot;http.method&quot;: &quot;GET&quot;, &quot;http.path&quot;: &quot;/product/get/1001&quot; } }, { &quot;traceId&quot;: &quot;9d244edbc1668d92&quot;, &quot;parentId&quot;: &quot;3f01ba499fac4ce9&quot;, &quot;id&quot;: &quot;c020c7f6e0fa1604&quot;, &quot;kind&quot;: &quot;CLIENT&quot;, &quot;name&quot;: &quot;get&quot;, &quot;timestamp&quot;: 1652413758805787, &quot;duration&quot;: 7031, &quot;localEndpoint&quot;: { &quot;serviceName&quot;: &quot;server-order&quot;, &quot;ipv4&quot;: &quot;192.168.0.111&quot; }, &quot;tags&quot;: { &quot;http.method&quot;: &quot;GET&quot;, &quot;http.path&quot;: &quot;/product/update_count/1001/1&quot; } }, { &quot;traceId&quot;: &quot;9d244edbc1668d92&quot;, &quot;parentId&quot;: &quot;9d244edbc1668d92&quot;, &quot;id&quot;: &quot;3f01ba499fac4ce9&quot;, &quot;kind&quot;: &quot;SERVER&quot;, &quot;name&quot;: &quot;get /submit_order&quot;, &quot;timestamp&quot;: 1652413758765048, &quot;duration&quot;: 53101, &quot;localEndpoint&quot;: { &quot;serviceName&quot;: &quot;server-order&quot;, &quot;ipv4&quot;: &quot;192.168.0.111&quot; }, &quot;remoteEndpoint&quot;: { &quot;ipv4&quot;: &quot;127.0.0.1&quot; }, &quot;tags&quot;: { &quot;http.method&quot;: &quot;GET&quot;, &quot;http.path&quot;: &quot;/order/submit_order&quot;, &quot;mvc.controller.class&quot;: &quot;OrderController&quot;, &quot;mvc.controller.method&quot;: &quot;submitOrder&quot; }, &quot;shared&quot;: true }, { &quot;traceId&quot;: &quot;9d244edbc1668d92&quot;, &quot;parentId&quot;: &quot;3f01ba499fac4ce9&quot;, &quot;id&quot;: &quot;a048eda8d5fd3dc9&quot;, &quot;kind&quot;: &quot;SERVER&quot;, &quot;name&quot;: &quot;get /get/{uid}&quot;, &quot;timestamp&quot;: 1652413758777073, &quot;duration&quot;: 14640, &quot;localEndpoint&quot;: { &quot;serviceName&quot;: &quot;server-user&quot;, &quot;ipv4&quot;: &quot;192.168.0.111&quot; }, &quot;remoteEndpoint&quot;: { &quot;ipv4&quot;: &quot;192.168.0.111&quot;, &quot;port&quot;: 54139 }, &quot;tags&quot;: { &quot;http.method&quot;: &quot;GET&quot;, &quot;http.path&quot;: &quot;/user/get/1001&quot;, &quot;mvc.controller.class&quot;: &quot;UserController&quot;, &quot;mvc.controller.method&quot;: &quot;getUser&quot; }, &quot;shared&quot;: true } ] ] å°ä¼™ä¼´ä»¬ä¹Ÿå¯ä»¥æ ¹æ®Jsonæ•°æ®åˆ†æä¸‹ç³»ç»Ÿçš„è°ƒç”¨é“¾è·¯ã€‚ ZipKinæ•°æ®æŒä¹…åŒ– æˆ‘ä»¬å®ç°äº†åœ¨é¡¹ç›®ä¸­é›†æˆZipKinï¼Œä½†æ˜¯æ­¤æ—¶æˆ‘ä»¬é›†æˆZipKinåï¼ŒZipKinä¸­çš„æ•°æ®æ˜¯ä¿å­˜åœ¨ç³»ç»Ÿå†…å­˜ä¸­çš„ï¼Œå¦‚æœæˆ‘ä»¬é‡å¯äº†ZipKinï¼Œåˆ™ä¿å­˜åœ¨ç³»ç»Ÿå†…å­˜ä¸­çš„æ•°æ®å°±ä¼šä¸¢å¤±ï¼Œé‚£æˆ‘å¦‚ä½•é¿å…æ•°æ®ä¸¢å¤±å‘¢ï¼ŸZipKinæ”¯æŒå°†æ•°æ®è¿›è¡ŒæŒä¹…åŒ–æ¥é˜²æ­¢æ•°æ®ä¸¢å¤±ï¼Œå¯ä»¥å°†æ•°æ®ä¿å­˜åˆ°ElasticSearchã€Cassandraæˆ–è€…MySQLä¸­ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬é‡ç‚¹ä»‹ç»ä¸‹å¦‚ä½•å°†æ•°æ®ä¿å­˜åˆ°MySQLå’ŒElasticSearchä¸­ã€‚ ZipKinæ•°æ®æŒä¹…åŒ–åˆ°MySQL ï¼ˆ1ï¼‰å°†Zipkinæ•°æ®æŒä¹…åŒ–åˆ°MySQLï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“MySQLçš„æ•°æ®è¡¨ç»“æ„ï¼Œå¥½åœ¨ZipKinæä¾›äº†MySQLè„šæœ¬ï¼Œå°ä¼™ä¼´ä»¬å¯ä»¥åœ¨é“¾æ¥ï¼šhttps://github.com/openzipkin/zipkin/tree/master/zipkin-storageé‡Œé¢ä¸‹è½½ã€‚ å½“ç„¶ï¼Œæˆ‘å°†ä¸‹è½½åçš„MySQLè„šæœ¬æ”¾åˆ°äº†ç½‘å…³æœåŠ¡shop-gatewayçš„resourcesç›®å½•ä¸‹çš„scriptsç›®å½•ä¸‹ã€‚ ï¼ˆ2ï¼‰åœ¨MySQLæ•°æ®åº“ä¸­æ–°å»ºzipkinæ•°æ®åº“ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ create database if not exists zipkin; ï¼ˆ3ï¼‰åœ¨æ–°å»ºçš„æ•°æ®åº“zipkinä¸­è¿è¡Œmysql.sqlè„šæœ¬ï¼Œè¿è¡Œè„šæœ¬åçš„æ•ˆæœå¦‚ä¸‹æ‰€ç¤ºã€‚ å¯ä»¥çœ‹åˆ°ï¼Œåœ¨zipkinæ•°æ®åº“ä¸­æ–°å»ºäº†zipkin_annotationsã€zipkin_dependencieså’Œzipkin_spansä¸‰å¼ æ•°æ®è¡¨ã€‚ ï¼ˆ4ï¼‰å¯åŠ¨ZipKinæ—¶æŒ‡å®šMySQLæ•°æ®æºï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ java -jar zipkin-server-2.12.9-exec.jar --STORAGE_TYPE=mysql --MYSQL_HOST=127.0.0.1 --MYSQL_TCP_PORT=3306 --MYSQL_DB=zipkin --MYSQL_USER=root --MYSQL_PASS=root ï¼ˆ5ï¼‰å¯åŠ¨ZipKinåï¼Œåœ¨æµè§ˆå™¨ä¸­è®¿é—®é“¾æ¥http://localhost:10001/server-order/order/submit_order?userId=1001&amp;productId=1001&amp;count=1ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ï¼ˆ6ï¼‰æŸ¥çœ‹zipkinæ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œå‘ç°zipkin_annotationsæ•°æ®è¡¨ä¸zipkin_spansæ•°æ®è¡¨å·²ç»å­˜åœ¨ç³»ç»Ÿçš„è°ƒç”¨é“¾è·¯æ•°æ®ã€‚ zipkin_annotationsæ•°æ®è¡¨éƒ¨åˆ†æ•°æ®å¦‚ä¸‹æ‰€ç¤ºã€‚ zipkin_spansæ•°æ®è¡¨éƒ¨åˆ†æ•°æ®å¦‚ä¸‹æ‰€ç¤ºã€‚ å¯ä»¥çœ‹åˆ°ï¼ŒZipKinå·²ç»å°†æ•°æ®æŒä¹…åŒ–åˆ°MySQLä¸­ï¼Œé‡å¯ZipKinåå°±ä¼šä»MySQLä¸­è¯»å–æ•°æ®ï¼Œæ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±äº†ã€‚ ZipKinæ•°æ®æŒä¹…åŒ–åˆ°ElasticSearch ï¼ˆ1ï¼‰åˆ°ElasticSearchå®˜ç½‘ä¸‹è½½ElasticSearchï¼Œé“¾æ¥ä¸ºï¼š https://www.elastic.co/cn/downloads/elasticsearchã€‚ è¿™é‡Œä¸‹è½½çš„å®‰è£…åŒ…æ˜¯ï¼šelasticsearch-8.2.0-windows-x86_64.zipã€‚ ï¼ˆ2ï¼‰è§£å‹elasticsearch-8.2.0-windows-x86_64.zipï¼Œåœ¨è§£å‹åçš„binç›®å½•ä¸‹æ‰¾åˆ°elasticsearch.batè„šæœ¬ï¼ŒåŒå‡»è¿è¡ŒElasticSearchã€‚ ï¼ˆ3ï¼‰å¯åŠ¨ZipKinæœåŠ¡ç«¯æ—¶ï¼ŒæŒ‡å®šElasticSearchï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ java -jar zipkin-server-2.12.9-exec.jar --STORAGE_TYPE=elasticsearch --ESHOST=localhost:9200 ï¼ˆ4ï¼‰å¯åŠ¨ZipKinæœåŠ¡ç«¯åï¼Œåœ¨æµè§ˆå™¨ä¸­è®¿é—®é“¾æ¥http://localhost:10001/server-order/order/submit_order?userId=1001&amp;productId=1001&amp;count=1ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ZipKinå°±ä¼šå°†è¯·æ±‚çš„é“¾è·¯ä¿¡æ¯ä¿å­˜åˆ°ElasticSearchä¸­è¿›è¡ŒæŒä¹…åŒ–ã€‚ ","link":"https://tianxiawuhao.github.io/OTKk-Bytc/"},{"title":"Sleuthæ¦‚è¿°","content":"Sleuthæ¦‚è¿° Sleuthæ˜¯SpringCloudä¸­æä¾›çš„ä¸€ä¸ªåˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªç»„ä»¶ï¼Œåœ¨è®¾è®¡ä¸Šå¤§é‡å‚è€ƒå¹¶å€Ÿç”¨äº†Google Dapperçš„è®¾è®¡ã€‚ Spanç®€ä»‹ Spanåœ¨Sleuthä¸­ä»£è¡¨ä¸€ç»„åŸºæœ¬çš„å·¥ä½œå•å…ƒï¼Œå½“è¯·æ±‚åˆ°è¾¾å„ä¸ªå¾®æœåŠ¡æ—¶ï¼ŒSleuthä¼šé€šè¿‡ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ï¼Œä¹Ÿå°±æ˜¯SpanIdæ¥æ ‡è®°å¼€å§‹é€šè¿‡è¿™ä¸ªå¾®æœåŠ¡ï¼Œåœ¨å½“å‰å¾®æœåŠ¡ä¸­æ‰§è¡Œçš„å…·ä½“è¿‡ç¨‹å’Œæ‰§è¡Œç»“æŸã€‚ æ­¤æ—¶ï¼Œé€šè¿‡SpanIdæ ‡è®°çš„å¼€å§‹æ—¶é—´æˆ³å’Œç»“æŸæ—¶é—´æˆ³ï¼Œå°±èƒ½å¤Ÿç»Ÿè®¡åˆ°å½“å‰Spançš„è°ƒç”¨æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯å½“å‰å¾®æœåŠ¡çš„æ‰§è¡Œæ—¶é—´ã€‚å¦å¤–ï¼Œä¹Ÿå¯ä»¥ç”¨è¿‡Spanè·å–åˆ°äº‹ä»¶çš„åç§°ï¼Œè¯·æ±‚çš„ä¿¡æ¯ç­‰æ•°æ®ã€‚ æ€»ç»“ï¼šè¿œç¨‹è°ƒç”¨å’ŒSpanæ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œæ˜¯åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªä¸­æœ€åŸºæœ¬çš„å·¥ä½œå•å…ƒï¼Œæ¯æ¬¡å‘é€ä¸€ä¸ªè¿œç¨‹è°ƒç”¨æœåŠ¡å°±ä¼šäº§ç”Ÿä¸€ä¸ª Spanã€‚Span Id æ˜¯ä¸€ä¸ª 64 ä½çš„å”¯ä¸€ IDï¼Œé€šè¿‡è®¡ç®— Span çš„å¼€å§‹å’Œç»“æŸæ—¶é—´ï¼Œå°±å¯ä»¥ç»Ÿè®¡æ¯ä¸ªæœåŠ¡è°ƒç”¨æ‰€è€—è´¹çš„æ—¶é—´ã€‚ Traceç®€ä»‹ Traceçš„ç²’åº¦æ¯”Spançš„ç²’åº¦å¤§ï¼ŒTraceä¸»è¦æ˜¯ç”±å…·æœ‰ä¸€ç»„ç›¸åŒçš„Trace IDçš„Spanç»„æˆçš„ï¼Œä»è¯·æ±‚è¿›å…¥åˆ†å¸ƒå¼ç³»ç»Ÿå…¥å£ç»è¿‡è°ƒç”¨å„ä¸ªå¾®æœåŠ¡ç›´åˆ°è¿”å›çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œéƒ½æ˜¯ä¸€ä¸ªTraceã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“è¯·æ±‚åˆ°è¾¾åˆ†å¸ƒå¼ç³»ç»Ÿçš„å…¥å£æ—¶ï¼ŒSleuthä¼šä¸ºè¯·æ±‚åˆ›å»ºä¸€ä¸ªå”¯ä¸€æ ‡è¯†ï¼Œè¿™ä¸ªå”¯ä¸€æ ‡è¯†å°±æ˜¯Trace Idï¼Œä¸ç®¡è¿™ä¸ªè¯·æ±‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¦‚ä½•æµè½¬ï¼Œä¹Ÿä¸ç®¡è¿™ä¸ªè¯·æ±‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­è°ƒç”¨äº†å¤šå°‘ä¸ªå¾®æœåŠ¡ï¼Œè¿™ä¸ªTrace Idéƒ½æ˜¯ä¸å˜çš„ï¼Œç›´åˆ°æ•´ä¸ªè¯·æ±‚è¿”å›ã€‚ æ€»ç»“ï¼šä¸€ä¸ª Trace å¯ä»¥å¯¹åº”å¤šä¸ª Spanï¼ŒTraceå’ŒSpanæ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ã€‚Trace Idæ˜¯ä¸€ä¸ª64 ä½çš„å”¯ä¸€IDã€‚Trace Idå¯ä»¥å°†è¿›å…¥åˆ†å¸ƒå¼ç³»ç»Ÿå…¥å£ç»è¿‡è°ƒç”¨å„ä¸ªå¾®æœåŠ¡ï¼Œå†åˆ°è¿”å›çš„æ•´ä¸ªè¿‡ç¨‹çš„è¯·æ±‚ä¸²è”èµ·æ¥ï¼Œå†…éƒ¨æ¯é€šè¿‡ä¸€æ¬¡å¾®æœåŠ¡æ—¶ï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„SpanIdã€‚Traceä¸²è”äº†æ•´ä¸ªè¯·æ±‚é“¾è·¯ï¼Œè€ŒSpanåœ¨è¯·æ±‚é“¾è·¯ä¸­åŒºåˆ†äº†æ¯ä¸ªå¾®æœåŠ¡ã€‚ Annotationç®€ä»‹ Annotationè®°å½•äº†ä¸€æ®µæ—¶é—´å†…çš„äº‹ä»¶ï¼Œå†…éƒ¨ä½¿ç”¨çš„é‡è¦æ³¨è§£å¦‚ä¸‹æ‰€ç¤ºã€‚ csï¼ˆClient Sendï¼‰å®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚ï¼Œæ ‡è®°æ•´ä¸ªè¯·æ±‚çš„å¼€å§‹æ—¶é—´ã€‚ srï¼ˆServer Receivedï¼‰æœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚å¼€å§‹è¿›è¡Œå¤„ç†ï¼Œé€šè¿‡srä¸cså¯ä»¥è®¡ç®—ç½‘ç»œçš„å»¶è¿Ÿæ—¶é—´ï¼Œä¾‹å¦‚ï¼šsrï¼ cs = ç½‘ç»œå»¶è¿Ÿï¼ˆæœåŠ¡è°ƒç”¨çš„æ—¶é—´ï¼‰ã€‚ ssï¼ˆServer Sendï¼‰æœåŠ¡ç«¯å¤„ç†å®Œæ¯•å‡†å¤‡å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œ é€šè¿‡ssä¸srå¯ä»¥è®¡ç®—æœåŠ¡å™¨ä¸Šçš„è¯·æ±‚å¤„ç†æ—¶é—´ï¼Œä¾‹å¦‚ï¼šss - sr = æœåŠ¡å™¨ä¸Šçš„è¯·æ±‚å¤„ç†æ—¶é—´ã€‚ crï¼ˆClient Reveivedï¼‰å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯çš„å“åº”ï¼Œè¯·æ±‚ç»“æŸã€‚é€šè¿‡crä¸cså¯ä»¥è®¡ç®—è¯·æ±‚çš„æ€»æ—¶é—´ï¼Œä¾‹å¦‚ï¼šcr - cs = è¯·æ±‚çš„æ€»æ—¶é—´ã€‚ æ€»ç»“ï¼šé“¾è·¯è¿½è¸ªç³»ç»Ÿå†…éƒ¨å®šä¹‰äº†å°‘é‡æ ¸å¿ƒæ³¨è§£ï¼Œç”¨æ¥å®šä¹‰ä¸€ä¸ªè¯·æ±‚çš„å¼€å§‹å’Œç»“æŸï¼Œé€šè¿‡è¿™äº›æ³¨è§£ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºè¯·æ±‚çš„æ¯ä¸ªé˜¶æ®µçš„æ—¶é—´ã€‚éœ€è¦æ³¨è§£çš„æ˜¯ï¼Œè¿™é‡Œè¯´çš„è¯·æ±‚ï¼Œæ˜¯åœ¨ç³»ç»Ÿå†…éƒ¨æµè½¬çš„è¯·æ±‚ï¼Œè€Œä¸æ˜¯ä»æµè§ˆå™¨ã€APPã€H5ã€å°ç¨‹åºç­‰å‘å‡ºçš„è¯·æ±‚ã€‚ é¡¹ç›®æ•´åˆSleuth Sleuthæä¾›äº†åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªèƒ½åŠ›ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨Sleuthçš„é“¾è·¯è¿½è¸ªåŠŸèƒ½ï¼Œéœ€è¦åœ¨é¡¹ç›®ä¸­é›†æˆSleuthã€‚ æœ€ç®€ä½¿ç”¨ ï¼ˆ1ï¼‰åœ¨æ¯ä¸ªå¾®æœåŠ¡ï¼ˆç”¨æˆ·å¾®æœåŠ¡shop-userã€å•†å“å¾®æœåŠ¡shop-productã€è®¢å•å¾®æœåŠ¡shop-orderã€ç½‘å…³æœåŠ¡shop-gatewayï¼‰ä¸‹çš„pom.xmlæ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹Sleuthçš„ä¾èµ–ã€‚ &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-sleuth&lt;/artifactId&gt; &lt;/dependency&gt; ï¼ˆ2ï¼‰å°†é¡¹ç›®çš„application.ymlæ–‡ä»¶å¤‡ä»½æˆapplication-pre-filter.ymlï¼Œå¹¶å°†application.ymlæ–‡ä»¶çš„å†…å®¹æ›¿æ¢ä¸ºapplication-sentinel.ymlæ–‡ä»¶çš„å†…å®¹ï¼Œè¿™ä¸€æ­¥æ˜¯ä¸ºäº†è®©æ•´ä¸ªé¡¹ç›®é›†æˆSentinelã€SpringCloud Gatewayå’ŒNacosã€‚application.ymlæ›¿æ¢åçš„æ–‡ä»¶å†…å®¹å¦‚ä¸‹æ‰€ç¤ºã€‚ server: port: 10002 spring: application: name: server-gateway cloud: nacos: discovery: server-addr: 127.0.0.1:8848 sentinel: transport: port: 7777 dashboard: 127.0.0.1:8888 web-context-unify: false eager: true gateway: globalcors: cors-configurations: '[/**]': allowedOrigins: &quot;*&quot; allowedMethods: &quot;*&quot; allowCredentials: true allowedHeaders: &quot;*&quot; discovery: locator: enabled: true route-id-prefix: gateway- ï¼ˆ3ï¼‰åˆ†åˆ«å¯åŠ¨Nacosã€Sentinelã€ç”¨æˆ·å¾®æœåŠ¡shop-userï¼Œå•†å“å¾®æœåŠ¡shop-productï¼Œè®¢å•å¾®æœåŠ¡shop-orderå’Œç½‘å…³æœåŠ¡shop-gatewayï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥é“¾æ¥localhost:10001/server-order/order/submit_order?userId=1001&amp;productId=1001&amp;count=1ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ï¼ˆ4ï¼‰åˆ†åˆ«æŸ¥çœ‹ç”¨æˆ·å¾®æœåŠ¡shop-userï¼Œå•†å“å¾®æœåŠ¡shop-productï¼Œè®¢å•å¾®æœåŠ¡shop-orderå’Œç½‘å…³æœåŠ¡shop-gatewayçš„æ§åˆ¶å°è¾“å‡ºï¼Œæ¯ä¸ªæœåŠ¡çš„æ§åˆ¶å°éƒ½è¾“å‡ºäº†å¦‚ä¸‹æ ¼å¼æ‰€ç¤ºçš„ä¿¡æ¯ã€‚ [å¾®æœåŠ¡åç§°,TraceID,SpanID,æ˜¯å¦å°†ç»“æœè¾“å‡ºåˆ°ç¬¬ä¸‰æ–¹å¹³å°] å…·ä½“å¦‚ä¸‹æ‰€ç¤ºã€‚ ç”¨æˆ·å¾®æœåŠ¡shop-user [server-user,03fef3d312450828,76b298dba54ec579,true] å•†å“å¾®æœåŠ¡shop-product [server-product,03fef3d312450828,41ac8836d2df4eec,true] [server-product,03fef3d312450828,6b7b3662d63372bf,true] è®¢å•å¾®æœåŠ¡shop-order [server-order,03fef3d312450828,cbd935d57cae84f9,true] ç½‘å…³æœåŠ¡shop-gateway [server-gateway,03fef3d312450828,03fef3d312450828,true] å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ªæœåŠ¡éƒ½æ‰“å°å‡ºäº†é“¾è·¯è¿½è¸ªçš„æ—¥å¿—ä¿¡æ¯ï¼Œè¯´æ˜å¼•å…¥Sleuthçš„ä¾èµ–åï¼Œå°±å¯ä»¥åœ¨å‘½ä»¤è¡ŒæŸ¥çœ‹é“¾è·¯è¿½è¸ªæƒ…å†µã€‚ æŠ½æ ·é‡‡é›†æ•°æ® Sleuthæ”¯æŒæŠ½æ ·é‡‡é›†æ•°æ®ã€‚å°¤å…¶æ˜¯åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¦‚æœé‡‡é›†æ‰€æœ‰çš„æ•°æ®ï¼Œé‚£ä¹ˆé‡‡é›†çš„æ•°æ®é‡å°±å¤ªå¤§äº†ï¼Œéå¸¸è€—è´¹ç³»ç»Ÿçš„æ€§èƒ½ã€‚é€šå¸¸çš„åšæ³•æ˜¯å¯ä»¥å‡å°‘ä¸€éƒ¨åˆ†æ•°æ®é‡ï¼Œç‰¹åˆ«æ˜¯å¯¹äºé‡‡ç”¨Httpæ–¹å¼å»å‘é€é‡‡é›†æ•°æ®ï¼Œèƒ½å¤Ÿæå‡å¾ˆå¤§çš„æ€§èƒ½ã€‚ Sleuthå¯ä»¥é‡‡ç”¨å¦‚ä¸‹æ–¹å¼é…ç½®æŠ½æ ·é‡‡é›†æ•°æ®ã€‚ spring: sleuth: sampler: probability: 1.0 è¿½è¸ªè‡ªå®šä¹‰çº¿ç¨‹æ±  Sleuthæ”¯æŒå¯¹å¼‚æ­¥ä»»åŠ¡çš„é“¾è·¯è¿½è¸ªï¼Œåœ¨é¡¹ç›®ä¸­ä½¿ç”¨@Asyncæ³¨è§£å¼€å¯ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡åï¼ŒSleuthä¼šä¸ºå¼‚æ­¥ä»»åŠ¡é‡æ–°ç”Ÿæˆä¸€ä¸ªSpanã€‚ä½†æ˜¯å¦‚æœä½¿ç”¨äº†è‡ªå®šä¹‰çš„å¼‚æ­¥ä»»åŠ¡çº¿ç¨‹æ± ï¼Œåˆ™ä¼šå¯¼è‡´Sleuthæ— æ³•æ–°åˆ›å»ºä¸€ä¸ªSpanï¼Œè€Œæ˜¯ä¼šé‡æ–°ç”ŸæˆTraceå’ŒSpanã€‚æ­¤æ—¶ï¼Œéœ€è¦ä½¿ç”¨Sleuthæä¾›çš„LazyTraceExecutorç±»æ¥åŒ…è£…ä¸‹å¼‚æ­¥ä»»åŠ¡çº¿ç¨‹æ± ï¼Œæ‰èƒ½åœ¨å¼‚æ­¥ä»»åŠ¡è°ƒç”¨é“¾è·¯ä¸­é‡æ–°åˆ›å»ºSpanã€‚ åœ¨æœåŠ¡ä¸­å¼€å¯å¼‚æ­¥çº¿ç¨‹æ± ä»»åŠ¡ï¼Œéœ€è¦ä½¿ç”¨@EnableAsyncã€‚æ‰€ä»¥ï¼Œåœ¨æ¼”ç¤ºç¤ºä¾‹å‰ï¼Œå…ˆåœ¨ç”¨æˆ·å¾®æœåŠ¡shop-userçš„io.binghe.shop.UserStarterå¯åŠ¨ç±»ä¸Šæ·»åŠ @EnableAsyncæ³¨è§£ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ /** * @author binghe * @version 1.0.0 * @description å¯åŠ¨ç”¨æˆ·æœçš„ç±» */ @SpringBootApplication @EnableTransactionManagement(proxyTargetClass = true) @MapperScan(value = { &quot;io.binghe.shop.user.mapper&quot; }) @EnableDiscoveryClient @EnableAsync public class UserStarter { public static void main(String[] args){ SpringApplication.run(UserStarter.class, args); } } æ¼”ç¤ºä½¿ç”¨@Asyncæ³¨è§£å¼€å¯ä»»åŠ¡ ï¼ˆ1ï¼‰åœ¨ç”¨æˆ·å¾®æœåŠ¡shop-userçš„io.binghe.shop.user.service.UserServiceæ¥å£ä¸­å®šä¹‰ä¸€ä¸ªasyncMethod()æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ void asyncMethod(); ï¼ˆ2ï¼‰åœ¨ç”¨æˆ·å¾®æœåŠ¡shop-userçš„io.binghe.shop.user.service.impl.UserServiceImplç±»ä¸­å®ç°asyncMethod()æ–¹æ³•ï¼Œå¹¶åœ¨asyncMethod()æ–¹æ³•ä¸Šæ·»åŠ @Asyncæ³¨è§£ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ @Async @Override public void asyncMethod() { log.info(&quot;æ‰§è¡Œäº†å¼‚æ­¥ä»»åŠ¡...&quot;); } ï¼ˆ3ï¼‰åœ¨ç”¨æˆ·å¾®æœåŠ¡shop-userçš„io.binghe.shop.user.controller.UserControllerç±»ä¸­æ–°å¢asyncApi()æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ @GetMapping(value = &quot;/async/api&quot;) public String asyncApi() { log.info(&quot;æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡å¼€å§‹...&quot;); userService.asyncMethod(); log.info(&quot;å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œç»“æŸ...&quot;); return &quot;asyncApi&quot;; } ï¼ˆ4ï¼‰åˆ†åˆ«å¯åŠ¨ç”¨æˆ·å¾®æœåŠ¡å’Œç½‘å…³æœåŠ¡ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥é“¾æ¥http://localhost:10001/server-user/user/async/api ï¼ˆ5ï¼‰æŸ¥çœ‹ç”¨æˆ·å¾®æœåŠ¡ä¸ç½‘å…³æœåŠ¡çš„æ§åˆ¶å°æ—¥å¿—ï¼Œåˆ†åˆ«å­˜åœ¨å¦‚ä¸‹æ—¥å¿—ã€‚ ç”¨æˆ·å¾®æœåŠ¡ [server-user,499d6c7128399ed0,a81bd920de0b07de,true]æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡å¼€å§‹... [server-user,499d6c7128399ed0,a81bd920de0b07de,true]å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œç»“æŸ... [server-user,499d6c7128399ed0,e2f297d512f40bb8,true]æ‰§è¡Œäº†å¼‚æ­¥ä»»åŠ¡... ç½‘å…³æœåŠ¡ [server-gateway,499d6c7128399ed0,499d6c7128399ed0,true] å¯ä»¥çœ‹åˆ°Sleuthä¸ºå¼‚æ­¥ä»»åŠ¡é‡æ–°ç”Ÿæˆäº†Spanã€‚ æ¼”ç¤ºè‡ªå®šä¹‰ä»»åŠ¡çº¿ç¨‹æ±  åœ¨æ¼”ç¤ºä½¿ç”¨@Asyncæ³¨è§£å¼€å¯ä»»åŠ¡çš„åŸºç¡€ä¸Šç»§ç»­æ¼”ç¤ºè‡ªå®šä¹‰ä»»åŠ¡çº¿ç¨‹æ± ï¼ŒéªŒè¯Sleuthæ˜¯å¦ä¸ºè‡ªå®šä¹‰çº¿ç¨‹æ± æ–°åˆ›å»ºäº†Spanã€‚ ï¼ˆ1ï¼‰åœ¨ç”¨æˆ·å¾®æœåŠ¡shop-userä¸­æ–°å»ºio.binghe.shop.user.configåŒ…ï¼Œåœ¨åŒ…ä¸‹åˆ›å»ºThreadPoolTaskExecutorConfigç±»ï¼Œç»§æ‰¿org.springframework.scheduling.annotation.AsyncConfigurerSupportç±»ï¼Œç”¨æ¥è‡ªå®šä¹‰å¼‚æ­¥ä»»åŠ¡çº¿ç¨‹æ± ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ /** * @author binghe * @version 1.0.0 * @description Sleuthå¼‚æ­¥çº¿ç¨‹æ± é…ç½® */ @Configuration @EnableAutoConfiguration public class ThreadPoolTaskExecutorConfig extends AsyncConfigurerSupport { @Override public Executor getAsyncExecutor() { ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor(); executor.setCorePoolSize(2); executor.setMaxPoolSize(5); executor.setQueueCapacity(10); executor.setThreadNamePrefix(&quot;trace-thread-&quot;); executor.initialize(); return executor; } } ï¼ˆ2ï¼‰ä»¥debugçš„å½¢å¼å¯åŠ¨ç”¨æˆ·å¾®æœåŠ¡å’Œç½‘å…³æœåŠ¡ï¼Œå¹¶åœ¨io.binghe.shop.user.config.ThreadPoolTaskExecutorConfig#getAsyncExecutor()æ–¹æ³•ä¸­æ‰“ä¸Šæ–­ç‚¹ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ å¯ä»¥çœ‹åˆ°ï¼Œé¡¹ç›®å¯åŠ¨åå¹¶æ²¡æœ‰è¿›å…¥io.binghe.shop.user.config.ThreadPoolTaskExecutorConfig#getAsyncExecutor()æ–¹æ³•ï¼Œè¯´æ˜é¡¹ç›®å¯åŠ¨æ—¶ï¼Œå¹¶ä¸ä¼šåˆ›å»ºå¼‚æ­¥ä»»åŠ¡çº¿ç¨‹æ± ã€‚ ï¼ˆ3ï¼‰åœ¨æµè§ˆå™¨ä¸­è¾“å…¥é“¾æ¥http://localhost:10001/server-user/user/async/apiï¼Œæ­¤æ—¶å¯ä»¥çœ‹åˆ°ç¨‹åºå·²ç»æ‰§è¡Œåˆ°io.binghe.shop.user.config.ThreadPoolTaskExecutorConfig#getAsyncExecutor()æ–¹æ³•çš„æ–­ç‚¹ä½ç½®ã€‚ è¯´æ˜å¼‚æ­¥ä»»åŠ¡çº¿ç¨‹æ± æ˜¯åœ¨è°ƒç”¨äº†å¼‚æ­¥ä»»åŠ¡çš„æ—¶å€™åˆ›å»ºçš„ã€‚ æ¥ä¸‹æ¥ï¼ŒæŒ‰F8è·³è¿‡æ–­ç‚¹ç»§ç»­è¿è¡Œç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°æµè§ˆå™¨ä¸Šçš„æ˜¾ç¤ºç»“æœå¦‚ä¸‹ã€‚ ï¼ˆ4ï¼‰æŸ¥çœ‹ç”¨æˆ·å¾®æœåŠ¡ä¸ç½‘å…³æœåŠ¡çš„æ§åˆ¶å°æ—¥å¿—ï¼Œåˆ†åˆ«å­˜åœ¨å¦‚ä¸‹æ—¥å¿—ã€‚ ç”¨æˆ·å¾®æœåŠ¡ [server-user,f89f2355ec3f9df1,4d679555674e96a4,true]æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡å¼€å§‹... [server-user,f89f2355ec3f9df1,4d679555674e96a4,true]å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œç»“æŸ... [server-user,0ee48d47e58e2a42,0ee48d47e58e2a42,true]æ‰§è¡Œäº†å¼‚æ­¥ä»»åŠ¡... ç½‘å…³æœåŠ¡ [server-gateway,f89f2355ec3f9df1,f89f2355ec3f9df1,true] å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨è‡ªå®šä¹‰å¼‚æ­¥ä»»åŠ¡çº¿ç¨‹æ± æ—¶ï¼Œåœ¨ç”¨æˆ·å¾®æœåŠ¡ä¸­åœ¨æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡æ—¶ï¼Œé‡æ–°ç”Ÿæˆäº†Traceå’ŒSpanã€‚ æ³¨æ„å¯¹æ¯”ç”¨æˆ·å¾®æœåŠ¡ä¸­è¾“å‡ºçš„ä¸‰æ¡æ—¥å¿—ä¿¡æ¯ï¼Œæœ€åä¸€æ¡æ—¥å¿—ä¿¡æ¯çš„TraceIDå’ŒSpanIDä¸å‰ä¸¤æ¡æ—¥å¿—éƒ½ä¸åŒã€‚ æ¼”ç¤ºåŒ…è£…è‡ªå®šä¹‰çº¿ç¨‹æ±  åœ¨è‡ªå®šä¹‰ä»»åŠ¡çº¿ç¨‹æ± çš„åŸºç¡€ä¸Šç»§ç»­æ¼”ç¤ºåŒ…è£…è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼ŒéªŒè¯Sleuthæ˜¯å¦ä¸ºåŒ…è£…åçš„è‡ªå®šä¹‰çº¿ç¨‹æ± æ–°åˆ›å»ºäº†Spanã€‚ ï¼ˆ1ï¼‰åœ¨ç”¨æˆ·å¾®æœåŠ¡shop-userçš„io.binghe.shop.user.config.ThreadPoolTaskExecutorConfigç±»ä¸­æ³¨å…¥BeanFactoryï¼Œå¹¶åœ¨getAsyncExecutor()æ–¹æ³•ä¸­ä½¿ç”¨org.springframework.cloud.sleuth.instrument.async.LazyTraceExecutor()æ¥åŒ…è£…è¿”å›çš„å¼‚æ­¥ä»»åŠ¡çº¿ç¨‹æ± ï¼Œä¿®æ”¹åçš„io.binghe.shop.user.config.ThreadPoolTaskExecutorConfigç±»çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ /** * @author binghe * @version 1.0.0 * @description Sleuthå¼‚æ­¥çº¿ç¨‹æ± é…ç½® */ @Configuration @EnableAutoConfiguration public class ThreadPoolTaskExecutorConfig extends AsyncConfigurerSupport { @Autowired private BeanFactory beanFactory; @Override public Executor getAsyncExecutor() { ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor(); executor.setCorePoolSize(2); executor.setMaxPoolSize(5); executor.setQueueCapacity(10); executor.setThreadNamePrefix(&quot;trace-thread-&quot;); executor.initialize(); return new LazyTraceExecutor(this.beanFactory, executor); } } ï¼ˆ2ï¼‰åˆ†åˆ«å¯åŠ¨ç”¨æˆ·å¾®æœåŠ¡å’Œç½‘å…³æœåŠ¡ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥é“¾æ¥http://localhost:10001/server-user/user/async/api ï¼ˆ3ï¼‰æŸ¥çœ‹ç”¨æˆ·å¾®æœåŠ¡ä¸ç½‘å…³æœåŠ¡çš„æ§åˆ¶å°æ—¥å¿—ï¼Œåˆ†åˆ«å­˜åœ¨å¦‚ä¸‹æ—¥å¿—ã€‚ ç”¨æˆ·å¾®æœåŠ¡ [server-user,157891cb90fddb65,0a278842776b1f01,true]æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡å¼€å§‹... [server-user,157891cb90fddb65,0a278842776b1f01,true]å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œç»“æŸ... [server-user,157891cb90fddb65,1ba55fd3432b77ae,true]æ‰§è¡Œäº†å¼‚æ­¥ä»»åŠ¡... ç½‘å…³æœåŠ¡ [server-gateway,157891cb90fddb65,157891cb90fddb65,true] å¯ä»¥çœ‹åˆ°Sleuthä¸ºå¼‚æ­¥ä»»åŠ¡é‡æ–°ç”Ÿæˆäº†Spanã€‚ ç»¼ä¸Šè¯´æ˜ï¼šSleuthæ”¯æŒå¯¹å¼‚æ­¥ä»»åŠ¡çš„é“¾è·¯è¿½è¸ªï¼Œåœ¨é¡¹ç›®ä¸­ä½¿ç”¨@Asyncæ³¨è§£å¼€å¯ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡åï¼ŒSleuthä¼šä¸ºå¼‚æ­¥ä»»åŠ¡é‡æ–°ç”Ÿæˆä¸€ä¸ªSpanã€‚ä½†æ˜¯å¦‚æœä½¿ç”¨äº†è‡ªå®šä¹‰çš„å¼‚æ­¥ä»»åŠ¡çº¿ç¨‹æ± ï¼Œåˆ™ä¼šå¯¼è‡´Sleuthæ— æ³•æ–°åˆ›å»ºä¸€ä¸ªSpanï¼Œè€Œæ˜¯ä¼šé‡æ–°ç”ŸæˆTraceå’ŒSpanã€‚æ­¤æ—¶ï¼Œéœ€è¦ä½¿ç”¨Sleuthæä¾›çš„LazyTraceExecutorç±»æ¥åŒ…è£…ä¸‹å¼‚æ­¥ä»»åŠ¡çº¿ç¨‹æ± ï¼Œæ‰èƒ½åœ¨å¼‚æ­¥ä»»åŠ¡è°ƒç”¨é“¾è·¯ä¸­é‡æ–°åˆ›å»ºSpanã€‚ è‡ªå®šä¹‰é“¾è·¯è¿‡æ»¤å™¨ åœ¨Sleuthä¸­å­˜åœ¨é“¾è·¯è¿‡æ»¤å™¨ï¼Œå¹¶ä¸”è¿˜æ”¯æŒè‡ªå®šä¹‰é“¾è·¯è¿‡æ»¤å™¨ã€‚ è‡ªå®šä¹‰é“¾è·¯è¿‡æ»¤å™¨æ¦‚è¿° TracingFilteræ˜¯Sleuthä¸­è´Ÿè´£å¤„ç†è¯·æ±‚å’Œå“åº”çš„ç»„ä»¶ï¼Œå¯ä»¥é€šè¿‡æ³¨å†Œè‡ªå®šä¹‰çš„TracingFilterå®ä¾‹æ¥å®ç°ä¸€äº›æ‰©å±•æ€§çš„éœ€æ±‚ã€‚ æ¼”ç¤ºè‡ªå®šä¹‰é“¾è·¯è¿‡æ»¤å™¨ æœ¬æ¡ˆä¾‹æ¼”ç¤ºé€šè¿‡è¿‡æ»¤å™¨éªŒè¯åªæœ‰HTTPæˆ–è€…HTTPSè¯·æ±‚æ‰èƒ½è®¿é—®æ¥å£ï¼Œå¹¶ä¸”åœ¨è®¿é—®çš„é“¾æ¥ä¸æ˜¯é™æ€æ–‡ä»¶æ—¶ï¼Œå°†traceIdæ”¾å…¥HttpRequestä¸­åœ¨æœåŠ¡ç«¯è·å–ï¼Œå¹¶åœ¨å“åº”ç»“æœä¸­æ·»åŠ è‡ªå®šä¹‰Headerï¼Œåç§°ä¸ºSLEUTH-HEADERï¼Œå€¼ä¸ºtraceIdã€‚ ï¼ˆ1ï¼‰åœ¨ç”¨æˆ·å¾®æœåŠ¡shop-userä¸­æ–°å»ºio.binghe.shop.user.filteråŒ…ï¼Œå¹¶åˆ›å»ºMyGenericFilterç±»ï¼Œç»§æ‰¿org.springframework.web.filter.GenericFilterBeanç±»ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ /** * @author binghe * @version 1.0.0 * @description é“¾è·¯è¿‡æ»¤å™¨ */ @Component @Order( Ordered.HIGHEST_PRECEDENCE + 6) public class MyGenericFilter extends GenericFilterBean{ private Pattern skipPattern = Pattern.compile(SleuthWebProperties.DEFAULT_SKIP_PATTERN); private final Tracer tracer; public MyGenericFilter(Tracer tracer){ this.tracer = tracer; } @Override public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException { if (!(request instanceof HttpServletRequest) || !(response instanceof HttpServletResponse)){ throw new ServletException(&quot;åªæ”¯æŒHTTPè®¿é—®&quot;); } Span currentSpan = this.tracer.currentSpan(); if (currentSpan == null) { chain.doFilter(request, response); return; } HttpServletRequest httpServletRequest = (HttpServletRequest) request; HttpServletResponse httpServletResponse = ((HttpServletResponse) response); boolean skipFlag = skipPattern.matcher(httpServletRequest.getRequestURI()).matches(); if (!skipFlag){ String traceId = currentSpan.context().traceIdString(); httpServletRequest.setAttribute(&quot;traceId&quot;, traceId); httpServletResponse.addHeader(&quot;SLEUTH-HEADER&quot;, traceId); } chain.doFilter(httpServletRequest, httpServletResponse); } } ï¼ˆ2ï¼‰åœ¨ç”¨æˆ·å¾®æœåŠ¡shop-userçš„io.binghe.shop.user.controller.UserControllerç±»ä¸­æ–°å»ºsleuthFilter()æ–¹æ³•ï¼Œåœ¨sleuthFilter()æ–¹æ³•ä¸­è·å–å¹¶æ‰“å°traceIdï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ @GetMapping(value = &quot;/sleuth/filter/api&quot;) public String sleuthFilter(HttpServletRequest request) { Object traceIdObj = request.getAttribute(&quot;traceId&quot;); String traceId = traceIdObj == null ? &quot;&quot; : traceIdObj.toString(); log.info(&quot;è·å–åˆ°çš„traceIdä¸º: &quot; + traceId); return &quot;sleuthFilter&quot;; } ï¼ˆ3ï¼‰åˆ†åˆ«å¯åŠ¨ç”¨æˆ·å¾®æœåŠ¡å’Œç½‘å…³æœåŠ¡ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://localhost:10001/server-user/user/sleuth/filter/apiï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ æŸ¥çœ‹ç”¨æˆ·å¾®æœåŠ¡çš„æ§åˆ¶å°ä¼šè¾“å‡ºå¦‚ä¸‹ä¿¡æ¯ã€‚ è·å–åˆ°çš„traceIdä¸º: f63ae7702f6f4bba æŸ¥çœ‹æµè§ˆå™¨çš„æ§åˆ¶å°ï¼Œçœ‹åˆ°åœ¨å“åº”çš„ç»“æœä¿¡æ¯ä¸­æ–°å¢äº†ä¸€ä¸ªåç§°ä¸ºSLEUTH-HEADERï¼Œå€¼ä¸ºf63ae7702f6f4bbaçš„Headerï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ è¯´æ˜ä½¿ç”¨Sleuthçš„è¿‡æ»¤å™¨å¯ä»¥å¤„ç†è¯·æ±‚å’Œå“åº”ä¿¡æ¯ï¼Œå¹¶ä¸”å¯ä»¥åœ¨Sleuthçš„è¿‡æ»¤å™¨ä¸­è·å–åˆ°TraceIDã€‚ ","link":"https://tianxiawuhao.github.io/ZbHW6UCYN/"},{"title":"åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª","content":"éšç€äº’è”ç½‘çš„ä¸æ–­å‘å±•ï¼Œä¼ä¸šçš„ä¸šåŠ¡ç³»ç»Ÿå˜å¾—è¶Šæ¥è¶Šå¤æ‚ï¼ŒåŸæœ¬å•ä¸€çš„å•ä½“åº”ç”¨ç³»ç»Ÿå·²ç»æ— æ³•æ»¡è¶³ä¼ä¸šä¸šåŠ¡å‘å±•çš„éœ€è¦ã€‚äºæ˜¯ï¼Œå¾ˆå¤šä¼ä¸šå¼€å§‹äº†å¯¹é¡¹ç›®çš„åˆ†å¸ƒå¼ä¸å¾®æœåŠ¡æ”¹é€ ï¼Œæ–°é¡¹ç›®ä¹Ÿåœ¨å¼€å§‹çš„æ—¶å€™å°±ä¼šé‡‡ç”¨åˆ†å¸ƒå¼ä¸å¾®æœåŠ¡çš„æ¶æ„æ¨¡å¼ã€‚ ä¸€ä¸ªç³»ç»Ÿé‡‡ç”¨åˆ†å¸ƒå¼ä¸å¾®æœåŠ¡æ¶æ„åï¼Œä¼šè¢«æ‹†åˆ†æˆè®¸å¤šæœåŠ¡æ¨¡å—ï¼Œè¿™äº›æœåŠ¡æ¨¡å—ä¹‹é—´çš„è°ƒç”¨å…³ç³»é”™ç»¼å¤æ‚ï¼Œå¯¹äºå®¢æˆ·ç«¯è¯·æ±‚çš„åˆ†æä¸å¤„ç†å°±ä¼šæ˜¾å¾—å¼‚å¸¸å¤æ‚ã€‚æ­¤æ—¶ï¼Œå°±éœ€è¦ä¸€ç§æŠ€æœ¯æ¥è§£å†³è¿™äº›é—®é¢˜ï¼Œè€Œè¿™ç§æŠ€æœ¯å°±æ˜¯åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªæŠ€æœ¯ã€‚ åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª éšç€äº’è”ç½‘ä¸šåŠ¡å¿«é€Ÿæ‰©å±•ï¼Œä¼ä¸šçš„ä¸šåŠ¡ç³»ç»Ÿå˜å¾—è¶Šæ¥è¶Šå¤æ‚ï¼Œä¸å°‘ä¼ä¸šå¼€å§‹å‘åˆ†å¸ƒå¼ã€å¾®æœåŠ¡æ–¹å‘å‘å±•ï¼Œå°†åŸæœ¬çš„å•ä½“åº”ç”¨æ‹†åˆ†æˆåˆ†å¸ƒå¼ã€å¾®æœåŠ¡ã€‚è¿™ä¹Ÿä½¿å¾—å½“å®¢æˆ·ç«¯è¯·æ±‚ç³»ç»Ÿçš„æ¥å£æ—¶ï¼ŒåŸæœ¬åœ¨åŒä¸€ä¸ªç³»ç»Ÿå†…éƒ¨çš„è¯·æ±‚é€»è¾‘å˜æˆäº†éœ€è¦åœ¨å¤šä¸ªå¾®æœåŠ¡ä¹‹é—´æµè½¬çš„è¯·æ±‚ã€‚ å•ä½“æ¶æ„ä¸­å¯ä»¥ä½¿ç”¨AOPåœ¨è°ƒç”¨å…·ä½“çš„ä¸šåŠ¡é€»è¾‘å‰ååˆ†åˆ«æ‰“å°ä¸€ä¸‹æ—¶é—´å³å¯è®¡ç®—å‡ºæ•´ä½“çš„è°ƒç”¨æ—¶é—´ï¼Œä½¿ç”¨ AOPæ•è·å¼‚å¸¸ä¹Ÿå¯çŸ¥é“æ˜¯å“ªé‡Œçš„è°ƒç”¨å¯¼è‡´çš„å¼‚å¸¸ã€‚ ä½†æ˜¯åœ¨åˆ†å¸ƒå¼å¾®æœåŠ¡åœºæ™¯ä¸‹ï¼Œä½¿ç”¨AOPæŠ€æœ¯æ˜¯æ— æ³•è¿½è¸ªåˆ°å„ä¸ªå¾®æœåŠ¡çš„è°ƒç”¨æƒ…å†µçš„ï¼Œä¹Ÿå°±æ— æ³•çŸ¥é“ç³»ç»Ÿä¸­å¤„ç†ä¸€æ¬¡è¯·æ±‚çš„æ•´ä½“è°ƒç”¨é“¾è·¯ã€‚ å¦å¤–ï¼Œåœ¨åˆ†å¸ƒå¼ä¸å¾®æœåŠ¡åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦è§£å†³å¦‚ä¸‹é—®é¢˜ï¼š å¦‚ä½•å¿«é€Ÿå‘ç°å¹¶å®šä½åˆ°åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„é—®é¢˜ã€‚ å¦‚ä½•å°½å¯èƒ½ç²¾ç¡®çš„åˆ¤æ–­æ•…éšœå¯¹ç³»ç»Ÿçš„å½±å“èŒƒå›´ä¸å½±å“ç¨‹åº¦ã€‚ å¦‚ä½•å°½å¯èƒ½ç²¾ç¡®çš„æ¢³ç†å‡ºæœåŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå¹¶åˆ¤æ–­å‡ºæœåŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»æ˜¯å¦åˆç†ã€‚ å¦‚ä½•å°½å¯èƒ½ç²¾ç¡®çš„åˆ†ææ•´ä¸ªç³»ç»Ÿè°ƒç”¨é“¾è·¯çš„æ€§èƒ½ä¸ç“¶é¢ˆç‚¹ã€‚ å¦‚ä½•å°½å¯èƒ½ç²¾ç¡®çš„åˆ†æç³»ç»Ÿçš„å­˜å‚¨ç“¶é¢ˆä¸å®¹é‡è§„åˆ’ã€‚ å¦‚ä½•å®æ—¶è§‚æµ‹ç³»ç»Ÿçš„æ•´ä½“è°ƒç”¨é“¾è·¯æƒ…å†µã€‚ ä¸Šè¿°é—®é¢˜å°±æ˜¯åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªæŠ€æœ¯è¦è§£å†³çš„é—®é¢˜ã€‚æ‰€è°“çš„åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªï¼Œå°±æ˜¯å°†å¯¹åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€æ¬¡è¯·æ±‚è½¬åŒ–æˆä¸€ä¸ªå®Œæ•´çš„è°ƒç”¨é“¾è·¯ã€‚è¿™ä¸ªå®Œæ•´çš„è°ƒç”¨é“¾è·¯ä»è¯·æ±‚è¿›å…¥åˆ†å¸ƒå¼ç³»ç»Ÿçš„å…¥å£å¼€å§‹ï¼Œç›´åˆ°æ•´ä¸ªè¯·æ±‚è¿”å›ä¸ºæ­¢ã€‚å¹¶åœ¨è¯·æ±‚è°ƒç”¨å¾®æœåŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œè®°å½•ç›¸åº”çš„è°ƒç”¨æ—¥å¿—ï¼Œç›‘æ§ç³»ç»Ÿè°ƒç”¨çš„æ€§èƒ½ï¼Œå¹¶ä¸”å¯ä»¥æŒ‰ç…§æŸç§æ–¹å¼æ˜¾ç¤ºè¯·æ±‚è°ƒç”¨çš„æƒ…å†µã€‚ åœ¨åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªä¸­ï¼Œå¯ä»¥ç»Ÿè®¡è°ƒç”¨æ¯ä¸ªå¾®æœåŠ¡çš„è€—æ—¶ï¼Œè¯·æ±‚ä¼šç»è¿‡å“ªäº›å¾®æœåŠ¡çš„æµè½¬ï¼Œæ¯ä¸ªå¾®æœåŠ¡çš„è¿è¡ŒçŠ¶å†µç­‰ä¿¡æ¯ã€‚ æ ¸å¿ƒåŸç† å‡å®šä¸‰ä¸ªå¾®æœåŠ¡è°ƒç”¨çš„é“¾è·¯å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šService 1 è°ƒç”¨ Service 2ï¼ŒService 2 è°ƒç”¨ Service 3 å’Œ Service 4ã€‚ é‚£ä¹ˆé“¾è·¯è¿½è¸ªä¼šåœ¨æ¯ä¸ªæœåŠ¡è°ƒç”¨çš„æ—¶å€™åŠ ä¸Š Trace ID å’Œ Span IDã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å°ä¼™ä¼´æ³¨æ„ä¸Šé¢çš„é¢œè‰²ï¼Œç›¸åŒé¢œè‰²çš„ä»£è¡¨æ˜¯åŒä¸€ä¸ª Span IDï¼Œè¯´æ˜æ˜¯é“¾è·¯è¿½è¸ªä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ã€‚ ç¬¬ä¸€æ­¥ï¼šç”¨æˆ·ç«¯è°ƒç”¨ Service 1ï¼Œç”Ÿæˆä¸€ä¸ª Requestï¼ŒTrace ID å’Œ Span ID ä¸ºç©ºï¼Œé‚£ä¸ªæ—¶å€™è¯·æ±‚è¿˜æ²¡æœ‰åˆ° Service 1ã€‚ ç¬¬äºŒæ­¥ï¼šè¯·æ±‚åˆ°è¾¾ Service 1ï¼Œè®°å½•äº† Trace ID = Xï¼ŒSpan ID ç­‰äº Aã€‚ ç¬¬ä¸‰æ­¥ï¼šService 1 å‘é€è¯·æ±‚ç»™ Service 2ï¼ŒSpan ID ç­‰äº Bï¼Œè¢«ç§°ä½œ Client Sentï¼Œå³ç”¨æˆ·ç«¯å‘é€ä¸€ä¸ªè¯·æ±‚ã€‚ ç¬¬å››æ­¥ï¼šè¯·æ±‚åˆ°è¾¾ Service 2ï¼ŒSpan ID ç­‰äº Bï¼ŒTrace ID ä¸ä¼šæ”¹å˜ï¼Œè¢«ç§°ä½œ Server Receivedï¼Œå³æœåŠ¡ç«¯å–å¾—è¯·æ±‚å¹¶å‡†å¤‡å¼€å§‹è§£å†³å®ƒã€‚ ç¬¬äº”æ­¥ï¼šService 2 å¼€å§‹è§£å†³è¿™ä¸ªè¯·æ±‚ï¼Œè§£å†³å®Œä¹‹åï¼ŒTrace ID ä¸å˜ï¼ŒSpan ID = Cã€‚ ç¬¬å…­æ­¥ï¼šService 2 å¼€å§‹å‘é€è¿™ä¸ªè¯·æ±‚ç»™ Service 3ï¼ŒTrace ID ä¸å˜ï¼ŒSpan ID = Dï¼Œè¢«ç§°ä½œ Client Sentï¼Œå³ç”¨æˆ·ç«¯å‘é€ä¸€ä¸ªè¯·æ±‚ã€‚ ç¬¬ä¸ƒæ­¥ï¼šService 3 æ¥æ”¶åˆ°è¿™ä¸ªè¯·æ±‚ï¼ŒSpan ID = Dï¼Œè¢«ç§°ä½œ Server Receivedã€‚ ç¬¬å…«æ­¥ï¼šService 3 å¼€å§‹è§£å†³è¿™ä¸ªè¯·æ±‚ï¼Œè§£å†³å®Œä¹‹åï¼ŒSpan ID = Eã€‚ ç¬¬ä¹æ­¥ï¼šService 3 å¼€å§‹å‘é€å“åº”ç»™ Service 2ï¼ŒSpan ID = Dï¼Œè¢«ç§°ä½œ Server Sentï¼Œå³æœåŠ¡ç«¯å‘é€å“åº”ã€‚ ç¬¬åæ­¥ï¼šService 3 æ”¶åˆ° Service 2 çš„å“åº”ï¼ŒSpan ID = Dï¼Œè¢«ç§°ä½œ Client Receivedï¼Œå³ç”¨æˆ·ç«¯æ¥æ”¶å“åº”ã€‚ ç¬¬åä¸€æ­¥ï¼šService 2 å¼€å§‹è¿”å› å“åº”ç»™ Service 1ï¼ŒSpan ID = Bï¼Œå’Œç¬¬ä¸‰æ­¥çš„ Span ID ç›¸åŒï¼Œè¢«ç§°ä½œ Client Receivedï¼Œå³ç”¨æˆ·ç«¯æ¥æ”¶å“åº”ã€‚ ç¬¬åäºŒæ­¥ï¼šService 1 è§£å†³å®Œå“åº”ï¼ŒSpan ID = Aï¼Œå’Œç¬¬äºŒæ­¥çš„ Span ID ç›¸åŒã€‚ ç¬¬åä¸‰æ­¥ï¼šService 1 å¼€å§‹å‘ç”¨æˆ·ç«¯è¿”å›å“åº”ï¼ŒSpan ID = Aã€ Service 3 å‘ Service 4 å‘é€è¯·æ±‚å’Œ Service 3 ç›¸ä¼¼ï¼Œå¯¹åº”çš„ Span ID æ˜¯ F å’Œ Gã€‚å¯ä»¥å‚ç…§ä¸Šé¢å‰é¢çš„ç¬¬å…­æ­¥åˆ°ç¬¬åæ­¥ã€‚ æŠŠä»¥ä¸Šçš„ç›¸åŒé¢œè‰²çš„æ­¥éª¤ç®€åŒ–ä¸ºä¸‹é¢çš„é“¾è·¯è¿½è¸ªå›¾ï¼š ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼šSpan ID = Aï¼ŒParent ID = nullï¼ŒService 1 æ¥æ”¶åˆ°è¯·æ±‚ã€‚ ç¬¬äºŒä¸ªèŠ‚ç‚¹ï¼šSpan ID = Bï¼ŒParent ID= Aï¼ŒService 1 å‘é€è¯·æ±‚åˆ° Service 2 è¿”å›å“åº”ç»™Service 1 çš„è¿‡ç¨‹ã€‚ ç¬¬ä¸‰ä¸ªèŠ‚ç‚¹ï¼šSpan ID = Cï¼ŒParent ID= Bï¼ŒService 2 çš„ ä¸­é—´è§£å†³è¿‡ç¨‹ã€‚ ç¬¬å››ä¸ªèŠ‚ç‚¹ï¼šSpan ID = Dï¼ŒParent ID= Cï¼ŒService 2 å‘é€è¯·æ±‚åˆ° Service 3 è¿”å›å“åº”ç»™Service 2 çš„è¿‡ç¨‹ã€‚ ç¬¬äº”ä¸ªèŠ‚ç‚¹ï¼šSpan ID = Eï¼ŒParent ID= Dï¼ŒService 3 çš„ä¸­é—´è§£å†³è¿‡ç¨‹ã€‚ ç¬¬å…­ä¸ªèŠ‚ç‚¹ï¼šSpan ID = Fï¼ŒParent ID= Cï¼ŒService 3 å‘é€è¯·æ±‚åˆ° Service 4 è¿”å›å“åº”ç»™ Service 3 çš„è¿‡ç¨‹ã€‚ ç¬¬ä¸ƒä¸ªèŠ‚ç‚¹ï¼šSpan ID = Gï¼ŒParent ID= Fï¼ŒService 4 çš„ä¸­é—´è§£å†³è¿‡ç¨‹ã€‚ é€šè¿‡ Parent ID å°±å¯æ‰¾åˆ°çˆ¶èŠ‚ç‚¹ï¼Œæ•´ä¸ªé“¾è·¯å³å¯ä»¥è¿›è¡Œè·Ÿè¸ªè¿½æº¯äº†ã€‚ å¤‡æ³¨ï¼šæ ¸å¿ƒåŸç†éƒ¨åˆ†å†…å®¹æ¥æºï¼šcnblogs.com/jackson0714/p/sleuth_zipkin.html è§£å†³æ–¹æ¡ˆ ç›®å‰ï¼Œè¡Œä¸šå†…æ¯”è¾ƒæˆç†Ÿçš„åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªæŠ€æœ¯è§£å†³æ–¹æ¡ˆå¦‚ä¸‹æ‰€ç¤ºã€‚ æŠ€æœ¯ è¯´æ˜ Cat ç”±å¤§ä¼—ç‚¹è¯„å¼€æºï¼ŒåŸºäºJavaå¼€å‘çš„å®æ—¶åº”ç”¨ç›‘æ§å¹³å°ï¼ŒåŒ…æ‹¬å®æ—¶åº”ç”¨ç›‘æ§ï¼Œä¸šåŠ¡ç›‘æ§ ã€‚é›†æˆæ–¹æ¡ˆæ˜¯é€šè¿‡ä»£ç åŸ‹ç‚¹çš„æ–¹å¼æ¥å®ç°ç›‘æ§ï¼Œæ¯”å¦‚ï¼šæ‹¦æˆªå™¨ï¼Œè¿‡æ»¤å™¨ç­‰ã€‚å¯¹ä»£ç çš„ä¾µå…¥æ€§å¾ˆå¤§ï¼Œé›†æˆæˆæœ¬è¾ƒé«˜ã€‚é£é™©è¾ƒå¤§ã€‚ ZipKin ç”±Twitterå…¬å¸å¼€æºï¼Œå¼€æ”¾æºä»£ç åˆ†å¸ƒå¼çš„è·Ÿè¸ªç³»ç»Ÿï¼Œç”¨äºæ”¶é›†æœåŠ¡çš„å®šæ—¶æ•°æ®ï¼Œä»¥è§£å†³å¾®æœåŠ¡æ¶æ„ä¸­çš„å»¶è¿Ÿé—®é¢˜ï¼ŒåŒ…æ‹¬ï¼šæ•°æ®çš„æ”¶é›†ã€å­˜å‚¨ã€æŸ¥æ‰¾å’Œå±•ç°ã€‚ç»“åˆspring-cloud-sleuthä½¿ç”¨è¾ƒä¸ºç®€å•ï¼Œ é›†æˆæ–¹ä¾¿ï¼Œ ä½†æ˜¯åŠŸèƒ½è¾ƒç®€å•ã€‚ Pinpoint Pinpointæ˜¯ä¸€æ¬¾å¼€æºçš„åŸºäºå­—èŠ‚ç æ³¨å…¥çš„è°ƒç”¨é“¾åˆ†æï¼Œä»¥åŠåº”ç”¨ç›‘æ§åˆ†æå·¥å…·ã€‚ç‰¹ç‚¹æ˜¯æ”¯æŒå¤šç§æ’ä»¶ï¼Œ UIåŠŸèƒ½å¼ºå¤§ï¼Œæ¥å…¥ç«¯æ— ä»£ç ä¾µå…¥ã€‚ Skywalking SkyWalkingæ˜¯å›½äººå¼€æºçš„åŸºäºå­—èŠ‚ç æ³¨å…¥çš„è°ƒç”¨é“¾åˆ†æï¼Œä»¥åŠåº”ç”¨ç›‘æ§åˆ†æå·¥å…·ã€‚ç‰¹ç‚¹æ˜¯æ”¯æŒå¤šç§æ’ä»¶ï¼Œ UIåŠŸèƒ½è¾ƒå¼ºï¼Œæ¥å…¥ç«¯æ— ä»£ç ä¾µå…¥ã€‚ Sleuth Sleuthæ˜¯SpringCloudä¸­çš„ä¸€ä¸ªç»„ä»¶ï¼Œä¸ºSpring Cloudå®ç°äº†åˆ†å¸ƒå¼è·Ÿè¸ªè§£å†³æ–¹æ¡ˆã€‚ æ³¨æ„ï¼šæˆ‘ä»¬åç»­ä¼šä½¿ç”¨ Sleuth+ZipKinçš„æ–¹æ¡ˆå®ç°åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªã€‚ ","link":"https://tianxiawuhao.github.io/Lq63Gr95h/"},{"title":"ç½‘å…³æ–­è¨€","content":"ç½‘å…³æ–­è¨€ æ–­è¨€çš„è‹±æ–‡æ˜¯Predicateï¼Œä¹Ÿå¯ä»¥ç¿»è¯‘æˆè°“è¯ã€‚ä¸»è¦çš„ä½œç”¨å°±æ˜¯è¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼Œå¯ä»¥åœ¨ç½‘å…³ä¸­å®ç°å¤šç§æ¡ä»¶åˆ¤æ–­ï¼Œåªæœ‰æ‰€æœ‰çš„åˆ¤æ–­ç»“æœéƒ½é€šè¿‡æ—¶ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰çš„æ¡ä»¶åˆ¤æ–­éƒ½è¿”å›trueï¼Œæ‰ä¼šçœŸæ­£çš„æ‰§è¡Œè·¯ç”±åŠŸèƒ½ã€‚ SpringCloud Gatewayå†…ç½®æ–­è¨€ SpringCloud GatewayåŒ…æ‹¬è®¸å¤šå†…ç½®çš„æ–­è¨€å·¥å‚ï¼Œæ‰€æœ‰è¿™äº›æ–­è¨€éƒ½ä¸HTTPè¯·æ±‚çš„ä¸åŒå±æ€§åŒ¹é…ã€‚ åŸºäºæ—¥æœŸæ—¶é—´ç±»å‹çš„æ–­è¨€ åŸºäºæ—¥æœŸæ—¶é—´ç±»å‹çš„æ–­è¨€æ ¹æ®æ—¶é—´åšåˆ¤æ–­ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªï¼š AfterRoutePredicateFactoryï¼šæ¥æ”¶ä¸€ä¸ªæ—¥æœŸæ—¶é—´å‚æ•°ï¼Œåˆ¤æ–­å½“å‰è¯·æ±‚çš„æ—¥æœŸæ—¶é—´æ˜¯å¦æ™šäºæŒ‡å®šçš„æ—¥æœŸæ—¶é—´ã€‚ BeforeRoutePredicateFactoryï¼šæ¥æ”¶ä¸€ä¸ªæ—¥æœŸæ—¶é—´å‚æ•°ï¼Œåˆ¤æ–­å½“å‰è¯·æ±‚çš„æ—¥æœŸæ—¶é—´æ˜¯å¦æ—©äºæŒ‡å®šçš„æ—¥æœŸæ—¶é—´ã€‚ BetweenRoutePredicateFactoryï¼šæ¥æ”¶ä¸¤ä¸ªæ—¥æœŸæ—¶é—´å‚æ•°ï¼Œåˆ¤æ–­å½“å‰è¯·æ±‚çš„æ—¥æœŸæ—¶é—´æ˜¯å¦åœ¨æŒ‡å®šçš„æ—¶é—´æ—¶é—´æ®µå†…ã€‚ ä½¿ç”¨ç¤ºä¾‹ - After=2022-05-10T23:59:59.256+08:00[Asia/Shanghai] åŸºäºè¿œç¨‹åœ°å€çš„æ–­è¨€ RemoteAddrRoutePredicateFactoryï¼šæ¥æ”¶ä¸€ä¸ªIPåœ°å€æ®µï¼Œåˆ¤æ–­å‘å‡ºè¯·æ±‚çš„å®¢æˆ·ç«¯çš„IPåœ°å€æ˜¯å¦åœ¨æŒ‡å®šçš„IPåœ°å€æ®µå†…ã€‚ ä½¿ç”¨ç¤ºä¾‹ - RemoteAddr=192.168.0.1/24 åŸºäºCookieçš„æ–­è¨€ CookieRoutePredicateFactoryï¼šæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œ Cookieçš„åç§°å’Œä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ã€‚åˆ¤æ–­è¯·æ±‚çš„Cookieæ˜¯å¦å…·æœ‰ç»™å®šåç§°ä¸”å€¼ä¸æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ã€‚ ä½¿ç”¨ç¤ºä¾‹ - Cookie=name, binghe. åŸºäºHeaderçš„æ–­è¨€ HeaderRoutePredicateFactoryï¼šæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œè¯·æ±‚Headerçš„åç§°å’Œæ­£åˆ™è¡¨è¾¾å¼ã€‚åˆ¤æ–­è¯·æ±‚Headerä¸­æ˜¯å¦å…·æœ‰ç»™å®šçš„åç§°ä¸”å€¼ä¸æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ã€‚ ä½¿ç”¨ç¤ºä¾‹ - Header=X-Request-Id, \\d+ åŸºäºHostçš„æ–­è¨€ HostRoutePredicateFactoryï¼šæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°é€šå¸¸æ˜¯ä¸»æœºåæˆ–è€…åŸŸåçš„æ¨¡å¼ï¼Œä¾‹å¦‚**.binghe.comè¿™ç§æ ¼å¼ã€‚åˆ¤æ–­å‘å‡ºè¯·æ±‚çš„ä¸»æœºæ˜¯å¦æ»¡è¶³åŒ¹é…è§„åˆ™ã€‚ ä½¿ç”¨ç¤ºä¾‹ - Host=**.binghe.com åŸºäºMethodè¯·æ±‚æ–¹æ³•çš„æ–­è¨€ MethodRoutePredicateFactoryï¼šæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œåˆ¤æ–­è¯·æ±‚çš„ç±»å‹æ˜¯å¦è·ŸæŒ‡å®šçš„ç±»å‹åŒ¹é…ï¼Œé€šå¸¸æŒ‡çš„æ˜¯è¯·æ±‚æ–¹å¼ã€‚ä¾‹å¦‚ï¼ŒPOSTã€GETã€PUTç­‰è¯·æ±‚æ–¹å¼ã€‚ ä½¿ç”¨ç¤ºä¾‹ - Method=GET åŸºäºPathè¯·æ±‚è·¯å¾„çš„æ–­è¨€ PathRoutePredicateFactoryï¼šæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œåˆ¤æ–­è¯·æ±‚çš„é“¾æ¥åœ°å€æ˜¯å¦æ»¡è¶³è·¯å¾„è§„åˆ™ï¼Œé€šå¸¸æŒ‡çš„æ˜¯è¯·æ±‚çš„URIéƒ¨åˆ†ã€‚ ä½¿ç”¨ç¤ºä¾‹ - Path=/binghe/{segment} åŸºäºQueryè¯·æ±‚å‚æ•°çš„æ–­è¨€ QueryRoutePredicateFactory ï¼šæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œè¯·æ±‚å‚æ•°å’Œæ­£åˆ™è¡¨è¾¾å¼ï¼Œ åˆ¤æ–­è¯·æ±‚çš„å‚æ•°æ˜¯å¦å…·æœ‰ç»™å®šçš„åç§°å¹¶ä¸”å‚æ•°å€¼æ˜¯å¦ä¸æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ã€‚ ä½¿ç”¨ç¤ºä¾‹ - Query=name, binghe. åŸºäºè·¯ç”±æƒé‡çš„æ–­è¨€ WeightRoutePredicateFactoryï¼šæ¥æ”¶ä¸€ä¸ª[ç»„å,æƒé‡]æ ¼å¼çš„æ•°ç»„ï¼Œç„¶åå¯¹äºåŒä¸€ä¸ªç»„å†…çš„è·¯ç”±æŒ‰ç…§æƒé‡è½¬å‘ã€‚ ä½¿ç”¨ç¤ºä¾‹ - id: weight1 uri: http://localhost:8080 predicates: - Path=/api/** - Weight=group1,2 filters: - StripPrefix=1 - id: weight2 uri: http://localhost:8081 predicates: - Path=/api/** - Weight=group1,8 filters: - StripPrefix=1 æ¼”ç¤ºå†…ç½®æ–­è¨€ åœ¨æ¼”ç¤ºçš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åŸºäºPathè¯·æ±‚è·¯å¾„çš„æ–­è¨€åˆ¤æ–­è¯·æ±‚è·¯å¾„æ˜¯å¦ç¬¦åˆè§„åˆ™ï¼ŒåŸºäºè¿œç¨‹åœ°å€çš„æ–­è¨€åˆ¤æ–­è¯·æ±‚ä¸»æœºåœ°å€æ˜¯å¦åœ¨åœ°å€æ®µä¸­ï¼Œå¹¶ä¸”é™åˆ¶è¯·æ±‚çš„æ–¹å¼ä¸ºGETæ–¹å¼ã€‚æ•´ä¸ªæ¼”ç¤ºçš„è¿‡ç¨‹ä»¥è®¿é—®ç”¨æˆ·å¾®æœåŠ¡çš„æ¥å£ä¸ºä¾‹ã€‚ ï¼ˆ1ï¼‰ç”±äºåœ¨å¼€å‘é¡¹ç›®æ—¶ï¼Œæ‰€æœ‰çš„æœåŠ¡éƒ½æ˜¯åœ¨æˆ‘æœ¬åœ°å¯åŠ¨çš„ï¼Œé¦–å…ˆæŸ¥çœ‹ä¸‹æˆ‘æœ¬æœºçš„IPåœ°å€ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘æœ¬æœºçš„IPåœ°å€ä¸º192.168.0.27ï¼Œå±äº192.168.0.1/24ç½‘æ®µã€‚ ï¼ˆ2ï¼‰åœ¨æœåŠ¡ç½‘å…³æ¨¡å—shop-gatewayä¸­ï¼Œå°†application.ymlæ–‡ä»¶å¤‡ä»½æˆapplication-sentinel.ymlæ–‡ä»¶ï¼Œå¹¶å°†application.ymlæ–‡ä»¶ä¸­çš„å†…å®¹ä¿®æ”¹æˆapplication-simple.ymlæ–‡ä»¶ä¸­çš„å†…å®¹ã€‚æ¥ä¸‹æ¥ï¼Œåœ¨application.ymlæ–‡ä»¶ä¸­çš„spring.cloud.gateway.routesèŠ‚ç‚¹ä¸‹çš„- id: user-gatewayä¸‹é¢è¿›è¡Œæ–­è¨€é…ç½®ï¼Œé…ç½®åçš„ç»“æœå¦‚ä¸‹æ‰€ç¤ºã€‚ spring: cloud: gateway: routes: - id: user-gateway uri: http://localhost:8060 order: 1 predicates: - Path=/server-user/** - RemoteAddr=192.168.0.1/24 - Method=GET filters: - StripPrefix=1 æ³¨æ„ï¼šå®Œæ•´çš„é…ç½®å‚è§æ¡ˆä¾‹å®Œæ•´æºä»£ç ã€‚ ï¼ˆ3ï¼‰é…ç½®å®Œæˆåå¯åŠ¨ç”¨æˆ·å¾®æœåŠ¡å’Œç½‘å…³æœåŠ¡ï¼Œé€šè¿‡ç½‘å…³æœåŠ¡è®¿é—®ç”¨æˆ·å¾®æœåŠ¡ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://localhost:10001/server-user/user/get/1001ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ å¯ä»¥çœ‹åˆ°é€šè¿‡http://localhost:10001/server-user/user/get/1001é“¾æ¥ä¸èƒ½æ­£ç¡®è®¿é—®åˆ°ç”¨æˆ·ä¿¡æ¯ã€‚ æ¥ä¸‹æ¥ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://192.168.0.27:10001/server-user/user/get/1001ï¼Œèƒ½å¤Ÿæ­£ç¡®è·å–åˆ°ç”¨æˆ·çš„ä¿¡æ¯ã€‚ ï¼ˆ4ï¼‰åœæ­¢ç½‘å…³å¾®æœåŠ¡ï¼Œå°†åŸºäºè¿œç¨‹åœ°å€çš„æ–­è¨€é…ç½®æˆ- RemoteAddr=192.168.1.1/24ï¼Œä¹Ÿå°±æ˜¯å°†åŸºäºè¿œç¨‹åœ°å€çš„æ–­è¨€é…ç½®æˆä¸æˆ‘æœ¬æœºIPåœ°å€ä¸åœ¨åŒä¸€ä¸ªç½‘æ®µï¼Œè¿™æ ·å°±èƒ½æ¼”ç¤ºè¯·æ±‚ä¸»æœºåœ°å€ä¸åœ¨åœ°å€æ®µä¸­çš„æƒ…å†µï¼Œä¿®æ”¹åçš„åŸºäºè¿œç¨‹åœ°å€çš„æ–­è¨€é…ç½®å¦‚ä¸‹æ‰€ç¤ºã€‚ - RemoteAddr=192.168.1.1/24 ï¼ˆ5ï¼‰é‡å¯ç½‘å…³æœåŠ¡ï¼Œå†æ¬¡åœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://localhost:10001/server-user/user/get/1001ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ å¯ä»¥çœ‹åˆ°é€šè¿‡http://localhost:10001/server-user/user/get/1001é“¾æ¥ä¸èƒ½æ­£ç¡®è®¿é—®åˆ°ç”¨æˆ·ä¿¡æ¯ã€‚ æ¥ä¸‹æ¥ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://192.168.0.27:10001/server-user/user/get/1001ï¼Œä¹Ÿä¸èƒ½æ­£ç¡®è·å–åˆ°ç”¨æˆ·çš„ä¿¡æ¯äº†ã€‚ è‡ªå®šä¹‰æ–­è¨€ SpringCloud Gatewayæ”¯æŒè‡ªå®šä¹‰æ–­è¨€åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…·ä½“ä¸šåŠ¡ä¸­ï¼ŒåŸºäºSpringCloud Gatewayè‡ªå®šä¹‰ç‰¹å®šçš„æ–­è¨€åŠŸèƒ½ã€‚ è‡ªå®šä¹‰æ–­è¨€æ¦‚è¿° SpringCloud Gatewayè™½ç„¶æä¾›äº†å¤šç§å†…ç½®çš„æ–­è¨€åŠŸèƒ½ï¼Œä½†æ˜¯åœ¨æŸäº›åœºæ™¯ä¸‹æ— æ³•æ»¡è¶³ä¸šåŠ¡çš„éœ€è¦ï¼Œæ­¤æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥åŸºäºSpringCloud Gatewayè‡ªå®šä¹‰æ–­è¨€åŠŸèƒ½ï¼Œä»¥æ­¤æ¥æ»¡è¶³æˆ‘ä»¬çš„ä¸šåŠ¡åœºæ™¯ã€‚ å®ç°è‡ªå®šä¹‰æ–­è¨€ è¿™é‡Œï¼Œæˆ‘ä»¬åŸºäºSpringCloud Gatewayå®ç°æ–­è¨€åŠŸèƒ½ï¼Œå®ç°åçš„æ•ˆæœæ˜¯åœ¨æœåŠ¡ç½‘å…³çš„application.ymlæ–‡ä»¶ä¸­çš„spring.cloud.gateway.routesèŠ‚ç‚¹ä¸‹çš„- id: user-gatewayä¸‹é¢è¿›è¡Œå¦‚ä¸‹é…ç½®ã€‚ spring: cloud: gateway: routes: - id: user-gateway uri: http://localhost:8060 order: 1 predicates: - Path=/server-user/** - Name=binghe filters: - StripPrefix=1 é€šè¿‡æœåŠ¡ç½‘å…³è®¿é—®ç”¨æˆ·å¾®æœåŠ¡æ—¶ï¼Œåªæœ‰åœ¨è®¿é—®çš„é“¾æ¥åé¢æ·»åŠ ?name=bingheå‚æ•°æ—¶æ‰èƒ½æ­£ç¡®è®¿é—®ç”¨æˆ·å¾®æœåŠ¡ã€‚ ï¼ˆ1ï¼‰åœ¨ç½‘å…³æœåŠ¡shop-gatewayä¸­æ–°å»ºio.binghe.shop.predicateåŒ…ï¼Œåœ¨åŒ…ä¸‹æ–°å»ºNameRoutePredicateConfigç±»ï¼Œä¸»è¦å®šä¹‰ä¸€ä¸ªSpringç±»å‹çš„nameæˆå‘˜å˜é‡ï¼Œç”¨æ¥æ¥æ”¶é…ç½®æ–‡ä»¶ä¸­çš„å‚æ•°ï¼Œæºç å¦‚ä¸‹æ‰€ç¤ºã€‚ /** * @author binghe * @version 1.0.0 * @description æ¥æ”¶é…ç½®æ–‡ä»¶ä¸­çš„å‚æ•° */ @Data public class NameRoutePredicateConfig implements Serializable { private static final long serialVersionUID = -3289515863427972825L; private String name; } ï¼ˆ2ï¼‰å®ç°è‡ªå®šä¹‰æ–­è¨€æ—¶ï¼Œéœ€è¦æ–°å»ºç±»ç»§æ‰¿org.springframework.cloud.gateway.handler.predicate.AbstractRoutePredicateFactoryç±»ï¼Œåœ¨io.binghe.shop.predicateåŒ…ä¸‹æ–°å»ºNameRoutePredicateFactoryç±»ï¼Œç»§æ‰¿org.springframework.cloud.gateway.handler.predicate.AbstractRoutePredicateFactoryç±»ï¼Œå¹¶è¦†å†™ç›¸å…³çš„æ–¹æ³•ï¼Œæºç å¦‚ä¸‹æ‰€ç¤ºã€‚ /** * @author binghe * @version 1.0.0 * @description è‡ªå®šä¹‰æ–­è¨€åŠŸèƒ½ */ @Component public class NameRoutePredicateFactory extends AbstractRoutePredicateFactory&lt;NameRoutePredicateConfig&gt; { public NameRoutePredicateFactory() { super(NameRoutePredicateConfig.class); } @Override public Predicate&lt;ServerWebExchange&gt; apply(NameRoutePredicateConfig config) { return (serverWebExchange)-&gt;{ String name = serverWebExchange.getRequest().getQueryParams().getFirst(&quot;name&quot;); if (StringUtils.isEmpty(name)){ name = &quot;&quot;; } return name.equals(config.getName()); }; } @Override public List&lt;String&gt; shortcutFieldOrder() { return Arrays.asList(&quot;name&quot;); } } ï¼ˆ3ï¼‰åœ¨æœåŠ¡ç½‘å…³çš„application.ymlæ–‡ä»¶ä¸­çš„spring.cloud.gateway.routesèŠ‚ç‚¹ä¸‹çš„- id: user-gatewayä¸‹é¢è¿›è¡Œå¦‚ä¸‹é…ç½®ã€‚ spring: cloud: gateway: routes: - id: user-gateway uri: http://localhost:8060 order: 1 predicates: - Path=/server-user/** - Name=binghe filters: - StripPrefix=1 ï¼ˆ4ï¼‰åˆ†åˆ«å¯åŠ¨ç”¨æˆ·å¾®æœåŠ¡ä¸ç½‘å…³æœåŠ¡ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://localhost:10001/server-user/user/get/1001ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://localhost:10001/server-user/user/get/1001ï¼Œæ— æ³•è·å–åˆ°ç”¨æˆ·ä¿¡æ¯ã€‚ ï¼ˆ5ï¼‰åœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://localhost:10001/server-user/user/get/1001?name=bingheï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è®¿é—®é“¾æ¥åæ·»åŠ ?name=bingheå‚æ•°åï¼Œèƒ½å¤Ÿæ­£ç¡®è·å–åˆ°ç”¨æˆ·ä¿¡æ¯ã€‚ è‡³æ­¤ï¼Œæˆ‘ä»¬å®ç°äº†è‡ªå®šä¹‰æ–­è¨€åŠŸèƒ½ã€‚ ç½‘å…³è¿‡æ»¤å™¨ è¿‡æ»¤å™¨å¯ä»¥åœ¨è¯·æ±‚è¿‡ç¨‹ä¸­ï¼Œä¿®æ”¹è¯·æ±‚çš„å‚æ•°å’Œå“åº”çš„ç»“æœç­‰ä¿¡æ¯ã€‚åœ¨ç”Ÿå‘½å‘¨æœŸçš„è§’åº¦æ€»ä½“ä¸Šå¯ä»¥åˆ†ä¸ºå‰ç½®è¿‡æ»¤å™¨ï¼ˆPreï¼‰å’Œåç½®è¿‡æ»¤å™¨(Post)ã€‚åœ¨å®ç°çš„è¿‡æ»¤èŒƒå›´è§’åº¦å¯ä»¥åˆ†ä¸ºå±€éƒ¨è¿‡æ»¤å™¨ï¼ˆGatewayFilterï¼‰å’Œå…¨å±€è¿‡æ»¤å™¨ï¼ˆGlobalFilterï¼‰ã€‚å±€éƒ¨è¿‡æ»¤å™¨ä½œç”¨çš„èŒƒå›´æ˜¯æŸä¸€ä¸ªè·¯ç”±ï¼Œå…¨å±€è¿‡æ»¤å™¨ä½œç”¨çš„èŒƒå›´æ˜¯å…¨éƒ¨è·¯ç”±ã€‚ Preå‰ç½®è¿‡æ»¤å™¨ï¼šåœ¨è¯·æ±‚è¢«ç½‘å…³è·¯ç”±ä¹‹å‰è°ƒç”¨ï¼Œå¯ä»¥åˆ©ç”¨è¿™ç§è¿‡æ»¤å™¨å®ç°è®¤è¯ã€é‰´æƒã€è·¯ç”±ç­‰åŠŸèƒ½ï¼Œä¹Ÿå¯ä»¥è®°å½•è®¿é—®æ—¶é—´ç­‰ä¿¡æ¯ã€‚ Poståç½®è¿‡æ»¤å™¨ï¼šåœ¨è¯·æ±‚è¢«ç½‘å…³è·¯ç”±åˆ°å¾®æœåŠ¡ä¹‹åæ‰§è¡Œã€‚å¯ä»¥åˆ©ç”¨è¿™ç§è¿‡æ»¤å™¨ä¿®æ”¹HTTPçš„å“åº”Headerä¿¡æ¯ï¼Œä¿®æ”¹è¿”å›çš„ç»“æœæ•°æ®ï¼ˆä¾‹å¦‚å¯¹äºä¸€äº›æ•æ„Ÿçš„æ•°æ®ï¼Œå¯ä»¥åœ¨æ­¤è¿‡æ»¤å™¨ä¸­ç»Ÿä¸€å¤„ç†åè¿”å›ï¼‰ï¼Œæ”¶é›†ä¸€äº›ç»Ÿè®¡ä¿¡æ¯ç­‰ã€‚ å±€éƒ¨è¿‡æ»¤å™¨ï¼ˆGatewayFilterï¼‰ï¼šä¹Ÿå¯ä»¥ç§°ä¸ºç½‘å…³è¿‡æ»¤å™¨ï¼Œè¿™ç§è¿‡æ»¤å™¨ä¸»è¦æ˜¯ä½œç”¨äºå•ä¸€è·¯ç”±æˆ–è€…æŸä¸ªè·¯ç”±åˆ†ç»„ã€‚ å…¨å±€è¿‡æ»¤å™¨ï¼ˆGlobalFilterï¼‰ï¼šè¿™ç§è¿‡æ»¤å™¨ä¸»è¦ä½œç”¨äºæ‰€æœ‰çš„è·¯ç”±ã€‚ å±€éƒ¨è¿‡æ»¤å™¨ å±€éƒ¨è¿‡æ»¤å™¨åˆç§°ä¸ºç½‘å…³è¿‡æ»¤å™¨ï¼Œè¿™ç§è¿‡æ»¤å™¨ä¸»è¦æ˜¯ä½œç”¨äºå•ä¸€è·¯ç”±æˆ–è€…æŸä¸ªè·¯ç”±åˆ†ç»„ã€‚ å±€éƒ¨è¿‡æ»¤å™¨æ¦‚è¿° åœ¨SpringCloud Gatewayä¸­å†…ç½®äº†å¾ˆå¤šä¸åŒç±»å‹çš„å±€éƒ¨è¿‡æ»¤å™¨ï¼Œä¸»è¦å¦‚ä¸‹æ‰€ç¤ºã€‚ æ¼”ç¤ºå†…éƒ¨è¿‡æ»¤å™¨ æ¼”ç¤ºå†…éƒ¨è¿‡æ»¤å™¨æ—¶ï¼Œæˆ‘ä»¬ä¸ºåŸå§‹è¯·æ±‚æ·»åŠ ä¸€ä¸ªåç§°ä¸ºIPçš„Headerï¼Œå€¼ä¸ºlocalhostï¼Œå¹¶æ·»åŠ ä¸€ä¸ªåç§°ä¸ºnameçš„å‚æ•°ï¼Œå‚æ•°å€¼ä¸ºbingheã€‚åŒæ—¶ä¿®æ”¹å“åº”çš„ç»“æœçŠ¶æ€ï¼Œå°†ç»“æœçŠ¶æ€ä¿®æ”¹ä¸º1001ã€‚ ï¼ˆ1ï¼‰åœ¨æœåŠ¡ç½‘å…³çš„application.ymlæ–‡ä»¶ä¸­çš„spring.cloud.gateway.routesèŠ‚ç‚¹ä¸‹çš„- id: user-gatewayä¸‹é¢è¿›è¡Œå¦‚ä¸‹é…ç½®ã€‚ spring: cloud: gateway: routes: - id: user-gateway uri: http://localhost:8060 order: 1 predicates: - Path=/server-user/** filters: - StripPrefix=1 - AddRequestHeader=IP,localhost - AddRequestParameter=name,binghe - SetStatus=1001 ï¼ˆ2ï¼‰åœ¨ç”¨æˆ·å¾®æœåŠ¡çš„io.binghe.shop.user.controller.UserControllerç±»ä¸­æ–°å¢apiFilter1()æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ @GetMapping(value = &quot;/api/filter1&quot;) public String apiFilter1(HttpServletRequest request, HttpServletResponse response){ log.info(&quot;è®¿é—®äº†apiFilter1æ¥å£&quot;); String ip = request.getHeader(&quot;IP&quot;); String name = request.getParameter(&quot;name&quot;); log.info(&quot;ip = &quot; + ip + &quot;, name = &quot; + name); return &quot;apiFilter1&quot;; } å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ–°å¢åŠ çš„apiFilter1()æ–¹æ³•ä¸­ï¼Œè·å–åˆ°æ–°å¢åŠ çš„Headerä¸å‚æ•°ï¼Œå¹¶å°†è·å–å‡ºæ¥çš„å‚æ•°ä¸Headeræ‰“å°å‡ºæ¥ã€‚å¹¶ä¸”æ–¹æ³•è¿”å›çš„æ˜¯å­—ç¬¦ä¸²apiFilter1ã€‚ ï¼ˆ3ï¼‰åˆ†åˆ«å¯åŠ¨ç”¨æˆ·å¾®æœåŠ¡ä¸ç½‘å…³æœåŠ¡ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://localhost:10001/server-user/user/api/filter1ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ æ­¤æ—¶ï¼ŒæŸ¥çœ‹æµè§ˆå™¨ä¸­çš„å“åº”çŠ¶æ€ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ å¯ä»¥çœ‹åˆ°ï¼Œæ­¤æ—¶çš„çŠ¶æ€ç å·²ç»è¢«ä¿®æ”¹ä¸º1001ã€‚ æ¥ä¸‹æ¥ï¼ŒæŸ¥çœ‹ä¸‹ç”¨æˆ·å¾®æœåŠ¡çš„æ§åˆ¶å°è¾“å‡ºçš„ä¿¡æ¯ï¼Œå‘ç°åœ¨è¾“å‡ºçš„ä¿¡æ¯ä¸­å­˜åœ¨å¦‚ä¸‹æ•°æ®ã€‚ è®¿é—®äº†apiFilter1æ¥å£ ip = localhost, name = binghe è¯´æ˜ä½¿ç”¨SpringCloud Gatewayçš„å†…ç½®è¿‡æ»¤å™¨æˆåŠŸä¸ºåŸå§‹è¯·æ±‚æ·»åŠ äº†ä¸€ä¸ªåç§°ä¸ºIPçš„Headerï¼Œå€¼ä¸ºlocalhostï¼Œå¹¶æ·»åŠ äº†ä¸€ä¸ªåç§°ä¸ºnameçš„å‚æ•°ï¼Œå‚æ•°å€¼ä¸ºbingheã€‚åŒæ—¶ä¿®æ”¹äº†å“åº”çš„ç»“æœçŠ¶æ€ï¼Œå°†ç»“æœçŠ¶æ€ä¿®æ”¹ä¸º1001ï¼Œç¬¦åˆé¢„æœŸæ•ˆæœã€‚ è‡ªå®šä¹‰å±€éƒ¨è¿‡æ»¤å™¨ è¿™é‡Œï¼Œæˆ‘ä»¬åŸºäºSpringCloud Gatewayè‡ªå®šä¹‰å±€éƒ¨è¿‡æ»¤å™¨å®ç°æ˜¯å¦å¼€å¯ç°åº¦å‘å¸ƒçš„åŠŸèƒ½ï¼Œæ•´ä¸ªå®ç°è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºã€‚ ï¼ˆ1ï¼‰åœ¨æœåŠ¡ç½‘å…³çš„application.ymlæ–‡ä»¶ä¸­çš„spring.cloud.gateway.routesèŠ‚ç‚¹ä¸‹çš„- id: user-gatewayä¸‹é¢è¿›è¡Œå¦‚ä¸‹é…ç½®ã€‚ spring: cloud: gateway: routes: - id: user-gateway uri: http://localhost:8060 order: 1 predicates: - Path=/server-user/** filters: - StripPrefix=1 - Grayscale=true ï¼ˆ2ï¼‰åœ¨ç½‘å…³æœåŠ¡æ¨¡å—shop-gatewayä¸­æ–°å»ºio.binghe.shop.filteråŒ…ï¼Œåœ¨åŒ…ä¸‹æ–°å»ºGrayscaleGatewayFilterConfigç±»ï¼Œç”¨äºæ¥æ”¶é…ç½®ä¸­çš„å‚æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ /** * @author binghe * @version 1.0.0 * @description æ¥æ”¶é…ç½®å‚æ•° */ @Data public class GrayscaleGatewayFilterConfig implements Serializable { private static final long serialVersionUID = 983019309000445082L; private boolean grayscale; } ï¼ˆ3ï¼‰åœ¨io.binghe.shop.filteråŒ…ä¸‹GrayscaleGatewayFilterFactoryç±»ï¼Œç»§æ‰¿org.springframework.cloud.gateway.filter.factory.AbstractGatewayFilterFactoryç±»ï¼Œä¸»è¦æ˜¯å®ç°è‡ªå®šä¹‰è¿‡æ»¤å™¨ï¼Œæ¨¡æ‹Ÿå®ç°ç°åº¦å‘å¸ƒã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ /** * @author binghe * @version 1.0.0 * @description è‡ªå®šä¹‰è¿‡æ»¤å™¨æ¨¡æ‹Ÿå®ç°ç°åº¦å‘å¸ƒ */ @Component public class GrayscaleGatewayFilterFactory extends AbstractGatewayFilterFactory&lt;GrayscaleGatewayFilterConfig&gt; { public GrayscaleGatewayFilterFactory(){ super(GrayscaleGatewayFilterConfig.class); } @Override public GatewayFilter apply(GrayscaleGatewayFilterConfig config) { return (exchange, chain) -&gt; { if (config.isGrayscale()){ System.out.println(&quot;å¼€å¯äº†ç°åº¦å‘å¸ƒåŠŸèƒ½...&quot;); }else{ System.out.println(&quot;å…³é—­äº†ç°åº¦å‘å¸ƒåŠŸèƒ½...&quot;); } return chain.filter(exchange); }; } @Override public List&lt;String&gt; shortcutFieldOrder() { return Arrays.asList(&quot;grayscale&quot;); } } ï¼ˆ4ï¼‰åˆ†åˆ«å¯åŠ¨ç”¨æˆ·å¾®æœåŠ¡å’ŒæœåŠ¡ç½‘å…³ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://localhost:10001/server-user/user/get/1001ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡æœåŠ¡ç½‘å…³æ­£ç¡®è®¿é—®åˆ°äº†ç”¨æˆ·å¾®æœåŠ¡ï¼Œå¹¶æ­£ç¡®è·å–åˆ°äº†ç”¨æˆ·ä¿¡æ¯ã€‚ æ¥ä¸‹æ¥ï¼ŒæŸ¥çœ‹ä¸‹æœåŠ¡ç½‘å…³çš„ç»ˆç«¯ï¼Œå‘ç°å·²ç»æˆåŠŸè¾“å‡ºäº†å¦‚ä¸‹ä¿¡æ¯ã€‚ å¼€å¯äº†ç°åº¦å‘å¸ƒåŠŸèƒ½... è¯´æ˜æ­£ç¡®å®ç°äº†è‡ªå®šä¹‰çš„å±€éƒ¨è¿‡æ»¤å™¨ã€‚ å…¨å±€è¿‡æ»¤å™¨ å…¨å±€è¿‡æ»¤å™¨æ˜¯ä¸€ç³»åˆ—ç‰¹æ®Šçš„è¿‡æ»¤å™¨ï¼Œä¼šæ ¹æ®æ¡ä»¶åº”ç”¨åˆ°æ‰€æœ‰è·¯ç”±ä¸­ã€‚ å…¨å±€è¿‡æ»¤å™¨æ¦‚è¿° åœ¨SpringCloud Gatewayä¸­å†…ç½®äº†å¤šç§ä¸åŒçš„å…¨å±€è¿‡æ»¤å™¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ æ¼”ç¤ºå…¨å±€è¿‡æ»¤å™¨ ï¼ˆ1ï¼‰åœ¨æœåŠ¡ç½‘å…³æ¨¡å—shop-gatewayæ¨¡å—ä¸‹çš„io.binghe.shop.configåŒ…ä¸‹æ–°å»ºGatewayFilterConfigç±»ï¼Œå¹¶åœ¨ç±»ä¸­é…ç½®å‡ ä¸ªå…¨å±€è¿‡æ»¤å™¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ /** * @author binghe * @version 1.0.0 * @description ç½‘å…³è¿‡æ»¤å™¨é…ç½® */ @Configuration @Slf4j public class GatewayFilterConfig { @Bean @Order(-1) public GlobalFilter globalFilter() { return (exchange, chain) -&gt; { log.info(&quot;æ‰§è¡Œå‰ç½®è¿‡æ»¤å™¨é€»è¾‘&quot;); return chain.filter(exchange).then(Mono.fromRunnable(() -&gt; { log.info(&quot;æ‰§è¡Œåç½®è¿‡æ»¤å™¨é€»è¾‘&quot;); })); }; } } æ³¨æ„ï¼š@Orderæ³¨è§£ä¸­çš„æ•°å­—è¶Šå°ï¼Œæ‰§è¡Œçš„ä¼˜å…ˆçº§è¶Šé«˜ã€‚ ï¼ˆ2ï¼‰å¯åŠ¨ç”¨æˆ·å¾®æœåŠ¡ä¸æœåŠ¡ç½‘å…³ï¼Œåœ¨æµè§ˆå™¨ä¸­è®¿é—®http://localhost:10001/server-user/user/get/1001ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ åœ¨æœåŠ¡ç½‘å…³ç»ˆç«¯è¾“å‡ºå¦‚ä¸‹ä¿¡æ¯ã€‚ æ‰§è¡Œå‰ç½®è¿‡æ»¤å™¨é€»è¾‘ æ‰§è¡Œåç½®è¿‡æ»¤å™¨é€»è¾‘ è¯´æ˜æˆ‘ä»¬æ¼”ç¤ºçš„å…¨å±€è¿‡æ»¤å™¨ç”Ÿæ•ˆäº†ã€‚ è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨ SpringCloud Gatewayå†…ç½®äº†å¾ˆå¤šå…¨å±€è¿‡æ»¤å™¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹èƒ½å¤Ÿæ»¡è¶³å®é™…å¼€å‘éœ€è¦ï¼Œä½†æ˜¯å¯¹äºæŸäº›ç‰¹æ®Šçš„ä¸šåŠ¡åœºæ™¯ï¼Œè¿˜æ˜¯éœ€è¦æˆ‘ä»¬è‡ªå·±å®ç°è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨ã€‚ è¿™é‡Œï¼Œæˆ‘ä»¬å°±æ¨¡æ‹Ÿå®ç°ä¸€ä¸ªè·å–å®¢æˆ·ç«¯è®¿é—®ä¿¡æ¯ï¼Œå¹¶ç»Ÿè®¡è®¿é—®æ¥å£æ—¶é•¿çš„å…¨å±€è¿‡æ»¤å™¨ã€‚ ï¼ˆ1ï¼‰åœ¨ç½‘å…³æœåŠ¡æ¨¡å—shop-orderçš„io.binghe.shop.filteråŒ…ä¸‹ï¼Œæ–°å»ºGlobalGatewayLogFilterç±»ï¼Œå®ç°org.springframework.cloud.gateway.filter.GlobalFilteræ¥å£å’Œorg.springframework.core.Orderedæ¥å£ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ /** * @author binghe * @version 1.0.0 * @description è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨ï¼Œæ¨¡æ‹Ÿå®ç°è·å–å®¢æˆ·ç«¯ä¿¡æ¯å¹¶ç»Ÿè®¡æ¥å£è®¿é—®æ—¶é•¿ */ @Slf4j @Component public class GlobalGatewayLogFilter implements GlobalFilter, Ordered { /** * å¼€å§‹è®¿é—®æ—¶é—´ */ private static final String BEGIN_VISIT_TIME = &quot;begin_visit_time&quot;; @Override public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) { //å…ˆè®°å½•ä¸‹è®¿é—®æ¥å£çš„å¼€å§‹æ—¶é—´ exchange.getAttributes().put(BEGIN_VISIT_TIME, System.currentTimeMillis()); return chain.filter(exchange).then(Mono.fromRunnable(()-&gt;{ Long beginVisitTime = exchange.getAttribute(BEGIN_VISIT_TIME); if (beginVisitTime != null){ log.info(&quot;è®¿é—®æ¥å£ä¸»æœº: &quot; + exchange.getRequest().getURI().getHost()); log.info(&quot;è®¿é—®æ¥å£ç«¯å£: &quot; + exchange.getRequest().getURI().getPort()); log.info(&quot;è®¿é—®æ¥å£URL: &quot; + exchange.getRequest().getURI().getPath()); log.info(&quot;è®¿é—®æ¥å£URLå‚æ•°: &quot; + exchange.getRequest().getURI().getRawQuery()); log.info(&quot;è®¿é—®æ¥å£æ—¶é•¿: &quot; + (System.currentTimeMillis() - beginVisitTime) + &quot;ms&quot;); } })); } @Override public int getOrder() { return 0; } } ä¸Šè¿°ä»£ç çš„å®ç°é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ã€‚ ï¼ˆ2ï¼‰å¯åŠ¨ç”¨æˆ·å¾®æœåŠ¡ä¸ç½‘å…³æœåŠ¡ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://localhost:10001/server-user/user/api/filter1?name=bingheï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ æ¥ä¸‹æ¥ï¼ŒæŸ¥çœ‹æœåŠ¡ç½‘å…³çš„ç»ˆç«¯æ—¥å¿—ï¼Œå¯ä»¥å‘ç°å·²ç»è¾“å‡ºäº†å¦‚ä¸‹ä¿¡æ¯ã€‚ è®¿é—®æ¥å£ä¸»æœº: localhost è®¿é—®æ¥å£ç«¯å£: 10001 è®¿é—®æ¥å£URL: /server-user/user/api/filter1 è®¿é—®æ¥å£URLå‚æ•°: name=binghe è®¿é—®æ¥å£æ—¶é•¿: 126ms è¯´æ˜æˆ‘ä»¬è‡ªå®šä¹‰çš„å…¨å±€è¿‡æ»¤å™¨ç”Ÿæ•ˆäº†ã€‚ ","link":"https://tianxiawuhao.github.io/ipsD-XbrM/"},{"title":"gatewayé¡¹ç›®æ•´åˆç½‘å…³","content":"é¡¹ç›®æ•´åˆç½‘å…³ æˆ‘ä»¬éœ€è¦åœ¨é¡¹ç›®ä¸­å¢åŠ ä¸€ä¸ªæœåŠ¡ç½‘å…³æ¨¡å—shop-gatewayï¼Œåœ¨æœåŠ¡ç½‘å…³æ¨¡å—ä¸­å®ç°ç½‘å…³çš„èƒ½åŠ›ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬çš„é¡¹ç›®ä¸­å°±ä¼šæœ‰ç”¨æˆ·å¾®æœåŠ¡ã€å•†å“å¾®æœåŠ¡ã€è®¢å•å¾®æœåŠ¡å’ŒæœåŠ¡ç½‘å…³ã€‚ æ–°å»ºç½‘å…³æ¨¡å— åœ¨é¡¹ç›®ä¸­æ–°å»ºshop-gatewayæ¨¡å—ï¼Œæ–°å¢ç½‘å…³æ¨¡å—åé¡¹ç›®çš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ åˆæ­¥æ•´åˆSpringCloud Gateway ï¼ˆ1ï¼‰åœ¨æœåŠ¡ç½‘å…³shop-gatewayæ¨¡å—çš„pom.xmlæ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹ä¾èµ–ã€‚ &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt; &lt;/dependency&gt; &lt;/dependencies&gt; ï¼ˆ2ï¼‰åœ¨æœåŠ¡ç½‘å…³shop-gatewayæ¨¡å—çš„resourcesç›®å½•ä¸‹æ–°å»ºapplication.ymlæ–‡ä»¶ï¼Œå¹¶åœ¨æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ä¿¡æ¯ã€‚ server: port: 10001 spring: application: name: server-gateway cloud: gateway: globalcors: cors-configurations: '[/**]': allowedOrigins: &quot;*&quot; allowedMethods: &quot;*&quot; allowCredentials: true allowedHeaders: &quot;*&quot; routes: - id: user-gateway uri: http://localhost:8060 order: 1 predicates: - Path=/server-user/** filters: - StripPrefix=1 - id: product-gateway uri: http://localhost:8070 order: 1 predicates: - Path=/server-product/** filters: - StripPrefix=1 - id: order-gateway uri: http://localhost:8080 order: 1 predicates: - Path=/server-order/** filters: - StripPrefix=1 æˆ‘ä»¬é‡ç‚¹æ¥çœ‹ä¸‹ spring.cloud.gateway èŠ‚ç‚¹ä¸‹çš„é…ç½®ã€‚ globalcorsï¼šæ­¤èŠ‚ç‚¹ä¸‹çš„é…ç½®æ˜¯ä¸ºäº†è§£å†³SpringCloud Gatewayè·¨åŸŸçš„é—®é¢˜ã€‚ routesï¼šè¡¨ç¤ºä¸€ä¸ªè·¯ç”±æ•°ç»„ï¼Œå¯ä»¥åœ¨æ­¤èŠ‚ç‚¹ä¸‹é…ç½®å¤šä¸ªè·¯ç”±ä¿¡æ¯ã€‚ idï¼šå½“å‰è·¯ç”±çš„å”¯ä¸€æ ‡è¯†ã€‚ orderï¼šè·¯ç”±çš„ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå°è¡¨ç¤ºä¼˜å…ˆçº§è¶Šé«˜ã€‚ predicatesï¼šç½‘å…³æ–­è¨€ï¼Œä¹Ÿå°±æ˜¯è·¯ç”±è½¬å‘çš„æ¡ä»¶ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå¯ä»¥é…ç½®å¤šä¸ªè·¯ç”±è½¬å‘æ¡ä»¶ã€‚ Pathï¼šå½“å®¢æˆ·ç«¯è¯·æ±‚çš„è·¯å¾„æ»¡è¶³Pathçš„è§„åˆ™æ—¶ï¼Œè¿›è¡Œè·¯ç”±è½¬å‘æ“ä½œã€‚ filtersï¼šç½‘å…³è¿‡æ»¤å™¨ï¼Œåœ¨è¿‡æ»¤å™¨ä¸­å¯ä»¥ä¿®æ”¹è¯·æ±‚çš„å‚æ•°å’Œheaderä¿¡æ¯ï¼Œä»¥åŠå“åº”çš„ç»“æœå’Œheaderä¿¡æ¯ï¼Œç½‘å…³è¿‡æ»¤å™¨ä¹Ÿæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå¯ä»¥é…ç½®å¤šä¸ªè¿‡æ»¤è§„åˆ™ã€‚ StripPrefixï¼šç½‘å…³åœ¨è¿›è¡Œè·¯ç”±è½¬å‘ä¹‹å‰ï¼Œä¼šå»æ‰1å±‚è®¿é—®è·¯å¾„ã€‚ ï¼ˆ3ï¼‰åœ¨æœåŠ¡ç½‘å…³shop-gatewayæ¨¡å—çš„io.binghe.shopåŒ…ä¸‹æ–°å»ºGatewayStarterç±»ï¼Œè¡¨ç¤ºæœåŠ¡ç½‘å…³çš„å¯åŠ¨ç±»ï¼Œæºç å¦‚ä¸‹æ‰€ç¤ºã€‚ /** * @version 1.0.0 * @description æœåŠ¡ç½‘å…³å¯åŠ¨ç±» */ @SpringBootApplication public class GatewayStarter { public static void main(String[] args){ SpringApplication.run(GatewayStarter.class, args); } } ï¼ˆ4ï¼‰ç”±äºä¹‹å‰é¡¹ç›®ä¸­æ•´åˆäº†Nacoså’ŒSentinelï¼Œæ‰€ä»¥ï¼Œåœ¨å¯åŠ¨é¡¹ç›®å‰ï¼Œè¦åˆ†åˆ«å¯åŠ¨Nacoså’ŒSentinelã€‚ è¿›å…¥åˆ°Nacosçš„binç›®å½•ä¸‹ï¼Œè¾“å…¥å¦‚ä¸‹å‘½ä»¤å¯åŠ¨Nacosã€‚ startup.cmd -m standalone è¿›å…¥Sentinel JaråŒ…æ‰€åœ¨çš„ç›®å½•ï¼Œè¾“å…¥å¦‚ä¸‹å‘½ä»¤å¯åŠ¨Sentinelã€‚ java -Dserver.port=8888 -Dcsp.sentinel.dashboard.server=localhost:8888 -Dproject.name=sentinel-dashboard -jar sentinel-dashboard-1.8.4.jar ï¼ˆ5ï¼‰åˆ†åˆ«å¯åŠ¨ç”¨æˆ·å¾®æœåŠ¡ã€å•†å“å¾®æœåŠ¡ã€è®¢å•å¾®æœåŠ¡å’ŒæœåŠ¡ç½‘å…³ã€‚ ï¼ˆ6ï¼‰é€šè¿‡æœåŠ¡ç½‘å…³è®¿é—®ç”¨æˆ·å¾®æœåŠ¡ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://localhost:10001/server-user/user/get/1001ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ç”¨æˆ·å¾®æœåŠ¡è¿”å›çš„åŸå§‹æ•°æ®å¦‚ä¸‹æ‰€ç¤ºã€‚ { &quot;id&quot;: 1001, &quot;username&quot;: &quot;binghe&quot;, &quot;password&quot;: &quot;c26be8aaf53b15054896983b43eb6a65&quot;, &quot;phone&quot;: &quot;13212345678&quot;, &quot;address&quot;: &quot;åŒ—äº¬&quot; } å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡æœåŠ¡ç½‘å…³èƒ½å¤Ÿæ­£ç¡®è®¿é—®åˆ°ç”¨æˆ·å¾®æœåŠ¡ã€‚ ï¼ˆ7ï¼‰é€šè¿‡æœåŠ¡ç½‘å…³è®¿é—®å•†å“å¾®æœåŠ¡ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://localhost:10001/server-product/product/get/1001ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ å•†å“å¾®æœåŠ¡è¿”å›çš„åŸå§‹æ•°æ®å¦‚ä¸‹æ‰€ç¤ºã€‚ { &quot;id&quot;: 1001, &quot;proName&quot;: &quot;åä¸º&quot;, &quot;proPrice&quot;: 2399, &quot;proStock&quot;: 100 } å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡æœåŠ¡ç½‘å…³èƒ½å¤Ÿæ­£ç¡®è®¿é—®åˆ°å•†å“å¾®æœåŠ¡ã€‚ ï¼ˆ8ï¼‰é€šè¿‡æœåŠ¡ç½‘å…³è®¿é—®è®¢å•å¾®æœåŠ¡ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://localhost:10001/server-order/order/test_sentinelï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡æœåŠ¡ç½‘å…³èƒ½å¤Ÿæ­£ç¡®è®¿é—®åˆ°è®¢å•å¾®æœåŠ¡ã€‚ ç½‘å…³æ•´åˆNacos åœ¨åˆæ­¥æ•´åˆSpringCloud Gatewayä¸­ï¼Œæˆ‘ä»¬åœ¨æœåŠ¡ç½‘å…³æ¨¡å—çš„application.ymlæ–‡ä»¶ä¸­ç¡¬ç¼–ç é…ç½®äº†æœåŠ¡è½¬å‘çš„åœ°å€ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ç¡¬ç¼–ç ç”¨æˆ·å¾®æœåŠ¡åœ°å€ uri: http://localhost:8060 ç¡¬ç¼–ç å•†å“å¾®æœåŠ¡åœ°å€ uri: http://localhost:8070 ç¡¬ç¼–ç è®¢å•å¾®æœåŠ¡åœ°å€ uri: http://localhost:8080 è¿™é‡Œï¼Œæˆ‘ä»¬å°†ç½‘å…³æ•´åˆNacoså®ç°ä»Nacosæ³¨å†Œä¸­å¿ƒè·å–è½¬å‘çš„æœåŠ¡åœ°å€ã€‚ ï¼ˆ1ï¼‰åœ¨æœåŠ¡ç½‘å…³shop-gatewayæ¨¡å—çš„pom.xmlæ–‡ä»¶ä¸­ç»§ç»­æ·»åŠ å¦‚ä¸‹ä¾èµ–ã€‚ &lt;dependency&gt; &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt; &lt;/dependency&gt; ï¼ˆ2ï¼‰åœ¨æœåŠ¡ç½‘å…³shop-gatewayæ¨¡å—çš„å¯åŠ¨ç±»io.binghe.shop.GatewayStarterä¸Šæ·»åŠ @EnableDiscoveryClientæ³¨è§£ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ /** * @version 1.0.0 * @description æœåŠ¡ç½‘å…³å¯åŠ¨ç±» */ @SpringBootApplication @EnableDiscoveryClient public class GatewayStarter { public static void main(String[] args){ SpringApplication.run(GatewayStarter.class, args); } } ï¼ˆ3ï¼‰å°†application.ymlå¤‡ä»½ä¸€ä»½ï¼Œå‘½åä¸ºapplication-simple.ymlï¼Œå¹¶ä¿®æ”¹application.ymlé…ç½®æ–‡ä»¶ï¼Œä¿®æ”¹åçš„æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºã€‚ server: port: 10001 spring: application: name: server-gateway cloud: nacos: discovery: server-addr: 127.0.0.1:8848 gateway: globalcors: cors-configurations: '[/**]': allowedOrigins: &quot;*&quot; allowedMethods: &quot;*&quot; allowCredentials: true allowedHeaders: &quot;*&quot; discovery: locator: enabled: true routes: - id: user-gateway uri: lb://server-user order: 1 predicates: - Path=/server-user/** filters: - StripPrefix=1 - id: product-gateway uri: lb://server-product order: 1 predicates: - Path=/server-product/** filters: - StripPrefix=1 - id: order-gateway uri: lb://server-order order: 1 predicates: - Path=/server-order/** filters: - StripPrefix=1 ä¸Šè¿°é…ç½®ä¸­å¢åŠ äº†Nacosç›¸å…³çš„é…ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ spring: cloud: nacos: discovery: server-addr: 127.0.0.1:8848 æ–°å¢äº†è®©SpringCloud Gatewayå¯ä»¥å‘ç°Nacosä¸­çš„æœåŠ¡é…ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ Spring: cloud: gateway: discovery: locator: enabled: true å¦å¤–ï¼Œå°†ç¡¬ç¼–ç çš„æœåŠ¡è½¬å‘åœ°å€ä¿®æ”¹æˆä»Nacosä¸­æŒ‰ç…§åç§°è·å–å¾®æœåŠ¡åœ°å€ï¼Œå¹¶æŒ‰ç…§è´Ÿè½½å‡è¡¡ç­–ç•¥åˆ†å‘ã€‚ ä»Nacosä¸­è·å–ç”¨æˆ·å¾®æœåŠ¡ uri: lb://server-user ä»Nacosä¸­è·å–å•†å“å¾®æœåŠ¡ uri: lb://server-product ä»Nacosä¸­è·å–è®¢å•å¾®æœåŠ¡ uri: lb://server-order å…¶ä¸­ï¼ŒlbæŒ‡çš„æ˜¯ä»Nacosä¸­æŒ‰ç…§å¾®æœåŠ¡çš„åç§°è·å–å¾®æœåŠ¡åœ°å€ï¼Œå¹¶æŒ‰ç…§è´Ÿè½½å‡è¡¡çš„ç­–ç•¥åˆ†å‘ã€‚ä½¿ç”¨lbä»Nacosä¸­è·å–å¾®æœåŠ¡æ—¶ï¼Œéµå¾ªå¦‚ä¸‹çš„æ ¼å¼ã€‚ lb://å¾®æœåŠ¡åç§° å¾®æœåŠ¡çš„åç§°å°±æ˜¯å„ä¸ªå¾®æœåŠ¡åœ¨application.ymlæ–‡ä»¶ä¸­é…ç½®çš„æœåŠ¡åç§°ã€‚ spring: application: name: æœåŠ¡åç§° ï¼ˆ4ï¼‰åˆ†åˆ«å¯åŠ¨ç”¨æˆ·å¾®æœåŠ¡ã€å•†å“å¾®æœåŠ¡ã€è®¢å•å¾®æœåŠ¡å’ŒæœåŠ¡ç½‘å…³ã€‚ ï¼ˆ5ï¼‰é€šè¿‡æœåŠ¡ç½‘å…³è®¿é—®ç”¨æˆ·å¾®æœåŠ¡ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://localhost:10001/server-user/user/get/1001ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ç”¨æˆ·å¾®æœåŠ¡è¿”å›çš„åŸå§‹æ•°æ®å¦‚ä¸‹æ‰€ç¤ºã€‚ { &quot;id&quot;: 1001, &quot;username&quot;: &quot;binghe&quot;, &quot;password&quot;: &quot;c26be8aaf53b15054896983b43eb6a65&quot;, &quot;phone&quot;: &quot;13212345678&quot;, &quot;address&quot;: &quot;åŒ—äº¬&quot; } å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡æœåŠ¡ç½‘å…³èƒ½å¤Ÿæ­£ç¡®è®¿é—®åˆ°ç”¨æˆ·å¾®æœåŠ¡ã€‚ ï¼ˆ6ï¼‰é€šè¿‡æœåŠ¡ç½‘å…³è®¿é—®å•†å“å¾®æœåŠ¡ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://localhost:10001/server-product/product/get/1001ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ å•†å“å¾®æœåŠ¡è¿”å›çš„åŸå§‹æ•°æ®å¦‚ä¸‹æ‰€ç¤ºã€‚ { &quot;id&quot;: 1001, &quot;proName&quot;: &quot;åä¸º&quot;, &quot;proPrice&quot;: 2399, &quot;proStock&quot;: 100 } å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡æœåŠ¡ç½‘å…³èƒ½å¤Ÿæ­£ç¡®è®¿é—®åˆ°å•†å“å¾®æœåŠ¡ã€‚ ï¼ˆ7ï¼‰é€šè¿‡æœåŠ¡ç½‘å…³è®¿é—®è®¢å•å¾®æœåŠ¡ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://localhost:10001/server-order/order/test_sentinelï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡æœåŠ¡ç½‘å…³èƒ½å¤Ÿæ­£ç¡®è®¿é—®åˆ°è®¢å•å¾®æœåŠ¡ã€‚ ç½‘å…³æ•´åˆNacosæœ€ç®€é…ç½® SpringCloud Gatewayæ•´åˆNacosåï¼Œå¯ä»¥ä¸ç”¨æ‰‹åŠ¨æŒ‡å®šå…¶ä»–å¾®æœåŠ¡çš„åç§°æ¥ä»Nacosä¸­è·å–å¾®æœåŠ¡çš„åœ°å€ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥å®ç°SpringCloud Gatewayç½‘å…³æ•´åˆNacosçš„æœ€ç®€é…ç½®ã€‚ ï¼ˆ1ï¼‰å°†application.ymlå¤‡ä»½ä¸€ä»½ï¼Œå‘½åä¸ºapplication-nacos.ymlï¼Œå¹¶ä¿®æ”¹application.ymlé…ç½®æ–‡ä»¶ï¼Œä¿®æ”¹åçš„æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºã€‚ server: port: 10001 spring: application: name: server-gateway cloud: nacos: discovery: server-addr: 127.0.0.1:8848 gateway: globalcors: cors-configurations: '[/**]': allowedOrigins: &quot;*&quot; allowedMethods: &quot;*&quot; allowCredentials: true allowedHeaders: &quot;*&quot; discovery: locator: enabled: true å¯ä»¥çœ‹åˆ°ï¼Œåœ¨application.ymlæ–‡ä»¶ä¸­ï¼Œå»æ‰äº†spring.cloud.gateway.routes èŠ‚ç‚¹åŠå…¶ä¸‹é¢çš„æ‰€æœ‰é…ç½®ã€‚ ï¼ˆ2ï¼‰åˆ†åˆ«å¯åŠ¨ç”¨æˆ·å¾®æœåŠ¡ã€å•†å“å¾®æœåŠ¡ã€è®¢å•å¾®æœåŠ¡å’ŒæœåŠ¡ç½‘å…³ã€‚ ï¼ˆ3ï¼‰é€šè¿‡æœåŠ¡ç½‘å…³è®¿é—®ç”¨æˆ·å¾®æœåŠ¡ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://localhost:10001/server-user/user/get/1001ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ç”¨æˆ·å¾®æœåŠ¡è¿”å›çš„åŸå§‹æ•°æ®å¦‚ä¸‹æ‰€ç¤ºã€‚ { &quot;id&quot;: 1001, &quot;username&quot;: &quot;binghe&quot;, &quot;password&quot;: &quot;c26be8aaf53b15054896983b43eb6a65&quot;, &quot;phone&quot;: &quot;13212345678&quot;, &quot;address&quot;: &quot;åŒ—äº¬&quot; } å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡æœåŠ¡ç½‘å…³èƒ½å¤Ÿæ­£ç¡®è®¿é—®åˆ°ç”¨æˆ·å¾®æœåŠ¡ã€‚ ï¼ˆ4ï¼‰é€šè¿‡æœåŠ¡ç½‘å…³è®¿é—®å•†å“å¾®æœåŠ¡ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://localhost:10001/server-product/product/get/1001ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ å•†å“å¾®æœåŠ¡è¿”å›çš„åŸå§‹æ•°æ®å¦‚ä¸‹æ‰€ç¤ºã€‚ { &quot;id&quot;: 1001, &quot;proName&quot;: &quot;åä¸º&quot;, &quot;proPrice&quot;: 2399, &quot;proStock&quot;: 100 } å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡æœåŠ¡ç½‘å…³èƒ½å¤Ÿæ­£ç¡®è®¿é—®åˆ°å•†å“å¾®æœåŠ¡ã€‚ ï¼ˆ5ï¼‰é€šè¿‡æœåŠ¡ç½‘å…³è®¿é—®è®¢å•å¾®æœåŠ¡ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://localhost:10001/server-order/order/test_sentinelï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡æœåŠ¡ç½‘å…³èƒ½å¤Ÿæ­£ç¡®è®¿é—®åˆ°è®¢å•å¾®æœåŠ¡ã€‚ æ³¨æ„ï¼šSpringCloud Gatewayæ•´åˆNacosæœ€ç®€é…ç½®æ—¶ï¼Œé€šè¿‡ç½‘å…³è®¿é—®å¾®æœåŠ¡çš„æ ¼å¼å¦‚ä¸‹æ‰€ç¤ºã€‚ http(s)://ç½‘å…³IP:ç½‘å…³ç«¯å£/è®¿é—®çš„ç›®æ ‡å¾®æœåŠ¡åç§°/æ¥å£åœ°å€ ç½‘å…³æ•´åˆSentinelé™æµ Sentinelä»1.6.0ç‰ˆæœ¬å¼€å§‹ï¼Œæä¾›äº†SpringCloud Gatewayçš„é€‚é…æ¨¡å—ï¼Œå¹¶ä¸”å¯ä»¥æä¾›ä¸¤ç§èµ„æºç»´åº¦çš„é™æµï¼Œä¸€ç§æ˜¯routeç»´åº¦ï¼›å¦ä¸€ç§æ˜¯è‡ªå®šä¹‰APIåˆ†ç»„ç»´åº¦ã€‚ routeç»´åº¦ï¼šå¯¹application.ymlæ–‡ä»¶ä¸­é…ç½®çš„spring.cloud.gateway.routes.idé™æµï¼Œå¹¶ä¸”èµ„æºåä¸ºspring.cloud.gateway.routes.idå¯¹åº”çš„å€¼ã€‚ è‡ªå®šä¹‰APIåˆ†ç»„ç»´åº¦ï¼šåˆ©ç”¨Sentinelæä¾›çš„APIæ¥å£æ¥è‡ªå®šä¹‰APIåˆ†ç»„ï¼Œå¹¶ä¸”å¯¹è¿™äº›APIåˆ†ç»„è¿›è¡Œé™æµã€‚ å®ç°routeç»´åº¦é™æµ ï¼ˆ1ï¼‰åœ¨æœåŠ¡ç½‘å…³shop-gatewayæ¨¡å—çš„pom.xmlæ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹ä¾èµ–ã€‚ &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-alibaba-sentinel-gateway&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt; &lt;artifactId&gt;sentinel-spring-cloud-gateway-adapter&lt;/artifactId&gt; &lt;/dependency&gt; &lt;/dependencies&gt; ï¼ˆ2ï¼‰åœ¨æœåŠ¡ç½‘å…³shop-gatewayæ¨¡å—ä¸­æ–°å»ºio.binghe.shop.configåŒ…ï¼Œå¹¶åœ¨åŒ…ä¸‹æ–°å»ºGatewayConfigç±»ã€‚åŸºäºSentinel çš„Gatewayé™æµæ˜¯é€šè¿‡å…¶æä¾›çš„Filteræ¥å®Œæˆçš„ï¼Œä½¿ç”¨æ—¶åªéœ€æ³¨å…¥å¯¹åº”çš„SentinelGatewayFilterå®ä¾‹ä»¥åŠ SentinelGatewayBlockExceptionHandler å®ä¾‹å³å¯ã€‚ GatewayConfigç±»çš„æºä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ /** * @version 1.0.0 * @description ç½‘å…³é…ç½®ç±» */ @Configuration public class GatewayConfig { private final List&lt;ViewResolver&gt; viewResolvers; private final ServerCodecConfigurer serverCodecConfigurer; @Value(&quot;${spring.cloud.gateway.discovery.locator.route-id-prefix}&quot;) private String routeIdPrefix; public GatewayConfig(ObjectProvider&lt;List&lt;ViewResolver&gt;&gt; viewResolversProvider, ServerCodecConfigurer serverCodecConfigurer) { this.viewResolvers = viewResolversProvider.getIfAvailable(Collections::emptyList); this.serverCodecConfigurer = serverCodecConfigurer; } /** * åˆå§‹åŒ–ä¸€ä¸ªé™æµçš„è¿‡æ»¤å™¨ */ @Bean @Order(Ordered.HIGHEST_PRECEDENCE) public GlobalFilter sentinelGatewayFilter() { return new SentinelGatewayFilter(); } @PostConstruct public void init() { this.initGatewayRules(); this.initBlockHandlers(); } /** * é…ç½®åˆå§‹åŒ–çš„é™æµå‚æ•° */ private void initGatewayRules() { Set&lt;GatewayFlowRule&gt; rules = new HashSet&lt;&gt;(); /** * Sentinelæ•´åˆSpringCloud Gatewayä½¿ç”¨çš„APIç±»å‹ä¸ºRoute IDç±»å‹ï¼Œä¹Ÿå°±æ˜¯åŸºäºrouteç»´åº¦æ—¶ï¼Œ * ç”±äºSentinelä¸ºSpringCloud Gatewayç½‘å…³ç”Ÿæˆçš„APIåç§°è§„åˆ™å¦‚ä¸‹ï¼š * ç”Ÿæˆçš„è§„åˆ™ä¸ºï¼š${spring.cloud.gateway.discovery.locator.route-id-prefix}åé¢ç›´æ¥åŠ ä¸Šç›®æ ‡å¾®æœåŠ¡çš„åç§°ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ * ${spring.cloud.gateway.discovery.locator.route-id-prefix}ç›®æ ‡å¾®æœåŠ¡çš„åç§° * å…¶ä¸­ï¼Œ${spring.cloud.gateway.discovery.locator.route-id-prefix}æ˜¯åœ¨ymlæ–‡ä»¶ä¸­é…ç½®çš„è®¿é—®å‰ç¼€ * * ä¸ºäº†è®©é€šè¿‡æœåŠ¡ç½‘å…³è®¿é—®ç›®æ ‡å¾®æœåŠ¡é“¾æ¥åï¼Œè¯·æ±‚é“¾è·¯ä¸­ç”Ÿæˆçš„APIåç§°ä¸æµæ§è§„åˆ™ä¸­ç”Ÿæˆçš„APIåç§°ä¸€è‡´ï¼Œä»¥è¾¾åˆ°å¯åŠ¨é¡¹ç›®å³å¯å®ç°è®¿é—®é“¾æ¥çš„é™æµæ•ˆæœï¼Œ * è€Œæ— éœ€ç™»å½•Setinelç®¡ç†ç•Œé¢æ‰‹åŠ¨é…ç½®é™æµè§„åˆ™ï¼Œå¯ä»¥å°† * resourceå‚æ•°è®¾ç½®ä¸º${spring.cloud.gateway.discovery.locator.route-id-prefix}ç›®æ ‡å¾®æœåŠ¡çš„åç§° * * å½“ç„¶ï¼Œå¦‚æœä¸æŒ‰ç…§ä¸Šè¿°é…ç½®ï¼Œä¹Ÿå¯ä»¥åœ¨é¡¹ç›®å¯åŠ¨åï¼Œé€šè¿‡æœåŠ¡ç½‘å…³è®¿é—®ç›®æ ‡å¾®æœåŠ¡é“¾æ¥åï¼Œåœ¨Sentinelç®¡ç†ç•Œé¢çš„è¯·æ±‚é“¾è·¯ä¸­æ‰¾åˆ°å¯¹åº”çš„APIåç§°æ‰€ä»£è¡¨çš„è¯·æ±‚é“¾è·¯ï¼Œ * ç„¶åæ‰‹åŠ¨é…ç½®é™æµè§„åˆ™ã€‚ **/ // //ç”¨æˆ·å¾®æœåŠ¡ç½‘å…³ // rules.add(this.getGatewayFlowRule(&quot;user-gateway&quot;)); // //å•†å“å¾®æœåŠ¡ç½‘å…³ // rules.add(this.getGatewayFlowRule(&quot;product-gateway&quot;)); // //è®¢å•å¾®æœåŠ¡ç½‘å…³ // rules.add(this.getGatewayFlowRule(&quot;order-gateway&quot;)); //ç”¨æˆ·å¾®æœåŠ¡ç½‘å…³ rules.add(this.getGatewayFlowRule(getResource(&quot;server-user&quot;))); //å•†å“å¾®æœåŠ¡ç½‘å…³ rules.add(this.getGatewayFlowRule(getResource(&quot;server-product&quot;))); //è®¢å•å¾®æœåŠ¡ç½‘å…³ rules.add(this.getGatewayFlowRule(getResource(&quot;server-order&quot;))); //åŠ è½½è§„åˆ™ GatewayRuleManager.loadRules(rules); } private String getResource(String targetServiceName){ if (routeIdPrefix == null){ routeIdPrefix = &quot;&quot;; } return routeIdPrefix.concat(targetServiceName); } private GatewayFlowRule getGatewayFlowRule(String resource){ //ä¼ å…¥èµ„æºåç§°ç”ŸæˆGatewayFlowRule GatewayFlowRule gatewayFlowRule = new GatewayFlowRule(resource); //é™æµé˜ˆå€¼ gatewayFlowRule.setCount(1); //ç»Ÿè®¡çš„æ—¶é—´çª—å£ï¼Œå•ä½ä¸º gatewayFlowRule.setIntervalSec(1); return gatewayFlowRule; } /** * é…ç½®é™æµçš„å¼‚å¸¸å¤„ç†å™¨ */ @Bean @Order(Ordered.HIGHEST_PRECEDENCE) public SentinelGatewayBlockExceptionHandler sentinelGatewayBlockExceptionHandler() { return new SentinelGatewayBlockExceptionHandler(viewResolvers, serverCodecConfigurer); } /** * è‡ªå®šä¹‰é™æµå¼‚å¸¸é¡µé¢ */ private void initBlockHandlers() { BlockRequestHandler blockRequestHandler = new BlockRequestHandler() { @Override public Mono&lt;ServerResponse&gt; handleRequest(ServerWebExchange serverWebExchange, Throwable throwable) { Map map = new HashMap&lt;&gt;(); map.put(&quot;code&quot;, 1001); map.put(&quot;codeMsg&quot;, &quot;æ¥å£è¢«é™æµäº†&quot;); return ServerResponse.status(HttpStatus.OK). contentType(MediaType.APPLICATION_JSON_UTF8). body(BodyInserters.fromObject(map)); } }; GatewayCallbackManager.setBlockHandler(blockRequestHandler); } } GatewayConfigç±»çš„æºä»£ç çœ‹ä¸Šå»æ¯”è¾ƒå¤šï¼Œä½†æ˜¯éƒ½æ˜¯ä¸€äº›éå¸¸ç®€å•çš„æ–¹æ³•ï¼Œå†°æ²³åœ¨è¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ã€‚ è¿™é‡Œæœ‰ä¸ªéœ€è¦ç‰¹åˆ«æ³¨æ„çš„åœ°æ–¹ï¼š Sentinel1.8.4æ•´åˆSpringCloud Gatewayä½¿ç”¨çš„APIç±»å‹ä¸ºRoute IDç±»å‹æ—¶ï¼Œä¹Ÿå°±æ˜¯åŸºäºrouteç»´åº¦æ—¶ï¼Œç”±äºSentinelä¸ºSpringCloud Gatewayç½‘å…³ç”Ÿæˆçš„APIåç§°è§„åˆ™å¦‚ä¸‹ï¼š ç”Ÿæˆçš„è§„åˆ™ä¸ºï¼š****${spring.cloud.gateway.discovery.locator.route-id-prefix}åé¢ç›´æ¥åŠ ä¸Šç›®æ ‡å¾®æœåŠ¡çš„åç§°ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ {spring.cloud.gateway.discovery.locator.route-id-prefix}ç›®æ ‡å¾®æœåŠ¡çš„åç§°ã€‚å…¶ä¸­ï¼Œ${spring.cloud.gateway.discovery.locator.route-id-prefix}æ˜¯åœ¨ymlæ–‡ä»¶ä¸­é…ç½®çš„è®¿é—®å‰ç¼€ã€‚ ä¸ºäº†è®©é€šè¿‡æœåŠ¡ç½‘å…³è®¿é—®ç›®æ ‡å¾®æœåŠ¡é“¾æ¥åï¼Œè¯·æ±‚é“¾è·¯ä¸­ç”Ÿæˆçš„APIåç§°ä¸æµæ§è§„åˆ™ä¸­ç”Ÿæˆçš„APIåç§°ä¸€è‡´ï¼Œä»¥è¾¾åˆ°å¯åŠ¨é¡¹ç›®å³å¯å®ç°è®¿é—®é“¾æ¥çš„é™æµæ•ˆæœï¼Œè€Œæ— éœ€ç™»å½•Setinelç®¡ç†ç•Œé¢æ‰‹åŠ¨é…ç½®é™æµè§„åˆ™ï¼Œå¯ä»¥å°†ç”ŸæˆGatewayFlowRuleå¯¹è±¡çš„resourceå‚æ•°è®¾ç½®ä¸º${spring.cloud.gateway.discovery.locator.route-id-prefix}ç›®æ ‡å¾®æœåŠ¡çš„åç§° å½“ç„¶ï¼Œå¦‚æœä¸æŒ‰ç…§ä¸Šè¿°é…ç½®ï¼Œä¹Ÿå¯ä»¥åœ¨é¡¹ç›®å¯åŠ¨åï¼Œé€šè¿‡æœåŠ¡ç½‘å…³è®¿é—®ç›®æ ‡å¾®æœåŠ¡é“¾æ¥åï¼Œåœ¨Sentinelç®¡ç†ç•Œé¢çš„è¯·æ±‚é“¾è·¯ä¸­æ‰¾åˆ°å¯¹åº”çš„APIåç§°æ‰€ä»£è¡¨çš„è¯·æ±‚é“¾è·¯ï¼Œç„¶åæ‰‹åŠ¨é…ç½®é™æµè§„åˆ™ã€‚ ï¼ˆ3ï¼‰å°†æœåŠ¡ç½‘å…³shop-gatewayæ¨¡å—çš„application.ymlæ–‡ä»¶å¤‡ä»½ä¸€ä»½åç§°ä¸ºapplication-nacos-simple.ymlçš„æ–‡ä»¶ï¼Œå¹¶å°†application.ymlæ–‡ä»¶çš„å†…å®¹ä¿®æ”¹æˆå¦‚ä¸‹æ‰€ç¤ºã€‚ server: port: 10001 spring: application: name: server-gateway main: allow-bean-definition-overriding: true cloud: nacos: discovery: server-addr: 127.0.0.1:8848 sentinel: transport: port: 7777 dashboard: 127.0.0.1:8888 web-context-unify: false eager: true gateway: globalcors: cors-configurations: '[/**]': allowedOrigins: &quot;*&quot; allowedMethods: &quot;*&quot; allowCredentials: true allowedHeaders: &quot;*&quot; discovery: locator: enabled: true route-id-prefix: gateway- å…¶ä¸­ï¼š spring.cloud.sentinel.eagerè¡¨ç¤ºç¨‹åºå¯åŠ¨æ—¶ï¼Œæµæ§è§„åˆ™æ˜¯å¦ç«‹å³æ³¨å†Œåˆ°Sentinelï¼Œé…ç½®ä¸ºtrueè¡¨ç¤ºç«‹å³æ³¨å†Œåˆ°Sentinelã€‚ spring.cloud.gateway.discovery.locator.route-id-prefixï¼šç”Ÿæˆæµæ§è§„åˆ™APIåç§°çš„å‰ç¼€ã€‚ ï¼ˆ4ï¼‰åœ¨IDEAä¸­é…ç½®å¯åŠ¨æœåŠ¡ç½‘å…³shop-gatewayæ¨¡å—çš„å‚æ•°-Dcsp.sentinel.app.type=1ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ å¦‚æœæ˜¯åœ¨å‘½ä»¤è¡Œå¯åŠ¨ç½‘å…³æœåŠ¡çš„JaråŒ…ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ã€‚ java -Dcsp.sentinel.app.type=1 shop-gateway.jar æˆ–è€…åœ¨å¯åŠ¨ç±»io.binghe.shop.GatewayStarterçš„main()æ–¹æ³•ä¸­æ·»åŠ ä¸€è¡ŒSystem.setProperty(&quot;csp.sentinel.app.type&quot;, &quot;1&quot;);ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ /** * @version 1.0.0 * @description æœåŠ¡ç½‘å…³å¯åŠ¨ç±» */ @SpringBootApplication @EnableDiscoveryClient public class GatewayStarter { public static void main(String[] args){ System.setProperty(&quot;csp.sentinel.app.type&quot;, &quot;1&quot;); SpringApplication.run(GatewayStarter.class, args); } } ï¼ˆ5ï¼‰åˆ†åˆ«å¯åŠ¨ç”¨æˆ·å¾®æœåŠ¡ã€å•†å“å¾®æœåŠ¡ã€è®¢å•å¾®æœåŠ¡å’ŒæœåŠ¡ç½‘å…³ï¼Œå¯åŠ¨åä¼šåœ¨Sentinelç®¡ç†ç•Œé¢å·¦ä¾§èœå•æ ä¸­çœ‹åˆ°server-gatewayèœå•ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ åœ¨server-gatewayèœå•ä¸‹çš„æµæ§è§„åˆ™å­èœå•ä¸­å¯ä»¥çœ‹åˆ°ç½‘å…³çš„æµæ§è§„åˆ™å·²ç»æ³¨å†Œåˆ°Sentinelï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ï¼ˆ6ï¼‰é€šè¿‡æœåŠ¡ç½‘å…³è®¿é—®ç”¨æˆ·å¾®æœåŠ¡ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://localhost:10001/server-user/user/get/1001ï¼Œä¸æ–­åˆ·æ–°é¡µé¢ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ç”¨æˆ·å¾®æœåŠ¡è¿”å›çš„åŸå§‹æ•°æ®å¦‚ä¸‹æ‰€ç¤ºã€‚ { &quot;code&quot;: 1001, &quot;codeMsg&quot;: &quot;æ¥å£è¢«é™æµäº†&quot; } å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡æœåŠ¡ç½‘å…³ä¸æ–­åˆ·æ–°ç”¨æˆ·å¾®æœåŠ¡æ—¶ï¼Œè§¦å‘äº†æœåŠ¡é™æµï¼Œå¹¶è¿”å›äº†è‡ªå®šä¹‰çš„é™æµç»“æœæ•°æ®ã€‚ ï¼ˆ7ï¼‰é€šè¿‡æœåŠ¡ç½‘å…³è®¿é—®å•†å“å¾®æœåŠ¡ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://localhost:10001/server-product/product/get/1001ï¼Œä¸æ–­åˆ·æ–°é¡µé¢ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ å•†å“å¾®æœåŠ¡è¿”å›çš„åŸå§‹æ•°æ®å¦‚ä¸‹æ‰€ç¤ºã€‚ { &quot;code&quot;: 1001, &quot;codeMsg&quot;: &quot;æ¥å£è¢«é™æµäº†&quot; } å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡æœåŠ¡ç½‘å…³ä¸æ–­åˆ·æ–°å•†å“å¾®æœåŠ¡æ—¶ï¼Œè§¦å‘äº†æœåŠ¡é™æµï¼Œå¹¶è¿”å›äº†è‡ªå®šä¹‰çš„é™æµç»“æœæ•°æ®ã€‚ ï¼ˆ8ï¼‰é€šè¿‡æœåŠ¡ç½‘å…³è®¿é—®è®¢å•å¾®æœåŠ¡ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥http://localhost:10001/server-order/order/test_sentinelï¼Œä¸æ–­åˆ·æ–°é¡µé¢ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡æœåŠ¡ç½‘å…³ä¸æ–­åˆ·æ–°è®¢å•å¾®æœåŠ¡æ—¶ï¼Œè§¦å‘äº†æœåŠ¡é™æµï¼Œå¹¶è¿”å›äº†è‡ªå®šä¹‰çš„é™æµç»“æœæ•°æ®ã€‚ å®ç°è‡ªå®šä¹‰APIåˆ†ç»„ç»´åº¦é™æµ å‰é¢ï¼Œæˆ‘ä»¬å®ç°äº†routeç»´åº¦çš„é™æµï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†åŸºäºSentinelä¸SpringCloud gatewayå®ç°è‡ªå®šä¹‰APIåˆ†ç»„ç»´åº¦çš„é™æµã€‚ ï¼ˆ1ï¼‰åœ¨æœåŠ¡ç½‘å…³shop-gatewayæ¨¡å—çš„io.binghe.shop.config.GatewayConfigé…ç½®ç±»ä¸­æ–°å¢initCustomizedApis()æ–¹æ³•ï¼Œåˆå§‹åŒ–APIç®¡ç†çš„ä¿¡æ¯ï¼Œæºç å¦‚ä¸‹æ‰€ç¤ºã€‚ private void initCustomizedApis() { Set&lt;ApiDefinition&gt; definitions = new HashSet&lt;&gt;(); ApiDefinition api1 = new ApiDefinition(&quot;user_api1&quot;) .setPredicateItems(new HashSet&lt;ApiPredicateItem&gt;() {{ // ä»¥/server-user/user/api1 å¼€å¤´çš„è¯·æ±‚ add(new ApiPathPredicateItem().setPattern(&quot;/server-user/user/api1/**&quot;). setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_PREFIX)); }}); ApiDefinition api2 = new ApiDefinition(&quot;user_api2&quot;) .setPredicateItems(new HashSet&lt;ApiPredicateItem&gt;() {{ // ä»¥/server-user/user/api2/demo1 å®Œæˆçš„urlè·¯å¾„åŒ¹é… add(new ApiPathPredicateItem().setPattern(&quot;/server-user/user/api2/demo1&quot;)); }}); definitions.add(api1); definitions.add(api2); GatewayApiDefinitionManager.loadApiDefinitions(definitions); } ä¸Šè¿°ä»£ç ä¸­ï¼Œé…ç½®äº†ä¸¤ä¸ªAPIåˆ†ç»„ï¼Œæ¯ä¸ªAPIåˆ†ç»„çš„è§„åˆ™å¦‚ä¸‹ã€‚ user_api1åˆ†ç»„ï¼šåŒ¹é…ä»¥/product-serv/product/api1å¼€å¤´çš„æ‰€æœ‰è¯·æ±‚ã€‚ user_api2åˆ†ç»„ï¼šç²¾ç¡®åŒ¹é…/server-user/user/api2/demo1ã€‚ ï¼ˆ2ï¼‰åœ¨æœåŠ¡ç½‘å…³shop-gatewayæ¨¡å—çš„io.binghe.shop.config.GatewayConfigé…ç½®ç±»ä¸­init()æ–¹æ³•ä¸­è°ƒç”¨initCustomizedApis()æ–¹æ³•ï¼Œä¸ºäº†é¿å…routeç»´åº¦çš„é™æµå¯¹è‡ªå®šä¹‰APIåˆ†ç»„ç»´åº¦çš„é™æµäº§ç”Ÿå½±å“ï¼Œè¿™é‡Œï¼ŒåŒæ—¶åœ¨init()æ–¹æ³•ä¸­æ³¨é‡Šæ‰è°ƒç”¨initGatewayRules()æ–¹æ³•ï¼Œä¿®æ”¹åçš„init()æ–¹æ³•çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ @PostConstruct public void init() { //this.initGatewayRules(); this.initBlockHandlers(); this.initCustomizedApis(); } ï¼ˆ3ï¼‰åœ¨ç”¨æˆ·å¾®æœåŠ¡shop-userçš„io.binghe.shop.user.controller.UserControllerç±»ä¸­æ–°å¢å››ä¸ªæµ‹è¯•æ¥å£ï¼Œæºç å¦‚ä¸‹æ‰€ç¤ºã€‚ @GetMapping(value = &quot;/api1/demo1&quot;) public String api1Demo1(){ log.info(&quot;è®¿é—®äº†api1Demo1æ¥å£&quot;); return &quot;api1Demo1&quot;; } @GetMapping(value = &quot;/api1/demo2&quot;) public String api1Demo2(){ log.info(&quot;è®¿é—®äº†api1Demo2æ¥å£&quot;); return &quot;api1Demo2&quot;; } @GetMapping(value = &quot;/api2/demo1&quot;) public String api2Demo1(){ log.info(&quot;è®¿é—®äº†api2Demo1æ¥å£&quot;); return &quot;api2Demo1&quot;; } @GetMapping(value = &quot;/api2/demo2&quot;) public String api2Demo2(){ log.info(&quot;è®¿é—®äº†api2Demo2æ¥å£&quot;); return &quot;api2Demo2&quot;; } ï¼ˆ4ï¼‰åˆ†åˆ«å¯åŠ¨ç”¨æˆ·å¾®æœåŠ¡ã€å•†å“å¾®æœåŠ¡ã€è®¢å•å¾®æœåŠ¡å’ŒæœåŠ¡ç½‘å…³ï¼Œå¯åŠ¨åä¼šåœ¨Sentinelç®¡ç†ç•Œé¢å·¦ä¾§èœå•æ ä¸­çœ‹åˆ°server-gatewayèœå•ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ æ­¤æ—¶ï¼Œç”±äºæˆ‘ä»¬æ³¨é‡Šäº†è°ƒç”¨ä»¥routeç»´åº¦é™æµçš„æ–¹æ³•ï¼Œæ‰€ä»¥ï¼Œåœ¨æµæ§è§„åˆ™é‡Œçš„é™æµè§„åˆ™ä¸ºç©ºï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ åœ¨APIç®¡ç†é‡Œé¢ä¼šå‘ç°æˆ‘ä»¬å®šä¹‰çš„APIåˆ†ç»„å·²ç»è‡ªåŠ¨æ³¨å†Œåˆ°Sentinelä¸­äº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ï¼ˆ5ï¼‰åœ¨Sentinelç®¡ç†ç•Œé¢çš„æµæ§è§„åˆ™ä¸­ï¼Œæ–°å¢ç½‘å…³æµæ§è§„åˆ™ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ç‚¹å‡»æ–°å¢ç½‘å…³æµæ§è§„åˆ™åï¼Œä¼šå¼¹å‡ºæ–°å¢ç½‘å…³æµæ§è§„åˆ™é…ç½®æ¡†ï¼ŒæŒ‰ç…§å¦‚ä¸‹æ–¹å¼ä¸ºuser_api1åˆ†ç»„é…ç½®é™æµè§„åˆ™ã€‚ ç‚¹å‡»æ–°å¢æŒ‰é’®åï¼ŒæŒ‰ç…§åŒæ ·çš„æ–¹å¼ä¸ºuser_api2åˆ†ç»„é…ç½®é™æµè§„åˆ™ã€‚ é…ç½®å®Œæ¯•åï¼Œåœ¨æµæ§è§„åˆ™ä¸­çš„é™æµè§„åˆ™å¦‚ä¸‹æ‰€ç¤ºã€‚ ï¼ˆ6ï¼‰é¢„æœŸçš„æµ‹è¯•ç»“æœå¦‚ä¸‹ã€‚ å½“é¢‘ç¹è®¿é—®http://localhost:10001/server-user/user/api1/demo1æ—¶ä¼šè¢«é™æµã€‚ å½“é¢‘ç¹è®¿é—®http://localhost:10001/server-user/user/api1/demo2æ—¶ä¼šè¢«é™æµã€‚ å½“é¢‘ç¹è®¿é—®http://localhost:10001/server-user/user/api2/demo1æ—¶ä¼šè¢«é™æµã€‚ å½“é¢‘ç¹è®¿é—®http://localhost:10001/server-user/user/api2/demo2æ—¶ä¸ä¼šè¢«é™æµã€‚ æ³¨æ„ï¼šåªæœ‰æœ€åä¸€ä¸ªä¸ä¼šè¢«é™æµã€‚ ï¼ˆ7ï¼‰åœ¨æµè§ˆå™¨ä¸Šé¢‘ç¹è®¿é—®http://localhost:10001/server-user/user/api1/demo1ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ è¿”å›çš„åŸå§‹æ•°æ®å¦‚ä¸‹æ‰€ç¤ºã€‚ { &quot;code&quot;: 1001, &quot;codeMsg&quot;: &quot;æ¥å£è¢«é™æµäº†&quot; } è¯´æ˜è§¦å‘äº†æœåŠ¡é™æµï¼Œå¹¶è¿”å›äº†è‡ªå®šä¹‰çš„é™æµç»“æœæ•°æ®ã€‚ ï¼ˆ8ï¼‰åœ¨æµè§ˆå™¨ä¸Šé¢‘ç¹è®¿é—®http://localhost:10001/server-user/user/api1/demo2ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ è¿”å›çš„åŸå§‹æ•°æ®å¦‚ä¸‹æ‰€ç¤ºã€‚ { &quot;code&quot;: 1001, &quot;codeMsg&quot;: &quot;æ¥å£è¢«é™æµäº†&quot; } è¯´æ˜è§¦å‘äº†æœåŠ¡é™æµï¼Œå¹¶è¿”å›äº†è‡ªå®šä¹‰çš„é™æµç»“æœæ•°æ®ã€‚ ï¼ˆ9ï¼‰åœ¨æµè§ˆå™¨ä¸Šé¢‘ç¹è®¿é—®http://localhost:10001/server-user/user/api2/demo1ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ è¿”å›çš„åŸå§‹æ•°æ®å¦‚ä¸‹æ‰€ç¤ºã€‚ { &quot;code&quot;: 1001, &quot;codeMsg&quot;: &quot;æ¥å£è¢«é™æµäº†&quot; } è¯´æ˜è§¦å‘äº†æœåŠ¡é™æµï¼Œå¹¶è¿”å›äº†è‡ªå®šä¹‰çš„é™æµç»“æœæ•°æ®ã€‚ ï¼ˆ10ï¼‰åœ¨æµè§ˆå™¨ä¸Šé¢‘ç¹è®¿é—®http://localhost:10001/server-user/user/api2/demo2ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ å¯ä»¥çœ‹åˆ°ï¼Œè®¿é—®http://localhost:10001/server-user/user/api2/demo2æ—¶ï¼Œæ— è®ºè®¿é—®çš„é¢‘ç‡å¤šé¢‘ç¹ï¼Œéƒ½ä¸ä¼šè§¦å‘Sentinelé™æµã€‚ è‡³æ­¤ï¼Œæˆ‘ä»¬å°±æˆåŠŸåœ¨é¡¹ç›®ä¸­æ•´åˆäº†SpringCloud Gatewayç½‘å…³ï¼Œå¹¶é€šè¿‡Sentinelæ•´åˆSpringCloud Gatewayå®ç°äº†ç½‘å…³çš„é™æµæ“ä½œã€‚ ","link":"https://tianxiawuhao.github.io/PN2nvPeue/"},{"title":"gatewayç½‘å…³æ¦‚è¿°","content":"ç½‘å…³æ¦‚è¿° å½“é‡‡ç”¨åˆ†å¸ƒå¼ã€å¾®æœåŠ¡çš„æ¶æ„æ¨¡å¼å¼€å‘ç³»ç»Ÿä¸­ï¼ŒæœåŠ¡ç½‘å…³æ˜¯æ•´ä¸ªç³»ç»Ÿä¸­å¿…ä¸å¯å°‘çš„ä¸€éƒ¨åˆ†ã€‚ æ²¡æœ‰ç½‘å…³çš„å¼Šç«¯ å½“ä¸€ä¸ªç³»ç»Ÿä½¿ç”¨åˆ†å¸ƒå¼ã€å¾®æœåŠ¡æ¶æ„åï¼Œç³»ç»Ÿä¼šè¢«æ‹†åˆ†ä¸ºä¸€ä¸ªä¸ªå°çš„å¾®æœåŠ¡ï¼Œæ¯ä¸ªå¾®æœåŠ¡ä¸“æ³¨ä¸€ä¸ªå°çš„ä¸šåŠ¡ã€‚é‚£ä¹ˆï¼Œå®¢æˆ·ç«¯å¦‚ä½•è°ƒç”¨è¿™ä¹ˆå¤šå¾®æœåŠ¡çš„æ¥å£å‘¢ï¼Ÿå¦‚æœä¸åšä»»ä½•å¤„ç†ï¼Œæ²¡æœ‰æœåŠ¡ç½‘å…³ï¼Œå°±åªèƒ½åœ¨å®¢æˆ·ç«¯è®°å½•ä¸‹æ¯ä¸ªå¾®æœåŠ¡çš„æ¯ä¸ªæ¥å£åœ°å€ï¼Œç„¶åæ ¹æ®å®é™…éœ€è¦å»è°ƒç”¨ç›¸åº”çš„æ¥å£ã€‚ è¿™ç§ç›´æ¥ä½¿ç”¨å®¢æˆ·ç«¯è®°å½•å¹¶ç®¡ç†æ¯ä¸ªå¾®æœåŠ¡çš„æ¯ä¸ªæ¥å£çš„æ–¹å¼ï¼Œå­˜åœ¨ç€å¤ªå¤šçš„é—®é¢˜ã€‚æ¯”å¦‚ï¼Œè¿™é‡Œæˆ‘åˆ—ä¸¾å‡ ä¸ªå¸¸è§çš„é—®é¢˜ã€‚ ç”±å®¢æˆ·ç«¯è®°å½•å¹¶ç®¡ç†æ‰€æœ‰çš„æ¥å£ç¼ºä¹å®‰å…¨æ€§ã€‚ ç”±å®¢æˆ·ç«¯ç›´æ¥è¯·æ±‚ä¸åŒçš„å¾®æœåŠ¡ï¼Œä¼šå¢åŠ å®¢æˆ·ç«¯ç¨‹åºç¼–å†™çš„å¤æ‚æ€§ã€‚ æ¶‰åŠåˆ°æœåŠ¡è®¤è¯ä¸é‰´æƒè§„åˆ™æ—¶ï¼Œéœ€è¦åœ¨æ¯ä¸ªå¾®æœåŠ¡ä¸­å®ç°è¿™äº›é€»è¾‘ï¼Œå¢åŠ äº†ä»£ç çš„å†—ä½™æ€§ã€‚ å®¢æˆ·ç«¯è°ƒç”¨å¤šä¸ªå¾®æœåŠ¡ï¼Œç”±äºæ¯ä¸ªå¾®æœåŠ¡å¯èƒ½éƒ¨ç½²çš„æœåŠ¡å™¨å’ŒåŸŸåä¸åŒï¼Œå­˜åœ¨è·¨åŸŸçš„é£é™©ã€‚ å½“å®¢æˆ·ç«¯æ¯”è¾ƒå¤šæ—¶ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯ä¸Šéƒ½ç®¡ç†å’Œé…ç½®æ‰€æœ‰çš„æ¥å£ï¼Œç»´æŠ¤èµ·æ¥ç›¸å¯¹æ¯”è¾ƒå¤æ‚ã€‚ å¼•å…¥APIç½‘å…³ APIç½‘å…³ï¼Œå…¶å®å°±æ˜¯æ•´ä¸ªç³»ç»Ÿçš„ç»Ÿä¸€å…¥å£ã€‚ç½‘å…³ä¼šå°è£…å¾®æœåŠ¡çš„å†…éƒ¨ç»“æ„ï¼Œä¸ºå®¢æˆ·ç«¯æä¾›ç»Ÿä¸€çš„å…¥å£æœåŠ¡ï¼ŒåŒæ—¶ï¼Œä¸€äº›ä¸å…·ä½“ä¸šåŠ¡é€»è¾‘æ— å…³çš„é€šç”¨é€»è¾‘å¯ä»¥åœ¨ç½‘å…³ä¸­å®ç°ï¼Œæ¯”å¦‚è®¤è¯ã€æˆæƒã€è·¯ç”±è½¬å‘ã€é™æµã€ç›‘æ§ç­‰ã€‚å¼•å…¥APIç½‘å…³åï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ å¯ä»¥çœ‹åˆ°ï¼Œå¼•å…¥APIç½‘å…³åï¼Œå®¢æˆ·ç«¯åªéœ€è¦è¿æ¥APIç½‘å…³ï¼Œç”±APIç½‘å…³æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œè·¯ç”±è½¬å‘ï¼Œå°†è¯·æ±‚è½¬å‘åˆ°å…·ä½“çš„å¾®æœåŠ¡ï¼ŒåŒæ—¶ï¼ŒAPIç½‘å…³ä¼šæä¾›è®¤è¯ã€æˆæƒã€é™æµå’Œç›‘æ§ç­‰åŠŸèƒ½ã€‚ ä¸»æµçš„APIç½‘å…³ å½“ç³»ç»Ÿé‡‡ç”¨åˆ†å¸ƒå¼ã€å¾®æœåŠ¡çš„æ¶æ„æ¨¡å¼åï¼ŒAPIç½‘å…³å°±æˆäº†æ•´ä¸ªç³»ç»Ÿä¸å¯åˆ†å‰²çš„ä¸€éƒ¨åˆ†ã€‚ä¸šç•Œé€šè¿‡ä¸æ–­çš„æ¢ç´¢ä¸åˆ›æ–°ï¼Œå®ç°äº†å¤šç§APIç½‘å…³çš„è§£å†³æ–¹æ¡ˆã€‚ç›®å‰ï¼Œæ¯”è¾ƒä¸»æµçš„APIç½‘å…³æœ‰ï¼šNginx+Luaã€Kongå®˜ç½‘ã€Zuulç½‘å…³ã€Apache Shenyuç½‘å…³ã€SpringCloud Gatewayç½‘å…³ã€‚ Nginx+Lua Nginxçš„ä¸€äº›æ’ä»¶æœ¬èº«å°±å®ç°äº†é™æµã€ç¼“å­˜ã€é»‘ç™½åå•å’Œç°åº¦å‘å¸ƒï¼Œå†åŠ ä¸ŠNginxçš„åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡ï¼Œèƒ½å¤Ÿå®ç°å¯¹æœåŠ¡æ¥å£çš„è´Ÿè½½å‡è¡¡å’Œé«˜å¯ç”¨ã€‚è€ŒLuaè¯­è¨€å¯ä»¥å®ç°ä¸€äº›ç®€å•çš„ä¸šåŠ¡é€»è¾‘ï¼ŒNginxåˆæ”¯æŒLuaè¯­è¨€ã€‚æ‰€ä»¥ï¼Œå¯ä»¥åŸºäºNginx+Luaè„šæœ¬å®ç°ç½‘å…³ã€‚ Kongç½‘å…³ Kongç½‘å…³åŸºäºNginxä¸Luaè„šæœ¬å¼€å‘ï¼Œæ€§èƒ½é«˜ï¼Œæ¯”è¾ƒç¨³å®šï¼Œæä¾›å¤šä¸ªé™æµã€é‰´æƒç­‰æ’ä»¶ï¼Œè¿™äº›æ’ä»¶æ”¯æŒçƒ­æ’æ‹”ï¼Œå¼€ç®±å³ç”¨ã€‚Kongç½‘å…³æä¾›äº†ç®¡ç†é¡µé¢ï¼Œä½†æ˜¯ï¼Œç›®å‰åŸºäºKongç½‘å…³äºŒæ¬¡å¼€å‘æ¯”è¾ƒå›°éš¾ã€‚ Zuulç½‘å…³ Zuulç½‘å…³æ˜¯Netflixå¼€æºçš„ç½‘å…³ï¼ŒåŠŸèƒ½æ¯”è¾ƒä¸°å¯Œï¼Œä¸»è¦åŸºäºJavaè¯­è¨€å¼€å‘ï¼Œä¾¿äºåœ¨Zuulç½‘å…³çš„åŸºç¡€ä¸Šè¿›è¡ŒäºŒæ¬¡å¼€å‘ã€‚ä½†æ˜¯Zuulç½‘å…³æ— æ³•å®ç°åŠ¨æ€é…ç½®è§„åˆ™ï¼Œä¾èµ–çš„ç»„ä»¶ç›¸å¯¹æ¥è¯´ä¹Ÿæ¯”è¾ƒå¤šï¼Œåœ¨æ€§èƒ½ä¸Šä¸å¦‚Nginxã€‚ Apache Shenyuç½‘å…³ Dromaraç¤¾åŒºå¼€å‘çš„ç½‘å…³æ¡†æ¶ï¼ŒShenYu çš„å‰åæ˜¯ soulï¼Œæœ€è¿‘æ­£å¼åŠ å…¥äº† Apache çš„å­µåŒ–å™¨ï¼Œå› æ­¤æ”¹åä¸º ShenYuã€‚å…¶æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ï¼Œé«˜æ€§èƒ½çš„ï¼Œè·¨è¯­è¨€çš„ï¼Œå“åº”å¼çš„APIç½‘å…³ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šæä¾›äº†éå¸¸ä¸°å¯Œçš„æ‰©å±•åŠŸèƒ½ï¼š æ”¯æŒå„ç§è¯­è¨€(httpåè®®)ï¼Œæ”¯æŒDubbo, Spring-Cloud, Grpc, Motan, Sofa, Tarsç­‰åè®®ã€‚ æ’ä»¶åŒ–è®¾è®¡æ€æƒ³ï¼Œæ’ä»¶çƒ­æ’æ‹”ï¼Œæ˜“æ‰©å±•ã€‚ çµæ´»çš„æµé‡ç­›é€‰ï¼Œèƒ½æ»¡è¶³å„ç§æµé‡æ§åˆ¶ã€‚ å†…ç½®ä¸°å¯Œçš„æ’ä»¶æ”¯æŒï¼Œé‰´æƒï¼Œé™æµï¼Œç†”æ–­ï¼Œé˜²ç«å¢™ç­‰ç­‰ã€‚ æµé‡é…ç½®åŠ¨æ€åŒ–ï¼Œæ€§èƒ½æé«˜ã€‚ æ”¯æŒé›†ç¾¤éƒ¨ç½²ï¼Œæ”¯æŒ A/B Testï¼Œè“ç»¿å‘å¸ƒã€‚ SpringCloud Gatewayç½‘å…³ Springä¸ºäº†æ›¿æ¢Zuulè€Œå¼€å‘çš„ç½‘å…³ï¼ŒSpringCloud AlibabaæŠ€æœ¯æ ˆä¸­ï¼Œå¹¶æ²¡æœ‰å•ç‹¬å®ç°ç½‘å…³çš„ç»„ä»¶ã€‚åœ¨åç»­çš„æ¡ˆä¾‹å®ç°ä¸­ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨SpringCloud Gatewayå®ç°ç½‘å…³åŠŸèƒ½ã€‚ SpringCloud Gatewayç½‘å…³ Spring Cloud Gatewayæ˜¯Springå…¬å¸åŸºäºSpring 5.0ï¼Œ Spring Boot 2.0 å’Œ Project Reactor ç­‰æŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼Œå®ƒæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•æœ‰æ•ˆçš„ç»Ÿä¸€çš„ API è·¯ç”±ç®¡ç†æ–¹å¼ã€‚ å®ƒçš„ç›®æ ‡æ˜¯æ›¿ä»£Netflix Zuulï¼Œå…¶ä¸ä»…æä¾›ç»Ÿä¸€çš„è·¯ç”±æ–¹å¼ï¼Œå¹¶ä¸”åŸºäº Filter é“¾çš„æ–¹å¼æä¾›äº†ç½‘å…³åŸºæœ¬çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼šå®‰å…¨ï¼Œç›‘æ§å’Œé™æµã€é‡è¯•ç­‰ã€‚ SpringCloud Gatewayæ¦‚è¿° Spring Cloud Gatewayæ˜¯Spring Cloudçš„ä¸€ä¸ªå…¨æ–°é¡¹ç›®ï¼ŒåŸºäºSpring 5.0 + Spring Boot 2.0å’ŒProject Reactorç­‰æŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼Œå®ƒæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•æœ‰æ•ˆçš„ç»Ÿä¸€çš„APIè·¯ç”±ç®¡ç†æ–¹å¼ã€‚ Spring Cloud Getewayä½œä¸ºSpring Cloudç”Ÿæ€ç³»ç»Ÿä¸­çš„ç½‘å…³ï¼Œç›®æ ‡æ˜¯æ›¿ä»£Zuulï¼Œåœ¨Spring Cloud2.0ä»¥ä¸Šç‰ˆæœ¬ä¸­ï¼Œæ²¡æœ‰å¯¹æ–°ç‰ˆæœ¬çš„Zuul 2.0ä»¥ä¸Šæœ€æ–°é«˜æ€§èƒ½ç‰ˆæœ¬è¿›è¡Œé›†æˆï¼Œä»ç„¶è¿˜æ˜¯ä½¿ç”¨çš„Zuul 1.xéReactoræ¨¡å¼çš„è€ç‰ˆæœ¬ã€‚ ä¸ºäº†æå‡ç½‘å…³æ€§èƒ½ï¼ŒSpring Cloud Gatewayæ˜¯åŸºäºWebFluxæ¡†æ¶å®ç°çš„ï¼Œè€ŒWebFluxæ¡†æ¶åº•å±‚åˆ™ä½¿ç”¨äº†é«˜æ€§èƒ½çš„Reactoræ¨¡å¼é€šä¿¡æ¡†æ¶Nettyã€‚ Spring Cloud Gatewayçš„ç›®æ ‡æä¾›ç»Ÿä¸€çš„è·¯ç”±æ–¹å¼ä¸”åŸºäºFilteré“¾çš„æ–¹å¼æä¾›äº†ç½‘å…³åŸºæœ¬çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼šå®‰å…¨ï¼Œç›‘æ§/æŒ‡æ ‡ï¼Œå’Œé™æµã€‚ æ€»ç»“ä¸€å¥è¯ï¼šSpring Cloud Gatewayä½¿ç”¨çš„Webfluxä¸­çš„reactor-nettyå“åº”å¼ç¼–ç¨‹ç»„ä»¶ï¼Œåº•å±‚ä½¿ç”¨Nettyé€šè®¯æ¡†æ¶ã€‚ SpringCloud Gatewayæ ¸å¿ƒæ¶æ„ å®¢æˆ·ç«¯è¯·æ±‚åˆ° Gateway ç½‘å…³ï¼Œä¼šå…ˆç»è¿‡ Gateway Handler Mapping è¿›è¡Œè¯·æ±‚å’Œè·¯ç”±åŒ¹é…ã€‚åŒ¹é…æˆåŠŸåå†å‘é€åˆ° Gateway Web Handler å¤„ç†ï¼Œç„¶åä¼šç»è¿‡ç‰¹å®šçš„è¿‡æ»¤å™¨é“¾ï¼Œç»è¿‡æ‰€æœ‰å‰ç½®è¿‡æ»¤åï¼Œä¼šå‘é€ä»£ç†è¯·æ±‚ã€‚è¯·æ±‚ç»“æœè¿”å›åï¼Œæœ€åä¼šæ‰§è¡Œæ‰€æœ‰çš„åç½®è¿‡æ»¤å™¨ã€‚ ç”±ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼ŒSpringCloud Gatewayçš„ä¸»è¦æµç¨‹ä¸ºï¼šå®¢æˆ·ç«¯è¯·æ±‚ä¼šå…ˆæ‰“åˆ°Gatewayï¼Œå…·ä½“çš„è®²åº”è¯¥æ˜¯DispacherHandlerï¼ˆå› ä¸ºGatewayå¼•å…¥äº†WebFluxï¼Œä½œç”¨å¯ä»¥ç±»æ¯”MVCçš„DispacherServletï¼‰ã€‚ Gatewayæ ¹æ®ç”¨æˆ·çš„è¯·æ±‚æ‰¾åˆ°ç›¸åº”çš„HandlerMappingï¼Œè¯·æ±‚å’Œå…·ä½“çš„handlerä¹‹é—´æœ‰ä¸€ä¸ªæ˜ å°„å…³ç³»ï¼Œç½‘å…³ä¼šå¯¹è¯·æ±‚è¿›è¡Œè·¯ç”±ï¼Œhandlerä¼šåŒ¹é…åˆ°RoutePredicateHandlerMappingï¼ŒåŒ¹é…è¯·æ±‚å¯¹åº”çš„Routeï¼Œç„¶ååˆ°è¾¾Webå¤„ç†å™¨ã€‚ WebHandlerä»£ç†äº†ä¸€ç³»åˆ—ç½‘å…³è¿‡æ»¤å™¨å’Œå…¨å±€è¿‡æ»¤å™¨çš„å®ä¾‹ï¼Œè¿™äº›è¿‡æ»¤å™¨å¯ä»¥å¯¹è¯·æ±‚å’Œå“åº”è¿›è¡Œä¿®æ”¹ï¼Œæœ€åç”±ä»£ç†æœåŠ¡å®Œæˆç”¨æˆ·è¯·æ±‚ï¼Œå¹¶å°†ç»“æœè¿”å›ã€‚ ","link":"https://tianxiawuhao.github.io/8Wk_K0cjl/"},{"title":"Sentinelæºç æ‹“å±•ä¹‹â€”â€”é™æµçš„å„ç§å®ç°æ–¹å¼","content":"Sentinelæºç æ‹“å±•ä¹‹â€”â€”é™æµçš„å„ç§å®ç°æ–¹å¼ ä¸€ å¸¸è§çš„é™æµåŠŸèƒ½å®ç°æœ‰ä»¥ä¸‹ä¸‰ç§æ–¹å¼ æ»‘åŠ¨æ—¶é—´çª—å£ã€ä»¤ç‰Œæ¡¶ã€æ¼æ¡¶ï¼Œè¿™ä¸‰ç§å®ç°æ–¹å¼ï¼Œæœ‰å„è‡ªæ“…é•¿çš„åº”ç”¨åœºæ™¯ï¼Œè€Œåœ¨ Sentinel ä¸­è¿™ä¸‰ç§é™æµå®ç°éƒ½æœ‰è¢«ç”¨åˆ°ï¼Œåªä¸è¿‡ä½¿ç”¨åœ¨ä¸åŒçš„é™æµåœºæ™¯ä¸‹ï¼š **æ»‘åŠ¨æ—¶é—´çª—å£ï¼š**æ™®é€šQPSé™æµä¸‹çš„å¿«é€Ÿå¤±è´¥ã€Warmupé¢„çƒ­ï¼Œä½¿ç”¨åœºæ™¯æœ€å¤šï¼›â€”â€” Sentinelçš„å®ç°ï¼Œæ˜¯ä½¿ç”¨â€œç¯å½¢æ—¶é—´çª—å£â€æ¥è¡¨ç¤ºæ— è¾¹æ— é™…çš„æ—¶é—´ï¼› **ä»¤ç‰Œæ¡¶ï¼š**çƒ­ç‚¹å‚æ•°é™æµï¼Œéœ€è¦ä¸ºæ¯ä¸€ä¸ªè¯·æ±‚å‚æ•°ï¼Œåˆ›å»ºä¸€ä¸ªä»¤ç‰Œæ¡¶ï¼›â€”â€” Sentinelçš„å®ç°ï¼Œå®é™…ä¸æ˜¯çœŸçš„åˆ›å»ºå¾ˆå¤šä¸ªæ¡¶ï¼› **æ¼æ¡¶ï¼ˆæµé‡æ•´å½¢ï¼‰ï¼š**æ™®é€šQPSé™æµä¸‹çš„æ’é˜Ÿç­‰å¾…ï¼Œå°†è¯·æ±‚æš‚å­˜åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼ŒæŒ‰æ—¶é—´é—´éš”æ‹‰å–å¹¶å¤„ç†ï¼›â€”â€” Sentinelçš„å®ç°ï¼Œå®é™…ä¸æ˜¯çœŸçš„æ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼› 1 æ—¶é—´çª—å£ï¼ˆæ»‘åŠ¨æ—¶é—´çª—å£ï¼‰ å›ºå®šæ—¶é—´çª—å£ï¼Œç”±äºæ—¶é—´çª—å£ç²’åº¦å¤ªç²—ï¼Œè€Œæ—¶é—´æœ¬èº«å…¶å®æ˜¯æ²¡æœ‰è¾¹ç•Œçš„ï¼Œæ‰€ä»¥æ— æ³•ä¿è¯ä»»æ„å•ä½æ—¶é—´çª—å£ä¸­çš„QPSéƒ½ä¸è¶…é™ï¼ˆå¦‚ä¸‹å›¾ç²‰çº¢è‰²åŒºåŸŸï¼‰ï¼› ä¸ºäº†è§£å†³è¿™ç§é—®é¢˜ï¼Œå¯ä»¥å°†æˆ‘ä»¬è®¾ç½®çš„æ—¶é—´çª—å£åšNç­‰åˆ†ï¼Œåˆ’åˆ†ä¸ºæ›´å°ç²’åº¦çš„çª—å£ï¼Œè¿™å°±æ˜¯æ»‘åŠ¨æ—¶é—´çª—å£ï¼š å‡è®¾æ»‘åŠ¨æ—¶é—´è·¨åº¦Internelä¸º1ç§’ï¼Œæˆ‘ä»¬å¯ä»¥åšN=2ç­‰åˆ†ï¼Œé‚£ä¹ˆæœ€å°æ—¶é—´çª—å£å…¶å®å°±æ˜¯500msï¼› åœ¨é™æµç»Ÿè®¡QPSæ—¶ï¼Œçª—å£èŒƒå›´å°±æ˜¯ä»( currentTime â€“ interval) ä¹‹åçš„ç¬¬ä¸€ä¸ªæ—¶åŒºå¼€å§‹ï¼Œåˆ° currentTime æ‰€åœ¨æ—¶é—´çª—å£ã€‚ éšç€Nçš„å€¼è¶Šå¤§ï¼Œé™æµçš„ç²¾åº¦å°±ä¼šè¶Šé«˜ã€‚ 2 ä»¤ç‰Œæ¡¶ ä»¥å›ºå®šçš„é€Ÿç‡ç”Ÿæˆä»¤ç‰Œï¼Œå­˜åœ¨ä»¤ç‰Œæ¡¶ä¸­ï¼Œå¦‚æœä»¤ç‰Œæ¡¶æ»¡äº†ä»¥åï¼Œå¤šä½™çš„ä»¤ç‰Œå°†ä¼šè¢«ä¸¢å¼ƒï¼› è¯·æ±‚è¿›å…¥åï¼Œå¿…é¡»å…ˆå°è¯•ä»ä»¤ç‰Œæ¡¶ä¸­è·å–ä»¤ç‰Œï¼Œè·å–åˆ°ä»¤ç‰Œçš„è¯·æ±‚æ‰ä¼šè¢«å¤„ç†ï¼Œæ²¡æœ‰è·å–åˆ°ä»¤ç‰Œçš„è¯·æ±‚å°†ä¼šè¢«æ‹’ç»ï¼Œæˆ–è€…ç­‰å¾…ã€‚ 3 æ¼æ¡¶ å°†æ¯ä¸€ä¸ªâ€œè¯·æ±‚â€è§†ä½œâ€œæ°´æ»´â€ï¼Œæ”¾å…¥â€œæ¼æ¡¶â€ä¸­å­˜å‚¨ï¼› â€œæ¼æ¡¶â€ä»¥å›ºå®šé€Ÿç‡å‘å¤–â€œæ¼å‡ºâ€è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œå¦‚æœâ€œæ¼æ¡¶â€ç©ºäº†åˆ™ä»£è¡¨æ²¡æœ‰å¾…å¤„ç†çš„è¯·æ±‚ï¼› å¦‚æœâ€œæ¼æ¡¶â€æ»¡äº†ï¼Œåˆ™å¤šä½™çš„â€œè¯·æ±‚â€å°†è¢«å¿«é€Ÿæ‹’ç»ï¼› ä»¥ä¸Šéƒ½æ˜¯ä¸‰ç§å®ç°æ–¹æ¡ˆçš„ç†è®ºçŸ¥è¯†ï¼Œè€ŒSentinelåœ¨å®é™…å®ç°æ—¶ï¼Œæ˜¯åšäº†ä¸€å®šçš„ä¼˜åŒ–çš„ï¼ äºŒ Sentinelä¸­ä¸‰ç§é™æµæ–¹æ¡ˆçš„å®ç°æºç å‰–æä¹‹â€”â€”æ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³• æ»‘åŠ¨æ—¶é—´çª—å£ â€”â€” QPSå¿«é€Ÿå¤±è´¥ + WarmUpé¢„çƒ­ï¼š Sentinelä¸­çš„æ—¶é—´çª—å£ï¼Œå…¶å®ä½¿ç”¨çš„æ˜¯å¦‚ä¸‹å›¾æ‰€ç¤ºçš„ç¯å½¢æ—¶é—´çª—å£ï¼š å› ä¸ºæ—¶é—´æ˜¯æ²¡æœ‰è¾¹ç•Œçš„ï¼Œ è€Œä¸”æˆ‘ä»¬ä¸€èˆ¬ä¹Ÿåªä¼šå…³æ³¨ä¸€ä¸ªInternelä¹‹å†…çš„æ—¶é—´ï¼Œå¦‚æœä¸€ä¸ªInternelè¢«åˆ†æˆäº†Nä¸ªå°çª—å£ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿåªä¼šå…³æ³¨Nä¸ªå°çš„æ—¶é—´çª—å£ï¼› æ‰€ä»¥ä½¿ç”¨ç¯å½¢æ—¶é—´çª—å£ï¼Œæ—¢èƒ½æ»¡è¶³ä½¿ç”¨éœ€æ±‚ï¼Œåˆèƒ½è§£å†³å†…å­˜ç©ºé—´ã€‚ é€šè¿‡ä¸Šä¸€ç¯‡å…³äº ProcessorSlotChain æ’æ§½é“¾çš„ä»‹ç»ï¼Œæˆ‘ä»¬å·²ç»æ¸…æ¥šäº†ï¼š QPS çš„ç»Ÿè®¡å·¥ä½œå°†ä¼šç”± StatisticSlot æ’æ§½å®Œæˆï¼› é™æµåˆ¤æ–­çš„é€»è¾‘å°†ä¼šç”± FlowSlot æ’æ§½æ¥å®Œæˆï¼› è€Œæ‰€æœ‰çš„ PrcessorSlot çš„å¤„ç†é€»è¾‘ï¼Œéƒ½åœ¨ä»–ä»¬çš„ entry() æ–¹æ³•ä¸­ï¼› 1 æ—¶é—´çª—å£è¯·æ±‚é‡ç»Ÿè®¡ï¼šStatisticSlot public class StatisticSlot extends AbstractLinkedProcessorSlot&lt;DefaultNode&gt; { @Override public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count, boolean prioritized, Object... args) throws Throwable { try { // å…ˆå»æ‰§è¡Œåé¢æ’æ§½å’Œè¯·æ±‚ä½“çš„ä»»åŠ¡ fireEntry(context, resourceWrapper, node, count, prioritized, args); // å¤„ç†å®Œä¹‹åæ‰ä¼šå›æ¥åšç»Ÿè®¡ï¼ˆå¦‚æœåé¢å¤±è´¥äº†ï¼Œè‚¯å®šå°±ä¸ç”¨ç»Ÿè®¡äº†ï¼‰ node.increaseThreadNum(); // çº¿ç¨‹æ•°ç»Ÿè®¡ï¼ˆæœåŠ¡éš”ç¦»ï¼‰ node.addPassRequest(count); // QPSè¯·æ±‚é‡ç»Ÿè®¡ï¼ˆæœåŠ¡é™æµï¼‰ ...... } catch (Exception e){ ...... } } } // com.alibaba.csp.sentinel.node.DefaultNode#addPassRequest public void addPassRequest(int count) { super.addPassRequest(count); // ä¸ºDefaultNodeåšç»Ÿè®¡ this.clusterNode.addPassRequest(count); // ä¸ºClusterNodeåšç»Ÿè®¡ } æˆ‘ä»¬çŸ¥é“DefaultNode å’Œ ClusterNode éƒ½æ˜¯ StatisticNode çš„å­ç±»ï¼Œæ‰€ä»¥è¿™é‡Œéƒ½ä¼šè°ƒç”¨åˆ°StatisticNodeçš„addPassRequest()æ–¹æ³•ï¼š public class StatisticNode implements Node { // ç§’çº§ç»Ÿè®¡ï¼ˆçœ‹å˜é‡åå°±çŸ¥é“æ˜¯ä¸€ä¸ªç¯å½¢è®¡æ•°å™¨ï¼‰ private transient volatile Metric rollingCounterInSecond = new ArrayMetric(SampleCountProperty.SAMPLE_COUNT, IntervalProperty.INTERVAL); // åˆ†é’Ÿçº§ç»Ÿè®¡ï¼ˆçœ‹å˜é‡åå°±çŸ¥é“æ˜¯ä¸€ä¸ªç¯å½¢è®¡æ•°å™¨ï¼‰ private transient Metric rollingCounterInMinute = new ArrayMetric(60, 60 * 1000, false); // ç»Ÿè®¡QPSæ–¹æ³• public void addPassRequest(int count) { rollingCounterInSecond.addPass(count); // ç§’çº§ç»Ÿè®¡ rollingCounterInMinute.addPass(count); // åˆ†é’Ÿçº§ç»Ÿè®¡ } } // intervalInMsï¼šæ»‘åŠ¨çª—å£çš„æ—¶é—´é—´éš”ï¼ŒSentinelé»˜è®¤ä¸º 1000ms // sampleCountï¼šæ—¶é—´çª—å£çš„åˆ†å‰²æ•°é‡ï¼ŒSentinelé»˜è®¤ä¸º 2 // æ‰€ä»¥æœ€å°çš„æ—¶é—´çª—å£å°±ä¸º 500ms public class ArrayMetric implements Metric { private final LeapArray&lt;MetricBucket&gt; data; public ArrayMetric(int sampleCount, int intervalInMs) { this.data = new OccupiableBucketLeapArray(sampleCount, intervalInMs); } } æ—¶é—´çº¿é“ºå¹³çš„æ•ˆæœå¦‚ä¸‹å›¾ï¼š è·å–å½“å‰è¯·æ±‚æ‰€åœ¨æ—¶é—´çª—å£ï¼Œå¹¶å¢åŠ è®¡æ•° public class ArrayMetric implements Metric { private final LeapArray&lt;MetricBucket&gt; data; public ArrayMetric(int sampleCount, int intervalInMs) { this.data = new OccupiableBucketLeapArray(sampleCount, intervalInMs); } @Override public void addPass(int count) { // è·å–å½“å‰è¯·æ±‚æ‰€åœ¨æ—¶é—´çª—å£ WindowWrap&lt;MetricBucket&gt; wrap = data.currentWindow(); // è®¡æ•°å™¨ + count wrap.value().addPass(count); } } ArrayMetric åˆæ˜¯å¦‚ä½•è·å–å½“å‰æ‰€åœ¨æ—¶é—´çª—å£çš„å‘¢ï¼Ÿ é¦–å…ˆæˆ‘ä»¬å¾—è¦å¼„æ¸…æ¥šLeapArrayä¿å­˜äº†å“ªäº›æ•°æ®ï¼Ÿ public abstract class LeapArray&lt;T&gt; { // å°æ—¶é—´çª—å£çš„æ—¶é—´é•¿åº¦ï¼Œé»˜è®¤ä¸º 500ms protected int windowLengthInMs; // ä¸€ä¸ªIntervalæ—¶é—´è¢«åˆ’åˆ†çš„æ•°é‡ï¼Œç§’çº§ç»Ÿè®¡é»˜è®¤ä¸º2ï¼Œåˆ†é’Ÿçº§é»˜è®¤ä¸º60 protected int sampleCount; // æ»‘åŠ¨æ—¶é—´çª—å£æ—¶é—´é—´éš”ï¼Œé»˜è®¤ä¸º 1000ms protected int intervalInMs; // æ¯ä¸€ä¸ªIntervalæ—¶é—´çª—å£å†…çš„å°çª—å£æ•°ç»„ï¼Œè¿™é‡Œå°±æ˜¯2 protected final AtomicReferenceArray&lt;WindowWrap&lt;T&gt;&gt; array; } å†æ¬¡ä¸Šå›¾ï¼ŒLeapArrayæ˜¯ä¸€ä¸ªç¯å½¢æ•°ç»„ï¼š æˆ‘ä»¬ç›´æ¥çœ‹data.currentWindow() æ–¹æ³•ï¼š // com.alibaba.csp.sentinel.slots.statistic.base.LeapArray#currentWindow(å½“å‰æ—¶é—´æˆ³) public WindowWrap&lt;T&gt; currentWindow(long timeMillis) { if (timeMillis &lt; 0) { return null; } // è®¡ç®—å½“å‰æ—¶é—´å¯¹åº”çš„æ•°ç»„è§’æ ‡ = (å½“å‰æ—¶é—´/500ms)%16 int idx = calculateTimeIdx(timeMillis); // è®¡ç®—å½“å‰æ—¶é—´æ‰€åœ¨çª—å£çš„å¼€å§‹æ—¶é—´ = å½“å‰æ—¶é—´ - å½“å‰æ—¶é—´ % 500ms long windowStart = calculateWindowStart(timeMillis); /* * å…ˆæ ¹æ®è§’æ ‡è·å–æ•°ç»„ä¸­ä¿å­˜çš„ oldWindow å¯¹è±¡ï¼Œå¯èƒ½æ˜¯æ—§æ•°æ®ï¼Œéœ€è¦åˆ¤æ–­. * * (1) oldWindow ä¸å­˜åœ¨, è¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡ï¼Œåˆ›å»ºæ–° windowå¹¶å­˜å…¥ï¼Œç„¶åè¿”å›å³å¯ * (2) oldWindowçš„ starTime = æœ¬æ¬¡è¯·æ±‚çš„ windowStar, è¯´æ˜æ­£æ˜¯è¦æ‰¾çš„çª—å£ï¼Œç›´æ¥è¿”å›. * (3) oldWindowçš„ starTime &lt; æœ¬æ¬¡è¯·æ±‚çš„ windowStar, è¯´æ˜æ˜¯æ—§æ•°æ®ï¼Œéœ€è¦è¢«è¦†ç›–ï¼Œåˆ›å»º * æ–°çª—å£ï¼Œè¦†ç›–æ—§çª—å£ */ while (true) { WindowWrap&lt;T&gt; old = array.get(idx); if (old == null) { // åˆ›å»ºæ–° window WindowWrap&lt;T&gt; window = new WindowWrap&lt;T&gt;(windowLengthInMs, windowStart, newEmptyBucket(timeMillis)); // åŸºäºCASå†™å…¥æ•°ç»„ï¼Œé¿å…çº¿ç¨‹å®‰å…¨é—®é¢˜ if (array.compareAndSet(idx, null, window)) { // å†™å…¥æˆåŠŸï¼Œè¿”å›æ–°çš„ window return window; } else { // å†™å…¥å¤±è´¥ï¼Œè¯´æ˜æœ‰å¹¶å‘æ›´æ–°ï¼Œç­‰å¾…å…¶å®ƒäººæ›´æ–°å®Œæˆå³å¯ Thread.yield(); } } else if (windowStart == old.windowStart()) { return old; } else if (windowStart &gt; old.windowStart()) { if (updateLock.tryLock()) { try { // è·å–å¹¶å‘é”ï¼Œè¦†ç›–æ—§çª—å£å¹¶è¿”å› return resetWindowTo(old, windowStart); } finally { updateLock.unlock(); } } else { // è·å–é”å¤±è´¥ï¼Œç­‰å¾…å…¶å®ƒçº¿ç¨‹å¤„ç†å°±å¯ä»¥äº† Thread.yield(); } } else if (windowStart &lt; old.windowStart()) { // è¿™ç§æƒ…å†µä¸åº”è¯¥å­˜åœ¨ï¼Œå†™è¿™é‡Œåªæ˜¯ä»¥é˜²ä¸‡ä¸€ã€‚ return new WindowWrap&lt;T&gt;(windowLengthInMs, windowStart, newEmptyBucket(timeMillis)); } } } è·å–åˆ°æ—¶é—´çª—å£åï¼Œå¢åŠ è®¡æ•°å°±æ¯”è¾ƒç®€å•äº†ï¼Œä½¿ç”¨â€œè‡ªæ—‹ + CASâ€çš„æ–¹å¼å®Œæˆè®¡æ•°å™¨å®‰å…¨å¢åŠ å³å¯ã€‚ 2 æ»‘åŠ¨çª—å£QPSè®¡ç®—ï¼Œå¹¶åˆ¤æ–­é™æµé€»è¾‘ï¼šFlowSlot public class FlowSlot extends AbstractLinkedProcessorSlot&lt;DefaultNode&gt; { @Override public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count, boolean prioritized, Object... args) throws Throwable { // å…ˆåšé™æµåˆ¤æ–­ checkFlow(resourceWrapper, context, node, count, prioritized); // åˆ¤æ–­é€šè¿‡åï¼Œæ‰ä¼šæ”¾è¡Œåˆ°ä¸‹ä¸€ä¸ªæ’æ§½ fireEntry(context, resourceWrapper, node, count, prioritized, args); } } FlowSlotçš„é™æµåˆ¤æ–­æœ€ç»ˆéƒ½ç”±TrafficShapingControlleræ¥å£ä¸­çš„canPassæ–¹æ³•æ¥å®ç°ã€‚è¯¥æ¥å£æœ‰ä¸‰ä¸ªå®ç°ç±»ï¼š DefaultControllerï¼šå¿«é€Ÿå¤±è´¥ï¼Œé»˜è®¤çš„æ–¹å¼ï¼ŒåŸºäºæ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•ï¼› WarmUpControllerï¼šé¢„çƒ­æ¨¡å¼ï¼ŒåŸºäºæ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•ï¼Œåªä¸è¿‡é˜ˆå€¼æ˜¯åŠ¨æ€çš„ï¼› RateLimiterControllerï¼šæ’é˜Ÿç­‰å¾…æ¨¡å¼ï¼ŒåŸºäºæ¼æ¡¶ç®—æ³•ï¼› è¿™é‡Œæˆ‘ä»¬å°±ä»¥DefaultController.canPass() æ–¹æ³•ä¸ºä¾‹ï¼š com.alibaba.csp.sentinel.slots.block.flow.controller.DefaultController#canPass() public boolean canPass(Node node, int acquireCount, boolean prioritized) { // é‡ç‚¹ï¼šè®¡ç®—ç›®å‰ä¸ºæ­¢æ»‘åŠ¨çª—å£å†…å·²ç»å­˜åœ¨çš„è¯·æ±‚é‡ int curCount = avgUsedTokens(node); // åˆ¤æ–­ï¼šå·²ä½¿ç”¨è¯·æ±‚é‡ + éœ€è¦çš„è¯·æ±‚é‡ï¼ˆ1ï¼‰ æ˜¯å¦å¤§äº çª—å£çš„è¯·æ±‚é˜ˆå€¼ if (curCount + acquireCount &gt; count) { // å¤§äºï¼Œè¯´æ˜è¶…å‡ºé˜ˆå€¼ï¼Œè¿”å›false if (prioritized &amp;&amp; grade == RuleConstant.FLOW_GRADE_QPS) { long currentTime; long waitInMs; currentTime = TimeUtil.currentTimeMillis(); waitInMs = node.tryOccupyNext(currentTime, acquireCount, count); if (waitInMs &lt; OccupyTimeoutProperty.getOccupyTimeout()) { node.addWaitingRequest(currentTime + waitInMs, acquireCount); node.addOccupiedPass(acquireCount); sleep(waitInMs); // PriorityWaitException indicates that the request will pass after waiting for {@link @waitInMs}. throw new PriorityWaitException(waitInMs); } } return false; } // å°äºç­‰äºï¼Œè¯´æ˜åœ¨é˜ˆå€¼èŒƒå›´å†…ï¼Œè¿”å›true return true; } å¾ˆæ˜¾ç„¶ï¼Œå…³é”®ç‚¹å°±åœ¨äºï¼Œå¦‚ä½•è®¡ç®—æ»‘åŠ¨çª—å£å†…å·²ç»ç”¨æ‰çš„è¯·æ±‚é‡ private int avgUsedTokens(Node node) { if (node == null) { return DEFAULT_AVG_USED_TOKENS; } return grade == RuleConstant.FLOW_GRADE_THREAD ? node.curThreadNum() : (int)(node.passQps()); } // æˆ‘ä»¬è¿™é‡Œè‚¯å®šæ˜¯QPSé™æµ // com.alibaba.csp.sentinel.node.StatisticNode#passQps public double passQps() { // è¯·æ±‚é‡ Ã· æ»‘åŠ¨çª—å£æ—¶é—´é—´éš”(é»˜è®¤1ç§’) ï¼Œå¾—åˆ°çš„å°±æ˜¯QPS return rollingCounterInSecond.pass() / rollingCounterInSecond.getWindowIntervalInSec(); } é‚£ä¹ˆrollingCounterInSecond.pass() åˆæ˜¯å¦‚ä½•è®¡ç®—å½“å‰æ—¶é—´çª—å£å†…çš„è¯·æ±‚é‡çš„å‘¢ï¼Ÿ ä»¥ç§’çº§ç»Ÿè®¡ä¸ºä¾‹ï¼Œå…¶å®ç¯å½¢æ•°ç»„çš„é•¿åº¦åªä¸º2ï¼Œåªéœ€è¦è®°å½•å½“å‰å°æ—¶é—´çª—å£å’Œå‰ä¸€ä¸ªå°æ—¶é—´çª—å£å³å¯ï¼Œä¸€ä¸ªéƒ½ä¸å¤šè®°å½•ï¼ŒèŠ‚çº¦å†…å­˜ï¼ // com.alibaba.csp.sentinel.slots.statistic.metric.ArrayMetric#pass public long pass() { // è·å–å½“å‰çª—å£ data.currentWindow(); long pass = 0; // è·å– å½“å‰æ—¶é—´çš„ æ»‘åŠ¨çª—å£èŒƒå›´å†… çš„æ‰€æœ‰å°çª—å£ List&lt;MetricBucket&gt; list = data.values(); // éå† for (MetricBucket window : list) { // ç´¯åŠ æ±‚å’Œ pass += window.pass(); } // è¿”å› return pass; } | | // data.values()å¦‚ä½•è·å– æ»‘åŠ¨çª—å£èŒƒå›´å†… çš„æ‰€æœ‰å°çª—å£çš„ // com.alibaba.csp.sentinel.slots.statistic.base.LeapArray#values(long) public List&lt;T&gt; values(long timeMillis) { if (timeMillis &lt; 0) { return new ArrayList&lt;T&gt;(); } // åˆ›å»ºç©ºé›†åˆï¼Œå¤§å°ç­‰äº LeapArrayé•¿åº¦ï¼ˆ2ï¼‰ int size = array.length(); List&lt;T&gt; result = new ArrayList&lt;T&gt;(size); // éå† LeapArray for (int i = 0; i &lt; size; i++) { // è·å–æ¯ä¸€ä¸ªå°çª—å£ WindowWrap&lt;T&gt; windowWrap = array.get(i); // åˆ¤æ–­è¿™ä¸ªå°çª—å£æ˜¯å¦åœ¨ æ»‘åŠ¨çª—å£æ—¶é—´èŒƒå›´å†…ï¼ˆ1ç§’å†…ï¼‰ if (windowWrap == null || isWindowDeprecated(timeMillis, windowWrap)) { // ä¸åœ¨èŒƒå›´å†…ï¼Œåˆ™è·³è¿‡ continue; } // åœ¨èŒƒå›´å†…ï¼Œåˆ™æ·»åŠ åˆ°é›†åˆä¸­ result.add(windowWrap.value()); } // è¿”å›é›†åˆ return result; } | | // isWindowDeprecated(timeMillis, windowWrap)åˆæ˜¯å¦‚ä½•åˆ¤æ–­çª—å£æ˜¯å¦ç¬¦åˆè¦æ±‚å‘¢ï¼Ÿ public boolean isWindowDeprecated(long time, WindowWrap&lt;T&gt; windowWrap) { // å½“å‰æ—¶é—´ - çª—å£å¼€å§‹æ—¶é—´ æ˜¯å¦å¤§äº æ»‘åŠ¨çª—å£çš„æœ€å¤§é—´éš”ï¼ˆ1ç§’ï¼‰ // ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è¦ç»Ÿè®¡çš„æ˜¯ è·ç¦»å½“å‰æ—¶é—´1ç§’å†…çš„ å°çª—å£çš„ countä¹‹å’Œ return time - windowWrap.windowStart() &gt; intervalInMs; } åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å¯ä»¥ç†æ¸…äº†ï¼š StatisticSlotä¼šå¸®åŠ©æˆ‘ä»¬è®°å½•æ¯ä¸€æ¬¡çš„requestè¯·æ±‚ï¼Œç»Ÿè®¡æ¯ä¸ªå°æ—¶é—´çª—å£å†…çš„è¯·æ±‚æ•°ï¼› ç§’çº§ç»Ÿè®¡çš„æ—¶é—´çª—å£ç¯åªæœ‰ 2 æ ¼ï¼› åˆ†é’Ÿçº§ç»Ÿè®¡çš„æ—¶é—´çª—å£ç¯æœ‰ 60æ ¼ï¼› FlowSlotåœ¨éœ€è¦çš„æ—¶å€™ï¼Œä¼šå»é™¤å½“å‰æ—¶é—´çª—å£å†…åŒ…å«çš„æ‰€æœ‰å°çª—å£ï¼Œç„¶åç´¯åŠ ä»–ä»¬çš„è¯·æ±‚é‡ï¼› æœ€ååˆ¤æ–­æ˜¯å¦æº¢å‡ºé™æµé˜ˆå€¼ï¼Œå…è®¸é€šè¿‡ï¼Œæˆ–ç›´æ¥æ‹’ç»ï¼ ä¸‰ Sentinelä¸­ä¸‰ç§é™æµæ–¹æ¡ˆçš„å®ç°æºç å‰–æä¹‹â€”â€”ä»¤ç‰Œæ¡¶ç®—æ³• â€œçƒ­ç‚¹å‚æ•°â€é™æµç­–ç•¥ï¼Œä¸é€‚åˆä½¿ç”¨ StatisticSlot ä¸­å¸¸è§„çš„ â€œæ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•â€ï¼Œå› ä¸ºStatisticSlotä¸­ç»Ÿè®¡çš„ç»´åº¦æ˜¯Nodeçº§åˆ«ï¼› å¾ˆæ˜¾ç„¶ï¼Œâ€œçƒ­ç‚¹å‚æ•°â€å¹¶ä¸é€‚åˆä½¿ç”¨ä¸Šé¢çš„â€œç¯å½¢æ—¶é—´çª—å£ç®—æ³•â€æ¥å®ç°ï¼› ç›¸æ¯”ä¸‹æ¥ï¼Œâ€œä»¤ç‰Œæ¡¶ç®—æ³•â€æœ€é€‚åˆç”¨åœ¨â€œçƒ­ç‚¹å‚æ•°é™æµâ€åœºæ™¯ä¸‹ï¼Œåªéœ€è¦ä¸ºæ¯ä¸ªä¸åŒçš„å‚æ•°å€¼åˆ›å»ºä¸€ä¸ªä»¤ç‰Œæ¡¶å³å¯ã€‚ Controllerä¸­çš„æ–¹æ³•èµ„æºæ˜¯ä¸å¯ä»¥è¿›è¡Œçƒ­ç‚¹å‚æ•°é™æµçš„ï¼šé€šè¿‡Sentinelæ·»åŠ çš„springmvcæ‹¦æˆªå™¨å®ç°ï¼Œåˆ›å»ºEntryæ—¶å€™æ²¡æœ‰ä¼ å…¥paramså‚æ•°ï¼› å…¶å®ƒçš„æˆ‘ä»¬é€šè¿‡@SentinelResourceæ·»åŠ çš„èµ„æºæ‰è‰ºè¿›è¡Œçƒ­ç‚¹å‚æ•°é™æµï¼šé€šè¿‡AOPåˆ‡é¢ç¼–ç¨‹å®ç°ï¼Œåˆ›å»ºEntryçš„æ—¶å€™ï¼Œä¹Ÿå°†Paramsä¸€å¹¶ä¼ å…¥äº†ï¼› public class ParamFlowSlot extends AbstractLinkedProcessorSlot&lt;DefaultNode&gt; { public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count, boolean prioritized, Object... args) throws Throwable { if (!ParamFlowRuleManager.hasRules(resourceWrapper.getName())) { this.fireEntry(context, resourceWrapper, node, count, prioritized, args); } else { // æ ¡éªŒå‚æ•°é™æµ this.checkFlow(resourceWrapper, count, args); // æ”¾è¡Œåˆ°ä¸‹ä¸€ä¸ªæ’æ§½ this.fireEntry(context, resourceWrapper, node, count, prioritized, args); } } void checkFlow(ResourceWrapper resourceWrapper, int count, Object... args) throws BlockException { // args == null æƒ…å†µæœ‰äºŒï¼š1ã€ç¡®å®æ²¡æœ‰å‚æ•°ï¼› 2ã€Controlleræ–¹æ³•æ— æ³•è¿›è¡Œå‚æ•°é™æµ if (args != null) { if (ParamFlowRuleManager.hasRules(resourceWrapper.getName())) { List&lt;ParamFlowRule&gt; rules = ParamFlowRuleManager.getRulesOfResource(resourceWrapper.getName()); Iterator var5 = rules.iterator(); ParamFlowRule rule; // do-whileå¾ªç¯ï¼Œå¯¹æ¯ä¸€æ¡ruleè§„åˆ™åšåˆ¤æ–­ do { if (!var5.hasNext()) { return; } rule = (ParamFlowRule)var5.next(); this.applyRealParamIdx(rule, args.length); // åˆå§‹åŒ–â€œä»¤ç‰Œæ¡¶â€â€”â€” åŠ â€œâ€å·ï¼Œå¹¶éçœŸçš„ä»¤ç‰Œæ¡¶ ParameterMetricStorage.initParamMetricsFor(resourceWrapper, rule); } while(ParamFlowChecker.passCheck(resourceWrapper, rule, count, args)); String triggeredParam = &quot;&quot;; if (args.length &gt; rule.getParamIdx()) { Object value = args[rule.getParamIdx()]; triggeredParam = String.valueOf(value); } throw new ParamFlowException(resourceWrapper.getName(), triggeredParam, rule); } } } } 1ParameterMetricStorage.initParamMetricsFor() ä»¤ç‰Œæ¡¶åˆå§‹åŒ–æ–¹æ³• public final class ParameterMetricStorage { // ä»¥èµ„æºååŒºåˆ†ä¸åŒèµ„æºä¸‹çš„ä»¤ç‰Œæ¡¶å®¹å™¨ï¼ˆå› ä¸ºè¿™è¿˜ä¸æ˜¯çœŸæ­£çš„ä»¤ç‰Œæ¡¶ï¼‰ private static final Map&lt;String, ParameterMetric&gt; metricsMap = new ConcurrentHashMap(); private static final Object LOCK = new Object(); public static void initParamMetricsFor(ResourceWrapper resourceWrapper, ParamFlowRule rule) { if (resourceWrapper != null &amp;&amp; resourceWrapper.getName() != null) { String resourceName = resourceWrapper.getName(); ParameterMetric metric; if ((metric = (ParameterMetric)metricsMap.get(resourceName)) == null) { synchronized(LOCK) { // å¦‚æœå½“å‰èµ„æºè¿˜æ²¡åˆ›å»ºè¿‡è‡ªå·±çš„ä»¤ç‰Œæ¡¶å®¹å™¨ï¼Œé‚£å°±åˆ›å»ºä¸€ä¸ª if ((metric = (ParameterMetric)metricsMap.get(resourceName)) == null) { metric = new ParameterMetric(); metricsMap.put(resourceWrapper.getName(), metric); RecordLog.info(&quot;[ParameterMetricStorage] Creating parameter metric for: &quot; + resourceWrapper.getName(), new Object[0]); } } } // å¯¹ä»¤ç‰Œæ¡¶å®¹å™¨è¿›è¡Œåˆå§‹åŒ– metric.initialize(rule); } } } 2 åˆå§‹åŒ–ä»¤ç‰Œæ¡¶å®¹å™¨ï¼ŒçœŸæ­£çš„ä»¤ç‰Œæ¡¶å³å°†å‡ºç° Sentinelä¸­çš„ä»¤ç‰Œæ¡¶ï¼Œå…¶å®æ˜¯ç»´æŠ¤2ä¸ªåŒå±‚Mapï¼š å®¹å™¨ä¸­å‰©ä½™ä»¤ç‰Œæ•°çš„Mapï¼š&lt;ParamFlowRule, &lt;å‚æ•°å€¼, å±äºè¿™ä¸ªå‚æ•°å€¼å¾—æ¡¶ä¸­çš„å‰©ä½™å¯ç”¨ä»¤ç‰Œæ•°&gt;&gt;ï¼šæ­¤æ—¶ç¬¬äºŒå±‚Mapè¿˜æ˜¯ç©ºMapï¼› è®°å½•æœ€è¿‘ä¸€æ¬¡é€šè¿‡çš„è¯·æ±‚æ—¶é—´æˆ³çš„Mapï¼š&lt;ParamFlowRule, &lt;å‚æ•°å€¼, æœ€è¿‘ä¸€æ¬¡è¯·æ±‚çš„æ—¶é—´æˆ³&gt;&gt;ï¼šæ­¤æ—¶ç¬¬äºŒå±‚Mapè¿˜æ˜¯ç©ºMapï¼› public class ParameterMetric { private static final int THREAD_COUNT_MAX_CAPACITY = 4000; private static final int BASE_PARAM_MAX_CAPACITY = 4000; private static final int TOTAL_MAX_CAPACITY = 200000; private final Object lock = new Object(); // ä»¤ç‰Œæ¡¶å®ç°ä¹‹ä¸€ï¼šåŒå±‚Mapï¼š&lt;ParamFlowRule, &lt;å‚æ•°å€¼, ä¸Šæ¬¡è¯·æ±‚çš„æ—¶é—´æˆ³&gt;&gt; private final Map&lt;ParamFlowRule, CacheMap&lt;Object, AtomicLong&gt;&gt; ruleTimeCounters = new HashMap(); // ä»¤ç‰Œæ¡¶ä¹‹äºŒï¼šæ¡¶ä¸­å‰©ä½™çš„ä»¤ç‰Œæ•° private final Map&lt;ParamFlowRule, CacheMap&lt;Object, AtomicLong&gt;&gt; ruleTokenCounter = new HashMap(); private final Map&lt;Integer, CacheMap&lt;Object, AtomicInteger&gt;&gt; threadCountMap = new HashMap(); // åˆå§‹åŒ–ä»¤ç‰Œæ¡¶å®¹å™¨ public void initialize(ParamFlowRule rule) { long size; if (!this.ruleTimeCounters.containsKey(rule)) { synchronized(this.lock) { // åˆå§‹åŒ–ParamRuleå¯¹åº”çš„â€œæœ€è¿‘è¯·æ±‚æ—¶é—´æˆ³Mapâ€ if (this.ruleTimeCounters.get(rule) == null) { size = Math.min(4000L * rule.getDurationInSec(), 200000L); this.ruleTimeCounters.put(rule, new ConcurrentLinkedHashMapWrapper(size)); } } } if (!this.ruleTokenCounter.containsKey(rule)) { synchronized(this.lock) { // åˆå§‹åŒ–ParamRuleå¯¹åº”çš„â€œæ¡¶ä¸­å¯ç”¨ä»¤ç‰ŒMapâ€ if (this.ruleTokenCounter.get(rule) == null) { size = Math.min(4000L * rule.getDurationInSec(), 200000L); this.ruleTokenCounter.put(rule, new ConcurrentLinkedHashMapWrapper(size)); } } } if (!this.threadCountMap.containsKey(rule.getParamIdx())) { synchronized(this.lock) { if (this.threadCountMap.get(rule.getParamIdx()) == null) { this.threadCountMap.put(rule.getParamIdx(), new ConcurrentLinkedHashMapWrapper(4000L)); } } } } } ä»¥ä¸Šï¼Œåªç®—æ˜¯å°†ä»¤ç‰Œæ¡¶å®¹å™¨åˆå§‹åŒ–å¥½äº†ï¼Œä½†æ˜¯è¿˜æ²¡å¼€å§‹æ­£å¼ä½¿ç”¨ï¼ 3 æ­£å¼ä½¿ç”¨ä¸Šé¢åˆ›å»ºçš„ä»¤ç‰Œæ¡¶å®¹å™¨ï¼Œä¸€æ­¥æ­¥è°ƒç”¨è‡³â€œçƒ­ç‚¹å‚æ•°é™æµâ€åˆ¤æ–­é€»è¾‘æ ¸å¿ƒæ–¹æ³• ParamFlowChecker.passCheck(resourceWrapper, rule, count, args) com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowChecker#passLocalCheck com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowChecker#passSingleValueCheck com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowChecker#passDefaultLocalCheck 4ParamFlowChecker.passDefaultLocalCheck() å³ä¸ºâ€œçƒ­ç‚¹é™æµé€»è¾‘â€çš„æ ¸å¿ƒæ–¹æ³• // com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowChecker#passDefaultLocalCheck static boolean passDefaultLocalCheck(ResourceWrapper resourceWrapper, ParamFlowRule rule, int acquireCount, Object value) { ParameterMetric metric = getParameterMetric(resourceWrapper); // æ ¹æ®ruleä»ä¸Šé¢åˆå§‹åŒ–å¥½çš„ä»¤ç‰Œæ¡¶å®¹å™¨ä¸­å»é™¤ç¬¬äºŒå±‚Map // &lt;å‚æ•°å€¼, ä¸Šæ¬¡è¯·æ±‚çš„æ—¶é—´æˆ³&gt; // &lt;å‚æ•°å€¼, å±äºè¿™ä¸ªå‚æ•°å€¼å¾—æ¡¶ä¸­çš„å‰©ä½™å¯ç”¨ä»¤ç‰Œæ•°&gt; CacheMap&lt;Object, AtomicLong&gt; tokenCounters = metric == null ? null : metric.getRuleTokenCounter(rule); CacheMap&lt;Object, AtomicLong&gt; timeCounters = metric == null ? null : metric.getRuleTimeCounter(rule); if (tokenCounters != null &amp;&amp; timeCounters != null) { Set&lt;Object&gt; exclusionItems = rule.getParsedHotItems().keySet(); long tokenCount = (long)rule.getCount(); if (exclusionItems.contains(value)) { tokenCount = (long)(Integer)rule.getParsedHotItems().get(value); } if (tokenCount == 0L) { return false; } else { // å…è®¸çš„æœ€å¤§è¯·æ±‚æ•°ï¼Œä¹Ÿæ˜¯æ¡¶çš„æœ€å¤§å€¼ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬ruleä¸­è®¾ç½®çš„å•æœºé˜ˆå€¼ // åè€…æ˜¯çªå‘é˜ˆå€¼ï¼Œä¸€èˆ¬ä¸é…ç½®ï¼Œä¸º0 long maxCount = tokenCount + (long)rule.getBurstCount(); if ((long)acquireCount &gt; maxCount) { return false; } else { while(true) { long currentTime = TimeUtil.currentTimeMillis(); // ä»timeMapä¸­è·å–æœ€è¿‘ä¸€æ¬¡è¯·æ±‚é€šè¿‡çš„æ—¶é—´æˆ³ AtomicLong lastAddTokenTime = (AtomicLong)timeCounters.putIfAbsent(value, new AtomicLong(currentTime)); if (lastAddTokenTime == null) { // ç›¸åŒå‚æ•°ç¬¬ä¸€æ¬¡ï¼Œç›´æ¥æ”¾è¡Œï¼Œå¹¶æ›´æ–°tokenMap = maxCount - 1 tokenCounters.putIfAbsent(value, new AtomicLong(maxCount - (long)acquireCount)); return true; } // è·ç¦»ä¸Šä¸€æ¬¡è¯·æ±‚é€šè¿‡çš„æ—¶é—´çš„å·®å€¼ long passTime = currentTime - lastAddTokenTime.get(); AtomicLong oldQps; long restQps; // è·æœ€è¿‘ä¸€æ¬¡æ—¶é—´å·® &gt; ä¸€æ¬¡ç»Ÿè®¡çª—å£ if (passTime &gt; rule.getDurationInSec() * 1000L) { oldQps = (AtomicLong)tokenCounters.putIfAbsent(value, new AtomicLong(maxCount - (long)acquireCount)); if (oldQps == null) { lastAddTokenTime.set(currentTime); return true; } // tokenMapä¸­å‰©ä½™çš„ä»¤ç‰Œæ•° restQps = oldQps.get(); // åœ¨è·ç¦»ä¸Šæ¬¡è¯·æ±‚çš„è¿™æ®µæ—¶é—´å†…ï¼Œåº”è¯¥è¡¥å……ç”Ÿæˆå¤šå°‘æ–°çš„ä»¤ç‰Œ long toAddCount = passTime * tokenCount / (rule.getDurationInSec() * 1000L); // ä¸Šé¢2è€…ç›¸åŠ ï¼Œä¸maxCountå…è®¸çš„æœ€å¤§ä»¤ç‰Œæ•°å¯¹æ¯”ï¼Œå–minå€¼ï¼Œå¹¶å‡å»æœ¬æ¬¡éœ€è¦çš„ä»¤ç‰Œæ•° long newQps = toAddCount + restQps &gt; maxCount ? maxCount - (long)acquireCount : restQps + toAddCount - (long)acquireCount; if (newQps &lt; 0L) { return false; } // é€šè¿‡CASæ›¿æ¢åŸæ¥çš„tokenMapï¼Œå¹¶ä¿®æ”¹æœ€æ–°é€šè¿‡çš„è¯·æ±‚æ—¶é—´æˆ³ if (oldQps.compareAndSet(restQps, newQps)) { lastAddTokenTime.set(currentTime); return true; } Thread.yield(); } else { // è·æœ€è¿‘ä¸€æ¬¡æ—¶é—´å·® &lt; ä¸€æ¬¡ç»Ÿè®¡çª—å£ oldQps = (AtomicLong)tokenCounters.get(value); if (oldQps != null) { restQps = oldQps.get(); // tokenMapä¸­å‰©ä½™ä»¤ç‰Œä¸è¶³ï¼Œç›´æ¥æ‹’ç» if (restQps - (long)acquireCount &lt; 0L) { return false; } // å‰©ä½™ä»¤ç‰Œå……è¶³ï¼ŒCASä»tokenMapä¸­å‡å»å½“å‰éœ€è¦çš„ä»¤ç‰Œæ•° if (oldQps.compareAndSet(restQps, restQps - (long)acquireCount)) { return true; } } Thread.yield(); } } } } } else { return true; } } æ€»ç»“ï¼šå¯¹äºçƒ­ç‚¹å‚æ•°é™æµï¼š Sentinel ä¼šä¸ºæ¯ä¸ªèµ„æºï¼Œç»´æŠ¤ä¸¤ä¸ªåŒå±‚æ•°ç»„ï¼š å®¹å™¨ä¸­å‰©ä½™ä»¤ç‰Œæ•°çš„tokenMapï¼š&lt;ParamFlowRule, &lt;å‚æ•°å€¼, å±äºè¿™ä¸ªå‚æ•°å€¼å¾—æ¡¶ä¸­çš„å‰©ä½™å¯ç”¨ä»¤ç‰Œæ•°&gt;&gt; è®°å½•æœ€è¿‘ä¸€æ¬¡é€šè¿‡çš„è¯·æ±‚æ—¶é—´æˆ³çš„timeMapï¼š&lt;ParamFlowRule, &lt;å‚æ•°å€¼, æœ€è¿‘ä¸€æ¬¡è¯·æ±‚çš„æ—¶é—´æˆ³&gt;&gt; ä»¥å‚æ•° x=100ï¼Œé™æµä¸º5ä¸ºä¾‹ï¼š ç¬¬ä¸€æ¬¡åˆ°è¾¾æ—¶ï¼Œè‚¯å®šä¸ä¼šè¶…é™ï¼Œæ”¾è¡Œï¼ŒåŒæ—¶å¾€tokenMapä¸­putå…¥&lt;100, 4&gt; è¿‡ä¸€ä¼šå„¿ï¼Œx = 100 çš„è¯·æ±‚å†æ¬¡åˆ°è¾¾ï¼Œåˆ™åˆ¤æ–­ï¼Œæœ¬æ¬¡è¯·æ±‚ï¼Œè·ç¦»ä¸Šä¸€æ¬¡è¯·æ±‚æ—¶é—´ï¼Œæ˜¯å¦è¶…è¿‡ä¸€ä¸ªæ—¶é—´ç»Ÿè®¡çª—å£ï¼š åœ¨åŒä¸€ä¸ªæ—¶é—´çª—å£ï¼Œåˆ™åœ¨å‰ä¸€æ¬¡çš„åŸºç¡€ä¸Šç»§ç»­å‡å°‘tokenå€¼ï¼ŒtokenMapä¸­å€¼å˜ä¸º &lt;100, 3&gt; å¦‚æœä¸åœ¨ä¸€ä¸ªæ—¶é—´çª—å£ï¼Œé‚£ä¹ˆè®¡ç®—è·ç¦»ä¸Šæ¬¡è¯·æ±‚çš„è¿™æ®µæ—¶é—´å†…ï¼Œåº”è¯¥æ–°ç”Ÿæˆçš„tokenæ•° + ç°åœ¨æ¡¶ä¸­å‰©ä½™çš„tokenæ•°ï¼Œä¸maxTokenæ•°åšå¯¹æ¯”ï¼Œå–å°å€¼å°±ç›¸å½“äºæ˜¯æ­¤æ—¶æ¡¶ä¸­åº”è¯¥æœ‰çš„ä»¤ç‰Œæ•°ï¼Œç„¶åå‡å»è‡ªå·±æœ¬æ¬¡éœ€è¦çš„ä»¤ç‰Œæ•°ï¼Œä¹‹åå†æ›´æ–°tokenMapï¼› å››ã€Sentinelä¸­ä¸‰ç§é™æµæ–¹æ¡ˆçš„å®ç°æºç å‰–æä¹‹â€”â€”æ¼æ¡¶ç®—æ³• æ¼æ¡¶ç®—æ³•çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šå°†è¯·æ±‚æ”¾åœ¨æ¼æ¡¶ä¸­ï¼Œæ¼æ¡¶ä¼šæŒ‰ç…§å›ºå®šæ—¶é—´é—´éš”ï¼Œå‘å¤–â€œæ¼å‡ºâ€è¯·æ±‚ï¼Œè¿›è¡Œå¤„ç†ï¼Œè¿™æ ·å¾ˆæ˜æ˜¾çš„å¥½å¤„å°±æ˜¯â€œæµé‡æ•´å½¢â€ï¼Œå½“ç¬é—´æµé‡è¿‡å¤§æ—¶ï¼Œä¹Ÿå¯ä»¥å…ˆæ”¾åœ¨æ¼æ¡¶ä¸­ï¼Œæ…¢æ…¢å¤„ç†ï¼ æ¼æ¡¶ç®—æ³•çš„å…¥å£ä¹Ÿæ˜¯åœ¨FlowSlotä¸­ï¼Œä¸Šé¢æœ‰è®²è¿‡ï¼š FlowSlotçš„é™æµåˆ¤æ–­æœ€ç»ˆéƒ½ç”±TrafficShapingControlleræ¥å£ä¸­çš„canPassæ–¹æ³•æ¥å®ç°ã€‚è¯¥æ¥å£æœ‰ä¸‰ä¸ªå®ç°ç±»ï¼š DefaultControllerï¼šå¿«é€Ÿå¤±è´¥ï¼Œé»˜è®¤çš„æ–¹å¼ï¼ŒåŸºäºæ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•ï¼› WarmUpControllerï¼šé¢„çƒ­æ¨¡å¼ï¼ŒåŸºäºæ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•ï¼Œåªä¸è¿‡é˜ˆå€¼æ˜¯åŠ¨æ€çš„ï¼› RateLimiterControllerï¼šæ’é˜Ÿç­‰å¾…æ¨¡å¼ï¼ŒåŸºäºæ¼æ¡¶ç®—æ³•ï¼› ç›´æ¥è¿›å…¥RateLimiterController.canPass()æ–¹æ³•é€»è¾‘ï¼š // com.alibaba.csp.sentinel.slots.block.flow.controller.RateLimiterController#canPass() // æœ€æ–°ä¸€æ¬¡çš„è¯·æ±‚æ‰§è¡Œæ—¶é—´ï¼ˆä¸ä¸€å®šæ˜¯å·²ç»é€šè¿‡çš„ï¼Œè€Œæ˜¯é˜Ÿåˆ—ä¸­æ’åœ¨æœ€å°¾ç«¯çš„è¯·æ±‚çš„é¢„æœŸæ‰§è¡Œæ—¶é—´ï¼‰ private final AtomicLong latestPassedTime = new AtomicLong(-1); @Override public boolean canPass(Node node, int acquireCount, boolean prioritized) { // Pass when acquire count is less or equal than 0. if (acquireCount &lt;= 0) { return true; } // é˜ˆå€¼å°äºç­‰äº 0 ï¼Œé˜»æ­¢è¯·æ±‚ï¼Œä¸å¤ªå¯èƒ½ if (count &lt;= 0) { return false; } // è·å–å½“å‰æ—¶é—´ long currentTime = TimeUtil.currentTimeMillis(); // è®¡ç®—ä¸¤æ¬¡è¯·æ±‚ä¹‹é—´å…è®¸çš„æœ€å°æ—¶é—´é—´éš” // æ­£å¸¸æ—¶å€™acquireCount=1ï¼Œé‚£ä¹ˆcostTime = 200ms long costTime = Math.round(1.0 * (acquireCount) / count * 1000); // è®¡ç®—æœ¬æ¬¡è¯·æ±‚ å…è®¸æ‰§è¡Œçš„æ—¶é—´ç‚¹ = ä¸Šä¸€æ¬¡è¯·æ±‚çš„å¯èƒ½æ‰§è¡Œæ—¶é—´ + ä¸¤æ¬¡è¯·æ±‚çš„æœ€å°é—´éš” long expectedTime = costTime + latestPassedTime.get(); // å¦‚æœå…è®¸æ‰§è¡Œçš„æ—¶é—´ç‚¹å°äºå½“å‰æ—¶é—´ï¼Œè¯´æ˜å¯ä»¥ç«‹å³æ‰§è¡Œ if (expectedTime &lt;= currentTime) { // æ›´æ–°ä¸Šä¸€æ¬¡çš„è¯·æ±‚çš„æ‰§è¡Œæ—¶é—´ latestPassedTime.set(currentTime); // è¿™ç§æƒ…å†µè¯´æ˜è¯¥æ‰§è¡Œäº†ï¼Œç«‹å³æ‰§è¡Œ return true; } else { // ä¸èƒ½ç«‹å³æ‰§è¡Œï¼Œéœ€è¦è®¡ç®— é¢„æœŸç­‰å¾…æ—¶é•¿ // é¢„æœŸç­‰å¾…æ—¶é•¿ = ä¸¤æ¬¡è¯·æ±‚çš„æœ€å°é—´éš” + æœ€è¿‘ä¸€æ¬¡è¯·æ±‚çš„å¯æ‰§è¡Œæ—¶é—´ - å½“å‰æ—¶é—´ long waitTime = costTime + latestPassedTime.get() - TimeUtil.currentTimeMillis(); // å¦‚æœé¢„æœŸç­‰å¾…æ—¶é—´è¶…å‡ºé˜ˆå€¼ï¼Œåˆ™æ‹’ç»è¯·æ±‚ if (waitTime &gt; maxQueueingTimeMs) { return false; } else { // é¢„æœŸç­‰å¾…æ—¶é—´å°äºé˜ˆå€¼ï¼Œæ›´æ–°æœ€è¿‘ä¸€æ¬¡è¯·æ±‚çš„å¯æ‰§è¡Œæ—¶é—´ï¼ŒåŠ ä¸ŠcostTime long oldTime = latestPassedTime.addAndGet(costTime); try { // ä¿é™©èµ·è§ï¼Œå†åˆ¤æ–­ä¸€æ¬¡é¢„æœŸç­‰å¾…æ—¶é—´ï¼Œæ˜¯å¦è¶…è¿‡é˜ˆå€¼ waitTime = oldTime - TimeUtil.currentTimeMillis(); if (waitTime &gt; maxQueueingTimeMs) { // å¦‚æœè¶…è¿‡ï¼Œåˆ™æŠŠåˆšæ‰ åŠ  çš„æ—¶é—´å† å‡å›æ¥ latestPassedTime.addAndGet(-costTime); // æ‹’ç» return false; } // in race condition waitTime may &lt;= 0 if (waitTime &gt; 0) { // é¢„æœŸç­‰å¾…æ—¶é—´åœ¨é˜ˆå€¼èŒƒå›´å†…ï¼Œä¼‘çœ è¦ç­‰å¾…çš„æ—¶é—´ï¼Œé†’æ¥åç»§ç»­æ‰§è¡Œ Thread.sleep(waitTime); } return true; } catch (InterruptedException e) { } } } return false; } æ€»ç»“ï¼š Sentinelçš„æ¼æ¡¶ç®—æ³•ï¼Œä¸æ˜¯çœŸçš„ç»´æŠ¤äº†ä¸€ä¸ªé˜Ÿåˆ—ï¼Œè€Œæ˜¯é€šè¿‡è®¡ç®—å„ä¸ªè¯·æ±‚çš„é¢„è®¡æ‰§è¡Œæ—¶é—´ï¼› å¦‚æœé¢„è®¡æ‰§è¡Œæ—¶é—´ &gt; æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œé‚£ä¹ˆä¹…ä¸ç”¨ç­‰äº†ï¼Œç›´æ¥æ‹’ç»ï¼› å¦‚æœé¢„è®¡æ‰§è¡Œæ—¶é—´ &lt; æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œé‚£ä¹ˆå°±ç­‰å¾…å§ï¼Œè‡ªå·±é€šè¿‡ Thread.sleep(waitTime) å®ç°ç­‰å¾…ï¼ ","link":"https://tianxiawuhao.github.io/xUda2KT1A/"},{"title":"Sentinelæ ¸å¿ƒæºç â€”â€”æ’æ§½æœºåˆ¶ï¼ˆè´£ä»»é“¾æ¨¡å¼ï¼‰","content":"Sentinelæ ¸å¿ƒæºç â€”â€”æ’æ§½æœºåˆ¶ï¼ˆè´£ä»»é“¾æ¨¡å¼ï¼‰ Sentinelçš„å·¥ä½œåŸç†ï¼šhttps://github.com/alibaba/Sentinel/wiki Sentinelä¼šä¸ºæ‰€æœ‰çš„èµ„æºï¼Œä»¥èµ„æºåä¸ºåŒºåˆ†ï¼Œåˆ›å»ºå„è‡ªçš„DefaultProcessorSlotChainï¼Œæ”¾åœ¨ç¼“å­˜ä¸­ï¼› DefaultProcessorSlotChainçš„9ä¸ªProcessorSlotæ’æ§½éƒ½æ˜¯é€šè¿‡SPIæœºåˆ¶ä» META/services/ ç›®å½•ä¸‹åŠ è½½çš„ï¼› æ¯ä¸€ä¸ªProcessorSlot å…¶å®æ˜¯ä¸€ä¸ª AbstractLinkedProcessorSlot æŠ½è±¡é“¾è¡¨å¤„ç†å™¨æ’æ§½ï¼Œ æœ‰ä¸€ä¸ªnextå±æ€§ï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªSlotï¼Œå½“æŸä¸€ä¸ªSlotæ‰§è¡Œå®Œåï¼Œä¼šè°ƒç”¨fireEntry()æ–¹æ³•ï¼Œ å°†è¯·æ±‚è½¬åˆ°ä¸‹ä¸€ä¸ªSlotç»§ç»­æ‰§è¡Œã€‚ æœ€ç»ˆå®Œæˆè´£ä»»é“¾ä¸Šæ‰€æœ‰ProcessorSlotçš„é€»è¾‘ï¼ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” Contexté“¾è·¯ä¸Šä¸‹æ–‡ä¸ºrequestè¯·æ±‚çº§åˆ«çš„ï¼Œæ”¾åœ¨ThreadLocalä¸­ï¼Œè¯·æ±‚ç»“æŸå³é‡Šæ”¾ï¼› entranceNodeæ˜¯åº”ç”¨çº§åˆ«çš„ï¼Œåˆ›å»ºå®Œæˆåï¼Œä¼šç¼“å­˜èµ·æ¥ï¼ˆkeyä¸ºcontextNameï¼‰ï¼Œä¸‹ä¸€ä¸ªè¯·æ±‚å¯ä»¥ç»§ç»­ä½¿ç”¨ï¼› processorSlotChainä¹Ÿæ˜¯åº”ç”¨çº§åˆ«çš„ï¼Œåˆ›å»ºå®Œæˆåï¼Œä¼šç¼“å­˜èµ·æ¥ï¼ˆkeyä¸ºresourceNameï¼‰ï¼Œä¸‹ä¸€ä¸ªè¯·æ±‚å¯ä»¥ç»§ç»­ä½¿ç”¨ï¼› ä¸€ ProcessorSlotChainå¤„ç†å™¨æ’æ§½é“¾å’ŒNodeèŠ‚ç‚¹çš„å¼•å…¥ é¦–å…ˆï¼Œæ ¹æ®å®˜æ–¹Wikiä¸­çš„å›¾ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå½¢è±¡åœ°çœ‹åˆ°ï¼Œæ•´ä¸ªè¯·æ±‚å¤„ç†è¿‡ç¨‹å°±åƒä¸€ä¸ªé“¾æ¡ä¸€æ ·ï¼Œä¸€æ­¥æ­¥åœ°å‘åæ‰§è¡Œï¼Œè¿™æ˜¯ä¸€ç§å…¸å‹åœ°â€œè´£ä»»é“¾æ¨¡å¼â€ï¼› è´£ä»»é“¾æ¨¡å¼ â€”â€” ä¸ºè¯·æ±‚åˆ›å»ºä¸€ä¸ªæ¥æ”¶è€…å¯¹è±¡çš„é“¾ï¼Œé“¾ä¸Šçš„æ¯ä¸€ä¸ªèŠ‚ç‚¹æœåŠ¡å¤„ç†å„è‡ªçš„ä¸šåŠ¡é€»è¾‘ï¼Œå®ç°è§£è€¦ï¼Œæ¯ä¸€ä¸ªå¤„ç†è€…èŠ‚ç‚¹è®°å½•ç€ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å¼•ç”¨ï¼Œè¯·æ±‚å°†æ²¿ç€è¿™æ¡é“¾è¢«ä¼ é€’ä¸‹å»ï¼Œä»¥æ­¤å¤„ç†å¯¹åº”çš„é€»è¾‘ã€‚ 1 ProcessorSlotChainå¤„ç†å™¨æ’æ§½é“¾çš„å¼•å…¥ ProcessorSlotChainæ˜¯ä¸Šå›¾æ•´ä¸ªé“¾çš„éª¨æ¶ï¼ŒåŸºäºâ€œè´£ä»»é“¾æ¨¡å¼â€è®¾è®¡ï¼Œå°†â€œç»Ÿè®¡ã€æˆæƒã€é™æµã€é™çº§ç­‰â€å¤„ç†é€»è¾‘å°è£…æˆä¸€ä¸ªä¸ªçš„Slotæ’æ§½ï¼Œä¸²è”èµ·æ¥ã€‚ å¤„ç†é“¾ä¸­çš„Slotæ’æ§½å¯ç²—åˆ†ä¸ºä¸Šä¸‹ä¸¤å¤§ç±»ï¼šæ•°æ®ç»Ÿè®¡éƒ¨åˆ† + è§„åˆ™åˆ¤æ–­éƒ¨åˆ† æ•°æ®ç»Ÿè®¡ï¼š **NodeSelectorSlotï¼š**è´Ÿè´£æ„å»ºç°‡ç‚¹é“¾è·¯ä¸­çš„å„ä¸ªèŠ‚ç‚¹ï¼ˆDefaultNodeï¼‰ï¼Œå½¢æˆNodeTree **ClusterBuilderSlotï¼š**è´Ÿè´£æ„å»ºæŸä¸ªèµ„æºçš„ClusterNodeï¼ˆå…·ä½“çš„DefaultNodeå’ŒClusterNodeçš„åŒºåˆ«è§ä¸‹æ–‡ï¼‰ **StatisticSlotï¼š**è´Ÿè´£å®æ—¶ç»Ÿè®¡è¯·æ±‚çš„å„ç§è°ƒç”¨ä¿¡æ¯ï¼Œå¦‚æ¥æºä¿¡æ¯ã€è¯·æ±‚æ¬¡æ•°ã€è¿è¡Œä¿¡æ¯ç­‰ï¼› è§„åˆ™åˆ¤æ–­ï¼š AuthoritySlotï¼šæˆæƒè§„åˆ™åˆ¤æ–­ï¼ˆæ¥æºæ§åˆ¶ï¼‰ SystemSlotï¼šç³»ç»Ÿä¿æŠ¤è§„åˆ™åˆ¤æ–­ï¼Œå½“ç³»ç»Ÿèµ„æºä½¿ç”¨é‡è¾¾åˆ°ä¸€å®šç¨‹åº¦åï¼Œæ‹’ç»æ–°çš„è¯·æ±‚è¿›å…¥ç­‰ï¼› ParamFlowSlotï¼šçƒ­ç‚¹å‚æ•°é™æµè§„åˆ™åˆ¤æ–­ FlowSoltï¼šæ™®é€šé™æµè§„åˆ™åˆ¤æ–­ DegradeSlotï¼šé™çº§è§„åˆ™åˆ¤æ–­ 2 ä¸ºä»€ä¹ˆè¦å­˜åœ¨NodeSelectorSlotå’ŒClusterBuilderSlotä¸¤ä¸ªæ’æ§½ï¼ŸDefaultNodeå’ŒClusterNodeæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ **DefaultNodeï¼š åŒä¸€ä»½èµ„æºï¼Œç»è¿‡ä¸åŒçš„é“¾è·¯è°ƒç”¨ï¼Œä¼šåˆ›å»ºä¸åŒçš„DefaultNodeï¼Œè®°å½•ä¸åŒé“¾è·¯è®¿é—®å½“å‰èµ„æºçš„ç»Ÿè®¡å…ƒæ•°æ® **ï¼Œå› ä¸ºæ•´ä¸ªSentinelæ˜¯æ”¯æŒâ€œæ ¹æ®é“¾è·¯é™æµâ€çš„ï¼Œæ‰€ä»¥è‚¯å®šè¦åˆ†å¼€ç»Ÿè®¡ï¼› ClusterNodeï¼š åŒä¸€ä»½èµ„æºï¼Œåœ¨æ•´ä¸ªç³»ç»Ÿä¸­åªä¼šåˆ›å»ºä¸€ä¸ªClusterNodeï¼Œè®°å½•æ‰€æœ‰å…¥å£è®¿é—®å½“å‰èµ„æºçš„ç»Ÿè®¡å…ƒæ•°æ®ï¼Œå› ä¸ºå¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦ç»Ÿè®¡è¯¥èµ„æºçš„æ•´ä½“ä½¿ç”¨æƒ…å†µã€‚ æ³¨æ„è¿™é‡Œçš„ç”¨è¯ï¼ŒDefaultNodeå’ŒClusterNodeéƒ½åªæ˜¯è´Ÿè´£è®°å½•ç»Ÿè®¡å…ƒæ•°æ®ï¼ŒçœŸæ­£çš„ç»Ÿè®¡å·¥ä½œç”±ä¹‹åçš„StatisticSlotè¿›è¡Œï¼Œå¦å¤–ParmFlowSlotä¼šè´Ÿè´£çƒ­ç‚¹å‚æ•°é™æµè¿™ç§ç‰¹æ®Šåœºæ™¯ä¸‹çš„æ•°æ®ç»Ÿè®¡ã€‚ï¼ˆçƒ­ç‚¹å‚æ•°é™æµçš„ç»Ÿè®¡ä¸ºä»€ä¹ˆè¦å•ç‹¬å‡ºæ¥ï¼Œåé¢åšé™æµç®—æ³•å®ç°çš„è®²è§£æ—¶å°±æ¸…æ¥šäº†ï¼‰ã€‚ 3 å¦‚ä½•è‡ªå®šä¹‰ä¸€ä¸ªSentinelèµ„æºï¼Ÿ@SentinelResourceæ³¨è§£ï¼Ÿ æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œå½“æˆ‘ä»¬è¦è‡ªå®šä¹‰sentinelèµ„æºæ—¶ï¼Œåªéœ€è¦ä½¿ç”¨@SentinelResourceæ³¨è§£å®šä¹‰å³å¯ï¼Œå¾ˆæ–¹ä¾¿ã€‚ è€Œä¸”Sentinelé»˜è®¤å°±å·²ç»å°† springmvc çš„ controller ä¸­çš„æ–¹æ³•æ³¨å†Œä¸ºsentinelèµ„æºäº†ï¼Œä½†æ˜¯è¿™äº›æ–¹æ³•å¹¶æ²¡æœ‰æ·»åŠ  @SentinelResource æ³¨è§£å‘€ï¼ å…¶å®@SentinelResourceåº•å±‚ä¹Ÿå°±æ˜¯é€šè¿‡AOP + Entry çš„æ–¹å¼æ¥æ‰‹åŠ¨æ³¨å†Œ Sentinelèµ„æºçš„ï¼š // èµ„æºåå¯ä½¿ç”¨ä»»æ„æœ‰ä¸šåŠ¡è¯­ä¹‰çš„å­—ç¬¦ä¸²ï¼Œæ¯”å¦‚æ–¹æ³•åã€æ¥å£åæˆ–å…¶å®ƒå¯å”¯ä¸€æ ‡è¯†çš„å­—ç¬¦ä¸²ã€‚ try (Entry entry = SphU.entry(&quot;resourceName&quot;)) { // è¢«ä¿æŠ¤çš„ä¸šåŠ¡é€»è¾‘ // do something here... } catch (BlockException ex) { // èµ„æºè®¿é—®é˜»æ­¢ï¼Œè¢«é™æµæˆ–è¢«é™çº§ // åœ¨æ­¤å¤„è¿›è¡Œç›¸åº”çš„å¤„ç†æ“ä½œ } SentinelResourceAspectåˆ‡é¢ç±»ï¼š @Aspect public class SentinelResourceAspect extends AbstractSentinelAspectSupport { @Pointcut(&quot;@annotation(com.alibaba.csp.sentinel.annotation.SentinelResource)&quot;) public void sentinelResourceAnnotationPointcut() { } // ç»å…¸AOPå®ç° @Around(&quot;sentinelResourceAnnotationPointcut()&quot;) public Object invokeResourceWithSentinel(ProceedingJoinPoint pjp) throws Throwable { Method originMethod = this.resolveMethod(pjp); SentinelResource annotation = (SentinelResource)originMethod.getAnnotation(SentinelResource.class); if (annotation == null) { throw new IllegalStateException(&quot;Wrong state for SentinelResource annotation&quot;); } else { String resourceName = this.getResourceName(annotation.value(), originMethod); EntryType entryType = annotation.entryType(); int resourceType = annotation.resourceType(); Entry entry = null; try { Object var18; try { // æ³¨å†Œå¯¹åº”çš„èµ„æº entry = SphU.entry(resourceName, resourceType, entryType, pjp.getArgs()); // æ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘ return pjp.proceed(); } catch (Exception e) { ...... } } finally { ...... } } } } æ‰€ä»¥ï¼Œé€šè¿‡Entryæ‰‹åŠ¨æ³¨å†Œèµ„æº å’Œ é€šè¿‡@SentinelResource æ³¨è§£è‡ªåŠ¨æ³¨å…¥èµ„æºï¼ŒåŸç†ä¸Šæ—¶ä¸€æ ·çš„ï¼Œéƒ½æ˜¯é€šè¿‡ SphU.entry(â€¦) æ–¹æ³•å®ç°ã€‚ 4 é“¾è·¯ä¸Šä¸‹æ–‡Context public class Context { private final String name; private DefaultNode entranceNode; private Entry curEntry; private String origin = &quot;&quot;; private final boolean async; } Contextä»£è¡¨è°ƒç”¨é“¾è·¯çš„ä¸Šä¸‹æ–‡ï¼Œè´¯ç©¿ä¸€æ¬¡é“¾è·¯è°ƒç”¨ä¸­çš„æ‰€æœ‰èµ„æºï¼ˆEntryï¼‰ï¼ŒåŸºäºThreadLocalå®ç°ï¼› Contextç»´æŠ¤è€…å…¥å£èŠ‚ç‚¹ï¼ˆentranceNodeï¼‰ã€å½“å‰èµ„æºèŠ‚ç‚¹ï¼ˆcurEntry â€”&gt;curNodeï¼‰ã€è°ƒç”¨æ¥æºoriginç­‰ä¿¡æ¯ï¼› åç»­æ‰€æœ‰çš„Slotæ’æ§½éƒ½å¯ä»¥é€šè¿‡contextæ‹¿åˆ°DefaultNode å’Œ ClusterNodeï¼Œä»è€Œå®Œæˆç»Ÿè®¡æˆ–åˆ¤æ–­é€»è¾‘ï¼› Contextåˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œä¼šåˆ›å»ºEntranceNodeï¼ŒcontextName å°±æ˜¯entranceNodeçš„åç§°ï¼› // åˆ›å»ºcontextï¼ŒåŒ…å«ä¸¤ä¸ªå‚æ•°ï¼šcontextåç§°ã€ æ¥æºåç§° ContextUtil.enter(&quot;contextName&quot;, &quot;originName&quot;); é»˜è®¤æƒ…å†µä¸‹ï¼ŒSentinelçš„entranceNodeæ˜¯sentinel_default_contextï¼Œå¦‚æœæˆ‘ä»¬è¦æƒ³åšé“¾è·¯é™æµï¼Œå°±å¿…é¡»å…³é—­â€œç»Ÿä¸€å…¥å£é…ç½®â€ï¼Œä»è€Œè®©æ¯ä¸€ä¸ªControlleræ–¹æ³•ä¸ºContextçš„å…¥å£ã€‚ public final static String CONTEXT_DEFAULT_NAME = &quot;sentinel_default_context&quot;; spring: cloud: sentinel: web-context-unify: false # å…³é—­contextç»Ÿä¸€å…¥å£é…ç½® äºŒ Sentinelæºç å‰–æâ€”â€”Contextçš„åˆå§‹åŒ– 1 spring-cloud-starter-alibaba-sentinel çš„ spring.factory ä¸­æœ‰ä¸¤ä¸ªç›¸å…³çš„è‡ªåŠ¨è£…é…ç±» ç”±äºï¼ŒContextçš„åˆå§‹åŒ–ï¼Œæ¶‰åŠåˆ°äº†å°†Controllerä¸­çš„æ–¹æ³•å®šä¹‰ä¸ºentranceNodeçš„è¿‡ç¨‹ï¼Œæ‰€ä»¥è‚¯å®šæ˜¯çœ‹ SentinelWebAutoConfiguration è¿™ä¸ªè‡ªåŠ¨è£…é…ç±»ï¼ 2 å‘ springmvc å¤„ç†é“¾ä¸­æ·»åŠ ä¸€ä¸ªSentinelçš„æ‹¦æˆªå™¨ @Configuration( proxyBeanMethods = false // Liteæ¨¡å¼ï¼Œå…³é—­Fullæ¨¡å¼ ) @ConditionalOnWebApplication( type = Type.SERVLET ) @ConditionalOnProperty( name = {&quot;spring.cloud.sentinel.enabled&quot;}, matchIfMissing = true ) @ConditionalOnClass({SentinelWebInterceptor.class}) @EnableConfigurationProperties({SentinelProperties.class}) public class SentinelWebAutoConfiguration implements WebMvcConfigurer { // é€šè¿‡å®ç° WebMvcConfigurer æ¥å£ï¼Œå…è®¸äº†æ‰‹åŠ¨å‘springmvcä¸­æ·»åŠ æ‹¦æˆªå™¨ Interceptor ...... // æ³¨å…¥æœ¬ç±»ä¸‹æ–‡å®šä¹‰çš„SentinelWebInterceptor @Autowired private Optional&lt;SentinelWebInterceptor&gt; sentinelWebInterceptorOptional; public SentinelWebAutoConfiguration() { } // æ·»åŠ  public void addInterceptors(InterceptorRegistry registry) { if (this.sentinelWebInterceptorOptional.isPresent()) { Filter filterConfig = this.properties.getFilter(); registry.addInterceptor((HandlerInterceptor)this.sentinelWebInterceptorOptional.get()) .order(filterConfig.getOrder()).addPathPatterns(filterConfig.getUrlPatterns()); } } // å‘ IOC å®¹å™¨ä¸­æ³¨å…¥ä¸€ä¸ª SentinelWebInterceptor æ‹¦æˆªå™¨ @Bean @ConditionalOnProperty( name = {&quot;spring.cloud.sentinel.filter.enabled&quot;}, matchIfMissing = true ) public SentinelWebInterceptor sentinelWebInterceptor(SentinelWebMvcConfig sentinelWebMvcConfig) { return new SentinelWebInterceptor(sentinelWebMvcConfig); } } 3 SentinelWebInterceptoræ‹¦æˆªå™¨çš„æ ¸å¿ƒæ–¹æ³• SentinelWebInterceptor ä¸­ä¼šå¯¹çˆ¶ç±» AbstractSentinelInterceptor ä¸­çš„æŠ½è±¡æ–¹æ³•åšå®ç°ï¼ˆæ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼‰ï¼š public class SentinelWebInterceptor extends AbstractSentinelInterceptor { // è·å–resourceNameï¼š // controllerä¸­è¯·æ±‚æ–¹æ³•çš„è·¯å¾„ï¼ˆèµ„æºï¼‰ï¼š/order/{orderId} protected String getResourceName(HttpServletRequest request) { Object resourceNameObject = request.getAttribute(HandlerMapping.BEST_MATCHING_PATTERN_ATTRIBUTE); if (resourceNameObject != null &amp;&amp; resourceNameObject instanceof String) { String resourceName = (String)resourceNameObject; UrlCleaner urlCleaner = this.config.getUrlCleaner(); if (urlCleaner != null) { resourceName = urlCleaner.clean(resourceName); } if (StringUtil.isNotEmpty(resourceName) &amp;&amp; this.config.isHttpMethodSpecify()) { resourceName = request.getMethod().toUpperCase() + &quot;:&quot; + resourceName; } return resourceName; } else { return null; } } // è·å–contextNameï¼š // å¦‚æœå¼€å¯äº†ç»Ÿä¸€å…¥å£é…ç½®ï¼Œåˆ™contextNameå°±æ˜¯é»˜è®¤çš„ç»Ÿä¸€å…¥å£ï¼šsentinel_spring_web_context // å¦‚æœå…³é—­äº†ç»Ÿä¸€å…¥å£é…ç½®ï¼Œåˆ™contextNameå°±æ˜¯å½“å‰èµ„æºçš„åç§°ï¼› protected String getContextName(HttpServletRequest request) { return this.config.isWebContextUnify() ? super.getContextName(request) : this.getResourceName(request); } } è€Œä½œä¸ºä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œæœ€é‡è¦çš„é€»è¾‘ï¼Œè‚¯å®šæ˜¯åœ¨ prehandler() ä¸­ï¼š public abstract class AbstractSentinelInterceptor implements HandlerInterceptor { public static final String SENTINEL_SPRING_WEB_CONTEXT_NAME = &quot;sentinel_spring_web_context&quot;; private static final String EMPTY_ORIGIN = &quot;&quot;; private final BaseWebMvcConfig baseWebMvcConfig; // å‰ç½®æ‹¦æˆªçš„æ ¸å¿ƒé€»è¾‘ public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { try { // è·å–èµ„æºåç§°ï¼Œä¸€èˆ¬æ˜¯controlleræ–¹æ³•çš„@RequestMappingè·¯å¾„ï¼Œä¾‹å¦‚/order/{orderId} String resourceName = this.getResourceName(request); if (StringUtil.isEmpty(resourceName)) { return true; } else if (this.increaseReferece(request, this.baseWebMvcConfig.getRequestRefName(), 1) != 1) { return true; } else { // ä»requestä¸­è·å–è¯·æ±‚æ¥æºï¼Œå°†æ¥åš æˆæƒè§„åˆ™ï¼ˆæ¥æºæ§åˆ¶ï¼‰ åˆ¤æ–­æ—¶ä¼šç”¨ String origin = this.parseOrigin(request); // è·å– contextNameï¼Œé»˜è®¤æ˜¯sentinel_spring_web_contextï¼› // å¦‚æœå…³é—­ç»Ÿä¸€å…¥å£ï¼Œé‚£å°±æ˜¯å½“å‰resourceName String contextName = this.getContextName(request); // åˆ›å»ºContextæ ¸å¿ƒæ–¹æ³• ContextUtil.enter(contextName, origin); // æ„å»ºProcessorSlotChainå¤„ç†å™¨æ’æ§½é“¾çš„æ ¸å¿ƒé€»è¾‘ Entry entry = SphU.entry(resourceName, 1, EntryType.IN); request.setAttribute(this.baseWebMvcConfig.getRequestAttributeName(), entry); return true; } } catch (BlockException var12) { BlockException e = var12; try { this.handleBlockException(request, response, e); } finally { ContextUtil.exit(); } return false; } } // å½“è¯·æ±‚ä½“ä¸šåŠ¡å¤„ç†å®Œæˆåï¼Œå…³é—­æ‰€æœ‰çš„èµ„æº public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception { if (this.increaseReferece(request, this.baseWebMvcConfig.getRequestRefName(), -1) == 0) { Entry entry = this.getEntryInRequest(request, this.baseWebMvcConfig.getRequestAttributeName()); if (entry == null) { ...Log... } else { this.traceExceptionAndExit(entry, ex); // entry.exit()é€€å‡º this.removeEntryInRequest(request); ContextUtil.exit(); // contextHolder.set(null); } } } } // private static ThreadLocal&lt;Context&gt; contextHolder = new ThreadLocal&lt;&gt;(); // ä¿å­˜contextçš„threadLocal 4ã€ContextUtil.enter(contextName, origin) åˆ›å»ºContextæ ¸å¿ƒæ–¹æ³•ï¼š // com.alibaba.csp.sentinel.context.ContextUtil#enter public static Context enter(String name, String origin) { // &quot;sentinel_default_context&quot;æ˜¯ä¸å…è®¸è¢«åˆ›å»ºçš„ if (Constants.CONTEXT_DEFAULT_NAME.equals(name)) { throw new ContextNameDefineException( &quot;The &quot; + Constants.CONTEXT_DEFAULT_NAME + &quot; can't be permit to defined!&quot;); } return trueEnter(name, origin); } | | // com.alibaba.csp.sentinel.context.ContextUtil#trueEnter protected static Context trueEnter(String name, String origin) { // å°è¯•è·å–contextï¼Œä¸€èˆ¬ä¸€ä¸ªæ–°çš„è¯·æ±‚åˆ°è¾¾åï¼Œè·å–contextè‚¯å®šä¸ºnull Context context = contextHolder.get(); // åˆ¤ç©º if (context == null) { // å¦‚æœä¸ºç©ºï¼Œå¼€å§‹åˆå§‹åŒ– Map&lt;String, DefaultNode&gt; localCacheNameMap = contextNameNodeMap; // å°è¯•è·å–å…¥å£èŠ‚ç‚¹ DefaultNode node = localCacheNameMap.get(name); if (node == null) { LOCK.lock(); try { node = contextNameNodeMap.get(name); if (node == null) { // åŒé‡æ£€æµ‹é” // å…¥å£èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆå§‹åŒ–å…¥å£èŠ‚ç‚¹ EntranceNode node = new EntranceNode(new StringResourceWrapper(name, EntryType.IN), null); // æ·»åŠ å…¥å£èŠ‚ç‚¹åˆ° ROOTï¼Œæ‰€æœ‰çš„èŠ‚ç‚¹å…±ç”¨ä¸€ä¸ªROOTæ ¹èŠ‚ç‚¹ Constants.ROOT.addChild(node); // å°†å…¥å£èŠ‚ç‚¹æ”¾å…¥ç¼“å­˜ï¼ˆä¸‹æ¬¡è¯·æ±‚æ—¶å€™ï¼Œæ ¹æ®contextNameè·å–ï¼Œå¯ç›´æ¥ä½¿ç”¨ï¼‰ Map&lt;String, DefaultNode&gt; newMap = new HashMap&lt;&gt;(contextNameNodeMap.size() + 1); newMap.putAll(contextNameNodeMap); newMap.put(name, node); contextNameNodeMap = newMap; // CopyOnWrite } } finally { LOCK.unlock(); } } // åˆ›å»ºContextï¼Œå‚æ•°ä¸ºï¼šå…¥å£èŠ‚ç‚¹ å’Œ contextName context = new Context(node, name); // è®¾ç½®è¯·æ±‚æ¥æº origin context.setOrigin(origin); // å°†contextæ”¾å…¥ThreadLocal contextHolder.set(context); } // è¿”å› return context; } ç”±æ­¤æˆ‘ä»¬å¯ä»¥å¾—å‡ºé‡è¦ç»“è®ºï¼š åœ¨æ¯ä¸€ä¸ªè¯·æ±‚åˆ°è¾¾æ—¶ï¼ŒSentinelçš„æ‹¦æˆªå™¨éƒ½ä¼šä¸ºæœ¬æ¬¡è¯·æ±‚å°è£…ä¸€ä¸ªâ€œé“¾è·¯ä¸Šä¸‹æ–‡contextâ€ï¼Œç„¶åæ”¾å…¥åˆ°ThreadLocalä¸­ï¼Œä¾¿äºè¯·æ±‚åœ¨åé¢çš„å¤„ç†è¿‡ç¨‹ä¸­å–ç”¨ï¼› é»˜è®¤æƒ…å†µä¸‹ï¼Œâ€œç»Ÿä¸€å…¥å£é…ç½®å¼€å¯â€ï¼Œâ€œé“¾è·¯ä¸Šä¸‹æ–‡contextâ€ä»¥sentinel-spring-web-context å‘½åï¼› å¦‚æœå…³é—­äº†â€œç»Ÿä¸€å…¥å£é…ç½®â€ï¼Œâ€œé“¾è·¯ä¸Šä¸‹æ–‡contextâ€å°†ä»¥æœ¬æ¬¡è¯·æ±‚å¯¹åº”çš„controlleræ–¹æ³•çš„ @RequestMapping() çš„å€¼å‘½åï¼Œå¦‚â€œ/order/{orderId}â€ï¼› ç”±äºcontextæ˜¯æ”¾åœ¨Threadä¸­çš„ï¼Œæ‰€ä»¥å½“æœ¬æ¬¡è¯·æ±‚ç»“æŸåï¼Œcontextå°±ä¼šè¢«é‡Šæ”¾ï¼Œä¸‹æ¬¡è¯·æ±‚éœ€è¦é‡æ–°åˆ›å»ºï¼›ï¼ˆcontextç”Ÿå‘½å‘¨æœŸä¸ºrequestï¼‰ ä½†æ˜¯å…¥å£ entranceNode å´æ˜¯æ”¾åœ¨ç¼“å­˜HashMapä¸­çš„ï¼Œæ‰€ä»¥ä¸‹ä¸€æ¬¡æ–°çš„è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œå°±æ²¡æœ‰å¿…è¦å†é‡æ–°åˆ›å»ºäº†ï¼›(entranceNodeç”Ÿå‘½å‘¨æœŸä¸ºåº”ç”¨çº§) åˆ›å»ºå…¥å£æ–¹æ³• entranceNode æ—¶ï¼Œä½¿ç”¨äº† åŒé‡æ£€æµ‹é” + CopyOnWrite ï¼Œå› ä¸ºå­˜åœ¨å¤šä¸ªè¯·æ±‚çº¿ç¨‹å¹¶å‘æƒ…å†µï¼› åˆ›å»º context è¿‡ç¨‹ä¸éœ€è¦è€ƒè™‘å¤šçº¿ç¨‹å®‰å…¨ ï¼ŒåŸå› ä¹Ÿæ˜¯å› ä¸º contextæ—¶çº¿ç¨‹å†…çš„ï¼Œå•çº¿ç¨‹ ã€‚ ä¸‰ Sentinelæ ¸å¿ƒæºç ä¹‹ProcessorSlotChainçš„æ„å»º 1 å…¥å£æ–¹æ³•ï¼Œæ­£å¼ä¸Šæ–‡æ‹¦æˆªå™¨ä¸­åˆ›å»ºContextä¹‹åçš„æ–¹æ³• Entry entry = SphU.entry(resourceName, 1, EntryType.IN); è¯¥æ–¹æ³•ï¼Œå°†â€œä¸€è„‰å•ä¼ â€è°ƒç”¨åˆ°ä»¥ä¸‹æ–¹æ³• entryWithPriority() ï¼š private Entry entryWithPriority(ResourceWrapper resourceWrapper, int count, boolean prioritized, Object... args) throws BlockException { // è·å– Context Context context = ContextUtil.getContext(); if (context == null) { // Using default context. context = InternalContextUtil.internalEnter(Constants.CONTEXT_DEFAULT_NAME); } // è·å– Slotæ‰§è¡Œé“¾ï¼ŒåŒä¸€ä¸ªèµ„æºï¼ˆå¦‚ï¼š/order/{orderId}ï¼‰ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ‰§è¡Œé“¾ï¼Œæ”¾å…¥ç¼“å­˜ ProcessorSlot&lt;Object&gt; chain = lookProcessChain(resourceWrapper); // åˆ›å»º Entryï¼Œå¹¶å°† resourceã€chainã€context è®°å½•åœ¨ Entryä¸­ Entry e = new CtEntry(resourceWrapper, chain, context); try { // æ‰§è¡Œ slotChain chain.entry(context, resourceWrapper, null, count, prioritized, args); } catch (BlockException e1) { // å¦‚æœæ‰§è¡Œ slotChain è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œä¹Ÿç›´æ¥å°†å¯¹åº”çš„èµ„æºé‡Šæ”¾ e.exit(count, args); ...... } return e; } 2 lookProcessChain() åˆ›å»ºæˆ–è·å–èµ„æºå¯¹åº”çš„ProcessorSlotChainçš„æ–¹æ³• // com.alibaba.csp.sentinel.CtSph#lookProcessChain ProcessorSlot&lt;Object&gt; lookProcessChain(ResourceWrapper resourceWrapper) { // ä»ç¼“å­˜chainMapä¸­è·å– ProcessorSlotChain chain = chainMap.get(resourceWrapper); if (chain == null) { synchronized (LOCK) { chain = chainMap.get(resourceWrapper); if (chain == null) { // åˆæ˜¯åŒé‡æ£€æµ‹é” // Entry size limit. if (chainMap.size() &gt;= Constants.MAX_SLOT_CHAIN_SIZE) { return null; } // å…¥å£æœ¬èµ„æºå¯¹åº”çš„chainä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ chain = SlotChainProvider.newSlotChain(); Map&lt;ResourceWrapper, ProcessorSlotChain&gt; newMap = new HashMap&lt;ResourceWrapper, ProcessorSlotChain&gt;( chainMap.size() + 1); newMap.putAll(chainMap); newMap.put(resourceWrapper, chain); chainMap = newMap; // åˆæ˜¯CopyOnWrite } } } return chain; } è™½ç„¶æ¯ä¸€æ¬¡è¯·æ±‚çš„ResourceWrapperéƒ½æ˜¯æ–°newçš„ï¼Œä½†æ˜¯ç”±äºå®ƒçš„hashCode() å’Œ equals() æ–¹æ³•ï¼Œåªä¼šå¯¹æ¯” name; public abstract class ResourceWrapper { protected final String name; protected final EntryType entryType; protected final int resourceType; @Override public int hashCode() { return getName().hashCode(); } @Override public boolean equals(Object obj) { if (obj instanceof ResourceWrapper) { ResourceWrapper rw = (ResourceWrapper)obj; return rw.getName().equals(getName()); } return false; } } æ‰€ä»¥ï¼Œå¾—å‡ºç»“è®ºï¼š Sentinelä¼šä¸ºæ‰€æœ‰çš„èµ„æºï¼Œä»¥èµ„æºåä¸ºåŒºåˆ†ï¼Œåˆ›å»ºå¯¹åº”çš„ProcessorSlotChain ï¼Œå¹¶ç¼“å­˜åˆ°chainMapä¸­ï¼› ProcessorSlotChainåº”ç”¨çº§æœ‰æ•ˆï¼Œåˆ›å»ºåï¼Œä¸‹æ¬¡ç›¸åŒåç§°çš„Resourceè¯·æ±‚è¿›å…¥æ—¶ï¼Œå°†ä¸éœ€è¦å†æ¬¡åˆ›å»ºchainï¼› 3 SlotChainProvider.newSlotChain() å¤„ç†å™¨æ’æ§½é“¾çš„æ„å»ºè¿‡ç¨‹ // com.alibaba.csp.sentinel.slotchain.SlotChainProvider#newSlotChain public static ProcessorSlotChain newSlotChain() { if (slotChainBuilder != null) { return slotChainBuilder.build(); } // é»˜è®¤è‚¯å®šæ˜¯å¾—åˆ°ä¸€ä¸ª DefaultSlotChainBuilder slotChainBuilder = SpiLoader.loadFirstInstanceOrDefault(SlotChainBuilder.class, DefaultSlotChainBuilder.class); if (slotChainBuilder == null) { slotChainBuilder = new DefaultSlotChainBuilder(); } else { ...... } return slotChainBuilder.build(); } public class DefaultSlotChainBuilder implements SlotChainBuilder { @Override public ProcessorSlotChain build() { // åˆ›å»ºä¸€ä¸ª DefaultProcessorSlotChain ProcessorSlotChain chain = new DefaultProcessorSlotChain(); // è¯¥æ–¹æ³•ä¼šé€šè¿‡spiæœºåˆ¶ä» \\META-INF\\services\\ç›®å½•ä¸‹ï¼ŒåŠ è½½æ‰€æœ‰çš„ProcessorSlotç±» List&lt;ProcessorSlot&gt; sortedSlotList = SpiLoader.loadPrototypeInstanceListSorted(ProcessorSlot.class); for (ProcessorSlot slot : sortedSlotList) { if (!(slot instanceof AbstractLinkedProcessorSlot)) { continue; } // æœ€ç»ˆåˆ›å»ºçš„ chain.addLast((AbstractLinkedProcessorSlot&lt;?&gt;) slot); } return chain; } } 4 SpiLoader.loadPrototypeInstanceListSorted(ProcessorSlot.class)é€šè¿‡SPIæœºåˆ¶åŠ è½½æ‰€æœ‰çš„ProcessorSlotæ’æ§½ç±» // com.alibaba.csp.sentinel.util.SpiLoader#loadPrototypeInstanceListSorted public static &lt;T&gt; List&lt;T&gt; loadPrototypeInstanceListSorted(Class&lt;T&gt; clazz) { try { // Not use SERVICE_LOADER_MAP, to make sure the instances loaded are different. ServiceLoader&lt;T&gt; serviceLoader = ServiceLoaderUtil.getServiceLoader(clazz); List&lt;SpiOrderWrapper&lt;T&gt;&gt; orderWrappers = new ArrayList&lt;&gt;(); // SPIæœºåˆ¶ä¼šä»æœ¬åœ°çš„ META-INF/services/ ç›®å½•ä¸‹åŠ è½½ ProcessorSlot åˆ—è¡¨ï¼› for (T spi : serviceLoader) { int order = SpiOrderResolver.resolveOrder(spi); // Since SPI is lazy initialized in ServiceLoader, we use online sort algorithm here. SpiOrderResolver.insertSorted(orderWrappers, spi, order); } List&lt;T&gt; list = new ArrayList&lt;&gt;(orderWrappers.size()); for (int i = 0; i &lt; orderWrappers.size(); i++) { list.add(orderWrappers.get(i).spi); } return list; } catch (Throwable t) { t.printStackTrace(); return new ArrayList&lt;&gt;(); } } æœ¬åœ° META/services/ ç›®å½•ä¸‹çš„ ProcessorSlotæ–‡ä»¶å®šä¹‰äº†9ä¸ªæ’æ§½ï¼ 5 æœ€ç»ˆæ„å»ºæˆçš„ProcessorSlotChainçš„ç»“æ„ é¦–å…ˆï¼Œæ‰€æœ‰çš„9å¤§ProcessorSlotéƒ½ç»§æ‰¿äºä¸€ä¸ªAbstractLinkedProcessorSlotç±»ï¼š public abstract class AbstractLinkedProcessorSlot&lt;T&gt; implements ProcessorSlot&lt;T&gt; { private AbstractLinkedProcessorSlot&lt;?&gt; next = null; // fireEntryçš„ä½œç”¨ä¸»è¦å°±æ˜¯è®©è¯·æ±‚æµè½¬åˆ°ä¸‹ä¸€ä¸ªProcessorSlot(å¦‚æœå­˜åœ¨çš„è¯) @Override public void fireEntry(Context context, ResourceWrapper resourceWrapper, Object obj, int count, boolean prioritized, Object... args) throws Throwable { if (next != null) { next.transformEntry(context, resourceWrapper, obj, count, prioritized, args); } } // æ‰€æœ‰ProcessorSlotçš„å…¥å£æ–¹æ³•ï¼Œå…¶ä¸­ä¼šé€šè¿‡æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œè°ƒç”¨å„è‡ªçš„entryå¤„ç†é€»è¾‘ // è€Œå†æ‰€æœ‰çš„å¤„ç†é€»è¾‘çš„æœ€åï¼Œéƒ½ä¼šå†è°ƒä¸€æ¬¡ fireEntry() æ–¹æ³• void transformEntry(Context context, ResourceWrapper resourceWrapper, Object o, int count, boolean prioritized, Object... args) throws Throwable { T t = (T)o; entry(context, resourceWrapper, t, count, prioritized, args); } } ç»è¿‡ next æŒ‡å‘ï¼Œæœ€ç»ˆæ„å»ºå‡ºæ¥çš„ DefaultProcessorSlotChain å¦‚ä¸‹ï¼š ç»¼ä¸Šæ€»ç»“ï¼š Sentinelä¼š ä¸ºæ‰€æœ‰çš„èµ„æºï¼Œä»¥èµ„æºåä¸ºåŒºåˆ†ï¼Œåˆ›å»ºå„è‡ªçš„DefaultProcessorSlotChainï¼Œæ”¾åœ¨ç¼“å­˜ ä¸­ï¼› DefaultProcessorSlotChainçš„ æ¯ä¸€ä¸ªProcessorSlotæ’æ§½éƒ½æ˜¯é€šè¿‡SPIæœºåˆ¶ä» META/services/ ç›®å½•ä¸‹åŠ è½½çš„ ï¼› æ¯ä¸€ä¸ªProcessorSlot å…¶å®æ˜¯ä¸€ä¸ª AbstractLinkedProcessorSlot æŠ½è±¡é“¾è¡¨å¤„ç†å™¨æ’æ§½ï¼Œæœ‰ä¸€ä¸ªnextå±æ€§ï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªSlot ï¼Œå½“æŸä¸€ä¸ªSlotæ‰§è¡Œå®Œåï¼Œä¼šè°ƒç”¨ fireEntry() æ–¹æ³•ï¼Œå°†è¯·æ±‚è½¬åˆ°ä¸‹ä¸€ä¸ªSlotç»§ç»­æ‰§è¡Œã€‚ æœ€ç»ˆå®Œæˆè´£ä»»é“¾ä¸Šæ‰€æœ‰ProcessorSlotçš„é€»è¾‘ï¼ å›› ä¹å¤§ProcessorSlotå¤„ç†å™¨æ’æ§½çš„å·¥ä½œåŸç† LogSlotæ’æ§½æ˜¯ä¸€ä¸ªè¾¹ç¼˜æ’æ§½ï¼Œåšä¸€äº›æ—¥å¿—è®°å½•ï¼Œæ‰€ä»¥ä¸ç®—é‡è¦ï¼Œæ’é™¤åœ¨å¤–åï¼Œå°±å‰©8å¤§æ’æ§½ï¼Œä¹Ÿå°±æ˜¯&lt;ç¬¬ä¸€ç« èŠ‚&gt;åˆ—å‡ºçš„å…«å¤§æ’æ§½ï¼š æ•°æ®ç»Ÿè®¡éƒ¨åˆ† + è§„åˆ™åˆ¤æ–­éƒ¨åˆ† æ•°æ®ç»Ÿè®¡ï¼š NodeSelectorSlotï¼šè´Ÿè´£æ„å»ºç°‡ç‚¹é“¾è·¯ä¸­çš„å„ä¸ªèŠ‚ç‚¹ï¼ˆDefaultNodeï¼‰ï¼Œå½¢æˆNodeTree ClusterBuilderSlotï¼šè´Ÿè´£æ„å»ºæŸä¸ªèµ„æºçš„ClusterNodeï¼ˆå…·ä½“çš„DefaultNodeå’ŒClusterNodeçš„åŒºåˆ«è§ä¸‹æ–‡ï¼‰ StatisticSlotï¼šè´Ÿè´£å®æ—¶ç»Ÿè®¡è¯·æ±‚çš„å„ç§è°ƒç”¨ä¿¡æ¯ï¼Œå¦‚æ¥æºä¿¡æ¯ã€è¯·æ±‚æ¬¡æ•°ã€è¿è¡Œä¿¡æ¯ç­‰ï¼› è§„åˆ™åˆ¤æ–­ï¼š AuthoritySlotï¼šæˆæƒè§„åˆ™åˆ¤æ–­ï¼ˆæ¥æºæ§åˆ¶ï¼‰ SystemSlotï¼šç³»ç»Ÿä¿æŠ¤è§„åˆ™åˆ¤æ–­ï¼Œå½“ç³»ç»Ÿèµ„æºä½¿ç”¨é‡è¾¾åˆ°ä¸€å®šç¨‹åº¦åï¼Œæ‹’ç»æ–°çš„è¯·æ±‚è¿›å…¥ç­‰ï¼› ParamFlowSlotï¼šçƒ­ç‚¹å‚æ•°é™æµè§„åˆ™åˆ¤æ–­ FlowSoltï¼šæ™®é€šé™æµè§„åˆ™åˆ¤æ–­ DegradeSlotï¼šé™çº§è§„åˆ™åˆ¤æ–­ å…¶å®ï¼Œå½“Sentinelçš„æ•´ä½“æ¶æ„ï¼Œå’Œè°ƒç”¨é€»è¾‘æ¢³ç†æ¸…æ¥šåï¼Œæ¯ä¸€ä¸ªè´£ä»»é“¾èŠ‚ç‚¹çš„å¤„ç†é€»è¾‘å°±å¾ˆç®€å•äº† ","link":"https://tianxiawuhao.github.io/xdN8U8BuX/"},{"title":"Sentinelé™æµç†”æ–­é™çº§â€”â€”çŸ¥è¯†ç‚¹æ€»ç»“","content":" Sentineiå®˜ç½‘åœ°å€ï¼šhttps://sentinelguard.io/zh-cn/docs/quick-start.html Sentinel Githubåœ°å€ï¼šhttps://github.com/alibaba/Sentinel/wiki Sentinelç”Ÿäº§çº§ä½¿ç”¨ï¼šhttps://github.com/alibaba/Sentinel/wiki/åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨-Sentinel ä¸€ Sentinelæ˜¯ä»€ä¹ˆ,ä¸ºä»€ä¹ˆè¦å¼•å…¥Sentinel 1 ä»€ä¹ˆæ˜¯â€œæœåŠ¡é›ªå´©â€ï¼Ÿ åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå­˜åœ¨ç€å¤§é‡çš„æœåŠ¡é—´è°ƒç”¨ï¼Œæœ‰æ—¶å€™ï¼Œç”±äºæŸä¸ªæœåŠ¡å‘ç”Ÿäº†æ•…éšœï¼Œè€Œå¯¼è‡´è°ƒç”¨å®ƒçš„æœåŠ¡çš„èµ„æºå¾—ä¸åˆ°æ­£å¸¸é‡Šæ”¾ï¼Œä»è€Œä¹Ÿå‘ç”Ÿæ•…éšœï¼Œæ•…éšœä¸æ–­ä¼ æ’­ï¼Œæœ€ç»ˆå¯¼è‡´æ•´ä¸ªå¾®æœåŠ¡æ— æ³•å¯¹å¤–æä¾›æœåŠ¡ï¼Œè¿™å°±å‘ç”Ÿäº†â€œæœåŠ¡é›ªå´©â€ï¼ 2 â€œæœåŠ¡é›ªå´©â€å¦‚ä½•è§£å†³ï¼Ÿ è§£å†³â€œæœåŠ¡é›ªå´©â€çš„æ ¸å¿ƒç‚¹æœ‰2ä¸ªï¼šå°½é‡æ§åˆ¶æµé‡ï¼Œä¸è¦è®©æœåŠ¡å› ä¸ºè¿‡è½½è¿˜å‡ºç°æ•…éšœï¼›å½“ä¸€ä¸ªæœåŠ¡å·²ç»å‡ºç°æ•…éšœæ—¶ï¼Œä¸è¦è®©æ•…éšœåœ¨å¾®æœåŠ¡æ•´ä¸ªè°ƒç”¨é“¾è·¯ä¸­è¿›è¡Œä¼ æ’­ï¼ é’ˆå¯¹ä¸Šé¢ä¸¤ç‚¹ï¼Œâ€œæœåŠ¡é›ªå´©â€å°±æœ‰äº†å¸¸è§çš„2å¤§ç±»è§£å†³æ–¹æ¡ˆï¼š æµé‡æ§åˆ¶ï¼Œé¿å…å‡ºç°æ•…éšœï¼š æµé‡æ§åˆ¶ï¼šåœ¨å¾®æœåŠ¡è°ƒç”¨é“¾è·¯çš„å„ä¸ªæ ¸å¿ƒèµ„æºç‚¹ï¼Œè¿›è¡Œæµé‡æ§åˆ¶ï¼Œè¶…å‡ºçš„æµé‡ç›´æ¥ä¸è¦æ”¾è¡Œï¼Œä»¥å¯¹ç›®æ ‡èµ„æºè¿›è¡Œç›´æ¥ä¿æŠ¤ï¼ å‡ºç°æ•…éšœæ—¶ï¼Œé˜²æ­¢æ•…éšœä¼ æ’­ï¼š è¶…æ—¶å¤„ç†ï¼šè®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œè¶…è¿‡è®¾å®šæ—¶é—´å°±è¿”å›æŠ¥é”™ä¿¡æ¯ï¼Œåšå¯¹åº”å¤„ç†ï¼Œé˜²æ­¢â€œæ— ä¼‘æ­¢â€ç­‰å¾…ï¼ æœåŠ¡éš”ç¦»ï¼šé™å®šæ¯ä¸ªä¸šåŠ¡èƒ½ä½¿ç”¨çš„çº¿ç¨‹æ•°ï¼Œé¿å…è€—å°½æ•´ä¸ªæœåŠ¡çš„æ‰€æœ‰çº¿ç¨‹èµ„æºï¼Œä¿æŠ¤å…¶ä»–ä¸šåŠ¡ï¼ ç†”æ–­é™çº§ï¼šé€šè¿‡æ–­è·¯å™¨ç»Ÿè®¡æœåŠ¡è°ƒç”¨çš„â€œå¼‚å¸¸æ•°â€æˆ–â€œå¼‚å¸¸æ¯”ä¾‹â€ï¼Œå¦‚æœè¶…å‡ºè®¾å®šé˜ˆå€¼ï¼Œåˆ™ç›´æ¥ç†”æ–­ï¼Œåç»­ä¸€å®šæ—¶é—´å†…çš„è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œç›´æ¥è¿”å›é™çº§å¤„ç†çš„ç»“æœï¼Œè€Œä¸çœŸæ­£å»è°ƒç”¨ç›®æ ‡æœåŠ¡ï¼ è€Œä¸Šé¢æ‰€è¯´çš„è¿™ä¸€ç³»åˆ—è§£å†³æ–¹æ¡ˆï¼ŒSentineléƒ½ä¸ºæˆ‘ä»¬æä¾›äº†å®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©Sentinelï¼ 3 é˜¿é‡Œçš„Sentinelå’Œç½‘é£çš„Hystrixçš„å¯¹æ¯”ï¼Ÿ å…¶å®å¾ˆæ˜æ˜¾ï¼ŒSentinelæ¯”Hystrixå¼ºå¤§å¾ˆå¤šï¼Œè€Œä¸”Hystrixå·²ç»è¿›å…¥ç»´æŠ¤æœŸä¸å†æ›´æ–°äº†ï¼Œä»¥åçš„å¾®æœåŠ¡é¡¹ç›®ä¸­è‚¯å®šæ˜¯é€‰æ‹©Sentinelï¼ äºŒ Sentinelçš„ç®€å•ä½¿ç”¨å’Œ é¦–å…ˆè™½ç„¶Sentinelæ˜¯ä½œä¸ºSpringCloud Alibabaçš„é‡è¦ç»„ä»¶è€Œå‡ºåï¼Œä½†æ˜¯å¹¶ä¸æ˜¯å¼ºä¾èµ–äºSpringCloud Alibabaï¼ ç‹¬ç«‹ä½¿ç”¨Sentinelæ–‡æ¡£ï¼šhttps://sentinelguard.io/zh-cn/docs/quick-start.html åœ¨spring-cloud-alibabaæ¡†æ¶ä¸­ä½¿ç”¨ï¼šhttps://github.com/alibaba/spring-cloud-alibaba/wiki/Sentinel 1 åœ¨spring-cloud-alibabaæ¡†æ¶ä¸­çš„ç®€å•ä½¿ç”¨Sentinel å¼•å…¥ä¾èµ–starterï¼š &lt;dependency&gt; &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt; &lt;/dependency&gt; å¯åŠ¨Sentinel Dashboardæ§åˆ¶å°ï¼š https://sentinelguard.io/zh-cn/docs/dashboard.html # Sentinelçš„å¯åŠ¨éå¸¸ç®€å•ï¼Œjava -jar sentinel-dashboard.jar è¿è¡Œå³å¯ï¼š java -Dserver.port=8080 -Dcsp.sentinel.dashboard.server=localhost:8080 -Dproject.name=sentinel-dashboard -jar sentinel-dashboard.jar åœ¨æˆ‘ä»¬çš„é¡¹ç›®æ–‡ä»¶ä¸­é…ç½®sentinel-dashboardæ§åˆ¶å°çš„åœ°å€ï¼š spring: cloud: sentinel: transport: dashboard: localhost:8080 2 å¼€å¯Sentinelå¯¹Feignè°ƒç”¨çš„æ”¯æŒ é™¤äº†ä¸Šé¢çš„ä¾èµ–å’Œé…ç½®å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¢åŠ ä¸€ä¸‹é…ç½®ï¼š å¦‚æœæˆ‘ä»¬å¼•å…¥çš„Feignæ˜¯é€šè¿‡ spring-cloud-starter-openfeign å¼•å…¥Feignçš„ï¼Œé‚£ä¹ˆ Sentinel starter ä¸­çš„è‡ªåŠ¨é…ç½®ç±»å°±ä¼šç”Ÿæ•ˆï¼ æ­¤æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ application.yml é…ç½®æ–‡ä»¶ä¸­å¼€å¯ Sentinel å¯¹ Feign çš„æ”¯æŒå³å¯ï¼š feign: sentinel: enabled: true # å¼€å¯feignå¯¹sentinelçš„æ”¯æŒ 3 Sentinel Dashboard çš„é…ç½®æŒä¹…åŒ–åˆ° Nacos é…ç½®ä¸­å¿ƒ https://github.com/alibaba/Sentinel/wiki/åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨-Sentinel Sentinel Dashboardä¸­çš„æ‰€æœ‰é…ç½®åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œåˆ·æ–°åå°±ä¼šä¸¢å¤±ï¼Œé‚£ä¹ˆå®é™…ç”Ÿäº§ä¸­è‚¯å®šæ˜¯å¯å…è®¸çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»è¦æƒ³åŠæ³•å°†Sentinelçš„é…ç½®æŒä¹…åŒ–ï¼› è€Œæ­£å¥½Nacoså°±æä¾›äº†é…ç½®çš„â€œæŒä¹…åŒ–â€ä¸â€œç›‘å¬æœºåˆ¶â€ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±é€‰æ‹©é€šè¿‡ Nacos å®Œæˆ Sentinel çš„é…ç½®æŒä¹…åŒ–ï¼ï¼ˆpushæ¨¡å¼ï¼Œä¹Ÿæ˜¯ç”Ÿäº§ä¸­æœ€å¸¸ç”¨çš„ï¼‰ åœ¨é¡¹ç›®çš„pom.xmlä¸­å¢åŠ  sentinel-datasource-nacos çš„ä¾èµ–ï¼Œå¼€å¯å¯¹nacosçš„é…ç½®ä¸­å¿ƒçš„ç›‘å¬ï¼š &lt;dependency&gt; &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt; &lt;artifactId&gt;sentinel-datasource-nacos&lt;/artifactId&gt; &lt;/dependency&gt; åœ¨ application.yml ä¸­å¢åŠ  sentinel çš„æ•°æ®æºé…ç½®ï¼š spring: application: name: orderservice cloud: sentinel: transport: dashboard: localhost:8080 # sentinelæ§åˆ¶å°åœ°å€ web-context-unify: false # å…³é—­contextæ•´åˆ datasource: flow: nacos: server-addr: localhost:8848 # nacosåœ°å€ dataId: orderservice-flow-rules groupId: SENTINEL_GROUP rule-type: flow # è¿˜å¯ä»¥æ˜¯ï¼šdegradeã€authorityã€param-flow feign: sentinel: enabled: true # å¼€å¯feignå¯¹sentinelçš„æ”¯æŒ 4 Sentinelçš„ä¸‰ç§è§„åˆ™é…ç½®ç®¡ç†æ¨¡å¼ åŸå§‹æ¨¡å¼ï¼šå¦‚æœæˆ‘ä»¬ç®€å•ä½¿ç”¨Dashboardï¼Œä¸åšä»»ä½•ä¿®æ”¹ï¼Œå°±æ˜¯é‡‡ç”¨çš„è¿™ç§æ¨¡å¼ï¼š â€‹ å®¢æˆ·ç«¯åœ¨å¯åŠ¨æ—¶ï¼Œä¼šåŒæ—¶å¯åŠ¨ä¸€ä¸ªServerSocketï¼Œé»˜è®¤ç«¯å£ä¸ºï¼š8719ï¼ˆå¦‚æœè¢«å ç”¨ï¼Œå°è¯•3æ¬¡å+1ï¼Œç»§ç»­å°è¯•ï¼‰ï¼Œå‘Šè¯‰Dashboardï¼Œå½“Dashboardä¸­çš„é…ç½®æœ‰å˜åŒ–æ—¶ï¼Œé€šè¿‡APIæ¥å£å‘Šè¯‰æˆ‘ä»¬çš„æœåŠ¡ä¸­çš„Sentinelå®¢æˆ·ç«¯ï¼ŒSentinelå°†è¿™äº›é…ç½®å­˜åˆ°å†…å­˜ä¸­ï¼ŒæœåŠ¡é‡å¯å³ä¸¢å¤±ï¼Œè¯¥æ¨¡å¼åªèƒ½ç”¨äºç®€å•æµ‹è¯•ï¼Œä¸€å®šä¸èƒ½ç”¨äºç”Ÿäº§ç¯å¢ƒï¼ å¯ä»Envç±»ä¸€è·¯å‘ä¸‹ç ”ç©¶ï¼Œå°±å¯ä»¥çŸ¥é“é€»è¾‘ï¼š public class Env { public static final Sph sph = new CtSph(); static { // If init fails, the process will exit. InitExecutor.doInit(); } } Pullæ¨¡å¼ï¼šSentinelå®¢æˆ·ç«¯ï¼ˆæˆ‘ä»¬çš„åº”ç”¨æœåŠ¡ï¼‰å‘è¿œç«¯çš„é…ç½®ç®¡ç†ä¸­å¿ƒä¸»åŠ¨å®šæœŸè½®è¯¢æ‹‰å–è§„åˆ™ï¼Œæ›´æ–°åˆ°å†…å­˜ç¼“å­˜ï¼ŒåŒæ—¶å†™å…¥åˆ°æœ¬åœ°ç£ç›˜æ–‡ä»¶ï¼Œè¿™æ ·çš„è¯ä¹Ÿå¯ä»¥å®ç°æŒä¹…åŒ–ï¼Œä½†æ˜¯æ•°æ®ä¸€è‡´æ€§ã€å®æ—¶æ€§ä¸å¤ªå¥½ï¼Œè€Œä¸”å¤§é‡çš„è½®è¯¢å¯¹æœåŠ¡æ€§èƒ½åˆæœ‰å½±å“ï¼ // éœ€è¦åœ¨å®¢æˆ·ç«¯æ³¨å†Œæ•°æ®æºï¼š // â€”å°†å¯¹åº”çš„è¯»æ•°æ®æºæ³¨å†Œè‡³å¯¹åº”çš„ RuleManagerï¼Œ // â€”â€”å°†å†™æ•°æ®æºæ³¨å†Œè‡³ transport çš„ WritableDataSourceRegistry ä¸­ã€‚ public class FileDataSourceInit implements InitFunc { @Override public void init() throws Exception { String flowRulePath = &quot;xxx&quot;; ReadableDataSource&lt;String, List&lt;FlowRule&gt;&gt; ds = new FileRefreshableDataSource&lt;&gt;( flowRulePath, source -&gt; JSON.parseObject(source, new TypeReference&lt;List&lt;FlowRule&gt;&gt;() {}) ); // å°†å¯è¯»æ•°æ®æºæ³¨å†Œè‡³ FlowRuleManager. FlowRuleManager.register2Property(ds.getProperty()); WritableDataSource&lt;List&lt;FlowRule&gt;&gt; wds = new FileWritableDataSource&lt;&gt;(flowRulePath, this::encodeJson); // å°†å¯å†™æ•°æ®æºæ³¨å†Œè‡³ transport æ¨¡å—çš„ WritableDataSourceRegistry ä¸­. // è¿™æ ·æ”¶åˆ°æ§åˆ¶å°æ¨é€çš„è§„åˆ™æ—¶ï¼ŒSentinel ä¼šå…ˆæ›´æ–°åˆ°å†…å­˜ï¼Œç„¶åå°†è§„åˆ™å†™å…¥åˆ°æ–‡ä»¶ä¸­. WritableDataSourceRegistry.registerFlowDataSource(wds); } private &lt;T&gt; String encodeJson(T t) { return JSON.toJSONString(t); } } Pushæ¨¡å¼ï¼šç”Ÿäº§ç¯å¢ƒæœ€æ¨èçš„ä¸€ç§æ¨¡å¼ï¼Œéœ€è¦ä¾èµ–äºå¤–éƒ¨çš„æ³¨å†Œä¸­å¿ƒï¼Œnacosã€zookeeperç­‰ æˆ‘ä»¬åœ¨Sentinel Dashboardä¸­ä¿®æ”¹çš„è§„åˆ™é…ç½®ï¼Œé¦–å…ˆä¼šå…ˆæŒä¹…åŒ–åˆ°æˆ‘ä»¬çš„é…ç½®ä¸­å¿ƒä¸­ï¼ˆé…ç½®ä¸­å¿ƒå·²ç»å®ç°äº†æŒä¹…åŒ–ï¼‰ï¼› sentinelå®¢æˆ·ç«¯ï¼ˆæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼‰æ˜¯ä»é…ç½®ä¸­å¿ƒè·å–æ•°æ®ã€‚ å…·ä½“çš„Pushæ¨¡å¼ï¼ˆnacosï¼‰çš„å®ç°å·²ç»åœ¨â€œç¬¬3æ®µâ€æœ‰è®²è¿°ï¼› ä½†æ˜¯æš‚æ—¶é»˜è®¤å¼€æºçš„Sentinel Dashboardä¸­å¹¶æ²¡æœ‰ç›´æ¥æä¾›å¯¹nacosç­‰æ³¨å†Œä¸­å¿ƒçš„ç›´æ¥æ”¯æŒï¼Œå¾—è‡ªå·±æ”¹é€ ï¼Œæˆ–è€…ç›´æ¥å»Nacosä¸­ç›²é…ï¼ ä¸‰ Sentinel Dashboardä¸­å¾—å„ç§è§„åˆ™é…ç½®ä¸è§£è¯» é¦–å…ˆï¼Œå½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡æ‰“å¼€Sentinel Dashboardæ—¶ï¼Œæˆ‘ä»¬ä¼šå‘ç°æ§åˆ¶å°ç©ºç©ºå¦‚ä¹Ÿï¼Œè¿™æ˜¯ç”±äºSentinelä½¿ç”¨çš„æ˜¯æ‡’åŠ è½½ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè°ƒç”¨ä¸€æ¬¡æœåŠ¡çš„æ¥å£ï¼Œç„¶åæ‰å¯ä»¥çœ‹åˆ°â€œç°‡ç‚¹é“¾è·¯â€ï¼š ä¹‹åæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹æ„‰å¿«çš„é…ç½®å•¦ï¼ æœ¬ç« èŠ‚ï¼Œä¸åšå…·ä½“é…ç½®å’Œè°ƒè¯•ï¼Œä¸»è¦æ˜¯å¯¹æ‰€æœ‰çš„é…ç½®è¿›è¡Œè§£é‡Šï¼ŒåŠ æ·±å°è±¡ï¼ 1 æµæ§è§„åˆ™ï¼šè§åçŸ¥æ„ï¼Œæµé‡æ§åˆ¶ 2ç§é˜ˆå€¼ç±»å‹ï¼š QPSï¼šå¯¹å•ä½æ—¶é—´å†…çš„è¯·æ±‚æ•°é‡è¿›è¡Œç»Ÿè®¡ï¼Œæ§åˆ¶æµé‡ï¼› çº¿ç¨‹æ•°ï¼šå±äºæœåŠ¡éš”ç¦»ï¼ˆçº¿ç¨‹éš”ç¦»ï¼‰ï¼ŒSentinelé»˜è®¤ä½¿ç”¨çš„æ˜¯â€œä¿¡å·é‡éš”ç¦»â€ï¼Œè€ŒHystrixé»˜è®¤é‡‡ç”¨çš„æ˜¯â€œçº¿ç¨‹æ± éš”ç¦»â€ ä¿¡å·é‡éš”ç¦»ï¼šé€šè¿‡â€œä¿¡å·é‡è®¡æ•°å™¨â€å®ç°ï¼Œå¼€é”€å°ï¼Œä½†æ˜¯éš”ç¦»æ€§ä¸€èˆ¬ï¼›é€‚åˆâ€œæ‰‡å‡ºâ€å¤§çš„åœºæ™¯ï¼Œå¦‚gatewayå°±æ˜¯æ‰‡å‡ºæ¯”è¾ƒå¤§çš„åœºæ™¯ï¼› çº¿ç¨‹æ± éš”ç¦»ï¼šåŸºäºçº¿ç¨‹æ± å®ç°ï¼Œé¢å¤–å¼€é”€å¤§ï¼Œä½†æ˜¯éš”ç¦»æ€§æ›´å¼ºï¼›é€‚åˆäºâ€œæ‰‡å‡ºâ€å°çš„åœºæ™¯ï¼› 3ç§æµæ§æ¨¡å¼ï¼š ç›´æ¥ï¼šæµé‡ç»Ÿè®¡å¯¹è±¡ å’Œ é™æµå¯¹è±¡ éƒ½æ˜¯å½“å‰èµ„æºæœ¬èº«ï¼› å…³è”ï¼šæµé‡ç»Ÿè®¡çš„å¯¹è±¡æ˜¯å…¶å®ƒèµ„æºï¼Œé™æµçš„å¯¹è±¡å´æ˜¯è‡ªå·±ï¼› é“¾è·¯ï¼šåªç»Ÿè®¡ä»æŒ‡å®šé“¾è·¯è®¿é—®æœ¬èµ„æºçš„è¯·æ±‚ï¼Œè§¦å‘é˜ˆå€¼æ—¶ï¼Œä¹Ÿåªå¯¹æŒ‡å®šçš„é“¾è·¯è¿›è¡Œé™æµï¼› æ³¨æ„ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰çš„è¯·æ±‚çš„å…¥å£é“¾è·¯éƒ½æ˜¯é»˜è®¤çš„ï¼š sentinel_default_context ï¼Œé“¾è·¯æ¨¡å¼æ˜¯ä¸å¥½ä½¿ç”¨çš„ï¼Œæ‰€ä»¥ï¼Œå¦‚æœè¦ä½¿ç”¨é“¾è·¯æ¨¡å¼ï¼Œéœ€è¦å…³é—­â€œcontextç»Ÿä¸€å…¥å£é…ç½®â€ spring: application: name: orderservice cloud: sentinel: transport: dashboard: localhost:8080 # sentinelæ§åˆ¶å°åœ°å€ web-context-unify: false # å…³é—­contextç»Ÿä¸€å…¥å£ 3ç§æµæ§æ•ˆæœï¼š å¿«é€Ÿå¤±è´¥ï¼šè¾¾åˆ°é™æµé˜ˆå€¼åï¼Œç›´æ¥æŠ›å‡ºFlowExceptionå¼‚å¸¸ï¼› WarmUpé¢„çƒ­ï¼šä¸â€œå¿«é€Ÿå¤±è´¥â€ç±»ä¼¼ï¼Œè¾¾åˆ°é˜ˆå€¼åï¼Œä¹Ÿæ˜¯ç›´æ¥æŠ›å‡ºFlowExceptionå¼‚å¸¸ï¼Œä½†æ˜¯è¯¥æ¨¡å¼ä¸‹çš„é˜ˆå€¼æ˜¯å˜åŒ–çš„ï¼Œé»˜è®¤ä»ä¸€ä¸ªæœ€å¤§å€¼çš„1/3ï¼Œé€æ¸å¢åŠ åˆ°æœ€å¤§å€¼ï¼›å¸¸ç”¨äºæœåŠ¡çš„é¢„çƒ­å¯åŠ¨é˜¶æ®µï¼Œé˜²æ­¢æœåŠ¡æµé‡ä¸€ä¸‹å­æ‰“åˆ°æœ€å¤§ï¼Œå¯¼è‡´ä¸€äº›éå¸¸æ€é—®é¢˜å‘ç”Ÿï¼› æ’é˜Ÿç­‰å¾…ï¼ˆæµé‡æ•´å½¢ï¼‰ï¼šè¯·æ±‚åˆ°è¾¾åï¼Œæ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼ŒæŒ‰ç…§ 1/QPS çš„é€Ÿåº¦è¿›è¡Œæ¶ˆè´¹å¤„ç†ï¼Œåœ¨é˜Ÿåˆ—ä¸­çš„è¯·æ±‚ç­‰å¾…æ—¶é—´ï¼Œæœ€å¤§ä¸å¯ä»¥è¶…è¿‡â€œè®¾å®šçš„è¶…æ—¶æ—¶é—´â€ï¼ 2 çƒ­ç‚¹è§„åˆ™ï¼ˆçƒ­ç‚¹é™æµè§„åˆ™ï¼‰â€”â€” ç‰¹æ®Šçš„æµæ§è§„åˆ™ ç”±äºSentinelé»˜è®¤çŸ¥ä¹å°†Springmvcçš„æ³¨è§£å¦‚@RequestMappingç­‰æ³¨å†Œä¸ºèµ„æºï¼Œæ‰€ä»¥å½“æˆ‘ä»¬éœ€è¦å®šä¹‰å…¶å®ƒèµ„æºæ—¶ï¼Œéœ€è¦æ‰‹åŠ¨ä½¿ç”¨@SentinelResourceæ³¨è§£å»å®šä¹‰ï¼š @SentinelResource(&quot;hot&quot;) public Order queryOrderById(Long orderId) { // 1.æŸ¥è¯¢è®¢å• Order order = orderMapper.findById(orderId); // 2.ç”¨Feignè¿œç¨‹è°ƒç”¨ User user = userClient.findById(order.getUserId()); // 3.å°è£…useråˆ°Order order.setUser(user); // 4.è¿”å› return order; } ä¹‹åï¼Œå½“æˆ‘ä»¬è°ƒç”¨è¿‡ä¸€æ¬¡åï¼Œå°±å¯ä»¥çœ‹åˆ°â€œhotâ€è¿™ä¸ªèµ„æºäº†ï¼Œè€Œåå¯¹å®ƒè¿›è¡Œæµæ§é…ç½®ï¼š ä¸Šå›¾çš„çƒ­ç‚¹æµæ§è§„åˆ™è§£è¯»ä¸ºï¼šå¯¹äºhotè¿™ä¸ªèµ„æºï¼Œå¯¹äºå®ƒçš„ç¬¬0ä¸ªè¯·æ±‚å‚æ•°ï¼Œå…è®¸å®ƒ1ç§’å†…ç›¸åŒå€¼çš„æœ€å¤§è¯·æ±‚æ•°ä¸º5ï¼ŒåŒæ—¶ï¼ŒåŒ…å«ä¸€ä¸ªç‰¹æ®Šæƒ…å†µï¼Œå¯¹äºvalue=101ï¼Œå…è®¸çš„QPSé˜ˆå€¼ä¸º10ã€‚ 3 é™çº§è§„åˆ™ï¼ˆç†”æ–­é™çº§ï¼‰ ç†”æ–­é™çº§é€šå¸¸é…ç½® Feign æœåŠ¡é—´è°ƒç”¨ä½¿ç”¨ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šå®šä¹‰ä¸¤ä¸ªç±» UserClientä»£ç†æ¥å£ + UserClientFallbackFactoryé™çº§å·¥å‚ç±»ï¼š UserClientï¼š @FeignClient(value = &quot;userservice&quot;, fallbackFactory = UserClientFallbackFactory.class) public interface UserClient { @GetMapping(&quot;/user/{id}&quot;) User findById(@PathVariable(&quot;id&quot;) Long id); } UserClientFallbackFactoryï¼š @Slf4j @Component public class UserClientFallbackFactory implements FallbackFactory&lt;UserClient&gt; { @Override public UserClient create(Throwable throwable) { return new UserClient() { @Override public User findById(Long id) { log.info(&quot;è¯·æ±‚ç”¨æˆ·æ•°æ®å¤±è´¥&quot;); return new User().setId(100L).setUsername(&quot;default&quot;).setAddress(&quot;defaultAddress&quot;); } }; } } ä¸Šå›¾çš„ç†”æ–­é™çº§è§„åˆ™è§£è¯»ä¸ºï¼š å½“ResponseTimeæ—¶é—´è¶…è¿‡400msæ—¶ä¸ºæ…¢è°ƒç”¨ï¼Œç»Ÿè®¡æœ€è¿‘10000mså†…çš„è¯·æ±‚ï¼Œå¦‚æœè¯·æ±‚æ€»æ•°è¶…è¿‡10æ¬¡ï¼Œä¸”æ…¢è°ƒç”¨çš„æ¯”ä¾‹è¾¾åˆ°0.6ï¼Œåˆ™è§¦å‘ç†”æ–­OPENï¼› ç†”æ–­æ—¶å¸¸ä¸º5ç§’ï¼› 5ç§’åï¼Œè¿›å…¥HALF-OPENçŠ¶æ€ï¼Œæ”¾è¡Œä¸€æ¬¡è¯·æ±‚åšæµ‹è¯•ï¼Œå¦‚æœOKï¼Œåˆ™æ–­è·¯å™¨é‡æ–°CLOSEé—­åˆï¼Œå¼€å§‹æ­£å¸¸å·¥ä½œï¼ 4ã€æˆæƒè§„åˆ™ï¼ˆå¯¹è¯·æ±‚çš„æ¥æºåšæ§åˆ¶ï¼‰ æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬æ‹…å¿ƒç”±äºæœåŠ¡æš´éœ²ï¼Œå¯¼è‡´æœ‰äº›è¯·æ±‚ä¼šè¶Šè¿‡Gatewayï¼Œè€Œç›´æ¥è®¿é—®æˆ‘ä»¬çš„æœåŠ¡ï¼Œè¿™æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡Sentinelæˆæƒåªå…è®¸ä»Gatewayè¿‡æ¥çš„è¯·æ±‚è®¿é—®æˆ‘ä»¬çš„æœåŠ¡ã€‚ åœ¨gatewayä¸­é€šè¿‡filterä¸ºç»è¿‡çš„è¯·æ±‚å¢åŠ ä¸€ä¸ªheaderå€¼ origin = gatewayï¼š spring: application: name: gateway cloud: nacos: server-addr: localhost:8848 # nacosåœ°å€ gateway: routes: - id: user-service # è·¯ç”±æ ‡ç¤ºï¼Œå¿…é¡»å”¯ä¸€ uri: lb://userservice # è·¯ç”±çš„ç›®æ ‡åœ°å€ predicates: # è·¯ç”±æ–­è¨€ï¼Œåˆ¤æ–­è¯·æ±‚æ˜¯å¦ç¬¦åˆè§„åˆ™ - Path=/user/** # è·¯å¾„æ–­è¨€ï¼Œåˆ¤æ–­è·¯å¾„æ˜¯å¦æ˜¯ä»¥/userå¼€å¤´ï¼Œå¦‚æœæ˜¯åˆ™ç¬¦åˆ - id: order-service uri: lb://orderservice predicates: - Path=/order/** default-filters: - AddRequestHeader=origin,gateway åœ¨é¡¹ç›®ä¸­æ³¨å…¥ä¸€ä¸ªRequestOriginParserï¼š @Component public class HeaderOriginParser implements RequestOriginParser { @Override public String parseOrigin(HttpServletRequest request) { // 1.è·å–è¯·æ±‚å¤´ String origin = request.getHeader(&quot;origin&quot;); // 2.éç©ºåˆ¤æ–­ if (StringUtils.isEmpty(origin)) { origin = &quot;blank&quot;; } return origin; } } æœ€åï¼Œé…ç½®ä¸€æ¡æˆæƒè§„åˆ™ç™½åå•ï¼š ä¸Šå›¾æˆæƒè§„åˆ™è§£è¯»ï¼šåªå…è®¸è¯·æ±‚å¤´ä¸­ï¼Œorigin = gateway çš„è¯·æ±‚é€šè¿‡ï¼ å›› è¡¥å……å…¶ä»–çŸ¥è¯†ç‚¹ 1 é»˜è®¤æƒ…å†µä¸‹ï¼Œå‘ç”Ÿé™æµã€æˆæƒæ‹¦æˆªæ—¶ï¼Œä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸åˆ°è°ƒç”¨æ–¹ï¼Œå¾ˆä¸å‹å¥½ï¼Œæœ€å¥½è¦è‡ªå®šä¹‰å¼‚å¸¸è¿”å›ç»“æœ éœ€è¦ä¸º BlockExceptionHandler å†™ä¸€ä¸ªå®ç°ï¼š @Component public class SentinelExceptionHandler implements BlockExceptionHandler { @Override public void handle(HttpServletRequest request, HttpServletResponse response, BlockException e) throws Exception { String msg = &quot;æœªçŸ¥å¼‚å¸¸&quot;; int status = 429; if (e instanceof FlowException) { msg = &quot;è¯·æ±‚è¢«é™æµäº†&quot;; } else if (e instanceof ParamFlowException) { msg = &quot;è¯·æ±‚è¢«çƒ­ç‚¹å‚æ•°é™æµ&quot;; } else if (e instanceof DegradeException) { msg = &quot;è¯·æ±‚è¢«é™çº§äº†&quot;; } else if (e instanceof AuthorityException) { msg = &quot;æ²¡æœ‰æƒé™è®¿é—®&quot;; status = 401; } response.setContentType(&quot;application/json;charset=utf-8&quot;); response.setStatus(status); response.getWriter().println(&quot;{\\&quot;msg\\&quot;: &quot; + msg + &quot;, \\&quot;status\\&quot;: &quot; + status + &quot;}&quot;); } } 2 ä¸åŒçš„æµæ§è§„åˆ™ï¼Œä½¿ç”¨çš„æŠ€æœ¯å®ç°æ–¹æ¡ˆä¸ä¸€æ · å¯¹äºé™æµçš„éœ€æ±‚ï¼Œå¸¸è§çš„å®ç°æ–¹æ¡ˆæœ‰å¤šç§ï¼Œæ»‘åŠ¨æ—¶é—´çª—å£ã€ä»¤ç‰Œæ¡¶ã€æ¼æ¡¶ï¼Œè¿™ä¸‰ç§æœ‰å„è‡ªæ“…é•¿çš„ä¸šåŠ¡åœºæ™¯ï¼Œè€ŒSentinelæ”¯æŒçš„ä¸šåŠ¡åœºæ™¯å¾ˆå¤šï¼Œåœ¨ä¸åŒçš„åœºæ™¯ä¸‹ï¼Œå°±é€‰æ‹©äº†ä¸åŒçš„é™æµå®ç°ã€‚ å¿«é€Ÿå¤±è´¥ã€WarmUpé¢„çƒ­ï¼šæ»‘åŠ¨æ—¶é—´çª—å£ çƒ­ç‚¹é™æµï¼šä»¤ç‰Œæ¡¶ æ’é˜Ÿç­‰å¾…ï¼šæ¼æ¡¶ å…·ä½“çš„é™æµå®ç°ï¼Œè¯·å‚é˜…å¦ä¸€ç¯‡æ–‡ç« ï¼šSentinelæºç æ‹“å±•ä¹‹â€”â€”é™æµçš„å„ç§å®ç°æ–¹å¼ ","link":"https://tianxiawuhao.github.io/XPUt_T_-A/"},{"title":"openfeign-ribbonæ ¸å¿ƒæºç å‰–æ","content":"ä¸€ã€æ€»ç»“å‰ç½®ï¼š 1 ribbon,feign,openfeignä¸‰è€…çš„å¯¹æ¯” æˆ‘ä»¬ç°åœ¨å·¥ä½œä¸­ç°åœ¨å‡ ä¹éƒ½æ˜¯ç›´æ¥ä½¿ç”¨openfeignï¼Œè€Œæˆ‘ä»¬å¾ˆæœ‰å¿…è¦äº†è§£ä¸€ä¸‹ï¼Œribbonã€feignã€openfeignä¸‰è€…ä¹‹é—´çš„å…³ç³»ï¼ ribbonï¼šribbonæ˜¯netflixå¼€æºçš„å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ç»„ä»¶ï¼Œå¯ä»¥è°ƒç”¨æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡åˆ—è¡¨ï¼Œå¹¶é€šè¿‡è´Ÿè½½å‡è¡¡ç®—æ³•æŒ‘é€‰ä¸€å°Serverï¼› feignï¼šfeignä¹Ÿæ˜¯netflixå¼€æºçš„ï¼Œæ˜¯å¯¹ribbonçš„ä¸€å±‚å°è£…ï¼Œé€šè¿‡æ¥å£çš„æ–¹å¼ä½¿ç”¨ï¼Œæ›´åŠ ä¼˜é›…ï¼Œä¸éœ€è¦æ¯æ¬¡éƒ½å»å†™restTemplateï¼Œåªéœ€è¦å®šä¹‰ä¸€ä¸ªæ¥å£æ¥ä½¿ç”¨ï¼›ä½†æ˜¯Feignä¸æ”¯æŒspringmvcçš„æ³¨è§£ï¼› openfeignï¼šæ˜¯å¯¹feignçš„è¿›ä¸€æ­¥å°è£…ï¼Œä½¿å…¶èƒ½å¤Ÿæ”¯æŒspringmvcæ³¨è§£ï¼Œå¦‚@GetMappingç­‰ï¼Œä½¿ç”¨èµ·æ¥æ›´åŠ æ–¹ä¾¿å’Œä¼˜é›…ï¼ 2 å·¥ä½œä¸­éƒ½æ˜¯å¦‚ä½•ä½¿ç”¨openfeign // æƒ³è¦ä½¿ç”¨openfeignï¼Œå¿…é¡»è¦åœ¨å¯åŠ¨ç±»å¢åŠ @EnableFeignClientæ³¨è§£ï¼Œå¦åˆ™å¯åŠ¨æŠ¥é”™ @FeignClient(&quot;feign-provider&quot;) public interface OrderService { @GetMapping(&quot;/order/get/{id}&quot;) public String getById(@PathVariable(&quot;id&quot;) String id); } 3 openfeignä¸ribbonå¦‚ä½•åˆ†å·¥ openfeigné€šè¿‡åŠ¨æ€ä»£ç†çš„æ–¹å¼ï¼Œå¯¹feignclientæ³¨è§£ä¿®é¥°çš„ç±»è¿›è¡ŒåŠ¨æ€ä»£ç†ï¼Œæ‹¼æ¥æˆä¸´æ—¶URLï¼šhttp://feign-provider/order/get/100ï¼Œäº¤ç»™ribbon ribboné€šè¿‡è‡ªå·±çš„æ‹¦æˆªå™¨ï¼Œæˆªå–å‡ºserviceNameåœ¨æœåŠ¡æ³¨å†Œè¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„serverListï¼Œå¹¶é€šè¿‡è´Ÿè½½å‡è¡¡ç­–ç•¥æŒ‘é€‰ä¸€å°Serverï¼Œæ‹¼æ¥æˆæœ€ç»ˆçš„URLï¼šhttp://10.206.73.156:1111/order/get/100ï¼Œäº¤è¿˜ç»™feignï¼› æœ€åï¼Œfeigné€šè¿‡è‡ªå·±å°è£…çš„Clientå¯¹ç›®æ ‡åœ°å€å‘èµ·è°ƒç”¨ï¼Œå¹¶è·å¾—è¿”å›ç»“æœï¼›ï¼ˆClientæ˜¯å¯¹åŸç”Ÿ java.net ä¸­çš„URLç±»çš„å°è£…ï¼Œå®ç°è¿œç¨‹è°ƒç”¨ï¼‰ äºŒ æ ¸å¿ƒä»£ç â€”â€”Openfeignç”Ÿæˆçš„åŠ¨æ€ä»£ç†ç±»æ˜¯å•¥ 1 å¯åŠ¨ç±»å¿…é¡»å¢åŠ @EnableFeignClientï¼Œé‚£æˆ‘ä»¬å°±ä»è¿™é‡Œå…¥å£ @EnableFeignClients @Import(FeignClientsRegistrar.class) // é‡åˆ°import(Registrar)ï¼Œæˆ‘ä»¬å°±å»çœ‹å®ƒçš„registerBeanDefinitions()æ–¹æ³•ï¼š public void registerBeanDefinitions(AnnotationMetadata metadata, BeanDefinitionRegistry registry) { registerDefaultConfiguration(metadata, registry); // æ³¨å†ŒFeignClientï¼Œå…¶å®FeignClientå°±æ˜¯æˆ‘ä»¬éœ€è¦çš„åŠ¨æ€ä»£ç†ç±» registerFeignClients(metadata, registry); } public void registerFeignClients(AnnotationMetadata metadata,BeanDefinitionRegistry registry) { ...... // å®šä¹‰è¿‡æ»¤å™¨ï¼ŒæŠŠåŠ äº†@FeignClientæ³¨è§£çš„æ¥å£éƒ½è¿‡æ»¤å‡ºæ¥ AnnotationTypeFilter annotationTypeFilter = new AnnotationTypeFilter(FeignClient.class); ...è¿‡æ»¤é€»è¾‘... for (String basePackage : basePackages) { Set&lt;BeanDefinition&gt; candidateComponents = scanner .findCandidateComponents(basePackage); for (BeanDefinition candidateComponent : candidateComponents) { if (candidateComponent instanceof AnnotatedBeanDefinition) { // verify annotated class is an interface AnnotatedBeanDefinition beanDefinition = (AnnotatedBeanDefinition) candidateComponent; AnnotationMetadata annotationMetadata = beanDefinition.getMetadata(); Assert.isTrue(annotationMetadata.isInterface(), &quot;@FeignClient can only be specified on an interface&quot;); Map&lt;String, Object&gt; attributes = annotationMetadata .getAnnotationAttributes( FeignClient.class.getCanonicalName()); String name = getClientName(attributes); registerClientConfiguration(registry, name, attributes.get(&quot;configuration&quot;)); // å°†ä¸ºæ¯ä¸€ä¸ªè¿‡æ»¤å‡ºæ¥çš„æ¥å£ï¼Œæ³¨å†ŒFeignClient registerFeignClient(registry, annotationMetadata, attributes); } } } } private void registerFeignClient(BeanDefinitionRegistry registry, AnnotationMetadata annotationMetadata, Map&lt;String, Object&gt; attributes) { String className = annotationMetadata.getClassName(); BeanDefinitionBuilder definition = BeanDefinitionBuilder .genericBeanDefinition(FeignClientFactoryBean.class); ...ç›®æ ‡FactoryBeanä¸ºFeignClientFactoryBean... ...FactoryBeanä¸€èˆ¬ç”¨äºå®šåˆ¶åŒ–ä¸€äº›ç‰¹æ®Šçš„Beanï¼Œspringä¼šè°ƒç”¨å®ƒçš„getObjectæ¥å£... BeanDefinitionHolder holder = new BeanDefinitionHolder(beanDefinition, className, new String[] { alias }); BeanDefinitionReaderUtils.registerBeanDefinition(holder, registry); } 2 è§åçŸ¥æ„FeignClientçš„å·¥å‚beanï¼šFeignClientFactoryBean.getObject()æ–¹æ³• class FeignClientFactoryBean{ @Override public Object getObject() throws Exception { return getTarget(); } &lt;T&gt; T getTarget() { FeignContext context = this.applicationContext.getBean(FeignContext.class); Feign.Builder builder = feign(context); // å½“æˆ‘ä»¬ä¸ä¸º@FeignClient()æ³¨è§£é…ç½®urlå±æ€§æ—¶ // è¿™é‡ŒåŒæ—¶ä¼šæ ¹æ®æ³¨è§£ï¼Œæ‹¼æ¥å‡ºurlå‰ç¼€ï¼Œå¦‚ï¼šhttp://feign-provider if (!StringUtils.hasText(this.url)) { if (!this.name.startsWith(&quot;http&quot;)) { this.url = &quot;http://&quot; + this.name; } else { this.url = this.name; } this.url += cleanPath(); return (T) loadBalance(builder, context, new HardCodedTarget&lt;&gt;(this.type, this.name, this.url)); } ...å¦‚æœæˆ‘ä»¬ä¸º@FeignClient()æ³¨è§£é…ç½®urlå±æ€§ä¹‹åçš„é€»è¾‘... } } protected &lt;T&gt; T loadBalance(Feign.Builder builder, FeignContext context, HardCodedTarget&lt;T&gt; target) { // ä»å®¹å™¨ä¸­è·å–ä¸€ä¸ªç±»å‹ä¸ºClientçš„beanï¼Œé‚£ä¹ˆIOCå®¹å™¨ä¸­è‚¯å®šæœ‰ä¸€ä¸ªè¿™æ ·çš„Bean Client client = getOptional(context, Client.class); if (client != null) { builder.client(client); Targeter targeter = get(context, Targeter.class); return targeter.target(this, builder, context, target); } // å¦‚æœæ‰¾ä¸åˆ°ç±»å‹ä¸ºClientçš„Beanå°±æ˜¯æœ‰é—®é¢˜çš„å•¦ï¼ throw new IllegalStateException( &quot;No Feign Client for loadBalancing defined. Did you forget to include spring-cloud-starter-netflix-ribbon?&quot;); } 3 å®¹å™¨ä¸­ç±»å‹ä¸ºClientçš„Beanæ˜¯è° æ­¤æ—¶è¿˜æ˜¯å¯åŠ¨é˜¶æ®µï¼Œæˆ‘ä»¬å»çœ‹çœ‹æœ‰å“ªäº›beanä¼šè¢«æ³¨å…¥ï¼Œåœ¨ spring.factories ä¸­ï¼Œæˆ‘ä»¬ä¼šæ‰¾åˆ°ä¸¤ä¸ªè‡ªåŠ¨é…ç½®ç±»ï¼š è¿™ä¸¤ä¸ªç±»ï¼Œå¾ˆå…³é”®ï¼Œéƒ½ä¼šå¾€å®¹å™¨ä¸­æ³¨å…¥è´Ÿè½½å‡è¡¡çš„Client Beanï¼Œä½†æ˜¯åªä¼šæœ‰ä¸€ä¸ªæˆåŠŸï¼Œ FeignRibbonClientAutoCOnfigurationç±»ï¼š @ConditionalOnClass({ ILoadBalancer.class, Feign.class }) @ConditionalOnProperty(value = &quot;spring.cloud.loadbalancer.ribbon.enabled&quot;,matchIfMissing = true) @Configuration(proxyBeanMethods = false) // é‡ç‚¹1ï¼šåœ¨FeignAutoConfigurationä¹‹å‰è£…è½½é…ç½® @AutoConfigureBefore(FeignAutoConfiguration.class) @EnableConfigurationProperties({ FeignHttpClientProperties.class }) @Import({ HttpClientFeignLoadBalancedConfiguration.class, OkHttpFeignLoadBalancedConfiguration.class, DefaultFeignLoadBalancedConfiguration.class }) // é‡ç‚¹2ï¼š public class FeignRibbonClientAutoConfiguration { ...éé‡ç‚¹... } @Configuration(proxyBeanMethods = false) class DefaultFeignLoadBalancedConfiguration { @Bean @ConditionalOnMissingBean // å¦‚æœClientç±»å‹çš„beanå·²ç»å­˜åœ¨ï¼Œåˆ™ä¸æ‰§è¡Œ public Client feignClient(CachingSpringLoadBalancerFactory cachingFactory, SpringClientFactory clientFactory) { return new LoadBalancerFeignClient(new Client.Default(null, null), cachingFactory, clientFactory); } } FeignLoadBalancerAutoConfigurationç±»ï¼š @ConditionalOnClass(Feign.class) @ConditionalOnBean(BlockingLoadBalancerClient.class) @AutoConfigureBefore(FeignAutoConfiguration.class) // é‡ç‚¹1ï¼šåœ¨FeignRibbonClientAutoConfigurationä¹‹åè£…è½½é…ç½® @AutoConfigureAfter(FeignRibbonClientAutoConfiguration.class) @EnableConfigurationProperties(FeignHttpClientProperties.class) @Configuration(proxyBeanMethods = false) @Import({ HttpClientFeignLoadBalancerConfiguration.class, OkHttpFeignLoadBalancerConfiguration.class, DefaultFeignLoadBalancerConfiguration.class }) // é‡ç‚¹2ï¼š public class FeignLoadBalancerAutoConfiguration { ...éé‡ç‚¹... } @Configuration(proxyBeanMethods = false) class DefaultFeignLoadBalancerConfiguration { @Bean @ConditionalOnMissingBean // å¦‚æœClientç±»å‹çš„beanå·²ç»å­˜åœ¨ï¼Œåˆ™ä¸æ‰§è¡Œ public Client feignClient(BlockingLoadBalancerClient loadBalancerClient) { return new FeignBlockingLoadBalancerClient(new Client.Default(null, null), loadBalancerClient); } } åˆ°è¿™é‡Œå°±éå¸¸æ¸…æ™°äº†ï¼š é€šè¿‡spring.factoriesæ³¨å…¥äº†ä¸¤ä¸ªé…ç½®ç±»ï¼Œå¹¶é€šè¿‡ @AutoConfigureBefore å’Œ @AutoConfigureAfterå¼ºåˆ¶äº†ä¸¤ä¸ªé…ç½®ç±»çš„è£…è½½é¡ºåºï¼ è¿™ä¸¤ä¸ªé…ç½®ç±»å„import äº† å¦ä¸€ä¸ªé…ç½®ç±»ï¼šDefaultFeignLoadBalancedConfigurationï¼ˆæ³¨å…¥ï¼šLoadBalancerFeignClientï¼‰ å’Œ DefaultFeignLoadBalancerConfigurationï¼ˆæ³¨å…¥ï¼šFeignBlockingLoadBalancerClientï¼‰ï¼Œä½†æ˜¯ç”±äº@ConditionalOnMissingBeanæ³¨è§£ï¼Œåªæœ‰ä¸€ä¸ªå‰é¢é‚£ä¸ªä¼šæ³¨å…¥æˆåŠŸï¼ æ‰€ä»¥ï¼Œç»“è®ºå°±æ˜¯ï¼šIOCå®¹å™¨ä¸­çš„â€œClientâ€ç±»å‹çš„ Bean ä¸º â€œLoadBalancerFeignClientâ€ æ‰€ä»¥ï¼Œæœ€ç»ˆçš„ç»“è®ºå°±æ˜¯ï¼šOpenfeigné€šè¿‡çš„åŠ¨æ€ä»£ç†ï¼Œä¸ºæ¯ä¸ªâ€œ@FeignClientâ€æ³¨è§£ä¿®é¥°çš„æ¥å£ç”Ÿæˆä¸€ä¸ªç±»å‹ä¸º â€œLoadBalancerFeignClientâ€çš„ä»£ç†ç±»ã€‚ ä¸‰ FeignClientä»£ç†ç±»æ‰§è¡Œæ—¶ï¼Œæ˜¯å¦‚ä½•ä½¿ç”¨Ribbonçš„ 1 å½“æ‰§è¡ŒLoadBalancerFeignClient.execute()æ–¹æ³•æ—¶ï¼š // org.springframework.cloud.openfeign.ribbon.LoadBalancerFeignClient#execute public Response execute(Request request, Request.Options options) throws IOException { try { URI asUri = URI.create(request.url()); String clientName = asUri.getHost(); URI uriWithoutHost = cleanUrl(request.url(), clientName); FeignLoadBalancer.RibbonRequest ribbonRequest = new FeignLoadBalancer.RibbonRequest( this.delegate, request, uriWithoutHost); // å¯ä»¥è·å–åˆ°nacosçš„ä¸€äº›ä¿¡æ¯ IClientConfig requestConfig = getClientConfig(options, clientName); // lbClient(clientName)ï¼šå¯ä»¥è·å¾—å…·ä½“çš„ä»£ç†ç±»ï¼Œæ¯ä¸ª@FeignClientä¿®é¥°çš„æ¥å£ä»£ç†ç±»æ—¶ç‹¬ç«‹çš„ return lbClient(clientName) .executeWithLoadBalancer(ribbonRequest, requestConfig).toResponse(); } catch (ClientException e) { ...... } } æˆ‘ä»¬å¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹åˆ°ï¼Œè¿™é‡Œè‚¯å®šä¼šè¦ç”¨åˆ°Ribbonï¼› 2 é€šè¿‡è´Ÿè½½å‡è¡¡å™¨ï¼Œæ‰§è¡Œè°ƒç”¨ï¼Œå¹¶è¿”å›ç»“æœ // com.netflix.client.AbstractLoadBalancerAwareClient#executeWithLoadBalancer(...) public T executeWithLoadBalancer(final S request, final IClientConfig requestConfig) throws ClientException { LoadBalancerCommand&lt;T&gt; command = buildLoadBalancerCommand(request, requestConfig); try { return command.submit( // è¿™æ­¥ä¼šè¿”å›å…·ä½“çš„ï¼Œè´Ÿè½½å‡è¡¡é€‰å®šå¥½çš„Server new ServerOperation&lt;T&gt;() { @Override public Observable&lt;T&gt; call(Server server) { // submité€‰å¥½çš„Serverä½œä¸ºå…¥å‚ URI finalUri = reconstructURIWithServer(server, request.getUri()); S requestForServer = (S) request.replaceUri(finalUri); try { return Observable.just(AbstractLoadBalancerAwareClient.this.execute(requestForServer, requestConfig)); } catch (Exception e) { return Observable.error(e); } } }) .toBlocking() .single(); } catch (Exception e) { ...... } } // com.netflix.loadbalancer.reactive.LoadBalancerCommand#submit public Observable&lt;T&gt; submit(final ServerOperation&lt;T&gt; operation) { final ExecutionInfoContext context = new ExecutionInfoContext(); ...... final int maxRetrysSame = retryHandler.getMaxRetriesOnSameServer(); final int maxRetrysNext = retryHandler.getMaxRetriesOnNextServer(); // selectServer()æ–¹æ³•ä¼šé€šè¿‡è´Ÿè½½å‡è¡¡é€‰æ‹©ä¸€å°Server Observable&lt;T&gt; o = (server == null ? selectServer() : Observable.just(server)) .concatMap(new Func1&lt;Server, Observable&lt;T&gt;&gt;() { ...... }); } 3 selectServer()å…·ä½“æ–¹æ³• // com.netflix.loadbalancer.reactive.LoadBalancerCommand#selectServer private Observable&lt;Server&gt; selectServer() { return Observable.create(new OnSubscribe&lt;Server&gt;() { @Override public void call(Subscriber&lt;? super Server&gt; next) { try { Server server = loadBalancerContext.getServerFromLoadBalancer(loadBalancerURI, loadBalancerKey); next.onNext(server); next.onCompleted(); } catch (Exception e) { next.onError(e); } } }); } 4 è¿™é‡Œå°†ä½¿ç”¨åˆ°éå¸¸é‡è¦çš„ä¸€ä¸ªZoneAwareLoadBalancer // com.netflix.loadbalancer.LoadBalancerContext#getServerFromLoadBalancer public Server getServerFromLoadBalancer(@Nullable URI original, @Nullable Object loadBalancerKey) throws ClientException { String host = null; int port = -1; if (original != null) { host = original.getHost(); } if (original != null) { Pair&lt;String, Integer&gt; schemeAndPort = deriveSchemeAndPortFromPartialUri(original); port = schemeAndPort.second(); } // å…³é”®ä¸€æ­¥ï¼Œè·å¾—äº†ä¸€ä¸ªILoadBalancer ILoadBalancer lb = getLoadBalancer(); if (host == null) { // é‡è¦ï¼šè¿™é‡Œå…¶å®è·å¾—çš„æ˜¯ZoneAwareLoadBalancerç±»çš„Bean if (lb != null){ Server svc = lb.chooseServer(loadBalancerKey); if (svc == null){ throw new ClientException(ClientException.ErrorType.GENERAL, &quot;Load balancer does not have available server for client: &quot; + clientName); } host = svc.getHost(); return svc; } else { ...... } } else { ...... } return new Server(host, port); } // com.netflix.loadbalancer.BaseLoadBalancer#chooseServer public Server chooseServer(Object key) { if (!ENABLED.get() || getLoadBalancerStats().getAvailableZones().size() &lt;= 1) { logger.debug(&quot;Zone aware logic disabled or there is only one zone&quot;); return super.chooseServer(key); } ...å…¶å®ƒåˆ†æ”¯åœ¨å›½å†…ä¸€èˆ¬ä¸ä¼šèµ°ï¼Œæ²¡æœ‰zoneçš„æ¦‚å¿µ... } // com.netflix.loadbalancer.BaseLoadBalancer#chooseServer public Server chooseServer(Object key) { if (counter == null) { counter = createCounter(); } counter.increment(); if (rule == null) { return null; } else { try { return rule.choose(key); // PredicateBasedRule } catch (Exception e) { return null; } } } // com.netflix.loadbalancer.PredicateBasedRule#choose public Server choose(Object key) { ILoadBalancer lb = getLoadBalancer(); Optional&lt;Server&gt; server = getPredicate().chooseRoundRobinAfterFiltering(lb.getAllServers(), key); if (server.isPresent()) { return server.get(); } else { return null; } } 5 å¯ä»¥çœ‹åˆ° lb.getAllServer()ï¼Œæ­£æ˜¯ZoneAwareLoadBalancer.getAllServers()æ–¹æ³• // com.netflix.loadbalancer.BaseLoadBalancer#getAllServers public class BaseLoadBalancer extends AbstractLoadBalancer { protected volatile List&lt;Server&gt; allServerList = Collections.synchronizedList(new ArrayList&lt;Server&gt;()); public List&lt;Server&gt; getAllServers() { return Collections.unmodifiableList(allServerList); } } æ‰€ä»¥ï¼Œæˆ‘ä»¬ç°åœ¨ç”¨å¼„æ¸…æ¥šçš„æœ‰ä¸¤ç‚¹ï¼š ä¸ºä»€ä¹ˆé‡è¦çš„ILoadBalancerçš„å®ç°å°±æ˜¯ZoneAwareLoadBalancerï¼› ZoneAwareLoadBalancerä¸­çš„allServerListå±æ€§æ˜¯ä½•æ—¶è¢«èµ‹å€¼çš„ï¼› å›› ZoneAwareLoadBalanceræ˜¯ä½•æ—¶æ³¨å…¥çš„ 1 åœ¨spring-cloud-netfliex-ribbonåŒ…çš„spring.factoriesä¸­æœ‰RibbonAutoConfigurationç±» æˆ‘ä»¬çœ‹åˆ°è¿™ä¸ªç±»çš„æ„é€ æ–¹æ³•ï¼Œåˆ›å»ºäº†ä¸€ä¸ªSpringClientFactoryå·¥å‚ç±»ï¼š @Configuration @Conditional(RibbonAutoConfiguration.RibbonClassesConditions.class) @RibbonClients @AutoConfigureAfter(name = &quot;org.springframework.cloud.netflix.eureka.EurekaClientAutoConfiguration&quot;) @AutoConfigureBefore({ LoadBalancerAutoConfiguration.class, AsyncLoadBalancerAutoConfiguration.class }) @EnableConfigurationProperties({ RibbonEagerLoadProperties.class, ServerIntrospectorProperties.class }) public class RibbonAutoConfiguration { @Autowired(required = false) private List&lt;RibbonClientSpecification&gt; configurations = new ArrayList&lt;&gt;(); @Autowired private RibbonEagerLoadProperties ribbonEagerLoadProperties; @Bean public HasFeatures ribbonFeature() { return HasFeatures.namedFeature(&quot;Ribbon&quot;, Ribbon.class); } @Bean public SpringClientFactory springClientFactory() { // SpringClientFactoryè¿™ä¸ªClientå·¥å‚ç±»å¾ˆå…³é”® SpringClientFactory factory = new SpringClientFactory(); factory.setConfigurations(this.configurations); return factory; } } æˆ‘ä»¬å†çœ‹çœ‹è¿™ä¸ªå·¥å‚ç±»çš„æ„é€ æ–¹æ³•åšäº†ä»€ä¹ˆäº‹ï¼š public class SpringClientFactory extends NamedContextFactory&lt;RibbonClientSpecification&gt; { static final String NAMESPACE = &quot;ribbon&quot;; public SpringClientFactory() { super(RibbonClientConfiguration.class, NAMESPACE, &quot;ribbon.client.name&quot;); } } public abstract class NamedContextFactory&lt;C extends NamedContextFactory.Specification&gt; implements DisposableBean, ApplicationContextAware { private final String propertySourceName; private final String propertyName; private Map&lt;String, AnnotationConfigApplicationContext&gt; contexts = new ConcurrentHashMap(); private Map&lt;String, C&gt; configurations = new ConcurrentHashMap(); private ApplicationContext parent; private Class&lt;?&gt; defaultConfigType; public NamedContextFactory(Class&lt;?&gt; defaultConfigType, String propertySourceName, String propertyName) { this.defaultConfigType = defaultConfigType; this.propertySourceName = propertySourceName; this.propertyName = propertyName; } } æ˜¾ç„¶ï¼Œæ„é€ äº†ä¸€ä¸ªä¸Šä¸‹å·¥å‚â€œNamedContextFactoryâ€ç±»ï¼Œè¿™ä¸ªå·¥å‚ç±»çš„é»˜è®¤é…ç½®ç±»æ˜¯â€œRibbonClientConfiguraionâ€ï¼Œè¿™ä¸ªåœ¨ä¹‹åFeignçš„è°ƒç”¨è¿‡ç¨‹ä¸­éå¸¸å…³é”®ï¼› 2 LoadBalancerFeignClientè¿™ä¸ªä»£ç†ç±»çš„execute()æ–¹æ³•ä¸­ // org.springframework.cloud.openfeign.ribbon.LoadBalancerFeignClient#execute public Response execute(Request request, Request.Options options) throws IOException { try { URI asUri = URI.create(request.url()); String clientName = asUri.getHost(); URI uriWithoutHost = cleanUrl(request.url(), clientName); FeignLoadBalancer.RibbonRequest ribbonRequest = new FeignLoadBalancer.RibbonRequest( this.delegate, request, uriWithoutHost); // è¿™ä¸ªæ–¹æ³•ä¸ç”¨è®²ï¼Œå¾—åˆ°çš„IclientConfigè‚¯å®šæ˜¯RibbonClientConfiguraion IClientConfig requestConfig = getClientConfig(options, clientName); return lbClient(clientName) .executeWithLoadBalancer(ribbonRequest, requestConfig).toResponse(); } catch (ClientException e) { ...... } } // org.springframework.cloud.openfeign.ribbon.LoadBalancerFeignClient#getClientConfig IClientConfig getClientConfig(Request.Options options, String clientName) { ...... requestConfig = this.clientFactory.getClientConfig(clientName); ...... } // org.springframework.cloud.netflix.ribbon.SpringClientFactory#getClientConfig public IClientConfig getClientConfig(String name) { return getInstance(name, IClientConfig.class); } // org.springframework.cloud.netflix.ribbon.SpringClientFactory#getInstance public &lt;C&gt; C getInstance(String name, Class&lt;C&gt; type) { // SpringClientFactoryçš„superçˆ¶ç±»å°±æ˜¯NamedContextFactory C instance = super.getInstance(name, type); if (instance != null) { return instance; } IClientConfig config = getInstance(name, IClientConfig.class); return instantiateWithConfig(getContext(name), type, config); } // org.springframework.cloud.context.named.NamedContextFactory#getInstance public &lt;T&gt; T getInstance(String name, Class&lt;T&gt; type) { AnnotationConfigApplicationContext context = this.getContext(name); return BeanFactoryUtils.beanNamesForTypeIncludingAncestors(context, type).length &gt; 0 ? context.getBean(type) : null; } æ‰¾åˆ°äº†**NamedContextFactory ï¼Œå°±å’Œç¬¬ä¸€ç‚¹ä¸²èµ·æ¥äº†ï¼Œå®ƒçš„ é»˜è®¤ é…ç½®ç±»æ­£æ˜¯RibbonClientConfiguration **ï¼› 3 RibbonClientConfigurationåˆæ˜¯å¦‚ä½•æ³¨å…¥æˆ‘ä»¬éœ€è¦çš„ZoneAwareLoadBalancerçš„ @Configuration(proxyBeanMethods = false) @EnableConfigurationProperties // Order is important here, last should be the default, first should be optional // see // https://github.com/spring-cloud/spring-cloud-netflix/issues/2086#issuecomment-316281653 @Import({ HttpClientConfiguration.class, OkHttpRibbonConfiguration.class, RestClientRibbonConfiguration.class, HttpClientRibbonConfiguration.class }) public class RibbonClientConfiguration { @Bean @ConditionalOnMissingBean public ILoadBalancer ribbonLoadBalancer(IClientConfig config, ServerList&lt;Server&gt; serverList, ServerListFilter&lt;Server&gt; serverListFilter, IRule rule, IPing ping, ServerListUpdater serverListUpdater) { if (this.propertiesFactory.isSet(ILoadBalancer.class, name)) { return this.propertiesFactory.get(ILoadBalancer.class, config, name); } // é»˜è®¤æ³¨å…¥çš„ç±»æ­£æ˜¯ZoneAwareLoadBalancer return new ZoneAwareLoadBalancer&lt;&gt;(config, rule, ping, serverList, serverListFilter, serverListUpdater); } } æ‰€ä»¥ï¼Œè¿™å°±è§£é‡Šäº†ï¼Œä¸ºä»€ä¹ˆåœ¨åé¢çš„ ILoadBalancer lb = getLoadBalancer(); è·å¾—åˆ°çš„å°±æ˜¯ZoneAwareLoadBalancerï¼ åŒæ—¶ï¼Œè¿™ä¸ªç±»æ˜¯åœ¨åŠ¨æ€ä»£ç†è¢«æ‰§è¡Œexecute()çš„æ—¶å€™è¢«è°ƒèµ·çš„ï¼Œæ‰€ä»¥Ribbonä¹Ÿæ˜¯åœ¨è¢«ä½¿ç”¨æ—¶æ‰ä»Nacosè·å–æ³¨å†Œè¡¨çš„ï¼Œå¹¶ä¸æ˜¯åœ¨å®¹å™¨å¯åŠ¨æ—¶ï¼ äº” Ribbonåˆæ˜¯ä½•æ—¶ä»NacosæœåŠ¡ç«¯è·å–allServerListçš„ 1 æˆ‘ä»¬éœ€è¦è·Ÿè¸ªZoneAwareLoadBalancerå¯¹åº”çš„Beançš„æ„é€ è¿‡ç¨‹ // com.netflix.loadbalancer.ZoneAwareLoadBalancer#ZoneAwareLoadBalancer public ZoneAwareLoadBalancer(IClientConfig clientConfig, IRule rule, IPing ping, ServerList&lt;T&gt; serverList, ServerListFilter&lt;T&gt; filter, ServerListUpdater serverListUpdater) { super(clientConfig, rule, ping, serverList, filter, serverListUpdater); } // com.netflix.loadbalancer.DynamicServerListLoadBalancer#DynamicServerListLoadBalancer public DynamicServerListLoadBalancer(IClientConfig clientConfig, IRule rule, IPing ping, ServerList&lt;T&gt; serverList, ServerListFilter&lt;T&gt; filter, ServerListUpdater serverListUpdater) { super(clientConfig, rule, ping); this.serverListImpl = serverList; this.filter = filter; this.serverListUpdater = serverListUpdater; if (filter instanceof AbstractServerListFilter) { ((AbstractServerListFilter) filter).setLoadBalancerStats(getLoadBalancerStats()); } //æ‰§è¡Œè¿œç¨‹è°ƒç”¨ï¼Œå¹¶åˆå§‹åŒ–BaseLoadBalancerä¸­çš„allServerList restOfInit(clientConfig); } 2 è¿œç¨‹è°ƒç”¨Nacoså¹¶åˆå§‹åŒ–restOfInit()æ–¹æ³•çš„é€»è¾‘ void restOfInit(IClientConfig clientConfig) { boolean primeConnection = this.isEnablePrimingConnections(); // turn this off to avoid duplicated asynchronous priming done in BaseLoadBalancer.setServerList() this.setEnablePrimingConnections(false); // è·å–æœåŠ¡åˆ—è¡¨åŠŸèƒ½ enableAndInitLearnNewServersFeature(); updateListOfServers(); if (primeConnection &amp;&amp; this.getPrimeConnections() != null) { this.getPrimeConnections() .primeConnections(getReachableServers()); } this.setEnablePrimingConnections(primeConnection); } public void enableAndInitLearnNewServersFeature() { serverListUpdater.start(updateAction); } è¿™ä¸ªupdateActionå˜é‡æ˜¯å¯æ‰§è¡Œçš„ï¼š protected final ServerListUpdater.UpdateAction updateAction = new ServerListUpdater.UpdateAction() { @Override public void doUpdate() { updateListOfServers(); // æ›´æ–°Serversåˆ—è¡¨ } }; 3ã€updateListOfServer()æ–¹æ³•å¦‚ä½•ä»NacosæœåŠ¡ç«¯è·å–æœåŠ¡åˆ—è¡¨ï¼š // com.netflix.loadbalancer.DynamicServerListLoadBalancer#updateListOfServers public void updateListOfServers() { List&lt;T&gt; servers = new ArrayList&lt;T&gt;(); if (serverListImpl != null) { // å…¶ä¸­çš„serverListImplæœ‰ä¸‰ä¸ªå®ç°ï¼Œå…¶ä¸­ä¹‹ä¸€å°±æ˜¯Nacos servers = serverListImpl.getUpdatedListOfServers(); LOGGER.debug(&quot;List of Servers for {} obtained from Discovery client: {}&quot;, getIdentifier(), servers); if (filter != null) { servers = filter.getFilteredListOfServers(servers); LOGGER.debug(&quot;Filtered List of Servers for {} obtained from Discovery client: {}&quot;, getIdentifier(), servers); } } // ç”¨è·å¾—åˆ°çš„æœåŠ¡åˆ—è¡¨æ›´æ–°BaseLoadBalancerä¸­çš„allServerList updateAllServerList(servers); } ä¸ç”¨æƒ³äº†ï¼Œè‚¯å®šæ˜¯NacosServerListï¼Œè¿™ä¸ªç®€å•è¿½è¸ªå°±ä¸èµ˜è¿°äº†ï¼ NacosServerList.getUpdatedListOfServers()æœ€ç»ˆä¼šè°ƒç”¨nacoså®¢æˆ·ç«¯çš„æ ¸å¿ƒç±» NacosNamingServer.selectInstances() æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åªä¼šè¿”å›å¥åº·å®ä¾‹åˆ—è¡¨ï¼› 4 æ ¹æ®ä»nacosè·å¾—åˆ°çš„Serversï¼Œæ›´æ–°æœ¬åœ°çš„allServerListå±æ€§ // com.netflix.loadbalancer.DynamicServerListLoadBalancer#updateAllServerList protected void updateAllServerList(List&lt;T&gt; ls) { // other threads might be doing this - in which case, we pass if (serverListUpdateInProgress.compareAndSet(false, true)) { try { for (T s : ls) { s.setAlive(true); // set so that clients can start using these // servers right away instead // of having to wait out the ping cycle. } setServersList(ls); super.forceQuickPing(); } finally { serverListUpdateInProgress.set(false); } } } public void setServersList(List lsrv) { super.setServersList(lsrv); // æ ¸å¿ƒ List&lt;T&gt; serverList = (List&lt;T&gt;) lsrv; Map&lt;String, List&lt;Server&gt;&gt; serversInZones = new HashMap&lt;String, List&lt;Server&gt;&gt;(); for (Server server : serverList) { // make sure ServerStats is created to avoid creating them on hot // path getLoadBalancerStats().getSingleServerStat(server); String zone = server.getZone(); if (zone != null) { zone = zone.toLowerCase(); List&lt;Server&gt; servers = serversInZones.get(zone); if (servers == null) { servers = new ArrayList&lt;Server&gt;(); serversInZones.put(zone, servers); } servers.add(server); } } setServerListForZones(serversInZones); } // com.netflix.loadbalancer.BaseLoadBalancer#setServersList public void setServersList(List lsrv) { Lock writeLock = allServerLock.writeLock(); logger.debug(&quot;LoadBalancer [{}]: clearing server list (SET op)&quot;, name); ArrayList&lt;Server&gt; newServers = new ArrayList&lt;Server&gt;(); writeLock.lock(); try { ArrayList&lt;Server&gt; allServers = new ArrayList&lt;Server&gt;(); ...å¯¹æ¯ä¸€ä¸ªServerè¿›è¡Œä¸‹åŒ…è£…... allServerList = allServers; //æœ¬åœ°çš„allServerListèµ‹å€¼ if (canSkipPing()) { for (Server s : allServerList) { s.setAlive(true); } upServerList = allServerList; } else if (listChanged) { forceQuickPing(); } } finally { writeLock.unlock(); } } åˆ°è¿™é‡Œï¼Œæ€»ç®—å’Œ äºŒ.5 ç« èŠ‚ä¸­çš„allServerListè¿›è¡Œå‘¼åº”äº†ï¼ è‡³æ­¤ï¼Œæ•´ä¸ªä»FeignClientæ³¨è§£ç”ŸæˆåŠ¨æ€ä»£ç†ç±»LoadBalancerFeignClientï¼› â€”â€”&gt; Clientæ‰§è¡Œæ—¶ä¼šç”Ÿæˆribbonä¸‹çš„ZoneAwareLoadBalancerç±»ï¼Œè°ƒç”¨nacosæœåŠ¡ç«¯è·å–æœåŠ¡åˆ—è¡¨ï¼› â€”â€”&gt; åœ¨é€šè¿‡ZoneAwareLoadBalancerçš„çˆ¶ç±»çš„BaseLoadBalancer.chooseServer()æ–¹æ³•æ ¹æ®è´Ÿè½½å‡è¡¡ç®—æ³•æŒ‘é€‰ä¸€å°æœåŠ¡å™¨ï¼› â€”â€”&gt; æœ€åäº¤ç»™Feignçš„çš„Clienté€šè¿‡URLç±»å®Œæˆè°ƒç”¨ã€‚ å…­ Feignå’ŒRibbonçš„é‡è¯•æœºåˆ¶ 1 é¦–å…ˆæˆ‘ä»¬åšä¸¤ä¸ªäº‹æƒ… æœåŠ¡æä¾›è€…feign-providerï¼š @GetMapping(&quot;/get/{id}&quot;) public String getById(@PathVariable(&quot;id&quot;) String id){ System.out.println(&quot;è¢«è°ƒç”¨ï¼Œæ—¶é—´ï¼š&quot; + System.currentTimeMillis()); try { TimeUnit.SECONDS.sleep(100); } catch (InterruptedException e) { e.printStackTrace(); } return &quot;feign-provider:com.jiguiquan.springcloud.controller.OrderController#getById=&quot; + id; } æœåŠ¡æ¶ˆè´¹è€…feign-consumerï¼š @GetMapping(&quot;test&quot;) public String test(){ return orderService.getById(&quot;100&quot;); } 2 ä¸é…ç½®ä»»ä½•é‡è¯•æœºåˆ¶ï¼Œä½¿ç”¨é»˜è®¤å€¼ è°ƒç”¨æ¥å£åï¼Œçœ‹æœåŠ¡æä¾›è€…çš„æ—¥å¿—ï¼ˆé‡è¯•äº†2æ¬¡ï¼Œæ—¶é—´é—´éš”ä¸º1ç§’ï¼‰ï¼š 3 æˆ‘ä»¬ä¸ºç³»ç»Ÿæ³¨å…¥Feignçš„é»˜è®¤Retryeré‡è¯•æœºåˆ¶ @Bean public Retryer retryer(){ return new Retryer.Default(); } å†æ¬¡è°ƒç”¨ï¼Œå†çœ‹æ—¥å¿—ï¼ˆé‡è¯•äº†10æ¬¡ï¼Œï¼‰ï¼š 4 Feignçš„é»˜è®¤é‡è¯•å™¨çš„æ ¸å¿ƒä»£ç ï¼ˆé»˜è®¤æ˜¯ä¸å¼€å¯çš„ï¼‰ public static class Default implements Retryer { private final int maxAttempts; private final long period; private final long maxPeriod; int attempt; long sleptForMillis; public Default() { // é»˜è®¤çš„é‡è¯•é—´éš”æ—¶é—´100msï¼Œæœ€å¤§é—´éš”æ—¶é—´ä¸º1sï¼Œæœ€å¤§é‡è¯•æ¬¡æ•°ä¸º5æ¬¡ this(100L, TimeUnit.SECONDS.toMillis(1L), 5); } // é»˜è®¤ä¸‹æ¬¡é‡è¯•é—´éš”æ—¶é—´ 100 * 1.5^(å°è¯•è½®æ¬¡-1) æ¬¡æ–¹ // ç¬¬ä¸€æ¬¡å°è¯•ï¼š100 * 1.5(2 -1) = 150ms; ä»¥æ­¤ç±»æ¨ long nextMaxInterval() { long interval = (long)((double)this.period * Math.pow(1.5D, (double)(this.attempt - 1))); return interval &gt; this.maxPeriod ? this.maxPeriod : interval; } } 5 Ribbonå’ŒFeignçš„é‡è¯•å™¨çš„æºç å°±ä¸è¿‡åº¦è¿½æº¯äº†ï¼Œç›´æ¥ä¸Šç»“è®º Ribbonçš„é‡è¯•æœºåˆ¶é»˜è®¤æ˜¯å¼€å¯çš„ï¼Œé‡è¯•1æ¬¡ï¼Œå…±è°ƒç”¨ä¸¤æ¬¡ï¼› Feignçš„Retryeré‡è¯•å™¨é»˜è®¤æ˜¯å…³é—­çš„ NEVER_RETRY; Feignå¦‚æœæƒ³å¼€å¯é»˜è®¤é‡è¯•å™¨ï¼Œç›´æ¥åœ¨Springå®¹å™¨ä¸­æ³¨å…¥ Retryer.Default å³å¯ï¼Œé»˜è®¤é‡è¯•5æ¬¡ï¼› 6 ä¿®æ”¹Ribbonçš„é»˜è®¤é‡è¯•æœºåˆ¶ # Ribbon é…ç½® ribbon: # å•èŠ‚ç‚¹æœ€å¤§é‡è¯•æ¬¡æ•°(ä¸åŒ…å«é»˜è®¤è°ƒç”¨çš„1æ¬¡)ï¼Œè¾¾åˆ°æœ€å¤§å€¼æ—¶ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç¤ºä¾‹ MaxAutoRetries: 0 # 0 ç›¸å½“äºå…³é—­ribboné‡è¯• # æ›´æ¢ä¸‹ä¸€ä¸ªé‡è¯•èŠ‚ç‚¹çš„æœ€å¤§æ¬¡æ•°ï¼Œå¯ä»¥è®¾ç½®ä¸ºæœåŠ¡æä¾›è€…å‰¯æœ¬æ•°ï¼ˆå‰¯æœ¬æ•° = æ€»æœºå™¨æ•° - 1ï¼‰ï¼Œä¹Ÿæ˜¯å°±æ¯ä¸ªå‰¯æœ¬éƒ½æŸ¥è¯¢ä¸€æ¬¡ MaxAutoRetriesNextServer: 0 # æ˜¯å¦å¯¹æ‰€æœ‰è¯·æ±‚è¿›è¡Œé‡è¯•ï¼Œé»˜è®¤fasleï¼Œåˆ™åªä¼šå¯¹GETè¯·æ±‚è¿›è¡Œé‡è¯•ï¼Œå»ºè®®é…ç½®ä¸ºfalseï¼Œä¸ç„¶æ·»åŠ æ•°æ®æ¥å£ï¼Œä¼šé€ æˆå¤šæ¡é‡å¤ï¼Œä¹Ÿå°±æ˜¯å¹‚ç­‰æ€§é—®é¢˜ã€‚ OkToRetryOnAllOperations: false 7 è‡ªå®šä¹‰Feigné‡è¯•æœºåˆ¶ï¼ˆç›´æ¥ç»™ Retryer.Default æ„é€ æ–¹æ³•ä¼ å‚å³å¯ï¼‰ @Bean public Retryer retryer(){ return new Retryer.Default(100, 1000, 3); // è°ƒç”¨3æ¬¡ï¼ˆåŒ…å«åŸæœ¬çš„ä¸€æ¬¡è°ƒç”¨ï¼‰ } å½“ç„¶ï¼Œå¦‚æœå¯¹ Retryer.Dafault çš„é»˜è®¤çš„æ–¹æ³•é€»è¾‘ä¸è®¤å¯ï¼Œå¯ä»¥ç›´æ¥å®ç°ä¸€ä¸ªè‡ªå·±çš„CustomRetryeræ³¨å…¥åˆ°springå®¹å™¨ä¸­å³å¯ï¼š @Bean public Retryer customerRetryer(){ return new Retryer() { @Override public void continueOrPropagate(RetryableException e) { } @Override public Retryer clone() { return null; } }; } ","link":"https://tianxiawuhao.github.io/Y45PUcltI/"},{"title":"Nacosæ ¸å¿ƒæºç å‰–æâ€”â€”é…ç½®ä¸­å¿ƒ","content":"Nacoså®˜æ–¹æ–‡æ¡£ï¼šhttps://nacos.io/zh-cn/docs/quick-start.html æœåŠ¡ç«¯å¯¹å¤–æš´éœ²çš„APIï¼šhttps://nacos.io/zh-cn/docs/open-api.html Nacosçš„Serverç«¯å…¶å®å°±æ˜¯ä¸€ä¸ªWebæœåŠ¡ï¼Œå¯¹å¤–æä¾›äº†HttpæœåŠ¡æ¥å£ï¼Œæ‰€æœ‰çš„å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„é€šè®¯éƒ½é€šè¿‡Httpè°ƒç”¨å®Œæˆï¼ˆçŸ­é“¾æ¥ï¼‰ã€‚ Nacosæ³¨å†ŒæœåŠ¡æ ¸å¿ƒç±»ï¼šNacosNamingService Nacosé…ç½®ä¸­å¿ƒæ ¸å¿ƒç±»ï¼šNacosConfigService Nacosé…ç½®ä¸­å¿ƒçš„nameSpace/Groupå’Œæ³¨å†Œä¸­å¿ƒç±»ä¼¼ï¼Œä½†æ˜¯æ²¡æœ‰é›†ç¾¤Clusterçš„æ¦‚å¿µï¼ é…ç½®æ–‡ä»¶çš„æ ¸å¿ƒä¸»é”®æ˜¯DataIdï¼ˆä¸æ³¨å†Œä¸­å¿ƒä¸ä¸€æ ·ï¼Œæ³¨å†Œä¸­å¿ƒä¸ºServiceNameï¼‰ spring: application: name: nacos-config-client cloud: nacos: config: server-addr: 10.206.73.156:8848 namespace: haier-iot group: dev file-extension: yaml # ä¸Šé¢çš„é…ç½®ï¼Œæ‹¼è£…æˆçš„æœ€é«˜ä¼˜å…ˆçº§é…ç½®æ–‡ä»¶ä¸º haier-iot/dev/ nacos-config-client-dev.yaml Nacosè¿˜æ”¯æŒæ‰©å±•é…ç½®ï¼šextension-configsï¼Œå’Œå…±äº«é…ç½®ï¼šshared-configsï¼Œä»¥æ”¯æŒå„ç§å¤æ‚çš„åº”ç”¨åœºæ™¯ï¼ å®˜æ–¹github wikiåœ°å€ï¼šhttps://github.com/alibaba/spring-cloud-alibaba/wiki/Nacos-config Clientå®¢æˆ·ç«¯æ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼š å½“éœ€è¦è·å–é…ç½®æ—¶ï¼Œå…ˆå°è¯•ä»æœ¬åœ°é…ç½®æ–‡ä»¶è·å–ï¼Œè·å–ä¸åˆ°æ—¶ï¼Œå†å»è¿œç«¯Serverè·å–ï¼›ä»è¿œç«¯è·å–æˆåŠŸåï¼Œä¿å­˜åˆ°æœ¬åœ°é…ç½®æ–‡ä»¶ï¼Œåé¢é€šè¿‡ClientWorkerä¸­çš„é•¿è½®è¯¢å®Œæˆé…ç½®çš„å®æ—¶æ›´æ–°! ClientWorkerä¸­æœ‰ä¸¤ä¸ªçº¿ç¨‹executorå’ŒexecutorServiceï¼š å•çº¿ç¨‹executorå®šæ—¶ä»»åŠ¡ï¼šæ¯10msæ‰§è¡ŒcheckConfigInfo()æ–¹æ³•ï¼Œçœ‹çœ‹æœ¬åœ°é…ç½®ä¿¡æ¯æ˜¯å¦æœ‰å˜åŒ–ï¼Œä»¥3000ä¸ªä¸ºä¸€ç»„ï¼Œåˆ¤æ–­æ˜¯å¦è¦å¢åŠ æ–°çš„LongPollingRunnableé•¿è½®è¯¢ä»»åŠ¡ï¼› å¤šçº¿ç¨‹executorServiceæ‰§è¡ŒLongPollingRunnableé•¿è½®è¯¢ä»»åŠ¡æ ¸å¿ƒé€»è¾‘ï¼šæ ¹æ®æœ¬åœ°é…ç½®é¡¹çš„dataIdï¼Œgroupï¼ŒMd5å€¼ï¼Œtenantæ‹¼æ¥å­—ç¬¦ä¸²ï¼Œè°ƒç”¨æœåŠ¡ç«¯â€œç›‘å¬é…ç½®â€”â€”é•¿è½®è¯¢æ¥å£â€çœ‹çœ‹è¿™æ‰¹æ¬¡çš„é…ç½®æ˜¯å¦æœ‰å˜åŒ–ï¼Œæœ‰å˜åŒ–çš„è¯ï¼Œå°±éå†è°ƒç”¨â€œè·å–é…ç½®è¯¦æƒ…æ¥å£â€è·å–æœ€æ–°é…ç½®å€¼ï¼Œæ²¡å˜åŒ–çš„ä¸ç”¨åŠ¨ï¼Œä»»åŠ¡æœ€åï¼Œå†æ¬¡æ‰§è¡Œthisï¼Œå¾ªç¯å¾€å¤æ‰§è¡Œæ­¤é•¿è½®è¯¢ä»»åŠ¡ï¼ å½“æœ¬åœ°çš„é…ç½®æ–‡ä»¶å‘ç”Ÿæ”¹å˜æ—¶ï¼Œä¼šå›è°ƒæ³¨å†Œåœ¨è¿™äº›é…ç½®ä¸Šçš„ç›‘å¬å™¨çš„å›è°ƒæ–¹æ³•ï¼Œä»è€Œå®Œæˆåº”ç”¨ç¨‹åºçš„é…ç½®æ›´æ–°ï¼ï¼ˆrefresh(context)åå®ŒæˆNacosç›‘å¬å™¨çš„æ³¨å†Œï¼‰ æœåŠ¡ç«¯æ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼š æœåŠ¡ç«¯å³ä½¿é…ç½®äº†mysqlï¼Œæ¯æ¬¡è¯·æ±‚ä¹Ÿä¸æ˜¯ç›´æ¥å»æŸ¥è¯¢mysqlçš„ï¼Œè€Œæ˜¯å€ŸåŠ© æœ¬åœ°å†…å­˜ç¼“å­˜ä¸­çš„å…ƒæ•°æ® + æœ¬åœ°ç£ç›˜ä¸­çš„é…ç½®æ–‡ä»¶ï¼› Mysqlä¸»è¦ç”¨äºé›†ç¾¤èŠ‚ç‚¹å¯åŠ¨æ—¶çš„æ•°æ®åŠ è½½ï¼ˆå…¨é‡åŠ è½½ã€å¢é‡åŠ è½½ï¼‰ å’Œ æ•°æ®å˜åŠ¨æ—¶çš„åˆ·æ–°åŒæ­¥ï¼› æŸèŠ‚ç‚¹å¤„ç†é…ç½®å‘å¸ƒè¯·æ±‚æ—¶ï¼Œä¸æ˜¯ç€æ€¥æ›´æ–°è‡ªå·±çš„çŠ¶æ€ï¼Œè€Œæ˜¯ä¼šå…ˆå†™å…¥mysqlæ•°æ®åº“ï¼Œä¹‹åé€šè¿‡ConfigDataChangeEventäº‹ä»¶å®ç°å¼‚æ­¥å¤„ç†ï¼Œé€šçŸ¥æ‰€æœ‰èŠ‚ç‚¹æ›´æ–°è‡ªå·±çš„å†…å­˜ç¼“å­˜å’Œæœ¬åœ°ç£ç›˜æ–‡ä»¶ï¼›ï¼ˆåŒ…æ‹¬è‡ªå·±ï¼‰ APé›†ç¾¤ï¼Œå­˜åœ¨æ•°æ®çš„çŸ­æ—¶é—´ä¸ä¸€è‡´ï¼Œä½†æ˜¯å¯ä»¥ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œå¯¹å®¢æˆ·ç«¯çš„å½±å“ä¹Ÿå°±æ˜¯å¯èƒ½é…ç½®æ›´æ–°æ…¢é‚£ä¹ˆä¸€ç‚¹ã€‚ ä¸€ nacoså®¢æˆ·ç«¯åŠ è½½é…ç½®çš„æ ¸å¿ƒé€»è¾‘ 1 nacosæ ¸å¿ƒé…ç½®NacosPropertySourceLocatorç±»çš„å®šä½ï¼š å¦‚æœè¦å¼„æ¸…æ¥šNacosé…ç½®æ–‡ä»¶åŠ è½½åˆ°Springå®¹å™¨ä¸­çš„æµç¨‹ï¼Œè¿˜éœ€è¦ç†Ÿæ‚‰Springcloudçš„æºç æµç¨‹ï¼Œäº†è§£Springcloudä¸­çš„é…ç½®ï¼Œè¿˜æœ‰é‡è¦çš„Beanæ˜¯å¦‚æœè£…è½½åˆ°Springå®¹å™¨ä¸­çš„ï¼› è¿™é‡Œåªèƒ½å¤§æ¦‚èŠä¸€ä¸‹ï¼š Springbooté¡¹ç›®å¯åŠ¨æ—¶ï¼Œåœ¨prepareEnvironment()é˜¶æ®µï¼Œä¼šé€šè¿‡spring.factoriesæ–‡ä»¶ä¸­çš„BootstrapConfigurationç±»æ‰¾åˆ°NacosConfigBootstrapConfigurationé…ç½®ç±»ï¼Œå¹¶å®Œæˆæ³¨å…¥ï¼š NacosConfigBootstrapConfigurationé…ç½®ç±»ï¼Œä¼šå‘Springå®¹å™¨ä¸­æ³¨å…¥å‡ ä¸ªNacosé…ç½®è¯»å–é‡è¦çš„ç±» public class NacosConfigBootstrapConfiguration { public NacosConfigBootstrapConfiguration() { } @Bean @ConditionalOnMissingBean public NacosConfigProperties nacosConfigProperties() { return new NacosConfigProperties(); } @Bean @ConditionalOnMissingBean public NacosConfigManager nacosConfigManager(NacosConfigProperties nacosConfigProperties) { return new NacosConfigManager(nacosConfigProperties); } // NacosPropertySourceLocatorèƒ½å¤Ÿä¸€æ­¥æ­¥åœ°æŠŠæŠŠNacosçš„é…ç½®æ–‡ä»¶éƒ½æ‰¾åˆ° @Bean public NacosPropertySourceLocator nacosPropertySourceLocator(NacosConfigManager nacosConfigManager) { return new NacosPropertySourceLocator(nacosConfigManager); } } ç„¶ååœ¨prepareContext()ä¸Šä¸‹æ–‡çš„æ—¶å€™ï¼Œä¼šé€šè¿‡ä¹‹å‰ä»spring.factoriesä¸­è¯»å–åˆ°çš„ApplicationInitializeråˆå§‹åŒ–å™¨ï¼Œè¿™é‡Œéå†æ‰§è¡Œæ—¶ï¼Œå°±ä¼šæ‰§è¡Œåˆ°springcloudçš„PropertySpurceBootstrapConfigurationç±»çš„initialize()æ–¹æ³•ï¼š å¯ä»¥çœ‹åˆ°PropertySpurceBootstrapConfiguration.initialize()æ–¹æ³•ä¸­éœ€è¦ç”¨åˆ°PropertySourceLocatoræ¥å£çš„å®ç°ç±»ï¼Œè€Œæˆ‘ä»¬é…ç½®çš„Nacosæ­£å¥½ä¸ºè¿™ä¸ªæ¥å£æä¾›äº†å®ç°ç±»NacosPropertySourceLocator 2 é€šè¿‡NacosPropertySourceLocatorç±»ï¼Œç†æ¸…Nacoså„ä¸­é…ç½®æ–‡ä»¶çš„ä¼˜å…ˆçº§ï¼š // com.alibaba.cloud.nacos.client.NacosPropertySourceLocator#locate public PropertySource&lt;?&gt; locate(Environment env) { this.nacosConfigProperties.setEnvironment(env); ConfigService configService = this.nacosConfigManager.getConfigService(); if (null == configService) { log.warn(&quot;no instance of config service found, can't load config from nacos&quot;); return null; } else { long timeout = (long)this.nacosConfigProperties.getTimeout(); this.nacosPropertySourceBuilder = new NacosPropertySourceBuilder(configService, timeout); String name = this.nacosConfigProperties.getName(); String dataIdPrefix = this.nacosConfigProperties.getPrefix(); if (StringUtils.isEmpty(dataIdPrefix)) { dataIdPrefix = name; } if (StringUtils.isEmpty(dataIdPrefix)) { dataIdPrefix = env.getProperty(&quot;spring.application.name&quot;); } CompositePropertySource composite = new CompositePropertySource(&quot;NACOS&quot;); // 1. å…ˆåŠ è½½å…±äº«é…ç½®æ–‡ä»¶ this.loadSharedConfiguration(composite); // 2. å†åŠ è½½æ‰©å±•é…ç½®æ–‡ä»¶ this.loadExtConfiguration(composite); // 3. æœ€åæ‰åŠ è½½æœ¬åº”ç”¨è‡ªå·±çš„é…ç½®æ–‡ä»¶ this.loadApplicationConfiguration(composite, dataIdPrefix, this.nacosConfigProperties, env); return composite; } } æœ¬åº”ç”¨è‡ªå·±çš„é…ç½®æ–‡ä»¶ä¹Ÿæ˜¯å¯ä»¥å­˜åœ¨å¤šä¸ªçš„ï¼Œä¹Ÿæ˜¯æœ‰ä¼˜å…ˆçº§çš„ï¼š // å…¥å‚ä¸­çš„dataIdPrefixï¼Œç†è§£ä¸ºå°±æ˜¯spring.application.name private void loadApplicationConfiguration(CompositePropertySource compositePropertySource, String dataIdPrefix, NacosConfigProperties properties, Environment environment) { String fileExtension = properties.getFileExtension(); String nacosGroup = properties.getGroup(); // 1. å…ˆå°è¯•åŠ è½½ï¼šçº¯å¾®æœåŠ¡åç§°å¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼Œå¦‚ï¼šorder-config this.loadNacosDataIfPresent(compositePropertySource, dataIdPrefix, nacosGroup, fileExtension, true); // 2. å†å°è¯•åŠ è½½ï¼šå¾®æœåŠ¡åç§° + &quot;.&quot; + æ–‡ä»¶æ‰©å±•åçš„æ–‡ä»¶ï¼Œå¦‚ï¼šorder-config.yaml this.loadNacosDataIfPresent(compositePropertySource, dataIdPrefix + &quot;.&quot; + fileExtension, nacosGroup, fileExtension, true); String[] var7 = environment.getActiveProfiles(); int var8 = var7.length; // 3. æœ€åå†å°è¯•åŠ è½½ï¼šå¾®æœåŠ¡åç§° + &quot;-&quot; + profile + &quot;.&quot; + æ–‡ä»¶æ‰©å±•åçš„æ–‡ä»¶ï¼Œå¦‚ï¼šorder-config-dev.yaml for(int var9 = 0; var9 &lt; var8; ++var9) { String profile = var7[var9]; String dataId = dataIdPrefix + &quot;-&quot; + profile + &quot;.&quot; + fileExtension; this.loadNacosDataIfPresent(compositePropertySource, dataId, nacosGroup, fileExtension, true); } } æ ¹æ®ååŠ è½½çš„è¦†ç›–å…ˆåŠ è½½çš„åŸåˆ™ï¼Œæœ€åæˆ‘ä»¬å¾ˆå®¹æ˜“å°±å¯ä»¥çŸ¥é“æ•´ä¸ªæœåŠ¡çš„é…ç½®æ–‡ä»¶çš„ä¼˜å…ˆçº§ä¸ºï¼š order-config-dev.yaml &gt; order-config.yaml &gt; order-config &gt; extension-configs &gt; shared-configs äºŒ Nacosé…ç½®ä¸­å¿ƒçš„æ ¸å¿ƒç±»NacosConfigServiceçš„å¼•å…¥ 1 å®¢æˆ·ç«¯æ˜¯ä½•æ—¶ä»è¿œç¨‹é…ç½®NacosæœåŠ¡ç«¯æ‹‰å–é…ç½®çš„ // è¿˜è®°å¾—åˆšå¼€å§‹æ—¶å€™ï¼Œé€šè¿‡spring.factoriesæ³¨å…¥äº†ä¸€ä¸ªé…ç½®ç±»NacosConfigBootstrapConfiguration // è¯¥é…ç½®ç±»ï¼Œä¼šå‘Springå®¹å™¨ä¸­æ³¨å…¥ä¸€ä¸ªBeanï¼šNacosConfigManager @Bean @ConditionalOnMissingBean public NacosConfigManager nacosConfigManager(NacosConfigProperties nacosConfigProperties) { return new NacosConfigManager(nacosConfigProperties); } //è€ŒNacosConfigManagerçš„æ„é€ æ–¹æ³•ä¸­ï¼Œå°±ä¼šâ€œå†™æ­»â€ä¸ºæˆ‘ä»¬createä¸€ä¸ªConfigServiceï¼Œèµ‹å€¼ç»™é™æ€å˜é‡service private static ConfigService service = createConfigService(nacosConfigProperties); | public static ConfigService createConfigService(Properties properties) throws NacosException { try { Class&lt;?&gt; driverImplClass = Class.forName(&quot;com.alibaba.nacos.client.config.NacosConfigService&quot;); Constructor constructor = driverImplClass.getConstructor(Properties.class); ConfigService vendorImpl = (ConfigService)constructor.newInstance(properties); return vendorImpl; } catch (Throwable var4) { throw new NacosException(-400, var4); } } æ­¤æ—¶ï¼ŒNacosConfigServiceé—ªäº®ç™»åœºï¼ 2 NacosConfigServiceç±»çš„æ„é€ æ–¹æ³•ä¸­ä¼šåˆ›å»ºé‡è¦çš„ä¸¤ä¸ªå±æ€§agentå’Œworkerï¼š public NacosConfigService(Properties properties) throws NacosException { ValidatorUtils.checkInitParam(properties); String encodeTmp = properties.getProperty(PropertyKeyConst.ENCODE); if (StringUtils.isBlank(encodeTmp)) { this.encode = Constants.ENCODE; } else { this.encode = encodeTmp.trim(); } initNamespace(properties); // agentæ˜¯ä¸€ä¸ªhttpä»£ç†ï¼Œå¦‚æœéœ€è¦ç™»å½•éªŒè¯ç­‰æ“ä½œï¼ŒServerHttpAgentæ„é€ æ—¶ä¼šå®ŒæˆéªŒè¯ this.agent = new MetricsHttpAgent(new ServerHttpAgent(properties)); this.agent.start(); // å®¢æˆ·ç«¯çš„å®é™…å·¥ä½œè€…ClientWorkerï¼Œå…¶ä¸­çš„agentä¹Ÿå°±æ˜¯ä¸Šé¢åˆ›å»ºçš„agent this.worker = new ClientWorker(this.agent, this.configFilterChainManager, properties); } 3 NacosConfigServiceä¸­çš„æ ¸å¿ƒè·å–é…ç½®æ–¹æ³•getConfig() â€”â€”&gt; getConfigInner()ï¼š å®¢æˆ·ç«¯éœ€è¦ä½¿ç”¨é…ç½®æ–‡ä»¶æ—¶ï¼Œä¸æ˜¯ç›´æ¥å»è°ƒç”¨è¿œç«¯Serverè·å–ï¼Œè€Œæ˜¯å…ˆå°è¯•ä»æœ¬åœ°Failoveræ–‡ä»¶è·å–ï¼› å¦‚æœæœ¬åœ°æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™æ‰ä¼šä»è¿œç«¯Serverè·å–ï¼› ä»è¿œç«¯ServeræˆåŠŸè·å–é…ç½®åï¼Œä¼šå‘æœ¬åœ°æ–‡ä»¶ä¿å­˜å¿«ç…§ï¼Œä»¥å¤‡åç”¨ï¼›ï¼ˆæœ¬åœ°æ–‡ä»¶çš„æ›´æ–°ç”±åé¢çš„é•¿è½®è¯¢å®Œæˆï¼‰ private String getConfigInner(String tenant, String dataId, String group, long timeoutMs) throws NacosException { group = null2defaultGroup(group); ParamUtils.checkKeyParam(dataId, group); ConfigResponse cr = new ConfigResponse(); cr.setDataId(dataId); cr.setTenant(tenant); cr.setGroup(group); // ä¼˜å…ˆä½¿ç”¨æœ¬åœ°é…ç½® String content = LocalConfigInfoProcessor.getFailover(agent.getName(), dataId, group, tenant); if (content != null) { cr.setContent(content); configFilterChainManager.doFilter(null, cr); content = cr.getContent(); return content; } try { // æœ¬åœ°æ²¡æœ‰åï¼Œå°±å°è¯•ä»è¿œç«¯è·å–é…ç½® String[] ct = worker.getServerConfig(dataId, group, tenant, timeoutMs); cr.setContent(ct[0]); configFilterChainManager.doFilter(null, cr); content = cr.getContent(); return content; } catch (NacosException ioe) { ...... } ...... return content; } æ‰€ä»¥Nacosé…ç½®ä¸­å¿ƒä¸æ³¨å†Œä¸­å¿ƒç±»ä¼¼ï¼Œéƒ½æ˜¯å…ˆå°è¯•ä»æœ¬åœ°è·å–é…ç½®ï¼Œåªä¸è¿‡æ³¨å†Œä¸­å¿ƒæ¯”é…ç½®ä¸­å¿ƒå¤šäº†ä¸€ä»½å†…å­˜æ³¨å†Œè¡¨ï¼ æ³¨å†Œä¸­å¿ƒï¼šæœ¬åœ°Failoveræ•…éšœè½¬ç§»æ–‡ä»¶ â€”â€”&gt; æœ¬åœ°å†…å­˜æ³¨å†Œè¡¨ â€”â€”&gt; è¿œç«¯è¯·æ±‚æœåŠ¡åˆ—è¡¨ é…ç½®ä¸­å¿ƒï¼šæœ¬åœ°Failoveræ•…éšœè½¬ç§»æ–‡ä»¶ï¼ˆä¹Ÿå°±æ˜¯æœ¬åœ°é…ç½®å¿«ç…§æ–‡ä»¶ï¼‰â€”â€”&gt; è¿œç«¯è¯·æ±‚é…ç½®æ–‡ä»¶ worker.getServerConfig()è¿œç«¯é…ç½®è¯·æ±‚æˆåŠŸåï¼Œè¿˜ä¼šå¾€æœ¬åœ°é…ç½®æ–‡ä»¶å­˜ä¸€ä»½Snapshotï¼š // worker.getServerConfig() public String[] getServerConfig(String dataId, String group, String tenant, long readTimeout){ // ä»è¿œç«¯Serverè·å–é…ç½®ï¼Œè¿™é‡Œçš„agentå°±æ˜¯NacosConfigServiceæ„é€ æ–¹æ³•ä¸­åˆ›å»ºçš„agentä»£ç† result = agent.httpGet(Constants.CONFIG_CONTROLLER_PATH, null, params, agent.getEncode(), readTimeout); switch (result.getCode()) { case HttpURLConnection.HTTP_OK: // å¾€æœ¬åœ°é…ç½®å¿«ç…§æ–‡ä»¶å­˜ä¸€ä»½ LocalConfigInfoProcessor.saveSnapshot(agent.getName(), dataId, group, tenant, result.getData()); ct[0] = result.getData(); if (result.getHeader().getValue(CONFIG_TYPE) != null) { ct[1] = result.getHeader().getValue(CONFIG_TYPE); } else { ct[1] = ConfigType.TEXT.getType(); } return ct; case HttpURLConnection.HTTP_NOT_FOUND: LocalConfigInfoProcessor.saveSnapshot(agent.getName(), dataId, group, tenant, null); return ct; case HttpURLConnection.HTTP_CONFLICT: { ... } case HttpURLConnection.HTTP_FORBIDDEN: { ... } default: { ... } } } 4 Clientç¬¬ä¸€æ¬¡è·å–åˆ°Serverç«¯é…ç½®åï¼Œä¹‹åå¦‚ä½•è¿›è¡Œå®šæ—¶æ›´æ–°ï¼Ÿ // ClientWorkeræ„é€ æ—¶ï¼Œä¼šåˆ›å»º2ä¸ªçº¿ç¨‹æ±  // 1. executor(å•çº¿ç¨‹) ï¼šå®šæ—¶æ¯10æ¯«ç§’æ‰§è¡ŒcheckConfigInfo()æ–¹æ³• // 2. executorService(1~æ ¸æ•°/2): å…·ä½“çš„æ‰§è¡Œé•¿è½®è¯¢çš„çº¿ç¨‹ public ClientWorker(final HttpAgent agent, final ConfigFilterChainManager configFilterChainManager,final Properties properties) { this.agent = agent; this.configFilterChainManager = configFilterChainManager; // Initialize the timeout parameter init(properties); this.executor = Executors.newScheduledThreadPool(1, new ThreadFactory() { @Override public Thread newThread(Runnable r) { Thread t = new Thread(r); t.setName(&quot;com.alibaba.nacos.client.Worker.&quot; + agent.getName()); t.setDaemon(true); return t; } }); this.executorService = Executors .newScheduledThreadPool(Runtime.getRuntime().availableProcessors(), new ThreadFactory() { @Override public Thread newThread(Runnable r) { Thread t = new Thread(r); t.setName(&quot;com.alibaba.nacos.client.Worker.longPolling.&quot; + agent.getName()); t.setDaemon(true); return t; } }); this.executor.scheduleWithFixedDelay(new Runnable() { @Override public void run() { try { checkConfigInfo(); } catch (Throwable e) { LOGGER.error(&quot;[&quot; + agent.getName() + &quot;] [sub-check] rotate check error&quot;, e); } } }, 1L, 10L, TimeUnit.MILLISECONDS); } public void checkConfigInfo() { // å°†æ€»çš„éœ€è¦ç›‘å¬çš„é…ç½®æ•°ï¼Œä»¥3000ä¸ªä¸ºä¸€ç»„ï¼Œåˆ›å»ºé•¿è½®è¯¢LongPollingRunnableä»»åŠ¡ï¼Œç›‘å¬é…ç½®æ›´æ–°ï¼ int listenerSize = cacheMap.get().size(); int longingTaskCount = (int) Math.ceil(listenerSize / ParamUtil.getPerTaskConfigSize()); if (longingTaskCount &gt; currentLongingTaskCount) { for (int i = (int) currentLongingTaskCount; i &lt; longingTaskCount; i++) { // å®é™…çš„å¹²æ´»çº¿ç¨‹ï¼Œä»è¿œç«¯æ‹‰å–æœ€æ–°çš„configï¼Œä¸æœ¬åœ°çš„configå¯¹æ¯”MD5å€¼ï¼Œçœ‹æ˜¯å¦å‘ç”Ÿå˜åŒ– executorService.execute(new LongPollingRunnable(i)); } currentLongingTaskCount = longingTaskCount; } } æ€»ç»“ï¼šClientWorkerå®ä¾‹åŒ–æ—¶ï¼Œä¼šåˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ï¼šexecutorå’ŒexecutorService executorï¼ˆå•çº¿ç¨‹ï¼‰ï¼šæ¯éš”10msæ£€æŸ¥æœ¬åœ°çš„é…ç½®æ•°æ˜¯å¦å‘ç”Ÿæ”¹å˜ï¼Œä»¥3000ä¸ºä¸€æ‰¹æ¬¡åˆ›å»ºé•¿è½®è¯¢ä»»åŠ¡ï¼Œä¸è¶³çš„è¯ï¼Œä¸å¦å¤–åˆ›å»ºé•¿è½®è¯¢ä»»åŠ¡ï¼› executorServiceï¼ˆå¤šçº¿ç¨‹1~æ ¸æ•°/2ï¼‰:å…·ä½“æ‰§è¡Œé•¿è½®è¯¢LongPollingä»»åŠ¡çš„å·¥ä½œçº¿ç¨‹ï¼› 5 Nacoså®¢æˆ·ç«¯é•¿è½®è¯¢LongPollingä»»åŠ¡çš„æ ¸å¿ƒé€»è¾‘ï¼ˆmd5æ¯”å¯¹ï¼‰ï¼š ç›‘å¬é…ç½®çš„é•¿è½®è¯¢æ¥å£APIï¼šhttps://nacos.io/zh-cn/docs/open-api.html // LongPollingRunnable.run() public void run() { List&lt;CacheData&gt; cacheDatas = new ArrayList&lt;CacheData&gt;(); List&lt;String&gt; inInitializingCacheList = new ArrayList&lt;String&gt;(); try { // æ£€æŸ¥æœ¬åœ°çš„é…ç½®æ–‡ä»¶ for (CacheData cacheData : cacheMap.get().values()) { if (cacheData.getTaskId() == taskId) { cacheDatas.add(cacheData); try { checkLocalConfig(cacheData); if (cacheData.isUseLocalConfigInfo()) { cacheData.checkListenerMd5(); } } catch (Exception e) { LOGGER.error(&quot;get local config info error&quot;, e); } } } // ä¼šæ ¹æ®ä¸Šé¢å¾—åˆ°çš„cacheDatasï¼Œç»„è£…å‚æ•°ï¼Œè°ƒç”¨æœåŠ¡ç«¯çš„ç›‘å¬é…ç½®çš„é•¿è½®è¯¢æ¥å£/nacos/v1/cs/configs/listener // é•¿è½®è¯¢çš„è¿”å›å€¼æ˜¯dataId^2group^2tenant^1ï¼Œç©ºä¸²ä»£è¡¨æ— å˜åŒ– List&lt;String&gt; changedGroupKeys = checkUpdateDataIds(cacheDatas, inInitializingCacheList); if (!CollectionUtils.isEmpty(changedGroupKeys)) { LOGGER.info(&quot;get changedGroupKeys:&quot; + changedGroupKeys); } for (String groupKey : changedGroupKeys) { String[] key = GroupKey.parseKey(groupKey); String dataId = key[0]; String group = key[1]; String tenant = null; if (key.length == 3) { tenant = key[2]; } try { // ä¼šæ ¹æ®è¿”å›å€¼ä¸­æœ‰å˜åŒ–çš„dataIdé…ç½®é¡¹ï¼Œå•ç‹¬å»è·å–æœ€æ–°çš„é…ç½®å€¼å›æœ¬åœ° String[] ct = getServerConfig(dataId, group, tenant, 3000L); CacheData cache = cacheMap.get().get(GroupKey.getKeyTenant(dataId, group, tenant)); cache.setContent(ct[0]); if (null != ct[1]) { cache.setType(ct[1]); } LOGGER.info(&quot;[{}] [data-received] dataId={}, group={}, tenant={}, md5={}, content={}, type={}&quot;, agent.getName(), dataId, group, tenant, cache.getMd5(), ContentUtils.truncateContent(ct[0]), ct[1]); } catch (NacosException ioe) { String message = String .format(&quot;[%s] [get-update] get changed config exception. dataId=%s, group=%s, tenant=%s&quot;, agent.getName(), dataId, group, tenant); LOGGER.error(message, ioe); } } for (CacheData cacheData : cacheDatas) { if (!cacheData.isInitializing() || inInitializingCacheList .contains(GroupKey.getKeyTenant(cacheData.dataId, cacheData.group, cacheData.tenant))) { cacheData.checkListenerMd5(); cacheData.setInitializing(false); } } inInitializingCacheList.clear(); // å†æ¬¡æ‰§è¡Œè¯¥æ–¹æ³•ï¼Œä¸æ–­å¾ªç¯ï¼Œä¸åœç›‘å¬é…ç½®æ–‡ä»¶çš„æ›´æ–° executorService.execute(this); } catch (Throwable e) { // If the rotation training task is abnormal, the next execution time of the task will be punished LOGGER.error(&quot;longPolling error : &quot;, e); executorService.schedule(this, taskPenaltyTime, TimeUnit.MILLISECONDS); } } checkUpdateDataIds(cacheDatas, inInitializingCacheList)æ ¸å¿ƒé€»è¾‘ï¼š // æ‹¼æ¥æœ¬åœ°æ‰€æœ‰çš„dataIdä¸ºä¸€ä¸ªé•¿å­—ç¬¦ä¸² List&lt;String&gt; checkUpdateDataIds(List&lt;CacheData&gt; cacheDatas, List&lt;String&gt; inInitializingCacheList) throws Exception { StringBuilder sb = new StringBuilder(); for (CacheData cacheData : cacheDatas) { if (!cacheData.isUseLocalConfigInfo()) { sb.append(cacheData.dataId).append(WORD_SEPARATOR); sb.append(cacheData.group).append(WORD_SEPARATOR); if (StringUtils.isBlank(cacheData.tenant)) { sb.append(cacheData.getMd5()).append(LINE_SEPARATOR); } else { sb.append(cacheData.getMd5()).append(WORD_SEPARATOR); sb.append(cacheData.getTenant()).append(LINE_SEPARATOR); } if (cacheData.isInitializing()) { // It updates when cacheData occours in cacheMap by first time. inInitializingCacheList .add(GroupKey.getKeyTenant(cacheData.dataId, cacheData.group, cacheData.tenant)); } } } boolean isInitializingCacheList = !inInitializingCacheList.isEmpty(); return checkUpdateConfigStr(sb.toString(), isInitializingCacheList); } // å‘æœåŠ¡ç«¯å‘èµ·é•¿è½®è¯¢çš„æŸ¥è¯¢é€»è¾‘ï¼Œè¶…æ—¶ä¸º30ç§’ï¼Œä¸è¦æŒ‚èµ·æˆ‘ List&lt;String&gt; checkUpdateConfigStr(String probeUpdateString, boolean isInitializingCacheList) { Map&lt;String, String&gt; params = new HashMap&lt;String, String&gt;(2); params.put(Constants.PROBE_MODIFY_REQUEST, probeUpdateString); Map&lt;String, String&gt; headers = new HashMap&lt;String, String&gt;(2); headers.put(&quot;Long-Pulling-Timeout&quot;, &quot;&quot; + timeout); if (isInitializingCacheList) { headers.put(&quot;Long-Pulling-Timeout-No-Hangup&quot;, &quot;true&quot;); } if (StringUtils.isBlank(probeUpdateString)) { return Collections.emptyList(); } try { // In order to prevent the server from handling the delay of the client's long task, // increase the client's read timeout to avoid this problem. long readTimeoutMs = timeout + (long) Math.round(timeout &gt;&gt; 1); HttpRestResult&lt;String&gt; result = agent .httpPost(Constants.CONFIG_CONTROLLER_PATH + &quot;/listener&quot;, headers, params, agent.getEncode(), readTimeoutMs); if (result.ok()) { setHealthServer(true); return parseUpdateDataIdResponse(result.getData()); } else { setHealthServer(false); LOGGER.error(&quot;[{}] [check-update] get changed dataId error, code: {}&quot;, agent.getName(), result.getCode()); } } catch (Exception e) { setHealthServer(false); LOGGER.error(&quot;[&quot; + agent.getName() + &quot;] [check-update] get changed dataId exception&quot;, e); throw e; } return Collections.emptyList(); } æ€»ç»“ï¼šé•¿è½®è¯¢LongPollingRunnableé•¿è½®è¯¢ä»»åŠ¡çš„æ ¸å¿ƒé€»è¾‘å°±æ˜¯ï¼š å…ˆæŸ¥è¯¢æœ¬åœ°é…ç½®æ–‡ä»¶Failoveræ–‡ä»¶ï¼ˆæœ¬åœ°é…ç½®å¿«ç…§Snapshotæ–‡ä»¶ï¼‰ï¼› æ ¹æ®æœ¬åœ°é…ç½®æ–‡ä»¶ï¼Œå¾—åˆ°æ‰€æœ‰é…ç½®é¡¹ï¼Œæ‹¼æ¥è¯·æ±‚å‚æ•°ï¼ˆdataId/group/Md5/tenantï¼‰ï¼Œå‘æœåŠ¡ç«¯æä¾›çš„é•¿è½®è¯¢æ¥å£ï¼ˆç›‘å¬é…ç½®ï¼‰ï¼šPOSTï¼š/nacos/v1/cs/configs/listener å‘èµ·é•¿è½®è¯¢è°ƒç”¨ï¼› å¦‚æœæœ¬æ‰¹æ¬¡çš„é…ç½®é¡¹æœ‰å˜åŠ¨ï¼ŒæœåŠ¡ç«¯å°±ä¼šè¿”å›æœ‰å˜åŠ¨çš„é…ç½®é¡¹å­—ç¬¦ä¸²æ•°ç»„ï¼Œå¦‚æœæ²¡æœ‰å˜åŠ¨ï¼Œå°±è¿”å›ç©ºä¸²ï¼› å¦‚æœè¿”å›ä¸ä¸ºç©ºï¼Œè¯´æ˜æœ‰å˜åŠ¨ï¼Œå°±éå†è¿™äº›å˜åŠ¨é¡¹ï¼Œç„¶åé€šè¿‡å…·ä½“çš„è·å–é…ç½®æ¥å£ï¼šGETï¼š/nacos/v1/cs/configs è·å–è¯¥é…ç½®é¡¹çš„æœ€æ–°é…ç½®ï¼› æœ€åï¼Œå†æ¬¡æ‰§è¡Œæœ¬æ¬¡çš„ LongPollingRunnable ä»»åŠ¡ï¼Œå¾ªç¯å¾€å¤ï¼Œå®Œæˆé…ç½®çš„å®æ—¶ç›‘å¬æ›´æ–°ï¼ 6 ç»è¿‡é•¿è½®è¯¢åï¼Œå¦‚æœæœ¬åœ°é…ç½®æ–‡ä»¶æ›´æ–°åï¼Œè¯¥å¦‚ä½•é€šçŸ¥åˆ°æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼ˆæ³¨å†Œç›‘å¬å™¨ï¼‰ï¼Ÿ åœ¨Springbooté¡¹ç›®å®Œæˆrefresh(context)åï¼Œä¼šè°ƒç”¨ listeners.running(context) æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šå‘ç³»ç»Ÿå‘å‡ºApplicationReadyEventäº‹ä»¶ï¼Œå…¶å®ƒçš„ç›‘å¬äº†è¿™ä¸ªäº‹ä»¶çš„Listenerå°±å¯ä»¥åšå¯¹åº”çš„å·¥ä½œäº†ï¼Œè€ŒNacosContextRefresherå°±æ˜¯å…¶ä¸­ä¹‹ä¸€ï¼ public class NacosContextRefresher implements ApplicationListener&lt;ApplicationReadyEvent&gt;, ApplicationContextAware { // ç›‘å¬åˆ°ApplicationReadyEventäº‹ä»¶åï¼Œå¼€å§‹æ³¨å†ŒNacosçš„ç›‘å¬å™¨ public void onApplicationEvent(ApplicationReadyEvent event) { if (this.ready.compareAndSet(false, true)) { this.registerNacosListenersForApplications(); } } private void registerNacosListenersForApplications() { if (this.isRefreshEnabled()) { Iterator var1 = NacosPropertySourceRepository.getAll().iterator(); while(var1.hasNext()) { NacosPropertySource propertySource = (NacosPropertySource)var1.next(); if (propertySource.isRefreshable()) { // é»˜è®¤ä½¿å¼€å¯çš„ String dataId = propertySource.getDataId(); this.registerNacosListener(propertySource.getGroup(), dataId); } } } } } æœ‰äº†è¿™ä¸€ç³»åˆ—çš„ç›‘å¬å™¨ï¼Œå½“å®¢æˆ·ç«¯çŸ¥é“é…ç½®å‘ç”Ÿæ”¹å˜æ—¶ï¼Œå°±ä¼šå›è°ƒå¯¹åº”çš„ç›‘å¬å™¨çš„å›è°ƒæ–¹æ³•ï¼Œé€šçŸ¥åº”ç”¨ç¨‹åºæ›´æ–°å¯¹åº”çš„Beanï¼ˆä»IOCå®¹å™¨ä¸­åˆ é™¤æ—§Beanï¼Œæ”¾å…¥æ–°çš„Beanï¼‰ã€‚ ä¸‰ APæ¨¡å¼nacosé›†ç¾¤ï¼ŒæœåŠ¡ç«¯å¦‚ä½•å·¥ä½œ é¦–å…ˆä¸€å®šè¦æ¸…æ¥šï¼Œå³ä½¿é›†ç¾¤æƒ…å†µä¸‹ï¼Œé…ç½®äº†mysqlï¼Œå½“å®¢æˆ·ç«¯æŸ¥è¯¢é…ç½®æ—¶ï¼Œä¹Ÿä¸æ˜¯ç›´æ¥ä»mysqlè·å–çš„ï¼Œè€Œæ˜¯ä»æ¯ä¸ªèŠ‚ç‚¹çš„æœ¬åœ°æ–‡ä»¶è¯»å–ï¼› å„èŠ‚ç‚¹æœ¬åœ°æ–‡ä»¶ï¼šå…·ä½“çš„é…ç½®ï¼› å„èŠ‚ç‚¹å†…å­˜ç¼“å­˜ï¼šå­˜å‚¨é…ç½®çš„å…ƒä¿¡æ¯ï¼Œå¦‚Md5å€¼ç­‰ï¼› Mysqlï¼šå…·ä½“çš„é…ç½®çš„æœ€æ–°å€¼å’Œå†å²è®°å½•ï¼Œæ–¹ä¾¿æ–°èŠ‚ç‚¹å¯åŠ¨æ—¶åŠ è½½ï¼Œä»¥åŠèŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®åŒæ­¥ï¼› 1 é…ç½®æ–‡ä»¶çš„DumpåŠ è½½ï¼šDumpService DumpServiceç”±ä¸¤ä¸ªå®ç°ç±»ï¼šEmbeddedDumpServiceï¼ˆderbyï¼‰ å’Œ ExternalDumpServiceï¼ˆmysqlï¼‰ï¼› å½“æ–°èŠ‚ç‚¹å¯åŠ¨æ—¶ï¼Œéœ€è¦ä»mysqlä¸­åŠ è½½é…ç½®æ•°æ®ï¼Œå¦‚æœæœ€åå¿ƒè·³æ—¶é—´&gt;6hï¼Œåˆ™ä»mysqlåŠ è½½å…¨é‡æ•°æ®ï¼›å¦‚æœæœ€åå¿ƒè·³æ—¶é—´&lt;6hï¼Œåˆ™ä»mysqlåŠ è½½å¢é‡æ•°æ®ï¼› å…¨é‡åŠ è½½ï¼šåˆ é™¤æœ¬åœ°çš„é…ç½®æ–‡ä»¶ï¼Œå…¨éƒ¨ä»mysqlåŠ è½½é…ç½®æ•°æ®ï¼›ï¼ˆæ¯æ¬¡æå–1000æ¡ï¼‰ å¢é‡åŠ è½½ï¼šæå–æœ€è¿‘6å°æ—¶çš„æ–°å¢é…ç½®ï¼Œæ›´æ–°æœ¬åœ°å’Œå†…å­˜å…ƒæ•°æ®åï¼Œä¸mysqlæ•°æ®åº“ä¸­çš„é…ç½®è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœä¸ä¸€è‡´ï¼Œåˆ™å†åŒæ­¥ä¸€æ¬¡ï¼ 2 æ–°çš„é…ç½®è¢«å‘å¸ƒåï¼Œå¦‚ä½•åœ¨é›†ç¾¤é—´è¿›è¡ŒåŒæ­¥ï¼Ÿ APé›†ç¾¤ï¼Œæ¯ä¸ªèŠ‚ç‚¹åœ°ä½å¹³ç­‰ï¼Œå‘å¸ƒé…ç½®åï¼Œæ ¹æ®è½®è¯¢æœºåˆ¶ï¼Œä¼šç”±æŸä¸€å°ServerèŠ‚ç‚¹å¤„ç†æœ¬åœ°è¯·æ±‚ï¼Œè¯¥èŠ‚ç‚¹é¦–å…ˆä¼šå°†é…ç½®å†™å…¥åˆ°Mysqlæ•°æ®åº“ä¸­ï¼› è¯¥èŠ‚ç‚¹ä¼šå‘å¸ƒä¸€ä¸ªConfigDataChangeEventäº‹ä»¶ï¼Œè¯¥äº‹ä»¶ä¼šè¢«è‡ªå·±çš„ç›‘å¬å™¨å¤„ç†ï¼Œå¤„ç†æ—¶ï¼Œä¼šé€šè¿‡HTTPè°ƒç”¨é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œå‘ŠçŸ¥é…ç½®å‘ç”Ÿæ”¹å˜ï¼ˆåŒ…æ‹¬è‡ªå·±ï¼Œå› ä¸ºä¸Šé¢åªæ˜¯å†™mysqlï¼Œè‡ªå·±çš„æœ¬åœ°æ–‡ä»¶å’Œå†…å­˜æ–‡ä»¶ä¹Ÿéƒ½æ²¡æœ‰è¢«ä¿®æ”¹ï¼‰ æ‰€æœ‰èŠ‚ç‚¹æ¥æ”¶åˆ°æœ¬åœ°é…ç½®ä¿®æ”¹çš„é€šçŸ¥åï¼Œä¼šåˆ°Mysqlä¸­åŒæ­¥æœ€æ–°çš„é…ç½®ï¼Œåˆ·æ–°å†…å­˜ç¼“å­˜ å’Œ æœ¬åœ°ç£ç›˜æ–‡ä»¶ï¼› ","link":"https://tianxiawuhao.github.io/bp8DT_bHg/"},{"title":"Nacosæ ¸å¿ƒæºç å‰–æï¼ˆCPæ¶æ„ï¼‰â€”â€”æ³¨å†Œä¸­å¿ƒ","content":"ä¸€ Nacos CPé›†ç¾¤æ¶æ„çš„åŸºç¡€çŸ¥è¯† 1 Nacosé›†ç¾¤éƒ¨ç½²åï¼Œå¯ä»¥åŒæ—¶æ”¯æŒAPå’ŒCPï¼ˆæ³¨æ„ï¼Œä¸æ˜¯åŒæ—¶æ”¯æŒCAPï¼‰ APæ¶æ„ï¼šä¸´æ—¶å®ä¾‹ CPæ¶æ„ï¼šæŒä¹…åŒ–å®ä¾‹ åœ¨æ³¨å†ŒæœåŠ¡æ—¶ï¼Œå¦‚æœæˆ‘ä»¬è®©æˆ‘ä»¬çš„èŠ‚ç‚¹æ³¨å†Œä¸ºï¼šæŒä¹…åŒ–å®ä¾‹ï¼Œå³è‡ªåŠ¨ä¼šèµ°CPæ¶æ„ï¼ spring: application: name: nacos-config-client cloud: nacos: discovery: server-addr: 10.206.73.156:8848 namespace: haier-iot group: dev cluster-name: BJ ephemeral: true # æŒä¹…åŒ–å®ä¾‹èµ°CPæ¶æ„ 2 Nacos CPæ¶æ„ä½¿ç”¨çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®ï¼Ÿï¼ˆç®€åŒ–ç‰ˆçš„Raftï¼‰ Raftåˆ†å¸ƒå¼ä¸€è‡´æ€§åè®® å’Œ Zookeeperä½¿ç”¨çš„ZABåŸå­å¹¿æ’­åè®®éå¸¸ç›¸ä¼¼ï¼› éƒ½æ˜¯ä¸€ä¸ªLeaderå¸¦é¢†å¤šä¸ªFollowerï¼ŒåŒºåˆ«åœ¨äºï¼ŒLeaderé€‰ä¸¾æ—¶çš„æŠ•ç¥¨æœºåˆ¶ï¼š ZABæŠ•ç¥¨æ—¶ï¼šæ‰€æœ‰å€™é€‰èŠ‚ç‚¹éƒ½ä¼šå‘èµ·æŠ•ç¥¨ï¼Œç„¶åè¿›è¡Œé€‰ç¥¨PKï¼Œå†³å®šè°èƒœå‡ºï¼› RaftæŠ•ç¥¨æ—¶ï¼šä¼šè®©æ‰€æœ‰èŠ‚ç‚¹éšæœºç¡çœ ï¼Œå…ˆç¡é†’çš„èŠ‚ç‚¹å‘èµ·æŠ•ç¥¨ï¼ŒæŠ•è‡ªå·±ï¼Œå¹¶å°†é€‰ç¥¨å‘åˆ°å…¶å®ƒèŠ‚ç‚¹ç­‰å¾…ç»“æœï¼› ä½†æ˜¯ï¼Œå¯¹ç»“æœçš„åˆ¤æ–­ï¼ŒZAB å’Œ Raft éƒ½éµå¾ªâ€œåŠæ•°æœºåˆ¶â€ã€‚ äºŒ CPæ¶æ„ä¸‹ï¼ŒæŒä¹…åŒ–å®ä¾‹çš„æ³¨å†Œé€»è¾‘ 1 æ³¨å†Œå®ä¾‹çš„APIæ¥å£ä¸å˜ï¼š/nacos/v1/ns/instance è¿™é‡Œå½“ç„¶æ—¶é€‰æ‹©RaftConsistencyServiceImplçš„å®ç°ï¼š public void put(String key, Record value) throws NacosException { checkIsStopWork(); try { raftCore.signalPublish(key, value); } catch (Exception e) { ...... } } 2 æ•´ä¸ªCPæ¶æ„ä¸‹çš„ä¸»èŠ‚ç‚¹æ³¨å†Œé€»è¾‘éƒ½åœ¨signalPublish()æ–¹æ³•ä¸­ public void signalPublish(String key, Record value) throws Exception { if (stopWork) { throw new IllegalStateException(&quot;old raft protocol already stop work&quot;); } // åˆ¤æ–­è‡ªå·±æ˜¯ä¸æ˜¯Leader if (!isLeader()) { ObjectNode params = JacksonUtils.createEmptyJsonNode(); params.put(&quot;key&quot;, key); params.replace(&quot;value&quot;, JacksonUtils.transferToJsonNode(value)); Map&lt;String, String&gt; parameters = new HashMap&lt;&gt;(1); parameters.put(&quot;key&quot;, key); final RaftPeer leader = getLeader(); // å¦‚æœæœ¬èŠ‚ç‚¹ä¸æ˜¯Leaderï¼Œå°±æŠŠè¯·æ±‚è½¬å‘ç»™LeaderèŠ‚ç‚¹å¤„ç† raftProxy.proxyPostLarge(leader.ip, API_PUB, params.toString(), parameters); return; } OPERATE_LOCK.lock(); try { ...... // æ ¸å¿ƒæ–¹æ³•ï¼Œå†™æœ¬åœ°æ•°æ®ï¼Œå†™å†…å­˜ç¼“å­˜ï¼Œå‘å¸ƒäº‹ä»¶â€”â€”æ›´æ–°å†…å­˜æœåŠ¡æ³¨å†Œè¡¨ onPublish(datum, peers.local()); final String content = json.toString(); // é€šè¿‡CountDownLatchå®ç°åŠæ•°ackçš„ç»Ÿè®¡ï¼Œå¦‚æœè·å¾—åˆ°åŠæ•°ä»¥ä¸Šçš„ackï¼Œåˆ™Countdownlatché€»è¾‘æ‰å¯ä»¥ç»§ç»­å‘ä¸‹èµ°ï¼ final CountDownLatch latch = new CountDownLatch(peers.majorityCount()); for (final String server : peers.allServersIncludeMyself()) { if (isLeader(server)) { // é¦–å…ˆè‡ªå·±çš„é’¥åŒ™å…ˆç”¨ä¸Š latch.countDown(); continue; } final String url = buildUrl(server, API_ON_PUB); // /v1/ns/raft/datum/commit HttpClient.asyncHttpPostLarge(url, Arrays.asList(&quot;key&quot;, key), content, new Callback&lt;String&gt;() { @Override public void onReceive(RestResult&lt;String&gt; result) { latch.countDown(); // Httpè°ƒç”¨æ­£å¸¸åï¼Œåˆ™å½“ä½œä¸€æ¬¡ack } @Override public void onError(Throwable throwable) { } @Override public void onCancel() { } }); } } finally { OPERATE_LOCK.unlock(); } å…¶å®Nacoså®ç°çš„ç®€å•Raftåè®®ï¼Œé€»è¾‘æœ‰ç‚¹ä¸å¤ªä¸¥è°¨ï¼Œå°±æ˜¯ï¼šå³ä½¿æœ¬æ¬¡åŒæ­¥ä¸æˆåŠŸï¼Œä½†æ˜¯ä¸»èŠ‚ç‚¹çš„æœ¬åœ°ç£ç›˜æ–‡ä»¶ + å†…å­˜æ–‡ä»¶ å·²ç»éƒ½ä¿®æ”¹è¿‡äº†ï¼Œä¸åƒZookeeperçš„ä¸¤é˜¶æ®µæäº¤ï¼› åæœŸNacosçš„ä¸€è‡´æ€§åè®®ä¼šä¿®æ”¹ä¸ºJRaftï¼Œè¿™ç‚¹è‚¯å®šä¼šè§£å†³ï¼ 3ã€Leaderæœ¬èŠ‚ç‚¹ä¿å­˜æ•°æ®çš„é€»è¾‘ï¼šonPublish(datum, peers.local()) public void onPublish(Datum datum, RaftPeer source) throws Exception { ...... // é€»è¾‘èƒ½èµ°åˆ°è¿™ï¼Œè¿™ä¸ªifæ­£å¸¸éƒ½ä¸ºtrue if (KeyBuilder.matchPersistentKey(datum.key)) { // æ ¸å¿ƒï¼Œå°†æ•°æ®å†™åˆ°æœ¬åœ°ç£ç›˜ raftStore.write(datum); } // å¾€å†…å­˜ä¸­ä¿å­˜ä¸€äº›æ³¨å†Œè¡¨ä¿¡æ¯ datums.put(datum.key, datum); if (isLeader()) { local.term.addAndGet(PUBLISH_TERM_INCREASE_COUNT); } else { if (local.term.get() + PUBLISH_TERM_INCREASE_COUNT &gt; source.term.get()) { //set leader term: getLeader().term.set(source.term.get()); local.term.set(getLeader().term.get()); } else { local.term.addAndGet(PUBLISH_TERM_INCREASE_COUNT); } } raftStore.updateTerm(local.term.get()); // å‘å¸ƒä¸€ä¸ªValueChangeEventäº‹ä»¶ï¼ŒPersistentNotifier.onEvent(ValueChangeEvent)ä¼šå»å¤„ç†è¿™ä¸ªäº‹ä»¶ NotifyCenter.publishEvent(ValueChangeEvent.builder().key(datum.key).action(DataOperation.CHANGE).build()); Loggers.RAFT.info(&quot;data added/updated, key={}, term={}&quot;, datum.key, local.term); } Leaderä¿å­˜æœ¬èŠ‚ç‚¹æ•°æ®ï¼Œåˆ†ä¸ºä¸‰ä¸ªè¿‡ç¨‹ï¼š 1. ä¿å­˜æ•°æ®åˆ°ç£ç›˜æ–‡ä»¶ 2. ä¿å­˜éƒ¨åˆ†ä¿¡æ¯åˆ°ç¼“å­˜datums 3. ä¿å­˜æ–‡ä»¶åˆ°å†…å­˜ä¸­çš„æœåŠ¡æ³¨å†Œè¡¨ï¼ˆåŒå±‚ConcurrentHashMapï¼‰â€”â€” ä½†ä¸æ˜¯åŒæ­¥ä¿å­˜ï¼Œè€Œæ˜¯é€šè¿‡äº‹ä»¶å‘å¸ƒï¼Œå®ç°å¼‚æ­¥ä¿å­˜ éœ€è¦ä¿å­˜åˆ°å†…å­˜ä¸­çš„æœåŠ¡æ³¨å†Œè¡¨æ—¶ï¼Œä¼šå‘å¸ƒä¸€ä¸ªValueChangeEventäº‹ä»¶ï¼Œè¯¥äº‹ä»¶ä¼šè¢«PersisNotifier.onEvent(ValueChangeEvent)æ•æ‰åˆ°ï¼Œå¹¶è¿›è¡Œå¤„ç†ï¼š // com.alibaba.nacos.naming.consistency.persistent.PersistentNotifier#onEvent public void onEvent(ValueChangeEvent event) { notify(event.getKey(), event.getAction(), find.apply(event.getKey())); } public &lt;T extends Record&gt; void notify(final String key, final DataOperation action, final T value) { ...... for (RecordListener listener : listenerMap.get(key)) { try { if (action == DataOperation.CHANGE) { listener.onChange(key, value); //æ‰§è¡ŒupdateIpsæ›´æ–°å†…å­˜æ³¨å†Œè¡¨ continue; } if (action == DataOperation.DELETE) { listener.onDelete(key); } } catch (Throwable e) { ...... } } } public void onChange(String key, Instances value) throws Exception { ...... // æ›´æ–°æ³¨å†Œè¡¨ï¼ˆè¿™ä¸ªæ–¹æ³•ï¼Œåœ¨APæ¶æ„å¸ˆï¼Œé‡ç‚¹ä»‹ç»è¿‡ï¼‰ updateIPs(value.getInstanceList(), KeyBuilder.matchEphemeralInstanceListKey(key)); recalculateChecksum(); } è‡³æ­¤ï¼Œæ•´ä¸ªLeaderèŠ‚ç‚¹çš„æŒä¹…åŒ–èŠ‚ç‚¹æ³¨å†Œé€»è¾‘å°±å®Œæˆäº†ï¼ åŒæ­¥æ•°æ®ç»™å…¶å®ƒFollowerèŠ‚ç‚¹ï¼Œå°±æ˜¯HTTPè°ƒç”¨â€œraft/datum/commitâ€æ¥å£ï¼Œå¤„ç†é€»è¾‘æ¯”ä¸»èŠ‚ç‚¹ç®€å•ï¼ ä¸‰ Nacos CPé›†ç¾¤é€‰ä¸¾è¿‡ç¨‹ 1 é›†ç¾¤èŠ‚ç‚¹å¯åŠ¨æ—¶ï¼Œä¼šæ‰§è¡ŒRaftCore.init()æ ¸å¿ƒæ–¹æ³• è¿™ä¸ªInit()æ ¸å¿ƒæ–¹æ³•ï¼Œä¼šå¯åŠ¨2ä¸ªæ ¸å¿ƒå®šæ—¶ä»»åŠ¡ï¼ˆæ¯500msæ‰§è¡Œä¸€æ¬¡ï¼‰ï¼š é€‰ä¸¾ä»»åŠ¡ï¼šnew MasterElection() å¿ƒè·³ä»»åŠ¡ï¼šnew HeartBeat() @Component public class RaftCore implements Closeable { @PostConstruct public void init() throws Exception { // å¯åŠ¨CPé›†ç¾¤èŠ‚ç‚¹ raftStore.loadDatums(notifier, datums); //ä»æœ¬åœ°ç£ç›˜æ–‡ä»¶åŠ è½½æ•°æ® // å¦‚æœLeaderå‘¨æœŸä¸å­˜åœ¨ï¼Œåˆ™ç½®ä¸º0 setTerm(NumberUtils.toLong(raftStore.loadMeta().getProperty(&quot;term&quot;), 0L)); initialized = true; // æ¯500msåšä¸€æ¬¡é€‰ä¸¾ä»»åŠ¡ masterTask = GlobalExecutor.registerMasterElection(new MasterElection()); // æ¯500msåšä¸€æ¬¡å¿ƒè·³ä»»åŠ¡ heartbeatTask = GlobalExecutor.registerHeartbeat(new HeartBeat()); versionJudgement.registerObserver(isAllNewVersion -&gt; { stopWork = isAllNewVersion; if (stopWork) { try { shutdown(); raftListener.removeOldRaftMetadata(); } catch (NacosException e) { throw new NacosRuntimeException(NacosException.SERVER_ERROR, e); } } }, 100); // æ³¨å†ŒPersistentNotifierç›‘å¬å™¨ï¼Œç”¨æ¥ç›‘å¬å¤„ç† ValueChangeEvent äº‹ä»¶ï¼Œä¿å­˜å†…å­˜ä¸­æœåŠ¡æ³¨å†Œè¡¨æ—¶ç”¨çš„ NotifyCenter.registerSubscriber(notifier); } } 2 é€‰ä¸¾ä»»åŠ¡çš„æ ¸å¿ƒrun()æ–¹æ³• public class MasterElection implements Runnable { @Override public void run() { try { RaftPeer local = peers.local(); local.leaderDueMs -= GlobalExecutor.TICK_PERIOD_MS; if (local.leaderDueMs &gt; 0) { return; } // Rafté€‰ä¸¾å‰çš„éšæœºä¼‘çœ é˜¶æ®µï¼ˆ15såˆ°20sä¹‹é—´çš„éšæœºå€¼ï¼‰ local.resetLeaderDue(); // é‡æ–°å¿ƒè·³æ—¶é—´ä¸º5s local.resetHeartbeatDue(); // ç‡å…ˆè·³å‡ºä¼‘çœ çš„èŠ‚ç‚¹ï¼Œå‘èµ·æŠ•ç¥¨ sendVote(); } catch (Exception e) { } } private void sendVote() { RaftPeer local = peers.get(NetUtils.localServer()); // é‡ç½®é›†ç¾¤èŠ‚ç‚¹æŠ•ç¥¨ peers.reset(); // é€‰ä¸¾å‘¨æœŸ+1 local.term.incrementAndGet(); // é»˜è®¤æŠ•ç»™è‡ªå·± local.voteFor = local.ip; // æŠŠè‡ªå·±çš„çŠ¶æ€æ”¹ä¸º â€œå€™é€‰è€…â€ local.state = RaftPeer.State.CANDIDATE; Map&lt;String, String&gt; params = new HashMap&lt;&gt;(1); params.put(&quot;vote&quot;, JacksonUtils.toJson(local)); for (final String server : peers.allServersWithoutMySelf()) { // å…¶å®ƒèŠ‚ç‚¹çš„APIæ¥å£ä¸ºï¼š/raft/vote final String url = buildUrl(server, API_VOTE); try { // å‘å…¶å®ƒèŠ‚ç‚¹å‘å‡ºé€‰ç¥¨ HttpClient.asyncHttpPost(url, null, params, new Callback&lt;String&gt;() { @Override //å…¶å®ƒèŠ‚ç‚¹ç»™æœ¬èŠ‚ç‚¹çš„å“åº” public void onReceive(RestResult&lt;String&gt; result) { if (!result.ok()) { Loggers.RAFT.error(&quot;NACOS-RAFT vote failed: {}, url: {}&quot;, result.getCode(), url); return; } RaftPeer peer = JacksonUtils.toObj(result.getData(), RaftPeer.class); // åˆ¤æ–­æ˜¯å¦è¾¾åˆ°åŠæ•°é€‰ç¥¨ï¼Œæˆä¸ºLeader peers.decideLeader(peer); } @Override public void onError(Throwable throwable) { } @Override public void onCancel() { } }); } catch (Exception e) { } } } } 3 å…¶å®ƒèŠ‚ç‚¹æ”¶åˆ°æŠ•ç¥¨åçš„å¤„ç†é€»è¾‘ å¦‚æœæ”¶åˆ°çš„å€™é€‰èŠ‚ç‚¹çš„termå°äºè‡ªå·±æœ¬åœ°èŠ‚ç‚¹çš„termï¼Œåˆ™voteForè‡ªå·±ï¼›ï¼ˆæˆ‘æ›´é€‚åˆåšLeaderï¼Œè¿™ä¸€ç¥¨æˆ‘æŠ•ç»™è‡ªå·±ï¼‰ å¦åˆ™ï¼Œé‡ç½®è‡ªå·±çš„election timeoutï¼Œè®¾ç½®voteForä¸ºæ”¶åˆ°çš„å€™é€‰èŠ‚ç‚¹ï¼Œæ›´æ–°é›†ç¾¤å‘¨æœŸtermä¸ºå€™é€‰èŠ‚ç‚¹çš„termï¼›ï¼ˆæˆ‘åŒæ„æ”¶åˆ°çš„èŠ‚ç‚¹åšLeaderï¼‰ ç»™Httpçš„è°ƒç”¨æ–¹è¿”å›responseï¼› å›› Nacos CPé›†ç¾¤çš„å¿ƒè·³ä»»åŠ¡ 1 å¿ƒè·³ä»»åŠ¡ç”±LeaderèŠ‚ç‚¹å‘å‡ºï¼Œæœ‰2ä¸ªä½œç”¨ ç¡®å®šFollowerèŠ‚ç‚¹åœ¨çº¿ï¼› å¸®åŠ©FollowerèŠ‚ç‚¹åˆ¤æ–­æ•°æ®æ˜¯å¦ä¸€è‡´ï¼›ï¼ˆå› ä¸ºæœåŠ¡æ³¨å†Œæˆ–å˜æ›´æ—¶ï¼ŒLeaderèŠ‚ç‚¹è‡ªå·±ä¿®æ”¹äº†ï¼Œä¸”æ”¶åˆ°äº†â€œè¿‡åŠâ€ä»¥ä¸ŠèŠ‚ç‚¹çš„ackï¼Œä½†æ˜¯ä¸æ’é™¤æœ‰äº›èŠ‚ç‚¹æ²¡æœ‰æ‰§è¡ŒæˆåŠŸï¼Œæ‰€ä»¥é€šè¿‡å¿ƒè·³ä»»åŠ¡ï¼Œè¿›è¡Œçº é”™å®¹é”™ï¼‰ 2 å¿ƒè·³ä»»åŠ¡çš„æ ¸å¿ƒrun()æ–¹æ³•(åªæœ‰LeaderèŠ‚ç‚¹æ‰å¯ä»¥å‘å…¶å®ƒèŠ‚ç‚¹å‘é€å¿ƒè·³åŒ…) public class HeartBeat implements Runnable { @Override public void run() { try { if (stopWork) { return; } if (!peers.isReady()) { return; } RaftPeer local = peers.local(); // ä»»åŠ¡æ¯0.5sæ‰§è¡Œä¸€æ¬¡ï¼Œæ¯æ¬¡å‡0.5sï¼Œæ€»å…±5så‡å®Œåï¼Œå°±å¯ä»¥å¼€å§‹sendBeat() local.heartbeatDueMs -= GlobalExecutor.TICK_PERIOD_MS; if (local.heartbeatDueMs &gt; 0) { return; } // é‡ç½®å¿ƒè·³é—´éš”æ—¶é—´ä¸º5s local.resetHeartbeatDue(); sendBeat(); } catch (Exception e) { Loggers.RAFT.warn(&quot;[RAFT] error while sending beat {}&quot;, e); } } private void sendBeat() throws IOException, InterruptedException { RaftPeer local = peers.local(); // å¦‚æœå½“å‰æ˜¯å•æœºæ¨¡å¼ï¼Œæˆ–è€…æœ¬èŠ‚ç‚¹ä¸æ˜¯LeaderèŠ‚ç‚¹ï¼Œåˆ™æ— æƒå‘é€å¿ƒè·³ï¼Œç›´æ¥è·³è¿‡ if (EnvUtil.getStandaloneMode() || local.state != RaftPeer.State.LEADER) { return; } local.resetLeaderDue(); // build data ObjectNode packet = JacksonUtils.createEmptyJsonNode(); packet.replace(&quot;peer&quot;, JacksonUtils.transferToJsonNode(local)); ArrayNode array = JacksonUtils.createEmptyArrayNode(); if (switchDomain.isSendBeatOnly()) { Loggers.RAFT.info(&quot;[SEND-BEAT-ONLY] {}&quot;, switchDomain.isSendBeatOnly()); } // å°è£…å¿ƒè·³åŒ…ï¼Œä»å†…å­˜ä¸­è·å–LeaderèŠ‚ç‚¹æ³¨å†Œè¡¨ç¼“å­˜ä¸­æŠ½å–æ•°æ®çš„keyå’Œtimestampå€¼ if (!switchDomain.isSendBeatOnly()) { for (Datum datum : datums.values()) { ObjectNode element = JacksonUtils.createEmptyJsonNode(); if (KeyBuilder.matchServiceMetaKey(datum.key)) { element.put(&quot;key&quot;, KeyBuilder.briefServiceMetaKey(datum.key)); } else if (KeyBuilder.matchInstanceListKey(datum.key)) { element.put(&quot;key&quot;, KeyBuilder.briefInstanceListkey(datum.key)); } element.put(&quot;timestamp&quot;, datum.timestamp.get()); array.add(element); } } packet.replace(&quot;datums&quot;, array); // broadcast Map&lt;String, String&gt; params = new HashMap&lt;String, String&gt;(1); params.put(&quot;beat&quot;, JacksonUtils.toJson(packet)); String content = JacksonUtils.toJson(params); // å¯¹å¿ƒè·³åŒ…åšgzipå‹ç¼© ByteArrayOutputStream out = new ByteArrayOutputStream(); GZIPOutputStream gzip = new GZIPOutputStream(out); gzip.write(content.getBytes(StandardCharsets.UTF_8)); gzip.close(); byte[] compressedBytes = out.toByteArray(); String compressedContent = new String(compressedBytes, StandardCharsets.UTF_8); // æŠŠå‹ç¼©åçš„å¿ƒè·³åŒ…ï¼Œå‘é€ç»™é™¤è‡ªå·±å¤–çš„å…¶ä»–æ‰€æœ‰èŠ‚ç‚¹ for (final String server : peers.allServersWithoutMySelf()) { try { // å¿ƒè·³åŒ…çš„APIä¸ºï¼š/raft/beat final String url = buildUrl(server, API_BEAT); HttpClient.asyncHttpPostLarge(url, null, compressedBytes, new Callback&lt;String&gt;() { @Override public void onReceive(RestResult&lt;String&gt; result) { peers.update(JacksonUtils.toObj(result.getData(), RaftPeer.class)); } @Override public void onError(Throwable throwable) { } @Override public void onCancel() { } }); } catch (Exception e) { } } } } 3 FollowerèŠ‚ç‚¹æ”¶åˆ°å¿ƒè·³åŒ…åçš„å¤„ç†é€»è¾‘ Leaderå‘å‡ºçš„å¿ƒè·³åŒ…ä¸­ï¼ŒåŒ…å«äº†æ•°æ®ä¸­çš„æ‰€æœ‰keyå’Œtimestampï¼ŒFollowerèŠ‚ç‚¹é€šè¿‡éå†å¯¹æ¯”ï¼Œå¯ä»¥æ’æŸ¥è‡ªå·±æ•°æ®æ˜¯å¦ä¸ºæœ€æ–°æœ€å…¨æ•°æ®ï¼› å¦‚æœæ•°æ®ä¸æ˜¯æœ€æ–°æˆ–æœ€å…¨çš„ï¼Œåˆ™æ‰¹é‡ä»LeaderèŠ‚ç‚¹è·å–ä¸ä¸€è‡´çš„æ•°æ®çš„æœ€æ–°å€¼ï¼›ï¼ˆLeaderèŠ‚ç‚¹æ–°å¢æˆ–ä¿®æ”¹çš„æ•°æ®ï¼‰ åŒæ—¶è¦åˆ é™¤æ‰è‡ªå·±æ¯”Leaderå¤šå‡ºæ¥çš„æ•°æ®ï¼›ï¼ˆLeaderèŠ‚ç‚¹åˆ é™¤æ‰çš„æ•°æ®ï¼‰ public RaftPeer receivedBeat(JsonNode beat) throws Exception { ...ä»å¿ƒè·³åŒ…ä¸­è§£ææ•°æ®... // è®¾ç½®Leaderä¸ºå‘é€å¿ƒè·³åŒ…ç»™æˆ‘çš„æœºå™¨ï¼Œå› ä¸ºåªæœ‰Leaderæ‰å¯ä»¥å‘é€å¿ƒè·³åŒ… peers.makeLeader(remote); if (!switchDomain.isSendBeatOnly()) { // receivedKeysMap çš„ä½œç”¨æ˜¯åˆ¤æ–­å‡ºæœ¬èŠ‚ç‚¹ æ¯” LeaderèŠ‚ç‚¹å¤šå‡ºæ¥çš„æ•°æ®ï¼ˆè§æ–¹æ³•çš„æœ€åï¼‰ Map&lt;String, Integer&gt; receivedKeysMap = new HashMap&lt;&gt;(datums.size()); for (Map.Entry&lt;String, Datum&gt; entry : datums.entrySet()) { // å¦‚æœè¿™ä¸ªMapä¸­çš„æ•°æ®ä¸º0ï¼Œåˆ™ä»£è¡¨æ˜¯æœ¬åœ°è‡ªå·±çš„æ•°æ®ï¼› // æ¥æ”¶åˆ°çš„ä¸»èŠ‚ç‚¹æ•°æ®æ—¶ï¼ŒæŠŠå¯¹åº”çš„å€¼æ”¹ä¸º1ï¼› // é‚£ä¹ˆç›´åˆ°å¤„ç†æœ€åï¼Œè¿™ä¸ªMapä¸­è¿˜æœ‰0ï¼Œè¯´æ˜è¿™æ¡æ•°æ®åœ¨ä¸»èŠ‚ç‚¹å¹¶æ²¡æœ‰ï¼Œåªæœ‰ä¸€ç§å¯èƒ½ï¼Œè¿™æ¡æ•°æ®åœ¨ä¸»èŠ‚ç‚¹ä¸­è¢«åˆ é™¤æ‰äº†ï¼ï¼ˆå¦™ï¼‰ // æœ€åï¼Œå¯ä»¥æŠŠè¿™äº›æ•°æ®ï¼Œåœ¨æœ¬åœ°æ¸…é™¤æ‰ receivedKeysMap.put(entry.getKey(), 0); } // batchç”¨æ¥æ”¶é›†æœ¬èŠ‚ç‚¹æ²¡æœ‰çš„æ•°æ®ï¼Œæˆ–è€…ä¸æ˜¯æœ€æ–°çš„æ•°æ® List&lt;String&gt; batch = new ArrayList&lt;&gt;(); int processedCount = 0; // å·²å¤„ç†çš„æ•°æ®æ¡æ•° for (Object object : beatDatums) { processedCount = processedCount + 1; ...... receivedKeysMap.put(datumKey, 1); try { // åŒ…å«ï¼Œä¸”æˆ‘è‡ªå·±ç¼“å­˜ä¸­è¿™æ¡keyå¯¹åº”çš„æ•°æ®çš„æ—¶é—´æˆ³&gt;=æ”¶åˆ°çš„å¿ƒè·³ä¸­çš„æ•°æ®ï¼Œåˆ™ä»£è¡¨è¿™æ¡æ•°æ®æˆ‘æœ‰ï¼Œå°±å¯ä»¥è·³å‡ºæœ¬è½® if (datums.containsKey(datumKey) &amp;&amp; datums.get(datumKey).timestamp.get() &gt;= timestamp &amp;&amp; processedCount &lt; beatDatums.size()) { continue; } // å–åï¼Œä¸æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶ï¼Œåˆ™è¯´æ˜è¿™æ¡æ•°æ®æˆ‘æ²¡æœ‰ï¼Œæˆ–è€…ä¸æ˜¯æœ€æ–°çš„ï¼Œåˆ™æ”¶é›†åˆ°batchä¸­ // å› ä¸ºèŠ‚ç‚¹å˜åŒ–çš„æ—¶å€™ï¼Œè™½ç„¶LeaderèŠ‚ç‚¹æ”¶åˆ°äº†åŠæ•°ä»¥ä¸Šçš„ackï¼Œä½†æ˜¯æ¯•ç«Ÿè¿˜æœ‰å¯èƒ½æœ‰äº›èŠ‚ç‚¹æ²¡æœ‰æ”¶åˆ°ï¼Œæˆ–è€…å¤„ç†ä¸æˆåŠŸï¼Œæ‰€ä»¥è¿™é‡Œé€šè¿‡å¿ƒè·³åŒ…è¿›è¡Œæ•°æ®åŒæ­¥çš„å®¹é”™å¤„ç† if (!(datums.containsKey(datumKey) &amp;&amp; datums.get(datumKey).timestamp.get() &gt;= timestamp)) { batch.add(datumKey); } // å½“batchçš„æ•°æ®é‡&gt;=50æˆ–è€…æ•°æ®å·²ç»å…¨éƒ¨å¤„ç†å®Œï¼Œåˆ™å°±å¯ä»¥ç»§ç»­ä¸‹é¢å‘LeaderèŠ‚ç‚¹å‘èµ·æ‰¹é‡è¯·æ±‚æ•°æ®çš„é€»è¾‘ï¼› // åè¿‡æ¥ï¼Œå¦‚æœbatch&lt;50ï¼Œä¸”æ•°æ®è¿˜æ²¡æœ‰å¤„ç†å®Œï¼Œé‚£ä¹ˆè¿™é‡Œå…ˆè·³è¿‡ï¼Œä¸è¦å‘LeaderèŠ‚ç‚¹å‘èµ·æ‰¹é‡è·å–æ•°æ®çš„è¯·æ±‚ if (batch.size() &lt; 50 &amp;&amp; processedCount &lt; beatDatums.size()) { continue; } String keys = StringUtils.join(batch, &quot;,&quot;); // å¦‚æœbatchä¸ºç©ºï¼Œå½“ç„¶ä¹Ÿä¸ç”¨å‘è¯·æ±‚ if (batch.size() &lt;= 0) { continue; } // update datum entry String url = buildUrl(remote.ip, API_GET); Map&lt;String, String&gt; queryParam = new HashMap&lt;&gt;(1); queryParam.put(&quot;keys&quot;, URLEncoder.encode(keys, &quot;UTF-8&quot;)); // ä»Leaderæ‰¹é‡è·å–æœ¬èŠ‚ç‚¹ç¼ºå°‘çš„æˆ–è¿‡æ—¶çš„æ•°æ® HttpClient.asyncHttpGet(url, null, queryParam, new Callback&lt;String&gt;() { @Override public void onReceive(RestResult&lt;String&gt; result) { ...è·å–ç¼ºå°‘çš„æˆ–è¿‡æ—¶çš„æ•°æ®æˆåŠŸå... for (JsonNode datumJson : datumList) { Datum newDatum = null; OPERATE_LOCK.lock(); try { ...... // å’Œä¸Šé¢LeaderèŠ‚ç‚¹æ–°å¢æ•°æ®æ—¶å€™é€»è¾‘ç›¸åŒï¼Œå†™å†…å­˜æ³¨å†Œè¡¨ raftStore.write(newDatum); datums.put(newDatum.key, newDatum); notifier.notify(newDatum.key, DataOperation.CHANGE, newDatum.value); ...... } catch (Throwable e) { } finally { OPERATE_LOCK.unlock(); } } return; } @Override public void onError(Throwable throwable) { } @Override public void onCancel() { } }); batch.clear(); } catch (Exception e) { } } // å¦‚æœæœ€åreceivedKeysMapä¸­è¿˜æœ‰valueä¸º0çš„æ•°æ®ï¼Œè¯´æ˜è¿™äº›æ•°æ®åœ¨ä¸»èŠ‚ç‚¹å·²ç»è¢«åˆ é™¤äº†ï¼Œé‚£æˆ‘ä»¬ä»èŠ‚ç‚¹ä¹Ÿä¸»åŠ¨åˆ é™¤ä¸€ä¸‹ List&lt;String&gt; deadKeys = new ArrayList&lt;&gt;(); for (Map.Entry&lt;String, Integer&gt; entry : receivedKeysMap.entrySet()) { if (entry.getValue() == 0) { deadKeys.add(entry.getKey()); } } for (String deadKey : deadKeys) { try { deleteDatum(deadKey); //åˆ é™¤æœ¬èŠ‚ç‚¹å¤šå‡ºæ¥çš„æ•°æ®é€»è¾‘ } catch (Exception e) { } } } return local; } ","link":"https://tianxiawuhao.github.io/zolXTKRvU/"},{"title":"Nacosæ ¸å¿ƒæºç å‰–æï¼ˆAPæ¶æ„ï¼‰â€”â€”æ³¨å†Œä¸­å¿ƒ","content":"Nacoså®˜æ–¹æ–‡æ¡£ï¼šhttps://nacos.io/zh-cn/docs/quick-start.html æœåŠ¡ç«¯å¯¹å¤–æš´éœ²çš„APIï¼šhttps://nacos.io/zh-cn/docs/open-api.html Nacosçš„Serverç«¯å…¶å®å°±æ˜¯ä¸€ä¸ªWebæœåŠ¡ï¼Œå¯¹å¤–æä¾›äº†HttpæœåŠ¡æ¥å£ï¼Œæ‰€æœ‰çš„å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„é€šè®¯éƒ½é€šè¿‡Httpè°ƒç”¨å®Œæˆï¼ˆçŸ­é“¾æ¥ï¼‰ã€‚ Nacosæ³¨å†ŒæœåŠ¡æ ¸å¿ƒç±»ï¼šNacosNamingService Nacosé…ç½®ä¸­å¿ƒæ ¸å¿ƒç±»ï¼šNacosConfigService ä¸€ å¾®æœåŠ¡ä¸­å¸¸ç”¨çš„æ³¨å†Œä¸­å¿ƒå¯¹æ¯” Zookeeperï¼ˆApacheï¼‰ï¼šå…¸å‹çš„CPæ¶æ„ï¼Œæœ‰LeaderèŠ‚ç‚¹ï¼Œåœ¨é€‰ä¸¾Leaderçš„è¿‡ç¨‹ä¸­ï¼Œæ•´ä¸ªé›†ç¾¤å¯¹å¤–ä¸å¯ç”¨ï¼Œä¸ºäº†å¼ºä¸€è‡´æ€§ï¼Œç‰ºç‰²é«˜å¯ç”¨æ€§ï¼ï¼ˆClientä¸Serverä¹‹é—´ä¸ºå¿ƒè·³ç»´æŒçš„TCPé•¿è¿æ¥ï¼‰ Eurekaï¼ˆNetflixï¼‰ï¼šAPæ¶æ„ï¼Œä¸ºäº†é«˜å¯ç”¨æ€§ï¼Œç‰ºç‰²å¼ºä¸€è‡´æ€§ï¼›æœåŠ¡æä¾›è€…æ–°èŠ‚ç‚¹æ³¨å†Œåï¼Œæ¶ˆè´¹è€…éœ€è¦ä¸€å®šçš„æ—¶é—´åæ‰èƒ½æ‹¿åˆ°æœ€æ–°æœåŠ¡åˆ—è¡¨ï¼Œæœ€é•¿å¯è¾¾60sï¼› Nacosï¼ˆé˜¿é‡Œï¼‰ï¼šå‚è€ƒäº†Zookeeper+Eurekaï¼ŒåŒæ—¶æ”¯æŒAP/CPæ¶æ„ï¼Œé›†ç¾¤é»˜è®¤ä¸ºAPæ¶æ„ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é…ç½®åˆ‡æ¢ä¸ºCPæ¶æ„ï¼ˆRaftï¼‰ï¼›æœåŠ¡åˆ—è¡¨å˜åŠ¨åï¼Œæ¶ˆè´¹è€…è·å–æœ€æ–°åˆ—è¡¨æœ€ç„¶ä¼šæœ‰ä¸€ç‚¹å»¶è¿Ÿï¼Œä½†æ˜¯æ¯”Eurekaå¥½å¾ˆå¤šï¼Œè€Œä¸”è¿˜å¯ä»¥é€šè¿‡udpå®æ—¶é€šçŸ¥ï¼Œè™½ç„¶UDPå¯é æ€§æ— æ³•ä¿è¯ï¼ï¼ˆClientä¸Serverä¹‹é—´ä¸ºçŸ­é“¾æ¥Httpè°ƒç”¨ï¼‰ äºŒ NACOSçš„æœåŠ¡æ¶æ„å›¾ æœåŠ¡æ³¨å†Œ+æœåŠ¡å¿ƒè·³ï¼šé¦–å…ˆæ— è®ºæ˜¯â€œæœåŠ¡æä¾›è€…â€è¿˜æ˜¯â€œæœåŠ¡æ¶ˆè´¹è€…â€éƒ½ä¼šå°†è‡ªå·±æ³¨å†Œåˆ°nacosï¼Œå¹¶ç»´æŒå¿ƒè·³ã€‚ï¼ˆæ¯5ç§’å‘é€ä¸€æ¬¡å¿ƒè·³åŒ…ï¼‰ æœåŠ¡å¥åº·æ£€æŸ¥ï¼šæœåŠ¡ç«¯å†å¯åŠ¨åï¼Œä¼šä»¥Serviceä¸ºå•ä½ï¼Œå¼€å¯ClientBeatCheckTaskå¿ƒè·³æ£€æŸ¥ä»»åŠ¡ã€‚ï¼ˆæ¯5ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œå¦‚æœæŸä¸ªå®¢æˆ·ç«¯æœ€åä¸€æ¬¡å¿ƒè·³è¶…è¿‡15ç§’ï¼Œæ ‡è®°ä¸ºä¸å¥åº·ï¼Œè¶…è¿‡30ç§’è¸¢é™¤ï¼‰ æœåŠ¡å‘ç°ï¼šâ€œæœåŠ¡æ¶ˆè´¹è€…â€ä¼šæ ¹æ®éœ€è¦è‡ªå·±çš„è‡ªå·±æ‰€éœ€çš„ç›®æ ‡æœåŠ¡çš„namespace/group/serviceName/clusteråªæ ¹æ®éœ€è¦æŸ¥è¯¢å¯¹åº”çš„æœåŠ¡æ³¨å†Œè¡¨ï¼Œä¿å­˜åœ¨æœ¬åœ°ã€‚ï¼ˆå®šæ—¶æ¯10så»æœåŠ¡ç«¯æ›´æ–°ä¸€æ¬¡ï¼‰ï¼ æœåŠ¡åŒæ­¥ï¼šæœåŠ¡ç«¯é›†ç¾¤ä¹‹é—´ä¼šåŒæ­¥æœåŠ¡æ³¨å†Œè¡¨ï¼Œç”¨æ¥ä¿è¯æœåŠ¡ä¿¡æ¯çš„ä¸€è‡´æ€§ï¼ï¼ˆæ³¨æ„APæ¶æ„çš„é›†ç¾¤ä¸­ï¼Œå³ä½¿é…ç½®äº†mysqlï¼Œä¹Ÿä¸æ˜¯ç”¨æ¥å­˜æ”¾æ³¨å†Œè¡¨ï¼‰ ä¸‰ Nacosçš„æ ¸å¿ƒæ³¨å†Œè¡¨ç»“æ„ï¼ˆåŒå±‚ConcurrentHashMapï¼‰ 1 Nacoså’ŒEurekaçš„æ³¨å†Œè¡¨åº•å±‚éƒ½æ˜¯åŒå±‚ConcurrentHashMap // æœ¬ç¯‡åªä»‹ç»Nacos public class ServiceManager implements RecordListener&lt;Service&gt; { // NacosæœåŠ¡æ³¨å†Œè¡¨çš„å®é™…å­˜å‚¨ç»“æ„ï¼ˆåŒå±‚Mapï¼‰ Map&lt;String, Map&lt;String, Service&gt;&gt; serviceMap = new ConcurrentHashMap&lt;&gt;() //Map&lt;nameSpaceId, Map&lt;group::serverName, Service&gt;&gt; â€”â€”â€”â€”&gt; é€šè¿‡nameSpaceId + group::serviceNameå®šä½åˆ°å…·ä½“çš„æœåŠ¡(Service) //å…¶ä¸­çš„ServiceæœåŠ¡å®ä¾‹çš„ç»“æ„ï¼š public class Service { private Map&lt;String, Cluster&gt; clusterMap = new HashMap&lt;&gt;(); //Map&lt;clusterName, Cluster&gt; â€”â€”â€”â€”&gt; åœ¨å…·ä½“çš„serviceInstanceå†…é€šè¿‡clusterNameå®šä½åˆ°å…·ä½“çš„Clusteré›†ç¾¤ //è€ŒClusteré›†ç¾¤ï¼Œåˆæ˜¯è¿™æ ·çš„ç»“æ„ public class Cluster { private Set&lt;Instance&gt; ephemeralInstances = new HashSet&lt;&gt;(); //è¿™å°±æ˜¯å®é™…å¯ä»¥å¯¹å¤–æä¾›çš„å•ä¸ªæœåŠ¡ï¼ˆserviceInstanceItemï¼‰ } } } æ€»ç»“ï¼šNacosåº•å±‚æ•°æ®ç»“æ„ï¼Œæ˜¾ç¤ºä¸€ä¸ªåŒå±‚Mapï¼Œ â€”â€” 1ã€æœåŠ¡å‘ç°é˜¶æ®µï¼Œé€šè¿‡nameSpaceId, group::serviceNameæ‰¾åˆ°å¯¹åº”çš„æœåŠ¡ ServiceæœåŠ¡ â€”â€” 2ã€åœ¨æœåŠ¡Serviceå†…é€šè¿‡clusterNameå®šä½åˆ°å…·ä½“çš„é›†ç¾¤Cluster â€”â€” 3ã€åœ¨Clusteré›†ç¾¤é‡Œé¢ä»¥HashSetçš„å½¢å¼ï¼Œå­˜æ”¾ç€æ‰€æœ‰èƒ½å¤Ÿæä¾›æœåŠ¡çš„æ¯ä¸ªå®ä¾‹Instanceï¼ˆè¿™ä¸ªInstanceä¸­æœ‰è®¿é—®å®ƒçš„è¯¦ç»†ä¿¡æ¯ï¼‰ï¼Œæœ€åæŠŠæ•´ä¸ªSetåˆ—è¡¨è¿”å›ç»™å®¢æˆ·ç«¯å³å¯! 2 Nacosè¿™ä¹ˆå¤šå±‚çš„é…ç½®ï¼Œè¯¥å¦‚ä½•ä½¿ç”¨ï¼Ÿ æœ€ä½³å®è·µä¸€ï¼ˆä¸­å°å‹å…¬å¸ï¼‰ï¼š // namespaceï¼šç”¨æ¥åŒºåˆ†ä¸é€šçš„é¡¹ç›®ï¼Œå¦‚haier-iot / haier-code / cold-chain // groupï¼šç”¨æ¥åŒºåˆ†ä¸é€šé¡¹ç›®çš„ prod / test / dev ç­‰ç¯å¢ƒ // â€”â€”â€”â€”spring.application.nameâ€”â€”â€”â€” // clusterï¼šå¯ä»¥ä»¥ä½äºæ¥åˆ’åˆ†é›†ç¾¤ï¼šBJ / NJ / SH // ç¤ºä¾‹ï¼š spring: application: name: haier-iot-device-manager cloud: nacos: discovery: server-addr: 10.206.73.156:8848 namespace: haier-iot group: dev cluster-name: BJ //å¯ä»¥ä¸åŒºåˆ† config: server-addr: 10.206.73.156:8848 file-extension: yaml namespace: haier-iot group: dev cluster-name: BJ //å¯ä»¥ä¸åŒºåˆ† æœ€ä½³å®è·µäºŒï¼ˆå¤§å‹å…¬å¸ï¼‰ï¼š //ä¸æœ€ä½³å®è·µä¸€çš„åŒºåˆ«åœ¨äºï¼Œç›´æ¥ä½¿ç”¨nacosé¡¹ç›®ä¸“ç”¨ï¼Œç›´æ¥ä½¿ç”¨ namespace åŒºåˆ†ç¯å¢ƒ // namespaceï¼šç›´æ¥ç”¨æ¥åŒºåˆ† prod / test / dev ç­‰ç¯å¢ƒ // groupï¼šä½¿ç”¨ DEFAULT_GROUPï¼Œå› ä¸ºå¾®æœåŠ¡æœ‰å¯èƒ½å¤ªå¤šï¼Œç®¡ç†å®¹æ˜“æ··ä¹±ï¼›åŒæ—¶è¿™ä¸€å±‚å¯ä»¥åšæ‰©å±•ï¼Œæ¯”å¦‚å¤šä¸ªå°æœåŠ¡å¯èƒ½å±äºå¦ä¸€ä¸ªå¤§æœåŠ¡ä¸‹ï¼› // â€”â€”â€”â€”spring.application.nameâ€”â€”â€”â€” // clusterï¼šå¯ä»¥ä»¥ä½äºæ¥åˆ’åˆ†é›†ç¾¤ï¼šBJ / NJ / SH // ç¤ºä¾‹ï¼š spring: application: name: haier-iot-device-manager cloud: nacos: discovery: server-addr: 10.206.73.156:8848 namespace: dev group: DEFAULT_GROUP //é»˜è®¤GROUPå¯ä»¥ä¸æŒ‡å®š cluster-name: BJ //å¯ä»¥ä¸åŒºåˆ† config: server-addr: 10.206.73.156:8848 namespace: dev group: DEFAULT_GROUP //é»˜è®¤GROUPå¯ä»¥ä¸æŒ‡å®š file-extension: yaml 3 ä¸ºä»€ä¹ˆNacosè¦è®¾è®¡è¿™ä¹ˆå¤æ‚çš„æ•°æ®ç»“æ„ å› ä¸ºNacosæ˜¯ä¸€ä¸ªå¼€æ”¾çš„äº§å“ï¼Œä¸ºäº†é€‚åº”ç»å¤§å¤šæ•°ä½¿ç”¨è€…çš„ä½¿ç”¨åœºæ™¯ï¼Œæ‰€ä»¥æ‰©å±•æ€§ä¸€å®šè¦å¥½ï¼Œè¿™ä¹ˆå¤šå±‚çš„è®¾è®¡ï¼Œå‡ ä¹å¯ä»¥æ»¡è¶³ä»»æ„å¤æ‚çš„ä¸šåŠ¡åœºæ™¯ï¼ ä¸‰ Nacosçš„æ³¨å†Œè¡¨å†™å…¥æ€§èƒ½ä¿è¯ 1 Nacosæ€ä¹ˆè´Ÿè´£çš„æ³¨å†Œè¡¨ç»“æ„ï¼Œå¦‚ä½•æ”¯æ’‘é«˜å¹¶å‘åœºæ™¯ï¼Ÿï¼ˆé˜»å¡é˜Ÿåˆ—ã€å¼‚æ­¥æ³¨å†Œï¼‰ // ä½¿ç”¨å†…å­˜é˜»å¡é˜Ÿåˆ—å®ç°å¼‚æ­¥æ³¨å†Œ â€”â€” å½“æ¥æ”¶åˆ°providerçš„æ³¨å†Œæ—¶ï¼ŒNacosæœåŠ¡ç«¯ä¼šå°†ä»»åŠ¡å°è£…æˆTask public class DistroConsistencyServiceImpl{ @PostConstruct public void init() { GlobalExecutor.submitDistroNotifyTask(notifier); } // è€Œnotifieræ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œå•çº¿ç¨‹å¤„ç†æœåŠ¡æ³¨å†Œä»»åŠ¡ï¼Œä¹Ÿé¿å…äº†â€œå¹¶å‘è¦†ç›–â€é—®é¢˜ï¼ public class Notifier implements Runnable { private BlockingQueue&lt;Pair&lt;String, DataOperation&gt;&gt; tasks = new ArrayBlockingQueue&lt;&gt;(1024 * 1024); // run()æ–¹æ³•å°±æ˜¯åœ¨å¤„ç†æ”¾å…¥åˆ°tasksé˜Ÿåˆ—ä¸­çš„Taskä»»åŠ¡ @Override public void run() { for (; ; ) { // æ­»å¾ªç¯ï¼Œå³ä½¿å‡ºç°å¼‚å¸¸ä¹Ÿä¸ä¼šé€€å‡º try { Pair&lt;String, DataOperation&gt; pair = tasks.take(); //é˜»å¡é˜Ÿåˆ—ä¸æ¶ˆè€—CPU handle(pair); } catch (Throwable e) { Loggers.DISTRO.error(&quot;[NACOS-DISTRO] Error while handling notifying task&quot;, e); } } } } // æ–°çš„Instanceä»»åŠ¡è¢«å°è£…æˆTaskä»»åŠ¡ï¼Œæ”¾å…¥åˆ°Notifierä¸­ public void put(String key, Record value) throws NacosException { onPut(key, value); // ä»»åŠ¡è¢«å°è£…æˆ distroProtocol.sync(new DistroKey(key, KeyBuilder.INSTANCE_LIST_KEY_PREFIX), DataOperation.CHANGE, globalConfig.getTaskDispatchPeriod() / 2); } public void onPut(String key, Record value) { ...è¾¹ç¼˜é€»è¾‘... notifier.addTask(key, DataOperation.CHANGE); } } 2 ä½¿ç”¨é˜»å¡é˜Ÿåˆ—å®ç°å¼‚æ­¥æ³¨å†Œï¼Œä¼šä¸ä¼šå­˜åœ¨ä¸ä¸€è‡´é—®é¢˜ï¼Œè¿˜æ²¡æ³¨å†ŒæˆåŠŸå°±ç»™å®¢æˆ·ç«¯è¿”å›ç»“æœï¼Ÿ æ˜¯çš„ï¼Œè‚¯å®šä¼šå­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯è¿™æ˜¯ä¸€ä¸ªå–èˆï¼Œé«˜æ€§èƒ½çš„ä¸­é—´ä»¶å†…éƒ¨éƒ½ä½¿ç”¨äº†å¤§é‡çš„å¼‚æ­¥æ“ä½œï¼› æƒ³ä¸€æƒ³ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå¯èƒ½ä¾èµ–å¾ˆå¤šç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œå¦‚æœç¬¬ä¸‰æ–¹ä¸­é—´ä»¶éƒ½ç”¨åŒæ­¥çš„æ–¹å¼å»æ‰§è¡Œè‡ªå·±çš„å†…éƒ¨é€»è¾‘ï¼Œé‚£ä¹ˆåº”ç”¨ç¨‹åºçš„å¯åŠ¨å°†å˜å¾—éå¸¸åœ°ç¼“æ…¢ï¼Œæœ€åçš„æ•ˆæœè‚¯å®šæ˜¯éš¾ä»¥æ¥å—çš„ï¼› â€”â€” æ”¯æŒé«˜å¹¶å‘ï¼ â€”â€” è¦è¯´ä¸åŠæ—¶ï¼Œä¹‹å‰çš„Eurekaæ›´ä¸¥é‡ï¼ å…¶å®æ­£å¸¸æƒ…å†µä¸‹ï¼Œå‡ ä¹ä¸ä¼šå¤ªè¿‡é˜»å¡ï¼Œå› ä¸ºå‡ ä¹æ²¡æœ‰å¤šå°‘å…¬å¸ï¼Œæ˜¯ä¸€æ¬¡æ€§å¢åŠ nå¤šå°æœåŠ¡çš„ï¼Œéƒ½æ˜¯æ…¢æ…¢æ·»åŠ çš„ï¼Œè€Œä¸”å³ä½¿ä¸ªåˆ«æ…¢äº†ï¼Œä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„ï¼Œå…ˆç”¨å…¶å®ƒæœåŠ¡èŠ‚ç‚¹å³å¯ï¼Œç«™åœ¨æœåŠ¡æ¶ˆè´¹è€…çš„è§’åº¦ï¼Œä¹Ÿå°±æ˜¯provideræœåŠ¡èµ·å¾—æœ‰ç‚¹æ…¢è€Œå·²ã€‚ 3 ä¸ºäº†è§£å†³é«˜å¹¶å‘ä¸‹çš„è¯»å†™å†²çªé—®é¢˜ï¼ŒNacosä½¿ç”¨äº†CopyOnWriteæ–¹æ¡ˆ // åœ¨Notifier.run()æ–¹æ³•ä¸­ï¼š listener.onChange(datumKey, dataStore.get(datumKey).value); | com.alibaba.nacos.naming.core.Service#onChange(){ updateIPs(value.getInstanceList(), KeyBuilder.matchEphemeralInstanceListKey(key)); } | com.alibaba.nacos.naming.core.Service#updateIPs(){ clusterMap.get(entry.getKey()).updateIps(entryIPs, ephemeral); } | com.alibaba.nacos.naming.core.Cluster#updateIps{ Set&lt;Instance&gt; toUpdateInstances = ephemeral ? ephemeralInstances : persistentInstances; // å°†æ—§çš„ä¸´æ—¶å®ä¾‹ephemeralInstancesåˆ—è¡¨ï¼Œå¤åˆ¶è½¬åŒ–ä¸ºä¸€ä¸ªMapè¿›è¡Œæ›´æ–°æ“ä½œ HashMap&lt;String, Instance&gt; oldIpMap = new HashMap&lt;&gt;(toUpdateInstances.size()); for (Instance ip : toUpdateInstances) { oldIpMap.put(ip.getDatumKey(), ip); } //...å¯¹æ—§Setæ‹·è´åè½¬åŒ–ä¸ºHashMapè¿›è¡Œæ›´æ–°æ“ä½œ... toUpdateInstances = new HashSet&lt;&gt;(ips); if (ephemeral) { ephemeralInstances = toUpdateInstances; } else { persistentInstances = toUpdateInstances; } } 4 åŒæ—¶nå¤šä¸ªå®ä¾‹æ³¨å†Œæˆ–æ›´æ–°ï¼Œéƒ½è¿›è¡ŒCopyOnWriteï¼Œå²‚ä¸æ˜¯ä¼šå­˜åœ¨â€œæ›´æ–°è¦†ç›–â€ï¼Ÿ // 1ã€é¦–å…ˆï¼Œæ ¹æ®ä¸Šé¢çš„ç¬¬1æ¡ï¼ŒNotifierçš„æ‰§è¡Œæ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼š /// Notifieræ‰€åœ¨ç±»DistroConsistencyServiceImplæ˜¯ä¸€ä¸ªå•ä¾‹Serviceï¼Œ@PostConstructå†³å®šäº†initæ–¹æ³•åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼š //// è€ŒGlobalExecutor æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„çº¿ç¨‹æ± ï¼Œæ‰€ä»¥å¤„ç†å®ä¾‹æ³¨å†Œçš„æœ€ç»ˆçº¿ç¨‹åªä¼šæœ‰ä¸€ä¸ª @PostConstruct public void init() { GlobalExecutor.submitDistroNotifyTask(notifier); } // 2ã€CopyOnWriteåçš„é›†åˆä¸­çš„å…ƒç´ ä¸èƒ½ç›´æ¥ä¿®æ”¹ï¼Œå› ä¸ºé›†åˆä¸­çš„å…ƒç´ æ˜¯å¼•ç”¨ï¼ // â€”â€” å½“æ–°å¢æ—¶ï¼Œç›´æ¥åœ¨æ–°é›†åˆä¸­æ–°å¢Instanceï¼Œç„¶åæ›¿æ¢åŸæ³¨å†Œè¡¨ä¸­çš„é›†åˆå³å¯ï¼ // â€”â€” å½“åˆ é™¤æ—¶ï¼Œç›´æ¥å°†æ–°é›†åˆä¸­çš„å¯¹åº”Instanceåˆ é™¤ï¼Œç„¶åæ›¿æ¢åŸæ³¨å†Œè¡¨ä¸­çš„é›†åˆå³å¯ï¼ // â€”â€” å½“æ›´æ–°æ—¶ï¼Œæ–°å¢ä¸€ä¸ªInstanceï¼Œç„¶ååˆ é™¤åŸé›†åˆä¸­çš„Instanceå…ƒç´ ï¼Œå¢åŠ æ–°çš„Instanceå…ƒç´ å³å¯ï¼ // â€”â€”â€”â€”åŸåˆ™å°±æ˜¯ï¼šæ°¸è¿œæ˜¯æ›¿æ¢ï¼Œä¸ç›´æ¥ä¿®æ”¹åŸInstanceå¯¹è±¡ï¼ 5 éšç€æ³¨å†Œè¡¨çš„ä¸æ–­å¢å¤§ï¼Œè¿›è¡ŒCopyOnWriteæ—¶å€™çš„æˆæœ¬æ˜¯ä¸æ˜¯å˜å¾—éå¸¸å¤§ï¼Ÿ // å½“ç„¶ä¸æ˜¯æ¯æ¬¡ç›´æ¥Copyæ•´å¼ æ³¨å†Œè¡¨ï¼Œé‚£æ ·å¼€é”€è‚¯å®šå¾ˆå¤§ // æ¯æ¬¡Copyçš„ç²’åº¦æ˜¯ç¼©å°åˆ°Serviceä¸‹å¯¹åº”çš„Clusterä¸­çš„Set&lt;Instance&gt;é›†åˆï¼Œè¿™ä¸ªç²’åº¦æ˜¯å¾ˆå°çš„ï¼ public class Cluster extends com.alibaba.nacos.api.naming.pojo.Cluster implements Cloneable { private Set&lt;Instance&gt; persistentInstances = new HashSet&lt;&gt;(); // APæ¨¡å¼å®ä¾‹åˆ—è¡¨ï¼ˆæœåŠ¡å‘ç°å¾—åˆ°çš„åˆ—è¡¨å°±æ˜¯å®ƒï¼‰ private Set&lt;Instance&gt; ephemeralInstances = new HashSet&lt;&gt;(); // CPæ¨¡å¼å®ä¾‹åˆ—è¡¨ï¼ˆæœåŠ¡å‘ç°å¾—åˆ°çš„åˆ—è¡¨å°±æ˜¯å®ƒï¼‰ // æ›´æ–°èŠ‚ç‚¹çš„æ“ä½œï¼ˆClusterçº§åˆ«ï¼‰ public void updateIps(List&lt;Instance&gt; ips, boolean ephemeral) { Set&lt;Instance&gt; toUpdateInstances = ephemeral ? ephemeralInstances : persistentInstances; HashMap&lt;String, Instance&gt; oldIpMap = new HashMap&lt;&gt;(toUpdateInstances.size()); //...å¯¹æ—§Setæ‹·è´åè½¬åŒ–ä¸ºHashMapè¿›è¡Œæ›´æ–°æ“ä½œ... toUpdateInstances = new HashSet&lt;&gt;(ips); if (ephemeral) { ephemeralInstances = toUpdateInstances; } else { persistentInstances = toUpdateInstances; } } } // ä¸ºäº†æ€§èƒ½ï¼ŒCopyOnWriteçš„ç²’åº¦ä¸€å®šè¦è¶Šå°è¶Šå¥½ï¼ å›› Nacosçš„å¿ƒè·³æœºåˆ¶ï¼ˆå®šæ—¶å»è°ƒNacosæœåŠ¡ç«¯Httpæ¥å£ï¼‰ æ ¸å¿ƒç±»ï¼šNacosNamingService 1 Clientåœ¨å‘æœåŠ¡ç«¯æ³¨å†ŒæœåŠ¡çš„åŒæ—¶ï¼Œå¼€å¯å®šæ—¶ä»»åŠ¡å‘æœåŠ¡ç«¯å‘é€å¿ƒè·³è¯·æ±‚ // com.alibaba.nacos.client.naming.NacosNamingService#registerInstance() // æ—¢æ˜¯æ³¨å†ŒæœåŠ¡çš„æ ¸å¿ƒä»£ç ï¼Œä¹Ÿæ˜¯å‘é€å¿ƒè·³çš„æ ¸å¿ƒä»£ç  public void registerInstance(String serviceName, String groupName, Instance instance) throws NacosException { String groupedServiceName = NamingUtils.getGroupedName(serviceName, groupName); if (instance.isEphemeral()) { BeatInfo beatInfo = beatReactor.buildBeatInfo(groupedServiceName, instance); beatReactor.addBeatInfo(groupedServiceName, beatInfo); // å‘é€å¿ƒè·³ } serverProxy.registerService(groupedServiceName, groupName, instance); // æ³¨å†Œå®ä¾‹ } | public void addBeatInfo(String serviceName, BeatInfo beatInfo) { ... // ç¬¬ä¸€æ¬¡è°ƒç”¨ = è§¦å‘å¿ƒè·³ä»»åŠ¡ executorService.schedule(new BeatTask(beatInfo), beatInfo.getPeriod(), TimeUnit.MILLISECONDS); ... } | //BeatTask.run()ä»»åŠ¡æ ¸å¿ƒä»£ç ï¼š public void run() { if (!this.beatInfo.isStopped()) { // è®¡ç®—ä¸‹ä¸€æ¬¡å‘é€çš„æ—¶é—´ long nextTime = this.beatInfo.getPeriod(); try { //æ­¤å¤„å°±æ˜¯å»è°ƒç”¨â€œå‘é€å¿ƒè·³APIâ€ JsonNode result = BeatReactor.this.serverProxy.sendBeat(this.beatInfo, BeatReactor.this.lightBeatEnabled); ...å¯¹å¿ƒè·³å‘é€ç»“æœè¿›è¡Œå¤„ç†... } catch (NacosException var11) { ...log... } //ç¬¬äºŒæ¬¡å‘é€å¿ƒè·³ï¼Œå¾ªç¯è¿›è¡Œï¼Œå°±å½¢æˆå®šæ—¶å‘é€å¿ƒè·³çš„æ•ˆæœ BeatReactor.this.executorService.schedule(BeatReactor.this.new BeatTask(this.beatInfo), nextTime, TimeUnit.MILLISECONDS); } } æˆ‘ä»¬å†çœ‹çœ‹æ‰§è¡Œâ€œå¿ƒè·³ä»»åŠ¡â€çš„çº¿ç¨‹é•¿å•¥æ ·ï¼š // å®šæ—¶ä»»åŠ¡çº¿ç¨‹ this.executorService = new ScheduledThreadPoolExecutor(threadCount, new ThreadFactory() { @Override public Thread newThread(Runnable r) { Thread thread = new Thread(r); thread.setDaemon(true); // å®ˆæŠ¤çº¿ç¨‹ï¼ˆæ‰€æœ‰ç”¨æˆ·çº¿ç¨‹ç»“æŸåï¼Œå®ˆæŠ¤çº¿ç¨‹ä¼šè‡ªåŠ¨ç»“æŸï¼‰ thread.setName(&quot;com.alibaba.nacos.naming.beat.sender&quot;); return thread; } }); æ‰€ä»¥â€œå¿ƒè·³åŒ…â€çš„æ ¸å¿ƒå°±æ˜¯ï¼šé€šè¿‡ä¸€ä¸ªå®šæ—¶ä»»åŠ¡å®ˆæŠ¤çº¿ç¨‹ï¼Œå®šæ—¶å»è°ƒç”¨NacosæœåŠ¡ç«¯çš„å‘é€å¿ƒè·³åŒ…çš„APIæ¥å£ï¼ 2 â€œå¿ƒè·³åŒ…â€çš„é»˜è®¤é—´éš”æ—¶é—´æ˜¯å¤šå°‘ï¼Ÿï¼ˆ5-15-30ï¼‰ // æ„å»ºå¿ƒè·³åŒ…çš„ä¿¡æ¯ BeatInfo beatInfo = this.beatReactor.buildBeatInfo(groupedServiceName, instance); beatInfo.setPeriod(instance.getInstanceHeartBeatInterval()); public long getInstanceHeartBeatInterval() { return this.getMetaDataByKeyWithDefault(&quot;preserved.heart.beat.interval&quot;, Constants.DEFAULT_HEART_BEAT_INTERVAL); } //è€ŒConstants.DEFAULT_HEART_BEAT_INTERVALæ˜¯ä¸ªå¸¸é‡ static { DEFAULT_HEART_BEAT_TIMEOUT = TimeUnit.SECONDS.toMillis(15L); //15ç§’ æ”¶ä¸åˆ°å¿ƒè·³ï¼Œåˆ™ä¼šè¢«æ ‡è®°ä¸ºâ€œä¸å¥åº·â€ DEFAULT_IP_DELETE_TIMEOUT = TimeUnit.SECONDS.toMillis(30L); //30ç§’ æ”¶ä¸åˆ°å¿ƒè·³ï¼Œåˆ™â€œå‰”é™¤â€è¯¥å®ä¾‹IP DEFAULT_HEART_BEAT_INTERVAL = TimeUnit.SECONDS.toMillis(5L); //é»˜è®¤å¿ƒè·³æ—¶é—´ 5ç§’ 3 NacosæœåŠ¡ç«¯å¯¹å¿ƒè·³åŒ…çš„å¤„ç†é€»è¾‘(æœåŠ¡å¥åº·æ£€æŸ¥)ï¼Ÿ(å®šæ—¶ä»»åŠ¡ï¼Œæ¯5ç§’å¥åº·æ£€æŸ¥) // ä»¥Serviceä¸ºå•ä½ï¼Œæ¯ä¸ªServiceåœ¨è¢«åˆå§‹åŒ–æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªå¥åº·æ£€æŸ¥å™¨HealthCheckReactor public class Service { public void init() { // HealthCheckReactor å¥åº·æ£€æŸ¥å™¨ï¼Œä¹Ÿæ˜¯é€šè¿‡schduledçº¿ç¨‹æ± å»åšæ£€æŸ¥çš„ HealthCheckReactor.scheduleCheck(clientBeatCheckTask); for (Map.Entry&lt;String, Cluster&gt; entry : clusterMap.entrySet()) { entry.getValue().setService(this); entry.getValue().init(); } } } | // HealthCheckReactor.scheduleCheck()æ–¹æ³•å°±æ˜¯å¼€å¯å®šæ—¶ä»»åŠ¡çº¿ç¨‹ |çº¿ç¨‹æ± å¤§å°ä¸º1~æ ¸æ•°/2 public static void scheduleCheck(BeatCheckTask task) { futureMap.putIfAbsent(task.taskKey(), GlobalExecutor.scheduleNamingHealth(task, 5000, 5000, TimeUnit.MILLISECONDS)); //å»¶è¿Ÿ5ç§’åï¼Œæ¯5ç§’æ‰§è¡Œä¸€æ¬¡ } å¥åº·æ£€æŸ¥ä»»åŠ¡çš„æ ¸å¿ƒ run() æ–¹æ³•é€»è¾‘ï¼š public class ClientBeatCheckTask implements BeatCheckTask { @Override public void run() { //æ‹¿å‡ºServiceä¸­æ‰€æœ‰çš„å®ä¾‹ï¼ˆåé¢éå†æ£€æŸ¥ï¼‰ List&lt;Instance&gt; instances = service.allIPs(true); // ç³»ç»Ÿå½“å‰æ—¶é—´ - æœ€åä¸€æ¬¡å¿ƒè·³æ—¶é—´ &gt; ä¸å¥åº·é˜ˆå€¼ï¼ˆ15ç§’ï¼‰ï¼Œæ ‡è®°ä¸ºä¸å¥åº· for (Instance instance : instances) { if (System.currentTimeMillis() - instance.getLastBeat() &gt; instance.getInstanceHeartBeatTimeOut()) { if (!instance.isMarked()) { if (instance.isHealthy()) { instance.setHealthy(false); Loggers.EVT_LOG .info(&quot;{POS} {IP-DISABLED} valid: {}:{}@{}@{}, region: {}, msg: client timeout after {}, last beat: {}&quot;, instance.getIp(), instance.getPort(), instance.getClusterName(), service.getName(), UtilsAndCommons.LOCALHOST_SITE, instance.getInstanceHeartBeatTimeOut(), instance.getLastBeat()); getPushService().serviceChanged(service); } } } } if (!getGlobalConfig().isExpireInstance()) { return; } // ç³»ç»Ÿå½“å‰æ—¶é—´ - æœ€åä¸€æ¬¡å¿ƒè·³æ—¶é—´ &gt; å¯å‰”é™¤é˜ˆå€¼ï¼ˆ30ç§’ï¼‰ï¼Œç›´æ¥å‰”é™¤ for (Instance instance : instances) { if (System.currentTimeMillis() - instance.getLastBeat() &gt; instance.getIpDeleteTimeout()) { // delete instance Loggers.SRV_LOG.info(&quot;[AUTO-DELETE-IP] service: {}, ip: {}&quot;, service.getName(), JacksonUtils.toJson(instance)); deleteIp(instance); } } } } æ‰€ä»¥â€œæœåŠ¡å¥åº·æ£€æŸ¥â€çš„é€»è¾‘å°±æ˜¯ï¼šæœåŠ¡ç«¯ä»¥Serviceä¸ºå•ä½ï¼Œä½¿ç”¨å®šæ—¶ä»»åŠ¡çº¿ç¨‹æ± ï¼Œæ¯5ç§’æ£€æŸ¥ä¸€æ¬¡Serviceä¸­æ‰€æœ‰å®ä¾‹çš„çŠ¶æ€ï¼š æœ€åå¿ƒè·³æ—¶é—´è·å½“å‰è¶…è¿‡15ç§’ï¼Œæ ‡è®°ä¸ºä¸å¥åº·ï¼› æœ€åå¿ƒè·³æ—¶é—´è·å½“å‰è¶…è¿‡30ç§’ï¼Œå°†æ­¤å®ä¾‹è¸¢é™¤ï¼ äº” æœåŠ¡å‘ç° å½“æœåŠ¡æ¶ˆè´¹è€…éœ€è¦æŸ¥è¯¢è‡ªå·±éœ€è¦çš„æœåŠ¡åˆ—è¡¨æ—¶ï¼Œä¼šä¼˜å…ˆä»æœ¬åœ°ç¼“å­˜æ³¨å†Œè¡¨è·å–æ•°æ®ï¼Œç¬¬ä¸€æ¬¡è·å–ä¸ºç©ºæ—¶ï¼Œæ‰ä¼šä»è¿œç¨‹Serverç«¯è·å–ï¼› ä»è¿œç¨‹Serverè·å–æœåŠ¡åˆ—è¡¨çš„ç²’åº¦ä¸ºClusterç²’åº¦ï¼ŒåŒæ—¶è¿˜ä¼šå°†è‡ªå·±çš„udpç«¯å£å‘Šè¯‰Serverç«¯ï¼Œä¾¿äºServerå˜åŒ–æ—¶çš„ä¸»åŠ¨é€šçŸ¥ï¼› ä»è¿œç¨‹Serverè·å–åˆ—è¡¨çš„åŒæ—¶ï¼Œè¿˜ä¼šå¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼Œæ¯éš”10ç§’ä»Serverç«¯åŒæ­¥ä¸€æ¬¡è‡ªå·±çš„æ³¨å†Œè¡¨ï¼ˆåªåŒæ­¥è‡ªå·±éœ€è¦çš„ï¼‰ï¼› udpé€šçŸ¥çš„å¯é æ€§ä¸èƒ½ä¿è¯ï¼Œä½†æ˜¯å½±å“ä¸å¤§ï¼Œå› ä¸ºæœ‰å®šæ—¶ä»»åŠ¡åŒæ­¥æ‰˜åº•ï¼ 1 è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨æ ¸å¿ƒæ–¹æ³•ï¼šNacosNamingService#getAllInstances() public List&lt;Instance&gt; getAllInstances(String serviceName, String groupName, List&lt;String&gt; clusters, boolean subscribe) { ServiceInfo serviceInfo; if (subscribe) { // é»˜è®¤æ˜¯å¼€å¯è®¢é˜…ï¼ˆudpé€šçŸ¥ï¼‰ï¼Œæ‰€ä»¥èµ°è¿™ä¸€åˆ†æ”¯ serviceInfo = hostReactor.getServiceInfo(NamingUtils.getGroupedName(serviceName, groupName), StringUtils.join(clusters, &quot;,&quot;)); } else { serviceInfo = hostReactor .getServiceInfoDirectlyFromServer(NamingUtils.getGroupedName(serviceName, groupName), StringUtils.join(clusters, &quot;,&quot;)); } List&lt;Instance&gt; list; if (serviceInfo == null || CollectionUtils.isEmpty(list = serviceInfo.getHosts())) { return new ArrayList&lt;Instance&gt;(); } return list; } | public ServiceInfo getServiceInfo(final String serviceName, final String clusters) { String key = ServiceInfo.getKey(serviceName, clusters); if (failoverReactor.isFailoverSwitch()) { return failoverReactor.getService(key); // æ•…éšœè½¬ç§»åŠŸèƒ½ï¼Œä»æ•…éšœè½¬ç§»æ–‡ä»¶è·å–æœåŠ¡åˆ—è¡¨ } // ä»æœ¬åœ°ç¼“å­˜çš„æ³¨å†Œè¡¨è·å–æœåŠ¡åˆ—è¡¨ ServiceInfo serviceObj = getServiceInfo0(serviceName, clusters); if (null == serviceObj) { // ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶å€™ï¼Œç¼“å­˜è‚¯å®šä¸ºç©ºï¼Œæ‰€ä»¥ä¼šèµ°è¿™ä¸€åˆ†æ”¯ serviceObj = new ServiceInfo(serviceName, clusters); serviceInfoMap.put(serviceObj.getKey(), serviceObj); updatingMap.put(serviceName, new Object()); updateServiceNow(serviceName, clusters); // æ ¸å¿ƒå»è¿œç¨‹è·å–æœåŠ¡åˆ—è¡¨çš„æ–¹æ³• updatingMap.remove(serviceName); } else if (updatingMap.containsKey(serviceName)) { if (UPDATE_HOLD_INTERVAL &gt; 0) { // hold a moment waiting for update finish synchronized (serviceObj) { try { serviceObj.wait(UPDATE_HOLD_INTERVAL); } catch (InterruptedException e) { NAMING_LOGGER .error(&quot;[getServiceInfo] serviceName:&quot; + serviceName + &quot;, clusters:&quot; + clusters, e); } } } } scheduleUpdateIfAbsent(serviceName, clusters); // å¼€å¯å®šæ—¶ä»»åŠ¡ï¼Œå®šæ—¶æ›´æ–°æœ¬åœ°æ³¨å†Œè¡¨ return serviceInfoMap.get(serviceObj.getKey()); } ä»è¿œç¨‹è·å–æœåŠ¡åˆ—è¡¨æ²¡å•¥çœ‹çš„ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹çœ‹å®šæ—¶ä»»åŠ¡æ›´æ–°æœ¬åœ°ç¼“å­˜æ³¨å†Œè¡¨çš„é€»è¾‘ï¼š public void scheduleUpdateIfAbsent(String serviceName, String clusters) { synchronized (futureMap) { if (futureMap.get(ServiceInfo.getKey(serviceName, clusters)) != null) { return; } // UpdateTaskè§åçŸ¥æ„ ScheduledFuture&lt;?&gt; future = addTask(new UpdateTask(serviceName, clusters)); futureMap.put(ServiceInfo.getKey(serviceName, clusters), future); } } | // çœ‹çœ‹UpdateTask.run()æ ¸å¿ƒæ–¹æ³•ï¼š public void run() { long delayTime = -1; try { ...ä¸€ç³»åˆ—é€»è¾‘ï¼Œä½†æ˜¯æœ€ç»ˆéƒ½ä¼šèµ°finallyä¸­çš„é€»è¾‘... delayTime = serviceObj.getCacheMillis(); } catch (Throwable e) { NAMING_LOGGER.warn(&quot;[NA] failed to update serviceName: &quot; + serviceName, e); } finally { if (delayTime &gt; 0) { // delayTimeé»˜è®¤ä¸º10ç§’ executor.schedule(this, delayTime, TimeUnit.MILLISECONDS); } } } æ‰€ä»¥â€œæœåŠ¡å‘ç°â€çš„é€»è¾‘å°±æ˜¯ï¼šåœ¨å®¢æˆ·ç«¯å¯åŠ¨æ—¶ï¼Œä¼šæ ¹æ®éœ€è¦ä»NacosæœåŠ¡ç«¯è·å–è‡ªå·±éœ€è¦çš„æœåŠ¡åˆ—è¡¨ï¼ˆClusterçº§åˆ«ï¼‰ï¼Œ å¹¶ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜ä¸­çš„æ³¨å†Œè¡¨ä¸­ï¼Œå¹¶å¼€å¯ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯éš”10ç§’å»æœåŠ¡ç«¯åŒæ­¥ä¸€ä¸‹å¯¹åº”çš„æ³¨å†Œè¡¨ï¼› ä¹‹åæ¯æ¬¡éœ€è¦æ—¶ï¼Œéƒ½æ˜¯ä»æœ¬åœ°ç¼“å­˜ä¸­çš„æ³¨å†Œè¡¨è·å–æœåŠ¡åˆ—è¡¨å³å¯ï¼ 2 å¦‚ä½•å°½å¯èƒ½åœ°ä¿è¯æœ¬åœ°æ³¨å†Œè¡¨çš„å®æ—¶æ€§ï¼Ÿ(å¼€å¯è®¢é˜…ï¼Œå¼€æ”¾udpç«¯å£) ä»ç¬¬ä¸€æ¡ä¸­æˆ‘ä»¬çœ‹åˆ°ä¸€ä¸ªå¼€å¯è®¢é˜…çš„é€»è¾‘ï¼Œåœ¨å¯¹åº”çš„åˆ†æ”¯ä¸­ï¼Œä»æœåŠ¡ç«¯è·å–æœåŠ¡åˆ—è¡¨æ—¶ï¼š updateServiceNow(serviceName, clusters); String result = serverProxy.queryList(serviceName, clusters, pushReceiver.getUdpPort(), false); // pushReceiver.getUdpPort() // å¯ä»¥çŸ¥é“ï¼Œä»æœåŠ¡ç«¯è·å–æœåŠ¡åˆ—è¡¨æ—¶ï¼Œé¡ºä¾¿æŠŠè‡ªå·±çš„udpç«¯å£ä¹Ÿä¼ ç»™äº†æœåŠ¡ç«¯ // é‚£ä¹ˆå½“æœåŠ¡ç«¯å‘ç°å¯¹åº”çš„æœåŠ¡åˆ—è¡¨æœ‰å˜åŠ¨æ—¶ï¼Œå°±å¯ä»¥é€šè¿‡æ­¤Udpç«¯å£é€šçŸ¥åˆ°æœ¬Client å…­ æœåŠ¡åŒæ­¥ â€‹ Nacosé›†ç¾¤å³ä½¿é…ç½®äº†å¤–éƒ¨mysqlæ•°æ®åº“ï¼Œæ³¨å†Œè¡¨ä¿¡æ¯ä¹Ÿæ˜¯å­˜å‚¨åœ¨æ¯ä¸ªèŠ‚ç‚¹çš„å†…å­˜ä¸­çš„ï¼Œè€Œä¸æ˜¯å­˜å‚¨åœ¨mysqlä¸­ï¼Œè€Œå½“Clientå‘NacosæœåŠ¡ç«¯æ³¨å†Œæ—¶ï¼Œåªä¼šé€‰æ‹©ä¸€ä¸ªNacos ServerèŠ‚ç‚¹æ³¨å†Œï¼Œé‚£ä¹ˆå°±å¿…é¡»æœ‰ä¸€å¥—æœºåˆ¶èƒ½å¤Ÿå®ç°Nacosé›†ç¾¤çš„å„ä¸ªèŠ‚ç‚¹éƒ½èƒ½åŒæ­¥åˆ°æ•°æ®ï¼ŒNacosè‡ªå·±å®ç°äº†ä¸€å¥—Distroåè®®ï¼Œä»¥å®ç°åˆ†å¸ƒå¼é›†ç¾¤å„èŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®æœ€ç»ˆä¸€è‡´æ€§ï¼ 1 ä»€ä¹ˆæ—¶Distroåè®®ï¼Ÿ Distroåè®®æ—¶Nacosç¤¾åŒºè‡ªç ”çš„ä¸€å¥—APåˆ†å¸ƒå¼åè®®ï¼Œä¸ºäº†é›†ç¾¤çš„é«˜å¯ç”¨ï¼Œç‰ºç‰²å¼ºä¸€è‡´æ€§ï¼Œåªè¿½æ±‚æœ€ç»ˆä¸€è‡´æ€§ï¼ Nacosé›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹æ—¶å¹³ç­‰çš„ï¼Œéƒ½å¯ä»¥å¤„ç†è¯»å†™è¯·æ±‚ï¼ŒåŒæ—¶æŠŠæ•°æ®åŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹ï¼› æ¯ä¸ªèŠ‚ç‚¹åªè´Ÿè´£éƒ¨åˆ†æ•°æ®ï¼ˆæœåŠ¡å¥åº·æ£€æŸ¥ç­‰ï¼‰ï¼Œå®šæ—¶å‘é€è‡ªå·±è´Ÿè´£çš„æ•°æ®çš„æ ¡éªŒå€¼åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œä»¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼› æ¯ä¸ªèŠ‚ç‚¹ç‹¬ç«‹å¤„ç†è¯·æ±‚ï¼Œä¸éœ€è¦ç»è¿‡å…¶ä»–èŠ‚ç‚¹åŒæ„ï¼ŒåŠæ—¶ä»æœ¬åœ°å‘èµ·å¯¹Clientç«¯çš„ç›¸åº”ï¼ 2 Nacosé›†ç¾¤ä¸­çš„èŠ‚ç‚¹ï¼Œå¦‚ä½•çŸ¥é“å…¶å®ƒèŠ‚ç‚¹çš„å­˜åœ¨ï¼Ÿ å¾—ç†Ÿæ‚‰Nacos APé›†ç¾¤å¾—éƒ¨ç½²æ–¹å¼ï¼ŒNacosé›†ç¾¤åœ¨éƒ¨ç½²æ—¶ï¼Œéœ€è¦åœ¨é…ç½® cluster.conf æ–‡ä»¶ä¸­é…ç½®é›†ç¾¤å¾—å„ä¸ªèŠ‚ç‚¹ï¼Œè¿™æ ·æ¯å°æœºå™¨å°±éƒ½çŸ¥é“é›†ç¾¤ä¸­å¾—å…¶å®ƒèŠ‚ç‚¹å¾—ip:portäº†; @Component(&quot;serverListManager&quot;) public class ServerListManager extends MemberChangeListener { @PostConstruct public void init() { // é›†ç¾¤èŠ‚ç‚¹çŠ¶æ€åŒæ­¥ä»»åŠ¡ï¼Œå®ƒä¼šæ¯2ç§’è°ƒç”¨é›†ç¾¤å…¶å®ƒèŠ‚ç‚¹çš„çŠ¶æ€æ¥å£ï¼Œä»¥åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦è¿˜åœ¨çº¿ï¼ GlobalExecutor.registerServerStatusReporter(new ServerStatusReporter(), 2000); GlobalExecutor.registerServerInfoUpdater(new ServerInfoUpdater()); } // é›†ç¾¤èŠ‚ç‚¹çŠ¶æ€åŒæ­¥ä»»åŠ¡ï¼Œæ¯2ç§’æ‰§è¡Œä¸€æ¬¡ï¼Œ ServerStatusReporter.run(){ // å¾ˆç®€å•ï¼Œå°±æ˜¯è°ƒç”¨å…¶å®ƒèŠ‚ç‚¹çš„çŠ¶æ€æ¥å£ï¼Œå‘Šè¯‰å…¶å®ƒæœºå™¨è‡ªå·±è¿˜æ´»ç€ï¼ˆé›†ç¾¤ä¸­æ¯ä¸¤å°æœºå™¨ç›´æ¥éƒ½ä¼šäº’ç›¸è°ƒç”¨ï¼‰ï¼› // å¦‚æœæŸä¸ªèŠ‚ç‚¹åœ¨ä¸€å®šæ—¶é—´å†…ï¼Œæ²¡æœ‰æ”¶åˆ°å…¶å®ƒæŸä¸ªèŠ‚ç‚¹çš„çŠ¶æ€æŠ¥å‘Šï¼Œé‚£å°±è®¤ä¸ºè¿™ä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œå°±ä¼šæ›´æ–°è‡ªå·±æœ¬åœ°è®¤ä¸ºçš„é›†ç¾¤å­˜æ´»èŠ‚ç‚¹æ•°ï¼› // é›†ç¾¤å­˜æ´»èŠ‚ç‚¹æ•°ä¼šç›´æ¥å½±å“åˆ°â€œæœåŠ¡å¥åº·æ£€æŸ¥â€çš„ç›®æ ‡æœºå™¨æ ¸å¿ƒå˜é‡ï¼Œä»è€Œå†³å®šæ¯ä¸ªServiceï¼Œå°†ä¼šåœ¨å“ªä¸ªServerèŠ‚ç‚¹è¢«æ‰§è¡Œå¥åº·æ£€æŸ¥ï¼ synchronizer.send(server.getAddress(), msg); } } 3 â€œæœåŠ¡æ³¨å†Œâ€ä»»åŠ¡ç”±å“ªä¸ªèŠ‚ç‚¹è´Ÿè´£ï¼Ÿå¦‚ä½•åŒæ­¥æ•°æ®åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Ÿ â€œæœåŠ¡æ³¨å†Œâ€ä»»åŠ¡ï¼Œæœ‰Clientç«¯å‘èµ·ï¼Œæ ¹æ®è´Ÿè½½å‡è¡¡ç®—æ³•æŒ‘é€‰ä¸€å°Serveræœºå™¨è¿›è¡Œæ³¨å†Œï¼› è¢«æŒ‘é€‰åˆ°çš„ServerèŠ‚ç‚¹ï¼Œå¤„ç†è‡ªå·±çš„æ³¨å†Œä»»åŠ¡çš„åŒæ—¶ï¼Œé€šè¿‡Distroåè®®ï¼ŒåŒæ­¥åˆ°é›†ç¾¤ä¸­çš„å…¶å®ƒèŠ‚ç‚¹ï¼› // com.alibaba.nacos.naming.consistency.ephemeral.distro.DistroConsistencyServiceImpl#put public void put(String key, Record value) throws NacosException { // åœ¨æœ¬æœºå¤„ç†æœåŠ¡æ³¨å†Œè¯·æ±‚ onPut(key, value); // åŒæ­¥ç»™å…¶å®ƒæœºå™¨è¿›è¡Œæ³¨å†Œ distroProtocol.sync(new DistroKey(key, KeyBuilder.INSTANCE_LIST_KEY_PREFIX), DataOperation.CHANGE, globalConfig.getTaskDispatchPeriod() / 2); } 4 å¦‚ä½•åˆ¤æ–­å„ä¸ªServiceçš„å¥åº·æ£€æŸ¥ä»»åŠ¡ï¼Œç”±é›†ç¾¤ä¸­çš„å“ªä¸ªèŠ‚ç‚¹è´Ÿè´£æ£€æŸ¥ï¼Ÿ // æˆ‘ä»¬æ‰¾åˆ°å¿ƒè·³æ£€æŸ¥ä»»åŠ¡çš„run()æ–¹æ³•ï¼š ClientBeatCheckTask.run(){ // åˆ¤æ–­æ˜¯å¦è¯¥ç”±æœ¬èŠ‚ç‚¹è´Ÿè´£è¯¥Serviceçš„å¿ƒè·³æ£€æŸ¥ä»»åŠ¡ if (!getDistroMapper().responsible(service.getName())) { return; } ...å¦‚æœæ˜¯è‡ªå·±è´Ÿè´£è¯¥Serviceçš„å¿ƒè·³æ£€æŸ¥ï¼Œæ‰ä¼šç»§ç»­æ‰§è¡Œå¿ƒè·³æ£€æŸ¥ä»»åŠ¡... } // åˆ¤æ–­é€»è¾‘ public boolean responsible(String serviceName) { final List&lt;String&gt; servers = healthyList; if (!switchDomain.isDistroEnabled() || EnvUtil.getStandaloneMode()) { return true; } if (CollectionUtils.isEmpty(servers)) { // means distro config is not ready yet return false; } int index = servers.indexOf(EnvUtil.getLocalAddress()); int lastIndex = servers.lastIndexOf(EnvUtil.getLocalAddress()); if (lastIndex &lt; 0 || index &lt; 0) { return true; // è‡ªå·±ä¸åœ¨é›†ç¾¤åˆ—è¡¨ä¸­ï¼Œé‚£å¯èƒ½å½“å‰å°±ä¸æ˜¯é›†ç¾¤éƒ¨ç½²ï¼Œæ‰€ä»¥è‡ªå·±å¾—æ£€æŸ¥ } // å¯¹serviceNameè¿›è¡Œhashåï¼Œå¯¹å½“å‰é›†ç¾¤èŠ‚ç‚¹æ•°é‡å–ä½™ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯è‡ªå·± // å¦‚æœä¸æ˜¯è‡ªå·±ï¼Œä¸ç”¨æ‹…å¿ƒï¼Œå…¶å®ƒæœºå™¨åœ¨è¢«æ³¨å†Œæ—¶ï¼Œä¹Ÿä¼šèµ°åˆ°è¿™æ¡é€»è¾‘ï¼Œæ€»æœ‰ä¸€å°æœºå™¨æ˜¯è´Ÿè´£è¯¥Serviceçš„â€œå¥åº·æ£€æŸ¥â€çš„ int target = distroHash(serviceName) % servers.size(); return target &gt;= index &amp;&amp; target &lt;= lastIndex; } 5 é›†ç¾¤é—´ä¸¤ä¸ªé‡è¦çš„åŒæ­¥ä»»åŠ¡ 1. ServerListManagerä¸‹çš„ServerStatusReporterä»»åŠ¡ï¼š â€”â€” ä¸Šé¢å·²ç»è®²è¿‡ï¼Œåœ¨é›†ç¾¤ä¹‹é—´é€šè¿‡å®šæ—¶è°ƒç”¨çŠ¶æ€æ¥å£çš„æ–¹å¼ï¼ŒåŒæ­¥é›†ç¾¤å„èŠ‚ç‚¹çš„åœ¨çº¿çŠ¶æ€ï¼ 2. ServiceManagerä¸‹çš„ServiceReporterä»»åŠ¡ï¼š â€”â€” å½“æŸä¸ªèŠ‚ç‚¹æ‰§è¡Œå®Œå¥åº·æ£€æŸ¥åï¼Œå¦‚æœå‘ç°æŸä¸ªServiceå®ä¾‹çŠ¶æ€æ”¹å˜äº†ï¼Œå®ƒå¿…é¡»è¦åŒæ­¥ç»™é›†ç¾¤ä¸­å…¶å®ƒèŠ‚ç‚¹ï¼Œä¿®æ”¹å„è‡ªæ³¨å†Œè¡¨ä¸­çš„çŠ¶æ€ï¼ˆé€šè¿‡è°ƒç”¨InstanceControllerä¸­çš„APIæ¥å£å®ç°ï¼‰ 6 å¦‚æœæœ‰æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ï¼Œå¦‚æœä»å…¶å®ƒèŠ‚ç‚¹åŒæ­¥æ•°æ®ï¼Ÿ // æ¯ä¸ªèŠ‚ç‚¹å¯åŠ¨æ—¶ï¼Œä¼šæ³¨å…¥ä¸€ä¸ªDistroProtocolçš„Bean @Component public class DistroProtocol { // åœ¨DistroProtocolçš„æ„é€ å‡½æ•°ä¸­ï¼Œä¼šå¯åŠ¨DistroTaskæ•°æ®åŒæ­¥ä»»åŠ¡ public DistroProtocol(ServerMemberManager memberManager, DistroComponentHolder distroComponentHolder, DistroTaskEngineHolder distroTaskEngineHolder, DistroConfig distroConfig) { this.memberManager = memberManager; this.distroComponentHolder = distroComponentHolder; this.distroTaskEngineHolder = distroTaskEngineHolder; this.distroConfig = distroConfig; startDistroTask(); } private void startDistroTask() { // å¦‚æœæ—¶å•èŠ‚ç‚¹è¿è¡Œï¼Œå°±ä¸ç”¨åŒæ­¥å•¦ if (EnvUtil.getStandaloneMode()) { isInitialized = true; return; } startVerifyTask(); startLoadTask(); // å¼€å¯æ•°æ®åŠ è½½ä»»åŠ¡ } private void startLoadTask() { DistroCallback loadCallback = new DistroCallback() { @Override public void onSuccess() { isInitialized = true; } @Override public void onFailed(Throwable throwable) { isInitialized = false; } }; GlobalExecutor.submitLoadDataTask( new DistroLoadDataTask(memberManager, distroComponentHolder, distroConfig, loadCallback)); } } //DistroLoadDataTaskä»»åŠ¡çš„æ ¸å¿ƒrun()æ–¹æ³•ï¼š DistroLoadDataTask.run(){ try { load(); // ä»å…¶å®ƒèŠ‚ç‚¹åŠ è½½æ•°æ® if (!checkCompleted()) { // å¦‚æœä¸æˆåŠŸï¼Œå°±å¼€ä¸ªå»¶æ—¶ä»»åŠ¡ï¼Œè¿‡ä¼šå„¿ç»§ç»­å°è¯•å»åŠ è½½ GlobalExecutor.submitLoadDataTask(this, distroConfig.getLoadDataRetryDelayMillis()); } else { loadCallback.onSuccess(); Loggers.DISTRO.info(&quot;[DISTRO-INIT] load snapshot data success&quot;); } } catch (Exception e) { loadCallback.onFailed(e); Loggers.DISTRO.error(&quot;[DISTRO-INIT] load snapshot data failed. &quot;, e); } } çœŸæ­£çš„load()ä»è¿œç¨‹åŠ è½½é€»è¾‘ï¼š private void load() throws Exception { while (memberManager.allMembersWithoutSelf().isEmpty()) { Loggers.DISTRO.info(&quot;[DISTRO-INIT] waiting server list init...&quot;); TimeUnit.SECONDS.sleep(1); } while (distroComponentHolder.getDataStorageTypes().isEmpty()) { Loggers.DISTRO.info(&quot;[DISTRO-INIT] waiting distro data storage register...&quot;); TimeUnit.SECONDS.sleep(1); } for (String each : distroComponentHolder.getDataStorageTypes()) { if (!loadCompletedMap.containsKey(each) || !loadCompletedMap.get(each)) { loadCompletedMap.put(each, loadAllDataSnapshotFromRemote(each)); } } } // forå¾ªç¯å°è¯•ä»æ‰€æœ‰è¿œç¨‹èŠ‚ç‚¹è·å–æ³¨å†Œè¡¨å…¨é‡æ–‡ä»¶ï¼Œåªè¦æœ‰ä¸€ä¸ªæˆåŠŸï¼Œåˆ™è·³å‡ºforå¾ªç¯ private boolean loadAllDataSnapshotFromRemote(String resourceType) { DistroTransportAgent transportAgent = distroComponentHolder.findTransportAgent(resourceType); DistroDataProcessor dataProcessor = distroComponentHolder.findDataProcessor(resourceType); if (null == transportAgent || null == dataProcessor) { Loggers.DISTRO.warn(&quot;[DISTRO-INIT] Can't find component for type {}, transportAgent: {}, dataProcessor: {}&quot;, resourceType, transportAgent, dataProcessor); return false; } for (Member each : memberManager.allMembersWithoutSelf()) { try { // è°ƒå–è¿œç¨‹èŠ‚ç‚¹çš„è·å–DatumSnapshotå¿«ç…§æ•°æ®æ¥å£ DistroData distroData = transportAgent.getDatumSnapshot(each.getAddress()); // å¤„ç†æ•°æ®ï¼ŒåŠ è½½åˆ°æœ¬èŠ‚ç‚¹å†…å­˜çš„æ³¨å†Œè¡¨ä¸­ï¼Œå®Œæˆæ–°èŠ‚ç‚¹æ•°æ®åˆå§‹åŒ– boolean result = dataProcessor.processSnapshot(distroData); if (result) { return true; // æœ‰ä¸€ä¸ªèŠ‚ç‚¹æˆåŠŸï¼Œåˆ™è·³å‡ºå…¨éƒ¨forå¾ªç¯ï¼Œç›´æ¥è¿”å›æˆåŠŸç»“æœ } } catch (Exception e) { ...... } } return false; } ","link":"https://tianxiawuhao.github.io/zMtbXOeeT/"},{"title":"ä¸Šä¼ æ–‡ä»¶åˆ°äºšé©¬é€Šäº‘S3å¯¹è±¡å­˜å‚¨","content":"ä¸€ åœ¨äºšé©¬é€Šäº‘S3åˆ›å»ºä¸€ä¸ªå­˜å‚¨æ¡¶ï¼Œå¹¶è®¾ç½®æƒé™ 1 åˆ›å»ºä¸€ä¸ªå­˜å‚¨æ¡¶ï¼Œå¹¶å°†æƒé™è®¾ç½®ä¸ºå…¬å¼€ï¼Œå› ä¸ºæˆ‘æ­£å¸¸æ—¶å€™æ˜¯ç”¨æ¥å­˜æ”¾ç½‘ç«™å›¾ç‰‡ 2 é…ç½®å­˜å‚¨å·ç­–ç•¥ { &quot;Version&quot;: &quot;2012-10-17&quot;, &quot;Statement&quot;: [ { &quot;Sid&quot;: &quot;PublicReadGetObject&quot;, &quot;Effect&quot;: &quot;Allow&quot;, &quot;Principal&quot;: &quot;*&quot;, &quot;Action&quot;: &quot;s3:GetObject&quot;, &quot;Resource&quot;: &quot;arn:aws:s3:::test.jiguiquan.com/*&quot; } ] } 3 é…ç½®è·¨åŸŸç­–ç•¥ [ { &quot;AllowedHeaders&quot;: [ &quot;*&quot; ], &quot;AllowedMethods&quot;: [ &quot;PUT&quot;, &quot;POST&quot;, &quot;GET&quot; ], &quot;AllowedOrigins&quot;: [ &quot;*&quot; ], &quot;ExposeHeaders&quot;: [ &quot;x-amz-server-side-encryption&quot;, &quot;x-amz-request-id&quot;, &quot;x-amz-id-2&quot; ], &quot;MaxAgeSeconds&quot;: 3000 } ] åˆ°è¿™é‡Œï¼Œå­˜å‚¨å·çš„é…ç½®å°±ç®—æ˜¯OKå•¦ï¼Œæ»¡è¶³æ­£å¸¸ç½‘ç«™å›¾ç‰‡çš„ä½¿ç”¨äº†ï¼ äºŒ ç¼–å†™Javaç±»ï¼Œå®Œæˆæ–‡ä»¶çš„ä¸Šä¼  1 åœ¨é¡¹ç›®ä¸­å¼•å…¥ aws-sdk çš„ä¾èµ– &lt;dependency&gt; &lt;groupId&gt;com.amazonaws&lt;/groupId&gt; &lt;artifactId&gt;aws-java-sdk-s3&lt;/artifactId&gt; &lt;version&gt;1.11.347&lt;/version&gt; &lt;/dependency&gt; 2 ç¼–å†™ä¸Šä¼ æ–‡ä»¶çš„æ¥å£ @Api(tags = &quot;Authâ€”â€”ç¬¬ä¸‰æ–¹æœåŠ¡æ¨¡å—&quot;) @RestController @RequiredArgsConstructor public class ThirdpartyController { @Value(&quot;${s3.accessKeyId}&quot;) private String s3AccessKeyId; @Value(&quot;${s3.accessKeySecret}&quot;) private String s3AccessKeySecret; @Value(&quot;${s3.bucketName}&quot;) private String s3BucketName; @Value(&quot;${s3.region}&quot;) private String s3Region; private static BasicAWSCredentials awsCreds; private static AmazonS3 s3; @PostConstruct private void init(){ awsCreds = new BasicAWSCredentials(s3AccessKeyId, s3AccessKeySecret); s3 = AmazonS3ClientBuilder.standard() .withCredentials(new AWSStaticCredentialsProvider(awsCreds)) //è®¾ç½®æœåŠ¡å™¨æ‰€å±åœ°åŒº .withRegion(s3Region) .build(); } @ApiResponses({@ApiResponse(code = 200, message = &quot;æ–‡ä»¶url&quot;)}) @ApiOperation(&quot;åç«¯ç›´æ¥ä¸Šä¼ æ–‡ä»¶åˆ°äºšé©¬é€Šäº‘S3&quot;) @PostMapping(&quot;/auth/s3/upload&quot;) public BaseResponse&lt;String&gt; uploadFileToS3(@RequestParam(&quot;file&quot;) MultipartFile file) { if (file.getSize() == 0){ throw ZidanApiException.create(BmoonResponseCode.FILE_SIZE_ZERO); } if (StringUtils.isBlank(file.getOriginalFilename())){ throw ZidanApiException.create(BmoonResponseCode.FILE_NAME_EMPTY); } // String host = &quot;https://s3.&quot; + s3Region + &quot;.amazonaws.com/&quot; + s3BucketName; String host = &quot;https://s3.ap-northeast-2.amazonaws.com/test.jiguiquan.com&quot;; String format = new SimpleDateFormat(&quot;yyyyMMdd&quot;).format(new Date()); String uploadName = format + &quot;/&quot; + UUID.randomUUID().toString() + file.getOriginalFilename(); ObjectMetadata metadata = new ObjectMetadata(); metadata.setContentType(file.getContentType()); metadata.setContentLength(file.getSize()); InputStream inputStream = null; try { inputStream = file.getInputStream(); com.amazonaws.services.s3.model.PutObjectResult result = s3.putObject(new PutObjectRequest(s3BucketName, uploadName, inputStream, metadata)); System.out.println(uploadName + &quot;:æ–‡ä»¶çš„Md5ä¸ºï¼š&quot; + result.getContentMd5()); return BaseResponse.success(host + &quot;/&quot; + uploadName); }catch (Exception e) { e.printStackTrace(); throw ZidanApiException.create(BmoonResponseCode.FILE_UPLOAD_FAILED); } finally { if (inputStream != null){ try { inputStream.close(); } catch (IOException e) { e.printStackTrace(); } } } } } ä¸‰ æµ‹è¯•æ–‡ä»¶çš„ä¸Šä¼ ä¸è®¿é—® æµè§ˆå™¨è®¿é—®ï¼š ","link":"https://tianxiawuhao.github.io/PTmSAlH_U/"},{"title":"netty","content":"1. Nettyç®€å•ä»‹ç» 1. åŸç”ŸNIOå­˜åœ¨çš„é—®é¢˜ ä¸ºä»€ä¹ˆæœ‰äº† NIO ï¼Œè¿˜ä¼šå‡ºç° Nettyï¼Œå› ä¸º NIO æœ‰å¦‚ä¸‹é—®é¢˜ï¼š NIO çš„ç±»åº“å’Œ API ç¹æ‚ï¼Œä½¿ç”¨éº»çƒ¦ï¼šéœ€è¦ç†Ÿç»ƒæŒæ¡ Selectorã€ServerSocketChannelã€ SocketChannelã€ByteBuffer ç­‰ã€‚ éœ€è¦å…·å¤‡å…¶ä»–çš„é¢å¤–æŠ€èƒ½ï¼šè¦ç†Ÿæ‚‰ Java å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œå› ä¸º NIO ç¼–ç¨‹æ¶‰åŠåˆ° Reactor æ¨¡å¼ï¼Œä½ å¿…é¡»å¯¹å¤šçº¿ç¨‹å’Œç½‘ç»œç¼–ç¨‹éå¸¸ç†Ÿæ‚‰ï¼Œæ‰èƒ½ç¼–å†™å‡ºé«˜è´¨é‡çš„ NIO ç¨‹åºã€‚ å¼€å‘å·¥ä½œé‡å’Œéš¾åº¦éƒ½éå¸¸å¤§ï¼šä¾‹å¦‚å®¢æˆ·ç«¯é¢ä¸´æ–­è¿é‡è¿ã€ç½‘ç»œé—ªæ–­ã€åŠåŒ…è¯»å†™ã€å¤±è´¥ç¼“å­˜ã€ç½‘ç»œæ‹¥å¡å’Œå¼‚å¸¸æµçš„å¤„ç†ç­‰ç­‰ã€‚ JDK NIO çš„ Bugï¼šä¾‹å¦‚è‡­åæ˜­è‘—çš„ Epoll Bugï¼Œå®ƒä¼šå¯¼è‡´ Selector ç©ºè½®è¯¢ï¼ˆæ­»å¾ªç¯ï¼‰ï¼Œæœ€ç»ˆå¯¼è‡´ CPU 100%ã€‚ç›´åˆ° JDK 1.7 ç‰ˆæœ¬è¯¥é—®é¢˜ä»æ—§å­˜åœ¨ï¼Œæ²¡æœ‰è¢«æ ¹æœ¬è§£å†³ 2. Nettyå®˜ç½‘è¯´æ˜ å®˜ç½‘åœ°å€ ï¼šhttps://netty.io/ Nettyæ˜¯ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨ç¨‹åºæ¡†æ¶ï¼Œç”¨äºå¿«é€Ÿå¼€å‘å¯ç»´æŠ¤çš„é«˜æ€§èƒ½çš„æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ã€‚ Netty æ˜¯ç”± JBOSS æä¾›çš„ä¸€ä¸ª Java å¼€æºæ¡†æ¶ã€‚Netty æä¾›å¼‚æ­¥çš„ã€åŸºäºäº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨ç¨‹åºæ¡†æ¶ï¼Œç”¨ä»¥å¿«é€Ÿå¼€å‘é«˜æ€§èƒ½ã€é«˜å¯é æ€§çš„ç½‘ç»œ IO ç¨‹åºã€‚ Netty å¯ä»¥å¸®åŠ©ä½ å¿«é€Ÿã€ç®€å•çš„å¼€å‘å‡ºä¸€ä¸ªç½‘ç»œåº”ç”¨ï¼Œç›¸å½“äºç®€åŒ–å’Œæµç¨‹åŒ–äº† NIO çš„ å¼€å‘è¿‡ç¨‹ã€‚ Netty æ˜¯ç›®å‰æœ€æµè¡Œçš„ NIO æ¡†æ¶ï¼ŒNetty åœ¨äº’è”ç½‘é¢†åŸŸã€å¤§æ•°æ®åˆ†å¸ƒå¼è®¡ç®—é¢†åŸŸã€æ¸¸æˆè¡Œä¸šã€é€šä¿¡è¡Œä¸šç­‰è·å¾—äº†å¹¿æ³›çš„åº”ç”¨ï¼ŒçŸ¥åçš„ Elasticsearch ã€Dubbo æ¡†æ¶å†…éƒ¨éƒ½é‡‡ ç”¨äº† Nettyã€‚ 3. Nettyçš„ä¼˜ç‚¹ Netty å¯¹ JDK è‡ªå¸¦çš„ NIO çš„ API è¿›è¡Œäº†å°è£…ï¼Œè§£å†³äº†ä¸Šè¿°é—®é¢˜ã€‚ è®¾è®¡ä¼˜é›…ï¼šé€‚ç”¨äºå„ç§ä¼ è¾“ç±»å‹çš„ç»Ÿä¸€ API é˜»å¡å’Œéé˜»å¡ Socketï¼›åŸºäºçµæ´»ä¸”å¯æ‰©å±•çš„äº‹ä»¶æ¨¡å‹ï¼Œå¯ä»¥æ¸…æ™°åœ°åˆ†ç¦»å…³æ³¨ç‚¹ï¼›é«˜åº¦å¯å®šåˆ¶çš„çº¿ç¨‹æ¨¡å‹ â€”â€” å•çº¿ç¨‹ï¼Œä¸€ä¸ªæˆ–å¤šä¸ª çº¿ç¨‹æ± . ä½¿ç”¨æ–¹ä¾¿ï¼šè¯¦ç»†è®°å½•çš„ Javadocï¼Œç”¨æˆ·æŒ‡å—å’Œç¤ºä¾‹ï¼›æ²¡æœ‰å…¶ä»–ä¾èµ–é¡¹ (JDK 5 -&gt; Netty 3.x ; 6 -&gt; Netty 4.x å°±å¯ä»¥æ”¯æŒäº†ï¼‰ã€‚ é«˜æ€§èƒ½ã€ååé‡æ›´é«˜ï¼šå»¶è¿Ÿæ›´ä½ï¼›å‡å°‘èµ„æºæ¶ˆè€—ï¼›æœ€å°åŒ–ä¸å¿…è¦çš„å†…å­˜å¤åˆ¶ã€‚ å®‰å…¨ï¼šå®Œæ•´çš„ SSL/TLS å’Œ StartTLS æ”¯æŒã€‚ ç¤¾åŒºæ´»è·ƒã€ä¸æ–­æ›´æ–°ï¼šç¤¾åŒºæ´»è·ƒï¼Œç‰ˆæœ¬è¿­ä»£å‘¨æœŸçŸ­ï¼Œå‘ç°çš„ Bug å¯ä»¥è¢«åŠæ—¶ä¿®å¤ï¼Œ åŒæ—¶ï¼Œæ›´å¤šçš„æ–°åŠŸèƒ½ä¼šè¢«åŠ å…¥ 4. Nettyç‰ˆæœ¬è¯´æ˜ nettyç‰ˆæœ¬åˆ†ä¸º netty3.x å’Œ netty4.xã€netty5.x å› ä¸ºNetty5å‡ºç°é‡å¤§bugï¼Œå·²ç»è¢«å®˜ç½‘åºŸå¼ƒäº†ï¼Œç›®å‰æ¨èä½¿ç”¨çš„æ˜¯Netty4.xçš„ç¨³å®šç‰ˆæœ¬ ç›®å‰åœ¨å®˜ç½‘å¯ä¸‹è½½çš„ç‰ˆæœ¬ netty3.x netty4.0.x å’Œ netty4.1.x è¿™é‡Œä½¿ç”¨çš„æ˜¯ Netty4.1.x ç‰ˆæœ¬ netty ä¸‹è½½åœ°å€ï¼š https://bintray.com/netty/downloads/netty/ 2. å„çº¿ç¨‹æ¨¡å¼ 1. ä¼ ç»Ÿé˜»å¡ I/O æœåŠ¡æ¨¡å‹ æ¨¡å‹ç‰¹ç‚¹ é‡‡ç”¨é˜»å¡IOæ¨¡å¼è·å–è¾“å…¥çš„æ•°æ® æ¯ä¸ªè¿æ¥éƒ½éœ€è¦ç‹¬ç«‹çš„çº¿ç¨‹å®Œæˆæ•°æ®çš„è¾“å…¥ï¼ˆreadï¼‰ï¼Œä¸šåŠ¡å¤„ç†ï¼Œ æ•°æ®è¿”å›ï¼ˆsendï¼‰ é—®é¢˜åˆ†æ å½“å¹¶å‘æ•°å¾ˆå¤§ï¼Œå°±ä¼šåˆ›å»ºå¤§é‡çš„çº¿ç¨‹ï¼Œå ç”¨å¾ˆå¤§ç³»ç»Ÿèµ„æº è¿æ¥åˆ›å»ºåï¼Œå¦‚æœå½“å‰çº¿ç¨‹æš‚æ—¶æ²¡æœ‰æ•°æ®å¯è¯»ï¼Œè¯¥çº¿ç¨‹ä¼šé˜»å¡åœ¨read æ“ä½œï¼Œé€ æˆçº¿ç¨‹èµ„æºæµªè´¹ 2. Reactor æ¨¡å¼ é’ˆå¯¹ä¼ ç»Ÿé˜»å¡ I/O æœåŠ¡æ¨¡å‹çš„ 2 ä¸ªç¼ºç‚¹ï¼Œè§£å†³æ–¹æ¡ˆï¼š åŸºäº I/O å¤ç”¨æ¨¡å‹ï¼šå¤šä¸ªè¿æ¥å…±ç”¨ä¸€ä¸ªé˜»å¡å¯¹è±¡ï¼Œåº”ç”¨ç¨‹åºåªéœ€è¦åœ¨ä¸€ä¸ªé˜»å¡å¯¹è±¡ç­‰å¾…ï¼Œæ— éœ€é˜»å¡ç­‰å¾…æ‰€æœ‰è¿æ¥ã€‚å½“æŸä¸ªè¿æ¥æœ‰æ–°çš„æ•°æ®å¯ä»¥å¤„ç†æ—¶ï¼Œæ“ä½œç³»ç»Ÿé€šçŸ¥åº”ç”¨ç¨‹åºï¼Œçº¿ç¨‹ä»é˜»å¡çŠ¶æ€è¿”å›ï¼Œå¼€å§‹è¿›è¡Œä¸šåŠ¡å¤„ç† åŸºäºçº¿ç¨‹æ± å¤ç”¨çº¿ç¨‹èµ„æºï¼šä¸å¿…å†ä¸ºæ¯ä¸ªè¿æ¥åˆ›å»ºçº¿ç¨‹ï¼Œå°†è¿æ¥å®Œæˆåçš„ä¸šåŠ¡å¤„ç†ä»»åŠ¡åˆ†é…ç»™çº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤„ç†å¤šä¸ªè¿æ¥çš„ä¸šåŠ¡ã€‚ Reactor å¯¹åº”çš„å«æ³•: ååº”å™¨æ¨¡å¼ åˆ†å‘è€…æ¨¡å¼(Dispatcher) é€šçŸ¥è€…æ¨¡å¼(notifier) è¯´æ˜: Reactor æ¨¡å¼ï¼Œé€šè¿‡ä¸€ä¸ªæˆ–å¤šä¸ªè¾“å…¥åŒæ—¶ä¼ é€’ç»™æœåŠ¡å¤„ç†å™¨çš„æ¨¡å¼ (åŸºäºäº‹ä»¶é©±åŠ¨) æœåŠ¡å™¨ç«¯ç¨‹åºå¤„ç†ä¼ å…¥çš„å¤šä¸ªè¯·æ±‚, å¹¶å°†å®ƒä»¬åŒæ­¥åˆ†æ´¾åˆ°ç›¸åº”çš„å¤„ç†çº¿ç¨‹ï¼Œ å› æ­¤Reactorï¼ˆååº”å™¨ï¼‰æ¨¡å¼ä¹Ÿå« Dispatcherï¼ˆåˆ†å‘è€…ï¼‰ æ¨¡å¼ Reactor æ¨¡å¼ä½¿ç”¨IOå¤ç”¨ç›‘å¬äº‹ä»¶, æ”¶åˆ°äº‹ä»¶åï¼Œåˆ†å‘ç»™æŸä¸ªçº¿ç¨‹(è¿›ç¨‹), è¿™ç‚¹å°±æ˜¯ç½‘ç»œæœåŠ¡å™¨é«˜å¹¶å‘å¤„ç†å…³é”® æ ¸å¿ƒç»„æˆï¼š Reactorï¼šReactor åœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸­è¿è¡Œï¼Œè´Ÿè´£ç›‘å¬å’Œåˆ†å‘äº‹ä»¶ï¼Œåˆ†å‘ç»™é€‚å½“çš„å¤„ ç†ç¨‹åºæ¥å¯¹ IO äº‹ä»¶åšå‡ºååº”ã€‚ å®ƒå°±åƒå…¬å¸çš„ç”µè¯æ¥çº¿å‘˜ï¼Œå®ƒæ¥å¬æ¥è‡ªå®¢æˆ·çš„ç”µè¯å¹¶ å°†çº¿è·¯è½¬ç§»åˆ°é€‚å½“çš„è”ç³»äººï¼› Handlersï¼šå¤„ç†ç¨‹åºæ‰§è¡Œ I/O äº‹ä»¶è¦å®Œæˆçš„å®é™…äº‹ä»¶ï¼Œç±»ä¼¼äºå®¢æˆ·æƒ³è¦ä¸ä¹‹äº¤è°ˆçš„å…¬å¸ä¸­çš„å®é™…å®˜å‘˜ã€‚Reactor é€šè¿‡è°ƒåº¦é€‚å½“çš„å¤„ç†ç¨‹åºæ¥å“åº” I/O äº‹ä»¶ï¼Œå¤„ç†ç¨‹åºæ‰§è¡Œéé˜»å¡æ“ä½œ Reactor æ¨¡å¼åˆ†ç±»ï¼š å• Reactor å•çº¿ç¨‹ å• Reactor å¤šçº¿ç¨‹ ä¸»ä» Reactor å¤šçº¿ç¨‹ 3. å•Reactor-å•çº¿ç¨‹ è¯´æ˜ï¼š Select æ˜¯å‰é¢ I/O å¤ç”¨æ¨¡å‹ä»‹ç»çš„æ ‡å‡†ç½‘ç»œç¼–ç¨‹ APIï¼Œå¯ä»¥å®ç°åº”ç”¨ç¨‹åºé€šè¿‡ä¸€ä¸ªé˜»å¡å¯¹è±¡ç›‘å¬å¤šè·¯è¿æ¥è¯·æ±‚ Reactor å¯¹è±¡é€šè¿‡ Select ç›‘æ§å®¢æˆ·ç«¯è¯·æ±‚äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åé€šè¿‡ Dispatch è¿›è¡Œåˆ†å‘ å¦‚æœæ˜¯å»ºç«‹è¿æ¥è¯·æ±‚äº‹ä»¶ï¼Œåˆ™ç”± Acceptor é€šè¿‡ Accept å¤„ç†è¿æ¥è¯·æ±‚ï¼Œç„¶ååˆ›å»ºä¸€ä¸ª Handler å¯¹è±¡å¤„ç†è¿æ¥å®Œæˆåçš„åç»­ä¸šåŠ¡å¤„ç† å¦‚æœä¸æ˜¯å»ºç«‹è¿æ¥äº‹ä»¶ï¼Œåˆ™ Reactor ä¼šåˆ†å‘è°ƒç”¨è¿æ¥å¯¹åº”çš„ Handler æ¥å“åº” Handler ä¼šå®Œæˆ Readâ†’ä¸šåŠ¡å¤„ç†â†’Send çš„å®Œæ•´ä¸šåŠ¡æµç¨‹ ç»“åˆå®ä¾‹ï¼šæœåŠ¡å™¨ç«¯ç”¨ä¸€ä¸ªçº¿ç¨‹é€šè¿‡å¤šè·¯å¤ç”¨æå®šæ‰€æœ‰çš„ IO æ“ä½œï¼ˆåŒ…æ‹¬è¿æ¥ï¼Œè¯»ã€å†™ ç­‰ï¼‰ï¼Œç¼–ç ç®€å•ï¼Œæ¸…æ™°æ˜äº†ï¼Œä½†æ˜¯å¦‚æœå®¢æˆ·ç«¯è¿æ¥æ•°é‡è¾ƒå¤šï¼Œå°†æ— æ³•æ”¯æ’‘ï¼Œå‰é¢çš„ NIO æ¡ˆä¾‹å°±å±äºè¿™ç§æ¨¡å‹ã€‚ ä¼˜ç‚¹ï¼š æ¨¡å‹ç®€å•ï¼Œæ²¡æœ‰å¤šçº¿ç¨‹ã€è¿›ç¨‹é€šä¿¡ã€ç«äº‰çš„é—®é¢˜ï¼Œå…¨éƒ¨éƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å®Œæˆ ç¼ºç‚¹ï¼š æ€§èƒ½é—®é¢˜ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œæ— æ³•å®Œå…¨å‘æŒ¥å¤šæ ¸ CPU çš„æ€§èƒ½ã€‚Handler åœ¨å¤„ç†æŸ ä¸ªè¿æ¥ä¸Šçš„ä¸šåŠ¡æ—¶ï¼Œæ•´ä¸ªè¿›ç¨‹æ— æ³•å¤„ç†å…¶ä»–è¿æ¥äº‹ä»¶ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´æ€§èƒ½ç“¶é¢ˆ å¯é æ€§é—®é¢˜ï¼Œçº¿ç¨‹æ„å¤–ç»ˆæ­¢ï¼Œæˆ–è€…è¿›å…¥æ­»å¾ªç¯ï¼Œä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿé€šä¿¡æ¨¡å—ä¸ å¯ç”¨ï¼Œä¸èƒ½æ¥æ”¶å’Œå¤„ç†å¤–éƒ¨æ¶ˆæ¯ï¼Œé€ æˆèŠ‚ç‚¹æ•…éšœ ä½¿ç”¨åœºæ™¯ï¼šå®¢æˆ·ç«¯çš„æ•°é‡æœ‰é™ï¼Œä¸šåŠ¡å¤„ç†éå¸¸å¿«é€Ÿï¼Œæ¯”å¦‚ Redisåœ¨ä¸šåŠ¡å¤„ç†çš„æ—¶é—´å¤ æ‚åº¦ O(1) çš„æƒ…å†µ 4. å• Reactor å¤šçº¿ç¨‹ è¯´æ˜ï¼š Reactor å¯¹è±¡é€šè¿‡ select ç›‘æ§å®¢æˆ·ç«¯è¯·æ±‚äº‹ä»¶, æ”¶åˆ°äº‹ä»¶åï¼Œé€šè¿‡ dispatch è¿›è¡Œåˆ†å‘ å¦‚æœå»ºç«‹è¿æ¥è¯·æ±‚, åˆ™ç”± Acceptor é€šè¿‡ accept å¤„ç†è¿æ¥è¯·æ±‚, ç„¶ååˆ›å»ºä¸€ä¸ªHandlerå¯¹è±¡å¤„ç†å®Œæˆè¿æ¥åçš„å„ç§äº‹ä»¶ å¦‚æœä¸æ˜¯è¿æ¥è¯·æ±‚ï¼Œåˆ™ç”± Reactor åˆ†å‘è°ƒç”¨è¿æ¥å¯¹ åº”çš„Handler æ¥å¤„ç† Handler åªè´Ÿè´£å“åº”äº‹ä»¶ï¼Œä¸åšå…·ä½“çš„ä¸šåŠ¡å¤„ç†, é€šè¿‡ read è¯»å–æ•°æ®åï¼Œä¼šåˆ†å‘ç»™åé¢çš„ Worker çº¿ç¨‹æ± çš„æŸä¸ªçº¿ç¨‹å¤„ç†ä¸šåŠ¡ Worker çº¿ç¨‹æ± ä¼šåˆ†é…ç‹¬ç«‹çº¿ç¨‹å®ŒæˆçœŸæ­£çš„ä¸šåŠ¡ï¼Œ å¹¶å°†ç»“æœè¿”å›ç»™ Handler Handler æ”¶åˆ°å“åº”åï¼Œé€šè¿‡ send å°†ç»“æœè¿”å›ç»™ Client ä¼˜ç‚¹ï¼šå¯ä»¥å……åˆ†çš„åˆ©ç”¨å¤šæ ¸cpu çš„å¤„ç†èƒ½åŠ› ç¼ºç‚¹ï¼šå¤šçº¿ç¨‹æ•°æ®å…±äº«å’Œè®¿é—®æ¯”è¾ƒå¤æ‚,å• Reactor å¤„ç†æ‰€æœ‰çš„äº‹ä»¶çš„ç›‘å¬å’Œå“åº”ï¼Œåœ¨å•çº¿ç¨‹è¿è¡Œï¼Œ åœ¨é«˜å¹¶å‘åœºæ™¯å®¹æ˜“å‡ºç°æ€§èƒ½ç“¶é¢ˆ 5. ä¸»ä» Reactor å¤šçº¿ç¨‹ è¯´æ˜ 1: Reactor ä¸»çº¿ç¨‹ MainReactor å¯¹è±¡é€šè¿‡ select ç›‘å¬è¿æ¥äº‹ä»¶, æ”¶åˆ°äº‹ä»¶åï¼Œé€šè¿‡ Acceptor å¤„ç†è¿æ¥äº‹ä»¶(ä¸» Reactor åªå¤„ç†è¿æ¥äº‹ä»¶) 2ï¼šå½“ Acceptor å¤„ç†è¿æ¥äº‹ä»¶åï¼ŒMainReactor å°†è¿æ¥åˆ†é…ç»™ SubReactor 3ï¼šSubReactor å°†è¿æ¥åŠ å…¥åˆ°è¿æ¥é˜Ÿåˆ—è¿›è¡Œç›‘å¬,å¹¶åˆ›å»º Handler è¿›è¡Œå„ç§äº‹ä»¶å¤„ç† 4ï¼šå½“æœ‰æ–°äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œ SubReactor å°±ä¼šè°ƒç”¨å¯¹åº”çš„ Handlerå¤„ç†ï¼ŒHandler é€šè¿‡ read è¯»å–æ•°æ®ï¼Œåˆ†å‘ç»™åé¢çš„ ï¼ˆWorker çº¿ç¨‹æ± ï¼‰å¤„ç† 5ï¼šï¼ˆWorker çº¿ç¨‹æ± ï¼‰åˆ†é…ç‹¬ç«‹çš„ ï¼ˆWorker çº¿ç¨‹ï¼‰è¿›è¡Œä¸šåŠ¡å¤„ç†ï¼Œå¹¶è¿” å›ç»“æœ 6ï¼šHandler æ”¶åˆ°å“åº”çš„ç»“æœåï¼Œå†é€šè¿‡ send å°†ç»“æœè¿”å›ç»™ Client psï¼šä¸€ä¸ª MainReactor å¯ä»¥å…³è”å¤šä¸ª SubReactor ä¼˜ç‚¹ï¼š çˆ¶çº¿ç¨‹ä¸å­çº¿ç¨‹çš„æ•°æ®äº¤äº’ç®€å•èŒè´£æ˜ç¡®ï¼Œçˆ¶çº¿ç¨‹åªéœ€è¦æ¥æ”¶æ–°è¿æ¥ï¼Œå­çº¿ç¨‹å®Œæˆåç»­çš„ä¸šåŠ¡å¤„ç†ã€‚ çˆ¶çº¿ç¨‹ä¸å­çº¿ç¨‹çš„æ•°æ®äº¤äº’ç®€å•ï¼ŒReactor ä¸»çº¿ç¨‹åªéœ€è¦æŠŠæ–°è¿æ¥ä¼ ç»™å­çº¿ç¨‹ï¼Œå­çº¿ç¨‹æ— éœ€è¿”å›æ•°æ®ã€‚ ç¼ºç‚¹ï¼šç¼–ç¨‹å¤æ‚åº¦è¾ƒé«˜ ç»“åˆå®ä¾‹ï¼šè¿™ç§æ¨¡å‹åœ¨è®¸å¤šé¡¹ç›®ä¸­å¹¿æ³›ä½¿ç”¨ï¼ŒåŒ…æ‹¬ Nginx ä¸»ä» Reactor å¤šè¿›ç¨‹æ¨¡å‹ï¼Œ Memcached ä¸»ä»å¤šçº¿ç¨‹ï¼ŒNetty ä¸»ä»å¤šçº¿ç¨‹æ¨¡å‹çš„æ”¯æŒ 6. Reactor æ¨¡å¼å°ç»“ 3 ç§æ¨¡å¼ç”¨ç”Ÿæ´»æ¡ˆä¾‹æ¥ç†è§£ å• Reactor å•çº¿ç¨‹ï¼Œå‰å°æ¥å¾…å‘˜å’ŒæœåŠ¡å‘˜æ˜¯åŒä¸€ä¸ªäººï¼Œå…¨ç¨‹ä¸ºé¡¾å®¢æœ å• Reactor å¤šçº¿ç¨‹ï¼Œ1 ä¸ªå‰å°æ¥å¾…å‘˜ï¼Œå¤šä¸ªæœåŠ¡å‘˜ï¼Œæ¥å¾…å‘˜åªè´Ÿè´£æ¥å¾… ä¸»ä» Reactor å¤šçº¿ç¨‹ï¼Œå¤šä¸ªå‰å°æ¥å¾…å‘˜ï¼Œå¤šä¸ªæœåŠ¡ç”Ÿ Reactor æ¨¡å¼å…·æœ‰å¦‚ä¸‹çš„ä¼˜ç‚¹ï¼š å“åº”å¿«ï¼Œä¸å¿…ä¸ºå•ä¸ªåŒæ­¥æ—¶é—´æ‰€é˜»å¡ï¼Œè™½ç„¶ Reactor æœ¬èº«ä¾ç„¶æ˜¯åŒæ­¥çš„ å¯ä»¥æœ€å¤§ç¨‹åº¦çš„é¿å…å¤æ‚çš„å¤šçº¿ç¨‹åŠåŒæ­¥é—®é¢˜ï¼Œå¹¶ä¸”é¿å…äº†å¤šçº¿ç¨‹/è¿›ç¨‹ çš„åˆ‡æ¢å¼€é”€ æ‰©å±•æ€§å¥½ï¼Œå¯ä»¥æ–¹ä¾¿çš„é€šè¿‡å¢åŠ  Reactor å®ä¾‹ä¸ªæ•°æ¥å……åˆ†åˆ©ç”¨ CPU èµ„æº å¤ç”¨æ€§å¥½ï¼ŒReactor æ¨¡å‹æœ¬èº«ä¸å…·ä½“äº‹ä»¶å¤„ç†é€»è¾‘æ— å…³ï¼Œå…·æœ‰å¾ˆé«˜çš„å¤ç”¨æ€§ 3. Nettyæ¨¡å‹ 1. ç®€å•ç‰ˆ è¯´æ˜ ï¼š BossGroup çº¿ç¨‹ç»´æŠ¤Selector , åªå…³æ³¨Accecpt å½“æ¥æ”¶åˆ°Acceptäº‹ä»¶ï¼Œè·å–åˆ°å¯¹åº”çš„ SocketChannel, å°è£…æˆ NIOScoketChannelå¹¶æ³¨å†Œåˆ° Worker çº¿ç¨‹(äº‹ä»¶å¾ªç¯), å¹¶è¿›è¡Œç»´æŠ¤ å½“Workerçº¿ç¨‹ç›‘å¬åˆ° Selector ä¸­é€šé“å‘ç”Ÿè‡ªå·±æ„Ÿ å…´è¶£çš„äº‹ä»¶åï¼Œå°±è¿›è¡Œå¤„ç†(å°±ç”± Handler å¤„ç†)ï¼Œ æ³¨æ„ Handler å·²ç»åŠ å…¥åˆ°é€šé“ 2. è¿›é˜¶ç‰ˆ 3. å®Œæ•´ç‰ˆ éå¸¸é‡è¦ è¯´æ˜ ï¼š 1ï¼šNetty æŠ½è±¡å‡ºä¸¤ç»„çº¿ç¨‹æ±  BossGroup ä¸“é—¨è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥, WorkerGroup ä¸“é—¨è´Ÿè´£ç½‘ç»œçš„è¯»å†™ 2ï¼šBossGroup å’Œ WorkerGroup ç±»å‹éƒ½æ˜¯ NioEventLoopGroup 3ï¼šNioEventLoopGroup ç›¸å½“äºä¸€ä¸ªäº‹ä»¶å¾ªç¯ç»„, è¿™ä¸ªç»„ä¸­å«æœ‰å¤šä¸ªäº‹ä»¶å¾ªç¯ ï¼Œæ¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯æ˜¯ NioEventLoop 4ï¼šNioEventLoop è¡¨ç¤ºä¸€ä¸ªä¸æ–­å¾ªç¯çš„æ‰§è¡Œå¤„ç†ä»»åŠ¡çš„çº¿ç¨‹ï¼Œ æ¯ä¸ª NioEventLoop éƒ½æœ‰ä¸€ä¸ª Selector , ç”¨äºç›‘å¬ç»‘å®šåœ¨å…¶ä¸Šçš„ Socket çš„ç½‘ç»œé€šè®¯ 5:NioEventLoopGroup(BossGroupã€WorkerGroup) å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹, å³å¯ä»¥å«æœ‰å¤šä¸ª NioEventLoop 6:æ¯ä¸ªBoss çš„ NioEventLoop å¾ªç¯æ‰§è¡Œçš„æ­¥éª¤æœ‰3æ­¥ (1):è½®è¯¢accept äº‹ä»¶ (2):å¤„ç†accept äº‹ä»¶ , ä¸clientå»ºç«‹è¿æ¥ , ç”ŸæˆNioScocketChannel , å¹¶å°†å…¶æ³¨å†Œåˆ° Worker çš„ (3):NIOEventLoop ä¸Šçš„ Selector å¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ ï¼Œ å³ runAllTasks 7ï¼šæ¯ä¸ª Worker çš„ NIOEventLoop å¾ªç¯æ‰§è¡Œçš„æ­¥éª¤ (1):è½®è¯¢read, write äº‹ä»¶ (2):å¤„ç†i/oäº‹ä»¶ï¼Œ å³read , write äº‹ä»¶ï¼Œåœ¨å¯¹åº”NioScocketChannel å¤„ç† (3):å¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ ï¼Œ å³ runAllTasks æ¯ä¸ªWorker NIOEventLoop å¤„ç†ä¸šåŠ¡æ—¶ï¼Œä¼šä½¿ç”¨ Pipeline(ç®¡é“), Pipeline ä¸­åŒ…å«äº† Channel , å³é€šè¿‡ Pipeline å¯ä»¥è·å–åˆ°å¯¹åº”é€šé“, ç®¡é“ä¸­ç»´æŠ¤äº†å¾ˆå¤šçš„å¤„ç†å™¨ã€‚ç®¡é“å¯ä»¥ä½¿ç”¨ Netty æä¾›çš„ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰ 4. ç†è§£é‡åˆ¶ç‰ˆ æœåŠ¡å™¨ç«¯é¦–å…ˆåˆ›å»ºä¸€ä¸ªServerSocketChannelï¼ŒbossGroupåªå¤„ç†å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚,workGroupå¤„ç†è¯»å†™äº‹ä»¶ï¼Œæ­¤äºŒè€…ä¸ºçº¿ç¨‹ç»„ï¼Œå…¶ä¸­æ¯ä¸€ä¸ªNIOEventLoopéƒ½æ˜¯çº¿ç¨‹ç»„å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹ å®¢æˆ·ç«¯å‘é€è¿æ¥è¯·æ±‚é€šè¿‡ServerSocketChannelè¢«NIOLoopEventGroupçº¿ç¨‹ç»„ä¸­çš„ä¸€ä¸ªçº¿ç¨‹NIOLoopEventçš„selectoré€‰æ‹©å™¨ç›‘å¬ï¼Œå¹¶å°†äº‹ä»¶æ”¾å…¥taskqueueé˜Ÿåˆ—è¿›è¡Œè½®è¯¢ï¼Œä¸€æ—¦æœ‰acceptäº‹ä»¶å°±ä¼šå°è£…NIOSocketChannelå¯¹è±¡ï¼Œå¹¶é€šè¿‡å…¶å»æ³¨å†Œåˆ°workGroupçš„çº¿ç¨‹çš„selectorä¸­è®©å…¶ç›‘å¬ ä¸€æ—¦workGroupçš„çº¿ç¨‹çš„taskqueueè½®è¯¢åˆ°è¯»å†™äº‹ä»¶ï¼Œåœ¨å¯¹åº”çš„NIOSocketChannelè¿›è¡Œå¤„ç† 4. Nettyå®ä¾‹åˆ†æ 1. BossGroup å’Œ WorkGroup æ€ä¹ˆç¡®å®šè‡ªå·±æœ‰å¤šå°‘ä¸ª NIOEventLoop BossGroup å’Œ WorkerGroup å«æœ‰çš„å­çº¿ç¨‹æ•°ï¼ˆNioEventLoopï¼‰é»˜è®¤ä¸º CPU æ ¸æ•°*2 ç”±æºç ä¸­çš„æ„é€ æ–¹æ³•å¯çŸ¥ â€”â€” æƒ³è¦è®¾ç½®çº¿ç¨‹æ•°åªè¦åœ¨å‚æ•°ä¸­è¾“å…¥å³å¯ 2. WorkerGroup æ˜¯å¦‚ä½•åˆ†é…è¿™äº›è¿›ç¨‹çš„ è®¾ç½® BossGroup è¿›ç¨‹æ•°ä¸º 1 ï¼› WorkerGroup è¿›ç¨‹æ•°ä¸º 4 ï¼› Client æ•°ä½ 8 åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒWorkerGroup åˆ†é…çš„é€»è¾‘å°±æ˜¯æŒ‰é¡ºåºå¾ªç¯åˆ†é…çš„ 3. BossGroup å’Œ WorkerGroup ä¸­çš„ Selector å’Œ TaskQueue æ‰“æ–­ç‚¹è¿›è¡Œ Debug æ¯ä¸ªå­çº¿ç¨‹éƒ½å…·æœ‰è‡ªå·±çš„ Selectorã€TaskQueueâ€¦â€¦ 4. CTX ä¸Šä¸‹æ–‡ã€Channelã€Pipeline ä¹‹é—´å…³ç³» ä¿®æ”¹ NettyServerHandler ï¼Œå¹¶æ·»åŠ ç«¯ç‚¹ å…ˆçœ‹ CTX ä¸Šä¸‹æ–‡ä¸­çš„ä¿¡æ¯ Pipeline Channel CTX ä¸Šä¸‹æ–‡ã€Channelã€Pipeline ä¸‰è€…å…³ç³»ç¤ºæ„å›¾ 5. è®¾ç½®é€šé“å‚æ•° childOption() æ–¹æ³• ç»™æ¯æ¡child channel è¿æ¥è®¾ç½®ä¸€äº›TCPåº•å±‚ç›¸å…³çš„å±æ€§ï¼Œæ¯”å¦‚ä¸Šé¢ï¼Œæˆ‘ä»¬è®¾ç½®äº†ä¸¤ç§TCPå±æ€§ï¼Œå…¶ä¸­ ChannelOption.SO_KEEPALIVEè¡¨ç¤ºæ˜¯å¦å¼€å¯TCPåº•å±‚å¿ƒè·³æœºåˆ¶ï¼Œtrueä¸ºå¼€ option() æ–¹æ³• å¯¹äºserver bootstrapè€Œè¨€ï¼Œè¿™ä¸ªæ–¹æ³•ï¼Œæ˜¯ç»™parent channel è¿æ¥è®¾ç½®ä¸€äº›TCPåº•å±‚ç›¸å…³çš„å±æ€§ã€‚ TCPè¿æ¥çš„å‚æ•°è¯¦ç»†ä»‹ç»å¦‚ä¸‹ã€‚SO_RCVBUF ï¼ŒSO_SNDBUF è¿™ä¸¤ä¸ªé€‰é¡¹å°±æ˜¯æ¥è®¾ç½®TCPè¿æ¥çš„ä¸¤ä¸ªbufferå°ºå¯¸çš„ã€‚ æ¯ä¸ªTCP socketåœ¨å†…æ ¸ä¸­éƒ½æœ‰ä¸€ä¸ªå‘é€ç¼“å†²åŒºå’Œä¸€ä¸ªæ¥æ”¶ç¼“å†²åŒºï¼ŒTCPçš„å…¨åŒå·¥çš„å·¥ä½œæ¨¡å¼ä»¥åŠTCPçš„æ»‘åŠ¨çª—å£ä¾¿æ˜¯ä¾èµ–äºè¿™ä¸¤ä¸ªç‹¬ç«‹çš„bufferä»¥åŠæ­¤bufferçš„å¡«å……çŠ¶æ€ã€‚ SO_SNDBUF Socketå‚æ•°ï¼ŒTCPæ•°æ®å‘é€ç¼“å†²åŒºå¤§å°ã€‚è¯¥ç¼“å†²åŒºå³TCPå‘é€æ»‘åŠ¨çª—å£ï¼Œlinuxæ“ä½œç³»ç»Ÿå¯ä½¿ç”¨å‘½ä»¤ï¼šcat /proc/sys/net/ipv4/tcp_smem æŸ¥è¯¢å…¶å¤§å°ã€‚ TCP_NODELAY TCPå‚æ•°ï¼Œç«‹å³å‘é€æ•°æ®ï¼Œé»˜è®¤å€¼ä¸ºTureï¼ˆNettyé»˜è®¤ä¸ºTrueè€Œæ“ä½œç³»ç»Ÿé»˜è®¤ä¸ºFalseï¼‰ã€‚è¯¥å€¼è®¾ç½®Nagleç®—æ³•çš„å¯ç”¨ï¼Œæ”¹ç®—æ³•å°†å°çš„ç¢ç‰‡æ•°æ®è¿æ¥æˆæ›´å¤§çš„æŠ¥æ–‡æ¥æœ€å°åŒ–æ‰€å‘é€çš„æŠ¥æ–‡çš„æ•°é‡ï¼Œå¦‚æœéœ€è¦å‘é€ä¸€äº›è¾ƒå°çš„æŠ¥æ–‡ï¼Œåˆ™éœ€è¦ç¦ç”¨è¯¥ç®—æ³•ã€‚Nettyé»˜è®¤ç¦ç”¨è¯¥ç®—æ³•ï¼Œä»è€Œæœ€å°åŒ–æŠ¥æ–‡ä¼ è¾“å»¶æ—¶ã€‚ è¿™ä¸ªå‚æ•°ï¼Œä¸æ˜¯å¦å¼€å¯Nagleç®—æ³•æ˜¯åç€æ¥çš„ï¼Œtrueè¡¨ç¤ºå…³é—­ï¼Œfalseè¡¨ç¤ºå¼€å¯ã€‚é€šä¿—åœ°è¯´ï¼Œå¦‚æœè¦æ±‚é«˜å®æ—¶æ€§ï¼Œæœ‰æ•°æ®å‘é€æ—¶å°±é©¬ä¸Šå‘é€ï¼Œå°±å…³é—­ï¼Œå¦‚æœéœ€è¦å‡å°‘å‘é€æ¬¡æ•°å‡å°‘ç½‘ç»œäº¤äº’ï¼Œå°±å¼€å¯ã€‚ SO_KEEPALIVE åº•å±‚TCPåè®®çš„å¿ƒè·³æœºåˆ¶ã€‚Socketå‚æ•°ï¼Œè¿æ¥ä¿æ´»ï¼Œé»˜è®¤å€¼ä¸ºFalseã€‚å¯ç”¨è¯¥åŠŸèƒ½æ—¶ï¼ŒTCPä¼šä¸»åŠ¨æ¢æµ‹ç©ºé—²è¿æ¥çš„æœ‰æ•ˆæ€§ã€‚å¯ä»¥å°†æ­¤åŠŸèƒ½è§†ä¸ºTCPçš„å¿ƒè·³æœºåˆ¶ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼šé»˜è®¤çš„å¿ƒè·³é—´éš”æ˜¯7200så³2å°æ—¶ã€‚Nettyé»˜è®¤å…³é—­è¯¥åŠŸèƒ½ã€‚ SO_REUSEADDR Socketå‚æ•°ï¼Œåœ°å€å¤ç”¨ï¼Œé»˜è®¤å€¼Falseã€‚æœ‰å››ç§æƒ…å†µå¯ä»¥ä½¿ç”¨ï¼š (1).å½“æœ‰ä¸€ä¸ªæœ‰ç›¸åŒæœ¬åœ°åœ°å€å’Œç«¯å£çš„socket1å¤„äºTIME_WAITçŠ¶æ€æ—¶ï¼Œè€Œä½ å¸Œæœ›å¯åŠ¨çš„ç¨‹åºçš„socket2è¦å ç”¨è¯¥åœ°å€å’Œç«¯å£ï¼Œæ¯”å¦‚é‡å¯æœåŠ¡ä¸”ä¿æŒå…ˆå‰ç«¯å£ã€‚ (2).æœ‰å¤šå—ç½‘å¡æˆ–ç”¨IP AliasæŠ€æœ¯çš„æœºå™¨åœ¨åŒä¸€ç«¯å£å¯åŠ¨å¤šä¸ªè¿›ç¨‹ï¼Œä½†æ¯ä¸ªè¿›ç¨‹ç»‘å®šçš„æœ¬åœ°IPåœ°å€ä¸èƒ½ç›¸åŒã€‚ (3).å•ä¸ªè¿›ç¨‹ç»‘å®šç›¸åŒçš„ç«¯å£åˆ°å¤šä¸ªsocketä¸Šï¼Œä½†æ¯ä¸ªsocketç»‘å®šçš„ipåœ°å€ä¸åŒã€‚(4).å®Œå…¨ç›¸åŒçš„åœ°å€å’Œç«¯å£çš„é‡å¤ç»‘å®šã€‚ä½†è¿™åªç”¨äºUDPçš„å¤šæ’­ï¼Œä¸ç”¨äºTCPã€‚ SO_LINGER Socketå‚æ•°ï¼Œå…³é—­Socketçš„å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤å€¼ä¸º-1ï¼Œè¡¨ç¤ºç¦ç”¨è¯¥åŠŸèƒ½ã€‚-1è¡¨ç¤ºsocket.close()æ–¹æ³•ç«‹å³è¿”å›ï¼Œä½†OSåº•å±‚ä¼šå°†å‘é€ç¼“å†²åŒºå…¨éƒ¨å‘é€åˆ°å¯¹ç«¯ã€‚0è¡¨ç¤ºsocket.close()æ–¹æ³•ç«‹å³è¿”å›ï¼ŒOSæ”¾å¼ƒå‘é€ç¼“å†²åŒºçš„æ•°æ®ç›´æ¥å‘å¯¹ç«¯å‘é€RSTåŒ…ï¼Œå¯¹ç«¯æ”¶åˆ°å¤ä½é”™è¯¯ã€‚é0æ•´æ•°å€¼è¡¨ç¤ºè°ƒç”¨socket.close()æ–¹æ³•çš„çº¿ç¨‹è¢«é˜»å¡ç›´åˆ°å»¶è¿Ÿæ—¶é—´åˆ°æˆ–å‘é€ç¼“å†²åŒºä¸­çš„æ•°æ®å‘é€å®Œæ¯•ï¼Œè‹¥è¶…æ—¶ï¼Œåˆ™å¯¹ç«¯ä¼šæ”¶åˆ°å¤ä½é”™è¯¯ã€‚ SO_BACKLOG Socketå‚æ•°ï¼ŒæœåŠ¡ç«¯æ¥å—è¿æ¥çš„é˜Ÿåˆ—é•¿åº¦ï¼Œå¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œå®¢æˆ·ç«¯è¿æ¥å°†è¢«æ‹’ç»ã€‚é»˜è®¤å€¼ï¼ŒWindowsä¸º200ï¼Œå…¶ä»–ä¸º128ã€‚ b.option(ChannelOption.SO_BACKLOG, 1024) è¡¨ç¤ºç³»ç»Ÿç”¨äºä¸´æ—¶å­˜æ”¾å·²å®Œæˆä¸‰æ¬¡æ¡æ‰‹çš„è¯·æ±‚çš„é˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ï¼Œå¦‚æœè¿æ¥å»ºç«‹é¢‘ç¹ï¼ŒæœåŠ¡å™¨å¤„ç†åˆ›å»ºæ–°è¿æ¥è¾ƒæ…¢ï¼Œå¯ä»¥é€‚å½“è°ƒå¤§è¿™ä¸ªå‚æ•°. SO_BROADCAST Socketå‚æ•°ï¼Œè®¾ç½®å¹¿æ’­æ¨¡å¼ã€‚ 5. TaskQueue ä»»åŠ¡é˜Ÿåˆ— ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ Task æœ‰ 3 ç§å…¸å‹ä½¿ç”¨åœºæ™¯ ç”¨æˆ·ç¨‹åºè‡ªå®šä¹‰çš„æ™®é€šä»»åŠ¡ ç”¨æˆ·è‡ªå®šä¹‰å®šæ—¶ä»»åŠ¡ éå½“å‰ Reactor çº¿ç¨‹è°ƒç”¨ Channel çš„å„ç§æ–¹æ³• 6. å¼‚æ­¥æ¨¡å‹ 1. å·¥ä½œç¤ºæ„å›¾ è¯´æ˜ 1:åœ¨ä½¿ç”¨ Netty è¿›è¡Œç¼–ç¨‹æ—¶ï¼Œæ‹¦æˆªæ“ä½œå’Œè½¬æ¢å‡ºå…¥ç«™æ•°æ®åªéœ€è¦æ‚¨æä¾› callback æˆ–åˆ©ç”¨ future å³å¯ã€‚è¿™ä½¿å¾—é“¾å¼æ“ä½œç®€å•ã€é«˜æ•ˆ, å¹¶æœ‰åˆ©äºç¼–å†™å¯é‡ç”¨çš„ã€é€šç”¨çš„ä»£ç ã€‚ 2:Netty æ¡†æ¶çš„ç›®æ ‡å°±æ˜¯è®©ä½ çš„ä¸šåŠ¡é€»è¾‘ä»ç½‘ç»œåŸºç¡€åº”ç”¨ç¼–ç ä¸­åˆ†ç¦»å‡ºæ¥ 2. Future-Listener æœºåˆ¶ å½“ Future å¯¹è±¡åˆšåˆšåˆ›å»ºæ—¶ï¼Œå¤„äºéå®ŒæˆçŠ¶æ€ï¼Œè°ƒç”¨è€…å¯ä»¥é€šè¿‡è¿”å›çš„ ChannelFuture æ¥è·å–æ“ä½œæ‰§è¡Œçš„çŠ¶æ€ï¼Œæ³¨å†Œç›‘å¬å‡½æ•°æ¥æ‰§è¡Œå®Œæˆåçš„æ“ä½œã€‚ å¸¸è§æœ‰å¦‚ä¸‹æ“ä½œ â€¢ é€šè¿‡ isDone æ–¹æ³•æ¥åˆ¤æ–­å½“å‰æ“ä½œæ˜¯å¦å®Œæˆï¼› â€¢ é€šè¿‡ isSuccess æ–¹æ³•æ¥åˆ¤æ–­å·²å®Œæˆçš„å½“å‰æ“ä½œæ˜¯å¦æˆåŠŸï¼› â€¢ é€šè¿‡ getCause æ–¹æ³•æ¥è·å–å·²å®Œæˆçš„å½“å‰æ“ä½œå¤±è´¥çš„åŸå› ï¼› â€¢ é€šè¿‡ isCancelled æ–¹æ³•æ¥åˆ¤æ–­å·²å®Œæˆçš„å½“å‰æ“ä½œæ˜¯å¦è¢«å–æ¶ˆï¼› â€¢ é€šè¿‡ addListener æ–¹æ³•æ¥æ³¨å†Œç›‘å¬å™¨ï¼Œå½“æ“ä½œå·²å®Œæˆ(isDone æ–¹æ³•è¿”å›å®Œæˆ)ï¼Œå°†ä¼šé€šçŸ¥ æŒ‡å®šçš„ç›‘å¬å™¨ï¼›å¦‚æœ Future å¯¹è±¡å·²å®Œæˆï¼Œåˆ™é€šçŸ¥æŒ‡å®šçš„ç›‘å¬å™¨ ä»£ç ç¤ºä¾‹ ç»™ä¸€ä¸ª ChannelFuture æ³¨å†Œç›‘å¬å™¨ï¼Œæ¥ç›‘æ§æˆ‘ä»¬å…³ç³»çš„äº‹ä»¶ channelFuture.addListener(new ChannelFutureListener() { @Override public void operationComplete(ChannelFuture channelFuture) throws Exception { if (channelFuture.isSuccess()){ System.out.println(&quot;ç›‘å¬ç«¯å£ 6668 æˆåŠŸ&quot;); }else { System.out.println(&quot;ç›‘å¬ç«¯å£ 6668 å¤±è´¥&quot;); } } }); 3. å¿«é€Ÿå…¥é—¨å®ä¾‹-HTTPæœåŠ¡ Netty å¯ä»¥åšHttpæœåŠ¡å¼€å‘ï¼Œå¹¶ä¸”ç†è§£Handlerå®ä¾‹ å’Œå®¢æˆ·ç«¯åŠå…¶è¯·æ±‚çš„å…³ç³» ç¼–å†™ä»£ç  â€”â€” æœåŠ¡ç«¯ä»£ç  # ç¼–å†™æœåŠ¡ç«¯ï¼š HttpServer public static void main(String[] args) throws Exception { //åˆ›å»ºBossGroup ,workGroup EventLoopGroup bossGroup = new NioEventLoopGroup(); EventLoopGroup workGroup = new NioEventLoopGroup(); try { ServerBootstrap serverBootstrap = new ServerBootstrap(); serverBootstrap.group(bossGroup,workGroup) .channel(NioServerSocketChannel.class) .childHandler(new TestServerInitializer()); ChannelFuture channelFuture = serverBootstrap.bind(8080).sync(); channelFuture.channel().closeFuture().sync(); } finally { bossGroup.shutdownGracefully(); workGroup.shutdownGracefully(); } } ç¼–å†™ æœåŠ¡åˆå§‹åŒ–å™¨ ï¼šHttpServerInitialize public class TestServerInitializer extends ChannelInitializer&lt;SocketChannel&gt; { @Override protected void initChannel(SocketChannel socketChannel) throws Exception { //å‘ç®¡é“åŠ å…¥å¤„ç†å™¨ ChannelPipeline pipeline = socketChannel.pipeline(); //åŠ å…¥nettyæä¾›çš„httpServerCodec,nettyæä¾›çš„å¤„ç†Httpçš„ç¼–-è§£ç å™¨ pipeline.addLast(&quot;MyHttpServerCodec&quot;,new HttpServerCodec()); pipeline.addLast(&quot;MyTestHttpServerHandler&quot;,new TestHttpServerHandler()); } } ç¼–å†™ æœåŠ¡å¤„ç†å™¨ ï¼šHttpServerHandler /** * * 1. SimpleChannelInboundHandler æ˜¯ä¹‹å‰ä½¿ç”¨çš„ ChannelInboundHandlerAdapter çš„å­ç±» * 2. HttpObject è¿™ä¸ªç±»å‹è¡¨ç¤ºï¼Œ å®¢æˆ·ç«¯ã€æœåŠ¡ç«¯ ç›¸äº’é€šä¿¡çš„æ•°æ®éœ€è¦è¢«å°è£…æˆä»€ä¹ˆç±»å‹ * */ public class TestHttpServerHandler extends SimpleChannelInboundHandler&lt;HttpObject&gt; { /** * è¯»å–å®¢æˆ·ç«¯æ•°æ® * @param ctx * @param msg * @throws Exception */ @Override protected void channelRead0(ChannelHandlerContext ctx, HttpObject msg) throws Exception { //åˆ¤æ–­msg æ˜¯ä¸æ˜¯HttpRequest è¯·æ±‚ if(msg instanceof HttpRequest){ System.out.println(&quot;msg ç±»å‹ = &quot;+msg.getClass()); System.out.println(&quot;å®¢æˆ·ç«¯åœ°å€&quot;+ctx.channel().remoteAddress()); // è·å–è¯·æ±‚çš„ URI HttpRequest httpRequest = (HttpRequest) msg; URI uri = new URI(httpRequest.uri()); // åˆ¤æ–­è¯·æ±‚è·¯å¾„ä¸º /favicon.icoï¼Œå°±ä¸åšå¤„ç† if (&quot;/favicon.ico&quot;.equals(uri.getPath())){ System.out.println(&quot;è¯·æ±‚äº† å›¾æ ‡ èµ„æºï¼Œä¸åšå“åº”&quot;); return; } //å›å¤ä¿¡æ¯ç»™æµè§ˆå™¨ã€HTTPåè®®ã€‘ ByteBuf content = Unpooled.copiedBuffer(&quot;Hello I am server&quot;, CharsetUtil.UTF_8); //æ„é€ ä¸€ä¸ªhttpå›åº”ï¼Œå³httpResponse,HttpResponseStatus:çŠ¶æ€ç  FullHttpResponse response = new DefaultFullHttpResponse(HttpVersion.HTTP_1_1, HttpResponseStatus.OK,content); response.headers().set(HttpHeaderNames.CONTENT_TYPE,&quot;text/plain&quot;); response.headers().set(HttpHeaderNames.CONTENT_LENGTH,content.readableBytes()); //å°†æ„å»ºå¥½çš„responseè¿”å› ctx.writeAndFlush(response); } } ç¼–å†™ä»£ç  â€”â€” å¯¹ç‰¹å®šèµ„æºçš„è¿‡æ»¤ ä¸Šé¢çš„æœåŠ¡ç«¯å¯åŠ¨åï¼Œåœ¨é¡µé¢ä¸Šä¸æ­¢æ¥æ”¶åˆ°äº†æ–‡æœ¬ï¼Œè¿˜æ¥æ”¶åˆ°äº†ä¸€ä¸ªç½‘é¡µçš„å›¾æ ‡ ç°åœ¨æŠŠå®ƒè¿‡æ»¤æ‰ // ä¿®æ”¹ HttpServerHandler // è·å–è¯·æ±‚çš„ URI HttpRequest httpRequest = (HttpRequest) msg; URI uri = new URI(httpRequest.uri()); // åˆ¤æ–­è¯·æ±‚è·¯å¾„ä¸º /favicon.icoï¼Œå°±ä¸åšå¤„ç† if (&quot;/favicon.ico&quot;.equals(uri.getPath())){ System.out.println(&quot;è¯·æ±‚äº† å›¾æ ‡ èµ„æºï¼Œä¸åšå“åº”&quot;); return; } 7. nettyæ ¸å¿ƒç»„ä»¶ 1. Bootstrap å’Œ ServerBootstrap Bootstrap æ„æ€æ˜¯å¼•å¯¼ï¼Œä¸€ä¸ª Netty åº”ç”¨é€šå¸¸ç”±ä¸€ä¸ª Bootstrap å¼€å§‹ï¼Œä¸»è¦ä½œç”¨æ˜¯é…ç½®æ•´ä¸ª Netty ç¨‹åºï¼Œä¸²è”å„ä¸ªç»„ä»¶ï¼ŒNetty ä¸­ Bootstrapç±»æ˜¯å®¢æˆ·ç«¯ç¨‹åºçš„å¯åŠ¨å¼•å¯¼ç±»ï¼Œ ServerBootstrapæ˜¯æœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼ç±» å¸¸è§çš„æ–¹æ³•æœ‰ â€¢ public ServerBootstrap group(EventLoopGroup parentGroup, EventLoopGroup childGroup)ï¼Œè¯¥æ–¹æ³•ç”¨äºæœåŠ¡å™¨ç«¯ï¼Œç”¨æ¥è®¾ç½®ä¸¤ä¸ª EventLoop â€¢ public B channel(Class&lt;? extends C&gt; channelClass)ï¼Œè¯¥æ–¹æ³•ç”¨æ¥è®¾ç½®ä¸€ä¸ªæœåŠ¡å™¨ç«¯çš„é€šé“å®ç° â€¢ public ChannelFuture bind(int inetPort) ï¼Œè¯¥æ–¹æ³•ç”¨äºæœåŠ¡å™¨ç«¯ï¼Œç”¨æ¥è®¾ç½®å ç”¨çš„ç«¯å£å· â€¢ public B option(ChannelOption option, T value)ï¼Œç”¨æ¥ç»™ ServerChannel æ·»åŠ é…ç½® â€¢ public B group(EventLoopGroup group) ï¼Œè¯¥æ–¹æ³•ç”¨äºå®¢æˆ·ç«¯ï¼Œç”¨æ¥è®¾ç½®ä¸€ä¸ª EventLoop â€¢ public ChannelFuture connect(String inetHost, int inetPort) ï¼Œè¯¥æ–¹æ³•ç”¨äºå®¢æˆ·ç«¯ï¼Œç”¨æ¥è¿æ¥æœåŠ¡å™¨ ç«¯ â€¢ public ServerBootstrap childOption(ChannelOption childOption, T value)ï¼Œç”¨æ¥ç»™æ¥æ”¶åˆ°çš„é€šé“æ·»åŠ é…ç½® â€¢ public ServerBootstrap childHandler(ChannelHandler childHandler)ï¼Œè¯¥æ–¹æ³•ç”¨æ¥è®¾ç½®ä¸šåŠ¡å¤„ç†ç±» ï¼ˆè‡ªå®šä¹‰çš„ handlerï¼‰ .childHandler(new TestServerInitializer())//å¯¹åº”workGroup .handler(null)//å¯¹åº”bossGroup 2. Future å’Œ ChannelFuture Netty ä¸­æ‰€æœ‰çš„ IO æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä¸èƒ½ç«‹åˆ»å¾—çŸ¥æ¶ˆæ¯æ˜¯å¦è¢«æ­£ç¡®å¤„ç†ã€‚ä½†æ˜¯å¯ä»¥è¿‡ä¸€ä¼šç­‰å®ƒæ‰§è¡Œå®Œæˆæˆ–è€…ç›´æ¥æ³¨å†Œä¸€ä¸ªç›‘å¬ï¼Œå…·ä½“çš„å®ç°å°±æ˜¯é€šè¿‡ Future å’Œ ChannelFuturesï¼Œä»–ä»¬å¯ä»¥æ³¨å†Œä¸€ä¸ªç›‘å¬ï¼Œå½“æ“ä½œæ‰§è¡ŒæˆåŠŸæˆ–å¤±è´¥æ—¶ç›‘å¬ä¼šè‡ªåŠ¨è§¦å‘æ³¨å†Œçš„ç›‘å¬äº‹ä»¶ å¸¸è§çš„æ–¹æ³•æœ‰ â€¢ Channel channel()ï¼Œè¿”å›å½“å‰æ­£åœ¨è¿›è¡Œ IO æ“ä½œçš„é€šé“ â€¢ ChannelFuture sync()ï¼Œç­‰å¾…å¼‚æ­¥æ“ä½œæ‰§è¡Œå®Œæ¯• 3. Channel Netty ç½‘ç»œé€šä¿¡çš„ç»„ä»¶ï¼Œèƒ½å¤Ÿç”¨äºæ‰§è¡Œç½‘ç»œ I/O æ“ä½œã€‚ é€šè¿‡Channel å¯è·å¾—å½“å‰ç½‘ç»œè¿æ¥çš„é€šé“çš„çŠ¶æ€ é€šè¿‡Channel å¯è·å¾—ç½‘ç»œè¿æ¥çš„é…ç½®å‚æ•° ï¼ˆä¾‹å¦‚æ¥æ”¶ç¼“å†²åŒºå¤§å°ï¼‰ Channel æä¾›å¼‚æ­¥çš„ç½‘ç»œ I/O æ“ä½œ(å¦‚å»ºç«‹è¿æ¥ï¼Œè¯»å†™ï¼Œç»‘å®šç«¯å£)ï¼Œå¼‚æ­¥è°ƒç”¨æ„å‘³ç€ä»»ä½• I/O è°ƒç”¨éƒ½å°†ç«‹å³è¿”å›ï¼Œå¹¶ä¸”ä¸ä¿è¯åœ¨è°ƒç”¨ç»“æŸæ—¶æ‰€è¯·æ±‚çš„ I/O æ“ä½œå·²å®Œæˆ è°ƒç”¨ç«‹å³è¿”å›ä¸€ä¸ª ChannelFuture å®ä¾‹ï¼Œé€šè¿‡æ³¨å†Œç›‘å¬å™¨åˆ° ChannelFuture ä¸Šï¼Œå¯ä»¥ I/O æ“ä½œæˆåŠŸã€å¤±è´¥æˆ–å–æ¶ˆæ—¶å›è°ƒé€šçŸ¥è°ƒç”¨æ–¹ æ”¯æŒå…³è” I/O æ“ä½œä¸å¯¹åº”çš„å¤„ç†ç¨‹åº ä¸åŒåè®®ã€ä¸åŒçš„é˜»å¡ç±»å‹çš„è¿æ¥éƒ½æœ‰ä¸åŒçš„ Channel ç±»å‹ä¸ä¹‹å¯¹åº” å¸¸ç”¨çš„ Channel ç±»å‹ â€¢ NioSocketChannelï¼Œå¼‚æ­¥çš„å®¢æˆ·ç«¯ TCP Socket è¿æ¥ã€‚ â€¢ NioServerSocketChannelï¼Œå¼‚æ­¥çš„æœåŠ¡å™¨ç«¯ TCP Socket è¿æ¥ã€‚ â€¢ NioDatagramChannelï¼Œå¼‚æ­¥çš„ UDP è¿æ¥ã€‚ â€¢ NioSctpChannelï¼Œå¼‚æ­¥çš„å®¢æˆ·ç«¯ Sctp è¿æ¥ã€‚ â€¢ NioSctpServerChannelï¼Œå¼‚æ­¥çš„ Sctp æœåŠ¡å™¨ç«¯è¿æ¥ï¼Œè¿™äº›é€šé“æ¶µç›–äº† UDP å’Œ TCP ç½‘ç»œ IO ä»¥åŠæ–‡ä»¶ IOã€‚ 4. Selector Netty åŸºäº Selector å¯¹è±¡å®ç° I/O å¤šè·¯å¤ç”¨ï¼Œé€šè¿‡ Selector ä¸€ä¸ªçº¿ç¨‹å¯ä»¥ç›‘å¬å¤šä¸ªè¿æ¥çš„ Channel äº‹ä»¶ã€‚ å½“å‘ä¸€ä¸ª Selector ä¸­æ³¨å†Œ Channel åï¼ŒSelector å†…éƒ¨çš„æœºåˆ¶å°±å¯ä»¥è‡ªåŠ¨ä¸æ–­åœ°æŸ¥è¯¢ (Select) è¿™äº›æ³¨å†Œçš„ Channel æ˜¯å¦æœ‰å·²å°±ç»ªçš„ I/O äº‹ä»¶ï¼ˆä¾‹å¦‚å¯è¯»ï¼Œå¯å†™ï¼Œç½‘ç»œè¿æ¥ å®Œæˆç­‰ï¼‰ï¼Œè¿™æ ·ç¨‹åºå°±å¯ä»¥å¾ˆç®€å•åœ°ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹é«˜æ•ˆåœ°ç®¡ç†å¤šä¸ª Channel 5. ChannelHandler æˆ‘ä»¬ç»å¸¸éœ€è¦è‡ªå®šä¹‰ä¸€ ä¸ª Handler ç±»å»ç»§æ‰¿ ChannelInboundHandlerA dapterï¼Œç„¶åé€šè¿‡é‡å†™ç›¸åº”æ–¹æ³•å®ç°ä¸šåŠ¡é€»è¾‘ å¸¸ç”¨çš„æ–¹æ³• public class ChannelInboundHandlerAdapter extends ChannelHandlerAdapter implements ChannelInboundHandler { // é€šé“æ³¨å†Œäº‹ä»¶ public void channelRegistered(ChannelHandlerContext ctx) throws Exception { ctx.fireChannelRegistered(); } // é€šé“æ³¨é”€äº‹ä»¶ public void channelUnregistered(ChannelHandlerContext ctx) throws Exception { ctx.fireChannelUnregistered(); } // é€šé“å°±ç»ªäº‹ä»¶ public void channelActive(ChannelHandlerContext ctx) throws Exception { ctx.fireChannelActive(); } // é€šé“è¯»å–æ•°æ®äº‹ä»¶ public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception { ctx.fireChannelRead(msg); } // é€šé“è¯»å–æ•°æ®å®Œæ¯•äº‹ä»¶ public void channelReadComplete(ChannelHandlerContext ctx) throws Exception { ctx.fireChannelReadComplete(); } // é€šé“å‘ç”Ÿå¼‚å¸¸äº‹ä»¶ public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception { ctx.fireExceptionCaught(cause); } } 6. Pipeline å’Œ ChannelPipeline ChannelPipeline æ˜¯ä¸€ä¸ª Handler çš„é›†åˆï¼Œå®ƒè´Ÿè´£å¤„ç†å’Œæ‹¦æˆª inboundï¼ˆå…¥æ ˆï¼‰ æˆ–è€… outboundï¼ˆå‡ºæ ˆï¼‰ çš„äº‹ä»¶å’Œæ“ä½œï¼Œç›¸å½“äºä¸€ä¸ªè´¯ç©¿ Netty çš„é“¾ã€‚(ä¹Ÿå¯ä»¥è¿™æ ·ç†è§£ï¼š ChannelPipeline æ˜¯ ä¿å­˜ ChannelHandler çš„ Listï¼Œç”¨äºå¤„ç†æˆ–æ‹¦æˆª Channel çš„å…¥ç«™ å’Œå‡ºç«™ äº‹ä»¶ / æ“ä½œ) ChannelPipeline å®ç°äº†ä¸€ç§é«˜çº§å½¢å¼çš„æ‹¦æˆªè¿‡æ»¤å™¨æ¨¡å¼ï¼Œä½¿ç”¨æˆ·å¯ä»¥å®Œå…¨æ§åˆ¶äº‹ä»¶çš„å¤„ç†æ–¹å¼ï¼Œä»¥åŠ Channel ä¸­å„ä¸ªçš„ ChannelHandler å¦‚ä½•ç›¸äº’äº¤äº’ åœ¨ Netty ä¸­æ¯ä¸ª Channel éƒ½æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª ChannelPipeline ä¸ä¹‹å¯¹åº”ï¼Œå®ƒä»¬çš„ç»„æˆå…³ç³»å¦‚ä¸‹ è¯´æ˜ ï¼š â€¢ ä¸€ä¸ª Channel åŒ…å«äº†ä¸€ä¸ª ChannelPipelineï¼Œè€Œ ChannelPipeline ä¸­åˆç»´æŠ¤äº†ä¸€ä¸ªç”± ChannelHandlerContext ç»„æˆçš„åŒå‘é“¾è¡¨ï¼Œå¹¶ä¸”æ¯ä¸ª ChannelHandlerContext ä¸­åˆå…³è”ç€ä¸€ä¸ª ChannelHandler â€¢ å…¥ç«™äº‹ä»¶å’Œå‡ºç«™äº‹ä»¶åœ¨ä¸€ä¸ªåŒå‘é“¾è¡¨ä¸­ï¼Œå…¥ç«™äº‹ä»¶ä¼šä»é“¾è¡¨ head å¾€åä¼ é€’åˆ°æœ€åä¸€ä¸ªå…¥ç«™çš„ handlerï¼Œ å‡ºç«™äº‹ä»¶ä¼šä»é“¾è¡¨ tail å¾€å‰ä¼ é€’åˆ°æœ€å‰ä¸€ä¸ªå‡ºç«™çš„ handlerï¼Œä¸¤ç§ç±»å‹çš„ handler äº’ä¸å¹²æ‰° å¸¸ç”¨æ–¹æ³• //æŠŠä¸€ä¸ªä¸šåŠ¡å¤„ç†ç±»ï¼ˆhandlerï¼‰ æ·»åŠ åˆ°é“¾ä¸­çš„ç¬¬ä¸€ä¸ªä½ç½® ChannelPipeline addFirst(ChannelHandlerâ€¦ handlers) //æŠŠä¸€ä¸ªä¸šåŠ¡å¤„ç†ç±»ï¼ˆhandlerï¼‰ æ·»åŠ åˆ°é“¾ä¸­çš„æœ€åä¸€ä¸ªä½ç½® ChannelPipeline addLast(ChannelHandlerâ€¦ handlers) 8. Netty ç¾¤èŠ è¦æ±‚ï¼š ç¼–å†™ä¸€ä¸ª Netty ç¾¤èŠç³»ç»Ÿï¼Œå®ç°æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„æ•°æ®ç®€å•é€šè®¯ï¼ˆéé˜»å¡ï¼‰ å®ç°å¤šäººç¾¤èŠ æœåŠ¡å™¨ç«¯ï¼šå¯ä»¥ç›‘æµ‹ç”¨æˆ·ä¸Šçº¿ï¼Œç¦»çº¿ï¼Œå¹¶å®ç°æ¶ˆæ¯è½¬å‘åŠŸèƒ½ å®¢æˆ·ç«¯ï¼šé€šè¿‡channel å¯ä»¥æ— é˜»å¡å‘é€æ¶ˆæ¯ç»™å…¶å®ƒæ‰€æœ‰ç”¨æˆ·ï¼ŒåŒæ—¶å¯ä»¥æ¥å—å…¶å®ƒç”¨ æˆ·å‘é€çš„æ¶ˆæ¯(æœ‰æœåŠ¡å™¨è½¬å‘å¾—åˆ°) 1. serverç«¯ public class ChatServer { private int port; public ChatServer(int port) { this.port = port; } public void run() throws Exception{ //åˆ›å»ºbossGroup,workGroup EventLoopGroup bossGroup = new NioEventLoopGroup(); EventLoopGroup workGroup = new NioEventLoopGroup(); try { //åˆ›å»ºè¾…åŠ©å·¥å…· ServerBootstrap serverBootstrap = new ServerBootstrap(); //å¾ªç¯äº‹ä»¶ç»„ serverBootstrap.group(bossGroup,workGroup)//çº¿ç¨‹ç»„ .channel(NioServerSocketChannel.class)//é€šé“ç±»å‹ .option(ChannelOption.SO_BACKLOG,128) .childOption(ChannelOption.SO_KEEPALIVE,true) .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() { @Override protected void initChannel(SocketChannel socketChannel) throws Exception { ChannelPipeline pipeline = socketChannel.pipeline(); //åŠ å…¥è§£ç å™¨ pipeline.addLast(&quot;decoder&quot;,new StringDecoder()); //åŠ å…¥ç¼–ç å™¨ pipeline.addLast(&quot;encoder&quot;,new StringEncoder()); pipeline.addLast(new ChatServerHandler()); } }); System.out.println(&quot;server is ok&quot;); ChannelFuture channelFuture = serverBootstrap.bind(port).sync(); channelFuture.channel().closeFuture().sync(); } finally { bossGroup.shutdownGracefully(); workGroup.shutdownGracefully(); } } public static void main(String[] args) throws Exception { new ChatServer(8080).run(); } } 2. serverHandler public class ChatServerHandler extends SimpleChannelInboundHandler&lt;String&gt; { /** * å®šä¹‰ä¸€ä¸ª Channel çº¿ç¨‹ç»„ï¼Œç®¡ç†æ‰€æœ‰çš„ Channel, å‚æ•° æ‰§è¡Œå™¨ * GlobalEventExecutor =&gt; å…¨å±€äº‹ä»¶æ‰§è¡Œå™¨ * INSTANCE =&gt; è¡¨ç¤ºæ˜¯å•ä¾‹çš„ */ private static ChannelGroup channelGroup = new DefaultChannelGroup(GlobalEventExecutor.INSTANCE); SimpleDateFormat simpleDateFormat = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;); /** * å½“è¿æ¥å»ºç«‹ä¹‹åï¼Œç¬¬ä¸€ä¸ªè¢«æ‰§è¡Œ * ä¸€è¿æ¥æˆåŠŸï¼Œå°±æŠŠå½“å‰çš„ Channel åŠ å…¥åˆ° ChannelGroupï¼Œå¹¶å°†ä¸Šçº¿æ¶ˆæ¯æ¨é€ç»™å…¶ä»–å®¢æˆ· */ @Override public void handlerAdded(ChannelHandlerContext ctx) throws Exception { Channel channel = ctx.channel(); // å°†è¯¥å®¢æˆ·ä¸Šçº¿çš„ä¿¡æ¯ï¼Œæ¨é€ç»™å…¶ä»–åœ¨çº¿çš„ å®¢æˆ·ç«¯ // è¯¥æ–¹æ³•ï¼Œä¼šå°† ChannelGroup ä¸­æ‰€æœ‰çš„ Channel éå†ï¼Œå¹¶å‘é€æ¶ˆæ¯ Date date = new Date(System.currentTimeMillis()); channelGroup.writeAndFlush(&quot;[client]&quot; +channel.remoteAddress()+&quot;[&quot;+simpleDateFormat.format(date)+&quot;]&quot;+&quot;åŠ å…¥èŠå¤©&quot;); channelGroup.add(channel); } /** * å½“æ–­å¼€è¿æ¥æ¿€æ´»ï¼Œå°† XXX é€€å‡ºç¾¤èŠæ¶ˆæ¯æ¨é€ç»™å½“å‰åœ¨çº¿çš„å®¢æˆ· * å½“æŸä¸ª Channel æ‰§è¡Œåˆ°è¿™ä¸ªæ–¹æ³•ï¼Œä¼šè‡ªåŠ¨ä» ChannelGroup ä¸­ç§»é™¤ */ @Override public void handlerRemoved(ChannelHandlerContext ctx) throws Exception { Channel channel = ctx.channel(); Date date = new Date(System.currentTimeMillis()); channelGroup.writeAndFlush(&quot;[client]&quot;+channel.remoteAddress()+&quot;[&quot;+simpleDateFormat.format(date)+&quot;]&quot;+&quot;ç¦»å¼€èŠå¤©&quot;); //channelGroup.remove(channel); ä¸éœ€è¦ï¼ŒhandlerRemovedï¼ˆï¼‰ç›´æ¥åˆ é™¤äº†channel } /** * æç¤ºå®¢æˆ·ç«¯ç¦»çº¿çŠ¶æ€ * @param ctx * @throws Exception */ @Override public void channelInactive(ChannelHandlerContext ctx) throws Exception { Date date = new Date(System.currentTimeMillis()); System.out.println(ctx.channel().remoteAddress()+&quot;[&quot;+simpleDateFormat.format(date)+&quot;]&quot;+&quot;ä¸‹çº¿äº†&quot;); } /** * æç¤ºå®¢æˆ·ç«¯ä¸Šçº¿çŠ¶æ€ * @param ctx * @throws Exception */ @Override public void channelActive(ChannelHandlerContext ctx) throws Exception { Date date = new Date(System.currentTimeMillis()); System.out.println(ctx.channel().remoteAddress()+&quot;[&quot;+simpleDateFormat.format(date)+&quot;]&quot;+&quot;ä¸Šçº¿äº†&quot;);; } /** * è¯»å–æ¶ˆæ¯ï¼Œè½¬å‘æ•°æ® * @param ctx * @param msg * @throws Exception */ @Override protected void channelRead0(ChannelHandlerContext ctx, String msg) throws Exception { Channel channel = ctx.channel(); Date date = new Date(System.currentTimeMillis()); //éå†ï¼Œæ ¹æ®ä¸åŒå¯¹è±¡å‘é€ä¸åŒæ•°æ® channelGroup.forEach(ch -&gt;{ if(channel != ch){//ä¸æ˜¯è‡ªå·±çš„channel ch.writeAndFlush(&quot;[å®¢æˆ·]&quot;+channel.remoteAddress()+&quot;[&quot;+simpleDateFormat.format(date)+&quot;]&quot;+&quot;å‘é€&quot;+msg+&quot;/n&quot;); } else{ ch.writeAndFlush(&quot;[è‡ªå·±]å‘é€äº†æ¶ˆæ¯&quot;+&quot;[&quot;+simpleDateFormat.format(date)+&quot;]&quot;+msg+&quot;/n&quot;); } } ); } /** * å¼‚å¸¸å¤„ç† * @param ctx * @param cause * @throws Exception */ @Override public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception { ctx.close(); } } 3. clientç«¯ public class ChatClient { private final String HOST; private final int PORT; public ChatClient(String host, int port) { HOST = host; PORT = port; } public void run() throws InterruptedException { EventLoopGroup eventLoopGroup = new NioEventLoopGroup(); try { Bootstrap bootstrap = new Bootstrap(); bootstrap.group(eventLoopGroup) .channel(NioSocketChannel.class) .handler(new ChannelInitializer&lt;SocketChannel&gt;() { @Override protected void initChannel(SocketChannel socketChannel) throws Exception { ChannelPipeline pipeline = socketChannel.pipeline(); //åŠ å…¥è§£ç å™¨ pipeline.addLast(&quot;decoder&quot;,new StringDecoder()); //åŠ å…¥ç¼–ç å™¨ pipeline.addLast(&quot;encoder&quot;,new StringEncoder()); pipeline.addLast(new ChatClientHandler()); } }); ChannelFuture channelFuture = bootstrap.connect(HOST, PORT).sync(); System.out.println(&quot;client prepare is ok&quot;); Channel channel = channelFuture.channel(); //å®¢æˆ·ç«¯éœ€è¦è¾“å…¥ä¿¡æ¯ï¼Œå®šä¹‰æ‰«æå™¨ Scanner scanner = new Scanner(System.in); while(scanner.hasNextLine()){ String s = scanner.nextLine(); channel.writeAndFlush(s); } channel.closeFuture().sync(); } finally { eventLoopGroup.shutdownGracefully(); } } public static void main(String[] args) throws InterruptedException { new ChatClient(&quot;localhost&quot;,8080).run(); } } 4. clientHandler public class ChatClientHandler extends SimpleChannelInboundHandler&lt;String&gt; { @Override protected void channelRead0(ChannelHandlerContext channelHandlerContext, String s) throws Exception { // ç›´æ¥è¾“å‡ºä»æœåŠ¡ç«¯è·å¾—çš„ä¿¡æ¯ System.out.println(s.trim()); } } 9. å¿ƒè·³æœºåˆ¶ 1. serverç«¯ï¼š public class MyServer { public static void main(String[] args) throws Exception{ //åˆ›å»ºbossGroup,workGroup EventLoopGroup bossGroup = new NioEventLoopGroup(); EventLoopGroup workGroup = new NioEventLoopGroup(); try { //åˆ›å»ºè¾…åŠ©å·¥å…· ServerBootstrap serverBootstrap = new ServerBootstrap(); //å¾ªç¯äº‹ä»¶ç»„ serverBootstrap.group(bossGroup,workGroup)//çº¿ç¨‹ç»„ .channel(NioServerSocketChannel.class)//é€šé“ç±»å‹ .handler(new LoggingHandler(LogLevel.INFO)) .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() { @Override protected void initChannel(SocketChannel socketChannel) throws Exception { ChannelPipeline pipeline = socketChannel.pipeline(); /* è¯´æ˜ï¼š 1. IdleStateHandler æ˜¯ Netty æä¾›çš„ ç©ºé—²çŠ¶æ€å¤„ç†å™¨ 2. å››ä¸ªå‚æ•°ï¼š readerIdleTime : è¡¨ç¤ºå¤šä¹…æ²¡æœ‰ è¯» äº‹ä»¶åï¼Œå°±ä¼šå‘é€ä¸€ä¸ªå¿ƒè·³æ£€æµ‹åŒ…ï¼Œæ£€æµ‹æ˜¯å¦è¿˜æ˜¯è¿æ¥çŠ¶æ€ writerIdleTime : è¡¨ç¤ºå¤šä¹…æ²¡æœ‰ å†™ äº‹ä»¶åï¼Œå°±ä¼šå‘é€ä¸€ä¸ªå¿ƒè·³æ£€æµ‹åŒ…ï¼Œæ£€æµ‹æ˜¯å¦è¿˜æ˜¯è¿æ¥çŠ¶æ€ allIdleTime : è¡¨ç¤ºå¤šä¹…æ—¶é—´æ—¢æ²¡è¯»ä¹Ÿæ²¡å†™ åï¼Œå°±ä¼šå‘é€ä¸€ä¸ªå¿ƒè·³æ£€æµ‹åŒ…ï¼Œæ£€æµ‹æ˜¯å¦è¿˜æ˜¯è¿æ¥çŠ¶æ€ TimeUnit : æ—¶é—´å•ä½ 1. å½“ Channel ä¸€æ®µæ—¶é—´å†…æ²¡æœ‰æ‰§è¡Œ è¯» / å†™ / è¯»å†™ äº‹ä»¶åï¼Œå°±ä¼šè§¦å‘ä¸€ä¸ª IdleStateEvent ç©ºé—²çŠ¶æ€äº‹ä»¶ 2. å½“ IdleStateEvent è§¦å‘åï¼Œå°±ä¼šä¼ é€’ç»™ Pipeline ä¸­çš„ä¸‹ä¸€ä¸ª Handler å»å¤„ç†ï¼Œé€šè¿‡å›è°ƒä¸‹ä¸€ä¸ª Handler çš„ userEventTriggered æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­å¤„ç† IdleStateEvent */ pipeline.addLast(new IdleStateHandler(3,5,7, TimeUnit.SECONDS)); pipeline.addLast(new MyServerHandler()); } }); System.out.println(&quot;server is ok&quot;); ChannelFuture channelFuture = serverBootstrap.bind(8080).sync(); channelFuture.channel().closeFuture().sync(); } finally { bossGroup.shutdownGracefully(); workGroup.shutdownGracefully(); } } } 2. handler public class MyServerHandler extends ChannelInboundHandlerAdapter { /** * @param ctx ä¸Šä¸‹æ–‡ @param evt äº‹ä»¶ * @throws Exception */ @Override public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception { if(evt instanceof IdleStateEvent){ //å°† evt å‘ä¸‹è½¬å‹ IdleStateEvent IdleStateEvent event = (IdleStateEvent)evt; String eventType = null; //IdleStateEvent æšä¸¾ switch (event.state()){ case READER_IDLE: eventType = &quot;è¯»ç©ºé—²&quot;; break; case WRITER_IDLE: eventType = &quot;å†™ç©ºé—²&quot;; break; case ALL_IDLE: eventType = &quot;è¯»å†™ç©ºé—²&quot;; } System.out.println(ctx.channel().remoteAddress()+&quot;---è¶…æ—¶äº‹ä»¶---&quot;+eventType); } } } è¯´æ˜ï¼š 1: IdleStateHandler æ˜¯ Netty æä¾›çš„ ç©ºé—²çŠ¶æ€å¤„ç†å™¨ 2: å››ä¸ªå‚æ•°ï¼š readerIdleTime : è¡¨ç¤ºå¤šä¹…æ²¡æœ‰ è¯» äº‹ä»¶åï¼Œå°±ä¼šå‘é€ä¸€ä¸ªå¿ƒè·³æ£€æµ‹åŒ…ï¼Œæ£€æµ‹æ˜¯å¦è¿˜æ˜¯è¿æ¥çŠ¶æ€ writerIdleTime : è¡¨ç¤ºå¤šä¹…æ²¡æœ‰ å†™ äº‹ä»¶åï¼Œå°±ä¼šå‘é€ä¸€ä¸ªå¿ƒè·³æ£€æµ‹åŒ…ï¼Œæ£€æµ‹æ˜¯å¦è¿˜æ˜¯è¿æ¥çŠ¶æ€ allIdleTime : è¡¨ç¤ºå¤šä¹…æ—¶é—´æ—¢æ²¡è¯»ä¹Ÿæ²¡å†™ åï¼Œå°±ä¼šå‘é€ä¸€ä¸ªå¿ƒè·³æ£€æµ‹åŒ…ï¼Œæ£€æµ‹æ˜¯å¦è¿˜æ˜¯è¿æ¥çŠ¶æ€ TimeUnit : æ—¶é—´å•ä½ 3: å½“ Channel ä¸€æ®µæ—¶é—´å†…æ²¡æœ‰æ‰§è¡Œ è¯» / å†™ / è¯»å†™ äº‹ä»¶åï¼Œå°±ä¼šè§¦å‘ä¸€ä¸ª IdleStateEvent ç©ºé—²çŠ¶æ€äº‹ä»¶ 4: å½“ IdleStateEvent è§¦å‘åï¼Œå°±ä¼šä¼ é€’ç»™ Pipeline ä¸­çš„ä¸‹ä¸€ä¸ª Handler å»å¤„ç†ï¼Œé€šè¿‡å›è°ƒä¸‹ä¸€ä¸ª Handler çš„ userEventTriggered æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­å¤„ç† IdleStateEvent 10. é•¿è¿æ¥ è¦æ±‚ï¼š å®ç°åŸºäºwebSocketçš„é•¿è¿æ¥ çš„å…¨åŒå·¥çš„äº¤äº’ æ”¹å˜Httpåè®®å¤šæ¬¡è¯·æ±‚çš„çº¦æŸï¼Œå® ç°é•¿è¿æ¥äº†ï¼Œ æœåŠ¡å™¨å¯ä»¥å‘é€æ¶ˆæ¯ ç»™æµè§ˆå™¨ å®¢æˆ·ç«¯æµè§ˆå™¨å’ŒæœåŠ¡å™¨ç«¯ä¼šç›¸äº’æ„Ÿ çŸ¥ï¼Œæ¯”å¦‚æœåŠ¡å™¨å…³é—­äº†ï¼Œæµè§ˆå™¨ä¼š æ„ŸçŸ¥ï¼ŒåŒæ ·æµè§ˆå™¨å…³é—­äº†ï¼ŒæœåŠ¡å™¨ ä¼šæ„ŸçŸ¥ ä»£ç å®ç° æœåŠ¡ç«¯ ï¼šWebServer public class MyServer { public static void main(String[] args) throws InterruptedException { //åˆ›å»ºbossGroup,workGroup EventLoopGroup bossGroup = new NioEventLoopGroup(); EventLoopGroup workGroup = new NioEventLoopGroup(); try { //åˆ›å»ºè¾…åŠ©å·¥å…· ServerBootstrap serverBootstrap = new ServerBootstrap(); //å¾ªç¯äº‹ä»¶ç»„ serverBootstrap.group(bossGroup,workGroup)//çº¿ç¨‹ç»„ .channel(NioServerSocketChannel.class)//é€šé“ç±»å‹ .handler(new LoggingHandler(LogLevel.INFO)) .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() { @Override protected void initChannel(SocketChannel socketChannel) throws Exception { ChannelPipeline pipeline = socketChannel.pipeline(); //åŸºäºhttpåè®®ä½¿ç”¨httpçš„ç¼–ç å’Œè§£ç å™¨ pipeline.addLast(new HttpServerCodec()); // æ·»åŠ å—å¤„ç†å™¨ pipeline.addLast(new ChunkedWriteHandler()); /* è¯´æ˜ï¼š 1. å› ä¸º HTTP æ•°æ®ä¼ è¾“æ—¶æ˜¯åˆ†æ®µçš„ï¼ŒHttpObjectAggregator å¯ä»¥å°†å¤šä¸ªç«¯èšåˆ 2. è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæµè§ˆå™¨å‘é€å¤§é‡æ•°æ®æ—¶ï¼Œå°±ä¼šå‘å‡ºå¤šæ¬¡ HTTP è¯·æ±‚ */ pipeline.addLast(new HttpObjectAggregator(8192)); /* è¯´æ˜ï¼š 1. å¯¹äº WebSocket æ˜¯ä»¥ å¸§ çš„å½¢å¼ä¼ é€’çš„ 2. åé¢çš„å‚æ•°è¡¨ç¤º ï¼šè¯·æ±‚çš„ URL 3. WebSocketServerProtocolHandler å°† HTTP åè®®å‡çº§ä¸º WebSocket åè®®ï¼Œå³ä¿æŒé•¿è¿æ¥ 4. åˆ‡æ¢åè®®é€šè¿‡ä¸€ä¸ªçŠ¶æ€ç 101 */ pipeline.addLast(new WebSocketServerProtocolHandler(&quot;/hello&quot;)); // è‡ªå®šä¹‰çš„ Handler pipeline.addLast(new MyTextWebSocketFrameHandler()); } }); System.out.println(&quot;server is ok&quot;); ChannelFuture channelFuture = serverBootstrap.bind(8080).sync(); channelFuture.channel().closeFuture().sync(); } finally { bossGroup.shutdownGracefully(); workGroup.shutdownGracefully(); } } } æœåŠ¡ç«¯çš„å¤„ç†å™¨ ï¼šMyTextWebSocketFrameHandler /** * TextWebSocketFrame ç±»å‹ï¼Œè¡¨ç¤ºä¸€ä¸ªæ–‡æœ¬å¸§ï¼ˆflameï¼‰ */ public class MyTextWebSocketFrameHandler extends SimpleChannelInboundHandler&lt;TextWebSocketFrame&gt; { @Override protected void channelRead0(ChannelHandlerContext ctx, TextWebSocketFrame msg) throws Exception { System.out.println(&quot;æœåŠ¡å™¨æ”¶åˆ°æ¶ˆæ¯&quot;+msg.text()); //å›å¤æ¶ˆæ¯ ctx.channel().writeAndFlush(new TextWebSocketFrame(&quot;æœåŠ¡å™¨æ—¶é—´&quot;+ LocalDateTime.now()+msg.text())); } /** * å®¢æˆ·ç«¯è¿æ¥åï¼Œè§¦å‘æ–¹æ³• * @param ctx * @throws Exception */ @Override public void handlerAdded(ChannelHandlerContext ctx) throws Exception { //idè¡¨ç¤ºå”¯ä¸€çš„å€¼ï¼ŒLongtextæ˜¯å”¯ä¸€çš„shortText ä¸æ˜¯å”¯ä¸€ System.out.println(&quot;handlerAdded è¢«è°ƒç”¨&quot;+ctx.channel().id().asLongText()); System.out.println(&quot;handlerAdded è¢«è°ƒç”¨&quot;+ctx.channel().id().asShortText()); } @Override public void handlerRemoved(ChannelHandlerContext ctx) throws Exception { System.out.println(&quot;handlerRemoveè¢«è°ƒç”¨&quot;+ctx.channel().id().asLongText()); } @Override public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception { System.out.println(&quot;å¼‚å¸¸å‘ç”Ÿ&quot;+cause.getMessage()); //å…³é—­è¿æ¥ ctx.close(); } } hello.html(æµè§ˆå™¨) &lt;!DOCTYPE html&gt; &lt;html lang=&quot;en&quot;&gt; &lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;Title&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;form onsubmit=&quot;return false&quot;&gt; &lt;textarea id=&quot;message&quot; name=&quot;message&quot; style=&quot;height: 300px; width: 300px&quot;&gt;&lt;/textarea&gt; &lt;input type=&quot;button&quot; value=&quot;å‘é€æ¶ˆæ¯&quot; onclick=&quot;send(this.form.message.value)&quot;&gt; &lt;textarea id=&quot;responseText&quot; style=&quot;height: 300px; width: 300px&quot;&gt;&lt;/textarea&gt; &lt;input type=&quot;button&quot; value=&quot;æ¸…ç©ºå†…å®¹&quot; onclick=&quot;document.getElementById('responseText').value=''&quot;&gt; &lt;/form&gt; &lt;script&gt; var socket; // åˆ¤æ–­å½“å‰æµè§ˆå™¨æ˜¯å¦æ”¯æŒ WebSocket if (window.WebSocket){ socket = new WebSocket(&quot;ws://localhost:8080/hello&quot;); // ç›¸å½“äº channelRead0 æ–¹æ³•ï¼Œev æ”¶åˆ°æœåŠ¡å™¨ç«¯å›é€çš„æ¶ˆæ¯ socket.onmessage = function (ev){ var rt = document.getElementById(&quot;responseText&quot;); rt.value = rt.value + &quot;\\n&quot; + ev.data; } // ç›¸å½“äºè¿æ¥å¼€å¯ï¼Œæ„ŸçŸ¥åˆ°è¿æ¥å¼€å¯ socket.onopen = function (){ var rt = document.getElementById(&quot;responseText&quot;); rt.value = rt.value + &quot;\\n&quot; + &quot;è¿æ¥å¼€å¯â€¦â€¦&quot;; } // æ„ŸçŸ¥è¿æ¥å…³é—­ socket.onclose = function (){ var rt = document.getElementById(&quot;responseText&quot;); rt.value = rt.value + &quot;\\n&quot; + &quot;è¿æ¥å…³é—­â€¦â€¦&quot;; } }else { alert(&quot;ä¸æ”¯æŒ WebSocket&quot;); } // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨ function send(message){ // åˆ¤æ–­ WebSocket æ˜¯å¦åˆ›å»ºå¥½äº† if (!window.socket){ return ; } // åˆ¤æ–­ WebSocket æ˜¯å¦å¼€å¯ if (socket.readyState == WebSocket.OPEN){ // é€šè¿‡ Socket å‘é€æ¶ˆæ¯ socket.send(message); }else { alert(&quot;è¿æ¥æœªå¼€å¯&quot;); } } &lt;/script&gt; &lt;/body&gt; &lt;/html&gt; ","link":"https://tianxiawuhao.github.io/Hbra5M-xo/"},{"title":"NIO","content":"1. ç®€ä»‹ Netty æ˜¯ç”± JBOSS æä¾›çš„ä¸€ä¸ª Java å¼€æºæ¡†æ¶ï¼Œç°ä¸º Githubä¸Šçš„ç‹¬ç«‹é¡¹ç›®ã€‚ Netty æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ã€åŸºäºäº‹ä»¶é©±åŠ¨ï¼ˆå®¢æˆ·ç«¯çš„è¡Œä¸ºã€è¯»å†™äº‹ä»¶ï¼‰çš„ç½‘ç»œåº”ç”¨æ¡†æ¶ï¼Œç”¨ä»¥å¿«é€Ÿå¼€å‘é«˜æ€§èƒ½ã€é«˜å¯é æ€§çš„ç½‘ç»œ IO ç¨‹åºã€‚ Nettyä¸»è¦é’ˆå¯¹åœ¨TCPåè®®ä¸‹ï¼Œé¢å‘Clientsç«¯çš„é«˜å¹¶å‘åº”ç”¨ï¼Œæˆ–è€…Peer-to-Peeråœºæ™¯ä¸‹çš„å¤§é‡æ•°æ®æŒç»­ä¼ è¾“çš„åº”ç”¨ã€‚ Nettyæœ¬è´¨æ˜¯ä¸€ä¸ªNIOæ¡†æ¶ï¼Œé€‚ç”¨äºæœåŠ¡å™¨é€šè®¯ç›¸å…³çš„å¤šç§åº”ç”¨åœºæ™¯ è¦é€å½»ç†è§£Netty ï¼Œ éœ€è¦å…ˆå­¦ä¹  NIO ï¼Œ è¿™æ ·æˆ‘ä»¬æ‰èƒ½é˜…è¯» Netty çš„æºç ã€‚ 2. I/O æ¨¡å‹åŸºæœ¬è¯´æ˜ I/O æ¨¡å‹ç®€å•çš„ç†è§£ï¼šå°±æ˜¯ç”¨ä»€ä¹ˆæ ·çš„é€šé“è¿›è¡Œæ•°æ®çš„å‘é€å’Œæ¥æ”¶ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šå†³å®šäº†ç¨‹ åºé€šä¿¡çš„æ€§èƒ½ 2.1. Javaå…±æ”¯æŒ3ç§ç½‘ç»œç¼–ç¨‹æ¨¡å‹/IOæ¨¡å¼ï¼š BIOã€NIOã€AIO Java BIO ï¼š åŒæ­¥å¹¶é˜»å¡(ä¼ ç»Ÿé˜»å¡å‹)ï¼ŒæœåŠ¡å™¨å®ç°æ¨¡å¼ä¸ºä¸€ä¸ªè¿æ¥ä¸€ä¸ªçº¿ç¨‹ï¼Œå³å®¢æˆ·ç«¯ æœ‰è¿æ¥è¯·æ±‚æ—¶æœåŠ¡å™¨ç«¯å°±éœ€è¦å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œå¦‚æœè¿™ä¸ªè¿æ¥ä¸åšä»»ä½•äº‹æƒ…ä¼šé€ æˆ ä¸å¿…è¦çš„çº¿ç¨‹å¼€é”€ Java NIO ï¼š åŒæ­¥éé˜»å¡ï¼ŒæœåŠ¡å™¨å®ç°æ¨¡å¼ä¸ºä¸€ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªè¯·æ±‚(è¿æ¥)ï¼Œå³å®¢æˆ·ç«¯å‘é€çš„è¿æ¥è¯·æ±‚éƒ½ä¼šæ³¨å†Œåˆ°å¤šè·¯å¤ç”¨å™¨ä¸Šï¼Œå¤šè·¯å¤ç”¨å™¨è½®è¯¢åˆ°è¿æ¥æœ‰I/Oè¯·æ±‚å°±è¿›è¡Œå¤„ç† Java AIO(NIO.2) ï¼š å¼‚æ­¥éé˜»å¡ï¼ŒAIO å¼•å…¥å¼‚æ­¥é€šé“çš„æ¦‚å¿µï¼Œé‡‡ç”¨äº† Proactor æ¨¡å¼ï¼Œç®€åŒ–äº†ç¨‹åºç¼–å†™ï¼Œæœ‰æ•ˆçš„è¯·æ±‚æ‰å¯åŠ¨çº¿ç¨‹ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯å…ˆç”±æ“ä½œç³»ç»Ÿå®Œæˆåæ‰é€šçŸ¥æœåŠ¡ç«¯ç¨‹ 2.2. BIOã€NIOã€AIOé€‚ç”¨åœºæ™¯åˆ†æ BIOæ–¹å¼ é€‚ç”¨äºè¿æ¥æ•°ç›®æ¯”è¾ƒå°ä¸”å›ºå®šçš„æ¶æ„ï¼Œè¿™ç§æ–¹å¼å¯¹æœåŠ¡å™¨èµ„æºè¦æ±‚æ¯”è¾ƒé«˜ï¼Œ å¹¶å‘å±€é™äºåº”ç”¨ä¸­ï¼ŒJDK1.4ä»¥å‰çš„å”¯ä¸€é€‰æ‹©ï¼Œä½†ç¨‹åºç®€å•æ˜“ç†è§£ã€‚ NIOæ–¹å¼ é€‚ç”¨äºè¿æ¥æ•°ç›®å¤šä¸”è¿æ¥æ¯”è¾ƒçŸ­ï¼ˆè½»æ“ä½œï¼‰çš„æ¶æ„ï¼Œæ¯”å¦‚èŠå¤©æœåŠ¡å™¨ï¼Œå¼¹å¹• ç³»ç»Ÿï¼ŒæœåŠ¡å™¨é—´é€šè®¯ç­‰ã€‚ç¼–ç¨‹æ¯”è¾ƒå¤æ‚ï¼ŒJDK1.4å¼€å§‹æ”¯æŒã€‚ AIOæ–¹å¼ ä½¿ç”¨äºè¿æ¥æ•°ç›®å¤šä¸”è¿æ¥æ¯”è¾ƒé•¿ï¼ˆé‡æ“ä½œï¼‰çš„æ¶æ„ï¼Œæ¯”å¦‚ç›¸å†ŒæœåŠ¡å™¨ï¼Œå……åˆ† è°ƒç”¨OSå‚ä¸å¹¶å‘æ“ä½œï¼Œç¼–ç¨‹æ¯”è¾ƒå¤æ‚ï¼ŒJDK7å¼€å§‹æ”¯æŒã€‚ 3. NIOå…·ä½“ä»‹ç» Java NIO å…¨ç§° java non-blocking IOï¼Œæ˜¯æŒ‡ JDK æä¾›çš„æ–° APIã€‚ä» JDK1.4 å¼€å§‹ï¼ŒJava æä¾›äº†ä¸€ç³»åˆ—æ”¹è¿›çš„è¾“å…¥/è¾“å‡º çš„æ–°ç‰¹æ€§ï¼Œè¢«ç»Ÿç§°ä¸º NIO(å³ New IO)ï¼Œæ˜¯åŒæ­¥éé˜»å¡çš„ NIO ç›¸å…³ç±»éƒ½è¢«æ”¾åœ¨ java.nio åŒ…åŠå­åŒ…ä¸‹ï¼Œå¹¶ä¸”å¯¹åŸ java.io åŒ…ä¸­çš„å¾ˆå¤šç±»è¿›è¡Œæ”¹å†™ã€‚ NIO æœ‰ä¸‰å¤§æ ¸å¿ƒéƒ¨åˆ†ï¼šChannel(é€šé“)ï¼ŒBuffer(ç¼“å†²åŒº), Selector(é€‰æ‹©å™¨) NIOæ˜¯ é¢å‘ç¼“å†²åŒº ï¼Œæˆ–è€…é¢å‘å—ç¼–ç¨‹çš„ã€‚æ•°æ®è¯»å–åˆ°ä¸€ä¸ª å®ƒç¨åå¤„ç†çš„ç¼“å†²åŒºï¼Œéœ€è¦æ—¶å¯åœ¨ç¼“å†²åŒºä¸­å‰åç§»åŠ¨ï¼Œè¿™å°± å¢åŠ äº†å¤„ç†è¿‡ç¨‹ä¸­çš„çµæ´»æ€§ï¼Œä½¿ç”¨å®ƒå¯ä»¥æä¾›éé˜»å¡å¼çš„é«˜ ä¼¸ç¼©æ€§ç½‘ç»œ Java NIOçš„éé˜»å¡æ¨¡å¼ï¼Œä½¿ä¸€ä¸ªçº¿ç¨‹ä»æŸé€šé“å‘é€è¯·æ±‚æˆ–è€…è¯»å–æ•°æ®ï¼Œä½†æ˜¯å®ƒä»…èƒ½å¾—åˆ°ç›®å‰å¯ç”¨çš„æ•°æ®ï¼Œå¦‚æœç›®å‰æ²¡æœ‰æ•°æ®å¯ç”¨æ—¶ï¼Œå°±ä»€ä¹ˆéƒ½ä¸ä¼šè·å–ï¼Œè€Œä¸æ˜¯ä¿æŒçº¿ç¨‹é˜»å¡ï¼Œæ‰€ä»¥ç›´è‡³æ•°æ®å˜çš„å¯ä»¥è¯»å–ä¹‹å‰ï¼Œè¯¥çº¿ç¨‹å¯ä»¥ç»§ç»­åšå…¶ä»–çš„äº‹æƒ…ã€‚ éé˜»å¡å†™ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä¸€ä¸ªçº¿ç¨‹è¯·æ±‚å†™å…¥ä¸€äº›æ•°æ®åˆ°æŸé€šé“ï¼Œä½†ä¸éœ€è¦ç­‰å¾…å®ƒå®Œå…¨å†™å…¥ï¼Œè¿™ ä¸ªçº¿ç¨‹åŒæ—¶å¯ä»¥å»åšåˆ«çš„äº‹æƒ…ã€‚ é€šä¿—ç†è§£ï¼šNIOæ˜¯å¯ä»¥åšåˆ°ç”¨ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†å¤šä¸ªæ“ä½œçš„ã€‚å‡è®¾æœ‰10000ä¸ªè¯·æ±‚è¿‡æ¥, æ ¹æ®å®é™…æƒ…å†µï¼Œå¯ä»¥åˆ†é…50æˆ–è€…100ä¸ªçº¿ç¨‹æ¥å¤„ç†ã€‚ä¸åƒä¹‹å‰çš„é˜»å¡IOé‚£æ ·ï¼Œéå¾—åˆ†é…10000ä¸ªã€‚ HTTP2.0ä½¿ç”¨äº†å¤šè·¯å¤ç”¨çš„æŠ€æœ¯ï¼Œåšåˆ°åŒä¸€ä¸ªè¿æ¥å¹¶å‘å¤„ç†å¤šä¸ªè¯·æ±‚ï¼Œè€Œä¸”å¹¶å‘è¯·æ±‚ çš„æ•°é‡æ¯”HTTP1.1å¤§äº†å¥½å‡ ä¸ªæ•°é‡çº§ 3.1. NIO ä¸‰å¤§æ ¸å¿ƒ Selector ã€ Channel å’Œ Buffer çš„ç®€å•å…³ç³»å›¾ å…³ç³»å›¾çš„è¯´æ˜: çº¿ç¨‹æ˜¯éé˜»å¡ï¼Œbufferèµ·å¾ˆå¤§çš„ä½œç”¨ æ¯ä¸ª Channel éƒ½ä¼šå¯¹åº”ä¸€ä¸ª Buffer Selector å¯¹åº”ä¸€ä¸ªçº¿ç¨‹ï¼Œ ä¸€ä¸ª Selector å¯¹åº”å¤šä¸ª Channel(è¿æ¥) è¯¥å›¾ååº”äº†æœ‰ä¸‰ä¸ª Channel æ³¨å†Œåˆ°è¯¥ selector ç¨‹åºåˆ‡æ¢åˆ°å“ªä¸ª Channel æ˜¯ç”±äº‹ä»¶å†³å®šçš„, Event å°±æ˜¯ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µ Selector ä¼šæ ¹æ®ä¸åŒçš„äº‹ä»¶ï¼Œåœ¨å„ä¸ª Channelï¼ˆé€šé“ï¼‰ä¸Šåˆ‡æ¢ Buffer å°±æ˜¯ä¸€ä¸ªå†…å­˜å— ï¼Œ åº•å±‚æ˜¯æœ‰ä¸€ä¸ªæ•°ç»„ æ•°æ®çš„è¯»å–å†™å…¥æ˜¯é€šè¿‡ Buffer, è¿™ä¸ªå’ŒBIO , BIO ä¸­è¦ä¹ˆæ˜¯è¾“å…¥æµï¼Œæˆ–è€…æ˜¯ è¾“å‡ºæµ, ä¸èƒ½åŒå‘ï¼Œä½†æ˜¯NIOçš„ Buffer æ˜¯å¯ä»¥è¯»ä¹Ÿå¯ä»¥å†™, éœ€è¦ flip æ–¹æ³•åˆ‡æ¢ 3.2. å¸¸ç”¨Bufferå­ç±»ä¸€è§ˆ ByteBufferï¼Œå­˜å‚¨å­—èŠ‚æ•°æ®åˆ°ç¼“å†²åŒº =æœ€å¸¸ç”¨= ShortBufferï¼Œå­˜å‚¨å­—ç¬¦ä¸²æ•°æ®åˆ°ç¼“å†²åŒº CharBufferï¼Œå­˜å‚¨å­—ç¬¦æ•°æ®åˆ°ç¼“å†²åŒº IntBufferï¼Œå­˜å‚¨æ•´æ•°æ•°æ®åˆ°ç¼“å†²åŒº LongBufferï¼Œå­˜å‚¨é•¿æ•´å‹æ•°æ®åˆ°ç¼“å†²åŒº DoubleBufferï¼Œå­˜å‚¨å°æ•°åˆ°ç¼“å†²åŒº FloatBufferï¼Œå­˜å‚¨å°æ•°åˆ°ç¼“å†²åŒº 3.3. bufferå¸¸ç”¨æ–¹æ³• public abstract class Buffer { //JDK1.4æ—¶ï¼Œå¼•å…¥çš„api public final int capacity( )// â˜… è¿”å›æ­¤ç¼“å†²åŒºçš„å®¹é‡ public final int position( )// â˜… è¿”å›æ­¤ç¼“å†²åŒºçš„ä½ç½® public final Buffer position (int newPositio)// â˜… è®¾ç½®æ­¤ç¼“å†²åŒºçš„ä½ç½® public final int limit( )// â˜… è¿”å›æ­¤ç¼“å†²åŒºçš„é™åˆ¶ public final Buffer limit (int newLimit)// â˜… è®¾ç½®æ­¤ç¼“å†²åŒºçš„é™åˆ¶ public final Buffer mark( )//åœ¨æ­¤ç¼“å†²åŒºçš„ä½ç½®è®¾ç½®æ ‡è®° public final Buffer reset( )//å°†æ­¤ç¼“å†²åŒºçš„ä½ç½®é‡ç½®ä¸ºä»¥å‰æ ‡è®°çš„ä½ç½® public final Buffer clear( )// â˜… æ¸…é™¤æ­¤ç¼“å†²åŒº, å³å°†å„ä¸ªæ ‡è®°æ¢å¤åˆ°åˆå§‹çŠ¶æ€ï¼Œä½†æ˜¯æ•°æ®å¹¶æ²¡æœ‰çœŸæ­£æ“¦é™¤, åé¢æ“ä½œä¼šè¦†ç›– public final Buffer flip( )// â˜… åè½¬æ­¤ç¼“å†²åŒº public final Buffer rewind( )//é‡ç»•æ­¤ç¼“å†²åŒº public final int remaining( )//è¿”å›å½“å‰ä½ç½®ä¸é™åˆ¶ä¹‹é—´çš„å…ƒç´ æ•° public final boolean hasRemaining( )// â˜… å‘ŠçŸ¥åœ¨å½“å‰ä½ç½®å’Œé™åˆ¶ä¹‹é—´æ˜¯å¦æœ‰å…ƒç´  public abstract boolean isReadOnly( );// â˜… å‘ŠçŸ¥æ­¤ç¼“å†²åŒºæ˜¯å¦ä¸ºåªè¯»ç¼“å†²åŒº //JDK1.6æ—¶å¼•å…¥çš„api public abstract boolean hasArray();// â˜… å‘ŠçŸ¥æ­¤ç¼“å†²åŒºæ˜¯å¦å…·æœ‰å¯è®¿é—®çš„åº•å±‚å®ç°æ•°ç»„ public abstract Object array();// â˜… è¿”å›æ­¤ç¼“å†²åŒºçš„åº•å±‚å®ç°æ•°ç»„ public abstract int arrayOffset();//è¿”å›æ­¤ç¼“å†²åŒºçš„åº•å±‚å®ç°æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªç¼“å†²åŒºå…ƒç´ çš„åç§»é‡ public abstract boolean isDirect();//å‘ŠçŸ¥æ­¤ç¼“å†²åŒºæ˜¯å¦ä¸ºç›´æ¥ç¼“å†²åŒº } 3.4. é€šé“(Channel) 1ï¼šåŸºæœ¬ä»‹ç» NIOçš„é€šé“ç±»ä¼¼äºæµï¼Œä½†æœ‰äº›åŒºåˆ«å¦‚ä¸‹ï¼š â€¢ é€šé“å¯ä»¥åŒæ—¶è¿›è¡Œè¯»å†™ï¼Œè€Œæµåªèƒ½è¯»æˆ–è€…åªèƒ½å†™ â€¢ é€šé“å¯ä»¥å®ç°å¼‚æ­¥è¯»å†™æ•°æ® â€¢ é€šé“å¯ä»¥ä»ç¼“å†²è¯»æ•°æ®ï¼Œä¹Ÿå¯ä»¥å†™æ•°æ®åˆ°ç¼“å†²: FileChannelä¸»è¦ç”¨æ¥å¯¹æœ¬åœ°æ–‡ä»¶è¿›è¡Œ IO æ“ä½œï¼Œå¸¸è§çš„æ–¹æ³•æœ‰ public int read(ByteBuffer dst) ï¼Œä»é€šé“è¯»å–æ•°æ®å¹¶æ”¾åˆ°ç¼“å†²åŒºä¸­ public int write(ByteBuffer src) ï¼ŒæŠŠç¼“å†²åŒºçš„æ•°æ®å†™åˆ°é€šé“ä¸­ public long transferFrom(ReadableByteChannel src, long position, long count)ï¼Œä»ç›®æ ‡é€šé“ ä¸­å¤åˆ¶æ•°æ®åˆ°å½“å‰é€šé“ public long transferTo(long position, long count, WritableByteChannel target)ï¼ŒæŠŠæ•°æ®ä»å½“ å‰é€šé“å¤åˆ¶ç»™ç›®æ ‡é€šé“ é¦–å…ˆchannelä¸æ–‡ä»¶è”ç«‹ï¼Œåˆ¤æ–­æ˜¯è¾“å…¥è¾“å‡ºæµçœ‹channelä¸bufferä¹‹é—´çš„å…³ç³» 3.5. å…³äºBuffer å’Œ Channelçš„æ³¨æ„äº‹é¡¹å’Œç»†èŠ‚ 1ï¼šByteBuffer æ”¯æŒç±»å‹åŒ–çš„ put å’Œ get, put æ”¾å…¥çš„æ˜¯ä»€ä¹ˆæ•°æ®ç±»å‹ï¼Œget å°±åº”è¯¥ä½¿ç”¨ç›¸åº”çš„æ•°æ®ç±»å‹æ¥å–å‡ºï¼ˆå–å‡ºçš„é¡ºåºä¹Ÿè¦å’Œå­˜å…¥çš„é¡ºåºä¸€è‡´ï¼‰ï¼Œå¦åˆ™å¯èƒ½æœ‰ BufferUnderflowException å¼‚å¸¸ã€‚ 2ï¼š å¯ä»¥å°†ä¸€ä¸ªæ™®é€šBuffer è½¬æˆåªè¯»Bufferï¼Œå¦‚æœå¯¹ä¸€ä¸ªåªè¯»ç±»å‹çš„ Buffer è¿›è¡Œå†™æ“ä½œä¼šæŠ¥é”™ ReadOnlyBufferException ByteBuffer buffer = ByteBuffer.allocate(3); ByteBuffer byteBuffer = buffer.asReadOnlyBuffer(); System.out.println(buffer); System.out.println(byteBuffer); 3ï¼šNIO è¿˜æä¾›äº† MappedByteBufferï¼Œ å¯ä»¥è®©æ–‡ä»¶ç›´æ¥åœ¨å†…å­˜ï¼ˆå †å¤–çš„å†…å­˜ï¼‰ä¸­è¿›è¡Œä¿®æ”¹ï¼Œ è€Œå¦‚ä½•åŒæ­¥åˆ°æ–‡ä»¶ç”±NIO æ¥å®Œæˆ. /* è¯´æ˜ 1. MappedByteBuffer å¯ä»¥è®©æ–‡ä»¶ç›´æ¥åœ¨å†…å­˜ä¸­ä¿®æ”¹ï¼Œè¿™æ ·æ“ä½œç³»ç»Ÿå¹¶ä¸éœ€è¦æ‹·è´ä¸€æ¬¡ 2. MappedByteBuffer å®é™…ç±»å‹æ˜¯ DirectByteBuffer */ public static void main(String[] args) throws Exception { RandomAccessFile randomAccessFile = new RandomAccessFile(&quot;D:\\\\file01.txt&quot;, &quot;rw&quot;); // è·å–å¯¹åº”çš„æ–‡ä»¶é€šé“ FileChannel channel = randomAccessFile.getChannel(); // å‚æ•° ï¼šä½¿ç”¨ åªè¯»/åªå†™/è¯»å†™ æ¨¡å¼ ï¼› å¯ä»¥ä¿®æ”¹çš„èµ·å§‹ä½ç½® ï¼› æ˜ å°„åˆ°å†…å­˜çš„å¤§å°ï¼Œå³å¯ä»¥å°†æ–‡ä»¶çš„å¤šå°‘ä¸ªå­—èŠ‚æ˜ å°„åˆ°å†…å­˜ // è¿™é‡Œå°±è¡¨ç¤ºï¼Œå¯ä»¥å¯¹ file01.txt æ–‡ä»¶ä¸­ [0,5) çš„å­—èŠ‚è¿›è¡Œ è¯»å†™æ“ä½œ MappedByteBuffer map = channel.map(FileChannel.MapMode.READ_WRITE, 0, 5); // è¿›è¡Œä¿®æ”¹æ“ä½œ map.put(0, (byte) 'A'); map.put(3, (byte) '3'); // å…³é—­é€šé“ channel.close(); } 4ï¼šå‰é¢æˆ‘ä»¬è®²çš„è¯»å†™æ“ä½œï¼Œéƒ½æ˜¯é€šè¿‡ä¸€ä¸ªBuffer å®Œæˆçš„ï¼ŒNIO è¿˜æ”¯æŒ é€šè¿‡å¤šä¸ª Buffer (å³ Buffer æ•°ç»„) å®Œæˆè¯»å†™æ“ä½œï¼Œå³ Scattering å’Œ Gathering ï¼Œéµå¾ª ä¾æ¬¡å†™å…¥ï¼Œä¾æ¬¡è¯»å–ã€‚ public static void main(String[] args) throws Exception { // ä½¿ç”¨ ServerSocketChannel å’Œ InetSocketAddress ç½‘ç»œ ServerSocketChannel serverSocketChannel = ServerSocketChannel.open(); InetSocketAddress inetSocketAddress = new InetSocketAddress(7000); //ç»‘å®šç«¯å£åˆ°socketï¼Œå¯åŠ¨ serverSocketChannel.socket().bind(inetSocketAddress); //åˆ›å»ºbufferçš„2ä¸ªæ•°ç»„ ByteBuffer[] byteBuffers = new ByteBuffer[2]; byteBuffers[0] = ByteBuffer.allocate(5); byteBuffers[1] = ByteBuffer.allocate(3); //ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ SocketChannel socketChannel = serverSocketChannel.accept(); int messageLength = 8; //å¾ªç¯çš„è¯»å– while(true){ // è¡¨ç¤ºç´¯è®¡è¯»å–çš„å­—èŠ‚æ•° int byteRead = 0; // å‡è®¾ä»å®¢æˆ·ç«¯æœ€å¤šæ¥æ”¶ 8 ä¸ªå­—èŠ‚ while (byteRead &lt; messageLength){ // è‡ªåŠ¨æŠŠæ•°æ®åˆ†é…åˆ° byteBuffers-0ã€byteBuffers-1 long read = socketChannel.read(byteBuffers); byteRead += read; // ä½¿ç”¨æµæ‰“å°ï¼ŒæŸ¥çœ‹å½“å‰ Buffer çš„ Position å’Œ Limit Arrays.asList(byteBuffers).stream(). map(byteBuffer -&gt; &quot;{position: &quot;+byteBuffer.position()+&quot;, limit: &quot;+byteBuffer.limit()+&quot;}&quot;) .forEach(System.out::println); } // å°†æ‰€æœ‰çš„ Buffer è¿›è¡Œåè½¬ï¼Œä¸ºåé¢çš„å…¶ä»–æ“ä½œåšå‡†å¤‡ Arrays.asList(byteBuffers).forEach(Buffer -&gt;Buffer.flip()); // å°†æ•°æ®è¯»å‡ºï¼Œæ˜¾ç¤ºåˆ°å®¢æˆ·ç«¯ int byteWrite = 0; while (byteWrite &lt; messageLength){ long write = socketChannel.write(byteBuffers); byteWrite += write; } // å°†æ‰€æœ‰çš„ Buffer è¿›è¡Œæ¸…ç©ºï¼Œä¸ºåé¢çš„å…¶ä»–æ“ä½œåšå‡†å¤‡ Arrays.asList(byteBuffers).forEach(Buffer-&gt;Buffer.clear()); // æ‰“å°å¤„ç†çš„å­—èŠ‚æ•° System.out.println(&quot;{byteRead: &quot;+byteRead+&quot;, byteWrite: &quot;+byteWrite+&quot;}&quot;); } } 3.6. Selectoré€‰æ‹©å™¨ 1. åŸºæœ¬ä»‹ç» 1: Java çš„ NIOï¼Œç”¨éé˜»å¡çš„ IO æ–¹å¼ã€‚å¯ä»¥ç”¨ä¸€ä¸ªçº¿ç¨‹ï¼Œå¤„ç†å¤šä¸ªçš„å®¢æˆ·ç«¯è¿æ¥ï¼Œå°±ä¼šä½¿ç”¨åˆ°Selector(é€‰æ‹©å™¨) 2: Selector èƒ½å¤Ÿæ£€æµ‹å¤šä¸ªæ³¨å†Œçš„é€šé“ä¸Šæ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿ(æ³¨æ„:å¤šä¸ªChannelä»¥äº‹ä»¶çš„æ–¹å¼å¯ä»¥æ³¨å†Œåˆ°åŒä¸€ä¸ªSelector)ï¼Œå¦‚æœæœ‰äº‹ä»¶å‘ç”Ÿï¼Œä¾¿è·å–äº‹ä»¶ç„¶ åé’ˆå¯¹æ¯ä¸ªäº‹ä»¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚è¿™æ ·å°±å¯ä»¥åªç”¨ä¸€ä¸ªå•çº¿ç¨‹å»ç®¡ç†å¤šä¸ªé€šé“ï¼Œä¹Ÿå°±æ˜¯ç®¡ç†å¤šä¸ªè¿æ¥å’Œè¯·æ±‚ã€‚ 3: åªæœ‰åœ¨ è¿æ¥/é€šé“ çœŸæ­£æœ‰è¯»å†™äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œæ‰ä¼šè¿›è¡Œè¯»å†™ï¼Œå°±å¤§å¤§åœ°å‡å°‘ äº†ç³»ç»Ÿå¼€é”€ï¼Œå¹¶ä¸”ä¸å¿…ä¸ºæ¯ä¸ªè¿æ¥éƒ½åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¸ç”¨å»ç»´æŠ¤å¤šä¸ªçº¿ç¨‹ 4: é¿å…äº†å¤šçº¿ç¨‹ä¹‹é—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¯¼è‡´çš„å¼€é”€ 2. Selector(é€‰æ‹©å™¨) ç¤ºæ„å›¾ è¯´æ˜: Netty çš„ IO çº¿ç¨‹ NioEventLoop èšåˆäº† Selector(é€‰æ‹©å™¨ï¼Œ ä¹Ÿå«å¤šè·¯å¤ç”¨å™¨)ï¼Œå¯ä»¥åŒæ—¶å¹¶å‘å¤„ç†æˆç™¾ä¸Šåƒä¸ªå®¢ æˆ·ç«¯è¿æ¥ã€‚ å½“çº¿ç¨‹ä»æŸå®¢æˆ·ç«¯ Socket é€šé“è¿›è¡Œè¯»å†™æ•°æ®æ—¶ï¼Œè‹¥æ²¡ æœ‰æ•°æ®å¯ç”¨æ—¶ï¼Œè¯¥çº¿ç¨‹å¯ä»¥è¿›è¡Œå…¶ä»–ä»»åŠ¡ã€‚ çº¿ç¨‹é€šå¸¸å°†éé˜»å¡ IO çš„ç©ºé—²æ—¶é—´ç”¨äºåœ¨å…¶ä»–é€šé“ä¸Š æ‰§è¡Œ IO æ“ä½œï¼Œæ‰€ä»¥å•ç‹¬çš„çº¿ç¨‹å¯ä»¥ç®¡ç†å¤šä¸ªè¾“å…¥å’Œ è¾“å‡ºé€šé“ã€‚ ç”±äºè¯»å†™æ“ä½œéƒ½æ˜¯éé˜»å¡çš„ï¼Œè¿™å°±å¯ä»¥å……åˆ†æå‡ IO çº¿ç¨‹çš„è¿è¡Œæ•ˆç‡ï¼Œé¿å…ç”±äºé¢‘ç¹ I/O é˜»å¡å¯¼è‡´çš„çº¿ç¨‹ æŒ‚èµ·ã€‚ ä¸€ä¸ª I/O çº¿ç¨‹å¯ä»¥å¹¶å‘å¤„ç† N ä¸ªå®¢æˆ·ç«¯è¿æ¥å’Œè¯»å†™æ“ä½œï¼Œè¿™ä»æ ¹æœ¬ä¸Šè§£å†³äº†ä¼ ç»ŸåŒæ­¥é˜»å¡ I/O ä¸€è¿æ¥ä¸€çº¿ ç¨‹æ¨¡å‹ï¼Œæ¶æ„çš„æ€§èƒ½ã€å¼¹æ€§ä¼¸ç¼©èƒ½åŠ›å’Œå¯é æ€§éƒ½å¾—åˆ° äº†æå¤§çš„æå‡ã€‚ 3. Selectorç±»ç›¸å…³æ–¹æ³• Selector ç±»æ˜¯ä¸€ä¸ªæŠ½è±¡ç±», å¸¸ç”¨æ–¹æ³•å’Œè¯´æ˜å¦‚ä¸‹ public abstract class Selector implements Closeable { public static Selector open();//å¾—åˆ°ä¸€ä¸ªé€‰æ‹©å™¨å¯¹è±¡ public int select(long timeout);//ç›‘æ§æ‰€æœ‰æ³¨å†Œçš„é€šé“ï¼Œå½“å…¶ ä¸­æœ‰ IO æ“ä½œå¯ä»¥è¿›è¡Œæ—¶ï¼Œå°† å¯¹åº”çš„ SelectionKey åŠ å…¥åˆ°å†…éƒ¨é›†åˆä¸­å¹¶è¿”å›ï¼Œå‚æ•°ç”¨æ¥ è®¾ç½®è¶…æ—¶æ—¶é—´ public Set&lt;SelectionKey&gt; selectedKeys();//ä»å†…éƒ¨é›†åˆä¸­å¾— åˆ°æ‰€æœ‰çš„ SelectionKey } 4. æ³¨æ„äº‹é¡¹ NIOä¸­çš„ ServerSocketChannelåŠŸèƒ½ç±»ä¼¼ServerSocketï¼ŒSocketChannelåŠŸèƒ½ç±» ä¼¼Socket selector ç›¸å…³æ–¹æ³•è¯´æ˜ selector.select()//é˜»å¡ selector.select(1000);//é˜»å¡1000æ¯«ç§’ï¼Œåœ¨1000æ¯«ç§’åè¿”å› selector.wakeup();//å”¤é†’ selector selector.selectNow();//ä¸é˜»å¡ï¼Œç«‹é©¬è¿”è¿˜ 3.7. NIO éé˜»å¡ ç½‘ç»œç¼–ç¨‹åŸç†åˆ†æ NIO éé˜»å¡ ç½‘ç»œç¼–ç¨‹ç›¸å…³çš„(Selectorã€SelectionKeyã€ ServerScoketChannelå’ŒSocketChannel) å…³ç³»æ¢³ç†å›¾ è¯´æ˜ï¼š ServerSocketChannel éœ€è¦åœ¨selectoræ³¨å†Œï¼Œä¸€æ—¦æœ‰registeräº‹ä»¶ï¼ˆå®¢æˆ·ç«¯ä¸€æ—¦è¿æ¥ï¼‰å°±ä¼šå»ºç«‹SocketChannel å®¢æˆ·ç«¯è¿æ¥æ—¶éœ€è¦ä¼šé€šè¿‡ServerSocketChannel åœ¨selectoræ³¨å†Œï¼Œä¸€æ—¦æœ‰è¯»å†™äº‹ä»¶ï¼Œåå‘è·å–é€šé“channelï¼ŒæŠŠchannelæ•°æ®è¯»å‡ºåˆ°buffer äº‹ä»¶å‘ç”Ÿé€šè¿‡SelectorKeyæ¥åˆ¤æ–­ ä»£ç æ¼”ç¤ºï¼šserverç«¯ public static void main(String[] args) throws Exception { //æœåŠ¡å™¨ç«¯åˆ›å»ºServerSocketChannel -&gt;ServerSocketChannel ServerSocketChannel serverSocketChannel = ServerSocketChannel.open(); //å¾—åˆ°ä¸€ä¸ªSelectorå¯¹è±¡ Selector selector = Selector.open(); //ç»‘å®šä¸€ä¸ªç«¯å£6666ï¼Œåœ¨æœåŠ¡å™¨ç«¯ç›‘å¬ serverSocketChannel.socket().bind(new InetSocketAddress(6666)); //è®¾ç½®ä¸ºéé˜»å¡ serverSocketChannel.configureBlocking(false); //æŠŠserverSocketChannel æ³¨å†Œåˆ° selector å…³å¿ƒçš„äº‹ä»¶ï¼šop_ACCEPT serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT); //å¾ªç¯ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ while(true){ if(selector.select(1000) == 0){//æ²¡æœ‰äº‹ä»¶å‘ç”Ÿ System.out.println(&quot;æœåŠ¡å™¨ç­‰å¾…1s,æ— è¿æ¥&quot;); continue; } //è¿”å›å¤§äº0ï¼Œè·å–ç›¸å…³çš„selectionKeyé›†åˆ(è·å–åˆ°å…³æ³¨çš„äº‹ä»¶) //selector.selectedKeys() è¿”å›å…³æ³¨çš„äº‹ä»¶é›†åˆ Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys(); //éå†,ä½¿ç”¨è¿­ä»£å™¨ Iterator&lt;SelectionKey&gt; keyIterator = selectionKeys.iterator(); while(keyIterator.hasNext()){ //è·å–åˆ°SelectionKey SelectionKey key = keyIterator.next(); //æ ¹æ®key å¯¹åº”çš„é€šé“å‘ç”Ÿçš„äº‹ä»¶åšç›¸åº”çš„å¤„ç† if(key.isAcceptable()){//å¦‚æœæ˜¯OP_ACCEPT,æœ‰æ–°çš„å®¢æˆ·ç«¯è¿æ¥ //è¯¥å®¢æˆ·ç«¯ç”Ÿæˆä¸€ä¸ªSocketChannel SocketChannel socketChannel = serverSocketChannel.accept(); System.out.println(&quot;å®¢æˆ·ç«¯è¿æ¥æˆåŠŸï¼Œç”Ÿæˆä¸€ä¸ªsocketChannel&quot;); //å°†socketChannelè®¾ç½®ä¸ºéé˜»å¡ï¼Œè¿™æ—¶çº¿ç¨‹å¯ä»¥åšå…¶ä»–äº‹ socketChannel.configureBlocking(false); //å°†socketChannel æ³¨å†Œåˆ°Selectorï¼Œå…³æ³¨OP_READï¼ŒåŒæ—¶ç»™socketChannelå…³è”ä¸€ä¸ªbuffer socketChannel.register(selector,SelectionKey.OP_READ, ByteBuffer.allocate(1024)); } if(key.isReadable()){//å‘ç”ŸOP_READ //é€šè¿‡key åå‘è·å–å¯¹åº”çš„channel SocketChannel channel = (SocketChannel) key.channel(); //è·å–æ”¹channelå…³è”çš„buffer ByteBuffer buffer = (ByteBuffer) key.attachment(); channel.read(buffer); System.out.println(&quot;form client &quot;+ new String(buffer.array())); } //æ‰‹åŠ¨ä»é›†åˆä¸­ç§»åŠ¨å½“å‰çš„selectionKey,é˜²æ­¢é‡å¤æ“ä½œ keyIterator.remove(); } } } clientç«¯ï¼š public static void main(String[] args) throws Exception { //å¾—åˆ°ä¸€ä¸ªç½‘ç»œé€šé“ SocketChannel socketChannel = SocketChannel.open(); //è®¾ç½®éé˜»å¡æ¨¡å¼ socketChannel.configureBlocking(false); //æä¾›æœåŠ¡å™¨ç«¯çš„ipå’Œç«¯å£ InetSocketAddress inetSocketAddress = new InetSocketAddress(&quot;127.0.0.1&quot;,6666); //è¿æ¥æœåŠ¡å™¨ if(!socketChannel.connect(inetSocketAddress)){ while(!socketChannel.finishConnect()){ System.out.println(&quot;è¿æ¥éœ€è¦æ—¶é—´ï¼Œå®¢æˆ·ç«¯ä¸ä¼šé˜»å¡ï¼Œå¯åšå…¶ä»–å·¥ä½œ&quot;); } } //è¿æ¥æˆåŠŸï¼Œå‘é€æ•°æ® String str = &quot;hello,world&quot;; //è·å¾—å­—èŠ‚æ•°ç»„åˆ°bufferä¸­,ä¸”bufferå¤§å°ä¸å­—èŠ‚é•¿åº¦ä¸€è‡´ ByteBuffer buffer = ByteBuffer.wrap(str.getBytes()); //å‘é€æ•°æ®ï¼Œå°†buffer æ•°æ®å†™å…¥channel socketChannel.write(buffer); System.in.read(); } 3.8. SelectionKey SelectionKeyï¼Œè¡¨ç¤º Selector å’Œç½‘ç»œé€šé“çš„æ³¨å†Œå…³ç³»ï¼ˆOPSï¼‰, å…±å››ç§ï¼š int OP_ACCEPTï¼šæœ‰æ–°çš„ç½‘ç»œè¿æ¥å¯ä»¥ acceptï¼Œå€¼ä¸º 16 int OP_CONNECTï¼šä»£è¡¨è¿æ¥å·²ç»å»ºç«‹ï¼Œå€¼ä¸º 8 int OP_READï¼šä»£è¡¨è¯»æ“ä½œï¼Œå€¼ä¸º 1 int OP_WRITEï¼šä»£è¡¨å†™æ“ä½œï¼Œå€¼ä¸º 4 æºç ä¸­ï¼š public static final int OP_READ = 1 &lt;&lt; 0; public static final int OP_WRITE = 1 &lt;&lt; 2; public static final int OP_CONNECT = 1 &lt;&lt; 3; public static final int OP_ACCEPT = 1 &lt;&lt; 4; SelectionKeyç›¸å…³æ–¹æ³• public abstract class SelectionKey { public abstract Selector selector();//å¾—åˆ°ä¸ä¹‹å…³è”çš„ Selector å¯¹è±¡ public abstract SelectableChannel channel();//å¾—åˆ°ä¸ä¹‹å…³ è”çš„é€šé“ public final Object attachment();//å¾—åˆ°ä¸ä¹‹å…³è”çš„å…±äº«æ•° æ® public abstract SelectionKey interestOps(int ops);//è®¾ç½®æˆ–æ”¹ å˜ç›‘å¬äº‹ä»¶ public final boolean isAcceptable();//æ˜¯å¦å¯ä»¥ accept public final boolean isReadable();//æ˜¯å¦å¯ä»¥è¯» public final boolean isWritable();//æ˜¯å¦å¯ä»¥å†™ } 3.9. ServerSocketChannel ServerSocketChannel åœ¨æœåŠ¡å™¨ç«¯ç›‘å¬æ–°çš„å®¢æˆ·ç«¯ Socket è¿æ¥ ç›¸å…³æ–¹æ³•å¦‚ä¸‹: public abstract class ServerSocketChannel extends AbstractSelectableChannel implements NetworkChannel{ public static ServerSocketChannel open()//å¾—åˆ°ä¸€ä¸ª ServerSocketChannel é€šé“ public final ServerSocketChannel bind(SocketAddress local)//è®¾ç½®æœåŠ¡å™¨ç«¯ç«¯å£ å· public final SelectableChannel configureBlocking(boolean block)//è®¾ç½®é˜»å¡æˆ–é é˜»å¡æ¨¡å¼ï¼Œå–å€¼ false è¡¨ç¤ºé‡‡ç”¨éé˜»å¡æ¨¡å¼ public SocketChannel accept()//æ¥å—ä¸€ä¸ªè¿æ¥ï¼Œè¿”å›ä»£è¡¨è¿™ä¸ªè¿æ¥çš„é€šé“å¯¹è±¡ public final SelectionKey register(Selector sel, int ops)//æ³¨å†Œä¸€ä¸ªé€‰æ‹©å™¨å¹¶è®¾ç½® ç›‘å¬äº‹ä»¶ } 3.10. SocketChannel SocketChannelï¼Œç½‘ç»œ IO é€šé“ï¼Œå…·ä½“è´Ÿè´£è¿›è¡Œè¯»å†™æ“ä½œã€‚NIO æŠŠç¼“å†²åŒºçš„æ•°æ®å†™å…¥é€š é“ï¼Œæˆ–è€…æŠŠé€šé“é‡Œçš„æ•°æ®è¯»åˆ°ç¼“å†²åŒºã€‚ ç›¸å…³æ–¹æ³•å¦‚ä¸‹ public abstract class SocketChannel extends AbstractSelectableChannel implements ByteChannel, ScatteringByteChannel, GatheringByteChannel, NetworkChannel{ public static SocketChannel open();//å¾—åˆ°ä¸€ä¸ª SocketChannel é€šé“ public final SelectableChannel configureBlocking(boolean block);//è®¾ç½®é˜»å¡æˆ–éé˜»å¡ æ¨¡å¼ï¼Œå–å€¼ false è¡¨ç¤ºé‡‡ç”¨éé˜»å¡æ¨¡å¼ public boolean connect(SocketAddress remote);//è¿æ¥æœåŠ¡å™¨ public boolean finishConnect();//å¦‚æœä¸Šé¢çš„æ–¹æ³•è¿æ¥å¤±è´¥ï¼Œæ¥ä¸‹æ¥å°±è¦é€šè¿‡è¯¥æ–¹æ³• å®Œæˆè¿æ¥æ“ä½œ public int write(ByteBuffer src);//å¾€é€šé“é‡Œå†™æ•°æ® public int read(ByteBuffer dst);//ä»é€šé“é‡Œè¯»æ•°æ® public final SelectionKey register(Selector sel, int ops, Object att);//æ³¨å†Œä¸€ä¸ªé€‰æ‹©å™¨å¹¶ è®¾ç½®ç›‘å¬äº‹ä»¶ï¼Œæœ€åä¸€ä¸ªå‚æ•°å¯ä»¥è®¾ç½®å…±äº«æ•°æ® public final void close();//å…³é—­é€šé“ } 3.11. NIO ç½‘ç»œç¼–ç¨‹åº”ç”¨å®ä¾‹-ç¾¤èŠç³»ç»Ÿ è¦æ±‚: ç¼–å†™ä¸€ä¸ª NIO ç¾¤èŠç³»ç»Ÿï¼Œå®ç°æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„æ•°æ®ç®€å•é€šè®¯ï¼ˆéé˜»å¡ï¼‰ å®ç°å¤šäººç¾¤èŠ æœåŠ¡å™¨ç«¯ï¼šå¯ä»¥ç›‘æµ‹ç”¨æˆ·ä¸Šçº¿ï¼Œç¦»çº¿ï¼Œ å¹¶å®ç°æ¶ˆæ¯è½¬å‘åŠŸèƒ½ å®¢æˆ·ç«¯ï¼šé€šè¿‡channel å¯ä»¥æ— é˜»å¡å‘é€ æ¶ˆæ¯ç»™å…¶å®ƒæ‰€æœ‰ç”¨æˆ·ï¼ŒåŒæ—¶å¯ä»¥æ¥å— å…¶å®ƒç”¨æˆ·å‘é€çš„æ¶ˆæ¯(æœ‰æœåŠ¡å™¨è½¬å‘å¾—åˆ°) ç›®çš„ï¼šè¿›ä¸€æ­¥ç†è§£NIOéé˜»å¡ç½‘ç»œç¼–ç¨‹ æœºåˆ¶ ä»£ç å®ç°ï¼šæœåŠ¡ç«¯ package com.atguigu.groupchat; import java.io.IOException; import java.net.InetSocketAddress; import java.nio.ByteBuffer; import java.nio.channels.*; import java.util.Iterator; public class GroupChatServer { //å®šä¹‰å±æ€§ private Selector selector; private ServerSocketChannel listenChannel; private static final int PORT = 6667; //æ„é€ å™¨ //åˆå§‹åŒ–å·¥ä½œ public GroupChatServer(){ try { //å¾—åˆ°é€‰æ‹©å™¨ selector = Selector.open(); //å¾—åˆ°ServerSocketChannel listenChannel = ServerSocketChannel.open(); //ç»‘å®šç«¯å£ listenChannel.socket().bind(new InetSocketAddress(PORT)); //è®¾ç½®éé˜»å¡ listenChannel.configureBlocking(false); //listenChannelæ³¨å†Œåˆ°Selector listenChannel.register(selector, SelectionKey.OP_ACCEPT); } catch (IOException e) { e.printStackTrace(); } } //ç›‘å¬ public void listen(){ try { //å¾ªç¯å¤„ç†ç›‘å¬ while(true){ int count = selector.select(); if(count&gt;0){//æœ‰äº‹ä»¶ //éå†å¾—åˆ°selectionKey é›†åˆ Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator(); while(iterator.hasNext()){ //å–å¾—selectionKey SelectionKey key = iterator.next(); if(key.isAcceptable()){//è¿æ¥äº‹ä»¶ SocketChannel socketChannel = listenChannel.accept(); socketChannel.configureBlocking(false); socketChannel.register(selector,SelectionKey.OP_READ); //æç¤ºå®¢æˆ·ä¸Šçº¿ System.out.println(socketChannel.getRemoteAddress()+&quot;ä¸Šçº¿äº†&quot;); } else if(key.isReadable()){//readäº‹ä»¶ readDate(key); } //æ‰‹åŠ¨ä»é›†åˆä¸­ç§»åŠ¨å½“å‰çš„selectionKey,é˜²æ­¢é‡å¤æ“ä½œ iterator.remove(); } } else{ System.out.println(&quot;waiting event&quot;); } } } catch (Exception e) { e.printStackTrace(); }finally { } } //è¯»å–clientæ•°æ® public void readDate(SelectionKey key){ //å®šä¹‰ä¸€ä¸ªSocketChannel SocketChannel socketChannel = null; try { //å–åˆ°å…³è”çš„channel socketChannel = (SocketChannel)key.channel(); //åˆ›å»ºç¼“å­˜ ByteBuffer byteBuffer = ByteBuffer.allocate(1024); int count = socketChannel.read(byteBuffer); if(count&gt;0){ //bufferçš„æ•°æ®è½¬æˆå­—ç¬¦ä¸² String msg = new String(byteBuffer.array()); //è¾“å‡ºmsg System.out.println(&quot;form client&quot;+msg); //å‘å…¶ä»–å®¢æˆ·ç«¯è½¬å‘æ¶ˆæ¯ sendInfoToOtherClient(msg,socketChannel); } } catch (IOException e) { try { System.out.println(socketChannel.getRemoteAddress()+&quot;ç¦»çº¿äº†&quot;); //å–æ¶ˆæ³¨å†Œ key.cancel(); //å…³é—­é€šé“ socketChannel.close(); } catch (IOException ioException) { ioException.printStackTrace(); } } } //è½¬å‘æ¶ˆæ¯ç»™å…¶ä»–æ¶ˆæ¯ private void sendInfoToOtherClient(String msg,SocketChannel self) throws IOException{ //éå†æ‰€æœ‰æ³¨å†Œåˆ°selectorçš„SocketChannel for(SelectionKey key: selector.keys()){ Channel targetChannel = key.channel(); //æ’é™¤è‡ªå·± if(targetChannel != self &amp;&amp; targetChannel instanceof SocketChannel){ //è½¬å‘ SocketChannel dest = (SocketChannel)targetChannel; //å†™å…¥buffer ByteBuffer buffer = ByteBuffer.wrap(msg.getBytes()); //å†™å…¥é€šé“ dest.write(buffer); } } } public static void main(String[] args) { // åˆ›å»ºä¸€ä¸ªæœåŠ¡å™¨å¯¹è±¡ GroupChatServer server = new GroupChatServer(); server.listen(); } } ä»£ç å®ç°ï¼šå®¢æˆ·ç«¯ package com.atguigu.groupchat; import java.io.IOException; import java.net.InetSocketAddress; import java.nio.ByteBuffer; import java.nio.channels.SelectionKey; import java.nio.channels.Selector; import java.nio.channels.SocketChannel; import java.util.Iterator; import java.util.Scanner; public class GroupChatClient { // å®šä¹‰ç›¸å…³å±æ€§ // æœåŠ¡å™¨çš„IP private final String HOST = &quot;127.0.0.1&quot;; // æœåŠ¡å™¨çš„ç«¯å£ private final int PORT = 6667; private Selector selector; private SocketChannel socketChannel; private String username; // æ„é€ å™¨ public GroupChatClient() throws IOException { // å®Œæˆåˆå§‹åŒ– selector = Selector.open(); // è¿æ¥æœåŠ¡å™¨ socketChannel = SocketChannel.open(new InetSocketAddress(HOST, PORT)); // è®¾ç½® éé˜»å¡ socketChannel.configureBlocking(false); // å°† socketChannel æ³¨å†Œåˆ° Selector socketChannel.register(selector, SelectionKey.OP_READ); // å¾—åˆ° username username = socketChannel.getLocalAddress().toString().substring(1); System.out.println(username + &quot;is OK!&quot;); } // å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯ public void sendMessage(String message){ message = username + &quot;è¯´ï¼š&quot;+ message; try { // æŠŠ message å†™å…¥ buffer socketChannel.write(ByteBuffer.wrap(message.getBytes())); // è¯»å–ä»æœåŠ¡å™¨ç«¯å›å¤çš„æ¶ˆæ¯ }catch (Exception e){ e.printStackTrace(); }finally { } } public void readmessage(){ try { int select = selector.select(); if (select &gt; 0){ // æœ‰äº‹ä»¶å‘ç”Ÿçš„é€šé“ Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator(); while (iterator.hasNext()){ SelectionKey key = iterator.next(); if (key.isReadable()){ // å¾—åˆ°ç›¸å…³çš„é€šé“ SocketChannel channel = (SocketChannel) key.channel(); ByteBuffer buffer = ByteBuffer.allocate(1024); channel.read(buffer); String msg = new String(buffer.array()); System.out.println(msg.trim()); } } iterator.remove();//åˆ é™¤å½“å‰çš„selectionKey }else { // System.out.println(&quot;æ²¡æœ‰å¯ç”¨çš„é€šé“&quot;); } }catch (Exception e){ e.printStackTrace(); }finally { } } public static void main(String[] args) throws IOException { // å¯åŠ¨å®¢æˆ·ç«¯ GroupChatClient client = new GroupChatClient(); // å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹,æ¯ä¸ªä¸‰ç§’è¯»å–ä»æœåŠ¡å™¨ç«¯è¯»å–æ•°æ® new Thread(){ public void run(){ while (true){ client.readmessage(); try { Thread.sleep(3000); }catch (Exception e){ e.printStackTrace(); } } } }.start(); // å‘é€æ•°æ®ç»™æœåŠ¡ç«¯ Scanner scanner = new Scanner(System.in); while (scanner.hasNextLine()){ String line = scanner.nextLine(); client.sendMessage(line); } } } ","link":"https://tianxiawuhao.github.io/X2beO2j1l/"},{"title":"å‰ç«¯ç®€å•éƒ¨ç½²","content":"éƒ¨ç½²å‰ç«¯é¡¹ç›®ï¼Œå°†æ‰“åŒ…åçš„æ–‡ä»¶distæ”¾å…¥nginxï¼ŒåŸºäºnginxçš„åŸºç¡€é•œåƒåˆ›å»ºå‰ç«¯é¡¹ç›®çš„dockeré•œåƒå³å¯ ä¸€ã€å‰ç«¯é¡¹ç›®çš„æ–‡ä»¶å‡†å¤‡ 1ã€æ–‡ä»¶å‡†å¤‡ï¼š 1,dockerfile(dockeréƒ¨ç½²é•œåƒæ‰“åŒ…æ–‡ä»¶) 2,dist(å¾…éƒ¨ç½²å‰ç«¯æ–‡ä»¶å¤¹) 3,default.conf 2ã€Dockerfileæ–‡ä»¶ï¼š FROM nginx RUN rm /etc/nginx/conf.d/default.conf ADD default.conf /etc/nginx/conf.d/ COPY dist/ /usr/share/nginx/html/ EXPOSE 80 3ã€default.confï¼š server { listen 80; server_name localhost; # ä¿®æ”¹ä¸ºdockeræœåŠ¡å®¿ä¸»æœºçš„ip location / { root /usr/share/nginx/html; index index.html index.htm; try_files $uri $uri/ /index.html =404; } error_page 500 502 503 504 /50x.html; location = /50x.html { root html; } location /api/ { proxy_pass http://åç«¯æœåŠ¡å:IPç«¯å£; } } äºŒã€vueé¡¹ç›®çš„è‡ªåŠ¨åŒ–éƒ¨ç½² 1ã€å®‰è£…Jenkins Jenkinsçš„å®‰è£…ï¼šhttps://tinaxiawuhao.github.io/post/MN_sOyfo3/ 2ã€å®‰è£…node/npm/yarn å®‰è£…nodeä¸node/npm/yarnï¼šhttps://tinaxiawuhao.github.io/post/XMNtsw8ig/ 3ã€Jenkinsä¸­é…ç½®harborä»“åº“çš„å¯†é’¥ æˆ‘ä»¬éœ€è¦é€šè¿‡jenkinsfileæ–‡ä»¶æ¨é€dockeré•œåƒåˆ°æŒ‡å®šçš„harborä»“åº“ï¼Œéœ€è¦åœ¨jenkinsä¸­é…ç½®ä»“åº“ç™»å½•å‡­æ® 4ã€ç¼–å†™Jenkinsfile pipeline{ agent any environment { WS = &quot;${WORKSPACE}&quot; HARBOR_URL=&quot;harborçš„url&quot; HARBOR_ID=&quot;harborå¯†é’¥&quot; } stages { stage(&quot;ç¯å¢ƒæ£€æŸ¥&quot;){ steps { sh 'docker version' sh 'npm -v' sh 'yarn -v' } } stage('yarnå®‰è£…ä¸ç¼–è¯‘') { steps { sh &quot;echo ${WS} &amp;&amp; ls -alh&quot; sh &quot;cd ${WS} &amp;&amp; yarn install&quot; sh &quot;cd ${WS} &amp;&amp; yarn build:hd&quot; } } stage('dockeré•œåƒä¸æ¨é€') { steps { sh &quot;cd ${WS} &amp;&amp; docker build -f Dockerfile -t ${HARBOR_URL}/test/web:latest .&quot; withCredentials([usernamePassword(credentialsId: &quot;${HARBOR_ID}&quot;, passwordVariable: 'password', usernameVariable: 'username')]) { sh &quot;docker login -u ${username} -p ${password} ${HARBOR_URL}&quot; sh &quot;docker push ${HARBOR_URL}/test/web:latest&quot; } } } } post { success { echo 'success!' } failure { echo 'failed...' } } } harborå¯†é’¥è·å– ç‚¹è¿›å…¥åˆšæ‰æ·»åŠ çš„å‡­è¯è·å–å‡­è¯ æœ€ååˆ›å»ºä¸€ä¸ªpipelineé¡¹ç›®ï¼ˆå¯é€‰æ‹©Pipelineæˆ–è€…å¤šåˆ†æ”¯æµæ°´çº¿ï¼‰ï¼Œpipelineè„šæœ¬å®šä¹‰é€‰æ‹©Pipeline script from SCMï¼Œé€‰æ‹©gité¡¹ç›® ä¿®æ”¹å…³æ³¨åˆ†æ”¯ ä¸‰ã€æ¨¡ä»¿åç«¯å®ç°ç¯å¢ƒå˜é‡æ³¨å…¥ å€ŸåŠ©Nginx1.19ä»¥ådockeré•œåƒçš„templateæ–°åŠŸèƒ½ï¼Œå¯ä»¥å®ç°é…ç½®æ–‡ä»¶ç¯å¢ƒå˜é‡çš„åŠ¨æ€æ³¨å…¥ 1ã€å‡†å¤‡ default.conf.templateï¼š server { listen 80; listen [::]:80; server_name localhost; # ä¿®æ”¹ä¸ºdockeræœåŠ¡å®¿ä¸»æœºçš„ip location / { root /usr/share/nginx/html; index index.html index.htm; ssi on; try_files $uri $uri/ /index.html; if ($request_filename ~* ^.*?\\.(eot)|(ttf)|(woff)|(svg)|(otf)$) { add_header Access-Control-Allow-Origin *; } } error_page 500 502 503 504 /50x.html; location = /50x.html { root /usr/share/nginx/html; } location /api/ { ssi on; # å€ŸåŠ©ssi proxy_pass ${BACKEND_SERVICE_URL}; } } 2ã€ç¼–å†™Dockerfileæ–‡ä»¶ï¼š FROM nginx:1.21 COPY dist /usr/share/nginx/html # æ³¨æ„å’Œä¸Šé¢æ–‡ä»¶å¯¹æ¯”ä½ç½®çš„æ”¹å˜ COPY default.conf.template /etc/nginx/templates/ EXPOSE 80 3ã€è®¾ç½®ç¯å¢ƒå˜é‡ éƒ¨ç½²dockeræ—¶å€™ï¼Œè®¾ç½®ç¯å¢ƒå˜é‡-e BACKEND_SERVICE_URL= http://ip:port åï¼Œå®é™…çš„nginxé…ç½®å°±å˜ä¸ºäº†ï¼š $BACKEND_SERVICE_URL = http://ip:port #åç«¯æœåŠ¡çš„åœ°å€ï¼› server { listen 80; listen [::]:80; server_name localhost; # ä¿®æ”¹ä¸ºdockeræœåŠ¡å®¿ä¸»æœºçš„ip location / { root /usr/share/nginx/html; index index.html index.htm; ssi on; try_files $uri $uri/ /index.html; if ($request_filename ~* ^.*?\\.(eot)|(ttf)|(woff)|(svg)|(otf)$) { add_header Access-Control-Allow-Origin *; } } error_page 500 502 503 504 /50x.html; location = /50x.html { root /usr/share/nginx/html; } location /api/ { ssi on; # å€ŸåŠ©ssi proxy_pass http://ip:port; } } åˆ‡æ¢æœåŠ¡å°±å¯ä»¥ä¿®æ”¹ç¯å¢ƒå˜é‡ï¼Œåˆ‡æ¢ä¸åŒçš„æœåŠ¡åç«¯ ","link":"https://tianxiawuhao.github.io/KEyilqyTn/"},{"title":"gitlabæäº¤ä»£ç è‡ªåŠ¨è§¦å‘Jenkinsæ„å»ºæ“ä½œ","content":"Jenkinsé…ç½® æ’ä»¶å®‰è£… ç³»ç»Ÿç®¡ç†=====ã€‹æ’ä»¶ç®¡ç†=====ã€‹å¯é€‰æ’ä»¶=====ã€‹æœç´¢è¦æŒ‰ç…§çš„æ’ä»¶(gitlab hook-pluginå’Œgitlab-plugin) å¦‚æœæ‰¾ä¸åˆ°ä¸Šé¢ä¸¤ä¸ªæ’ä»¶ï¼Œå®‰è£…gitlabå’Œgitlab hookå³å¯ åˆ›å»ºæµ‹è¯•é¡¹ç›® gitlabé…ç½® æ‰“å¼€è¦å…³è”Jenkinsé¡¹ç›®çš„è®¾ç½®é€‰é¡¹æ‰¾åˆ°webhooksé€‰é¡¹ï¼ŒæŠŠJenkinsä¸­çš„é¡¹ç›®è§¦å‘å™¨urlä»¥åŠSecret tokené…ç½®åˆ°gitlabçš„webhooksé€‰é¡¹ä¸­ URL Secret token éªŒè¯æ•ˆæœ æˆ‘ä»¬æµ‹è¯•ä¸‹ç‚¹å‡»åˆšåˆšå…³è”çš„æ„å»ºåŠ¨ä½œï¼ŒJenkinsä¼šä¸ä¼šè‡ªåŠ¨æ„å»º å½“å‡ºç°è¯·æ±‚çŠ¶æ€ç 200çš„æ—¶å€™è¯æ˜æˆ‘ä»¬çš„å…³è”åŠ¨ä½œå·²ç»æ‰§è¡Œ ä¸‹é¢æˆ‘ä»¬å»åˆ°Jenkinsä¸­çœ‹ä¸‹æ˜¯å¦æœ‰æ„å»ºå†å² å†è¯•ä¸‹æ‰‹åŠ¨pushä»£ç åˆ°gitlabä¼šä¸ä¼šè§¦å‘Jenkinsçš„æ„å»ºä»»åŠ¡ æ‰‹åŠ¨å»åˆ°æœåŠ¡å™¨ä¸Šå‘è¿œç¨‹gitlabåˆ†æ”¯æ¨é€æ–‡ä»¶ ","link":"https://tianxiawuhao.github.io/ymh_BwIfn/"},{"title":"linuxå®‰è£…node","content":"ä»¥å½“å‰nodeç‰ˆæœ¬16.13.0ä¸ºä¾‹ï¼Œæ–°å»ºæ¼”ç¤ºç›®å½•/usr/local/node 1ã€ä¸‹è½½ wget https://nodejs.org/dist/v16.13.0/node-v16.13.0-linux-x64.tar.xz 2ã€ç§»åŠ¨åˆ°æŒ‡å®šç›®å½• mv node-v16.13.0-linux-x64.tar.xz /usr/local/node 3ã€è§£å‹ xz -d node-v16.13.0-linux-x64.tar.xz tar -xvf node-v16.13.0-linux-x64.tar æµ‹è¯•ä¸‹ï¼š /root/sdemo/node-v16.13.0-linux-x64/bin/node -v v16.13.0 /root/sdemo/node-v16.13.0-linux-x64/bin/npm -v 8.1.0 4ã€è®¾ç½®è½¯è¿æ¥ï¼Œç›¸å½“äºwindowsè®¾ç½®ç¯å¢ƒå˜é‡ ln -s /usr/local/node/node-v16.13.0-linux-x64/bin/node /usr/bin/node ln -s /usr/local/node/node-v16.13.0-linux-x64/bin/npm /usr/bin/npm 5ã€å®‰è£…yarn,å¹¶è®¾ç½®yarnçš„è½¯è¿ npm install yarn -g ln -s /usr/local/node/node-v16.13.0-linux-x64/bin/yarn /usr/bin/yarn æµ‹è¯•ä¸‹ï¼š yarn -v 1.22.17 6ã€å®‰è£…cnpm npm install -g cnpm --registry=https://registry.npm.taobao.org ln -s /usr/local/node/lib/node-v16.13.0-linux-x64/bin/cnpm /usr/bin/cnpm ","link":"https://tianxiawuhao.github.io/XMNtsw8ig/"},{"title":"linuxå®‰è£…jenkins","content":"1ã€å®‰è£…JDK yum install -y java 2ã€å®‰è£…jenkins æ·»åŠ Jenkinsåº“åˆ°yumåº“ï¼ŒJenkinså°†ä»è¿™é‡Œä¸‹è½½å®‰è£…ã€‚ wget -O /etc/yum.repos.d/jenkins.repo http://pkg.jenkins-ci.org/redhat/jenkins.repo rpm --import https://jenkins-ci.org/redhat/jenkins-ci.org.key yum install -y jenkins æˆ– yum install jenkins -y --nogpgcheck 3ã€ä¿®æ”¹jenkinsç«¯å£ [root@tools ~]# rpm -qa | grep jenkins jenkins-2.340-1.1.noarch [root@tools ~]# rpm -ql jenkins-2.340-1.1.noarch /etc/init.d/jenkins /etc/logrotate.d/jenkins /etc/sysconfig/jenkins /usr/bin/jenkins /usr/lib/systemd/system/jenkins.service /usr/sbin/rcjenkins /usr/share/java/jenkins.war /usr/share/jenkins /usr/share/jenkins/migrate /var/cache/jenkins /var/lib/jenkins /var/log/jenkins [root@tools ~]# vim /usr/lib/systemd/system/jenkins.service vi /etc/sysconfig/jenkins æ‰¾åˆ°ä¿®æ”¹ç«¯å£å·ï¼š JENKINS_PORT=â€œ9000â€ #æ­¤ç«¯å£ä¸å†²çªå¯ä»¥ä¸ä¿®æ”¹ 4ã€å¯åŠ¨jenkins systemctl start jenkins.service [root@tools ~]# netstat -nultp å®‰è£…æˆåŠŸåJenkinså°†ä½œä¸ºä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹éšç³»ç»Ÿå¯åŠ¨ ç³»ç»Ÿä¼šåˆ›å»ºä¸€ä¸ªâ€œjenkinsâ€ç”¨æˆ·æ¥å…è®¸è¿™ä¸ªæœåŠ¡ï¼Œå¦‚æœæ”¹å˜æœåŠ¡æ‰€æœ‰è€…ï¼ŒåŒæ—¶éœ€è¦ä¿®æ”¹/var/log/jenkins, /var/lib/jenkins, å’Œ/var/cache/jenkinsçš„æ‰€æœ‰è€… å¯åŠ¨çš„æ—¶å€™å°†ä»/etc/sysconfig/jenkinsè·å–é…ç½®å‚æ•° é»˜è®¤æƒ…å†µä¸‹ï¼ŒJenkinsè¿è¡Œåœ¨8080ç«¯å£ï¼Œåœ¨æµè§ˆå™¨ä¸­ç›´æ¥è®¿é—®è¯¥ç«¯è¿›è¡ŒæœåŠ¡é…ç½® Jenkinsçš„RPMä»“åº“é…ç½®è¢«åŠ åˆ°/etc/yum.repos.d/jenkins.repo 5ã€æ‰“å¼€jenkins åœ¨æµè§ˆå™¨ä¸­è®¿é—® http://192.168.3.200:9000/ é¦–æ¬¡è¿›å…¥ä¼šè¦æ±‚è¾“å…¥åˆå§‹å¯†ç  åˆå§‹å¯†ç åœ¨ï¼š/var/lib/jenkins/secrets/initialAdminPassword é‡ç½®å¯†ç ï¼šadmin/admin ","link":"https://tianxiawuhao.github.io/MN_sOyfo3/"},{"title":"k8sé«˜å¯ç”¨é›†ç¾¤æ­å»º","content":"æ•´ä½“ç¯å¢ƒ 3å°masterèŠ‚ç‚¹ï¼Œ3å°nodeèŠ‚ç‚¹ã€‚é‡‡ç”¨äº†Centos 7ï¼Œæœ‰ç½‘ç»œï¼Œäº’ç›¸å¯ä»¥pingé€šã€‚ å‡†å¤‡å·¥ä½œæŸ¥çœ‹å•é›†ç¾¤éƒ¨ç½² 1.å®‰è£…keepalived å’Œ haproxy 1.1å®‰è£…keepalivedå’Œ haproxy 1yum install keepalived haproxy -y 1.2 é…ç½® keepalived cat &lt;&lt;EOF &gt; /etc/keepalived/keepalived.conf ! Configuration File for keepalived global_defs { router_id k8s } vrrp_script check_haproxy { script &quot;/bin/bash -c 'if [[ $(netstat -nlp | grep 16443) ]]; then exit 0; else exit 1; fi'&quot; interval 3 weight -2 fall 10 rise 2 } vrrp_instance VI_1 { state MASTER interface ens33 virtual_router_id 51 priority 250 advert_int 1 authentication { auth_type PASS auth_pass ceb1b3ec013d66163d6ab } virtual_ipaddress { 192.168.40.19 } track_script { check_haproxy } } EOF cat &lt;&lt;EOF &gt; /etc/keepalived/keepalived.conf ! Configuration File for keepalived global_defs { router_id k8s } vrrp_script check_haproxy { script &quot;/bin/bash -c 'if [[ $(netstat -nlp | grep 16443) ]]; then exit 0; else exit 1; fi'&quot; interval 3 weight -2 fall 10 rise 2 } vrrp_instance VI_1 { state BACKUP interface ens33 virtual_router_id 51 priority 150 advert_int 1 authentication { auth_type PASS auth_pass ceb1b3ec013d66163d6ab } virtual_ipaddress { 192.168.40.19 } track_script { check_haproxy } } EOF cat &lt;&lt;EOF &gt; /etc/keepalived/keepalived.conf ! Configuration File for keepalived global_defs { router_id k8s } vrrp_script check_haproxy { script &quot;/bin/bash -c 'if [[ $(netstat -nlp | grep 16443) ]]; then exit 0; else exit 1; fi'&quot; interval 3 weight -2 fall 10 rise 2 } vrrp_instance VI_1 { state BACKUP interface ens33 virtual_router_id 51 priority 200 advert_int 1 authentication { auth_type PASS auth_pass ceb1b3ec013d66163d6ab } virtual_ipaddress { 192.168.40.19 } track_script { check_haproxy } } EOF vrrp_script ç”¨äºæ£€æµ‹ haproxy æ˜¯å¦æ­£å¸¸ã€‚å¦‚æœæœ¬æœºçš„ haproxy æŒ‚æ‰ï¼Œå³ä½¿ keepalived åŠ«æŒvipï¼Œä¹Ÿæ— æ³•å°†æµé‡è´Ÿè½½åˆ° apiserverã€‚ æˆ‘æ‰€æŸ¥é˜…çš„ç½‘ç»œæ•™ç¨‹å…¨éƒ¨ä¸ºæ£€æµ‹è¿›ç¨‹, ç±»ä¼¼ killall -0 haproxyã€‚è¿™ç§æ–¹å¼ç”¨åœ¨ä¸»æœºéƒ¨ç½²ä¸Šå¯ä»¥ï¼Œä½†å®¹å™¨éƒ¨ç½²æ—¶ï¼Œåœ¨ keepalived å®¹å™¨ä¸­æ— æ³•çŸ¥é“å¦ä¸€ä¸ªå®¹å™¨ haproxy çš„æ´»è·ƒæƒ…å†µï¼Œå› æ­¤æˆ‘åœ¨æ­¤å¤„é€šè¿‡æ£€æµ‹ç«¯å£å·æ¥åˆ¤æ–­ haproxy çš„å¥åº·çŠ¶å†µã€‚ weight å¯æ­£å¯è´Ÿã€‚ä¸ºæ­£æ—¶æ£€æµ‹æˆåŠŸ +weightï¼Œç›¸å½“ä¸èŠ‚ç‚¹æ£€æµ‹å¤±è´¥æ—¶æœ¬èº« priority ä¸å˜ï¼Œä½†å…¶ä»–æ£€æµ‹æˆåŠŸèŠ‚ç‚¹ priority å¢åŠ ã€‚ä¸ºè´Ÿæ—¶æ£€æµ‹å¤±è´¥æœ¬èº« priority å‡å°‘ã€‚ å¦å¤–å¾ˆå¤šæ–‡ç« ä¸­æ²¡æœ‰å¼ºè°ƒ nopreempt å‚æ•°ï¼Œæ„ä¸ºä¸å¯æŠ¢å ï¼Œæ­¤æ—¶ master èŠ‚ç‚¹å¤±è´¥åï¼Œbackup èŠ‚ç‚¹ä¹Ÿä¸èƒ½æ¥ç®¡ vipï¼Œå› æ­¤æˆ‘å°†æ­¤é…ç½®åˆ å» 1.3 é…ç½®haproxy cat &lt;&lt;EOF &gt; /etc/haproxy/haproxy.cfg #--------------------------------------------------------------------- # Global settings #--------------------------------------------------------------------- global # to have these messages end up in /var/log/haproxy.log you will # need to: # 1) configure syslog to accept network log events. This is done # by adding the '-r' option to the SYSLOGD_OPTIONS in # /etc/sysconfig/syslog # 2) configure local2 events to go to the /var/log/haproxy.log # file. A line like the following can be added to # /etc/sysconfig/syslog # # local2.* /var/log/haproxy.log # log 127.0.0.1 local0 chroot /var/lib/haproxy pidfile /var/run/haproxy.pid maxconn 4000 user haproxy group haproxy daemon # turn on stats unix socket stats socket /var/lib/haproxy/stats #--------------------------------------------------------------------- # common defaults that all the 'listen' and 'backend' sections will # use if not designated in their block #--------------------------------------------------------------------- defaults mode http log global option httplog option dontlognull option http-server-close option forwardfor except 127.0.0.0/8 option redispatch retries 3 timeout http-request 10s timeout queue 1m timeout connect 10s timeout client 1m timeout server 1m timeout http-keep-alive 10s timeout check 10s maxconn 3000 #--------------------------------------------------------------------- # kubernetes apiserver frontend which proxys to the backends #--------------------------------------------------------------------- frontend kubernetes-apiserver mode tcp bind *:16443 option tcplog default_backend kubernetes-apiserver #--------------------------------------------------------------------- # round robin balancing between the various backends #--------------------------------------------------------------------- backend kubernetes-apiserver mode tcp balance roundrobin server gk8s-master 192.168.40.20:6443 check server gk8s-master2 192.168.40.21:6443 check server gk8s-master3 192.168.40.22:6443 check #--------------------------------------------------------------------- # collection haproxy statistics message #--------------------------------------------------------------------- listen stats bind *:1080 stats auth admin:awesomePassword stats refresh 5s stats realm HAProxy\\ Statistics stats uri /admin?stats EOF è®¾ç½®å¼€æœºå¯åŠ¨ systemctl enable haproxy &amp;&amp; systemctl start haproxy systemctl enable keepalived &amp;&amp; systemctl start keepalived 2.å®‰è£…kubeadmã€kubeletã€kubectl 1.é…ç½®æ–‡ä»¶ä¿®æ”¹ cat &lt;&lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo [kubernetes] name=Kubernetes baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64 enabled=1 gpgcheck=0 repo_gpgcheck=0 gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg EOF 2.å®‰è£…å¯ç”¨ sudo yum install -y kubelet-1.24.1 kubeadm-1.24.1 kubectl-1.24.1 --disableexcludes=kubernetes sudo systemctl enable kubelet &amp;&amp; systemctl start kubelet 3.ä¿®æ”¹kubeletçš„é…ç½®æ–‡ä»¶ å…ˆæŸ¥çœ‹é…ç½®æ–‡ä»¶ä½ç½® systemctl status kubelet vi /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹(ä½¿ç”¨å’Œdockerç›¸åŒçš„cgroup-driver)ã€‚ Environment=&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --cgroup-driver=systemd&quot; 4.é‡å¯kubelet systemctl daemon-reload &amp;&amp; systemctl restart kubelet 3.è·å–K8Sé•œåƒï¼ˆå¯å¿½ç•¥ï¼‰ 1.è·å–é•œåƒåˆ—è¡¨ ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒä»“åº“ä¸‹è½½ï¼ˆå›½å†…ç¯å¢ƒè¯¥å‘½ä»¤å¯ä¸æ‰§è¡Œï¼Œä¸‹æ­¥éª¤kubeadm init --image-repository registry.cn-hangzhou.aliyuncs.com/google_containerså·²ç»é»˜è®¤ä¸ºå›½å†…ç¯å¢ƒï¼‰ ç”±äºå®˜æ–¹é•œåƒåœ°å€è¢«å¢™ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é¦–å…ˆè·å–æ‰€éœ€é•œåƒä»¥åŠå®ƒä»¬çš„ç‰ˆæœ¬ã€‚ç„¶åä»å›½å†…é•œåƒç«™è·å–ã€‚ kubeadm config images list è·å–é•œåƒåˆ—è¡¨åå¯ä»¥é€šè¿‡ä¸‹é¢çš„è„šæœ¬ä»é˜¿é‡Œäº‘è·å–ï¼š vi /usr/local/k8s/k8s-images.sh ä¸‹é¢çš„é•œåƒåº”è¯¥å»é™¤&quot;k8s.gcr.io/&quot;çš„å‰ç¼€ï¼Œç‰ˆæœ¬æ¢æˆä¸Šé¢è·å–åˆ°çš„ç‰ˆæœ¬ images=( kube-apiserver:v1.24.1 kube-controller-manager:v1.24.1 kube-scheduler:v1.24.1 kube-proxy:v1.24.1 pause:3.7 etcd:3.5.3-0 coredns:v1.8.6 ) for imageName in ${images[@]} ; do docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName k8s.gcr.io/$imageName docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName done 2.èµ‹æƒæ‰§è¡Œ chmod +x k8s-images.sh &amp;&amp; ./k8s-images.sh ä»¥ä¸Šæ“ä½œåœ¨æ‰€æœ‰æœºå™¨æ‰§è¡Œ 4.åˆå§‹åŒ–ç¯å¢ƒï¼ˆmasteræ“ä½œï¼‰ 1.å®‰è£…é•œåƒ é‡‡ç”¨æ¨¡æ¿é…ç½®æ–‡ä»¶åŠ è½½ kubeadm config print init-defaults &gt; kubeadm-config.yaml # æ¨¡æ¿éšç‰ˆæœ¬æ›´æ–° [root@master1 ~]# cat kubeadm-config.yaml apiVersion: kubeadm.k8s.io/v1beta2 bootstrapTokens: - groups: - system:bootstrappers:kubeadm:default-node-token token: abcdef.0123456789abcdef ttl: 24h0m0s usages: - signing - authentication kind: InitConfiguration localAPIEndpoint: advertiseAddress: 192.168.40.131 # æœ¬æœºIP bindPort: 6443 nodeRegistration: criSocket: unix:///var/run/cri-docker.sock # æ­¤å¤„åƒä¸‡ä¸è¦å¿˜è®°ä¿®æ”¹ï¼Œå¦‚æœä¸ä¿®æ”¹ç­‰äºæ²¡æœ‰æ›¿æ¢ã€‚(æ­¤å¤„å·²ç»æ›´æ”¹å®Œäº†) #criSocket: unix:///run/containerd/containerd.sock # æ­¤å¤„åƒä¸‡ä¸è¦å¿˜è®°ä¿®æ”¹ï¼Œå¦‚æœä¸ä¿®æ”¹ç­‰äºæ²¡æœ‰æ›¿æ¢ã€‚(æ­¤å¤„å·²ç»æ›´æ”¹å®Œäº†) name: master1 # æœ¬ä¸»æœºå taints: - effect: NoSchedule key: node-role.kubernetes.io/master --- apiServer: certSANs: - k8s-master-01 - k8s-master-02 - k8s-master-03 - master.k8s.io - 192.168.40.19 - 192.168.40.20 - 192.168.40.21 - 192.168.40.22 - 127.0.0.1 extraArgs: authorization-mode: Node,RBAC timeoutForControlPlane: 4m0s apiVersion: kubeadm.k8s.io/v1beta2 certificatesDir: /etc/kubernetes/pki clusterName: kubernetes controlPlaneEndpoint: &quot;192.168.40.19:16443&quot; # è™šæ‹ŸIPå’Œhaproxyç«¯å£ controllerManager: {} dns: type: CoreDNS etcd: local: dataDir: /var/lib/etcd imageRepository: registry.aliyuncs.com/google_containers # é•œåƒä»“åº“æºè¦æ ¹æ®è‡ªå·±å®é™…æƒ…å†µä¿®æ”¹ kind: ClusterConfiguration kubernetesVersion: v1.24.1 # k8sç‰ˆæœ¬ networking: dnsDomain: cluster.local podSubnet: &quot;10.244.0.0/16&quot; #è®¾ç½®ç½‘æ®µï¼Œå’Œä¸‹é¢ç½‘ç»œæ’ä»¶å¯¹åº” serviceSubnet: 10.96.0.0/12 scheduler: {} --- apiVersion: kubeproxy.config.k8s.io/v1alpha1 kind: KubeProxyConfiguration featureGates: SupportIPVSProxyMode: true mode: ipvs 2.æŸ¥çœ‹kubeadmç‰ˆæœ¬ï¼Œä¿®æ”¹å‘½ä»¤å‚æ•° kubeadm version è¿™ä¸ªå°±å¾ˆç®€å•äº†ï¼Œåªéœ€è¦ç®€å•çš„ä¸€ä¸ªå‘½ä»¤ï¼š #ç›´æ¥ä½¿ç”¨å·²ç»ä¸‹è½½å¥½çš„é•œåƒ kubeadm init --kubernetes-version=v1.24.1 --control-plane-endpoint &quot;192.168.40.19:16443&quot; --apiserver-advertise-address=192.168.40.20 --pod-network-cidr=10.244.0.0/16 --service-cidr=10.96.0.0/12 --ignore-preflight-errors=Swap --cri-socket unix:///var/run/cri-docker.sock | tee kubeadm-init.log #æˆ–è€…é‡‡ç”¨aliyuncsé•œåƒä¸‹è½½ kubeadm init --kubernetes-version=v1.24.1 --control-plane-endpoint &quot;192.168.40.19:16443&quot; --apiserver-advertise-address=192.168.40.20 --image-repository registry.aliyuncs.com/google_containers --service-cidr=10.1.0.0/16 --pod-network-cidr=10.244.0.0/16 --cri-socket unix:///var/run/cri-docker.sock| tee kubeadm-init.log #ä½¿ç”¨ä¸Šé¢ç³»ç»Ÿç”Ÿæˆé…ç½®æ–‡ä»¶åŠ è½½ kubeadm init --config kubeadm-config.yaml 3.åˆå§‹åŒ–å‘½ä»¤è¯´æ˜ï¼š è™šæ‹ŸipèŠ‚ç‚¹ç«¯å£å· --control-plane-endpoint æŒ‡æ˜ç”¨ Master çš„å“ªä¸ª interface ä¸ Cluster çš„å…¶ä»–èŠ‚ç‚¹é€šä¿¡ã€‚å¦‚æœ Master æœ‰å¤šä¸ª interfaceï¼Œå»ºè®®æ˜ç¡®æŒ‡å®šï¼Œå¦‚æœä¸æŒ‡å®šï¼Œkubeadm ä¼šè‡ªåŠ¨é€‰æ‹©æœ‰é»˜è®¤ç½‘å…³çš„ interfaceã€‚ --apiserver-advertise-address æŒ‡å®š Pod ç½‘ç»œçš„èŒƒå›´ã€‚Kubernetes æ”¯æŒå¤šç§ç½‘ç»œæ–¹æ¡ˆï¼Œè€Œä¸”ä¸åŒç½‘ç»œæ–¹æ¡ˆå¯¹ --pod-network-cidr æœ‰è‡ªå·±çš„è¦æ±‚ï¼Œè¿™é‡Œè®¾ç½®ä¸º 10.244.0.0/16 æ˜¯å› ä¸ºæˆ‘ä»¬å°†ä½¿ç”¨ flannel ç½‘ç»œæ–¹æ¡ˆï¼Œå¿…é¡»è®¾ç½®æˆè¿™ä¸ª CIDRã€‚ --pod-network-cidr Kubenetesé»˜è®¤Registriesåœ°å€æ˜¯ k8s.gcr.ioï¼Œåœ¨å›½å†…å¹¶ä¸èƒ½è®¿é—® gcr.ioï¼Œåœ¨1.19.3ç‰ˆæœ¬ä¸­æˆ‘ä»¬å¯ä»¥å¢åŠ â€“image-repositoryå‚æ•°ï¼Œé»˜è®¤å€¼æ˜¯ k8s.gcr.ioï¼Œå°†å…¶æŒ‡å®šä¸ºé˜¿é‡Œäº‘é•œåƒåœ°å€ï¼šregistry.aliyuncs.com/google_containersã€‚ --image-repository å…³é—­ç‰ˆæœ¬æ¢æµ‹ï¼Œå› ä¸ºå®ƒçš„é»˜è®¤å€¼æ˜¯stable-1ï¼Œä¼šå¯¼è‡´ä»https://dl.k8s.io/release/stable-1.txtä¸‹è½½æœ€æ–°çš„ç‰ˆæœ¬å·ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶æŒ‡å®šä¸ºå›ºå®šç‰ˆæœ¬ï¼ˆæœ€æ–°ç‰ˆï¼šv1.24.1ï¼‰æ¥è·³è¿‡ç½‘ç»œè¯·æ±‚ã€‚ --kubernetes-version=v1.24.1 æŒ‡å®šå¯åŠ¨æ—¶ä½¿ç”¨cri-dockerè°ƒç”¨docker --cri-socket unix:///var/run/cri-docker.sock 4.é”™è¯¯å¯åŠ¨é‡ç½® # é‡ç½® å¦‚æœæœ‰éœ€è¦ kubeadm reset --cri-socket unix:///var/run/cri-docker.sock 5.åˆå§‹åŒ–æˆåŠŸåï¼Œä¸ºé¡ºåˆ©ä½¿ç”¨kubectlï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config 6.æ·»åŠ å…¶ä»–ä¸»èŠ‚ç‚¹ 1.å¤åˆ¶å¯†é’¥åŠç›¸å…³æ–‡ä»¶ ssh root@192.168.40.21 mkdir -p /etc/kubernetes/pki/etcd scp /etc/kubernetes/admin.conf root@192.168.40.21:/etc/kubernetes scp /etc/kubernetes/pki/{ca.*,sa.*,front-proxy-ca.*}root@192.168.40.21:/etc/kubernetes/pki scp /etc/kubernetes/pki/etcd/ca.* root@192.168.40.21:/etc/kubernetes/pki/etcd ssh root@192.168.40.22 mkdir -p /etc/kubernetes/pki/etcd scp /etc/kubernetes/admin.conf root@192.168.40.22:/etc/kubernetes scp /etc/kubernetes/pki/{ca.*,sa.*,front-proxy-ca.*} root@192.168.40.22:/etc/kubernetes/pki scp /etc/kubernetes/pki/etcd/ca.* root@192.168.40.22:/etc/kubernetes/pki/etcd 2.æ·»åŠ èŠ‚ç‚¹ kubeadm join 192.168.40.19:16443 --token pqir66.66fy6pexw3kprt2b --discovery-token-ca-cert-hash sha256:cd4c42e956fdc7e0ad48c990484c22cfd43da63cb3f3887bedc481e7f33a0be1 --control-plane --cri-socket unix:///var/run/cri-docker.sock 7.æ‰§è¡Œkubectl get nodesï¼ŒæŸ¥çœ‹masterèŠ‚ç‚¹çŠ¶æ€ï¼š kubectl get node 8.é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹kubeletçŠ¶æ€ï¼š journalctl -xef -u kubelet -n 20 æç¤ºæœªå®‰è£…cni ç½‘ç»œæ’ä»¶ã€‚ 5.1å®‰è£…flannelç½‘ç»œæ’ä»¶(CNI) masteræ‰§è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…flannelå³å¯ï¼š kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml kube-flannel.yamlæ–‡ä»¶ä¸­çš„net-conf.json-&gt;Networkåœ°å€é»˜è®¤ä¸ºå‘½ä»¤ä¸­â€“pod-network-cidr=å€¼ç›¸åŒ è¾“å…¥å‘½ä»¤kubectl get pods -n kube-system,ç­‰å¾…æ‰€æœ‰æ’ä»¶ä¸ºrunningçŠ¶æ€ã€‚ å¾…æ‰€æœ‰pod statusä¸ºRunningçš„æ—¶å€™ï¼Œå†æ¬¡æ‰§è¡Œkubectl get nodesï¼š [root@k8s-master ~]# kubectl get node NAME STATUS ROLES AGE VERSION k8s-master Ready master 16m v1.24.1 å¦‚ä¸Šæ‰€ç¤ºï¼ŒmasterçŠ¶æ€å˜ä¸ºï¼Œè¡¨æ˜MasterèŠ‚ç‚¹éƒ¨ç½²æˆåŠŸï¼ 5.2å®‰è£…calicoç½‘ç»œ(åŠŸèƒ½æ›´å®Œå–„) 1.åœ¨masterä¸Šä¸‹è½½é…ç½®calicoç½‘ç»œçš„yamlã€‚ kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml 2.æå‰ä¸‹è½½æ‰€éœ€è¦çš„é•œåƒã€‚ # æŸ¥çœ‹æ­¤æ–‡ä»¶ç”¨å“ªäº›é•œåƒï¼š [root@k8s-master ~]# grep image calico.yaml image: docker.io/calico/cni:v3.23.1 image: docker.io/calico/node:v3.23.1 image: docker.io/calico/kube-controllers:v3.23.1 3.å®‰è£…calicoç½‘ç»œã€‚ åœ¨masterä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š kubectl apply -f calico.yaml 5.éªŒè¯ç»“æœã€‚ å†æ¬¡åœ¨masterä¸Šè¿è¡Œå‘½ä»¤ kubectl get nodesæŸ¥çœ‹è¿è¡Œç»“æœï¼š [root@k8s-master ~]# kubectl get nodes NAME STATUS ROLES AGE VERSION master01 Ready control-plane,master 21h v1.23.4 worker01 Ready control-plane,master 16h v1.23.4 worker02 Ready control-plane,master 16h v1.23.4 6.éƒ¨ç½²k8s-node1ã€k8s-node2ã€k8s-node3é›†ç¾¤ 1ã€åœ¨k8s-node1ã€k8s-node2ã€k8s-node3ç­‰ä¸‰å°è™šæ‹Ÿæœºä¸­é‡å¤æ‰§è¡Œä¸Šé¢çš„æ­¥éª¤ï¼Œå®‰è£…å¥½dockerã€kubeletã€kubectlã€kubeadmã€‚ 1.nodeèŠ‚ç‚¹åŠ å…¥é›†ç¾¤ åœ¨ä¸Šé¢ç¬¬åˆå§‹åŒ–masterèŠ‚ç‚¹æˆåŠŸåï¼Œè¾“å‡ºäº†ä¸‹é¢çš„kubeadm joinå‘½ä»¤ï¼š kubeadm join 192.168.40.131:6443 --token zj0u08.ge77y7uv76flqgdk --discovery-token-ca-cert-hash sha256:7cd23cec6afb192b2d34c5c719b378082a6315a9d91a22d91b83066c870d4db5 --cri-socket unix:///var/run/cri-docker.sock è¯¥å‘½ä»¤å°±æ˜¯nodeåŠ å…¥é›†ç¾¤çš„å‘½ä»¤ï¼Œåˆ†åˆ«åœ¨k8s-node1ã€k8s-node2ä¸Šæ‰§è¡Œè¯¥å‘½ä»¤åŠ å…¥é›†ç¾¤ã€‚ å¦‚æœå¿˜è®°è¯¥å‘½ä»¤ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤é‡æ–°ç”Ÿæˆï¼š kubeadm token create --print-join-command 2.åœ¨masterèŠ‚ç‚¹æ‰§è¡Œä¸‹é¢å‘½ä»¤æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼š kubectl get nodes [root@k8s-master ~]# kubectl get node NAME STATUS ROLES AGE VERSION k8s-master Ready master 24m v1.24.1 k8s-master2 Ready master 24m v1.24.1 k8s-master3 Ready master 24m v1.24.1 k8s-node1 Ready &lt;none&gt; 5m50s v1.24.1 k8s-node2 Ready &lt;none&gt; 5m21s v1.24.1 k8s-node3 Ready &lt;none&gt; 5m21s v1.24.1 å¦‚ä¸Šæ‰€ç¤ºï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½ä¸ºreadyï¼Œé›†ç¾¤æ­å»ºæˆåŠŸã€‚ å¸è½½é›†ç¾¤å‘½ä»¤ #å»ºè®®æ‰€æœ‰æœåŠ¡å™¨éƒ½æ‰§è¡Œ #!/bin/bash kubeadm reset -f modprobe -r ipip lsmod rm -rf ~/.kube/ rm -rf /etc/kubernetes/ rm -rf /etc/systemd/system/kubelet.service.d rm -rf /etc/systemd/system/kubelet.service rm -rf /usr/bin/kube* rm -rf /etc/cni rm -rf /opt/cni rm -rf /var/lib/etcd rm -rf /var/etcd yum -y remove kubeadm* kubectl* kubelet* docker* reboot ","link":"https://tianxiawuhao.github.io/McgbXRFnx/"},{"title":"Helmç®€ä»‹","content":"ä¸€ã€ç®€ä»‹ Helmæ˜¯Kubernetesçš„åŒ…ç®¡ç†å™¨ã€‚åŒ…ç®¡ç†å™¨ç±»ä¼¼äºUbuntuä¸­ä½¿ç”¨çš„aptã€Pythonä¸­çš„pipä¸€æ ·ï¼Œèƒ½å¿«é€ŸæŸ¥æ‰¾ã€ä¸‹è½½å’Œå®‰è£…è½¯ä»¶åŒ…ã€‚ Helmè§£å†³çš„ç—›ç‚¹ åœ¨Kubernetesä¸­éƒ¨ç½²ä¸€ä¸ªå¯ä»¥ä½¿ç”¨çš„åº”ç”¨ï¼Œéœ€è¦æ¶‰åŠåˆ°å¾ˆå¤šçš„Kubernetesèµ„æºçš„å…±åŒåä½œã€‚æ¯”å¦‚å®‰è£…ä¸€ä¸ªWordPressï¼Œç”¨åˆ°äº†ä¸€äº›Kubernetesçš„ä¸€äº›èµ„æºå¯¹è±¡ï¼ŒåŒ…æ‹¬Deploymentç”¨äºéƒ¨ç½²åº”ç”¨ã€Serviceæä¾›æœåŠ¡å‘ç°ã€Secreté…ç½® WordPressçš„ç”¨æˆ·åå’Œå¯†ç ï¼Œå¯èƒ½è¿˜éœ€è¦pvå’Œpvcæ¥æä¾›æŒä¹…åŒ–æœåŠ¡ã€‚å¹¶ä¸”WordPressæ•°æ®æ˜¯å­˜å‚¨åœ¨mariadbé‡Œé¢çš„ï¼Œæ‰€ä»¥éœ€è¦mariadbå¯åŠ¨å°±ç»ªåæ‰èƒ½å¯åŠ¨ WordPressã€‚è¿™äº›k8sèµ„æºè¿‡äºåˆ†æ•£ï¼Œä¸æ–¹ä¾¿è¿›è¡Œç®¡ç†ã€‚ HelmæŠŠKubernetesèµ„æº(æ¯”å¦‚deploymentsã€servicesæˆ–ingressç­‰) æ‰“åŒ…åˆ°ä¸€ä¸ªchartä¸­ï¼Œè€Œchartè¢«ä¿å­˜åˆ°chartä»“åº“ã€‚é€šè¿‡chartä»“åº“å¯ç”¨æ¥å­˜å‚¨å’Œåˆ†äº«chartã€‚Helmä½¿å‘å¸ƒå¯é…ç½®ï¼Œæ”¯æŒå‘å¸ƒåº”ç”¨é…ç½®çš„ç‰ˆæœ¬ç®¡ç†ï¼Œç®€åŒ–äº†Kuberneteséƒ¨ç½²åº”ç”¨çš„ç‰ˆæœ¬æ§åˆ¶ã€æ‰“åŒ…ã€å‘å¸ƒã€åˆ é™¤ã€æ›´æ–°ç­‰æ“ä½œã€‚ Helmç›¸å…³ç»„ä»¶åŠæ¦‚å¿µ helmæ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œä¸»è¦ç”¨äºKubernetesåº”ç”¨ç¨‹åºChartçš„åˆ›å»ºã€æ‰“åŒ…ã€å‘å¸ƒä»¥åŠåˆ›å»ºå’Œç®¡ç†æœ¬åœ°å’Œè¿œç¨‹çš„Chartä»“åº“ã€‚chart Helmçš„è½¯ä»¶åŒ…ï¼Œé‡‡ç”¨TARæ ¼å¼ã€‚ç±»ä¼¼äºAPTçš„DEBåŒ…æˆ–è€…YUMçš„RPMåŒ…ï¼Œå…¶åŒ…å«äº†ä¸€ç»„å®šä¹‰Kubernetesèµ„æºç›¸å…³çš„ YAMLæ–‡ä»¶ã€‚ Repoistory Helmçš„è½¯ä»¶ä»“åº“ï¼ŒRepositoryæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªWebæœåŠ¡å™¨ï¼Œè¯¥æœåŠ¡å™¨ä¿å­˜äº†ä¸€ç³»åˆ—çš„Chartè½¯ä»¶åŒ…ä»¥ä¾›ç”¨æˆ·ä¸‹è½½ï¼Œå¹¶ä¸”æä¾›äº†ä¸€ä¸ªè¯¥Repositoryçš„ChartåŒ…çš„æ¸…å•æ–‡ä»¶ä»¥ä¾›æŸ¥è¯¢ã€‚Helmå¯ä»¥åŒæ—¶ç®¡ç†å¤šä¸ªä¸åŒçš„Repositoryã€‚ releaseä½¿ç”¨helm installå‘½ä»¤åœ¨Kubernetesé›†ç¾¤ä¸­éƒ¨ç½²çš„Chartç§°ä¸ºReleaseã€‚å¯ä»¥ç†è§£ä¸ºHelmä½¿ç”¨ChartåŒ…éƒ¨ç½²çš„ä¸€ä¸ªåº”ç”¨å®ä¾‹ã€‚ åˆ›å»ºrelease helm å®¢æˆ·ç«¯ä»æŒ‡å®šçš„ç›®å½•æˆ–æœ¬åœ°taræ–‡ä»¶æˆ–è¿œç¨‹repoä»“åº“è§£æå‡ºchartçš„ç»“æ„ä¿¡æ¯ helm å®¢æˆ·ç«¯æ ¹æ® chart å’Œ values ç”Ÿæˆä¸€ä¸ª release helm å°†install releaseè¯·æ±‚ç›´æ¥ä¼ é€’ç»™ kube-apiserver åˆ é™¤release helm å®¢æˆ·ç«¯ä»æŒ‡å®šçš„ç›®å½•æˆ–æœ¬åœ°taræ–‡ä»¶æˆ–è¿œç¨‹repoä»“åº“è§£æå‡ºchartçš„ç»“æ„ä¿¡æ¯ helm å®¢æˆ·ç«¯æ ¹æ® chart å’Œ values ç”Ÿæˆä¸€ä¸ª release helm å°†delete releaseè¯·æ±‚ç›´æ¥ä¼ é€’ç»™ kube-apiserver æ›´æ–°release helm å®¢æˆ·ç«¯ä»æŒ‡å®šçš„ç›®å½•æˆ–æœ¬åœ°taræ–‡ä»¶æˆ–è¿œç¨‹repoä»“åº“è§£æå‡ºchartçš„ç»“æ„ä¿¡æ¯ helm å°†æ”¶åˆ°çš„ä¿¡æ¯ç”Ÿæˆæ–°çš„ releaseï¼Œå¹¶åŒæ—¶æ›´æ–°è¿™ä¸ª release çš„ history helm å°†æ–°çš„ release ä¼ é€’ç»™ kube-apiserver è¿›è¡Œæ›´æ–° chartçš„åŸºæœ¬ç»“æ„ ## Helmçš„æ‰“åŒ…æ ¼å¼å«åšchartï¼Œæ‰€è°“chartå°±æ˜¯ä¸€ç³»åˆ—æ–‡ä»¶, å®ƒæè¿°äº†ä¸€ç»„ç›¸å…³çš„ k8s é›†ç¾¤èµ„æºã€‚ ## Chartä¸­çš„æ–‡ä»¶å®‰è£…ç‰¹å®šçš„ç›®å½•ç»“æ„ç»„ç»‡, æœ€ç®€å•çš„chart ç›®å½•å¦‚ä¸‹æ‰€ç¤ºï¼š ./ â”œâ”€â”€ charts # ç›®å½•å­˜æ”¾ä¾èµ–çš„chart â”œâ”€â”€ Chart.yaml # åŒ…å«Chartçš„åŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬chartç‰ˆæœ¬ï¼Œåç§°ç­‰ â”œâ”€â”€ templates # ç›®å½•ä¸‹å­˜æ”¾åº”ç”¨ä¸€ç³»åˆ—k8sèµ„æºçš„yamlæ¨¡æ¿ â”‚ â”œâ”€â”€ deployment.yaml â”‚ â”œâ”€â”€ _helpers.tpl # æ­¤æ–‡ä»¶ä¸­å®šä¹‰ä¸€äº›å¯é‡ç”¨çš„æ¨¡æ¿ç‰‡æ–­ï¼Œæ­¤æ–‡ä»¶ä¸­çš„å®šä¹‰åœ¨ä»»ä½•èµ„æºå®šä¹‰æ¨¡æ¿ä¸­å¯ç”¨ â”‚ â”œâ”€â”€ ingress.yaml â”‚ â”œâ”€â”€ NOTES.txt # ä»‹ç»chartéƒ¨ç½²åçš„å¸®åŠ©ä¿¡æ¯ï¼Œå¦‚ä½•ä½¿ç”¨chartç­‰ â”‚ â”œâ”€â”€ serviceaccount.yaml â”‚ â”œâ”€â”€ service.yaml â”‚ â””â”€â”€ tests â”‚ â””â”€â”€ test-connection.yaml â””â”€â”€ values.yaml # åŒ…å«äº†å¿…è¦çš„å€¼å®šä¹‰ï¼ˆé»˜è®¤å€¼ï¼‰, ç”¨äºå­˜å‚¨templatesç›®å½•ä¸­æ¨¡æ¿æ–‡ä»¶ä¸­ç”¨åˆ°å˜é‡çš„å€¼ äºŒã€å®‰è£…Helm 1 å®‰è£…Helm [root@Ansible01 ~]# wget https://get.helm.sh/helm-v3.8.2-linux-amd64.tar.gz [root@Ansible01 ~]# tar -zxvf helm-v3.0.0-linux-amd64.tar.gz [root@Ansible01 ~]# mv linux-amd64/helm /usr/local/bin/helm [root@Ansible01 ~]# helm version version.BuildInfo{Version:&quot;v3.8.2&quot;, GitCommit:&quot;6e3701edea09e5d55a8ca2aae03a68917630e91b&quot;, GitTreeState:&quot;clean&quot;, GoVersion:&quot;go1.17.5&quot;} 2 æ·»åŠ å¸¸ç”¨repo æ·»åŠ å­˜å‚¨åº“ [root@Ansible01 ~]# helm repo add aliyun https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts &quot;aliyun&quot; has been added to your repositories æ›´æ–°å­˜å‚¨åº“ [root@Ansible01 ~]# helm repo update Hang tight while we grab the latest from your chart repositories... ...Successfully got an update from the &quot;aliyun&quot; chart repository ...Successfully got an update from the &quot;stable&quot; chart repository ...Successfully got an update from the &quot;prometheus-community&quot; chart repository ...Successfully got an update from the &quot;bitnami&quot; chart repository Update Complete. âˆHappy Helming!âˆ æŸ¥çœ‹å­˜å‚¨åº“ [root@Ansible01 ~]# helm repo list NAME URL bitnami https://charts.bitnami.com/bitnami prometheus-community https://prometheus-community.github.io/helm-charts stable http://mirror.azure.cn/kubernetes/charts aliyun https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts åˆ é™¤å­˜å‚¨åº“ [root@Ansible01 ~]# helm repo remove aliyun &quot;aliyun&quot; has been removed from your repositories ä¸‰ã€ä½¿ç”¨Helm 1 ä½¿ç”¨chartéƒ¨ç½²ä¸€ä¸ªmysql # æŸ¥æ‰¾æ‰€æœ‰repoä¸‹çš„æ‰€æœ‰chart helm search repo # æŸ¥æ‰¾stableè¿™ä¸ªrepoä¸‹çš„chart mysql helm search repo stable/mysql # æŸ¥çœ‹chartä¿¡æ¯ï¼š helm show chart stable/mysql # å®‰è£…åŒ…ï¼š helm install db stable/mysql** # æŸ¥çœ‹å‘å¸ƒçŠ¶æ€ï¼š helm status db [root@Ansible01 ~]# kubectl get pod -n default NAME READY STATUS RESTARTS AGE db-mysql-599d764c8c-knfqc 0/1 Pending 0 2m10s [root@Ansible01 ~]# kubectl describe pod db-mysql-599d764c8c-knfqc -n default ...... Events: Type Reason Age From Message ---- ------ ---- ---- ------- Warning FailedScheduling 17s (x3 over 2m33s) default-scheduler 0/4 nodes are available: 4 pod has unbound immediate PersistentVolumeClaims. 2 å®‰è£…å‰è‡ªå®šä¹‰charté…ç½®é€‰é¡¹ ä¸Šé¢éƒ¨ç½²çš„mysqlå¹¶æ²¡æœ‰æˆåŠŸï¼Œè¿™æ˜¯å› ä¸ºå¹¶ä¸æ˜¯æ‰€æœ‰çš„chartéƒ½èƒ½æŒ‰ç…§é»˜è®¤é…ç½®è¿è¡ŒæˆåŠŸï¼Œå¯èƒ½ä¼šéœ€è¦ä¸€äº›ç¯å¢ƒä¾èµ–ï¼Œä¾‹å¦‚PVã€‚ æ‰€ä»¥éœ€è¦è‡ªå®šä¹‰charté…ç½®é€‰é¡¹ï¼Œå®‰è£…è¿‡ç¨‹ä¸­æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥ä¼ é€’é…ç½®æ•°æ®ï¼šâ€“valuesï¼ˆæˆ–-fï¼‰ï¼šæŒ‡å®šå¸¦æœ‰è¦†ç›–çš„YAMLæ–‡ä»¶ã€‚è¿™å¯ä»¥å¤šæ¬¡æŒ‡å®šï¼Œæœ€å³è¾¹çš„æ–‡ä»¶ä¼˜å…ˆã€‚ â€“setï¼šåœ¨å‘½ä»¤è¡Œä¸ŠæŒ‡å®šæ›¿ä»£ã€‚å¦‚æœä¸¤è€…éƒ½ç”¨ï¼Œâ€“setä¼˜å…ˆçº§é«˜ åˆ›å»ºæ»¡è¶³çš„PV [root@Ansible01 mysql]# cat pv.yaml apiVersion: v1 kind: PersistentVolume metadata: name: mysql-pv-volume labels: type: local spec: storageClassName: &quot;managed-nfs-storage&quot; capacity: storage: 10Gi accessModes: - ReadWriteOnce hostPath: path: &quot;/mnt/data&quot; [root@Ansible01 hello-world]# kubectl get pv NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE mysql-pv-volume 10Gi RWO Retain Available managed-nfs-storage 4s [root@Ansible01 hello-world]# helm uninstall db release &quot;db&quot; uninstalled [root@Ansible01 hello-world]# cat config.yaml persistence: enabled: true storageClass: &quot;managed-nfs-storage&quot; accessMode: ReadWriteOnce size: 8Gi mysqlUser: &quot;k8s&quot; mysqlPassword: &quot;123456&quot; mysqlDatabase: &quot;k8s&quot; [root@Ansible01 hello-world]# helm install db -f config.yaml stable/mysql [root@Ansible01 hello-world]# kubectl get pv NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE mysql-pv-volume 10Gi RWO Retain Bound default/db-mysql managed-nfs-storage 17s [root@Ansible01 hello-world]# kubectl get pod NAME READY STATUS RESTARTS AGE db-mysql-f7fbfdd68-tc8cm 1/1 Running 0 11s 3 æ„å»ºä¸€ä¸ªHelm Chart å‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªåä¸ºmychart çš„helm chart [root@Ansible01 2022-05-21]# helm create mychart Creating mychart [root@Ansible01 2022-05-21]# ls mychart åˆ›å»ºåä¼šåœ¨ç›®å½•åˆ›å»ºä¸€ä¸ªmychartç›®å½• [root@Ansible01 2022-05-21]# tree mychart/ mychart/ â”œâ”€â”€ charts â”œâ”€â”€ Chart.yaml â”œâ”€â”€ templates â”‚ â”œâ”€â”€ deployment.yaml â”‚ â”œâ”€â”€ _helpers.tpl â”‚ â”œâ”€â”€ hpa.yaml â”‚ â”œâ”€â”€ ingress.yaml â”‚ â”œâ”€â”€ NOTES.txt â”‚ â”œâ”€â”€ serviceaccount.yaml â”‚ â”œâ”€â”€ service.yaml â”‚ â””â”€â”€ tests â”‚ â””â”€â”€ test-connection.yaml â””â”€â”€ values.yaml 3 directories, 10 files å…¶ä¸­mychartç›®å½•ä¸‹çš„templatesç›®å½•ä¸­ä¿å­˜æœ‰éƒ¨ç½²çš„æ¨¡æ¿æ–‡ä»¶ï¼Œvalues.yamlä¸­å®šä¹‰äº†éƒ¨ç½²çš„å˜é‡ï¼ŒChart.yamlæ–‡ä»¶åŒ…å«æœ‰versionï¼ˆchartç‰ˆæœ¬ï¼‰å’ŒappVersionï¼ˆåŒ…å«åº”ç”¨çš„ç‰ˆæœ¬ï¼‰ã€‚ [root@Ansible01 2022-05-21]# cat mychart/Chart.yaml |grep -v &quot;^#&quot; |grep -v ^$ apiVersion: v2 name: mychart description: A Helm chart for Kubernetes type: application version: 0.1.0 appVersion: &quot;1.16.0&quot; é€‰æ‹©é•œåƒåŠæ ‡ç­¾å’Œå‰¯æœ¬æ•°ï¼ˆè¿™é‡Œè®¾ç½®1ä¸ªï¼‰ [root@Ansible01 2022-05-21]# vi mychart/values.yaml replicaCount: 1 image: repository: myapp pullPolicy: IfNotPresent # Overrides the image tag whose default is the chart appVersion. tag: &quot;v1&quot; ç¼–è¾‘å®Œæˆåæ£€æŸ¥ä¾èµ–åŠæ¨¡æ¿é…ç½®æ˜¯å¦æ­£ç¡® [root@Ansible01 2022-05-21]# cd mychart/ [root@Ansible01 mychart]# helm lint . ==&gt; Linting . [INFO] Chart.yaml: icon is recommended 1 chart(s) linted, 0 chart(s) failed æ‰“åŒ…åº”ç”¨ï¼Œå…¶ä¸­0.1.0ä¸ºåœ¨Chart.yamlæ–‡ä»¶ä¸­å®šä¹‰çš„versionï¼ˆchartç‰ˆæœ¬ï¼‰ä¿¡æ¯ [root@Ansible01 2022-05-21]# helm package mychart/ Successfully packaged chart and saved it to: /root/2022-05-21/mychart-0.1.0.tgz [root@Ansible01 2022-05-21]# ls mychart mychart-0.1.0.tgz å‡çº§ã€å›æ»šå’Œåˆ é™¤ # å‘å¸ƒæ–°ç‰ˆæœ¬çš„chartæ—¶ï¼Œæˆ–è€…å½“æ‚¨è¦æ›´æ”¹å‘å¸ƒçš„é…ç½®æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¯¥helm upgrade å‘½ä»¤ã€‚ helm upgrade --set imageTag=1.17 web mychart helm upgrade -f values.yaml web mychart # å¦‚æœåœ¨å‘å¸ƒåæ²¡æœ‰è¾¾åˆ°é¢„æœŸçš„æ•ˆæœï¼Œåˆ™å¯ä»¥ä½¿ç”¨helm rollbackå›æ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬ã€‚ ä¾‹å¦‚å°†åº”ç”¨å›æ»šåˆ°ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼š helm rollback web 2 # å¸è½½å‘è¡Œç‰ˆï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹helm uninstallå‘½ä»¤ï¼š helm uninstall web # æŸ¥çœ‹å†å²ç‰ˆæœ¬é…ç½®ä¿¡æ¯ helm get --revision 1 web ä¸‹è½½ã€ä¸Šä¼ taråŒ… [root@Ansible01 2022-05-21]# helm pull stable/traefik [root@Ansible01 2022-05-21]# ls traefik-1.87.7.tgz # ä¸€ç§æ–¹å¼æ˜¯ç›´æ¥ä¸Šä¼ chartsæ–‡ä»¶å¤¹ï¼Œseldon-mabæ˜¯chartsç›®å½•ï¼Œharbor-test-helmæ˜¯harbor charts repoåç§°ã€‚ helm push seldon-mab harbor-test-helm # å¦ä¸€ç§æ˜¯å°†charts packageæ–‡ä»¶åŒ…push helm push seldon-core-operator-1.5.1.tgz harbor-test-helm å®‰è£…åˆ°k8sçš„å…¶å®ƒç©ºé—´ï¼š--namespace=monitoring helm install --name prometheus-operator --set rbacEnable=true --namespace=monitoring stable/prometheus-operator å››ã€Helmä½¿ç”¨minioæ­å»ºç§æœ‰ä»“åº“ minioä»‹ç» æˆ‘ä»¬ä¸€èˆ¬æ˜¯ä»æœ¬åœ°çš„ç›®å½•ç»“æ„ä¸­çš„chartå»è¿›è¡Œéƒ¨ç½²ï¼Œå¦‚æœè¦é›†ä¸­ç®¡ç†chart,å°±éœ€è¦æ¶‰åŠåˆ°repositoryçš„é—®é¢˜ï¼Œå› ä¸ºhelmrepositoryéƒ½æ˜¯æŒ‡åˆ°å¤–é¢çš„åœ°å€ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥é€šè¿‡minioå»ºç«‹ä¸€ä¸ªä¼ä¸šç§æœ‰çš„å­˜æ”¾ä»“åº“ã€‚ Minioæä¾›å¯¹è±¡å­˜å‚¨æœåŠ¡ã€‚å®ƒçš„åº”ç”¨åœºæ™¯è¢«è®¾å®šåœ¨äº†éç»“æ„åŒ–çš„æ•°æ®çš„å­˜å‚¨ä¹‹ä¸Šäº†ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼Œéç»“æ„åŒ–å¯¹è±¡è¯¸å¦‚å›¾åƒ/éŸ³é¢‘/è§†é¢‘/logæ–‡ä»¶/ç³»ç»Ÿå¤‡ä»½/é•œåƒæ–‡ä»¶â€¦ç­‰ç­‰ä¿å­˜èµ·æ¥ç®¡ç†æ€»æ˜¯ä¸é‚£ä¹ˆæ–¹ä¾¿ï¼Œsizeå˜åŒ–å¾ˆå¤§ï¼Œç±»å‹å¾ˆå¤šï¼Œå†æœ‰äº‘ç«¯çš„ç»“åˆä¼šä½¿å¾—æƒ…å†µæ›´åŠ å¤æ‚ï¼Œminioå°±æ˜¯è§£å†³æ­¤ç§åœºæ™¯çš„ä¸€ä¸ªè§£å†³æ–¹æ¡ˆã€‚Minioå·ç§°å…¶èƒ½å¾ˆå¥½çš„é€‚åº”éç»“æ„åŒ–çš„æ•°æ®ï¼Œæ”¯æŒAWSçš„S3ï¼Œéç»“æ„åŒ–çš„æ–‡ä»¶ä»æ•°KBåˆ°5TBéƒ½èƒ½å¾ˆå¥½çš„æ”¯æŒã€‚ Minioçš„ä½¿ç”¨æ¯”è¾ƒç®€å•ï¼Œåªæœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼ŒæœåŠ¡ç«¯minio,å®¢æˆ·è®¿é—®ç«¯mc,æ¯”è¾ƒç®€å•ã€‚ åœ¨é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ‰¾ä¸€å°è™šæ‹Ÿæœºä½œä¸ºMinio Server,æä¾›æœåŠ¡ï¼Œå½“ç„¶minioä¹Ÿæ”¯æŒä½œä¸ºPodéƒ¨ç½²ã€‚ 1 helm3å­˜å‚¨åº“æ›´æ”¹ åœ¨Helm 2ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹åŒ…æ‹¬ç¨³å®šçš„å›¾è¡¨å­˜å‚¨åº“ã€‚åœ¨Helm 3ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸åŒ…å«ä»»ä½•å­˜å‚¨åº“ã€‚å› æ­¤éœ€è¦åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯æ·»åŠ ä¸€ä¸ªå­˜å‚¨åº“ã€‚å®˜æ–¹å›¾è¡¨å­˜å‚¨åº“å°†åœ¨æœ‰é™çš„æ—¶é—´å†…ç»§ç»­æ¥æ”¶è¡¥ä¸ï¼Œä½†æ˜¯å°†ä¸å†ä½œä¸ºé»˜è®¤å­˜å‚¨åº“åŒ…å«åœ¨Helmå®¢æˆ·ç«¯ä¸­ã€‚ 2 minioä»‹ç» MinIO æ˜¯ä¸€ä¸ªåŸºäºApache License v2.0å¼€æºåè®®çš„å¯¹è±¡å­˜å‚¨æœåŠ¡ã€‚å®ƒå…¼å®¹äºšé©¬é€ŠS3äº‘å­˜å‚¨æœåŠ¡æ¥å£ï¼Œéå¸¸é€‚åˆäºå­˜å‚¨å¤§å®¹é‡éç»“æ„åŒ–çš„æ•°æ®ï¼Œä¾‹å¦‚å›¾ç‰‡ã€è§†é¢‘ã€æ—¥å¿—æ–‡ä»¶ã€å¤‡ä»½æ•°æ®å’Œå®¹å™¨/è™šæ‹Ÿæœºé•œåƒç­‰ï¼Œè€Œä¸€ä¸ªå¯¹è±¡æ–‡ä»¶å¯ä»¥æ˜¯ä»»æ„å¤§å°ï¼Œä»å‡ kbåˆ°æœ€å¤§5Tä¸ç­‰ã€‚ MinIOæ˜¯ä¸€ä¸ªéå¸¸è½»é‡çš„æœåŠ¡,å¯ä»¥å¾ˆç®€å•çš„å’Œå…¶ä»–åº”ç”¨çš„ç»“åˆï¼Œç±»ä¼¼ NodeJS, Redis æˆ–è€… MySQLã€‚ 3 å®‰è£…minioæœåŠ¡ç«¯ 1ä½¿ç”¨å®¹å™¨å®‰è£…æœåŠ¡ç«¯ docker pull minio/minio docker run -p 9000:9000 minio/minio server /data 2ä½¿ç”¨äºŒè¿›åˆ¶å®‰è£…æœåŠ¡ç«¯ wget https://dl.min.io/server/minio/release/linux-amd64/minio chmod +x minio mkdir -p /chart ./minio server /chart è®¿é—®Browser Accessåœ°å€ï¼š åœ¨å¯åŠ¨æ—¥å¿—ä¸­è·å–access keyå’Œsecret key çœ‹åˆ°è¿™ä¸ªé¡µé¢åˆ™è¡¨ç¤ºç™»é™†æˆåŠŸ è‡³æ­¤æœåŠ¡ç«¯éƒ¨ç½²å®Œæˆã€‚ 4 å®‰è£…minioå®¢æˆ·ç«¯ 1.ä½¿ç”¨å®¹å™¨å®‰è£…å®¢æˆ·ç«¯ docker pull minio/mc docker run minio/mc ls play 2.ä½¿ç”¨äºŒè¿›åˆ¶å®‰è£…å®¢æˆ·ç«¯ wget https://dl.min.io/client/mc/release/linux-amd64/mc chmod +x mc ./mc 5 è¿æ¥è‡³æœåŠ¡ç«¯ ./mc config host add myminio http://172.17.0.1:9000 XH2LCA4AJIP52RDB4P5M CDDCuoS2FNsdW8S0bodkcs2729N+TH5lFov+rrT3 æœåŠ¡ç«¯å¯åŠ¨æ—¶å€™çš„access keyå’Œsecret key 6 mcçš„shellä½¿ç”¨åˆ«å ls=mc ls cp=mc cp cat=mc cat mkdir=mc mb pipe=mc pipe find=mc find 7 åˆ›å»ºbucket ./mc mb myminio/minio-helm-repo 8 è®¾ç½®bucketå’ŒobjectsåŒ¿åè®¿é—® ./mc policy set download myminio/minio-helm-repo 9 helmåˆ›å»ºä¸ä»“åº“è¿æ¥çš„index.yamlæ–‡ä»¶ mkdir /root/helm/repo helm repo index helm/repo/ 10 helmä¸minioä»“åº“è¿›è¡Œè¿æ¥ 1.å°†index.yamlæ–‡ä»¶æ¨é€åˆ°backetä¸­å» ./mc cp helm/repo/index.yaml myminio/minio-helm-repo 2.helmè¿æ¥ç§ä»“ helm repo add fengnan http://192.168.0.119:9000/minio-helm-repo 3.æ›´æ–°repoä»“åº“ helm repo update 4.æŸ¥çœ‹repo helm repo list 5.æŸ¥çœ‹repoä¸­çš„æ–‡ä»¶ ./mc ls myminio/minio-helm-repo 6.ç™»å½•æœåŠ¡ç«¯webç•Œé¢æŸ¥çœ‹ ","link":"https://tianxiawuhao.github.io/zIWVYloAQ/"},{"title":"k8sèµ„æºæ“ä½œ","content":"1.èµ„æºç±»å‹ èµ„æºåˆ†ç±» ç±»å‹ å…·ä½“èµ„æº åç§°ç©ºé—´çº§åˆ« å·¥ä½œè´Ÿè½½å‹èµ„æº Pod(pod:k8s ç³»ç»Ÿä¸­å¯ä»¥åˆ›å»ºå’Œç®¡ç†çš„æœ€å°å•å…ƒ) åç§°ç©ºé—´çº§åˆ« å·¥ä½œè´Ÿè½½å‹èµ„æº ReplicaSet(rs:ç”¨æ¥ç¡®ä¿å®¹å™¨åº”ç”¨çš„å‰¯æœ¬æ•°å§‹ç»ˆä¿æŒåœ¨ç”¨æˆ·å®šä¹‰çš„å‰¯æœ¬æ•°) åç§°ç©ºé—´çº§åˆ« å·¥ä½œè´Ÿè½½å‹èµ„æº Deployment(deployment:ä¸º Pod å’Œ ReplicaSet æä¾›äº†ä¸€ä¸ª å£°æ˜å¼å®šä¹‰ (declarative) æ–¹æ³•) åç§°ç©ºé—´çº§åˆ« å·¥ä½œè´Ÿè½½å‹èµ„æº StatefulSet(sts:ä¸ºäº†è§£å†³æœ‰çŠ¶æ€æœåŠ¡çš„é—®é¢˜) åç§°ç©ºé—´çº§åˆ« å·¥ä½œè´Ÿè½½å‹èµ„æº DaemonSet(ds:) åç§°ç©ºé—´çº§åˆ« å·¥ä½œè´Ÿè½½å‹èµ„æº Job(jobs:è´Ÿè´£æ‰¹å¤„ç†ä»»åŠ¡ï¼Œå³ä»…æ‰§è¡Œä¸€æ¬¡çš„ä»»åŠ¡ï¼Œå®ƒä¿è¯æ‰¹å¤„ç†ä»»åŠ¡çš„ä¸€ä¸ªæˆ–å¤šä¸ª Pod) åç§°ç©ºé—´çº§åˆ« å·¥ä½œè´Ÿè½½å‹èµ„æº CronJob(jobs:ç®¡ç†åŸºäºæ—¶é—´çš„ Job) åç§°ç©ºé—´çº§åˆ« æœåŠ¡å‘ç°åŠè´Ÿè½½å‡è¡¡å‹èµ„æº Service(svc:ä¸ºä¸€ç»„åŠŸèƒ½ç›¸åŒçš„Podæä¾›ä¸€ä¸ªä¾›å¤–ç•Œè®¿é—®çš„åœ°å€) åç§°ç©ºé—´çº§åˆ« æœåŠ¡å‘ç°åŠè´Ÿè½½å‡è¡¡å‹èµ„æº Ingress(ing:å®˜æ–¹åªèƒ½å®ç°å››å±‚ä»£ç†ï¼ŒINGRESS å¯ä»¥å®ç°ä¸ƒå±‚ä»£ç†) åç§°ç©ºé—´çº§åˆ« é…ç½®ä¸å­˜å‚¨å‹èµ„æº Volume(å­˜å‚¨å·) åç§°ç©ºé—´çº§åˆ« é…ç½®ä¸å­˜å‚¨å‹èµ„æº CSI(å®¹å™¨å­˜å‚¨æ¥å£-- ç¬¬ä¸‰æ–¹å­˜å‚¨å·) åç§°ç©ºé—´çº§åˆ« ç‰¹æ®Šç±»å‹çš„å­˜å‚¨å· ConfigMap(å½“é…ç½®ä¸­å¿ƒæ¥ä½¿ç”¨çš„èµ„æºç±»å‹) åç§°ç©ºé—´çº§åˆ« ç‰¹æ®Šç±»å‹çš„å­˜å‚¨å· Secret(ä¿å­˜æ•æ„Ÿæ•°æ®) åç§°ç©ºé—´çº§åˆ« ç‰¹æ®Šç±»å‹çš„å­˜å‚¨å· DownwardApi(æŠŠå¤–éƒ¨ç¯å¢ƒä¸­çš„ä¿¡æ¯è¾“å‡ºç»™å®¹å™¨) é›†ç¾¤çº§èµ„æº é›†ç¾¤çº§èµ„æº Namespace(å‘½åç©ºé—´) é›†ç¾¤çº§èµ„æº é›†ç¾¤çº§èµ„æº Node(é›†ç¾¤èŠ‚ç‚¹) é›†ç¾¤çº§èµ„æº é›†ç¾¤çº§èµ„æº Role(è§’è‰²) é›†ç¾¤çº§èµ„æº é›†ç¾¤çº§èµ„æº ClusterRole(é›†ç¾¤è§’è‰²) é›†ç¾¤çº§èµ„æº é›†ç¾¤çº§èµ„æº RoleBinding(è§’è‰²ç»‘å®š) é›†ç¾¤çº§èµ„æº é›†ç¾¤çº§èµ„æº ClusterRoleBinging(é›†ç¾¤è§’è‰²ç»‘å®š) å…ƒæ•°æ®å‹èµ„æº å…ƒæ•°æ®å‹èµ„æº HPA(æ ¹æ® Podçš„ CPU åˆ©ç”¨ç‡æ‰©æ‰€å®¹) å…ƒæ•°æ®å‹èµ„æº å…ƒæ•°æ®å‹èµ„æº PodTemplate(podèµ„æºæ¨¡æ¿) å…ƒæ•°æ®å‹èµ„æº å…ƒæ•°æ®å‹èµ„æº LimitRange(èµ„æºé™åˆ¶) 2.æ“ä½œæŒ‡ä»¤ å‘½ä»¤å ç±»å‹ ä½œç”¨ get æŸ¥ åˆ—å‡ºæŸä¸ªç±»å‹çš„ä¸‹å±èµ„æº describe æŸ¥ æŸ¥çœ‹æŸä¸ªèµ„æºçš„è¯¦ç»†ä¿¡æ¯ logs æŸ¥ æŸ¥çœ‹æŸä¸ª pod çš„æ—¥å¿— create å¢ æ–°å»ºèµ„æº explain æŸ¥ æŸ¥çœ‹æŸä¸ªèµ„æºçš„é…ç½®é¡¹ delete åˆ  åˆ é™¤æŸä¸ªèµ„æº edit æ”¹ ä¿®æ”¹æŸä¸ªèµ„æºçš„é…ç½®é¡¹ apply æ”¹ åº”ç”¨æŸä¸ªèµ„æºçš„é…ç½®é¡¹ 3.æŸ¥çœ‹å’Œè¿›å…¥ç©ºé—´ å‘½ä»¤å ä½œç”¨ kubectl get pod -nåç§°ç©ºé—´ æŸ¥çœ‹å¯¹åº”åç§°ç©ºé—´å†…çš„pod kubectl exec -it podåå­— -nåç§°ç©ºé—´ bash è¿›å…¥å¯¹åº”åç§°ç©ºé—´çš„podå†… kubectl get nodes -o wide è·å–èŠ‚ç‚¹å’ŒæœåŠ¡ç‰ˆæœ¬ä¿¡æ¯ï¼Œå¹¶æŸ¥çœ‹é™„åŠ ä¿¡æ¯ kubectl get pod è·å–podä¿¡æ¯ï¼Œé»˜è®¤æ˜¯defaultåç§°ç©ºé—´ kubectl get pod -o wide è·å–podä¿¡æ¯ï¼Œé»˜è®¤æ˜¯defaultåç§°ç©ºé—´ï¼Œå¹¶æŸ¥çœ‹é™„åŠ ä¿¡æ¯ kubectl get pod -n kube-system è·å–æŒ‡å®šåç§°ç©ºé—´çš„pod kubectl get pod -n kube-system podName è·å–æŒ‡å®šåç§°ç©ºé—´ä¸­çš„æŒ‡å®špod kubectl get pod -A è·å–æ‰€æœ‰åç§°ç©ºé—´çš„pod kubectl get pods -o yamlkubectl get pods -o json æŸ¥çœ‹podçš„è¯¦ç»†ä¿¡æ¯ï¼Œä»¥yamlæ ¼å¼æˆ–jsonæ ¼å¼æ˜¾ç¤º kubectl get pod -A --show-labels æŸ¥çœ‹podçš„æ ‡ç­¾ä¿¡æ¯ kubectl get pod -A --selector=â€œk8s-app=kube-dnsâ€ æ ¹æ®Selectorï¼ˆlabel queryï¼‰æ¥æŸ¥è¯¢pod kubectl exec podName env æŸ¥çœ‹è¿è¡Œpodçš„ç¯å¢ƒå˜é‡ kubectl logs -f --tail 500 -n kube-system kube-apiserver-k8s-master æŸ¥çœ‹æŒ‡å®špodçš„æ—¥å¿— kubectl get svc -A æŸ¥çœ‹æ‰€æœ‰åç§°ç©ºé—´çš„serviceä¿¡æ¯ kubectl get svc -n kube-system æŸ¥çœ‹æŒ‡å®šåç§°ç©ºé—´çš„serviceä¿¡æ¯ kubectl get cs æŸ¥çœ‹componentstatusesä¿¡æ¯ kubectl get cm -A æŸ¥çœ‹æ‰€æœ‰configmapsä¿¡æ¯ kubectl get sa -A æŸ¥çœ‹æ‰€æœ‰serviceaccountsä¿¡æ¯ kubectl get ds -A æŸ¥çœ‹æ‰€æœ‰daemonsetsä¿¡æ¯ kubectl get deploy -A æŸ¥çœ‹æ‰€æœ‰deploymentsä¿¡æ¯ kubectl get rs -A æŸ¥çœ‹æ‰€æœ‰replicasetsä¿¡æ¯ kubectl get sts -A æŸ¥çœ‹æ‰€æœ‰statefulsetsä¿¡æ¯ kubectl get jobs -A æŸ¥çœ‹æ‰€æœ‰jobsä¿¡æ¯ kubectl get ing -A æŸ¥çœ‹æ‰€æœ‰ingressesä¿¡æ¯ kubectl get ns æŸ¥çœ‹æœ‰å“ªäº›åç§°ç©ºé—´ kubectl describe pod podNamekubectl describe pod -n kube-system kube-apiserver-k8s-master æŸ¥çœ‹podçš„æè¿°ä¿¡æ¯ kubectl describe deploy -n kube-system coredns æŸ¥çœ‹æŒ‡å®šåç§°ç©ºé—´ä¸­æŒ‡å®šdeployçš„æè¿°ä¿¡æ¯ kubectl top nodekubectl top pod æŸ¥çœ‹nodeæˆ–podçš„èµ„æºä½¿ç”¨æƒ…å†µï¼ˆéœ€è¦heapster æˆ–metrics-serveræ”¯æŒï¼‰ kubectl cluster-info kubectl cluster-info dump æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯ kubectl -s https://172.16.1.110:6443 get componentstatuses æŸ¥çœ‹å„ç»„ä»¶ä¿¡æ¯ã€172.16.1.110ä¸ºmasteræœºå™¨ã€‘ 4.è¿›å…¥podå¯åŠ¨çš„å®¹å™¨ å‘½ä»¤å ä½œç”¨ kubectl exec -it podName -n nsName /bin/sh è¿›å…¥å®¹å™¨ kubectl exec -it podName -n nsName /bin/bash è¿›å…¥å®¹å™¨ 5.æ·»åŠ labelå€¼ å‘½ä»¤å ä½œç”¨ kubectl label nodes k8s-node01 zone=north ä¸ºæŒ‡å®šèŠ‚ç‚¹æ·»åŠ æ ‡ç­¾ kubectl label nodes k8s-node01 zone ä¸ºæŒ‡å®šèŠ‚ç‚¹åˆ é™¤æ ‡ç­¾ kubectl label pod podName -n nsName role-name=test ä¸ºæŒ‡å®špodæ·»åŠ æ ‡ç­¾ kubectl label pod podName -n nsName role-name=dev --overwrite ä¿®æ”¹lableæ ‡ç­¾å€¼ kubectl label pod podName -n nsName role-name åˆ é™¤lableæ ‡ç­¾ 6.æ»šåŠ¨å‡çº§ å‘½ä»¤å ä½œç”¨ kubectl apply -f myapp-deployment-v2.yaml é€šè¿‡é…ç½®æ–‡ä»¶æ»šåŠ¨å‡çº§ kubectl set image deploy/myapp-deployment myapp=â€œregistry.cn-beijing.aliyuncs.com/google_registry/myapp:v3â€ é€šè¿‡å‘½ä»¤æ»šåŠ¨å‡çº§ kubectl rollout undo deploy/myapp-deployment kubectl rollout undo deploy myapp-deployment podå›æ»šåˆ°å‰ä¸€ä¸ªç‰ˆæœ¬ kubectl rollout undo deploy/myapp-deployment --to-revision=2 å›æ»šåˆ°æŒ‡å®šå†å²ç‰ˆæœ¬ 7.åŠ¨æ€ä¼¸ç¼© å‘½ä»¤å ä½œç”¨ kubectl scale deploy myapp-deployment --replicas=5 åŠ¨æ€ä¼¸ç¼© kubectl scale --replicas=8 -f myapp-deployment-v2.yaml åŠ¨æ€ä¼¸ç¼©ï¼ˆæ ¹æ®yamlæ–‡ä»¶ï¼‰ 8.æ“ä½œç±»å‘½ä»¤ å‘½ä»¤å ä½œç”¨ kubectl create -f xxx.yaml åˆ›å»ºèµ„æº kubectl apply -f xxx.yaml åº”ç”¨èµ„æº kubectl apply -f åº”ç”¨èµ„æºï¼Œè¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰ .yaml, .yml, æˆ– .json æ–‡ä»¶éƒ½ä¼šè¢«ä½¿ç”¨ kubectl create namespace test åˆ›å»ºteståç§°ç©ºé—´ kubectl delete -f xxx.yamlkubectl delete -f åˆ é™¤èµ„æº kubectl delete pod podName åˆ é™¤æŒ‡å®šçš„pod kubectl delete pod -n test podName åˆ é™¤æŒ‡å®šåç§°ç©ºé—´çš„æŒ‡å®špod kubectl delete svc svcNamekubectl delete deploy deployNamekubectl delete ns nsName åˆ é™¤å…¶ä»–èµ„æº kubectl delete pod podName -n nsName --grace-period=0 --forcekubectl delete pod podName -n nsName --grace-period=1kubectl delete pod podName -n nsName --now å¼ºåˆ¶åˆ é™¤ kubectl edit pod podName ç¼–è¾‘èµ„æº 9.çŠ¶æ€ çŠ¶æ€å å«ä¹‰ Running è¿è¡Œä¸­ Error å¼‚å¸¸ï¼Œæ— æ³•æä¾›æœåŠ¡ Pending å‡†å¤‡ä¸­ï¼Œæš‚æ—¶æ— æ³•æä¾›æœåŠ¡ Terminaling ç»“æŸä¸­ï¼Œå³å°†è¢«ç§»é™¤ Unknown æœªçŸ¥çŠ¶æ€ï¼Œå¤šå‘ç”ŸäºèŠ‚ç‚¹å®•æœº PullImageBackOff é•œåƒæ‹‰å–å¤±è´¥ å¿…é¡»å­˜åœ¨çš„å±æ€§ å‚æ•°å å­—æ®µç±»å‹ è¯´æ˜ version String K8S APIç‰ˆæœ¬, å¯ä»¥ä½¿ç”¨kubectl api-versionå‘½ä»¤æŸ¥è¯¢ kind String æŒ‡çš„æ˜¯yamlæ–‡ä»¶å®šä¹‰çš„èµ„æºç±»å‹å’Œè§’è‰², æ¯”å¦‚Pod metadata Object å…ƒæ•°æ®å¯¹è±¡, å›ºå®šå€¼å°±å†™metadata metadata.name String å…ƒæ•°æ®å¯¹è±¡çš„åå­—, æ¯”å¦‚å‘½åPodçš„åå­— metadata.namespace String å…ƒæ•°æ®å¯¹è±¡çš„å‘½åç©ºé—´ Spec Object è¯¦ç»†å®šä¹‰å¯¹è±¡, å›ºå®šå€¼å°±å†™Spec spec.containers[] list Specå¯¹è±¡çš„å®¹å™¨åˆ—è¡¨å®šä¹‰, æ˜¯ä¸ªåˆ—è¡¨ spec.containers[].name String å®¹å™¨çš„åå­— spec.containers[].image String ä½¿ç”¨åˆ°çš„é•œåƒåç§° ä¸»è¦å¯¹è±¡ apiVersion: v1 #å¿…é€‰ï¼Œç‰ˆæœ¬å·ï¼Œä¾‹å¦‚v1ï¼Œå¯ä»¥ç”¨ kubectl api-versions æŸ¥è¯¢åˆ° kind: Pod #å¿…é€‰ï¼ŒæŒ‡yamlæ–‡ä»¶å®šä¹‰çš„k8s èµ„æºç±»å‹æˆ–è§’è‰²ï¼Œæ¯”å¦‚ï¼šPod metadata: #å¿…é€‰ï¼Œå…ƒæ•°æ®å¯¹è±¡ name: string #å¿…é€‰ï¼Œå…ƒæ•°æ®å¯¹è±¡çš„åå­—ï¼Œè‡ªå·±å®šä¹‰ï¼Œæ¯”å¦‚å‘½åPodçš„åå­— namespace: string #å¿…é€‰ï¼Œå…ƒæ•°æ®å¯¹è±¡çš„åç§°ç©ºé—´ï¼Œé»˜è®¤ä¸º&quot;default&quot; labels: #è‡ªå®šä¹‰æ ‡ç­¾ key1: value1 #è‡ªå®šä¹‰æ ‡ç­¾é”®å€¼å¯¹1 key2: value2 #è‡ªå®šä¹‰æ ‡ç­¾é”®å€¼å¯¹2 annotations: #è‡ªå®šä¹‰æ³¨è§£ key1: value1 #è‡ªå®šä¹‰æ³¨è§£é”®å€¼å¯¹1 key2: value2 #è‡ªå®šä¹‰æ³¨è§£é”®å€¼å¯¹2 spec: #å¿…é€‰ï¼Œå¯¹è±¡ã€å¦‚podã€‘çš„è¯¦ç»†å®šä¹‰ containers: #å¿…é€‰ï¼Œspecå¯¹è±¡çš„å®¹å™¨ä¿¡æ¯ - name: string #å¿…é€‰ï¼Œå®¹å™¨åç§° image: string #å¿…é€‰ï¼Œè¦ç”¨åˆ°çš„é•œåƒåç§° imagePullPolicy: [Always|Never|IfNotPresent] #è·å–é•œåƒçš„ç­–ç•¥ï¼›(1)Alwaysï¼šæ„æ€æ˜¯æ¯æ¬¡éƒ½å°è¯•é‡æ–°æ‹‰å–é•œåƒï¼›(2)Neverï¼šè¡¨ç¤ºä»…ä½¿ç”¨æœ¬åœ°é•œåƒï¼Œå³ä½¿æœ¬åœ°æ²¡æœ‰é•œåƒä¹Ÿä¸æ‹‰å–ï¼›(3) IfNotPresentï¼šå¦‚æœæœ¬åœ°æœ‰é•œåƒå°±ä½¿ç”¨æœ¬åœ°é•œåƒï¼Œæ²¡æœ‰å°±æ‹‰å–è¿œç¨‹é•œåƒã€‚é»˜è®¤ï¼šAlways command: [string] #æŒ‡å®šå®¹å™¨å¯åŠ¨å‘½ä»¤ï¼Œç”±äºæ˜¯æ•°ç»„å› æ­¤å¯ä»¥æŒ‡å®šå¤šä¸ªã€‚ä¸æŒ‡å®šåˆ™ä½¿ç”¨é•œåƒæ‰“åŒ…æ—¶æŒ‡å®šçš„å¯åŠ¨å‘½ä»¤ã€‚ args: [string] #æŒ‡å®šå®¹å™¨å¯åŠ¨å‘½ä»¤å‚æ•°ï¼Œç”±äºæ˜¯æ•°ç»„å› æ­¤å¯ä»¥æŒ‡å®šå¤šä¸ª workingDir: string #æŒ‡å®šå®¹å™¨çš„å·¥ä½œç›®å½• volumeMounts: #æŒ‡å®šå®¹å™¨å†…éƒ¨çš„å­˜å‚¨å·é…ç½® - name: string #æŒ‡å®šå¯ä»¥è¢«å®¹å™¨æŒ‚è½½çš„å­˜å‚¨å·çš„åç§°ã€‚è·Ÿä¸‹é¢volumeå­—æ®µçš„nameå€¼ç›¸åŒè¡¨ç¤ºä½¿ç”¨è¿™ä¸ªå­˜å‚¨å· mountPath: string #æŒ‡å®šå¯ä»¥è¢«å®¹å™¨æŒ‚è½½çš„å­˜å‚¨å·çš„è·¯å¾„ï¼Œåº”å°‘äº512å­—ç¬¦ readOnly: boolean #è®¾ç½®å­˜å‚¨å·è·¯å¾„çš„è¯»å†™æ¨¡å¼ï¼Œtrueæˆ–è€…falseï¼Œé»˜è®¤ä¸ºè¯»å†™æ¨¡å¼false ports: #éœ€è¦æš´éœ²çš„ç«¯å£å·åˆ—è¡¨ - name: string #ç«¯å£çš„åç§° containerPort: int #å®¹å™¨ç›‘å¬çš„ç«¯å£å· #é™¤éç»å¯¹å¿…è¦ï¼Œå¦åˆ™ä¸è¦ä¸º Pod æŒ‡å®š hostPortã€‚å°† Pod ç»‘å®šåˆ°hostPortæ—¶ï¼Œå®ƒä¼šé™åˆ¶ Pod å¯ä»¥è°ƒåº¦çš„ä½ç½®æ•° #DaemonSet ä¸­çš„ Pod å¯ä»¥ä½¿ç”¨ hostPortï¼Œä»è€Œå¯ä»¥é€šè¿‡èŠ‚ç‚¹ IP è®¿é—®åˆ° Podï¼›å› ä¸ºDaemonSetæ¨¡å¼ä¸‹Podä¸ä¼šè¢«è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚ #ä¸€èˆ¬æƒ…å†µä¸‹ containerPortä¸hostPortå€¼ç›¸åŒ hostPort: int #å¯ä»¥é€šè¿‡å®¿ä¸»æœº+hostPortçš„æ–¹å¼è®¿é—®è¯¥Podã€‚ä¾‹å¦‚ï¼špodåœ¨/è°ƒåº¦åˆ°äº†k8s-node02ã€172.16.1.112ã€‘ï¼ŒhostPortä¸º8090ï¼Œé‚£ä¹ˆè¯¥Podå¯ä»¥é€šè¿‡172.16.1.112:8090æ–¹å¼è¿›è¡Œè®¿é—®ã€‚ protocol: string #ç«¯å£åè®®ï¼Œæ”¯æŒTCPå’ŒUDPï¼Œé»˜è®¤TCP env: #å®¹å™¨è¿è¡Œå‰éœ€è®¾ç½®çš„ç¯å¢ƒå˜é‡åˆ—è¡¨ - name: string #ç¯å¢ƒå˜é‡åç§° value: string #ç¯å¢ƒå˜é‡çš„å€¼ resources: #èµ„æºé™åˆ¶å’Œèµ„æºè¯·æ±‚çš„è®¾ç½®ï¼ˆè®¾ç½®å®¹å™¨çš„èµ„æºä¸Šçº¿ï¼‰ limits: #å®¹å™¨è¿è¡Œæ—¶èµ„æºä½¿ç”¨çš„ä¸Šçº¿ cpu: string #CPUé™åˆ¶ï¼Œå•ä½ä¸ºcoreæ•°ï¼Œå…è®¸æµ®ç‚¹æ•°ï¼Œå¦‚0.1ç­‰ä»·äº100mï¼Œ0.5ç­‰ä»·äº500mï¼›å› æ­¤å¦‚æœå°äº1é‚£ä¹ˆä¼˜å…ˆé€‰æ‹©å¦‚100mçš„å½¢å¼ï¼Œç²¾åº¦ä¸º1mã€‚è¿™ä¸ªæ•°å­—ç”¨ä½œ docker run å‘½ä»¤ä¸­çš„ --cpu-quota å‚æ•°ã€‚ memory: string #å†…å­˜é™åˆ¶ï¼Œå•ä½ï¼šE,P,T,G,M,Kï¼›æˆ–è€…Ei,Pi,Ti,Gi,Mi,Kiï¼›æˆ–è€…å­—èŠ‚æ•°ã€‚å°†ç”¨äºdocker run --memoryå‚æ•° requests: #å®¹å™¨å¯åŠ¨å’Œè°ƒåº¦æ—¶çš„é™åˆ¶è®¾å®š cpu: string #CPUè¯·æ±‚ï¼Œå®¹å™¨å¯åŠ¨æ—¶åˆå§‹åŒ–å¯ç”¨æ•°é‡ï¼Œå•ä½ä¸ºcoreæ•°ï¼Œå…è®¸æµ®ç‚¹æ•°ï¼Œå¦‚0.1ç­‰ä»·äº100mï¼Œ0.5ç­‰ä»·äº500mï¼›å› æ­¤å¦‚æœå°äº1é‚£ä¹ˆä¼˜å…ˆé€‰æ‹©å¦‚100mçš„å½¢å¼ï¼Œç²¾åº¦ä¸º1mã€‚è¿™ä¸ªæ•°å­—ç”¨ä½œ docker run å‘½ä»¤ä¸­çš„ --cpu-shares å‚æ•°ã€‚ memory: string #å†…å­˜è¯·æ±‚,å®¹å™¨å¯åŠ¨çš„åˆå§‹åŒ–å¯ç”¨æ•°é‡ã€‚å•ä½ï¼šE,P,T,G,M,Kï¼›æˆ–è€…Ei,Pi,Ti,Gi,Mi,Kiï¼›æˆ–è€…å­—èŠ‚æ•° # å‚è§å®˜ç½‘åœ°å€ï¼šhttps://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/ livenessProbe: #å¯¹Podå†…å„å®¹å™¨å¥åº·æ£€æŸ¥çš„è®¾ç½®ï¼Œå½“æ¢æµ‹æ— å“åº”å‡ æ¬¡åå°†è‡ªåŠ¨é‡å¯è¯¥å®¹å™¨ï¼Œæ£€æŸ¥æ–¹æ³•æœ‰execã€httpGetå’ŒtcpSocketï¼Œå¯¹ä¸€ä¸ªå®¹å™¨ã€åªéœ€è®¾ç½®å…¶ä¸­ä¸€ç§æ–¹æ³•å³å¯ã€‘ exec: #å¯¹Podå†…å®¹å™¨å¥åº·æ£€æŸ¥æ–¹å¼è®¾ç½®ä¸ºexecæ–¹å¼ command: [string] #execæ–¹å¼éœ€è¦åˆ¶å®šçš„å‘½ä»¤æˆ–è„šæœ¬ httpGet: #å¯¹Podå†…å®¹å™¨å¥åº·æ£€æŸ¥æ–¹æ³•è®¾ç½®ä¸ºHttpGetï¼Œéœ€è¦åˆ¶å®šPathã€port path: string #è®¿é—® HTTP æœåŠ¡çš„è·¯å¾„ port: number #è®¿é—®å®¹å™¨çš„ç«¯å£å·æˆ–è€…ç«¯å£åã€‚å¦‚æœæ•°å­—å¿…é¡»åœ¨ 1 ~ 65535 ä¹‹é—´ã€‚ host: string #å½“æ²¡æœ‰å®šä¹‰ &quot;host&quot; æ—¶ï¼Œä½¿ç”¨ &quot;PodIP&quot; scheme: string #å½“æ²¡æœ‰å®šä¹‰ &quot;scheme&quot; æ—¶ï¼Œä½¿ç”¨ &quot;HTTP&quot;ï¼Œscheme åªå…è®¸ &quot;HTTP&quot; å’Œ &quot;HTTPS&quot; HttpHeaders: #è¯·æ±‚ä¸­è‡ªå®šä¹‰çš„ HTTP å¤´ã€‚HTTP å¤´å­—æ®µå…è®¸é‡å¤ã€‚ - name: string value: string tcpSocket: #å¯¹Podå†…å®¹å™¨å¥åº·æ£€æŸ¥æ–¹å¼è®¾ç½®ä¸ºtcpSocketæ–¹å¼ port: number initialDelaySeconds: 5 #å®¹å™¨å¯åŠ¨å®Œæˆåï¼Œkubeletåœ¨æ‰§è¡Œç¬¬ä¸€æ¬¡æ¢æµ‹å‰åº”è¯¥ç­‰å¾… 5 ç§’ã€‚é»˜è®¤æ˜¯ 0 ç§’ï¼Œæœ€å°å€¼æ˜¯ 0ã€‚ periodSeconds: 60 #æŒ‡å®š kubelet æ¯éš” 60 ç§’æ‰§è¡Œä¸€æ¬¡å­˜æ´»æ¢æµ‹ã€‚é»˜è®¤æ˜¯ 10 ç§’ã€‚æœ€å°å€¼æ˜¯ 1 timeoutSeconds: 3 #å¯¹å®¹å™¨å¥åº·æ£€æŸ¥æ¢æµ‹ç­‰å¾…å“åº”çš„è¶…æ—¶æ—¶é—´ä¸º 3 ç§’ï¼Œé»˜è®¤1ç§’ successThreshold: 1 #æ£€æµ‹åˆ°æœ‰1æ¬¡æˆåŠŸåˆ™è®¤ä¸ºæœåŠ¡æ˜¯`å°±ç»ª` failureThreshold: 5 #æ£€æµ‹åˆ°æœ‰5æ¬¡å¤±è´¥åˆ™è®¤ä¸ºæœåŠ¡æ˜¯`æœªå°±ç»ª`ã€‚é»˜è®¤å€¼æ˜¯ 3ï¼Œæœ€å°å€¼æ˜¯ 1ã€‚ restartPolicy: [Always|Never|OnFailure] #Podçš„é‡å¯ç­–ç•¥ï¼Œé»˜è®¤Alwaysã€‚Alwaysè¡¨ç¤ºä¸€æ—¦ä¸ç®¡ä»¥ä½•ç§æ–¹å¼ç»ˆæ­¢è¿è¡Œï¼Œkubeletéƒ½å°†é‡å¯ï¼›OnFailureè¡¨ç¤ºåªæœ‰Podä»¥é0é€€å‡ºç é€€å‡ºæ‰é‡å¯ï¼›Nerverè¡¨ç¤ºä¸å†é‡å¯è¯¥Pod nodeSelector: #å®šä¹‰Nodeçš„labelè¿‡æ»¤æ ‡ç­¾ï¼Œä»¥keyï¼švalueçš„æ ¼å¼æŒ‡å®šã€‚èŠ‚ç‚¹é€‰æ‹©ï¼Œå…ˆç»™ä¸»æœºæ‰“æ ‡ç­¾kubectl label nodes kube-node01 key1=value1 key1: value1 imagePullSecrets: #Pullé•œåƒæ—¶ä½¿ç”¨çš„secretåç§°ï¼Œä»¥nameï¼šsecretKeyNameæ ¼å¼æŒ‡å®š - name: string hostNetwork: false #æ˜¯å¦ä½¿ç”¨ä¸»æœºç½‘ç»œæ¨¡å¼ï¼Œé»˜è®¤ä¸ºfalseã€‚å¦‚æœè®¾ç½®ä¸ºtrueï¼Œè¡¨ç¤ºä½¿ç”¨å®¿ä¸»æœºç½‘ç»œï¼Œä¸ä½¿ç”¨dockerç½‘æ¡¥ # volumes å’Œ containers æ˜¯åŒå±‚çº§ ****************************** # å‚è§å®˜ç½‘åœ°å€ï¼šhttps://kubernetes.io/zh/docs/concepts/storage/volumes/ volumes: #å®šä¹‰äº†paueså®¹å™¨å…³è”çš„å®¿ä¸»æœºæˆ–åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨å·åˆ—è¡¨ ï¼ˆvolumesç±»å‹æœ‰å¾ˆå¤šç§ï¼Œé€‰å…¶ä¸­ä¸€ç§å³å¯ï¼‰ - name: string #å…±äº«å­˜å‚¨å·åç§°ã€‚ emptyDir: {} #ç±»å‹ä¸ºemtyDirçš„å­˜å‚¨å·ï¼Œä¸PodåŒç”Ÿå‘½å‘¨æœŸçš„ä¸€ä¸ªä¸´æ—¶ç›®å½•ã€‚å½“Podå› ä¸ºæŸäº›åŸå› è¢«ä»èŠ‚ç‚¹ä¸Šåˆ é™¤æ—¶ï¼ŒemptyDirå·ä¸­çš„æ•°æ®ä¹Ÿä¼šæ°¸ä¹…åˆ é™¤ã€‚ hostPath: string #ç±»å‹ä¸ºhostPathçš„å­˜å‚¨å·ï¼Œè¡¨ç¤ºæŒ‚è½½Podæ‰€åœ¨å®¿ä¸»æœºçš„æ–‡ä»¶æˆ–ç›®å½• path: string #åœ¨å®¿ä¸»æœºä¸Šæ–‡ä»¶æˆ–ç›®å½•çš„è·¯å¾„ type: [|DirectoryOrCreate|Directory|FileOrCreate|File] #ç©ºå­—ç¬¦ä¸²ï¼ˆé»˜è®¤ï¼‰ç”¨äºå‘åå…¼å®¹ï¼Œè¿™æ„å‘³ç€åœ¨å®‰è£… hostPath å·ä¹‹å‰ä¸ä¼šæ‰§è¡Œä»»ä½•æ£€æŸ¥ã€‚DirectoryOrCreateï¼šå¦‚æœç»™å®šç›®å½•ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œæƒé™è®¾ç½®ä¸º 0755ï¼Œå…·æœ‰ä¸ Kubelet ç›¸åŒçš„ç»„å’Œæ‰€æœ‰æƒã€‚Directoryï¼šç»™å®šç›®å½•å¿…é¡»å­˜åœ¨ã€‚FileOrCreateï¼šå¦‚æœç»™å®šæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºç©ºæ–‡ä»¶ï¼Œæƒé™è®¾ç½®ä¸º 0644ï¼Œå…·æœ‰ä¸ Kubelet ç›¸åŒçš„ç»„å’Œæ‰€æœ‰æƒã€‚Fileï¼šç»™å®šæ–‡ä»¶å¿…é¡»å­˜åœ¨ã€‚ secret: #ç±»å‹ä¸ºsecretçš„å­˜å‚¨å·ï¼ŒæŒ‚è½½é›†ç¾¤é¢„å®šä¹‰çš„secreå¯¹è±¡åˆ°å®¹å™¨å†…éƒ¨ã€‚Secret æ˜¯ä¸€ç§åŒ…å«å°‘é‡æ•æ„Ÿä¿¡æ¯ä¾‹å¦‚å¯†ç ã€token æˆ– key çš„å¯¹è±¡ã€‚æ”¾åœ¨ä¸€ä¸ª secret å¯¹è±¡ä¸­å¯ä»¥æ›´å¥½åœ°æ§åˆ¶å®ƒçš„ç”¨é€”ï¼Œå¹¶é™ä½æ„å¤–æš´éœ²çš„é£é™©ã€‚ secretName: string #secret å¯¹è±¡çš„åå­— items: #å¯é€‰ï¼Œä¿®æ”¹key çš„ç›®æ ‡è·¯å¾„ - key: username #username secretå­˜å‚¨åœ¨/etc/foo/my-group/my-username æ–‡ä»¶ä¸­è€Œä¸æ˜¯ /etc/foo/username ä¸­ã€‚ã€æ­¤æ—¶å­˜åœ¨spec.containers[].volumeMounts[].mountPathä¸º/etc/fooã€‘ path: my-group/my-username configMap: #ç±»å‹ä¸ºconfigMapçš„å­˜å‚¨å·ï¼ŒæŒ‚è½½é¢„å®šä¹‰çš„configMapå¯¹è±¡åˆ°å®¹å™¨å†…éƒ¨ã€‚ConfigMap å…è®¸æ‚¨å°†é…ç½®æ–‡ä»¶ä¸é•œåƒæ–‡ä»¶åˆ†ç¦»ï¼Œä»¥ä½¿å®¹å™¨åŒ–çš„åº”ç”¨ç¨‹åºå…·æœ‰å¯ç§»æ¤æ€§ã€‚ name: string #æä¾›ä½ æƒ³è¦æŒ‚è½½çš„ ConfigMap çš„åå­— kubectl explain podå‘½ä»¤å¯ä»¥æŸ¥çœ‹èµ„æºçš„æ¨¡æ¿ kubectl explain pod.apiVersion æŸ¥çœ‹è¯¦ç»†å­—æ®µ ","link":"https://tianxiawuhao.github.io/HhauOMn26/"},{"title":"k8s-ingresså®‰è£…ä½¿ç”¨","content":"1.Nginx ingresså®‰è£… é¦–å…ˆéœ€è¦å®‰è£…Nginx Ingress Controlleræ§åˆ¶å™¨ï¼Œæ§åˆ¶å™¨å®‰è£…æ–¹å¼åŒ…å«ä¸¤ç§ï¼šDaemonSetså’ŒDeploymentsã€‚ DaemonSetsé€šè¿‡hostPortçš„æ–¹å¼æš´éœ²80å’Œ443ç«¯å£ï¼Œå¯é€šè¿‡Nodeçš„è°ƒåº¦ç”±ä¸“é—¨çš„èŠ‚ç‚¹å®ç°éƒ¨ç½² Deploymentsåˆ™é€šè¿‡NodePortçš„æ–¹å¼å®ç°æ§åˆ¶å™¨ç«¯å£çš„æš´éœ²ï¼Œå€ŸåŠ©å¤–éƒ¨è´Ÿè½½å‡è¡¡å®ç°é«˜å¯ç”¨è´Ÿè½½å‡è¡¡ é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜éœ€è¦éƒ¨ç½²Namespaceï¼ŒServiceAccountï¼ŒRBACï¼ŒSecretsï¼ŒCustom Resource Definitionsç­‰èµ„æºï¼Œå¦‚ä¸‹å¼€å§‹éƒ¨ç½²ã€‚ 1.1 åŸºç¡€ä¾èµ–ç¯å¢ƒå‡†å¤‡ 1ã€githubä¸­ä¸‹è½½æºç åŒ…,å®‰è£…éƒ¨ç½²æ–‡ä»¶åœ¨kubernetes-ingress/deployments/ç›®å½•ä¸‹ git clone https://github.com/nginxinc/kubernetes-ingress.git kubernetes-ingress/deployments/ â”œâ”€â”€ common â”‚ â”œâ”€â”€ custom-resource-definitions.yaml è‡ªå®šä¹‰èµ„æº â”‚ â”œâ”€â”€ default-server-secret.yaml Secrets â”‚ â”œâ”€â”€ nginx-config.yaml â”‚ â””â”€â”€ ns-and-sa.yaml Namspace+ServiceAccount â”œâ”€â”€ daemon-set â”‚ â”œâ”€â”€ nginx-ingress.yaml DaemonSetsæ§åˆ¶å™¨ â”‚ â””â”€â”€ nginx-plus-ingress.yaml â”œâ”€â”€ deployment â”‚ â”œâ”€â”€ nginx-ingress.yaml Deploymentsæ§åˆ¶å™¨ â”‚ â””â”€â”€ nginx-plus-ingress.yaml â”œâ”€â”€ helm-chart Helmå®‰è£…åŒ… â”‚ â”œâ”€â”€ chart-icon.png â”‚ â”œâ”€â”€ Chart.yaml â”‚ â”œâ”€â”€ README.md â”‚ â”œâ”€â”€ templates â”‚ â”‚ â”œâ”€â”€ controller-configmap.yaml â”‚ â”‚ â”œâ”€â”€ controller-custom-resources.yaml â”‚ â”‚ â”œâ”€â”€ controller-daemonset.yaml â”‚ â”‚ â”œâ”€â”€ controller-deployment.yaml â”‚ â”‚ â”œâ”€â”€ controller-leader-election-configmap.yaml â”‚ â”‚ â”œâ”€â”€ controller-secret.yaml â”‚ â”‚ â”œâ”€â”€ controller-serviceaccount.yaml â”‚ â”‚ â”œâ”€â”€ controller-service.yaml â”‚ â”‚ â”œâ”€â”€ controller-wildcard-secret.yaml â”‚ â”‚ â”œâ”€â”€ _helpers.tpl â”‚ â”‚ â”œâ”€â”€ NOTES.txt â”‚ â”‚ â””â”€â”€ rbac.yaml â”‚ â”œâ”€â”€ values-icp.yaml â”‚ â”œâ”€â”€ values-plus.yaml â”‚ â””â”€â”€ values.yaml â”œâ”€â”€ rbac RBACè®¤è¯æˆæƒ â”‚ â””â”€â”€ rbac.yaml â”œâ”€â”€ README.md â””â”€â”€ service Serviceå®šä¹‰ â”œâ”€â”€ loadbalancer-aws-elb.yaml â”œâ”€â”€ loadbalancer.yaml DaemonSetsæš´éœ²æœåŠ¡æ–¹å¼ â””â”€â”€ nodeport.yaml Deploymentsæš´éœ²æœåŠ¡æ–¹å¼ **2ã€åˆ›å»ºNamespaceå’ŒServiceAccount ** cat common/ns-and-sa.yaml apiVersion: v1 kind: Namespace metadata: name: nginx-ingress --- apiVersion: v1 kind: ServiceAccount metadata: name: nginx-ingress namespace: nginx-ingress kubectl apply -f common/ns-and-sa.yaml 3ã€åˆ›å»ºSecretsè‡ªç­¾åè¯ä¹¦ kubectl apply -f common/default-server-secret.yaml apiVersion: v1 kind: Secret metadata: name: default-server-secret namespace: nginx-ingress type: Opaque data: tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN2akNDQWFZQ0NRREFPRjl0THNhWFhEQU5CZ2txaGtpRzl3MEJBUXNGQURBaE1SOHdIUVlEVlFRRERCWk8KUjBsT1dFbHVaM0psYzNORGIyNTBjbTlzYkdWeU1CNFhEVEU0TURreE1qRTRNRE16TlZvWERUSXpNRGt4TVRFNApNRE16TlZvd0lURWZNQjBHQTFVRUF3d1dUa2RKVGxoSmJtZHlaWE56UTI5dWRISnZiR3hsY2pDQ0FTSXdEUVlKCktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQUwvN2hIUEtFWGRMdjNyaUM3QlBrMTNpWkt5eTlyQ08KR2xZUXYyK2EzUDF0azIrS3YwVGF5aGRCbDRrcnNUcTZzZm8vWUk1Y2Vhbkw4WGM3U1pyQkVRYm9EN2REbWs1Qgo4eDZLS2xHWU5IWlg0Rm5UZ0VPaStlM2ptTFFxRlBSY1kzVnNPazFFeUZBL0JnWlJVbkNHZUtGeERSN0tQdGhyCmtqSXVuektURXUyaDU4Tlp0S21ScUJHdDEwcTNRYzhZT3ExM2FnbmovUWRjc0ZYYTJnMjB1K1lYZDdoZ3krZksKWk4vVUkxQUQ0YzZyM1lma1ZWUmVHd1lxQVp1WXN2V0RKbW1GNWRwdEMzN011cDBPRUxVTExSakZJOTZXNXIwSAo1TmdPc25NWFJNV1hYVlpiNWRxT3R0SmRtS3FhZ25TZ1JQQVpQN2MwQjFQU2FqYzZjNGZRVXpNQ0F3RUFBVEFOCkJna3Foa2lHOXcwQkFRc0ZBQU9DQVFFQWpLb2tRdGRPcEsrTzhibWVPc3lySmdJSXJycVFVY2ZOUitjb0hZVUoKdGhrYnhITFMzR3VBTWI5dm15VExPY2xxeC9aYzJPblEwMEJCLzlTb0swcitFZ1U2UlVrRWtWcitTTFA3NTdUWgozZWI4dmdPdEduMS9ienM3bzNBaS9kclkrcUI5Q2k1S3lPc3FHTG1US2xFaUtOYkcyR1ZyTWxjS0ZYQU80YTY3Cklnc1hzYktNbTQwV1U3cG9mcGltU1ZmaXFSdkV5YmN3N0NYODF6cFErUyt1eHRYK2VBZ3V0NHh3VlI5d2IyVXYKelhuZk9HbWhWNThDd1dIQnNKa0kxNXhaa2VUWXdSN0diaEFMSkZUUkk3dkhvQXprTWIzbjAxQjQyWjNrN3RXNQpJUDFmTlpIOFUvOWxiUHNoT21FRFZkdjF5ZytVRVJxbStGSis2R0oxeFJGcGZnPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo= tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBdi91RWM4b1JkMHUvZXVJTHNFK1RYZUprckxMMnNJNGFWaEMvYjVyYy9XMlRiNHEvClJOcktGMEdYaVN1eE9ycXgrajlnamx4NXFjdnhkenRKbXNFUkJ1Z1B0ME9hVGtIekhvb3FVWmcwZGxmZ1dkT0EKUTZMNTdlT1l0Q29VOUZ4amRXdzZUVVRJVUQ4R0JsRlNjSVo0b1hFTkhzbysyR3VTTWk2Zk1wTVM3YUhudzFtMApxWkdvRWEzWFNyZEJ6eGc2clhkcUNlUDlCMXl3VmRyYURiUzc1aGQzdUdETDU4cGszOVFqVUFQaHpxdmRoK1JWClZGNGJCaW9CbTVpeTlZTW1hWVhsMm0wTGZzeTZuUTRRdFFzdEdNVWozcGJtdlFmazJBNnljeGRFeFpkZFZsdmwKMm82MjBsMllxcHFDZEtCRThCay90elFIVTlKcU56cHpoOUJUTXdJREFRQUJBb0lCQVFDZklHbXowOHhRVmorNwpLZnZJUXQwQ0YzR2MxNld6eDhVNml4MHg4Mm15d1kxUUNlL3BzWE9LZlRxT1h1SENyUlp5TnUvZ2IvUUQ4bUFOCmxOMjRZTWl0TWRJODg5TEZoTkp3QU5OODJDeTczckM5bzVvUDlkazAvYzRIbjAzSkVYNzZ5QjgzQm9rR1FvYksKMjhMNk0rdHUzUmFqNjd6Vmc2d2szaEhrU0pXSzBwV1YrSjdrUkRWYmhDYUZhNk5nMUZNRWxhTlozVDhhUUtyQgpDUDNDeEFTdjYxWTk5TEI4KzNXWVFIK3NYaTVGM01pYVNBZ1BkQUk3WEh1dXFET1lvMU5PL0JoSGt1aVg2QnRtCnorNTZud2pZMy8yUytSRmNBc3JMTnIwMDJZZi9oY0IraVlDNzVWYmcydVd6WTY3TWdOTGQ5VW9RU3BDRkYrVm4KM0cyUnhybnhBb0dCQU40U3M0ZVlPU2huMVpQQjdhTUZsY0k2RHR2S2ErTGZTTXFyY2pOZjJlSEpZNnhubmxKdgpGenpGL2RiVWVTbWxSekR0WkdlcXZXaHFISy9iTjIyeWJhOU1WMDlRQ0JFTk5jNmtWajJTVHpUWkJVbEx4QzYrCk93Z0wyZHhKendWelU0VC84ajdHalRUN05BZVpFS2FvRHFyRG5BYWkyaW5oZU1JVWZHRXFGKzJyQW9HQkFOMVAKK0tZL0lsS3RWRzRKSklQNzBjUis3RmpyeXJpY05iWCtQVzUvOXFHaWxnY2grZ3l4b25BWlBpd2NpeDN3QVpGdwpaZC96ZFB2aTBkWEppc1BSZjRMazg5b2pCUmpiRmRmc2l5UmJYbyt3TFU4NUhRU2NGMnN5aUFPaTVBRHdVU0FkCm45YWFweUNweEFkREtERHdObit3ZFhtaTZ0OHRpSFRkK3RoVDhkaVpBb0dCQUt6Wis1bG9OOTBtYlF4VVh5YUwKMjFSUm9tMGJjcndsTmVCaWNFSmlzaEhYa2xpSVVxZ3hSZklNM2hhUVRUcklKZENFaHFsV01aV0xPb2I2NTNyZgo3aFlMSXM1ZUtka3o0aFRVdnpldm9TMHVXcm9CV2xOVHlGanIrSWhKZnZUc0hpOGdsU3FkbXgySkJhZUFVWUNXCndNdlQ4NmNLclNyNkQrZG8wS05FZzFsL0FvR0FlMkFVdHVFbFNqLzBmRzgrV3hHc1RFV1JqclRNUzRSUjhRWXQKeXdjdFA4aDZxTGxKUTRCWGxQU05rMXZLTmtOUkxIb2pZT2pCQTViYjhibXNVU1BlV09NNENoaFJ4QnlHbmR2eAphYkJDRkFwY0IvbEg4d1R0alVZYlN5T294ZGt5OEp0ek90ajJhS0FiZHd6NlArWDZDODhjZmxYVFo5MWpYL3RMCjF3TmRKS2tDZ1lCbyt0UzB5TzJ2SWFmK2UwSkN5TGhzVDQ5cTN3Zis2QWVqWGx2WDJ1VnRYejN5QTZnbXo5aCsKcDNlK2JMRUxwb3B0WFhNdUFRR0xhUkcrYlNNcjR5dERYbE5ZSndUeThXczNKY3dlSTdqZVp2b0ZpbmNvVlVIMwphdmxoTUVCRGYxSjltSDB5cDBwWUNaS2ROdHNvZEZtQktzVEtQMjJhTmtsVVhCS3gyZzR6cFE9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo= 4ã€åˆ›å»ºConfigMapè‡ªå®šä¹‰é…ç½®æ–‡ kubectl apply -f common/nginx-config.yaml kind: ConfigMap apiVersion: v1 metadata: name: nginx-config namespace: nginx-ingress data: 5ã€ä¸ºä¸»æœºå’Œä¸»æœºè·¯ç”±å®šä¹‰è‡ªå®šä¹‰èµ„æºï¼Œæ”¯æŒè‡ªå®šä¹‰ä¸»æœºå’Œè·¯ç”± kubectl apply -f common/custom-resource-definitions.yaml apiVersion: apiextensions.k8s.io/v1beta1 kind: CustomResourceDefinition metadata: name: virtualservers.k8s.nginx.org spec: group: k8s.nginx.org versions: - name: v1 served: true storage: true scope: Namespaced names: plural: virtualservers singular: virtualserver kind: VirtualServer shortNames: - vs --- apiVersion: apiextensions.k8s.io/v1beta1 kind: CustomResourceDefinition metadata: name: virtualserverroutes.k8s.nginx.org spec: group: k8s.nginx.org versions: - name: v1 served: true storage: true scope: Namespaced names: plural: virtualserverroutes singular: virtualserverroute kind: VirtualServerRoute shortNames: - vsr 6ã€é…ç½®RBACè®¤è¯æˆæƒï¼Œå®ç°ingressæ§åˆ¶å™¨è®¿é—®é›†ç¾¤ä¸­çš„å…¶ä»–èµ„æº kubectl apply -f rbac/rbac.yaml kind: ClusterRole apiVersion: rbac.authorization.k8s.io/v1beta1 metadata: name: nginx-ingress rules: - apiGroups: - &quot;&quot; resources: - services - endpoints verbs: - get - list - watch - apiGroups: - &quot;&quot; resources: - secrets verbs: - get - list - watch - apiGroups: - &quot;&quot; resources: - configmaps verbs: - get - list - watch - update - create - apiGroups: - &quot;&quot; resources: - pods verbs: - list - watch - apiGroups: - &quot;&quot; resources: - events verbs: - create - patch - apiGroups: - extensions resources: - ingresses verbs: - list - watch - get - apiGroups: - &quot;extensions&quot; resources: - ingresses/status verbs: - update - apiGroups: - k8s.nginx.org resources: - virtualservers - virtualserverroutes verbs: - list - watch - get --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1beta1 metadata: name: nginx-ingress subjects: - kind: ServiceAccount name: nginx-ingress namespace: nginx-ingress roleRef: kind: ClusterRole name: nginx-ingress apiGroup: rbac.authorization.k8s.io 1.2 éƒ¨ç½²Ingressæ§åˆ¶å™¨ 1ã€ éƒ¨ç½²æ§åˆ¶å™¨ï¼Œæ§åˆ¶å™¨å¯ä»¥DaemonSetså’ŒDeploymentçš„å½¢å¼éƒ¨ç½²ï¼Œå¦‚ä¸‹æ˜¯DaemonSetsçš„é…ç½®æ–‡ä»¶ apiVersion: apps/v1 kind: DaemonSet metadata: name: nginx-ingress namespace: nginx-ingress spec: selector: matchLabels: app: nginx-ingress template: metadata: labels: app: nginx-ingress #annotations: #prometheus.io/scrape: &quot;true&quot; #prometheus.io/port: &quot;9113&quot; spec: serviceAccountName: nginx-ingress containers: - image: nginx/nginx-ingress:edge imagePullPolicy: Always name: nginx-ingress ports: - name: http containerPort: 80 hostPort: 80 #é€šè¿‡hostPortçš„æ–¹å¼æš´éœ²ç«¯å£ - name: https containerPort: 443 hostPort: 443 #- name: prometheus #containerPort: 9113 securityContext: allowPrivilegeEscalation: true runAsUser: 101 #nginx capabilities: drop: - ALL add: - NET_BIND_SERVICE env: - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace - name: POD_NAME valueFrom: fieldRef: fieldPath: metadata.name args: - -nginx-configmaps=$(POD_NAMESPACE)/nginx-config - -default-server-tls-secret=$(POD_NAMESPACE)/default-server-secret #- -v=3 # Enables extensive logging. Useful for troubleshooting. #- -report-ingress-status #- -external-service=nginx-ingress #- -enable-leader-election #- -enable-prometheus-metrics Deploymentsçš„é…ç½®æ–‡ä»¶ apiVersion: apps/v1 kind: Deployment metadata: name: nginx-ingress namespace: nginx-ingress spec: replicas: 1 #å‰¯æœ¬çš„ä¸ªæ•° selector: matchLabels: app: nginx-ingress template: metadata: labels: app: nginx-ingress #annotations: #prometheus.io/scrape: &quot;true&quot; #prometheus.io/port: &quot;9113&quot; spec: serviceAccountName: nginx-ingress containers: - image: nginx/nginx-ingress:edge imagePullPolicy: Always name: nginx-ingress ports: #å†…éƒ¨æš´éœ²çš„æœåŠ¡ç«¯å£ï¼Œéœ€è¦é€šè¿‡NodePortçš„æ–¹å¼æš´éœ²ç»™å¤–éƒ¨ - name: http containerPort: 80 - name: https containerPort: 443 #- name: prometheus #containerPort: 9113 securityContext: allowPrivilegeEscalation: true runAsUser: 101 #nginx capabilities: drop: - ALL add: - NET_BIND_SERVICE env: - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace - name: POD_NAME valueFrom: fieldRef: fieldPath: metadata.name args: - -nginx-configmaps=$(POD_NAMESPACE)/nginx-config - -default-server-tls-secret=$(POD_NAMESPACE)/default-server-secret #- -v=3 # Enables extensive logging. Useful for troubleshooting. #- -report-ingress-status #- -external-service=nginx-ingress #- -enable-leader-election #- -enable-prometheus-metrics 2ã€æˆ‘ä»¬ä»¥DaemonSetsçš„æ–¹å¼éƒ¨ç½²ï¼ŒDaemonSetéƒ¨ç½²é›†ç¾¤ä¸­å„ä¸ªèŠ‚ç‚¹éƒ½æ˜¯å¯¹ç­‰ï¼Œå¦‚æœæœ‰å¤–éƒ¨LoadBalanceråˆ™é€šè¿‡å¤–éƒ¨è´Ÿè½½å‡è¡¡è·¯ç”±è‡³Ingressä¸­ [root@node-1 deployments]# kubectl apply -f daemon-set/nginx-ingress.yaml daemonset.apps/nginx-ingress created [root@node-1 deployments]# kubectl get daemonsets -n nginx-ingress NAME DESIRED CURRENT READY UP-TO-DATE AVAILABLE NODE SELECTOR AGE nginx-ingress 3 3 3 3 3 &lt;none&gt; 15s [root@node-1 ~]# kubectl get pods -n nginx-ingress -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES nginx-ingress-7mpfc 1/1 Running 0 2m44s 10.244.0.50 node-1 &lt;none&gt; &lt;none&gt; nginx-ingress-l2rtj 1/1 Running 0 2m44s 10.244.1.144 node-2 &lt;none&gt; &lt;none&gt; nginx-ingress-tgf6r 1/1 Running 0 2m44s 10.244.2.160 node-3 &lt;none&gt; &lt;none&gt; 3ã€æ ¡éªŒNginx Ingresså®‰è£…æƒ…å†µ æ­¤æ—¶ä¸‰ä¸ªèŠ‚ç‚¹å‡æ˜¯å¯¹ç­‰ï¼Œå³è®¿é—®ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹å‡èƒ½å®ç°ç›¸åŒçš„æ•ˆæœï¼Œç»Ÿä¸€å…¥å£åˆ™é€šè¿‡å¤–éƒ¨è´Ÿè½½å‡è¡¡ï¼Œå¦‚æœåœ¨äº‘ç¯å¢ƒä¸‹æ‰§è¡Œkubectl apply -f service/loadbalancer.yamlåˆ›å»ºå¤–éƒ¨è´Ÿè½½å‡è¡¡å®ç°å…¥å£è°ƒåº¦ï¼Œè‡ªå»ºçš„å¯ä»¥é€šè¿‡lvsæˆ–nginxç­‰è´Ÿè½½å‡è¡¡å®ç°æ¥å…¥ã€‚ å¤‡æ³¨è¯´æ˜ï¼šå¦‚æœä»¥Deploymentsçš„æ–¹å¼éƒ¨ç½²ï¼Œåˆ™éœ€è¦æ‰§è¡Œservice/nodeport.yamlåˆ›å»ºNodePortç±»å‹çš„Serviceï¼Œå®ç°çš„æ•ˆæœå’ŒDaemonSetsç±»ä¼¼ã€‚ 2. Ingressèµ„æºå®šä¹‰ ä¸Šé¢çš„å·²å®‰è£…äº†ä¸€ä¸ªNginx Ingress Controlleræ§åˆ¶å™¨ï¼Œæœ‰äº†Ingressæ§åˆ¶å™¨åï¼Œæˆ‘ä»¬å°±å¯ä»¥å®šä¹‰Ingressèµ„æºæ¥å®ç°ä¸ƒå±‚è´Ÿè½½è½¬å‘äº†ï¼Œå¤§ä½“ä¸ŠIngressæ”¯æŒä¸‰ç§ä½¿ç”¨æ–¹å¼ï¼š1. åŸºäºè™šæ‹Ÿä¸»æœºè½¬å‘ï¼Œ2. åŸºäºè™šæ‹Ÿæœºä¸»æœºURIè½¬å‘ï¼Œ3. æ”¯æŒTLSåŠ å¯†è½¬å‘ã€‚ 2.1 Ingresså®šä¹‰ 1ã€ç¯å¢ƒå‡†å¤‡ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªnginxçš„Deploymentåº”ç”¨ï¼ŒåŒ…å«2ä¸ªå‰¯æœ¬ [root@node-1 ~]# kubectl run ingress-demo --image=nginx:1.7.9 --port=80 --replicas=2 [root@node-1 ~]# kubectl get deployments NAME READY UP-TO-DATE AVAILABLE AGE ingress-demo 2/2 2 2 116s 2ã€ä»¥serviceæ–¹å¼æš´éœ²æœåŠ¡ç«¯å£ [root@node-1 ~]# kubectl expose deployment ingress-demo --port=80 --protocol=TCP --target-port=80 service/ingress-demo exposed [root@node-1 ~]# kubectl get services NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE ingress-demo ClusterIP 10.109.33.91 &lt;none&gt; 80/TCP 2m15s 3ã€ä¸Šè¿°ä¸¤ä¸ªæ­¥éª¤å·²åˆ›å»ºäº†ä¸€ä¸ªserviceï¼Œå¦‚ä¸‹æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªingresså¯¹è±¡å°†æµé‡è½¬å‘è‡³ingress-demoè¿™ä¸ªserviceï¼Œé€šè¿‡ingress.classæŒ‡å®šæ§åˆ¶å™¨çš„ç±»å‹ä¸ºnginx [root@node-1 nginx-ingress]# cat nginx-ingress-demo.yaml apiVersion: extensions/v1beta1 kind: Ingress metadata: name: nginx-ingress-demo labels: ingres-controller: nginx annotations: kubernets.io/ingress.class: nginx spec: rules: - host: www.test.cn http: paths: - path: / backend: serviceName: ingress-demo servicePort: 80 4ã€åˆ›å»ºingresså¯¹è±¡ [root@node-1 nginx-ingress]# kubectl apply -f nginx-ingress-demo.yaml ingress.extensions/nginx-ingress-demo created æŸ¥çœ‹ingressèµ„æºåˆ—è¡¨ [root@node-1 nginx-ingress]# kubectl get ingresses NAME HOSTS ADDRESS PORTS AGE nginx-ingress-demo www.test.cn 80 4m4s 5ã€æŸ¥çœ‹ingressè¯¦æƒ…ï¼Œå¯ä»¥åœ¨Rulesè§„åˆ™ä¸­çœ‹åˆ°åç«¯Podçš„åˆ—è¡¨ï¼Œè‡ªåŠ¨å‘ç°å’Œå…³è”ç›¸å…³Pod [root@node-1 ~]# kubectl describe ingresses nginx-ingress-demo Name: nginx-ingress-demo Namespace: default Address: Default backend: default-http-backend:80 (&lt;none&gt;) Rules: Host Path Backends ---- ---- -------- www.test.cn / ingress-demo:80 (10.244.1.146:80,10.244.2.162:80) Annotations: kubectl.kubernetes.io/last-applied-configuration: {&quot;apiVersion&quot;:&quot;extensions/v1beta1&quot;,&quot;kind&quot;:&quot;Ingress&quot;,&quot;metadata&quot;:{&quot;annotations&quot;:{&quot;kubernets.io/ingress.class&quot;:&quot;nginx&quot;},&quot;labels&quot;:{&quot;ingres-controller&quot;:&quot;nginx&quot;},&quot;name&quot;:&quot;nginx-ingress-demo&quot;,&quot;namespace&quot;:&quot;default&quot;},&quot;spec&quot;:{&quot;rules&quot;:[{&quot;host&quot;:&quot;www.happylaulab.cn&quot;,&quot;http&quot;:{&quot;paths&quot;:[{&quot;backend&quot;:{&quot;serviceName&quot;:&quot;ingress-demo&quot;,&quot;servicePort&quot;:80},&quot;path&quot;:&quot;/&quot;}]}}]}} kubernets.io/ingress.class: nginx Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal AddedOrUpdated 9m7s nginx-ingress-controller Configuration for default/nginx-ingress-demo was added or updated Normal AddedOrUpdated 9m7s nginx-ingress-controller Configuration for default/nginx-ingress-demo was added or updated Normal AddedOrUpdated 9m7s nginx-ingress-controller Configuration for default/nginx-ingress-demo was added or updated 6ã€æµ‹è¯•éªŒè¯ ingressè§„åˆ™çš„é…ç½®ä¿¡æ¯å·²æ³¨å…¥åˆ°Ingress Controllerä¸­ï¼Œç¯å¢ƒä¸­Ingress Controlleræ˜¯ä»¥DaemonSetsçš„æ–¹å¼éƒ¨ç½²åœ¨é›†ç¾¤ä¸­ï¼Œå¦‚æœæœ‰å¤–éƒ¨çš„è´Ÿè½½å‡è¡¡ï¼Œåˆ™å°†www.test.cnåŸŸåçš„åœ°å€è§£æä¸ºè´Ÿè½½å‡è¡¡VIPã€‚ç”±äºæµ‹è¯•ç¯å¢ƒæ²¡æœ‰æ­å»ºè´Ÿè½½å‡è¡¡ï¼Œå°†hostsè§£ææ‰§è¡Œnode-1ï¼Œnode-2æˆ–è€…node-3ä»»æ„ä¸€ä¸ªIPéƒ½èƒ½å®ç°ç›¸åŒçš„åŠŸèƒ½ã€‚ ä¸Šè¿°æµ‹è¯•è§£ææ­£å¸¸ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è§£æä¸ºnode-1å’Œnode-2çš„IPï¼Œå¦‚ä¸‹ï¼š [root@node-1 ~]# curl -I http://www.happylau.cn --resolve www.happylau.cn:80:10.254.100.101 HTTP/1.1 200 OK Server: nginx/1.17.6 Date: Tue, 24 Dec 2019 10:32:22 GMT Content-Type: text/html Content-Length: 612 Connection: keep-alive Last-Modified: Tue, 23 Dec 2014 16:25:09 GMT ETag: &quot;54999765-264&quot; Accept-Ranges: bytes [root@node-1 ~]# curl -I http://www.happylau.cn --resolve www.happylau.cn:80:10.254.100.102 HTTP/1.1 200 OK Server: nginx/1.17.6 Date: Tue, 24 Dec 2019 10:32:24 GMT Content-Type: text/html Content-Length: 612 Connection: keep-alive Last-Modified: Tue, 23 Dec 2014 16:25:09 GMT ETag: &quot;54999765-264&quot; Accept-Ranges: bytes 3 IngressåŠ¨æ€é…ç½® ä¸Šé¢ä»‹ç»äº†ingressèµ„æºå¯¹è±¡çš„ç”³æ˜é…ç½®ï¼Œè¿™é‡Œæˆ‘ä»¬æ¢ç©¶ä¸€ä¸‹Nginx Ingress Controllerçš„å®ç°æœºåˆ¶å’ŒåŠ¨æ€é…ç½®æ›´æ–°æœºåˆ¶ï¼Œä»¥æ–¹ä¾¿äº†è§£Ingressæ§åˆ¶å™¨çš„å·¥ä½œæœºåˆ¶ã€‚ 1ã€ æŸ¥çœ‹Nginx Controlleræ§åˆ¶å™¨çš„é…ç½®æ–‡ä»¶ï¼Œåœ¨nginx-ingress podä¸­å­˜å‚¨ç€ingressçš„é…ç½®æ–‡ä»¶ [root@node-1 ~]# kubectl get pods -n nginx-ingress NAME READY STATUS RESTARTS AGE nginx-ingress-7mpfc 1/1 Running 0 6h15m nginx-ingress-l2rtj 1/1 Running 0 6h15m nginx-ingress-tgf6r 1/1 Running 0 6h15m #æŸ¥çœ‹é…ç½®æ–‡ä»¶ï¼Œæ¯ä¸ªingressç”Ÿæˆä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œæ–‡ä»¶åä¸ºï¼šå‘½åç©ºé—´-ingresåç§°.conf [root@node-1 ~]# kubectl exec -it nginx-ingress-7mpfc -n nginx-ingress -- ls -l /etc/nginx/conf.d total 4 -rw-r--r-- 1 nginx nginx 1005 Dec 24 10:06 default-nginx-ingress-demo.conf #æŸ¥çœ‹é…ç½®æ–‡ä»¶ [root@node-1 ~]# kubectl exec -it nginx-ingress-7mpfc -n nginx-ingress -- cat /etc/nginx/conf.d/default-nginx-ingress-demo.conf # configuration for default/nginx-ingress-demo #upstreamçš„é…ç½®ï¼Œä¼šç”¨least_connç®—æ³•ï¼Œé€šè¿‡serviceæœåŠ¡å‘ç°æœºåˆ¶åŠ¨æ€è¯†åˆ«åˆ°åç«¯çš„Pod upstream default-nginx-ingress-demo-www.test.cn-ingress-demo-80 { zone default-nginx-ingress-demo-www.test.cn-ingress-demo-80 256k; random two least_conn; server 10.244.1.146:80 max_fails=1 fail_timeout=10s max_conns=0; server 10.244.2.162:80 max_fails=1 fail_timeout=10s max_conns=0; } server { listen 80; server_tokens on; server_name www.test.cn; location / { proxy_http_version 1.1; proxy_connect_timeout 60s; proxy_read_timeout 60s; proxy_send_timeout 60s; client_max_body_size 1m; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Host $host; proxy_set_header X-Forwarded-Port $server_port; proxy_set_header X-Forwarded-Proto $scheme; proxy_buffering on; proxy_pass http://default-nginx-ingress-demo-www.test.cn-ingress-demo-80; #è°ƒç”¨upstreamå®ç°ä»£ç† } } é€šè¿‡ä¸Šè¿°æŸ¥çœ‹é…ç½®æ–‡ä»¶å¯å¾—çŸ¥ï¼ŒNginx Ingress Controllerå®é™…æ˜¯æ ¹æ®ingressè§„åˆ™ç”Ÿæˆå¯¹åº”çš„nginxé…ç½®æ–‡ä»¶ï¼Œä»¥å®ç°ä»£ç†è½¬å‘çš„åŠŸèƒ½ï¼ŒåŠ å…¥Deploymentsçš„å‰¯æœ¬æ•°å˜æ›´ånginxçš„é…ç½®æ–‡ä»¶ä¼šå‘ç”Ÿä»€ä¹ˆæ”¹å˜å‘¢ï¼Ÿ 2ã€æ›´æ–°æ§åˆ¶å™¨çš„å‰¯æœ¬æ•°ï¼Œç”±2ä¸ªPodå‰¯æœ¬æ‰©å®¹è‡³3ä¸ª [root@node-1 ~]# kubectl scale --replicas=3 deployment ingress-demo deployment.extensions/ingress-demo scaled [root@node-1 ~]# kubectl get deployments NAME READY UP-TO-DATE AVAILABLE AGE ingress-demo 3/3 3 3 123m 3ã€å†æ¬¡æŸ¥çœ‹nginxçš„é…ç½®æ–‡ä»¶ï¼Œingresså€ŸåŠ©äºserviceçš„æœåŠ¡å‘ç°æœºåˆ¶ï¼Œå°†åŠ å…¥çš„Podè‡ªåŠ¨åŠ å…¥åˆ°nginx upstreamä¸­ 4ã€æŸ¥çœ‹nginx podçš„æ—¥å¿—ï¼ˆkubectl logs nginx-ingress-7mpfc -n nginx-ingressï¼‰ï¼Œæœ‰reloadä¼˜é›…é‡å¯çš„è®°å½•ï¼Œå³é€šè¿‡æ›´æ–°é…ç½®æ–‡ä»¶+reloadå®ç°é…ç½®åŠ¨æ€æ›´æ–°ã€‚ é€šè¿‡ä¸Šè¿°çš„é…ç½®å¯çŸ¥ï¼Œingressè°ƒç”¨kubernetes apiå»æ„ŸçŸ¥kubernetesé›†ç¾¤ä¸­çš„å˜åŒ–æƒ…å†µï¼ŒPodçš„å¢åŠ æˆ–å‡å°‘è¿™äº›å˜åŒ–ï¼Œç„¶ååŠ¨æ€æ›´æ–°nginx ingress controllerçš„é…ç½®æ–‡ä»¶ï¼Œå¹¶é‡æ–°è½½å…¥é…ç½®ã€‚å½“é›†ç¾¤è§„æ¨¡è¶Šå¤§æ—¶ï¼Œä¼šé¢‘ç¹æ¶‰åŠåˆ°é…ç½®æ–‡ä»¶çš„å˜åŠ¨å’Œé‡è½½ï¼Œå› æ­¤nginxè¿™æ–¹é¢ä¼šå­˜åœ¨å…ˆå¤©çš„åŠ£åŠ¿ï¼Œä¸“é—¨ä¸ºå¾®æœåŠ¡è´Ÿè½½å‡è¡¡åº”è¿è€Œç”Ÿï¼Œå¦‚Traefikï¼ŒEnvoyï¼ŒIstioï¼Œè¿™äº›è´Ÿè½½å‡è¡¡å·¥å…·èƒ½å¤Ÿæä¾›å¤§è§„æ¨¡ï¼Œé¢‘ç¹åŠ¨æ€æ›´æ–°çš„åœºæ™¯ï¼Œä½†æ€§èƒ½ç›¸æ¯”Nginxï¼ŒHAproxyè¿˜å­˜åœ¨ä¸€å®šçš„åŠ£åŠ¿ã€‚ 4 Ingressè·¯å¾„è½¬å‘ Ingressæ”¯æŒURIæ ¼å¼çš„è½¬å‘æ–¹å¼ï¼ŒåŒæ—¶æ”¯æŒURLé‡å†™ï¼Œå¦‚ä¸‹ä»¥ä¸¤ä¸ªserviceä¸ºä¾‹æ¼”ç¤ºï¼Œservice-1å®‰è£…nginxï¼Œservice-2å®‰è£…httpdï¼Œåˆ†åˆ«ç”¨http://demo.happylau.cn/newså’Œhttp://demo.happylau.cn/sportsè½¬å‘åˆ°ä¸¤ä¸ªä¸åŒçš„service 1ã€ç¯å¢ƒå‡†å¤‡ï¼Œåˆ›å»ºä¸¤ä¸ªåº”ç”¨å¹¶å®ç°serviceæš´éœ²ï¼Œåˆ›å»ºdeploymentsæ—¶æŒ‡å®š--exploseåˆ›å»ºservice [root@node-1 ~]# kubectl run service-1 --image=nginx:1.7.9 --port=80 --replicas=1 --expose=true service/service-1 created deployment.apps/service-1 created [root@node-1 ~]# kubectl run service-2 --image=httpd --port=80 --replicas=1 --expose=true service/service-2 created deployment.apps/service-2 created æŸ¥çœ‹deploymentçŠ¶æ€ [root@node-1 ~]# kubectl get deployments NAME READY UP-TO-DATE AVAILABLE AGE ingress-demo 4/4 4 4 4h36m service-1 1/1 1 1 65s service-2 1/1 1 1 52s æŸ¥çœ‹serviceçŠ¶æ€ï¼ŒæœåŠ¡å·²ç»æ­£å¸¸ [root@node-1 ~]# kubectl get services NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE ingress-demo ClusterIP 10.109.33.91 &lt;none&gt; 80/TCP 4h36m kubernetes ClusterIP 10.96.0.1 &lt;none&gt; 443/TCP 101d service-1 ClusterIP 10.106.245.71 &lt;none&gt; 80/TCP 68s service-2 ClusterIP 10.104.204.158 &lt;none&gt; 80/TCP 55s 2ã€åˆ›å»ºingresså¯¹è±¡ï¼Œé€šè¿‡ä¸€ä¸ªåŸŸåå°†è¯·æ±‚è½¬å‘è‡³åç«¯ä¸¤ä¸ªservice [root@node-1 nginx-ingress]# cat nginx-ingress-uri-demo.yaml apiVersion: extensions/v1beta1 kind: Ingress metadata: name: nginx-ingress-uri-demo labels: ingres-controller: nginx annotations: kubernets.io/ingress.class: nginx nginx.ingress.kubernetes.io/rewrite-target: / spec: rules: - host: http: paths: - path: /news backend: serviceName: service-1 servicePort: 80 - path: /sports backend: serviceName: service-2 servicePort: 80 3ã€åˆ›å»ºingressè§„åˆ™ï¼ŒæŸ¥çœ‹è¯¦æƒ… [root@node-1 nginx-ingress]# kubectl apply -f nginx-ingress-uri-demo.yaml ingress.extensions/nginx-ingress-uri-demo created #æŸ¥çœ‹è¯¦æƒ… [root@node-1 nginx-ingress]# kubectl get ingresses. NAME HOSTS ADDRESS PORTS AGE nginx-ingress-demo www.happylau.cn 80 4h35m nginx-ingress-uri-demo demo.happylau.cn 80 4s [root@node-1 nginx-ingress]# kubectl describe ingresses nginx-ingress-uri-demo Name: nginx-ingress-uri-demo Namespace: default Address: Default backend: default-http-backend:80 (&lt;none&gt;) Rules: #å¯¹åº”çš„è½¬å‘urlè§„åˆ™ Host Path Backends ---- ---- -------- demo.happylau.cn /news service-1:80 (10.244.2.163:80) /sports service-2:80 (10.244.1.148:80) Annotations: kubectl.kubernetes.io/last-applied-configuration: {&quot;apiVersion&quot;:&quot;extensions/v1beta1&quot;,&quot;kind&quot;:&quot;Ingress&quot;,&quot;metadata&quot;:{&quot;annotations&quot;:{&quot;kubernets.io/ingress.class&quot;:&quot;nginx&quot;,&quot;nginx.ingress.kubernetes.io/rewrite-target&quot;:&quot;/&quot;},&quot;labels&quot;:{&quot;ingres-controller&quot;:&quot;nginx&quot;},&quot;name&quot;:&quot;nginx-ingress-uri-demo&quot;,&quot;namespace&quot;:&quot;default&quot;},&quot;spec&quot;:{&quot;rules&quot;:[{&quot;host&quot;:&quot;demo.happylau.cn&quot;,&quot;http&quot;:{&quot;paths&quot;:[{&quot;backend&quot;:{&quot;serviceName&quot;:&quot;service-1&quot;,&quot;servicePort&quot;:80},&quot;path&quot;:&quot;/news&quot;},{&quot;backend&quot;:{&quot;serviceName&quot;:&quot;service-2&quot;,&quot;servicePort&quot;:80},&quot;path&quot;:&quot;/sports&quot;}]}}]}} kubernets.io/ingress.class: nginx nginx.ingress.kubernetes.io/rewrite-target: / Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal AddedOrUpdated 11s nginx-ingress-controller Configuration for default/nginx-ingress-uri-demo was added or updated Normal AddedOrUpdated 11s nginx-ingress-controller Configuration for default/nginx-ingress-uri-demo was added or updated Normal AddedOrUpdated 11s nginx-ingress-controller Configuration for default/nginx-ingress-uri-demo was added or updated 4ã€å‡†å¤‡æµ‹è¯•ï¼Œç«™ç‚¹ä¸­åˆ›å»ºå¯¹åº”çš„è·¯å¾„ [root@node-1 ~]# kubectl exec -it service-1-7b66bf758f-xj9jh /bin/bash root@service-1-7b66bf758f-xj9jh:/# echo &quot;service-1 website page&quot; &gt;/usr/share/nginx/html/news [root@node-1 ~]# kubectl exec -it service-2-7c7444684d-w9cv9 /bin/bash root@service-2-7c7444684d-w9cv9:/usr/local/apache2# echo &quot;service-2 website page&quot; &gt;/usr/local/apache2/htdocs/sports 5ã€æµ‹è¯•éªŒè¯ [root@node-1 ~]# curl http://demo.happylau.cn/news --resolve demo.happylau.cn:80:10.254.100.101 service-1 website page [root@node-1 ~]# curl http://demo.happylau.cn/sports --resolve demo.happylau.cn:80:10.254.100.101 service-2 website page 6ã€æ€»ç»“ é€šè¿‡ä¸Šè¿°çš„éªŒè¯æµ‹è¯•å¯ä»¥å¾—çŸ¥ï¼Œingressæ”¯æŒURIçš„è·¯ç”±æ–¹å¼è½¬å‘ï¼Œå…¶å¯¹åº”åœ¨ingressä¸­çš„é…ç½®æ–‡ä»¶å†…å®¹æ˜¯æ€æ ·çš„å‘¢ï¼Œæˆ‘ä»¬çœ‹ä¸‹ingress controllerç”Ÿæˆå¯¹åº”çš„nginxé…ç½®æ–‡ä»¶å†…å®¹ï¼Œå®é™…æ˜¯é€šè¿‡ingressçš„locationæ¥å®ç°ï¼Œå°†ä¸åŒçš„localtionè½¬å‘è‡³ä¸åŒçš„upstreamä»¥å®ç°serviceçš„å…³è”ï¼Œé…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š [root@node-1 ~]# kubectl exec -it nginx-ingress-7mpfc -n nginx-ingress /bin/bash nginx@nginx-ingress-7mpfc:/$ cat /etc/nginx/conf.d/default-nginx-ingress-uri-demo.conf |grep -v &quot;^$&quot; # configuration for default/nginx-ingress-uri-demo #å®šä¹‰ä¸¤ä¸ªupstreamå’Œåç«¯çš„serviceå…³è” upstream default-nginx-ingress-uri-demo-demo.happylau.cn-service-1-80 { zone default-nginx-ingress-uri-demo-demo.happylau.cn-service-1-80 256k; random two least_conn; server 10.244.2.163:80 max_fails=1 fail_timeout=10s max_conns=0; } upstream default-nginx-ingress-uri-demo-demo.happylau.cn-service-2-80 { zone default-nginx-ingress-uri-demo-demo.happylau.cn-service-2-80 256k; random two least_conn; server 10.244.1.148:80 max_fails=1 fail_timeout=10s max_conns=0; } server { listen 80; server_tokens on; server_name demo.happylau.cn; #å®šä¹‰locationå®ç°ä»£ç†ï¼Œé€šè¿‡proxy_passå’Œåç«¯çš„serviceå…³è” location /news { proxy_http_version 1.1; proxy_connect_timeout 60s; proxy_read_timeout 60s; proxy_send_timeout 60s; client_max_body_size 1m; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Host $host; proxy_set_header X-Forwarded-Port $server_port; proxy_set_header X-Forwarded-Proto $scheme; proxy_buffering on; proxy_pass http://default-nginx-ingress-uri-demo-demo.happylau.cn-service-1-80; } location /sports { proxy_http_version 1.1; proxy_connect_timeout 60s; proxy_read_timeout 60s; proxy_send_timeout 60s; client_max_body_size 1m; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Host $host; proxy_set_header X-Forwarded-Port $server_port; proxy_set_header X-Forwarded-Proto $scheme; proxy_buffering on; proxy_pass http://default-nginx-ingress-uri-demo-demo.happylau.cn-service-2-80; } } 5 Ingressè™šæ‹Ÿä¸»æœº ingressæ”¯æŒåŸºäºåç§°çš„è™šæ‹Ÿä¸»æœºï¼Œå®ç°å•ä¸ªIPå¤šä¸ªåŸŸåè½¬å‘çš„éœ€æ±‚ï¼Œé€šè¿‡è¯·æ±‚å¤´éƒ¨æºå¸¦ä¸»æœºåæ–¹å¼åŒºåˆ†å¼€ï¼Œå°†ä¸Šä¸ªç« èŠ‚çš„ingressåˆ é™¤ï¼Œä½¿ç”¨service-1å’Œservice-2ä¸¤ä¸ªserviceæ¥åšæ¼”ç¤ºã€‚ 1ã€åˆ›å»ºingressè§„åˆ™ï¼Œé€šè¿‡ä¸»æœºåå®ç°è½¬å‘è§„åˆ™ apiVersion: extensions/v1beta1 kind: Ingress metadata: name: nginx-ingress-virtualname-demo labels: ingres-controller: nginx annotations: kubernets.io/ingress.class: nginx spec: rules: - host: news.happylau.cn http: paths: - path: / backend: serviceName: service-1 servicePort: 80 - host: sports.happylau.cn http: paths: - path: / backend: serviceName: service-2 servicePort: 80 2ã€ç”Ÿæˆingressè§„åˆ™å¹¶æŸ¥çœ‹è¯¦æƒ…ï¼Œä¸€ä¸ªingresså¯¹åº”ä¸¤ä¸ªHOSTS [root@node-1 nginx-ingress]# kubectl apply -f nginx-ingress-virtualname.yaml ingress.extensions/nginx-ingress-virtualname-demo created #æŸ¥çœ‹åˆ—è¡¨ [root@node-1 nginx-ingress]# kubectl get ingresses nginx-ingress-virtualname-demo NAME HOSTS ADDRESS PORTS AGE nginx-ingress-virtualname-demo news.happylau.cn,sports.happylau.cn 80 12s #æŸ¥çœ‹è¯¦æƒ… [root@node-1 nginx-ingress]# kubectl describe ingresses nginx-ingress-virtualname-demo Name: nginx-ingress-virtualname-demo Namespace: default Address: Default backend: default-http-backend:80 (&lt;none&gt;) Rules: Host Path Backends ---- ---- -------- news.happylau.cn / service-1:80 (10.244.2.163:80) sports.happylau.cn / service-2:80 (10.244.1.148:80) Annotations: kubectl.kubernetes.io/last-applied-configuration: {&quot;apiVersion&quot;:&quot;extensions/v1beta1&quot;,&quot;kind&quot;:&quot;Ingress&quot;,&quot;metadata&quot;:{&quot;annotations&quot;:{&quot;kubernets.io/ingress.class&quot;:&quot;nginx&quot;},&quot;labels&quot;:{&quot;ingres-controller&quot;:&quot;nginx&quot;},&quot;name&quot;:&quot;nginx-ingress-virtualname-demo&quot;,&quot;namespace&quot;:&quot;default&quot;},&quot;spec&quot;:{&quot;rules&quot;:[{&quot;host&quot;:&quot;news.happylau.cn&quot;,&quot;http&quot;:{&quot;paths&quot;:[{&quot;backend&quot;:{&quot;serviceName&quot;:&quot;service-1&quot;,&quot;servicePort&quot;:80},&quot;path&quot;:&quot;/&quot;}]}},{&quot;host&quot;:&quot;sports.happylau.cn&quot;,&quot;http&quot;:{&quot;paths&quot;:[{&quot;backend&quot;:{&quot;serviceName&quot;:&quot;service-2&quot;,&quot;servicePort&quot;:80},&quot;path&quot;:&quot;/&quot;}]}}]}} kubernets.io/ingress.class: nginx Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal AddedOrUpdated 28s nginx-ingress-controller Configuration for default/nginx-ingress-virtualname-demo was added or updated Normal AddedOrUpdated 28s nginx-ingress-controller Configuration for default/nginx-ingress-virtualname-demo was added or updated Normal AddedOrUpdated 28s nginx-ingress-controller Configuration for default/nginx-ingress-virtualname-demo was added or updated 3ã€å‡†å¤‡æµ‹è¯•æ•°æ®å¹¶æµ‹è¯• [root@node-1 ~]# kubectl exec -it service-1-7b66bf758f-xj9jh /bin/bash root@service-1-7b66bf758f-xj9jh:/# echo &quot;news demo&quot; &gt;/usr/share/nginx/html/index.html [root@node-1 ~]# kubectl exec -it service-2-7c7444684d-w9cv9 /bin/bash root@service-2-7c7444684d-w9cv9:/usr/local/apache2# echo &quot;sports demo&quot; &gt;/usr/local/apache2/htdocs/index.html æµ‹è¯•ï¼š [root@node-1 ~]# curl http://news.happylau.cn --resolve news.happylau.cn:80:10.254.100.102 news demo [root@node-1 ~]# curl http://sports.happylau.cn --resolve sports.happylau.cn:80:10.254.100.102 sports demo 4ã€æŸ¥çœ‹nginxçš„é…ç½®æ–‡ä»¶å†…å®¹ï¼Œé€šè¿‡åœ¨serverä¸­å®šä¹‰ä¸åŒçš„server_nameä»¥åŒºåˆ†ï¼Œä»£ç†åˆ°ä¸åŒçš„upstreamä»¥å®ç°serviceçš„ä»£ç†ã€‚ # configuration for default/nginx-ingress-virtualname-demo upstream default-nginx-ingress-virtualname-demo-news.happylau.cn-service-1-80 { zone default-nginx-ingress-virtualname-demo-news.happylau.cn-service-1-80 256k; random two least_conn; server 10.244.2.163:80 max_fails=1 fail_timeout=10s max_conns=0; } upstream default-nginx-ingress-virtualname-demo-sports.happylau.cn-service-2-80 { zone default-nginx-ingress-virtualname-demo-sports.happylau.cn-service-2-80 256k; random two least_conn; server 10.244.1.148:80 max_fails=1 fail_timeout=10s max_conns=0; } server { listen 80; server_tokens on; server_name news.happylau.cn; location / { proxy_http_version 1.1; proxy_connect_timeout 60s; proxy_read_timeout 60s; proxy_send_timeout 60s; client_max_body_size 1m; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Host $host; proxy_set_header X-Forwarded-Port $server_port; proxy_set_header X-Forwarded-Proto $scheme; proxy_buffering on; proxy_pass http://default-nginx-ingress-virtualname-demo-news.happylau.cn-service-1-80; } } server { listen 80; server_tokens on; server_name sports.happylau.cn; location / { proxy_http_version 1.1; proxy_connect_timeout 60s; proxy_read_timeout 60s; proxy_send_timeout 60s; client_max_body_size 1m; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Host $host; proxy_set_header X-Forwarded-Port $server_port; proxy_set_header X-Forwarded-Proto $scheme; proxy_buffering on; proxy_pass http://default-nginx-ingress-virtualname-demo-sports.happylau.cn-service-2-80; } } 6 Ingress TLSåŠ å¯† å››å±‚çš„è´Ÿè½½å‡è¡¡æ— æ³•æ”¯æŒhttpsè¯·æ±‚ï¼Œå½“å‰å¤§éƒ¨åˆ†ä¸šåŠ¡éƒ½è¦æ±‚ä»¥httpsæ–¹å¼æ¥å…¥ï¼ŒIngressèƒ½æ”¯æŒhttpsçš„æ–¹å¼æ¥å…¥ï¼Œé€šè¿‡Secretså­˜å‚¨è¯ä¹¦+ç§é’¥ï¼Œå®ç°httpsæ¥å…¥ï¼ŒåŒæ—¶è¿˜èƒ½æ”¯æŒhttpè·³è½¬åŠŸèƒ½ã€‚å¯¹äºç”¨æˆ·çš„è¯·æ±‚æµé‡æ¥è¯´ï¼Œå®¢æˆ·ç«¯åˆ°ingress controlleræ˜¯httpsæµé‡ï¼Œingress controlleråˆ°åç«¯serviceåˆ™æ˜¯httpï¼Œæé«˜ç”¨æˆ·è®¿é—®æ€§èƒ½ï¼Œå¦‚ä¸‹ä»‹ç»ingress TLSåŠŸèƒ½å®ç°æ­¥éª¤ã€‚ 1ã€ç”Ÿæˆè‡ªç­¾åè¯ä¹¦å’Œç§é’¥ [root@node-1 ~]# openssl req -x509 -newkey rsa:2048 -nodes -days 365 -keyout tls.key -out tls.crt Generating a 2048 bit RSA private key ....................................................+++ ........................................+++ writing new private key to 'tls.key' ----- You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [XX]:CN #å›½å®¶ State or Province Name (full name) []:GD #çœä»½ Locality Name (eg, city) [Default City]:ShenZhen #åŸå¸‚ Organization Name (eg, company) [Default Company Ltd]:Tencent #å…¬å¸ Organizational Unit Name (eg, section) []:HappyLau #ç»„ç»‡ Common Name (eg, your name or your server's hostname) []:www.happylau.cn #åŸŸå Email Address []:573302346@qq.com #é‚®ç®±åœ°å€ #tls.crtä¸ºè¯ä¹¦ï¼Œtls.keyä¸ºç§é’¥ [root@node-1 ~]# ls tls.* -l -rw-r--r-- 1 root root 1428 12æœˆ 26 13:21 tls.crt -rw-r--r-- 1 root root 1708 12æœˆ 26 13:21 tls.key 2ã€é…ç½®Secretsï¼Œå°†è¯ä¹¦å’Œç§é’¥é…ç½®åˆ°Secretsä¸­ [root@node-1 ~]# kubectl create secret tls happylau-sslkey --cert=tls.crt --key=tls.key secret/happylau-sslkey created æŸ¥çœ‹Secretsè¯¦æƒ…,è¯ä¹¦å’Œç§è¦åŒ…å«åœ¨dataä¸­ï¼Œæ–‡ä»¶åä¸ºä¸¤ä¸ªä¸åŒçš„keyï¼štls.crtå’Œtls.key [root@node-1 ~]# kubectl describe secrets happylau-sslkey Name: happylau-sslkey Namespace: default Labels: &lt;none&gt; Annotations: &lt;none&gt; Type: kubernetes.io/tls Data ==== tls.crt: 1428 bytes tls.key: 1708 bytes 3ã€é…ç½®ingressè°ƒç”¨Secretså®ç°SSLè¯ä¹¦åŠ å¯† apiVersion: extensions/v1beta1 kind: Ingress metadata: name: nginx-ingress-tls-demo labels: ingres-controller: nginx annotations: kubernets.io/ingress.class: nginx spec: tls: - hosts: - news.happylau.cn - sports.happylau.cn secretName: happylau-sslkey rules: - host: news.happylau.cn http: paths: - path: / backend: serviceName: service-1 servicePort: 80 - host: sports.happylau.cn http: paths: - path: / backend: serviceName: service-2 servicePort: 80 4ã€åˆ›å»ºingresså¹¶æŸ¥çœ‹ingressè¯¦æƒ… [root@node-1 nginx-ingress]# kubectl describe ingresses nginx-ingress-tls-demo Name: nginx-ingress-tls-demo Namespace: default Address: Default backend: default-http-backend:80 (&lt;none&gt;) TLS: happylau-sslkey terminates news.happylau.cn,sports.happylau.cn Rules: Host Path Backends ---- ---- -------- news.happylau.cn / service-1:80 (10.244.2.163:80) sports.happylau.cn / service-2:80 (10.244.1.148:80) Annotations: kubectl.kubernetes.io/last-applied-configuration: {&quot;apiVersion&quot;:&quot;extensions/v1beta1&quot;,&quot;kind&quot;:&quot;Ingress&quot;,&quot;metadata&quot;:{&quot;annotations&quot;:{&quot;kubernets.io/ingress.class&quot;:&quot;nginx&quot;},&quot;labels&quot;:{&quot;ingres-controller&quot;:&quot;nginx&quot;},&quot;name&quot;:&quot;nginx-ingress-tls-demo&quot;,&quot;namespace&quot;:&quot;default&quot;},&quot;spec&quot;:{&quot;rules&quot;:[{&quot;host&quot;:&quot;news.happylau.cn&quot;,&quot;http&quot;:{&quot;paths&quot;:[{&quot;backend&quot;:{&quot;serviceName&quot;:&quot;service-1&quot;,&quot;servicePort&quot;:80},&quot;path&quot;:&quot;/&quot;}]}},{&quot;host&quot;:&quot;sports.happylau.cn&quot;,&quot;http&quot;:{&quot;paths&quot;:[{&quot;backend&quot;:{&quot;serviceName&quot;:&quot;service-2&quot;,&quot;servicePort&quot;:80},&quot;path&quot;:&quot;/&quot;}]}}],&quot;tls&quot;:[{&quot;hosts&quot;:[&quot;news.happylau.cn&quot;,&quot;sports.happylau.cn&quot;],&quot;secretName&quot;:&quot;happylau-sslkey&quot;}]}} kubernets.io/ingress.class: nginx Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal AddedOrUpdated 22s nginx-ingress-controller Configuration for default/nginx-ingress-tls-demo was added or updated Normal AddedOrUpdated 22s nginx-ingress-controller Configuration for default/nginx-ingress-tls-demo was added or updated Normal AddedOrUpdated 22s nginx-ingress-controller Configuration for default/nginx-ingress-tls-demo was added or updated 5ã€è®¿é—® å°†news.happylau.cnå’Œsports.happylau.cnå†™å…¥åˆ°hostsæ–‡ä»¶ä¸­ï¼Œå¹¶é€šè¿‡https://news.happylau.cn çš„æ–¹å¼è®¿é—®ï¼Œæµè§ˆå™¨è®¿é—®å†…å®¹æç¤ºè¯ä¹¦å¦‚ä¸‹ï¼Œä¿¡ä»»è¯ä¹¦å³å¯è®¿é—®åˆ°ç«™ç‚¹å†…å®¹ã€‚ æŸ¥çœ‹è¯ä¹¦è¯¦æƒ…ï¼Œæ­£æ˜¯æˆ‘ä»¬åˆ¶ä½œçš„è‡ªç­¾åè¯ä¹¦ï¼Œç”Ÿäº§å®é™…ä½¿ç”¨æ—¶ï¼Œæ¨èä½¿ç”¨CAæœºæ„é¢å‘ç­¾åè¯ä¹¦ã€‚ 6ã€æ¥ä¸‹æ¥æŸ¥çœ‹ä¸€ä¸‹tlsé…ç½®httpsçš„nginxé…ç½®æ–‡ä»¶å†…å®¹ï¼Œå¯ä»¥çœ‹åˆ°åœ¨serverå—å¯ç”¨äº†httpså¹¶é…ç½®è¯ä¹¦ï¼ŒåŒæ—¶é…ç½®äº†httpè·³è½¬ï¼Œå› æ­¤ç›´æ¥è®¿é—®httpä¹Ÿèƒ½å¤Ÿå®ç°è‡ªåŠ¨è·³è½¬åˆ°httpsåŠŸèƒ½ã€‚ # configuration for default/nginx-ingress-tls-demo upstream default-nginx-ingress-tls-demo-news.happylau.cn-service-1-80 { zone default-nginx-ingress-tls-demo-news.happylau.cn-service-1-80 256k; random two least_conn; server 10.244.2.163:80 max_fails=1 fail_timeout=10s max_conns=0; } upstream default-nginx-ingress-tls-demo-sports.happylau.cn-service-2-80 { zone default-nginx-ingress-tls-demo-sports.happylau.cn-service-2-80 256k; random two least_conn; server 10.244.1.148:80 max_fails=1 fail_timeout=10s max_conns=0; } server { listen 80; listen 443 ssl; #httpsç›‘å¬ç«¯å£ï¼Œè¯ä¹¦å’Œkeyï¼Œå®ç°å’ŒSecretså…³è” ssl_certificate /etc/nginx/secrets/default-happylau-sslkey; ssl_certificate_key /etc/nginx/secrets/default-happylau-sslkey; server_tokens on; server_name news.happylau.cn; #httpè·³è½¬åŠŸèƒ½ï¼Œå³è®¿é—®httpä¼šè‡ªåŠ¨è·³è½¬è‡³https if ($scheme = http) { return 301 https://$host:443$request_uri; } location / { proxy_http_version 1.1; proxy_connect_timeout 60s; proxy_read_timeout 60s; proxy_send_timeout 60s; client_max_body_size 1m; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Host $host; proxy_set_header X-Forwarded-Port $server_port; proxy_set_header X-Forwarded-Proto $scheme; proxy_buffering on; proxy_pass http://default-nginx-ingress-tls-demo-news.happylau.cn-service-1-80; } } server { listen 80; listen 443 ssl; ssl_certificate /etc/nginx/secrets/default-happylau-sslkey; ssl_certificate_key /etc/nginx/secrets/default-happylau-sslkey; server_tokens on; server_name sports.happylau.cn; if ($scheme = http) { return 301 https://$host:443$request_uri; } location / { proxy_http_version 1.1; proxy_connect_timeout 60s; proxy_read_timeout 60s; proxy_send_timeout 60s; client_max_body_size 1m; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Host $host; proxy_set_header X-Forwarded-Port $server_port; proxy_set_header X-Forwarded-Proto $scheme; proxy_buffering on; proxy_pass http://default-nginx-ingress-tls-demo-sports.happylau.cn-service-2-80; } } 7. Nginx Ingressé«˜çº§åŠŸèƒ½ 7.1 å®šåˆ¶åŒ–å‚æ•° ingress controlleræä¾›äº†åŸºç¡€åå‘ä»£ç†çš„åŠŸèƒ½ï¼Œå¦‚æœéœ€è¦å®šåˆ¶åŒ–nginxçš„ç‰¹æ€§æˆ–å‚æ•°ï¼Œéœ€è¦é€šè¿‡ConfigMapå’ŒAnnotationsæ¥å®ç°ï¼Œä¸¤è€…å®ç°çš„æ–¹å¼æœ‰æ‰€ä¸åŒï¼ŒConfigMapç”¨äºæŒ‡å®šæ•´ä¸ªingressé›†ç¾¤èµ„æºçš„åŸºæœ¬å‚æ•°ï¼Œä¿®æ”¹åä¼šè¢«æ‰€æœ‰çš„ingresså¯¹è±¡æ‰€ç»§æ‰¿ï¼›Annotationsåˆ™è¢«æŸä¸ªå…·ä½“çš„ingresså¯¹è±¡æ‰€ä½¿ç”¨ï¼Œä¿®æ”¹åªä¼šå½±å“æŸä¸ªå…·ä½“çš„ingressèµ„æºï¼Œå†²çªæ—¶å…¶ä¼˜å…ˆçº§é«˜äºConfigMapã€‚ 7.1.1 ConfigMapè‡ªå®šä¹‰å‚æ•° å®‰è£…nginx ingress controlleræ—¶é»˜è®¤ä¼šåŒ…å«ä¸€ä¸ªç©ºçš„ConfigMapï¼Œå¯ä»¥é€šè¿‡ConfigMapæ¥è‡ªå®šä¹‰nginx controllerçš„é»˜è®¤å‚æ•°ï¼Œå¦‚ä¸‹ä»¥ä¿®æ”¹ä¸€äº›å‚æ•°ä¸ºä¾‹ï¼š 1ã€ å®šä¹‰ConfigMapå‚æ•° kind: ConfigMap apiVersion: v1 metadata: name: nginx-config namespace: nginx-ingress data: proxy-connect-timeout: &quot;10s&quot; proxy-read-timeout: &quot;10s&quot; proxy-send-timeout: &quot;10&quot; client-max-body-size: &quot;3m&quot; 2ã€ åº”ç”¨é…ç½®å¹¶æŸ¥çœ‹ConfigMapé…ç½® [root@node-1 ~]# kubectl get configmaps -n nginx-ingress nginx-config -o yaml apiVersion: v1 data: client-max-body-size: 3m proxy-connect-timeout: 10s proxy-read-timeout: 10s proxy-send-timeout: 10s kind: ConfigMap metadata: annotations: kubectl.kubernetes.io/last-applied-configuration: | {&quot;apiVersion&quot;:&quot;v1&quot;,&quot;data&quot;:{&quot;client-max-body-size&quot;:&quot;3m&quot;,&quot;proxy-connect-timeout&quot;:&quot;10s&quot;,&quot;proxy-read-timeout&quot;:&quot;10s&quot;,&quot;proxy-send-timeout&quot;:&quot;10&quot;},&quot;kind&quot;:&quot;ConfigMap&quot;,&quot;metadata&quot;:{&quot;annotations&quot;:{},&quot;name&quot;:&quot;nginx-config&quot;,&quot;namespace&quot;:&quot;nginx-ingress&quot;}} creationTimestamp: &quot;2019-12-24T04:39:23Z&quot; name: nginx-config namespace: nginx-ingress resourceVersion: &quot;13845543&quot; selfLink: /api/v1/namespaces/nginx-ingress/configmaps/nginx-config uid: 9313ae47-a0f0-463e-a25a-1658f1ca0d57 3 ã€æ­¤æ—¶ï¼ŒConfigMapå®šä¹‰çš„é…ç½®å‚æ•°ä¼šè¢«é›†ç¾¤ä¸­æ‰€æœ‰çš„Ingressèµ„æºç»§æ‰¿ï¼ˆé™¤äº†annotationså®šä¹‰ä¹‹å¤–ï¼‰ æœ‰å¾ˆå¤šå‚æ•°å¯ä»¥å®šä¹‰ï¼Œè¯¦æƒ…é…ç½®å¯å‚è€ƒæ–¹æ–‡æ¡£è¯´æ˜ï¼šhttps://github.com/nginxinc/kubernetes-ingress/blob/master/docs/configmap-and-annotations.md#Summary-of-ConfigMap-and-Annotations 7.1.2 Annotationsè‡ªå®šä¹‰å‚æ•° ConfigMapå®šä¹‰çš„æ˜¯å…¨å±€çš„é…ç½®å‚æ•°ï¼Œä¿®æ”¹åæ‰€æœ‰çš„é…ç½®éƒ½ä¼šå—å½±å“ï¼Œå¦‚æœæƒ³é’ˆå¯¹æŸä¸ªå…·ä½“çš„ingressèµ„æºè‡ªå®šä¹‰å‚æ•°ï¼Œåˆ™å¯ä»¥é€šè¿‡Annotationsæ¥å®ç°ï¼Œä¸‹é¢å¼€å§‹ä»¥å®é™…çš„ä¾‹å­æ¼”ç¤ºAnnotationsçš„ä½¿ç”¨ã€‚ 1ã€ä¿®æ”¹ingressèµ„æºï¼Œæ·»åŠ annotationsçš„å®šä¹‰,é€šè¿‡nginx.orgç»„ä¿®æ”¹äº†ä¸€äº›å‚æ•°ï¼Œå¦‚proxy-connect-timeoutï¼Œè°ƒåº¦ç®—æ³•ä¸ºround_robinï¼ˆé»˜è®¤ä¸ºleast _connï¼‰ apiVersion: extensions/v1beta1 kind: Ingress metadata: name: nginx-ingress-demo labels: ingres-controller: nginx annotations: kubernets.io/ingress.class: nginx nginx.org/proxy-connect-timeout: &quot;30s&quot; nginx.org/proxy-send-timeout: &quot;20s&quot; nginx.org/proxy-read-timeout: &quot;20s&quot; nginx.org/client-max-body-size: &quot;2m&quot; nginx.org/fail-timeout: &quot;5s&quot; nginx.org/lb-method: &quot;round_robin&quot; spec: rules: - host: www.happylau.cn http: paths: - path: / backend: serviceName: ingress-demo servicePort: 80 2ã€ é‡æ–°åº”ç”¨ingresså¯¹è±¡å¹¶æŸ¥çœ‹å‚æ•°é…ç½®æƒ…å†µ ç”±ä¸Šé¢çš„æ¼”ç¤ºå¯å¾—çŸ¥ï¼ŒAnnotationsçš„ä¼˜å…ˆçº§é«˜äºConfigMapMapï¼ŒAnnotationsä¿®æ”¹å‚æ•°åªä¼šå½±å“åˆ°æŸä¸€ä¸ªå…·ä½“çš„ingressèµ„æºï¼Œå…¶å®šä¹‰çš„æ–¹æ³•å’ŒConfigMapç›¸ç›¸è¿‘ä¼¼ï¼Œä½†åˆæœ‰å·®åˆ«ï¼Œéƒ¨åˆ†ConfigMapçš„å‚æ•°Annotationsæ— æ³•æ”¯æŒï¼Œåè¿‡æ¥Annotationså®šä¹‰çš„å‚æ•°ConfigMapä¹Ÿä¸ä¸€å®šæ”¯æŒï¼Œä¸‹å›¾åˆ—ä¸¾ä¸€ä¸‹å¸¸è§„æ”¯æŒå‚æ•°æƒ…å†µï¼š é€šç”¨å‚æ•° æ—¥å¿—æ”¯æŒ è¯·æ±‚å¤´éƒ¨ è®¤è¯å’Œå®‰å…¨ upstreamæ”¯æŒ 7.2 è™šæ‹Ÿä¸»æœºå’Œè·¯ç”± å®‰è£…nginx ingressæ—¶æˆ‘ä»¬å®‰è£…äº†ä¸€ä¸ªcustomresourcedefinitionsè‡ªå®šä¹‰èµ„æºï¼Œå…¶èƒ½å¤Ÿæä¾›é™¤äº†é»˜è®¤ingressåŠŸèƒ½ä¹‹å¤–çš„ä¸€äº›é«˜çº§ç‰¹æ€§å¦‚ è™šæ‹Ÿä¸»æœºVirtualServer è™šæ‹Ÿè·¯ç”±VirtualServerRoute å¥åº·æ£€æŸ¥Healthcheck æµé‡åˆ‡å‰²Split ä¼šè¯ä¿æŒSessionCookie é‡å®šå‘Redirect è¿™äº›åŠŸèƒ½å¤§éƒ¨åˆ†ä¾èµ–äºNginx Plusé«˜çº§ç‰ˆæœ¬çš„æ”¯æŒï¼Œç¤¾åŒºç‰ˆæœ¬ä»…æ”¯æŒéƒ¨åˆ†ï¼Œå¯¹äºä¼ä¸šçº§å¼€å‘è€Œè¨€ï¼Œä¸°å¯Œæ›´å¤šçš„åŠŸèƒ½å¯ä»¥è´­ä¹°ä¼ä¸šçº§Nginx Plusç‰ˆæœ¬ã€‚å¦‚ä¸‹ä»¥é€šè¿‡VirtualServerå’ŒVirtualServerRouteå®šä¹‰upstreamé…ç½®ä¸ºä¾‹æ¼”ç¤ºåŠŸèƒ½ä½¿ç”¨ã€‚ 1ã€å®šä¹‰VirtualServerèµ„æº,å…¶é…ç½®å’Œingressèµ„æºå¯¹è±¡ç±»ä¼¼ï¼Œèƒ½æ”¯æŒçš„åŠŸèƒ½ä¼šæ›´ä¸°å¯Œä¸€ç‚¹ apiVersion: k8s.nginx.org/v1 kind: VirtualServer metadata: name: cafe spec: host: cafe.example.com tls: secret: cafe-secret upstreams: - name: tea service: tea-svc port: 80 name: tea service: ingress-demo subselector: version: canary lb-method: round_robin fail-timeout: 10s max-fails: 1 max-conns: 32 keepalive: 32 connect-timeout: 30s read-timeout: 30s send-timeout: 30s next-upstream: &quot;error timeout non_idempotent&quot; next-upstream-timeout: 5s next-upstream-tries: 10 client-max-body-size: 2m tls: enable: true routes: - path: /tea action: pass: tea 2ã€ åº”ç”¨èµ„æºå¹¶æŸ¥çœ‹VirtualServerèµ„æºåˆ—è¡¨ [root@node-1 ~]# kubectl apply -f vs.yaml virtualserver.k8s.nginx.org/cafe unchanged [root@node-1 ~]# kubectl get virtualserver NAME AGE cafe 2m52s 3ã€æ£€æŸ¥ingressæ§åˆ¶å™¨çš„é…ç½®æ–‡ä»¶æƒ…å†µ,ç”Ÿæˆçš„é…ç½®å’Œupstreamå®šä¹‰ä¸€è‡´ nginx@nginx-ingress-7mpfc:/etc/nginx/conf.d$ cat vs_default_cafe.conf upstream vs_default_cafe_tea { zone vs_default_cafe_tea 256k; server 10.244.0.51:80 max_fails=1 fail_timeout=10s max_conns=32; server 10.244.1.146:80 max_fails=1 fail_timeout=10s max_conns=32; server 10.244.1.147:80 max_fails=1 fail_timeout=10s max_conns=32; server 10.244.2.162:80 max_fails=1 fail_timeout=10s max_conns=32; keepalive 32; } server { listen 80; server_name cafe.example.com; listen 443 ssl; ssl_certificate /etc/nginx/secrets/default; ssl_certificate_key /etc/nginx/secrets/default; ssl_ciphers NULL; server_tokens &quot;on&quot;; location /tea { proxy_connect_timeout 30s; proxy_read_timeout 30s; proxy_send_timeout 30s; client_max_body_size 2m; proxy_max_temp_file_size 1024m; proxy_buffering on; proxy_http_version 1.1; set $default_connection_header &quot;&quot;; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection $vs_connection_header; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Host $host; proxy_set_header X-Forwarded-Port $server_port; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass https://vs_default_cafe_tea; proxy_next_upstream error timeout non_idempotent; proxy_next_upstream_timeout 5s; proxy_next_upstream_tries 10; } } ","link":"https://tianxiawuhao.github.io/TX9ZIPxbq/"},{"title":"k8sç•Œé¢kubesphereå®‰è£…","content":"åœ¨ Kubernetes ä¸Šå®‰è£… KubeSphere 3.2.1ï¼Œæ‚¨çš„ Kubernetes ç‰ˆæœ¬å¿…é¡»ä¸ºï¼š1.19.xã€1.20.xã€1.21.x æˆ– 1.22.xï¼ˆå®éªŒæ€§æ”¯æŒï¼‰ 1 æ­å»ºNFSä½œä¸ºé»˜è®¤scï¼ˆï¼ˆä¸»èŠ‚ç‚¹ä½œä¸ºæœåŠ¡å™¨ï¼Œä¸»èŠ‚ç‚¹æ“ä½œï¼‰ 1.1 é…ç½®NFSæœåŠ¡å™¨ yum install -y nfs-utils rpcbind &amp;&amp; echo &quot;/nfs *(insecure,rw,sync,no_root_squash)&quot; &gt; /etc/exports 1.2 åˆ›å»ºnfsæœåŠ¡å™¨ç›®å½• mkdir -p /nfs 1.3 å¯åŠ¨rpcbind,nfsæœåŠ¡å‘½ä»¤ systemctl restart rpcbind &amp;&amp; systemctl enable rpcbind systemctl restart nfs-server &amp;&amp; systemctl enable nfs-server 1.4 æ£€æŸ¥é…ç½®æ˜¯å¦ç”Ÿæ•ˆ exportfs -r exportfs 1.5 æµ‹è¯•Podç›´æ¥æŒ‚è½½NFSäº†ï¼ˆä¸»èŠ‚ç‚¹æ“ä½œï¼‰ 1.5.1 åœ¨optç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªnginx.yamlçš„æ–‡ä»¶ vi nginx.yaml 1.5.2 å†™å…¥ä»¥ä¸‹çš„å‘½ä»¤ apiVersion: v1 kind: Pod metadata: name: vol-nfs namespace: default spec: volumes: - name: html nfs: path: /nfs server: 192.168.40.131 #è‡ªå·±çš„nfsæœåŠ¡å™¨åœ°å€ containers: - name: myapp image: nginx volumeMounts: - name: html mountPath: /usr/share/nginx/html/ 1.5.3 åº”ç”¨è¯¥yamlçš„podæœåŠ¡ kubectl apply -f nginx.yaml 1.5.4 æ£€æŸ¥è¯¥podæ˜¯å¦å…è®¸çŠ¶æ€ kubectl get pod kubectl get pods -A è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¿…é¡»ç­‰æ‰€æœ‰çš„çŠ¶æ€ä¸ºRuningæ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚ 2 æ­å»ºNFS-Clientï¼ˆnodeèŠ‚ç‚¹æ“ä½œï¼‰ æœåŠ¡å™¨ç«¯é˜²ç«å¢™å¼€æ”¾111ã€662ã€875ã€892ã€2049çš„ tcp / udp å…è®¸ï¼Œå¦åˆ™è¿œç«¯å®¢æˆ·æ— æ³•è¿æ¥ã€‚ 2.1 å®‰è£…å®¢æˆ·ç«¯å·¥å…· yum install -y nfs-utils rpcbind showmount -e 192.168.40.131 è¯¥IPåœ°å€æ˜¯masterçš„IPåœ°å€ 2.2 åˆ›å»ºåŒæ­¥æ–‡ä»¶å¤¹ mkdir /nfs/data/ 2.3 å°†å®¢æˆ·ç«¯çš„/nfs/dataå’Œ/nfs/åšåŒæ­¥ï¼ˆnodeèŠ‚ç‚¹æ“ä½œï¼‰ mount -t nfs 192.168.40.131:/nfs/ /nfs/data/ 192.168.40.131ï¼šæ˜¯nfsçš„æœåŠ¡å™¨çš„åœ°å€ï¼Œè¿™é‡Œæ˜¯masterçš„IPåœ°å€ã€‚ 3 è®¾ç½®åŠ¨æ€ä¾›åº” 3.1 åˆ›å»ºprovisionerï¼ˆNFSç¯å¢ƒå‰é¢å·²ç»æ­å¥½ï¼‰ å­—æ®µåç§° å¡«å…¥å†…å®¹ å¤‡æ³¨ åç§° nfs-storage è‡ªå®šä¹‰å­˜å‚¨ç±»åç§° NFS Server 192.168.40.131 NFSæœåŠ¡çš„IPåœ°å€ NFS Path /nfs NFSæœåŠ¡æ‰€å…±äº«çš„è·¯å¾„ 3.1.1 å…ˆåˆ›å»ºæˆæƒï¼ˆmasterèŠ‚ç‚¹æ“ä½œï¼‰ vim nfs-rbac.yaml #åœ¨optç›®å½•ä¸‹ æ–°å»ºå†…å®¹å¦‚ä¸‹ï¼š --- apiVersion: v1 kind: ServiceAccount metadata: name: nfs-provisioner --- kind: ClusterRole apiVersion: rbac.authorization.k8s.io/v1 metadata: name: nfs-provisioner-runner rules: - apiGroups: [&quot;&quot;] resources: [&quot;persistentvolumes&quot;] verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;delete&quot;] - apiGroups: [&quot;&quot;] resources: [&quot;persistentvolumeclaims&quot;] verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;update&quot;] - apiGroups: [&quot;storage.k8s.io&quot;] resources: [&quot;storageclasses&quot;] verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;] - apiGroups: [&quot;&quot;] resources: [&quot;events&quot;] verbs: [&quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;] - apiGroups: [&quot;&quot;] resources: [&quot;services&quot;, &quot;endpoints&quot;] verbs: [&quot;get&quot;,&quot;create&quot;,&quot;list&quot;, &quot;watch&quot;,&quot;update&quot;] - apiGroups: [&quot;extensions&quot;] resources: [&quot;podsecuritypolicies&quot;] resourceNames: [&quot;nfs-provisioner&quot;] verbs: [&quot;use&quot;] --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: run-nfs-provisioner subjects: - kind: ServiceAccount name: nfs-provisioner namespace: default roleRef: kind: ClusterRole name: nfs-provisioner-runner apiGroup: rbac.authorization.k8s.io --- kind: Deployment apiVersion: apps/v1 metadata: name: nfs-client-provisioner spec: replicas: 1 strategy: type: Recreate selector: matchLabels: app: nfs-client-provisioner template: metadata: labels: app: nfs-client-provisioner spec: serviceAccount: nfs-provisioner containers: - name: nfs-client-provisioner image: lizhenliang/nfs-client-provisioner volumeMounts: - name: nfs-client-root mountPath: /persistentvolumes env: - name: PROVISIONER_NAME value: storage.pri/nfs - name: NFS_SERVER value: 192.168.40.131 - name: NFS_PATH value: /nfs volumes: - name: nfs-client-root nfs: server: 192.168.40.131 path: /nfs è¿™ä¸ªé•œåƒä¸­volumeçš„mountPathé»˜è®¤ä¸º/persistentvolumesï¼Œä¸èƒ½ä¿®æ”¹ï¼Œå¦åˆ™è¿è¡Œæ—¶ä¼šæŠ¥é”™ã€‚ipçš„å¿…é¡»æ˜¯è‡ªå·±çš„masterçš„IPåœ°å€ã€‚ 3.1.2 æ‰§è¡Œåˆ›å»ºnfsçš„yamlæ–‡ä»¶ä¿¡æ¯ kubectl apply -f nfs-rbac.yaml 3.1.3 å¦‚æœå‘ç°podæœ‰é—®é¢˜ï¼Œæƒ³åˆ é™¤podè¿›è¡Œé‡æ–°kubectl apply-f nfs-rbac.yamlçš„è¯ï¼Œå¯ä»¥å‚ç…§è¿™ä¸ªåšå®¢æ–‡æ¡£ï¼š https://blog.csdn.net/qq_43542988/article/details/101277263?utm_medium=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromMachineLearnPai2-1.channel_param&amp;depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromMachineLearnPai2-1.channel_param 3.1.4 æŸ¥çœ‹podçš„çŠ¶æ€ä¿¡æ¯ kubectl get pods -A # å¦‚æœæŠ¥é”™ï¼šæŸ¥çœ‹æŠ¥é”™ä¿¡æ¯ï¼Œè¿™ä¸ªå‘½ä»¤ï¼š kubectl describe pod xxx -n kube-system 3.1.5 åˆ›å»ºstorageclassï¼ˆmasterèŠ‚ç‚¹æ“ä½œï¼‰ vim storageclass-nfs.yaml apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: storage-nfs provisioner: storage.pri/nfs reclaimPolicy: Delete 3.1.6 åº”ç”¨storageclass-nfs.yamlæ–‡ä»¶ kubectl apply -f storageclass-nfs.yaml 3.1.7 ä¿®æ”¹é»˜è®¤çš„é©±åŠ¨ kubectl patch storageclass storage-nfs -p '{&quot;metadata&quot;: {&quot;annotations&quot;:{&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;true&quot;}}}' kubectl get sc 4 å®‰è£…metrics-server 4.1 å‡†å¤‡metrics-server.yamlæ–‡ä»¶ï¼ˆä¸»èŠ‚ç‚¹æ“ä½œï¼‰ vim metrics-server.yaml 4.2 ç¼–å†™ä»¥ä¸‹çš„å†…å®¹ --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: system:aggregated-metrics-reader labels: rbac.authorization.k8s.io/aggregate-to-view: &quot;true&quot; rbac.authorization.k8s.io/aggregate-to-edit: &quot;true&quot; rbac.authorization.k8s.io/aggregate-to-admin: &quot;true&quot; rules: - apiGroups: [&quot;metrics.k8s.io&quot;] resources: [&quot;pods&quot;, &quot;nodes&quot;] verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;] --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: metrics-server:system:auth-delegator roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:auth-delegator subjects: - kind: ServiceAccount name: metrics-server namespace: kube-system --- apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: name: metrics-server-auth-reader namespace: kube-system roleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: extension-apiserver-authentication-reader subjects: - kind: ServiceAccount name: metrics-server namespace: kube-system --- apiVersion: apiregistration.k8s.io/v1 kind: APIService metadata: name: v1beta1.metrics.k8s.io spec: service: name: metrics-server namespace: kube-system group: metrics.k8s.io version: v1beta1 insecureSkipTLSVerify: true groupPriorityMinimum: 100 versionPriority: 100 --- apiVersion: v1 kind: ServiceAccount metadata: name: metrics-server namespace: kube-system --- apiVersion: apps/v1 kind: Deployment metadata: name: metrics-server namespace: kube-system labels: k8s-app: metrics-server spec: selector: matchLabels: k8s-app: metrics-server template: metadata: name: metrics-server labels: k8s-app: metrics-server spec: serviceAccountName: metrics-server volumes: # mount in tmp so we can safely use from-scratch images and/or read-only containers - name: tmp-dir emptyDir: {} containers: - name: metrics-server image: mirrorgooglecontainers/metrics-server-amd64:v0.3.6 imagePullPolicy: IfNotPresent args: - --cert-dir=/tmp - --secure-port=4443 - --kubelet-insecure-tls - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname ports: - name: main-port containerPort: 4443 protocol: TCP securityContext: readOnlyRootFilesystem: true runAsNonRoot: true runAsUser: 1000 volumeMounts: - name: tmp-dir mountPath: /tmp nodeSelector: kubernetes.io/os: linux kubernetes.io/arch: &quot;amd64&quot; --- apiVersion: v1 kind: Service metadata: name: metrics-server namespace: kube-system labels: kubernetes.io/name: &quot;Metrics-server&quot; kubernetes.io/cluster-service: &quot;true&quot; spec: selector: k8s-app: metrics-server ports: - port: 443 protocol: TCP targetPort: main-port --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: system:metrics-server rules: - apiGroups: - &quot;&quot; resources: - pods - nodes - nodes/stats - namespaces - configmaps verbs: - get - list - watch --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: system:metrics-server roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:metrics-server subjects: - kind: ServiceAccount name: metrics-server namespace: kube-system 4.3 åº”ç”¨è¯¥æ–‡ä»¶pod kubectl apply -f metrics-server.yaml 4.4 æŸ¥çœ‹éƒ¨ç½²çš„åº”ç”¨ä¿¡æ¯çŠ¶æ€ kubectl get pod -A 4.5 æŸ¥çœ‹ç³»ç»Ÿçš„ç›‘æ§çŠ¶æ€ kubectl top nodes å¦‚æœè¿è¡Œkubectl top nodesè¿™ä¸ªå‘½ä»¤ï¼Œçˆ†metrics not available yet è¿™ä¸ªå‘½ä»¤è¿˜æ²¡æœ‰ç”¨ï¼Œé‚£å°±ç¨ç­‰ä¸€ä¼šï¼Œå°±èƒ½ç”¨äº† è¿™é‡Œï¼Œkubesphere3.0çš„å‰ç½®ç¯å¢ƒå…¨éƒ¨ç»“æŸã€‚ 5 å®‰è£…kubesphere v3.0.0 5.1 æ–‡æ¡£åœ°å€ https://kubesphere.com.cn/ 1.5.2 éƒ¨ç½²æ–‡æ¡£åœ°å€ https://kubesphere.com.cn/docs/quick-start/minimal-kubesphere-on-k8s/ 1.5.3 å®‰è£…æ­¥éª¤è¯´æ˜ï¼ˆmasterèŠ‚ç‚¹ï¼‰ 1.5.3.1 å®‰è£…é›†ç¾¤é…ç½®æ–‡ä»¶ 1.5.3.1.1 å‡†å¤‡é…ç½®æ–‡ä»¶cluster-configuration.yaml vim cluster-configuration.yaml 1.5.3.1.2 ç¼–å†™ä»¥ä¸‹çš„å†…å®¹é…ç½® --- apiVersion: installer.kubesphere.io/v1alpha1 kind: ClusterConfiguration metadata: name: ks-installer namespace: kubesphere-system labels: version: v3.2.1 spec: persistence: storageClass: &quot;&quot; # If there is no default StorageClass in your cluster, you need to specify an existing StorageClass here. authentication: jwtSecret: &quot;&quot; # Keep the jwtSecret consistent with the Host Cluster. Retrieve the jwtSecret by executing &quot;kubectl -n kubesphere-system get cm kubesphere-config -o yaml | grep -v &quot;apiVersion&quot; | grep jwtSecret&quot; on the Host Cluster. local_registry: &quot;&quot; # Add your private registry address if it is needed. # dev_tag: &quot;&quot; # Add your kubesphere image tag you want to install, by default it's same as ks-install release version. etcd: monitoring: false # Enable or disable etcd monitoring dashboard installation. You have to create a Secret for etcd before you enable it. endpointIps: localhost # etcd cluster EndpointIps. It can be a bunch of IPs here. port: 2379 # etcd port. tlsEnable: true common: core: console: enableMultiLogin: true # Enable or disable simultaneous logins. It allows different users to log in with the same account at the same time. port: 30880 type: NodePort # apiserver: # Enlarge the apiserver and controller manager's resource requests and limits for the large cluster # resources: {} # controllerManager: # resources: {} redis: enabled: false volumeSize: 2Gi # Redis PVC size. openldap: enabled: false volumeSize: 2Gi # openldap PVC size. minio: volumeSize: 20Gi # Minio PVC size. monitoring: # type: external # Whether to specify the external prometheus stack, and need to modify the endpoint at the next line. endpoint: http://prometheus-operated.kubesphere-monitoring-system.svc:9090 # Prometheus endpoint to get metrics data. GPUMonitoring: # Enable or disable the GPU-related metrics. If you enable this switch but have no GPU resources, Kubesphere will set it to zero. enabled: false gpu: # Install GPUKinds. The default GPU kind is nvidia.com/gpu. Other GPU kinds can be added here according to your needs. kinds: - resourceName: &quot;nvidia.com/gpu&quot; resourceType: &quot;GPU&quot; default: true es: # Storage backend for logging, events and auditing. # master: # volumeSize: 4Gi # The volume size of Elasticsearch master nodes. # replicas: 1 # The total number of master nodes. Even numbers are not allowed. # resources: {} # data: # volumeSize: 20Gi # The volume size of Elasticsearch data nodes. # replicas: 1 # The total number of data nodes. # resources: {} logMaxAge: 7 # Log retention time in built-in Elasticsearch. It is 7 days by default. elkPrefix: logstash # The string making up index names. The index name will be formatted as ks-&lt;elk_prefix&gt;-log. basicAuth: enabled: false username: &quot;&quot; password: &quot;&quot; externalElasticsearchUrl: &quot;&quot; externalElasticsearchPort: &quot;&quot; alerting: # (CPU: 0.1 Core, Memory: 100 MiB) It enables users to customize alerting policies to send messages to receivers in time with different time intervals and alerting levels to choose from. enabled: false # Enable or disable the KubeSphere Alerting System. # thanosruler: # replicas: 1 # resources: {} auditing: # Provide a security-relevant chronological set of recordsï¼Œrecording the sequence of activities happening on the platform, initiated by different tenants. enabled: false # Enable or disable the KubeSphere Auditing Log System. # operator: # resources: {} # webhook: # resources: {} devops: # (CPU: 0.47 Core, Memory: 8.6 G) Provide an out-of-the-box CI/CD system based on Jenkins, and automated workflow tools including Source-to-Image &amp; Binary-to-Image. enabled: false # Enable or disable the KubeSphere DevOps System. # resources: {} jenkinsMemoryLim: 2Gi # Jenkins memory limit. jenkinsMemoryReq: 1500Mi # Jenkins memory request. jenkinsVolumeSize: 8Gi # Jenkins volume size. jenkinsJavaOpts_Xms: 512m # The following three fields are JVM parameters. jenkinsJavaOpts_Xmx: 512m jenkinsJavaOpts_MaxRAM: 2g events: # Provide a graphical web console for Kubernetes Events exporting, filtering and alerting in multi-tenant Kubernetes clusters. enabled: false # Enable or disable the KubeSphere Events System. # operator: # resources: {} # exporter: # resources: {} # ruler: # enabled: true # replicas: 2 # resources: {} logging: # (CPU: 57 m, Memory: 2.76 G) Flexible logging functions are provided for log query, collection and management in a unified console. Additional log collectors can be added, such as Elasticsearch, Kafka and Fluentd. enabled: false # Enable or disable the KubeSphere Logging System. containerruntime: docker logsidecar: enabled: true replicas: 2 # resources: {} metrics_server: # (CPU: 56 m, Memory: 44.35 MiB) It enables HPA (Horizontal Pod Autoscaler). enabled: false # Enable or disable metrics-server. monitoring: storageClass: &quot;&quot; # If there is an independent StorageClass you need for Prometheus, you can specify it here. The default StorageClass is used by default. # kube_rbac_proxy: # resources: {} # kube_state_metrics: # resources: {} # prometheus: # replicas: 1 # Prometheus replicas are responsible for monitoring different segments of data source and providing high availability. # volumeSize: 20Gi # Prometheus PVC size. # resources: {} # operator: # resources: {} # adapter: # resources: {} # node_exporter: # resources: {} # alertmanager: # replicas: 1 # AlertManager Replicas. # resources: {} # notification_manager: # resources: {} # operator: # resources: {} # proxy: # resources: {} gpu: # GPU monitoring-related plug-in installation. nvidia_dcgm_exporter: # Ensure that gpu resources on your hosts can be used normally, otherwise this plug-in will not work properly. enabled: false # Check whether the labels on the GPU hosts contain &quot;nvidia.com/gpu.present=true&quot; to ensure that the DCGM pod is scheduled to these nodes. # resources: {} multicluster: clusterRole: none # host | member | none # You can install a solo cluster, or specify it as the Host or Member Cluster. network: networkpolicy: # Network policies allow network isolation within the same cluster, which means firewalls can be set up between certain instances (Pods). # Make sure that the CNI network plugin used by the cluster supports NetworkPolicy. There are a number of CNI network plugins that support NetworkPolicy, including Calico, Cilium, Kube-router, Romana and Weave Net. enabled: false # Enable or disable network policies. ippool: # Use Pod IP Pools to manage the Pod network address space. Pods to be created can be assigned IP addresses from a Pod IP Pool. type: none # Specify &quot;calico&quot; for this field if Calico is used as your CNI plugin. &quot;none&quot; means that Pod IP Pools are disabled. topology: # Use Service Topology to view Service-to-Service communication based on Weave Scope. type: none # Specify &quot;weave-scope&quot; for this field to enable Service Topology. &quot;none&quot; means that Service Topology is disabled. openpitrix: # An App Store that is accessible to all platform tenants. You can use it to manage apps across their entire lifecycle. store: enabled: false # Enable or disable the KubeSphere App Store. servicemesh: # (0.3 Core, 300 MiB) Provide fine-grained traffic management, observability and tracing, and visualized traffic topology. enabled: false # Base component (pilot). Enable or disable KubeSphere Service Mesh (Istio-based). kubeedge: # Add edge nodes to your cluster and deploy workloads on edge nodes. enabled: false # Enable or disable KubeEdge. cloudCore: nodeSelector: {&quot;node-role.kubernetes.io/worker&quot;: &quot;&quot;} tolerations: [] cloudhubPort: &quot;10000&quot; cloudhubQuicPort: &quot;10001&quot; cloudhubHttpsPort: &quot;10002&quot; cloudstreamPort: &quot;10003&quot; tunnelPort: &quot;10004&quot; cloudHub: advertiseAddress: # At least a public IP address or an IP address which can be accessed by edge nodes must be provided. - &quot;&quot; # Note that once KubeEdge is enabled, CloudCore will malfunction if the address is not provided. nodeLimit: &quot;100&quot; service: cloudhubNodePort: &quot;30000&quot; cloudhubQuicNodePort: &quot;30001&quot; cloudhubHttpsNodePort: &quot;30002&quot; cloudstreamNodePort: &quot;30003&quot; tunnelNodePort: &quot;30004&quot; edgeWatcher: nodeSelector: {&quot;node-role.kubernetes.io/worker&quot;: &quot;&quot;} tolerations: [] edgeWatcherAgent: nodeSelector: {&quot;node-role.kubernetes.io/worker&quot;: &quot;&quot;} tolerations: [] endpointIps: 192.168.40.131ï¼šmasterèŠ‚ç‚¹çš„åœ°å€ã€‚ 1.5.3.1.3 å‡†å¤‡é…ç½®æ–‡ä»¶kubesphere-installer.yaml vim kubesphere-installer.yaml 1.5.3.1.4 ç¼–å†™ä»¥ä¸‹çš„å†…å®¹é…ç½® --- apiVersion: apiextensions.k8s.io/v1 kind: CustomResourceDefinition metadata: name: clusterconfigurations.installer.kubesphere.io spec: group: installer.kubesphere.io versions: - name: v1alpha1 served: true storage: true schema: openAPIV3Schema: type: object properties: spec: type: object x-kubernetes-preserve-unknown-fields: true status: type: object x-kubernetes-preserve-unknown-fields: true scope: Namespaced names: plural: clusterconfigurations singular: clusterconfiguration kind: ClusterConfiguration shortNames: - cc --- apiVersion: v1 kind: Namespace metadata: name: kubesphere-system --- apiVersion: v1 kind: ServiceAccount metadata: name: ks-installer namespace: kubesphere-system --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: ks-installer rules: - apiGroups: - &quot;&quot; resources: - '*' verbs: - '*' - apiGroups: - apps resources: - '*' verbs: - '*' - apiGroups: - extensions resources: - '*' verbs: - '*' - apiGroups: - batch resources: - '*' verbs: - '*' - apiGroups: - rbac.authorization.k8s.io resources: - '*' verbs: - '*' - apiGroups: - apiregistration.k8s.io resources: - '*' verbs: - '*' - apiGroups: - apiextensions.k8s.io resources: - '*' verbs: - '*' - apiGroups: - tenant.kubesphere.io resources: - '*' verbs: - '*' - apiGroups: - certificates.k8s.io resources: - '*' verbs: - '*' - apiGroups: - devops.kubesphere.io resources: - '*' verbs: - '*' - apiGroups: - monitoring.coreos.com resources: - '*' verbs: - '*' - apiGroups: - logging.kubesphere.io resources: - '*' verbs: - '*' - apiGroups: - jaegertracing.io resources: - '*' verbs: - '*' - apiGroups: - storage.k8s.io resources: - '*' verbs: - '*' - apiGroups: - admissionregistration.k8s.io resources: - '*' verbs: - '*' - apiGroups: - policy resources: - '*' verbs: - '*' - apiGroups: - autoscaling resources: - '*' verbs: - '*' - apiGroups: - networking.istio.io resources: - '*' verbs: - '*' - apiGroups: - config.istio.io resources: - '*' verbs: - '*' - apiGroups: - iam.kubesphere.io resources: - '*' verbs: - '*' - apiGroups: - notification.kubesphere.io resources: - '*' verbs: - '*' - apiGroups: - auditing.kubesphere.io resources: - '*' verbs: - '*' - apiGroups: - events.kubesphere.io resources: - '*' verbs: - '*' - apiGroups: - core.kubefed.io resources: - '*' verbs: - '*' - apiGroups: - installer.kubesphere.io resources: - '*' verbs: - '*' - apiGroups: - storage.kubesphere.io resources: - '*' verbs: - '*' - apiGroups: - security.istio.io resources: - '*' verbs: - '*' - apiGroups: - monitoring.kiali.io resources: - '*' verbs: - '*' - apiGroups: - kiali.io resources: - '*' verbs: - '*' - apiGroups: - networking.k8s.io resources: - '*' verbs: - '*' - apiGroups: - kubeedge.kubesphere.io resources: - '*' verbs: - '*' - apiGroups: - types.kubefed.io resources: - '*' verbs: - '*' - apiGroups: - monitoring.kubesphere.io resources: - '*' verbs: - '*' - apiGroups: - application.kubesphere.io resources: - '*' verbs: - '*' --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: ks-installer subjects: - kind: ServiceAccount name: ks-installer namespace: kubesphere-system roleRef: kind: ClusterRole name: ks-installer apiGroup: rbac.authorization.k8s.io --- apiVersion: apps/v1 kind: Deployment metadata: name: ks-installer namespace: kubesphere-system labels: app: ks-install spec: replicas: 1 selector: matchLabels: app: ks-install template: metadata: labels: app: ks-install spec: serviceAccountName: ks-installer containers: - name: installer image: kubesphere/ks-installer:v3.2.1 imagePullPolicy: &quot;Always&quot; resources: limits: cpu: &quot;1&quot; memory: 1Gi requests: cpu: 20m memory: 100Mi volumeMounts: - mountPath: /etc/localtime name: host-time readOnly: true volumes: - hostPath: path: /etc/localtime type: &quot;&quot; name: host-time 1.5.3.1.5 åˆ†åˆ«æ‰§è¡Œä¸¤ä¸ªæ–‡ä»¶ kubectl apply -f kubesphere-installer.yaml kubectl apply -f cluster-configuration.yaml #æˆ–è€…ç›´æ¥ç”¨ç½‘ç»œæ–‡ä»¶å®‰è£… kubectl apply -f https://github.com/kubesphere/ks-installer/releases/download/v3.2.1/kubesphere-installer.yaml kubectl apply -f https://github.com/kubesphere/ks-installer/releases/download/v3.2.1/cluster-configuration.yaml 1.5.3.1.6 ç›‘æ§å®‰è£…çš„æ—¥å¿—ä¿¡æ¯ kubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l app=ks-install -o jsonpath='{.items[0].metadata.name}') -f 1.5.3.1.7 æŸ¥çœ‹podå¯åŠ¨çŠ¶æ€ä¿¡æ¯ kubectl get pods -A éœ€è¦ç­‰å¾…æ¼«é•¿çš„æ—¶é—´ã€‚ 1.5.4 è®¿é—®éªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸ è®¿é—®åœ°å€ï¼š http://192.168.40.131:30880/login å¸å·ï¼šadmin å¯†ç ï¼šP@88w0rd 1.5.5 harborç›®å½•ä¸‹é‡æ–°å¯åŠ¨harbor docker-compose stop docker-compose up -d ","link":"https://tianxiawuhao.github.io/ULtZ5rQXA/"},{"title":"harborè‡ªå»ºé•œåƒä»“åº“","content":"centosç½‘ç»œé…ç½® 1.è®¾ç½®ä¸»æœºå [root@localhost ~]# hostnamectl set-hostname harbor 2.æ·»åŠ  Host è§£æ [root@harbor ~]# cat /etc/hosts 127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 ::1 localhost localhost.localdomain localhost6 localhost6.localdomain6 192.168.40.131 k8s-master 192.168.40.132 k8s-node1 192.168.40.133 k8s-node2 192.168.40.150 hub.test.com k8s é›†ç¾¤æ¯ä¸ªèŠ‚ç‚¹æ·»åŠ è§£æï¼ˆæ³¨æ„ï¼šK8s æ¯ä¸ªèŠ‚ç‚¹ï¼Œä¸æ˜¯ Harborï¼‰ [root@k8s-master ~]# echo &quot;192.168.40.150 hub.test.com&quot; &gt;&gt; /etc/hosts [root@k8s-node1 ~]# echo &quot;192.168.40.150 hub.test.com&quot; &gt;&gt; /etc/hosts [root@k8s-node2 ~]# echo &quot;192.168.40.150 hub.test.com&quot; &gt;&gt; /etc/hosts 3.ç½‘ç»œç¯å¢ƒè®¾ç½® vi /etc/sysconfig/network-scripts/ifcfg-ens33 å†…å®¹æ›¿æ¢å¦‚ä¸‹ï¼š BOOTPROTO=static #é™æ€è¿æ¥ ONBOOT=yes #ç½‘ç»œè®¾å¤‡å¼€æœºå¯åŠ¨ IPADDR=192.168.40.150 NETMASK=255.255.255.0 #å­ç½‘æ©ç  GATEWAY=192.168.40.2 #ç½‘å…³ DNS1=114.114.114.114 #DNSè§£æ ç½‘ç»œæœåŠ¡é‡å¯ service network restart å®‰è£…ç¯å¢ƒ 1.å®‰è£…Docker-CE # å¸è½½æ—§ç‰ˆæœ¬ yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine # å®‰è£…æ‰€éœ€çš„è½¯ä»¶åŒ… yum install -y yum-utils device-mapper-persistent-data lvm2 # æ·»åŠ dockerå­˜å‚¨åº“ yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo #å®‰è£…æœ€æ–°ç‰ˆçš„docker-ce yum install -y docker-ce docker-ce-cli containerd.io #å¯åŠ¨dockerå¹¶è®¾ç½®ä¸ºå¼€æœºè‡ªå¯åŠ¨ systemctl enable --now docker 2.é…ç½®Dockeré•œåƒåŠ é€Ÿå™¨ tee /etc/docker/daemon.json &lt;&lt;-'EOF' { &quot;registry-mirrors&quot;: [&quot;https://hub-mirror.c.163.com/&quot;], &quot;insecure-registries&quot;: [&quot;https://hub.test.com&quot;] } EOF # é‡å¯ systemctl daemon-reload &amp;&amp; systemctl restart docker 3.å®‰è£…docker-compose #1ã€å®‰è£…pip yum -y install epel-release yum install python3-pip pip3 install --upgrade pip #2ã€å®‰è£…docker-compose pip3 install docker-compose #3ã€æŸ¥çœ‹ç‰ˆæœ¬ docker-compose version 4.åˆ›å»º https è¯ä¹¦ å®‰è£… openssl [root@harbor]# yum install openssl -y åˆ›å»ºè¯ä¹¦ç›®å½•ï¼Œå¹¶èµ‹äºˆæƒé™ [root@harbor ~]# mkdir -p /cert/harbor [root@harbor ~]# chmod -R 777 /cert/harbor [root@harbor ~]# cd /cert/harbor åˆ›å»ºæœåŠ¡å™¨è¯ä¹¦å¯†é’¥æ–‡ä»¶ harbor.key [root@harbor harbor]# openssl genrsa -des3 -out harbor.key 2048 è¾“å…¥å¯†ç ï¼Œç¡®è®¤å¯†ç ï¼Œè‡ªå·±éšä¾¿å®šä¹‰ï¼Œä½†æ˜¯è¦è®°ä½ï¼Œåé¢ä¼šç”¨åˆ°ã€‚ åˆ›å»ºæœåŠ¡å™¨è¯ä¹¦çš„ç”³è¯·æ–‡ä»¶ harbor.csr [root@harbor harbor]# openssl req -new -key harbor.key -out harbor.csr è¾“å…¥å¯†é’¥æ–‡ä»¶çš„å¯†ç , ç„¶åä¸€è·¯å›è½¦ã€‚ å¤‡ä»½ä¸€ä»½æœåŠ¡å™¨å¯†é’¥æ–‡ä»¶ [root@harbor harbor]# cp harbor.key harbor.key.org å»é™¤æ–‡ä»¶å£ä»¤ [root@harbor harbor]# openssl rsa -in harbor.key.org -out harbor.key è¾“å…¥å¯†é’¥æ–‡ä»¶çš„å¯†ç  åˆ›å»ºä¸€ä¸ªè‡ªå½“å‰æ—¥æœŸèµ·ä¸ºæœŸåå¹´çš„è¯ä¹¦ harbor.crt [root@harbor harbor]# openssl x509 -req -days 3650 -in harbor.csr -signkey harbor.key -out harbor.crt 5.ä¸‹è½½Harborå®‰è£…åŒ…å¹¶è§£å‹ é“¾æ¥ï¼šhttps://pan.baidu.com/s/1AUEw0Qw3w9lZP-rnAYaWjA æå–ç ï¼šqutg wget https://github.com/goharbor/harbor/releases/download/v2.5.0/harbor-offline-installer-v2.5.0.tgz tar zxvf harbor-offline-installer-v2.5.0.tgz 6.é…ç½®harbor.cfgå’Œå®‰è£…Harbor vi harbor.yml å°†httpç«¯å£æ”¹æˆ10086ï¼Œå› ä¸ºé»˜è®¤ç”¨çš„80ç«¯å£å·²ç»è¢«å ç”¨ï¼Œhttpå¯ä»¥æŒ‡å®šä»»æ„ç«¯å£ï¼› æ¥ä¸‹æ¥è¿è¡Œinstall.shå®‰è£…å’Œå¯åŠ¨harbor ./prepare ./install.sh 7.æµ‹è¯• Harbor [root@k8s-master01 ~]# docker login https://hub.test.com Username: admin Password: Harbor12345 # é»˜è®¤å¯†ç ï¼Œå¯é€šè¿‡ harbor.yml é…ç½®æ–‡ä»¶ä¿®æ”¹ ç™»å½•æ—¶æŠ¥ï¼šError response from daemon: Get https://hub.test.com/v2/: x509: certificate is not valid for any names, but wanted to match hub.test.com è§£å†³ï¼šä¿®æ”¹å®¢æˆ·ç«¯ï¼ˆå³éœ€è¦ç™»é™†harborçš„æœºå™¨ï¼‰çš„docker.service æ–‡ä»¶ vi /lib/systemd/system/docker.service æ·»åŠ  --insecure-registry hub.test.com é‡æ–°åŠ è½½æœåŠ¡é…ç½®æ–‡ä»¶ï¼Œå¹¶ä¸”é‡å¯dockeræœåŠ¡ systemctl daemon-reload &amp;&amp; systemctl restart docker ä¸‹è½½é•œåƒæ¨é€åˆ° Harbor [root@k8s-node01 ~]# docker pull nginx [root@k8s-node01 ~]# docker tag nginx:latest hub.test.com/library/test:v1 [root@k8s-node01 ~]# docker push hub.test.com/library/test:v1 8.Windows è®¿é—® Harbor Webç•Œé¢ Windows æ·»åŠ  hosts è§£æè·¯å¾„ C:\\Windows\\System32\\drivers\\etc\\hosts æ·»åŠ ä¿¡æ¯ 192.168.40.150 hub.test.com æµè§ˆå™¨è®¿é—®æµ‹è¯• https://hub.test.com ç”¨æˆ·å¯†ç ï¼šadmin / Harbor12345 ","link":"https://tianxiawuhao.github.io/WOO39eqh2/"},{"title":"k8s1.24.1å®‰è£…ï¼ˆåŸºäºCentos 7ï¼‰","content":"æ³¨æ„ï¼šé™¤äº†MasterèŠ‚ç‚¹åˆå§‹åŒ–åŠNodeèŠ‚ç‚¹æ·»åŠ åˆ†åˆ«åœ¨MasterèŠ‚ç‚¹å’ŒNodeèŠ‚ç‚¹æ‰§è¡Œå¤–ï¼Œå…¶ä½™æ‰€æœ‰å‘½ä»¤å‡åœ¨æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œ æ•´ä½“ç¯å¢ƒ ä¸€å°masterèŠ‚ç‚¹ï¼Œ2å°nodeèŠ‚ç‚¹ã€‚é‡‡ç”¨äº†Centos 7ï¼Œæœ‰ç½‘ç»œï¼Œäº’ç›¸å¯ä»¥pingé€šã€‚ 1.å†…æ ¸å‡çº§ï¼ˆå¯å¿½ç•¥ï¼‰ ä¸ºé¿å…å‡ºç°ä¸å¯é¢„çŸ¥çš„é—®é¢˜ï¼Œæå‡centos 7å†…æ ¸åˆ°æœ€æ–°ç‰ˆæœ¬ è”ç½‘å‡çº§å†…æ ¸ 1. æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬ uname -r 2. å¯¼å…¥ELRepoè½¯ä»¶ä»“åº“çš„å…¬å…±ç§˜é’¥ rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org 3. å®‰è£…ELRepoè½¯ä»¶ä»“åº“çš„yumæº rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm 4. å¯ç”¨ elrepo è½¯ä»¶æºå¹¶ä¸‹è½½å®‰è£…æœ€æ–°ç¨³å®šç‰ˆå†…æ ¸ yum --enablerepo=elrepo-kernel install kernel-ml -y 5. æŸ¥çœ‹ç³»ç»Ÿå¯ç”¨å†…æ ¸ï¼Œå¹¶è®¾ç½®å†…æ ¸å¯åŠ¨é¡ºåº sudo awk -F\\' '$1==&quot;menuentry &quot; {print i++ &quot; : &quot; $2}' /etc/grub2.cfg 6. ç”Ÿæˆ grub é…ç½®æ–‡ä»¶ æœºå™¨ä¸Šå­˜åœ¨å¤šä¸ªå†…æ ¸ï¼Œæˆ‘ä»¬è¦ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ï¼Œå¯ä»¥é€šè¿‡ grub2-set-default 0 å‘½ä»¤ç”Ÿæˆ grub é…ç½®æ–‡ä»¶ grub2-set-default 0 #åˆå§‹åŒ–é¡µé¢çš„ç¬¬ä¸€ä¸ªå†…æ ¸å°†ä½œä¸ºé»˜è®¤å†…æ ¸ grub2-mkconfig -o /boot/grub2/grub.cfg #é‡æ–°åˆ›å»ºå†…æ ¸é…ç½® 7. é‡å¯ç³»ç»Ÿå¹¶éªŒè¯ yum update reboot uname -r 8. åˆ é™¤æ—§å†…æ ¸ yum -y remove kernel kernel-tools 2.centosç½‘ç»œé…ç½®æ–‡ä»¶ ç½‘ç»œé…ç½®æ–‡ä»¶åå¯èƒ½ä¼šæœ‰ä¸åŒï¼Œåœ¨è¾“å…¥åˆ°ifcfgæ—¶ï¼Œå¯ä»¥è¿ç»­æŒ‰ä¸¤ä¸‹tabé”®ï¼Œè·å–æç¤ºï¼Œæ¯”å¦‚æˆ‘çš„æœºå™¨ ä¸º ifcfg-ens33 vi /etc/sysconfig/network-scripts/ifcfg-ens33 1.å†…å®¹æ›¿æ¢å¦‚ä¸‹ï¼š BOOTPROTO=static #é™æ€è¿æ¥ ONBOOT=yes #ç½‘ç»œè®¾å¤‡å¼€æœºå¯åŠ¨ IPADDR=192.168.40.131 #192.168.40.132,192.168.40.133. NETMASK=255.255.255.0 #å­ç½‘æ©ç  GATEWAY=192.168.40.2 #ç½‘å…³ DNS1=114.114.114.114 #DNSè§£æ 2.ç½‘ç»œæœåŠ¡é‡å¯ service network restart 3.æŸ¥çœ‹IPåœ°å€ 3.å®‰è£…ä¾èµ–åŒ… yum install -y wget 4.ä¿®æ”¹yumæºï¼ˆè§†ç½‘ç»œæƒ…å†µæ“ä½œï¼‰ 1.å¤‡ä»½ cp /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup 2.ä¸‹è½½ wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo æˆ–è€…ä½¿ç”¨æ¸…åå¤§å­¦ç«™ sudo sed -e 's|^mirrorlist=|#mirrorlist=|g' -e 's|^#baseurl=http://mirror.centos.org/$contentdir|baseurl=https://mirrors.tuna.tsinghua.edu.cn/centos|g' -i.bak /etc/yum.repos.d/CentOS-Base.repo 3.æ¸…é™¤ç”Ÿæˆç¼“å­˜ yum clean all # æ¸…é™¤ç³»ç»Ÿæ‰€æœ‰çš„yumç¼“å­˜ yum makecache # ç”Ÿæˆyumç¼“å­˜ 5.ä¿®æ”¹ä¸»æœºå hostnamectl set-hostname k8s-master hostnamectl set-hostname k8s-node1 hostnamectl set-hostname k8s-node2 æŸ¥çœ‹ä¸»æœºåç§° 6.æ·»åŠ hostsè§£æ echo -e &quot;192.168.40.131 k8s-master\\n192.168.40.132 k8s-node1\\n192.168.40.133 k8s-node2&quot; &gt;&gt; /etc/hosts 7.å…³é—­é˜²ç«å¢™firewalld systemctl stop firewalld &amp;&amp; systemctl disable firewalld 8.å…³é—­selinux setenforce 0 &amp;&amp; sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config 9.å…³é—­swapåˆ†åŒºäº¤æ¢ swapoff -a &amp;&amp; sed -i '/ swap / s/^\\(.*\\)$/#\\1/g' /etc/fstab 10.é…ç½®å†…æ ¸å‚æ•° å°†æ¡¥æ¥çš„IPv4æµé‡ä¼ é€’å€’iptablesçš„é“¾ 1.è®¾ç½®å†…æ ¸å‚æ•° cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt;EOF net.bridge.bridge-nf-call-iptables=1 net.bridge.bridge-nf-call-ip6tables=1 net.ipv4.ip_forward=1 net.ipv4.tcp_tw_recycle=0 vm.swappiness=0 # ç¦æ­¢ä½¿ç”¨swapç©ºé—´ï¼Œåªæœ‰å½“ç³»ç»Ÿ00Mæ—¶æ‰å…è®¸ä½¿ç”¨å®ƒ vm.overcommit_memory=1 # ä¸æ£€æŸ¥ç‰©ç†å†…å­˜æ˜¯å¦å¤Ÿç”¨ vm.panic_on_oom=0 # å¼€å¯oom fs.inotify.max_user_instances=8192 fs.inotify.max_user_watches=1048576 fs.file-max=52786963 fs.nr_open=52706963 net.ipv6.conf.all.disable_ipv6=1 net.netfilter.nf_conntrack_max=2310720 EOF 2.åŠ è½½å†…æ ¸æ¨¡å— modprobe br_netfilter &amp;&amp; echo &quot;modprobe br_netfilter&quot; &gt;&gt; /etc/rc.local 3.ä½¿å†…æ ¸å‚æ•°ç”Ÿæ•ˆ sysctl -p /etc/sysctl.d/k8s.conf 11.æ—¶é—´åŒæ­¥ timedatectl set-timezone Asia/Shanghai &amp;&amp; timedatectl set-local-rtc 0 #é‡å¯ä¾èµ–äºç³»ç»Ÿæ—¶é—´çš„æœåŠ¡ systemctl restart rsyslog &amp;&amp; systemctl restart crond 12.å®‰è£…iptablesï¼Œè®¾ç½®ç©ºè¡¨ yum -y install iptables-services &amp;&amp; systemctl start iptables &amp;&amp; systemctl enable iptables &amp;&amp; iptables -F &amp;&amp; service iptables save æ£€æŸ¥æœåŠ¡çš„çš„è§„åˆ™ï¼šiptables -L -n 13.å¼€å¯IPVS ç”±äºipvså·²ç»åŠ å…¥åˆ°äº†å†…æ ¸çš„ä¸»å¹²ï¼Œæ‰€ä»¥ä¸ºkube-proxyå¼€å¯ipvsçš„å‰æéœ€è¦åŠ è½½ä»¥ä¸‹çš„å†…æ ¸æ¨¡å— cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF #ï¼/bin/bash modprobe -- ip_vs modprobe -- ip_vs_rr modprobe -- ip_vs_wrr modprobe -- ip_vs_sh modprobe -- nf_conntrack_ipv4 EOF æˆæƒå¯åŠ¨ chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod æ¥ä¸‹æ¥è¿˜éœ€è¦ç¡®ä¿å„ä¸ªèŠ‚ç‚¹ä¸Šå·²ç»å®‰è£…äº†ipsetè½¯ä»¶åŒ…ã€‚ ä¸ºäº†ä¾¿äºæŸ¥çœ‹ipvsçš„ä»£ç†è§„åˆ™ï¼Œæœ€å¥½å®‰è£…ä¸€ä¸‹ç®¡ç†å·¥å…·ipvsadmã€‚ yum install ipset ipvsadm -y serviceåº•å±‚å®ç°ä¸»è¦ç”±ä¸¤ä¸ªç½‘ç»œæ¨¡å¼ç»„æˆï¼šiptablesä¸IPVSã€‚ä»–ä»¬éƒ½æ˜¯æœ‰kube-proxyç»´æŠ¤ Iptables VS IPVS Iptablesï¼š â€¢ çµæ´»ï¼ŒåŠŸèƒ½å¼ºå¤§ â€¢ è§„åˆ™éå†åŒ¹é…å’Œæ›´æ–°ï¼Œå‘ˆçº¿æ€§æ—¶å»¶ IPVSï¼š â€¢ å·¥ä½œåœ¨å†…æ ¸æ€ï¼Œæœ‰æ›´å¥½çš„æ€§èƒ½ â€¢ è°ƒåº¦ç®—æ³•ä¸°å¯Œï¼šrrï¼Œwrrï¼Œlcï¼Œwlcï¼Œip hash ç­‰é›†ç¾¤éƒ¨ç½²æˆåŠŸï¼Œmodeç”±ç©ºå€¼ä¿®æ”¹æˆipvsæ¨¡å¼ kubectl edit configmap kube-proxy -n kube-system configmap/kube-proxy edited åˆ é™¤æ‰€æœ‰kube-proxyçš„pod,ç­‰å¾…é‡å¯ kubectl delete pod/kube-proxy-84p9n -n kube-system # æŸ¥çœ‹ipvsç›¸å…³è§„åˆ™ ipvsadm 14.å®‰è£…dockerè½¯ä»¶ è‡ª1.20ç‰ˆæœ¬è¢«å¼ƒç”¨ä¹‹åï¼Œdockershimç»„ä»¶ç»ˆäºåœ¨1.24çš„kubeletä¸­è¢«åˆ é™¤ã€‚ä»1.24å¼€å§‹ï¼Œå¤§å®¶éœ€è¦ä½¿ç”¨å…¶ä»–å—åˆ°æ”¯æŒçš„è¿è¡Œæ—¶é€‰é¡¹ï¼ˆä¾‹å¦‚containerdæˆ–CRI-Oï¼‰ï¼›å¦‚æœæ‚¨é€‰æ‹©Docker Engineä½œä¸ºè¿è¡Œæ—¶ï¼Œåˆ™éœ€è¦ä½¿ç”¨cri-dockerdã€‚ 1.åˆ é™¤è‡ªå¸¦çš„docker yum remove docker \\ docker-client \\ docker-client-latest \\ docker-common \\ docker-latest \\ docker-latest-logrotate \\ docker-logrotate \\ docker-selinux \\ docker-engine-selinux \\ docker-engine 2.å®‰è£…ä¾èµ–åŒ… yum install -y yum-utils device-mapper-persistent-data lvm2 3.å®‰è£…yumæº yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo 4.å®‰è£…docker-ce yum -y install docker-ce 5.è®¾ç½®docker cat &gt; /etc/docker/daemon.conf &lt;&lt;EOF { &quot;registry-mirrors&quot;: [&quot;https://registry.docker-cn.com&quot;,&quot;https://heusyzko.mirror.aliyuncs.com&quot;], &quot;insecure-registries&quot;: [&quot;https://hub.test.com&quot;], &quot;exec-opts&quot;:[&quot;native.cgroupdriver=systemd&quot;], &quot;log-driver&quot;:&quot;json-file&quot;, &quot;log-opts&quot;:{ &quot;max-size&quot;: &quot;100m&quot; }, &quot;storage-driver&quot;: &quot;overlay2&quot; } EOF mkdir -p /etc/systemd/system/docker.service.d 6.é‡å¯dockeræœåŠ¡ systemctl daemon-reload &amp;&amp; systemctl start docker &amp;&amp; systemctl enable docker systemctl daemon-reload &amp;&amp; systemctl restart docker ä»¥ä¸‹çš„NO_PROXYè¡¨ç¤ºå¯¹è¿™äº›ç½‘æ®µçš„æœåŠ¡å™¨ä¸ä½¿ç”¨ä»£ç†ï¼Œå¦‚æœä¸éœ€è¦ç”¨åˆ°ä»£ç†æœåŠ¡å™¨ï¼Œä»¥ä¸‹çš„é…ç½®å¯ä»¥ä¸å†™ï¼Œæ³¨æ„ï¼Œä»¥ä¸‹çš„ä»£ç†æ˜¯ä¸é€šçš„ã€‚ä¸å»ºè®®ä½¿ç”¨ä»£ç†ï¼Œå› ä¸ºå›½å†…æœ‰èµ„æºå¯ä»¥è®¿é—®åˆ°gcr.ioéœ€è¦çš„é•œåƒï¼Œä¸‹æ–‡ä¼šä»‹ç» #æ”¾åœ¨Type=notifyä¸‹é¢ vi /usr/lib/systemd/system/docker.service Environment=&quot;HTTPS_PROXY=http://www.ik8s.io:10080&quot; Environment=&quot;HTTP_PROXY=http://www.ik8s.io:10080&quot; Environment=&quot;NO_PROXY=127.0.0.0/8,172.20.0.0/16&quot; #ä¿å­˜é€€å‡ºåï¼Œæ‰§è¡Œ systemctl daemon-reload #ç¡®ä¿å¦‚ä¸‹ä¸¤ä¸ªå‚æ•°å€¼ä¸º1ï¼Œé»˜è®¤ä¸º1ã€‚ cat /proc/sys/net/bridge/bridge-nf-call-ip6tables cat /proc/sys/net/bridge/bridge-nf-call-iptables #å¯åŠ¨docker-ce systemctl restart docker #è®¾ç½®å¼€æœºå¯åŠ¨ systemctl enable docker.service #æƒ³è¦åˆ é™¤å®¹å™¨ï¼Œåˆ™è¦å…ˆåœæ­¢æ‰€æœ‰å®¹å™¨ï¼ˆå½“ç„¶ï¼Œä¹Ÿå¯ä»¥åŠ -få¼ºåˆ¶åˆ é™¤ï¼Œä½†æ˜¯ä¸æ¨èï¼‰ï¼š docker stop $(docker ps -a -q) #åˆ é™¤æ‰€æœ‰å®¹å™¨ docker rm $(docker ps -a -q) #.åˆ é™¤æ‰€æœ‰é•œåƒï¼ˆæ…é‡ï¼‰ docker rmi $(docker images -q) 14.2.cri-dockerdå®‰è£… CRI-Dockerd å…¶å®å°±æ˜¯ä»è¢«ç§»é™¤çš„ Docker Shim ä¸­ï¼Œç‹¬ç«‹å‡ºæ¥çš„ä¸€ä¸ªé¡¹ç›®ï¼Œç”¨äºè§£å†³å†å²é—ç•™çš„èŠ‚ç‚¹å‡çº§ Kubernetes çš„é—®é¢˜ã€‚ kubeletå¹¶æ²¡æœ‰ç›´æ¥å’Œdockerdäº¤äº’ï¼Œè€Œæ˜¯é€šè¿‡äº†ä¸€ä¸ªdockershimçš„ç»„ä»¶é—´æ¥æ“ä½œdockerdã€‚dockershimæä¾›äº†ä¸€ä¸ªæ ‡å‡†çš„æ¥å£ï¼Œè®©kubeletèƒ½å¤Ÿä¸“æ³¨äºå®¹å™¨è°ƒåº¦é€»è¾‘æœ¬èº«ï¼Œè€Œä¸ç”¨å»é€‚é…dockerdçš„æ¥å£å˜åŠ¨ã€‚è€Œå…¶ä»–å®ç°äº†ç›¸åŒæ ‡å‡†æ¥å£çš„å®¹å™¨æŠ€æœ¯ä¹Ÿå¯ä»¥è¢«kubeleté›†æˆä½¿ç”¨ï¼Œè¿™ä¸ªæ¥å£ç§°ä½œCRIã€‚dockershimå’ŒCRIçš„å‡ºç°ä¹Ÿæ˜¯å®¹å™¨ç”Ÿæ€ç³»ç»Ÿæ¼”åŒ–çš„å†å²äº§ç‰©ã€‚åœ¨k8sæœ€æ—©æœŸçš„ç‰ˆæœ¬ä¸­æ˜¯ä¸å­˜åœ¨dockershimçš„ï¼Œkubeletç›´æ¥å’Œdockerdäº¤äº’ã€‚ä½†ä¸ºäº†æ”¯æŒæ›´å¤šä¸åŒçš„å®¹å™¨æŠ€æœ¯ï¼ˆé¿å…å®Œå…¨è¢«dockeræ§åˆ¶å®¹å™¨æŠ€æœ¯å¸‚åœºï¼‰ï¼Œkubeletåœ¨ä¹‹åçš„ç‰ˆæœ¬å¼€å§‹æ”¯æŒå¦ä¸€ç§å®¹å™¨æŠ€æœ¯rktã€‚è¿™ç»™kubeletçš„ç»´æŠ¤å·¥ä½œé€ æˆäº†å·¨å¤§çš„æŒ‘æˆ˜ï¼Œå› ä¸ºä¸¤ç§å®¹å™¨æŠ€æœ¯æ²¡æœ‰ç»Ÿä¸€çš„æ¥å£å’Œä½¿ç”¨é€»è¾‘ï¼ŒkubeletåŒæ—¶æ”¯æŒä¸¤ç§æŠ€æœ¯çš„ä½¿ç”¨è¿˜è¦ä¿è¯ä¸€è‡´çš„å®¹å™¨åŠŸèƒ½è¡¨ç°ï¼Œå¯¹ä»£ç é€»è¾‘å’ŒåŠŸèƒ½å¯é æ€§éƒ½æœ‰å¾ˆå¤§çš„å½±å“ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œk8sæå‡ºäº†ä¸€ä¸ªç»Ÿä¸€æ¥å£CRIï¼Œkubeletç»Ÿä¸€é€šè¿‡è¿™ä¸ªæ¥å£æ¥è°ƒç”¨å®¹å™¨åŠŸèƒ½ã€‚ä½†æ˜¯dockerdå¹¶ä¸æ”¯æŒCRIï¼Œk8så°±è‡ªå·±å®ç°äº†é…å¥—çš„dockershimå°†CRIæ¥å£è°ƒç”¨è½¬æ¢æˆdockerdæ¥å£è°ƒç”¨æ¥æ”¯æŒCRIã€‚å› æ­¤ï¼Œdockershimå¹¶ä¸æ˜¯dockeræŠ€æœ¯çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ˜¯k8sç³»ç»Ÿçš„ä¸€éƒ¨åˆ† ä½¿ç”¨ CRI-Dockerd é¡¹ç›® é¡¹ç›®åœ°å€ï¼šhttps://github.com/Mirantis/cri-dockerd 1.ä¸‹è½½cri-dockerdäºŒè¿›åˆ¶åŒ…æˆ–è€…æºç è‡ªå·±ç¼–è¯‘ # ä¸‹è½½æ–‡ä»¶ wget https://github.com/Mirantis/cri-dockerd/releases/download/v0.2.0/cri-dockerd-v0.2.0-linux-amd64.tar.gz # è§£å‹æ–‡ä»¶ tar -xvf cri-dockerd-v0.2.0-linux-amd64.tar.gz # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶åˆ°æŒ‡å®šç›®å½• cp cri-dockerd /usr/bin/ 2.é…ç½®å¯åŠ¨æ–‡ä»¶ # é…ç½®å¯åŠ¨æ–‡ä»¶ cat &lt;&lt;&quot;EOF&quot; &gt; /usr/lib/systemd/system/cri-docker.service [Unit] Description=CRI Interface for Docker Application Container Engine Documentation=https://docs.mirantis.com After=network-online.target firewalld.service docker.service Wants=network-online.target Requires=cri-docker.socket [Service] Type=notify ExecStart=/usr/bin/cri-dockerd --container-runtime-endpoint=unix:///var/run/cri-docker.sock --network-plugin=cni --cni-bin-dir=/opt/cni/bin \\ --cni-conf-dir=/etc/cni/net.d --image-pull-progress-deadline=30s --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.7 \\ --docker-endpoint=unix:///var/run/docker.sock --cri-dockerd-root-directory=/var/lib/docker ExecReload=/bin/kill -s HUP $MAINPID TimeoutSec=0 RestartSec=2 Restart=always # Note that StartLimit* options were moved from &quot;Service&quot; to &quot;Unit&quot; in systemd 229. # Both the old, and new location are accepted by systemd 229 and up, so using the old location # to make them work for either version of systemd. StartLimitBurst=3 # Note that StartLimitInterval was renamed to StartLimitIntervalSec in systemd 230. # Both the old, and new name are accepted by systemd 230 and up, so using the old name to make # this option work for either version of systemd. StartLimitInterval=60s # Having non-zero Limit*s causes performance problems due to accounting overhead # in the kernel. We recommend using cgroups to do container-local accounting. LimitNOFILE=infinity LimitNPROC=infinity LimitCORE=infinity # Comment TasksMax if your systemd version does not support it. # Only systemd 226 and above support this option. TasksMax=infinity Delegate=yes KillMode=process [Install] WantedBy=multi-user.target EOF # ç”Ÿæˆsocket æ–‡ä»¶ cat &lt;&lt;&quot;EOF&quot; &gt; /usr/lib/systemd/system/cri-docker.socket [Unit] Description=CRI Docker Socket for the API PartOf=cri-docker.service [Socket] ListenStream=/var/run/cri-dockerd.sock SocketMode=0660 SocketUser=root SocketGroup=docker [Install] WantedBy=sockets.target EOF # å¯åŠ¨ cri-dockerd systemctl daemon-reload systemctl start cri-docker #è®¾ç½®å¼€æœºå¯åŠ¨ systemctl enable cri-docker # æŸ¥çœ‹å¯åŠ¨çŠ¶æ€ systemctl status cri-docker 3.ä¸‹è½½cri-toolséªŒè¯cri-docker æ˜¯å¦æ­£å¸¸ # ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ wget https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.24.0/crictl-v1.24.0-linux-amd64.tar.gz # è§£å‹ tar -xvf crictl-v1.24.0-linux-amd64.tar.gz # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶åˆ°æŒ‡å®šç›®å½• cp crictl /usr/bin/ # åˆ›å»ºé…ç½®æ–‡ä»¶ vim /etc/crictl.yaml runtime-endpoint: &quot;unix:///var/run/cri-docker.sock&quot; image-endpoint: &quot;unix:///var/run/cri-docker.sock&quot; timeout: 10 debug: false pull-image-on-create: true disable-pull-on-run: false # æµ‹è¯•èƒ½å¦è®¿é—®docker # æŸ¥çœ‹è¿è¡Œçš„å®¹å™¨ crictl ps # æŸ¥çœ‹æ‹‰å–çš„é•œåƒ crictl images # æ‹‰å–é•œåƒ crictl pull busybox [root@k8s-node-4 ~]# crictl pull busybox Image is up to date for busybox@sha256:5ecba83a746c7608ed511dc1533b87c737a0b0fb730301639a0179f9344b13448 è¿”å›ä¸€åˆ‡æ­£å¸¸cri-dockerdæ¥å…¥dockerå®Œæ•´ 15.éƒ¨ç½² containerd(k8s-1.24ç‰ˆæœ¬ä»¥ä¸Š) æœåŠ¡ç‰ˆæœ¬ æœåŠ¡åç§° ç‰ˆæœ¬å· å†…æ ¸ 5.14.3-1.el7.elrepo.x86_64 containerd v1.6.4ï¼ˆåŠ å…¥ï¼‰ ctr v1.6.4 k8s 1.24 1.å®‰è£…containerd åˆ›å»ºé…ç½®æ–‡ä»¶ mkdir /etc/modules-load.d/containerd.conf åˆ›å»ºå®Œé…ç½®æ–‡ä»¶æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ modprobe overlay &amp;&amp; modprobe br_netfilter ç«‹å³ç”Ÿæ•ˆ sysctl --system ä¸‹è½½ docker-ce æº wget http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo æˆ–è€… yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo å®‰è£… containerd æœåŠ¡å¹¶åŠ å…¥å¼€æœºå¯åŠ¨ yum install -y containerd.io systemctl enable containerd &amp;&amp; systemctl start containerd 2.é…ç½® containerd åˆ›å»ºè·¯å¾„ mkdir -p /etc/containerd è·å–é»˜è®¤é…ç½®æ–‡ä»¶ containerd config default | sudo tee /etc/containerd/config.toml ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œæ–°å¢ &quot;SystemdCgroup = true&quot;ï¼Œä½¿ç”¨ systemd ä½œä¸º cgroup é©±åŠ¨ç¨‹åº [root@master1 ~]# vi /etc/containerd/config.toml #ä¿®æ”¹ä»¥ä¸‹å†…å®¹ [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options] SystemdCgroup = true ## ä¿®æ”¹ä¸ºtrue æ›¿æ¢é»˜è®¤pauseé•œåƒåœ°å€ é»˜è®¤æƒ…å†µä¸‹k8s.gcr.ioæ— æ³•è®¿é—®ï¼Œæ‰€ä»¥ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒä»“åº“åœ°å€å³å¯ # æ‰€æœ‰èŠ‚ç‚¹æ›´æ¢é»˜è®¤é•œåƒåœ°å€ sed -i 's/k8s.gcr.io/registry.cn-beijing.aliyuncs.com\\/abcdocker/' /etc/containerd/config.toml é‡å¯ containerd systemctl restart containerd æŸ¥çœ‹ containerd è¿è¡ŒçŠ¶æ€(ä»¥ä¸‹çŠ¶æ€è§†ä¸ºæ­£å¸¸) [root@master1 ~]# systemctl status containerd â— containerd.service - containerd container runtime Loaded: loaded (/usr/lib/systemd/system/containerd.service; enabled; vendor preset: disabled) Active: active (running) since Sun 2022-03-06 08:09:00 CST; 1h 43min ago Docs: https://containerd.io Process: 931 ExecStartPre=/sbin/modprobe overlay (code=exited, status=0/SUCCESS) Main PID: 941 (containerd) Tasks: 11 Memory: 61.4M CGroup: /system.slice/containerd.service â””â”€941 /usr/bin/containerd 16.å®‰è£…kubeadmã€kubeletã€kubectl 1.é…ç½®æ–‡ä»¶ä¿®æ”¹ cat &lt;&lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo [kubernetes] name=Kubernetes baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64 enabled=1 gpgcheck=0 repo_gpgcheck=0 gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg EOF 2.å®‰è£…å¯ç”¨ sudo yum install -y kubelet-1.24.1 kubeadm-1.24.1 kubectl-1.24.1 --disableexcludes=kubernetes sudo systemctl enable kubelet &amp;&amp; systemctl start kubelet 3.ä¿®æ”¹kubeletçš„é…ç½®æ–‡ä»¶ å…ˆæŸ¥çœ‹é…ç½®æ–‡ä»¶ä½ç½® systemctl status kubelet vi /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹(ä½¿ç”¨å’Œdockerç›¸åŒçš„cgroup-driver)ã€‚ Environment=&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --cgroup-driver=systemd&quot; 4.é‡å¯kubelet systemctl daemon-reload &amp;&amp; systemctl restart kubelet 17.è·å–K8Sé•œåƒï¼ˆå¯å¿½ç•¥ï¼‰ 1.è·å–é•œåƒåˆ—è¡¨ ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒä»“åº“ä¸‹è½½ï¼ˆå›½å†…ç¯å¢ƒè¯¥å‘½ä»¤å¯ä¸æ‰§è¡Œï¼Œä¸‹æ­¥éª¤kubeadm init --image-repository registry.cn-hangzhou.aliyuncs.com/google_containerså·²ç»é»˜è®¤ä¸ºå›½å†…ç¯å¢ƒï¼‰ ç”±äºå®˜æ–¹é•œåƒåœ°å€è¢«å¢™ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é¦–å…ˆè·å–æ‰€éœ€é•œåƒä»¥åŠå®ƒä»¬çš„ç‰ˆæœ¬ã€‚ç„¶åä»å›½å†…é•œåƒç«™è·å–ã€‚ kubeadm config images list è·å–é•œåƒåˆ—è¡¨åå¯ä»¥é€šè¿‡ä¸‹é¢çš„è„šæœ¬ä»é˜¿é‡Œäº‘è·å–ï¼š vi /usr/local/k8s/k8s-images.sh ä¸‹é¢çš„é•œåƒåº”è¯¥å»é™¤&quot;k8s.gcr.io/&quot;çš„å‰ç¼€ï¼Œç‰ˆæœ¬æ¢æˆä¸Šé¢è·å–åˆ°çš„ç‰ˆæœ¬ images=( kube-apiserver:v1.24.1 kube-controller-manager:v1.24.1 kube-scheduler:v1.24.1 kube-proxy:v1.24.1 pause:3.7 etcd:3.5.3-0 coredns:v1.8.6 ) for imageName in ${images[@]} ; do docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName k8s.gcr.io/$imageName docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName done 2.èµ‹æƒæ‰§è¡Œ chmod +x k8s-images.sh &amp;&amp; ./k8s-images.sh ä»¥ä¸Šæ“ä½œåœ¨æ‰€æœ‰æœºå™¨æ‰§è¡Œ 18.åˆå§‹åŒ–ç¯å¢ƒï¼ˆmasteræ“ä½œï¼‰ 1.å®‰è£…é•œåƒ é‡‡ç”¨æ¨¡æ¿é…ç½®æ–‡ä»¶åŠ è½½ kubeadm config print init-defaults &gt; kubeadm-config.yaml [root@master1 ~]# cat kubeadm-config.yaml apiVersion: kubeadm.k8s.io/v1beta2 bootstrapTokens: - groups: - system:bootstrappers:kubeadm:default-node-token token: abcdef.0123456789abcdef ttl: 24h0m0s usages: - signing - authentication kind: InitConfiguration localAPIEndpoint: advertiseAddress: 192.168.40.131 # æœ¬æœºIP bindPort: 6443 nodeRegistration: criSocket: unix:///var/run/cri-docker.sock # æ­¤å¤„åƒä¸‡ä¸è¦å¿˜è®°ä¿®æ”¹ï¼Œå¦‚æœä¸ä¿®æ”¹ç­‰äºæ²¡æœ‰æ›¿æ¢ã€‚(æ­¤å¤„å·²ç»æ›´æ”¹å®Œäº†) #criSocket: unix:///run/containerd/containerd.sock # æ­¤å¤„åƒä¸‡ä¸è¦å¿˜è®°ä¿®æ”¹ï¼Œå¦‚æœä¸ä¿®æ”¹ç­‰äºæ²¡æœ‰æ›¿æ¢ã€‚(æ­¤å¤„å·²ç»æ›´æ”¹å®Œäº†) name: master1 # æœ¬ä¸»æœºå taints: - effect: NoSchedule key: node-role.kubernetes.io/master --- apiServer: timeoutForControlPlane: 4m0s apiVersion: kubeadm.k8s.io/v1beta2 certificatesDir: /etc/kubernetes/pki clusterName: kubernetes controlPlaneEndpoint: &quot;192.168.40.151:16443&quot; # è™šæ‹ŸIPå’Œhaproxyç«¯å£ controllerManager: {} dns: type: CoreDNS etcd: local: dataDir: /var/lib/etcd imageRepository: registry.aliyuncs.com/google_containers # é•œåƒä»“åº“æºè¦æ ¹æ®è‡ªå·±å®é™…æƒ…å†µä¿®æ”¹ kind: ClusterConfiguration kubernetesVersion: v1.24.1 # k8sç‰ˆæœ¬ networking: dnsDomain: cluster.local podSubnet: &quot;10.244.0.0/16&quot; #è®¾ç½®ç½‘æ®µï¼Œå’Œä¸‹é¢ç½‘ç»œæ’ä»¶å¯¹åº” serviceSubnet: 10.96.0.0/12 scheduler: {} --- apiVersion: kubeproxy.config.k8s.io/v1alpha1 kind: KubeProxyConfiguration featureGates: SupportIPVSProxyMode: true mode: ipvs 2.æŸ¥çœ‹kubeadmç‰ˆæœ¬ï¼Œä¿®æ”¹å‘½ä»¤å‚æ•° kubeadm version è¿™ä¸ªå°±å¾ˆç®€å•äº†ï¼Œåªéœ€è¦ç®€å•çš„ä¸€ä¸ªå‘½ä»¤ï¼š #ç›´æ¥ä½¿ç”¨å·²ç»ä¸‹è½½å¥½çš„é•œåƒ kubeadm init --kubernetes-version=v1.24.1 --apiserver-advertise-address=192.168.40.131 --pod-network-cidr=10.244.0.0/16 --service-cidr=10.96.0.0/12 --ignore-preflight-errors=Swap --cri-socket unix:///var/run/cri-docker.sock | tee kubeadm-init.log #æˆ–è€…é‡‡ç”¨aliyuncsé•œåƒä¸‹è½½ kubeadm init --kubernetes-version=v1.24.1 --apiserver-advertise-address=192.168.40.131 --image-repository registry.aliyuncs.com/google_containers --service-cidr=10.1.0.0/16 --pod-network-cidr=10.244.0.0/16 --cri-socket unix:///var/run/cri-docker.sock| tee kubeadm-init.log #ä½¿ç”¨ä¸Šé¢ç³»ç»Ÿç”Ÿæˆé…ç½®æ–‡ä»¶åŠ è½½ kubeadm init --config kubeadm-config.yaml 3.åˆå§‹åŒ–å‘½ä»¤è¯´æ˜ï¼š æŒ‡æ˜ç”¨ Master çš„å“ªä¸ª interface ä¸ Cluster çš„å…¶ä»–èŠ‚ç‚¹é€šä¿¡ã€‚å¦‚æœ Master æœ‰å¤šä¸ª interfaceï¼Œå»ºè®®æ˜ç¡®æŒ‡å®šï¼Œå¦‚æœä¸æŒ‡å®šï¼Œkubeadm ä¼šè‡ªåŠ¨é€‰æ‹©æœ‰é»˜è®¤ç½‘å…³çš„ interfaceã€‚ --apiserver-advertise-address æŒ‡å®š Pod ç½‘ç»œçš„èŒƒå›´ã€‚Kubernetes æ”¯æŒå¤šç§ç½‘ç»œæ–¹æ¡ˆï¼Œè€Œä¸”ä¸åŒç½‘ç»œæ–¹æ¡ˆå¯¹ --pod-network-cidr æœ‰è‡ªå·±çš„è¦æ±‚ï¼Œè¿™é‡Œè®¾ç½®ä¸º 10.244.0.0/16 æ˜¯å› ä¸ºæˆ‘ä»¬å°†ä½¿ç”¨ flannel ç½‘ç»œæ–¹æ¡ˆï¼Œå¿…é¡»è®¾ç½®æˆè¿™ä¸ª CIDRã€‚ --pod-network-cidr Kubenetesé»˜è®¤Registriesåœ°å€æ˜¯ k8s.gcr.ioï¼Œåœ¨å›½å†…å¹¶ä¸èƒ½è®¿é—® gcr.ioï¼Œåœ¨1.19.3ç‰ˆæœ¬ä¸­æˆ‘ä»¬å¯ä»¥å¢åŠ â€“image-repositoryå‚æ•°ï¼Œé»˜è®¤å€¼æ˜¯ k8s.gcr.ioï¼Œå°†å…¶æŒ‡å®šä¸ºé˜¿é‡Œäº‘é•œåƒåœ°å€ï¼šregistry.aliyuncs.com/google_containersã€‚ --image-repository å…³é—­ç‰ˆæœ¬æ¢æµ‹ï¼Œå› ä¸ºå®ƒçš„é»˜è®¤å€¼æ˜¯stable-1ï¼Œä¼šå¯¼è‡´ä»https://dl.k8s.io/release/stable-1.txtä¸‹è½½æœ€æ–°çš„ç‰ˆæœ¬å·ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶æŒ‡å®šä¸ºå›ºå®šç‰ˆæœ¬ï¼ˆæœ€æ–°ç‰ˆï¼šv1.24.1ï¼‰æ¥è·³è¿‡ç½‘ç»œè¯·æ±‚ã€‚ --kubernetes-version=v1.24.1 æŒ‡å®šå¯åŠ¨æ—¶ä½¿ç”¨cri-dockerè°ƒç”¨docker --cri-socket unix:///var/run/cri-docker.sock 4.é”™è¯¯å¯åŠ¨é‡ç½® # é‡ç½® å¦‚æœæœ‰éœ€è¦ kubeadm reset --cri-socket unix:///var/run/cri-docker.sock 5.åˆå§‹åŒ–æˆåŠŸåï¼Œä¸ºé¡ºåˆ©ä½¿ç”¨kubectlï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config 6.æ·»åŠ èŠ‚ç‚¹ kubeadm join 192.168.40.131:6443 --token eyr8v6.j84sxak8aptse8j9 --discovery-token-ca-cert-hash sha256:c082f3c546bdbac02d0d0a3b696de4004b0d449e37838fa38d4752b39682676b --cri-socket unix:///var/run/cri-docker.sock 7.æ‰§è¡Œkubectl get nodesï¼ŒæŸ¥çœ‹masterèŠ‚ç‚¹çŠ¶æ€ï¼š kubectl get node 8.é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹kubeletçŠ¶æ€ï¼š journalctl -xef -u kubelet -n 20 æç¤ºæœªå®‰è£…cni ç½‘ç»œæ’ä»¶ã€‚ 19.1å®‰è£…flannelç½‘ç»œæ’ä»¶(CNI) masteræ‰§è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…flannelå³å¯ï¼š kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml kube-flannel.yamlæ–‡ä»¶ä¸­çš„net-conf.json-&gt;Networkåœ°å€é»˜è®¤ä¸ºå‘½ä»¤ä¸­â€“pod-network-cidr=å€¼ç›¸åŒ è¾“å…¥å‘½ä»¤kubectl get pods -n kube-system,ç­‰å¾…æ‰€æœ‰æ’ä»¶ä¸ºrunningçŠ¶æ€ã€‚ å¾…æ‰€æœ‰pod statusä¸ºRunningçš„æ—¶å€™ï¼Œå†æ¬¡æ‰§è¡Œkubectl get nodesï¼š [root@k8s-master ~]# kubectl get node NAME STATUS ROLES AGE VERSION k8s-master Ready master 16m v1.19.3 å¦‚ä¸Šæ‰€ç¤ºï¼ŒmasterçŠ¶æ€å˜ä¸ºï¼Œè¡¨æ˜MasterèŠ‚ç‚¹éƒ¨ç½²æˆåŠŸï¼ 19.2å®‰è£…calicoç½‘ç»œ(åŠŸèƒ½æ›´å®Œå–„) 1.åœ¨masterä¸Šä¸‹è½½é…ç½®calicoç½‘ç»œçš„yamlã€‚ kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml 2.æå‰ä¸‹è½½æ‰€éœ€è¦çš„é•œåƒã€‚ # æŸ¥çœ‹æ­¤æ–‡ä»¶ç”¨å“ªäº›é•œåƒï¼š [root@k8s-master ~]# grep image calico.yaml image: docker.io/calico/cni:v3.23.1 image: docker.io/calico/node:v3.23.1 image: docker.io/calico/kube-controllers:v3.23.1 3.å®‰è£…calicoç½‘ç»œã€‚ åœ¨masterä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š kubectl apply -f calico.yaml 5.éªŒè¯ç»“æœã€‚ å†æ¬¡åœ¨masterä¸Šè¿è¡Œå‘½ä»¤ kubectl get nodesæŸ¥çœ‹è¿è¡Œç»“æœï¼š [root@k8s-master ~]# kubectl get nodes NAME STATUS ROLES AGE VERSION master01 Ready control-plane,master 21h v1.23.4 worker01 Ready &lt;none&gt; 16h v1.23.4 worker02 Ready &lt;none&gt; 16h v1.23.4 20.éƒ¨ç½²k8s-node1ã€k8s-node2é›†ç¾¤ 1ã€åœ¨k8s-node1ã€k8s-node2ç­‰ä¸¤å°è™šæ‹Ÿæœºä¸­é‡å¤æ‰§è¡Œä¸Šé¢çš„æ­¥éª¤ï¼Œå®‰è£…å¥½dockerã€kubeletã€kubectlã€kubeadmã€‚ 1.nodeèŠ‚ç‚¹åŠ å…¥é›†ç¾¤ åœ¨ä¸Šé¢ç¬¬åˆå§‹åŒ–masterèŠ‚ç‚¹æˆåŠŸåï¼Œè¾“å‡ºäº†ä¸‹é¢çš„kubeadm joinå‘½ä»¤ï¼š kubeadm join 192.168.40.131:6443 --token zj0u08.ge77y7uv76flqgdk --discovery-token-ca-cert-hash sha256:7cd23cec6afb192b2d34c5c719b378082a6315a9d91a22d91b83066c870d4db5 --cri-socket unix:///var/run/cri-docker.sock è¯¥å‘½ä»¤å°±æ˜¯nodeåŠ å…¥é›†ç¾¤çš„å‘½ä»¤ï¼Œåˆ†åˆ«åœ¨k8s-node1ã€k8s-node2ä¸Šæ‰§è¡Œè¯¥å‘½ä»¤åŠ å…¥é›†ç¾¤ã€‚ å¦‚æœå¿˜è®°è¯¥å‘½ä»¤ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤é‡æ–°ç”Ÿæˆï¼š kubeadm token create --print-join-command 2.åœ¨masterèŠ‚ç‚¹æ‰§è¡Œä¸‹é¢å‘½ä»¤æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼š kubectl get nodes [root@k8s-master ~]# kubectl get node NAME STATUS ROLES AGE VERSION k8s-master Ready master 24m v1.19.3 k8s-node1 Ready &lt;none&gt; 5m50s v1.19.3 k8s-node2 Ready &lt;none&gt; 5m21s v1.19.3 å¦‚ä¸Šæ‰€ç¤ºï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½ä¸ºreadyï¼Œé›†ç¾¤æ­å»ºæˆåŠŸã€‚ 21.å®‰è£…ingress-nginx vi ingress-nginx-deploy.yaml apiVersion: v1 kind: Namespace metadata: labels: app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx name: ingress-nginx --- apiVersion: v1 automountServiceAccountToken: true kind: ServiceAccount metadata: labels: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx app.kubernetes.io/version: 1.2.0 name: ingress-nginx namespace: ingress-nginx --- apiVersion: v1 kind: ServiceAccount metadata: labels: app.kubernetes.io/component: admission-webhook app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx app.kubernetes.io/version: 1.2.0 name: ingress-nginx-admission namespace: ingress-nginx --- apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: labels: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx app.kubernetes.io/version: 1.2.0 name: ingress-nginx namespace: ingress-nginx rules: - apiGroups: - &quot;&quot; resources: - namespaces verbs: - get - apiGroups: - &quot;&quot; resources: - configmaps - pods - secrets - endpoints verbs: - get - list - watch - apiGroups: - &quot;&quot; resources: - services verbs: - get - list - watch - apiGroups: - networking.k8s.io resources: - ingresses verbs: - get - list - watch - apiGroups: - networking.k8s.io resources: - ingresses/status verbs: - update - apiGroups: - networking.k8s.io resources: - ingressclasses verbs: - get - list - watch - apiGroups: - &quot;&quot; resourceNames: - ingress-controller-leader resources: - configmaps verbs: - get - update - apiGroups: - &quot;&quot; resources: - configmaps verbs: - create - apiGroups: - &quot;&quot; resources: - events verbs: - create - patch --- apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: labels: app.kubernetes.io/component: admission-webhook app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx app.kubernetes.io/version: 1.2.0 name: ingress-nginx-admission namespace: ingress-nginx rules: - apiGroups: - &quot;&quot; resources: - secrets verbs: - get - create --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: labels: app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx app.kubernetes.io/version: 1.2.0 name: ingress-nginx rules: - apiGroups: - &quot;&quot; resources: - configmaps - endpoints - nodes - pods - secrets - namespaces verbs: - list - watch - apiGroups: - &quot;&quot; resources: - nodes verbs: - get - apiGroups: - &quot;&quot; resources: - services verbs: - get - list - watch - apiGroups: - networking.k8s.io resources: - ingresses verbs: - get - list - watch - apiGroups: - &quot;&quot; resources: - events verbs: - create - patch - apiGroups: - networking.k8s.io resources: - ingresses/status verbs: - update - apiGroups: - networking.k8s.io resources: - ingressclasses verbs: - get - list - watch --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: labels: app.kubernetes.io/component: admission-webhook app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx app.kubernetes.io/version: 1.2.0 name: ingress-nginx-admission rules: - apiGroups: - admissionregistration.k8s.io resources: - validatingwebhookconfigurations verbs: - get - update --- apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: labels: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx app.kubernetes.io/version: 1.2.0 name: ingress-nginx namespace: ingress-nginx roleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: ingress-nginx subjects: - kind: ServiceAccount name: ingress-nginx namespace: ingress-nginx --- apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: labels: app.kubernetes.io/component: admission-webhook app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx app.kubernetes.io/version: 1.2.0 name: ingress-nginx-admission namespace: ingress-nginx roleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: ingress-nginx-admission subjects: - kind: ServiceAccount name: ingress-nginx-admission namespace: ingress-nginx --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: labels: app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx app.kubernetes.io/version: 1.2.0 name: ingress-nginx roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: ingress-nginx subjects: - kind: ServiceAccount name: ingress-nginx namespace: ingress-nginx --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: labels: app.kubernetes.io/component: admission-webhook app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx app.kubernetes.io/version: 1.2.0 name: ingress-nginx-admission roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: ingress-nginx-admission subjects: - kind: ServiceAccount name: ingress-nginx-admission namespace: ingress-nginx --- apiVersion: v1 data: allow-snippet-annotations: &quot;true&quot; kind: ConfigMap metadata: labels: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx app.kubernetes.io/version: 1.2.0 name: ingress-nginx-controller namespace: ingress-nginx --- apiVersion: v1 kind: Service metadata: labels: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx app.kubernetes.io/version: 1.2.0 name: ingress-nginx-controller namespace: ingress-nginx spec: ports: - appProtocol: http name: http port: 80 protocol: TCP targetPort: http - appProtocol: https name: https port: 443 protocol: TCP targetPort: https selector: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx type: NodePort --- apiVersion: v1 kind: Service metadata: labels: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx app.kubernetes.io/version: 1.2.0 name: ingress-nginx-controller-admission namespace: ingress-nginx spec: ports: - appProtocol: https name: https-webhook port: 443 targetPort: webhook selector: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx type: ClusterIP --- apiVersion: apps/v1 kind: Deployment metadata: labels: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx app.kubernetes.io/version: 1.2.0 name: ingress-nginx-controller namespace: ingress-nginx spec: minReadySeconds: 0 revisionHistoryLimit: 10 selector: matchLabels: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx template: metadata: labels: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx spec: containers: - args: - /nginx-ingress-controller - --election-id=ingress-controller-leader - --controller-class=k8s.io/ingress-nginx - --ingress-class=nginx - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller - --validating-webhook=:8443 - --validating-webhook-certificate=/usr/local/certificates/cert - --validating-webhook-key=/usr/local/certificates/key env: - name: POD_NAME valueFrom: fieldRef: fieldPath: metadata.name - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace - name: LD_PRELOAD value: /usr/local/lib/libmimalloc.so image: registry.aliyuncs.com/google_containers/nginx-ingress-controller:v1.2.0 imagePullPolicy: IfNotPresent lifecycle: preStop: exec: command: - /wait-shutdown livenessProbe: failureThreshold: 5 httpGet: path: /healthz port: 10254 scheme: HTTP initialDelaySeconds: 10 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 1 name: controller ports: - containerPort: 80 name: http protocol: TCP - containerPort: 443 name: https protocol: TCP - containerPort: 8443 name: webhook protocol: TCP readinessProbe: failureThreshold: 3 httpGet: path: /healthz port: 10254 scheme: HTTP initialDelaySeconds: 10 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 1 resources: requests: cpu: 100m memory: 90Mi securityContext: allowPrivilegeEscalation: true capabilities: add: - NET_BIND_SERVICE drop: - ALL runAsUser: 101 volumeMounts: - mountPath: /usr/local/certificates/ name: webhook-cert readOnly: true dnsPolicy: ClusterFirst nodeSelector: kubernetes.io/os: linux serviceAccountName: ingress-nginx terminationGracePeriodSeconds: 300 volumes: - name: webhook-cert secret: secretName: ingress-nginx-admission --- apiVersion: batch/v1 kind: Job metadata: labels: app.kubernetes.io/component: admission-webhook app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx app.kubernetes.io/version: 1.2.0 name: ingress-nginx-admission-create namespace: ingress-nginx spec: template: metadata: labels: app.kubernetes.io/component: admission-webhook app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx app.kubernetes.io/version: 1.2.0 name: ingress-nginx-admission-create spec: containers: - args: - create - --host=ingress-nginx-controller-admission,ingress-nginx-controller-admission.$(POD_NAMESPACE).svc - --namespace=$(POD_NAMESPACE) - --secret-name=ingress-nginx-admission env: - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace image: registry.aliyuncs.com/google_containers/kube-webhook-certgen:v1.1.1 imagePullPolicy: IfNotPresent name: create securityContext: allowPrivilegeEscalation: false nodeSelector: kubernetes.io/os: linux restartPolicy: OnFailure securityContext: fsGroup: 2000 runAsNonRoot: true runAsUser: 2000 serviceAccountName: ingress-nginx-admission --- apiVersion: batch/v1 kind: Job metadata: labels: app.kubernetes.io/component: admission-webhook app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx app.kubernetes.io/version: 1.2.0 name: ingress-nginx-admission-patch namespace: ingress-nginx spec: template: metadata: labels: app.kubernetes.io/component: admission-webhook app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx app.kubernetes.io/version: 1.2.0 name: ingress-nginx-admission-patch spec: containers: - args: - patch - --webhook-name=ingress-nginx-admission - --namespace=$(POD_NAMESPACE) - --patch-mutating=false - --secret-name=ingress-nginx-admission - --patch-failure-policy=Fail env: - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace image: registry.aliyuncs.com/google_containers/kube-webhook-certgen:v1.1.1 imagePullPolicy: IfNotPresent name: patch securityContext: allowPrivilegeEscalation: false nodeSelector: kubernetes.io/os: linux restartPolicy: OnFailure securityContext: fsGroup: 2000 runAsNonRoot: true runAsUser: 2000 serviceAccountName: ingress-nginx-admission --- apiVersion: networking.k8s.io/v1 kind: IngressClass metadata: labels: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx app.kubernetes.io/version: 1.2.0 name: nginx spec: controller: k8s.io/ingress-nginx --- apiVersion: admissionregistration.k8s.io/v1 kind: ValidatingWebhookConfiguration metadata: labels: app.kubernetes.io/component: admission-webhook app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx app.kubernetes.io/version: 1.2.0 name: ingress-nginx-admission webhooks: - admissionReviewVersions: - v1 clientConfig: service: name: ingress-nginx-controller-admission namespace: ingress-nginx path: /networking/v1/ingresses failurePolicy: Fail matchPolicy: Equivalent name: validate.nginx.ingress.kubernetes.io rules: - apiGroups: - networking.k8s.io apiVersions: - v1 operations: - CREATE - UPDATE resources: - ingresses sideEffects: None kubectl create -f ingress-nginx-deploy.yaml å¸è½½é›†ç¾¤å‘½ä»¤ #å»ºè®®æ‰€æœ‰æœåŠ¡å™¨éƒ½æ‰§è¡Œ #!/bin/bash kubeadm reset -f modprobe -r ipip lsmod rm -rf ~/.kube/ rm -rf /etc/kubernetes/ rm -rf /etc/systemd/system/kubelet.service.d rm -rf /etc/systemd/system/kubelet.service rm -rf /usr/bin/kube* rm -rf /etc/cni rm -rf /opt/cni rm -rf /var/lib/etcd rm -rf /var/etcd yum -y remove kubeadm* kubectl* kubelet* docker* reboot ","link":"https://tianxiawuhao.github.io/oqAZb-4wU/"},{"title":"centos7å®‰è£…Dockerè¯¦ç»†æ­¥éª¤","content":"ä¸€ã€å®‰è£…å‰å¿…è¯» åœ¨å®‰è£… Docker ä¹‹å‰ï¼Œå…ˆè¯´ä¸€ä¸‹é…ç½®ï¼Œæˆ‘è¿™é‡Œæ˜¯Centos7 Linux å†…æ ¸ï¼šå®˜æ–¹å»ºè®® 3.10 ä»¥ä¸Šï¼Œ3.8ä»¥ä¸Šè²Œä¼¼ä¹Ÿå¯ã€‚ æ³¨æ„ï¼šæœ¬æ–‡çš„å‘½ä»¤ä½¿ç”¨çš„æ˜¯ root ç”¨æˆ·ç™»å½•æ‰§è¡Œï¼Œä¸æ˜¯ root çš„è¯æ‰€æœ‰å‘½ä»¤å‰é¢è¦åŠ  sudo 1.æŸ¥çœ‹å½“å‰çš„å†…æ ¸ç‰ˆæœ¬ uname -r 2.ä½¿ç”¨ root æƒé™æ›´æ–° yum åŒ…ï¼ˆç”Ÿäº§ç¯å¢ƒä¸­æ­¤æ­¥æ“ä½œéœ€æ…é‡ï¼Œçœ‹è‡ªå·±æƒ…å†µï¼Œå­¦ä¹ çš„è¯éšä¾¿æï¼‰ yum -y update è¿™ä¸ªå‘½ä»¤ä¸æ˜¯å¿…é¡»æ‰§è¡Œçš„ï¼Œçœ‹ä¸ªäººæƒ…å†µï¼Œåé¢å‡ºç°ä¸å…¼å®¹çš„æƒ…å†µçš„è¯å°±å¿…é¡»updateäº† æ³¨æ„ yum -y updateï¼šå‡çº§æ‰€æœ‰åŒ…åŒæ—¶ä¹Ÿå‡çº§è½¯ä»¶å’Œç³»ç»Ÿå†…æ ¸ï¼› yum -y upgradeï¼šåªå‡çº§æ‰€æœ‰åŒ…ï¼Œä¸å‡çº§è½¯ä»¶å’Œç³»ç»Ÿå†…æ ¸ 3.å¸è½½æ—§ç‰ˆæœ¬ï¼ˆå¦‚æœä¹‹å‰å®‰è£…è¿‡çš„è¯ï¼‰ yum remove docker docker-common docker-selinux docker-engine äºŒã€å®‰è£…Dockerçš„è¯¦ç»†æ­¥éª¤ 1.å®‰è£…éœ€è¦çš„è½¯ä»¶åŒ…ï¼Œ yum-util æä¾›yum-config-manageråŠŸèƒ½ï¼Œå¦ä¸¤ä¸ªæ˜¯devicemapperé©±åŠ¨ä¾èµ– yum install -y yum-utils device-mapper-persistent-data lvm2 2.è®¾ç½® yum æº è®¾ç½®ä¸€ä¸ªyumæºï¼Œä¸‹é¢ä¸¤ä¸ªéƒ½å¯ç”¨ yum-config-manager --add-repo http://download.docker.com/linux/centos/docker-ce.repoï¼ˆä¸­å¤®ä»“åº“ï¼‰ yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repoï¼ˆé˜¿é‡Œä»“åº“ï¼‰ 3.é€‰æ‹©dockerç‰ˆæœ¬å¹¶å®‰è£… ï¼ˆ1ï¼‰æŸ¥çœ‹å¯ç”¨ç‰ˆæœ¬æœ‰å“ªäº› yum list docker-ce --showduplicates | sort -r ï¼ˆ2ï¼‰é€‰æ‹©ä¸€ä¸ªç‰ˆæœ¬å¹¶å®‰è£…ï¼šyum install docker-ce-ç‰ˆæœ¬å· yum -y install docker-ce-18.03.1.ce 4.å¯åŠ¨ Docker å¹¶è®¾ç½®å¼€æœºè‡ªå¯ systemctl start docker systemctl enable docker ","link":"https://tianxiawuhao.github.io/4kG3rvwit/"},{"title":"HTTP3","content":"HTTP3åè®®å‘å¸ƒ è‡ª2017å¹´èµ·HTTP3åè®®å·²å‘å¸ƒäº†29ä¸ªDraftï¼Œæ¨å‡ºåœ¨å³ï¼ŒChromeã€Nginxç­‰è½¯ä»¶éƒ½åœ¨è·Ÿè¿›å®ç°æœ€æ–°çš„è‰æ¡ˆã€‚æœ¬æ–‡å°†ä»‹ç»HTTP3åè®®è§„èŒƒã€åº”ç”¨åœºæ™¯åŠå®ç°åŸç†ã€‚ 2015å¹´HTTP2åè®®æ­£å¼æ¨å‡ºåï¼Œå·²ç»æœ‰æ¥è¿‘ä¸€åŠçš„äº’è”ç½‘ç«™ç‚¹åœ¨ä½¿ç”¨å®ƒï¼š HTTP2åè®®è™½ç„¶å¤§å¹…æå‡äº†HTTP/1.1çš„æ€§èƒ½ï¼Œç„¶è€Œï¼ŒåŸºäºTCPå®ç°çš„HTTP2é—ç•™ä¸‹3ä¸ªé—®é¢˜ï¼š æœ‰åºå­—èŠ‚æµå¼•å‡ºçš„é˜Ÿå¤´é˜»å¡ï¼ˆHead-of-line blockingï¼‰ï¼Œä½¿å¾—HTTP2çš„å¤šè·¯å¤ç”¨èƒ½åŠ›å¤§æ‰“æŠ˜æ‰£ï¼› TCPä¸TLSå åŠ äº†æ¡æ‰‹æ—¶å»¶ï¼Œå»ºé“¾æ—¶é•¿è¿˜æœ‰1å€çš„ä¸‹é™ç©ºé—´ï¼› åŸºäºTCPå››å…ƒç»„ç¡®å®šä¸€ä¸ªè¿æ¥ï¼Œè¿™ç§è¯ç”Ÿäºæœ‰çº¿ç½‘ç»œçš„è®¾è®¡ï¼Œå¹¶ä¸é€‚åˆç§»åŠ¨çŠ¶æ€ä¸‹çš„æ— çº¿ç½‘ç»œï¼Œè¿™æ„å‘³ç€IPåœ°å€çš„é¢‘ç¹å˜åŠ¨ä¼šå¯¼è‡´TCPè¿æ¥ã€TLSä¼šè¯åå¤æ¡æ‰‹ï¼Œæˆæœ¬é«˜æ˜‚ã€‚ HTTP3åè®®è§£å†³äº†è¿™äº›é—®é¢˜ï¼š HTTP3åŸºäºUDPåè®®é‡æ–°å®šä¹‰äº†è¿æ¥ï¼Œåœ¨QUICå±‚å®ç°äº†æ— åºã€å¹¶å‘å­—èŠ‚æµçš„ä¼ è¾“ï¼Œè§£å†³äº†é˜Ÿå¤´é˜»å¡é—®é¢˜ï¼ˆåŒ…æ‹¬åŸºäºQPACKè§£å†³äº†åŠ¨æ€è¡¨çš„é˜Ÿå¤´é˜»å¡ï¼‰ï¼› HTTP3é‡æ–°å®šä¹‰äº†TLSåè®®åŠ å¯†QUICå¤´éƒ¨çš„æ–¹å¼ï¼Œæ—¢æé«˜äº†ç½‘ç»œæ”»å‡»æˆæœ¬ï¼Œåˆé™ä½äº†å»ºç«‹è¿æ¥çš„é€Ÿåº¦ï¼ˆä»…éœ€1ä¸ªRTTå°±å¯ä»¥åŒæ—¶å®Œæˆå»ºé“¾ä¸å¯†é’¥åå•†ï¼‰ï¼› HTTP3 å°†Packetã€QUIC Frameã€HTTP3 Frameåˆ†ç¦»ï¼Œå®ç°äº†è¿æ¥è¿ç§»åŠŸèƒ½ï¼Œé™ä½äº†5Gç¯å¢ƒä¸‹é«˜é€Ÿç§»åŠ¨è®¾å¤‡çš„è¿æ¥ç»´æŠ¤æˆæœ¬ã€‚ æœ¬æ–‡å°†ä¼šä»HTTP3åè®®çš„æ¦‚å¿µè®²èµ·ï¼Œä»è¿æ¥è¿ç§»çš„å®ç°ä¸Šå­¦ä¹ HTTP3çš„æŠ¥æ–‡æ ¼å¼ï¼Œå†å›´ç»•ç€é˜Ÿå¤´é˜»å¡é—®é¢˜æ¥åˆ†æå¤šè·¯å¤ç”¨ä¸QPACKåŠ¨æ€è¡¨çš„å®ç°ã€‚è™½ç„¶æ­£å¼çš„RFCè§„èŒƒè¿˜æœªæ¨å‡ºï¼Œä½†æœ€è¿‘çš„è‰æ¡ˆChangeåªæœ‰å¾®å°çš„å˜åŒ–ï¼Œæ‰€ä»¥ç°åœ¨å­¦ä¹ HTTP3æ­£å½“å…¶æ—¶ï¼Œè¿™å°†æ˜¯ä¸‹ä¸€ä»£äº’è”ç½‘æœ€é‡è¦çš„åŸºç¡€è®¾æ–½ã€‚ HTTP3åè®®åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ å°±åƒHTTP2åè®®ä¸€æ ·ï¼ŒHTTP3å¹¶æ²¡æœ‰æ”¹å˜HTTP1çš„è¯­ä¹‰ã€‚é‚£ä»€ä¹ˆæ˜¯HTTPè¯­ä¹‰å‘¢ï¼Ÿåœ¨æˆ‘çœ‹æ¥ï¼Œå®ƒåŒ…æ‹¬ä»¥ä¸‹3ä¸ªç‚¹ï¼š è¯·æ±‚åªèƒ½ç”±å®¢æˆ·ç«¯å‘èµ·ï¼Œè€ŒæœåŠ¡å™¨é’ˆå¯¹æ¯ä¸ªè¯·æ±‚è¿”å›ä¸€ä¸ªå“åº”ï¼› è¯·æ±‚ä¸å“åº”éƒ½ç”±Headerã€Bodyï¼ˆå¯é€‰ï¼‰ç»„æˆï¼Œå…¶ä¸­è¯·æ±‚å¿…é¡»å«æœ‰URLå’Œæ–¹æ³•ï¼Œè€Œå“åº”å¿…é¡»å«æœ‰å“åº”ç ï¼› Headerä¸­å„Nameå¯¹åº”çš„å«ä¹‰ä¿æŒä¸å˜ã€‚ HTTP3åœ¨ä¿æŒHTTP1è¯­ä¹‰ä¸å˜çš„æƒ…å†µä¸‹ï¼Œæ›´æ”¹äº†ç¼–ç æ ¼å¼ï¼Œè¿™ç”±2ä¸ªåŸå› æ‰€è‡´ï¼šé¦–å…ˆï¼Œæ˜¯ä¸ºäº†å‡å°‘ç¼–ç é•¿åº¦ã€‚ä¸‹å›¾ä¸­HTTP1åè®®çš„ç¼–ç ä½¿ç”¨äº†ASCIIç ï¼Œç”¨ç©ºæ ¼ã€å†’å·ä»¥åŠ\\r\\nä½œä¸ºåˆ†éš”ç¬¦ï¼Œç¼–ç æ•ˆç‡å¾ˆä½ï¼š HTTP2ä¸HTTP3é‡‡ç”¨äºŒè¿›åˆ¶ã€é™æ€è¡¨ã€åŠ¨æ€è¡¨ä¸Huffmanç®—æ³•å¯¹HTTP Headerç¼–ç ï¼Œä¸åªæä¾›äº†é«˜å‹ç¼©ç‡ï¼Œè¿˜åŠ å¿«äº†å‘é€ç«¯ç¼–ç ã€æ¥æ”¶ç«¯è§£ç çš„é€Ÿåº¦ã€‚ å…¶æ¬¡ï¼Œç”±äºHTTP1åè®®ä¸æ”¯æŒå¤šè·¯å¤ç”¨ï¼Œè¿™æ ·é«˜å¹¶å‘åªèƒ½é€šè¿‡å¤šå¼€ä¸€äº›TCPè¿æ¥å®ç°ã€‚ç„¶è€Œï¼Œé€šè¿‡TCPå®ç°é«˜å¹¶å‘æœ‰3ä¸ªå¼Šç«¯ï¼š å®ç°æˆæœ¬é«˜ã€‚TCPæ˜¯ç”±æ“ä½œç³»ç»Ÿå†…æ ¸å®ç°çš„ï¼Œå¦‚æœé€šè¿‡å¤šçº¿ç¨‹å®ç°å¹¶å‘ï¼Œå¹¶å‘çº¿ç¨‹æ•°ä¸èƒ½å¤ªå¤šï¼Œå¦åˆ™çº¿ç¨‹é—´åˆ‡æ¢æˆæœ¬ä¼šä»¥æŒ‡æ•°çº§ä¸Šå‡ï¼›å¦‚æœé€šè¿‡å¼‚æ­¥ã€éé˜»å¡socketå®ç°å¹¶å‘ï¼Œå¼€å‘æ•ˆç‡åˆå¤ªä½ï¼› æ¯ä¸ªTCPè¿æ¥ä¸TLSä¼šè¯éƒ½å åŠ äº†2-3ä¸ªRTTçš„å»ºé“¾æˆæœ¬ï¼› TCPè¿æ¥æœ‰ä¸€ä¸ªé˜²æ­¢å‡ºç°æ‹¥å¡çš„æ…¢å¯åŠ¨æµç¨‹ï¼Œå®ƒä¼šå¯¹æ¯ä¸ªTCPè¿æ¥éƒ½äº§ç”Ÿå‡é€Ÿæ•ˆæœã€‚ å› æ­¤ï¼ŒHTTP2ä¸HTTP3éƒ½åœ¨åº”ç”¨å±‚å®ç°äº†å¤šè·¯å¤ç”¨åŠŸèƒ½ï¼š HTTP2åè®®åŸºäºTCPæœ‰åºå­—èŠ‚æµå®ç°ï¼Œå› æ­¤åº”ç”¨å±‚çš„å¤šè·¯å¤ç”¨å¹¶ä¸èƒ½åšåˆ°æ— åºåœ°å¹¶å‘ï¼Œåœ¨ä¸¢åŒ…åœºæ™¯ä¸‹ä¼šå‡ºç°é˜Ÿå¤´é˜»å¡é—®é¢˜ã€‚å¦‚ä¸‹é¢çš„åŠ¨æ€å›¾ç‰‡æ‰€ç¤ºï¼ŒæœåŠ¡å™¨è¿”å›çš„ç»¿è‰²å“åº”ç”±5ä¸ªTCPæŠ¥æ–‡ç»„æˆï¼Œè€Œé»„è‰²å“åº”ç”±4ä¸ªTCPæŠ¥æ–‡ç»„æˆï¼Œå½“ç¬¬2ä¸ªé»„è‰²æŠ¥æ–‡ä¸¢å¤±åï¼Œå³ä½¿å®¢æˆ·ç«¯æ¥æ”¶åˆ°å®Œæ•´çš„5ä¸ªç»¿è‰²æŠ¥æ–‡ï¼Œä½†TCPå±‚ä¸ä¼šå…è®¸åº”ç”¨è¿›ç¨‹çš„readå‡½æ•°è¯»å–åˆ°æœ€å5ä¸ªæŠ¥æ–‡ï¼Œå¹¶å‘æˆäº†ä¸€çº¸ç©ºè°ˆï¼š å½“ç½‘ç»œç¹å¿™æ—¶ï¼Œä¸¢åŒ…æ¦‚ç‡ä¼šå¾ˆé«˜ï¼Œå¤šè·¯å¤ç”¨å—åˆ°äº†å¾ˆå¤§é™åˆ¶ã€‚å› æ­¤ï¼ŒHTTP3é‡‡ç”¨UDPä½œä¸ºä¼ è¾“å±‚åè®®ï¼Œé‡æ–°å®ç°äº†æ— åºè¿æ¥ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šé€šè¿‡æœ‰åºçš„QUIC Streamæä¾›äº†å¤šè·¯å¤ç”¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æœ€æ—©è¿™ä¸€å®éªŒæ€§åè®®ç”±Googleæ¨å‡ºï¼Œå¹¶å‘½åä¸ºgQUICï¼Œå› æ­¤ï¼ŒIETFè‰æ¡ˆä¸­ä»ç„¶ä¿ç•™äº†QUICæ¦‚å¿µï¼Œç”¨æ¥æè¿°HTTP3åè®®çš„ä¼ è¾“å±‚å’Œè¡¨ç¤ºå±‚ã€‚HTTP3åè®®è§„èŒƒç”±ä»¥ä¸‹5ä¸ªéƒ¨åˆ†ç»„æˆï¼š QUICå±‚ç”±https://tools.ietf.org/html/draft-ietf-quic-transport-29æè¿°ï¼Œå®ƒå®šä¹‰äº†è¿æ¥ã€æŠ¥æ–‡çš„å¯é ä¼ è¾“ã€æœ‰åºå­—èŠ‚æµçš„å®ç°ï¼› TLSåè®®ä¼šå°†QUICå±‚çš„éƒ¨åˆ†æŠ¥æ–‡å¤´éƒ¨æš´éœ²åœ¨æ˜æ–‡ä¸­ï¼Œæ–¹ä¾¿ä»£ç†æœåŠ¡å™¨è¿›è¡Œè·¯ç”±ã€‚https://tools.ietf.org/html/draft-ietf-quic-tls-29è§„èŒƒå®šä¹‰äº†QUICä¸TLSçš„ç»“åˆæ–¹å¼ï¼› ä¸¢åŒ…æ£€æµ‹ã€RTOé‡ä¼ å®šæ—¶å™¨é¢„ä¼°ç­‰åŠŸèƒ½ç”±https://tools.ietf.org/html/draft-ietf-quic-recovery-29å®šä¹‰ï¼Œç›®å‰æ‹¥å¡æ§åˆ¶ä½¿ç”¨äº†ç±»ä¼¼TCP New RENOçš„ç®—æ³•ï¼Œæœªæ¥æœ‰å¯èƒ½æ›´æ¢ä¸ºåŸºäºå¸¦å®½æ£€æµ‹çš„ç®—æ³•ï¼ˆä¾‹å¦‚BBRï¼‰ï¼› åŸºäºä»¥ä¸Š3ä¸ªè§„èŒƒï¼Œhttps://tools.ietf.org/html/draft-ietf-quic-http-29å®šä¹‰äº†HTTPè¯­ä¹‰çš„å®ç°ï¼ŒåŒ…æ‹¬æœåŠ¡å™¨æ¨é€ã€è¯·æ±‚å“åº”çš„ä¼ è¾“ç­‰ï¼› åœ¨HTTP2ä¸­ï¼Œç”±HPACKè§„èŒƒå®šä¹‰HTTPå¤´éƒ¨çš„å‹ç¼©ç®—æ³•ã€‚ç”±äºHPACKåŠ¨æ€è¡¨çš„æ›´æ–°å…·æœ‰æ—¶åºæ€§ï¼Œæ— æ³•æ»¡è¶³HTTP3çš„è¦æ±‚ã€‚åœ¨HTTP3ä¸­ï¼ŒQPACKå®šä¹‰HTTPå¤´éƒ¨çš„ç¼–ç ï¼šhttps://tools.ietf.org/html/draft-ietf-quic-qpack-16ã€‚æ³¨æ„ï¼Œä»¥ä¸Šè§„èŒƒçš„æœ€æ–°è‰æ¡ˆéƒ½åˆ°äº†29ï¼Œè€ŒQPACKç›¸å¯¹ç®€å•ï¼Œå®ƒç›®å‰æ›´æ–°åˆ°16ã€‚ è‡ª1991å¹´è¯ç”Ÿçš„HTTP/0.9åè®®å·²ä¸å†ä½¿ç”¨ï¼Œä½†1996æ¨å‡ºçš„HTTP/1.0ã€1999å¹´æ¨å‡ºçš„HTTP/1.1ã€2015å¹´æ¨å‡ºçš„HTTP2åè®®ä»ç„¶å…±å­˜äºäº’è”ç½‘ä¸­ï¼ˆHTTP/1.0åœ¨ä¼ä¸šå†…ç½‘ä¸­è¿˜åœ¨å¹¿ä¸ºä½¿ç”¨ï¼Œä¾‹å¦‚Nginxä¸ä¸Šæ¸¸çš„é»˜è®¤åè®®è¿˜æ˜¯1.0ç‰ˆæœ¬ï¼‰ï¼Œå³å°†é¢ä¸–çš„HTTP3åè®®çš„åŠ å…¥ï¼Œå°†ä¼šè¿›ä¸€æ­¥å¢åŠ åè®®é€‚é…çš„å¤æ‚åº¦ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ·±å…¥HTTP3åè®®çš„ç»†èŠ‚ã€‚ è¿æ¥è¿ç§»åŠŸèƒ½æ˜¯æ€æ ·å®ç°çš„ï¼Ÿ å¯¹äºå½“ä¸‹çš„HTTP1å’ŒHTTP2åè®®ï¼Œä¼ è¾“è¯·æ±‚å‰éœ€è¦å…ˆå®Œæˆè€—æ—¶1ä¸ªRTTçš„TCPä¸‰æ¬¡æ¡æ‰‹ã€è€—æ—¶1ä¸ªRTTçš„TLSæ¡æ‰‹ï¼ˆTLS1.3ï¼‰ï¼Œç”±äºå®ƒä»¬åˆ†å±å†…æ ¸å®ç°çš„ä¼ è¾“å±‚ã€opensslåº“å®ç°çš„è¡¨ç¤ºå±‚ï¼Œæ‰€ä»¥éš¾ä»¥åˆå¹¶åœ¨ä¸€èµ·ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š åœ¨IoTæ—¶ä»£ï¼Œç§»åŠ¨è®¾å¤‡æ¥å…¥çš„ç½‘ç»œä¼šé¢‘ç¹å˜åŠ¨ï¼Œä»è€Œå¯¼è‡´è®¾å¤‡IPåœ°å€æ”¹å˜ã€‚å¯¹äºé€šè¿‡å››å…ƒç»„ï¼ˆæºIPã€æºç«¯å£ã€ç›®çš„IPã€ç›®çš„ç«¯å£ï¼‰å®šä½è¿æ¥çš„TCPåè®®æ¥è¯´ï¼Œè¿™æ„å‘³ç€è¿æ¥éœ€è¦æ–­å¼€é‡è¿ï¼Œæ‰€ä»¥ä¸Šè¿°2ä¸ªRTTçš„å»ºé“¾æ—¶å»¶ã€TCPæ…¢å¯åŠ¨éƒ½éœ€è¦é‡æ–°æ¥è¿‡ã€‚è€ŒHTTP3çš„QUICå±‚å®ç°äº†è¿æ¥è¿ç§»åŠŸèƒ½ï¼Œå…è®¸ç§»åŠ¨è®¾å¤‡æ›´æ¢IPåœ°å€åï¼Œåªè¦ä»ä¿æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆæ¯”å¦‚è¿æ¥IDã€TLSå¯†é’¥ç­‰ï¼‰ï¼Œå°±å¯ä»¥å¤ç”¨åŸè¿æ¥ã€‚ åœ¨UDPæŠ¥æ–‡å¤´éƒ¨ä¸HTTPæ¶ˆæ¯ä¹‹é—´ï¼Œå…±æœ‰3å±‚å¤´éƒ¨ï¼Œå®šä¹‰è¿æ¥ä¸”å®ç°äº†Connection Migrationä¸»è¦æ˜¯åœ¨Packet Headerä¸­å®Œæˆçš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š è¿™3å±‚Headerå®ç°çš„åŠŸèƒ½å„ä¸ç›¸åŒï¼š Packet Headerå®ç°äº†å¯é çš„è¿æ¥ã€‚å½“UDPæŠ¥æ–‡ä¸¢å¤±åï¼Œé€šè¿‡Packet Headerä¸­çš„Packet Numberå®ç°æŠ¥æ–‡é‡ä¼ ã€‚è¿æ¥ä¹Ÿæ˜¯é€šè¿‡å…¶ä¸­çš„Connection IDå­—æ®µå®šä¹‰çš„ï¼› QUIC Frame Headeråœ¨æ— åºçš„PacketæŠ¥æ–‡ä¸­ï¼ŒåŸºäºQUIC Streamæ¦‚å¿µå®ç°äº†æœ‰åºçš„å­—èŠ‚æµï¼Œè¿™å…è®¸HTTPæ¶ˆæ¯å¯ä»¥åƒåœ¨TCPè¿æ¥ä¸Šä¸€æ ·ä¼ è¾“ï¼› HTTP3 Frame Headerå®šä¹‰äº†HTTP Headerã€Bodyçš„æ ¼å¼ï¼Œä»¥åŠæœåŠ¡å™¨æ¨é€ã€QPACKç¼–è§£ç æµç­‰åŠŸèƒ½ã€‚ ä¸ºäº†è¿›ä¸€æ­¥æå‡ç½‘ç»œä¼ è¾“æ•ˆç‡ï¼ŒPacket Headeråˆå¯ä»¥ç»†åˆ†ä¸ºä¸¤ç§ï¼š Long Packet Headerç”¨äºé¦–æ¬¡å»ºç«‹è¿æ¥ï¼› Short Packet Headerç”¨äºæ—¥å¸¸ä¼ è¾“æ•°æ®ã€‚ å…¶ä¸­ï¼ŒLong Packet Headerçš„æ ¼å¼å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å»ºç«‹è¿æ¥æ—¶ï¼Œè¿æ¥æ˜¯ç”±æœåŠ¡å™¨é€šè¿‡Source Connection IDå­—æ®µåˆ†é…çš„ï¼Œè¿™æ ·ï¼Œåç»­ä¼ è¾“æ—¶ï¼ŒåŒæ–¹åªéœ€è¦å›ºå®šä½Destination Connection IDï¼Œå°±å¯ä»¥åœ¨å®¢æˆ·ç«¯IPåœ°å€ã€ç«¯å£å˜åŒ–åï¼Œç»•è¿‡UDPå››å…ƒç»„ï¼ˆä¸TCPå››å…ƒç»„ç›¸åŒï¼‰ï¼Œå®ç°è¿æ¥è¿ç§»åŠŸèƒ½ã€‚ä¸‹å›¾æ˜¯Short Packet Headerå¤´éƒ¨çš„æ ¼å¼ï¼Œè¿™é‡Œå°±ä¸å†éœ€è¦ä¼ è¾“Source Connection IDå­—æ®µäº†ï¼š ä¸Šå›¾ä¸­çš„Packet Numberæ˜¯æ¯ä¸ªæŠ¥æ–‡ç‹¬ä¸€æ— äºŒçš„åºå·ï¼ŒåŸºäºå®ƒå¯ä»¥å®ç°ä¸¢å¤±æŠ¥æ–‡çš„ç²¾å‡†é‡å‘ã€‚å¦‚æœä½ é€šè¿‡æŠ“åŒ…è§‚å¯ŸPacket Headerï¼Œä¼šå‘ç°Packet Numberè¢«TLSå±‚åŠ å¯†ä¿æŠ¤äº†ï¼Œè¿™æ˜¯ä¸ºäº†é˜²èŒƒå„ç±»ç½‘ç»œæ”»å‡»çš„ä¸€ç§è®¾è®¡ã€‚ä¸‹å›¾ç»™å‡ºäº†Packet Headerä¸­è¢«åŠ å¯†ä¿æŠ¤çš„å­—æ®µï¼š å…¶ä¸­ï¼Œæ˜¾ç¤ºä¸ºEï¼ˆEncryptï¼‰çš„å­—æ®µè¡¨ç¤ºè¢«TLSåŠ å¯†è¿‡ã€‚å½“ç„¶ï¼ŒPacket Headeråªæ˜¯æè¿°äº†æœ€åŸºæœ¬çš„è¿æ¥ä¿¡æ¯ï¼Œå…¶ä¸Šçš„Streamå±‚ã€HTTPæ¶ˆæ¯ä¹Ÿæ˜¯è¢«åŠ å¯†ä¿æŠ¤çš„ï¼š ç°åœ¨æˆ‘ä»¬å·²ç»å¯¹HTTP3åè®®çš„æ ¼å¼æœ‰äº†åŸºæœ¬çš„äº†è§£ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡é˜Ÿå¤´é˜»å¡é—®é¢˜ï¼Œçœ‹çœ‹Packetä¹‹ä¸Šçš„QUIC Frameã€HTTP3 Frameå¸§æ ¼å¼ã€‚ Streamå¤šè·¯å¤ç”¨æ—¶çš„é˜Ÿå¤´é˜»å¡æ˜¯æ€æ ·è§£å†³çš„ï¼Ÿ å…¶å®ï¼Œè§£å†³é˜Ÿå¤´é˜»å¡çš„æ–¹æ¡ˆï¼Œå°±æ˜¯å…è®¸å¾®è§‚ä¸Šæœ‰åºå‘å‡ºçš„PacketæŠ¥æ–‡ï¼Œåœ¨æ¥æ”¶ç«¯æ— åºåˆ°è¾¾åä¹Ÿå¯ä»¥åº”ç”¨äºå¹¶å‘è¯·æ±‚ä¸­ã€‚æ¯”å¦‚ä¸Šæ–‡çš„åŠ¨æ€å›¾ä¸­ï¼Œå¦‚æœä¸¢å¤±çš„é»„è‰²æŠ¥æ–‡å¯¹å…¶åå‘å‡ºçš„ç»¿è‰²æŠ¥æ–‡ä¸é€ æˆå½±å“ï¼Œé˜Ÿå¤´é˜»å¡é—®é¢˜è‡ªç„¶å°±å¾—åˆ°äº†è§£å†³ï¼š åœ¨Packet Headerä¹‹ä¸Šçš„QUIC Frame Headerï¼Œå®šä¹‰äº†æœ‰åºå­—èŠ‚æµStreamï¼Œè€Œä¸”Streamä¹‹é—´å¯ä»¥å®ç°çœŸæ­£çš„å¹¶å‘ã€‚HTTP3çš„Streamï¼Œå€Ÿé‰´äº†HTTP2ä¸­çš„éƒ¨åˆ†æ¦‚å¿µï¼Œæ‰€ä»¥åœ¨è®¨è®ºQUIC Frame Headeræ ¼å¼ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹HTTP2ä¸­çš„Streamé•¿æˆä»€ä¹ˆæ ·å­ï¼š æ¯ä¸ªStreamå°±åƒHTTP1ä¸­çš„TCPè¿æ¥ï¼Œå®ƒä¿è¯äº†æ‰¿è½½çš„HEADERS frameï¼ˆå­˜æ”¾HTTP Headerï¼‰ã€DATA frameï¼ˆå­˜æ”¾HTTP Bodyï¼‰æ˜¯æœ‰åºåˆ°è¾¾çš„ï¼Œå¤šä¸ªStreamä¹‹é—´å¯ä»¥å¹¶è¡Œä¼ è¾“ã€‚åœ¨HTTP3ä¸­ï¼Œä¸Šå›¾ä¸­çš„HTTP2 frameä¼šè¢«æ‹†è§£ä¸ºä¸¤å±‚ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹åº•å±‚çš„QUIC Frameã€‚ ä¸€ä¸ªPacketæŠ¥æ–‡ä¸­å¯ä»¥å­˜æ”¾å¤šä¸ªQUIC Frameï¼Œå½“ç„¶æ‰€æœ‰Frameçš„é•¿åº¦ä¹‹å’Œä¸èƒ½å¤§äºPMTUDï¼ˆPath Maximum Transmission Unit Discoveryï¼Œè¿™æ˜¯å¤§äº1200å­—èŠ‚çš„å€¼ï¼‰ï¼Œä½ å¯ä»¥æŠŠå®ƒä¸IPè·¯ç”±ä¸­çš„MTUæ¦‚å¿µå¯¹ç…§ç†è§£ï¼š æ¯ä¸€ä¸ªFrameéƒ½æœ‰æ˜ç¡®çš„ç±»å‹ï¼š å‰4ä¸ªå­—èŠ‚çš„Frame Typeå­—æ®µæè¿°çš„ç±»å‹ä¸åŒï¼Œæ¥ä¸‹æ¥çš„ç¼–ç ä¹Ÿä¸ç›¸åŒï¼Œä¸‹è¡¨æ˜¯å„ç±»Frameçš„16è¿›åˆ¶Typeå€¼ï¼š åœ¨ä¸Šè¡¨ä¸­ï¼Œæˆ‘ä»¬åªè¦åˆ†æ0x08-0x0fè¿™8ç§STREAMç±»å‹çš„Frameï¼Œå°±èƒ½å¼„æ˜ç™½Streamæµçš„å®ç°åŸç†ï¼Œè‡ªç„¶ä¹Ÿå°±æ¸…æ¥šé˜Ÿå¤´é˜»å¡æ˜¯æ€æ ·è§£å†³çš„äº†ã€‚Stream Frameç”¨äºä¼ é€’HTTPæ¶ˆæ¯ï¼Œå®ƒçš„æ ¼å¼å¦‚ä¸‹æ‰€ç¤ºï¼š å¯è§ï¼ŒStream Frameå¤´éƒ¨çš„3ä¸ªå­—æ®µï¼Œå®Œæˆäº†å¤šè·¯å¤ç”¨ã€æœ‰åºå­—èŠ‚æµä»¥åŠæŠ¥æ–‡æ®µå±‚é¢çš„äºŒè¿›åˆ¶åˆ†éš”åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š Stream IDæ ‡è¯†äº†ä¸€ä¸ªæœ‰åºå­—èŠ‚æµã€‚å½“HTTP Bodyéå¸¸å¤§ï¼Œéœ€è¦è·¨è¶Šå¤šä¸ªPacketæ—¶ï¼Œåªè¦åœ¨æ¯ä¸ªStream Frameä¸­å«æœ‰åŒæ ·çš„Stream IDï¼Œå°±å¯ä»¥ä¼ è¾“ä»»æ„é•¿åº¦çš„æ¶ˆæ¯ã€‚å¤šä¸ªå¹¶å‘ä¼ è¾“çš„HTTPæ¶ˆæ¯ï¼Œé€šè¿‡ä¸åŒçš„Stream IDåŠ ä»¥åŒºåˆ«ï¼› æ¶ˆæ¯åºåˆ—åŒ–åçš„â€œæœ‰åºâ€ç‰¹æ€§ï¼Œæ˜¯é€šè¿‡Offsetå­—æ®µå®Œæˆçš„ï¼Œå®ƒç±»ä¼¼äºTCPåè®®ä¸­çš„Sequenceåºå·ï¼Œç”¨äºå®ç°Streamå†…å¤šä¸ªFrameé—´çš„ç´¯è®¡ç¡®è®¤åŠŸèƒ½ï¼› LengthæŒ‡æ˜äº†Frameæ•°æ®çš„é•¿åº¦ã€‚ ä½ å¯èƒ½ä¼šå¥‡æ€ªï¼Œä¸ºä»€ä¹ˆä¼šæœ‰8ç§Stream Frameå‘¢ï¼Ÿè¿™æ˜¯å› ä¸º0x08-0x0f è¿™8ç§ç±»å‹å…¶å®æ˜¯ç”±3ä¸ªäºŒè¿›åˆ¶ä½ç»„æˆï¼Œå®ƒä»¬å®ç°äº†ä»¥ä¸‹3 æ ‡å¿—ä½çš„ç»„åˆï¼š ç¬¬1ä½è¡¨ç¤ºæ˜¯å¦å«æœ‰Offsetï¼Œå½“å®ƒä¸º0æ—¶ï¼Œè¡¨ç¤ºè¿™æ˜¯Streamä¸­çš„èµ·å§‹Frameï¼Œè¿™ä¹Ÿæ˜¯ä¸Šå›¾ä¸­Offsetæ˜¯å¯é€‰å­—æ®µçš„åŸå› ï¼› ç¬¬2ä½è¡¨ç¤ºæ˜¯å¦å«æœ‰Lengthå­—æ®µï¼› ç¬¬3ä½Finï¼Œè¡¨ç¤ºè¿™æ˜¯Streamä¸­æœ€å1ä¸ªFrameï¼Œä¸HTTP2åè®®Frameå¸§ä¸­çš„FINæ ‡å¿—ä½ç›¸åŒã€‚ Streamæ•°æ®ä¸­å¹¶ä¸ä¼šç›´æ¥å­˜æ”¾HTTPæ¶ˆæ¯ï¼Œå› ä¸ºHTTP3è¿˜éœ€è¦å®ç°æœåŠ¡å™¨æ¨é€ã€æƒé‡ä¼˜å…ˆçº§è®¾å®šã€æµé‡æ§åˆ¶ç­‰åŠŸèƒ½ï¼Œæ‰€ä»¥Stream Dataä¸­é¦–å…ˆå­˜æ”¾äº†HTTP3 Frameï¼š å…¶ä¸­ï¼ŒLengthæŒ‡æ˜äº†HTTPæ¶ˆæ¯çš„é•¿åº¦ï¼Œè€ŒTypeå­—æ®µï¼ˆè¯·æ³¨æ„ï¼Œä½2ä½æœ‰ç‰¹æ®Šç”¨é€”ï¼Œåœ¨QPACKç« èŠ‚ä¸­ä¼šè¯¦ç»†ä»‹ç»ï¼‰åŒ…å«äº†ä»¥ä¸‹ç±»å‹ï¼š 0x00ï¼šDATAå¸§ï¼Œç”¨äºä¼ è¾“HTTP BodyåŒ…ä½“ï¼› 0x01ï¼šHEADERSå¸§ï¼Œé€šè¿‡QPACK ç¼–ç ï¼Œä¼ è¾“HTTP Headerå¤´éƒ¨ï¼› 0x03ï¼šCANCEL_PUSHæ§åˆ¶å¸§ï¼Œç”¨äºå–æ¶ˆ1æ¬¡æœåŠ¡å™¨æ¨é€æ¶ˆæ¯ï¼Œé€šå¸¸å®¢æˆ·ç«¯åœ¨æ”¶åˆ°PUSH_PROMISEå¸§åï¼Œé€šè¿‡å®ƒå‘ŠçŸ¥æœåŠ¡å™¨ä¸éœ€è¦è¿™æ¬¡æ¨é€ï¼› 0x04ï¼šSETTINGSæ§åˆ¶å¸§ï¼Œè®¾ç½®å„ç±»é€šè®¯å‚æ•°ï¼› 0x05ï¼šPUSH_PROMISEå¸§ï¼Œç”¨äºæœåŠ¡å™¨æ¨é€HTTP Bodyå‰ï¼Œå…ˆå°†HTTP Headerå¤´éƒ¨å‘ç»™å®¢æˆ·ç«¯ï¼Œæµç¨‹ä¸HTTP2ç›¸ä¼¼ï¼› 0x07ï¼šGOAWAYæ§åˆ¶å¸§ï¼Œç”¨äºå…³é—­è¿æ¥ï¼ˆæ³¨æ„ï¼Œä¸æ˜¯å…³é—­Streamï¼‰ï¼› 0x0dï¼šMAX_PUSH_IDï¼Œå®¢æˆ·ç«¯ç”¨æ¥é™åˆ¶æœåŠ¡å™¨æ¨é€æ¶ˆæ¯æ•°é‡çš„æ§åˆ¶å¸§ã€‚ æ€»ç»“ä¸€ä¸‹ï¼ŒQUIC Stream Frameå®šä¹‰äº†æœ‰åºå­—èŠ‚æµï¼Œä¸”å¤šä¸ªStreamé—´çš„ä¼ è¾“æ²¡æœ‰æ—¶åºæ€§è¦æ±‚ï¼Œè¿™æ ·ï¼ŒHTTPæ¶ˆæ¯åŸºäºQUIC Streamå°±å®ç°äº†çœŸæ­£çš„å¤šè·¯å¤ç”¨ï¼Œé˜Ÿå¤´é˜»å¡é—®é¢˜è‡ªç„¶å°±è¢«è§£å†³æ‰äº†ã€‚ QPACKç¼–ç æ˜¯å¦‚ä½•è§£å†³é˜Ÿå¤´é˜»å¡é—®é¢˜çš„ï¼Ÿ æœ€åï¼Œæˆ‘ä»¬å†çœ‹ä¸‹HTTP Headerå¤´éƒ¨çš„ç¼–ç æ–¹å¼ï¼Œå®ƒéœ€è¦é¢å¯¹å¦ä¸€ç§é˜Ÿå¤´é˜»å¡é—®é¢˜ã€‚ ä¸HTTP2ä¸­çš„HPACKç¼–ç æ–¹å¼ç›¸ä¼¼ï¼ŒHTTP3ä¸­çš„QPACKä¹Ÿé‡‡ç”¨äº†é™æ€è¡¨ã€åŠ¨æ€è¡¨åŠHuffmanç¼–ç ï¼š å…ˆæ¥çœ‹é™æ€è¡¨çš„å˜åŒ–ã€‚åœ¨ä¸Šå›¾ä¸­ï¼ŒGETæ–¹æ³•æ˜ å°„ä¸ºæ•°å­—2ï¼Œè¿™æ˜¯é€šè¿‡å®¢æˆ·ç«¯ã€æœåŠ¡å™¨åè®®å®ç°å±‚çš„ç¡¬ç¼–ç å®Œæˆçš„ã€‚åœ¨HTTP2ä¸­ï¼Œå…±æœ‰61ä¸ªé™æ€è¡¨é¡¹ï¼š è€Œåœ¨QPACKä¸­ï¼Œåˆ™ä¸Šå‡ä¸º98ä¸ªé™æ€è¡¨é¡¹ï¼Œæ¯”å¦‚Nginxä¸Šçš„ngx_htt_v3_static_tableæ•°ç»„æ‰€ç¤ºï¼š ä½ ä¹Ÿå¯ä»¥ä»è¿™é‡Œæ‰¾åˆ°å®Œæ•´çš„HTTP3é™æ€è¡¨ã€‚å¯¹äºHuffmanä»¥åŠæ•´æ•°çš„ç¼–ç ï¼ŒQPACKä¸HPACKå¹¶æ— å¤šå¤§ä¸åŒï¼Œä½†åŠ¨æ€è¡¨ç¼–è§£ç æ–¹å¼å·®è·å¾ˆå¤§ã€‚ æ‰€è°“åŠ¨æ€è¡¨ï¼Œå°±æ˜¯å°†æœªåŒ…å«åœ¨é™æ€è¡¨ä¸­çš„Headeré¡¹ï¼Œåœ¨å…¶é¦–æ¬¡å‡ºç°æ—¶åŠ å…¥åŠ¨æ€è¡¨ï¼Œè¿™æ ·åç»­ä¼ è¾“æ—¶ä»…ç”¨1ä¸ªæ•°å­—è¡¨ç¤ºï¼Œå¤§å¤§æå‡äº†ç¼–ç æ•ˆç‡ã€‚å› æ­¤ï¼ŒåŠ¨æ€è¡¨æ˜¯å¤©ç„¶å…·å¤‡æ—¶åºæ€§çš„ï¼Œå¦‚æœé¦–æ¬¡å‡ºç°çš„è¯·æ±‚å‡ºç°äº†ä¸¢åŒ…ï¼Œåç»­è¯·æ±‚è§£ç HPACKå¤´éƒ¨æ—¶ï¼Œä¸€å®šä¼šè¢«é˜»å¡ï¼ QPACKæ˜¯å¦‚ä½•è§£å†³é˜Ÿå¤´é˜»å¡é—®é¢˜çš„å‘¢ï¼Ÿäº‹å®ä¸Šï¼ŒQPACKå°†åŠ¨æ€è¡¨çš„ç¼–ç ã€è§£ç ç‹¬ç«‹åœ¨å•å‘Streamä¸­ä¼ è¾“ï¼Œä»…å½“å•å‘Streamä¸­çš„åŠ¨æ€è¡¨ç¼–ç æˆåŠŸåï¼Œæ¥æ”¶ç«¯æ‰èƒ½è§£ç åŒå‘Streamä¸ŠHTTPæ¶ˆæ¯é‡Œçš„åŠ¨æ€è¡¨ç´¢å¼•ã€‚ æˆ‘ä»¬åˆå¼•å…¥äº†å•å‘Streamå’ŒåŒå‘Streamæ¦‚å¿µï¼Œä¸è¦å¤´ç–¼ï¼Œå®ƒå…¶å®å¾ˆç®€å•ã€‚å•å‘æŒ‡åªæœ‰ä¸€ç«¯å¯ä»¥å‘é€æ¶ˆæ¯ï¼ŒåŒå‘åˆ™æŒ‡ä¸¤ç«¯éƒ½å¯ä»¥å‘é€æ¶ˆæ¯ã€‚è¿˜è®°å¾—ä¸Šä¸€å°èŠ‚çš„QUIC Stream Frameå¤´éƒ¨å—ï¼Ÿå…¶ä¸­çš„Stream IDåˆ«æœ‰ç„æœºï¼Œé™¤äº†æ ‡è¯†Streamå¤–ï¼Œå®ƒçš„ä½2ä½è¿˜å¯ä»¥è¡¨è¾¾ä»¥ä¸‹ç»„åˆï¼š å› æ­¤ï¼Œå½“Stream IDæ˜¯0ã€4ã€8ã€12æ—¶ï¼Œè¿™å°±æ˜¯å®¢æˆ·ç«¯å‘èµ·çš„åŒå‘Streamï¼ˆHTTP3ä¸æ”¯æŒæœåŠ¡å™¨å‘èµ·åŒå‘Streamï¼‰ï¼Œå®ƒç”¨äºä¼ è¾“HTTPè¯·æ±‚ä¸å“åº”ã€‚å•å‘Streamæœ‰å¾ˆå¤šç”¨é€”ï¼Œæ‰€ä»¥å®ƒåœ¨æ•°æ®å‰åˆå¤šå‡ºä¸€ä¸ªStream Typeå­—æ®µï¼š Stream Typeæœ‰ä»¥ä¸‹å–å€¼ï¼š 0x00ï¼šæ§åˆ¶Streamï¼Œä¼ é€’å„ç±»Streamæ§åˆ¶æ¶ˆæ¯ï¼› 0x01ï¼šæœåŠ¡å™¨æ¨é€æ¶ˆæ¯ï¼› 0x02ï¼šç”¨äºç¼–ç QPACKåŠ¨æ€è¡¨ï¼Œæ¯”å¦‚é¢å¯¹ä¸å±äºé™æ€è¡¨çš„HTTPè¯·æ±‚å¤´éƒ¨ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡è¿™ä¸ªStreamå‘é€åŠ¨æ€è¡¨ç¼–ç ï¼› 0x03ï¼šç”¨äºé€šçŸ¥ç¼–ç ç«¯QPACKåŠ¨æ€è¡¨çš„æ›´æ–°ç»“æœã€‚ ç”±äºHTTP3çš„STREAMä¹‹é—´æ˜¯ä¹±åºä¼ è¾“çš„ï¼Œå› æ­¤ï¼Œè‹¥å…ˆå‘é€çš„ç¼–ç Streamååˆ°è¾¾ï¼ŒåŒå‘Streamä¸­çš„QPACKå¤´éƒ¨å°±æ— æ³•è§£ç ï¼Œæ­¤æ—¶ä¼ è¾“HTTPæ¶ˆæ¯çš„åŒå‘Streamå°±ä¼šè¿›å…¥Blocké˜»å¡çŠ¶æ€ï¼ˆä¸¤ç«¯å¯ä»¥é€šè¿‡æ§åˆ¶å¸§å®šä¹‰é˜»å¡Streamçš„å¤„ç†æ–¹å¼ï¼‰ã€‚ å°ç»“ æœ€åå¯¹æœ¬æ–‡å†…å®¹åšä¸ªå°ç»“ã€‚ åŸºäºå››å…ƒç»„å®šä¹‰è¿æ¥å¹¶ä¸é€‚ç”¨äºä¸‹ä¸€ä»£IoTç½‘ç»œï¼ŒHTTP3åˆ›é€ å‡ºConnection IDæ¦‚å¿µå®ç°äº†è¿æ¥è¿ç§»ï¼Œé€šè¿‡èåˆä¼ è¾“å±‚ã€è¡¨ç¤ºå±‚ï¼Œæ—¢ç¼©çŸ­äº†æ¡æ‰‹æ—¶é•¿ï¼Œä¹ŸåŠ å¯†äº†ä¼ è¾“å±‚ä¸­çš„ç»å¤§éƒ¨åˆ†å­—æ®µï¼Œæå‡äº†ç½‘ç»œå®‰å…¨æ€§ã€‚ HTTP3åœ¨Packetå±‚ä¿éšœäº†è¿æ¥çš„å¯é æ€§ï¼Œåœ¨QUIC Frameå±‚å®ç°äº†æœ‰åºå­—èŠ‚æµï¼Œåœ¨HTTP3 Frameå±‚å®ç°äº†HTTPè¯­ä¹‰ï¼Œè¿™å½»åº•è§£å¼€äº†é˜Ÿå¤´é˜»å¡é—®é¢˜ï¼ŒçœŸæ­£å®ç°äº†åº”ç”¨å±‚çš„å¤šè·¯å¤ç”¨ã€‚ QPACKä½¿ç”¨ç‹¬ç«‹çš„å•å‘Streamåˆ†åˆ«ä¼ è¾“åŠ¨æ€è¡¨ç¼–ç ã€è§£ç ä¿¡æ¯ï¼Œè¿™æ ·ä¹±åºã€å¹¶å‘ä¼ è¾“HTTPæ¶ˆæ¯çš„Streamæ—¢ä¸ä¼šå‡ºç°é˜Ÿå¤´é˜»å¡ï¼Œä¹Ÿèƒ½åŸºäºæ—¶åºæ€§å¤§å¹…å‹ç¼©HTTP Headerçš„ä½“ç§¯ã€‚ ","link":"https://tianxiawuhao.github.io/Um_5N4eGG/"},{"title":"binlogã€redologã€undolog","content":"æ—¥å¿—æ˜¯ mysql æ•°æ®åº“çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œè®°å½•ç€æ•°æ®åº“è¿è¡ŒæœŸé—´å„ç§çŠ¶æ€ä¿¡æ¯ã€‚mysqlæ—¥å¿—ä¸»è¦åŒ…æ‹¬é”™è¯¯æ—¥å¿—ã€æŸ¥è¯¢æ—¥å¿—ã€æ…¢æŸ¥è¯¢æ—¥å¿—ã€äº‹åŠ¡æ—¥å¿—ã€äºŒè¿›åˆ¶æ—¥å¿—å‡ å¤§ç±»ã€‚ ä½œä¸ºå¼€å‘ï¼Œæˆ‘ä»¬é‡ç‚¹éœ€è¦å…³æ³¨çš„æ˜¯äºŒè¿›åˆ¶æ—¥å¿—( binlog )å’Œäº‹åŠ¡æ—¥å¿—(åŒ…æ‹¬redo log å’Œ undo log )ï¼Œæœ¬æ–‡æ¥ä¸‹æ¥ä¼šè¯¦ç»†ä»‹ç»è¿™ä¸‰ç§æ—¥å¿—ã€‚ binlog binlog ç”¨äºè®°å½•æ•°æ®åº“æ‰§è¡Œçš„å†™å…¥æ€§æ“ä½œ(ä¸åŒ…æ‹¬æŸ¥è¯¢)ä¿¡æ¯ï¼Œä»¥äºŒè¿›åˆ¶çš„å½¢å¼ä¿å­˜åœ¨ç£ç›˜ä¸­ã€‚binlog æ˜¯ mysqlçš„é€»è¾‘æ—¥å¿—ï¼Œå¹¶ä¸”ç”± Server å±‚è¿›è¡Œè®°å½•ï¼Œä½¿ç”¨ä»»ä½•å­˜å‚¨å¼•æ“çš„ mysql æ•°æ®åº“éƒ½ä¼šè®°å½• binlog æ—¥å¿—ã€‚ é€»è¾‘æ—¥å¿—ï¼šå¯ä»¥ç®€å•ç†è§£ä¸ºè®°å½•çš„å°±æ˜¯sqlè¯­å¥ ã€‚ ç‰©ç†æ—¥å¿—ï¼šmysql æ•°æ®æœ€ç»ˆæ˜¯ä¿å­˜åœ¨æ•°æ®é¡µä¸­çš„ï¼Œç‰©ç†æ—¥å¿—è®°å½•çš„å°±æ˜¯æ•°æ®é¡µå˜æ›´ ã€‚ binlog æ˜¯é€šè¿‡è¿½åŠ çš„æ–¹å¼è¿›è¡Œå†™å…¥çš„ï¼Œå¯ä»¥é€šè¿‡max_binlog_size å‚æ•°è®¾ç½®æ¯ä¸ª binlogæ–‡ä»¶çš„å¤§å°ï¼Œå½“æ–‡ä»¶å¤§å°è¾¾åˆ°ç»™å®šå€¼ä¹‹åï¼Œä¼šç”Ÿæˆæ–°çš„æ–‡ä»¶æ¥ä¿å­˜æ—¥å¿—ã€‚ binlogä½¿ç”¨åœºæ™¯ åœ¨å®é™…åº”ç”¨ä¸­ï¼Œ binlog çš„ä¸»è¦ä½¿ç”¨åœºæ™¯æœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯ ä¸»ä»å¤åˆ¶ å’Œ æ•°æ®æ¢å¤ ã€‚ ä¸»ä»å¤åˆ¶ ï¼šåœ¨ Master ç«¯å¼€å¯ binlog ï¼Œç„¶åå°† binlogå‘é€åˆ°å„ä¸ª Slave ç«¯ï¼Œ Slave ç«¯é‡æ”¾ binlog ä»è€Œè¾¾åˆ°ä¸»ä»æ•°æ®ä¸€è‡´ã€‚ æ•°æ®æ¢å¤ ï¼šé€šè¿‡ä½¿ç”¨ mysqlbinlog å·¥å…·æ¥æ¢å¤æ•°æ®ã€‚ binlogåˆ·ç›˜æ—¶æœº å¯¹äº InnoDB å­˜å‚¨å¼•æ“è€Œè¨€ï¼Œåªæœ‰åœ¨äº‹åŠ¡æäº¤æ—¶æ‰ä¼šè®°å½•binlog ï¼Œæ­¤æ—¶è®°å½•è¿˜åœ¨å†…å­˜ä¸­ï¼Œé‚£ä¹ˆ binlogæ˜¯ä»€ä¹ˆæ—¶å€™åˆ·åˆ°ç£ç›˜ä¸­çš„å‘¢ï¼Ÿ mysql é€šè¿‡ sync_binlog å‚æ•°æ§åˆ¶ binlog çš„åˆ·ç›˜æ—¶æœºï¼Œå–å€¼èŒƒå›´æ˜¯ 0-Nï¼š 0ï¼šä¸å»å¼ºåˆ¶è¦æ±‚ï¼Œç”±ç³»ç»Ÿè‡ªè¡Œåˆ¤æ–­ä½•æ—¶å†™å…¥ç£ç›˜ï¼› 1ï¼šæ¯æ¬¡ commit çš„æ—¶å€™éƒ½è¦å°† binlog å†™å…¥ç£ç›˜ï¼› Nï¼šæ¯Nä¸ªäº‹åŠ¡ï¼Œæ‰ä¼šå°† binlog å†™å…¥ç£ç›˜ã€‚ ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œ sync_binlog æœ€å®‰å…¨çš„æ˜¯è®¾ç½®æ˜¯ 1 ï¼Œè¿™ä¹Ÿæ˜¯MySQL 5.7.7ä¹‹åç‰ˆæœ¬çš„é»˜è®¤å€¼ã€‚ä½†æ˜¯è®¾ç½®ä¸€ä¸ªå¤§ä¸€äº›çš„å€¼å¯ä»¥æå‡æ•°æ®åº“æ€§èƒ½ï¼Œå› æ­¤å®é™…æƒ…å†µä¸‹ä¹Ÿå¯ä»¥å°†å€¼é€‚å½“è°ƒå¤§ï¼Œç‰ºç‰²ä¸€å®šçš„ä¸€è‡´æ€§æ¥è·å–æ›´å¥½çš„æ€§èƒ½ã€‚ binlogæ—¥å¿—æ ¼å¼ binlog æ—¥å¿—æœ‰ä¸‰ç§æ ¼å¼ï¼Œåˆ†åˆ«ä¸º STATMENT ã€ ROW å’Œ MIXEDã€‚ åœ¨ MySQL 5.7.7 ä¹‹å‰ï¼Œé»˜è®¤çš„æ ¼å¼æ˜¯ STATEMENT ï¼Œ MySQL 5.7.7 ä¹‹åï¼Œé»˜è®¤å€¼æ˜¯ ROWã€‚æ—¥å¿—æ ¼å¼é€šè¿‡ binlog-format æŒ‡å®šã€‚ STATMENTï¼šåŸºäºSQL è¯­å¥çš„å¤åˆ¶( statement-based replication, SBR )ï¼Œæ¯ä¸€æ¡ä¼šä¿®æ”¹æ•°æ®çš„sqlè¯­å¥ä¼šè®°å½•åˆ°binlog ä¸­ ã€‚ ä¼˜ç‚¹ï¼šä¸éœ€è¦è®°å½•æ¯ä¸€è¡Œçš„å˜åŒ–ï¼Œå‡å°‘äº† binlog æ—¥å¿—é‡ï¼ŒèŠ‚çº¦äº† IO , ä»è€Œæé«˜äº†æ€§èƒ½ï¼› ç¼ºç‚¹ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ä¼šå¯¼è‡´ä¸»ä»æ•°æ®ä¸ä¸€è‡´ï¼Œæ¯”å¦‚æ‰§è¡Œsysdate() ã€ slepp() ç­‰ ã€‚ ROWï¼šåŸºäºè¡Œçš„å¤åˆ¶(row-based replication, RBR )ï¼Œä¸è®°å½•æ¯æ¡sqlè¯­å¥çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä»…éœ€è®°å½•å“ªæ¡æ•°æ®è¢«ä¿®æ”¹äº† ã€‚ ä¼˜ç‚¹ï¼šä¸ä¼šå‡ºç°æŸäº›ç‰¹å®šæƒ…å†µä¸‹çš„å­˜å‚¨è¿‡ç¨‹ã€æˆ–functionã€æˆ–triggerçš„è°ƒç”¨å’Œè§¦å‘æ— æ³•è¢«æ­£ç¡®å¤åˆ¶çš„é—®é¢˜ ï¼› ç¼ºç‚¹ï¼šä¼šäº§ç”Ÿå¤§é‡çš„æ—¥å¿—ï¼Œå°¤å…¶æ˜¯alter table çš„æ—¶å€™ä¼šè®©æ—¥å¿—æš´æ¶¨ MIXEDï¼šåŸºäºSTATMENT å’Œ ROW ä¸¤ç§æ¨¡å¼çš„æ··åˆå¤åˆ¶(mixed-based replication, MBR )ï¼Œä¸€èˆ¬çš„å¤åˆ¶ä½¿ç”¨STATEMENT æ¨¡å¼ä¿å­˜ binlog ï¼Œå¯¹äº STATEMENT æ¨¡å¼æ— æ³•å¤åˆ¶çš„æ“ä½œä½¿ç”¨ ROW æ¨¡å¼ä¿å­˜ binlog redo log æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œäº‹åŠ¡çš„å››å¤§ç‰¹æ€§é‡Œé¢æœ‰ä¸€ä¸ªæ˜¯ æŒä¹…æ€§ ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯åªè¦äº‹åŠ¡æäº¤æˆåŠŸï¼Œé‚£ä¹ˆå¯¹æ•°æ®åº“åšçš„ä¿®æ”¹å°±è¢«æ°¸ä¹…ä¿å­˜ä¸‹æ¥äº†ï¼Œä¸å¯èƒ½å› ä¸ºä»»ä½•åŸå› å†å›åˆ°åŸæ¥çš„çŠ¶æ€ ã€‚ é‚£ä¹ˆ mysqlæ˜¯å¦‚ä½•ä¿è¯ä¸€è‡´æ€§çš„å‘¢ï¼Ÿ æœ€ç®€å•çš„åšæ³•æ˜¯åœ¨æ¯æ¬¡äº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œå°†è¯¥äº‹åŠ¡æ¶‰åŠä¿®æ”¹çš„æ•°æ®é¡µå…¨éƒ¨åˆ·æ–°åˆ°ç£ç›˜ä¸­ã€‚ä½†æ˜¯è¿™ä¹ˆåšä¼šæœ‰ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼Œä¸»è¦ä½“ç°åœ¨ä¸¤ä¸ªæ–¹é¢ï¼š å› ä¸º Innodb æ˜¯ä»¥ é¡µ ä¸ºå•ä½è¿›è¡Œç£ç›˜äº¤äº’çš„ï¼Œè€Œä¸€ä¸ªäº‹åŠ¡å¾ˆå¯èƒ½åªä¿®æ”¹ä¸€ä¸ªæ•°æ®é¡µé‡Œé¢çš„å‡ ä¸ªå­—èŠ‚ï¼Œè¿™ä¸ªæ—¶å€™å°†å®Œæ•´çš„æ•°æ®é¡µåˆ·åˆ°ç£ç›˜çš„è¯ï¼Œå¤ªæµªè´¹èµ„æºäº†ï¼ ä¸€ä¸ªäº‹åŠ¡å¯èƒ½æ¶‰åŠä¿®æ”¹å¤šä¸ªæ•°æ®é¡µï¼Œå¹¶ä¸”è¿™äº›æ•°æ®é¡µåœ¨ç‰©ç†ä¸Šå¹¶ä¸è¿ç»­ï¼Œä½¿ç”¨éšæœºIOå†™å…¥æ€§èƒ½å¤ªå·®ï¼ å› æ­¤ mysql è®¾è®¡äº† redo log ï¼Œ å…·ä½“æ¥è¯´å°±æ˜¯åªè®°å½•äº‹åŠ¡å¯¹æ•°æ®é¡µåšäº†å“ªäº›ä¿®æ”¹ï¼Œè¿™æ ·å°±èƒ½å®Œç¾åœ°è§£å†³æ€§èƒ½é—®é¢˜äº†(ç›¸å¯¹è€Œè¨€æ–‡ä»¶æ›´å°å¹¶ä¸”æ˜¯é¡ºåºIO)ã€‚ redo logåŸºæœ¬æ¦‚å¿µ redo log åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼šä¸€ä¸ªæ˜¯å†…å­˜ä¸­çš„æ—¥å¿—ç¼“å†²( redo log buffer )ï¼Œå¦ä¸€ä¸ªæ˜¯ç£ç›˜ä¸Šçš„æ—¥å¿—æ–‡ä»¶( redo logfile)ã€‚ mysql æ¯æ‰§è¡Œä¸€æ¡ DML è¯­å¥ï¼Œå…ˆå°†è®°å½•å†™å…¥ redo log bufferï¼Œåç»­æŸä¸ªæ—¶é—´ç‚¹å†ä¸€æ¬¡æ€§å°†å¤šä¸ªæ“ä½œè®°å½•å†™åˆ° redo log fileã€‚è¿™ç§ å…ˆå†™æ—¥å¿—ï¼Œå†å†™ç£ç›˜ çš„æŠ€æœ¯å°±æ˜¯ MySQLé‡Œç»å¸¸è¯´åˆ°çš„ WAL(Write-Ahead Logging) æŠ€æœ¯ã€‚ åœ¨è®¡ç®—æœºæ“ä½œç³»ç»Ÿä¸­ï¼Œç”¨æˆ·ç©ºé—´( user space )ä¸‹çš„ç¼“å†²åŒºæ•°æ®ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯æ— æ³•ç›´æ¥å†™å…¥ç£ç›˜çš„ï¼Œä¸­é—´å¿…é¡»ç»è¿‡æ“ä½œç³»ç»Ÿå†…æ ¸ç©ºé—´( kernel space )ç¼“å†²åŒº( OS Buffer )ã€‚ å› æ­¤ï¼Œ redo log buffer å†™å…¥ redo logfile å®é™…ä¸Šæ˜¯å…ˆå†™å…¥ OS Buffer ï¼Œç„¶åå†é€šè¿‡ç³»ç»Ÿè°ƒç”¨ fsync() å°†å…¶åˆ·åˆ° redo log file ä¸­ï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼š mysql æ”¯æŒä¸‰ç§å°† redo log buffer å†™å…¥ redo log file çš„æ—¶æœºï¼Œå¯ä»¥é€šè¿‡ innodb_flush_log_at_trx_commit å‚æ•°é…ç½®ï¼Œå„å‚æ•°å€¼å«ä¹‰å¦‚ä¸‹ï¼š redo logè®°å½•å½¢å¼ å‰é¢è¯´è¿‡ï¼Œ redo log å®é™…ä¸Šè®°å½•æ•°æ®é¡µçš„å˜æ›´ï¼Œè€Œè¿™ç§å˜æ›´è®°å½•æ˜¯æ²¡å¿…è¦å…¨éƒ¨ä¿å­˜ï¼Œå› æ­¤ redo logå®ç°ä¸Šé‡‡ç”¨äº†å¤§å°å›ºå®šï¼Œå¾ªç¯å†™å…¥çš„æ–¹å¼ï¼Œå½“å†™åˆ°ç»“å°¾æ—¶ï¼Œä¼šå›åˆ°å¼€å¤´å¾ªç¯å†™æ—¥å¿—ã€‚å¦‚ä¸‹å›¾ï¼š åŒæ—¶æˆ‘ä»¬å¾ˆå®¹æ˜“å¾—çŸ¥ï¼Œ åœ¨innodbä¸­ï¼Œæ—¢æœ‰redo log éœ€è¦åˆ·ç›˜ï¼Œè¿˜æœ‰ æ•°æ®é¡µ ä¹Ÿéœ€è¦åˆ·ç›˜ï¼Œ redo logå­˜åœ¨çš„æ„ä¹‰ä¸»è¦å°±æ˜¯é™ä½å¯¹ æ•°æ®é¡µ åˆ·ç›˜çš„è¦æ±‚ ã€‚ åœ¨ä¸Šå›¾ä¸­ï¼Œ write pos è¡¨ç¤º redo log å½“å‰è®°å½•çš„ LSN (é€»è¾‘åºåˆ—å·)ä½ç½®ï¼Œ check point è¡¨ç¤º æ•°æ®é¡µæ›´æ”¹è®°å½• åˆ·ç›˜åå¯¹åº” redo log æ‰€å¤„çš„ LSN(é€»è¾‘åºåˆ—å·)ä½ç½®ã€‚ write pos åˆ° check point ä¹‹é—´çš„éƒ¨åˆ†æ˜¯ redo log ç©ºç€çš„éƒ¨åˆ†ï¼Œç”¨äºè®°å½•æ–°çš„è®°å½•ï¼›check point åˆ° write pos ä¹‹é—´æ˜¯ redo log å¾…è½ç›˜çš„æ•°æ®é¡µæ›´æ”¹è®°å½•ã€‚å½“ write posè¿½ä¸Šcheck point æ—¶ï¼Œä¼šå…ˆæ¨åŠ¨ check point å‘å‰ç§»åŠ¨ï¼Œç©ºå‡ºä½ç½®å†è®°å½•æ–°çš„æ—¥å¿—ã€‚ å¯åŠ¨ innodb çš„æ—¶å€™ï¼Œä¸ç®¡ä¸Šæ¬¡æ˜¯æ­£å¸¸å…³é—­è¿˜æ˜¯å¼‚å¸¸å…³é—­ï¼Œæ€»æ˜¯ä¼šè¿›è¡Œæ¢å¤æ“ä½œã€‚å› ä¸º redo logè®°å½•çš„æ˜¯æ•°æ®é¡µçš„ç‰©ç†å˜åŒ–ï¼Œå› æ­¤æ¢å¤çš„æ—¶å€™é€Ÿåº¦æ¯”é€»è¾‘æ—¥å¿—(å¦‚ binlog )è¦å¿«å¾ˆå¤šã€‚ é‡å¯innodb æ—¶ï¼Œé¦–å…ˆä¼šæ£€æŸ¥ç£ç›˜ä¸­æ•°æ®é¡µçš„ LSN ï¼Œå¦‚æœæ•°æ®é¡µçš„LSN å°äºæ—¥å¿—ä¸­çš„ LSN ï¼Œåˆ™ä¼šä» checkpoint å¼€å§‹æ¢å¤ã€‚ è¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œåœ¨å®•æœºå‰æ­£å¤„äºcheckpoint çš„åˆ·ç›˜è¿‡ç¨‹ï¼Œä¸”æ•°æ®é¡µçš„åˆ·ç›˜è¿›åº¦è¶…è¿‡äº†æ—¥å¿—é¡µçš„åˆ·ç›˜è¿›åº¦ï¼Œæ­¤æ—¶ä¼šå‡ºç°æ•°æ®é¡µä¸­è®°å½•çš„ LSN å¤§äºæ—¥å¿—ä¸­çš„ LSNï¼Œè¿™æ—¶è¶…å‡ºæ—¥å¿—è¿›åº¦çš„éƒ¨åˆ†å°†ä¸ä¼šé‡åšï¼Œå› ä¸ºè¿™æœ¬èº«å°±è¡¨ç¤ºå·²ç»åšè¿‡çš„äº‹æƒ…ï¼Œæ— éœ€å†é‡åšã€‚ redo logä¸binlogåŒºåˆ« ç”± binlog å’Œ redo log çš„åŒºåˆ«å¯çŸ¥ï¼šbinlog æ—¥å¿—åªç”¨äºå½’æ¡£ï¼Œåªä¾é  binlog æ˜¯æ²¡æœ‰ crash-safe èƒ½åŠ›çš„ã€‚ ä½†åªæœ‰ redo log ä¹Ÿä¸è¡Œï¼Œå› ä¸º redo log æ˜¯ InnoDBç‰¹æœ‰çš„ï¼Œä¸”æ—¥å¿—ä¸Šçš„è®°å½•è½ç›˜åä¼šè¢«è¦†ç›–æ‰ã€‚å› æ­¤éœ€è¦ binlogå’Œ redo logäºŒè€…åŒæ—¶è®°å½•ï¼Œæ‰èƒ½ä¿è¯å½“æ•°æ®åº“å‘ç”Ÿå®•æœºé‡å¯æ—¶ï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±ã€‚ undo log æ•°æ®åº“äº‹åŠ¡å››å¤§ç‰¹æ€§ä¸­æœ‰ä¸€ä¸ªæ˜¯ åŸå­æ€§ ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯ åŸå­æ€§æ˜¯æŒ‡å¯¹æ•°æ®åº“çš„ä¸€ç³»åˆ—æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œä¸å¯èƒ½å‡ºç°éƒ¨åˆ†æˆåŠŸçš„æƒ…å†µã€‚ å®é™…ä¸Šï¼Œ åŸå­æ€§ åº•å±‚å°±æ˜¯é€šè¿‡ undo log å®ç°çš„ã€‚undo logä¸»è¦è®°å½•äº†æ•°æ®çš„é€»è¾‘å˜åŒ–ï¼Œæ¯”å¦‚ä¸€æ¡ INSERT è¯­å¥ï¼Œå¯¹åº”ä¸€æ¡DELETE çš„ undo log ï¼Œå¯¹äºæ¯ä¸ª UPDATE è¯­å¥ï¼Œå¯¹åº”ä¸€æ¡ç›¸åçš„ UPDATE çš„ undo log ï¼Œè¿™æ ·åœ¨å‘ç”Ÿé”™è¯¯æ—¶ï¼Œå°±èƒ½å›æ»šåˆ°äº‹åŠ¡ä¹‹å‰çš„æ•°æ®çŠ¶æ€ã€‚ åŒæ—¶ï¼Œ undo log ä¹Ÿæ˜¯ MVCC(å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶)å®ç°çš„å…³é”®ã€‚ ","link":"https://tianxiawuhao.github.io/HHdQUUQvV/"},{"title":"RocketMQ","content":"å¯ç”¨æ€§è¯„ä¼° ç³»ç»Ÿå¯ç”¨æ€§(Availability)æ˜¯ä¿¡æ¯å·¥ä¸šç•Œç”¨æ¥è¡¡é‡ä¸€ä¸ªä¿¡æ¯ç³»ç»Ÿæä¾›æŒç»­æœåŠ¡çš„èƒ½åŠ›ï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯åœ¨ç»™å®šæ—¶é—´åŒºé—´å†…ç³»ç»Ÿæˆ–è€…ç³»ç»ŸæŸä¸€èƒ½åŠ›åœ¨ç‰¹å®šç¯å¢ƒä¸­èƒ½å¤Ÿæ­£å¸¸å·¥ä½œçš„æ¦‚ç‡ã€‚ ç®€å•åœ°è¯´ï¼Œ å¯ç”¨æ€§æ˜¯å¹³å‡æ•…éšœé—´éš”æ—¶é—´(MTBF)é™¤ä»¥å¹³å‡æ•…éšœé—´éš”æ—¶é—´(MTBF)å’Œå¹³å‡æ•…éšœä¿®å¤æ—¶é—´(MTTR)ä¹‹å’Œæ‰€å¾—çš„ç»“æœï¼Œ å³ï¼š é€šå¸¸ä¸šç•Œä¹ æƒ¯ç”¨Nä¸ª9æ¥è¡¨å¾ç³»ç»Ÿå¯ç”¨æ€§ï¼Œè¡¨ç¤ºç³»ç»Ÿå¯ä»¥æ­£å¸¸ä½¿ç”¨æ—¶é—´ä¸æ€»æ—¶é—´(1å¹´)ä¹‹æ¯”ï¼Œæ¯”å¦‚ï¼š 99.9%ä»£è¡¨3ä¸ª9çš„å¯ç”¨æ€§ï¼Œæ„å‘³ç€å…¨å¹´ä¸å¯ç”¨æ—¶é—´åœ¨8.76å°æ—¶ä»¥å†…ï¼Œè¡¨ç¤ºè¯¥ç³»ç»Ÿåœ¨è¿ç»­è¿è¡Œ1å¹´æ—¶é—´é‡Œæœ€å¤šå¯èƒ½çš„ä¸šåŠ¡ä¸­æ–­æ—¶é—´æ˜¯8.76å°æ—¶ï¼› 99.99%ä»£è¡¨4ä¸ª9çš„å¯ç”¨æ€§ï¼Œæ„å‘³ç€å…¨å¹´ä¸å¯ç”¨æ—¶é—´åœ¨52.6åˆ†é’Ÿä»¥å†…,è¡¨ç¤ºè¯¥ç³»ç»Ÿåœ¨è¿ç»­è¿è¡Œ1å¹´æ—¶é—´é‡Œæœ€å¤šå¯èƒ½çš„ä¸šåŠ¡ä¸­æ–­æ—¶é—´æ˜¯52.6åˆ†é’Ÿï¼› 99.999%ä»£è¡¨5ä¸ª9çš„å¯ç”¨æ€§ï¼Œæ„å‘³ç€å…¨å¹´ä¸å¯ç”¨æ—¶é—´å¿…é¡»ä¿è¯åœ¨5.26åˆ†é’Ÿä»¥å†…ï¼Œç¼ºå°‘æ•…éšœè‡ªåŠ¨æ¢å¤æœºåˆ¶çš„ç³»ç»Ÿå°†å¾ˆéš¾è¾¾åˆ°5ä¸ª9çš„é«˜å¯ç”¨æ€§ã€‚ é‚£ä¹ˆXä¸ª9é‡Œçš„Xåªä»£è¡¨æ•°å­—35ï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰12ï¼Œä¹Ÿæ²¡æœ‰å¤§äº6çš„å‘¢ï¼Ÿ æˆ‘ä»¬æ¥ç€å¾€ä¸‹è®¡ç®—ï¼š 1ä¸ª9ï¼š(1-90%)*365=36.5å¤© *2ä¸ª9ï¼š(1-99%)*365=3.65å¤© 6ä¸ª9ï¼š(1-99.9999%)*365*24*60*60=31ç§’ å¯ä»¥çœ‹åˆ°1ä¸ª9å’Œã€2ä¸ª9åˆ†åˆ«è¡¨ç¤ºä¸€å¹´æ—¶é—´å†…ä¸šåŠ¡å¯èƒ½ä¸­æ–­çš„æ—¶é—´æ˜¯36.5å¤©ã€3.65å¤©ï¼Œè¿™ç§çº§åˆ«çš„å¯é æ€§æˆ–è®¸è¿˜ä¸é…ä½¿ç”¨â€œå¯é æ€§â€è¿™ä¸ªè¯ï¼› è€Œ6ä¸ª9åˆ™è¡¨ç¤ºä¸€å¹´å†…ä¸šåŠ¡ä¸­æ–­æ—¶é—´æœ€å¤šæ˜¯31ç§’ï¼Œé‚£ä¹ˆè¿™ä¸ªçº§åˆ«çš„å¯é æ€§å¹¶éå®ç°ä¸äº†ï¼Œè€Œæ˜¯è¦åšåˆ°ä»â€œ5ä¸ª9â€ åˆ°â€œ6ä¸ª9â€çš„å¯é æ€§æå‡çš„è¯ï¼Œåè€…éœ€è¦ä»˜å‡ºæ¯”å‰è€…å‡ å€çš„æˆæœ¬ã€‚ RocketMQæ¶æ„è®¾è®¡ åœ¨ä»‹ç»RocketMQé«˜å¯ç”¨ä¹‹å‰ï¼Œé¦–å…ˆäº†è§£ä¸€ä¸‹RocketMQæ¶æ„è®¾è®¡ æŠ€æœ¯æ¶æ„ éƒ¨ç½²æ¶æ„ æŠ€æœ¯æ¶æ„ RocketMQæ¶æ„ä¸Šä¸»è¦åˆ†ä¸ºå››éƒ¨åˆ†ï¼Œå¦‚å›¾æ‰€ç¤º: Producerï¼šæ¶ˆæ¯å‘å¸ƒçš„è§’è‰²ï¼Œæ”¯æŒåˆ†å¸ƒå¼é›†ç¾¤æ–¹å¼éƒ¨ç½²ã€‚Produceré€šè¿‡MQçš„è´Ÿè½½å‡è¡¡æ¨¡å—é€‰æ‹©ç›¸åº”çš„Brokeré›†ç¾¤é˜Ÿåˆ—è¿›è¡Œæ¶ˆæ¯æŠ•é€’ï¼ŒæŠ•é€’çš„è¿‡ç¨‹æ”¯æŒå¿«é€Ÿå¤±è´¥å¹¶ä¸”ä½å»¶è¿Ÿã€‚ Consumerï¼šæ¶ˆæ¯æ¶ˆè´¹çš„è§’è‰²ï¼Œæ”¯æŒåˆ†å¸ƒå¼é›†ç¾¤æ–¹å¼éƒ¨ç½²ã€‚æ”¯æŒä»¥pushæ¨ï¼Œpullæ‹‰ä¸¤ç§æ¨¡å¼å¯¹æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹ã€‚åŒæ—¶ä¹Ÿæ”¯æŒé›†ç¾¤æ–¹å¼å’Œå¹¿æ’­æ–¹å¼çš„æ¶ˆè´¹ï¼Œå®ƒæä¾›å®æ—¶æ¶ˆæ¯è®¢é˜…æœºåˆ¶ï¼Œå¯ä»¥æ»¡è¶³å¤§å¤šæ•°ç”¨æˆ·çš„éœ€æ±‚ã€‚ NameServerï¼šNameServeræ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„Topicè·¯ç”±æ³¨å†Œä¸­å¿ƒï¼Œå…¶è§’è‰²ç±»ä¼¼Dubboä¸­çš„zookeeperï¼Œæ”¯æŒBrokerçš„åŠ¨æ€æ³¨å†Œä¸å‘ç°ã€‚ä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªåŠŸèƒ½ï¼šBrokerç®¡ç†ï¼ŒNameServeræ¥å—Brokeré›†ç¾¤çš„æ³¨å†Œä¿¡æ¯å¹¶ä¸”ä¿å­˜ä¸‹æ¥ä½œä¸ºè·¯ç”±ä¿¡æ¯çš„åŸºæœ¬æ•°æ®ã€‚ç„¶åæä¾›å¿ƒè·³æ£€æµ‹æœºåˆ¶ï¼Œæ£€æŸ¥Brokeræ˜¯å¦è¿˜å­˜æ´»ï¼›è·¯ç”±ä¿¡æ¯ç®¡ç†ï¼Œæ¯ä¸ªNameServerå°†ä¿å­˜å…³äºBrokeré›†ç¾¤çš„æ•´ä¸ªè·¯ç”±ä¿¡æ¯å’Œç”¨äºå®¢æˆ·ç«¯æŸ¥è¯¢çš„é˜Ÿåˆ—ä¿¡æ¯ã€‚ç„¶åProducerå’ŒConumseré€šè¿‡NameServerå°±å¯ä»¥çŸ¥é“æ•´ä¸ªBrokeré›†ç¾¤çš„è·¯ç”±ä¿¡æ¯ï¼Œä»è€Œè¿›è¡Œæ¶ˆæ¯çš„æŠ•é€’å’Œæ¶ˆè´¹ã€‚NameServeré€šå¸¸ä¹Ÿæ˜¯é›†ç¾¤çš„æ–¹å¼éƒ¨ç½²ï¼Œå„å®ä¾‹é—´ç›¸äº’ä¸è¿›è¡Œä¿¡æ¯é€šè®¯ã€‚Brokeræ˜¯å‘æ¯ä¸€å°NameServeræ³¨å†Œè‡ªå·±çš„è·¯ç”±ä¿¡æ¯ï¼Œæ‰€ä»¥æ¯ä¸€ä¸ªNameServerå®ä¾‹ä¸Šé¢éƒ½ä¿å­˜ä¸€ä»½å®Œæ•´çš„è·¯ç”±ä¿¡æ¯ã€‚å½“æŸä¸ªNameServerå› æŸç§åŸå› ä¸‹çº¿äº†ï¼ŒBrokerä»ç„¶å¯ä»¥å‘å…¶å®ƒNameServeråŒæ­¥å…¶è·¯ç”±ä¿¡æ¯ï¼ŒProducer,Consumerä»ç„¶å¯ä»¥åŠ¨æ€æ„ŸçŸ¥Brokerçš„è·¯ç”±çš„ä¿¡æ¯ã€‚ BrokerServerï¼šBrokerä¸»è¦è´Ÿè´£æ¶ˆæ¯çš„å­˜å‚¨ã€æŠ•é€’å’ŒæŸ¥è¯¢ä»¥åŠæœåŠ¡é«˜å¯ç”¨ä¿è¯ï¼Œä¸ºäº†å®ç°è¿™äº›åŠŸèƒ½ï¼ŒBrokeråŒ…å«äº†ä»¥ä¸‹å‡ ä¸ªé‡è¦å­æ¨¡å—ã€‚ Remoting Moduleï¼šæ•´ä¸ªBrokerçš„å®ä½“ï¼Œè´Ÿè´£å¤„ç†æ¥è‡ªclientsç«¯çš„è¯·æ±‚ã€‚ Client Managerï¼šè´Ÿè´£ç®¡ç†å®¢æˆ·ç«¯(Producer/Consumer)å’Œç»´æŠ¤Consumerçš„Topicè®¢é˜…ä¿¡æ¯ Store Serviceï¼šæä¾›æ–¹ä¾¿ç®€å•çš„APIæ¥å£å¤„ç†æ¶ˆæ¯å­˜å‚¨åˆ°ç‰©ç†ç¡¬ç›˜å’ŒæŸ¥è¯¢åŠŸèƒ½ã€‚ HA Serviceï¼šé«˜å¯ç”¨æœåŠ¡ï¼Œæä¾›Master Broker å’Œ Slave Brokerä¹‹é—´çš„æ•°æ®åŒæ­¥åŠŸèƒ½ã€‚ Index Serviceï¼šæ ¹æ®ç‰¹å®šçš„Message keyå¯¹æŠ•é€’åˆ°Brokerçš„æ¶ˆæ¯è¿›è¡Œç´¢å¼•æœåŠ¡ï¼Œä»¥æä¾›æ¶ˆæ¯çš„å¿«é€ŸæŸ¥è¯¢ã€‚ éƒ¨ç½²æ¶æ„ RocketMQçš„Brokeræœ‰ä¸‰ç§é›†ç¾¤éƒ¨ç½²æ–¹å¼ï¼š 1.å•å°Masteréƒ¨ç½²ï¼› 2.å¤šå°Masteréƒ¨ç½²ï¼› 3.å¤šMasterå¤šSlaveéƒ¨ç½²ï¼› åŸºç¡€çš„rocketé«˜å¯ç”¨ï¼Œä¸»è¦é‡‡ç”¨ç¬¬3ç§éƒ¨ç½²æ–¹å¼ ä¸‹å›¾æ˜¯ç¬¬3ç§éƒ¨ç½²æ–¹å¼çš„ç®€å•å›¾ï¼š ç¬¬3ç§éƒ¨ç½²æ–¹å¼ç½‘ç»œéƒ¨ç½²ç‰¹ç‚¹ NameServeræ˜¯ä¸€ä¸ªå‡ ä¹æ— çŠ¶æ€èŠ‚ç‚¹ï¼Œå¯é›†ç¾¤éƒ¨ç½²ï¼ŒèŠ‚ç‚¹ä¹‹é—´æ— ä»»ä½•ä¿¡æ¯åŒæ­¥ã€‚ Brokeréƒ¨ç½²ç›¸å¯¹å¤æ‚ï¼ŒBrokeråˆ†ä¸ºMasterä¸Slaveï¼Œä¸€ä¸ªMasterå¯ä»¥å¯¹åº”å¤šä¸ªSlaveï¼Œä½†æ˜¯ä¸€ä¸ªSlaveåªèƒ½å¯¹åº”ä¸€ä¸ªMasterï¼ŒMasterä¸Slave çš„å¯¹åº”å…³ç³»é€šè¿‡æŒ‡å®šç›¸åŒçš„BrokerNameï¼Œä¸åŒçš„BrokerId æ¥å®šä¹‰ï¼ŒBrokerIdä¸º0è¡¨ç¤ºMasterï¼Œé0è¡¨ç¤ºSlaveã€‚Masterä¹Ÿå¯ä»¥éƒ¨ç½²å¤šä¸ªã€‚æ¯ä¸ªBrokerä¸NameServeré›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹å»ºç«‹é•¿è¿æ¥ï¼Œå®šæ—¶æ³¨å†ŒTopicä¿¡æ¯åˆ°æ‰€æœ‰NameServerã€‚ æ³¨æ„ï¼šå½“å‰RocketMQç‰ˆæœ¬åœ¨éƒ¨ç½²æ¶æ„ä¸Šæ”¯æŒä¸€Masterå¤šSlaveï¼Œä½†åªæœ‰BrokerId=1çš„ä»æœåŠ¡å™¨æ‰ä¼šå‚ä¸æ¶ˆæ¯çš„è¯»è´Ÿè½½ã€‚ Producerä¸NameServeré›†ç¾¤ä¸­çš„å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆéšæœºé€‰æ‹©ï¼‰å»ºç«‹é•¿è¿æ¥ï¼Œå®šæœŸä»NameServerè·å–Topicè·¯ç”±ä¿¡æ¯ï¼Œå¹¶å‘æä¾›Topic æœåŠ¡çš„Masterå»ºç«‹é•¿è¿æ¥ï¼Œä¸”å®šæ—¶å‘Masterå‘é€å¿ƒè·³ã€‚Producerå®Œå…¨æ— çŠ¶æ€ï¼Œå¯é›†ç¾¤éƒ¨ç½²ã€‚ Consumerä¸NameServeré›†ç¾¤ä¸­çš„å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆéšæœºé€‰æ‹©ï¼‰å»ºç«‹é•¿è¿æ¥ï¼Œå®šæœŸä»NameServerè·å–Topicè·¯ç”±ä¿¡æ¯ï¼Œå¹¶å‘æä¾›TopicæœåŠ¡çš„Masterã€Slaveå»ºç«‹é•¿è¿æ¥ï¼Œä¸”å®šæ—¶å‘Masterã€Slaveå‘é€å¿ƒè·³ã€‚Consumeræ—¢å¯ä»¥ä»Masterè®¢é˜…æ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥ä»Slaveè®¢é˜…æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…åœ¨å‘Masteræ‹‰å–æ¶ˆæ¯æ—¶ï¼ŒMasteræœåŠ¡å™¨ä¼šæ ¹æ®æ‹‰å–åç§»é‡ä¸æœ€å¤§åç§»é‡çš„è·ç¦»ï¼ˆåˆ¤æ–­æ˜¯å¦è¯»è€æ¶ˆæ¯ï¼Œäº§ç”Ÿè¯»I/Oï¼‰ï¼Œä»¥åŠä»æœåŠ¡å™¨æ˜¯å¦å¯è¯»ç­‰å› ç´ å»ºè®®ä¸‹ä¸€æ¬¡æ˜¯ä»Masterè¿˜æ˜¯Slaveæ‹‰å–ã€‚ ç»“åˆéƒ¨ç½²æ¶æ„å›¾ï¼Œæè¿°é›†ç¾¤å·¥ä½œæµç¨‹ï¼š å¯åŠ¨NameServerï¼ŒNameServerèµ·æ¥åç›‘å¬ç«¯å£ï¼Œç­‰å¾…Brokerã€Producerã€Consumerè¿ä¸Šæ¥ï¼Œç›¸å½“äºä¸€ä¸ªè·¯ç”±æ§åˆ¶ä¸­å¿ƒã€‚ Brokerå¯åŠ¨ï¼Œè·Ÿæ‰€æœ‰çš„NameServerä¿æŒé•¿è¿æ¥ï¼Œå®šæ—¶å‘é€å¿ƒè·³åŒ…ã€‚å¿ƒè·³åŒ…ä¸­åŒ…å«å½“å‰Brokerä¿¡æ¯(IP+ç«¯å£ç­‰)ä»¥åŠå­˜å‚¨æ‰€æœ‰Topicä¿¡æ¯ã€‚æ³¨å†ŒæˆåŠŸåï¼ŒNameServeré›†ç¾¤ä¸­å°±æœ‰Topicè·ŸBrokerçš„æ˜ å°„å…³ç³»ã€‚ æ”¶å‘æ¶ˆæ¯å‰ï¼Œå…ˆåˆ›å»ºTopicï¼Œåˆ›å»ºTopicæ—¶éœ€è¦æŒ‡å®šè¯¥Topicè¦å­˜å‚¨åœ¨å“ªäº›Brokerä¸Šï¼Œä¹Ÿå¯ä»¥åœ¨å‘é€æ¶ˆæ¯æ—¶è‡ªåŠ¨åˆ›å»ºTopicã€‚ Producerå‘é€æ¶ˆæ¯ï¼Œå¯åŠ¨æ—¶å…ˆè·ŸNameServeré›†ç¾¤ä¸­çš„å…¶ä¸­ä¸€å°å»ºç«‹é•¿è¿æ¥ï¼Œå¹¶ä»NameServerä¸­è·å–å½“å‰å‘é€çš„Topicå­˜åœ¨å“ªäº›Brokerä¸Šï¼Œè½®è¯¢ä»é˜Ÿåˆ—åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªé˜Ÿåˆ—ï¼Œç„¶åä¸é˜Ÿåˆ—æ‰€åœ¨çš„Brokerå»ºç«‹é•¿è¿æ¥ä»è€Œå‘Brokerå‘æ¶ˆæ¯ã€‚ Consumerè·ŸProducerç±»ä¼¼ï¼Œè·Ÿå…¶ä¸­ä¸€å°NameServerå»ºç«‹é•¿è¿æ¥ï¼Œè·å–å½“å‰è®¢é˜…Topicå­˜åœ¨å“ªäº›Brokerä¸Šï¼Œç„¶åç›´æ¥è·ŸBrokerå»ºç«‹è¿æ¥é€šé“ï¼Œå¼€å§‹æ¶ˆè´¹æ¶ˆæ¯ã€‚ æ±‡æ€»ï¼šRocketMQ é›†ç¾¤éƒ¨ç½²æ¨¡å¼ å‰é¢ä»‹ç»åˆ°ï¼ŒRocketMQçš„Brokeræœ‰ä¸‰ç§é›†ç¾¤éƒ¨ç½²æ–¹å¼ï¼š 1.å•å°Masteréƒ¨ç½²ï¼› 2.å¤šå°Masteréƒ¨ç½²ï¼› 3.å¤šMasterå¤šSlaveéƒ¨ç½²ï¼› ç¬¬ä¸‰ç§æ¨¡å¼ï¼Œæ ¹æ®Masterå’ŒSlaveä¹‹èŠ‚çš„æ•°æ®åŒæ­¥æ–¹å¼å¯ä»¥åˆ†ä¸ºï¼š å¤š master å¤š slave å¼‚æ­¥å¤åˆ¶æ¨¡å¼ å¤š master å¤š slave åŒæ­¥å¤åˆ¶æ¨¡å¼ åŒæ­¥æ–¹å¼ï¼šåŒæ­¥å¤åˆ¶å’Œå¼‚æ­¥å¤åˆ¶ï¼ˆæŒ‡çš„ä¸€ç»„ master å’Œ slave ä¹‹é—´æ•°æ®çš„åŒæ­¥ï¼‰ æ‰€ä»¥ï¼Œæ€»ä½“æ¥è¯´ï¼ŒRocketMQ é›†ç¾¤éƒ¨ç½²æ¨¡å¼ä¸ºå››ç§ï¼š 1.å• master æ¨¡å¼ ä¹Ÿå°±æ˜¯åªæœ‰ä¸€ä¸ª master èŠ‚ç‚¹ï¼Œå¦‚æœmasterèŠ‚ç‚¹æŒ‚æ‰äº†ï¼Œä¼šå¯¼è‡´æ•´ä¸ªæœåŠ¡ä¸å¯ç”¨ï¼Œçº¿ä¸Šä¸å®œä½¿ç”¨ï¼Œé€‚åˆä¸ªäººå­¦ä¹ ä½¿ç”¨ã€‚ 2.å¤š master æ¨¡å¼ å¤šä¸ª master èŠ‚ç‚¹ç»„æˆé›†ç¾¤ï¼Œå•ä¸ª master èŠ‚ç‚¹å®•æœºæˆ–è€…é‡å¯å¯¹åº”ç”¨æ²¡æœ‰å½±å“ã€‚ ä¼˜ç‚¹ï¼šæ‰€æœ‰æ¨¡å¼ä¸­æ€§èƒ½æœ€é«˜ ç¼ºç‚¹ï¼šå•ä¸ª master èŠ‚ç‚¹å®•æœºæœŸé—´ï¼Œæœªè¢«æ¶ˆè´¹çš„æ¶ˆæ¯åœ¨èŠ‚ç‚¹æ¢å¤ä¹‹å‰ä¸å¯ç”¨ï¼Œæ¶ˆæ¯çš„å®æ—¶æ€§å°±å—åˆ°å½±å“ã€‚ æ³¨æ„ï¼šä½¿ç”¨åŒæ­¥åˆ·ç›˜å¯ä»¥ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼ŒåŒæ—¶ Topic ç›¸å¯¹åº”çš„ queue åº”è¯¥åˆ†å¸ƒåœ¨é›†ç¾¤ä¸­å„ä¸ª master èŠ‚ç‚¹ï¼Œè€Œä¸æ˜¯åªåœ¨æŸå„ master èŠ‚ç‚¹ä¸Šï¼Œå¦åˆ™ï¼Œè¯¥èŠ‚ç‚¹å®•æœºä¼šå¯¹è®¢é˜…è¯¥ topic çš„åº”ç”¨é€ æˆå½±å“ã€‚ 3.å¤š master å¤š slave å¼‚æ­¥å¤åˆ¶æ¨¡å¼ åœ¨å¤š master æ¨¡å¼çš„åŸºç¡€ä¸Šï¼Œæ¯ä¸ª master èŠ‚ç‚¹éƒ½æœ‰è‡³å°‘ä¸€ä¸ªå¯¹åº”çš„ slaveã€‚ master èŠ‚ç‚¹å¯è¯»å¯å†™ï¼Œä½†æ˜¯ slave åªèƒ½è¯»ä¸èƒ½å†™ï¼Œç±»ä¼¼äº mysql çš„ä¸»å¤‡æ¨¡å¼ã€‚ ä¼˜ç‚¹ï¼š åœ¨ master å®•æœºæ—¶ï¼Œæ¶ˆè´¹è€…å¯ä»¥ä» slave è¯»å–æ¶ˆæ¯ï¼Œæ¶ˆæ¯çš„å®æ—¶æ€§ä¸ä¼šå—å½±å“ï¼Œæ€§èƒ½å‡ ä¹å’Œå¤š master ä¸€æ ·ã€‚ ç¼ºç‚¹ï¼šä½¿ç”¨å¼‚æ­¥å¤åˆ¶çš„åŒæ­¥æ–¹å¼æœ‰å¯èƒ½ä¼šæœ‰æ¶ˆæ¯ä¸¢å¤±çš„é—®é¢˜ã€‚ 4.å¤š master å¤š slave åŒæ­¥åŒå†™æ¨¡å¼ åŒå¤š master å¤š slave å¼‚æ­¥å¤åˆ¶æ¨¡å¼ç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äº master å’Œ slave ä¹‹é—´çš„æ•°æ®åŒæ­¥æ–¹å¼ã€‚ ä¼˜ç‚¹ï¼šåŒæ­¥åŒå†™çš„åŒæ­¥æ¨¡å¼èƒ½ä¿è¯æ•°æ®ä¸ä¸¢å¤±ã€‚ ç¼ºç‚¹ï¼šå‘é€å•ä¸ªæ¶ˆæ¯ RT ä¼šç•¥é•¿ï¼Œæ€§èƒ½ç›¸æ¯”å¼‚æ­¥å¤åˆ¶ä½10%å·¦å³ã€‚ åˆ·ç›˜ç­–ç•¥ï¼šåŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜ï¼ˆæŒ‡çš„æ˜¯èŠ‚ç‚¹è‡ªèº«æ•°æ®æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥å­˜å‚¨ï¼‰ æ³¨æ„ï¼šè¦ä¿è¯æ•°æ®å¯é ï¼Œéœ€é‡‡ç”¨åŒæ­¥åˆ·ç›˜å’ŒåŒæ­¥åŒå†™çš„æ–¹å¼ï¼Œä½†æ€§èƒ½ä¼šè¾ƒå…¶ä»–æ–¹å¼ä½ã€‚ RocketMQä¸ZooKeeperçš„çˆ±æ¨çº è‘› è¯´åˆ°é«˜æ€§èƒ½æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œç¬¬ä¸€ä¸ªæƒ³åˆ°çš„è‚¯å®šæ˜¯LinkedInå¼€æºçš„Kafkaï¼Œè™½ç„¶æœ€åˆKafkaæ˜¯ä¸ºæ—¥å¿—ä¼ è¾“è€Œç”Ÿï¼Œä½†ä¹Ÿéå¸¸é€‚åˆäº’è”ç½‘å…¬å¸æ¶ˆæ¯æœåŠ¡çš„åº”ç”¨åœºæ™¯ï¼Œä»–ä»¬ä¸è¦æ±‚æ•°æ®å®æ—¶çš„å¼ºä¸€è‡´æ€§ï¼ˆäº‹åŠ¡ï¼‰ï¼Œæ›´å¤šæ˜¯å¸Œæœ›è¾¾åˆ°æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚ RocketMQæ˜¯MetaQçš„3.0ç‰ˆæœ¬ï¼Œè€ŒMetaQæœ€åˆçš„è®¾è®¡åˆå‚è€ƒäº†Kafkaã€‚æœ€åˆçš„MetaQ 1.xç‰ˆæœ¬ç”±é˜¿é‡Œçš„åŸä½œè€…åº„æ™“ä¸¹å¼€å‘ï¼Œåé¢çš„MetaQ 2.xç‰ˆæœ¬æ‰è¿›è¡Œäº†å¼€æºã€‚ MetaQ 1.xå’ŒMetaQ 2.xæ˜¯ä¾èµ–ZooKeeperçš„ï¼Œä½†RocketMQï¼ˆå³MetaQ 3.xï¼‰å´å»æ‰äº†ZooKeeperä¾èµ–ï¼Œè½¬è€Œé‡‡ç”¨è‡ªå·±çš„NameServerã€‚ ZooKeeperæ˜¯è‘—åçš„åˆ†å¸ƒå¼åä½œæ¡†æ¶ï¼Œæä¾›äº†Masteré€‰ä¸¾ã€åˆ†å¸ƒå¼é”ã€æ•°æ®çš„å‘å¸ƒå’Œè®¢é˜…ç­‰è¯¸å¤šåŠŸèƒ½ã€‚ä¸ºä»€ä¹ˆRocketMQæ²¡æœ‰é€‰æ‹©ZooKeeperï¼Œè€Œæ˜¯è‡ªå·±å¼€å‘äº†NameServerï¼Œæˆ‘ä»¬æ¥å…·ä½“çœ‹çœ‹NameServeråœ¨RocketMQé›†ç¾¤ä¸­çš„ä½œç”¨å°±æ˜äº†äº†ã€‚ RocketMQçš„Brokeræœ‰ä¸‰ç§é›†ç¾¤éƒ¨ç½²æ–¹å¼ RocketMQçš„Brokeræœ‰ä¸‰ç§é›†ç¾¤éƒ¨ç½²æ–¹å¼ï¼š 1.å•å°Masteréƒ¨ç½²ï¼› 2.å¤šå°Masteréƒ¨ç½²ï¼› 3.å¤šMasterå¤šSlaveéƒ¨ç½²ï¼› é‡‡ç”¨ç¬¬3ç§éƒ¨ç½²æ–¹å¼æ—¶ï¼ŒMasterå’ŒSlaveå¯ä»¥é‡‡ç”¨åŒæ­¥å¤åˆ¶å’Œå¼‚æ­¥å¤åˆ¶ä¸¤ç§æ–¹å¼ã€‚ ä¸‹å›¾æ˜¯ç¬¬3ç§éƒ¨ç½²æ–¹å¼çš„ç®€å•å›¾ï¼š å½“é‡‡ç”¨å¤šMasteræ–¹å¼æ—¶ï¼ŒMasterä¸Masterä¹‹é—´æ˜¯ä¸éœ€è¦çŸ¥é“å½¼æ­¤çš„ï¼Œè¿™æ ·çš„è®¾è®¡ç›´æ¥é™ä½äº†Brokerå®ç°çš„å¤æ‚æ€§ã€‚ ä½ å¯ä»¥è¯•æƒ³ï¼Œå¦‚æœMasterä¸Masterä¹‹é—´éœ€è¦çŸ¥é“å½¼æ­¤çš„å­˜åœ¨ï¼Œè¿™ä¼šéœ€è¦åœ¨Masterä¹‹ä¸­ç»´æŠ¤ä¸€ä¸ªç½‘ç»œçš„Masteråˆ—è¡¨ï¼Œè€Œä¸”å¿…ç„¶è®¾è®¡åˆ°Masterå‘ç°å’Œæ´»è·ƒMasteræ•°é‡å˜æ›´ç­‰è¯¸å¤šçŠ¶æ€æ›´æ–°é—®é¢˜ï¼Œæ‰€ä»¥æœ€ç®€å•ä¹Ÿæœ€å¯é çš„åšæ³•å°±æ˜¯Masteråªåšå¥½è‡ªå·±çš„äº‹æƒ…ï¼ˆæ¯”å¦‚å’ŒSlaveè¿›è¡Œæ•°æ®åŒæ­¥ï¼‰å³å¯ã€‚ è¿™æ ·ï¼Œåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼ŒæŸå°Masterå®•æœºæˆ–ä¸Šçº¿ï¼Œä¸ä¼šå¯¹å…¶ä»–Masteré€ æˆä»»ä½•å½±å“ã€‚ é‚£ä¹ˆæ€ä¹ˆæ‰èƒ½çŸ¥é“ç½‘ç»œä¸­æœ‰å¤šå°‘å°Masterå’ŒSlaveå‘¢ï¼Ÿ ä½ ä¼šå¾ˆè‡ªç„¶æƒ³åˆ°ç”¨ZooKeeperï¼Œæ¯ä¸ªæ´»è·ƒçš„Masteræˆ–Slaveéƒ½å»çº¦å®šçš„ZooKeeperèŠ‚ç‚¹ä¸‹æ³¨å†Œä¸€ä¸ªçŠ¶æ€èŠ‚ç‚¹ï¼Œä½†RocketMQæ²¡æœ‰ä½¿ç”¨ZooKeeperï¼Œæ‰€ä»¥è¿™ä»¶äº‹å°±äº¤ç»™äº†NameServeræ¥åšäº†ï¼ˆçœ‹ä¸Šå›¾ï¼‰ã€‚ NameServerçš„åŠŸèƒ½ åŠŸèƒ½ä¸€ï¼šNameServerç”¨æ¥ä¿å­˜æ´»è·ƒçš„brokeråˆ—è¡¨ï¼ŒåŒ…æ‹¬Masterå’ŒSlaveã€‚ åŠŸèƒ½äºŒï¼šNameServerç”¨æ¥ä¿å­˜æ‰€æœ‰topicå’Œè¯¥topicæ‰€æœ‰é˜Ÿåˆ—çš„åˆ—è¡¨ã€‚ åŠŸèƒ½ä¸‰ï¼šNameServerç”¨æ¥ä¿å­˜æ‰€æœ‰brokerçš„Filteråˆ—è¡¨ã€‚ åŠŸèƒ½å››ï¼šNameServerå¯ä»¥ç†è§£æ‰¿æ‹…äº†æ³¨å†Œä¸­å¿ƒçš„èŒèƒ½ NameServeræ³¨å†Œä¸­å¿ƒèŒèƒ½ NameServeræ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„è·¯ç”±æ³¨å†Œä¸­å¿ƒï¼Œå…¶è§’è‰²ç±»ä¼¼Dubboä¸­çš„zookeeperï¼Œæ”¯æŒBrokerçš„åŠ¨æ€æ³¨å†Œä¸å‘ç°ã€‚ Brokerç®¡ç†ï¼ŒNameServeræ¥å—Brokeré›†ç¾¤çš„æ³¨å†Œä¿¡æ¯å¹¶ä¸”ä¿å­˜ä¸‹æ¥ä½œä¸ºè·¯ç”±ä¿¡æ¯çš„åŸºæœ¬æ•°æ®ã€‚ç„¶åæä¾›å¿ƒè·³æ£€æµ‹æœºåˆ¶ï¼Œæ£€æŸ¥Brokeræ˜¯å¦è¿˜å­˜æ´»ï¼› è·¯ç”±ä¿¡æ¯ç®¡ç†ï¼Œæ¯ä¸ªNameServerå°†ä¿å­˜å…³äºBrokeré›†ç¾¤çš„æ•´ä¸ªè·¯ç”±ä¿¡æ¯å’Œç”¨äºå®¢æˆ·ç«¯æŸ¥è¯¢çš„é˜Ÿåˆ—ä¿¡æ¯ã€‚ç„¶åProducerå’ŒConumseré€šè¿‡NameServerå°±å¯ä»¥çŸ¥é“æ•´ä¸ªBrokeré›†ç¾¤çš„è·¯ç”±ä¿¡æ¯ï¼Œä»è€Œè¿›è¡Œæ¶ˆæ¯çš„æŠ•é€’å’Œæ¶ˆè´¹ æ•´ä¸ªRocketmqé›†ç¾¤çš„å·¥ä½œåŸç†å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å¯ä»¥çœ‹åˆ°ï¼ŒBrokeré›†ç¾¤ã€Produceré›†ç¾¤ã€Consumeré›†ç¾¤éƒ½éœ€è¦ä¸NameServeré›†ç¾¤è¿›è¡Œé€šä¿¡ï¼š Brokeré›†ç¾¤: Brokerç”¨äºæ¥æ”¶ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ï¼Œæˆ–è€…æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯çš„è¯·æ±‚ã€‚ä¸€ä¸ªBrokeré›†ç¾¤ç”±å¤šç»„Master/Slaveç»„æˆï¼ŒMasterå¯å†™å¯è¯»ï¼ŒSlaveåªå¯ä»¥è¯»ï¼ŒMasterå°†å†™å…¥çš„æ•°æ®åŒæ­¥ç»™Slaveã€‚ æ¯ä¸ªBrokerèŠ‚ç‚¹ï¼Œåœ¨å¯åŠ¨æ—¶ï¼Œéƒ½ä¼šéå†NameServeråˆ—è¡¨ï¼Œä¸æ¯ä¸ªNameServerå»ºç«‹é•¿è¿æ¥ï¼Œæ³¨å†Œè‡ªå·±çš„ä¿¡æ¯ï¼Œä¹‹åå®šæ—¶ä¸ŠæŠ¥ã€‚ Produceré›†ç¾¤: æ¶ˆæ¯çš„ç”Ÿäº§è€…ï¼Œé€šè¿‡NameServeré›†ç¾¤è·å¾—Topicçš„è·¯ç”±ä¿¡æ¯ï¼ŒåŒ…æ‹¬Topicä¸‹é¢æœ‰å“ªäº›Queueï¼Œè¿™äº›Queueåˆ†å¸ƒåœ¨å“ªäº›Brokerä¸Šç­‰ã€‚Produceråªä¼šå°†æ¶ˆæ¯å‘é€åˆ°MasterèŠ‚ç‚¹ä¸Šï¼Œå› æ­¤åªéœ€è¦ä¸MasterèŠ‚ç‚¹å»ºç«‹è¿æ¥ã€‚ Consumeré›†ç¾¤: æ¶ˆæ¯çš„æ¶ˆè´¹è€…ï¼Œé€šè¿‡NameServeré›†ç¾¤è·å¾—Topicçš„è·¯ç”±ä¿¡æ¯ï¼Œè¿æ¥åˆ°å¯¹åº”çš„Brokerä¸Šæ¶ˆè´¹æ¶ˆæ¯ã€‚æ³¨æ„ï¼Œç”±äºMasterå’ŒSlaveéƒ½å¯ä»¥è¯»å–æ¶ˆæ¯ï¼Œå› æ­¤Consumerä¼šä¸Masterå’ŒSlaveéƒ½å»ºç«‹è¿æ¥ã€‚ æ€»ä¹‹ï¼š Name Server æ˜¯ä¸“ä¸º RocketMQ è®¾è®¡çš„è½»é‡çº§æ³¨å†Œä¸­å¿ƒï¼Œå…·æœ‰ç®€å•ã€å¯é›†ç¾¤æ¨ªåæ‰©å±•ã€æ— çŠ¶æ€ï¼ŒèŠ‚ç‚¹ä¹‹é—´äº’ä¸é€šä¿¡ç­‰ç‰¹ç‚¹ã€‚ RocketMQä¸ºä»€ä¹ˆä¸ä½¿ç”¨ZooKeeper æ¥çœ‹çœ‹RocketMQä¸ºä»€ä¹ˆä¸ä½¿ç”¨ZooKeeperï¼Ÿ ZooKeeperå¯ä»¥æä¾›Masteré€‰ä¸¾åŠŸèƒ½ã€‚æ¯”å¦‚Kafkaç”¨æ¥ç»™æ¯ä¸ªåˆ†åŒºé€‰ä¸€ä¸ªbrokerä½œä¸ºleaderã€‚ ä½†å¯¹äºRocketMQæ¥è¯´ï¼Œtopicçš„æ•°æ®åœ¨æ¯ä¸ªMasterä¸Šæ˜¯å¯¹ç­‰çš„ï¼Œæ²¡æœ‰å“ªä¸ªMasterä¸Šæœ‰topicä¸Šçš„å…¨éƒ¨æ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œé€‰ä¸¾leaderæ²¡æœ‰æ„ä¹‰ï¼› RockeqMQé›†ç¾¤ä¸­ï¼Œéœ€è¦æœ‰æ„ä»¶æ¥å¤„ç†ä¸€äº›é€šç”¨æ•°æ®ï¼Œæ¯”å¦‚brokeråˆ—è¡¨ï¼Œbrokeråˆ·æ–°æ—¶é—´ã€‚ è™½ç„¶ZooKeeperä¹Ÿèƒ½å­˜æ”¾æ•°æ®ï¼Œå¹¶æœ‰ä¸€è‡´æ€§ä¿è¯ã€‚ä½†å¤„ç†æ•°æ®ä¹‹é—´çš„ä¸€äº›é€»è¾‘å…³ç³»å´æ¯”è¾ƒéº»çƒ¦ï¼Œè€Œä¸”æ•°æ®çš„é€»è¾‘è§£ææ“ä½œå¾—äº¤ç»™ZooKeeperå®¢æˆ·ç«¯æ¥åšï¼Œå¦‚æœæœ‰å¤šç§è§’è‰²çš„å®¢æˆ·ç«¯å­˜åœ¨ï¼Œè‡ªå·±è§£æå¤šçº§æ•°æ®ç¡®å®æ˜¯ä¸ªéº»çƒ¦äº‹æƒ…ï¼› æ—¢ç„¶RocketMQé›†ç¾¤ä¸­æ²¡æœ‰ç”¨åˆ°ZooKeeperçš„ä¸€äº›é‡é‡çº§çš„åŠŸèƒ½ï¼Œåªæ˜¯ä½¿ç”¨ZooKeeperçš„æ•°æ®ä¸€è‡´æ€§å’Œå‘å¸ƒè®¢é˜…çš„è¯ï¼Œä¸å…¶ä¾èµ–é‡é‡çº§çš„ZooKeeperï¼Œè¿˜ä¸å¦‚å†™ä¸ªè½»é‡çº§çš„NameServerï¼ŒNameServerä¹Ÿå¯ä»¥é›†ç¾¤éƒ¨ç½²ï¼ŒNameServerä¸NameServerä¹‹é—´æ— ä»»ä½•ä¿¡æ¯åŒæ­¥ï¼Œä¸éœ€è¦ä¿éšœæ•°æ®ä¸€è‡´æ€§ï¼Œ æ¯”zkç®€å•å¤ªå¤šã€‚ NameServerç‰¹æ€§ NameServeré€šå¸¸ä¹Ÿæ˜¯é›†ç¾¤çš„æ–¹å¼éƒ¨ç½²ï¼Œå„å®ä¾‹é—´ç›¸äº’ä¸è¿›è¡Œä¿¡æ¯é€šè®¯ã€‚Brokeræ˜¯å‘æ¯ä¸€å°NameServeræ³¨å†Œè‡ªå·±çš„è·¯ç”±ä¿¡æ¯ï¼Œæ‰€ä»¥æ¯ä¸€ä¸ªNameServerå®ä¾‹ä¸Šé¢éƒ½ä¿å­˜ä¸€ä»½å®Œæ•´çš„è·¯ç”±ä¿¡æ¯ã€‚å½“æŸä¸ªNameServerå› æŸç§åŸå› ä¸‹çº¿äº†ï¼ŒBrokerä»ç„¶å¯ä»¥å‘å…¶å®ƒNameServeråŒæ­¥å…¶è·¯ç”±ä¿¡æ¯ï¼ŒProducerï¼ŒConsumerä»ç„¶å¯ä»¥åŠ¨æ€æ„ŸçŸ¥Brokerçš„è·¯ç”±çš„ä¿¡æ¯ã€‚ NameServerå®ä¾‹æ—¶é—´äº’ä¸é€šä¿¡ï¼Œè¿™æœ¬èº«ä¹Ÿæ˜¯å…¶è®¾è®¡äº®ç‚¹ä¹‹ä¸€ï¼Œå³å…è®¸ä¸åŒNameServerä¹‹é—´æ•°æ®ä¸åŒæ­¥(åƒZookeeperé‚£æ ·ä¿è¯å„èŠ‚ç‚¹æ•°æ®å¼ºä¸€è‡´æ€§ä¼šå¸¦æ¥é¢å¤–çš„æ€§èƒ½æ¶ˆè€—) RocketMQ çš„æ¶ˆæ¯ç±»å‹ RocketMQ æ”¯æŒæ™®é€šæ¶ˆæ¯ï¼Œé¡ºåºæ¶ˆæ¯ã€äº‹åŠ¡æ¶ˆæ¯ï¼Œç­‰ç­‰å¤šç§æ¶ˆæ¯ç±»å‹ï¼š æ™®é€šæ¶ˆæ¯ï¼šæ²¡æœ‰ç‰¹æ®ŠåŠŸèƒ½çš„æ¶ˆæ¯ã€‚ åˆ†åŒºé¡ºåºæ¶ˆæ¯ï¼šä»¥åˆ†åŒºçº¬åº¦ä¿æŒé¡ºåºè¿›è¡Œæ¶ˆè´¹çš„æ¶ˆæ¯ã€‚ å…¨å±€é¡ºåºæ¶ˆæ¯ï¼šå…¨å±€é¡ºåºæ¶ˆæ¯å¯ä»¥çœ‹ä½œæ˜¯åªåˆ†ä¸€ä¸ªåŒºï¼Œå§‹ç»ˆåœ¨åŒä¸€ä¸ªåˆ†åŒºä¸Šè¿›è¡Œæ¶ˆè´¹ã€‚ å®šæ—¶/å»¶æ—¶æ¶ˆæ¯ï¼šæ¶ˆæ¯å¯ä»¥å»¶è¿Ÿä¸€æ®µç‰¹å®šæ—¶é—´è¿›è¡Œæ¶ˆè´¹ã€‚ äº‹åŠ¡æ¶ˆæ¯ï¼šäºŒé˜¶æ®µäº‹åŠ¡æ¶ˆæ¯ï¼Œå…ˆè¿›è¡ŒprepareæŠ•é€’æ¶ˆæ¯ï¼Œæ­¤æ—¶ä¸èƒ½è¿›è¡Œæ¶ˆæ¯æ¶ˆè´¹ï¼Œå½“äºŒé˜¶æ®µå‘å‡ºcommitæˆ–è€…rollbackçš„æ—¶å€™æ‰ä¼šè¿›è¡Œæ¶ˆæ¯çš„æ¶ˆè´¹æˆ–è€…å›æ»šã€‚ è™½ç„¶é…ç½®ç§ç±»æ¯”è¾ƒç¹å¤šï¼Œä½†æ˜¯ä½¿ç”¨çš„è¿˜æ˜¯æ™®é€šæ¶ˆæ¯å’Œåˆ†åŒºé¡ºåºæ¶ˆæ¯ã€‚ æœ¬æ–‡çš„ä¸»è¦ä»‹ç»é«˜å¯ç”¨ï¼Œä¸»è¦ä»‹ç»æ™®é€šæ¶ˆæ¯ï¼Œå…¶ä»–æ¶ˆæ¯çš„é«˜å¯ç”¨ç­–ç•¥ï¼Œä¹Ÿæ˜¯ç±»ä¼¼ä¾§ã€‚ RocketMQé«˜å¯ç”¨ NameServer é«˜å¯ç”¨ ç”±äº NameServer èŠ‚ç‚¹æ˜¯æ— çŠ¶æ€çš„ï¼Œä¸”å„ä¸ªèŠ‚ç‚¹ç›´æ¥çš„æ•°æ®æ˜¯ä¸€è‡´çš„ï¼Œæ•…å­˜åœ¨å¤šä¸ª NameServer èŠ‚ç‚¹çš„æƒ…å†µä¸‹ï¼Œéƒ¨åˆ† NameServer ä¸å¯ç”¨ä¹Ÿå¯ä»¥ä¿è¯ MQ æœåŠ¡æ­£å¸¸è¿è¡Œ BrokerServer é«˜å¯ç”¨ RocketMQæ˜¯é€šè¿‡ Master å’Œ Slave çš„é…åˆè¾¾åˆ° BrokerServer æ¨¡å—çš„é«˜å¯ç”¨æ€§çš„ ä¸€ä¸ª Master å¯ä»¥é…ç½®å¤šä¸ª Slaveï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒé…ç½®å¤šä¸ª Master-Slave ç»„ã€‚ å½“å…¶ä¸­ä¸€ä¸ª Master å‡ºç°é—®é¢˜æ—¶ï¼š ç”±äºSlaveåªè´Ÿè´£è¯»ï¼Œå½“ Master ä¸å¯ç”¨ï¼Œå®ƒå¯¹åº”çš„ Slave ä»èƒ½ä¿è¯æ¶ˆæ¯è¢«æ­£å¸¸æ¶ˆè´¹ ç”±äºé…ç½®å¤šç»„ Master-Slave ç»„ï¼Œå…¶ä»–çš„ Master-Slave ç»„ä¹Ÿä¼šä¿è¯æ¶ˆæ¯çš„æ­£å¸¸å‘é€å’Œæ¶ˆè´¹ è€ç‰ˆæœ¬çš„RocketMQä¸æ”¯æŒæŠŠSlaveè‡ªåŠ¨è½¬æˆMasterï¼Œå¦‚æœæœºå™¨èµ„æºä¸è¶³ï¼Œ éœ€è¦æŠŠSlaveè½¬æˆMasterï¼Œåˆ™è¦æ‰‹åŠ¨åœæ­¢Slaveè§’è‰²çš„Brokerï¼Œæ›´æ”¹é…ç½®æ–‡ ä»¶ï¼Œç”¨æ–°çš„é…ç½®æ–‡ä»¶å¯åŠ¨Brokerã€‚ æ–°ç‰ˆæœ¬çš„RocketMQï¼Œæ”¯æŒSlaveè‡ªåŠ¨è½¬æˆMasterã€‚ consumeré«˜å¯ç”¨ Consumer çš„é«˜å¯ç”¨æ˜¯ä¾èµ–äº Master-Slave é…ç½®çš„ï¼Œç”±äº Master èƒ½å¤Ÿæ”¯æŒè¯»å†™æ¶ˆæ¯ï¼ŒSlave æ”¯æŒè¯»æ¶ˆæ¯ï¼Œå½“ Master ä¸å¯ç”¨æˆ–ç¹å¿™æ—¶ï¼Œ Consumer ä¼šè¢«è‡ªåŠ¨åˆ‡æ¢åˆ°ä» Slave è¯»å–(è‡ªåŠ¨åˆ‡æ¢ï¼Œæ— éœ€é…ç½®)ã€‚ æ•…å½“ Master çš„æœºå™¨æ•…éšœåï¼Œæ¶ˆæ¯ä»å¯ä» Slave ä¸­è¢«æ¶ˆè´¹ produceré«˜å¯ç”¨ åœ¨åˆ›å»ºTopicçš„æ—¶å€™ï¼ŒæŠŠTopicçš„å¤šä¸ªMessage Queueåˆ›å»ºåœ¨å¤šä¸ªBrokerç»„ä¸Šï¼ˆç›¸åŒBrokeråç§°ï¼Œä¸åŒ brokerIdçš„æœºå™¨ç»„æˆä¸€ä¸ªBrokerç»„ï¼‰. è¿™æ ·å½“ä¸€ä¸ªBrokerç»„çš„Masterä¸å¯ç”¨åï¼Œå…¶ä»–ç»„çš„Masterä»ç„¶å¯ç”¨ï¼ŒProducerä»ç„¶å¯ä»¥å‘é€æ¶ˆæ¯ã€‚ å®ç°åˆ†å¸ƒå¼é›†ç¾¤å¤šå‰¯æœ¬çš„ä¸‰ç§æ–¹å¼ M/Sæ¨¡å¼ å³Master/Slaveræ¨¡å¼ã€‚ è¯¥æ¨¡å¼åœ¨è¿‡å»ä½¿ç”¨çš„æœ€å¤šï¼ŒRocketMqä¹‹å‰ä¹Ÿæ˜¯ä½¿ç”¨è¿™æ ·çš„ä¸»ä»æ¨¡å¼æ¥å®ç°çš„ã€‚ ä¸»ä»æ¨¡å¼åˆ†ä¸ºåŒæ­¥æ¨¡å¼å’Œå¼‚æ­¥æ¨¡å¼ï¼ŒåŒºåˆ«æ˜¯åœ¨åŒæ­¥æ¨¡å¼ä¸‹åªæœ‰ä¸»ä»å¤åˆ¶å®Œæ¯•æ‰ä¼šè¿”å›ç»™å®¢æˆ·ç«¯ï¼›è€Œåœ¨å¼‚æ­¥æ¨¡å¼ä¸­ï¼Œä¸»ä»çš„å¤åˆ¶æ˜¯å¼‚æ­¥çš„ï¼Œä¸ç”¨ç­‰å¾…å³å¯è¿”å›ã€‚ åŒæ­¥æ¨¡å¼ åŒæ­¥æ¨¡å¼ç‰¹ç‚¹ å¼‚æ­¥æ¨¡å¼ å¼‚æ­¥æ¨¡å¼ç‰¹ç‚¹ åŸºäºzookeeperæœåŠ¡ å’ŒM/Sæ¨¡å¼ç›¸æ¯”zookeeperæ¨¡å¼æ˜¯è‡ªåŠ¨é€‰ä¸¾çš„ä¸»èŠ‚ç‚¹ï¼Œæ–°ç‰ˆæœ¬rocketMqæš‚æ—¶ä¸æ”¯æŒzookeeperã€‚ åŸºäºraft ç›¸æ¯”zookeeperï¼Œraftè‡ªèº«å°±å¯ä»¥å®ç°é€‰ä¸¾ï¼Œrafté€šè¿‡æŠ•ç¥¨çš„æ–¹å¼å®ç°è‡ªèº«é€‰ä¸¾leaderã€‚å»é™¤é¢å¤–ä¾èµ–ã€‚ç›®å‰RocketMq 4.5.0å·²ç»æ”¯æŒ å¯ç”¨æ€§ä¸å¯é æ€§ å¯ç”¨æ€§ ç”±äºæ¶ˆæ¯åˆ†å¸ƒåœ¨å„ä¸ªbrokerä¸Šï¼Œä¸€æ—¦æŸä¸ªbrokerå®•æœºï¼Œåˆ™è¯¥brokerä¸Šçš„æ¶ˆæ¯è¯»å†™éƒ½ä¼šå—åˆ°å½±å“ã€‚æ‰€ä»¥rocketmqæä¾›äº†master/slaveçš„ç»“æ„ï¼Œsalveå®šæ—¶ä»masteråŒæ­¥æ•°æ®ï¼Œå¦‚æœmasterå®•æœºï¼Œåˆ™slaveæä¾›æ¶ˆè´¹æœåŠ¡ï¼Œä½†æ˜¯ä¸èƒ½å†™å…¥æ¶ˆæ¯ï¼Œæ­¤è¿‡ç¨‹å¯¹åº”ç”¨é€æ˜ï¼Œç”±rocketmqå†…éƒ¨è§£å†³ã€‚ è¿™é‡Œæœ‰ä¸¤ä¸ªå…³é”®ç‚¹ï¼š ä¸€æ—¦æŸä¸ªbroker masterå®•æœºï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å¤šä¹…æ‰èƒ½å‘ç°ï¼Ÿå—é™äºrocketmqçš„ç½‘ç»œè¿æ¥æœºåˆ¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæœ€å¤šéœ€è¦30ç§’ï¼Œä½†è¿™ä¸ªæ—¶é—´å¯ç”±åº”ç”¨è®¾å®šå‚æ•°æ¥ç¼©çŸ­æ—¶é—´ã€‚è¿™ä¸ªæ—¶é—´æ®µå†…ï¼Œå‘å¾€è¯¥brokerçš„æ¶ˆæ¯éƒ½æ˜¯å¤±è´¥çš„ï¼Œè€Œä¸”è¯¥brokerçš„æ¶ˆæ¯æ— æ³•æ¶ˆè´¹ï¼Œå› ä¸ºæ­¤æ—¶æ¶ˆè´¹è€…ä¸çŸ¥é“è¯¥brokerå·²ç»æŒ‚æ‰ã€‚ æ¶ˆè´¹è€…å¾—åˆ°masterå®•æœºé€šçŸ¥åï¼Œè½¬å‘slaveæ¶ˆè´¹ï¼Œä½†æ˜¯slaveä¸èƒ½ä¿è¯masterçš„æ¶ˆæ¯100%éƒ½åŒæ­¥è¿‡æ¥äº†ï¼Œå› æ­¤ä¼šæœ‰å°‘é‡çš„æ¶ˆæ¯ä¸¢å¤±ã€‚ä½†æ˜¯æ¶ˆæ¯æœ€ç»ˆä¸ä¼šä¸¢çš„ï¼Œä¸€æ—¦masteræ¢å¤ï¼ŒæœªåŒæ­¥è¿‡å»çš„æ¶ˆæ¯ä¼šè¢«æ¶ˆè´¹æ‰ã€‚ å¯é æ€§ æ‰€æœ‰å‘å¾€brokerçš„æ¶ˆæ¯ï¼Œæœ‰åŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜æœºåˆ¶ï¼Œæ€»çš„æ¥è¯´ï¼Œå¯é æ€§éå¸¸é«˜ åŒæ­¥åˆ·ç›˜æ—¶ï¼Œæ¶ˆæ¯å†™å…¥ç‰©ç†æ–‡ä»¶æ‰ä¼šè¿”å›æˆåŠŸï¼Œå› æ­¤éå¸¸å¯é  å¼‚æ­¥åˆ·ç›˜æ—¶ï¼Œåªæœ‰æœºå™¨å®•æœºï¼Œæ‰ä¼šäº§ç”Ÿæ¶ˆæ¯ä¸¢å¤±ï¼ŒbrokeræŒ‚æ‰å¯èƒ½ä¼šå‘ç”Ÿï¼Œä½†æ˜¯æœºå™¨å®•æœºå´©æºƒæ˜¯å¾ˆå°‘å‘ç”Ÿçš„ï¼Œé™¤éçªç„¶æ–­ç”µ Brokeræ¶ˆæ¯çš„é›¶ä¸¢å¤±æ–¹æ¡ˆ åŒæ­¥åˆ·ç›˜ã€å¼‚æ­¥åˆ·ç›˜ RocketMQçš„æ¶ˆæ¯æ˜¯å­˜å‚¨åˆ°ç£ç›˜ä¸Šçš„ï¼Œè¿™æ ·æ—¢èƒ½ä¿è¯æ–­ç”µåæ¢å¤ï¼Œåˆå¯ä»¥è®©å­˜å‚¨çš„æ¶ˆæ¯é‡è¶…å‡ºå†…å­˜çš„é™åˆ¶ã€‚RocketMQä¸ºäº†æé«˜æ€§èƒ½ï¼Œä¼šå°½å¯èƒ½åœ°ä¿è¯ç£ç›˜çš„é¡ºåºå†™ã€‚ æ¶ˆæ¯åœ¨é€šè¿‡Producerå†™å…¥RocketMQçš„æ—¶å€™ï¼Œæœ‰ä¸¤ç§å†™ç£ç›˜æ–¹å¼ï¼š å¼‚æ­¥åˆ·ç›˜æ–¹å¼ï¼š åœ¨è¿”å›å†™æˆåŠŸçŠ¶æ€æ—¶ï¼Œæ¶ˆæ¯å¯èƒ½åªæ˜¯è¢«å†™å…¥äº†å†…å­˜çš„PAGECACHEï¼Œå†™æ“ä½œçš„è¿”å›å¿«ï¼Œååé‡å¤§ï¼›å½“å†…å­˜é‡Œçš„æ¶ˆæ¯é‡ç§¯ç´¯åˆ°ä¸€å®šç¨‹åº¦æ—¶ï¼Œç»Ÿä¸€è§¦å‘å†™ç£ç›˜æ“ä½œï¼Œå¿«é€Ÿå†™å…¥ ä¼˜ç‚¹ï¼šæ€§èƒ½é«˜ ç¼ºç‚¹ï¼šMasterå®•æœºï¼Œç£ç›˜æŸåçš„æƒ…å†µä¸‹ï¼Œä¼šä¸¢å¤±å°‘é‡çš„æ¶ˆæ¯, å¯¼è‡´MQçš„æ¶ˆæ¯çŠ¶æ€å’Œç”Ÿäº§è€…/æ¶ˆè´¹è€…çš„æ¶ˆæ¯çŠ¶æ€ä¸ä¸€è‡´ åŒæ­¥åˆ·ç›˜æ–¹å¼ï¼š åœ¨è¿”å›åº”ç”¨å†™æˆåŠŸçŠ¶æ€å‰ï¼Œæ¶ˆæ¯å·²ç»è¢«å†™å…¥ç£ç›˜ã€‚ å…·ä½“æµç¨‹æ˜¯ï¼Œæ¶ˆæ¯å†™å…¥å†…å­˜çš„PAGECACHEåï¼Œç«‹åˆ»é€šçŸ¥åˆ·ç›˜çº¿ç¨‹åˆ·ç›˜ï¼Œç„¶åç­‰å¾…åˆ·ç›˜å®Œæˆï¼Œåˆ·ç›˜çº¿ç¨‹æ‰§è¡Œå®Œæˆåå”¤é†’ç­‰å¾…çš„çº¿ç¨‹ï¼Œç»™åº”ç”¨è¿”å›æ¶ˆæ¯å†™æˆåŠŸçš„çŠ¶æ€ã€‚ ä¼˜ç‚¹ï¼šå¯ä»¥ä¿æŒMQçš„æ¶ˆæ¯çŠ¶æ€å’Œç”Ÿäº§è€…/æ¶ˆè´¹è€…çš„æ¶ˆæ¯çŠ¶æ€ä¸€è‡´ ç¼ºç‚¹ï¼šæ€§èƒ½æ¯”å¼‚æ­¥çš„ä½ åŒæ­¥åˆ·ç›˜è¿˜æ˜¯å¼‚æ­¥åˆ·ç›˜ï¼Œæ˜¯é€šè¿‡Brokeré…ç½®æ–‡ä»¶é‡Œçš„flushDiskTypeå‚æ•°è®¾ç½®çš„ï¼Œè¿™ä¸ªå‚æ•°è¢«è®¾ç½®æˆSYNC_FLUSH, ASYNC_FLUSHä¸­çš„ä¸€ä¸ªã€‚ åŒæ­¥å¤åˆ¶ã€å¼‚æ­¥å¤åˆ¶ å¦‚æœä¸€ä¸ªbrokerç»„æœ‰Masterå’ŒSlaveï¼Œæ¶ˆæ¯éœ€è¦ä»Masterå¤åˆ¶åˆ°Slaveä¸Šï¼Œæœ‰åŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§å¤åˆ¶æ–¹å¼ã€‚ åŒæ­¥å¤åˆ¶æ–¹å¼ï¼š ç­‰Masterå’ŒSlaveå‡å†™æˆåŠŸåæ‰åé¦ˆç»™å®¢æˆ·ç«¯å†™æˆåŠŸçŠ¶æ€ ä¼˜ç‚¹ï¼šå¦‚æœMasterå‡ºæ•…éšœï¼ŒSlaveä¸Šæœ‰å…¨éƒ¨çš„å¤‡ä»½æ•°æ®ï¼Œå®¹æ˜“æ¢å¤ï¼Œæ¶ˆè´¹è€…ä»å¯ä»¥ä»Slaveæ¶ˆè´¹, æ¶ˆæ¯ä¸ä¸¢å¤± ç¼ºç‚¹ï¼šå¢å¤§æ•°æ®å†™å…¥å»¶è¿Ÿï¼Œé™ä½ç³»ç»Ÿååé‡ï¼Œæ€§èƒ½æ¯”å¼‚æ­¥å¤åˆ¶æ¨¡å¼ç•¥ä½ï¼Œå¤§çº¦ä½10%å·¦å³ï¼Œå‘é€å•ä¸ªMasterçš„å“åº”æ—¶é—´ä¼šç•¥é«˜ å¼‚æ­¥å¤åˆ¶æ–¹å¼ï¼š åªè¦Masterå†™æˆåŠŸå³å¯åé¦ˆç»™å®¢æˆ·ç«¯å†™æˆåŠŸçŠ¶æ€ ä¼˜ç‚¹ï¼šç³»ç»Ÿæ‹¥æœ‰è¾ƒä½çš„å»¶è¿Ÿå’Œè¾ƒé«˜çš„ååé‡. Masterå®•æœºä¹‹åï¼Œæ¶ˆè´¹è€…ä»å¯ä»¥ä»Slaveæ¶ˆè´¹ï¼Œæ­¤è¿‡ç¨‹å¯¹åº”ç”¨é€æ˜ï¼Œä¸éœ€è¦äººå·¥å¹²é¢„ï¼Œæ€§èƒ½åŒå¤šä¸ªMasteræ¨¡å¼å‡ ä¹ä¸€æ · ç¼ºç‚¹ï¼šå¦‚æœMasterå‡ºäº†æ•…éšœï¼Œæœ‰äº›æ•°æ®å› ä¸ºæ²¡æœ‰è¢«å†™å…¥Slaveï¼Œè€Œä¸¢å¤±å°‘é‡æ¶ˆæ¯ã€‚ è‹¥ä¸€ä¸ª Broker ç»„æœ‰ä¸€ä¸ª Master å’Œ Slaveï¼Œæ¶ˆæ¯éœ€è¦ä» Master å¤åˆ¶åˆ° Slave ä¸Šï¼Œæœ‰åŒæ­¥å¤åˆ¶å’Œå¼‚æ­¥å¤åˆ¶ä¸¤ç§æ–¹å¼ åŒæ­¥å¤åˆ¶ å¼‚æ­¥å¤åˆ¶ æ¦‚å¿µ å³ç­‰ Master å’Œ Slave å‡å†™æˆåŠŸåæ‰åé¦ˆç»™å®¢æˆ·ç«¯å†™æˆåŠŸçŠ¶æ€ åªè¦ Master å†™æˆåŠŸï¼Œå°±åé¦ˆå®¢æˆ·ç«¯å†™æˆåŠŸçŠ¶æ€ å¯é æ€§ å¯é æ€§é«˜ï¼Œè‹¥ Master å‡ºç°æ•…éšœï¼ŒSlave ä¸Šæœ‰å…¨éƒ¨çš„å¤‡ä»½æ•°æ®ï¼Œå®¹æ˜“æ¢å¤ è‹¥ Master å‡ºç°æ•…éšœï¼Œå¯èƒ½å­˜åœ¨ä¸€äº›æ•°æ®è¿˜æ²¡æ¥å¾—åŠå†™å…¥ Slaveï¼Œå¯èƒ½ä¼šä¸¢å¤± æ•ˆç‡ ç”±äºæ˜¯åŒæ­¥å¤åˆ¶ï¼Œä¼šå¢åŠ æ•°æ®å†™å…¥å»¶è¿Ÿï¼Œé™ä½ç³»ç»Ÿååé‡ ç”±äºåªè¦å†™å…¥ Master å³å¯ï¼Œæ•…æ•°æ®å†™å…¥å»¶è¿Ÿè¾ƒä½ï¼Œååé‡è¾ƒé«˜ åŒæ­¥å¤åˆ¶å’Œå¼‚æ­¥å¤åˆ¶æ˜¯é€šè¿‡Brokeré…ç½®æ–‡ä»¶é‡Œçš„brokerRoleå‚æ•°è¿›è¡Œè®¾ç½®çš„ï¼Œè¿™ä¸ªå‚æ•°å¯ä»¥è¢«è®¾ç½®æˆASYNC_MASTERã€SYNC_MASTERã€SLAVEä¸‰ä¸ªå€¼ä¸­çš„ä¸€ä¸ªã€‚ ä¸‰ä¸ªå€¼çš„è¯´æ˜ï¼š sync_masteræ˜¯åŒæ­¥æ–¹å¼ï¼ŒMasterè§’è‰²Brokerä¸­çš„æ¶ˆæ¯è¦ç«‹åˆ»åŒæ­¥è¿‡å»ã€‚ async_masteræ˜¯å¼‚æ­¥æ–¹å¼ï¼ŒMasterè§’è‰²Brokerä¸­çš„æ¶ˆæ¯é€šè¿‡å¼‚æ­¥å¤„ç†çš„æ–¹å¼åŒæ­¥åˆ°Slaveè§’è‰²çš„æœºå™¨ä¸Šã€‚ SLAVE è¡¨æ˜å½“å‰æ˜¯ä»èŠ‚ç‚¹ï¼Œæ— éœ€é…ç½® brokerRole æ¶ˆæ¯é›¶ä¸¢å¤±æ–¹æ¡ˆ æ¶ˆæ¯é›¶ä¸¢å¤±æ˜¯ä¸€æŠŠåŒåˆƒå‰‘ï¼Œè¦æƒ³ç”¨å¥½ï¼Œè¿˜æ˜¯è¦è§†å…·ä½“çš„ä¸šåŠ¡åœºæ™¯ï¼Œåœ¨æ€§èƒ½å’Œæ¶ˆæ¯é›¶ä¸¢å¤±ä¸Šåšå¹³è¡¡ã€‚ å®é™…åº”ç”¨ä¸­çš„æ¨èæŠŠMasterå’ŒSlaveè®¾ç½®æˆASYNC_FLUSHçš„å¼‚æ­¥åˆ·ç›˜æ–¹å¼ï¼Œä¸»ä»ä¹‹é—´é…ç½®æˆSYNC_MASTERçš„åŒæ­¥å¤åˆ¶æ–¹å¼ï¼Œè¿™æ ·å³ä½¿æœ‰ä¸€å°æœºå™¨å‡ºæ•…éšœï¼Œä»ç„¶å¯ä»¥ä¿è¯æ•°æ®ä¸ä¸¢ã€‚ åˆ·ç›˜æ–¹å¼ Masterå’ŒSlaveéƒ½è®¾ç½®æˆASYNC_FLUSHçš„å¼‚æ­¥åˆ·ç›˜ å¤åˆ¶æ–¹å¼ Masteré…ç½®æˆSYNC_MASTER åŒæ­¥å¤åˆ¶ å¼‚æ­¥åˆ·ç›˜èƒ½å¤Ÿé¿å…é¢‘ç¹è§¦å‘ç£ç›˜å†™æ“ä½œï¼Œé™¤éæœåŠ¡å™¨å®•æœºï¼Œå¦åˆ™ä¸ä¼šé€ æˆæ¶ˆæ¯ä¸¢å¤±ã€‚ ä¸»ä»åŒæ­¥å¤åˆ¶èƒ½å¤Ÿä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Œå³ä½¿ Master èŠ‚ç‚¹å¼‚å¸¸ï¼Œä¹Ÿèƒ½ä¿è¯ Slave èŠ‚ç‚¹å­˜å‚¨æ‰€æœ‰æ¶ˆæ¯å¹¶è¢«æ­£å¸¸æ¶ˆè´¹æ‰ã€‚ produceré«˜å¯ç”¨ producerå…·å¤‡å‘é€åˆ°å…¨éƒ¨masterçš„èƒ½åŠ›ï¼Œå¦‚æœæœ‰å¤šä¸ªmasterï¼Œæ¶ˆæ¯ä¼šå‘é€åˆ°æ‰€æœ‰çš„master å¦å¤–ï¼Œåœ¨topicçš„ä¸åŒçš„queueä¹‹é—´ï¼Œproducerè¿˜å…·å¤‡è´Ÿè½½å‡è¡¡èƒ½åŠ›ã€‚ åœ¨å®ä¾‹å‘é€æ¶ˆæ¯æ—¶ï¼Œé»˜è®¤ä¼šè½®è¯¢æ‰€æœ‰è®¢é˜…äº†æ”¹ Topic çš„ broker èŠ‚ç‚¹ä¸Šçš„ message queueï¼Œè®©æ¶ˆæ¯å¹³å‡è½åœ¨ä¸åŒçš„ queue ä¸Šï¼Œè€Œç”±äºè¿™äº› queue æ•£è½åœ¨ä¸åŒçš„ broker èŠ‚ç‚¹ä¸­ï¼Œå³ä½¿æŸä¸ª broker èŠ‚ç‚¹å¼‚å¸¸ï¼Œå…¶ä»–å­˜åœ¨è®¢é˜…äº†è¿™ä¸ª Topic çš„ message queue çš„ broker ä¾ç„¶èƒ½æ¶ˆè´¹æ¶ˆæ¯ æ¶ˆæ¯è€…ä¸šåŠ¡ä»£ç å‡ºç°å¼‚å¸¸æ€ä¹ˆåŠï¼Ÿ å†æ¥çœ‹ä¸€ä¸‹æ¶ˆè´¹è€…çš„ä»£ç ä¸­ç›‘å¬å™¨çš„éƒ¨åˆ†ï¼Œå®ƒè¯´å¦‚æœæ¶ˆæ¯å¤„ç†æˆåŠŸï¼Œé‚£ä¹ˆå°±è¿”å›æ¶ˆæ¯çŠ¶æ€ä¸º CONSUME_SUCCESSï¼Œä¹Ÿæœ‰å¯èƒ½å‘æ”¾ä¼˜æƒ åˆ¸ã€ç§¯åˆ†ç­‰æ“ä½œå‡ºç°äº†å¼‚å¸¸ï¼Œæ¯”å¦‚è¯´æ•°æ®åº“æŒ‚æ‰äº†ã€‚è¿™ä¸ªæ—¶å€™åº”è¯¥æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ consumer.registerMessageListener(new MessageListenerConcurrently() { @Override public ConsumeConcurrentlyStatus consumeMessage(List &lt;MessageExt&gt; list, ConsumeConcurrentlyContext consumeConcurrentlyContext) { // å¯¹æ¶ˆæ¯çš„å¤„ç†ï¼Œæ¯”å¦‚å‘æ”¾ä¼˜æƒ åˆ¸ã€ç§¯åˆ†ç­‰ return ConsumeConcurrentlyStatus.CONSUME_SUCCESS; } }); æˆ‘ä»¬å¯ä»¥æŠŠä»£ç æ”¹ä¸€æ”¹ï¼Œæ•è·å¼‚å¸¸ä¹‹åè¿”å›æ¶ˆæ¯çš„çŠ¶æ€ä¸º RECONSUME_LATER è¡¨ç¤ºç¨åé‡è¯•ã€‚ // è¿™æ¬¡å›è°ƒæ¥å£ï¼Œæ¥æ”¶æ¶ˆæ¯ consumer.registerMessageListener(new MessageListenerConcurrently() { @Override public ConsumeConcurrentlyStatus consumeMessage(List &lt;MessageExt&gt; list, ConsumeConcurrentlyContext consumeConcurrentlyContext) { try { // å¯¹æ¶ˆæ¯çš„å¤„ç†ï¼Œæ¯”å¦‚å‘æ”¾ä¼˜æƒ åˆ¸ã€ç§¯åˆ†ç­‰ return ConsumeConcurrentlyStatus.CONSUME_SUCCESS; } catch (Exception e) { // ä¸‡ä¸€å‘ç”Ÿæ•°æ®åº“å®•æœºç­‰å¼‚å¸¸ï¼Œè¿”å›ç¨åé‡è¯•æ¶ˆæ¯çš„çŠ¶æ€ return ConsumeConcurrentlyStatus.RECONSUME_LATER; } } }); è¿™ä¸ªæ—¶å€™ï¼Œæ¶ˆæ¯ä¼šè¿›å…¥åˆ° RocketMQ çš„é‡è¯•é˜Ÿåˆ—ä¸­ã€‚ é‡è¯•é˜Ÿåˆ— æ¯”å¦‚è¯´æ¶ˆè´¹è€…æ‰€å±çš„æ¶ˆæ¯ç»„åç§°ä¸ºAAAConsumerGroup å…¶é‡è¯•é˜Ÿåˆ—åç§°å°±å«åš**%RETRY%AAAConsumerGroup** é‡è¯•é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯è¿‡ä¸€æ®µæ—¶é—´ä¼šå†æ¬¡å‘é€ç»™æ¶ˆè´¹è€…ï¼Œå¦‚æœè¿˜æ˜¯æ— æ³•æ­£å¸¸æ‰§è¡Œä¼šå†æ¬¡è¿›å…¥é‡è¯•é˜Ÿåˆ— é»˜è®¤é‡è¯•16æ¬¡ï¼Œè¿˜æ˜¯æ— æ³•æ‰§è¡Œï¼Œæ¶ˆæ¯å°±ä¼šä»é‡è¯•é˜Ÿåˆ—è¿›å…¥åˆ°æ­»ä¿¡é˜Ÿåˆ— æ­»ä¿¡é˜Ÿåˆ— é‡è¯•é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯é‡è¯•16æ¬¡ä»»ç„¶æ— æ³•æ‰§è¡Œï¼Œå°†ä¼šè¿›å…¥åˆ°æ­»ä¿¡é˜Ÿåˆ— æ­»ä¿¡é˜Ÿåˆ—çš„åå­—æ˜¯ %DLQ%AAAConsumerGroup æ­»ä¿¡é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å¯ä»¥åå°å¼€ä¸€ä¸ªçº¿ç¨‹ï¼Œè®¢é˜…**%DLQ%AAAConsumerGroup**ï¼Œå¹¶ä¸åœé‡è¯• Customer è´Ÿè½½å‡è¡¡ é›†ç¾¤æ¨¡å¼ åœ¨é›†ç¾¤æ¶ˆè´¹æ¨¡å¼ä¸‹ï¼Œå­˜åœ¨å¤šä¸ªæ¶ˆè´¹è€…åŒæ—¶æ¶ˆè´¹æ¶ˆæ¯ï¼ŒåŒä¸€æ¡æ¶ˆæ¯åªä¼šè¢«æŸä¸€ä¸ªæ¶ˆè´¹è€…è·å–ã€‚å³æ¶ˆæ¯åªéœ€è¦è¢«æŠ•é€’åˆ°è®¢é˜…äº†è¿™ä¸ª Topic çš„æ¶ˆè´¹è€…Groupä¸‹çš„ä¸€ä¸ªå®ä¾‹ä¸­å³å¯ã€‚ æ¶ˆè´¹è€…é‡‡ç”¨ä¸»åŠ¨æ‹‰å»çš„æ–¹å¼æ‹‰å»å¹¶æ¶ˆè´¹ï¼Œåœ¨æ‹‰å–çš„æ—¶å€™éœ€è¦æ˜ç¡®æŒ‡å®šæ‹‰å–é‚£ä¸€æ¡æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€‚ æ¯å½“æœ‰å®ä¾‹å˜æ›´ï¼Œéƒ½ä¼šè§¦å‘ä¸€æ¬¡æ‰€æœ‰æ¶ˆè´¹è€…å®ä¾‹çš„è´Ÿè½½å‡è¡¡ï¼Œè¿™æ˜¯ä¼šæŒ‰ç…§queueçš„æ•°é‡å’Œå®ä¾‹çš„æ•°é‡å¹³å‡åˆ†é… queue ç»™æ¯ä¸ªæ¶ˆè´¹è€…å®ä¾‹ã€‚ æ³¨æ„ï¼š 1ï¼‰åœ¨é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œä¸€ä¸ª queue åªå…è®¸åˆ†é…ç»™ä¸€ä¸ªæ¶ˆè´¹è€…å®ä¾‹ï¼Œè¿™æ˜¯ç”±äºè‹¥å¤šä¸ªå®ä¾‹åŒæ—¶æ¶ˆè´¹ä¸€ä¸ª queue çš„å°ï¼Œç”±äºæ‹‰å–æ“ä½œæ˜¯ç”± consumer ä¸»åŠ¨å‘ç”Ÿçš„ï¼Œå¯èƒ½å¯¼è‡´åŒä¸€ä¸ªæ¶ˆæ¯åœ¨ä¸åŒçš„ consumer å®ä¾‹ä¸­è¢«æ¶ˆè´¹ã€‚æ•…ç®—æ³•ä¿è¯äº†ä¸€ä¸ª queue åªä¼šè¢«ä¸€ä¸ª consumer å®ä¾‹æ¶ˆè´¹ï¼Œä½†ä¸€ä¸ª consumer å®ä¾‹èƒ½å¤Ÿæ¶ˆè´¹å¤šä¸ª queue 2ï¼‰æ§åˆ¶ consumer æ•°é‡ï¼Œåº”å°äº queue æ•°é‡ã€‚è¿™æ˜¯ç”±äºä¸€ä¸ª queue åªå…è®¸åˆ†é…ç»™ä¸€ä¸ª consumer å®ä¾‹ï¼Œè‹¥ consumer å®ä¾‹æ•°é‡å¤šäº queueï¼Œåˆ™å¤šå‡ºçš„ consumer å®ä¾‹æ— æ³•åˆ†é…åˆ° queueæ¶ˆè´¹ï¼Œä¼šæµªè´¹ç³»ç»Ÿèµ„æº å¹¿æ’­æ¨¡å¼ å¹¿æ’­æ¨¡å¼å…¶å®ä¸æ˜¯è´Ÿè½½å‡è¡¡ï¼Œç”±äºæ¯ä¸ªæ¶ˆè´¹è€…éƒ½èƒ½å¤Ÿæ‹¿åˆ°æ‰€æœ‰æ¶ˆæ¯ï¼Œæ•…ä¸èƒ½è¾¾åˆ°è´Ÿè½½å‡è¡¡çš„è¦æ±‚ æ¶ˆè´¹è€…çš„æ¶ˆæ¯é‡è¯• é¡ºåºæ¶ˆæ¯é‡è¯• å¯¹äºé¡ºåºæ¶ˆæ¯ï¼Œä¸ºäº†ä¿è¯æ¶ˆæ¯æ¶ˆè´¹çš„é¡ºåºæ€§ï¼Œå½“consumeræ¶ˆè´¹å¤±è´¥åï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¼šè‡ªåŠ¨ä¸æ–­è¿›è¡Œæ¶ˆæ¯é‡è¯•(æ¯æ¬¡é—´éš”æ—¶é—´ä¸º1s)ï¼Œ è¿™æ—¶ä¼šå¯¼è‡´consumeræ¶ˆè´¹è¢«é˜»å¡çš„æƒ…å†µï¼Œæ•…å¿…é¡»ä¿è¯åº”ç”¨èƒ½å¤ŸåŠæ—¶ç›‘æ§å¹¶å¤„ç†æ¶ˆè´¹å¤±è´¥çš„æƒ…å†µï¼Œé¿å…é˜»å¡ç°è±¡çš„å‘ç”Ÿ æ— åºæ¶ˆæ¯é‡è¯• æ¦‚è¿° æ— åºæ¶ˆæ¯å³æ™®é€šã€å®šæ—¶ã€å»¶æ—¶ã€äº‹åŠ¡æ¶ˆæ¯ï¼Œå½“consumeræ¶ˆè´¹æ¶ˆæ¯å¤±è´¥æ—¶ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®è¿”å›çŠ¶æ€å®ç°æ¶ˆæ¯é‡è¯• æ³¨æ„ï¼šæ— åºæ¶ˆæ¯çš„é‡è¯•åªé’ˆå¯¹é›†ç¾¤æ¶ˆè´¹æ–¹å¼ï¼ˆéå¹¿æ’­æ–¹å¼ï¼‰ç”Ÿæ•ˆ å¹¿æ’­æ–¹å¼ä¸æä¾›å¤±è´¥é‡è¯•ç‰¹æ€§ï¼Œå³æ¶ˆè´¹å¤±è´¥åï¼Œå¤±è´¥çš„æ¶ˆæ¯ä¸å†é‡è¯•ï¼Œè€Œæ˜¯ç»§ç»­æ¶ˆè´¹æ–°æ¶ˆæ¯ é‡è¯•æ¬¡æ•° æ¶ˆæ¯é˜Ÿåˆ— RocketMQ é»˜è®¤å…è®¸æ¯æ¡æ¶ˆæ¯æœ€å¤šé‡è¯• 16 æ¬¡ï¼Œæ¯æ¬¡é‡è¯•çš„é—´éš”æ—¶é—´å¦‚ä¸‹ï¼š ç¬¬å‡ æ¬¡é‡è¯• ä¸ä¸Šæ¬¡é‡è¯•çš„é—´éš”æ—¶é—´ ç¬¬å‡ æ¬¡é‡è¯• ä¸ä¸Šæ¬¡é‡è¯•çš„é—´éš”æ—¶é—´ 1 10 ç§’ 9 7 åˆ†é’Ÿ 2 30 ç§’ 10 8 åˆ†é’Ÿ 3 1 åˆ†é’Ÿ 11 9 åˆ†é’Ÿ 4 2 åˆ†é’Ÿ 12 10 åˆ†é’Ÿ 5 3 åˆ†é’Ÿ 13 20 åˆ†é’Ÿ 6 4 åˆ†é’Ÿ 14 30 åˆ†é’Ÿ 7 5 åˆ†é’Ÿ 15 1 å°æ—¶ 8 6 åˆ†é’Ÿ 16 2 å°æ—¶ å¦‚æœæ¶ˆæ¯é‡è¯• 16 æ¬¡åä»ç„¶å¤±è´¥ï¼Œæ¶ˆæ¯å°†ä¸å†æŠ•é€’ã€‚ å¦‚æœä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°é‡è¯•æ—¶é—´é—´éš”è®¡ç®—ï¼ŒæŸæ¡æ¶ˆæ¯åœ¨ä¸€ç›´æ¶ˆè´¹å¤±è´¥çš„å‰æä¸‹ï¼Œå°†ä¼šåœ¨æ¥ä¸‹æ¥çš„ 4 å°æ—¶ 46 åˆ†é’Ÿä¹‹å†…è¿›è¡Œ 16 æ¬¡é‡è¯•ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´èŒƒå›´æ¶ˆæ¯å°†ä¸å†é‡è¯•æŠ•é€’ã€‚ æ³¨æ„ï¼š ä¸€æ¡æ¶ˆæ¯æ— è®ºé‡è¯•å¤šå°‘æ¬¡ï¼Œè¿™äº›é‡è¯•æ¶ˆæ¯çš„ Message ID ä¸ä¼šæ”¹å˜ã€‚ æ¶ˆæ¯é‡è¯•ç›¸å…³çš„å¤„ç†æ–¹å¼ æ¶ˆè´¹å¤±è´¥åï¼Œéœ€è¦é‡è¯•çš„å¤„ç†æ–¹å¼ é›†ç¾¤æ¶ˆè´¹æ–¹å¼ï¼ˆéå¹¿æ’­æ–¹å¼ï¼‰ä¸‹ï¼Œæ¶ˆæ¯æ¶ˆè´¹å¤±è´¥åæœŸæœ›æ¶ˆæ¯é‡è¯•ï¼Œéœ€è¦åœ¨æ¶ˆæ¯ç›‘å¬å™¨æ¥å£çš„å®ç°ä¸­æ˜ç¡®è¿›è¡Œé…ç½®ï¼ˆä¸‰ç§æ–¹å¼ä»»é€‰ä¸€ç§ï¼‰ï¼š æ–¹å¼ 1ï¼šè¿”å› Action.ReconsumeLaterï¼ˆæ¨èï¼‰ æ–¹å¼ 2ï¼šè¿”å› Null æ–¹å¼ 3ï¼šæŠ›å‡ºå¼‚å¸¸ ç¤ºä¾‹ä»£ç  public class MessageListenerImpl implements MessageListener { @Override public Action consume(Message message, ConsumeContext context) { //æ¶ˆæ¯å¤„ç†é€»è¾‘æŠ›å‡ºå¼‚å¸¸ï¼Œæ¶ˆæ¯å°†é‡è¯• doConsumeMessage(message); //æ–¹å¼ 1ï¼šè¿”å› Action.ReconsumeLaterï¼Œæ¶ˆæ¯å°†é‡è¯• return Action.ReconsumeLater; //æ–¹å¼ 2ï¼šè¿”å› nullï¼Œæ¶ˆæ¯å°†é‡è¯• return null; //æ–¹å¼ 3ï¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œæ¶ˆæ¯å°†é‡è¯• throw new RuntimeException(&quot;Consumer Message exception&quot;); } } é›†ç¾¤æ¶ˆè´¹æ–¹å¼ä¸‹ï¼Œæ¶ˆæ¯æ¶ˆè´¹å¤±è´¥åæœŸæœ›æ¶ˆæ¯é‡è¯•ï¼Œéœ€è¦åœ¨æ¶ˆæ¯ç›‘å¬å™¨æ¥å£çš„å®ç°ä¸­æ˜ç¡®è¿›è¡Œé…ç½® æ¶ˆè´¹å¤±è´¥åï¼Œæ— éœ€é‡è¯•çš„å¤„ç†æ–¹å¼ é›†ç¾¤æ¶ˆè´¹æ–¹å¼ä¸‹ï¼Œæ¶ˆæ¯å¤±è´¥åæœŸæœ›æ¶ˆæ¯ä¸é‡è¯•ï¼Œéœ€è¦æ•è·æ¶ˆè´¹é€»è¾‘ä¸­å¯èƒ½æŠ›å‡ºçš„å¼‚å¸¸ï¼Œæœ€ç»ˆè¿”å› Action.CommitMessageï¼Œæ­¤åè¿™æ¡æ¶ˆæ¯å°†ä¸ä¼šå†é‡è¯•ã€‚ public class MessageListenerImpl implements MessageListener { @Override public Action consume(Message message, ConsumeContext context) { try { doConsumeMessage(message); } catch (Throwable e) { //æ•è·æ¶ˆè´¹é€»è¾‘ä¸­çš„æ‰€æœ‰å¼‚å¸¸ï¼Œå¹¶è¿”å› Action.CommitMessage; return Action.CommitMessage; } //æ¶ˆæ¯å¤„ç†æ­£å¸¸ï¼Œç›´æ¥è¿”å› Action.CommitMessage; return Action.CommitMessage; } } 3ï¼‰è‡ªå®šä¹‰æ¶ˆæ¯æœ€å¤§é‡è¯•æ¬¡æ•° æ¶ˆæ¯é˜Ÿåˆ— RocketMQ å…è®¸ Consumer å¯åŠ¨çš„æ—¶å€™è®¾ç½®æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œé‡è¯•æ—¶é—´é—´éš”å°†æŒ‰ç…§å¦‚ä¸‹ç­–ç•¥ï¼š æœ€å¤§é‡è¯•æ¬¡æ•°å°äºç­‰äº 16 æ¬¡ï¼Œåˆ™é‡è¯•æ—¶é—´é—´éš”åŒä¸Šè¡¨æè¿°ã€‚ æœ€å¤§é‡è¯•æ¬¡æ•°å¤§äº 16 æ¬¡ï¼Œè¶…è¿‡ 16 æ¬¡çš„é‡è¯•æ—¶é—´é—´éš”å‡ä¸ºæ¯æ¬¡ 2 å°æ—¶ã€‚ è®¾ç½®æ–¹å¼ï¼š consumer.setMaxReconsumeTimes(20); æˆ–è€…ï¼š Properties properties = new Properties(); //é…ç½®å¯¹åº” Group ID çš„æœ€å¤§æ¶ˆæ¯é‡è¯•æ¬¡æ•°ä¸º 20 æ¬¡ï¼Œæœ€å¤§é‡è¯•æ¬¡æ•°ä¸ºå­—ç¬¦ä¸²ç±»å‹ properties.put(PropertyKeyConst.MaxReconsumeTimes,&quot;20&quot;); Consumer consumer =ONSFactory.createConsumer(properties); æ³¨æ„ï¼š æ¶ˆæ¯æœ€å¤§é‡è¯•æ¬¡æ•°è®¾ç½®ï¼Œå¯¹ç›¸åŒ Group ID ä¸‹çš„æ‰€æœ‰ Consumer å®ä¾‹æœ‰æ•ˆã€‚ å¦‚æœåªå¯¹ç›¸åŒ Group ID ä¸‹ä¸¤ä¸ª Consumer å®ä¾‹ä¸­çš„å…¶ä¸­ä¸€ä¸ªè®¾ç½®äº† MaxReconsumeTimesï¼Œé‚£ä¹ˆè¯¥é…ç½®å¯¹ä¸¤ä¸ª Consumer å®ä¾‹å‡ç”Ÿæ•ˆã€‚ é…ç½®é‡‡ç”¨è¦†ç›–çš„æ–¹å¼ç”Ÿæ•ˆï¼Œå³æœ€åå¯åŠ¨çš„ Consumer å®ä¾‹ä¼šè¦†ç›–ä¹‹å‰çš„å¯åŠ¨å®ä¾‹çš„é…ç½® è·å–æ¶ˆæ¯é‡è¯•æ¬¡æ•° æ¶ˆè´¹è€…æ”¶åˆ°æ¶ˆæ¯åï¼Œå¯ä»¥è·å–åˆ°æ¶ˆæ¯çš„é‡è¯•æ¬¡æ•° è®¾ç½®æ–¹å¼ï¼š public class MessageListenerImpl implements MessageListener { @Override public Action consume(Message message, ConsumeContext context) { //è·å–æ¶ˆæ¯çš„é‡è¯•æ¬¡æ•° System.out.println(message.getReconsumeTimes()); return Action.CommitMessage; } } æ­»ä¿¡é˜Ÿåˆ— æ­»ä¿¡é˜Ÿåˆ—æ¦‚å¿µ åœ¨æ­£å¸¸æƒ…å†µä¸‹æ— æ³•è¢«æ¶ˆè´¹(è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°)çš„æ¶ˆæ¯ç§°ä¸ºæ­»ä¿¡æ¶ˆæ¯(Dead-Letter Message)ï¼Œå­˜å‚¨æ­»ä¿¡æ¶ˆæ¯çš„ç‰¹æ®Šé˜Ÿåˆ—å°±ç§°ä¸ºæ­»ä¿¡é˜Ÿåˆ—(Dead-Letter Queue) å½“ä¸€æ¡æ¶ˆæ¯åˆæ¬¡æ¶ˆè´¹å¤±è´¥ï¼Œæ¶ˆæ¯é˜Ÿåˆ— RocketMQ ä¼šè‡ªåŠ¨è¿›è¡Œæ¶ˆæ¯é‡è¯•ï¼› è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°åï¼Œè‹¥æ¶ˆè´¹ä¾ç„¶å¤±è´¥ï¼Œåˆ™è¡¨æ˜æ¶ˆè´¹è€…åœ¨æ­£å¸¸æƒ…å†µä¸‹æ— æ³•æ­£ç¡®åœ°æ¶ˆè´¹è¯¥æ¶ˆæ¯ï¼Œæ­¤æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ— RocketMQ ä¸ä¼šç«‹åˆ»å°†æ¶ˆæ¯ä¸¢å¼ƒï¼Œè€Œæ˜¯å°†å…¶å‘é€åˆ°è¯¥æ¶ˆè´¹è€…å¯¹åº”çš„æ­»ä¿¡é˜Ÿåˆ—ä¸­ã€‚ ä»£ç æ­£å¸¸æ‰§è¡Œè¿”å›æ¶ˆæ¯çŠ¶æ€ä¸ºCONSUME_SUCCESSï¼Œæ‰§è¡Œå¼‚å¸¸è¿”å›RECONSUME_LATER çŠ¶æ€ä¸ºRECONSUME_LATERçš„æ¶ˆæ¯ä¼šè¿›å…¥åˆ°é‡è¯•é˜Ÿåˆ—ï¼Œé‡è¯•é˜Ÿåˆ—çš„åç§°ä¸º %RETRY% + ConsumerGroupNameï¼› é‡è¯•16æ¬¡æ¶ˆæ¯ä»»ç„¶æ²¡æœ‰å¤„ç†æˆåŠŸï¼Œæ¶ˆæ¯å°±ä¼šè¿›å…¥åˆ°æ­»ä¿¡é˜Ÿåˆ—%DLQ% + ConsumerGroupName; æ­»ä¿¡ç‰¹æ€§ æ­»ä¿¡æ¶ˆæ¯æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š ä¸ä¼šå†è¢«æ¶ˆè´¹è€…æ­£å¸¸æ¶ˆè´¹ æœ‰æ•ˆæœŸä¸æ­£å¸¸æ¶ˆæ¯ç›¸åŒï¼Œå‡ä¸º 3 å¤©ï¼Œ3 å¤©åä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚æ•…æ­»ä¿¡æ¶ˆæ¯åº”åœ¨äº§ç”Ÿçš„ 3 å¤©å†…åŠæ—¶å¤„ç† æ­»ä¿¡é˜Ÿåˆ—æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š ä¸€ä¸ªæ­»ä¿¡é˜Ÿåˆ—å¯¹åº”ä¸€ä¸ªæ¶ˆè´¹è€…ç»„ï¼Œè€Œä¸æ˜¯å¯¹åº”å•ä¸ªæ¶ˆè´¹è€…å®ä¾‹ ä¸€ä¸ªæ­»ä¿¡é˜Ÿåˆ—åŒ…å«äº†å¯¹åº”çš„ Group ID æ‰€äº§ç”Ÿçš„æ‰€æœ‰æ­»ä¿¡æ¶ˆæ¯ï¼Œä¸è®ºè¯¥æ¶ˆæ¯å±äºå“ªä¸ª Topic è‹¥ä¸€ä¸ª Group ID æ²¡æœ‰äº§ç”Ÿè¿‡æ­»ä¿¡æ¶ˆæ¯ï¼Œåˆ™ RocketMQ ä¸ä¼šä¸ºå…¶åˆ›å»ºç›¸åº”çš„æ­»ä¿¡é˜Ÿåˆ— æŸ¥çœ‹æ­»ä¿¡ä¿¡æ¯å’Œé‡å‘ åœ¨æ§åˆ¶å°æŸ¥çœ‹æ­»ä¿¡é˜Ÿåˆ—çš„ä¸»é¢˜ä¿¡æ¯ é‡å‘æ¶ˆæ¯ æ¶ˆæ¯å¹‚ç­‰æ€§ æ¶ˆè´¹å¹‚ç­‰ æ¶ˆè´¹å¹‚ç­‰å³æ— è®ºæ¶ˆè´¹è€…æ¶ˆè´¹å¤šå°‘æ¬¡ï¼Œå…¶ç»“æœéƒ½æ˜¯ä¸€æ ·çš„ã€‚ RocketMQ æ˜¯é€šè¿‡ä¸šåŠ¡ä¸Šçš„å”¯ä¸€ Key æ¥å¯¹æ¶ˆæ¯åšå¹‚ç­‰å¤„ç† æ¶ˆè´¹å¹‚ç­‰çš„å¿…è¦æ€§ åœ¨ç½‘ç»œç¯å¢ƒä¸­ï¼Œç”±äºç½‘ç»œä¸ç¨³å®šç­‰å› ç´ ï¼Œæ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆæ¯æœ‰å¯èƒ½å‡ºç°é‡å¤ï¼Œå¤§æ¦‚æœ‰ä»¥ä¸‹å‡ ç§ï¼š å‘é€æ—¶æ¶ˆæ¯é‡å¤ å½“ä¸€æ¡æ¶ˆæ¯å·²è¢«æˆåŠŸå‘é€åˆ°æœåŠ¡ç«¯å¹¶å®ŒæˆæŒä¹…åŒ–ï¼Œæ­¤æ—¶å‡ºç°äº†ç½‘ç»œé—ªæ–­æˆ–è€…å®¢æˆ·ç«¯å®•æœºï¼Œå¯¼è‡´æœåŠ¡ç«¯å¯¹å®¢æˆ·ç«¯åº”ç­”å¤±è´¥ã€‚ å¦‚æœæ­¤æ—¶ç”Ÿäº§è€…æ„è¯†åˆ°æ¶ˆæ¯å‘é€å¤±è´¥å¹¶å°è¯•å†æ¬¡å‘é€æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…åç»­ä¼šæ”¶åˆ°ä¸¤æ¡å†…å®¹ç›¸åŒå¹¶ä¸” Message ID ä¹Ÿç›¸åŒçš„æ¶ˆæ¯ã€‚ æŠ•é€’æ—¶æ¶ˆæ¯é‡å¤ æ¶ˆæ¯æ¶ˆè´¹çš„åœºæ™¯ä¸‹ï¼Œæ¶ˆæ¯å·²æŠ•é€’åˆ°æ¶ˆè´¹è€…å¹¶å®Œæˆä¸šåŠ¡å¤„ç†ï¼Œå½“å®¢æˆ·ç«¯ç»™æœåŠ¡ç«¯åé¦ˆåº”ç­”çš„æ—¶å€™ç½‘ç»œé—ªæ–­ã€‚ ä¸ºäº†ä¿è¯æ¶ˆæ¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡ï¼Œæ¶ˆæ¯é˜Ÿåˆ— RocketMQ çš„æœåŠ¡ç«¯å°†åœ¨ç½‘ç»œæ¢å¤åå†æ¬¡å°è¯•æŠ•é€’ä¹‹å‰å·²è¢«å¤„ç†è¿‡çš„æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…åç»­ä¼šæ”¶åˆ°ä¸¤æ¡å†…å®¹ç›¸åŒå¹¶ä¸” Message ID ä¹Ÿç›¸åŒçš„æ¶ˆæ¯ã€‚ è´Ÿè½½å‡è¡¡æ—¶æ¶ˆæ¯é‡å¤ï¼ˆåŒ…æ‹¬ä½†ä¸é™äºç½‘ç»œæŠ–åŠ¨ã€Broker é‡å¯ä»¥åŠè®¢é˜…æ–¹åº”ç”¨é‡å¯ï¼‰ å½“æ¶ˆæ¯é˜Ÿåˆ— RocketMQ çš„ Broker æˆ–å®¢æˆ·ç«¯é‡å¯ã€æ‰©å®¹æˆ–ç¼©å®¹æ—¶ï¼Œä¼šè§¦å‘ Rebalanceï¼Œæ­¤æ—¶æ¶ˆè´¹è€…å¯èƒ½ä¼šæ”¶åˆ°é‡å¤æ¶ˆæ¯ã€‚ ç»“åˆä¸‰ç§æƒ…å†µï¼Œå¯ä»¥å‘ç°æ¶ˆæ¯é‡å‘çš„æœ€åç»“æœéƒ½æ˜¯ï¼Œæ¶ˆè´¹è€…æ¥æ”¶åˆ°äº†é‡å¤æ¶ˆæ¯ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨æ¶ˆè´¹è€…ç«¯ç»Ÿä¸€è¿›è¡Œå¹‚ç­‰å¤„ç†å°±èƒ½å¤Ÿå®ç°æ¶ˆæ¯å¹‚ç­‰ã€‚ å¤„ç†æ–¹å¼ æ¶ˆè´¹ç«¯å®ç°æ¶ˆæ¯å¹‚ç­‰æ€§ RocketMQ åªèƒ½å¤Ÿä¿è¯æ¶ˆæ¯ä¸¢å¤±ï¼Œä½†ä¸èƒ½ä¿è¯æ¶ˆæ¯ä¸é‡å¤æŠ•é€’ï¼Œä¸”ç”±äºé«˜å¯ç”¨å’Œé«˜æ€§èƒ½çš„è€ƒè™‘ï¼Œåº”è¯¥åœ¨æ¶ˆè´¹ç«¯å®ç°æ¶ˆæ¯å¹‚ç­‰æ€§ã€‚ é‚£ä¹ˆ RocketMQ æ˜¯æ€æ ·è§£å†³æ¶ˆæ¯é‡å¤çš„é—®é¢˜å‘¢ï¼Ÿè¿˜æ˜¯â€œæ°å¥½â€ä¸è§£å†³ã€‚ é€ æˆæ¶ˆæ¯é‡å¤çš„æ ¹æœ¬åŸå› æ˜¯ï¼šç½‘ç»œä¸å¯è¾¾ã€‚åªè¦é€šè¿‡ç½‘ç»œäº¤æ¢æ•°æ®ï¼Œå°±æ— æ³•é¿å…è¿™ä¸ªé—®é¢˜ã€‚æ‰€ä»¥è§£å†³è¿™ä¸ªé—®é¢˜çš„åŠæ³•å°±æ˜¯ç»•è¿‡è¿™ä¸ªé—®é¢˜ã€‚é‚£ä¹ˆé—®é¢˜å°±å˜æˆäº†ï¼šå¦‚æœæ¶ˆè´¹ç«¯æ”¶åˆ°ä¸¤æ¡ä¸€æ ·çš„æ¶ˆæ¯ï¼Œåº”è¯¥æ€æ ·å¤„ç†ï¼Ÿ æ¶ˆè´¹ç«¯å¤„ç†æ¶ˆæ¯çš„ä¸šåŠ¡é€»è¾‘ä¿æŒå¹‚ç­‰æ€§ ä¿è¯æ¯æ¡æ¶ˆæ¯éƒ½æœ‰å”¯ä¸€ç¼–å·ä¸”ä¿è¯æ¶ˆæ¯å¤„ç†æˆåŠŸä¸å»é‡è¡¨çš„æ—¥å¿—åŒæ—¶å‡ºç° ç¬¬1æ¡å¾ˆå¥½ç†è§£ï¼Œåªè¦ä¿æŒå¹‚ç­‰æ€§ï¼Œä¸ç®¡æ¥å¤šå°‘æ¡é‡å¤æ¶ˆæ¯ï¼Œæœ€åå¤„ç†çš„ç»“æœéƒ½ä¸€æ ·ã€‚ ç¬¬2æ¡åŸç†å°±æ˜¯åˆ©ç”¨ä¸€å¼ æ—¥å¿—è¡¨æ¥è®°å½•å·²ç»å¤„ç†æˆåŠŸçš„æ¶ˆæ¯çš„IDï¼Œå¦‚æœæ–°åˆ°çš„æ¶ˆæ¯IDå·²ç»åœ¨æ—¥å¿—è¡¨ä¸­ï¼Œé‚£ä¹ˆå°±ä¸å†å¤„ç†è¿™æ¡æ¶ˆæ¯ã€‚ ç¬¬1æ¡è§£å†³æ–¹æ¡ˆï¼Œå¾ˆæ˜æ˜¾åº”è¯¥åœ¨æ¶ˆè´¹ç«¯å®ç°ï¼Œä¸å±äºæ¶ˆæ¯ç³»ç»Ÿè¦å®ç°çš„åŠŸèƒ½ã€‚ç¬¬2æ¡å¯ä»¥æ¶ˆæ¯ç³»ç»Ÿå®ç°ï¼Œä¹Ÿå¯ä»¥ä¸šåŠ¡ç«¯å®ç°ã€‚æ­£å¸¸æƒ…å†µä¸‹å‡ºç°é‡å¤æ¶ˆæ¯çš„æ¦‚ç‡å…¶å®å¾ˆå°ï¼Œå¦‚æœç”±æ¶ˆæ¯ç³»ç»Ÿæ¥å®ç°çš„è¯ï¼Œè‚¯å®šä¼šå¯¹æ¶ˆæ¯ç³»ç»Ÿçš„ååé‡å’Œé«˜å¯ç”¨æœ‰å½±å“ï¼Œæ‰€ä»¥æœ€å¥½è¿˜æ˜¯ç”±ä¸šåŠ¡ç«¯è‡ªå·±å¤„ç†æ¶ˆæ¯é‡å¤çš„é—®é¢˜ï¼Œè¿™ä¹Ÿæ˜¯ RocketMQ ä¸è§£å†³æ¶ˆæ¯é‡å¤çš„é—®é¢˜çš„åŸå› ã€‚ RocketMQ ä¸ä¿è¯æ¶ˆæ¯ä¸é‡å¤ï¼Œå¦‚æœä½ çš„ä¸šåŠ¡éœ€è¦ä¿è¯ä¸¥æ ¼çš„ä¸é‡å¤æ¶ˆæ¯ï¼Œéœ€è¦ä½ è‡ªå·±åœ¨ä¸šåŠ¡ç«¯å»é‡ã€‚ åœ¨æ¶ˆè´¹ç«¯é€šè¿‡ä¸šåŠ¡é€»è¾‘å®ç°å¹‚ç­‰æ€§æ“ä½œï¼Œæœ€å¸¸ç”¨çš„æ–¹å¼å°±æ˜¯å”¯ä¸€IDçš„å½¢å¼ï¼Œè‹¥å·²ç»æ¶ˆè´¹è¿‡çš„æ¶ˆæ¯å°±ä¸è¿›è¡Œå¤„ç†ã€‚ä¾‹å¦‚åœ¨ç§’æ€ç³»ç»Ÿä¸­ä½¿ç”¨è®¢å•IDä½œä¸ºå…³é”®IDï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¸¸ç”¨é›ªèŠ±ç®—æ³•ç”ŸæˆIDã€‚ æ³¨ï¼šå¦‚æœéœ€è¦å½»åº•äº†è§£é›ªèŠ±ç®—æ³•ï¼Œä»¥åŠé‡Œè¾¹çš„ä½è¿ç®—é€»è¾‘ï¼Œè¯·å‚è§å°¼æ©çš„ç§’æ€è§†é¢‘ã€‚ åœ¨å‘é€æ¶ˆæ¯æ—¶ï¼Œå¯ä»¥å¯¹ Message è®¾ç½®æ ‡è¯†å”¯ä¸€æ ‡è¯†ï¼š Message message = new Message(); # è®¾ç½®å”¯ä¸€æ ‡è¯†ï¼Œæ ‡è¯†ç”±é›ªèŠ±ç®—æ³•ç”Ÿæˆmessage.setKey(idWorker.nextId()); è®¢é˜…æ–¹æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œå¯ä»¥è·å–åˆ°è¿™ä¸ª Key consumer.registerMessageListener(new MessageListenerConcurrently() { @Override public ConsumeConcurrentlyStatus consumeMessage(List&lt;MessageExt&gt; msgs, ConsumeConcurrentlyContext context) { System.out.printf(&quot;%s Receive New Messages: %s %n&quot;, Thread.currentThread().getName(), msgs); for (MessageExt ext : msgs) { System.out.println(ext.getKeys()); } return ConsumeConcurrentlyStatus.CONSUME_SUCCESS; } }); ä¸€ã€é¡ºåºæ¶ˆæ¯ é¡ºåºæ¶ˆæ¯ï¼ˆFIFO æ¶ˆæ¯ï¼‰æ˜¯æ¶ˆæ¯é˜Ÿåˆ— RocketMQ æä¾›çš„ä¸€ç§ä¸¥æ ¼æŒ‰ç…§é¡ºåºæ¥å‘å¸ƒå’Œæ¶ˆè´¹çš„æ¶ˆæ¯ã€‚é¡ºåºå‘å¸ƒå’Œé¡ºåºæ¶ˆè´¹æ˜¯æŒ‡å¯¹äºæŒ‡å®šçš„ä¸€ä¸ª Topicï¼Œç”Ÿ äº§è€…æŒ‰ç…§ä¸€å®šçš„å…ˆåé¡ºåºå‘å¸ƒæ¶ˆæ¯ï¼›æ¶ˆè´¹è€…æŒ‰ç…§æ—¢å®šçš„å…ˆåé¡ºåºè®¢é˜…æ¶ˆæ¯ï¼Œå³å…ˆå‘å¸ƒçš„æ¶ˆæ¯ä¸€å®šä¼šå…ˆè¢«å®¢æˆ·ç«¯æ¥æ”¶åˆ°ã€‚ é¡ºåºæ¶ˆæ¯åˆ†ä¸ºå…¨å±€é¡ºåºæ¶ˆæ¯å’Œåˆ†åŒºé¡ºåºæ¶ˆæ¯ã€‚ 1.1ã€å…¨å±€é¡ºåºæ¶ˆæ¯ RocketMQ åœ¨é»˜è®¤æƒ…å†µä¸‹ä¸ä¿è¯é¡ºåºï¼Œè¦ä¿è¯å…¨å±€é¡ºåºï¼Œéœ€è¦æŠŠ Topic çš„è¯»å†™é˜Ÿåˆ—æ•°è®¾ç½®ä¸º 1ï¼Œç„¶åç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å¹¶å‘è®¾ç½®ä¹Ÿæ˜¯ 1ã€‚æ‰€ä»¥è¿™æ ·çš„è¯ é«˜å¹¶å‘ï¼Œé«˜ååé‡çš„åŠŸèƒ½å®Œå…¨ç”¨ä¸ä¸Šã€‚ 1.1.1ã€é€‚ç”¨åœºæ™¯ é€‚ç”¨äºæ€§èƒ½è¦æ±‚ä¸é«˜ï¼Œæ‰€æœ‰çš„æ¶ˆæ¯ä¸¥æ ¼æŒ‰ç…§ FIFO åŸåˆ™æ¥å‘å¸ƒå’Œæ¶ˆè´¹çš„åœºæ™¯ã€‚ 1.1.2ã€ç¤ºä¾‹ è¦ç¡®ä¿å…¨å±€é¡ºåºæ¶ˆæ¯ï¼Œéœ€è¦å…ˆæŠŠ Topic çš„è¯»å†™é˜Ÿåˆ—æ•°è®¾ç½®ä¸º 1ï¼Œç„¶åç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å¹¶å‘è®¾ç½®ä¹Ÿæ˜¯ 1ã€‚ mqadmin update Topic -t AllOrder -c DefaultCluster -r 1 -w 1 -n 127.0.0.1:9876 åœ¨è¯åˆ¸å¤„ç†ä¸­ï¼Œä»¥äººæ°‘å¸å…‘æ¢ç¾å…ƒä¸º Topicï¼Œåœ¨ä»·æ ¼ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œå…ˆå‡ºä»·è€…ä¼˜å…ˆå¤„ç†ï¼Œåˆ™å¯ä»¥æŒ‰ç…§ FIFO çš„æ–¹å¼å‘å¸ƒå’Œæ¶ˆè´¹å…¨å±€é¡ºåºæ¶ˆæ¯ã€‚ 1.2ã€éƒ¨åˆ†é¡ºåºæ¶ˆæ¯ å¯¹äºæŒ‡å®šçš„ä¸€ä¸ª Topicï¼Œæ‰€æœ‰æ¶ˆæ¯æ ¹æ® Sharding Key è¿›è¡ŒåŒºå—åˆ†åŒºã€‚åŒä¸€ä¸ªåˆ†åŒºå†…çš„æ¶ˆæ¯æŒ‰ç…§ä¸¥æ ¼çš„ FIFO é¡ºåºè¿›è¡Œå‘å¸ƒå’Œæ¶ˆè´¹ã€‚Sharding Key æ˜¯é¡º åºæ¶ˆæ¯ä¸­ç”¨æ¥åŒºåˆ†ä¸åŒåˆ†åŒºçš„å…³é”®å­—æ®µï¼Œå’Œæ™®é€šæ¶ˆæ¯çš„ Key æ˜¯å®Œå…¨ä¸åŒçš„æ¦‚å¿µã€‚ äºŒã€å»¶æ—¶æ¶ˆæ¯ 2.1ã€æ¦‚å¿µä»‹ç» å»¶æ—¶æ¶ˆæ¯ï¼šProducer å°†æ¶ˆæ¯å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ— RocketMQ æœåŠ¡ç«¯ï¼Œä½†å¹¶ä¸æœŸæœ›è¿™æ¡æ¶ˆæ¯ç«‹é©¬æŠ•é€’ï¼Œè€Œæ˜¯å»¶è¿Ÿä¸€å®šæ—¶é—´åæ‰æŠ•é€’åˆ° Consumer è¿›è¡Œæ¶ˆè´¹ï¼Œ è¯¥æ¶ˆæ¯å³å»¶æ—¶æ¶ˆæ¯ã€‚ 2.2ã€é€‚ç”¨åœºæ™¯ æ¶ˆæ¯ç”Ÿäº§å’Œæ¶ˆè´¹æœ‰æ—¶é—´çª—å£è¦æ±‚ï¼šæ¯”å¦‚åœ¨ç”µå•†äº¤æ˜“ä¸­è¶…æ—¶æœªæ”¯ä»˜å…³é—­è®¢å•çš„åœºæ™¯ï¼Œåœ¨è®¢å•åˆ›å»ºæ—¶ä¼šå‘é€ä¸€æ¡å»¶æ—¶æ¶ˆæ¯ã€‚è¿™æ¡æ¶ˆæ¯å°†ä¼šåœ¨ 30 åˆ†é’Ÿä»¥ åæŠ•é€’ç»™æ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…æ”¶åˆ°æ­¤æ¶ˆæ¯åéœ€è¦åˆ¤æ–­å¯¹åº”çš„è®¢å•æ˜¯å¦å·²å®Œæˆæ”¯ä»˜ã€‚ å¦‚æ”¯ä»˜æœªå®Œæˆï¼Œåˆ™å…³é—­è®¢å•ã€‚å¦‚å·²å®Œæˆæ”¯ä»˜åˆ™å¿½ç•¥ã€‚ 2.3ã€ä½¿ç”¨æ–¹å¼ Apache RocketMQ ç›®å‰åªæ”¯æŒå›ºå®šç²¾åº¦çš„å®šæ—¶æ¶ˆæ¯ï¼Œå› ä¸ºå¦‚æœè¦æ”¯æŒä»»æ„çš„æ—¶é—´ç²¾åº¦ï¼Œåœ¨ Broker å±‚é¢ï¼Œå¿…é¡»è¦åšæ¶ˆæ¯æ’åºï¼Œå¦‚æœå†æ¶‰åŠåˆ°æŒä¹…åŒ–ï¼Œ é‚£ä¹ˆæ¶ˆæ¯æ’åºè¦ä¸å¯é¿å…çš„äº§ç”Ÿå·¨å¤§æ€§èƒ½å¼€é”€ã€‚ï¼ˆé˜¿é‡Œäº‘ RocketMQ æä¾›äº†ä»»æ„æ—¶åˆ»çš„å®šæ—¶æ¶ˆæ¯åŠŸèƒ½ï¼ŒApache çš„ RocketMQ å¹¶æ²¡æœ‰,é˜¿é‡Œå¹¶æ²¡æœ‰å¼€æºï¼‰ å‘é€å»¶æ—¶æ¶ˆæ¯æ—¶éœ€è¦è®¾å®šä¸€ä¸ªå»¶æ—¶æ—¶é—´é•¿åº¦ï¼Œæ¶ˆæ¯å°†ä»å½“å‰å‘é€æ—¶é—´ç‚¹å¼€å§‹å»¶è¿Ÿå›ºå®šæ—¶é—´ä¹‹åæ‰å¼€å§‹æŠ•é€’ã€‚ å»¶è¿Ÿæ¶ˆæ¯æ˜¯æ ¹æ®å»¶è¿Ÿé˜Ÿåˆ—çš„ level æ¥çš„ï¼Œå»¶è¿Ÿé˜Ÿåˆ—é»˜è®¤æ˜¯ **msg.setDelayTimeLevel(5)**ä»£è¡¨å»¶è¿Ÿä¸€åˆ†é’Ÿ &quot;1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h&quot; æ˜¯è¿™ 18 ä¸ªç­‰çº§ï¼ˆç§’ï¼ˆsï¼‰ã€åˆ†ï¼ˆmï¼‰ã€å°æ—¶ï¼ˆhï¼‰ï¼‰ï¼Œlevel ä¸º 1ï¼Œè¡¨ç¤ºå»¶è¿Ÿ 1 ç§’åæ¶ˆè´¹ï¼Œlevel ä¸º 5 è¡¨ç¤ºå»¶è¿Ÿ 1 åˆ†é’Ÿåæ¶ˆè´¹ï¼Œlevel ä¸º 18 è¡¨ç¤ºå»¶è¿Ÿ 2 ä¸ª å°æ—¶æ¶ˆè´¹ã€‚ç”Ÿäº§æ¶ˆæ¯è·Ÿæ™®é€šçš„ç”Ÿäº§æ¶ˆæ¯ç±»ä¼¼ï¼Œåªéœ€è¦åœ¨æ¶ˆæ¯ä¸Šè®¾ç½®å»¶è¿Ÿé˜Ÿåˆ—çš„ level å³å¯ã€‚æ¶ˆè´¹æ¶ˆæ¯è·Ÿæ™®é€šçš„æ¶ˆè´¹æ¶ˆæ¯ä¸€è‡´ã€‚ ä¸‰ã€æ­»ä¿¡é˜Ÿåˆ— 3.1ã€æ¦‚å¿µä»‹ç» æ­»ä¿¡é˜Ÿåˆ—ç”¨äºå¤„ç†æ— æ³•è¢«æ­£å¸¸æ¶ˆè´¹çš„æ¶ˆæ¯ã€‚å½“ä¸€æ¡æ¶ˆæ¯åˆæ¬¡æ¶ˆè´¹å¤±è´¥ï¼Œæ¶ˆæ¯é˜Ÿåˆ— MQ ä¼šè‡ªåŠ¨è¿›è¡Œæ¶ˆæ¯é‡è¯•ï¼›è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°åï¼Œè‹¥æ¶ˆè´¹ä¾ç„¶å¤±è´¥ï¼Œ åˆ™è¡¨æ˜Consumer åœ¨æ­£å¸¸æƒ…å†µä¸‹æ— æ³•æ­£ç¡®åœ°æ¶ˆè´¹è¯¥æ¶ˆæ¯ã€‚æ­¤æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—MQä¸ä¼šç«‹åˆ»å°†æ¶ˆæ¯ä¸¢å¼ƒï¼Œè€Œæ˜¯å°†è¿™æ¡æ¶ˆæ¯å‘é€åˆ°è¯¥ Consumer å¯¹åº”çš„ç‰¹æ®Šé˜Ÿåˆ—ä¸­ã€‚ æ¶ˆæ¯é˜Ÿåˆ— MQ å°†è¿™ç§æ­£å¸¸æƒ…å†µä¸‹æ— æ³•è¢«æ¶ˆè´¹çš„æ¶ˆæ¯ç§°ä¸ºæ­»ä¿¡æ¶ˆæ¯ï¼ˆDead-Letter Messageï¼‰ï¼Œå°†å­˜å‚¨æ­»ä¿¡æ¶ˆæ¯çš„ç‰¹æ®Šé˜Ÿåˆ—ç§°ä¸ºæ­»ä¿¡é˜Ÿåˆ— ï¼ˆDead-Letter Queue)ã€‚ 3.2é€‚ç”¨åœºæ™¯ 3.2.1ã€æ­»ä¿¡æ¶ˆæ¯çš„ç‰¹æ€§ ä¸ä¼šå†è¢«æ¶ˆè´¹è€…æ­£å¸¸æ¶ˆè´¹ã€‚ æœ‰æ•ˆæœŸä¸æ­£å¸¸æ¶ˆæ¯ç›¸åŒï¼Œå‡ä¸º 3 å¤©ï¼Œ3 å¤©åä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚å› æ­¤ï¼Œè¯·åœ¨æ­»ä¿¡æ¶ˆæ¯äº§ç”Ÿåçš„ 3 å¤©å†…åŠæ—¶å¤„ç†ã€‚ 3.2.2ã€æ­»ä¿¡é˜Ÿåˆ—çš„ç‰¹æ€§ ä¸€ä¸ªæ­»ä¿¡é˜Ÿåˆ—å¯¹åº”ä¸€ä¸ª Group IDï¼Œ è€Œä¸æ˜¯å¯¹åº”å•ä¸ªæ¶ˆè´¹è€…å®ä¾‹ã€‚ å¦‚æœä¸€ä¸ª Group ID æœªäº§ç”Ÿæ­»ä¿¡æ¶ˆæ¯ï¼Œæ¶ˆæ¯é˜Ÿåˆ— MQ ä¸ä¼šä¸ºå…¶åˆ›å»ºç›¸åº”çš„æ­»ä¿¡é˜Ÿåˆ—ã€‚ ä¸€ä¸ªæ­»ä¿¡é˜Ÿåˆ—åŒ…å«äº†å¯¹åº” Group ID äº§ç”Ÿçš„æ‰€æœ‰æ­»ä¿¡æ¶ˆæ¯ï¼Œä¸è®ºè¯¥æ¶ˆæ¯å±äºå“ªä¸ª Topicã€‚ æ¶ˆæ¯é˜Ÿåˆ— MQ æ§åˆ¶å°æä¾›å¯¹æ­»ä¿¡æ¶ˆæ¯çš„æŸ¥è¯¢çš„åŠŸèƒ½ã€‚ ä¸€èˆ¬æ§åˆ¶å°ç›´æ¥æŸ¥çœ‹æ­»ä¿¡æ¶ˆæ¯ä¼šæŠ¥é”™ã€‚ è¿›å…¥RocketMQä¸­æœåŠ¡å™¨å¯¹åº”çš„ RocketMQ ä¸­çš„/bin ç›®å½•ï¼Œæ‰§è¡Œä»¥ä¸‹è„šæœ¬ sh mqadmin updateTopic -b 192.168.0.128:10911 -n 192.168.0.128:9876 -t %DLQ%group1 -p 6 å››ã€æ¶ˆè´¹å¹‚ç­‰ ä¸ºäº†é˜²æ­¢æ¶ˆæ¯é‡å¤æ¶ˆè´¹å¯¼è‡´ä¸šåŠ¡å¤„ç†å¼‚å¸¸ï¼Œæ¶ˆæ¯é˜Ÿåˆ— MQ çš„æ¶ˆè´¹è€…åœ¨æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œæœ‰å¿…è¦æ ¹æ®ä¸šåŠ¡ä¸Šçš„å”¯ä¸€ Key å¯¹æ¶ˆæ¯åšå¹‚ç­‰å¤„ç†ã€‚æœ¬æ–‡ä»‹ç»æ¶ˆæ¯å¹‚ ç­‰çš„æ¦‚å¿µã€é€‚ç”¨åœºæ™¯ä»¥åŠå¤„ç†æ–¹æ³•ã€‚ 4.1ã€ä»€ä¹ˆæ˜¯æ¶ˆæ¯å¹‚ç­‰ å½“å‡ºç°æ¶ˆè´¹è€…å¯¹æŸæ¡æ¶ˆæ¯é‡å¤æ¶ˆè´¹çš„æƒ…å†µæ—¶ï¼Œé‡å¤æ¶ˆè´¹çš„ç»“æœä¸æ¶ˆè´¹ä¸€æ¬¡çš„ç»“æœæ˜¯ç›¸åŒçš„ï¼Œå¹¶ä¸”å¤šæ¬¡æ¶ˆè´¹å¹¶æœªå¯¹ä¸šåŠ¡ç³»ç»Ÿäº§ç”Ÿä»»ä½•è´Ÿé¢å½±å“ï¼Œé‚£ä¹ˆ è¿™æ•´ä¸ªè¿‡ç¨‹å°±å®ç°å¯æ¶ˆæ¯å¹‚ç­‰ã€‚ ä¾‹å¦‚ï¼Œåœ¨æ”¯ä»˜åœºæ™¯ä¸‹ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹æ‰£æ¬¾æ¶ˆæ¯ï¼Œå¯¹ä¸€ç¬”è®¢å•æ‰§è¡Œæ‰£æ¬¾æ“ä½œï¼Œæ‰£æ¬¾é‡‘é¢ä¸º 100 å…ƒã€‚å¦‚æœå› ç½‘ç»œä¸ç¨³å®šç­‰åŸå› å¯¼è‡´æ‰£æ¬¾æ¶ˆæ¯é‡å¤æŠ•é€’ï¼Œæ¶ˆ è´¹è€…é‡å¤æ¶ˆè´¹äº†è¯¥æ‰£æ¬¾æ¶ˆæ¯ï¼Œä½†æœ€ç»ˆçš„ä¸šåŠ¡ç»“æœæ˜¯åªæ‰£æ¬¾ä¸€æ¬¡ï¼Œæ‰£è´¹ 100 å…ƒï¼Œä¸”ç”¨æˆ·çš„æ‰£æ¬¾è®°å½•ä¸­å¯¹åº”çš„è®¢å•åªæœ‰ä¸€æ¡æ‰£æ¬¾æµæ°´ï¼Œä¸ä¼šå¤šæ¬¡æ‰£é™¤è´¹ç”¨ã€‚ é‚£ä¹ˆè¿™æ¬¡æ‰£æ¬¾æ“ä½œæ˜¯ç¬¦åˆè¦æ±‚çš„ï¼Œæ•´ä¸ªæ¶ˆè´¹è¿‡ç¨‹å®ç°äº†æ¶ˆè´¹å¹‚ç­‰ã€‚ 4.2ã€éœ€è¦å¤„ç†çš„åœºæ™¯ åœ¨äº’è”ç½‘åº”ç”¨ä¸­ï¼Œå°¤å…¶åœ¨ç½‘ç»œä¸ç¨³å®šçš„æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯é˜Ÿåˆ— MQ çš„æ¶ˆæ¯æœ‰å¯èƒ½ä¼šå‡ºç°é‡å¤ã€‚å¦‚æœæ¶ˆæ¯é‡å¤ä¼šå½±å“æ‚¨çš„ä¸šåŠ¡å¤„ç†ï¼Œè¯·å¯¹æ¶ˆæ¯åšå¹‚ç­‰å¤„ç†ã€‚ æ¶ˆæ¯é‡å¤çš„åœºæ™¯å¦‚ä¸‹ï¼š **1. å‘é€æ—¶æ¶ˆæ¯é‡å¤ ** å½“ä¸€æ¡æ¶ˆæ¯å·²è¢«æˆåŠŸå‘é€åˆ°æœåŠ¡ç«¯å¹¶å®ŒæˆæŒä¹…åŒ–ï¼Œæ­¤æ—¶å‡ºç°äº†ç½‘ç»œé—ªæ–­æˆ–è€…å®¢æˆ·ç«¯å®•æœºï¼Œå¯¼è‡´æœåŠ¡ç«¯å¯¹å®¢æˆ·ç«¯åº”ç­”å¤±è´¥ã€‚ å¦‚æœæ­¤æ—¶ç”Ÿäº§è€…æ„è¯†åˆ°æ¶ˆ æ¯å‘é€å¤±è´¥å¹¶å°è¯•å†æ¬¡å‘é€æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…åç»­ä¼šæ”¶åˆ°ä¸¤æ¡å†…å®¹ç›¸åŒå¹¶ä¸” Message ID ä¹Ÿç›¸åŒçš„æ¶ˆæ¯ã€‚ **2. æŠ•é€’æ—¶æ¶ˆæ¯é‡å¤ ** æ¶ˆæ¯æ¶ˆè´¹çš„åœºæ™¯ä¸‹ï¼Œæ¶ˆæ¯å·²æŠ•é€’åˆ°æ¶ˆè´¹è€…å¹¶å®Œæˆä¸šåŠ¡å¤„ç†ï¼Œå½“å®¢æˆ·ç«¯ç»™æœåŠ¡ç«¯åé¦ˆåº”ç­”çš„æ—¶å€™ç½‘ç»œé—ªæ–­ã€‚ä¸ºäº†ä¿è¯æ¶ˆæ¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡ï¼Œæ¶ˆæ¯é˜Ÿåˆ— MQ çš„æœåŠ¡ç«¯å°†åœ¨ç½‘ç»œæ¢å¤åå†æ¬¡å°è¯•æŠ•é€’ä¹‹å‰å·²è¢«å¤„ç†è¿‡çš„æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…åç»­ä¼šæ”¶åˆ°ä¸¤æ¡å†…å®¹ç›¸åŒå¹¶ä¸” Message ID ä¹Ÿç›¸åŒçš„æ¶ˆæ¯ã€‚ 3. è´Ÿè½½å‡è¡¡æ—¶æ¶ˆæ¯é‡å¤ï¼ˆåŒ…æ‹¬ä½†ä¸é™äºç½‘ç»œæŠ–åŠ¨ã€Broker é‡å¯ä»¥åŠæ¶ˆè´¹è€…åº”ç”¨é‡å¯ï¼‰ å½“æ¶ˆæ¯é˜Ÿåˆ— MQ çš„ Broker æˆ–å®¢æˆ·ç«¯é‡å¯ã€æ‰©å®¹æˆ–ç¼©å®¹æ—¶ï¼Œä¼šè§¦å‘ Rebalanceï¼Œæ­¤æ—¶æ¶ˆè´¹è€…å¯èƒ½ä¼šæ”¶åˆ°é‡å¤æ¶ˆæ¯ã€‚ 4.3ã€å¤„ç†æ–¹æ³• å› ä¸º Message ID æœ‰å¯èƒ½å‡ºç°å†²çªï¼ˆé‡å¤ï¼‰çš„æƒ…å†µï¼Œæ‰€ä»¥çœŸæ­£å®‰å…¨çš„å¹‚ç­‰å¤„ç†ï¼Œä¸å»ºè®®ä»¥ Message ID ä½œä¸ºå¤„ç†ä¾æ®ã€‚æœ€å¥½çš„æ–¹å¼æ˜¯ä»¥ä¸šåŠ¡å”¯ä¸€æ ‡è¯† ä½œä¸ºå¹‚ç­‰å¤„ç†çš„å…³é”®ä¾æ®ï¼Œè€Œä¸šåŠ¡çš„å”¯ä¸€æ ‡è¯†å¯ä»¥é€šè¿‡æ¶ˆæ¯ Key è®¾ç½®ã€‚ ä»¥æ”¯ä»˜åœºæ™¯ä¸ºä¾‹ï¼Œå¯ä»¥å°†æ¶ˆæ¯çš„ Key è®¾ç½®ä¸ºè®¢å•å·ï¼Œä½œä¸ºå¹‚ç­‰å¤„ç†çš„ä¾æ®ã€‚å…·ä½“ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š Message message = new Message(); message.setKey(&quot;ORDERID_100&quot;); SendResult sendResult = producer.send(message); æ¶ˆè´¹è€…æ”¶åˆ°æ¶ˆæ¯æ—¶å¯ä»¥æ ¹æ®æ¶ˆæ¯çš„ Keyï¼Œå³è®¢å•å·æ¥å®ç°æ¶ˆæ¯å¹‚ç­‰ï¼š consumer.subscribe(&quot;ons_test&quot;, &quot;*&quot;, new MessageListener() { public Action consume(Message message, ConsumeContext context) { String key = message.getKey() // æ ¹æ®ä¸šåŠ¡å”¯ä¸€æ ‡è¯†çš„ Key åšå¹‚ç­‰å¤„ç† } }); ","link":"https://tianxiawuhao.github.io/BvbuvYGnx/"},{"title":"CountDownLatch,CyclicBarrier,Semaphoreçš„ç”¨æ³•å’ŒåŒºåˆ«","content":"CountDownLatch CountDownLatchï¼ˆä¹Ÿå«é—­é”ï¼‰æ˜¯ä¸€ä¸ªåŒæ­¥ååŠ©ç±»ï¼Œå…è®¸ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹å®Œæˆæ“ä½œé›†ã€‚ CountDownLatch ä½¿ç”¨ç»™å®šçš„è®¡æ•°å€¼ï¼ˆcountï¼‰åˆå§‹åŒ–ã€‚await æ–¹æ³•ä¼šé˜»å¡ç›´åˆ°å½“å‰çš„è®¡æ•°å€¼ï¼ˆcountï¼‰ç”±äº countDown æ–¹æ³•çš„è°ƒç”¨è¾¾åˆ° 0ï¼Œcount ä¸º 0 ä¹‹åæ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹éƒ½ä¼šè¢«é‡Šæ”¾ï¼Œå¹¶ä¸”éšåå¯¹awaitæ–¹æ³•çš„è°ƒç”¨éƒ½ä¼šç«‹å³è¿”å›ã€‚ æ„é€ æ–¹æ³• //å‚æ•°countä¸ºè®¡æ•°å€¼ public CountDownLatch(int count) {}; å¸¸ç”¨æ–¹æ³• // è°ƒç”¨ await() æ–¹æ³•çš„çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œå®ƒä¼šç­‰å¾…ç›´åˆ° count å€¼ä¸º 0 æ‰ç»§ç»­æ‰§è¡Œ public void await() throws InterruptedException {}; // å’Œ await() ç±»ä¼¼ï¼Œè‹¥ç­‰å¾… timeout æ—¶é•¿åï¼Œcount å€¼è¿˜æ˜¯æ²¡æœ‰å˜ä¸º 0ï¼Œä¸å†ç­‰å¾…ï¼Œç»§ç»­æ‰§è¡Œ public boolean await(long timeout, TimeUnit unit) throws InterruptedException {}; // ä¼šå°† count å‡ 1ï¼Œç›´è‡³ä¸º 0 public void countDown() {}; ä½¿ç”¨æ¡ˆä¾‹ é¦–å…ˆæ˜¯åˆ›å»ºå®ä¾‹ CountDownLatch countDown = new CountDownLatch(2)ï¼› éœ€è¦åŒæ­¥çš„çº¿ç¨‹æ‰§è¡Œå®Œä¹‹åï¼Œè®¡æ•° -1ï¼Œ countDown.countDown()ï¼› éœ€è¦ç­‰å¾…å…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œå†è¿è¡Œçš„çº¿ç¨‹ï¼Œè°ƒç”¨ countDown.await()å®ç°é˜»å¡åŒæ­¥ã€‚ åº”ç”¨åœºæ™¯ CountDownLatch ä¸€èˆ¬ç”¨ä½œå¤šçº¿ç¨‹å€’è®¡æ—¶è®¡æ•°å™¨ï¼Œå¼ºåˆ¶å®ƒä»¬ç­‰å¾…å…¶ä»–ä¸€ç»„ï¼ˆCountDownLatchçš„åˆå§‹åŒ–å†³å®šï¼‰ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚ CountDownLatchçš„ä¸¤ç§ä½¿ç”¨åœºæ™¯ï¼š è®©å¤šä¸ªçº¿ç¨‹ç­‰å¾…ï¼Œæ¨¡æ‹Ÿå¹¶å‘ã€‚ è®©å•ä¸ªçº¿ç¨‹ç­‰å¾…ï¼Œå¤šä¸ªçº¿ç¨‹ï¼ˆä»»åŠ¡ï¼‰å®Œæˆåï¼Œè¿›è¡Œæ±‡æ€»åˆå¹¶ã€‚ åœºæ™¯ 1ï¼šæ¨¡æ‹Ÿå¹¶å‘ import java.util.concurrent.CountDownLatch; /** * è®©å¤šä¸ªçº¿ç¨‹ç­‰å¾…ï¼šæ¨¡æ‹Ÿå¹¶å‘ï¼Œè®©å¹¶å‘çº¿ç¨‹ä¸€èµ·æ‰§è¡Œ */ public class CountDownLatchTest { public static void main(String[] args) throws InterruptedException { CountDownLatch countDownLatch = new CountDownLatch(1); for (int i = 0; i &lt; 5; i++) { new Thread(() -&gt; { try { // ç­‰å¾… countDownLatch.await(); String parter = &quot;ã€&quot; + Thread.currentThread().getName() + &quot;ã€‘&quot;; System.out.println(parter + &quot;å¼€å§‹æ‰§è¡Œâ€¦â€¦&quot;); } catch (InterruptedException e) { e.printStackTrace(); } }).start(); } Thread.sleep(2000); countDownLatch.countDown(); } } åœºæ™¯ 2ï¼šå¤šä¸ªçº¿ç¨‹å®Œæˆåï¼Œè¿›è¡Œæ±‡æ€»åˆå¹¶ å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬çš„å¹¶å‘ä»»åŠ¡ï¼Œå­˜åœ¨å‰åä¾èµ–å…³ç³»ï¼›æ¯”å¦‚æ•°æ®è¯¦æƒ…é¡µéœ€è¦åŒæ—¶è°ƒç”¨å¤šä¸ªæ¥å£è·å–æ•°æ®ï¼Œå¹¶å‘è¯·æ±‚è·å–åˆ°æ•°æ®åã€éœ€è¦è¿›è¡Œç»“æœåˆå¹¶ï¼›æˆ–è€…å¤šä¸ªæ•°æ®æ“ä½œå®Œæˆåï¼Œéœ€è¦æ•°æ® checkï¼›è¿™å…¶å®éƒ½æ˜¯ï¼šåœ¨å¤šä¸ªçº¿ç¨‹(ä»»åŠ¡)å®Œæˆåï¼Œè¿›è¡Œæ±‡æ€»åˆå¹¶çš„åœºæ™¯ã€‚ import java.util.Map; import java.util.concurrent.ConcurrentHashMap; import java.util.concurrent.CountDownLatch; /** * è®©å•ä¸ªçº¿ç¨‹ç­‰å¾…ï¼šå¤šä¸ªçº¿ç¨‹(ä»»åŠ¡)å®Œæˆåï¼Œè¿›è¡Œæ±‡æ€»åˆå¹¶ */ public class CountDownLatchTest3 { //ç”¨äºèšåˆæ‰€æœ‰çš„ç»Ÿè®¡æŒ‡æ ‡ private static Map map = new ConcurrentHashMap(); //åˆ›å»ºè®¡æ•°å™¨ï¼Œè¿™é‡Œéœ€è¦ç»Ÿè®¡4ä¸ªæŒ‡æ ‡ private static CountDownLatch countDownLatch = new CountDownLatch(4); public static void main(String[] args) throws Exception { //è®°å½•å¼€å§‹æ—¶é—´ long startTime = System.currentTimeMillis(); Thread countUserThread = new Thread(() -&gt; { try { System.out.println(&quot;æ­£åœ¨ç»Ÿè®¡æ–°å¢ç”¨æˆ·æ•°é‡&quot;); Thread.sleep(3000);//ä»»åŠ¡æ‰§è¡Œéœ€è¦3ç§’ map.put(&quot;userNumber&quot;, 100);//ä¿å­˜ç»“æœå€¼ System.out.println(&quot;ç»Ÿè®¡æ–°å¢ç”¨æˆ·æ•°é‡å®Œæ¯•&quot;); countDownLatch.countDown();//æ ‡è®°å·²ç»å®Œæˆä¸€ä¸ªä»»åŠ¡ } catch (InterruptedException e) { e.printStackTrace(); } }); Thread countOrderThread = new Thread(() -&gt; { try { System.out.println(&quot;æ­£åœ¨ç»Ÿè®¡è®¢å•æ•°é‡&quot;); Thread.sleep(3000);//ä»»åŠ¡æ‰§è¡Œéœ€è¦3ç§’ map.put(&quot;countOrder&quot;, 20);//ä¿å­˜ç»“æœå€¼ System.out.println(&quot;ç»Ÿè®¡è®¢å•æ•°é‡å®Œæ¯•&quot;); countDownLatch.countDown();//æ ‡è®°å·²ç»å®Œæˆä¸€ä¸ªä»»åŠ¡ } catch (InterruptedException e) { e.printStackTrace(); } }); Thread countGoodsThread = new Thread(() -&gt; { try { System.out.println(&quot;æ­£åœ¨å•†å“é”€é‡&quot;); Thread.sleep(3000);//ä»»åŠ¡æ‰§è¡Œéœ€è¦3ç§’ map.put(&quot;countGoods&quot;, 300);//ä¿å­˜ç»“æœå€¼ System.out.println(&quot;ç»Ÿè®¡å•†å“é”€é‡å®Œæ¯•&quot;); countDownLatch.countDown();//æ ‡è®°å·²ç»å®Œæˆä¸€ä¸ªä»»åŠ¡ } catch (InterruptedException e) { e.printStackTrace(); } }); Thread countmoneyThread = new Thread(() -&gt; { try { System.out.println(&quot;æ­£åœ¨æ€»é”€å”®é¢&quot;); Thread.sleep(3000);//ä»»åŠ¡æ‰§è¡Œéœ€è¦3ç§’ map.put(&quot;countMoney&quot;, 40000);//ä¿å­˜ç»“æœå€¼ System.out.println(&quot;ç»Ÿè®¡é”€å”®é¢å®Œæ¯•&quot;); countDownLatch.countDown();//æ ‡è®°å·²ç»å®Œæˆä¸€ä¸ªä»»åŠ¡ } catch (InterruptedException e) { e.printStackTrace(); } }); //å¯åŠ¨å­çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ countUserThread.start(); countGoodsThread.start(); countOrderThread.start(); countmoneyThread.start(); try { //ä¸»çº¿ç¨‹ç­‰å¾…æ‰€æœ‰ç»Ÿè®¡æŒ‡æ ‡æ‰§è¡Œå®Œæ¯• countDownLatch.await(); long endTime = System.currentTimeMillis();//è®°å½•ç»“æŸæ—¶é—´ System.out.println(&quot;------ç»Ÿè®¡æŒ‡æ ‡å…¨éƒ¨å®Œæˆ--------&quot;); System.out.println(&quot;ç»Ÿè®¡ç»“æœä¸ºï¼š&quot; + map); System.out.println(&quot;ä»»åŠ¡æ€»æ‰§è¡Œæ—¶é—´ä¸º&quot; + (endTime - startTime) + &quot;ms&quot;); } catch (InterruptedException e) { e.printStackTrace(); } } } CylicBarrier ä»å­—é¢ä¸Šçš„æ„æ€å¯ä»¥çŸ¥é“ï¼Œè¿™ä¸ªç±»çš„ä¸­æ–‡æ„æ€æ˜¯â€œå¾ªç¯æ …æ â€ã€‚å¤§æ¦‚çš„æ„æ€å°±æ˜¯ä¸€ä¸ªå¯å¾ªç¯åˆ©ç”¨çš„å±éšœã€‚ å®ƒçš„ä½œç”¨å°±æ˜¯ä¼šè®©æ‰€æœ‰çº¿ç¨‹éƒ½ç­‰å¾…å®Œæˆåæ‰ä¼šç»§ç»­ä¸‹ä¸€æ­¥è¡ŒåŠ¨ã€‚ ç°å®ç”Ÿæ´»ä¸­æˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°è¿™æ ·çš„æƒ…æ™¯ï¼Œåœ¨è¿›è¡ŒæŸä¸ªæ´»åŠ¨å‰éœ€è¦ç­‰å¾…äººå…¨éƒ¨éƒ½é½äº†æ‰å¼€å§‹ã€‚ä¾‹å¦‚åƒé¥­æ—¶è¦ç­‰å…¨å®¶äººéƒ½ä¸Šåº§äº†æ‰åŠ¨ç­·å­ï¼Œæ—…æ¸¸æ—¶è¦ç­‰å…¨éƒ¨äººéƒ½åˆ°é½äº†æ‰å‡ºå‘ï¼Œæ¯”èµ›æ—¶è¦ç­‰è¿åŠ¨å‘˜éƒ½ä¸Šåœºåæ‰å¼€å§‹ã€‚ åœ¨JUCåŒ…ä¸­ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªåŒæ­¥å·¥å…·ç±»èƒ½å¤Ÿå¾ˆå¥½çš„æ¨¡æ‹Ÿè¿™ç±»åœºæ™¯ï¼Œå®ƒå°±æ˜¯CyclicBarrierç±»ã€‚åˆ©ç”¨CyclicBarrierç±»å¯ä»¥å®ç°ä¸€ç»„çº¿ç¨‹ç›¸äº’ç­‰å¾…ï¼Œå½“æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾æŸä¸ªå±éšœç‚¹åå†è¿›è¡Œåç»­çš„æ“ä½œã€‚ CyclicBarrierå­—é¢æ„æ€æ˜¯â€œå¯é‡å¤ä½¿ç”¨çš„æ …æ â€ï¼ŒCyclicBarrierç›¸æ¯” CountDownLatch æ¥è¯´ï¼Œè¦ç®€å•å¾ˆå¤šï¼Œå…¶æºç æ²¡æœ‰ä»€ä¹ˆé«˜æ·±çš„åœ°æ–¹ï¼Œå®ƒæ˜¯ ReentrantLock å’Œ Condition çš„ç»„åˆä½¿ç”¨ã€‚ çœ‹å¦‚ä¸‹ç¤ºæ„å›¾ï¼ŒCyclicBarrier å’Œ CountDownLatch æ˜¯ä¸æ˜¯å¾ˆåƒï¼Œåªæ˜¯ CyclicBarrier å¯ä»¥æœ‰ä¸æ­¢ä¸€ä¸ªæ …æ ï¼Œå› ä¸ºå®ƒçš„æ …æ ï¼ˆBarrierï¼‰å¯ä»¥é‡å¤ä½¿ç”¨ï¼ˆCyclicï¼‰ã€‚ å°±å¥½æ¯”ä»¥å‰çš„é‚£ç§å®¢è½¦ä¸€æ ·ï¼Œå½“ç¬¬ä¸€è½®è½¦åæ»¡ä¹‹åå‘è½¦ï¼Œç„¶åæ¥ç€ç­‰ç¬¬äºŒè¾†è½¦åæ»¡ä¹‹ååœ¨å‘è½¦ã€‚ æ„é€ æ–¹æ³• // partiesè¡¨ç¤ºå±éšœæ‹¦æˆªçš„çº¿ç¨‹æ•°é‡ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨ await æ–¹æ³•å‘Šè¯‰ CyclicBarrier æˆ‘å·²ç»åˆ°è¾¾äº†å±éšœï¼Œç„¶åå½“å‰çº¿ç¨‹è¢«é˜»å¡ã€‚ public CyclicBarrier(int parties) // ç”¨äºåœ¨çº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œä¼˜å…ˆæ‰§è¡Œ barrierActionï¼Œæ–¹ä¾¿å¤„ç†æ›´å¤æ‚çš„ä¸šåŠ¡åœºæ™¯(è¯¥çº¿ç¨‹çš„æ‰§è¡Œæ—¶æœºæ˜¯åœ¨åˆ°è¾¾å±éšœä¹‹åå†æ‰§è¡Œ) public CyclicBarrier(int parties, Runnable barrierAction) å¸¸ç”¨æ–¹æ³• //å±éšœ æŒ‡å®šæ•°é‡çš„çº¿ç¨‹å…¨éƒ¨è°ƒç”¨await()æ–¹æ³•æ—¶ï¼Œè¿™äº›çº¿ç¨‹ä¸å†é˜»å¡ // BrokenBarrierException è¡¨ç¤ºæ …æ å·²ç»è¢«ç ´åï¼Œç ´åçš„åŸå› å¯èƒ½æ˜¯å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹ await() æ—¶è¢«ä¸­æ–­æˆ–è€…è¶…æ—¶ public int await() throws InterruptedException, BrokenBarrierException public int await(long timeout, TimeUnit unit) throws InterruptedException, B rokenBarrierException, TimeoutException //å¾ªç¯ é€šè¿‡reset()æ–¹æ³•å¯ä»¥è¿›è¡Œé‡ç½® public void reset() ä½¿ç”¨æ¡ˆä¾‹ import java.util.concurrent.CyclicBarrier; /** * CyclicBarrier(å›ç¯æ …æ )å…è®¸ä¸€ç»„çº¿ç¨‹äº’ç›¸ç­‰å¾…ï¼Œç›´åˆ°åˆ°è¾¾æŸä¸ªå…¬å…±å±éšœç‚¹ (Common Barrier Point) * CountDownLatch ç”¨äºç­‰å¾…countDownäº‹ä»¶ï¼Œè€Œæ …æ ç”¨äºç­‰å¾…å…¶ä»–çº¿ç¨‹ã€‚ */ public class CyclicBarrierTest { public static void main(String[] args) { CyclicBarrier cyclicBarrier = new CyclicBarrier(3); for (int i = 0; i &lt; 5; i++) { new Thread(new Runnable() { @Override public void run() { try { System.out.println(Thread.currentThread().getName() + &quot;å¼€å§‹ç­‰å¾…å…¶ä»–çº¿ç¨‹&quot;); cyclicBarrier.await(); System.out.println(Thread.currentThread().getName() + &quot;å¼€å§‹æ‰§è¡Œ&quot;); //TODO æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç† Thread.sleep(5000); System.out.println(Thread.currentThread().getName() + &quot;æ‰§è¡Œå®Œæ¯•&quot;); } catch (Exception e) { e.printStackTrace(); } } }).start(); } } } åº”ç”¨åœºæ™¯ å¯ä»¥ç”¨äºå¤šçº¿ç¨‹è®¡ç®—æ•°æ®ï¼Œæœ€ååˆå¹¶è®¡ç®—ç»“æœçš„åœºæ™¯ã€‚ import java.util.Set; import java.util.concurrent.*; public class CyclicBarrierTest2 { //ä¿å­˜æ¯ä¸ªå­¦ç”Ÿçš„å¹³å‡æˆç»© private ConcurrentHashMap&lt;String, Integer&gt; map = new ConcurrentHashMap&lt;String, Integer&gt;(); private ExecutorService threadPool = Executors.newFixedThreadPool(3); private CyclicBarrier cb = new CyclicBarrier(3, () -&gt; { int result = 0; Set&lt;String&gt; set = map.keySet(); for (String s : set) { result += map.get(s); } System.out.println(&quot;ä¸‰äººå¹³å‡æˆç»©ä¸º:&quot; + (result / 3) + &quot;åˆ†&quot;); }); public void count() { for (int i = 0; i &lt; 3; i++) { threadPool.execute(new Runnable() { @Override public void run() { //è·å–å­¦ç”Ÿå¹³å‡æˆç»© int score = (int) (Math.random() * 40 + 60); map.put(Thread.currentThread().getName(), score); System.out.println(Thread.currentThread().getName() + &quot;åŒå­¦çš„å¹³å‡æˆç»©ä¸ºï¼š&quot; + score); try { //æ‰§è¡Œå®Œè¿è¡Œawait(),ç­‰å¾…æ‰€æœ‰å­¦ç”Ÿå¹³å‡æˆç»©éƒ½è®¡ç®—å®Œæ¯• cb.await(); } catch (InterruptedException | BrokenBarrierException e) { e.printStackTrace(); } } }); } } public static void main(String[] args) { CyclicBarrierTest2 cb = new CyclicBarrierTest2(); cb.count(); } } æµ‹è¯•ç»“æœï¼š Semaphore Semaphoreï¼Œä¿—ç§°ä¿¡å·é‡ï¼ŒåŸºäº AbstractQueuedSynchronizer å®ç°ã€‚ä½¿ç”¨ Semaphore å¯ä»¥æ§åˆ¶åŒæ—¶è®¿é—®èµ„æºçš„çº¿ç¨‹ä¸ªæ•°ã€‚ æ¯”å¦‚ï¼šåœè½¦åœºå…¥å£ç«‹ç€çš„é‚£ä¸ªæ˜¾ç¤ºå±ï¼Œæ¯æœ‰ä¸€è¾†è½¦è¿›å…¥åœè½¦åœºæ˜¾ç¤ºå±å°±ä¼šæ˜¾ç¤ºå‰©ä½™è½¦ä½å‡ 1ï¼Œæ¯æœ‰ä¸€è¾†è½¦ä»åœè½¦åœºå‡ºå»ï¼Œæ˜¾ç¤ºå±ä¸Šæ˜¾ç¤ºçš„å‰©ä½™è½¦è¾†å°±ä¼šåŠ  1ï¼Œå½“æ˜¾ç¤ºå±ä¸Šçš„å‰©ä½™è½¦ä½ä¸º 0 æ—¶ï¼Œåœè½¦åœºå…¥å£çš„æ æ†å°±ä¸ä¼šå†æ‰“å¼€ï¼Œè½¦è¾†å°±æ— æ³•è¿›å…¥åœè½¦åœºäº†ï¼Œç›´åˆ°æœ‰ä¸€è¾†è½¦ä»åœè½¦åœºå‡ºå»ä¸ºæ­¢ã€‚ æ¯”å¦‚ï¼šåœ¨å­¦ç”Ÿæ—¶ä»£éƒ½å»é¤å…æ‰“è¿‡é¥­ï¼Œå‡å¦‚æœ‰ 3 ä¸ªçª—å£å¯ä»¥æ‰“é¥­ï¼ŒåŒä¸€æ—¶åˆ»ä¹Ÿåªèƒ½æœ‰ 3 ååŒå­¦æ‰“é¥­ã€‚ç¬¬ 4 ä¸ªäººæ¥äº†ä¹‹åå°±å¿…é¡»åœ¨å¤–é¢ç­‰ç€ï¼Œåªè¦æœ‰æ‰“é¥­çš„åŒå­¦å¥½äº†ï¼Œå°±å¯ä»¥å»ç›¸åº”çš„çª—å£äº† ã€‚ æ„é€ æ–¹æ³• //åˆ›å»ºå…·æœ‰ç»™å®šçš„è®¸å¯æ•°å’Œéå…¬å¹³çš„å…¬å¹³è®¾ç½®çš„ Semaphoreã€‚ Semaphore(int permits) //åˆ›å»ºå…·æœ‰ç»™å®šçš„è®¸å¯æ•°å’Œç»™å®šçš„å…¬å¹³è®¾ç½®çš„ Semaphoreã€‚ Semaphore(int permits, boolean fair) permits è¡¨ç¤ºè®¸å¯è¯çš„æ•°é‡ï¼ˆèµ„æºæ•°ï¼‰ï¼Œå°±å¥½æ¯”ä¸€ä¸ªå­¦ç”Ÿå¯ä»¥å ç”¨ 3 ä¸ªæ‰“é¥­çª—å£ã€‚ fair è¡¨ç¤ºå…¬å¹³æ€§ï¼Œå¦‚æœè¿™ä¸ªè®¾ä¸º true çš„è¯ï¼Œä¸‹æ¬¡æ‰§è¡Œçš„çº¿ç¨‹ä¼šæ˜¯ç­‰å¾…æœ€ä¹…çš„çº¿ç¨‹ã€‚ å¸¸ç”¨æ–¹æ³• public void acquire() throws InterruptedException public boolean tryAcquire() public void release() public int availablePermits() public final int getQueueLength() public final boolean hasQueuedThreads() protected void reducePermits(int reduction) protected Collection&lt;Thread&gt; getQueuedThreads() acquire()ï¼šè¡¨ç¤ºé˜»å¡å¹¶è·å–è®¸å¯ã€‚ tryAcquire()ï¼šæ–¹æ³•åœ¨æ²¡æœ‰è®¸å¯çš„æƒ…å†µä¸‹ä¼šç«‹å³è¿”å› falseï¼Œè¦è·å–è®¸å¯çš„çº¿ç¨‹ä¸ä¼šé˜»å¡ã€‚ release()ï¼šè¡¨ç¤ºé‡Šæ”¾è®¸å¯ã€‚ int availablePermits()ï¼šè¿”å›æ­¤ä¿¡å·é‡ä¸­å½“å‰å¯ç”¨çš„è®¸å¯è¯æ•°ã€‚ int getQueueLength()ï¼šè¿”å›æ­£åœ¨ç­‰å¾…è·å–è®¸å¯è¯çš„çº¿ç¨‹æ•°ã€‚ boolean hasQueuedThreads()ï¼šæ˜¯å¦æœ‰çº¿ç¨‹æ­£åœ¨ç­‰å¾…è·å–è®¸å¯è¯ã€‚ void reducePermit(int reduction)ï¼šå‡å°‘ reduction ä¸ªè®¸å¯è¯ã€‚ Collection getQueuedThreads()ï¼šè¿”å›æ‰€æœ‰ç­‰å¾…è·å–è®¸å¯è¯çš„çº¿ç¨‹é›†åˆã€‚ ä½¿ç”¨æ¡ˆä¾‹ æˆ‘ä»¬å¯ä»¥æ¨¡æ‹Ÿè½¦ç«™ä¹°ç¥¨ï¼Œå‡å¦‚è½¦ç«™æœ‰ 3 ä¸ªçª—å£å”®ç¥¨ï¼Œé‚£ä¹ˆåŒä¸€æ—¶åˆ»æ¯ä¸ªçª—å£åªèƒ½å­˜åœ¨ä¸€ä¸ªäººä¹°ç¥¨ï¼Œå…¶ä»–äººåˆ™ç­‰å¾…å‰é¢çš„äººå®Œæˆåæ‰å¯ä»¥å»ä¹°ç¥¨ã€‚ import java.util.concurrent.Semaphore; public class SemaphoreTest { public static void main(String[] args) { // 3 ä¸ªçª—å£ Semaphore windows = new Semaphore(3); // æ¨¡æ‹Ÿ 5 ä¸ªäººè´­ç¥¨ for (int i = 0; i &lt; 5; i++) { new Thread(new Runnable() { @Override public void run() { // å ç”¨çª—å£ï¼ŒåŠ é” try { windows.acquire(); System.out.println(Thread.currentThread().getName() + &quot;ï¼šå¼€å§‹è´­ç¥¨&quot;); // ä¹°ç¥¨ Thread.sleep(5000); System.out.println(Thread.currentThread().getName() + &quot;ï¼šè´­ç¥¨æˆåŠŸ&quot;); } catch (InterruptedException e) { e.printStackTrace(); } finally { // é‡Šæ”¾è®¸å¯ï¼Œé‡Šæ”¾çª—å£ windows.release(); } } }, &quot;Thread&quot; + i).start(); } } } æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š å¾ˆæ˜æ˜¾å¯ä»¥çœ‹åˆ°å½“å‰é¢ 3 ä¸ªçº¿ç¨‹è´­ç¥¨æˆåŠŸä¹‹åï¼Œå‰©ä½™çš„çº¿ç¨‹å†å¼€å§‹è´­ç¥¨ã€‚ åº”ç”¨åœºæ™¯ å¯ä»¥ç”¨äºåšæµé‡æ§åˆ¶ï¼Œç‰¹åˆ«æ˜¯å…¬ç”¨èµ„æºæœ‰é™çš„åº”ç”¨åœºæ™¯ã€‚ å¦‚æˆ‘ä»¬å®ç°ä¸€ä¸ªåŒæ—¶åªèƒ½å¤„ç† 5 ä¸ªè¯·æ±‚çš„é™æµå™¨ã€‚ import java.util.concurrent.LinkedBlockingDeque; import java.util.concurrent.Semaphore; import java.util.concurrent.ThreadPoolExecutor; import java.util.concurrent.TimeUnit; public class SemaphoneTest2 { /** * å®ç°ä¸€ä¸ªåŒæ—¶åªèƒ½å¤„ç†5ä¸ªè¯·æ±‚çš„é™æµå™¨ */ private static Semaphore semaphore = new Semaphore(5); /** * å®šä¹‰ä¸€ä¸ªçº¿ç¨‹æ±  * 0 */ private static ThreadPoolExecutor executor = new ThreadPoolExecutor(10, 50, 1 , TimeUnit.SECONDS, new LinkedBlockingDeque&lt;&gt;(200)); /** * æ¨¡æ‹Ÿæ‰§è¡Œæ–¹æ³• */ public static void exec() { try { semaphore.acquire(1); // æ¨¡æ‹ŸçœŸå®æ–¹æ³•æ‰§è¡Œ System.out.println(&quot;æ‰§è¡Œexecæ–¹æ³•&quot;); Thread.sleep(2000); } catch (Exception e) { e.printStackTrace(); } finally { semaphore.release(1); } } public static void main(String[] args) throws InterruptedException { { for (;;) { Thread.sleep(100); // æ¨¡æ‹Ÿè¯·æ±‚ä»¥10ä¸ª/sçš„é€Ÿåº¦ executor.execute(() -&gt; exec()); } } } } æ€»ç»“ 1ã€CountDownLatchã€CyclicBarrierã€Semaphoreçš„åŒºåˆ« CountDownLatch å’Œ CyclicBarrier éƒ½èƒ½å¤Ÿå®ç°çº¿ç¨‹ä¹‹é—´çš„ç­‰å¾…ï¼Œåªä¸è¿‡å®ƒä»¬ä¾§é‡ç‚¹ä¸åŒï¼š CountDownLatch ä¸€èˆ¬ç”¨äºæŸä¸ªçº¿ç¨‹ A ç­‰å¾…è‹¥å¹²ä¸ªå…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡ä¹‹åï¼Œå®ƒæ‰æ‰§è¡Œï¼› è€ŒCyclicBarrierä¸€èˆ¬ç”¨äºä¸€ç»„çº¿ç¨‹äº’ç›¸ç­‰å¾…è‡³æŸä¸ªçŠ¶æ€ï¼Œç„¶åè¿™ä¸€ç»„çº¿ç¨‹å†åŒæ—¶æ‰§è¡Œï¼› å¦å¤–ï¼ŒCountDownLatchæ˜¯ä¸èƒ½å¤Ÿé‡ç”¨çš„ï¼Œè€Œ CyclicBarrier æ˜¯å¯ä»¥é‡ç”¨çš„ï¼ˆresetï¼‰ã€‚ Semaphoreå’Œé”æœ‰ç‚¹ç±»ä¼¼ï¼Œå®ƒä¸€èˆ¬ç”¨äºæ§åˆ¶å¯¹æŸç»„èµ„æºçš„è®¿é—®æƒé™ã€‚ 2ã€CountDownLatch ä¸ Thread.join çš„åŒºåˆ« CountDownLatch çš„ä½œç”¨å°±æ˜¯å…è®¸ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹å®Œæˆæ“ä½œï¼Œçœ‹èµ·æ¥æœ‰ç‚¹ç±»ä¼¼ join() æ–¹æ³•ï¼Œä½†å…¶æä¾›äº†æ¯” join() æ›´åŠ çµæ´»çš„APIã€‚ CountDownLatch å¯ä»¥æ‰‹åŠ¨æ§åˆ¶åœ¨nä¸ªçº¿ç¨‹é‡Œè°ƒç”¨ n æ¬¡ countDown() æ–¹æ³•ä½¿è®¡æ•°å™¨è¿›è¡Œå‡ä¸€æ“ä½œï¼Œä¹Ÿå¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹é‡Œè°ƒç”¨ n æ¬¡æ‰§è¡Œå‡ä¸€æ“ä½œã€‚ è€Œ join() çš„å®ç°åŸç†æ˜¯ä¸åœæ£€æŸ¥ join çº¿ç¨‹æ˜¯å¦å­˜æ´»ï¼Œå¦‚æœ join çº¿ç¨‹å­˜æ´»åˆ™è®©å½“å‰çº¿ç¨‹æ°¸è¿œç­‰å¾…ã€‚æ‰€ä»¥ä¸¤è€…ä¹‹é—´ç›¸å¯¹æ¥è¯´è¿˜æ˜¯ CountDownLatch ä½¿ç”¨èµ·æ¥è¾ƒä¸ºçµæ´»ã€‚ 3ã€CyclicBarrier ä¸ CountDownLatch åŒºåˆ« CountDownLatchçš„è®¡æ•°å™¨åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œè€ŒCyclicBarrierçš„è®¡æ•°å™¨å¯ä»¥ä½¿ç”¨reset()æ–¹æ³•é‡ç½®ã€‚æ‰€ä»¥CyclicBarrierèƒ½å¤„ç†æ›´ä¸ºå¤æ‚çš„ä¸šåŠ¡åœºæ™¯ï¼Œæ¯”å¦‚å¦‚æœè®¡ç®—å‘ç”Ÿé”™è¯¯ï¼Œå¯ä»¥é‡ç½®è®¡æ•°å™¨ï¼Œå¹¶è®©çº¿ç¨‹ä»¬é‡æ–°æ‰§è¡Œä¸€æ¬¡ã€‚ CyclicBarrierè¿˜æä¾›getNumberWaiting(å¯ä»¥è·å¾—CyclicBarrieré˜»å¡çš„çº¿ç¨‹æ•°é‡)ã€isBroken(ç”¨æ¥çŸ¥é“é˜»å¡çš„çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­)ç­‰æ–¹æ³•ã€‚ CountDownLatchä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼ŒCyclicBarrierä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œåªä¼šé˜»å¡å­çº¿ç¨‹ã€‚ CountDownLatchå’ŒCyclicBarrieréƒ½èƒ½å¤Ÿå®ç°çº¿ç¨‹ä¹‹é—´çš„ç­‰å¾…ï¼Œåªä¸è¿‡å®ƒä»¬ä¾§é‡ç‚¹ä¸åŒã€‚CountDownLatchä¸€èˆ¬ç”¨äºä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ï¼Œç­‰å¾…å…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡åï¼Œå†æ‰§è¡Œã€‚CyclicBarrierä¸€èˆ¬ç”¨äºä¸€ç»„çº¿ç¨‹äº’ç›¸ç­‰å¾…è‡³æŸä¸ªçŠ¶æ€ï¼Œç„¶åè¿™ä¸€ç»„çº¿ç¨‹å†åŒæ—¶æ‰§è¡Œã€‚ CyclicBarrier è¿˜å¯ä»¥æä¾›ä¸€ä¸ª barrierActionï¼Œåˆå¹¶å¤šçº¿ç¨‹è®¡ç®—ç»“æœã€‚ CyclicBarrieræ˜¯é€šè¿‡ReentrantLockçš„&quot;ç‹¬å é”&quot;å’ŒConditonæ¥å®ç°ä¸€ç»„çº¿ç¨‹çš„é˜»å¡å”¤é†’çš„ï¼Œè€ŒCountDownLatchåˆ™æ˜¯é€šè¿‡AQSçš„â€œå…±äº«é”â€å®ç°ã€‚ ","link":"https://tianxiawuhao.github.io/bPYM5y-vS/"},{"title":"å¼‚æ­¥ç¼–ç¨‹çš„ 7 ç§å®ç°æ–¹å¼","content":"æ—©æœŸçš„ç³»ç»Ÿæ˜¯åŒæ­¥çš„ï¼Œå®¹æ˜“ç†è§£ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸ªä¾‹å­ åŒæ­¥ç¼–ç¨‹ å½“ç”¨æˆ·åˆ›å»ºä¸€ç¬”ç”µå•†äº¤æ˜“è®¢å•æ—¶ï¼Œè¦ç»å†çš„ä¸šåŠ¡é€»è¾‘æµç¨‹è¿˜æ˜¯å¾ˆé•¿çš„ï¼Œæ¯ä¸€æ­¥éƒ½è¦è€—è´¹ä¸€å®šçš„æ—¶é—´ï¼Œé‚£ä¹ˆæ•´ä½“çš„RTå°±ä¼šæ¯”è¾ƒé•¿ã€‚ äºæ˜¯ï¼Œèªæ˜çš„äººä»¬å¼€å§‹æ€è€ƒèƒ½ä¸èƒ½å°†ä¸€äº›éæ ¸å¿ƒä¸šåŠ¡ä»ä¸»æµç¨‹ä¸­å‰¥ç¦»å‡ºæ¥ï¼Œäºæ˜¯æœ‰äº†å¼‚æ­¥ç¼–ç¨‹é›å½¢ã€‚ å¼‚æ­¥ç¼–ç¨‹æ˜¯è®©ç¨‹åºå¹¶å‘è¿è¡Œçš„ä¸€ç§æ‰‹æ®µã€‚å®ƒå…è®¸å¤šä¸ªäº‹ä»¶åŒæ—¶å‘ç”Ÿï¼Œå½“ç¨‹åºè°ƒç”¨éœ€è¦é•¿æ—¶é—´è¿è¡Œçš„æ–¹æ³•æ—¶ï¼Œå®ƒä¸ä¼šé˜»å¡å½“å‰çš„æ‰§è¡Œæµç¨‹ï¼Œç¨‹åºå¯ä»¥ç»§ç»­è¿è¡Œã€‚ æ ¸å¿ƒæ€è·¯ï¼šé‡‡ç”¨å¤šçº¿ç¨‹ä¼˜åŒ–æ€§èƒ½ï¼Œå°†ä¸²è¡Œæ“ä½œå˜æˆå¹¶è¡Œæ“ä½œã€‚å¼‚æ­¥æ¨¡å¼è®¾è®¡çš„ç¨‹åºå¯ä»¥æ˜¾è‘—å‡å°‘çº¿ç¨‹ç­‰å¾…ï¼Œä»è€Œåœ¨é«˜ååé‡åœºæ™¯ä¸­ï¼Œæå¤§æå‡ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ï¼Œæ˜¾è‘—é™ä½æ—¶å»¶ã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥è®²ä¸‹å¼‚æ­¥æœ‰å“ªäº›ç¼–ç¨‹å®ç°æ–¹å¼ ä¸€ã€çº¿ç¨‹ Thread ç›´æ¥ç»§æ‰¿ Threadç±» æ˜¯åˆ›å»ºå¼‚æ­¥çº¿ç¨‹æœ€ç®€å•çš„æ–¹å¼ã€‚ é¦–å…ˆï¼Œåˆ›å»ºThreadå­ç±»ï¼Œæ™®é€šç±»æˆ–åŒ¿åå†…éƒ¨ç±»æ–¹å¼ï¼›ç„¶ååˆ›å»ºå­ç±»å®ä¾‹ï¼›æœ€åé€šè¿‡start()æ–¹æ³•å¯åŠ¨çº¿ç¨‹ã€‚ public class AsyncThread extends Thread{ @Override public void run() { System.out.println(&quot;å½“å‰çº¿ç¨‹åç§°:&quot; + this.getName() + &quot;, æ‰§è¡Œçº¿ç¨‹åç§°:&quot; + Thread.currentThread().getName() + &quot;-hello&quot;); } } public static void main(String[] args) { // æ¨¡æ‹Ÿä¸šåŠ¡æµç¨‹ // ....... // åˆ›å»ºå¼‚æ­¥çº¿ç¨‹ AsyncThread asyncThread = new AsyncThread(); // å¯åŠ¨å¼‚æ­¥çº¿ç¨‹ asyncThread.start(); } å½“ç„¶å¦‚æœæ¯æ¬¡éƒ½åˆ›å»ºä¸€ä¸ª Threadçº¿ç¨‹ï¼Œé¢‘ç¹çš„åˆ›å»ºã€é”€æ¯ï¼Œæµªè´¹ç³»ç»Ÿèµ„æºã€‚æˆ‘ä»¬å¯ä»¥é‡‡ç”¨çº¿ç¨‹æ±  @Bean(name = &quot;executorService&quot;) public ExecutorService downloadExecutorService() { return new ThreadPoolExecutor(20, 40, 60, TimeUnit.SECONDS, new ArrayBlockingQueue&lt;&gt;(2000), new ThreadFactoryBuilder().setNameFormat(&quot;defaultExecutorService-%d&quot;).build(), (r, executor) -&gt; log.error(&quot;defaultExecutor pool is full! &quot;)); } å°†ä¸šåŠ¡é€»è¾‘å°è£…åˆ° Runnable æˆ– Callable ä¸­ï¼Œäº¤ç”± çº¿ç¨‹æ±  æ¥æ‰§è¡Œ äºŒã€Future ä¸Šè¿°æ–¹å¼è™½ç„¶è¾¾åˆ°äº†å¤šçº¿ç¨‹å¹¶è¡Œå¤„ç†ï¼Œä½†æœ‰äº›ä¸šåŠ¡ä¸ä»…ä»…è¦æ‰§è¡Œè¿‡ç¨‹ï¼Œè¿˜è¦è·å–æ‰§è¡Œç»“æœã€‚ Java ä»1.5ç‰ˆæœ¬å¼€å§‹ï¼Œæä¾›äº† Callable å’Œ Futureï¼Œå¯ä»¥åœ¨ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹åå¾—åˆ°ä»»åŠ¡æ‰§è¡Œç»“æœã€‚ å½“ç„¶ä¹Ÿæä¾›äº†å…¶ä»–åŠŸèƒ½ï¼Œå¦‚ï¼šå–æ¶ˆä»»åŠ¡ã€æŸ¥è¯¢ä»»åŠ¡æ˜¯å¦å®Œæˆç­‰ Futureç±»ä½äºjava.util.concurrentåŒ…ä¸‹ï¼Œæ¥å£å®šä¹‰ï¼š public interface Future&lt;V&gt; { boolean cancel(boolean mayInterruptIfRunning); boolean isCancelled(); boolean isDone(); V get() throws InterruptedException, ExecutionException; V get(long timeout, TimeUnit unit) throws InterruptedException, ExecutionException, TimeoutException; } æ–¹æ³•æè¿°ï¼š cancel()ï¼šå–æ¶ˆä»»åŠ¡ï¼Œå¦‚æœå–æ¶ˆä»»åŠ¡æˆåŠŸè¿”å›trueï¼Œå¦‚æœå–æ¶ˆä»»åŠ¡å¤±è´¥åˆ™è¿”å›false isCancelled()ï¼šè¡¨ç¤ºä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆæˆåŠŸï¼Œå¦‚æœåœ¨ä»»åŠ¡æ­£å¸¸å®Œæˆå‰è¢«å–æ¶ˆæˆåŠŸï¼Œåˆ™è¿”å› true isDone()ï¼šè¡¨ç¤ºä»»åŠ¡æ˜¯å¦å·²ç»å®Œæˆï¼Œå¦‚æœå®Œæˆï¼Œè¿”å›true get()ï¼šè·å–æ‰§è¡Œç»“æœï¼Œè¿™ä¸ªæ–¹æ³•ä¼šäº§ç”Ÿé˜»å¡ï¼Œä¼šä¸€ç›´ç­‰åˆ°ä»»åŠ¡æ‰§è¡Œå®Œæ¯•æ‰è¿”å› get(long timeout, TimeUnit unit)ï¼šç”¨æ¥è·å–æ‰§è¡Œç»“æœï¼Œå¦‚æœåœ¨æŒ‡å®šæ—¶é—´å†…ï¼Œè¿˜æ²¡è·å–åˆ°ç»“æœï¼Œå°±ç›´æ¥è¿”å›null ä»£ç ç¤ºä¾‹ï¼š public class CallableAndFuture { public static ExecutorService executorService = new ThreadPoolExecutor(4, 40, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue&lt;Runnable&gt;(1024), new ThreadFactoryBuilder() .setNameFormat(&quot;demo-pool-%d&quot;).build(), new ThreadPoolExecutor.AbortPolicy()); static class MyCallable implements Callable&lt;String&gt; { @Override public String call() throws Exception { return &quot;å¼‚æ­¥å¤„ç†ï¼ŒCallable è¿”å›ç»“æœ&quot;; } } public static void main(String[] args) { Future&lt;String&gt; future = executorService.submit(new MyCallable()); try { System.out.println(future.get()); } catch (Exception e) { // nodo } finally { executorService.shutdown(); } } } Future è¡¨ç¤ºä¸€ä¸ªå¯èƒ½è¿˜æ²¡æœ‰å®Œæˆçš„å¼‚æ­¥ä»»åŠ¡çš„ç»“æœï¼Œé€šè¿‡ get æ–¹æ³•è·å–æ‰§è¡Œç»“æœï¼Œè¯¥æ–¹æ³•ä¼šé˜»å¡ç›´åˆ°ä»»åŠ¡è¿”å›ç»“æœã€‚ ä¸‰ã€FutureTask FutureTask å®ç°äº† RunnableFuture æ¥å£ï¼Œåˆ™ RunnableFuture æ¥å£ç»§æ‰¿äº† Runnable æ¥å£å’Œ Future æ¥å£ï¼Œæ‰€ä»¥å¯ä»¥å°† FutureTask å¯¹è±¡ä½œä¸ºä»»åŠ¡æäº¤ç»™ ThreadPoolExecutor å»æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¢« Thread æ‰§è¡Œï¼›åˆå› ä¸ºå®ç°äº† Future æ¥å£ï¼Œæ‰€ä»¥ä¹Ÿèƒ½ç”¨æ¥è·å¾—ä»»åŠ¡çš„æ‰§è¡Œç»“æœã€‚ FutureTask æ„é€ å‡½æ•°ï¼š public FutureTask(Callable&lt;V&gt; callable) public FutureTask(Runnable runnable, V result) FutureTask å¸¸ç”¨æ¥å°è£… Callable å’Œ Runnableï¼Œå¯ä»¥ä½œä¸ºä¸€ä¸ªä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± ä¸­æ‰§è¡Œã€‚é™¤äº†ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„ç±»ä¹‹å¤–ï¼Œä¹Ÿæä¾›äº†ä¸€äº›åŠŸèƒ½æ€§å‡½æ•°ä¾›æˆ‘ä»¬åˆ›å»ºè‡ªå®šä¹‰ task ç±»ä½¿ç”¨ã€‚ FutureTask çº¿ç¨‹å®‰å…¨ç”±CASæ¥ä¿è¯ã€‚ ExecutorService executor = Executors.newCachedThreadPool(); // FutureTaskåŒ…è£…callbaleä»»åŠ¡ï¼Œå†äº¤ç»™çº¿ç¨‹æ± æ‰§è¡Œ FutureTask&lt;Integer&gt; futureTask = new FutureTask&lt;&gt;(() -&gt; { System.out.println(&quot;å­çº¿ç¨‹å¼€å§‹è®¡ç®—ï¼š&quot;); Integer sum = 0; for (int i = 1; i &lt;= 100; i++) sum += i; return sum; }); // çº¿ç¨‹æ± æ‰§è¡Œä»»åŠ¡ï¼Œ è¿è¡Œç»“æœåœ¨ futureTask å¯¹è±¡é‡Œé¢ executor.submit(futureTask); try { System.out.println(&quot;taskè¿è¡Œç»“æœè®¡ç®—çš„æ€»å’Œä¸ºï¼š&quot; + futureTask.get()); } catch (Exception e) { e.printStackTrace(); } executor.shutdown(); Callable å’Œ Future çš„åŒºåˆ«ï¼šCallable ç”¨äºäº§ç”Ÿç»“æœï¼ŒFuture ç”¨äºè·å–ç»“æœ å¦‚æœæ˜¯å¯¹å¤šä¸ªä»»åŠ¡å¤šæ¬¡è‡ªç”±ä¸²è¡Œã€æˆ–å¹¶è¡Œç»„åˆï¼Œæ¶‰åŠå¤šä¸ªçº¿ç¨‹ä¹‹é—´åŒæ­¥é˜»å¡è·å–ç»“æœï¼ŒFuture ä»£ç å®ç°ä¼šæ¯”è¾ƒç¹çï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å¤„ç†å„ä¸ªäº¤å‰ç‚¹ï¼Œå¾ˆå®¹æ˜“å‡ºé”™ã€‚ å››ã€å¼‚æ­¥æ¡†æ¶ CompletableFuture Future ç±»é€šè¿‡ get() æ–¹æ³•é˜»å¡ç­‰å¾…è·å–å¼‚æ­¥æ‰§è¡Œçš„è¿è¡Œç»“æœï¼Œæ€§èƒ½æ¯”è¾ƒå·®ã€‚ JDK1.8 ä¸­ï¼ŒJava æä¾›äº† CompletableFuture ç±»ï¼Œå®ƒæ˜¯åŸºäºå¼‚æ­¥å‡½æ•°å¼ç¼–ç¨‹ã€‚ç›¸å¯¹é˜»å¡å¼ç­‰å¾…è¿”å›ç»“æœï¼ŒCompletableFuture å¯ä»¥é€šè¿‡å›è°ƒçš„æ–¹å¼æ¥å¤„ç†è®¡ç®—ç»“æœï¼Œå®ç°äº†å¼‚æ­¥éé˜»å¡ï¼Œæ€§èƒ½æ›´ä¼˜ã€‚ ä¼˜ç‚¹ï¼š å¼‚æ­¥ä»»åŠ¡ç»“æŸæ—¶ï¼Œä¼šè‡ªåŠ¨å›è°ƒæŸä¸ªå¯¹è±¡çš„æ–¹æ³• å¼‚æ­¥ä»»åŠ¡å‡ºé”™æ—¶ï¼Œä¼šè‡ªåŠ¨å›è°ƒæŸä¸ªå¯¹è±¡çš„æ–¹æ³• ä¸»çº¿ç¨‹è®¾ç½®å¥½å›è°ƒåï¼Œä¸å†å…³å¿ƒå¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œ æ³¡èŒ¶ç¤ºä¾‹ï¼š (å†…å®¹æ‘˜è‡ªï¼šæå®¢æ—¶é—´çš„ã€ŠJava å¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹) //ä»»åŠ¡1ï¼šæ´—æ°´å£¶-&gt;çƒ§å¼€æ°´ CompletableFuture&lt;Void&gt; f1 = CompletableFuture.runAsync(() -&gt; { System.out.println(&quot;T1:æ´—æ°´å£¶...&quot;); sleep(1, TimeUnit.SECONDS); System.out.println(&quot;T1:çƒ§å¼€æ°´...&quot;); sleep(15, TimeUnit.SECONDS); }); //ä»»åŠ¡2ï¼šæ´—èŒ¶å£¶-&gt;æ´—èŒ¶æ¯-&gt;æ‹¿èŒ¶å¶ CompletableFuture&lt;String&gt; f2 = CompletableFuture.supplyAsync(() -&gt; { System.out.println(&quot;T2:æ´—èŒ¶å£¶...&quot;); sleep(1, TimeUnit.SECONDS); System.out.println(&quot;T2:æ´—èŒ¶æ¯...&quot;); sleep(2, TimeUnit.SECONDS); System.out.println(&quot;T2:æ‹¿èŒ¶å¶...&quot;); sleep(1, TimeUnit.SECONDS); return &quot;é¾™äº•&quot;; }); //ä»»åŠ¡3ï¼šä»»åŠ¡1å’Œä»»åŠ¡2å®Œæˆåæ‰§è¡Œï¼šæ³¡èŒ¶ CompletableFuture&lt;String&gt; f3 = f1.thenCombine(f2, (__, tf) -&gt; { System.out.println(&quot;T1:æ‹¿åˆ°èŒ¶å¶:&quot; + tf); System.out.println(&quot;T1:æ³¡èŒ¶...&quot;); return &quot;ä¸ŠèŒ¶:&quot; + tf; }); //ç­‰å¾…ä»»åŠ¡3æ‰§è¡Œç»“æœ System.out.println(f3.join()); } CompletableFuture æä¾›äº†éå¸¸ä¸°å¯Œçš„APIï¼Œå¤§çº¦æœ‰50ç§å¤„ç†ä¸²è¡Œï¼Œå¹¶è¡Œï¼Œç»„åˆä»¥åŠå¤„ç†é”™è¯¯çš„æ–¹æ³•ã€‚ äº”ã€ SpringBoot æ³¨è§£ @Async é™¤äº†ç¡¬ç¼–ç çš„å¼‚æ­¥ç¼–ç¨‹å¤„ç†æ–¹å¼ï¼ŒSpringBoot æ¡†æ¶è¿˜æä¾›äº† æ³¨è§£å¼ è§£å†³æ–¹æ¡ˆï¼Œä»¥ æ–¹æ³•ä½“ ä¸ºè¾¹ç•Œï¼Œæ–¹æ³•ä½“å†…éƒ¨çš„ä»£ç é€»è¾‘å…¨éƒ¨æŒ‰å¼‚æ­¥æ–¹å¼æ‰§è¡Œã€‚ é¦–å…ˆï¼Œä½¿ç”¨ @EnableAsync å¯ç”¨å¼‚æ­¥æ³¨è§£ @SpringBootApplication @EnableAsync public class StartApplication { public static void main(String[] args) { SpringApplication.run(StartApplication.class, args); } } è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼š @Configuration @Slf4j public class ThreadPoolConfiguration { @Bean(name = &quot;defaultThreadPoolExecutor&quot;, destroyMethod = &quot;shutdown&quot;) public ThreadPoolExecutor systemCheckPoolExecutorService() { return new ThreadPoolExecutor(3, 10, 60, TimeUnit.SECONDS, new LinkedBlockingQueue&lt;Runnable&gt;(10000), new ThreadFactoryBuilder().setNameFormat(&quot;default-executor-%d&quot;).build(), (r, executor) -&gt; log.error(&quot;system pool is full! &quot;)); } } åœ¨å¼‚æ­¥å¤„ç†çš„æ–¹æ³•ä¸Šæ·»åŠ æ³¨è§£ @Async ï¼Œå½“å¯¹ execute æ–¹æ³• è°ƒç”¨æ—¶ï¼Œé€šè¿‡è‡ªå®šä¹‰çš„çº¿ç¨‹æ±  defaultThreadPoolExecutor å¼‚æ­¥åŒ–æ‰§è¡Œ execute æ–¹æ³• @Service public class AsyncServiceImpl implements AsyncService { @Async(&quot;defaultThreadPoolExecutor&quot;) public Boolean execute(Integer num) { System.out.println(&quot;çº¿ç¨‹ï¼š&quot; + Thread.currentThread().getName() + &quot; , ä»»åŠ¡ï¼š&quot; + num); return true; } } ç”¨ @Async æ³¨è§£æ ‡è®°çš„æ–¹æ³•ï¼Œç§°ä¸ºå¼‚æ­¥æ–¹æ³•ã€‚åœ¨spring bootåº”ç”¨ä¸­ä½¿ç”¨ @Async å¾ˆç®€å•ï¼š è°ƒç”¨å¼‚æ­¥æ–¹æ³•ç±»ä¸Šæˆ–è€…å¯åŠ¨ç±»åŠ ä¸Šæ³¨è§£ @EnableAsync åœ¨éœ€è¦è¢«å¼‚æ­¥è°ƒç”¨çš„æ–¹æ³•å¤–åŠ ä¸Š @Async æ‰€ä½¿ç”¨çš„ @Async æ³¨è§£æ–¹æ³•çš„ç±»å¯¹è±¡åº”è¯¥æ˜¯Springå®¹å™¨ç®¡ç†çš„beanå¯¹è±¡ï¼› å…­ã€Spring ApplicationEvent äº‹ä»¶ äº‹ä»¶æœºåˆ¶åœ¨ä¸€äº›å¤§å‹é¡¹ç›®ä¸­è¢«ç»å¸¸ä½¿ç”¨ï¼ŒSpring ä¸“é—¨æä¾›äº†ä¸€å¥—äº‹ä»¶æœºåˆ¶çš„æ¥å£ï¼Œæ»¡è¶³äº†æ¶æ„åŸåˆ™ä¸Šçš„è§£è€¦ã€‚ ApplicationContext é€šè¿‡ ApplicationEvent ç±»å’Œ ApplicationListener æ¥å£è¿›è¡Œäº‹ä»¶å¤„ç†ã€‚å¦‚æœå°†å®ç° ApplicationListener æ¥å£çš„ bean æ³¨å…¥åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼Œåˆ™æ¯æ¬¡ä½¿ç”¨ ApplicationContext å‘å¸ƒ ApplicationEvent æ—¶ï¼Œéƒ½ä¼šé€šçŸ¥è¯¥ beanã€‚æœ¬è´¨ä¸Šï¼Œè¿™æ˜¯æ ‡å‡†çš„è§‚å¯Ÿè€…è®¾è®¡æ¨¡å¼ã€‚ ApplicationEvent æ˜¯ç”± Spring æä¾›çš„æ‰€æœ‰ Event ç±»çš„åŸºç±» é¦–å…ˆï¼Œè‡ªå®šä¹‰ä¸šåŠ¡äº‹ä»¶å­ç±»ï¼Œç»§æ‰¿è‡ª ApplicationEventï¼Œé€šè¿‡æ³›å‹æ³¨å…¥ä¸šåŠ¡æ¨¡å‹å‚æ•°ç±»ã€‚ç›¸å½“äº MQ çš„æ¶ˆæ¯ä½“ã€‚ public class OrderEvent extends AbstractGenericEvent&lt;OrderModel&gt; { public OrderEvent(OrderModel source) { super(source); } } ç„¶åï¼Œç¼–å†™äº‹ä»¶ç›‘å¬å™¨ã€‚ApplicationListener æ¥å£æ˜¯ç”± Spring æä¾›çš„äº‹ä»¶è®¢é˜…è€…å¿…é¡»å®ç°çš„æ¥å£ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªå­ç±»ï¼Œç»§æ‰¿ ApplicationListenerã€‚ç›¸å½“äº MQ çš„æ¶ˆè´¹ç«¯ @Component public class OrderEventListener implements ApplicationListener&lt;OrderEvent&gt; { @Override public void onApplicationEvent(OrderEvent event) { System.out.println(&quot;ã€OrderEventListenerã€‘ç›‘å¬å™¨å¤„ç†ï¼&quot; + JSON.toJSONString(event.getSource())); } } æœ€åï¼Œå‘å¸ƒäº‹ä»¶ï¼ŒæŠŠæŸä¸ªäº‹ä»¶å‘Šè¯‰æ‰€æœ‰ä¸è¿™ä¸ªäº‹ä»¶ç›¸å…³çš„ç›‘å¬å™¨ã€‚ç›¸å½“äº MQ çš„ç”Ÿäº§ç«¯ã€‚ OrderModel orderModel = new OrderModel(); orderModel.setOrderId((long) i); orderModel.setBuyerName(&quot;Tom-&quot; + i); orderModel.setSellerName(&quot;judy-&quot; + i); orderModel.setAmount(100L); // å‘å¸ƒSpringäº‹ä»¶é€šçŸ¥ SpringUtils.getApplicationContext().publishEvent(new OrderEvent(orderModel)); åŠ ä¸ªé¤ï¼š [æ¶ˆè´¹ç«¯]çº¿ç¨‹ï¼šhttp-nio-8090-exec-1ï¼Œæ¶ˆè´¹äº‹ä»¶ {&quot;amount&quot;:100.0,&quot;buyerName&quot;:&quot;Tom-1&quot;,&quot;orderId&quot;:1,&quot;sellerName&quot;:&quot;judy-1&quot;} [ç”Ÿäº§ç«¯]çº¿ç¨‹ï¼šhttp-nio-8090-exec-1ï¼Œå‘å¸ƒäº‹ä»¶ 1 [æ¶ˆè´¹ç«¯]çº¿ç¨‹ï¼šhttp-nio-8090-exec-1ï¼Œæ¶ˆè´¹äº‹ä»¶ {&quot;amount&quot;:100.0,&quot;buyerName&quot;:&quot;Tom-2&quot;,&quot;orderId&quot;:2,&quot;sellerName&quot;:&quot;judy-2&quot;} [ç”Ÿäº§ç«¯]çº¿ç¨‹ï¼šhttp-nio-8090-exec-1ï¼Œå‘å¸ƒäº‹ä»¶ 2 [æ¶ˆè´¹ç«¯]çº¿ç¨‹ï¼šhttp-nio-8090-exec-1ï¼Œæ¶ˆè´¹äº‹ä»¶ {&quot;amount&quot;:100.0,&quot;buyerName&quot;:&quot;Tom-3&quot;,&quot;orderId&quot;:3,&quot;sellerName&quot;:&quot;judy-3&quot;} [ç”Ÿäº§ç«¯]çº¿ç¨‹ï¼šhttp-nio-8090-exec-1ï¼Œå‘å¸ƒäº‹ä»¶ 3 ä¸Šé¢æ˜¯è·‘äº†ä¸ªdemoçš„è¿è¡Œç»“æœï¼Œæˆ‘ä»¬å‘ç°æ— è®ºç”Ÿäº§ç«¯è¿˜æ˜¯æ¶ˆè´¹ç«¯ï¼Œä½¿ç”¨äº†åŒä¸€ä¸ªçº¿ç¨‹ http-nio-8090-exec-1ï¼ŒSpring æ¡†æ¶çš„äº‹ä»¶æœºåˆ¶é»˜è®¤æ˜¯åŒæ­¥é˜»å¡çš„ã€‚åªæ˜¯åœ¨ä»£ç è§„èŒƒæ–¹é¢åšäº†è§£è€¦ï¼Œæœ‰è¾ƒå¥½çš„æ‰©å±•æ€§ï¼Œä½†åº•å±‚è¿˜æ˜¯é‡‡ç”¨åŒæ­¥è°ƒç”¨æ–¹å¼ã€‚ é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚æœæƒ³å®ç°å¼‚æ­¥è°ƒç”¨ï¼Œå¦‚ä½•å¤„ç†ï¼Ÿ æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ª SimpleApplicationEventMulticasterï¼Œå¹¶è®¾ç½® TaskExecutorï¼Œæ­¤æ—¶æ‰€æœ‰çš„æ¶ˆè´¹äº‹ä»¶é‡‡ç”¨å¼‚æ­¥çº¿ç¨‹æ‰§è¡Œã€‚ @Component public class SpringConfiguration { @Bean public SimpleApplicationEventMulticaster applicationEventMulticaster(@Qualifier(&quot;defaultThreadPoolExecutor&quot;) ThreadPoolExecutor defaultThreadPoolExecutor) { SimpleApplicationEventMulticaster simpleApplicationEventMulticaster = new SimpleApplicationEventMulticaster(); simpleApplicationEventMulticaster.setTaskExecutor(defaultThreadPoolExecutor); return simpleApplicationEventMulticaster; } } æˆ‘ä»¬çœ‹ä¸‹æ”¹é€ åçš„è¿è¡Œç»“æœï¼š [ç”Ÿäº§ç«¯]çº¿ç¨‹ï¼šhttp-nio-8090-exec-1ï¼Œå‘å¸ƒäº‹ä»¶ 1 [ç”Ÿäº§ç«¯]çº¿ç¨‹ï¼šhttp-nio-8090-exec-1ï¼Œå‘å¸ƒäº‹ä»¶ 2 [ç”Ÿäº§ç«¯]çº¿ç¨‹ï¼šhttp-nio-8090-exec-1ï¼Œå‘å¸ƒäº‹ä»¶ 3 [æ¶ˆè´¹ç«¯]çº¿ç¨‹ï¼šdefault-executor-1ï¼Œæ¶ˆè´¹äº‹ä»¶ {&quot;amount&quot;:100.0,&quot;buyerName&quot;:&quot;Tom-2&quot;,&quot;orderId&quot;:2,&quot;sellerName&quot;:&quot;judy-2&quot;} [æ¶ˆè´¹ç«¯]çº¿ç¨‹ï¼šdefault-executor-2ï¼Œæ¶ˆè´¹äº‹ä»¶ {&quot;amount&quot;:100.0,&quot;buyerName&quot;:&quot;Tom-1&quot;,&quot;orderId&quot;:1,&quot;sellerName&quot;:&quot;judy-1&quot;} [æ¶ˆè´¹ç«¯]çº¿ç¨‹ï¼šdefault-executor-0ï¼Œæ¶ˆè´¹äº‹ä»¶ {&quot;amount&quot;:100.0,&quot;buyerName&quot;:&quot;Tom-3&quot;,&quot;orderId&quot;:3,&quot;sellerName&quot;:&quot;judy-3&quot;} SimpleApplicationEventMulticaster è¿™ä¸ªæˆ‘ä»¬è‡ªå·±å®ä¾‹åŒ–çš„ Bean ä¸ç³»ç»Ÿé»˜è®¤çš„åŠ è½½é¡ºåºå¦‚ä½•ï¼Ÿä¼šä¸ä¼šæœ‰å†²çªï¼Ÿ æŸ¥äº†ä¸‹ Spring æºç ï¼Œå¤„ç†é€»è¾‘åœ¨ AbstractApplicationContext#initApplicationEventMulticaster æ–¹æ³•ä¸­ï¼Œé€šè¿‡ beanFactory æŸ¥æ‰¾æ˜¯å¦æœ‰è‡ªå®šä¹‰çš„ Beanï¼Œå¦‚æœæ²¡æœ‰ï¼Œå®¹å™¨ä¼šè‡ªå·± new ä¸€ä¸ª SimpleApplicationEventMulticaster å¯¹è±¡æ³¨å…¥åˆ°å®¹å™¨ä¸­ã€‚ ä»£ç åœ°å€ï¼šhttps://github.com/aalansehaiyang/wx-project ä¸ƒã€æ¶ˆæ¯é˜Ÿåˆ— å¼‚æ­¥æ¶æ„æ˜¯äº’è”ç½‘ç³»ç»Ÿä¸­ä¸€ç§å…¸å‹æ¶æ„æ¨¡å¼ï¼Œä¸åŒæ­¥æ¶æ„ç›¸å¯¹åº”ã€‚è€Œæ¶ˆæ¯é˜Ÿåˆ—å¤©ç”Ÿå°±æ˜¯è¿™ç§å¼‚æ­¥æ¶æ„ï¼Œå…·æœ‰è¶…é«˜ååé‡å’Œè¶…ä½æ—¶å»¶ã€‚ æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥æ¶æ„çš„ä¸»è¦è§’è‰²åŒ…æ‹¬æ¶ˆæ¯ç”Ÿäº§è€…ã€æ¶ˆæ¯é˜Ÿåˆ—å’Œæ¶ˆæ¯æ¶ˆè´¹è€…ã€‚ æ¶ˆæ¯ç”Ÿäº§è€…å°±æ˜¯ä¸»åº”ç”¨ç¨‹åºï¼Œç”Ÿäº§è€…å°†è°ƒç”¨è¯·æ±‚å°è£…æˆæ¶ˆæ¯å‘é€ç»™æ¶ˆæ¯é˜Ÿåˆ—ã€‚ æ¶ˆæ¯é˜Ÿåˆ—çš„èŒè´£å°±æ˜¯ç¼“å†²æ¶ˆæ¯ï¼Œç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹ã€‚æ ¹æ®æ¶ˆè´¹æ–¹å¼åˆåˆ†ä¸ºç‚¹å¯¹ç‚¹æ¨¡å¼å’Œå‘å¸ƒè®¢é˜…æ¨¡å¼ä¸¤ç§ã€‚ æ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œç”¨æ¥ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ‹‰å–ã€æ¶ˆè´¹æ¶ˆæ¯ï¼Œå®Œæˆä¸šåŠ¡é€»è¾‘å¤„ç†ã€‚ å½“ç„¶å¸‚é¢ä¸Šæ¶ˆæ¯é˜Ÿåˆ—æ¡†æ¶éå¸¸å¤šï¼Œå¸¸è§çš„æœ‰RabbitMQã€Kafkaã€RocketMQã€ActiveMQ å’Œ Pulsar ç­‰ ä¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—çš„åŠŸèƒ½ç‰¹æ€§ä¼šç•¥æœ‰ä¸åŒï¼Œä½†æ•´ä½“æ¶æ„ç±»ä¼¼ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚ æˆ‘ä»¬åªéœ€è¦è®°ä½ä¸€ä¸ªå…³é”®ç‚¹ï¼Œå€ŸåŠ©æ¶ˆæ¯é˜Ÿåˆ—è¿™ä¸ªä¸­é—´ä»¶å¯ä»¥é«˜æ•ˆçš„å®ç°å¼‚æ­¥ç¼–ç¨‹ã€‚ ","link":"https://tianxiawuhao.github.io/9hE3Lg3SU/"},{"title":"RabbitMQ","content":"æ€ç»´å¯¼å›¾ï¼š 1. æ¶ˆæ¯é˜Ÿåˆ— 1.1 æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å¼ æ¶ˆæ¯é˜Ÿåˆ—ç›®å‰ä¸»è¦ 2 ç§æ¨¡å¼ï¼Œåˆ†åˆ«ä¸ºâ€œç‚¹å¯¹ç‚¹æ¨¡å¼â€å’Œâ€œå‘å¸ƒ/è®¢é˜…æ¨¡å¼â€ã€‚ 1.1.1 ç‚¹å¯¹ç‚¹æ¨¡å¼ ä¸€ä¸ªå…·ä½“çš„æ¶ˆæ¯åªèƒ½ç”±ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œå¤šä¸ªç”Ÿäº§è€…å¯ä»¥å‘åŒä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å‘é€æ¶ˆæ¯ï¼Œä½†æ˜¯ä¸€ä¸ªæ¶ˆæ¯åœ¨è¢«ä¸€ä¸ªæ¶ˆæ¯è€…å¤„ç†çš„æ—¶å€™ï¼Œè¿™ä¸ªæ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸Šä¼šè¢«é”ä½æˆ–è€…è¢«ç§»é™¤å¹¶ä¸”å…¶ä»–æ¶ˆè´¹è€…æ— æ³•å¤„ç†è¯¥æ¶ˆæ¯ã€‚ éœ€è¦é¢å¤–æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ¶ˆè´¹è€…å¤„ç†ä¸€ä¸ªæ¶ˆæ¯å¤±è´¥äº†ï¼Œæ¶ˆæ¯ç³»ç»Ÿä¸€èˆ¬ä¼šæŠŠè¿™ä¸ªæ¶ˆæ¯æ”¾å›é˜Ÿåˆ—ï¼Œè¿™æ ·å…¶ä»–æ¶ˆè´¹è€…å¯ä»¥ç»§ç»­å¤„ç†ã€‚ 1.1.2 å‘å¸ƒ/è®¢é˜…æ¨¡å¼ å•ä¸ªæ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªè®¢é˜…è€…å¹¶å‘çš„è·å–å’Œå¤„ç†ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè®¢é˜…æœ‰ä¸¤ç§ç±»å‹ï¼š ä¸´æ—¶ï¼ˆephemeralï¼‰è®¢é˜…ï¼šè¿™ç§è®¢é˜…åªæœ‰åœ¨æ¶ˆè´¹è€…å¯åŠ¨å¹¶ä¸”è¿è¡Œçš„æ—¶å€™æ‰å­˜åœ¨ã€‚ä¸€æ—¦æ¶ˆè´¹è€…é€€å‡ºï¼Œç›¸åº”çš„è®¢é˜…ä»¥åŠå°šæœªå¤„ç†çš„æ¶ˆæ¯å°±ä¼šä¸¢å¤±ã€‚ æŒä¹…ï¼ˆdurableï¼‰è®¢é˜…ï¼šè¿™ç§è®¢é˜…ä¼šä¸€ç›´å­˜åœ¨ï¼Œé™¤éä¸»åŠ¨å»åˆ é™¤ã€‚æ¶ˆè´¹è€…é€€å‡ºåï¼Œæ¶ˆæ¯ç³»ç»Ÿä¼šç»§ç»­ç»´æŠ¤è¯¥è®¢é˜…ï¼Œå¹¶ä¸”åç»­æ¶ˆæ¯å¯ä»¥è¢«ç»§ç»­å¤„ç†ã€‚ 1.2 è¡¡é‡æ ‡å‡† å¯¹æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡ŒæŠ€æœ¯é€‰å‹æ—¶ï¼Œéœ€è¦é€šè¿‡ä»¥ä¸‹æŒ‡æ ‡è¡¡é‡ä½ æ‰€é€‰æ‹©çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ˜¯å¦å¯ä»¥æ»¡è¶³ä½ çš„éœ€æ±‚ï¼š æ¶ˆæ¯é¡ºåºï¼šå‘é€åˆ°é˜Ÿåˆ—çš„æ¶ˆæ¯ï¼Œæ¶ˆè´¹æ—¶æ˜¯å¦å¯ä»¥ä¿è¯æ¶ˆè´¹çš„é¡ºåºï¼Œæ¯”å¦‚Aå…ˆä¸‹å•ï¼ŒBåä¸‹å•ï¼Œåº”è¯¥æ˜¯Aå…ˆå»æ‰£åº“å­˜ï¼ŒBå†å»æ‰£ï¼Œé¡ºåºä¸èƒ½åã€‚ æ¶ˆæ¯è·¯ç”±ï¼šæ ¹æ®è·¯ç”±è§„åˆ™ï¼Œåªè®¢é˜…åŒ¹é…è·¯ç”±è§„åˆ™çš„æ¶ˆæ¯ï¼Œæ¯”å¦‚æœ‰A/Bä¸¤è€…è§„åˆ™çš„æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…å¯ä»¥åªè®¢é˜…Aæ¶ˆæ¯ï¼ŒBæ¶ˆæ¯ä¸ä¼šæ¶ˆè´¹ã€‚ æ¶ˆæ¯å¯é æ€§ï¼šæ˜¯å¦ä¼šå­˜åœ¨ä¸¢æ¶ˆæ¯çš„æƒ…å†µï¼Œæ¯”å¦‚æœ‰A/Bä¸¤ä¸ªæ¶ˆæ¯ï¼Œæœ€ååªæœ‰Bæ¶ˆæ¯èƒ½æ¶ˆè´¹ï¼ŒAæ¶ˆæ¯ä¸¢å¤±ã€‚ æ¶ˆæ¯æ—¶åºï¼šä¸»è¦åŒ…æ‹¬â€œæ¶ˆæ¯å­˜æ´»æ—¶é—´â€å’Œâ€œå»¶è¿Ÿ/é¢„å®šçš„æ¶ˆæ¯â€ï¼Œâ€œæ¶ˆæ¯å­˜æ´»æ—¶é—´â€è¡¨ç¤ºç”Ÿäº§è€…å¯ä»¥å¯¹æ¶ˆæ¯è®¾ç½®TTLï¼Œå¦‚æœè¶…è¿‡è¯¥TTLï¼Œæ¶ˆæ¯ä¼šè‡ªåŠ¨æ¶ˆå¤±ï¼›â€œå»¶è¿Ÿ/é¢„å®šçš„æ¶ˆæ¯â€æŒ‡çš„æ˜¯å¯ä»¥å»¶è¿Ÿæˆ–è€…é¢„è®¢æ¶ˆè´¹æ¶ˆæ¯ï¼Œæ¯”å¦‚å»¶æ—¶5åˆ†é’Ÿï¼Œé‚£ä¹ˆæ¶ˆæ¯ä¼š5åˆ†é’Ÿåæ‰èƒ½è®©æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œæ—¶é—´æœªåˆ°çš„è¯ï¼Œæ˜¯ä¸èƒ½æ¶ˆè´¹çš„ã€‚ æ¶ˆæ¯ç•™å­˜ï¼šæ¶ˆæ¯æ¶ˆè´¹æˆåŠŸåï¼Œæ˜¯å¦è¿˜ä¼šç»§ç»­ä¿ç•™åœ¨æ¶ˆæ¯é˜Ÿåˆ—ã€‚ å®¹é”™æ€§ï¼šå½“ä¸€æ¡æ¶ˆæ¯æ¶ˆè´¹å¤±è´¥åï¼Œæ˜¯å¦æœ‰ä¸€äº›æœºåˆ¶ï¼Œä¿è¯è¿™æ¡æ¶ˆæ¯æ˜¯ä¸€ç§èƒ½æˆåŠŸï¼Œæ¯”å¦‚å¼‚æ­¥ç¬¬ä¸‰æ–¹é€€æ¬¾æ¶ˆæ¯ï¼Œéœ€è¦ä¿è¯è¿™æ¡æ¶ˆæ¯æ¶ˆè´¹æ‰ï¼Œæ‰èƒ½ç¡®å®šç»™ç”¨æˆ·é€€æ¬¾æˆåŠŸï¼Œæ‰€ä»¥å¿…é¡»ä¿è¯è¿™æ¡æ¶ˆæ¯æ¶ˆè´¹æˆåŠŸçš„å‡†ç¡®æ€§ã€‚ ä¼¸ç¼©ï¼šå½“æ¶ˆæ¯é˜Ÿåˆ—æ€§èƒ½æœ‰é—®é¢˜ï¼Œæ¯”å¦‚æ¶ˆè´¹å¤ªæ…¢ï¼Œæ˜¯å¦å¯ä»¥å¿«é€Ÿæ”¯æŒåº“å®¹ï¼›å½“æ¶ˆè´¹é˜Ÿåˆ—è¿‡å¤šï¼Œæµªè´¹ç³»ç»Ÿèµ„æºï¼Œæ˜¯å¦å¯ä»¥æ”¯æŒç¼©å®¹ã€‚ ååé‡ï¼šæ”¯æŒçš„æœ€é«˜å¹¶å‘æ•°ã€‚ 2. RabbitMQ åŸç†åˆæ¢ RabbitMQ 2007 å¹´å‘å¸ƒï¼Œæ˜¯ä½¿ç”¨ Erlang è¯­è¨€å¼€å‘çš„å¼€æºæ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼ŒåŸºäº AMQP åè®®æ¥å®ç°ã€‚ 2.1 åŸºæœ¬æ¦‚å¿µ æåˆ°RabbitMQï¼Œå°±ä¸å¾—ä¸æAMQPåè®®ã€‚AMQPåè®®æ˜¯å…·æœ‰ç°ä»£ç‰¹å¾çš„äºŒè¿›åˆ¶åè®®ã€‚æ˜¯ä¸€ä¸ªæä¾›ç»Ÿä¸€æ¶ˆæ¯æœåŠ¡çš„åº”ç”¨å±‚æ ‡å‡†é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼Œæ˜¯åº”ç”¨å±‚åè®®çš„ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼Œä¸ºé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶è®¾è®¡ã€‚ å…ˆäº†è§£ä¸€ä¸‹AMQPåè®®ä¸­é—´çš„å‡ ä¸ªé‡è¦æ¦‚å¿µï¼š Serverï¼šæ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œå®ç°AMQPå®ä½“æœåŠ¡ã€‚ Connectionï¼šè¿æ¥ï¼Œåº”ç”¨ç¨‹åºä¸Serverçš„ç½‘ç»œè¿æ¥ï¼ŒTCPè¿æ¥ã€‚ Channelï¼šä¿¡é“ï¼Œæ¶ˆæ¯è¯»å†™ç­‰æ“ä½œåœ¨ä¿¡é“ä¸­è¿›è¡Œã€‚å®¢æˆ·ç«¯å¯ä»¥å»ºç«‹å¤šä¸ªä¿¡é“ï¼Œæ¯ä¸ªä¿¡é“ä»£è¡¨ä¸€ä¸ªä¼šè¯ä»»åŠ¡ã€‚ Messageï¼šæ¶ˆæ¯ï¼Œåº”ç”¨ç¨‹åºå’ŒæœåŠ¡å™¨ä¹‹é—´ä¼ é€çš„æ•°æ®ï¼Œæ¶ˆæ¯å¯ä»¥éå¸¸ç®€å•ï¼Œä¹Ÿå¯ä»¥å¾ˆå¤æ‚ã€‚ç”±Propertieså’ŒBodyç»„æˆã€‚Propertiesä¸ºå¤–åŒ…è£…ï¼Œå¯ä»¥å¯¹æ¶ˆæ¯è¿›è¡Œä¿®é¥°ï¼Œæ¯”å¦‚æ¶ˆæ¯çš„ä¼˜å…ˆçº§ã€å»¶è¿Ÿç­‰é«˜çº§ç‰¹æ€§ï¼›Bodyå°±æ˜¯æ¶ˆæ¯ä½“å†…å®¹ã€‚ Virtual Hostï¼šè™šæ‹Ÿä¸»æœºï¼Œç”¨äºé€»è¾‘éš”ç¦»ã€‚ä¸€ä¸ªè™šæ‹Ÿä¸»æœºé‡Œé¢å¯ä»¥æœ‰è‹¥å¹²ä¸ªExchangeå’ŒQueueï¼ŒåŒä¸€ä¸ªè™šæ‹Ÿä¸»æœºé‡Œé¢ä¸èƒ½æœ‰ç›¸åŒåç§°çš„Exchangeæˆ–Queueã€‚ Exchangeï¼šäº¤æ¢å™¨ï¼Œæ¥æ”¶æ¶ˆæ¯ï¼ŒæŒ‰ç…§è·¯ç”±è§„åˆ™å°†æ¶ˆæ¯è·¯ç”±åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªé˜Ÿåˆ—ã€‚å¦‚æœè·¯ç”±ä¸åˆ°ï¼Œæˆ–è€…è¿”å›ç»™ç”Ÿäº§è€…ï¼Œæˆ–è€…ç›´æ¥ä¸¢å¼ƒã€‚RabbitMQå¸¸ç”¨çš„äº¤æ¢å™¨å¸¸ç”¨ç±»å‹æœ‰directã€topicã€fanoutã€headerså››ç§ï¼Œåé¢è¯¦ç»†ä»‹ç»ã€‚ Bindingï¼šç»‘å®šï¼Œäº¤æ¢å™¨å’Œæ¶ˆæ¯é˜Ÿåˆ—ä¹‹é—´çš„è™šæ‹Ÿè¿æ¥ï¼Œç»‘å®šä¸­å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ªRoutingKeyã€‚ RoutingKeyï¼šè·¯ç”±é”®ï¼Œç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€ç»™äº¤æ¢å™¨çš„æ—¶å€™ï¼Œä¼šå‘é€ä¸€ä¸ªRoutingKeyï¼Œç”¨æ¥æŒ‡å®šè·¯ç”±è§„åˆ™ï¼Œè¿™æ ·äº¤æ¢å™¨å°±çŸ¥é“æŠŠæ¶ˆæ¯å‘é€åˆ°å“ªä¸ªé˜Ÿåˆ—ã€‚è·¯ç”±é”®é€šå¸¸ä¸ºä¸€ä¸ªâ€œ.â€åˆ†å‰²çš„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚â€œcom.rabbitmqâ€ã€‚ Queueï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œç”¨æ¥ä¿å­˜æ¶ˆæ¯ï¼Œä¾›æ¶ˆè´¹è€…æ¶ˆè´¹ã€‚ 2.2 å·¥ä½œåŸç† AMQP åè®®æ¨¡å‹ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šç”Ÿäº§è€…ã€æ¶ˆè´¹è€…å’ŒæœåŠ¡ç«¯ï¼Œæ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š ç”Ÿäº§è€…æ˜¯è¿æ¥åˆ° Serverï¼Œå»ºç«‹ä¸€ä¸ªè¿æ¥ï¼Œå¼€å¯ä¸€ä¸ªä¿¡é“ã€‚ ç”Ÿäº§è€…å£°æ˜äº¤æ¢å™¨å’Œé˜Ÿåˆ—ï¼Œè®¾ç½®ç›¸å…³å±æ€§ï¼Œå¹¶é€šè¿‡è·¯ç”±é”®å°†äº¤æ¢å™¨å’Œé˜Ÿåˆ—è¿›è¡Œç»‘å®šã€‚ æ¶ˆè´¹è€…ä¹Ÿéœ€è¦è¿›è¡Œå»ºç«‹è¿æ¥ï¼Œå¼€å¯ä¿¡é“ç­‰æ“ä½œï¼Œä¾¿äºæ¥æ”¶æ¶ˆæ¯ã€‚ ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ï¼Œå‘é€åˆ°æœåŠ¡ç«¯ä¸­çš„è™šæ‹Ÿä¸»æœºã€‚ è™šæ‹Ÿä¸»æœºä¸­çš„äº¤æ¢å™¨æ ¹æ®è·¯ç”±é”®é€‰æ‹©è·¯ç”±è§„åˆ™ï¼Œå‘é€åˆ°ä¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚ è®¢é˜…äº†æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹è€…å°±å¯ä»¥è·å–åˆ°æ¶ˆæ¯ï¼Œè¿›è¡Œæ¶ˆè´¹ã€‚ 2.3 å¸¸ç”¨äº¤æ¢å™¨ RabbitMQå¸¸ç”¨çš„äº¤æ¢å™¨ç±»å‹æœ‰directã€topicã€fanoutã€headerså››ç§ï¼š Direct Exchangeï¼šè§æ–‡çŸ¥æ„ï¼Œç›´è¿äº¤æ¢æœºæ„æ€æ˜¯æ­¤äº¤æ¢æœºéœ€è¦ç»‘å®šä¸€ä¸ªé˜Ÿåˆ—ï¼Œè¦æ±‚è¯¥æ¶ˆæ¯ä¸ä¸€ä¸ªç‰¹å®šçš„è·¯ç”±é”®å®Œå…¨åŒ¹é…ã€‚ç®€å•ç‚¹è¯´å°±æ˜¯ä¸€å¯¹ä¸€çš„ï¼Œç‚¹å¯¹ç‚¹çš„å‘é€ã€‚ Fanout Exchangeï¼šè¿™ç§ç±»å‹çš„äº¤æ¢æœºéœ€è¦å°†é˜Ÿåˆ—ç»‘å®šåˆ°äº¤æ¢æœºä¸Šã€‚ä¸€ä¸ªå‘é€åˆ°äº¤æ¢æœºçš„æ¶ˆæ¯éƒ½ä¼šè¢«è½¬å‘åˆ°ä¸è¯¥äº¤æ¢æœºç»‘å®šçš„æ‰€æœ‰é˜Ÿåˆ—ä¸Šã€‚å¾ˆåƒå­ç½‘å¹¿æ’­ï¼Œæ¯å°å­ç½‘å†…çš„ä¸»æœºéƒ½è·å¾—äº†ä¸€ä»½å¤åˆ¶çš„æ¶ˆæ¯ã€‚ç®€å•ç‚¹è¯´å°±æ˜¯å‘å¸ƒè®¢é˜…ã€‚ Topic Exchangeï¼šç›´æ¥ç¿»è¯‘çš„è¯å«åšä¸»é¢˜äº¤æ¢æœºï¼Œå¦‚æœä»ç”¨æ³•ä¸Šé¢ç¿»è¯‘å¯èƒ½å«é€šé…ç¬¦äº¤æ¢æœºä¼šæ›´åŠ è´´åˆ‡ã€‚è¿™ç§äº¤æ¢æœºæ˜¯ä½¿ç”¨é€šé…ç¬¦å»åŒ¹é…ï¼Œè·¯ç”±åˆ°å¯¹åº”çš„é˜Ÿåˆ—ã€‚é€šé…ç¬¦æœ‰ä¸¤ç§ï¼š&quot;*&quot; ã€ &quot;#&quot;ã€‚éœ€è¦æ³¨æ„çš„æ˜¯é€šé…ç¬¦å‰é¢å¿…é¡»è¦åŠ ä¸Š&quot;.&quot;ç¬¦å·ã€‚ *ç¬¦å·ï¼šæœ‰ä¸”åªåŒ¹é…ä¸€ä¸ªè¯ã€‚æ¯”å¦‚ a.*å¯ä»¥åŒ¹é…åˆ°&quot;a.b&quot;ã€&quot;a.c&quot;ï¼Œä½†æ˜¯åŒ¹é…ä¸äº†&quot;a.b.c&quot;ã€‚ #ç¬¦å·ï¼šåŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªè¯ã€‚æ¯”å¦‚&quot;rabbit.#&quot;æ—¢å¯ä»¥åŒ¹é…åˆ°&quot;rabbit.a.b&quot;ã€&quot;rabbit.a&quot;ï¼Œä¹Ÿå¯ä»¥åŒ¹é…åˆ°&quot;rabbit.a.b.c&quot;ã€‚ Headers Exchangeï¼šè¿™ç§äº¤æ¢æœºç”¨çš„ç›¸å¯¹æ²¡è¿™ä¹ˆå¤šã€‚å®ƒè·Ÿä¸Šé¢ä¸‰ç§æœ‰ç‚¹åŒºåˆ«ï¼Œå®ƒçš„è·¯ç”±ä¸æ˜¯ç”¨routingKeyè¿›è¡Œè·¯ç”±åŒ¹é…ï¼Œè€Œæ˜¯åœ¨åŒ¹é…è¯·æ±‚å¤´ä¸­æ‰€å¸¦çš„é”®å€¼è¿›è¡Œè·¯ç”±ã€‚åˆ›å»ºé˜Ÿåˆ—éœ€è¦è®¾ç½®ç»‘å®šçš„å¤´éƒ¨ä¿¡æ¯ï¼Œæœ‰ä¸¤ç§æ¨¡å¼ï¼šå…¨éƒ¨åŒ¹é…å’Œéƒ¨åˆ†åŒ¹é…ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œäº¤æ¢æœºä¼šæ ¹æ®ç”Ÿäº§è€…å‘é€è¿‡æ¥çš„å¤´éƒ¨ä¿¡æ¯æºå¸¦çš„é”®å€¼å»åŒ¹é…é˜Ÿåˆ—ç»‘å®šçš„é”®å€¼ï¼Œè·¯ç”±åˆ°å¯¹åº”çš„é˜Ÿåˆ—ã€‚ 2.4 æ¶ˆè´¹åŸç† æˆ‘ä»¬å…ˆçœ‹å‡ ä¸ªåŸºæœ¬æ¦‚å¿µï¼š brokerï¼šæ¯ä¸ªèŠ‚ç‚¹è¿è¡Œçš„æœåŠ¡ç¨‹åºï¼ŒåŠŸèƒ½ä¸ºç»´æŠ¤è¯¥èŠ‚ç‚¹çš„é˜Ÿåˆ—çš„å¢åˆ ä»¥åŠè½¬å‘é˜Ÿåˆ—æ“ä½œè¯·æ±‚ã€‚ master queueï¼šæ¯ä¸ªé˜Ÿåˆ—éƒ½åˆ†ä¸ºä¸€ä¸ªä¸»é˜Ÿåˆ—å’Œè‹¥å¹²ä¸ªé•œåƒé˜Ÿåˆ—ã€‚ mirror queueï¼šé•œåƒé˜Ÿåˆ—ï¼Œä½œä¸ºmaster queueçš„å¤‡ä»½ã€‚åœ¨master queueæ‰€åœ¨èŠ‚ç‚¹æŒ‚æ‰ä¹‹åï¼Œç³»ç»ŸæŠŠmirror queueæå‡ä¸ºmaster queueï¼Œè´Ÿè´£å¤„ç†å®¢æˆ·ç«¯é˜Ÿåˆ—æ“ä½œè¯·æ±‚ã€‚æ³¨æ„ï¼Œmirror queueåªåšé•œåƒï¼Œè®¾è®¡ç›®çš„ä¸æ˜¯ä¸ºäº†æ‰¿æ‹…å®¢æˆ·ç«¯è¯»å†™å‹åŠ›ã€‚ é›†ç¾¤ä¸­æœ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸Šæœ‰ä¸€ä¸ªbrokerï¼Œæ¯ä¸ªbrokerè´Ÿè´£æœ¬æœºä¸Šé˜Ÿåˆ—çš„ç»´æŠ¤ï¼Œå¹¶ä¸”borkerä¹‹é—´å¯ä»¥äº’ç›¸é€šä¿¡ã€‚é›†ç¾¤ä¸­æœ‰ä¸¤ä¸ªé˜Ÿåˆ—Aå’ŒBï¼Œæ¯ä¸ªé˜Ÿåˆ—éƒ½åˆ†ä¸ºmaster queueå’Œmirror queueï¼ˆå¤‡ä»½ï¼‰ã€‚é‚£ä¹ˆé˜Ÿåˆ—ä¸Šçš„ç”Ÿäº§æ¶ˆè´¹æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ å¯¹äºæ¶ˆè´¹é˜Ÿåˆ—ï¼Œå¦‚ä¸‹å›¾æœ‰ä¸¤ä¸ªconsumeræ¶ˆè´¹é˜Ÿåˆ—Aï¼Œè¿™ä¸¤ä¸ªconsumerè¿åœ¨äº†é›†ç¾¤çš„ä¸åŒæœºå™¨ä¸Šã€‚RabbitMQé›†ç¾¤ä¸­çš„ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹éƒ½æ‹¥æœ‰é›†ç¾¤ä¸Šæ‰€æœ‰é˜Ÿåˆ—çš„å…ƒä¿¡æ¯ï¼Œæ‰€ä»¥è¿æ¥åˆ°é›†ç¾¤ä¸­çš„ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥ï¼Œä¸»è¦åŒºåˆ«åœ¨äºæœ‰çš„consumerè¿åœ¨master queueæ‰€åœ¨èŠ‚ç‚¹ï¼Œæœ‰çš„è¿åœ¨émaster queueèŠ‚ç‚¹ä¸Šã€‚ å› ä¸ºmirror queueè¦å’Œmaster queueä¿æŒä¸€è‡´ï¼Œæ•…éœ€è¦åŒæ­¥æœºåˆ¶ï¼Œæ­£å› ä¸ºä¸€è‡´æ€§çš„é™åˆ¶ï¼Œå¯¼è‡´æ‰€æœ‰çš„è¯»å†™æ“ä½œéƒ½å¿…é¡»éƒ½æ“ä½œåœ¨master queueä¸Šï¼ˆæƒ³æƒ³ï¼Œä¸ºå•¥è¯»ä¹Ÿè¦ä»master queueä¸­è¯»ï¼Ÿå’Œæ•°æ®åº“è¯»å†™åˆ†ç¦»æ˜¯ä¸ä¸€æ ·çš„ï¼‰ï¼Œç„¶åç”±masterèŠ‚ç‚¹åŒæ­¥æ“ä½œåˆ°mirror queueæ‰€åœ¨çš„èŠ‚ç‚¹ã€‚å³ä½¿consumerè¿æ¥åˆ°äº†émaster queueèŠ‚ç‚¹ï¼Œè¯¥consumerçš„æ“ä½œä¹Ÿä¼šè¢«è·¯ç”±åˆ°master queueæ‰€åœ¨çš„èŠ‚ç‚¹ä¸Šï¼Œè¿™æ ·æ‰èƒ½è¿›è¡Œæ¶ˆè´¹ã€‚ å¯¹äºç”Ÿæˆé˜Ÿåˆ—ï¼ŒåŸç†å’Œæ¶ˆè´¹ä¸€æ ·ï¼Œå¦‚æœè¿æ¥åˆ°é master queue èŠ‚ç‚¹ï¼Œåˆ™è·¯ç”±è¿‡å»ã€‚ æ‰€ä»¥ï¼Œåˆ°è¿™é‡Œå°ä¼™ä¼´ä»¬å°±å¯ä»¥çœ‹åˆ° RabbitMQçš„ä¸è¶³ï¼šç”±äºmaster queueå•èŠ‚ç‚¹ï¼Œå¯¼è‡´æ€§èƒ½ç“¶é¢ˆï¼Œååé‡å—é™ã€‚è™½ç„¶ä¸ºäº†æé«˜æ€§èƒ½ï¼Œå†…éƒ¨ä½¿ç”¨äº†Erlangè¿™ä¸ªè¯­è¨€å®ç°ï¼Œä½†æ˜¯ç»ˆç©¶æ‘†è„±ä¸äº†æ¶æ„è®¾è®¡ä¸Šçš„è‡´å‘½ç¼ºé™·ã€‚ 2.5 é«˜çº§ç‰¹æ€§ 2.5.1 è¿‡æœŸæ—¶é—´ Time To Liveï¼Œä¹Ÿå°±æ˜¯ç”Ÿå­˜æ—¶é—´ï¼Œæ˜¯ä¸€æ¡æ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸­çš„æœ€å¤§å­˜æ´»æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ï¼Œä¸‹é¢çœ‹çœ‹RabbitMQè¿‡æœŸæ—¶é—´ç‰¹æ€§ï¼š RabbitMQå¯ä»¥å¯¹æ¶ˆæ¯å’Œé˜Ÿåˆ—è®¾ç½®TTLã€‚ RabbitMQæ”¯æŒè®¾ç½®æ¶ˆæ¯çš„è¿‡æœŸæ—¶é—´ï¼Œåœ¨æ¶ˆæ¯å‘é€çš„æ—¶å€™å¯ä»¥è¿›è¡ŒæŒ‡å®šï¼Œæ¯æ¡æ¶ˆæ¯çš„è¿‡æœŸæ—¶é—´å¯ä»¥ä¸åŒã€‚ RabbitMQæ”¯æŒè®¾ç½®é˜Ÿåˆ—çš„è¿‡æœŸæ—¶é—´ï¼Œä»æ¶ˆæ¯å…¥é˜Ÿåˆ—å¼€å§‹è®¡ç®—ï¼Œç›´åˆ°è¶…è¿‡äº†é˜Ÿåˆ—çš„è¶…æ—¶æ—¶é—´é…ç½®ï¼Œé‚£ä¹ˆæ¶ˆæ¯ä¼šå˜æˆæ­»ä¿¡ï¼Œè‡ªåŠ¨æ¸…é™¤ã€‚ å¦‚æœä¸¤ç§æ–¹å¼ä¸€èµ·ä½¿ç”¨ï¼Œåˆ™è¿‡æœŸæ—¶é—´ä»¥ä¸¤è€…ä¸­è¾ƒå°çš„é‚£ä¸ªæ•°å€¼ä¸ºå‡†ã€‚ å½“ç„¶ä¹Ÿå¯ä»¥ä¸è®¾ç½®TTLï¼Œä¸è®¾ç½®è¡¨ç¤ºæ¶ˆæ¯ä¸ä¼šè¿‡æœŸï¼›å¦‚æœè®¾ç½®ä¸º0ï¼Œåˆ™è¡¨ç¤ºé™¤éæ­¤æ—¶å¯ä»¥ç›´æ¥å°†æ¶ˆæ¯æŠ•é€’åˆ°æ¶ˆè´¹è€…ï¼Œå¦åˆ™è¯¥æ¶ˆæ¯å°†è¢«ç«‹å³ä¸¢å¼ƒã€‚ 2.5.2 æ¶ˆæ¯ç¡®è®¤ ä¸ºäº†ä¿è¯æ¶ˆæ¯ä»é˜Ÿåˆ—å¯é åœ°åˆ°è¾¾æ¶ˆè´¹è€…ï¼ŒRabbitMQæä¾›äº†æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ã€‚ æ¶ˆè´¹è€…è®¢é˜…é˜Ÿåˆ—çš„æ—¶å€™ï¼Œå¯ä»¥æŒ‡å®šautoAckå‚æ•°ï¼Œå½“autoAckä¸ºtrueçš„æ—¶å€™ï¼ŒRabbitMQé‡‡ç”¨è‡ªåŠ¨ç¡®è®¤æ¨¡å¼ï¼ŒRabbitMQè‡ªåŠ¨æŠŠå‘é€å‡ºå»çš„æ¶ˆæ¯è®¾ç½®ä¸ºç¡®è®¤ï¼Œç„¶åä»å†…å­˜æˆ–è€…ç¡¬ç›˜ä¸­åˆ é™¤ï¼Œè€Œä¸ç®¡æ¶ˆè´¹è€…æ˜¯å¦çœŸæ­£æ¶ˆè´¹åˆ°äº†è¿™äº›æ¶ˆæ¯ã€‚ å½“autoAckä¸ºfalseçš„æ—¶å€™ï¼ŒRabbitMQä¼šç­‰å¾…æ¶ˆè´¹è€…å›å¤çš„ç¡®è®¤ä¿¡å·ï¼Œæ”¶åˆ°ç¡®è®¤ä¿¡å·ä¹‹åæ‰ä»å†…å­˜æˆ–è€…ç£ç›˜ä¸­åˆ é™¤æ¶ˆæ¯ã€‚ æ¶ˆæ¯ç¡®è®¤æœºåˆ¶æ˜¯RabbitMQæ¶ˆæ¯å¯é æ€§æŠ•é€’çš„åŸºç¡€ï¼Œåªè¦è®¾ç½®autoAckå‚æ•°ä¸ºfalseï¼Œæ¶ˆè´¹è€…å°±æœ‰è¶³å¤Ÿçš„æ—¶é—´å¤„ç†æ¶ˆæ¯ï¼Œä¸ç”¨æ‹…å¿ƒå¤„ç†æ¶ˆæ¯çš„è¿‡ç¨‹ä¸­æ¶ˆè´¹è€…è¿›ç¨‹æŒ‚æ‰åæ¶ˆæ¯ä¸¢å¤±çš„é—®é¢˜ã€‚ 2.5.3 æŒä¹…åŒ– æ¶ˆæ¯çš„å¯é æ€§æ˜¯RabbitMQçš„ä¸€å¤§ç‰¹è‰²ï¼Œé‚£ä¹ˆRabbitMQæ˜¯å¦‚ä½•ä¿è¯æ¶ˆæ¯å¯é æ€§çš„å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯æ¶ˆæ¯æŒä¹…åŒ–ã€‚æŒä¹…åŒ–å¯ä»¥é˜²æ­¢åœ¨å¼‚å¸¸æƒ…å†µä¸‹ä¸¢å¤±æ•°æ®ã€‚RabbitMQçš„æŒä¹…åŒ–åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼šäº¤æ¢å™¨æŒä¹…åŒ–ã€é˜Ÿåˆ—æŒä¹…åŒ–å’Œæ¶ˆæ¯çš„æŒä¹…åŒ–ã€‚ äº¤æ¢å™¨æŒä¹…åŒ–å¯ä»¥é€šè¿‡åœ¨å£°æ˜é˜Ÿåˆ—æ—¶å°†durableå‚æ•°è®¾ç½®ä¸ºtrueã€‚å¦‚æœäº¤æ¢å™¨ä¸è®¾ç½®æŒä¹…åŒ–ï¼Œé‚£ä¹ˆåœ¨RabbitMQæœåŠ¡é‡å¯ä¹‹åï¼Œç›¸å…³çš„äº¤æ¢å™¨å…ƒæ•°æ®ä¼šä¸¢å¤±ï¼Œä¸è¿‡æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼Œåªæ˜¯ä¸èƒ½å°†æ¶ˆæ¯å‘é€åˆ°è¿™ä¸ªäº¤æ¢å™¨äº†ã€‚ é˜Ÿåˆ—çš„æŒä¹…åŒ–èƒ½ä¿è¯å…¶æœ¬èº«çš„å…ƒæ•°æ®ä¸ä¼šå› å¼‚å¸¸æƒ…å†µè€Œä¸¢å¤±ï¼Œä½†æ˜¯ä¸èƒ½ä¿è¯å†…éƒ¨æ‰€å­˜å‚¨çš„æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ã€‚è¦ç¡®ä¿æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼Œéœ€è¦å°†å…¶è®¾ç½®ä¸ºæŒä¹…åŒ–ã€‚é˜Ÿåˆ—çš„æŒä¹…åŒ–å¯ä»¥é€šè¿‡åœ¨å£°æ˜é˜Ÿåˆ—æ—¶å°†durableå‚æ•°è®¾ç½®ä¸ºtrueã€‚ è®¾ç½®äº†é˜Ÿåˆ—å’Œæ¶ˆæ¯çš„æŒä¹…åŒ–ï¼Œå½“RabbitMQæœåŠ¡é‡å¯ä¹‹åï¼Œæ¶ˆæ¯ä¾ç„¶å­˜åœ¨ã€‚å¦‚æœåªè®¾ç½®é˜Ÿåˆ—æŒä¹…åŒ–æˆ–è€…æ¶ˆæ¯æŒä¹…åŒ–ï¼Œé‡å¯ä¹‹åæ¶ˆæ¯éƒ½ä¼šæ¶ˆå¤±ã€‚ å½“ç„¶ï¼Œä¹Ÿå¯ä»¥å°†æ‰€æœ‰çš„æ¶ˆæ¯éƒ½è®¾ç½®ä¸ºæŒä¹…åŒ–ï¼Œä½†æ˜¯è¿™æ ·åšä¼šå½±å“RabbitMQçš„æ€§èƒ½ï¼Œå› ä¸ºç£ç›˜çš„å†™å…¥é€Ÿåº¦æ¯”å†…å­˜çš„å†™å…¥è¦æ…¢å¾—å¤šã€‚ å¯¹äºå¯é æ€§ä¸æ˜¯é‚£ä¹ˆé«˜çš„æ¶ˆæ¯å¯ä»¥ä¸é‡‡ç”¨æŒä¹…åŒ–å¤„ç†ä»¥æé«˜æ•´ä½“çš„ååé‡ã€‚é±¼å’Œç†ŠæŒä¸å¯å…¼å¾—ï¼Œå…³é”®åœ¨äºé€‰æ‹©å’Œå–èˆã€‚åœ¨å®é™…ä¸­ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µåœ¨å¯é æ€§å’Œååé‡ä¹‹é—´åšä¸€ä¸ªæƒè¡¡ã€‚ 2.5.4 æ­»ä¿¡é˜Ÿåˆ— å½“æ¶ˆæ¯åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­å˜æˆæ­»ä¿¡ä¹‹åï¼Œä»–èƒ½è¢«é‡æ–°å‘é€åˆ°å¦ä¸€ä¸ªäº¤æ¢å™¨ä¸­ï¼Œè¿™ä¸ªäº¤æ¢å™¨æˆä¸ºæ­»ä¿¡äº¤æ¢å™¨ï¼Œä¸è¯¥äº¤æ¢å™¨ç»‘å®šçš„é˜Ÿåˆ—ç§°ä¸ºæ­»ä¿¡é˜Ÿåˆ—ã€‚ æ¶ˆæ¯å˜æˆæ­»ä¿¡æœ‰ä¸‹é¢å‡ ç§æƒ…å†µï¼š æ¶ˆæ¯è¢«æ‹’ç»ã€‚ æ¶ˆæ¯è¿‡æœŸ é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦ DLXä¹Ÿæ˜¯ä¸€ä¸ªæ­£å¸¸çš„äº¤æ¢å™¨ï¼Œå’Œä¸€èˆ¬çš„äº¤æ¢å™¨æ²¡æœ‰åŒºåˆ«ï¼Œä»–èƒ½åœ¨ä»»ä½•çš„é˜Ÿåˆ—ä¸Šé¢è¢«æŒ‡å®šï¼Œå®é™…ä¸Šå°±æ˜¯è®¾ç½®æŸä¸ªé˜Ÿåˆ—çš„å±æ€§ã€‚å½“è¿™ä¸ªé˜Ÿåˆ—ä¸­æœ‰æ­»ä¿¡çš„æ—¶å€™ï¼ŒRabbitMQä¼šè‡ªåŠ¨å°†è¿™ä¸ªæ¶ˆæ¯é‡æ–°å‘é€åˆ°è®¾ç½®çš„äº¤æ¢å™¨ä¸Šï¼Œè¿›è€Œè¢«è·¯ç”±åˆ°å¦ä¸€ä¸ªé˜Ÿåˆ—ï¼Œæˆ‘ä»¬å¯ä»¥ç›‘å¬è¿™ä¸ªé˜Ÿåˆ—ä¸­æ¶ˆæ¯åšç›¸åº”çš„å¤„ç†ã€‚ æ­»ä¿¡é˜Ÿåˆ—æœ‰ä»€ä¹ˆç”¨ï¼Ÿå½“å‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™ï¼Œæ¶ˆæ¯ä¸èƒ½å¤Ÿè¢«æ¶ˆè´¹è€…æ­£å¸¸æ¶ˆè´¹ï¼Œè¢«åŠ å…¥åˆ°äº†æ­»ä¿¡é˜Ÿåˆ—ä¸­ã€‚åç»­çš„ç¨‹åºå¯ä»¥æ ¹æ®æ­»ä¿¡é˜Ÿåˆ—ä¸­çš„å†…å®¹åˆ†æå½“æ—¶å‘ç”Ÿçš„å¼‚å¸¸ï¼Œè¿›è€Œæ”¹å–„å’Œä¼˜åŒ–ç³»ç»Ÿã€‚ 2.5.5 å»¶è¿Ÿé˜Ÿåˆ— ä¸€èˆ¬çš„é˜Ÿåˆ—ï¼Œæ¶ˆæ¯ä¸€æ—¦è¿›å…¥é˜Ÿåˆ—å°±ä¼šè¢«æ¶ˆè´¹è€…ç«‹å³æ¶ˆè´¹ã€‚å»¶è¿Ÿé˜Ÿåˆ—å°±æ˜¯è¿›å…¥è¯¥é˜Ÿåˆ—çš„æ¶ˆæ¯ä¼šè¢«æ¶ˆè´¹è€…å»¶è¿Ÿæ¶ˆè´¹ï¼Œå»¶è¿Ÿé˜Ÿåˆ—ä¸­å­˜å‚¨çš„å¯¹è±¡æ˜¯çš„å»¶è¿Ÿæ¶ˆæ¯ï¼Œâ€œå»¶è¿Ÿæ¶ˆæ¯â€æ˜¯æŒ‡å½“æ¶ˆæ¯è¢«å‘é€ä»¥åï¼Œç­‰å¾…ç‰¹å®šçš„æ—¶é—´åï¼Œæ¶ˆè´¹è€…æ‰èƒ½æ‹¿åˆ°è¿™ä¸ªæ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹ã€‚ å»¶è¿Ÿé˜Ÿåˆ—ç”¨äºéœ€è¦å»¶è¿Ÿå·¥ä½œçš„åœºæ™¯ã€‚æœ€å¸¸è§çš„ä½¿ç”¨åœºæ™¯ï¼šæ·˜å®æˆ–è€…å¤©çŒ«æˆ‘ä»¬éƒ½ä½¿ç”¨è¿‡ï¼Œç”¨æˆ·åœ¨ä¸‹å•ä¹‹åé€šå¸¸æœ‰30åˆ†é’Ÿçš„æ—¶é—´è¿›è¡Œæ”¯ä»˜ï¼Œå¦‚æœè¿™30åˆ†é’Ÿä¹‹å†…æ²¡æœ‰æ”¯ä»˜æˆåŠŸï¼Œé‚£ä¹ˆè®¢å•å°±ä¼šè‡ªåŠ¨å–æ¶ˆã€‚ é™¤äº†å»¶è¿Ÿæ¶ˆè´¹ï¼Œå»¶è¿Ÿé˜Ÿåˆ—çš„å…¸å‹åº”ç”¨åœºæ™¯è¿˜æœ‰å»¶è¿Ÿé‡è¯•ã€‚æ¯”å¦‚æ¶ˆè´¹è€…ä»é˜Ÿåˆ—é‡Œé¢æ¶ˆè´¹æ¶ˆæ¯å¤±è´¥äº†ï¼Œå¯ä»¥å»¶è¿Ÿä¸€æ®µæ—¶é—´ä»¥åè¿›è¡Œé‡è¯•ã€‚ 2.6 ç‰¹æ€§åˆ†æ è¿™é‡Œæ‰æ˜¯å†…å®¹çš„é‡ç‚¹ï¼Œä¸ä»…éœ€è¦çŸ¥é“Rabbitçš„ç‰¹æ€§ï¼Œè¿˜éœ€è¦çŸ¥é“æ”¯æŒè¿™äº›ç‰¹æ€§çš„åŸå› ï¼š æ¶ˆæ¯è·¯ç”±ï¼ˆæ”¯æŒï¼‰ï¼šRabbitMQå¯ä»¥é€šè¿‡ä¸åŒçš„äº¤æ¢å™¨æ”¯æŒä¸åŒç§ç±»çš„æ¶ˆæ¯è·¯ç”±ï¼› æ¶ˆæ¯æœ‰åºï¼ˆä¸æ”¯æŒï¼‰ï¼šå½“æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œå¦‚æœæ¶ˆè´¹å¤±è´¥ï¼Œæ¶ˆæ¯ä¼šè¢«æ”¾å›é˜Ÿåˆ—ï¼Œç„¶åé‡æ–°æ¶ˆè´¹ï¼Œè¿™æ ·ä¼šå¯¼è‡´æ¶ˆæ¯æ— åºï¼› æ¶ˆæ¯æ—¶åºï¼ˆéå¸¸å¥½ï¼‰ï¼šé€šè¿‡å»¶æ—¶é˜Ÿåˆ—ï¼Œå¯ä»¥æŒ‡å®šæ¶ˆæ¯çš„å»¶æ—¶æ—¶é—´ï¼Œè¿‡æœŸæ—¶é—´TTLç­‰ï¼› å®¹é”™å¤„ç†ï¼ˆéå¸¸å¥½ï¼‰ï¼šé€šè¿‡äº¤ä»˜é‡è¯•å’Œæ­»ä¿¡äº¤æ¢å™¨ï¼ˆDLXï¼‰æ¥å¤„ç†æ¶ˆæ¯å¤„ç†æ•…éšœï¼› ä¼¸ç¼©ï¼ˆä¸€èˆ¬ï¼‰ï¼šä¼¸ç¼©å…¶å®æ²¡æœ‰éå¸¸æ™ºèƒ½ï¼Œå› ä¸ºå³ä½¿ä¼¸ç¼©äº†ï¼Œmaster queueè¿˜æ˜¯åªæœ‰ä¸€ä¸ªï¼Œè´Ÿè½½è¿˜æ˜¯åªæœ‰è¿™ä¸€ä¸ªmaster queueå»æŠ—ï¼Œæ‰€ä»¥æˆ‘ç†è§£RabbitMQçš„ä¼¸ç¼©å¾ˆå¼±ï¼ˆä¸ªäººç†è§£ï¼‰ã€‚ æŒä¹…åŒ–ï¼ˆä¸å¤ªå¥½ï¼‰ï¼šæ²¡æœ‰æ¶ˆè´¹çš„æ¶ˆæ¯ï¼Œå¯ä»¥æ”¯æŒæŒä¹…åŒ–ï¼Œè¿™ä¸ªæ˜¯ä¸ºäº†ä¿è¯æœºå™¨å®•æœºæ—¶æ¶ˆæ¯å¯ä»¥æ¢å¤ï¼Œä½†æ˜¯æ¶ˆè´¹è¿‡çš„æ¶ˆæ¯ï¼Œå°±ä¼šè¢«é©¬ä¸Šåˆ é™¤ï¼Œå› ä¸ºRabbitMQè®¾è®¡æ—¶ï¼Œå°±ä¸æ˜¯ä¸ºäº†å»å­˜å‚¨å†å²æ•°æ®çš„ã€‚ æ¶ˆæ¯å›æº¯ï¼ˆä¸æ”¯æŒï¼‰ï¼šå› ä¸ºæ¶ˆæ¯ä¸æ”¯æŒæ°¸ä¹…ä¿å­˜ï¼Œæ‰€ä»¥è‡ªç„¶å°±ä¸æ”¯æŒå›æº¯ã€‚ é«˜ååï¼ˆä¸­ç­‰ï¼‰ï¼šå› ä¸ºæ‰€æœ‰çš„è¯·æ±‚çš„æ‰§è¡Œï¼Œæœ€åéƒ½æ˜¯åœ¨master queueï¼Œå®ƒçš„è¿™ä¸ªè®¾è®¡ï¼Œå¯¼è‡´å•æœºæ€§èƒ½è¾¾ä¸åˆ°åä¸‡çº§çš„æ ‡å‡†ã€‚ 3. RabbitMQç¯å¢ƒæ­å»º å› ä¸ºæˆ‘ç”¨çš„æ˜¯Macï¼Œæ‰€ä»¥ç›´æ¥å¯ä»¥å‚è€ƒå®˜ç½‘ï¼š https://www.rabbitmq.com/install-homebrew.html éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸€å®šéœ€è¦å…ˆæ‰§è¡Œï¼š brew update ç„¶åå†æ‰§è¡Œï¼š brew install rabbitmq ä¹‹å‰æ²¡æœ‰æ‰§è¡Œbrew updateï¼Œç›´æ¥æ‰§è¡Œbrew install rabbitmqæ—¶ï¼Œä¼šæŠ¥å„ç§å„æ ·å¥‡æ€ªçš„é”™è¯¯ï¼Œå…¶ä¸­â€œ403 Forbiddeâ€å±…å¤šã€‚ ä½†æ˜¯åœ¨æ‰§è¡Œâ€œbrew install rabbitmqâ€ï¼Œä¼šè‡ªåŠ¨å®‰è£…å…¶å®ƒçš„ç¨‹åºï¼Œå¦‚æœä½ ä½¿ç”¨æºç å®‰è£…Rabbitmqï¼Œå› ä¸ºå¯åŠ¨è¯¥æœåŠ¡ä¾èµ–erlangç¯å¢ƒï¼Œæ‰€ä»¥ä½ è¿˜éœ€æ‰‹åŠ¨å®‰è£…erlangï¼Œä½†æ˜¯ç›®å‰å®˜æ–¹å·²ç»ä¸€é”®ç»™ä½ æå®šï¼Œä¼šè‡ªåŠ¨å®‰è£…Rabbitmqä¾èµ–çš„æ‰€æœ‰ç¨‹åºï¼Œæ˜¯ä¸æ˜¯å¾ˆæ£’ï¼ æœ€åæ‰§è¡ŒæˆåŠŸçš„è¾“å‡ºå¦‚ä¸‹ï¼š å¯åŠ¨æœåŠ¡ï¼š # å¯åŠ¨æ–¹å¼1ï¼šåå°å¯åŠ¨ brew services start rabbitmq # å¯åŠ¨æ–¹å¼2ï¼šå½“å‰çª—å£å¯åŠ¨ cd /usr/local/Cellar/rabbitmq/3.8.19 rabbitmq-server åœ¨æµè§ˆå™¨è¾“å…¥ï¼š http://localhost:15672/ ä¼šå‡ºç°RabbitMQåå°ç®¡ç†ç•Œé¢ï¼ˆç”¨æˆ·åå’Œå¯†ç éƒ½ä¸ºguestï¼‰ï¼š é€šè¿‡brewå®‰è£…ï¼Œä¸€è¡Œå‘½ä»¤æå®šï¼ŒçœŸé¦™ï¼ 4. RabbitMQæµ‹è¯• 4.1 æ·»åŠ è´¦å· é¦–å…ˆå¾—å¯åŠ¨mq ## æ·»åŠ è´¦å· ./rabbitmqctl add_user admin admin ## æ·»åŠ è®¿é—®æƒé™ ./rabbitmqctl set_permissions -p &quot;/&quot; admin &quot;.*&quot; &quot;.*&quot; &quot;.*&quot; ## è®¾ç½®è¶…çº§æƒé™ ./rabbitmqctl set_user_tags admin administrator 4.2 ç¼–ç å®æµ‹ å› ä¸ºä»£ç ä¸­å¼•å…¥äº†java 8çš„ç‰¹æ€§ï¼Œpomå¼•å…¥ä¾èµ–ï¼š &lt;dependency&gt; &lt;groupId&gt;com.rabbitmq&lt;/groupId&gt; &lt;artifactId&gt;amqp-client&lt;/artifactId&gt; &lt;version&gt;5.5.1&lt;/version&gt; &lt;/dependency&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt; &lt;configuration&gt; &lt;source&gt;8&lt;/source&gt; &lt;target&gt;8&lt;/target&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;/plugins&gt; å¼€å§‹å†™ä»£ç ï¼š public class RabbitMqTest { //æ¶ˆæ¯é˜Ÿåˆ—åç§° private final static String QUEUE_NAME = &quot;hello&quot;; @Test public void send() throws java.io.IOException, TimeoutException { //åˆ›å»ºè¿æ¥å·¥ç¨‹ ConnectionFactory factory = new ConnectionFactory(); factory.setHost(&quot;127.0.0.1&quot;); factory.setPort(5672); factory.setUsername(&quot;admin&quot;); factory.setPassword(&quot;admin&quot;); //åˆ›å»ºè¿æ¥ Connection connection = factory.newConnection(); //åˆ›å»ºæ¶ˆæ¯é€šé“ Channel channel = connection.createChannel(); //ç”Ÿæˆä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ— channel.queueDeclare(QUEUE_NAME, true, false, false, null); for (int i = 0; i &lt; 10; i++) { String message = &quot;Hello World RabbitMQ count: &quot; + i; //å‘å¸ƒæ¶ˆæ¯ï¼Œç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºè·¯ç”±ï¼ˆExchangeåç§°ï¼‰ï¼Œä¸º&quot;&quot;åˆ™è¡¨ç¤ºä½¿ç”¨é»˜è®¤æ¶ˆæ¯è·¯ç”± channel.basicPublish(&quot;&quot;, QUEUE_NAME, null, message.getBytes()); System.out.println(&quot; [x] Sent '&quot; + message + &quot;'&quot;); } //å…³é—­æ¶ˆæ¯é€šé“å’Œè¿æ¥ channel.close(); connection.close(); } @Test public void consumer() throws java.io.IOException, TimeoutException { //åˆ›å»ºè¿æ¥å·¥å‚ ConnectionFactory factory = new ConnectionFactory(); factory.setHost(&quot;127.0.0.1&quot;); factory.setPort(5672); factory.setUsername(&quot;admin&quot;); factory.setPassword(&quot;admin&quot;); //åˆ›å»ºè¿æ¥ Connection connection = factory.newConnection(); //åˆ›å»ºæ¶ˆæ¯ä¿¡é“ final Channel channel = connection.createChannel(); //æ¶ˆæ¯é˜Ÿåˆ— channel.queueDeclare(QUEUE_NAME, true, false, false, null); System.out.println(&quot;[*] Waiting for message. To exist press CTRL+C&quot;); DeliverCallback deliverCallback = (consumerTag, delivery) -&gt; { String message = new String(delivery.getBody(), &quot;UTF-8&quot;); System.out.println(&quot; [x] Received '&quot; + message + &quot;'&quot;); }; channel.basicConsume(QUEUE_NAME, true, deliverCallback, consumerTag -&gt; {}); } } æ‰§è¡Œsend()åæ§åˆ¶å°è¾“å‡ºï¼š [x] Sent 'Hello World RabbitMQ count: 0' [x] Sent 'Hello World RabbitMQ count: 1' [x] Sent 'Hello World RabbitMQ count: 2' [x] Sent 'Hello World RabbitMQ count: 3' [x] Sent 'Hello World RabbitMQ count: 4' [x] Sent 'Hello World RabbitMQ count: 5' [x] Sent 'Hello World RabbitMQ count: 6' [x] Sent 'Hello World RabbitMQ count: 7' [x] Sent 'Hello World RabbitMQ count: 8' [x] Sent 'Hello World RabbitMQ count: 9' æ‰§è¡Œconsumer()åï¼š ç¤ºä¾‹ä¸­çš„ä»£ç è®²è§£ï¼Œå¯ä»¥ç›´æ¥å‚è€ƒå®˜ç½‘ï¼šhttps://www.rabbitmq.com/tutorials/tutorial-one-java.html 5. åŸºæœ¬ä½¿ç”¨å§¿åŠ¿ 5.1 å…¬å…±ä»£ç å°è£… å°è£…å·¥å‚ç±»ï¼š public class RabbitUtil { public static ConnectionFactory getConnectionFactory() { //åˆ›å»ºè¿æ¥å·¥ç¨‹ï¼Œä¸‹é¢ç»™å‡ºçš„æ˜¯é»˜è®¤çš„case ConnectionFactory factory = new ConnectionFactory(); factory.setHost(&quot;127.0.0.1&quot;); factory.setPort(5672); factory.setUsername(&quot;admin&quot;); factory.setPassword(&quot;admin&quot;); factory.setVirtualHost(&quot;/&quot;); return factory; } } å°è£…ç”Ÿæˆè€…ï¼š public class MsgProducer { public static void publishMsg(String exchange, BuiltinExchangeType exchangeType, String toutingKey, String message) throws IOException, TimeoutException { ConnectionFactory factory = RabbitUtil.getConnectionFactory(); //åˆ›å»ºè¿æ¥ Connection connection = factory.newConnection(); //åˆ›å»ºæ¶ˆæ¯é€šé“ Channel channel = connection.createChannel(); // å£°æ˜exchangeä¸­çš„æ¶ˆæ¯ä¸ºå¯æŒä¹…åŒ–ï¼Œä¸è‡ªåŠ¨åˆ é™¤ channel.exchangeDeclare(exchange, exchangeType, true, false, null); // å‘å¸ƒæ¶ˆæ¯ channel.basicPublish(exchange, toutingKey, null, message.getBytes()); System.out.println(&quot;Sent '&quot; + message + &quot;'&quot;); channel.close(); connection.close(); } } å°è£…æ¶ˆè´¹è€…ï¼š public class MsgConsumer { public static void consumerMsg(String exchange, String queue, String routingKey) throws IOException, TimeoutException { ConnectionFactory factory = RabbitUtil.getConnectionFactory(); //åˆ›å»ºè¿æ¥ Connection connection = factory.newConnection(); //åˆ›å»ºæ¶ˆæ¯ä¿¡é“ final Channel channel = connection.createChannel(); //æ¶ˆæ¯é˜Ÿåˆ— channel.queueDeclare(queue, true, false, false, null); //ç»‘å®šé˜Ÿåˆ—åˆ°äº¤æ¢æœº channel.queueBind(queue, exchange, routingKey); System.out.println(&quot;[*] Waiting for message. To exist press CTRL+C&quot;); Consumer consumer = new DefaultConsumer(channel) { @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException { String message = new String(body, &quot;UTF-8&quot;); try { System.out.println(&quot; [x] Received '&quot; + message); } finally { System.out.println(&quot; [x] Done&quot;); channel.basicAck(envelope.getDeliveryTag(), false); } } }; // å–æ¶ˆè‡ªåŠ¨ack channel.basicConsume(queue, false, consumer); } } 5.2 Directæ–¹å¼ 5.2.1 Directç¤ºä¾‹ ç”Ÿäº§è€…ï¼š public class DirectProducer { private static final String EXCHANGE_NAME = &quot;direct.exchange&quot;; public void publishMsg(String routingKey, String msg) { try { MsgProducer.publishMsg(EXCHANGE_NAME, BuiltinExchangeType.DIRECT, routingKey, msg); } catch (Exception e) { e.printStackTrace(); } } public static void main(String[] args) throws InterruptedException { DirectProducer directProducer = new DirectProducer(); String[] routingKey = new String[]{&quot;aaa&quot;, &quot;bbb&quot;, &quot;ccc&quot;}; String msg = &quot;hello &gt;&gt;&gt; &quot;; for (int i = 0; i &lt; 10; i++) { directProducer.publishMsg(routingKey[i % 3], msg + i); } System.out.println(&quot;----over-------&quot;); Thread.sleep(1000 * 60 * 100); } } æ‰§è¡Œç”Ÿäº§è€…ï¼Œå¾€æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ”¾å…¥10æ¡æ¶ˆæ¯ï¼Œå…¶ä¸­keyåˆ†åˆ«ä¸ºâ€œaaaâ€ã€â€œbbbâ€å’Œâ€œcccâ€ï¼Œåˆ†åˆ«æ”¾å…¥qaã€qbã€qcä¸‰ä¸ªé˜Ÿåˆ—ï¼š ä¸‹é¢æ˜¯qaé˜Ÿåˆ—çš„ä¿¡æ¯ï¼š æ¶ˆè´¹è€…ï¼š public class DirectConsumer { private static final String exchangeName = &quot;direct.exchange&quot;; public void msgConsumer(String queueName, String routingKey) { try { MsgConsumer.consumerMsg(exchangeName, queueName, routingKey); } catch (IOException e) { e.printStackTrace(); } catch (TimeoutException e) { e.printStackTrace(); } } public static void main(String[] args) throws InterruptedException { DirectConsumer consumer = new DirectConsumer(); String[] routingKey = new String[]{&quot;aaa&quot;, &quot;bbb&quot;, &quot;ccc&quot;}; String[] queueNames = new String[]{&quot;qa&quot;, &quot;qb&quot;, &quot;qc&quot;}; for (int i = 0; i &lt; 3; i++) { consumer.msgConsumer(queueNames[i], routingKey[i]); } Thread.sleep(1000 * 60 * 100); } } æ‰§è¡Œåçš„è¾“å‡ºï¼š [*] Waiting for message. To exist press CTRL+C [x] Received 'hello &gt;&gt;&gt; 0 [x] Done [x] Received 'hello &gt;&gt;&gt; 3 [x] Done [x] Received 'hello &gt;&gt;&gt; 6 [x] Done [x] Received 'hello &gt;&gt;&gt; 9 [x] Done [*] Waiting for message. To exist press CTRL+C [x] Received 'hello &gt;&gt;&gt; 1 [x] Done [x] Received 'hello &gt;&gt;&gt; 4 [x] Done [x] Received 'hello &gt;&gt;&gt; 7 [x] Done [*] Waiting for message. To exist press CTRL+C [x] Received 'hello &gt;&gt;&gt; 2 [x] Done [x] Received 'hello &gt;&gt;&gt; 5 [x] Done [x] Received 'hello &gt;&gt;&gt; 8 [x] Done å¯ä»¥çœ‹åˆ°ï¼Œåˆ†åˆ«ä»qaã€qbã€qcä¸­å°†ä¸åŒçš„keyçš„æ•°æ®æ¶ˆè´¹æ‰ã€‚ 5.2.2 é—®é¢˜æ¢è®¨ æœ‰ä¸ªç–‘é—®ï¼šè¿™ä¸ªé˜Ÿåˆ—çš„åç§°qaã€qbå’Œqcæ˜¯RabbitMQè‡ªåŠ¨ç”Ÿæˆçš„ä¹ˆï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šé˜Ÿåˆ—åç§°ä¹ˆï¼Ÿ æˆ‘åšäº†ä¸ªç®€å•çš„å®éªŒï¼Œæˆ‘æŠŠæ¶ˆè´¹è€…ä»£ç ä¿®æ”¹äº†ä¸€ä¸‹ï¼š public static void main(String[] args) throws InterruptedException { DirectConsumer consumer = new DirectConsumer(); String[] routingKey = new String[]{&quot;aaa&quot;, &quot;bbb&quot;, &quot;ccc&quot;}; String[] queueNames = new String[]{&quot;qa&quot;, &quot;qb&quot;, &quot;qc1&quot;}; // å°†qcä¿®æ”¹ä¸ºqc1 for (int i = 0; i &lt; 3; i++) { consumer.msgConsumer(queueNames[i], routingKey[i]); } Thread.sleep(1000 * 60 * 100); } æ‰§è¡Œåå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå¤šäº†ä¸€ä¸ªqc1ï¼Œæ‰€ä»¥å¯ä»¥åˆ¤æ–­è¿™ä¸ªç•Œé¢ä¸­çš„queuesï¼Œæ˜¯æ¶ˆè´¹è€…æ‰§è¡Œæ—¶ï¼Œä¼šå°†æ¶ˆè´¹è€…æŒ‡å®šçš„é˜Ÿåˆ—åç§°å’Œdirect.exchangeç»‘å®šï¼Œç»‘å®šçš„ä¾æ®å°±æ˜¯keyã€‚ å½“æˆ‘ä»¬æŠŠé˜Ÿåˆ—ä¸­çš„æ•°æ®å…¨éƒ¨æ¶ˆè´¹æ‰ï¼Œç„¶åé‡æ–°æ‰§è¡Œç”Ÿæˆè€…åï¼Œä¼šå‘ç°qcå’Œqc1ä¸­éƒ½æœ‰3æ¡å¾…æ¶ˆè´¹çš„æ•°æ®ï¼Œå› ä¸ºç»‘å®šçš„keyéƒ½æ˜¯â€œcccâ€ï¼Œæ‰€ä»¥ä¸¤è€…çš„æ•°æ®æ˜¯ä¸€æ ·çš„ï¼š ç»‘å®šå…³ç³»å¦‚ä¸‹ï¼š æ³¨æ„ï¼šå½“æ²¡æœ‰Queueç»‘å®šåˆ°Exchangeæ—¶ï¼Œå¾€Exchangeä¸­å†™å…¥çš„æ¶ˆæ¯ä¹Ÿä¸ä¼šé‡æ–°åˆ†å‘åˆ°ä¹‹åç»‘å®šçš„queueä¸Šã€‚ æ€è€ƒï¼šä¸æ‰§è¡Œæ¶ˆè´¹è€…ï¼Œçœ‹ä¸åˆ°è¿™ä¸ªQueresä¸­ä¿¡æ¯ï¼Œæˆ‘å…¶å®å¯ä»¥æŠŠè¿™ä¸ªç•Œé¢ç†è§£ä¸ºæ¶ˆè´¹è€…ä¿¡æ¯ç•Œé¢ã€‚ä¸è¿‡æ„Ÿè§‰è¿˜æ˜¯æ€ªæ€ªçš„ï¼Œè¿™ä¸ªqueueså¦‚æœæ˜¯æ¶ˆè´¹è€…ä¿¡æ¯ï¼Œå°±ä¸åº”è¯¥å«queuesï¼Œæˆ‘ç†è§£queuesåº”è¯¥æ˜¯RabbitMQä¸­å®é™…å­˜æ”¾æ•°æ®çš„queuesï¼Œéš¾é“æ˜¯æˆ‘ç†è§£é”™äº†ï¼Ÿ 5.3 Fanoutæ–¹å¼ï¼ˆæŒ‡å®šé˜Ÿåˆ—ï¼‰ ç”Ÿäº§è€…å°è£…ï¼š public class FanoutProducer { private static final String EXCHANGE_NAME = &quot;fanout.exchange&quot;; public void publishMsg(String routingKey, String msg) { try { MsgProducer.publishMsg(EXCHANGE_NAME, BuiltinExchangeType.FANOUT, routingKey, msg); } catch (Exception e) { e.printStackTrace(); } } public static void main(String[] args) { FanoutProducer directProducer = new FanoutProducer(); String msg = &quot;hello &gt;&gt;&gt; &quot;; for (int i = 0; i &lt; 10; i++) { directProducer.publishMsg(&quot;&quot;, msg + i); } } } æ¶ˆè´¹è€…ï¼š public class FanoutConsumer { private static final String EXCHANGE_NAME = &quot;fanout.exchange&quot;; public void msgConsumer(String queueName, String routingKey) { try { MsgConsumer.consumerMsg(EXCHANGE_NAME, queueName, routingKey); } catch (IOException e) { e.printStackTrace(); } catch (TimeoutException e) { e.printStackTrace(); } } public static void main(String[] args) { FanoutConsumer consumer = new FanoutConsumer(); String[] queueNames = new String[]{&quot;qa-2&quot;, &quot;qb-2&quot;, &quot;qc-2&quot;}; for (int i = 0; i &lt; 3; i++) { consumer.msgConsumer(queueNames[i], &quot;&quot;); } } } æ‰§è¡Œç”Ÿæˆè€…ï¼Œç»“æœå¦‚ä¸‹ï¼š æˆ‘ä»¬å‘ç°ï¼Œç”Ÿäº§è€…ç”Ÿäº§çš„10æ¡æ•°æ®ï¼Œåœ¨æ¯ä¸ªæ¶ˆè´¹è€…ä¸­éƒ½å¯ä»¥æ¶ˆè´¹ï¼Œè¿™ä¸ªæ˜¯å’ŒDirectä¸åŒçš„åœ°æ–¹ï¼Œä½†æ˜¯ä½¿ç”¨Fanoutæ–¹å¼æ—¶ï¼Œæœ‰å‡ ä¸ªç‚¹éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼š ç”Ÿäº§è€…çš„routkeyå¯ä»¥ä¸ºç©ºï¼Œå› ä¸ºç”Ÿäº§è€…çš„æ‰€æœ‰æ•°æ®ï¼Œä¼šä¸‹æ”¾åˆ°æ¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ‰€ä»¥ä¸ä¼šé€šè¿‡routkeyå»è·¯ç”±ï¼› æ¶ˆè´¹è€…éœ€è¦æŒ‡å®šqueuesï¼Œå› ä¸ºæ¶ˆè´¹è€…éœ€è¦ç»‘å®šåˆ°æŒ‡å®šçš„queuesæ‰èƒ½æ¶ˆè´¹ã€‚ è¿™å¹…å›¾å°±ç”»å‡ºäº†Fanoutçš„ç²¾é«“ä¹‹å¤„ï¼Œexchangeä¼šå’Œæ‰€æœ‰çš„queueè¿›è¡Œç»‘å®šï¼Œä¸åŒºåˆ†è·¯ç”±ï¼Œæ¶ˆè´¹è€…éœ€è¦ç»‘å®šæŒ‡å®šçš„queueæ‰èƒ½å‘èµ·æ¶ˆè´¹ã€‚ æ³¨æ„ï¼šå¾€é˜Ÿåˆ—å¡æ•°æ®æ—¶ï¼Œå¯èƒ½é€šè¿‡ç•Œé¢çœ‹ä¸åˆ°æ¶ˆæ¯ä¸ªæ•°çš„å¢åŠ ï¼Œå¯èƒ½æ˜¯ä½ ä¹‹å‰å·²ç»å¼€å¯äº†æ¶ˆè´¹è¿›ç¨‹ï¼Œå¯¼è‡´å¢åŠ çš„æ¶ˆæ¯é©¬ä¸Šè¢«æ¶ˆè´¹äº†ã€‚ 5.4 Fanoutæ–¹å¼ï¼ˆéšæœºè·å–é˜Ÿåˆ—ï¼‰ ä¸Šé¢æˆ‘ä»¬æ˜¯æŒ‡å®šäº†é˜Ÿåˆ—ï¼Œè¿™ä¸ªæ–¹å¼å…¶å®å¾ˆä¸å‹å¥½ï¼Œæ¯”å¦‚å¯¹äºFanoutï¼Œæˆ‘å…¶å®æ ¹æœ¬æ— éœ€å…³å¿ƒé˜Ÿåˆ—çš„åå­—ï¼Œå¦‚æœè¿˜æŒ‡å®šå¯¹åº”é˜Ÿåˆ—è¿›è¡Œæ¶ˆè´¹ï¼Œæ„Ÿè§‰è¿™ä¸ªå¾ˆå†—ä½™ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå°±é‡‡ç”¨éšæœºè·å–é˜Ÿåˆ—åå­—çš„æ–¹å¼ï¼Œä¸‹é¢ä»£ç ç›´æ¥Copyå®˜ç½‘ã€‚ ç”Ÿæˆè€…å°è£…ï¼š public static void publishMsgV2(String exchange, BuiltinExchangeType exchangeType, String message) throws IOException, TimeoutException { ConnectionFactory factory = RabbitUtil.getConnectionFactory(); //åˆ›å»ºè¿æ¥ Connection connection = factory.newConnection(); //åˆ›å»ºæ¶ˆæ¯é€šé“ Channel channel = connection.createChannel(); // å£°æ˜exchangeä¸­çš„æ¶ˆæ¯ channel.exchangeDeclare(exchange, exchangeType); // å‘å¸ƒæ¶ˆæ¯ channel.basicPublish(exchange, &quot;&quot;, null, message.getBytes(&quot;UTF-8&quot;)); System.out.println(&quot;Sent '&quot; + message + &quot;'&quot;); channel.close(); connection.close(); } æ¶ˆè´¹è€…å°è£…ï¼š public static void consumerMsgV2(String exchange) throws IOException, TimeoutException { ConnectionFactory factory = RabbitUtil.getConnectionFactory(); Connection connection = factory.newConnection(); final Channel channel = connection.createChannel(); channel.exchangeDeclare(exchange, &quot;fanout&quot;); String queueName = channel.queueDeclare().getQueue(); channel.queueBind(queueName, exchange, &quot;&quot;); System.out.println(&quot; [*] Waiting for messages. To exit press CTRL+C&quot;); DeliverCallback deliverCallback = (consumerTag, delivery) -&gt; { String message = new String(delivery.getBody(), &quot;UTF-8&quot;); System.out.println(&quot; [x] Received '&quot; + message + &quot;'&quot;); }; channel.basicConsume(queueName, true, deliverCallback, consumerTag -&gt; { }); } ç”Ÿäº§è€…ï¼š public class FanoutProducer { private static final String EXCHANGE_NAME = &quot;fanout.exchange.v2&quot;; public void publishMsg(String msg) { try { MsgProducer.publishMsgV2(EXCHANGE_NAME, BuiltinExchangeType.FANOUT, msg); } catch (Exception e) { e.printStackTrace(); } } public static void main(String[] args) { FanoutProducer directProducer = new FanoutProducer(); String msg = &quot;hello &gt;&gt;&gt; &quot;; for (int i = 0; i &lt; 10000; i++) { directProducer.publishMsg(msg + i); } } } æ¶ˆè´¹è€…ï¼š public class FanoutConsumer { private static final String EXCHANGE_NAME = &quot;fanout.exchange.v2&quot;; public void msgConsumer() { try { MsgConsumer.consumerMsgV2(EXCHANGE_NAME); } catch (IOException e) { e.printStackTrace(); } catch (TimeoutException e) { e.printStackTrace(); } } public static void main(String[] args) { FanoutConsumer consumer = new FanoutConsumer(); for (int i = 0; i &lt; 3; i++) { consumer.msgConsumer(); } } } æ‰§è¡Œåï¼Œç®¡ç†ç•Œé¢å¦‚ä¸‹ï¼š 5.5 Topicæ–¹å¼ ä»£ç è¯¦è§å®˜ç½‘ï¼šhttps://www.rabbitmq.com/tutorials/tutorial-five-java.html æ›´å¤šæ–¹å¼ï¼Œè¯·ç›´æ¥æŸ¥çœ‹å®˜ç½‘ï¼šhttps://www.rabbitmq.com/getstarted.html 6. RabbitMQ è¿›é˜¶ 6.1 durable å’Œ autoDeleted åœ¨å®šä¹‰Queueæ—¶ï¼Œå¯ä»¥æŒ‡å®šè¿™ä¸¤ä¸ªå‚æ•°ï¼š /** * Declare an exchange. * @see com.rabbitmq.client.AMQP.Exchange.Declare * @see com.rabbitmq.client.AMQP.Exchange.DeclareOk * @param exchange the name of the exchange * @param type the exchange type * @param durable true if we are declaring a durable exchange (the exchange will survive a server restart) * @param autoDelete true if the server should delete the exchange when it is no longer in use * @param arguments other properties (construction arguments) for the exchange * @return a declaration-confirm method to indicate the exchange was successfully declared * @throws java.io.IOException if an error is encountered */ Exchange.DeclareOk exchangeDeclare(String exchange, BuiltinExchangeType type, boolean durable, boolean autoDelete, Map&lt;String, Object&gt; arguments) throws IOException; /** * Declare a queue * @see com.rabbitmq.client.AMQP.Queue.Declare * @see com.rabbitmq.client.AMQP.Queue.DeclareOk * @param queue the name of the queue * @param durable true if we are declaring a durable queue (the queue will survive a server restart) * @param exclusive true if we are declaring an exclusive queue (restricted to this connection) * @param autoDelete true if we are declaring an autodelete queue (server will delete it when no longer in use) * @param arguments other properties (construction arguments) for the queue * @return a declaration-confirm method to indicate the queue was successfully declared * @throws java.io.IOException if an error is encountered */ Queue.DeclareOk queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments) throws IOException; 6.1.1 durable æŒä¹…åŒ–ï¼Œä¿è¯RabbitMQåœ¨é€€å‡ºæˆ–è€…crashç­‰å¼‚å¸¸æƒ…å†µä¸‹æ•°æ®æ²¡æœ‰ä¸¢å¤±ï¼Œéœ€è¦å°†queueï¼Œexchangeå’ŒMessageéƒ½æŒä¹…åŒ–ã€‚ è‹¥æ˜¯å°†queueçš„æŒä¹…åŒ–æ ‡è¯†durableè®¾ç½®ä¸ºtrueï¼Œåˆ™ä»£è¡¨æ˜¯ä¸€ä¸ªæŒä¹…çš„é˜Ÿåˆ—ï¼Œé‚£ä¹ˆåœ¨æœåŠ¡é‡å¯ä¹‹åï¼Œä¼šé‡æ–°è¯»å–ä¹‹å‰è¢«æŒä¹…åŒ–çš„queueã€‚ è™½ç„¶é˜Ÿåˆ—å¯ä»¥è¢«æŒä¹…åŒ–ï¼Œä½†æ˜¯é‡Œé¢çš„æ¶ˆæ¯æ˜¯å¦ä¸ºæŒä¹…åŒ–ï¼Œè¿˜è¦çœ‹æ¶ˆæ¯çš„æŒä¹…åŒ–è®¾ç½®ã€‚å³é‡å¯queueï¼Œä½†æ˜¯queueé‡Œé¢è¿˜æ²¡æœ‰å‘å‡ºå»çš„æ¶ˆæ¯ï¼Œé‚£é˜Ÿåˆ—é‡Œé¢è¿˜å­˜åœ¨è¯¥æ¶ˆæ¯ä¹ˆï¼Ÿè¿™ä¸ªå–å†³äºè¯¥æ¶ˆæ¯çš„è®¾ç½®ã€‚ 6.1.2 autoDeleted è‡ªåŠ¨åˆ é™¤ï¼Œå¦‚æœè¯¥é˜Ÿåˆ—æ²¡æœ‰ä»»ä½•è®¢é˜…çš„æ¶ˆè´¹è€…çš„è¯ï¼Œè¯¥é˜Ÿåˆ—ä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚è¿™ç§é˜Ÿåˆ—é€‚ç”¨äºä¸´æ—¶é˜Ÿåˆ—ã€‚ å½“ä¸€ä¸ªQueueè¢«è®¾ç½®ä¸ºè‡ªåŠ¨åˆ é™¤æ—¶ï¼Œå½“æ¶ˆè´¹è€…æ–­æ‰ä¹‹åï¼Œqueueä¼šè¢«åˆ é™¤ï¼Œè¿™ä¸ªä¸»è¦é’ˆå¯¹çš„æ˜¯ä¸€äº›ä¸æ˜¯ç‰¹åˆ«é‡è¦çš„æ•°æ®ï¼Œä¸å¸Œæœ›å‡ºç°æ¶ˆæ¯ç§¯ç´¯çš„æƒ…å†µã€‚ 6.1.3 å°èŠ‚ å½“ä¸€ä¸ªQueueå·²ç»å£°æ˜å¥½äº†ä¹‹åï¼Œä¸èƒ½æ›´æ–°durableæˆ–è€…autoDeltedå€¼ï¼›å½“éœ€è¦ä¿®æ”¹æ—¶ï¼Œéœ€è¦å…ˆåˆ é™¤å†é‡æ–°å£°æ˜ æ¶ˆè´¹çš„Queueå£°æ˜åº”è¯¥å’ŒæŠ•é€’çš„Queueå£°æ˜çš„ durable,autoDeltedå±æ€§ä¸€è‡´ï¼Œå¦åˆ™ä¼šæŠ¥é”™ å¯¹äºé‡è¦çš„æ•°æ®ï¼Œä¸€èˆ¬è®¾ç½® durable=true, autoDeleted=false å¯¹äºè®¾ç½® autoDeleted=true çš„é˜Ÿåˆ—ï¼Œå½“æ²¡æœ‰æ¶ˆè´¹è€…ä¹‹åï¼Œé˜Ÿåˆ—ä¼šè‡ªåŠ¨è¢«åˆ é™¤ 6.4 ACK æ‰§è¡Œä¸€ä¸ªä»»åŠ¡å¯èƒ½éœ€è¦èŠ±è´¹å‡ ç§’é’Ÿï¼Œä½ å¯èƒ½ä¼šæ‹…å¿ƒå¦‚æœä¸€ä¸ªæ¶ˆè´¹è€…åœ¨æ‰§è¡Œä»»åŠ¡è¿‡ç¨‹ä¸­æŒ‚æ‰äº†ã€‚ä¸€æ—¦RabbitMQå°†æ¶ˆæ¯åˆ†å‘ç»™äº†æ¶ˆè´¹è€…ï¼Œå°±ä¼šä»å†…å­˜ä¸­åˆ é™¤ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„æ¶ˆè´¹è€…å®•æœºï¼Œä¼šä¸¢å¤±æ­£åœ¨å¤„ç†çš„æ¶ˆæ¯å’Œåˆ†å‘ç»™è¿™ä¸ªæ¶ˆè´¹è€…ä½†å°šæœªå¤„ç†çš„æ¶ˆæ¯ã€‚ ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¸æƒ³ä¸¢å¤±ä»»ä½•ä»»åŠ¡ï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…æŒ‚æ‰äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å°†åˆ†å‘ç»™å®ƒçš„ä»»åŠ¡äº¤ä»˜ç»™å¦ä¸€ä¸ªæ¶ˆè´¹è€…å»å¤„ç†ã€‚ ä¸ºäº†ç¡®ä¿æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼ŒRabbitMQæ”¯æŒæ¶ˆæ¯åº”ç­”ã€‚æ¶ˆè´¹è€…å‘é€ä¸€ä¸ªæ¶ˆæ¯åº”ç­”ï¼Œå‘Šè¯‰RabbitMQè¿™ä¸ªæ¶ˆæ¯å·²ç»æ¥æ”¶å¹¶ä¸”å¤„ç†å®Œæ¯•äº†ã€‚RabbitMQå°±å¯ä»¥åˆ é™¤å®ƒäº†ã€‚ å› æ­¤æ‰‹åŠ¨ACKçš„å¸¸è§æ‰‹æ®µï¼š // æ¥æ”¶æ¶ˆæ¯ä¹‹åï¼Œä¸»åŠ¨ack/nak Consumer consumer = new DefaultConsumer(channel) { @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException { String message = new String(body, &quot;UTF-8&quot;); try { System.out.println(&quot; [ &quot; + queue + &quot; ] Received '&quot; + message); channel.basicAck(envelope.getDeliveryTag(), false); } catch (Exception e) { channel.basicNack(envelope.getDeliveryTag(), false, true); } } }; // å–æ¶ˆè‡ªåŠ¨ack channel.basicConsume(queue, false, consumer); ","link":"https://tianxiawuhao.github.io/olBu0Tj_j/"},{"title":"ExecutorCompletionService","content":"Future Futureæ¨¡å¼æ˜¯å¤šçº¿ç¨‹è®¾è®¡å¸¸ç”¨çš„ä¸€ç§è®¾è®¡æ¨¡å¼ã€‚Futureæ¨¡å¼å¯ä»¥ç†è§£æˆï¼šæˆ‘æœ‰ä¸€ä¸ªä»»åŠ¡ï¼Œæäº¤ç»™äº†Futureï¼ŒFutureæ›¿æˆ‘å®Œæˆè¿™ä¸ªä»»åŠ¡ã€‚æœŸé—´æˆ‘è‡ªå·±å¯ä»¥å»åšä»»ä½•æƒ³åšçš„äº‹æƒ…ã€‚ä¸€æ®µæ—¶é—´ä¹‹åï¼Œæˆ‘å°±ä¾¿å¯ä»¥ä»Futureé‚£å„¿å–å‡ºç»“æœã€‚ Futureæä¾›äº†ä¸‰ç§åŠŸèƒ½ï¼š åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å®Œæˆ èƒ½å¤Ÿä¸­æ–­ä»»åŠ¡ èƒ½å¤Ÿè·å–ä»»åŠ¡æ‰§è¡Œçš„ç»“æœ å‘çº¿ç¨‹æ± ä¸­æäº¤ä»»åŠ¡çš„submitæ–¹æ³•ä¸æ˜¯é˜»å¡æ–¹æ³•ï¼Œè€ŒFuture.getæ–¹æ³•æ˜¯ä¸€ä¸ªé˜»å¡æ–¹æ³•ï¼Œå½“submitæäº¤å¤šä¸ªä»»åŠ¡æ—¶ï¼Œåªæœ‰æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆåï¼Œæ‰èƒ½ä½¿ç”¨getæŒ‰ç…§ä»»åŠ¡çš„æäº¤é¡ºåºå¾—åˆ°è¿”å›ç»“æœï¼Œæ‰€ä»¥ä¸€èˆ¬éœ€è¦ä½¿ç”¨future.isDoneå…ˆåˆ¤æ–­ä»»åŠ¡æ˜¯å¦å…¨éƒ¨æ‰§è¡Œå®Œæˆï¼Œå®Œæˆåå†ä½¿ç”¨future.getå¾—åˆ°ç»“æœã€‚ï¼ˆä¹Ÿå¯ä»¥ç”¨get (long timeout, TimeUnit unit)æ–¹æ³•å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œé˜²æ­¢æ— é™æ—¶é—´çš„ç­‰å¾…ï¼‰ ä¸‰æ®µå¼çš„ç¼–ç¨‹ï¼š1.å¯åŠ¨å¤šçº¿ç¨‹ä»»åŠ¡2.å¤„ç†å…¶ä»–äº‹3.æ”¶é›†å¤šçº¿ç¨‹ä»»åŠ¡ç»“æœï¼ŒFutureè™½ç„¶å¯ä»¥å®ç°è·å–å¼‚æ­¥æ‰§è¡Œç»“æœçš„éœ€æ±‚ï¼Œä½†æ˜¯å®ƒæ²¡æœ‰æä¾›é€šçŸ¥çš„æœºåˆ¶ï¼Œè¦ä¹ˆä½¿ç”¨é˜»å¡ï¼Œåœ¨future.get()çš„åœ°æ–¹ç­‰å¾…futureè¿”å›çš„ç»“æœï¼Œè¿™æ—¶åˆå˜æˆåŒæ­¥æ“ä½œï¼›è¦ä¹ˆä½¿ç”¨isDone()è½®è¯¢åœ°åˆ¤æ–­Futureæ˜¯å¦å®Œæˆï¼Œè¿™æ ·ä¼šè€—è´¹CPUçš„èµ„æºã€‚ è§£å†³æ–¹æ³•ï¼šCompletionServiceå’ŒCompletableFutureï¼ˆæŒ‰ç…§ä»»åŠ¡å®Œæˆçš„å…ˆåé¡ºåºè·å–ä»»åŠ¡çš„ç»“æœï¼‰ ExecutorService åˆ›å»ºçº¿ç¨‹æ± ï¼Œå¤šçº¿ç¨‹åŠŸèƒ½è°ƒç”¨ public static void test1() throws Exception { ExecutorService executorService = Executors.newCachedThreadPool(); ArrayList&lt;Future&lt;String&gt;&gt; futureArrayList = new ArrayList&lt;&gt;(); System.out.println(&quot;å…¬å¸è®©ä½ é€šçŸ¥å¤§å®¶èšé¤ ä½ å¼€è½¦å»æ¥äºº&quot;); Future&lt;String&gt; future10 = executorService.submit(() -&gt; { System.out.println(&quot;æ€»è£ï¼šæˆ‘åœ¨å®¶ä¸Šå¤§å· æˆ‘æœ€è¿‘æ‹‰è‚šå­æ¯”è¾ƒæ…¢ è¦è¹²1ä¸ªå°æ—¶æ‰èƒ½å‡ºæ¥ ä½ ç­‰ä¼šæ¥æ¥æˆ‘å§&quot;); TimeUnit.SECONDS.sleep(10); System.out.println(&quot;æ€»è£ï¼š1å°æ—¶äº† æˆ‘ä¸Šå®Œå¤§å·äº†ã€‚ä½ æ¥æ¥å§&quot;); return &quot;æ€»è£ä¸Šå®Œå¤§å·äº†&quot;; }); futureArrayList.add(future10); Future&lt;String&gt; future6 = executorService.submit(() -&gt; { System.out.println(&quot;ä¸­å±‚ç®¡ç†ï¼šæˆ‘åœ¨å®¶ä¸Šå¤§å· è¦è¹²10åˆ†é’Ÿå°±å¯ä»¥å‡ºæ¥ ä½ ç­‰ä¼šæ¥æ¥æˆ‘å§&quot;); TimeUnit.SECONDS.sleep(6); System.out.println(&quot;ä¸­å±‚ç®¡ç†ï¼š10åˆ†é’Ÿ æˆ‘ä¸Šå®Œå¤§å·äº†ã€‚ä½ æ¥æ¥å§&quot;); return &quot;ä¸­å±‚ç®¡ç†ä¸Šå®Œå¤§å·äº†&quot;; }); futureArrayList.add(future6); Future&lt;String&gt; future3 = executorService.submit(() -&gt; { System.out.println(&quot;ç ”å‘ï¼šæˆ‘åœ¨å®¶ä¸Šå¤§å· æˆ‘æ¯”è¾ƒå¿« è¦è¹²3åˆ†é’Ÿå°±å¯ä»¥å‡ºæ¥ ä½ ç­‰ä¼šæ¥æ¥æˆ‘å§&quot;); TimeUnit.SECONDS.sleep(3); System.out.println(&quot;ç ”å‘ï¼š3åˆ†é’Ÿ æˆ‘ä¸Šå®Œå¤§å·äº†ã€‚ä½ æ¥æ¥å§&quot;); return &quot;ç ”å‘ä¸Šå®Œå¤§å·äº†&quot;; }); futureArrayList.add(future3); TimeUnit.SECONDS.sleep(1); System.out.println(&quot;éƒ½é€šçŸ¥å®Œäº†,ç­‰ç€æ¥å§ã€‚&quot;); try { for (Future&lt;String&gt; future : futureArrayList) { String returnStr = future.get(); System.out.println(returnStr + &quot;ï¼Œä½ å»æ¥ä»–&quot;); } } catch (Exception e) { e.printStackTrace(); }finally { executorService.shutdown(); } } ç»“æœ å…¬å¸è®©ä½ é€šçŸ¥å¤§å®¶èšé¤ ä½ å¼€è½¦å»æ¥äºº ç ”å‘ï¼šæˆ‘åœ¨å®¶ä¸Šå¤§å· æˆ‘æ¯”è¾ƒå¿« è¦è¹²3åˆ†é’Ÿå°±å¯ä»¥å‡ºæ¥ ä½ ç­‰ä¼šæ¥æ¥æˆ‘å§ æ€»è£ï¼šæˆ‘åœ¨å®¶ä¸Šå¤§å· æˆ‘æœ€è¿‘æ‹‰è‚šå­æ¯”è¾ƒæ…¢ è¦è¹²1ä¸ªå°æ—¶æ‰èƒ½å‡ºæ¥ ä½ ç­‰ä¼šæ¥æ¥æˆ‘å§ ä¸­å±‚ç®¡ç†ï¼šæˆ‘åœ¨å®¶ä¸Šå¤§å· è¦è¹²10åˆ†é’Ÿå°±å¯ä»¥å‡ºæ¥ ä½ ç­‰ä¼šæ¥æ¥æˆ‘å§ éƒ½é€šçŸ¥å®Œäº†,ç­‰ç€æ¥å§ã€‚ ç ”å‘ï¼š3åˆ†é’Ÿ æˆ‘ä¸Šå®Œå¤§å·äº†ã€‚ä½ æ¥æ¥å§ ç ”å‘ä¸Šå®Œå¤§å·äº†ï¼Œä½ å»æ¥ä»– ä¸­å±‚ç®¡ç†ï¼š10åˆ†é’Ÿ æˆ‘ä¸Šå®Œå¤§å·äº†ã€‚ä½ æ¥æ¥å§ æ€»è£ï¼š1å°æ—¶äº† æˆ‘ä¸Šå®Œå¤§å·äº†ã€‚ä½ æ¥æ¥å§ æ€»è£ä¸Šå®Œå¤§å·äº†ï¼Œä½ å»æ¥ä»– ä¸­å±‚ç®¡ç†ä¸Šå®Œå¤§å·äº†ï¼Œä½ å»æ¥ä»– ExecutorCompletionService public static void test2() throws Exception { ExecutorService executorService = Executors.newCachedThreadPool(); ExecutorCompletionService&lt;String&gt; completionService = new ExecutorCompletionService&lt;&gt;(executorService); System.out.println(&quot;å…¬å¸è®©ä½ é€šçŸ¥å¤§å®¶èšé¤ ä½ å¼€è½¦å»æ¥äºº&quot;); completionService.submit(() -&gt; { System.out.println(&quot;æ€»è£ï¼šæˆ‘åœ¨å®¶ä¸Šå¤§å· æˆ‘æœ€è¿‘æ‹‰è‚šå­æ¯”è¾ƒæ…¢ è¦è¹²1ä¸ªå°æ—¶æ‰èƒ½å‡ºæ¥ ä½ ç­‰ä¼šæ¥æ¥æˆ‘å§&quot;); TimeUnit.SECONDS.sleep(10); System.out.println(&quot;æ€»è£ï¼š1å°æ—¶äº† æˆ‘ä¸Šå®Œå¤§å·äº†ã€‚ä½ æ¥æ¥å§&quot;); return &quot;æ€»è£ä¸Šå®Œå¤§å·äº†&quot;; }); completionService.submit(() -&gt; { System.out.println(&quot;ä¸­å±‚ç®¡ç†ï¼šæˆ‘åœ¨å®¶ä¸Šå¤§å· è¦è¹²10åˆ†é’Ÿå°±å¯ä»¥å‡ºæ¥ ä½ ç­‰ä¼šæ¥æ¥æˆ‘å§&quot;); TimeUnit.SECONDS.sleep(6); System.out.println(&quot;ä¸­å±‚ç®¡ç†ï¼š10åˆ†é’Ÿ æˆ‘ä¸Šå®Œå¤§å·äº†ã€‚ä½ æ¥æ¥å§&quot;); return &quot;ä¸­å±‚ç®¡ç†ä¸Šå®Œå¤§å·äº†&quot;; }); completionService.submit(() -&gt; { System.out.println(&quot;ç ”å‘ï¼šæˆ‘åœ¨å®¶ä¸Šå¤§å· æˆ‘æ¯”è¾ƒå¿« è¦è¹²3åˆ†é’Ÿå°±å¯ä»¥å‡ºæ¥ ä½ ç­‰ä¼šæ¥æ¥æˆ‘å§&quot;); TimeUnit.SECONDS.sleep(3); System.out.println(&quot;ç ”å‘ï¼š3åˆ†é’Ÿ æˆ‘ä¸Šå®Œå¤§å·äº†ã€‚ä½ æ¥æ¥å§&quot;); return &quot;ç ”å‘ä¸Šå®Œå¤§å·äº†&quot;; }); TimeUnit.SECONDS.sleep(1); System.out.println(&quot;éƒ½é€šçŸ¥å®Œäº†,ç­‰ç€æ¥å§ã€‚&quot;); //æäº¤äº†3ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼‰ try { for (int i = 0; i &lt; 3; i++) { String returnStr = completionService.take().get(); System.out.println(returnStr + &quot;ï¼Œä½ å»æ¥ä»–&quot;); } Thread.currentThread().join(); } catch (Exception e) { e.printStackTrace(); }finally { executorService.shutdown(); } } ç»“æœ å…¬å¸è®©ä½ é€šçŸ¥å¤§å®¶èšé¤ ä½ å¼€è½¦å»æ¥äºº æ€»è£ï¼šæˆ‘åœ¨å®¶ä¸Šå¤§å· æˆ‘æœ€è¿‘æ‹‰è‚šå­æ¯”è¾ƒæ…¢ è¦è¹²1ä¸ªå°æ—¶æ‰èƒ½å‡ºæ¥ ä½ ç­‰ä¼šæ¥æ¥æˆ‘å§ ç ”å‘ï¼šæˆ‘åœ¨å®¶ä¸Šå¤§å· æˆ‘æ¯”è¾ƒå¿« è¦è¹²3åˆ†é’Ÿå°±å¯ä»¥å‡ºæ¥ ä½ ç­‰ä¼šæ¥æ¥æˆ‘å§ ä¸­å±‚ç®¡ç†ï¼šæˆ‘åœ¨å®¶ä¸Šå¤§å· è¦è¹²10åˆ†é’Ÿå°±å¯ä»¥å‡ºæ¥ ä½ ç­‰ä¼šæ¥æ¥æˆ‘å§ éƒ½é€šçŸ¥å®Œäº†,ç­‰ç€æ¥å§ã€‚ ç ”å‘ï¼š3åˆ†é’Ÿ æˆ‘ä¸Šå®Œå¤§å·äº†ã€‚ä½ æ¥æ¥å§ ç ”å‘ä¸Šå®Œå¤§å·äº†ï¼Œä½ å»æ¥ä»– ä¸­å±‚ç®¡ç†ï¼š10åˆ†é’Ÿ æˆ‘ä¸Šå®Œå¤§å·äº†ã€‚ä½ æ¥æ¥å§ ä¸­å±‚ç®¡ç†ä¸Šå®Œå¤§å·äº†ï¼Œä½ å»æ¥ä»– æ€»è£ï¼š1å°æ—¶äº† æˆ‘ä¸Šå®Œå¤§å·äº†ã€‚ä½ æ¥æ¥å§ æ€»è£ä¸Šå®Œå¤§å·äº†ï¼Œä½ å»æ¥ä»– æºç åˆ†æ completionServiceæ˜¯JUCé‡Œçš„çº¿ç¨‹æ± ExecutorCompletionService åˆå§‹åŒ–çº¿ç¨‹æ±  åŒæ­¥åˆå§‹åŒ–ä¸€ä¸ªå®Œæˆé˜Ÿåˆ—completionQueue public ExecutorCompletionService(Executor executor) { if (executor == null) throw new NullPointerException(); this.executor = executor; this.aes = (executor instanceof AbstractExecutorService) ? (AbstractExecutorService) executor : null; this.completionQueue = new LinkedBlockingQueue&lt;Future&lt;V&gt;&gt;(); } æ‰§è¡Œsubmitæ–¹æ³• çº¿ç¨‹æ± æ‰§è¡Œçš„æ—¶å€™ä¼ å…¥äº†è‡ªå·±çš„å†…éƒ¨ç±»QueueingFuture public Future&lt;V&gt; submit(Callable&lt;V&gt; task) { if (task == null) throw new NullPointerException(); RunnableFuture&lt;V&gt; f = newTaskFor(task); executor.execute(new QueueingFuture&lt;V&gt;(f, completionQueue)); return f; } QueueingFutureæ„é€ å‡½æ•°ï¼Œéœ€è¦å…³æ³¨è¿™é‡Œé‡å†™äº†doneæ–¹æ³•ï¼Œå‘é˜»å¡é˜Ÿåˆ—é‡Œæ·»åŠ task private static class QueueingFuture&lt;V&gt; extends FutureTask&lt;Void&gt; { QueueingFuture(RunnableFuture&lt;V&gt; task, BlockingQueue&lt;Future&lt;V&gt;&gt; completionQueue) { super(task, null); this.task = task; this.completionQueue = completionQueue; } private final Future&lt;V&gt; task; private final BlockingQueue&lt;Future&lt;V&gt;&gt; completionQueue; protected void done() { completionQueue.add(task); } //å¾€completionQueueé‡Œé¢å­˜å€¼ } æ‰§è¡ŒFutureTaskçš„runæ–¹æ³• public void run() { if (state != NEW || !RUNNER.compareAndSet(this, null, Thread.currentThread())) return; try { Callable&lt;V&gt; c = callable; if (c != null &amp;&amp; state == NEW) { V result; boolean ran; try { result = c.call(); ran = true; } catch (Throwable ex) { result = null; ran = false; setException(ex); } if (ran) set(result); //è®¾ç½®å€¼ } } finally { // runner must be non-null until state is settled to // prevent concurrent calls to run() runner = null; // state must be re-read after nulling runner to prevent // leaked interrupts int s = state; if (s &gt;= INTERRUPTING) handlePossibleCancellationInterrupt(s); } } setæ–¹æ³• protected void set(V v) { if (STATE.compareAndSet(this, NEW, COMPLETING)) { outcome = v; STATE.setRelease(this, NORMAL); // final state finishCompletion(); } } åœ¨finishCompletionæ–¹æ³•ä¸­æ‰§è¡Œäº†doneæ–¹æ³• private void finishCompletion() { // assert state &gt; COMPLETING; for (WaitNode q; (q = waiters) != null;) { if (WAITERS.weakCompareAndSet(this, q, null)) { for (;;) { Thread t = q.thread; if (t != null) { q.thread = null; LockSupport.unpark(t); } WaitNode next = q.next; if (next == null) break; q.next = null; // unlink to help gc q = next; } break; } } done(); //æ‰§è¡Œdoneæ–¹æ³•-completionQueue.add(task); callable = null; // to reduce footprint } æ‰€ä»¥æ¯æ¬¡çº¿ç¨‹å®Œæˆä»»åŠ¡ï¼Œéƒ½ä¼šå¾€completionQueueä¸­æ–°å¢ä¸€æ¡è®°å½•ã€‚completionQueueä¸­çš„è®°å½•éœ€è¦é€šè¿‡åˆ«çš„æ–¹å¼å–ï¼šExecutorCompletionService.take()ã€‚ ExecutorCompletionServiceçš„å®é™…ç”¨æ³•åº”è¯¥æ˜¯è¿™æ ·çš„ï¼šCompletionServiceä¸€è¾¹æ‰§è¡Œä»»åŠ¡ï¼Œä¸€è¾¹å¤„ç†å®Œæˆçš„ä»»åŠ¡ç»“æœï¼Œè¿™æ ·å¯ä»¥å°†æ‰§è¡Œçš„ä»»åŠ¡ä¸å¤„ç†ä»»åŠ¡éš”ç¦»å¼€æ¥è¿›è¡Œå¤„ç†ï¼Œä½¿ç”¨submitæ‰§è¡Œä»»åŠ¡ï¼Œä½¿ç”¨takeè·å–å·²å®Œæˆçš„ä»»åŠ¡ï¼Œå…ˆå®Œæˆçš„ä»»åŠ¡ç»“æœå…ˆåŠ å…¥é˜Ÿåˆ—ã€‚è·å–çš„ç»“æœï¼Œè·Ÿæäº¤ç»™çº¿ç¨‹æ± çš„ä»»åŠ¡æ˜¯æ— å…³è”çš„ã€‚ Future&lt;String&gt; submit = completionService.submit(() -&gt; { return &quot;å‡è£…æœ‰è¿”å›&quot;; }); submit.get();//ç›´æ¥è·å–è¿”å›å€¼ å¦‚ä¸Šå¦‚æœæˆ‘ä»¬åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ç”±äºéœ€è¦çš„æ˜¯å½“å‰çº¿ç¨‹ä»»åŠ¡çš„è¿”å›å€¼ï¼Œæ‰€ä»¥æ²¡æœ‰è°ƒç”¨takeæ–¹æ³•ï¼Œè€Œæ˜¯é€šè¿‡getæ–¹æ³•è·å–åˆ°å½“å‰çº¿ç¨‹è°ƒç”¨çš„è¿”å›å€¼ï¼Œä¼šå¯¼è‡´taskä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­ä¸€ç›´å¢åŠ ï¼Œä»è€Œé€ æˆOOM ","link":"https://tianxiawuhao.github.io/wT9gsiZx3/"},{"title":"æ¶ˆæ¯é˜Ÿåˆ—é€‰å‹","content":"æ¶ˆæ¯é˜Ÿåˆ— å¸¸ç”¨çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸»è¦è¿™ 4 ç§ï¼Œåˆ†åˆ«ä¸º Kafkaã€RabbitMQã€RocketMQ å’Œ ActiveMQï¼Œä¸»è¦ä»‹ç»å‰ä¸‰ï¼Œä¸BBï¼Œä¸Šæ€ç»´å¯¼å›¾ï¼ æ¶ˆæ¯é˜Ÿåˆ—åŸºç¡€ ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ æ¶ˆæ¯é˜Ÿåˆ—æ˜¯åœ¨æ¶ˆæ¯çš„ä¼ è¾“è¿‡ç¨‹ä¸­ä¿å­˜æ¶ˆæ¯çš„å®¹å™¨ï¼Œç”¨äºæ¥æ”¶æ¶ˆæ¯å¹¶ä»¥æ–‡ä»¶çš„æ–¹å¼å­˜å‚¨ï¼Œä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥è¢«ä¸€ä¸ªä¹Ÿå¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼ŒåŒ…å«ä»¥ä¸‹ 3 å…ƒç´ ï¼š Producerï¼šæ¶ˆæ¯ç”Ÿäº§è€…ï¼Œè´Ÿè´£äº§ç”Ÿå’Œå‘é€æ¶ˆæ¯åˆ° Brokerï¼› Brokerï¼šæ¶ˆæ¯å¤„ç†ä¸­å¿ƒï¼Œè´Ÿè´£æ¶ˆæ¯å­˜å‚¨ã€ç¡®è®¤ã€é‡è¯•ç­‰ï¼Œä¸€èˆ¬å…¶ä¸­ä¼šåŒ…å«å¤šä¸ª Queueï¼› Consumerï¼šæ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œè´Ÿè´£ä» Broker ä¸­è·å–æ¶ˆæ¯ï¼Œå¹¶è¿›è¡Œç›¸åº”å¤„ç†ã€‚ æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å¼ ç‚¹å¯¹ç‚¹æ¨¡å¼ï¼šå¤šä¸ªç”Ÿäº§è€…å¯ä»¥å‘åŒä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å‘é€æ¶ˆæ¯ï¼Œä¸€ä¸ªå…·ä½“çš„æ¶ˆæ¯åªèƒ½ç”±ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ã€‚ å‘å¸ƒ/è®¢é˜…æ¨¡å¼ï¼šå•ä¸ªæ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªè®¢é˜…è€…å¹¶å‘çš„è·å–å’Œå¤„ç†ã€‚ æ¶ˆæ¯é˜Ÿåˆ—åº”ç”¨åœºæ™¯ åº”ç”¨è§£è€¦ï¼šæ¶ˆæ¯é˜Ÿåˆ—å‡å°‘äº†æœåŠ¡ä¹‹é—´çš„è€¦åˆæ€§ï¼Œä¸åŒçš„æœåŠ¡å¯ä»¥é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œé€šä¿¡ï¼Œè€Œä¸ç”¨å…³å¿ƒå½¼æ­¤çš„å®ç°ç»†èŠ‚ã€‚ å¼‚æ­¥å¤„ç†ï¼šæ¶ˆæ¯é˜Ÿåˆ—æœ¬èº«æ˜¯å¼‚æ­¥çš„ï¼Œå®ƒå…è®¸æ¥æ”¶è€…åœ¨æ¶ˆæ¯å‘é€å¾ˆé•¿æ—¶é—´åå†å–å›æ¶ˆæ¯ã€‚ æµé‡å‰Šé”‹ï¼šå½“ä¸Šä¸‹æ¸¸ç³»ç»Ÿå¤„ç†èƒ½åŠ›å­˜åœ¨å·®è·çš„æ—¶å€™ï¼Œåˆ©ç”¨æ¶ˆæ¯é˜Ÿåˆ—åšä¸€ä¸ªé€šç”¨çš„â€è½½ä½“â€ï¼Œåœ¨ä¸‹æ¸¸æœ‰èƒ½åŠ›å¤„ç†çš„æ—¶å€™ï¼Œå†è¿›è¡Œåˆ†å‘ä¸å¤„ç†ã€‚ æ—¥å¿—å¤„ç†ï¼šæ—¥å¿—å¤„ç†æ˜¯æŒ‡å°†æ¶ˆæ¯é˜Ÿåˆ—ç”¨åœ¨æ—¥å¿—å¤„ç†ä¸­ï¼Œæ¯”å¦‚ Kafka çš„åº”ç”¨ï¼Œè§£å†³å¤§é‡æ—¥å¿—ä¼ è¾“çš„é—®é¢˜ã€‚ æ¶ˆæ¯é€šè®¯ï¼šæ¶ˆæ¯é˜Ÿåˆ—ä¸€èˆ¬éƒ½å†…ç½®äº†é«˜æ•ˆçš„é€šä¿¡æœºåˆ¶ï¼Œå› æ­¤ä¹Ÿå¯ä»¥ç”¨åœ¨çº¯çš„æ¶ˆæ¯é€šè®¯ï¼Œæ¯”å¦‚å®ç°ç‚¹å¯¹ç‚¹æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæˆ–è€…èŠå¤©å®¤ç­‰ã€‚ æ¶ˆæ¯å¹¿æ’­ï¼šå¦‚æœæ²¡æœ‰æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¯å½“ä¸€ä¸ªæ–°çš„ä¸šåŠ¡æ–¹æ¥å…¥ï¼Œæˆ‘ä»¬éƒ½è¦æ¥å…¥ä¸€æ¬¡æ–°æ¥å£ã€‚æœ‰äº†æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæˆ‘ä»¬åªéœ€è¦å…³å¿ƒæ¶ˆæ¯æ˜¯å¦é€è¾¾äº†é˜Ÿåˆ—ï¼Œè‡³äºè°å¸Œæœ›è®¢é˜…ï¼Œæ˜¯ä¸‹æ¸¸çš„äº‹æƒ…ï¼Œæ— ç–‘æå¤§åœ°å‡å°‘äº†å¼€å‘å’Œè”è°ƒçš„å·¥ä½œé‡ã€‚ å¸¸ç”¨æ¶ˆæ¯é˜Ÿåˆ— ç”±äºå®˜æ–¹ç¤¾åŒºç°åœ¨å¯¹ ActiveMQ 5.x ç»´æŠ¤è¶Šæ¥è¶Šå°‘ï¼Œè¾ƒå°‘åœ¨å¤§è§„æ¨¡ååçš„åœºæ™¯ä¸­ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸»è¦è®²è§£ Kafkaã€RabbitMQ å’Œ RocketMQã€‚ Kafka Apache Kafka æœ€åˆç”± LinkedIn å…¬å¸åŸºäºç‹¬ç‰¹çš„è®¾è®¡å®ç°ä¸ºä¸€ä¸ªåˆ†å¸ƒå¼çš„æäº¤æ—¥å¿—ç³»ç»Ÿï¼Œä¹‹åæˆä¸º Apache é¡¹ç›®çš„ä¸€éƒ¨åˆ†ï¼Œå·ç§°å¤§æ•°æ®çš„æ€æ‰‹é”ï¼Œåœ¨æ•°æ®é‡‡é›†ã€ä¼ è¾“ã€å­˜å‚¨çš„è¿‡ç¨‹ä¸­å‘æŒ¥ç€ä¸¾è¶³è½»é‡çš„ä½œç”¨ã€‚ å®ƒæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„ï¼Œæ”¯æŒå¤šåˆ†åŒºã€å¤šå‰¯æœ¬ï¼ŒåŸºäº Zookeeper çš„åˆ†å¸ƒå¼æ¶ˆæ¯æµå¹³å°ï¼Œå®ƒåŒæ—¶ä¹Ÿæ˜¯ä¸€æ¬¾å¼€æºçš„åŸºäºå‘å¸ƒè®¢é˜…æ¨¡å¼çš„æ¶ˆæ¯å¼•æ“ç³»ç»Ÿã€‚ é‡è¦æ¦‚å¿µ ä¸»é¢˜ï¼ˆTopicï¼‰ï¼šæ¶ˆæ¯çš„ç§ç±»ç§°ä¸ºä¸»é¢˜ï¼Œå¯ä»¥è¯´ä¸€ä¸ªä¸»é¢˜ä»£è¡¨äº†ä¸€ç±»æ¶ˆæ¯ï¼Œç›¸å½“äºæ˜¯å¯¹æ¶ˆæ¯è¿›è¡Œåˆ†ç±»ï¼Œä¸»é¢˜å°±åƒæ˜¯æ•°æ®åº“ä¸­çš„è¡¨ã€‚ åˆ†åŒºï¼ˆpartitionï¼‰ï¼šä¸»é¢˜å¯ä»¥è¢«åˆ†ä¸ºè‹¥å¹²ä¸ªåˆ†åŒºï¼ŒåŒä¸€ä¸ªä¸»é¢˜ä¸­çš„åˆ†åŒºå¯ä»¥ä¸åœ¨ä¸€ä¸ªæœºå™¨ä¸Šï¼Œæœ‰å¯èƒ½ä¼šéƒ¨ç½²åœ¨å¤šä¸ªæœºå™¨ä¸Šï¼Œç”±æ­¤æ¥å®ç° kafka çš„ä¼¸ç¼©æ€§ã€‚ æ‰¹æ¬¡ï¼šä¸ºäº†æé«˜æ•ˆç‡ï¼Œ æ¶ˆæ¯ä¼šåˆ†æ‰¹æ¬¡å†™å…¥ Kafkaï¼Œæ‰¹æ¬¡å°±ä»£æŒ‡çš„æ˜¯ä¸€ç»„æ¶ˆæ¯ã€‚ æ¶ˆè´¹è€…ç¾¤ç»„ï¼ˆConsumer Groupï¼‰ï¼šæ¶ˆè´¹è€…ç¾¤ç»„æŒ‡çš„å°±æ˜¯ç”±ä¸€ä¸ªæˆ–å¤šä¸ªæ¶ˆè´¹è€…ç»„æˆçš„ç¾¤ä½“ã€‚ Broker: ä¸€ä¸ªç‹¬ç«‹çš„ Kafka æœåŠ¡å™¨å°±è¢«ç§°ä¸º brokerï¼Œbroker æ¥æ”¶æ¥è‡ªç”Ÿäº§è€…çš„æ¶ˆæ¯ï¼Œä¸ºæ¶ˆæ¯è®¾ç½®åç§»é‡ï¼Œå¹¶æäº¤æ¶ˆæ¯åˆ°ç£ç›˜ä¿å­˜ã€‚ Broker é›†ç¾¤ï¼šbroker é›†ç¾¤ç”±ä¸€ä¸ªæˆ–å¤šä¸ª broker ç»„æˆã€‚ é‡å¹³è¡¡ï¼ˆRebalanceï¼‰ï¼šæ¶ˆè´¹è€…ç»„å†…æŸä¸ªæ¶ˆè´¹è€…å®ä¾‹æŒ‚æ‰åï¼Œå…¶ä»–æ¶ˆè´¹è€…å®ä¾‹è‡ªåŠ¨é‡æ–°åˆ†é…è®¢é˜…ä¸»é¢˜åˆ†åŒºçš„è¿‡ç¨‹ã€‚ Kafka æ¶æ„ ä¸€ä¸ªå…¸å‹çš„ Kafka é›†ç¾¤ä¸­åŒ…å« Producerã€brokerã€Consumer Groupã€Zookeeper é›†ç¾¤ã€‚ Kafka é€šè¿‡ Zookeeper ç®¡ç†é›†ç¾¤é…ç½®ï¼Œé€‰ä¸¾ leaderï¼Œä»¥åŠåœ¨ Consumer Group å‘ç”Ÿå˜åŒ–æ—¶è¿›è¡Œ rebalanceã€‚Producer ä½¿ç”¨ push æ¨¡å¼å°†æ¶ˆæ¯å‘å¸ƒåˆ° brokerï¼ŒConsumer ä½¿ç”¨ pull æ¨¡å¼ä» broker è®¢é˜…å¹¶æ¶ˆè´¹æ¶ˆæ¯ã€‚ Kafka å·¥ä½œåŸç† æ¶ˆæ¯ç»è¿‡åºåˆ—åŒ–åï¼Œé€šè¿‡ä¸åŒçš„åˆ†åŒºç­–ç•¥ï¼Œæ‰¾åˆ°å¯¹åº”çš„åˆ†åŒºã€‚ ç›¸åŒä¸»é¢˜å’Œåˆ†åŒºçš„æ¶ˆæ¯ï¼Œä¼šè¢«å­˜æ”¾åœ¨åŒä¸€ä¸ªæ‰¹æ¬¡é‡Œï¼Œç„¶åç”±ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹è´Ÿè´£æŠŠå®ƒä»¬å‘åˆ° Kafka Broker ä¸Šã€‚ åˆ†åŒºçš„ç­–ç•¥åŒ…æ‹¬é¡ºåºè½®è¯¢ã€éšæœºè½®è¯¢å’Œ key hash è¿™ 3 ç§æ–¹å¼ï¼Œé‚£ä»€ä¹ˆæ˜¯åˆ†åŒºå‘¢ï¼Ÿ åˆ†åŒºæ˜¯ Kafka è¯»å†™æ•°æ®çš„æœ€å°ç²’åº¦ï¼Œæ¯”å¦‚ä¸»é¢˜ A æœ‰ 15 æ¡æ¶ˆæ¯ï¼Œæœ‰ 5 ä¸ªåˆ†åŒºï¼Œå¦‚æœé‡‡ç”¨é¡ºåºè½®è¯¢çš„æ–¹å¼ï¼Œ15 æ¡æ¶ˆæ¯ä¼šé¡ºåºåˆ†é…ç»™è¿™ 5 ä¸ªåˆ†åŒºï¼Œåç»­æ¶ˆè´¹çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯æŒ‰ç…§åˆ†åŒºç²’åº¦æ¶ˆè´¹ã€‚ ç”±äºåˆ†åŒºå¯ä»¥éƒ¨ç½²åœ¨å¤šä¸ªä¸åŒçš„æœºå™¨ä¸Šï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡åˆ†åŒºå®ç° Kafka çš„ä¼¸ç¼©æ€§ï¼Œæ¯”å¦‚ä¸»é¢˜ A çš„ 5 ä¸ªåˆ†åŒºï¼Œåˆ†åˆ«éƒ¨ç½²åœ¨ 5 å°æœºå™¨ä¸Šï¼Œå¦‚æœä¸‹çº¿ä¸€å°ï¼Œåˆ†åŒºå°±å˜ä¸º 4ã€‚ Kafka æ¶ˆè´¹æ˜¯é€šè¿‡æ¶ˆè´¹ç¾¤ç»„å®Œæˆï¼ŒåŒä¸€ä¸ªæ¶ˆè´¹è€…ç¾¤ç»„ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹å¤šä¸ªåˆ†åŒºï¼Œä½†æ˜¯ä¸€ä¸ªåˆ†åŒºï¼Œåªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ã€‚ å¦‚æœæ¶ˆè´¹è€…å¢åŠ ï¼Œä¼šè§¦å‘ Rebalanceï¼Œä¹Ÿå°±æ˜¯åˆ†åŒºå’Œæ¶ˆè´¹è€…éœ€è¦é‡æ–°é…å¯¹ã€‚ ä¸åŒçš„æ¶ˆè´¹ç¾¤ç»„äº’ä¸å¹²æ¶‰ï¼Œæ¯”å¦‚ä¸‹å›¾çš„ 2 ä¸ªæ¶ˆè´¹ç¾¤ç»„ï¼Œå¯ä»¥åˆ†åˆ«æ¶ˆè´¹è¿™ 4 ä¸ªåˆ†åŒºçš„æ¶ˆæ¯ï¼Œäº’ä¸å½±å“ã€‚ æ›´å¤šçŸ¥è¯†ï¼Œè¯¦è§Kafka æ¶æ„æ·±å…¥ RocketMQ RocketMQ æ˜¯é˜¿é‡Œå¼€æºçš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå®ƒæ˜¯çº¯ Java å¼€å‘ï¼Œå…·æœ‰é«˜æ€§èƒ½ã€é«˜å¯é ã€é«˜å®æ—¶ã€é€‚åˆå¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿåº”ç”¨çš„ç‰¹ç‚¹ã€‚ RocketMQ æ€è·¯èµ·æºäº Kafkaï¼Œä½†å¹¶ä¸æ˜¯ Kafka çš„ä¸€ä¸ª Copyï¼Œå®ƒå¯¹æ¶ˆæ¯çš„å¯é ä¼ è¾“åŠäº‹åŠ¡æ€§åšäº†ä¼˜åŒ–ï¼Œç›®å‰åœ¨é˜¿é‡Œé›†å›¢è¢«å¹¿æ³›åº”ç”¨äºäº¤æ˜“ã€å……å€¼ã€æµè®¡ç®—ã€æ¶ˆæ¯æ¨é€ã€æ—¥å¿—æµå¼å¤„ç†ã€binlog åˆ†å‘ç­‰åœºæ™¯ã€‚ é‡è¦æ¦‚å¿µ Name æœåŠ¡å™¨ï¼ˆNameServerï¼‰ï¼šå……å½“æ³¨å†Œä¸­å¿ƒï¼Œç±»ä¼¼ Kafka ä¸­çš„ Zookeeperã€‚ Broker: ä¸€ä¸ªç‹¬ç«‹çš„ RocketMQ æœåŠ¡å™¨å°±è¢«ç§°ä¸º brokerï¼Œbroker æ¥æ”¶æ¥è‡ªç”Ÿäº§è€…çš„æ¶ˆæ¯ï¼Œä¸ºæ¶ˆæ¯è®¾ç½®åç§»é‡ã€‚ ä¸»é¢˜ï¼ˆTopicï¼‰ï¼šæ¶ˆæ¯çš„ç¬¬ä¸€çº§ç±»å‹ï¼Œä¸€æ¡æ¶ˆæ¯å¿…é¡»æœ‰ä¸€ä¸ª Topicã€‚ å­ä¸»é¢˜ï¼ˆTagï¼‰ï¼šæ¶ˆæ¯çš„ç¬¬äºŒçº§ç±»å‹ï¼ŒåŒä¸€ä¸šåŠ¡æ¨¡å—ä¸åŒç›®çš„çš„æ¶ˆæ¯å°±å¯ä»¥ç”¨ç›¸åŒ Topic å’Œä¸åŒçš„ Tag æ¥æ ‡è¯†ã€‚ åˆ†ç»„ï¼ˆGroupï¼‰ï¼šä¸€ä¸ªç»„å¯ä»¥è®¢é˜…å¤šä¸ª Topicï¼ŒåŒ…æ‹¬ç”Ÿäº§è€…ç»„ï¼ˆProducer Groupï¼‰å’Œæ¶ˆè´¹è€…ç»„ï¼ˆConsumer Groupï¼‰ã€‚ é˜Ÿåˆ—ï¼ˆQueueï¼‰ï¼šå¯ä»¥ç±»æ¯” Kafka çš„åˆ†åŒº Partitionã€‚ RocketMQ å·¥ä½œåŸç† RockerMQ ä¸­çš„æ¶ˆæ¯æ¨¡å‹å°±æ˜¯æŒ‰ç…§ä¸»é¢˜æ¨¡å‹æ‰€å®ç°çš„ï¼ŒåŒ…æ‹¬ Producer Groupã€Topicã€Consumer Group ä¸‰ä¸ªè§’è‰²ã€‚ ä¸ºäº†æé«˜å¹¶å‘èƒ½åŠ›ï¼Œä¸€ä¸ª Topic åŒ…å«å¤šä¸ª Queueï¼Œç”Ÿäº§è€…ç»„æ ¹æ®ä¸»é¢˜å°†æ¶ˆæ¯æ”¾å…¥å¯¹åº”çš„ Topicï¼Œä¸‹å›¾æ˜¯é‡‡ç”¨è½®è¯¢çš„æ–¹å¼æ‰¾åˆ°é‡Œé¢çš„ Queueã€‚ RockerMQ ä¸­çš„æ¶ˆè´¹ç¾¤ç»„å’Œ Queueï¼Œå¯ä»¥ç±»æ¯” Kafka ä¸­çš„æ¶ˆè´¹ç¾¤ç»„å’Œ Partitionï¼šä¸åŒçš„æ¶ˆè´¹è€…ç»„äº’ä¸å¹²æ‰°ï¼Œä¸€ä¸ª Queue åªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹å¤šä¸ª Queueã€‚ æ¶ˆè´¹ Queue çš„è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡åç§»é‡è®°å½•æ¶ˆè´¹çš„ä½ç½®ã€‚ RocketMQ æ¶æ„ RocketMQ æŠ€æœ¯æ¶æ„ä¸­æœ‰å››å¤§è§’è‰² NameServerã€Brokerã€Producer å’Œ Consumerï¼Œä¸‹é¢ä¸»è¦ä»‹ç» Brokerã€‚ Broker ç”¨äºå­˜æ”¾ Queueï¼Œä¸€ä¸ª Broker å¯ä»¥é…ç½®å¤šä¸ª Topicï¼Œä¸€ä¸ª Topic ä¸­å­˜åœ¨å¤šä¸ª Queueã€‚ å¦‚æœæŸä¸ª Topic æ¶ˆæ¯é‡å¾ˆå¤§ï¼Œåº”è¯¥ç»™å®ƒå¤šé…ç½®å‡ ä¸ª Queueï¼Œå¹¶ä¸”å°½é‡å¤šåˆ†å¸ƒåœ¨ä¸åŒ broker ä¸Šï¼Œä»¥å‡è½»æŸä¸ª broker çš„å‹åŠ›ã€‚Topic æ¶ˆæ¯é‡éƒ½æ¯”è¾ƒå‡åŒ€çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæŸä¸ª broker ä¸Šçš„é˜Ÿåˆ—è¶Šå¤šï¼Œåˆ™è¯¥ broker å‹åŠ›è¶Šå¤§ã€‚ ç®€å•æä¸€ä¸‹ï¼ŒBroker é€šè¿‡é›†ç¾¤éƒ¨ç½²ï¼Œå¹¶ä¸”æä¾›äº† master/slave çš„ç»“æ„ï¼Œslave å®šæ—¶ä» master åŒæ­¥æ•°æ®ï¼ˆåŒæ­¥åˆ·ç›˜æˆ–è€…å¼‚æ­¥åˆ·ç›˜ï¼‰ï¼Œå¦‚æœ master å®•æœºï¼Œåˆ™ slave æä¾›æ¶ˆè´¹æœåŠ¡ï¼Œä½†æ˜¯ä¸èƒ½å†™å…¥æ¶ˆæ¯ã€‚ çœ‹åˆ°è¿™é‡Œï¼Œå¤§å®¶åº”è¯¥å¯ä»¥å‘ç°ï¼ŒRocketMQ çš„è®¾è®¡å’Œ Kafka çœŸçš„å¾ˆåƒï¼ æ›´å¤šçŸ¥è¯†ï¼Œè¯¦è§ RabbitMQ RabbitMQ 2007 å¹´å‘å¸ƒï¼Œæ˜¯ä½¿ç”¨ Erlang è¯­è¨€å¼€å‘çš„å¼€æºæ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼ŒåŸºäº AMQP åè®®æ¥å®ç°ã€‚ AMQP çš„ä¸»è¦ç‰¹å¾æ˜¯é¢å‘æ¶ˆæ¯ã€é˜Ÿåˆ—ã€è·¯ç”±ã€å¯é æ€§ã€å®‰å…¨ã€‚AMQP åè®®æ›´å¤šç”¨åœ¨ä¼ä¸šç³»ç»Ÿå†…ï¼Œå¯¹æ•°æ®ä¸€è‡´æ€§ã€ç¨³å®šæ€§å’Œå¯é æ€§è¦æ±‚å¾ˆé«˜çš„åœºæ™¯ï¼Œå¯¹æ€§èƒ½å’Œååé‡çš„è¦æ±‚è¿˜åœ¨å…¶æ¬¡ã€‚ é‡è¦æ¦‚å¿µ ä¿¡é“ï¼ˆChannelï¼‰ï¼šæ¶ˆæ¯è¯»å†™ç­‰æ“ä½œåœ¨ä¿¡é“ä¸­è¿›è¡Œï¼Œå®¢æˆ·ç«¯å¯ä»¥å»ºç«‹å¤šä¸ªä¿¡é“ï¼Œæ¯ä¸ªä¿¡é“ä»£è¡¨ä¸€ä¸ªä¼šè¯ä»»åŠ¡ã€‚ äº¤æ¢å™¨ï¼ˆExchangeï¼‰ï¼šæ¥æ”¶æ¶ˆæ¯ï¼ŒæŒ‰ç…§è·¯ç”±è§„åˆ™å°†æ¶ˆæ¯è·¯ç”±åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªé˜Ÿåˆ—ï¼›å¦‚æœè·¯ç”±ä¸åˆ°ï¼Œæˆ–è€…è¿”å›ç»™ç”Ÿäº§è€…ï¼Œæˆ–è€…ç›´æ¥ä¸¢å¼ƒã€‚ è·¯ç”±é”®ï¼ˆRoutingKeyï¼‰ï¼šç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€ç»™äº¤æ¢å™¨çš„æ—¶å€™ï¼Œä¼šå‘é€ä¸€ä¸ª RoutingKeyï¼Œç”¨æ¥æŒ‡å®šè·¯ç”±è§„åˆ™ï¼Œè¿™æ ·äº¤æ¢å™¨å°±çŸ¥é“æŠŠæ¶ˆæ¯å‘é€åˆ°å“ªä¸ªé˜Ÿåˆ—ã€‚ ç»‘å®šï¼ˆBindingï¼‰ï¼šäº¤æ¢å™¨å’Œæ¶ˆæ¯é˜Ÿåˆ—ä¹‹é—´çš„è™šæ‹Ÿè¿æ¥ï¼Œç»‘å®šä¸­å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ª RoutingKeyã€‚ RabbitMQ å·¥ä½œåŸç† AMQP åè®®æ¨¡å‹ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šç”Ÿäº§è€…ã€æ¶ˆè´¹è€…å’ŒæœåŠ¡ç«¯ï¼Œæ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š ç”Ÿäº§è€…æ˜¯è¿æ¥åˆ° Serverï¼Œå»ºç«‹ä¸€ä¸ªè¿æ¥ï¼Œå¼€å¯ä¸€ä¸ªä¿¡é“ã€‚ ç”Ÿäº§è€…å£°æ˜äº¤æ¢å™¨å’Œé˜Ÿåˆ—ï¼Œè®¾ç½®ç›¸å…³å±æ€§ï¼Œå¹¶é€šè¿‡è·¯ç”±é”®å°†äº¤æ¢å™¨å’Œé˜Ÿåˆ—è¿›è¡Œç»‘å®šã€‚ æ¶ˆè´¹è€…ä¹Ÿéœ€è¦è¿›è¡Œå»ºç«‹è¿æ¥ï¼Œå¼€å¯ä¿¡é“ç­‰æ“ä½œï¼Œä¾¿äºæ¥æ”¶æ¶ˆæ¯ã€‚ ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ï¼Œå‘é€åˆ°æœåŠ¡ç«¯ä¸­çš„è™šæ‹Ÿä¸»æœºã€‚ è™šæ‹Ÿä¸»æœºä¸­çš„äº¤æ¢å™¨æ ¹æ®è·¯ç”±é”®é€‰æ‹©è·¯ç”±è§„åˆ™ï¼Œå‘é€åˆ°ä¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚ è®¢é˜…äº†æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹è€…å°±å¯ä»¥è·å–åˆ°æ¶ˆæ¯ï¼Œè¿›è¡Œæ¶ˆè´¹ã€‚ å¸¸ç”¨äº¤æ¢å™¨ RabbitMQ å¸¸ç”¨çš„äº¤æ¢å™¨ç±»å‹æœ‰ directã€topicã€fanoutã€headers å››ç§ å…·ä½“çš„ä½¿ç”¨æ–¹æ³•ï¼Œå¯ä»¥å‚è€ƒå®˜ç½‘ï¼š å®˜ç½‘å…¥å£ï¼šhttps://www.rabbitmq.com/getstarted.html æ›´å¤šçŸ¥è¯†ï¼Œè¯¦è§ æ¶ˆæ¯é˜Ÿåˆ—å¯¹æ¯”&amp;é€‰å‹ æ¶ˆæ¯é˜Ÿåˆ—å¯¹æ¯” Kafka ä¼˜ç‚¹ï¼š é«˜ååã€ä½å»¶è¿Ÿï¼šKafka æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯æ”¶å‘æ¶ˆæ¯éå¸¸å¿«ï¼ŒKafka æ¯ç§’å¯ä»¥å¤„ç†å‡ åä¸‡æ¡æ¶ˆæ¯ï¼Œå®ƒçš„æœ€ä½å»¶è¿Ÿåªæœ‰å‡ æ¯«ç§’ï¼› é«˜ä¼¸ç¼©æ€§ï¼šæ¯ä¸ªä¸»é¢˜ï¼ˆtopicï¼‰åŒ…å«å¤šä¸ªåˆ†åŒºï¼ˆpartitionï¼‰ï¼Œä¸»é¢˜ä¸­çš„åˆ†åŒºå¯ä»¥åˆ†å¸ƒåœ¨ä¸åŒçš„ä¸»æœºï¼ˆbrokerï¼‰ä¸­ï¼› é«˜ç¨³å®šæ€§ï¼šKafka æ˜¯åˆ†å¸ƒå¼çš„ï¼Œä¸€ä¸ªæ•°æ®å¤šä¸ªå‰¯æœ¬ï¼ŒæŸä¸ªèŠ‚ç‚¹å®•æœºï¼ŒKafka é›†ç¾¤èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼› æŒä¹…æ€§ã€å¯é æ€§ã€å¯å›æº¯ï¼šKafka èƒ½å¤Ÿå…è®¸æ•°æ®çš„æŒä¹…åŒ–å­˜å‚¨ï¼Œæ¶ˆæ¯è¢«æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œå¹¶æ”¯æŒæ•°æ®å¤‡ä»½é˜²æ­¢æ•°æ®ä¸¢å¤±ï¼Œæ”¯æŒæ¶ˆæ¯å›æº¯ï¼› æ¶ˆæ¯æœ‰åºï¼šé€šè¿‡æ§åˆ¶èƒ½å¤Ÿä¿è¯æ‰€æœ‰æ¶ˆæ¯è¢«æ¶ˆè´¹ä¸”ä»…è¢«æ¶ˆè´¹ä¸€æ¬¡ï¼› æœ‰ä¼˜ç§€çš„ç¬¬ä¸‰æ–¹ Kafka Web ç®¡ç†ç•Œé¢ Kafka-Managerï¼Œåœ¨æ—¥å¿—é¢†åŸŸæ¯”è¾ƒæˆç†Ÿï¼Œè¢«å¤šå®¶å…¬å¸å’Œå¤šä¸ªå¼€æºé¡¹ç›®ä½¿ç”¨ã€‚ ç¼ºç‚¹ï¼š Kafka å•æœºè¶…è¿‡ 64 ä¸ªé˜Ÿåˆ—/åˆ†åŒºï¼ŒLoad ä¼šå‘ç”Ÿæ˜æ˜¾çš„é£™é«˜ç°è±¡ï¼Œé˜Ÿåˆ—è¶Šå¤šï¼Œload è¶Šé«˜ï¼Œå‘é€æ¶ˆæ¯å“åº”æ—¶é—´å˜é•¿ï¼› ä¸æ”¯æŒæ¶ˆæ¯è·¯ç”±ï¼Œä¸æ”¯æŒå»¶è¿Ÿå‘é€ï¼Œä¸æ”¯æŒæ¶ˆæ¯é‡è¯•ï¼› ç¤¾åŒºæ›´æ–°è¾ƒæ…¢ã€‚ RocketMQ ä¼˜ç‚¹ï¼š é«˜ååï¼šå€Ÿé‰´ Kafka çš„è®¾è®¡ï¼Œå•ä¸€é˜Ÿåˆ—ç™¾ä¸‡æ¶ˆæ¯çš„å †ç§¯èƒ½åŠ›ï¼› é«˜ä¼¸ç¼©æ€§ï¼šçµæ´»çš„åˆ†å¸ƒå¼æ¨ªå‘æ‰©å±•éƒ¨ç½²æ¶æ„ï¼Œæ•´ä½“æ¶æ„å…¶å®å’Œ kafka å¾ˆåƒï¼› é«˜å®¹é”™æ€§ï¼šé€šè¿‡ACKæœºåˆ¶ï¼Œä¿è¯æ¶ˆæ¯ä¸€å®šèƒ½æ­£å¸¸æ¶ˆè´¹ï¼› æŒä¹…åŒ–ã€å¯å›æº¯ï¼šæ¶ˆæ¯å¯ä»¥æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ï¼Œæ”¯æŒæ¶ˆæ¯å›æº¯ï¼› æ¶ˆæ¯æœ‰åºï¼šåœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­å¯é çš„å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰å’Œä¸¥æ ¼çš„é¡ºåºä¼ é€’ï¼› æ”¯æŒå‘å¸ƒ/è®¢é˜…å’Œç‚¹å¯¹ç‚¹æ¶ˆæ¯æ¨¡å‹ï¼Œæ”¯æŒæ‹‰ã€æ¨ä¸¤ç§æ¶ˆæ¯æ¨¡å¼ï¼› æä¾› docker é•œåƒç”¨äºéš”ç¦»æµ‹è¯•å’Œäº‘é›†ç¾¤éƒ¨ç½²ï¼Œæä¾›é…ç½®ã€æŒ‡æ ‡å’Œç›‘æ§ç­‰åŠŸèƒ½ä¸°å¯Œçš„ Dashboardã€‚ ç¼ºç‚¹ï¼š ä¸æ”¯æŒæ¶ˆæ¯è·¯ç”±ï¼Œæ”¯æŒçš„å®¢æˆ·ç«¯è¯­è¨€ä¸å¤šï¼Œç›®å‰æ˜¯ java åŠ c++ï¼Œå…¶ä¸­ c++ ä¸æˆç†Ÿï¼› éƒ¨åˆ†æ”¯æŒæ¶ˆæ¯æœ‰åºï¼šéœ€è¦å°†åŒä¸€ç±»çš„æ¶ˆæ¯ hash åˆ°åŒä¸€ä¸ªé˜Ÿåˆ— Queue ä¸­ï¼Œæ‰èƒ½æ”¯æŒæ¶ˆæ¯çš„é¡ºåºï¼Œå¦‚æœåŒä¸€ç±»æ¶ˆæ¯æ•£è½åˆ°ä¸åŒçš„ Queueä¸­ï¼Œå°±ä¸èƒ½æ”¯æŒæ¶ˆæ¯çš„é¡ºåºã€‚ ç¤¾åŒºæ´»è·ƒåº¦ä¸€èˆ¬ã€‚ RabbitMQ ä¼˜ç‚¹ï¼š æ”¯æŒå‡ ä¹æ‰€æœ‰æœ€å—æ¬¢è¿çš„ç¼–ç¨‹è¯­è¨€ï¼šJavaï¼ŒCï¼ŒC ++ï¼ŒCï¼ƒï¼ŒRubyï¼ŒPerlï¼ŒPythonï¼ŒPHPç­‰ç­‰ï¼› æ”¯æŒæ¶ˆæ¯è·¯ç”±ï¼šRabbitMQ å¯ä»¥é€šè¿‡ä¸åŒçš„äº¤æ¢å™¨æ”¯æŒä¸åŒç§ç±»çš„æ¶ˆæ¯è·¯ç”±ï¼› æ¶ˆæ¯æ—¶åºï¼šé€šè¿‡å»¶æ—¶é˜Ÿåˆ—ï¼Œå¯ä»¥æŒ‡å®šæ¶ˆæ¯çš„å»¶æ—¶æ—¶é—´ï¼Œè¿‡æœŸæ—¶é—´TTLç­‰ï¼› æ”¯æŒå®¹é”™å¤„ç†ï¼šé€šè¿‡äº¤ä»˜é‡è¯•å’Œæ­»ä¿¡äº¤æ¢å™¨ï¼ˆDLXï¼‰æ¥å¤„ç†æ¶ˆæ¯å¤„ç†æ•…éšœï¼› æä¾›äº†ä¸€ä¸ªæ˜“ç”¨çš„ç”¨æˆ·ç•Œé¢ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥ç›‘æ§å’Œç®¡ç†æ¶ˆæ¯ Brokerï¼› ç¤¾åŒºæ´»è·ƒåº¦é«˜ã€‚ ç¼ºç‚¹ï¼š Erlang å¼€å‘ï¼Œå¾ˆéš¾å»çœ‹æ‡‚æºç ï¼Œä¸åˆ©äºåšäºŒæ¬¡å¼€å‘å’Œç»´æŠ¤ï¼ŒåŸºæœ¬åªèƒ½ä¾èµ–äºå¼€æºç¤¾åŒºçš„å¿«é€Ÿç»´æŠ¤å’Œä¿®å¤ bugï¼› RabbitMQ ååé‡ä¼šä½ä¸€äº›ï¼Œè¿™æ˜¯å› ä¸ºä»–åšçš„å®ç°æœºåˆ¶æ¯”è¾ƒé‡ï¼› ä¸æ”¯æŒæ¶ˆæ¯æœ‰åºã€æŒä¹…åŒ–ä¸å¥½ã€ä¸æ”¯æŒæ¶ˆæ¯å›æº¯ã€ä¼¸ç¼©æ€§ä¸€èˆ¬ã€‚ æ¶ˆæ¯é˜Ÿåˆ—é€‰å‹ Kafkaï¼šè¿½æ±‚é«˜ååé‡ï¼Œä¸€å¼€å§‹çš„ç›®çš„å°±æ˜¯ç”¨äºæ—¥å¿—æ”¶é›†å’Œä¼ è¾“ï¼Œé€‚åˆäº§ç”Ÿå¤§é‡æ•°æ®çš„äº’è”ç½‘æœåŠ¡çš„æ•°æ®æ”¶é›†ä¸šåŠ¡ï¼Œå¤§å‹å…¬å¸å»ºè®®å¯ä»¥é€‰ç”¨ï¼Œå¦‚æœæœ‰æ—¥å¿—é‡‡é›†åŠŸèƒ½ï¼Œè‚¯å®šæ˜¯é¦–é€‰ kafkaã€‚ RocketMQï¼šå¤©ç”Ÿä¸ºé‡‘èäº’è”ç½‘é¢†åŸŸè€Œç”Ÿï¼Œå¯¹äºå¯é æ€§è¦æ±‚å¾ˆé«˜çš„åœºæ™¯ï¼Œå°¤å…¶æ˜¯ç”µå•†é‡Œé¢çš„è®¢å•æ‰£æ¬¾ï¼Œä»¥åŠä¸šåŠ¡å‰Šå³°ï¼Œåœ¨å¤§é‡äº¤æ˜“æ¶Œå…¥æ—¶ï¼Œåç«¯å¯èƒ½æ— æ³•åŠæ—¶å¤„ç†çš„æƒ…å†µã€‚RocketMQ åœ¨ç¨³å®šæ€§ä¸Šå¯èƒ½æ›´å€¼å¾—ä¿¡èµ–ï¼Œè¿™äº›ä¸šåŠ¡åœºæ™¯åœ¨é˜¿é‡ŒåŒ 11 å·²ç»ç»å†äº†å¤šæ¬¡è€ƒéªŒï¼Œå¦‚æœä½ çš„ä¸šåŠ¡æœ‰ä¸Šè¿°å¹¶å‘åœºæ™¯ï¼Œå»ºè®®å¯ä»¥é€‰æ‹© RocketMQã€‚ RabbitMQï¼šç»“åˆ erlang è¯­è¨€æœ¬èº«çš„å¹¶å‘ä¼˜åŠ¿ï¼Œæ€§èƒ½è¾ƒå¥½ï¼Œç¤¾åŒºæ´»è·ƒåº¦ä¹Ÿæ¯”è¾ƒé«˜ï¼Œä½†æ˜¯ä¸åˆ©äºåšäºŒæ¬¡å¼€å‘å’Œç»´æŠ¤ï¼Œä¸è¿‡ RabbitMQ çš„ç¤¾åŒºååˆ†æ´»è·ƒï¼Œå¯ä»¥è§£å†³å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„ bugã€‚å¦‚æœä½ çš„æ•°æ®é‡æ²¡æœ‰é‚£ä¹ˆå¤§ï¼Œå°å…¬å¸ä¼˜å…ˆé€‰æ‹©åŠŸèƒ½æ¯”è¾ƒå®Œå¤‡çš„ RabbitMQã€‚ ActiveMQï¼šå®˜æ–¹ç¤¾åŒºç°åœ¨å¯¹ ActiveMQ 5.x ç»´æŠ¤è¶Šæ¥è¶Šå°‘ï¼Œè¾ƒå°‘åœ¨å¤§è§„æ¨¡ååçš„åœºæ™¯ä¸­ä½¿ç”¨ã€‚ ","link":"https://tianxiawuhao.github.io/DyzAzkEVU/"},{"title":"easyExcel","content":"è¯»Excel æ³¨è§£ ä½¿ç”¨æ³¨è§£å¾ˆç®€å•ï¼Œåªè¦åœ¨å¯¹åº”çš„å®ä½“ç±»ä¸Šé¢åŠ ä¸Šæ³¨è§£å³å¯ã€‚ ExcelProperty ç”¨äºåŒ¹é…excelå’Œå®ä½“ç±»çš„åŒ¹é…,å‚æ•°å¦‚ä¸‹ï¼š åç§° é»˜è®¤å€¼ æè¿° value ç©º ç”¨äºåŒ¹é…excelä¸­çš„å¤´ï¼Œå¿…é¡»å…¨åŒ¹é…,å¦‚æœæœ‰å¤šè¡Œå¤´ï¼Œä¼šåŒ¹é…æœ€åä¸€è¡Œå¤´ order Integer.MAX_VALUE ä¼˜å…ˆçº§é«˜äºvalueï¼Œä¼šæ ¹æ®orderçš„é¡ºåºæ¥åŒ¹é…å®ä½“å’Œexcelä¸­æ•°æ®çš„é¡ºåº index -1 ä¼˜å…ˆçº§é«˜äºvalueå’Œorderï¼Œä¼šæ ¹æ®indexç›´æ¥æŒ‡å®šåˆ°excelä¸­å…·ä½“çš„å“ªä¸€åˆ— converter è‡ªåŠ¨é€‰æ‹© æŒ‡å®šå½“å‰å­—æ®µç”¨ä»€ä¹ˆè½¬æ¢å™¨ï¼Œé»˜è®¤ä¼šè‡ªåŠ¨é€‰æ‹©ã€‚è¯»çš„æƒ…å†µä¸‹åªè¦å®ç°com.alibaba.excel.converters.Converter#convertToJavaData(com.alibaba.excel.converters.ReadConverterContext&lt;?&gt;) æ–¹æ³•å³å¯ ExcelIgnore é»˜è®¤æ‰€æœ‰å­—æ®µéƒ½ä¼šå’Œexcelå»åŒ¹é…ï¼ŒåŠ äº†è¿™ä¸ªæ³¨è§£ä¼šå¿½ç•¥è¯¥å­—æ®µ ExcelIgnoreUnannotated é»˜è®¤ä¸åŠ ExcelProperty çš„æ³¨è§£çš„éƒ½ä¼šå‚ä¸è¯»å†™ï¼ŒåŠ äº†ä¸ä¼šå‚ä¸ DateTimeFormat æ—¥æœŸè½¬æ¢ï¼Œç”¨Stringå»æ¥æ”¶excelæ—¥æœŸæ ¼å¼çš„æ•°æ®ä¼šè°ƒç”¨è¿™ä¸ªæ³¨è§£,å‚æ•°å¦‚ä¸‹ï¼š åç§° é»˜è®¤å€¼ æè¿° value ç©º å‚ç…§java.text.SimpleDateFormatä¹¦å†™å³å¯ use1904windowing è‡ªåŠ¨é€‰æ‹© excelä¸­æ—¶é—´æ˜¯å­˜å‚¨1900å¹´èµ·çš„ä¸€ä¸ªåŒç²¾åº¦æµ®ç‚¹æ•°ï¼Œä½†æ˜¯æœ‰æ—¶å€™é»˜è®¤å¼€å§‹æ—¥æœŸæ˜¯1904ï¼Œæ‰€ä»¥è®¾ç½®è¿™ä¸ªå€¼æ”¹æˆé»˜è®¤1904å¹´å¼€å§‹ NumberFormat æ•°å­—è½¬æ¢ï¼Œç”¨Stringå»æ¥æ”¶excelæ•°å­—æ ¼å¼çš„æ•°æ®ä¼šè°ƒç”¨è¿™ä¸ªæ³¨è§£ã€‚ åç§° é»˜è®¤å€¼ æè¿° value ç©º å‚ç…§java.text.DecimalFormatä¹¦å†™å³å¯ roundingMode RoundingMode.HALF_UP æ ¼å¼åŒ–çš„æ—¶å€™è®¾ç½®èˆå…¥æ¨¡å¼ å‚æ•° æ¦‚å¿µä»‹ç» ReadWorkbook å¯ä»¥ç†è§£æˆä¸€ä¸ªexcel ReadSheet ç†è§£æˆä¸€ä¸ªexcelé‡Œé¢çš„ä¸€ä¸ªè¡¨å• é€šç”¨å‚æ•° ReadWorkbook,ReadSheet éƒ½ä¼šæœ‰çš„å‚æ•°ï¼Œå¦‚æœä¸ºç©ºï¼Œé»˜è®¤ä½¿ç”¨ä¸Šçº§ã€‚ åç§° é»˜è®¤å€¼ æè¿° converter ç©º é»˜è®¤åŠ è½½äº†å¾ˆå¤šè½¬æ¢å™¨ï¼Œè¿™é‡Œå¯ä»¥åŠ å…¥ä¸æ”¯æŒçš„å­—æ®µ readListener ç©º å¯ä»¥æ³¨å†Œå¤šä¸ªç›‘å¬å™¨ï¼Œè¯»å–excelçš„æ—¶å€™ä¼šä¸æ–­çš„å›è°ƒç›‘å¬å™¨ä¸­çš„æ–¹æ³• headRowNumber 1 excelä¸­å¤´çš„è¡Œæ•°ï¼Œé»˜è®¤1è¡Œ head ç©º ä¸clazzäºŒé€‰ä¸€ã€‚è¯»å–æ–‡ä»¶å¤´å¯¹åº”çš„åˆ—è¡¨ï¼Œä¼šæ ¹æ®åˆ—è¡¨åŒ¹é…æ•°æ®ï¼Œå»ºè®®ä½¿ç”¨class clazz ç©º ä¸headäºŒé€‰ä¸€ã€‚è¯»å–æ–‡ä»¶çš„å¤´å¯¹åº”çš„classï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ³¨è§£ã€‚å¦‚æœä¸¤ä¸ªéƒ½ä¸æŒ‡å®šï¼Œåˆ™ä¼šè¯»å–å…¨éƒ¨æ•°æ® autoTrim true ä¼šå¯¹å¤´ã€è¯»å–æ•°æ®ç­‰è¿›è¡Œè‡ªåŠ¨trim use1904windowing false excelä¸­æ—¶é—´æ˜¯å­˜å‚¨1900å¹´èµ·çš„ä¸€ä¸ªåŒç²¾åº¦æµ®ç‚¹æ•°ï¼Œä½†æ˜¯æœ‰æ—¶å€™é»˜è®¤å¼€å§‹æ—¥æœŸæ˜¯1904ï¼Œæ‰€ä»¥è®¾ç½®è¿™ä¸ªå€¼æ”¹æˆé»˜è®¤1904å¹´å¼€å§‹ useScientificFormat false æ•°å­—è½¬æ–‡æœ¬çš„æ—¶å€™åœ¨è¾ƒå¤§çš„æ•°å€¼çš„æ˜¯å¦æ˜¯å¦é‡‡ç”¨ç§‘å­¦è®¡æ•°æ³• ReadWorkbook è®¾ç½®æ–¹æ³•å¦‚ä¸‹ï¼Œæ‰¾ä¸åˆ°å‚æ•°çš„çœ‹ä¸‹é€šç”¨å‚æ•°é‡Œé¢æ˜¯å¦å­˜åœ¨ã€‚ EasyExcel.read(fileName, DemoData.class, new DemoDataListener()) // åœ¨ read æ–¹æ³•ä¹‹åï¼Œ åœ¨ sheetæ–¹æ³•ä¹‹å‰éƒ½æ˜¯è®¾ç½®ReadWorkbookçš„å‚æ•° .sheet() .doRead(); åç§° é»˜è®¤å€¼ æè¿° excelType ç©º å½“å‰excelçš„ç±»å‹,æ”¯æŒXLSã€XLSXã€CSV inputStream ç©º ä¸fileäºŒé€‰ä¸€ã€‚è¯»å–æ–‡ä»¶çš„æµï¼Œå¦‚æœæ¥æ”¶åˆ°çš„æ˜¯æµå°±åªç”¨ï¼Œä¸ç”¨æµå»ºè®®ä½¿ç”¨fileå‚æ•°ã€‚å› ä¸ºä½¿ç”¨äº†inputStream easyexcelä¼šå¸®å¿™åˆ›å»ºä¸´æ—¶æ–‡ä»¶ï¼Œæœ€ç»ˆè¿˜æ˜¯file file ç©º ä¸inputStreamäºŒé€‰ä¸€ã€‚è¯»å–æ–‡ä»¶çš„æ–‡ä»¶ã€‚ mandatoryUseInputStream false å¼ºåˆ¶ä½¿ç”¨ inputStream æ¥åˆ›å»ºå¯¹è±¡ï¼Œæ€§èƒ½ä¼šå˜å·®ï¼Œä½†æ˜¯ä¸ä¼šåˆ›å»ºä¸´æ–‡ä»¶ã€‚ charset Charset#defaultCharset åªæœ‰csvæ–‡ä»¶æœ‰ç”¨ï¼Œè¯»å–æ–‡ä»¶çš„æ—¶å€™ä½¿ç”¨çš„ç¼–ç  autoCloseStream true è‡ªåŠ¨å…³é—­è¯»å–çš„æµã€‚ readCache ç©º é»˜è®¤å°äº5Mç”¨ å†…å­˜ï¼Œè¶…è¿‡5Mä¼šä½¿ç”¨ EhCache,è¿™é‡Œä¸å»ºè®®ä½¿ç”¨è¿™ä¸ªå‚æ•°ã€‚ readCacheSelector SimpleReadCacheSelector ç”¨äºé€‰æ‹©ä»€ä¹ˆæ—¶å€™ç”¨å†…å­˜å»å­˜å‚¨ä¸´æ—¶æ•°æ®ï¼Œä»€ä¹ˆæ—¶å€™ç”¨ç£ç›˜å­˜å‚¨ä¸´æ—¶æ•°æ® ignoreEmptyRow true å¿½ç•¥ç©ºçš„è¡Œ password ç©º è¯»å–æ–‡ä»¶çš„å¯†ç  xlsxSAXParserFactoryName ç©º æŒ‡å®šsaxè¯»å–ä½¿ç”¨çš„classçš„åç§°ï¼Œä¾‹å¦‚ï¼šcom.sun.org.apache.xerces.internal.jaxp.SAXParserFactoryImpl useDefaultListener true @since 2.1.4 é»˜è®¤ä¼šåŠ å…¥ModelBuildEventListener æ¥å¸®å¿™è½¬æ¢æˆä¼ å…¥classçš„å¯¹è±¡ï¼Œè®¾ç½®æˆfalseåå°†ä¸ä¼šååŠ©è½¬æ¢å¯¹è±¡ï¼Œè‡ªå®šä¹‰çš„ç›‘å¬å™¨ä¼šæ¥æ”¶åˆ°Map&lt;Integer,CellData&gt;å¯¹è±¡ï¼Œå¦‚æœè¿˜æƒ³ç»§ç»­æ¥å¬åˆ°classå¯¹è±¡ï¼Œè¯·è°ƒç”¨readListeneræ–¹æ³•ï¼ŒåŠ å…¥è‡ªå®šä¹‰çš„beforeListenerã€ ModelBuildEventListenerã€ è‡ªå®šä¹‰çš„afterListenerå³å¯ã€‚ extraReadSet ç©º é¢å¤–éœ€è¦è¯»å–å†…å®¹çš„setï¼Œé»˜è®¤ä¸è¯»å–è¿™äº›æ•°æ® ReadSheet è®¾ç½®æ–¹æ³•å¦‚ä¸‹ï¼Œæ‰¾ä¸åˆ°å‚æ•°çš„çœ‹ä¸‹é€šç”¨å‚æ•°é‡Œé¢æ˜¯å¦å­˜åœ¨ã€‚ EasyExcel.read(fileName, DemoData.class, new DemoDataListener()) .sheet() // åœ¨ sheet æ–¹æ³•ä¹‹åï¼Œ åœ¨ doReadæ–¹æ³•ä¹‹å‰éƒ½æ˜¯è®¾ç½®ReadSheetçš„å‚æ•° .doRead(); åç§° é»˜è®¤å€¼ æè¿° sheetNo 0 éœ€è¦è¯»å–Sheetçš„ç¼–ç ï¼Œå»ºè®®ä½¿ç”¨è¿™ä¸ªæ¥æŒ‡å®šè¯»å–å“ªä¸ªSheet sheetName ç©º æ ¹æ®åå­—å»åŒ¹é…Sheet å†™Excel æ³¨è§£ ä½¿ç”¨æ³¨è§£å¾ˆç®€å•ï¼Œåªè¦åœ¨å¯¹åº”çš„å®ä½“ç±»ä¸Šé¢åŠ ä¸Šæ³¨è§£å³å¯ã€‚ ExcelProperty ç”¨äºåŒ¹é…excelå’Œå®ä½“ç±»çš„åŒ¹é…,å‚æ•°å¦‚ä¸‹ï¼š åç§° é»˜è®¤å€¼ æè¿° value ç©º ç”¨äºåŒ¹é…excelä¸­çš„å¤´ï¼Œå¿…é¡»å…¨åŒ¹é…,å¦‚æœæœ‰å¤šè¡Œå¤´ï¼Œä¼šåŒ¹é…æœ€åä¸€è¡Œå¤´ order Integer.MAX_VALUE ä¼˜å…ˆçº§é«˜äºvalueï¼Œä¼šæ ¹æ®orderçš„é¡ºåºæ¥åŒ¹é…å®ä½“å’Œexcelä¸­æ•°æ®çš„é¡ºåº index -1 ä¼˜å…ˆçº§é«˜äºvalueå’Œorderï¼Œä¼šæ ¹æ®indexç›´æ¥æŒ‡å®šåˆ°excelä¸­å…·ä½“çš„å“ªä¸€åˆ— converter è‡ªåŠ¨é€‰æ‹© æŒ‡å®šå½“å‰å­—æ®µç”¨ä»€ä¹ˆè½¬æ¢å™¨ï¼Œé»˜è®¤ä¼šè‡ªåŠ¨é€‰æ‹©ã€‚å†™çš„æƒ…å†µä¸‹åªè¦å®ç°com.alibaba.excel.converters.Converter#convertToExcelData(com.alibaba.excel.converters.WriteConverterContext&lt;T&gt;) æ–¹æ³•å³å¯ ExcelIgnore é»˜è®¤æ‰€æœ‰å­—æ®µéƒ½ä¼šå’Œexcelå»åŒ¹é…ï¼ŒåŠ äº†è¿™ä¸ªæ³¨è§£ä¼šå¿½ç•¥è¯¥å­—æ®µ ExcelIgnoreUnannotated é»˜è®¤ä¸åŠ ExcelProperty çš„æ³¨è§£çš„éƒ½ä¼šå‚ä¸è¯»å†™ï¼ŒåŠ äº†ä¸ä¼šå‚ä¸ DateTimeFormat æ—¥æœŸè½¬æ¢ï¼Œç”¨Stringå»æ¥æ”¶excelæ—¥æœŸæ ¼å¼çš„æ•°æ®ä¼šè°ƒç”¨è¿™ä¸ªæ³¨è§£,å‚æ•°å¦‚ä¸‹ï¼š åç§° é»˜è®¤å€¼ æè¿° value ç©º å‚ç…§java.text.SimpleDateFormatä¹¦å†™å³å¯ use1904windowing è‡ªåŠ¨é€‰æ‹© excelä¸­æ—¶é—´æ˜¯å­˜å‚¨1900å¹´èµ·çš„ä¸€ä¸ªåŒç²¾åº¦æµ®ç‚¹æ•°ï¼Œä½†æ˜¯æœ‰æ—¶å€™é»˜è®¤å¼€å§‹æ—¥æœŸæ˜¯1904ï¼Œæ‰€ä»¥è®¾ç½®è¿™ä¸ªå€¼æ”¹æˆé»˜è®¤1904å¹´å¼€å§‹ NumberFormat æ•°å­—è½¬æ¢ï¼Œç”¨Stringå»æ¥æ”¶excelæ•°å­—æ ¼å¼çš„æ•°æ®ä¼šè°ƒç”¨è¿™ä¸ªæ³¨è§£ã€‚ åç§° é»˜è®¤å€¼ æè¿° value ç©º å‚ç…§java.text.DecimalFormatä¹¦å†™å³å¯ roundingMode RoundingMode.HALF_UP æ ¼å¼åŒ–çš„æ—¶å€™è®¾ç½®èˆå…¥æ¨¡å¼ å‚æ•° æ¦‚å¿µä»‹ç» WriteWorkbook å¯ä»¥ç†è§£æˆä¸€ä¸ªexcel WriteSheet ç†è§£æˆä¸€ä¸ªexcelé‡Œé¢çš„ä¸€ä¸ªè¡¨å• WriteTable ä¸€ä¸ªè¡¨å•é‡Œé¢å¦‚æœæœ‰å¤šä¸ªå®é™…ç”¨çš„è¡¨æ ¼ï¼Œåˆ™å¯ä»¥ç”¨WriteTable é€šç”¨å‚æ•° WriteWorkbook,WriteSheet ,WriteTableéƒ½ä¼šæœ‰çš„å‚æ•°ï¼Œå¦‚æœä¸ºç©ºï¼Œé»˜è®¤ä½¿ç”¨ä¸Šçº§ã€‚ åç§° é»˜è®¤å€¼ æè¿° converter ç©º é»˜è®¤åŠ è½½äº†å¾ˆå¤šè½¬æ¢å™¨ï¼Œè¿™é‡Œå¯ä»¥åŠ å…¥ä¸æ”¯æŒçš„å­—æ®µ writeHandler ç©º å†™çš„å¤„ç†å™¨ã€‚å¯ä»¥å®ç°WorkbookWriteHandler,SheetWriteHandler,RowWriteHandler,CellWriteHandlerï¼Œåœ¨å†™å…¥excelçš„ä¸åŒé˜¶æ®µä¼šè°ƒç”¨ relativeHeadRowIndex 0 å†™å…¥åˆ°excelå’Œä¸Šé¢ç©ºå¼€å‡ è¡Œ head ç©º ä¸clazzäºŒé€‰ä¸€ã€‚è¯»å–æ–‡ä»¶å¤´å¯¹åº”çš„åˆ—è¡¨ï¼Œä¼šæ ¹æ®åˆ—è¡¨åŒ¹é…æ•°æ®ï¼Œå»ºè®®ä½¿ç”¨class clazz ç©º ä¸headäºŒé€‰ä¸€ã€‚è¯»å–æ–‡ä»¶çš„å¤´å¯¹åº”çš„classï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ³¨è§£ã€‚å¦‚æœä¸¤ä¸ªéƒ½ä¸æŒ‡å®šï¼Œåˆ™ä¼šè¯»å–å…¨éƒ¨æ•°æ® autoTrim true ä¼šå¯¹å¤´ã€è¯»å–æ•°æ®ç­‰è¿›è¡Œè‡ªåŠ¨trim use1904windowing false excelä¸­æ—¶é—´æ˜¯å­˜å‚¨1900å¹´èµ·çš„ä¸€ä¸ªåŒç²¾åº¦æµ®ç‚¹æ•°ï¼Œä½†æ˜¯æœ‰æ—¶å€™é»˜è®¤å¼€å§‹æ—¥æœŸæ˜¯1904ï¼Œæ‰€ä»¥è®¾ç½®è¿™ä¸ªå€¼æ”¹æˆé»˜è®¤1904å¹´å¼€å§‹ useScientificFormat false æ•°å­—è½¬æ–‡æœ¬çš„æ—¶å€™åœ¨è¾ƒå¤§çš„æ•°å€¼çš„æ˜¯å¦æ˜¯å¦é‡‡ç”¨ç§‘å­¦è®¡æ•°æ³• needHead true æ˜¯å¦éœ€è¦å†™å…¥å¤´åˆ°excel useDefaultStyle true æ˜¯å¦ä½¿ç”¨é»˜è®¤çš„æ ·å¼ automaticMergeHead true è‡ªåŠ¨åˆå¹¶å¤´ï¼Œå¤´ä¸­ç›¸åŒçš„å­—æ®µä¸Šä¸‹å·¦å³éƒ½ä¼šå»å°è¯•åŒ¹é… excludeColumnIndexes ç©º éœ€è¦æ’é™¤å¯¹è±¡ä¸­çš„indexçš„æ•°æ® excludeColumnFieldNames ç©º éœ€è¦æ’é™¤å¯¹è±¡ä¸­çš„å­—æ®µçš„æ•°æ® includeColumnIndexes ç©º åªè¦å¯¼å‡ºå¯¹è±¡ä¸­çš„indexçš„æ•°æ® includeColumnFieldNames ç©º åªè¦å¯¼å‡ºå¯¹è±¡ä¸­çš„å­—æ®µçš„æ•°æ® WriteWorkbook è®¾ç½®æ–¹æ³•å¦‚ä¸‹ï¼Œæ‰¾ä¸åˆ°å‚æ•°çš„çœ‹ä¸‹é€šç”¨å‚æ•°é‡Œé¢æ˜¯å¦å­˜åœ¨ã€‚ EasyExcel.write(fileName, DemoData.class) // åœ¨ write æ–¹æ³•ä¹‹åï¼Œ åœ¨ sheetæ–¹æ³•ä¹‹å‰éƒ½æ˜¯è®¾ç½®WriteWorkbookçš„å‚æ•° .sheet(&quot;æ¨¡æ¿&quot;) .doWrite(() -&gt; { // åˆ†é¡µæŸ¥è¯¢æ•°æ® return data(); }); åç§° é»˜è®¤å€¼ æè¿° excelType ç©º å½“å‰excelçš„ç±»å‹,æ”¯æŒXLSã€XLSXã€CSV outputStream ç©º ä¸fileäºŒé€‰ä¸€ã€‚å†™å…¥æ–‡ä»¶çš„æµ file ç©º ä¸outputStreamäºŒé€‰ä¸€ã€‚å†™å…¥çš„æ–‡ä»¶ templateInputStream ç©º æ¨¡æ¿çš„æ–‡ä»¶æµ templateFile ç©º æ¨¡æ¿æ–‡ä»¶ charset Charset#defaultCharset åªæœ‰csvæ–‡ä»¶æœ‰ç”¨ï¼Œå†™å…¥æ–‡ä»¶çš„æ—¶å€™ä½¿ç”¨çš„ç¼–ç  autoCloseStream true è‡ªåŠ¨å…³é—­å†™å…¥çš„æµã€‚ password ç©º è¯»å–æ–‡ä»¶çš„å¯†ç  inMemory false æ˜¯å¦åœ¨å†…å­˜å¤„ç†ï¼Œé»˜è®¤ä¼šç”Ÿæˆä¸´æ—¶æ–‡ä»¶ä»¥èŠ‚çº¦å†…å­˜ã€‚å†…å­˜æ¨¡å¼æ•ˆç‡ä¼šæ›´å¥½ï¼Œä½†æ˜¯å®¹æ˜“OOM writeExcelOnException false å†™å…¥è¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸äº†ï¼Œæ˜¯å¦å°è¯•æŠŠæ•°æ®å†™å…¥åˆ°excel WriteSheet è®¾ç½®æ–¹æ³•å¦‚ä¸‹ï¼Œæ‰¾ä¸åˆ°å‚æ•°çš„çœ‹ä¸‹é€šç”¨å‚æ•°é‡Œé¢æ˜¯å¦å­˜åœ¨ã€‚ EasyExcel.write(fileName, DemoData.class) .sheet(&quot;æ¨¡æ¿&quot;) // åœ¨ sheet æ–¹æ³•ä¹‹åï¼Œ åœ¨ doWriteæ–¹æ³•ä¹‹å‰éƒ½æ˜¯è®¾ç½®WriteSheetçš„å‚æ•° .doWrite(() -&gt; { // åˆ†é¡µæŸ¥è¯¢æ•°æ® return data(); }); åç§° é»˜è®¤å€¼ æè¿° sheetNo 0 éœ€è¦å†™å…¥çš„ç¼–ç  sheetName ç©º éœ€è¦äº›çš„Sheetåç§°ï¼Œé»˜è®¤åŒsheetNo WriteTable è®¾ç½®æ–¹æ³•å¦‚ä¸‹ï¼Œæ‰¾ä¸åˆ°å‚æ•°çš„çœ‹ä¸‹é€šç”¨å‚æ•°é‡Œé¢æ˜¯å¦å­˜åœ¨ã€‚ EasyExcel.write(fileName, DemoData.class) .sheet(&quot;æ¨¡æ¿&quot;) .table() // åœ¨ table æ–¹æ³•ä¹‹åï¼Œ åœ¨ doWriteæ–¹æ³•ä¹‹å‰éƒ½æ˜¯è®¾ç½®WriteTableçš„å‚æ•° .doWrite(() -&gt; { // åˆ†é¡µæŸ¥è¯¢æ•°æ® return data(); }); åç§° é»˜è®¤å€¼ æè¿° tableNo 0 éœ€è¦å†™å…¥çš„ç¼–ç  &lt;dependency&gt; &lt;groupId&gt;com.alibaba&lt;/groupId&gt; &lt;artifactId&gt;easyexcel&lt;/artifactId&gt; &lt;version&gt;3.1.1&lt;/version&gt; &lt;/dependency&gt; WebTest import java.io.IOException; import java.net.URLEncoder; import java.util.Date; import java.util.List; import java.util.Map; import javax.servlet.http.HttpServletResponse; import com.alibaba.excel.EasyExcel; import com.alibaba.excel.util.ListUtils; import com.alibaba.excel.util.MapUtils; import com.alibaba.fastjson.JSON; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.stereotype.Controller; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.PostMapping; import org.springframework.web.bind.annotation.ResponseBody; import org.springframework.web.multipart.MultipartFile; /** * webè¯»å†™æ¡ˆä¾‹ * **/ @Controller public class WebTest { @Autowired private UploadDAO uploadDAO; /** * æ–‡ä»¶ä¸‹è½½ï¼ˆå¤±è´¥äº†ä¼šè¿”å›ä¸€ä¸ªæœ‰éƒ¨åˆ†æ•°æ®çš„Excelï¼‰ * &lt;p&gt; * 1. åˆ›å»ºexcelå¯¹åº”çš„å®ä½“å¯¹è±¡ å‚ç…§{@link DownloadData} * &lt;p&gt; * 2. è®¾ç½®è¿”å›çš„ å‚æ•° * &lt;p&gt; * 3. ç›´æ¥å†™ï¼Œè¿™é‡Œæ³¨æ„ï¼Œfinishçš„æ—¶å€™ä¼šè‡ªåŠ¨å…³é—­OutputStream,å½“ç„¶ä½ å¤–é¢å†å…³é—­æµé—®é¢˜ä¸å¤§ */ @GetMapping(&quot;download&quot;) public void download(HttpServletResponse response) throws IOException { // è¿™é‡Œæ³¨æ„ æœ‰åŒå­¦ååº”ä½¿ç”¨swagger ä¼šå¯¼è‡´å„ç§é—®é¢˜ï¼Œè¯·ç›´æ¥ç”¨æµè§ˆå™¨æˆ–è€…ç”¨postman response.setContentType(&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;); response.setCharacterEncoding(&quot;utf-8&quot;); // è¿™é‡ŒURLEncoder.encodeå¯ä»¥é˜²æ­¢ä¸­æ–‡ä¹±ç  å½“ç„¶å’Œeasyexcelæ²¡æœ‰å…³ç³» String fileName = URLEncoder.encode(&quot;æµ‹è¯•&quot;, &quot;UTF-8&quot;).replaceAll(&quot;\\\\+&quot;, &quot;%20&quot;); response.setHeader(&quot;Content-disposition&quot;, &quot;attachment;filename*=utf-8''&quot; + fileName + &quot;.xlsx&quot;); EasyExcel.write(response.getOutputStream(), DownloadData.class).sheet(&quot;æ¨¡æ¿&quot;).doWrite(data()); } /** * æ–‡ä»¶ä¸‹è½½å¹¶ä¸”å¤±è´¥çš„æ—¶å€™è¿”å›jsonï¼ˆé»˜è®¤å¤±è´¥äº†ä¼šè¿”å›ä¸€ä¸ªæœ‰éƒ¨åˆ†æ•°æ®çš„Excelï¼‰ * * @since 2.1.1 */ @GetMapping(&quot;downloadFailedUsingJson&quot;) public void downloadFailedUsingJson(HttpServletResponse response) throws IOException { // è¿™é‡Œæ³¨æ„ æœ‰åŒå­¦ååº”ä½¿ç”¨swagger ä¼šå¯¼è‡´å„ç§é—®é¢˜ï¼Œè¯·ç›´æ¥ç”¨æµè§ˆå™¨æˆ–è€…ç”¨postman try { response.setContentType(&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;); response.setCharacterEncoding(&quot;utf-8&quot;); // è¿™é‡ŒURLEncoder.encodeå¯ä»¥é˜²æ­¢ä¸­æ–‡ä¹±ç  å½“ç„¶å’Œeasyexcelæ²¡æœ‰å…³ç³» String fileName = URLEncoder.encode(&quot;æµ‹è¯•&quot;, &quot;UTF-8&quot;).replaceAll(&quot;\\\\+&quot;, &quot;%20&quot;); response.setHeader(&quot;Content-disposition&quot;, &quot;attachment;filename*=utf-8''&quot; + fileName + &quot;.xlsx&quot;); // è¿™é‡Œéœ€è¦è®¾ç½®ä¸å…³é—­æµ EasyExcel.write(response.getOutputStream(), DownloadData.class).autoCloseStream(Boolean.FALSE).sheet(&quot;æ¨¡æ¿&quot;) .doWrite(data()); } catch (Exception e) { // é‡ç½®response response.reset(); response.setContentType(&quot;application/json&quot;); response.setCharacterEncoding(&quot;utf-8&quot;); Map&lt;String, String&gt; map = MapUtils.newHashMap(); map.put(&quot;status&quot;, &quot;failure&quot;); map.put(&quot;message&quot;, &quot;ä¸‹è½½æ–‡ä»¶å¤±è´¥&quot; + e.getMessage()); response.getWriter().println(JSON.toJSONString(map)); } } /** * æ–‡ä»¶ä¸Šä¼  * &lt;p&gt; * 1. åˆ›å»ºexcelå¯¹åº”çš„å®ä½“å¯¹è±¡ å‚ç…§{@link UploadData} * &lt;p&gt; * 2. ç”±äºé»˜è®¤ä¸€è¡Œè¡Œçš„è¯»å–excelï¼Œæ‰€ä»¥éœ€è¦åˆ›å»ºexcelä¸€è¡Œä¸€è¡Œçš„å›è°ƒç›‘å¬å™¨ï¼Œå‚ç…§{@link UploadDataListener} * &lt;p&gt; * 3. ç›´æ¥è¯»å³å¯ */ @PostMapping(&quot;upload&quot;) @ResponseBody public String upload(MultipartFile file) throws IOException { EasyExcel.read(file.getInputStream(), UploadData.class, new UploadDataListener(uploadDAO)).sheet().doRead(); return &quot;success&quot;; } private List&lt;DownloadData&gt; data() { List&lt;DownloadData&gt; list = ListUtils.newArrayList(); for (int i = 0; i &lt; 10; i++) { DownloadData data = new DownloadData(); data.setString(&quot;å­—ç¬¦ä¸²&quot; + 0); data.setDate(new Date()); data.setDoubleData(0.56); list.add(data); } return list; } } DownloadData import java.util.Date; import com.alibaba.excel.annotation.ExcelProperty; import lombok.EqualsAndHashCode; import lombok.Getter; import lombok.Setter; /** * åŸºç¡€æ•°æ®ç±» * **/ @Getter @Setter @EqualsAndHashCode public class DownloadData { @ExcelProperty(&quot;å­—ç¬¦ä¸²æ ‡é¢˜&quot;) private String string; @ExcelProperty(&quot;æ—¥æœŸæ ‡é¢˜&quot;) private Date date; @ExcelProperty(&quot;æ•°å­—æ ‡é¢˜&quot;) private Double doubleData; } UploadDAO import java.util.List; import org.springframework.stereotype.Repository; /** * å‡è®¾è¿™ä¸ªæ˜¯ä½ çš„DAOå­˜å‚¨ã€‚å½“ç„¶è¿˜è¦è¿™ä¸ªç±»è®©springç®¡ç†ï¼Œå½“ç„¶ä½ ä¸ç”¨éœ€è¦å­˜å‚¨ï¼Œä¹Ÿä¸éœ€è¦è¿™ä¸ªç±»ã€‚ * **/ @Repository public class UploadDAO { public void save(List&lt;UploadData&gt; list) { // å¦‚æœæ˜¯mybatis,å°½é‡åˆ«ç›´æ¥è°ƒç”¨å¤šæ¬¡insert,è‡ªå·±å†™ä¸€ä¸ªmapperé‡Œé¢æ–°å¢ä¸€ä¸ªæ–¹æ³•batchInsert,æ‰€æœ‰æ•°æ®ä¸€æ¬¡æ€§æ’å…¥ } } UploadData import java.util.Date; import lombok.EqualsAndHashCode; import lombok.Getter; import lombok.Setter; /** * åŸºç¡€æ•°æ®ç±» * **/ @Getter @Setter @EqualsAndHashCode public class UploadData { private String string; private Date date; private Double doubleData; } UploadDataListener import java.util.List; import com.alibaba.excel.context.AnalysisContext; import com.alibaba.excel.read.listener.ReadListener; import com.alibaba.excel.util.ListUtils; import com.alibaba.fastjson.JSON; import lombok.extern.slf4j.Slf4j; /** * æ¨¡æ¿çš„è¯»å–ç±» * */ // æœ‰ä¸ªå¾ˆé‡è¦çš„ç‚¹ DemoDataListener ä¸èƒ½è¢«springç®¡ç†ï¼Œè¦æ¯æ¬¡è¯»å–exceléƒ½è¦new,ç„¶åé‡Œé¢ç”¨åˆ°springå¯ä»¥æ„é€ æ–¹æ³•ä¼ è¿›å» @Slf4j public class UploadDataListener implements ReadListener&lt;UploadData&gt; { /** * æ¯éš”5æ¡å­˜å‚¨æ•°æ®åº“ï¼Œå®é™…ä½¿ç”¨ä¸­å¯ä»¥100æ¡ï¼Œç„¶åæ¸…ç†list ï¼Œæ–¹ä¾¿å†…å­˜å›æ”¶ */ private static final int BATCH_COUNT = 5; private List&lt;UploadData&gt; cachedDataList = ListUtils.newArrayListWithExpectedSize(BATCH_COUNT); /** * å‡è®¾è¿™ä¸ªæ˜¯ä¸€ä¸ªDAOï¼Œå½“ç„¶æœ‰ä¸šåŠ¡é€»è¾‘è¿™ä¸ªä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªserviceã€‚å½“ç„¶å¦‚æœä¸ç”¨å­˜å‚¨è¿™ä¸ªå¯¹è±¡æ²¡ç”¨ã€‚ */ private UploadDAO uploadDAO; public UploadDataListener() { // è¿™é‡Œæ˜¯demoï¼Œæ‰€ä»¥éšä¾¿newä¸€ä¸ªã€‚å®é™…ä½¿ç”¨å¦‚æœåˆ°äº†spring,è¯·ä½¿ç”¨ä¸‹é¢çš„æœ‰å‚æ„é€ å‡½æ•° uploadDAO = new UploadDAO(); } /** * å¦‚æœä½¿ç”¨äº†spring,è¯·ä½¿ç”¨è¿™ä¸ªæ„é€ æ–¹æ³•ã€‚æ¯æ¬¡åˆ›å»ºListenerçš„æ—¶å€™éœ€è¦æŠŠspringç®¡ç†çš„ç±»ä¼ è¿›æ¥ * * @param uploadDAO */ public UploadDataListener(UploadDAO uploadDAO) { this.uploadDAO = uploadDAO; } /** * è¿™ä¸ªæ¯ä¸€æ¡æ•°æ®è§£æéƒ½ä¼šæ¥è°ƒç”¨ * * @param data one row value. Is is same as {@link AnalysisContext#readRowHolder()} * @param context */ @Override public void invoke(UploadData data, AnalysisContext context) { log.info(&quot;è§£æåˆ°ä¸€æ¡æ•°æ®:{}&quot;, JSON.toJSONString(data)); cachedDataList.add(data); // è¾¾åˆ°BATCH_COUNTäº†ï¼Œéœ€è¦å»å­˜å‚¨ä¸€æ¬¡æ•°æ®åº“ï¼Œé˜²æ­¢æ•°æ®å‡ ä¸‡æ¡æ•°æ®åœ¨å†…å­˜ï¼Œå®¹æ˜“OOM if (cachedDataList.size() &gt;= BATCH_COUNT) { saveData(); // å­˜å‚¨å®Œæˆæ¸…ç† list cachedDataList = ListUtils.newArrayListWithExpectedSize(BATCH_COUNT); } } /** * æ‰€æœ‰æ•°æ®è§£æå®Œæˆäº† éƒ½ä¼šæ¥è°ƒç”¨ * * @param context */ @Override public void doAfterAllAnalysed(AnalysisContext context) { // è¿™é‡Œä¹Ÿè¦ä¿å­˜æ•°æ®ï¼Œç¡®ä¿æœ€åé—ç•™çš„æ•°æ®ä¹Ÿå­˜å‚¨åˆ°æ•°æ®åº“ saveData(); log.info(&quot;æ‰€æœ‰æ•°æ®è§£æå®Œæˆï¼&quot;); } /** * åŠ ä¸Šå­˜å‚¨æ•°æ®åº“ */ private void saveData() { log.info(&quot;{}æ¡æ•°æ®ï¼Œå¼€å§‹å­˜å‚¨æ•°æ®åº“ï¼&quot;, cachedDataList.size()); uploadDAO.save(cachedDataList); log.info(&quot;å­˜å‚¨æ•°æ®åº“æˆåŠŸï¼&quot;); } } ExcelUtil import com.alibaba.excel.EasyExcelFactory; import com.alibaba.excel.ExcelWriter; import com.alibaba.excel.context.AnalysisContext; import com.alibaba.excel.event.AnalysisEventListener; import com.alibaba.excel.metadata.BaseRowModel; import com.alibaba.excel.metadata.Sheet; import lombok.Data; import lombok.Getter; import lombok.Setter; import lombok.extern.slf4j.Slf4j; import org.springframework.util.CollectionUtils; import org.springframework.util.StringUtils; import java.io.*; import java.util.ArrayList; import java.util.Collections; import java.util.List; @Slf4j public class ExcelUtil { private static Sheet initSheet; static { initSheet = new Sheet(1, 0); initSheet.setSheetName(&quot;sheet&quot;); //è®¾ç½®è‡ªé€‚åº”å®½åº¦ initSheet.setAutoWidth(Boolean.TRUE); } /** * è¯»å–å°‘äº1000è¡Œæ•°æ® * @param filePath æ–‡ä»¶ç»å¯¹è·¯å¾„ * @return */ public static List&lt;Object&gt; readLessThan1000Row(String filePath){ return readLessThan1000RowBySheet(filePath,null); } /** * è¯»å°äº1000è¡Œæ•°æ®, å¸¦æ ·å¼ * filePath æ–‡ä»¶ç»å¯¹è·¯å¾„ * initSheet ï¼š * sheetNo: sheeté¡µç ï¼Œé»˜è®¤ä¸º1 * headLineMun: ä»ç¬¬å‡ è¡Œå¼€å§‹è¯»å–æ•°æ®ï¼Œé»˜è®¤ä¸º0, è¡¨ç¤ºä»ç¬¬ä¸€è¡Œå¼€å§‹è¯»å– * clazz: è¿”å›æ•°æ®List&lt;Object&gt; ä¸­Objectçš„ç±»å */ public static List&lt;Object&gt; readLessThan1000RowBySheet(String filePath, Sheet sheet){ if(!StringUtils.hasText(filePath)){ return null; } sheet = sheet != null ? sheet : initSheet; InputStream fileStream = null; try { fileStream = new FileInputStream(filePath); return EasyExcelFactory.read(fileStream, sheet); } catch (FileNotFoundException e) { log.info(&quot;æ‰¾ä¸åˆ°æ–‡ä»¶æˆ–æ–‡ä»¶è·¯å¾„é”™è¯¯, æ–‡ä»¶ï¼š{}&quot;, filePath); }finally { try { if(fileStream != null){ fileStream.close(); } } catch (IOException e) { log.info(&quot;excelæ–‡ä»¶è¯»å–å¤±è´¥, å¤±è´¥åŸå› ï¼š{}&quot;, e); } } return null; } /** * è¯»å¤§äº1000è¡Œæ•°æ® * @param filePath æ–‡ä»¶è§‰å¾—è·¯å¾„ * @return */ public static List&lt;Object&gt; readMoreThan1000Row(String filePath){ return readMoreThan1000RowBySheet(filePath,null); } /** * è¯»å¤§äº1000è¡Œæ•°æ®, å¸¦æ ·å¼ * @param filePath æ–‡ä»¶è§‰å¾—è·¯å¾„ * @return */ public static List&lt;Object&gt; readMoreThan1000RowBySheet(String filePath, Sheet sheet){ if(!StringUtils.hasText(filePath)){ return null; } sheet = sheet != null ? sheet : initSheet; InputStream fileStream = null; try { fileStream = new FileInputStream(filePath); ExcelListener excelListener = new ExcelListener(); EasyExcelFactory.readBySax(fileStream, sheet, excelListener); return excelListener.getDatas(); } catch (FileNotFoundException e) { log.error(&quot;æ‰¾ä¸åˆ°æ–‡ä»¶æˆ–æ–‡ä»¶è·¯å¾„é”™è¯¯, æ–‡ä»¶ï¼š{}&quot;, filePath); }finally { try { if(fileStream != null){ fileStream.close(); } } catch (IOException e) { log.error(&quot;excelæ–‡ä»¶è¯»å–å¤±è´¥, å¤±è´¥åŸå› ï¼š{}&quot;, e); } } return null; } /** * ç”Ÿæˆexcle * @param filePath ç»å¯¹è·¯å¾„, å¦‚ï¼š/home/chenmingjian/Downloads/aaa.xlsx * @param data æ•°æ®æº * @param head è¡¨å¤´ */ public static void writeBySimple(String filePath, List&lt;List&lt;Object&gt;&gt; data, List&lt;String&gt; head){ writeSimpleBySheet(filePath,data,head,null); } /** * ç”Ÿæˆexcle * @param filePath ç»å¯¹è·¯å¾„, å¦‚ï¼š/home/chenmingjian/Downloads/aaa.xlsx * @param data æ•°æ®æº * @param sheet excleé¡µé¢æ ·å¼ * @param head è¡¨å¤´ */ public static void writeSimpleBySheet(String filePath, List&lt;List&lt;Object&gt;&gt; data, List&lt;String&gt; head, Sheet sheet){ sheet = (sheet != null) ? sheet : initSheet; if(head != null){ List&lt;List&lt;String&gt;&gt; list = new ArrayList&lt;&gt;(); head.forEach(h -&gt; list.add(Collections.singletonList(h))); sheet.setHead(list); } OutputStream outputStream = null; ExcelWriter writer = null; try { outputStream = new FileOutputStream(filePath); writer = EasyExcelFactory.getWriter(outputStream); writer.write1(data,sheet); } catch (FileNotFoundException e) { log.error(&quot;æ‰¾ä¸åˆ°æ–‡ä»¶æˆ–æ–‡ä»¶è·¯å¾„é”™è¯¯, æ–‡ä»¶ï¼š{}&quot;, filePath); }finally { try { if(writer != null){ writer.finish(); } if(outputStream != null){ outputStream.close(); } } catch (IOException e) { log.error(&quot;excelæ–‡ä»¶å¯¼å‡ºå¤±è´¥, å¤±è´¥åŸå› ï¼š{}&quot;, e); } } } /** * ç”Ÿæˆexcle * @param filePath ç»å¯¹è·¯å¾„, å¦‚ï¼š/home/chenmingjian/Downloads/aaa.xlsx * @param data æ•°æ®æº */ public static void writeWithTemplate(String filePath, List&lt;? extends BaseRowModel&gt; data){ writeWithTemplateAndSheet(filePath,data,null); } /** * ç”Ÿæˆexcle * @param filePath ç»å¯¹è·¯å¾„, å¦‚ï¼š/home/chenmingjian/Downloads/aaa.xlsx * @param data æ•°æ®æº * @param sheet excleé¡µé¢æ ·å¼ */ public static void writeWithTemplateAndSheet(String filePath, List&lt;? extends BaseRowModel&gt; data, Sheet sheet){ if(CollectionUtils.isEmpty(data)){ return; } sheet = (sheet != null) ? sheet : initSheet; sheet.setClazz(data.get(0).getClass()); OutputStream outputStream = null; ExcelWriter writer = null; try { outputStream = new FileOutputStream(filePath); writer = EasyExcelFactory.getWriter(outputStream); writer.write(data,sheet); } catch (FileNotFoundException e) { log.error(&quot;æ‰¾ä¸åˆ°æ–‡ä»¶æˆ–æ–‡ä»¶è·¯å¾„é”™è¯¯, æ–‡ä»¶ï¼š{}&quot;, filePath); }finally { try { if(writer != null){ writer.finish(); } if(outputStream != null){ outputStream.close(); } } catch (IOException e) { log.error(&quot;excelæ–‡ä»¶å¯¼å‡ºå¤±è´¥, å¤±è´¥åŸå› ï¼š{}&quot;, e); } } } /** * ç”Ÿæˆå¤šSheetçš„excle * @param filePath ç»å¯¹è·¯å¾„, å¦‚ï¼š/home/chenmingjian/Downloads/aaa.xlsx * @param multipleSheelPropetys */ public static void writeWithMultipleSheel(String filePath,List&lt;MultipleSheelPropety&gt; multipleSheelPropetys){ if(CollectionUtils.isEmpty(multipleSheelPropetys)){ return; } OutputStream outputStream = null; ExcelWriter writer = null; try { outputStream = new FileOutputStream(filePath); writer = EasyExcelFactory.getWriter(outputStream); for (MultipleSheelPropety multipleSheelPropety : multipleSheelPropetys) { Sheet sheet = multipleSheelPropety.getSheet() != null ? multipleSheelPropety.getSheet() : initSheet; if(!CollectionUtils.isEmpty(multipleSheelPropety.getData())){ sheet.setClazz(multipleSheelPropety.getData().get(0).getClass()); } writer.write(multipleSheelPropety.getData(), sheet); } } catch (FileNotFoundException e) { log.error(&quot;æ‰¾ä¸åˆ°æ–‡ä»¶æˆ–æ–‡ä»¶è·¯å¾„é”™è¯¯, æ–‡ä»¶ï¼š{}&quot;, filePath); }finally { try { if(writer != null){ writer.finish(); } if(outputStream != null){ outputStream.close(); } } catch (IOException e) { log.error(&quot;excelæ–‡ä»¶å¯¼å‡ºå¤±è´¥, å¤±è´¥åŸå› ï¼š{}&quot;, e); } } } /*********************åŒ¿åå†…éƒ¨ç±»å¼€å§‹ï¼Œå¯ä»¥æå–å‡ºå»******************************/ @Data public static class MultipleSheelPropety{ private List&lt;? extends BaseRowModel&gt; data; private Sheet sheet; } /** * è§£æç›‘å¬å™¨ï¼Œ * æ¯è§£æä¸€è¡Œä¼šå›è°ƒinvoke()æ–¹æ³•ã€‚ * æ•´ä¸ªexcelè§£æç»“æŸä¼šæ‰§è¡ŒdoAfterAllAnalysed()æ–¹æ³• */ @Getter @Setter public static class ExcelListener extends AnalysisEventListener { private List&lt;Object&gt; datas = new ArrayList&lt;&gt;(); /** * é€è¡Œè§£æ * object : å½“å‰è¡Œçš„æ•°æ® */ @Override public void invoke(Object object, AnalysisContext context) { //å½“å‰è¡Œ // context.getCurrentRowNum() if (object != null) { datas.add(object); } } /** * è§£æå®Œæ‰€æœ‰æ•°æ®åä¼šè°ƒç”¨è¯¥æ–¹æ³• */ @Override public void doAfterAllAnalysed(AnalysisContext context) { //è§£æç»“æŸé”€æ¯ä¸ç”¨çš„èµ„æº } } /************************åŒ¿åå†…éƒ¨ç±»ç»“æŸï¼Œå¯ä»¥æå–å‡ºå»***************************/ } ","link":"https://tianxiawuhao.github.io/T8lb37RDN/"},{"title":"ES6æ–°è¯­æ³•","content":"const ä¸ let å˜é‡ ä½¿ç”¨varå¸¦æ¥çš„éº»çƒ¦: function getClothing(isCold) { if (isCold) { var freezing = 'Grab a jacket!'; } else { var hot = 'It's a shorts kind of day.'; console.log(freezing); } } è¿è¡ŒgetClothing(false)åè¾“å‡ºçš„æ˜¯undefined,è¿™æ˜¯å› ä¸ºæ‰§è¡Œfunctionå‡½æ•°ä¹‹å‰,æ‰€æœ‰å˜é‡éƒ½ä¼šè¢«æå‡, æå‡åˆ°å‡½æ•°ä½œç”¨åŸŸé¡¶éƒ¨. letä¸constå£°æ˜çš„å˜é‡è§£å†³äº†è¿™ç§é—®é¢˜,å› ä¸ºä»–ä»¬æ˜¯å—çº§ä½œç”¨åŸŸ, åœ¨ä»£ç å—(ç”¨{}è¡¨ç¤º)ä¸­ä½¿ç”¨letæˆ–constå£°æ˜å˜é‡, è¯¥å˜é‡ä¼šé™·å…¥æš‚æ—¶æ€§æ­»åŒºç›´åˆ°è¯¥å˜é‡çš„å£°æ˜è¢«å¤„ç†. function getClothing(isCold) { if (isCold) { const freezing = 'Grab a jacket!'; } else { const hot = 'It's a shorts kind of day.'; console.log(freezing); } } è¿è¡ŒgetClothing(false)åè¾“å‡ºçš„æ˜¯ReferenceError: freezing is not defined,å› ä¸º freezing æ²¡æœ‰åœ¨ else è¯­å¥ã€å‡½æ•°ä½œç”¨åŸŸæˆ–å…¨å±€ä½œç”¨åŸŸå†…å£°æ˜ï¼Œæ‰€ä»¥æŠ›å‡º ReferenceErrorã€‚ å…³äºä½¿ç”¨letä¸constè§„åˆ™: ä½¿ç”¨letå£°æ˜çš„å˜é‡å¯ä»¥é‡æ–°èµ‹å€¼,ä½†æ˜¯ä¸èƒ½åœ¨åŒä¸€ä½œç”¨åŸŸå†…é‡æ–°å£°æ˜ ä½¿ç”¨constå£°æ˜çš„å˜é‡å¿…é¡»èµ‹å€¼åˆå§‹åŒ–,ä½†æ˜¯ä¸èƒ½åœ¨åŒä¸€ä½œç”¨åŸŸç±»é‡æ–°å£°æ˜ä¹Ÿæ— æ³•é‡æ–°èµ‹å€¼. æ¨¡æ¿å­—é¢é‡ åœ¨ES6ä¹‹å‰,å°†å­—ç¬¦ä¸²è¿æ¥åˆ°ä¸€èµ·çš„æ–¹æ³•æ˜¯+æˆ–è€…concat()æ–¹æ³•,å¦‚ const student = { name: 'Richard Kalehoff', guardian: 'Mr. Kalehoff' }; const teacher = { name: 'Mrs. Wilson', room: 'N231' } let message = student.name + ' please see ' + teacher.name + ' in ' + teacher.room + ' to pick up your report card.'; æ¨¡æ¿å­—é¢é‡æœ¬è´¨ä¸Šæ˜¯åŒ…å«åµŒå…¥å¼è¡¨è¾¾å¼çš„å­—ç¬¦ä¸²å­—é¢é‡. æ¨¡æ¿å­—é¢é‡ç”¨å€’å¼•å· ( `` )ï¼ˆè€Œä¸æ˜¯å•å¼•å· ( '' ) æˆ–åŒå¼•å·( &quot;&quot; )ï¼‰è¡¨ç¤ºï¼Œå¯ä»¥åŒ…å«ç”¨ ${expression} è¡¨ç¤ºçš„å ä½ç¬¦ let message = `${student.name} please see ${teacher.name} in ${teacher.room} to pick up your report card.`; è§£æ„ åœ¨ES6ä¸­,å¯ä»¥ä½¿ç”¨è§£æ„ä»æ•°ç»„å’Œå¯¹è±¡æå–å€¼å¹¶èµ‹å€¼ç»™ç‹¬ç‰¹çš„å˜é‡ è§£æ„æ•°ç»„çš„å€¼: const point = [10, 25, -34]; const [x, y, z] = point; console.log(x, y, z); Prints: 10 25 -34 []è¡¨ç¤ºè¢«è§£æ„çš„æ•°ç»„, x,y,zè¡¨ç¤ºè¦å°†æ•°ç»„ä¸­çš„å€¼å­˜å‚¨åœ¨å…¶ä¸­çš„å˜é‡, åœ¨è§£æ„æ•°ç»„æ˜¯, è¿˜å¯ä»¥å¿½ç•¥å€¼, ä¾‹å¦‚const[x,,z]=point,å¿½ç•¥yåæ ‡. è§£æ„å¯¹è±¡ä¸­çš„å€¼: const gemstone = { type: 'quartz', color: 'rose', karat: 21.29 }; const {type, color, karat} = gemstone; console.log(type, color, karat); èŠ±æ‹¬å· { } è¡¨ç¤ºè¢«è§£æ„çš„å¯¹è±¡ï¼Œtypeã€color å’Œ karat è¡¨ç¤ºè¦å°†å¯¹è±¡ä¸­çš„å±æ€§å­˜å‚¨åˆ°å…¶ä¸­çš„å˜é‡ å¯¹è±¡å­—é¢é‡ç®€å†™æ³• let type = 'quartz'; let color = 'rose'; let carat = 21.29; const gemstone = { type: type, color: color, carat: carat }; console.log(gemstone); ä½¿ç”¨å’Œæ‰€åˆ†é…çš„å˜é‡åç§°ç›¸åŒçš„åç§°åˆå§‹åŒ–å¯¹è±¡æ—¶å¦‚æœå±æ€§åç§°å’Œæ‰€åˆ†é…çš„å˜é‡åç§°ä¸€æ ·ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä»å¯¹è±¡å±æ€§ä¸­åˆ æ‰è¿™äº›é‡å¤çš„å˜é‡åç§°ã€‚ let type = 'quartz'; let color = 'rose'; let carat = 21.29; const gemstone = {type,color,carat}; console.log(gemstone); ç®€å†™æ–¹æ³•çš„åç§°: const gemstone = { type, color, carat, calculateWorth: function() { // å°†æ ¹æ®ç±»å‹(type)ï¼Œé¢œè‰²(color)å’Œå…‹æ‹‰(carat)è®¡ç®—å®çŸ³(gemstone)çš„ä»·å€¼ } }; åŒ¿åå‡½æ•°è¢«åˆ†é…ç»™å±æ€§ calculateWorthï¼Œä½†æ˜¯çœŸçš„éœ€è¦ function å…³é”®å­—å—ï¼Ÿåœ¨ ES6 ä¸­ä¸éœ€è¦ï¼ let gemstone = { type, color, carat, calculateWorth() { ... } }; for...ofå¾ªç¯ for...ofå¾ªç¯æ˜¯æœ€æ–°æ·»åŠ åˆ° JavaScript å¾ªç¯ç³»åˆ—ä¸­çš„å¾ªç¯ã€‚ å®ƒç»“åˆäº†å…¶å…„å¼Ÿå¾ªç¯å½¢å¼ for å¾ªç¯å’Œ for...in å¾ªç¯çš„ä¼˜åŠ¿ï¼Œå¯ä»¥å¾ªç¯ä»»ä½•å¯è¿­ä»£ï¼ˆä¹Ÿå°±æ˜¯éµå®ˆå¯è¿­ä»£åè®®ï¼‰ç±»å‹çš„æ•°æ®ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒåŒ…å«ä»¥ä¸‹æ•°æ®ç±»å‹ï¼šStringã€Arrayã€Map å’Œ Setï¼Œæ³¨æ„ä¸åŒ…å« Object æ•°æ®ç±»å‹ï¼ˆå³ {}ï¼‰ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯¹è±¡ä¸å¯è¿­ä»£ã€‚ forå¾ªç¯ const digits = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]; for (let i = 0; i &lt; digits.length; i++) { console.log(digits[i]); } for å¾ªç¯çš„æœ€å¤§ç¼ºç‚¹æ˜¯éœ€è¦è·Ÿè¸ªè®¡æ•°å™¨å’Œé€€å‡ºæ¡ä»¶ã€‚ è™½ç„¶ for å¾ªç¯åœ¨å¾ªç¯æ•°ç»„æ—¶çš„ç¡®å…·æœ‰ä¼˜åŠ¿ï¼Œä½†æ˜¯æŸäº›æ•°æ®ç»“æ„ä¸æ˜¯æ•°ç»„ï¼Œå› æ­¤å¹¶éå§‹ç»ˆé€‚åˆä½¿ç”¨ loop å¾ªç¯ã€‚ for...inå¾ªç¯ const digits = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]; for (const index in digits) { console.log(digits[index]); } ä¾ç„¶éœ€è¦ä½¿ç”¨ index æ¥è®¿é—®æ•°ç»„çš„å€¼ å½“ä½ éœ€è¦å‘æ•°ç»„ä¸­æ·»åŠ é¢å¤–çš„æ–¹æ³•ï¼ˆæˆ–å¦ä¸€ä¸ªå¯¹è±¡ï¼‰æ—¶ï¼Œfor...in å¾ªç¯ä¼šå¸¦æ¥å¾ˆå¤§çš„éº»çƒ¦ã€‚å› ä¸º for...in å¾ªç¯å¾ªç¯è®¿é—®æ‰€æœ‰å¯æšä¸¾çš„å±æ€§ï¼Œæ„å‘³ç€å¦‚æœå‘æ•°ç»„çš„åŸå‹ä¸­æ·»åŠ ä»»ä½•å…¶ä»–å±æ€§ï¼Œè¿™äº›å±æ€§ä¹Ÿä¼šå‡ºç°åœ¨å¾ªç¯ä¸­ã€‚ Array.prototype.decimalfy = function() { for (let i = 0; i &lt; this.length; i++) { this[i] = this[i].toFixed(2); } }; const digits = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]; for (const index in digits) { console.log(digits[index]); } forEach å¾ªç¯ forEach å¾ªç¯æ˜¯å¦ä¸€ç§å½¢å¼çš„ JavaScript å¾ªç¯ã€‚ä½†æ˜¯ï¼ŒforEach() å®é™…ä¸Šæ˜¯æ•°ç»„æ–¹æ³•ï¼Œå› æ­¤åªèƒ½ç”¨åœ¨æ•°ç»„ä¸­ã€‚ä¹Ÿæ— æ³•åœæ­¢æˆ–é€€å‡º forEach å¾ªç¯ã€‚å¦‚æœå¸Œæœ›ä½ çš„å¾ªç¯ä¸­å‡ºç°è¿™ç§è¡Œä¸ºï¼Œåˆ™éœ€è¦ä½¿ç”¨åŸºæœ¬çš„ for å¾ªç¯ã€‚ for...ofå¾ªç¯ for...of å¾ªç¯ç”¨äºå¾ªç¯è®¿é—®ä»»ä½•å¯è¿­ä»£çš„æ•°æ®ç±»å‹ã€‚ for...of å¾ªç¯çš„ç¼–å†™æ–¹å¼å’Œ for...in å¾ªç¯çš„åŸºæœ¬ä¸€æ ·ï¼Œåªæ˜¯å°† in æ›¿æ¢ä¸º ofï¼Œå¯ä»¥å¿½ç•¥ç´¢å¼•ã€‚ const digits = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]; for (const digit of digits) { console.log(digit); } å»ºè®®ä½¿ç”¨å¤æ•°å¯¹è±¡åç§°æ¥è¡¨ç¤ºå¤šä¸ªå€¼çš„é›†åˆã€‚è¿™æ ·ï¼Œå¾ªç¯è¯¥é›†åˆæ—¶ï¼Œå¯ä»¥ä½¿ç”¨åç§°çš„å•æ•°ç‰ˆæœ¬æ¥è¡¨ç¤ºé›†åˆä¸­çš„å•ä¸ªå€¼ã€‚ä¾‹å¦‚ï¼Œfor (const button of buttons) {â€¦}ã€‚ for...of å¾ªç¯è¿˜å…·æœ‰å…¶ä»–ä¼˜åŠ¿ï¼Œè§£å†³äº† for å’Œ for...in å¾ªç¯çš„ä¸è¶³ä¹‹å¤„ã€‚ä½ å¯ä»¥éšæ—¶åœæ­¢æˆ–é€€å‡º for...of å¾ªç¯ã€‚ for (const digit of digits) { if (digit % 2 === 0) { continue; } console.log(digit); } ä¸ç”¨æ‹…å¿ƒå‘å¯¹è±¡ä¸­æ·»åŠ æ–°çš„å±æ€§ã€‚for...of å¾ªç¯å°†åªå¾ªç¯è®¿é—®å¯¹è±¡ä¸­çš„å€¼ã€‚ Array.prototype.decimalfy = function() { for (i = 0; i &lt; this.length; i++) { this[i] = this[i].toFixed(2); } }; const digits = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]; for (const digit of digits) { console.log(digit); } å±•å¼€è¿ç®—ç¬¦ å±•å¼€è¿ç®—ç¬¦ï¼ˆç”¨ä¸‰ä¸ªè¿ç»­çš„ç‚¹ (...) è¡¨ç¤ºï¼‰æ˜¯ ES6 ä¸­çš„æ–°æ¦‚å¿µï¼Œä½¿ä½ èƒ½å¤Ÿå°†å­—é¢é‡å¯¹è±¡å±•å¼€ä¸ºå¤šä¸ªå…ƒç´  const books = [&quot;Don Quixote&quot;, &quot;The Hobbit&quot;, &quot;Alice in Wonderland&quot;, &quot;Tale of Two Cities&quot;]; console.log(...books); Prints: Don Quixote The Hobbit Alice in Wonderland Tale of Two Cities å±•å¼€è¿ç®—ç¬¦çš„ä¸€ä¸ªç”¨é€”æ˜¯ç»“åˆæ•°ç»„ã€‚ å¦‚æœä½ éœ€è¦ç»“åˆå¤šä¸ªæ•°ç»„ï¼Œåœ¨æœ‰å±•å¼€è¿ç®—ç¬¦ä¹‹å‰ï¼Œå¿…é¡»ä½¿ç”¨ Arrayçš„ concat() æ–¹æ³•ã€‚ const fruits = [&quot;apples&quot;, &quot;bananas&quot;, &quot;pears&quot;]; const vegetables = [&quot;corn&quot;, &quot;potatoes&quot;, &quot;carrots&quot;]; const produce = fruits.concat(vegetables); console.log(produce); Prints: [&quot;apples&quot;, &quot;bananas&quot;, &quot;pears&quot;, &quot;corn&quot;, &quot;potatoes&quot;, &quot;carrots&quot;] ä½¿ç”¨å±•å¼€ç¬¦æ¥ç»“åˆæ•°ç»„ const fruits = [&quot;apples&quot;, &quot;bananas&quot;, &quot;pears&quot;]; const vegetables = [&quot;corn&quot;, &quot;potatoes&quot;, &quot;carrots&quot;]; const produce = [...fruits,...vegetables]; console.log(produce); å‰©ä½™å‚æ•°(å¯å˜å‚æ•°) ä½¿ç”¨å±•å¼€è¿ç®—ç¬¦å°†æ•°ç»„å±•å¼€ä¸ºå¤šä¸ªå…ƒç´ , ä½¿ç”¨å‰©ä½™å‚æ•°å¯ä»¥å°†å¤šä¸ªå…ƒç´ ç»‘å®šåˆ°ä¸€ä¸ªæ•°ç»„ä¸­. å‰©ä½™å‚æ•°ä¹Ÿç”¨ä¸‰ä¸ªè¿ç»­çš„ç‚¹ ( ... ) è¡¨ç¤ºï¼Œä½¿ä½ èƒ½å¤Ÿå°†ä¸å®šæ•°é‡çš„å…ƒç´ è¡¨ç¤ºä¸ºæ•°ç»„. ç”¨é€”1: å°†å˜é‡èµ‹æ•°ç»„å€¼æ—¶: const order = [20.17, 18.67, 1.50, &quot;cheese&quot;, &quot;eggs&quot;, &quot;milk&quot;, &quot;bread&quot;]; const [total, subtotal, tax, ...items] = order; console.log(total, subtotal, tax, items); ç”¨é€”2: å¯å˜å‚æ•°å‡½æ•° å¯¹äºå‚æ•°ä¸å›ºå®šçš„å‡½æ•°,ES6ä¹‹å‰æ˜¯ä½¿ç”¨å‚æ•°å¯¹è±¡(arguments)å¤„ç†: function sum() { let total = 0; for(const argument of arguments) { total += argument; } return total; } åœ¨ES6ä¸­ä½¿ç”¨å‰©ä½™å‚æ•°è¿ç®—ç¬¦åˆ™æ›´ä¸ºç®€æ´,å¯è¯»æ€§æé«˜: function sum(...nums) { let total = 0; for(const num of nums) { total += num; } return total; } ES6ç®­å¤´å‡½æ•° ES6ä¹‹å‰,ä½¿ç”¨æ™®é€šå‡½æ•°æŠŠå…¶ä¸­æ¯ä¸ªåå­—è½¬æ¢ä¸ºå¤§å†™å½¢å¼ï¼š const upperizedNames = ['Farrin', 'Kagure', 'Asser'].map(function(name) { return name.toUpperCase(); }); ç®­å¤´å‡½æ•°è¡¨ç¤º: const upperizedNames = ['Farrin', 'Kagure', 'Asser'].map( name =&gt; name.toUpperCase() ); æ™®é€šå‡½æ•°å¯ä»¥æ˜¯å‡½æ•°å£°æ˜æˆ–è€…å‡½æ•°è¡¨è¾¾å¼, ä½†æ˜¯ç®­å¤´å‡½æ•°å§‹ç»ˆéƒ½æ˜¯è¡¨è¾¾å¼, å…¨ç¨‹æ˜¯ç®­å¤´å‡½æ•°è¡¨è¾¾å¼, å› æ­¤å› æ­¤ä»…åœ¨è¡¨è¾¾å¼æœ‰æ•ˆæ—¶æ‰èƒ½ä½¿ç”¨ï¼ŒåŒ…æ‹¬ï¼š å­˜å‚¨åœ¨å˜é‡ä¸­ï¼Œ å½“åšå‚æ•°ä¼ é€’ç»™å‡½æ•°ï¼Œ å­˜å‚¨åœ¨å¯¹è±¡çš„å±æ€§ä¸­ã€‚ const greet = name =&gt; `Hello ${name}!`; å¯ä»¥å¦‚ä¸‹è°ƒç”¨: greet('Asser'); å¦‚æœå‡½æ•°çš„å‚æ•°åªæœ‰ä¸€ä¸ª,ä¸éœ€è¦ä½¿ç”¨()åŒ…èµ·æ¥,ä½†æ˜¯åªæœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ª, åˆ™å¿…é¡»éœ€è¦å°†å‚æ•°åˆ—è¡¨æ”¾åœ¨åœ†æ‹¬å·å†…: // ç©ºå‚æ•°åˆ—è¡¨éœ€è¦æ‹¬å· const sayHi = () =&gt; console.log('Hello Udacity Student!'); // å¤šä¸ªå‚æ•°éœ€è¦æ‹¬å· const orderIceCream = (flavor, cone) =&gt; console.log(`Here's your ${flavor} ice cream in a ${cone} cone.`); orderIceCream('chocolate', 'waffle'); ä¸€èˆ¬ç®­å¤´å‡½æ•°éƒ½åªæœ‰ä¸€ä¸ªè¡¨è¾¾å¼ä½œä¸ºå‡½æ•°ä¸»é¢˜: const upperizedNames = ['Farrin', 'Kagure', 'Asser'].map( name =&gt; name.toUpperCase() ); è¿™ç§å‡½æ•°è¡¨è¾¾å¼å½¢å¼ç§°ä¸ºç®€å†™ä¸»ä½“è¯­æ³•: 1,åœ¨å‡½æ•°ä¸»ä½“å‘¨å›´æ²¡æœ‰èŠ±æ‹¬å·, 2,è‡ªåŠ¨è¿”å›è¡¨è¾¾å¼ 3,ä½†æ˜¯å¦‚æœç®­å¤´å‡½æ•°çš„ä¸»ä½“å†…éœ€è¦å¤šè¡Œä»£ç , åˆ™éœ€è¦ä½¿ç”¨å¸¸è§„ä¸»ä½“è¯­æ³•: å®ƒå°†å‡½æ•°ä¸»ä½“æ”¾åœ¨èŠ±æ‹¬å·å†… éœ€è¦ä½¿ç”¨ return è¯­å¥æ¥è¿”å›å†…å®¹ã€‚ const upperizedNames = ['Farrin', 'Kagure', 'Asser'].map( name =&gt; { name = name.toUpperCase(); return `${name} has ${name.length} characters in their name`; }); javascriptæ ‡å‡†å‡½æ•°this new å¯¹è±¡ const mySundae = new Sundae('Chocolate', ['Sprinkles', 'Hot Fudge']); sundaeè¿™ä¸ªæ„é€ å‡½æ•°å†…çš„thisçš„å€¼æ˜¯å®ä¾‹å¯¹è±¡, å› ä¸ºä»–ä½¿ç”¨newè¢«è°ƒç”¨. æŒ‡å®šçš„å¯¹è±¡ const result = obj1.printName.call(obj2); å‡½æ•°ä½¿ç”¨call/applyè¢«è°ƒç”¨,thisçš„å€¼æŒ‡å‘æŒ‡å®šçš„obj2,å› ä¸ºcall()ç¬¬ä¸€ä¸ªå‚æ•°æ˜ç¡®è®¾ç½®thisçš„æŒ‡å‘ ä¸Šä¸‹æ–‡å¯¹è±¡ data.teleport(); å‡½æ•°æ˜¯å¯¹è±¡çš„æ–¹æ³•, thisæŒ‡å‘å°±æ˜¯é‚£ä¸ªå¯¹è±¡,æ­¤å¤„thiså°±æ˜¯æŒ‡å‘data. å…¨å±€å¯¹è±¡æˆ– undefined teleport(); æ­¤å¤„æ˜¯thisæŒ‡å‘å…¨å±€å¯¹è±¡,åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹,æŒ‡å‘undefined. javascriptä¸­thisæ˜¯å¾ˆå¤æ‚çš„æ¦‚å¿µ, è¦è¯¦ç»†åˆ¤æ–­this,è¯·å‚è€ƒthisè±ç„¶å¼€æœ— ç®­å¤´å‡½æ•°å’Œthis å¯¹äºæ™®é€šå‡½æ•°, thisçš„å€¼åŸºäºå‡½æ•°å¦‚ä½•è¢«è°ƒç”¨, å¯¹äºç®­å¤´å‡½æ•°,thisçš„å€¼åŸºäºå‡½æ•°å‘¨å›´çš„ä¸Šä¸‹æ–‡, æ¢å¥è¯è¯´,thisçš„å€¼å’Œå‡½æ•°å¤–é¢çš„thisçš„å€¼æ˜¯ä¸€æ ·çš„. function IceCream() { this.scoops = 0; } // ä¸º IceCream æ·»åŠ  addScoop æ–¹æ³• IceCream.prototype.addScoop = function() { setTimeout(function() { this.scoops++; console.log('scoop added!'); console.log(this.scoops); // undefined+1=NaN console.log(dessert.scoops); //0 }, 500); }; const dessert = new IceCream(); dessert.addScoop(); ä¼ é€’ç»™ setTimeout() çš„å‡½æ•°è¢«è°ƒç”¨æ—¶æ²¡ç”¨åˆ° newã€call() æˆ– apply()ï¼Œä¹Ÿæ²¡ç”¨åˆ°ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚æ„å‘³ç€å‡½æ•°å†…çš„ this çš„å€¼æ˜¯å…¨å±€å¯¹è±¡ï¼Œä¸æ˜¯ dessert å¯¹è±¡ã€‚å®é™…ä¸Šå‘ç”Ÿçš„æƒ…å†µæ˜¯ï¼Œåˆ›å»ºäº†æ–°çš„ scoops å˜é‡ï¼ˆé»˜è®¤å€¼ä¸º undefinedï¼‰ï¼Œç„¶åé€’å¢ï¼ˆundefined + 1 ç»“æœä¸º NaNï¼‰; è§£å†³æ­¤é—®é¢˜çš„æ–¹å¼ä¹‹ä¸€æ˜¯ä½¿ç”¨é—­åŒ…(closure): // æ„é€ å‡½æ•° function IceCream() { this.scoops = 0; } // ä¸º IceCream æ·»åŠ  addScoop æ–¹æ³• IceCream.prototype.addScoop = function() { const cone = this; // è®¾ç½® `this` ç»™ `cone`å˜é‡ setTimeout(function() { cone.scoops++; // å¼•ç”¨`cone`å˜é‡ console.log('scoop added!'); console.log(dessert.scoops);//1 }, 0.5); }; const dessert = new IceCream(); dessert.addScoop(); ç®­å¤´å‡½æ•°çš„ä½œç”¨æ­£æ˜¯å¦‚æ­¤, å°†setTimeOut()çš„å‡½æ•°æ”¹ä¸ºå‰ªå¤´å‡½æ•°: // æ„é€ å‡½æ•° function IceCream() { this.scoops = 0; } // ä¸º IceCream æ·»åŠ  addScoop æ–¹æ³• IceCream.prototype.addScoop = function() { setTimeout(() =&gt; { // ä¸€ä¸ªç®­å¤´å‡½æ•°è¢«ä¼ é€’ç»™setTimeout this.scoops++; console.log('scoop added!'); console.log(dessert.scoops);//1 }, 0.5); }; const dessert = new IceCream(); dessert.addScoop(); é»˜è®¤å‚æ•°å‡½æ•° function greet(name, greeting) { name = (typeof name !== 'undefined') ? name : 'Student'; greeting = (typeof greeting !== 'undefined') ? greeting : 'Welcome'; return `${greeting} ${name}!`; } greet(); // Welcome Student! greet('James'); // Welcome James! greet('Richard', 'Howdy'); // Howdy Richard! greet() å‡½æ•°ä¸­æ··ä¹±çš„å‰ä¸¤è¡Œçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿå®ƒä»¬çš„ä½œç”¨æ˜¯å½“æ‰€éœ€çš„å‚æ•°æœªæä¾›æ—¶ï¼Œä¸ºå‡½æ•°æä¾›é»˜è®¤çš„å€¼ã€‚ä½†æ˜¯çœ‹èµ·æ¥å¾ˆéº»çƒ¦, ES6å¼•å…¥ä¸€ç§æ–°çš„æ–¹å¼åˆ›å»ºé»˜è®¤å€¼, ä»–å«é»˜è®¤å‡½æ•°å‚æ•°: function greet(name = 'Student', greeting = 'Welcome') { return `${greeting} ${name}!`; } greet(); // Welcome Student! greet('James'); // Welcome James! greet('Richard', 'Howdy'); // Howdy Richard! é»˜è®¤å€¼ä¸è§£æ„ é»˜è®¤å€¼ä¸è§£æ„æ•°ç»„ function createGrid([width = 5, height = 5]) { return `Generates a ${width} x ${height} grid`; } createGrid([]); // Generates a 5 x 5 grid createGrid([2]); // Generates a 2 x 5 grid createGrid([2, 3]); // Generates a 2 x 3 grid createGrid([undefined, 3]); // Generates a 5 x 3 grid createGrid() å‡½æ•°é¢„æœŸä¼ å…¥çš„æ˜¯æ•°ç»„ã€‚å®ƒé€šè¿‡è§£æ„å°†æ•°ç»„ä¸­çš„ç¬¬ä¸€é¡¹è®¾ä¸º widthï¼Œç¬¬äºŒé¡¹è®¾ä¸º heightã€‚å¦‚æœæ•°ç»„ä¸ºç©ºï¼Œæˆ–è€…åªæœ‰ä¸€é¡¹ï¼Œé‚£ä¹ˆå°±ä¼šä½¿ç”¨é»˜è®¤å‚æ•°ï¼Œå¹¶å°†ç¼ºå¤±çš„å‚æ•°è®¾ä¸ºé»˜è®¤å€¼ 5ã€‚ ä½†æ˜¯å­˜åœ¨ä¸€ä¸ªé—®é¢˜: createGrid(); // throws an error Uncaught TypeError: Cannot read property 'Symbol(Symbol.iterator)' of undefined å‡ºç°é”™è¯¯ï¼Œå› ä¸º createGrid() é¢„æœŸä¼ å…¥çš„æ˜¯æ•°ç»„ï¼Œç„¶åå¯¹å…¶è¿›è¡Œè§£æ„ã€‚å› ä¸ºå‡½æ•°è¢«è°ƒç”¨æ—¶æ²¡æœ‰ä¼ å…¥æ•°ç»„ï¼Œæ‰€ä»¥å‡ºç°é—®é¢˜ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨é»˜è®¤çš„å‡½æ•°å‚æ•°ï¼ function createGrid([width = 5, height = 5] = []) { return `Generating a grid of ${width} by ${height}`; } createGrid(); // Generates a 5 x 5 grid Returns: Generates a 5 x 5 grid é»˜è®¤å€¼ä¸è§£æ„å‡½æ•° å°±åƒä½¿ç”¨æ•°ç»„é»˜è®¤å€¼è§£æ„æ•°ç»„ä¸€æ ·ï¼Œå‡½æ•°å¯ä»¥è®©å¯¹è±¡æˆä¸ºä¸€ä¸ªé»˜è®¤å‚æ•°ï¼Œå¹¶ä½¿ç”¨å¯¹è±¡è§£æ„ï¼š function createSundae({scoops = 1, toppings = ['Hot Fudge']}={}) { const scoopText = scoops === 1 ? 'scoop' : 'scoops'; return `Your sundae has ${scoops} ${scoopText} with ${toppings.join(' and ')} toppings.`; } createSundae({}); // Your sundae has 1 scoop with Hot Fudge toppings. createSundae({scoops: 2}); // Your sundae has 2 scoops with Hot Fudge toppings. createSundae({scoops: 2, toppings: ['Sprinkles']}); // Your sundae has 2 scoops with Sprinkles toppings. createSundae({toppings: ['Cookie Dough']}); // Your sundae has 1 scoop with Cookie Dough toppings. createSundae(); // Your sundae has 1 scoop with Hot Fudge toppings. æ•°ç»„é»˜è®¤å€¼ä¸å¯¹è±¡é»˜è®¤å€¼ é»˜è®¤å‡½æ•°å‚æ•°åªæ˜¯ä¸ªç®€å•çš„æ·»åŠ å†…å®¹ï¼Œä½†æ˜¯å´å¸¦æ¥å¾ˆå¤šä¾¿åˆ©ï¼ä¸æ•°ç»„é»˜è®¤å€¼ç›¸æ¯”ï¼Œå¯¹è±¡é»˜è®¤å€¼å…·å¤‡çš„ä¸€ä¸ªä¼˜åŠ¿æ˜¯èƒ½å¤Ÿå¤„ç†è·³è¿‡çš„é€‰é¡¹ã€‚çœ‹çœ‹ä¸‹é¢çš„ä»£ç ï¼š function createSundae({scoops = 1, toppings = ['Hot Fudge']} = {}) { â€¦ } åœ¨ createSundae() å‡½æ•°ä½¿ç”¨å¯¹è±¡é»˜è®¤å€¼è¿›è¡Œè§£æ„æ—¶ï¼Œå¦‚æœä½ æƒ³ä½¿ç”¨ scoops çš„é»˜è®¤å€¼ï¼Œä½†æ˜¯æ›´æ”¹ toppingsï¼Œé‚£ä¹ˆåªéœ€ä½¿ç”¨ toppings ä¼ å…¥ä¸€ä¸ªå¯¹è±¡ï¼š createSundae({toppings: ['Hot Fudge', 'Sprinkles', 'Caramel']}); å°†ä¸Šè¿°ç¤ºä¾‹ä¸ä½¿ç”¨æ•°ç»„é»˜è®¤å€¼è¿›è¡Œè§£æ„çš„åŒä¸€å‡½æ•°ç›¸å¯¹æ¯”ã€‚ function createSundae([scoops = 1, toppings = ['Hot Fudge']] = []) { â€¦ } å¯¹äºè¿™ä¸ªå‡½æ•°ï¼Œå¦‚æœæƒ³ä½¿ç”¨ scoops çš„é»˜è®¤æ•°é‡ï¼Œä½†æ˜¯æ›´æ”¹ toppingsï¼Œåˆ™å¿…é¡»ä»¥è¿™ç§å¥‡æ€ªçš„æ–¹å¼è°ƒç”¨ä½ çš„å‡½æ•°ï¼š createSundae([undefined, ['Hot Fudge', 'Sprinkles', 'Caramel']]); å› ä¸ºæ•°ç»„æ˜¯åŸºäºä½ç½®çš„ï¼Œæˆ‘ä»¬éœ€è¦ä¼ å…¥ undefined ä»¥è·³è¿‡ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆå¹¶ä½¿ç”¨é»˜è®¤å€¼ï¼‰æ¥åˆ°è¾¾ç¬¬äºŒä¸ªå‚æ•°ã€‚ Javascriptç±» ES5åˆ›å»ºç±»: function Plane(numEngines) { this.numEngines = numEngines; this.enginesActive = false; } // ç”±æ‰€æœ‰å®ä¾‹ &quot;ç»§æ‰¿&quot; çš„æ–¹æ³• Plane.prototype.startEngines = function () { console.log('starting engines...'); this.enginesActive = true; }; ES6åˆ›å»ºç±» ES6ç±»åªæ˜¯ä¸€ä¸ªè¯­æ³•ç³–,åŸå‹ç»§ç»­å®é™…ä¸Šåœ¨åº•å±‚éšè—èµ·æ¥, ä¸ä¼ ç»Ÿç±»æœºåˆ¶è¯­è¨€æœ‰äº›åŒºåˆ«. class Plane { //constructoræ–¹æ³•è™½ç„¶åœ¨ç±»ä¸­,ä½†ä¸æ˜¯åŸå‹ä¸Šçš„æ–¹æ³•,åªæ˜¯ç”¨æ¥ç”Ÿæˆå®ä¾‹çš„. constructor(numEngines) { this.numEngines = numEngines; this.enginesActive = false; } //åŸå‹ä¸Šçš„æ–¹æ³•, ç”±æ‰€æœ‰å®ä¾‹å¯¹è±¡å…±äº«. startEngines() { console.log('starting enginesâ€¦'); this.enginesActive = true; } } console.log(typeof Plane); //function javascriptä¸­ç±»å…¶å®åªæ˜¯function, æ–¹æ³•ä¹‹é—´ä¸èƒ½ä½¿ç”¨,,ä¸ç”¨é€—å·åŒºåˆ†å±æ€§å’Œæ–¹æ³•. é™æ€æ–¹æ³• è¦æ·»åŠ é™æ€æ–¹æ³•ï¼Œè¯·åœ¨æ–¹æ³•åç§°å‰é¢åŠ ä¸Šå…³é”®å­— static class Plane { constructor(numEngines) { this.numEngines = numEngines; this.enginesActive = false; } static badWeather(planes) { for (plane of planes) { plane.enginesActive = false; } } startEngines() { console.log('starting enginesâ€¦'); this.enginesActive = true; } } å…³é”®å­—classå¸¦æ¥å…¶ä»–åŸºäºç±»çš„è¯­è¨€çš„å¾ˆå¤šæ€æƒ³,ä½†æ˜¯æ²¡æœ‰å‘javascriptä¸­æ·»åŠ æ­¤åŠŸèƒ½ javascriptç±»å®é™…ä¸Šè¿˜æ˜¯åŸå‹ç»§æ‰¿ åˆ›å»ºjavascriptç±»çš„æ–°å®ä¾‹æ—¶å¿…é¡»ä½¿ç”¨newå…³é”®å­— super å’Œ extends ä½¿ç”¨æ–°çš„superå’Œextendså…³é”®å­—æ‰©å±•ç±»: class Tree { constructor(size = '10', leaves = {spring: 'green', summer: 'green', fall: 'orange', winter: null}) { this.size = size; this.leaves = leaves; this.leafColor = null; } changeSeason(season) { this.leafColor = this.leaves[season]; if (season === 'spring') { this.size += 1; } } } class Maple extends Tree { constructor(syrupQty = 15, size, leaves) { super(size, leaves); //superç”¨ä½œå‡½æ•° this.syrupQty = syrupQty; } changeSeason(season) { super.changeSeason(season);//superç”¨ä½œå¯¹è±¡ if (season === 'spring') { this.syrupQty += 1; } } gatherSyrup() { this.syrupQty -= 3; } } ä½¿ç”¨ES5ç¼–å†™åŒæ ·åŠŸèƒ½çš„ç±»: function Tree(size, leaves) { this.size = size || 10; this.leaves = leaves || {spring: 'green', summer: 'green', fall: 'orange', winter: null}; this.leafColor; } Tree.prototype.changeSeason = function(season) { this.leafColor = this.leaves[season]; if (season === 'spring') { this.size += 1; } } function Maple (syrupQty, size, leaves) { Tree.call(this, size, leaves); this.syrupQty = syrupQty || 15; } Maple.prototype = Object.create(Tree.prototype); Maple.prototype.constructor = Maple; Maple.prototype.changeSeason = function(season) { Tree.prototype.changeSeason.call(this, season); if (season === 'spring') { this.syrupQty += 1; } } Maple.prototype.gatherSyrup = function() { this.syrupQty -= 3; } super å¿…é¡»åœ¨ this ä¹‹å‰è¢«è°ƒç”¨ åœ¨å­ç±»æ„é€ å‡½æ•°ä¸­ï¼Œåœ¨ä½¿ç”¨ this ä¹‹å‰ï¼Œå¿…é¡»å…ˆè°ƒç”¨è¶…çº§ç±»ã€‚ class Apple {} class GrannySmith extends Apple { constructor(tartnessLevel, energy) { this.tartnessLevel = tartnessLevel; // åœ¨ 'super' ä¹‹å‰ä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼ super(energy); } } ","link":"https://tianxiawuhao.github.io/MKTk7DnaM/"},{"title":"springBootå‚æ•°å’Œä¸šåŠ¡æ ¡éªŒ","content":"ä¸ºä»€ä¹ˆéœ€è¦å‚æ•°æ ¡éªŒ åœ¨æ—¥å¸¸çš„æ¥å£å¼€å‘ä¸­ï¼Œä¸ºäº†é˜²æ­¢éæ³•å‚æ•°å¯¹ä¸šåŠ¡é€ æˆå½±å“ï¼Œç»å¸¸éœ€è¦å¯¹æ¥å£çš„å‚æ•°åšæ ¡éªŒï¼Œä¾‹å¦‚ç™»å½•çš„æ—¶å€™éœ€è¦æ ¡éªŒç”¨æˆ·åå¯†ç æ˜¯å¦ä¸ºç©ºï¼Œåˆ›å»ºç”¨æˆ·çš„æ—¶å€™éœ€è¦æ ¡éªŒé‚®ä»¶ã€æ‰‹æœºå·ç æ ¼å¼æ˜¯å¦å‡†ç¡®ã€‚é ä»£ç å¯¹æ¥å£å‚æ•°ä¸€ä¸ªä¸ªæ ¡éªŒçš„è¯å°±å¤ªç¹çäº†ï¼Œä»£ç å¯è¯»æ€§æå·®ã€‚ Validatoræ¡†æ¶å°±æ˜¯ä¸ºäº†è§£å†³å¼€å‘äººå‘˜åœ¨å¼€å‘çš„æ—¶å€™å°‘å†™ä»£ç ï¼Œæå‡å¼€å‘æ•ˆç‡ Validatoræ ¡éªŒæ¡†æ¶éµå¾ªäº†JSR-303éªŒè¯è§„èŒƒï¼ˆå‚æ•°æ ¡éªŒè§„èŒƒï¼‰, JSRæ˜¯Java Specification Requestsçš„ç¼©å†™ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹åœ¨SpringbBootä¸­å¦‚ä½•é›†æˆå‚æ•°æ ¡éªŒæ¡†æ¶ã€‚ SpringBootä¸­é›†æˆå‚æ•°æ ¡éªŒ ç¬¬ä¸€æ­¥ï¼Œå¼•å…¥ä¾èµ– &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-validation&lt;/artifactId&gt; &lt;/dependency&gt; æ³¨ï¼šä»springboot-2.3å¼€å§‹ï¼Œæ ¡éªŒåŒ…è¢«ç‹¬ç«‹æˆäº†ä¸€ä¸ªstarterç»„ä»¶ï¼Œæ‰€ä»¥éœ€è¦å¼•å…¥validationå’Œwebï¼Œè€Œspringboot-2.3ä¹‹å‰çš„ç‰ˆæœ¬åªéœ€è¦å¼•å…¥ web ä¾èµ–å°±å¯ä»¥äº†ã€‚ ç¬¬äºŒæ­¥ï¼Œå®šä¹‰è¦å‚æ•°æ ¡éªŒçš„å®ä½“ç±» @Data public class ValidVO { private String id; @Length(min = 6,max = 12,message = &quot;appIdé•¿åº¦å¿…é¡»ä½äº6åˆ°12ä¹‹é—´&quot;) private String appId; @NotBlank(message = &quot;åå­—ä¸ºå¿…å¡«é¡¹&quot;) private String name; @Email(message = &quot;è¯·å¡«å†™æ­£ç¡®çš„é‚®ç®±åœ°å€&quot;) private String email; private String sex; @NotEmpty(message = &quot;çº§åˆ«ä¸èƒ½ä¸ºç©º&quot;) private String level; } åœ¨å®é™…å¼€å‘ä¸­å¯¹äºéœ€è¦æ ¡éªŒçš„å­—æ®µéƒ½éœ€è¦è®¾ç½®å¯¹åº”çš„ä¸šåŠ¡æç¤ºï¼Œå³messageå±æ€§ã€‚ å¸¸è§çš„çº¦æŸæ³¨è§£å¦‚ä¸‹ï¼š æ³¨è§£ åŠŸèƒ½ @AssertFalse å¯ä»¥ä¸ºnull,å¦‚æœä¸ä¸ºnullçš„è¯å¿…é¡»ä¸ºfalse @AssertTrue å¯ä»¥ä¸ºnull,å¦‚æœä¸ä¸ºnullçš„è¯å¿…é¡»ä¸ºtrue @DecimalMax è®¾ç½®ä¸èƒ½è¶…è¿‡æœ€å¤§å€¼ @DecimalMin è®¾ç½®ä¸èƒ½è¶…è¿‡æœ€å°å€¼ @Digits è®¾ç½®å¿…é¡»æ˜¯æ•°å­—ä¸”æ•°å­—æ•´æ•°çš„ä½æ•°å’Œå°æ•°çš„ä½æ•°å¿…é¡»åœ¨æŒ‡å®šèŒƒå›´å†… @Future æ—¥æœŸå¿…é¡»åœ¨å½“å‰æ—¥æœŸçš„æœªæ¥ @Past æ—¥æœŸå¿…é¡»åœ¨å½“å‰æ—¥æœŸçš„è¿‡å» @Max æœ€å¤§ä¸å¾—è¶…è¿‡æ­¤æœ€å¤§å€¼ @Min æœ€å¤§ä¸å¾—å°äºæ­¤æœ€å°å€¼ @NotNull ä¸èƒ½ä¸ºnullï¼Œå¯ä»¥æ˜¯ç©º @Null å¿…é¡»ä¸ºnull @Pattern å¿…é¡»æ»¡è¶³æŒ‡å®šçš„æ­£åˆ™è¡¨è¾¾å¼ @Size é›†åˆã€æ•°ç»„ã€mapç­‰çš„size()å€¼å¿…é¡»åœ¨æŒ‡å®šèŒƒå›´å†… @Email å¿…é¡»æ˜¯emailæ ¼å¼ @Length é•¿åº¦å¿…é¡»åœ¨æŒ‡å®šèŒƒå›´å†… @NotBlank å­—ç¬¦ä¸²ä¸èƒ½ä¸ºnull,å­—ç¬¦ä¸²trim()åä¹Ÿä¸èƒ½ç­‰äºâ€œâ€ @NotEmpty ä¸èƒ½ä¸ºnullï¼Œé›†åˆã€æ•°ç»„ã€mapç­‰size()ä¸èƒ½ä¸º0ï¼›å­—ç¬¦ä¸²trim()åå¯ä»¥ç­‰äºâ€œâ€ @Range å€¼å¿…é¡»åœ¨æŒ‡å®šèŒƒå›´å†… @URL å¿…é¡»æ˜¯ä¸€ä¸ªURL æ³¨ï¼šæ­¤è¡¨æ ¼åªæ˜¯ç®€å•çš„å¯¹æ³¨è§£åŠŸèƒ½çš„è¯´æ˜ï¼Œå¹¶æ²¡æœ‰å¯¹æ¯ä¸€ä¸ªæ³¨è§£çš„å±æ€§è¿›è¡Œè¯´æ˜ï¼›å¯è¯¦è§æºç ã€‚ ç¬¬ä¸‰æ­¥ï¼Œå®šä¹‰æ ¡éªŒç±»è¿›è¡Œæµ‹è¯• @RestController @Slf4j @Validated public class ValidController { @ApiOperation(&quot;RequestBodyæ ¡éªŒ&quot;) @PostMapping(&quot;/valid/test1&quot;) public String test1(@Validated @RequestBody ValidVO validVO){ log.info(&quot;validEntity is {}&quot;, validVO); return &quot;test1 valid success&quot;; } @ApiOperation(&quot;Formæ ¡éªŒ&quot;) @PostMapping(value = &quot;/valid/test2&quot;) public String test2(@Validated ValidVO validVO){ log.info(&quot;validEntity is {}&quot;, validVO); return &quot;test2 valid success&quot;; } @ApiOperation(&quot;å•å‚æ•°æ ¡éªŒ&quot;) @PostMapping(value = &quot;/valid/test3&quot;) public String test3(@Email String email){ log.info(&quot;email is {}&quot;, email); return &quot;email valid success&quot;; } } è¿™é‡Œæˆ‘ä»¬å…ˆå®šä¹‰ä¸‰ä¸ªæ–¹æ³•test1ï¼Œtest2ï¼Œtest3ï¼Œtest1ä½¿ç”¨äº†@RequestBodyæ³¨è§£ï¼Œç”¨äºæ¥å—å‰ç«¯å‘é€çš„jsonæ•°æ®ï¼Œtest2æ¨¡æ‹Ÿè¡¨å•æäº¤ï¼Œtest3æ¨¡æ‹Ÿå•å‚æ•°æäº¤ã€‚æ³¨æ„ï¼Œå½“ä½¿ç”¨å•å‚æ•°æ ¡éªŒæ—¶éœ€è¦åœ¨Controllerä¸ŠåŠ ä¸Š@Validatedæ³¨è§£ï¼Œå¦åˆ™ä¸ç”Ÿæ•ˆã€‚ ç¬¬å››æ­¥ï¼Œä½“éªŒæ•ˆæœ è°ƒç”¨test1æ–¹æ³•ï¼Œæç¤ºçš„æ˜¯org.springframework.web.bind.MethodArgumentNotValidExceptionå¼‚å¸¸ POST http://localhost:8080/valid/test1 Content-Type: application/json { &quot;id&quot;: 1, &quot;level&quot;: &quot;12&quot;, &quot;email&quot;: &quot;47693899&quot;, &quot;appId&quot;: &quot;ab1c&quot; } { &quot;status&quot;: 500, &quot;message&quot;: &quot;Validation failed for argument [0] in public java.lang.String com.jianzh5.blog.valid.ValidController.test1(com.jianzh5.blog.valid.ValidVO) with 3 errors: [Field error in object 'validVO' on field 'email': rejected value [47693899]; codes [Email.validVO.email,Email.email,Email.java.lang.String,Email]; arguments [org.springframework.context.support.DefaultMessageSourceResolvable: codes [validVO.email,email]; arguments []; default message [email],[Ljavax.validation.constraints.Pattern$Flag;@26139123,.*]; default message [ä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„ç”µå­é‚®ä»¶åœ°å€]]...&quot;, &quot;data&quot;: null, &quot;timestamp&quot;: 1628239624332 } è°ƒç”¨test2æ–¹æ³•ï¼Œæç¤ºçš„æ˜¯org.springframework.validation.BindExceptionå¼‚å¸¸ POST http://localhost:8080/valid/test2 Content-Type: application/x-www-form-urlencoded id=1&amp;level=12&amp;email=476938977&amp;appId=ab1c { &quot;status&quot;: 500, &quot;message&quot;: &quot;org.springframework.validation.BeanPropertyBindingResult: 3 errors\\nField error in object 'validVO' on field 'name': rejected value [null]; codes [NotBlank.validVO.name,NotBlank.name,NotBlank.java.lang.String,NotBlank]; arguments [org.springframework.context.support.DefaultMessageSourceResolvable: codes [validVO.name,name]; arguments []; default message [name]]; default message [åå­—ä¸ºå¿…å¡«é¡¹]...&quot;, &quot;data&quot;: null, &quot;timestamp&quot;: 1628239301951 } è°ƒç”¨test3æ–¹æ³•ï¼Œæç¤ºçš„æ˜¯javax.validation.ConstraintViolationExceptionå¼‚å¸¸ POST http://localhost:8080/valid/test3 Content-Type: application/x-www-form-urlencoded email=476938977 { &quot;status&quot;: 500, &quot;message&quot;: &quot;test3.email: ä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„ç”µå­é‚®ä»¶åœ°å€&quot;, &quot;data&quot;: null, &quot;timestamp&quot;: 1628239281022 } é€šè¿‡åŠ å…¥Validatoræ ¡éªŒæ¡†æ¶å¯ä»¥å¸®åŠ©æˆ‘ä»¬è‡ªåŠ¨å®ç°å‚æ•°çš„æ ¡éªŒã€‚ å‚æ•°å¼‚å¸¸åŠ å…¥å…¨å±€å¼‚å¸¸å¤„ç†å™¨ Validatoræ ¡éªŒæ¡†æ¶è¿”å›çš„é”™è¯¯æç¤ºå¤ªè‡ƒè‚¿äº†ï¼Œä¸ä¾¿äºé˜…è¯»ï¼Œä¸ºäº†æ–¹ä¾¿å‰ç«¯æç¤ºï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶ç®€åŒ–ä¸€ä¸‹ã€‚ åˆ›å»ºRestExceptionHandlerï¼Œå•ç‹¬æ‹¦æˆªå‚æ•°æ ¡éªŒçš„ä¸‰ä¸ªå¼‚å¸¸ï¼šjavax.validation.ConstraintViolationExceptionï¼Œorg.springframework.validation.BindExceptionï¼Œorg.springframework.web.bind.MethodArgumentNotValidExceptionï¼Œä»£ç å¦‚ä¸‹ï¼š @ExceptionHandler(value = {BindException.class, ValidationException.class, MethodArgumentNotValidException.class}) public ResponseEntity&lt;ResultData&lt;String&gt;&gt; handleValidatedException(Exception e) { ResultData&lt;String&gt; resp = null; if (e instanceof MethodArgumentNotValidException) { // BeanValidation exception MethodArgumentNotValidException ex = (MethodArgumentNotValidException) e; resp = ResultData.fail(HttpStatus.BAD_REQUEST.value(), ex.getBindingResult().getAllErrors().stream() .map(ObjectError::getDefaultMessage) .collect(Collectors.joining(&quot;; &quot;)) ); } else if (e instanceof ConstraintViolationException) { // BeanValidation GET simple param ConstraintViolationException ex = (ConstraintViolationException) e; resp = ResultData.fail(HttpStatus.BAD_REQUEST.value(), ex.getConstraintViolations().stream() .map(ConstraintViolation::getMessage) .collect(Collectors.joining(&quot;; &quot;)) ); } else if (e instanceof BindException) { // BeanValidation GET object param BindException ex = (BindException) e; resp = ResultData.fail(HttpStatus.BAD_REQUEST.value(), ex.getAllErrors().stream() .map(ObjectError::getDefaultMessage) .collect(Collectors.joining(&quot;; &quot;)) ); } return new ResponseEntity&lt;&gt;(resp,HttpStatus.BAD_REQUEST); } ä½“éªŒæ•ˆæœ POST http://localhost:8080/valid/test1 Content-Type: application/json { &quot;id&quot;: 1, &quot;level&quot;: &quot;12&quot;, &quot;email&quot;: &quot;47693899&quot;, &quot;appId&quot;: &quot;ab1c&quot; } { &quot;status&quot;: 400, &quot;message&quot;: &quot;åå­—ä¸ºå¿…å¡«é¡¹; ä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„ç”µå­é‚®ä»¶åœ°å€; appIdé•¿åº¦å¿…é¡»ä½äº6åˆ°12ä¹‹é—´&quot;, &quot;data&quot;: null, &quot;timestamp&quot;: 1628435116680 } æ˜¯ä¸æ˜¯æ„Ÿè§‰æ¸…çˆ½å¤šäº†ï¼Ÿ è‡ªå®šä¹‰å‚æ•°æ ¡éªŒ è™½ç„¶Spring Validation æä¾›çš„æ³¨è§£åŸºæœ¬ä¸Šå¤Ÿç”¨ï¼Œä½†æ˜¯é¢å¯¹å¤æ‚çš„å®šä¹‰ï¼Œæˆ‘ä»¬è¿˜æ˜¯éœ€è¦è‡ªå·±å®šä¹‰ç›¸å…³æ³¨è§£æ¥å®ç°è‡ªåŠ¨æ ¡éªŒã€‚ æ¯”å¦‚ä¸Šé¢å®ä½“ç±»ä¸­çš„sexæ€§åˆ«å±æ€§ï¼Œåªå…è®¸å‰ç«¯ä¼ é€’ä¼  Mï¼ŒF è¿™2ä¸ªæšä¸¾å€¼ï¼Œå¦‚ä½•å®ç°å‘¢ï¼Ÿ ç¬¬ä¸€æ­¥ï¼Œåˆ›å»ºè‡ªå®šä¹‰æ³¨è§£ @Target({METHOD, FIELD, ANNOTATION_TYPE, CONSTRUCTOR, PARAMETER, TYPE_USE}) @Retention(RUNTIME) @Repeatable(EnumString.List.class) @Documented @Constraint(validatedBy = EnumStringValidator.class)//æ ‡æ˜ç”±å“ªä¸ªç±»æ‰§è¡Œæ ¡éªŒé€»è¾‘ public @interface EnumString { String message() default &quot;value not in enum values.&quot;; Class&lt;?&gt;[] groups() default {}; Class&lt;? extends Payload&gt;[] payload() default {}; /** * @return date must in this value array */ String[] value(); /** * Defines several {@link EnumString} annotations on the same element. * * @see EnumString */ @Target({METHOD, FIELD, ANNOTATION_TYPE, CONSTRUCTOR, PARAMETER, TYPE_USE}) @Retention(RUNTIME) @Documented @interface List { EnumString[] value(); } } ç¬¬äºŒæ­¥ï¼Œè‡ªå®šä¹‰æ ¡éªŒé€»è¾‘ public class EnumStringValidator implements ConstraintValidator&lt;EnumString, String&gt; { private List&lt;String&gt; enumStringList; @Override public void initialize(EnumString constraintAnnotation) { enumStringList = Arrays.asList(constraintAnnotation.value()); } @Override public boolean isValid(String value, ConstraintValidatorContext context) { if(value == null){ return true; } return enumStringList.contains(value); } } ç¬¬ä¸‰æ­¥ï¼Œåœ¨å­—æ®µä¸Šå¢åŠ æ³¨è§£ @ApiModelProperty(value = &quot;æ€§åˆ«&quot;) @EnumString(value = {&quot;F&quot;,&quot;M&quot;}, message=&quot;æ€§åˆ«åªå…è®¸ä¸ºFæˆ–M&quot;) private String sex; ç¬¬å››æ­¥ï¼Œä½“éªŒæ•ˆæœ POST http://localhost:8080/valid/test2 Content-Type: application/x-www-form-urlencoded id=1&amp;name=javadaily&amp;level=12&amp;email=476938977@qq.com&amp;appId=ab1cdddd&amp;sex=N { &quot;status&quot;: 400, &quot;message&quot;: &quot;æ€§åˆ«åªå…è®¸ä¸ºFæˆ–M&quot;, &quot;data&quot;: null, &quot;timestamp&quot;: 1628435243723 } åˆ†ç»„æ ¡éªŒ ä¸€ä¸ªVOå¯¹è±¡åœ¨æ–°å¢çš„æ—¶å€™æŸäº›å­—æ®µä¸ºå¿…å¡«ï¼Œåœ¨æ›´æ–°çš„æ—¶å€™åˆéå¿…å¡«ã€‚å¦‚ä¸Šé¢çš„ValidVOä¸­ id å’Œ appId å±æ€§åœ¨æ–°å¢æ“ä½œæ—¶éƒ½æ˜¯éå¿…å¡«ï¼Œè€Œåœ¨ç¼–è¾‘æ“ä½œæ—¶éƒ½ä¸ºå¿…å¡«ï¼Œnameåœ¨æ–°å¢æ“ä½œæ—¶ä¸ºå¿…å¡«ï¼Œé¢å¯¹è¿™ç§åœºæ™¯ä½ ä¼šæ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ åœ¨å®é™…å¼€å‘ä¸­æˆ‘è§åˆ°å¾ˆå¤šåŒå­¦éƒ½æ˜¯å»ºç«‹ä¸¤ä¸ªVOå¯¹è±¡ï¼ŒValidCreateVOï¼ŒValidEditVOæ¥å¤„ç†è¿™ç§åœºæ™¯ï¼Œè¿™æ ·ç¡®å®ä¹Ÿèƒ½å®ç°æ•ˆæœï¼Œä½†æ˜¯ä¼šé€ æˆç±»è†¨èƒ€ï¼Œè€Œä¸”æå…¶å®¹æ˜“è¢«å¼€å‘è€é¸Ÿä»¬å˜²ç¬‘ã€‚ å…¶å®Validatoræ ¡éªŒæ¡†æ¶å·²ç»è€ƒè™‘åˆ°äº†è¿™ç§åœºæ™¯å¹¶ä¸”æä¾›äº†è§£å†³æ–¹æ¡ˆï¼Œå°±æ˜¯åˆ†ç»„æ ¡éªŒï¼Œåªä¸è¿‡å¾ˆå¤šåŒå­¦ä¸çŸ¥é“è€Œå·²ã€‚è¦ä½¿ç”¨åˆ†ç»„æ ¡éªŒï¼Œåªéœ€è¦ä¸‰ä¸ªæ­¥éª¤ï¼š ç¬¬ä¸€æ­¥ï¼šå®šä¹‰åˆ†ç»„æ¥å£ public interface ValidGroup extends Default { interface Crud extends ValidGroup{ interface Create extends Crud{ } interface Update extends Crud{ } interface Query extends Crud{ } interface Delete extends Crud{ } } } è¿™é‡Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªåˆ†ç»„æ¥å£ValidGroupè®©å…¶ç»§æ‰¿javax.validation.groups.Defaultï¼Œå†åœ¨åˆ†ç»„æ¥å£ä¸­å®šä¹‰å‡ºå¤šä¸ªä¸åŒçš„æ“ä½œç±»å‹ï¼ŒCreateï¼ŒUpdateï¼ŒQueryï¼ŒDeleteã€‚è‡³äºä¸ºä»€ä¹ˆéœ€è¦ç»§æ‰¿Defaultæˆ‘ä»¬ç¨åå†è¯´ã€‚ ç¬¬äºŒæ­¥ï¼Œåœ¨æ¨¡å‹ä¸­ç»™å‚æ•°åˆ†é…åˆ†ç»„ @Data @ApiModel(value = &quot;å‚æ•°æ ¡éªŒç±»&quot;) public class ValidVO { @ApiModelProperty(&quot;ID&quot;) @Null(groups = ValidGroup.Crud.Create.class) @NotNull(groups = ValidGroup.Crud.Update.class, message = &quot;åº”ç”¨IDä¸èƒ½ä¸ºç©º&quot;) private String id; @Null(groups = ValidGroup.Crud.Create.class) @NotNull(groups = ValidGroup.Crud.Update.class, message = &quot;åº”ç”¨IDä¸èƒ½ä¸ºç©º&quot;) @ApiModelProperty(value = &quot;åº”ç”¨ID&quot;,example = &quot;cloud&quot;) private String appId; @ApiModelProperty(value = &quot;åå­—&quot;) @NotBlank(groups = ValidGroup.Crud.Create.class,message = &quot;åå­—ä¸ºå¿…å¡«é¡¹&quot;) private String name; @ApiModelProperty(value = &quot;é‚®ç®±&quot;) @Email(message = &quot;è¯·å¡«å†™æ­£å–çš„é‚®ç®±åœ°å€&quot;) privte String email; ... } ç»™å‚æ•°æŒ‡å®šåˆ†ç»„ï¼Œå¯¹äºæœªæŒ‡å®šåˆ†ç»„çš„åˆ™ä½¿ç”¨çš„æ˜¯é»˜è®¤åˆ†ç»„ã€‚ ç¬¬ä¸‰æ­¥ï¼Œç»™éœ€è¦å‚æ•°æ ¡éªŒçš„æ–¹æ³•æŒ‡å®šåˆ†ç»„ @RestController @Api(&quot;å‚æ•°æ ¡éªŒ&quot;) @Slf4j @Validated public class ValidController { @ApiOperation(&quot;æ–°å¢&quot;) @PostMapping(value = &quot;/valid/add&quot;) public String add(@Validated(value = ValidGroup.Crud.Create.class) ValidVO validVO){ log.info(&quot;validEntity is {}&quot;, validVO); return &quot;test3 valid success&quot;; } @ApiOperation(&quot;æ›´æ–°&quot;) @PostMapping(value = &quot;/valid/update&quot;) public String update(@Validated(value = ValidGroup.Crud.Update.class) ValidVO validVO){ log.info(&quot;validEntity is {}&quot;, validVO); return &quot;test4 valid success&quot;; } } è¿™é‡Œæˆ‘ä»¬é€šè¿‡valueå±æ€§ç»™add()å’Œupdate()æ–¹æ³•åˆ†åˆ«æŒ‡å®šCreateå’ŒUpdateåˆ†ç»„ã€‚ ç¬¬å››æ­¥ï¼Œä½“éªŒæ•ˆæœ POST http://localhost:8080/valid/add Content-Type: application/x-www-form-urlencoded name=javadaily&amp;level=12&amp;email=476938977@qq.com&amp;sex=F åœ¨Createæ—¶æˆ‘ä»¬æ²¡æœ‰ä¼ é€’idå’ŒappIdå‚æ•°ï¼Œæ ¡éªŒé€šè¿‡ã€‚ å½“æˆ‘ä»¬ä½¿ç”¨åŒæ ·çš„å‚æ•°è°ƒç”¨updateæ–¹æ³•æ—¶åˆ™æç¤ºå‚æ•°æ ¡éªŒé”™è¯¯ã€‚ { &quot;status&quot;: 400, &quot;message&quot;: &quot;IDä¸èƒ½ä¸ºç©º; åº”ç”¨IDä¸èƒ½ä¸ºç©º&quot;, &quot;data&quot;: null, &quot;timestamp&quot;: 1628492514313 } ç”±äºemailå±äºé»˜è®¤åˆ†ç»„ï¼Œè€Œæˆ‘ä»¬çš„åˆ†ç»„æ¥å£ValidGroupå·²ç»ç»§æ‰¿äº†Defaultåˆ†ç»„ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯å¯ä»¥å¯¹emailå­—æ®µä½œå‚æ•°æ ¡éªŒçš„ã€‚å¦‚ï¼š POST http://localhost:8080/valid/add Content-Type: application/x-www-form-urlencoded name=javadaily&amp;level=12&amp;email=476938977&amp;sex=F { &quot;status&quot;: 400, &quot;message&quot;: &quot;è¯·å¡«å†™æ­£å–çš„é‚®ç®±åœ°å€&quot;, &quot;data&quot;: null, &quot;timestamp&quot;: 1628492637305 } å½“ç„¶å¦‚æœä½ çš„ValidGroupæ²¡æœ‰ç»§æ‰¿Defaultåˆ†ç»„ï¼Œé‚£åœ¨ä»£ç å±æ€§ä¸Šå°±éœ€è¦åŠ ä¸Š@Validated(value = {ValidGroup.Crud.Create.class, Default.class}æ‰èƒ½è®©emailå­—æ®µçš„æ ¡éªŒç”Ÿæ•ˆã€‚ ä¸šåŠ¡è§„åˆ™æ ¡éªŒ ä¸šåŠ¡è§„åˆ™æ ¡éªŒæŒ‡æ¥å£éœ€è¦æ»¡è¶³æŸäº›ç‰¹å®šçš„ä¸šåŠ¡è§„åˆ™ï¼Œä¸¾ä¸ªä¾‹å­ï¼šä¸šåŠ¡ç³»ç»Ÿçš„ç”¨æˆ·éœ€è¦ä¿è¯å…¶å”¯ä¸€æ€§ï¼Œç”¨æˆ·å±æ€§ä¸èƒ½ä¸å…¶ä»–ç”¨æˆ·äº§ç”Ÿå†²çªï¼Œä¸å…è®¸ä¸æ•°æ®åº“ä¸­ä»»ä½•å·²æœ‰ç”¨æˆ·çš„ç”¨æˆ·åç§°ã€æ‰‹æœºå·ç ã€é‚®ç®±äº§ç”Ÿé‡å¤ã€‚ è¿™å°±è¦æ±‚åœ¨åˆ›å»ºç”¨æˆ·æ—¶éœ€è¦æ ¡éªŒç”¨æˆ·åç§°ã€æ‰‹æœºå·ç ã€é‚®ç®±æ˜¯å¦è¢«æ³¨å†Œï¼›ç¼–è¾‘ç”¨æˆ·æ—¶ä¸èƒ½å°†ä¿¡æ¯ä¿®æ”¹æˆå·²æœ‰ç”¨æˆ·çš„å±æ€§ã€‚ 95%çš„ç¨‹åºå‘˜å½“é¢å¯¹è¿™ç§ä¸šåŠ¡è§„åˆ™æ ¡éªŒæ—¶å¾€å¾€é€‰æ‹©å†™åœ¨serviceé€»è¾‘ä¸­ï¼Œå¸¸è§çš„ä»£ç é€»è¾‘å¦‚ä¸‹ï¼š public void create(User user) { Account account = accountDao.queryByUserNameOrPhoneOrEmail(user.getName(),user.getPhone(),user.getEmail()); if (account != null) { throw new IllegalArgumentException(&quot;ç”¨æˆ·å·²å­˜åœ¨ï¼Œè¯·é‡æ–°è¾“å…¥&quot;); } } æœ€ä¼˜é›…çš„å®ç°æ–¹æ³•åº”è¯¥æ˜¯å‚è€ƒ Bean Validation çš„æ ‡å‡†æ–¹å¼ï¼Œå€ŸåŠ©è‡ªå®šä¹‰æ ¡éªŒæ³¨è§£å®Œæˆä¸šåŠ¡è§„åˆ™æ ¡éªŒã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ä¸Šé¢æåˆ°çš„ç”¨æˆ·æ¥å£æ¡ˆä¾‹ï¼Œé€šè¿‡è‡ªå®šä¹‰æ³¨è§£å®Œæˆä¸šåŠ¡è§„åˆ™æ ¡éªŒã€‚ ä»£ç å®æˆ˜ éœ€æ±‚å¾ˆå®¹æ˜“ç†è§£ï¼Œæ³¨å†Œæ–°ç”¨æˆ·æ—¶ï¼Œåº”çº¦æŸä¸ä¸ä»»ä½•å·²æœ‰ç”¨æˆ·çš„å…³é”®ä¿¡æ¯é‡å¤ï¼›è€Œä¿®æ”¹è‡ªå·±çš„ä¿¡æ¯æ—¶ï¼Œåªèƒ½ä¸è‡ªå·±çš„ä¿¡æ¯é‡å¤ï¼Œä¸å…è®¸ä¿®æ”¹æˆå·²æœ‰ç”¨æˆ·çš„ä¿¡æ¯ã€‚ è¿™äº›çº¦æŸè§„åˆ™ä¸ä»…ä»…ä¸ºè¿™ä¸¤ä¸ªæ–¹æ³•æœåŠ¡ï¼Œå®ƒä»¬å¯èƒ½ä¼šåœ¨ç”¨æˆ·èµ„æºä¸­çš„å…¶ä»–å…¥å£è¢«ä½¿ç”¨åˆ°ï¼Œä¹ƒè‡³åœ¨å…¶ä»–åˆ†å±‚çš„ä»£ç ä¸­è¢«ä½¿ç”¨åˆ°ï¼Œåœ¨ Bean ä¸Šåšæ ¡éªŒå°±èƒ½å…¨éƒ¨è¦†ç›–ä¸Šè¿°è¿™äº›ä½¿ç”¨åœºæ™¯ã€‚ è‡ªå®šä¹‰æ³¨è§£ é¦–å…ˆæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸¤ä¸ªè‡ªå®šä¹‰æ³¨è§£ï¼Œç”¨äºä¸šåŠ¡è§„åˆ™æ ¡éªŒï¼š UniqueUser:è¡¨ç¤ºä¸€ä¸ªç”¨æˆ·æ˜¯å”¯ä¸€çš„ï¼Œå”¯ä¸€æ€§åŒ…å«ï¼šç”¨æˆ·åï¼Œæ‰‹æœºå·ç ã€é‚®ç®± @Documented @Retention(RUNTIME) @Target({FIELD, METHOD, PARAMETER, TYPE}) @Constraint(validatedBy = UserValidation.UniqueUserValidator.class) public @interface UniqueUser { String message() default &quot;ç”¨æˆ·åã€æ‰‹æœºå·ç ã€é‚®ç®±ä¸å…è®¸ä¸ç°å­˜ç”¨æˆ·é‡å¤&quot;; Class&lt;?&gt;[] groups() default {}; Class&lt;? extends Payload&gt;[] payload() default {}; } NotConflictUser:è¡¨ç¤ºä¸€ä¸ªç”¨æˆ·çš„ä¿¡æ¯æ˜¯æ— å†²çªçš„ï¼Œæ— å†²çªæ˜¯æŒ‡è¯¥ç”¨æˆ·çš„æ•æ„Ÿä¿¡æ¯ä¸å…¶ä»–ç”¨æˆ·ä¸é‡åˆ @Documented @Retention(RUNTIME) @Target({FIELD, METHOD, PARAMETER, TYPE}) @Constraint(validatedBy = UserValidation.NotConflictUserValidator.class) public @interface NotConflictUser { String message() default &quot;ç”¨æˆ·åç§°ã€é‚®ç®±ã€æ‰‹æœºå·ç ä¸ç°å­˜ç”¨æˆ·äº§ç”Ÿé‡å¤&quot;; Class&lt;?&gt;[] groups() default {}; Class&lt;? extends Payload&gt;[] payload() default {}; } å®ç°ä¸šåŠ¡æ ¡éªŒè§„åˆ™ æƒ³è®©è‡ªå®šä¹‰éªŒè¯æ³¨è§£ç”Ÿæ•ˆï¼Œéœ€è¦å®ç° ConstraintValidator æ¥å£ã€‚æ¥å£çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ è‡ªå®šä¹‰æ³¨è§£ç±»å‹ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ è¢«æ³¨è§£å­—æ®µçš„ç±»ï¼Œå› ä¸ºéœ€è¦æ ¡éªŒå¤šä¸ªå‚æ•°ï¼Œæˆ‘ä»¬ç›´æ¥ä¼ å…¥ç”¨æˆ·å¯¹è±¡ã€‚éœ€è¦æåˆ°çš„ä¸€ç‚¹æ˜¯ ConstraintValidator æ¥å£çš„å®ç°ç±»æ— éœ€æ·»åŠ  @Component å®ƒåœ¨å¯åŠ¨çš„æ—¶å€™å°±å·²ç»è¢«åŠ è½½åˆ°å®¹å™¨ä¸­äº†ã€‚ @Slf4j public class UserValidation&lt;T extends Annotation&gt; implements ConstraintValidator&lt;T, User&gt; { protected Predicate&lt;User&gt; predicate = c -&gt; true; @Resource protected UserRepository userRepository; @Override public boolean isValid(User user, ConstraintValidatorContext constraintValidatorContext) { return userRepository == null || predicate.test(user); } /** * æ ¡éªŒç”¨æˆ·æ˜¯å¦å”¯ä¸€ * å³åˆ¤æ–­æ•°æ®åº“æ˜¯å¦å­˜åœ¨å½“å‰æ–°ç”¨æˆ·çš„ä¿¡æ¯ï¼Œå¦‚ç”¨æˆ·åï¼Œæ‰‹æœºï¼Œé‚®ç®± */ public static class UniqueUserValidator extends UserValidation&lt;UniqueUser&gt;{ @Override public void initialize(UniqueUser uniqueUser) { predicate = c -&gt; !userRepository.existsByUserNameOrEmailOrTelphone(c.getUserName(),c.getEmail(),c.getTelphone()); } } /** * æ ¡éªŒæ˜¯å¦ä¸å…¶ä»–ç”¨æˆ·å†²çª * å°†ç”¨æˆ·åã€é‚®ä»¶ã€ç”µè¯æ”¹æˆä¸ç°æœ‰å®Œå…¨ä¸é‡å¤çš„ï¼Œæˆ–è€…åªä¸è‡ªå·±é‡å¤çš„ï¼Œå°±ä¸ç®—å†²çª */ public static class NotConflictUserValidator extends UserValidation&lt;NotConflictUser&gt;{ @Override public void initialize(NotConflictUser notConflictUser) { predicate = c -&gt; { log.info(&quot;user detail is {}&quot;,c); Collection&lt;User&gt; collection = userRepository.findByUserNameOrEmailOrTelphone(c.getUserName(), c.getEmail(), c.getTelphone()); // å°†ç”¨æˆ·åã€é‚®ä»¶ã€ç”µè¯æ”¹æˆä¸ç°æœ‰å®Œå…¨ä¸é‡å¤çš„ï¼Œæˆ–è€…åªä¸è‡ªå·±é‡å¤çš„ï¼Œå°±ä¸ç®—å†²çª return collection.isEmpty() || (collection.size() == 1 &amp;&amp; collection.iterator().next().getId().equals(c.getId())); }; } } } è¿™é‡Œä½¿ç”¨Predicateå‡½æ•°å¼æ¥å£å¯¹ä¸šåŠ¡è§„åˆ™è¿›è¡Œåˆ¤æ–­ã€‚ ä½¿ç”¨ @RestController @RequestMapping(&quot;/senior/user&quot;) @Slf4j @Validated public class UserController { @Autowired private UserRepository userRepository; @PostMapping public User createUser(@UniqueUser @Valid User user){ User savedUser = userRepository.save(user); log.info(&quot;save user id is {}&quot;,savedUser.getId()); return savedUser; } @SneakyThrows @PutMapping public User updateUser(@NotConflictUser @Valid @RequestBody User user){ User editUser = userRepository.save(user); log.info(&quot;update user is {}&quot;,editUser); return editUser; } } ä½¿ç”¨å¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨æ–¹æ³•ä¸ŠåŠ å…¥è‡ªå®šä¹‰æ³¨è§£å³å¯ï¼Œä¸šåŠ¡é€»è¾‘ä¸­ä¸éœ€è¦æ·»åŠ ä»»ä½•ä¸šåŠ¡è§„åˆ™çš„ä»£ç ã€‚ æµ‹è¯• è°ƒç”¨æ¥å£åå‡ºç°å¦‚ä¸‹é”™è¯¯ï¼Œè¯´æ˜ä¸šåŠ¡è§„åˆ™æ ¡éªŒç”Ÿæ•ˆã€‚ { &quot;status&quot;: 400, &quot;message&quot;: &quot;ç”¨æˆ·åã€æ‰‹æœºå·ç ã€é‚®ç®±ä¸å…è®¸ä¸ç°å­˜ç”¨æˆ·é‡å¤&quot;, &quot;data&quot;: null, &quot;timestamp&quot;: 1644309081037 } å°ç»“ é€šè¿‡ä¸Šé¢å‡ æ­¥æ“ä½œï¼Œä¸šåŠ¡æ ¡éªŒä¾¿å’Œä¸šåŠ¡é€»è¾‘å°±å®Œå…¨åˆ†ç¦»å¼€æ¥ï¼Œåœ¨éœ€è¦æ ¡éªŒæ—¶ç”¨@Validatedæ³¨è§£è‡ªåŠ¨è§¦å‘ï¼Œæˆ–è€…é€šè¿‡ä»£ç æ‰‹åŠ¨è§¦å‘æ‰§è¡Œï¼Œå¯æ ¹æ®ä½ ä»¬é¡¹ç›®çš„è¦æ±‚ï¼Œå°†è¿™äº›æ³¨è§£åº”ç”¨äºæ§åˆ¶å™¨ã€æœåŠ¡å±‚ã€æŒä¹…å±‚ç­‰ä»»ä½•å±‚æ¬¡çš„ä»£ç ä¹‹ä¸­ã€‚ è¿™ç§æ–¹å¼æ¯”ä»»ä½•ä¸šåŠ¡è§„åˆ™æ ¡éªŒçš„æ–¹æ³•éƒ½ä¼˜é›…ï¼Œæ¨èå¤§å®¶åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ã€‚åœ¨å¼€å‘æ—¶å¯ä»¥å°†ä¸å¸¦ä¸šåŠ¡å«ä¹‰çš„æ ¼å¼æ ¡éªŒæ³¨è§£æ”¾åˆ° Bean çš„ç±»å®šä¹‰ä¹‹ä¸Šï¼Œå°†å¸¦ä¸šåŠ¡é€»è¾‘çš„æ ¡éªŒæ”¾åˆ° Bean çš„ç±»å®šä¹‰çš„å¤–é¢ã€‚è¿™ä¸¤è€…çš„åŒºåˆ«æ˜¯æ”¾åœ¨ç±»å®šä¹‰ä¸­çš„æ³¨è§£èƒ½å¤Ÿè‡ªåŠ¨è¿è¡Œï¼Œè€Œæ”¾åˆ°ç±»å¤–é¢åˆ™éœ€è¦åƒå‰é¢ä»£ç é‚£æ ·ï¼Œæ˜ç¡®æ ‡å‡ºæ³¨è§£æ—¶æ‰ä¼šè¿è¡Œã€‚ ","link":"https://tianxiawuhao.github.io/d4XUQj9K0/"},{"title":"WebFluxä¸WebMVCåŒºåˆ«","content":"åœ¨æ„å»ºå“åº”å¼ Web æœåŠ¡ä¸Šï¼ŒSpring 5 ä¸­å¼•å…¥äº†å…¨æ–°çš„ç¼–ç¨‹æ¡†æ¶ï¼Œé‚£å°±æ˜¯ Spring WebFluxã€‚ä½œä¸ºä¸€æ¬¾æ–°å‹çš„ Web æœåŠ¡å¼€å‘æ¡†æ¶ï¼Œå®ƒä¸ä¼ ç»Ÿçš„ WebMVC ç›¸æ¯”å…·ä½“æœ‰å“ªäº›ä¼˜åŠ¿å‘¢ï¼Ÿ Spring WebFlux çš„åº”ç”¨åœºæ™¯ WebFlux ç”¨äºæ„å»ºå“åº”å¼ Web æœåŠ¡ã€‚åœ¨è¯¦ç»†ä»‹ç» WebFlux ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¢³ç†ä¸€ä¸‹è¿™ä¸ªæ–°æ¡†æ¶çš„åº”ç”¨åœºæ™¯ï¼Œäº†è§£åº”ç”¨åœºæ™¯æ‰èƒ½å¸®åŠ©æˆ‘ä»¬å¯¹æ‰€è¦é‡‡ç”¨çš„æŠ€æœ¯ä½“ç³»åšå‡ºæ­£ç¡®çš„é€‰æ‹©ã€‚ å¾®æœåŠ¡æ¶æ„çš„å…´èµ·ä¸º WebFlux çš„åº”ç”¨æä¾›äº†ä¸€ä¸ªå¾ˆå¥½çš„åœºæ™¯ã€‚æˆ‘ä»¬çŸ¥é“åœ¨ä¸€ä¸ªå¾®æœåŠ¡ç³»ç»Ÿä¸­ï¼Œå­˜åœ¨æ•°åä¹ƒè‡³æ•°ç™¾ä¸ªç‹¬ç«‹çš„å¾®æœåŠ¡ï¼Œå®ƒä»¬ç›¸äº’é€šä¿¡ä»¥å®Œæˆå¤æ‚çš„ä¸šåŠ¡æµç¨‹ã€‚è¿™ä¸ªè¿‡ç¨‹åŠ¿å¿…ä¼šæ¶‰åŠå¤§é‡çš„ I/O æ“ä½œï¼Œå°¤å…¶æ˜¯é˜»å¡å¼ I/O æ“ä½œä¼šæ•´ä½“å¢åŠ ç³»ç»Ÿçš„å»¶è¿Ÿå¹¶é™ä½ååé‡ã€‚å¦‚æœèƒ½å¤Ÿåœ¨å¤æ‚çš„æµç¨‹ä¸­é›†æˆéé˜»å¡ã€å¼‚æ­¥é€šä¿¡æœºåˆ¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥é«˜æ•ˆå¤„ç†è·¨æœåŠ¡ä¹‹é—´çš„ç½‘ç»œè¯·æ±‚ã€‚é’ˆå¯¹è¿™ç§åœºæ™¯ï¼ŒWebFlux æ˜¯ä¸€ç§éå¸¸æœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚ ä» WebMVC åˆ° WebFlux æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è®¨è®º WebMVC ä¸ WebFlux ä¹‹é—´çš„å·®åˆ«ï¼Œè€Œè¿™äº›å·®åˆ«å®é™…ä¸Šæ­£æ˜¯ä½“ç°åœ¨ä» WebMVC åˆ° WebFlux çš„æ¼”è¿›è¿‡ç¨‹ä¸­ã€‚è®©æˆ‘ä»¬å…ˆä»ä¼ ç»Ÿçš„ Spring WebMVC æŠ€æœ¯æ ˆå¼€å§‹è¯´èµ·ã€‚ Spring WebMVCæŠ€æœ¯æ ˆ ä¸€èˆ¬è€Œè¨€ï¼ŒWeb è¯·æ±‚å¤„ç†æœºåˆ¶éƒ½ä¼šä½¿ç”¨â€œç®¡é“-è¿‡æ»¤å™¨ï¼ˆPipe-Filterï¼‰â€æ¶æ„æ¨¡å¼ï¼Œè€Œ Spring WebMVC ä½œä¸ºä¸€ç§å¤„ç† Web è¯·æ±‚çš„å…¸å‹å®ç°æ–¹æ¡ˆï¼ŒåŒæ ·ä½¿ç”¨äº† Servlet ä¸­çš„è¿‡æ»¤å™¨é“¾ï¼ˆFilterChainï¼‰æ¥å¯¹è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ æˆ‘ä»¬çŸ¥é“ WebMVC è¿è¡Œåœ¨ Servlet å®¹å™¨ä¸Šï¼Œè¿™äº›å®¹å™¨å¸¸ç”¨çš„åŒ…æ‹¬ Tomcatã€JBoss ç­‰ã€‚å½“ HTTP è¯·æ±‚é€šè¿‡ Servlet å®¹å™¨æ—¶å°±ä¼šè¢«è½¬æ¢ä¸ºä¸€ä¸ª ServletRequest å¯¹è±¡ï¼Œè€Œæœ€ç»ˆè¿”å›ä¸€ä¸ª ServletResponse å¯¹è±¡ï¼ŒFilterChain çš„å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºã€‚ public interface FilterChain { public void doFilter (ServletRequest request, ServletResponse response ) throws IOException, ServletException; } å½“ ServletRequest é€šè¿‡è¿‡æ»¤å™¨é“¾ä¸­æ‰€åŒ…å«çš„ä¸€ç³»åˆ—è¿‡æ»¤å™¨ä¹‹åï¼Œæœ€ç»ˆå°±ä¼šåˆ°è¾¾ä½œä¸ºå‰ç«¯æ§åˆ¶å™¨çš„ DispatcherServletã€‚DispatcherServlet æ˜¯ WebMVC çš„æ ¸å¿ƒç»„ä»¶ï¼Œæ‰©å±•äº† Servlet å¯¹è±¡ï¼Œå¹¶æŒæœ‰ä¸€ç»„ HandlerMapping å’Œ HandlerAdapterã€‚ å½“ ServletRequest è¯·æ±‚åˆ°è¾¾æ—¶ï¼ŒDispatcherServlet è´Ÿè´£æœç´¢ HandlerMapping å®ä¾‹å¹¶ä½¿ç”¨åˆé€‚çš„ HandlerAdapter å¯¹å…¶è¿›è¡Œé€‚é…ã€‚å…¶ä¸­ï¼ŒHandlerMapping çš„ä½œç”¨æ˜¯æ ¹æ®å½“å‰è¯·æ±‚æ‰¾åˆ°å¯¹åº”çš„å¤„ç†å™¨ Handlerï¼Œå®ƒåªå®šä¹‰äº†ä¸€ä¸ªæ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ public interface HandlerMapping { //æ‰¾åˆ°ä¸è¯·æ±‚å¯¹åº”çš„ Handlerï¼Œå°è£…ä¸ºä¸€ä¸ª HandlerExecutionChain è¿”å› HandlerExecutionChain getHandler(HttpServletRequest request) throws Exception; } è€Œ HandlerAdapter æ ¹æ®ç»™å®šçš„ HttpServletRequest å’Œ HttpServletResponse å¯¹è±¡çœŸæ­£è°ƒç”¨ç»™å®šçš„ Handlerï¼Œæ ¸å¿ƒæ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºã€‚ public interface HandlerAdapter { //é’ˆå¯¹ç»™å®šçš„è¯·æ±‚/å“åº”å¯¹è±¡è°ƒç”¨ç›®æ ‡ Handler ModelAndView handle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception; } åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼ŒDispatcherServlet ä¼šåœ¨åº”ç”¨ä¸Šä¸‹æ–‡ä¸­æœç´¢æ‰€æœ‰ HandlerMappingã€‚æ—¥å¸¸å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæœ€å¸¸ç”¨çš„ HandlerMapping åŒ…å« BeanNameUrlHandlerMapping å’Œ RequestMappingHandlerMappingï¼Œå‰è€…è´Ÿè´£æ£€æµ‹æ‰€æœ‰ Controller å¹¶æ ¹æ®è¯·æ±‚ URL çš„åŒ¹é…è§„åˆ™æ˜ å°„åˆ°å…·ä½“çš„ Controller å®ä¾‹ä¸Šï¼Œè€Œåè€…åŸºäº @RequestMapping æ³¨è§£æ¥æ‰¾åˆ°ç›®æ ‡ Controllerã€‚ å¦‚æœæˆ‘ä»¬ä½¿ç”¨äº† RequestMappingHandlerMappingï¼Œé‚£ä¹ˆå¯¹åº”çš„ HandlerAdapter å°±æ˜¯ RequestMappingHandlerAdapterï¼Œå®ƒè´Ÿè´£å°†ä¼ å…¥çš„ ServletRequest ç»‘å®šåˆ°æ·»åŠ äº† @RequestMapping æ³¨è§£çš„æ§åˆ¶å™¨æ–¹æ³•ä¸Šï¼Œä»è€Œå®ç°å¯¹è¯·æ±‚çš„æ­£ç¡®å“åº”ã€‚åŒæ—¶ï¼Œ HandlerAdapter è¿˜æä¾›è¯·æ±‚éªŒè¯å’Œå“åº”è½¬æ¢ç­‰è¾…åŠ©æ€§åŠŸèƒ½ï¼Œä½¿å¾— Spring WebMVC æ¡†æ¶åœ¨æ—¥å¸¸ Web å¼€å‘ä¸­éå¸¸å®ç”¨ã€‚ ä½œä¸ºæ€»ç»“ï¼Œæˆ‘æ¢³ç†äº† Spring WebMVC çš„æ•´ä½“æ¶æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ ä¸€ç›´ä»¥æ¥ï¼ŒSpring WebMVC æ˜¯æˆ‘ä»¬å¼€å‘ Web æœåŠ¡çš„ä¸»æµæ¡†æ¶ã€‚ä½†è¦æ³¨æ„çš„æ˜¯ï¼Œå°½ç®¡ Servlet æœ¬èº«åœ¨æ–°ç‰ˆæœ¬ä¸­æä¾›äº†å¼‚æ­¥éé˜»å¡çš„é€šä¿¡æœºåˆ¶ï¼Œä½† Spring WebMVC åœ¨å®ç°ä¸Šå¹¶ä¸å…è®¸åœ¨æ•´ä¸ªè¯·æ±‚ç”Ÿå‘½å‘¨æœŸä¸­éƒ½é‡‡ç”¨éé˜»å¡å¼çš„æ“ä½œæ–¹å¼ã€‚å› æ­¤ï¼ŒSpring åœ¨å°½é‡æ²¿ç”¨åŸæœ‰çš„å¼€å‘æ¨¡å¼ä»¥åŠ API è®¾è®¡ä¸Šæä¾›äº†æ”¯æŒå¼‚æ­¥éé˜»å¡çš„ Spring WebFlux æ¡†æ¶ã€‚ Spring WebFlux æŠ€æœ¯æ ˆ ä»‹ç»å®Œ Spring WebMVCï¼Œæˆ‘ä»¬æ¥è¯´è¯´ Spring WebFluxã€‚äº‹å®ä¸Šï¼Œå‰é¢ä»‹ç»çš„ HandlerMappingã€HandlerAdapter ç­‰ç»„ä»¶åœ¨ WebFlux é‡Œéƒ½æœ‰åŒåçš„å“åº”å¼ç‰ˆæœ¬ï¼Œè¿™æ˜¯ WebFlux çš„ä¸€ç§è®¾è®¡ç†å¿µï¼Œå³åœ¨æ—¢æœ‰è®¾è®¡çš„åŸºç¡€ä¸Šï¼Œæä¾›æ–°çš„å®ç°ç‰ˆæœ¬ï¼Œåªå¯¹éƒ¨åˆ†éœ€è¦å¢å¼ºå’Œå¼±åŒ–çš„åœ°æ–¹åšäº†è°ƒæ•´ã€‚ æˆ‘ä»¬å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªéœ€è¦è°ƒæ•´çš„åœ°æ–¹ï¼Œæ˜¾ç„¶ï¼Œæˆ‘ä»¬åº”è¯¥æ›¿æ¢æ‰åŸæœ‰çš„ Servlet API ä»¥ä¾¿èå…¥å“åº”å¼æµã€‚å› æ­¤ï¼Œåœ¨ WebFlux ä¸­ï¼Œä»£è¡¨è¯·æ±‚å’Œå“åº”çš„æ˜¯å…¨æ–°çš„ ServerHttpRequest å’Œ ServerHttpResponse å¯¹è±¡ã€‚ åŒæ ·ï¼ŒWebFlux ä¸­åŒæ ·æä¾›äº†ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ WebFilterChainï¼Œå®šä¹‰å¦‚ä¸‹ã€‚ public interface WebFilterChain { Mono&lt;Void&gt; filter(ServerWebExchange exchange); } è¿™é‡Œçš„ ServerWebExchange ç›¸å½“äºä¸€ä¸ªä¸Šä¸‹æ–‡å®¹å™¨ï¼Œä¿å­˜äº† ServerHttpRequestã€ServerHttpResponse ä»¥åŠä¸€äº›æ¡†æ¶è¿è¡Œæ—¶çŠ¶æ€ä¿¡æ¯ã€‚ åœ¨ WebFlux ä¸­ï¼Œå’Œ WebMVC ä¸­çš„ DispatcherServlet ç›¸å¯¹åº”çš„ç»„ä»¶æ˜¯ DispatcherHandlerã€‚ä¸ DispatcherServlet ç±»ä¼¼ï¼ŒDispatcherHandler åŒæ ·ä½¿ç”¨äº†ä¸€å¥—å“åº”å¼ç‰ˆæœ¬çš„ HandlerMapping å’Œ HandlerAdapter å®Œæˆå¯¹è¯·æ±‚çš„å¤„ç†ã€‚è¯·æ³¨æ„ï¼Œè¿™ä¸¤ä¸ªæ¥å£æ˜¯å®šä¹‰åœ¨ org.springframework.web.reactive åŒ…ä¸­ï¼Œè€Œä¸æ˜¯åœ¨åŸæœ‰çš„ org.springframework.web åŒ…ä¸­ã€‚å“åº”å¼ç‰ˆæœ¬çš„ HandlerMapping æ¥å£å®šä¹‰å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œè¿”å›çš„æ˜¯ä¸€ä¸ª Mono å¯¹è±¡ï¼Œä»è€Œå¯ç”¨äº†å“åº”å¼è¡Œä¸ºæ¨¡å¼ã€‚ public interface HandlerMapping { Mono&lt;Object&gt; getHandler(ServerWebExchange exchange); } åŒæ ·ï¼Œæˆ‘ä»¬æ‰¾åˆ°å“åº”å¼ç‰ˆæœ¬çš„ HandlerAdapterï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ public interface HandlerAdapter { Mono&lt;HandlerResult&gt; handle(ServerWebExchange exchange, Object handler); } å¯¹æ¯”éå“åº”å¼ç‰ˆæœ¬çš„ HandlerAdapterï¼Œè¿™é‡Œçš„ ServerWebExchange ä¸­åŒæ—¶åŒ…å«äº† ServerHttpRequest å’Œ ServerHttpResponse å¯¹è±¡ï¼Œè€Œ HandlerResult åˆ™ä»£è¡¨äº†å¤„ç†ç»“æœã€‚ç›¸æ¯” WebMVC ä¸­ ModelAndView è¿™ç§æ¯”è¾ƒæ¨¡ç³Šçš„è¿”å›ç»“æœï¼ŒHandlerResult æ›´åŠ ç›´æ¥å’Œæ˜ç¡®ã€‚ åœ¨ WebFlux ä¸­ï¼ŒåŒæ ·å®ç°äº†å“åº”å¼ç‰ˆæœ¬çš„ RequestMappingHandlerMapping å’Œ RequestMappingHandlerAdapterï¼Œå› æ­¤æˆ‘ä»¬ä»ç„¶å¯ä»¥é‡‡ç”¨æ³¨è§£çš„æ–¹æ³•æ¥æ„å»º Controllerã€‚å¦ä¸€æ–¹é¢ï¼ŒWebFlux ä¸­è¿˜æä¾›äº† RouterFunctionMapping å’Œ HandlerFunctionAdapter ç»„åˆï¼Œä¸“é—¨ç”¨æ¥æä¾›åŸºäºå‡½æ•°å¼ç¼–ç¨‹çš„å¼€å‘æ¨¡å¼ã€‚è¿™æ · Spring WebFlux çš„æ•´ä½“æ¶æ„å›¾å°±æ¼”å˜æˆè¿™æ ·ã€‚ è¯·æ³¨æ„ï¼Œåœ¨å¤„ç† HTTP è¯·æ±‚ä¸Šï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨æ”¯æŒå¼‚æ­¥éé˜»å¡çš„å“åº”å¼æœåŠ¡å™¨å¼•æ“ï¼Œå¸¸è§çš„åŒ…æ‹¬ Nettyã€Undertow ä»¥åŠæ”¯æŒ Servlet 3.1 åŠä»¥ä¸Šç‰ˆæœ¬çš„ Servlet å®¹å™¨ã€‚ å¯¹æ¯” WebFlux å’Œ WebMVC çš„å¤„ç†æ¨¡å‹ ç°åœ¨æˆ‘ä»¬å·²ç»æ˜ç¡®äº† WebMVC åˆ° WebFlux çš„æ¼”è¿›è¿‡ç¨‹ï¼Œä½†ä½ å¯èƒ½ä¼šé—®ï¼Œæ–°çš„ WebFlux è¦æ¯”ä¼ ç»Ÿ WebMVC å¥½åœ¨å“ªé‡Œå‘¢ï¼Ÿä»ä¸¤è€…çš„å¤„ç†æ¨¡å‹ä¸Šå…¥æ‰‹å¯ä»¥å¸®åŠ©ä½ å¾ˆå¥½åœ°ç†è§£è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸€ä¸‹ã€‚ WebFlux å’Œ Web MVC ä¸­çš„å¤„ç†æ¨¡å‹ é€šè¿‡å‰é¢çš„è®¨è®ºä½ å·²ç»çŸ¥é“ Servlet æ˜¯é˜»å¡å¼çš„ï¼Œæ‰€ä»¥ WebMVC å»ºç«‹åœ¨é˜»å¡ I/O ä¹‹ä¸Šï¼Œæˆ‘ä»¬æ¥åˆ†æè¿™ç§æ¨¡å‹ä¸‹çº¿ç¨‹å¤„ç†è¯·æ±‚çš„è¿‡ç¨‹ã€‚å‡è®¾æœ‰ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ä¼šå¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œæ‰€æœ‰è¯·æ±‚æ„æˆä¸€ä¸ªè¯·æ±‚é˜Ÿåˆ—ï¼Œå¹¶ç”±ä¸€ä¸ªçº¿ç¨‹æŒ‰é¡ºåºè¿›è¡Œå¤„ç†ã€‚é’ˆå¯¹ä¸€ä¸ªè¯·æ±‚ï¼Œçº¿ç¨‹éœ€è¦æ‰§è¡Œä¸¤éƒ¨åˆ†å·¥ä½œï¼Œé¦–å…ˆæ˜¯æ¥å—è¯·æ±‚ï¼Œç„¶åå†å¯¹å…¶è¿›è¡Œå¤„ç†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ï¼Œæ­£å¦‚ä½ å¯èƒ½æ³¨æ„åˆ°çš„ï¼Œå·¥ä½œçº¿ç¨‹çš„å®é™…å¤„ç†æ—¶é—´è¿œå°äºèŠ±è´¹åœ¨é˜»å¡æ“ä½œä¸Šçš„æ—¶é—´ã€‚è¿™æ„å‘³ç€å·¥ä½œçº¿ç¨‹ä¼šè¢« I/O è¯»å–æˆ–å†™å…¥æ•°æ®è¿™ä¸€æ“ä½œæ‰€é˜»å¡ã€‚ä»è¿™ä¸ªç®€å•çš„å›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼Œçº¿ç¨‹æ•ˆç‡ä½ä¸‹ã€‚åŒæ—¶ï¼Œå› ä¸ºæ‰€æœ‰è¯·æ±‚æ˜¯æ’é˜Ÿçš„ï¼Œç›¸å½“äºä¸€ä¸ªè¯·æ±‚é˜Ÿåˆ—ï¼Œæ‰€ä»¥æ¥å—è¯·æ±‚å’Œå¤„ç†è¯·æ±‚è¿™ä¸¤éƒ¨åˆ†æ“ä½œå®é™…ä¸Šæ˜¯å¯ä»¥å…±äº«ç­‰å¾…æ—¶é—´çš„ã€‚ ç›¸æ¯”ä¹‹ä¸‹ï¼ŒWebFlux æ„å»ºåœ¨éé˜»å¡ API ä¹‹ä¸Šï¼Œè¿™æ„å‘³ç€æ²¡æœ‰æ“ä½œéœ€è¦ä¸ I/O é˜»å¡çº¿ç¨‹è¿›è¡Œäº¤äº’ã€‚æ¥å—å’Œå¤„ç†è¯·æ±‚çš„æ•ˆç‡å¾ˆé«˜ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ å°†ä¸Šå›¾ä¸­æ‰€å±•ç¤ºçš„å¼‚æ­¥éé˜»å¡è¯·æ±‚å¤„ç†ä¸å‰é¢çš„é˜»å¡è¿‡ç¨‹è¿›è¡Œæ¯”è¾ƒï¼Œæˆ‘ä»¬ä¼šæ³¨æ„åˆ°ï¼Œç°åœ¨æ²¡æœ‰åœ¨è¯»å–è¯·æ±‚æ•°æ®æ—¶å‘ç”Ÿç­‰å¾…ï¼Œå·¥ä½œçº¿ç¨‹é«˜æ•ˆæ¥å—æ–°è¿æ¥ã€‚ç„¶åï¼Œæä¾›äº†éé˜»å¡ I/O æœºåˆ¶çš„åº•å±‚æ“ä½œç³»ç»Ÿä¼šå‘Šè¯‰æˆ‘ä»¬è¯·æ±‚æ•°æ®æ˜¯å¦å·²ç»æ¥æ”¶å®Œæˆï¼Œå¹¶ä¸”å¤„ç†å™¨å¯ä»¥åœ¨ä¸é˜»å¡çš„æƒ…å†µä¸‹è¿›è¡Œå¤„ç†ã€‚ ç±»ä¼¼çš„ï¼Œå†™å…¥å“åº”ç»“æœæ—¶åŒæ ·ä¸éœ€è¦é˜»å¡ï¼Œæ“ä½œç³»ç»Ÿä¼šåœ¨å‡†å¤‡å¥½å°†ä¸€éƒ¨åˆ†æ•°æ®éé˜»å¡åœ°å†™å…¥ I/O æ—¶é€šçŸ¥æˆ‘ä»¬ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±æ‹¥æœ‰äº†æœ€ä½³çš„ CPU åˆ©ç”¨ç‡ã€‚ å‰é¢çš„ç¤ºä¾‹å±•ç¤ºäº† WebFlux æ¯” WebMVC æ›´æœ‰æ•ˆåœ°åˆ©ç”¨ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œå› æ­¤å¯ä»¥åœ¨ç›¸åŒçš„æ—¶é—´å†…å¤„ç†æ›´å¤šçš„è¯·æ±‚ã€‚é‚£ä¹ˆï¼Œå¦‚æœæ˜¯åœ¨å¤šçº¿ç¨‹çš„åœºæ™¯ä¸‹ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸‹é¢è¿™å¼ å›¾ã€‚ ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œå¤šçº¿ç¨‹æ¨¡å‹å…è®¸æ›´å¿«åœ°å¤„ç†æ’é˜Ÿè¯·æ±‚ï¼Œèƒ½å¤ŸåŒæ—¶æ¥å—ã€å¤„ç†å’Œå“åº”å‡ ä¹ç›¸åŒæ•°é‡çš„è¯·æ±‚ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬æ˜ç™½å¤šçº¿ç¨‹æŠ€æœ¯æœ‰åˆ©æœ‰å¼Šã€‚å½“å¤„ç†ç”¨æˆ·è¯·æ±‚æ¶‰åŠå¤ªå¤šçš„çº¿ç¨‹å®ä¾‹æ—¶ï¼Œç›¸äº’ä¹‹é—´å°±éœ€è¦åè°ƒèµ„æºï¼Œè¿™æ˜¯ç”±äºå®ƒä»¬ä¹‹é—´çš„ä¸ä¸€è‡´æ€§ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚ ","link":"https://tianxiawuhao.github.io/OoSJ8O7Jf/"},{"title":"Spring Boot è‡ªå¸¦ Buff å·¥å…·ç±»","content":"æ–­è¨€ æ–­è¨€æ˜¯ä¸€ä¸ªé€»è¾‘åˆ¤æ–­ï¼Œç”¨äºæ£€æŸ¥ä¸åº”è¯¥å‘ç”Ÿçš„æƒ…å†µ Assert å…³é”®å­—åœ¨ JDK1.4 ä¸­å¼•å…¥ï¼Œå¯é€šè¿‡ JVM å‚æ•°-enableassertionså¼€å¯ SpringBoot ä¸­æä¾›äº† Assert æ–­è¨€å·¥å…·ç±»ï¼Œé€šå¸¸ç”¨äºæ•°æ®åˆæ³•æ€§æ£€æŸ¥ // è¦æ±‚å‚æ•° object å¿…é¡»ä¸ºéç©ºï¼ˆNot Nullï¼‰ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œä¸äºˆæ”¾è¡Œ // å‚æ•° message å‚æ•°ç”¨äºå®šåˆ¶å¼‚å¸¸ä¿¡æ¯ã€‚ void notNull(Object object, String message) // è¦æ±‚å‚æ•°å¿…é¡»ç©ºï¼ˆNullï¼‰ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œä¸äºˆã€æ”¾è¡Œã€ã€‚ // å’Œ notNull() æ–¹æ³•æ–­è¨€è§„åˆ™ç›¸å void isNull(Object object, String message) // è¦æ±‚å‚æ•°å¿…é¡»ä¸ºçœŸï¼ˆTrueï¼‰ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œä¸äºˆã€æ”¾è¡Œã€ã€‚ void isTrue(boolean expression, String message) // è¦æ±‚å‚æ•°ï¼ˆList/Setï¼‰å¿…é¡»éç©ºï¼ˆNot Emptyï¼‰ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œä¸äºˆæ”¾è¡Œ void notEmpty(Collection collection, String message) // è¦æ±‚å‚æ•°ï¼ˆStringï¼‰å¿…é¡»æœ‰é•¿åº¦ï¼ˆå³ï¼ŒNot Emptyï¼‰ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œä¸äºˆæ”¾è¡Œ void hasLength(String text, String message) // è¦æ±‚å‚æ•°ï¼ˆStringï¼‰å¿…é¡»æœ‰å†…å®¹ï¼ˆå³ï¼ŒNot Blankï¼‰ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œä¸äºˆæ”¾è¡Œ void hasText(String text, String message) // è¦æ±‚å‚æ•°æ˜¯æŒ‡å®šç±»å‹çš„å®ä¾‹ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œä¸äºˆæ”¾è¡Œ void isInstanceOf(Class type, Object obj, String message) // è¦æ±‚å‚æ•° `subType` å¿…é¡»æ˜¯å‚æ•° superType çš„å­ç±»æˆ–å®ç°ç±»ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œä¸äºˆæ”¾è¡Œ void isAssignable(Class superType, Class subType, String message) å¯¹è±¡ã€æ•°ç»„ã€é›†åˆ ObjectUtils è·å–å¯¹è±¡çš„åŸºæœ¬ä¿¡æ¯ // è·å–å¯¹è±¡çš„ç±»åã€‚å‚æ•°ä¸º null æ—¶ï¼Œè¿”å›å­—ç¬¦ä¸²ï¼š&quot;null&quot; String nullSafeClassName(Object obj) // å‚æ•°ä¸º null æ—¶ï¼Œè¿”å› 0 int nullSafeHashCode(Object object) // å‚æ•°ä¸º null æ—¶ï¼Œè¿”å›å­—ç¬¦ä¸²ï¼š&quot;null&quot; String nullSafeToString(boolean[] array) // è·å–å¯¹è±¡ HashCodeï¼ˆåå…­è¿›åˆ¶å½¢å¼å­—ç¬¦ä¸²ï¼‰ã€‚å‚æ•°ä¸º null æ—¶ï¼Œè¿”å› 0 String getIdentityHexString(Object obj) // è·å–å¯¹è±¡çš„ç±»åå’Œ HashCodeã€‚ å‚æ•°ä¸º null æ—¶ï¼Œè¿”å›å­—ç¬¦ä¸²ï¼š&quot;&quot; String identityToString(Object obj) // ç›¸å½“äº toString()æ–¹æ³•ï¼Œä½†å‚æ•°ä¸º null æ—¶ï¼Œè¿”å›å­—ç¬¦ä¸²ï¼š&quot;&quot; String getDisplayString(Object obj) åˆ¤æ–­å·¥å…· // åˆ¤æ–­æ•°ç»„æ˜¯å¦ä¸ºç©º boolean isEmpty(Object[] array) // åˆ¤æ–­å‚æ•°å¯¹è±¡æ˜¯å¦æ˜¯æ•°ç»„ boolean isArray(Object obj) // åˆ¤æ–­æ•°ç»„ä¸­æ˜¯å¦åŒ…å«æŒ‡å®šå…ƒç´  boolean containsElement(Object[] array, Object element) // ç›¸ç­‰ï¼Œæˆ–åŒä¸º nullæ—¶ï¼Œè¿”å› true boolean nullSafeEquals(Object o1, Object o2) /* åˆ¤æ–­å‚æ•°å¯¹è±¡æ˜¯å¦ä¸ºç©ºï¼Œåˆ¤æ–­æ ‡å‡†ä¸ºï¼š Optional: Optional.empty() Array: length == 0 CharSequence: length == 0 Collection: Collection.isEmpty() Map: Map.isEmpty() */ boolean isEmpty(Object obj) å…¶ä»–å·¥å…·æ–¹æ³• // å‘å‚æ•°æ•°ç»„çš„æœ«å°¾è¿½åŠ æ–°å…ƒç´ ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°æ•°ç»„ &lt;A, O extends A&gt; A[] addObjectToArray(A[] array, O obj) // åŸç”ŸåŸºç¡€ç±»å‹æ•°ç»„ --&gt; åŒ…è£…ç±»æ•°ç»„ Object[] toObjectArray(Object source) StringUtils å­—ç¬¦ä¸²åˆ¤æ–­å·¥å…· // åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä¸º nullï¼Œæˆ– &quot;&quot;ã€‚æ³¨æ„ï¼ŒåŒ…å«ç©ºç™½ç¬¦çš„å­—ç¬¦ä¸²ä¸ºéç©º boolean isEmpty(Object str) // åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦æ˜¯ä»¥æŒ‡å®šå†…å®¹ç»“æŸã€‚å¿½ç•¥å¤§å°å†™ boolean endsWithIgnoreCase(String str, String suffix) // åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦å·²æŒ‡å®šå†…å®¹å¼€å¤´ã€‚å¿½ç•¥å¤§å°å†™ boolean startsWithIgnoreCase(String str, String prefix) // æ˜¯å¦åŒ…å«ç©ºç™½ç¬¦ boolean containsWhitespace(String str) // åˆ¤æ–­å­—ç¬¦ä¸²éç©ºä¸”é•¿åº¦ä¸ä¸º 0ï¼Œå³ï¼ŒNot Empty boolean hasLength(CharSequence str) // åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦åŒ…å«å®é™…å†…å®¹ï¼Œå³éä»…åŒ…å«ç©ºç™½ç¬¦ï¼Œä¹Ÿå°±æ˜¯ Not Blank boolean hasText(CharSequence str) // åˆ¤æ–­å­—ç¬¦ä¸²æŒ‡å®šç´¢å¼•å¤„æ˜¯å¦åŒ…å«ä¸€ä¸ªå­ä¸²ã€‚ boolean substringMatch(CharSequence str, int index, CharSequence substring) // è®¡ç®—ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­æŒ‡å®šå­ä¸²çš„å‡ºç°æ¬¡æ•° int countOccurrencesOf(String str, String sub) å­—ç¬¦ä¸²æ“ä½œå·¥å…· // æŸ¥æ‰¾å¹¶æ›¿æ¢æŒ‡å®šå­ä¸² String replace(String inString, String oldPattern, String newPattern) // å»é™¤å°¾éƒ¨çš„ç‰¹å®šå­—ç¬¦ String trimTrailingCharacter(String str, char trailingCharacter) // å»é™¤å¤´éƒ¨çš„ç‰¹å®šå­—ç¬¦ String trimLeadingCharacter(String str, char leadingCharacter) // å»é™¤å¤´éƒ¨çš„ç©ºç™½ç¬¦ String trimLeadingWhitespace(String str) // å»é™¤å¤´éƒ¨çš„ç©ºç™½ç¬¦ String trimTrailingWhitespace(String str) // å»é™¤å¤´éƒ¨å’Œå°¾éƒ¨çš„ç©ºç™½ç¬¦ String trimWhitespace(String str) // åˆ é™¤å¼€å¤´ã€ç»“å°¾å’Œä¸­é—´çš„ç©ºç™½ç¬¦ String trimAllWhitespace(String str) // åˆ é™¤æŒ‡å®šå­ä¸² String delete(String inString, String pattern) // åˆ é™¤æŒ‡å®šå­—ç¬¦ï¼ˆå¯ä»¥æ˜¯å¤šä¸ªï¼‰ String deleteAny(String inString, String charsToDelete) // å¯¹æ•°ç»„çš„æ¯ä¸€é¡¹æ‰§è¡Œ trim() æ–¹æ³• String[] trimArrayElements(String[] array) // å°† URL å­—ç¬¦ä¸²è¿›è¡Œè§£ç  String uriDecode(String source, Charset charset) è·¯å¾„ç›¸å…³å·¥å…·æ–¹æ³• // è§£æè·¯å¾„å­—ç¬¦ä¸²ï¼Œä¼˜åŒ–å…¶ä¸­çš„ â€œ..â€ String cleanPath(String path) // è§£æè·¯å¾„å­—ç¬¦ä¸²ï¼Œè§£æå‡ºæ–‡ä»¶åéƒ¨åˆ† String getFilename(String path) // è§£æè·¯å¾„å­—ç¬¦ä¸²ï¼Œè§£æå‡ºæ–‡ä»¶åç¼€å String getFilenameExtension(String path) // æ¯”è¾ƒä¸¤ä¸ªä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯åŒä¸€ä¸ªè·¯å¾„ã€‚ä¼šè‡ªåŠ¨å¤„ç†è·¯å¾„ä¸­çš„ â€œ..â€ boolean pathEquals(String path1, String path2) // åˆ é™¤æ–‡ä»¶è·¯å¾„åä¸­çš„åç¼€éƒ¨åˆ† String stripFilenameExtension(String path) // ä»¥ â€œ. ä½œä¸ºåˆ†éš”ç¬¦ï¼Œè·å–å…¶æœ€åä¸€éƒ¨åˆ† String unqualify(String qualifiedName) // ä»¥æŒ‡å®šå­—ç¬¦ä½œä¸ºåˆ†éš”ç¬¦ï¼Œè·å–å…¶æœ€åä¸€éƒ¨åˆ† String unqualify(String qualifiedName, char separator) CollectionUtils é›†åˆåˆ¤æ–­å·¥å…· // åˆ¤æ–­ List/Set æ˜¯å¦ä¸ºç©º boolean isEmpty(Collection&lt;?&gt; collection) // åˆ¤æ–­ Map æ˜¯å¦ä¸ºç©º boolean isEmpty(Map&lt;?,?&gt; map) // åˆ¤æ–­ List/Set ä¸­æ˜¯å¦åŒ…å«æŸä¸ªå¯¹è±¡ boolean containsInstance(Collection&lt;?&gt; collection, Object element) // ä»¥è¿­ä»£å™¨çš„æ–¹å¼ï¼Œåˆ¤æ–­ List/Set ä¸­æ˜¯å¦åŒ…å«æŸä¸ªå¯¹è±¡ boolean contains(Iterator&lt;?&gt; iterator, Object element) // åˆ¤æ–­ List/Set æ˜¯å¦åŒ…å«æŸäº›å¯¹è±¡ä¸­çš„ä»»æ„ä¸€ä¸ª boolean containsAny(Collection&lt;?&gt; source, Collection&lt;?&gt; candidates) // åˆ¤æ–­ List/Set ä¸­çš„æ¯ä¸ªå…ƒç´ æ˜¯å¦å”¯ä¸€ã€‚å³ List/Set ä¸­ä¸å­˜åœ¨é‡å¤å…ƒç´  boolean hasUniqueObject(Collection&lt;?&gt; collection) é›†åˆæ“ä½œå·¥å…· // å°† Array ä¸­çš„å…ƒç´ éƒ½æ·»åŠ åˆ° List/Set ä¸­ &lt;E&gt; void mergeArrayIntoCollection(Object array, Collection&lt;E&gt; collection) // å°† Properties ä¸­çš„é”®å€¼å¯¹éƒ½æ·»åŠ åˆ° Map ä¸­ &lt;K,V&gt; void mergePropertiesIntoMap(Properties props, Map&lt;K,V&gt; map) // è¿”å› List ä¸­æœ€åä¸€ä¸ªå…ƒç´  &lt;T&gt; T lastElement(List&lt;T&gt; list) // è¿”å› Set ä¸­æœ€åä¸€ä¸ªå…ƒç´  &lt;T&gt; T lastElement(Set&lt;T&gt; set) // è¿”å›å‚æ•° candidates ä¸­ç¬¬ä¸€ä¸ªå­˜åœ¨äºå‚æ•° source ä¸­çš„å…ƒç´  &lt;E&gt; E findFirstMatch(Collection&lt;?&gt; source, Collection&lt;E&gt; candidates) // è¿”å› List/Set ä¸­æŒ‡å®šç±»å‹çš„å…ƒç´ ã€‚ &lt;T&gt; T findValueOfType(Collection&lt;?&gt; collection, Class&lt;T&gt; type) // è¿”å› List/Set ä¸­æŒ‡å®šç±»å‹çš„å…ƒç´ ã€‚å¦‚æœç¬¬ä¸€ç§ç±»å‹æœªæ‰¾åˆ°ï¼Œåˆ™æŸ¥æ‰¾ç¬¬äºŒç§ç±»å‹ï¼Œä»¥æ­¤ç±»æ¨ Object findValueOfType(Collection&lt;?&gt; collection, Class&lt;?&gt;[] types) // è¿”å› List/Set ä¸­å…ƒç´ çš„ç±»å‹ Class&lt;?&gt; findCommonElementType(Collection&lt;?&gt; collection) æ–‡ä»¶ã€èµ„æºã€IO æµ FileCopyUtils è¾“å…¥ // ä»æ–‡ä»¶ä¸­è¯»å…¥åˆ°å­—èŠ‚æ•°ç»„ä¸­ byte[] copyToByteArray(File in) // ä»è¾“å…¥æµä¸­è¯»å…¥åˆ°å­—èŠ‚æ•°ç»„ä¸­ byte[] copyToByteArray(InputStream in) // ä»è¾“å…¥æµä¸­è¯»å…¥åˆ°å­—ç¬¦ä¸²ä¸­ String copyToString(Reader in) è¾“å‡º // ä»å­—èŠ‚æ•°ç»„åˆ°æ–‡ä»¶ void copy(byte[] in, File out) // ä»æ–‡ä»¶åˆ°æ–‡ä»¶ int copy(File in, File out) // ä»å­—èŠ‚æ•°ç»„åˆ°è¾“å‡ºæµ void copy(byte[] in, OutputStream out) // ä»è¾“å…¥æµåˆ°è¾“å‡ºæµ int copy(InputStream in, OutputStream out) // ä»è¾“å…¥æµåˆ°è¾“å‡ºæµ int copy(Reader in, Writer out) // ä»å­—ç¬¦ä¸²åˆ°è¾“å‡ºæµ void copy(String in, Writer out) ResourceUtils ä»èµ„æºè·¯å¾„è·å–æ–‡ä»¶ // åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦æ˜¯ä¸€ä¸ªåˆæ³•çš„ URL å­—ç¬¦ä¸²ã€‚ static boolean isUrl(String resourceLocation) // è·å– URL static URL getURL(String resourceLocation) // è·å–æ–‡ä»¶ï¼ˆåœ¨ JAR åŒ…å†…æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼Œéœ€è¦æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ–‡ä»¶ï¼‰ static File getFile(String resourceLocation) Resource // æ–‡ä»¶ç³»ç»Ÿèµ„æº D:\\... FileSystemResource // URL èµ„æºï¼Œå¦‚ file://... http://... UrlResource // ç±»è·¯å¾„ä¸‹çš„èµ„æºï¼Œclasspth:... ClassPathResource // Web å®¹å™¨ä¸Šä¸‹æ–‡ä¸­çš„èµ„æºï¼ˆjar åŒ…ã€war åŒ…ï¼‰ ServletContextResource å¤åˆ¶ä»£ç  // åˆ¤æ–­èµ„æºæ˜¯å¦å­˜åœ¨ boolean exists() // ä»èµ„æºä¸­è·å¾— File å¯¹è±¡ File getFile() // ä»èµ„æºä¸­è·å¾— URI å¯¹è±¡ URI getURI() // ä»èµ„æºä¸­è·å¾— URI å¯¹è±¡ URL getURL() // è·å¾—èµ„æºçš„ InputStream InputStream getInputStream() // è·å¾—èµ„æºçš„æè¿°ä¿¡æ¯ String getDescription() StreamUtils è¾“å…¥ void copy(byte[] in, OutputStream out) int copy(InputStream in, OutputStream out) void copy(String in, Charset charset, OutputStream out) long copyRange(InputStream in, OutputStream out, long start, long end) è¾“å‡º byte[] copyToByteArray(InputStream in) String copyToString(InputStream in, Charset charset) // èˆå¼ƒè¾“å…¥æµä¸­çš„å†…å®¹ int drain(InputStream in) åå°„ã€AOP ReflectionUtils è·å–æ–¹æ³• // åœ¨ç±»ä¸­æŸ¥æ‰¾æŒ‡å®šæ–¹æ³• Method findMethod(Class&lt;?&gt; clazz, String name) // åŒä¸Šï¼Œé¢å¤–æä¾›æ–¹æ³•å‚æ•°ç±»å‹ä½œæŸ¥æ‰¾æ¡ä»¶ Method findMethod(Class&lt;?&gt; clazz, String name, Class&lt;?&gt;... paramTypes) // è·å¾—ç±»ä¸­æ‰€æœ‰æ–¹æ³•ï¼ŒåŒ…æ‹¬ç»§æ‰¿è€Œæ¥çš„ Method[] getAllDeclaredMethods(Class&lt;?&gt; leafClass) // åœ¨ç±»ä¸­æŸ¥æ‰¾æŒ‡å®šæ„é€ æ–¹æ³• Constructor&lt;T&gt; accessibleConstructor(Class&lt;T&gt; clazz, Class&lt;?&gt;... parameterTypes) // æ˜¯å¦æ˜¯ equals() æ–¹æ³• boolean isEqualsMethod(Method method) // æ˜¯å¦æ˜¯ hashCode() æ–¹æ³• boolean isHashCodeMethod(Method method) // æ˜¯å¦æ˜¯ toString() æ–¹æ³• boolean isToStringMethod(Method method) // æ˜¯å¦æ˜¯ä» Object ç±»ç»§æ‰¿è€Œæ¥çš„æ–¹æ³• boolean isObjectMethod(Method method) // æ£€æŸ¥ä¸€ä¸ªæ–¹æ³•æ˜¯å¦å£°æ˜æŠ›å‡ºæŒ‡å®šå¼‚å¸¸ boolean declaresException(Method method, Class&lt;?&gt; exceptionType) æ‰§è¡Œæ–¹æ³• // æ‰§è¡Œæ–¹æ³• Object invokeMethod(Method method, Object target) // åŒä¸Šï¼Œæä¾›æ–¹æ³•å‚æ•° Object invokeMethod(Method method, Object target, Object... args) // å–æ¶ˆ Java æƒé™æ£€æŸ¥ã€‚ä»¥ä¾¿åç»­æ‰§è¡Œè¯¥ç§æœ‰æ–¹æ³• void makeAccessible(Method method) // å–æ¶ˆ Java æƒé™æ£€æŸ¥ã€‚ä»¥ä¾¿åç»­æ‰§è¡Œç§æœ‰æ„é€ æ–¹æ³• void makeAccessible(Constructor&lt;?&gt; ctor) è·å–å­—æ®µ // åœ¨ç±»ä¸­æŸ¥æ‰¾æŒ‡å®šå±æ€§ Field findField(Class&lt;?&gt; clazz, String name) // åŒä¸Šï¼Œå¤šæä¾›äº†å±æ€§çš„ç±»å‹ Field findField(Class&lt;?&gt; clazz, String name, Class&lt;?&gt; type) // æ˜¯å¦ä¸ºä¸€ä¸ª &quot;public static final&quot; å±æ€§ boolean isPublicStaticFinal(Field field) è®¾ç½®å­—æ®µ // è·å– target å¯¹è±¡çš„ field å±æ€§å€¼ Object getField(Field field, Object target) // è®¾ç½® target å¯¹è±¡çš„ field å±æ€§å€¼ï¼Œå€¼ä¸º value void setField(Field field, Object target, Object value) // åŒç±»å¯¹è±¡å±æ€§å¯¹ç­‰èµ‹å€¼ void shallowCopyFieldState(Object src, Object dest) // å–æ¶ˆ Java çš„æƒé™æ§åˆ¶æ£€æŸ¥ã€‚ä»¥ä¾¿åç»­è¯»å†™è¯¥ç§æœ‰å±æ€§ void makeAccessible(Field field) // å¯¹ç±»çš„æ¯ä¸ªå±æ€§æ‰§è¡Œ callback void doWithFields(Class&lt;?&gt; clazz, ReflectionUtils.FieldCallback fc) // åŒä¸Šï¼Œå¤šäº†ä¸ªå±æ€§è¿‡æ»¤åŠŸèƒ½ã€‚ void doWithFields(Class&lt;?&gt; clazz, ReflectionUtils.FieldCallback fc, ReflectionUtils.FieldFilter ff) // åŒä¸Šï¼Œä½†ä¸åŒ…æ‹¬ç»§æ‰¿è€Œæ¥çš„å±æ€§ void doWithLocalFields(Class&lt;?&gt; clazz, ReflectionUtils.FieldCallback fc) AopUtils åˆ¤æ–­ä»£ç†ç±»å‹ // åˆ¤æ–­æ˜¯ä¸æ˜¯ Spring ä»£ç†å¯¹è±¡ boolean isAopProxy() // åˆ¤æ–­æ˜¯ä¸æ˜¯ jdk åŠ¨æ€ä»£ç†å¯¹è±¡ isJdkDynamicProxy() // åˆ¤æ–­æ˜¯ä¸æ˜¯ CGLIB ä»£ç†å¯¹è±¡ boolean isCglibProxy() è·å–è¢«ä»£ç†å¯¹è±¡çš„ class // è·å–è¢«ä»£ç†çš„ç›®æ ‡ class Class&lt;?&gt; getTargetClass() AopContext è·å–å½“å‰å¯¹è±¡çš„ä»£ç†å¯¹è±¡ Object currentProxy() ","link":"https://tianxiawuhao.github.io/I1j63ouUN/"},{"title":"nginx.confä¸­æ–‡è¯¦è§£","content":"#å®šä¹‰Nginxè¿è¡Œçš„ç”¨æˆ·å’Œç”¨æˆ·ç»„ user www www; #nginxè¿›ç¨‹æ•°ï¼Œå»ºè®®è®¾ç½®ä¸ºç­‰äºCPUæ€»æ ¸å¿ƒæ•°ã€‚ worker_processes 8; #å…¨å±€é”™è¯¯æ—¥å¿—å®šä¹‰ç±»å‹ï¼Œ[ debug | info | notice | warn | error | crit ] error_log /usr/local/nginx/logs/error.log info; #è¿›ç¨‹pidæ–‡ä»¶ pid /usr/local/nginx/logs/nginx.pid; #æŒ‡å®šè¿›ç¨‹å¯ä»¥æ‰“å¼€çš„æœ€å¤§æè¿°ç¬¦ï¼šæ•°ç›® #å·¥ä½œæ¨¡å¼ä¸è¿æ¥æ•°ä¸Šé™ #è¿™ä¸ªæŒ‡ä»¤æ˜¯æŒ‡å½“ä¸€ä¸ªnginxè¿›ç¨‹æ‰“å¼€çš„æœ€å¤šæ–‡ä»¶æè¿°ç¬¦æ•°ç›®ï¼Œç†è®ºå€¼åº”è¯¥æ˜¯æœ€å¤šæ‰“å¼€æ–‡ä»¶æ•°ï¼ˆulimit -nï¼‰ä¸nginxè¿›ç¨‹æ•°ç›¸é™¤ï¼Œä½†æ˜¯nginxåˆ†é…è¯·æ±‚å¹¶ä¸æ˜¯é‚£ä¹ˆå‡åŒ€ï¼Œæ‰€ä»¥æœ€å¥½ä¸ulimit -n çš„å€¼ä¿æŒä¸€è‡´ã€‚ #ç°åœ¨åœ¨linux 2.6å†…æ ¸ä¸‹å¼€å¯æ–‡ä»¶æ‰“å¼€æ•°ä¸º65535ï¼Œworker_rlimit_nofileå°±ç›¸åº”åº”è¯¥å¡«å†™65535ã€‚ #è¿™æ˜¯å› ä¸ºnginxè°ƒåº¦æ—¶åˆ†é…è¯·æ±‚åˆ°è¿›ç¨‹å¹¶ä¸æ˜¯é‚£ä¹ˆçš„å‡è¡¡ï¼Œæ‰€ä»¥å‡å¦‚å¡«å†™10240ï¼Œæ€»å¹¶å‘é‡è¾¾åˆ°3-4ä¸‡æ—¶å°±æœ‰è¿›ç¨‹å¯èƒ½è¶…è¿‡10240äº†ï¼Œè¿™æ—¶ä¼šè¿”å›502é”™è¯¯ã€‚ worker_rlimit_nofile 65535; events{ â€‹ #å‚è€ƒäº‹ä»¶æ¨¡å‹ï¼Œuse [ kqueue | rtsig | epoll | /dev/poll | select | poll ]; epollæ¨¡å‹ â€‹ #æ˜¯Linux 2.6ä»¥ä¸Šç‰ˆæœ¬å†…æ ¸ä¸­çš„é«˜æ€§èƒ½ç½‘ç»œI/Oæ¨¡å‹ï¼Œlinuxå»ºè®®epollï¼Œå¦‚æœè·‘åœ¨FreeBSDä¸Šé¢ï¼Œå°±ç”¨kqueueæ¨¡å‹ã€‚ â€‹ #è¡¥å……è¯´æ˜ï¼š â€‹ #ä¸apacheç›¸ç±»ï¼Œnginxé’ˆå¯¹ä¸åŒçš„æ“ä½œç³»ç»Ÿï¼Œæœ‰ä¸åŒçš„äº‹ä»¶æ¨¡å‹ â€‹ #Aï¼‰æ ‡å‡†äº‹ä»¶æ¨¡å‹ â€‹ #Selectã€pollå±äºæ ‡å‡†äº‹ä»¶æ¨¡å‹ï¼Œå¦‚æœå½“å‰ç³»ç»Ÿä¸å­˜åœ¨æ›´æœ‰æ•ˆçš„æ–¹æ³•ï¼Œnginxä¼šé€‰æ‹©selectæˆ–poll â€‹ #Bï¼‰é«˜æ•ˆäº‹ä»¶æ¨¡å‹ â€‹ #Kqueueï¼šä½¿ç”¨äºFreeBSD 4.1+, OpenBSD 2.9+, NetBSD 2.0 å’Œ MacOS X.ä½¿ç”¨åŒå¤„ç†å™¨çš„MacOS Xç³»ç»Ÿä½¿ç”¨kqueueå¯èƒ½ä¼šé€ æˆå†…æ ¸å´©æºƒã€‚ â€‹ #Epollï¼šä½¿ç”¨äºLinuxå†…æ ¸2.6ç‰ˆæœ¬åŠä»¥åçš„ç³»ç»Ÿã€‚ â€‹ #/dev/pollï¼šä½¿ç”¨äºSolaris 7 11/99+ï¼ŒHP/UX 11.22+ (eventport)ï¼ŒIRIX 6.5.15+ å’Œ Tru64 UNIX 5.1A+ã€‚ â€‹ #Eventportï¼šä½¿ç”¨äºSolaris 10ã€‚ ä¸ºäº†é˜²æ­¢å‡ºç°å†…æ ¸å´©æºƒçš„é—®é¢˜ï¼Œ æœ‰å¿…è¦å®‰è£…å®‰å…¨è¡¥ä¸ã€‚ â€‹ use epoll; â€‹ #å•ä¸ªè¿›ç¨‹æœ€å¤§è¿æ¥æ•°ï¼ˆæœ€å¤§è¿æ¥æ•°=è¿æ¥æ•°*è¿›ç¨‹æ•°ï¼‰ â€‹ #æ ¹æ®ç¡¬ä»¶è°ƒæ•´ï¼Œå’Œå‰é¢å·¥ä½œè¿›ç¨‹é…åˆèµ·æ¥ç”¨ï¼Œå°½é‡å¤§ï¼Œä½†æ˜¯åˆ«æŠŠcpuè·‘åˆ°100%å°±è¡Œã€‚æ¯ä¸ªè¿›ç¨‹å…è®¸çš„æœ€å¤šè¿æ¥æ•°ï¼Œç†è®ºä¸Šæ¯å°nginxæœåŠ¡å™¨çš„æœ€å¤§è¿æ¥æ•°ä¸ºã€‚ â€‹ worker_connections 65535; â€‹ #keepaliveè¶…æ—¶æ—¶é—´ã€‚ â€‹ keepalive_timeout 60; â€‹ #å®¢æˆ·ç«¯è¯·æ±‚å¤´éƒ¨çš„ç¼“å†²åŒºå¤§å°ã€‚è¿™ä¸ªå¯ä»¥æ ¹æ®ä½ çš„ç³»ç»Ÿåˆ†é¡µå¤§å°æ¥è®¾ç½®ï¼Œä¸€èˆ¬ä¸€ä¸ªè¯·æ±‚å¤´çš„å¤§å°ä¸ä¼šè¶…è¿‡1kï¼Œä¸è¿‡ç”±äºä¸€èˆ¬ç³»ç»Ÿåˆ†é¡µéƒ½è¦å¤§äº1kï¼Œæ‰€ä»¥è¿™é‡Œè®¾ç½®ä¸ºåˆ†é¡µå¤§å°ã€‚ â€‹ #åˆ†é¡µå¤§å°å¯ä»¥ç”¨å‘½ä»¤getconf PAGESIZE å–å¾—ã€‚ â€‹ #[root@web001 ~]# getconf PAGESIZE â€‹ #4096 â€‹ #ä½†ä¹Ÿæœ‰client_header_buffer_sizeè¶…è¿‡4kçš„æƒ…å†µï¼Œä½†æ˜¯client_header_buffer_sizeè¯¥å€¼å¿…é¡»è®¾ç½®ä¸ºâ€œç³»ç»Ÿåˆ†é¡µå¤§å°â€çš„æ•´å€æ•°ã€‚ â€‹ client_header_buffer_size 4k; â€‹ #è¿™ä¸ªå°†ä¸ºæ‰“å¼€æ–‡ä»¶æŒ‡å®šç¼“å­˜ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰å¯ç”¨çš„ï¼ŒmaxæŒ‡å®šç¼“å­˜æ•°é‡ï¼Œå»ºè®®å’Œæ‰“å¼€æ–‡ä»¶æ•°ä¸€è‡´ï¼Œinactiveæ˜¯æŒ‡ç»è¿‡å¤šé•¿æ—¶é—´æ–‡ä»¶æ²¡è¢«è¯·æ±‚ååˆ é™¤ç¼“å­˜ã€‚ â€‹ open_file_cache max=65535 inactive=60s; â€‹ #è¿™ä¸ªæ˜¯æŒ‡å¤šé•¿æ—¶é—´æ£€æŸ¥ä¸€æ¬¡ç¼“å­˜çš„æœ‰æ•ˆä¿¡æ¯ã€‚ â€‹ #è¯­æ³•:open_file_cache_valid time é»˜è®¤å€¼:open_file_cache_valid 60 ä½¿ç”¨å­—æ®µ:http, server, location è¿™ä¸ªæŒ‡ä»¤æŒ‡å®šäº†ä½•æ—¶éœ€è¦æ£€æŸ¥open_file_cacheä¸­ç¼“å­˜é¡¹ç›®çš„æœ‰æ•ˆä¿¡æ¯. â€‹ open_file_cache_valid 80s; â€‹ #open_file_cacheæŒ‡ä»¤ä¸­çš„inactiveå‚æ•°æ—¶é—´å†…æ–‡ä»¶çš„æœ€å°‘ä½¿ç”¨æ¬¡æ•°ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªæ•°å­—ï¼Œæ–‡ä»¶æè¿°ç¬¦ä¸€ç›´æ˜¯åœ¨ç¼“å­˜ä¸­æ‰“å¼€çš„ï¼Œå¦‚ä¸Šä¾‹ï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ–‡ä»¶åœ¨inactiveæ—¶é—´å†…ä¸€æ¬¡æ²¡è¢«ä½¿ç”¨ï¼Œå®ƒå°†è¢«ç§»é™¤ã€‚ â€‹ #è¯­æ³•:open_file_cache_min_uses number é»˜è®¤å€¼:open_file_cache_min_uses 1 ä½¿ç”¨å­—æ®µ:http, server, location è¿™ä¸ªæŒ‡ä»¤æŒ‡å®šäº†åœ¨open_file_cacheæŒ‡ä»¤æ— æ•ˆçš„å‚æ•°ä¸­ä¸€å®šçš„æ—¶é—´èŒƒå›´å†…å¯ä»¥ä½¿ç”¨çš„æœ€å°æ–‡ä»¶æ•°,å¦‚æœä½¿ç”¨æ›´å¤§çš„å€¼,æ–‡ä»¶æè¿°ç¬¦åœ¨cacheä¸­æ€»æ˜¯æ‰“å¼€çŠ¶æ€. â€‹ open_file_cache_min_uses 1; â€‹ #è¯­æ³•:open_file_cache_errors on | off é»˜è®¤å€¼:open_file_cache_errors off ä½¿ç”¨å­—æ®µ:http, server, location è¿™ä¸ªæŒ‡ä»¤æŒ‡å®šæ˜¯å¦åœ¨æœç´¢ä¸€ä¸ªæ–‡ä»¶æ—¶è®°å½•cacheé”™è¯¯. â€‹ open_file_cache_errors on; } #è®¾å®šhttpæœåŠ¡å™¨ï¼Œåˆ©ç”¨å®ƒçš„åå‘ä»£ç†åŠŸèƒ½æä¾›è´Ÿè½½å‡è¡¡æ”¯æŒ http{ â€‹ #æ–‡ä»¶æ‰©å±•åä¸æ–‡ä»¶ç±»å‹æ˜ å°„è¡¨ â€‹ include mime.types; â€‹ #é»˜è®¤æ–‡ä»¶ç±»å‹ â€‹ default_type application/octet-stream; â€‹ #é»˜è®¤ç¼–ç  â€‹ #charset utf-8; â€‹ #æœåŠ¡å™¨åå­—çš„hashè¡¨å¤§å° â€‹ #ä¿å­˜æœåŠ¡å™¨åå­—çš„hashè¡¨æ˜¯ç”±æŒ‡ä»¤server_names_hash_max_size å’Œserver_names_hash_bucket_sizeæ‰€æ§åˆ¶çš„ã€‚å‚æ•°hash bucket sizeæ€»æ˜¯ç­‰äºhashè¡¨çš„å¤§å°ï¼Œå¹¶ä¸”æ˜¯ä¸€è·¯å¤„ç†å™¨ç¼“å­˜å¤§å°çš„å€æ•°ã€‚åœ¨å‡å°‘äº†åœ¨å†…å­˜ä¸­çš„å­˜å–æ¬¡æ•°åï¼Œä½¿åœ¨å¤„ç†å™¨ä¸­åŠ é€ŸæŸ¥æ‰¾hashè¡¨é”®å€¼æˆä¸ºå¯èƒ½ã€‚å¦‚æœhash bucket sizeç­‰äºä¸€è·¯å¤„ç†å™¨ç¼“å­˜çš„å¤§å°ï¼Œé‚£ä¹ˆåœ¨æŸ¥æ‰¾é”®çš„æ—¶å€™ï¼Œæœ€åçš„æƒ…å†µä¸‹åœ¨å†…å­˜ä¸­æŸ¥æ‰¾çš„æ¬¡æ•°ä¸º2ã€‚ç¬¬ä¸€æ¬¡æ˜¯ç¡®å®šå­˜å‚¨å•å…ƒçš„åœ°å€ï¼Œç¬¬äºŒæ¬¡æ˜¯åœ¨å­˜å‚¨å•å…ƒä¸­æŸ¥æ‰¾é”® å€¼ã€‚å› æ­¤ï¼Œå¦‚æœNginxç»™å‡ºéœ€è¦å¢å¤§hash max size æˆ– hash bucket sizeçš„æç¤ºï¼Œé‚£ä¹ˆé¦–è¦çš„æ˜¯å¢å¤§å‰ä¸€ä¸ªå‚æ•°çš„å¤§å°. â€‹ server_names_hash_bucket_size 128; â€‹ #å®¢æˆ·ç«¯è¯·æ±‚å¤´éƒ¨çš„ç¼“å†²åŒºå¤§å°ã€‚è¿™ä¸ªå¯ä»¥æ ¹æ®ä½ çš„ç³»ç»Ÿåˆ†é¡µå¤§å°æ¥è®¾ç½®ï¼Œä¸€èˆ¬ä¸€ä¸ªè¯·æ±‚çš„å¤´éƒ¨å¤§å°ä¸ä¼šè¶…è¿‡1kï¼Œä¸è¿‡ç”±äºä¸€èˆ¬ç³»ç»Ÿåˆ†é¡µéƒ½è¦å¤§äº1kï¼Œæ‰€ä»¥è¿™é‡Œè®¾ç½®ä¸ºåˆ†é¡µå¤§å°ã€‚åˆ†é¡µå¤§å°å¯ä»¥ç”¨å‘½ä»¤getconf PAGESIZEå–å¾—ã€‚ â€‹ client_header_buffer_size 32k; â€‹ #å®¢æˆ·è¯·æ±‚å¤´ç¼“å†²å¤§å°ã€‚nginxé»˜è®¤ä¼šç”¨client_header_buffer_sizeè¿™ä¸ªbufferæ¥è¯»å–headerå€¼ï¼Œå¦‚æœheaderè¿‡å¤§ï¼Œå®ƒä¼šä½¿ç”¨large_client_header_buffersæ¥è¯»å–ã€‚ â€‹ large_client_header_buffers 4 64k; â€‹ #è®¾å®šé€šè¿‡nginxä¸Šä¼ æ–‡ä»¶çš„å¤§å° â€‹ client_max_body_size 8m; â€‹ #å¼€å¯é«˜æ•ˆæ–‡ä»¶ä¼ è¾“æ¨¡å¼ï¼ŒsendfileæŒ‡ä»¤æŒ‡å®šnginxæ˜¯å¦è°ƒç”¨sendfileå‡½æ•°æ¥è¾“å‡ºæ–‡ä»¶ï¼Œå¯¹äºæ™®é€šåº”ç”¨è®¾ä¸º onï¼Œå¦‚æœç”¨æ¥è¿›è¡Œä¸‹è½½ç­‰åº”ç”¨ç£ç›˜IOé‡è´Ÿè½½åº”ç”¨ï¼Œå¯è®¾ç½®ä¸ºoffï¼Œä»¥å¹³è¡¡ç£ç›˜ä¸ç½‘ç»œI/Oå¤„ç†é€Ÿåº¦ï¼Œé™ä½ç³»ç»Ÿçš„è´Ÿè½½ã€‚æ³¨æ„ï¼šå¦‚æœå›¾ç‰‡æ˜¾ç¤ºä¸æ­£å¸¸æŠŠè¿™ä¸ªæ”¹æˆoffã€‚ â€‹ #sendfileæŒ‡ä»¤æŒ‡å®š nginx æ˜¯å¦è°ƒç”¨sendfile å‡½æ•°ï¼ˆzero copy æ–¹å¼ï¼‰æ¥è¾“å‡ºæ–‡ä»¶ï¼Œå¯¹äºæ™®é€šåº”ç”¨ï¼Œå¿…é¡»è®¾ä¸ºonã€‚å¦‚æœç”¨æ¥è¿›è¡Œä¸‹è½½ç­‰åº”ç”¨ç£ç›˜IOé‡è´Ÿè½½åº”ç”¨ï¼Œå¯è®¾ç½®ä¸ºoffï¼Œä»¥å¹³è¡¡ç£ç›˜ä¸ç½‘ç»œIOå¤„ç†é€Ÿåº¦ï¼Œé™ä½ç³»ç»Ÿuptimeã€‚ â€‹ sendfile on; â€‹ #å¼€å¯ç›®å½•åˆ—è¡¨è®¿é—®ï¼Œåˆé€‚ä¸‹è½½æœåŠ¡å™¨ï¼Œé»˜è®¤å…³é—­ã€‚ â€‹ autoindex on; â€‹ #æ­¤é€‰é¡¹å…è®¸æˆ–ç¦æ­¢ä½¿ç”¨sockeçš„TCP_CORKçš„é€‰é¡¹ï¼Œæ­¤é€‰é¡¹ä»…åœ¨ä½¿ç”¨sendfileçš„æ—¶å€™ä½¿ç”¨ â€‹ tcp_nopush on; â€‹ tcp_nodelay on; â€‹ #é•¿è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ˜¯ç§’ â€‹ keepalive_timeout 120; â€‹ #FastCGIç›¸å…³å‚æ•°æ˜¯ä¸ºäº†æ”¹å–„ç½‘ç«™çš„æ€§èƒ½ï¼šå‡å°‘èµ„æºå ç”¨ï¼Œæé«˜è®¿é—®é€Ÿåº¦ã€‚ä¸‹é¢å‚æ•°çœ‹å­—é¢æ„æ€éƒ½èƒ½ç†è§£ã€‚ â€‹ fastcgi_connect_timeout 300; â€‹ fastcgi_send_timeout 300; â€‹ fastcgi_read_timeout 300; â€‹ fastcgi_buffer_size 64k; â€‹ fastcgi_buffers 4 64k; â€‹ fastcgi_busy_buffers_size 128k; â€‹ fastcgi_temp_file_write_size 128k; â€‹ #gzipæ¨¡å—è®¾ç½® â€‹ gzip on; #å¼€å¯gzipå‹ç¼©è¾“å‡º â€‹ gzip_min_length 1k; #æœ€å°å‹ç¼©æ–‡ä»¶å¤§å° â€‹ gzip_buffers 4 16k; #å‹ç¼©ç¼“å†²åŒº â€‹ gzip_http_version 1.0; #å‹ç¼©ç‰ˆæœ¬ï¼ˆé»˜è®¤1.1ï¼Œå‰ç«¯å¦‚æœæ˜¯squid2.5è¯·ä½¿ç”¨1.0ï¼‰ â€‹ gzip_comp_level 2; #å‹ç¼©ç­‰çº§ â€‹ gzip_types text/plain application/x-javascript text/css application/xml; #å‹ç¼©ç±»å‹ï¼Œé»˜è®¤å°±å·²ç»åŒ…å«textmlï¼Œæ‰€ä»¥ä¸‹é¢å°±ä¸ç”¨å†å†™äº†ï¼Œå†™ä¸Šå»ä¹Ÿä¸ä¼šæœ‰é—®é¢˜ï¼Œä½†æ˜¯ä¼šæœ‰ä¸€ä¸ªwarnã€‚ â€‹ gzip_vary on; â€‹ #å¼€å¯é™åˆ¶IPè¿æ¥æ•°çš„æ—¶å€™éœ€è¦ä½¿ç”¨ â€‹ #limit_zone crawler $binary_remote_addr 10m; â€‹ #è´Ÿè½½å‡è¡¡é…ç½® â€‹ upstream jh.w3cschool.cn { â€‹ #upstreamçš„è´Ÿè½½å‡è¡¡ï¼Œweightæ˜¯æƒé‡ï¼Œå¯ä»¥æ ¹æ®æœºå™¨é…ç½®å®šä¹‰æƒé‡ã€‚weigthå‚æ•°è¡¨ç¤ºæƒå€¼ï¼Œæƒå€¼è¶Šé«˜è¢«åˆ†é…åˆ°çš„å‡ ç‡è¶Šå¤§ã€‚ â€‹ server 192.168.80.121:80 weight=3; â€‹ server 192.168.80.122:80 weight=2; â€‹ server 192.168.80.123:80 weight=3; â€‹ #nginxçš„upstreamç›®å‰æ”¯æŒ4ç§æ–¹å¼çš„åˆ†é… â€‹ #1ã€è½®è¯¢ï¼ˆé»˜è®¤ï¼‰ â€‹ #æ¯ä¸ªè¯·æ±‚æŒ‰æ—¶é—´é¡ºåºé€ä¸€åˆ†é…åˆ°ä¸åŒçš„åç«¯æœåŠ¡å™¨ï¼Œå¦‚æœåç«¯æœåŠ¡å™¨downæ‰ï¼Œèƒ½è‡ªåŠ¨å‰”é™¤ã€‚ â€‹ #2ã€weight â€‹ #æŒ‡å®šè½®è¯¢å‡ ç‡ï¼Œweightå’Œè®¿é—®æ¯”ç‡æˆæ­£æ¯”ï¼Œç”¨äºåç«¯æœåŠ¡å™¨æ€§èƒ½ä¸å‡çš„æƒ…å†µã€‚ â€‹ #ä¾‹å¦‚ï¼š â€‹ #upstream bakend { â€‹ # server 192.168.0.14 weight=10; â€‹ # server 192.168.0.15 weight=10; â€‹ #} â€‹ #2ã€ip_hash â€‹ #æ¯ä¸ªè¯·æ±‚æŒ‰è®¿é—®ipçš„hashç»“æœåˆ†é…ï¼Œè¿™æ ·æ¯ä¸ªè®¿å®¢å›ºå®šè®¿é—®ä¸€ä¸ªåç«¯æœåŠ¡å™¨ï¼Œå¯ä»¥è§£å†³sessionçš„é—®é¢˜ã€‚ â€‹ #ä¾‹å¦‚ï¼š â€‹ #upstream bakend { â€‹ # ip_hash; â€‹ # server 192.168.0.14:88; â€‹ # server 192.168.0.15:80; â€‹ #} â€‹ #3ã€fairï¼ˆç¬¬ä¸‰æ–¹ï¼‰ â€‹ #æŒ‰åç«¯æœåŠ¡å™¨çš„å“åº”æ—¶é—´æ¥åˆ†é…è¯·æ±‚ï¼Œå“åº”æ—¶é—´çŸ­çš„ä¼˜å…ˆåˆ†é…ã€‚ â€‹ #upstream backend { â€‹ # server server1; â€‹ # server server2; â€‹ # fair; â€‹ #} â€‹ #4ã€url_hashï¼ˆç¬¬ä¸‰æ–¹ï¼‰ â€‹ #æŒ‰è®¿é—®urlçš„hashç»“æœæ¥åˆ†é…è¯·æ±‚ï¼Œä½¿æ¯ä¸ªurlå®šå‘åˆ°åŒä¸€ä¸ªåç«¯æœåŠ¡å™¨ï¼Œåç«¯æœåŠ¡å™¨ä¸ºç¼“å­˜æ—¶æ¯”è¾ƒæœ‰æ•ˆã€‚ â€‹ #ä¾‹ï¼šåœ¨upstreamä¸­åŠ å…¥hashè¯­å¥ï¼Œserverè¯­å¥ä¸­ä¸èƒ½å†™å…¥weightç­‰å…¶ä»–çš„å‚æ•°ï¼Œhash_methodæ˜¯ä½¿ç”¨çš„hashç®—æ³• â€‹ #upstream backend { â€‹ # server squid1:3128; â€‹ # server squid2:3128; â€‹ # hash $request_uri; â€‹ # hash_method crc32; â€‹ #} â€‹ #tips: â€‹ #upstream bakend{#å®šä¹‰è´Ÿè½½å‡è¡¡è®¾å¤‡çš„IpåŠè®¾å¤‡çŠ¶æ€}{ â€‹ # ip_hash; â€‹ # server 127.0.0.1:9090 down; â€‹ # server 127.0.0.1:8080 weight=2; â€‹ # server 127.0.0.1:6060; â€‹ # server 127.0.0.1:7070 backup; â€‹ #} â€‹ #åœ¨éœ€è¦ä½¿ç”¨è´Ÿè½½å‡è¡¡çš„serverä¸­å¢åŠ  proxy_pass http://bakend/; â€‹ #æ¯ä¸ªè®¾å¤‡çš„çŠ¶æ€è®¾ç½®ä¸º: â€‹ #1.downè¡¨ç¤ºå•å‰çš„serveræš‚æ—¶ä¸å‚ä¸è´Ÿè½½ â€‹ #2.weightä¸ºweightè¶Šå¤§ï¼Œè´Ÿè½½çš„æƒé‡å°±è¶Šå¤§ã€‚ â€‹ #3.max_failsï¼šå…è®¸è¯·æ±‚å¤±è´¥çš„æ¬¡æ•°é»˜è®¤ä¸º1.å½“è¶…è¿‡æœ€å¤§æ¬¡æ•°æ—¶ï¼Œè¿”å›proxy_next_upstreamæ¨¡å—å®šä¹‰çš„é”™è¯¯ â€‹ #4.fail_timeout:max_failsæ¬¡å¤±è´¥åï¼Œæš‚åœçš„æ—¶é—´ã€‚ â€‹ #5.backupï¼š å…¶å®ƒæ‰€æœ‰çš„ébackupæœºå™¨downæˆ–è€…å¿™çš„æ—¶å€™ï¼Œè¯·æ±‚backupæœºå™¨ã€‚æ‰€ä»¥è¿™å°æœºå™¨å‹åŠ›ä¼šæœ€è½»ã€‚ â€‹ #nginxæ”¯æŒåŒæ—¶è®¾ç½®å¤šç»„çš„è´Ÿè½½å‡è¡¡ï¼Œç”¨æ¥ç»™ä¸ç”¨çš„serveræ¥ä½¿ç”¨ã€‚ â€‹ #client_body_in_file_onlyè®¾ç½®ä¸ºOn å¯ä»¥è®²client postè¿‡æ¥çš„æ•°æ®è®°å½•åˆ°æ–‡ä»¶ä¸­ç”¨æ¥åšdebug â€‹ #client_body_temp_pathè®¾ç½®è®°å½•æ–‡ä»¶çš„ç›®å½• å¯ä»¥è®¾ç½®æœ€å¤š3å±‚ç›®å½• â€‹ #locationå¯¹URLè¿›è¡ŒåŒ¹é….å¯ä»¥è¿›è¡Œé‡å®šå‘æˆ–è€…è¿›è¡Œæ–°çš„ä»£ç† è´Ÿè½½å‡è¡¡ â€‹ } â€‹ #è™šæ‹Ÿä¸»æœºçš„é…ç½® â€‹ server{ â€‹ #ç›‘å¬ç«¯å£ â€‹ listen 80; â€‹ #åŸŸåå¯ä»¥æœ‰å¤šä¸ªï¼Œç”¨ç©ºæ ¼éš”å¼€ â€‹ server_name www.w3cschool.cn w3cschool.cn; â€‹ index index.html index.htm index.php; â€‹ root /data/www/w3cschool; â€‹ #å¯¹******è¿›è¡Œè´Ÿè½½å‡è¡¡ â€‹ location ~ .*.(php|php5)?${ â€‹ fastcgi_pass 127.0.0.1:9000; â€‹ fastcgi_index index.php; â€‹ include fastcgi.conf; â€‹ } â€‹ #å›¾ç‰‡ç¼“å­˜æ—¶é—´è®¾ç½® â€‹ location ~ .*.(gif|jpg|jpeg|png|bmp|swf)${ â€‹ expires 10d; â€‹ } â€‹ #JSå’ŒCSSç¼“å­˜æ—¶é—´è®¾ç½® â€‹ location ~ .*.(js|css)?${ â€‹ expires 1h; â€‹ } â€‹ #æ—¥å¿—æ ¼å¼è®¾å®š â€‹ #$remote_addrä¸$http_x_forwarded_forç”¨ä»¥è®°å½•å®¢æˆ·ç«¯çš„ipåœ°å€ï¼› â€‹ #$remote_userï¼šç”¨æ¥è®°å½•å®¢æˆ·ç«¯ç”¨æˆ·åç§°ï¼› â€‹ #$time_localï¼š ç”¨æ¥è®°å½•è®¿é—®æ—¶é—´ä¸æ—¶åŒºï¼› â€‹ #$requestï¼š ç”¨æ¥è®°å½•è¯·æ±‚çš„urlä¸httpåè®®ï¼› â€‹ #$statusï¼š ç”¨æ¥è®°å½•è¯·æ±‚çŠ¶æ€ï¼›æˆåŠŸæ˜¯200ï¼Œ â€‹ #$body_bytes_sent ï¼šè®°å½•å‘é€ç»™å®¢æˆ·ç«¯æ–‡ä»¶ä¸»ä½“å†…å®¹å¤§å°ï¼› â€‹ #$http_refererï¼šç”¨æ¥è®°å½•ä»é‚£ä¸ªé¡µé¢é“¾æ¥è®¿é—®è¿‡æ¥çš„ï¼› â€‹ #$http_user_agentï¼šè®°å½•å®¢æˆ·æµè§ˆå™¨çš„ç›¸å…³ä¿¡æ¯ï¼› â€‹ #é€šå¸¸webæœåŠ¡å™¨æ”¾åœ¨åå‘ä»£ç†çš„åé¢ï¼Œè¿™æ ·å°±ä¸èƒ½è·å–åˆ°å®¢æˆ·çš„IPåœ°å€äº†ï¼Œé€šè¿‡$remote_addæ‹¿åˆ°çš„IPåœ°å€æ˜¯åå‘ä»£ç†æœåŠ¡å™¨çš„iPåœ°å€ã€‚åå‘ä»£ç†æœåŠ¡å™¨åœ¨è½¬å‘è¯·æ±‚çš„httpå¤´ä¿¡æ¯ä¸­ï¼Œå¯ä»¥å¢åŠ x_forwarded_forä¿¡æ¯ï¼Œç”¨ä»¥è®°å½•åŸæœ‰å®¢æˆ·ç«¯çš„IPåœ°å€å’ŒåŸæ¥å®¢æˆ·ç«¯çš„è¯·æ±‚çš„æœåŠ¡å™¨åœ°å€ã€‚ â€‹ log_format access '$remote_addr - $remote_user [$time_local] &quot;$request&quot; ' â€‹ '$status $body_bytes_sent &quot;$http_referer&quot; ' â€‹ '&quot;$http_user_agent&quot; $http_x_forwarded_for'; â€‹ #å®šä¹‰æœ¬è™šæ‹Ÿä¸»æœºçš„è®¿é—®æ—¥å¿— â€‹ access_log /usr/local/nginx/logs/host.access.log main; â€‹ access_log /usr/local/nginx/logs/host.access.404.log log404; â€‹ #å¯¹ &quot;/&quot; å¯ç”¨åå‘ä»£ç† â€‹ location / { â€‹ proxy_pass http://127.0.0.1:88; â€‹ proxy_redirect off; â€‹ proxy_set_header X-Real-IP $remote_addr; â€‹ #åç«¯çš„WebæœåŠ¡å™¨å¯ä»¥é€šè¿‡X-Forwarded-Forè·å–ç”¨æˆ·çœŸå®IP â€‹ proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; â€‹ #ä»¥ä¸‹æ˜¯ä¸€äº›åå‘ä»£ç†çš„é…ç½®ï¼Œå¯é€‰ã€‚ â€‹ proxy_set_header Host $host; â€‹ #å…è®¸å®¢æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å•æ–‡ä»¶å­—èŠ‚æ•° â€‹ client_max_body_size 10m; â€‹ #ç¼“å†²åŒºä»£ç†ç¼“å†²ç”¨æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å­—èŠ‚æ•°ï¼Œ â€‹ #å¦‚æœæŠŠå®ƒè®¾ç½®ä¸ºæ¯”è¾ƒå¤§çš„æ•°å€¼ï¼Œä¾‹å¦‚256kï¼Œé‚£ä¹ˆï¼Œæ— è®ºä½¿ç”¨firefoxè¿˜æ˜¯IEæµè§ˆå™¨ï¼Œæ¥æäº¤ä»»æ„å°äº256kçš„å›¾ç‰‡ï¼Œéƒ½å¾ˆæ­£å¸¸ã€‚å¦‚æœæ³¨é‡Šè¯¥æŒ‡ä»¤ï¼Œä½¿ç”¨é»˜è®¤çš„client_body_buffer_sizeè®¾ç½®ï¼Œä¹Ÿå°±æ˜¯æ“ä½œç³»ç»Ÿé¡µé¢å¤§å°çš„ä¸¤å€ï¼Œ8kæˆ–è€…16kï¼Œé—®é¢˜å°±å‡ºç°äº†ã€‚ â€‹ #æ— è®ºä½¿ç”¨firefox4.0è¿˜æ˜¯IE8.0ï¼Œæäº¤ä¸€ä¸ªæ¯”è¾ƒå¤§ï¼Œ200kå·¦å³çš„å›¾ç‰‡ï¼Œéƒ½è¿”å›500 Internal Server Erroré”™è¯¯ â€‹ client_body_buffer_size 128k; â€‹ #è¡¨ç¤ºä½¿nginxé˜»æ­¢HTTPåº”ç­”ä»£ç ä¸º400æˆ–è€…æ›´é«˜çš„åº”ç­”ã€‚ â€‹ proxy_intercept_errors on; â€‹ #åç«¯æœåŠ¡å™¨è¿æ¥çš„è¶…æ—¶æ—¶é—´_å‘èµ·æ¡æ‰‹ç­‰å€™å“åº”è¶…æ—¶æ—¶é—´ â€‹ #nginxè·Ÿåç«¯æœåŠ¡å™¨è¿æ¥è¶…æ—¶æ—¶é—´(ä»£ç†è¿æ¥è¶…æ—¶) â€‹ proxy_connect_timeout 90; â€‹ #åç«¯æœåŠ¡å™¨æ•°æ®å›ä¼ æ—¶é—´(ä»£ç†å‘é€è¶…æ—¶) â€‹ #åç«¯æœåŠ¡å™¨æ•°æ®å›ä¼ æ—¶é—´_å°±æ˜¯åœ¨è§„å®šæ—¶é—´ä¹‹å†…åç«¯æœåŠ¡å™¨å¿…é¡»ä¼ å®Œæ‰€æœ‰çš„æ•°æ® â€‹ proxy_send_timeout 90; â€‹ #è¿æ¥æˆåŠŸåï¼Œåç«¯æœåŠ¡å™¨å“åº”æ—¶é—´(ä»£ç†æ¥æ”¶è¶…æ—¶) â€‹ #è¿æ¥æˆåŠŸå_ç­‰å€™åç«¯æœåŠ¡å™¨å“åº”æ—¶é—´_å…¶å®å·²ç»è¿›å…¥åç«¯çš„æ’é˜Ÿä¹‹ä¸­ç­‰å€™å¤„ç†ï¼ˆä¹Ÿå¯ä»¥è¯´æ˜¯åç«¯æœåŠ¡å™¨å¤„ç†è¯·æ±‚çš„æ—¶é—´ï¼‰ â€‹ proxy_read_timeout 90; â€‹ #è®¾ç½®ä»£ç†æœåŠ¡å™¨ï¼ˆnginxï¼‰ä¿å­˜ç”¨æˆ·å¤´ä¿¡æ¯çš„ç¼“å†²åŒºå¤§å° â€‹ #è®¾ç½®ä»è¢«ä»£ç†æœåŠ¡å™¨è¯»å–çš„ç¬¬ä¸€éƒ¨åˆ†åº”ç­”çš„ç¼“å†²åŒºå¤§å°ï¼Œé€šå¸¸æƒ…å†µä¸‹è¿™éƒ¨åˆ†åº”ç­”ä¸­åŒ…å«ä¸€ä¸ªå°çš„åº”ç­”å¤´ï¼Œé»˜è®¤æƒ…å†µä¸‹è¿™ä¸ªå€¼çš„å¤§å°ä¸ºæŒ‡ä»¤proxy_buffersä¸­æŒ‡å®šçš„ä¸€ä¸ªç¼“å†²åŒºçš„å¤§å°ï¼Œä¸è¿‡å¯ä»¥å°†å…¶è®¾ç½®ä¸ºæ›´å° â€‹ proxy_buffer_size 4k; â€‹ #proxy_buffersç¼“å†²åŒºï¼Œç½‘é¡µå¹³å‡åœ¨32kä»¥ä¸‹çš„è®¾ç½® â€‹ #è®¾ç½®ç”¨äºè¯»å–åº”ç­”ï¼ˆæ¥è‡ªè¢«ä»£ç†æœåŠ¡å™¨ï¼‰çš„ç¼“å†²åŒºæ•°ç›®å’Œå¤§å°ï¼Œé»˜è®¤æƒ…å†µä¹Ÿä¸ºåˆ†é¡µå¤§å°ï¼Œæ ¹æ®æ“ä½œç³»ç»Ÿçš„ä¸åŒå¯èƒ½æ˜¯4kæˆ–è€…8k â€‹ proxy_buffers 4 32k; â€‹ #é«˜è´Ÿè·ä¸‹ç¼“å†²å¤§å°ï¼ˆproxy_buffers*2ï¼‰ â€‹ proxy_busy_buffers_size 64k; â€‹ #è®¾ç½®åœ¨å†™å…¥proxy_temp_pathæ—¶æ•°æ®çš„å¤§å°ï¼Œé¢„é˜²ä¸€ä¸ªå·¥ä½œè¿›ç¨‹åœ¨ä¼ é€’æ–‡ä»¶æ—¶é˜»å¡å¤ªé•¿ â€‹ #è®¾å®šç¼“å­˜æ–‡ä»¶å¤¹å¤§å°ï¼Œå¤§äºè¿™ä¸ªå€¼ï¼Œå°†ä»upstreamæœåŠ¡å™¨ä¼  â€‹ proxy_temp_file_write_size 64k; â€‹ } â€‹ #è®¾å®šæŸ¥çœ‹NginxçŠ¶æ€çš„åœ°å€ â€‹ location /NginxStatus { â€‹ stub_status on; â€‹ access_log on; â€‹ auth_basic &quot;NginxStatus&quot;; â€‹ auth_basic_user_file confpasswd; â€‹ #htpasswdæ–‡ä»¶çš„å†…å®¹å¯ä»¥ç”¨apacheæä¾›çš„htpasswdå·¥å…·æ¥äº§ç”Ÿã€‚ â€‹ } â€‹ #æœ¬åœ°åŠ¨é™åˆ†ç¦»åå‘ä»£ç†é…ç½® â€‹ #æ‰€æœ‰jspçš„é¡µé¢å‡äº¤ç”±tomcatæˆ–resinå¤„ç† â€‹ location ~ .(jsp|jspx|do)?$ { â€‹ proxy_set_header Host $host; â€‹ proxy_set_header X-Real-IP $remote_addr; â€‹ proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; â€‹ proxy_pass http://127.0.0.1:8080; â€‹ } â€‹ #æ‰€æœ‰é™æ€æ–‡ä»¶ç”±nginxç›´æ¥è¯»å–ä¸ç»è¿‡tomcatæˆ–resin â€‹ location ~ .*.(htm|html|gif|jpg|jpeg|png|bmp|swf|ioc|rar|zip|txt|flv|mid|doc|ppt| â€‹ pdf|xls|mp3|wma)${ â€‹ expires 15d; â€‹ } â€‹ location ~ .*.(js|css)?${ â€‹ expires 1h; â€‹ } â€‹ } } ","link":"https://tianxiawuhao.github.io/yRJDaVAsJ/"},{"title":"docker å®¿ä¸»æœºå®šæ—¶æ¸…é™¤å®¹å™¨çš„è¿è¡Œæ—¥å¿—","content":"ä¸€èˆ¬dockerå®¹å™¨éƒ½æ˜¯æœ€å°åŒ–å®‰è£…ï¼Œä¸ä»…å¦‚æ­¤ç³»ç»Ÿå®šæ—¶å™¨ç›¸å…³çš„æœåŠ¡ä¹Ÿä¸å­˜åœ¨ï¼Œè‡ªå·±å»å®‰è£…ä¹Ÿå¾ˆéº»çƒ¦ï¼Œæ•…æ­¤ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºçš„å®šæ—¶å™¨å³å¯ã€‚ ä¸€ã€åœ¨å®¹å™¨ä¸­ç¼–å†™æ¸…é™¤æ—¥å¿—è„šæœ¬ è¿™ä¸€éƒ¨åˆ†ä¸è®ºä½ æ˜¯æŠŠå®šæ—¶å™¨åŠ åœ¨å®¿ä¸»æœºæˆ–è€…æ˜¯å®¹å™¨éƒ½å¿…é¡»è¦å»åšçš„ ï¼› ç½‘ä¸Šéšæ„ä¸€æœå°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„åˆ é™¤æ¨¡æ¿ï¼š find å¯¹åº”ç›®å½• -mtime +å¤©æ•° -name &quot;æ–‡ä»¶å&quot; -exec rm -rf {} \\; å› ä¸ºæœ¬äººçš„æ—¥å¿—ç›®å½•å±‚çº§æ¯”è¾ƒæ·± æ‰€ä»¥æ”¹è‰¯äº†å¦‚ä¸‹ï¼š 1. -- /opt/auto-del-log.sh 2. \\#!/bin/sh 3. find /home/schedule_log/ -mtime -5 -type f -iname &quot;*.log&quot; -exec rm -rf {} \\; ä¸€å®šè®°å¾—åŠ å¯æ‰§è¡Œæƒé™ chmod +777 /opt/auto-del-log.sh åé¢ç»è¿‡éªŒè¯ å…¶å®æ•ˆæœæ˜¯ä¸€æ ·çš„! é‡ç‚¹å°±æ˜¯ä½ è¦å»éªŒè¯ä½ çš„è„šæœ¬æœ‰æ— æ•ˆï¼ ä½ å¯ä»¥è¿™æ ·ç›´æ¥è¾“å…¥éªŒè¯ 1. find /home/schedule_log/ -type f -iname &quot;*.log&quot; 2. æˆ–è€… 3. find /home/schedule_log/ -name &quot;*.log&quot; å¦‚æœèƒ½æŸ¥å‡ºä½ æƒ³åˆ é™¤çš„æ–‡ä»¶é‚£ä¹ˆåé¢å°±å¯ä»¥å¼€å§‹å¥—æ¨¡æ¿äº†ã€‚ -mtimeï¼šæ ‡å‡†è¯­å¥å†™æ³•ï¼› +30ï¼šæŸ¥æ‰¾30å¤©å‰çš„æ–‡ä»¶ï¼Œè¿™é‡Œç”¨æ•°å­—ä»£è¡¨å¤©æ•°ï¼› &quot;*.log&quot;ï¼šå¸Œæœ›æŸ¥æ‰¾çš„æ•°æ®ç±»å‹ï¼Œ&quot;*.jpg&quot;è¡¨ç¤ºæŸ¥æ‰¾æ‰©å±•åä¸ºjpgçš„æ‰€æœ‰æ–‡ä»¶ï¼Œ&quot;*&quot;è¡¨ç¤ºæŸ¥æ‰¾æ‰€æœ‰æ–‡ä»¶ï¼Œè¿™ä¸ªå¯ä»¥çµæ´»è¿ç”¨ï¼Œä¸¾ä¸€åä¸‰ï¼› -execï¼šå›ºå®šå†™æ³•ï¼› rm -rfï¼šå¼ºåˆ¶åˆ é™¤æ–‡ä»¶ï¼ŒåŒ…æ‹¬ç›®å½•ï¼› {} \\; ï¼šå›ºå®šå†™æ³•ï¼Œä¸€å¯¹å¤§æ‹¬å·+ç©ºæ ¼+\\+; äºŒã€å®¿ä¸»æœºåŠ å…¥å®šæ—¶å™¨ ä½¿ç”¨docker exec å‘½ä»¤æ ¡éªŒä¹‹å‰å†™çš„è„šæœ¬æ˜¯å¦æœ‰æ•ˆ å¦‚ä¸‹ï¼š docker exec -it tomcat8002 /opt/auto-del-log.sh tomcat8002 ï¼š å®¹å™¨åç§°æˆ–è€…ID /opt/auto-del-log.sh :è„šæœ¬åœ¨å®¹å™¨ä¸­çš„ä½ç½® å¦‚æœæ­¤å‘½ä»¤æœ‰æ•ˆé‚£ä¹ˆå°±å¯ä»¥ç¼–è¾‘å®šæ—¶å™¨äº† æœ¬äººé‡‡ç”¨çš„æ˜¯centos7 å…·ä½“å¯ä»¥å‚çœ‹ç½‘ä¸Šä»‹ç»çš„æŒºå…¨çš„ä¸€ç¯‡åšå®¢å¦‚ä¸‹ï¼š centos7 linuxå®šæ—¶ä»»åŠ¡è¯¦è§£ crontab -e 02 4 * * * docker exec -it tomcat8002 /opt/auto-del-log.sh æ¥ä¸‹æ¥å°±OKå•¦ï¼ ","link":"https://tianxiawuhao.github.io/KW_02xshc/"},{"title":"dockerå®‰è£…elasticsearch","content":"docker search elasticsearch é€‰æ‹©ä¸€ä¸ªç‰ˆæœ¬ï¼Œæ‹‰å–é•œåƒ docker pull elasticsearch:2.4.4 æŸ¥çœ‹é•œåƒ docker images é€šè¿‡é•œåƒï¼Œå¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œå¹¶å°†9200å’Œ9300ç«¯å£æ˜ å°„åˆ°æœ¬æœº docker run -d -p 9200:9200 -p 9300:9300 -e ES_JAVA_OPTS=&quot;-Xms512m -Xmx512m&quot; --name elasticsearch elasticsearch:2.4.4 æŸ¥çœ‹å·²å¯åŠ¨å®¹å™¨ docker ps éªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸï¼Ÿè®¿é—®ï¼š http://localhost:9200/ å®‰è£…æ’ä»¶ï¼Œå…ˆè¿›å…¥å®¹å™¨ï¼š docker exec -it 4d34fbf944a5 /bin/bash è¿›å…¥å®¹å™¨binç›®å½•ï¼Œå¹¶æ‰§è¡Œå®‰è£…æ’ä»¶å‘½ä»¤ï¼š cd bin ls plugin install mobz/elasticsearch-head /**ï¼ˆä½ç‰ˆæœ¬æ‰§è¡Œå‘½ä»¤æœ‰æ‰€ä¸åŒï¼‰**/ plugin -install mobz/elasticsearch-head è®¿é—®ï¼š http://localhost:9200/_plugin/head/ æ’ä»¶å®‰è£…æˆåŠŸ ","link":"https://tianxiawuhao.github.io/2K9TL16e1/"},{"title":"ä½¿ç”¨dockeræ­å»ºFastDFSæ–‡ä»¶ç³»ç»Ÿ","content":"1.é¦–å…ˆä¸‹è½½FastDFSæ–‡ä»¶ç³»ç»Ÿçš„dockeré•œåƒ æŸ¥è¯¢é•œåƒ [root@localhost /]# docker search fastdfs å®‰è£…é•œåƒ [root@localhost ~]# docker pull season/fastdfs [root@localhost ~]# docker images 2.ä½¿ç”¨dockeré•œåƒæ„å»ºtrackerå®¹å™¨ï¼ˆè·Ÿè¸ªæœåŠ¡å™¨ï¼Œèµ·åˆ°è°ƒåº¦çš„ä½œç”¨ï¼‰ï¼š åˆ›å»ºtrackerå®¹å™¨ [root@localhost /]# docker run -ti -d --name trakcer -v ~/tracker_data:/fastdfs/tracker/data --net=host season/fastdfs tracker TrackeræœåŠ¡å™¨çš„ç«¯å£é»˜è®¤æ˜¯22122ï¼Œä½ å¯ä»¥æŸ¥çœ‹æ˜¯å¦å¯ç”¨ç«¯å£ [root@localhost /]# netstat -aon | grep 22122 3.ä½¿ç”¨dockeré•œåƒæ„å»ºstorageå®¹å™¨ï¼ˆå­˜å‚¨æœåŠ¡å™¨ï¼Œæä¾›å®¹é‡å’Œå¤‡ä»½æœåŠ¡ï¼‰ï¼š docker run -tid --name storage -v ~/storage_data:/fastdfs/storage/data -v ~/store_path:/fastdfs/store_path --net=host -e TRACKER_SERVER:192.168.115.130:22122 -e GROUP_NAME=group1 season/fastdfs storage 4.æ­¤æ—¶ä¸¤ä¸ªæœåŠ¡éƒ½ä»¥å¯åŠ¨ï¼Œè¿›è¡ŒæœåŠ¡çš„é…ç½®ã€‚ è¿›å…¥storageå®¹å™¨ï¼Œåˆ°storageçš„é…ç½®æ–‡ä»¶ä¸­é…ç½®httpè®¿é—®çš„ç«¯å£ï¼Œé…ç½®æ–‡ä»¶åœ¨fdfs_confç›®å½•ä¸‹çš„storage.confã€‚ [root@localhost /]# docker exec -it storage bash root@localhost:/# cd fdfs_conf root@localhost:/fdfs_conf# more storage.conf å¾€ä¸‹æ‹‰ï¼Œä½ ä¼šå‘ç°storageå®¹å™¨çš„ipä¸æ˜¯ä½ linuxçš„ipï¼Œå¦‚ä¸‹ï¼š æ¥ä¸‹æ¥ï¼Œé€€å‡ºstorageå®¹å™¨ï¼Œå¹¶å°†é…ç½®æ–‡ä»¶æ‹·è´ä¸€ä»½å‡ºæ¥ï¼š [root@localhost ~]# docker cp storage:/fdfs_conf/storage.conf ~/ [root@localhost ~]# vi ~/storage.conf å°†ä¿®æ”¹åçš„é…ç½®æ–‡ä»¶æ‹·è´åˆ°storageeçš„é…ç½®ç›®å½•ä¸‹ï¼š [root@localhost ~]# docker cp ~/storage.conf storage:/fdfs_conf/ é‡æ–°å¯åŠ¨storageå®¹å™¨ [root@localhost ~]# docker stop storage [root@localhost ~]# docker start storage æŸ¥çœ‹trackerå®¹å™¨å’Œstorageå®¹å™¨çš„å…³è” [root@localhost ~]# docker exec -it storage bash root@localhost:/# cd fdfs_conf root@localhost:/fdfs_conf# fdfs_monitor storage.conf 5.åœ¨dockeræ¨¡æ‹Ÿå®¢æˆ·ç«¯ä¸Šä¼ æ–‡ä»¶åˆ°storageå®¹å™¨ å¼€å¯ä¸€ä¸ªå®¢æˆ·ç«¯ [root@localhost 00]# docker run -tid --name fdfs_sh --net=host season/fastdfs sh æ›´æ”¹é…ç½®æ–‡ä»¶ï¼Œå› ä¸ºä¹‹å‰å·²ç»æ”¹è¿‡ä¸€æ¬¡äº†ï¼Œæ‰€ä»¥ç°åœ¨ç›´æ¥æ‹·è´ [root@localhost 00]# docker cp ~/storage.conf fdfs_sh:/fdfs_conf/ åˆ›å»ºä¸€ä¸ªtxtæ–‡ä»¶ [root@localhost 00]# docker exec -it fdfs_sh bash root@localhost:/# echo hello&gt;a.txt è¿›å…¥fdfs_confç›®å½•ï¼Œå¹¶å°†æ–‡ä»¶ä¸Šä¼ åˆ°storageå®¹å™¨ root@localhost:/# cd fdfs_conf root@localhost:/fdfs_conf# fdfs_upload_file storage.conf /a.txt /a.txtï¼šæŒ‡è¦ä¸Šä¼ çš„æ–‡ä»¶ ä¸Šä¼ ä¹‹åï¼Œæ ¹æ®è¿”å›çš„è·¯å¾„å»æ‰¾a.txt é€€å‡ºå»æŸ¥çœ‹ä¸Šä¼ çš„txtæ–‡ä»¶ [root@localhost ~]# cd ~/store_path/data/00/00 [root@localhost 00]# ls æŸ¥çœ‹æ˜¯å¦å’Œè¾“å…¥çš„å€¼æ˜¯å¦ç›¸åŒ [root@localhost 00]# more wKhzg1wGsieAL-3RAAAABncc3SA337.txt ","link":"https://tianxiawuhao.github.io/yIe_yl-14/"},{"title":"Dockerfileè¯¦è§£","content":"Dockerfileè¯¦è§£ ç¯å¢ƒä»‹ç» Dockerfileä¸­æ‰€ç”¨çš„æ‰€æœ‰æ–‡ä»¶ä¸€å®šè¦å’ŒDockerfileæ–‡ä»¶åœ¨åŒä¸€çº§çˆ¶ç›®å½•ä¸‹ï¼Œå¯ä»¥ä¸ºDockerfileçˆ¶ç›®å½•çš„å­ç›®å½• Dockerfileä¸­ç›¸å¯¹è·¯å¾„é»˜è®¤éƒ½æ˜¯Dockerfileæ‰€åœ¨çš„ç›®å½• Dockerfileä¸­ä¸€å®šè¦æƒœå­—å¦‚é‡‘ï¼Œèƒ½å†™åˆ°ä¸€è¡Œçš„æŒ‡ä»¤ï¼Œä¸€å®šè¦å†™åˆ°ä¸€è¡Œï¼ŒåŸå› æ˜¯åˆ†å±‚æ„å»ºï¼Œè”åˆæŒ‚è½½è¿™ä¸ªç‰¹æ€§ã€‚ Dockerfileä¸­æ¯ä¸€æ¡æŒ‡ä»¤è¢«è§†ä¸ºä¸€å±‚ Dockerfileä¸­æŒ‡æ˜å¤§å†™ï¼ˆçº¦å®šä¿—æˆï¼‰ æŒ‡ä»¤ä»‹ç» FROM åŠŸèƒ½ä¸ºæŒ‡å®šåŸºç¡€é•œåƒï¼Œå¹¶ä¸”å¿…é¡»æ˜¯ç¬¬ä¸€æ¡æŒ‡ä»¤ã€‚ å¦‚æœä¸ä»¥ä»»ä½•é•œåƒä¸ºåŸºç¡€ï¼Œé‚£ä¹ˆå†™æ³•ä¸ºï¼šFROM scratchã€‚ åŒæ—¶æ„å‘³ç€æ¥ä¸‹æ¥æ‰€å†™çš„æŒ‡ä»¤å°†ä½œä¸ºé•œåƒçš„ç¬¬ä¸€å±‚å¼€å§‹ è¯­æ³•ï¼š FROM &lt;image&gt; FROM &lt;image&gt;:&lt;tag&gt; FROM &lt;image&gt;:&lt;digest&gt; ä¸‰ç§å†™æ³•ï¼Œå…¶ä¸­&lt;tag&gt;å’Œ&lt;digest&gt; æ˜¯å¯é€‰é¡¹ï¼Œå¦‚æœæ²¡æœ‰é€‰æ‹©ï¼Œé‚£ä¹ˆé»˜è®¤å€¼ä¸ºlatest MAINTAINER æŒ‡å®šä½œè€… è¯­æ³•ï¼š MAINTAINER &lt;name&gt; æ–°ç‰ˆdockerä¸­ä½¿ç”¨LABELæŒ‡æ˜ LABEL åŠŸèƒ½æ˜¯ä¸ºé•œåƒæŒ‡å®šæ ‡ç­¾ è¯­æ³•ï¼š LABEL &lt;key&gt;=&lt;value&gt; &lt;key&gt;=&lt;value&gt; &lt;key&gt;=&lt;value&gt; ... ä¸€ä¸ªDockerfileç§å¯ä»¥æœ‰å¤šä¸ªLABELï¼Œå¦‚ä¸‹ï¼š LABEL &quot;com.example.vendor&quot;=&quot;ACME Incorporated&quot; LABEL com.example.label-with-value=&quot;foo&quot; LABEL version=&quot;1.0&quot; LABEL description=&quot;This text illustrates that label-values can span multiple lines.&quot; ä½†æ˜¯å¹¶ä¸å»ºè®®è¿™æ ·å†™ï¼Œæœ€å¥½å°±å†™æˆä¸€è¡Œï¼Œå¦‚å¤ªé•¿éœ€è¦æ¢è¡Œçš„è¯åˆ™ä½¿ç”¨\\ç¬¦å· å¦‚ä¸‹ï¼š LABEL multi.label1=&quot;value1&quot; multi.label2=&quot;value2&quot; other=&quot;value3&quot; è¯´æ˜ï¼šLABELä¼šç»§æ‰¿åŸºç¡€é•œåƒç§çš„LABELï¼Œå¦‚é‡åˆ°keyç›¸åŒï¼Œåˆ™å€¼è¦†ç›– ADD ä¸€ä¸ªå¤åˆ¶å‘½ä»¤ï¼ŒæŠŠæ–‡ä»¶å¤åˆ¶åˆ°é•œåƒä¸­ã€‚ å¦‚æœæŠŠè™šæ‹Ÿæœºä¸å®¹å™¨æƒ³è±¡æˆä¸¤å°linuxæœåŠ¡å™¨çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªå‘½ä»¤å°±ç±»ä¼¼äºscpï¼Œåªæ˜¯scpéœ€è¦åŠ ç”¨æˆ·åå’Œå¯†ç çš„æƒé™éªŒè¯ï¼Œè€ŒADDä¸ç”¨ã€‚ è¯­æ³•å¦‚ä¸‹ï¼š 1. ADD &lt;src&gt;... &lt;dest&gt; 2. ADD [&quot;&lt;src&gt;&quot;,... &quot;&lt;dest&gt;&quot;] è·¯å¾„çš„å¡«å†™å¯ä»¥æ˜¯å®¹å™¨å†…çš„ç»å¯¹è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯ç›¸å¯¹äºå·¥ä½œç›®å½•çš„ç›¸å¯¹è·¯å¾„ï¼Œæ¨èå†™æˆç»å¯¹è·¯å¾„ å¯ä»¥æ˜¯ä¸€ä¸ªæœ¬åœ°æ–‡ä»¶æˆ–è€…æ˜¯ä¸€ä¸ªæœ¬åœ°å‹ç¼©æ–‡ä»¶ï¼Œè¿˜å¯ä»¥æ˜¯ä¸€ä¸ªurl å¦‚æœæŠŠå†™æˆä¸€ä¸ªurlï¼Œé‚£ä¹ˆADDå°±ç±»ä¼¼äºwgetå‘½ä»¤ ç¤ºä¾‹ ADD test relativeDir/ ADD test /relativeDir ADD http://example.com/foobar/ æ³¨æ„äº‹é¡¹ srcä¸ºä¸€ä¸ªç›®å½•çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨æŠŠç›®å½•ä¸‹çš„æ–‡ä»¶å¤åˆ¶è¿‡å»ï¼Œç›®å½•æœ¬èº«ä¸ä¼šå¤åˆ¶ å¦‚æœsrcä¸ºå¤šä¸ªæ–‡ä»¶ï¼Œdestä¸€å®šè¦æ˜¯ä¸€ä¸ªç›®å½• COPY çœ‹è¿™ä¸ªåå­—å°±çŸ¥é“ï¼Œåˆæ˜¯ä¸€ä¸ªå¤åˆ¶å‘½ä»¤ è¯­æ³•å¦‚ä¸‹ï¼š COPY &lt;src&gt;... &lt;dest&gt; COPY [&quot;&lt;src&gt;&quot;,... &quot;&lt;dest&gt;&quot;] ä¸ADDçš„åŒºåˆ« COPYçš„åªèƒ½æ˜¯æœ¬åœ°æ–‡ä»¶ï¼Œå…¶ä»–ç”¨æ³•ä¸€è‡´ EXPOSE åŠŸèƒ½ä¸ºæš´æ¼å®¹å™¨è¿è¡Œæ—¶çš„ç›‘å¬ç«¯å£ç»™å¤–éƒ¨ ä½†æ˜¯EXPOSEå¹¶ä¸ä¼šä½¿å®¹å™¨è®¿é—®ä¸»æœºçš„ç«¯å£ å¦‚æœæƒ³ä½¿å¾—å®¹å™¨ä¸ä¸»æœºçš„ç«¯å£æœ‰æ˜ å°„å…³ç³»ï¼Œå¿…é¡»åœ¨å®¹å™¨å¯åŠ¨çš„æ—¶å€™åŠ ä¸Š -På‚æ•° è¯­æ³•ï¼š EXPOSE &lt;port&gt;/&lt;tcp/udp&gt; ENV åŠŸèƒ½ä¸ºè®¾ç½®ç¯å¢ƒå˜é‡ è¯­æ³•æœ‰ä¸¤ç§ ENV &lt;key&gt; &lt;value&gt; ENV &lt;key&gt;=&lt;value&gt; ... ä¸¤è€…çš„åŒºåˆ«å°±æ˜¯ç¬¬ä¸€ç§æ˜¯ä¸€æ¬¡è®¾ç½®ä¸€ä¸ªï¼Œç¬¬äºŒç§æ˜¯ä¸€æ¬¡è®¾ç½®å¤šä¸ª åœ¨Dockerfileä¸­ä½¿ç”¨å˜é‡çš„æ–¹å¼ $varname ${varname} ${varname:-default value} $(varname:+default value} ç¬¬ä¸€ç§å’Œç¬¬äºŒç§ç›¸åŒ ç¬¬ä¸‰ç§è¡¨ç¤ºå½“å˜é‡ä¸å­˜åœ¨ä½¿ç”¨-å·åé¢çš„å€¼ ç¬¬å››ç§è¡¨ç¤ºå½“å˜é‡å­˜åœ¨æ—¶ä½¿ç”¨+å·åé¢çš„å€¼ï¼ˆå½“ç„¶ä¸å­˜åœ¨ä¹Ÿæ˜¯ä½¿ç”¨åé¢çš„å€¼ï¼‰ RUN åŠŸèƒ½ä¸ºè¿è¡ŒæŒ‡å®šçš„å‘½ä»¤ RUNå‘½ä»¤æœ‰ä¸¤ç§æ ¼å¼ 1. RUN &lt;command&gt; 2. RUN [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;] ç¬¬ä¸€ç§åè¾¹ç›´æ¥è·Ÿshellå‘½ä»¤ åœ¨linuxæ“ä½œç³»ç»Ÿä¸Šé»˜è®¤ /bin/sh -c åœ¨windowsæ“ä½œç³»ç»Ÿä¸Šé»˜è®¤ cmd /S /C ç¬¬äºŒç§æ˜¯ç±»ä¼¼äºå‡½æ•°è°ƒç”¨ã€‚ å¯å°†executableç†è§£æˆä¸ºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œåé¢å°±æ˜¯ä¸¤ä¸ªå‚æ•°ã€‚ CMD åŠŸèƒ½ä¸ºå®¹å™¨å¯åŠ¨æ—¶é»˜è®¤å‘½ä»¤æˆ–å‚æ•° è¯­æ³•æœ‰ä¸‰ç§å†™æ³• CMD [&quot;executable&quot;,&quot;param1&quot;,&quot;param2&quot;] CMD [&quot;param1&quot;,&quot;param2&quot;] CMD command param1 param2 ç¬¬ä¸‰ç§æ¯”è¾ƒå¥½ç†è§£äº†ï¼Œå°±æ—¶shellè¿™ç§æ‰§è¡Œæ–¹å¼å’Œå†™æ³• ç¬¬ä¸€ç§å’Œç¬¬äºŒç§å…¶å®éƒ½æ˜¯å¯æ‰§è¡Œæ–‡ä»¶åŠ ä¸Šå‚æ•°çš„å½¢å¼ ä¸¾ä¾‹è¯´æ˜ä¸¤ç§å†™æ³•ï¼š CMD [ &quot;sh&quot;, &quot;-c&quot;, &quot;echo $HOME&quot; CMD [ &quot;echo&quot;, &quot;$HOME&quot; ] è¡¥å……ç»†èŠ‚ï¼šè¿™é‡Œè¾¹åŒ…æ‹¬å‚æ•°çš„ä¸€å®šè¦ç”¨åŒå¼•å·ï¼Œå°±æ˜¯&quot;,ä¸èƒ½æ˜¯å•å¼•å·ã€‚åƒä¸‡ä¸èƒ½å†™æˆå•å¼•å·ã€‚ åŸå› æ˜¯å‚æ•°ä¼ é€’åï¼Œdockerè§£æçš„æ˜¯ä¸€ä¸ªJSON array RUN&amp;&amp;CMD ä¸è¦æŠŠRUNå’ŒCMDææ··äº†ã€‚ RUNæ˜¯æ„ä»¶å®¹å™¨æ—¶å°±è¿è¡Œçš„å‘½ä»¤ä»¥åŠæäº¤è¿è¡Œç»“æœ CMDæ˜¯å®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œçš„å‘½ä»¤ï¼Œåœ¨æ„ä»¶æ—¶å¹¶ä¸è¿è¡Œï¼Œæ„ä»¶æ—¶ç´§ç´§æŒ‡å®šäº†è¿™ä¸ªå‘½ä»¤åˆ°åº•æ˜¯ä¸ªä»€ä¹ˆæ ·å­ ENTRYPOINT åŠŸèƒ½æ˜¯ï¼šå®¹å™¨å¯åŠ¨æ—¶è¿è¡Œå¾—å¯åŠ¨å‘½ä»¤ è¯­æ³•å¦‚ä¸‹ï¼š ENTRYPOINT [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;] ENTRYPOINT command param1 param2 å¦‚æœä»ä¸Šåˆ°ä¸‹çœ‹åˆ°è¿™é‡Œçš„è¯ï¼Œé‚£ä¹ˆä½ åº”è¯¥å¯¹è¿™ä¸¤ç§è¯­æ³•å¾ˆç†Ÿæ‚‰å•¦ã€‚ ç¬¬äºŒç§å°±æ˜¯å†™shell ç¬¬ä¸€ç§å°±æ˜¯å¯æ‰§è¡Œæ–‡ä»¶åŠ å‚æ•° ä¸CMDæ¯”è¾ƒè¯´æ˜ï¼ˆè¿™ä¿©å‘½ä»¤å¤ªåƒäº†ï¼Œè€Œä¸”è¿˜å¯ä»¥é…åˆä½¿ç”¨ï¼‰ï¼š ç›¸åŒç‚¹ï¼š åªèƒ½å†™ä¸€æ¡ï¼Œå¦‚æœå†™äº†å¤šæ¡ï¼Œé‚£ä¹ˆåªæœ‰æœ€åä¸€æ¡ç”Ÿæ•ˆ å®¹å™¨å¯åŠ¨æ—¶æ‰è¿è¡Œï¼Œè¿è¡Œæ—¶æœºç›¸åŒ ä¸åŒç‚¹ï¼š ENTRYPOINTä¸ä¼šè¢«è¿è¡Œçš„commandè¦†ç›–ï¼Œè€ŒCMDåˆ™ä¼šè¢«è¦†ç›– å¦‚æœæˆ‘ä»¬åœ¨Dockerfileç§åŒæ—¶å†™äº†ENTRYPOINTå’ŒCMDï¼Œå¹¶ä¸”CMDæŒ‡ä»¤ä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¯æ‰§è¡Œå‘½ä»¤ï¼Œé‚£ä¹ˆCMDæŒ‡å®šçš„å†…å®¹å°†ä¼šä½œä¸ºENTRYPOINTçš„å‚æ•° å¦‚ä¸‹ï¼š FROM ubuntu ENTRYPOINT [&quot;top&quot;, &quot;-b&quot;] CMD [&quot;-c&quot;] å¦‚æœæˆ‘ä»¬åœ¨Dockerfileç§åŒæ—¶å†™äº†ENTRYPOINTå’ŒCMDï¼Œå¹¶ä¸”CMDæ˜¯ä¸€ä¸ªå®Œæ•´çš„æŒ‡ä»¤ï¼Œé‚£ä¹ˆå®ƒä»¬ä¸¤ä¸ªä¼šäº’ç›¸è¦†ç›–ï¼Œè°åœ¨æœ€åè°ç”Ÿæ•ˆ å¦‚ä¸‹ï¼š FROM ubuntu ENTRYPOINT [&quot;top&quot;, &quot;-b&quot;] CMD ls -al é‚£ä¹ˆå°†æ‰§è¡Œls -al ,top -bä¸ä¼šæ‰§è¡Œã€‚ Dockerå®˜æ–¹ä½¿ç”¨ä¸€å¼ è¡¨æ ¼æ¥å±•ç¤ºäº†ENTRYPOINT å’Œ CMDä¸åŒç»„åˆçš„æ‰§è¡Œæƒ…å†µ VOLUME å¯å®ç°æŒ‚è½½åŠŸèƒ½ï¼Œå¯ä»¥å°†å®¿ä¸»æœºç›®å½•æŒ‚è½½åˆ°å®¹å™¨ä¸­ è¯´çš„è¿™é‡Œå¤§å®¶éƒ½æ‡‚äº†ï¼Œå¯ç”¨ä¸“ç”¨çš„æ–‡ä»¶å­˜å‚¨å½“ä½œDockerå®¹å™¨çš„æ•°æ®å­˜å‚¨éƒ¨åˆ† è¯­æ³•å¦‚ä¸‹ï¼š VOLUME [&quot;/data&quot;] è¯´æ˜ï¼š [&quot;/data&quot;]å¯ä»¥æ˜¯ä¸€ä¸ªJsonArray ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªå€¼ã€‚æ‰€ä»¥å¦‚ä¸‹å‡ ç§å†™æ³•éƒ½æ˜¯æ­£ç¡®çš„ VOLUME [&quot;/var/log/&quot;] VOLUME /var/log VOLUME /var/log /var/db ä¸€èˆ¬çš„ä½¿ç”¨åœºæ™¯ä¸ºéœ€è¦æŒä¹…åŒ–å­˜å‚¨æ•°æ®æ—¶ å®¹å™¨ä½¿ç”¨çš„æ˜¯AUFSï¼Œè¿™ç§æ–‡ä»¶ç³»ç»Ÿä¸èƒ½æŒä¹…åŒ–æ•°æ®ï¼Œå½“å®¹å™¨å…³é—­åï¼Œæ‰€æœ‰çš„æ›´æ”¹éƒ½ä¼šä¸¢å¤±ã€‚ USER è®¾ç½®å¯åŠ¨å®¹å™¨çš„ç”¨æˆ·ï¼Œå¯ä»¥æ˜¯ç”¨æˆ·åæˆ–UIDï¼Œæ‰€ä»¥ï¼Œåªæœ‰ä¸‹é¢çš„ä¸¤ç§å†™æ³•æ˜¯æ­£ç¡®çš„ USER daemo USER UID æ³¨æ„ï¼šå¦‚æœè®¾ç½®äº†å®¹å™¨ä»¥daemonç”¨æˆ·å»è¿è¡Œï¼Œé‚£ä¹ˆRUN, CMD å’Œ ENTRYPOINT éƒ½ä¼šä»¥è¿™ä¸ªç”¨æˆ·å»è¿è¡Œ, ä½¿ç”¨è¿™ä¸ªå‘½ä»¤ä¸€å®šè¦ç¡®è®¤å®¹å™¨ä¸­æ‹¥æœ‰è¿™ä¸ªç”¨æˆ·ï¼Œå¹¶ä¸”æ‹¥æœ‰è¶³å¤Ÿæƒé™ WORKDIR è®¾ç½®å·¥ä½œç›®å½• è¯­æ³•ï¼š WORKDIR /path/to/workdir è®¾ç½®å·¥ä½œç›®å½•ï¼Œå¯¹RUN,CMD,ENTRYPOINT,COPY,ADDç”Ÿæ•ˆã€‚å¦‚æœä¸å­˜åœ¨åˆ™ä¼šåˆ›å»ºï¼Œä¹Ÿå¯ä»¥è®¾ç½®å¤šæ¬¡ã€‚ å¦‚ï¼š WORKDIR /a WORKDIR b WORKDIR c RUN pwd pwdæ‰§è¡Œçš„ç»“æœæ˜¯/a/b/c WORKDIRä¹Ÿå¯ä»¥è§£æç¯å¢ƒå˜é‡ å¦‚ï¼š ENV DIRPATH /path WORKDIR $DIRPATH/$DIRNAME RUN pwd pwdçš„æ‰§è¡Œç»“æœæ˜¯/path/$DIRNAME ARG è®¾ç½®å˜é‡å‘½ä»¤ è¯­æ³•ï¼š ARG &lt;name&gt;[=&lt;default value&gt;] è®¾ç½®å˜é‡å‘½ä»¤ï¼ŒARGå‘½ä»¤å®šä¹‰äº†ä¸€ä¸ªå˜é‡ï¼Œåœ¨docker buildåˆ›å»ºé•œåƒçš„æ—¶å€™ï¼Œä½¿ç”¨ --build-arg =æ¥æŒ‡å®šå‚æ•° å¦‚æœç”¨æˆ·åœ¨buildé•œåƒæ—¶æŒ‡å®šäº†ä¸€ä¸ªå‚æ•°æ²¡æœ‰å®šä¹‰åœ¨Dockerfileç§ï¼Œé‚£ä¹ˆå°†æœ‰ä¸€ä¸ªWarning æç¤ºå¦‚ä¸‹ï¼š [Warning] One or more build-args [foo] were not consumed. æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°ï¼Œå¦‚ä¸‹ï¼š FROM busybox ARG user1 ARG buildno ä¹Ÿå¯ä»¥ç»™å‚æ•°ä¸€ä¸ªé»˜è®¤å€¼ï¼š FROM busybox ARG user1=someuser ARG buildno=1 å¦‚æœæˆ‘ä»¬ç»™äº†ARGå®šä¹‰çš„å‚æ•°é»˜è®¤å€¼ï¼Œé‚£ä¹ˆå½“buildé•œåƒæ—¶æ²¡æœ‰æŒ‡å®šå‚æ•°å€¼ï¼Œå°†ä¼šä½¿ç”¨è¿™ä¸ªé»˜è®¤å€¼ ONBUILD è¯­æ³•ï¼š ONBUILD [INSTRUCTION] è¿™ä¸ªå‘½ä»¤åªå¯¹å½“å‰é•œåƒçš„å­é•œåƒç”Ÿæ•ˆã€‚ æ¯”å¦‚å½“å‰é•œåƒä¸ºAï¼Œåœ¨Dockerfileç§æ·»åŠ ï¼š ONBUILD RUN ls -al è¿™ä¸ª ls -al å‘½ä»¤ä¸ä¼šåœ¨Aé•œåƒæ„å»ºæˆ–å¯åŠ¨çš„æ—¶å€™æ‰§è¡Œ æ­¤æ—¶æœ‰ä¸€ä¸ªé•œåƒBæ˜¯åŸºäºAé•œåƒæ„å»ºçš„ï¼Œé‚£ä¹ˆè¿™ä¸ªls -al å‘½ä»¤ä¼šåœ¨Bé•œåƒæ„å»ºçš„æ—¶å€™è¢«æ‰§è¡Œã€‚ STOPSIGNAL è¯­æ³•ï¼š STOPSIGNAL signal STOPSIGNALå‘½ä»¤æ˜¯çš„ä½œç”¨æ˜¯å½“å®¹å™¨åœæ­¢æ—¶ç»™ç³»ç»Ÿå‘é€ä»€ä¹ˆæ ·çš„æŒ‡ä»¤ï¼Œé»˜è®¤æ˜¯15 HEALTHCHECK å®¹å™¨å¥åº·çŠ¶å†µæ£€æŸ¥å‘½ä»¤ è¯­æ³•æœ‰ä¸¤ç§ï¼š HEALTHCHECK [OPTIONS] CMD command HEALTHCHECK NONE ç¬¬ä¸€ä¸ªçš„åŠŸèƒ½æ˜¯åœ¨å®¹å™¨å†…éƒ¨è¿è¡Œä¸€ä¸ªå‘½ä»¤æ¥æ£€æŸ¥å®¹å™¨çš„å¥åº·çŠ¶å†µ ç¬¬äºŒä¸ªçš„åŠŸèƒ½æ˜¯åœ¨åŸºç¡€é•œåƒä¸­å–æ¶ˆå¥åº·æ£€æŸ¥å‘½ä»¤ [OPTIONS]çš„é€‰é¡¹æ”¯æŒä»¥ä¸‹ä¸‰ä¸­é€‰é¡¹ï¼š â€“interval=DURATION ä¸¤æ¬¡æ£€æŸ¥é»˜è®¤çš„æ—¶é—´é—´éš”ä¸º30ç§’ â€“timeout=DURATION å¥åº·æ£€æŸ¥å‘½ä»¤è¿è¡Œè¶…æ—¶æ—¶é•¿ï¼Œé»˜è®¤30ç§’ â€“retries=N å½“è¿ç»­å¤±è´¥æŒ‡å®šæ¬¡æ•°åï¼Œåˆ™å®¹å™¨è¢«è®¤ä¸ºæ˜¯ä¸å¥åº·çš„ï¼ŒçŠ¶æ€ä¸ºunhealthyï¼Œé»˜è®¤æ¬¡æ•°æ˜¯3 æ³¨æ„ï¼š HEALTHCHECKå‘½ä»¤åªèƒ½å‡ºç°ä¸€æ¬¡ï¼Œå¦‚æœå‡ºç°äº†å¤šæ¬¡ï¼Œåªæœ‰æœ€åä¸€ä¸ªç”Ÿæ•ˆã€‚ CMDåè¾¹çš„å‘½ä»¤çš„è¿”å›å€¼å†³å®šäº†æœ¬æ¬¡å¥åº·æ£€æŸ¥æ˜¯å¦æˆåŠŸï¼Œå…·ä½“çš„è¿”å›å€¼å¦‚ä¸‹ï¼š 0: success - è¡¨ç¤ºå®¹å™¨æ˜¯å¥åº·çš„ 1: unhealthy - è¡¨ç¤ºå®¹å™¨å·²ç»ä¸èƒ½å·¥ä½œäº† 2: reserved - ä¿ç•™å€¼ ä¾‹å­ï¼š HEALTHCHECK --interval=5m --timeout=3s CMD curl -f http://localhost/ || exit 1 å¥åº·æ£€æŸ¥å‘½ä»¤æ˜¯ï¼šcurl -f http://localhost/ || exit 1 ä¸¤æ¬¡æ£€æŸ¥çš„é—´éš”æ—¶é—´æ˜¯5ç§’ å‘½ä»¤è¶…æ—¶æ—¶é—´ä¸º3ç§’ ","link":"https://tianxiawuhao.github.io/jw7hb2R8R/"},{"title":"Docker ","content":"Docker å­¦ä¹ ç›®æ ‡ï¼š æŒæ¡DockeråŸºç¡€çŸ¥è¯†ï¼Œèƒ½å¤Ÿç†è§£Dockeré•œåƒä¸å®¹å™¨çš„æ¦‚å¿µ å®ŒæˆDockerå®‰è£…ä¸å¯åŠ¨ æŒæ¡Dockeré•œåƒä¸å®¹å™¨ç›¸å…³å‘½ä»¤ æŒæ¡Tomcat Nginx ç­‰è½¯ä»¶çš„å¸¸ç”¨åº”ç”¨çš„å®‰è£… æŒæ¡dockerè¿ç§»ä¸å¤‡ä»½ç›¸å…³å‘½ä»¤ èƒ½å¤Ÿè¿ç”¨Dockerfileç¼–å†™åˆ›å»ºå®¹å™¨çš„è„šæœ¬ èƒ½å¤Ÿæ­å»ºä¸ä½¿ç”¨dockerç§æœ‰ä»“åº“ 1 Dockerç®€ä»‹ 1.1 ä»€ä¹ˆæ˜¯è™šæ‹ŸåŒ– â€‹ åœ¨è®¡ç®—æœºä¸­ï¼Œè™šæ‹ŸåŒ–ï¼ˆè‹±è¯­ï¼šVirtualizationï¼‰æ˜¯ä¸€ç§èµ„æºç®¡ç†æŠ€æœ¯ï¼Œæ˜¯å°†è®¡ç®—æœºçš„å„ç§å®ä½“èµ„æºï¼Œå¦‚æœåŠ¡å™¨ã€ç½‘ç»œã€å†…å­˜åŠå­˜å‚¨ç­‰ï¼Œäºˆä»¥æŠ½è±¡ã€è½¬æ¢åå‘ˆç°å‡ºæ¥ï¼Œæ‰“ç ´å®ä½“ç»“æ„é—´çš„ä¸å¯åˆ‡å‰²çš„éšœç¢ï¼Œä½¿ç”¨æˆ·å¯ä»¥æ¯”åŸæœ¬çš„ç»„æ€æ›´å¥½çš„æ–¹å¼æ¥åº”ç”¨è¿™äº›èµ„æºã€‚è¿™äº›èµ„æºçš„æ–°è™šæ‹Ÿéƒ¨ä»½æ˜¯ä¸å—ç°æœ‰èµ„æºçš„æ¶è®¾æ–¹å¼ï¼Œåœ°åŸŸæˆ–ç‰©ç†ç»„æ€æ‰€é™åˆ¶ã€‚ä¸€èˆ¬æ‰€æŒ‡çš„è™šæ‹ŸåŒ–èµ„æºåŒ…æ‹¬è®¡ç®—èƒ½åŠ›å’Œèµ„æ–™å­˜å‚¨ã€‚ â€‹ åœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè™šæ‹ŸåŒ–æŠ€æœ¯ä¸»è¦ç”¨æ¥è§£å†³é«˜æ€§èƒ½çš„ç‰©ç†ç¡¬ä»¶äº§èƒ½è¿‡å‰©å’Œè€çš„æ—§çš„ç¡¬ä»¶äº§èƒ½è¿‡ä½çš„é‡ç»„é‡ç”¨ï¼Œé€æ˜åŒ–åº•å±‚ç‰©ç†ç¡¬ä»¶ï¼Œä»è€Œæœ€å¤§åŒ–çš„åˆ©ç”¨ç‰©ç†ç¡¬ä»¶ å¯¹èµ„æºå……åˆ†åˆ©ç”¨ â€‹ è™šæ‹ŸåŒ–æŠ€æœ¯ç§ç±»å¾ˆå¤šï¼Œä¾‹å¦‚ï¼šè½¯ä»¶è™šæ‹ŸåŒ–ã€ç¡¬ä»¶è™šæ‹ŸåŒ–ã€å†…å­˜è™šæ‹ŸåŒ–ã€ç½‘ç»œè™šæ‹ŸåŒ–(vip)ã€æ¡Œé¢è™šæ‹ŸåŒ–ã€æœåŠ¡è™šæ‹ŸåŒ–ã€è™šæ‹Ÿæœºç­‰ç­‰ã€‚ 1.2 ä»€ä¹ˆæ˜¯Docker â€‹ Docker æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œè¯ç”Ÿäº 2013 å¹´åˆï¼Œæœ€åˆæ˜¯ dotCloud å…¬å¸å†…éƒ¨çš„ä¸€ä¸ªä¸šä½™é¡¹ç›®ã€‚å®ƒåŸºäº Google å…¬å¸æ¨å‡ºçš„ Go è¯­è¨€å®ç°ã€‚ é¡¹ç›®åæ¥åŠ å…¥äº† Linux åŸºé‡‘ä¼šï¼Œéµä»äº† Apache 2.0 åè®®ï¼Œé¡¹ç›®ä»£ç åœ¨ GitHub ä¸Šè¿›è¡Œç»´æŠ¤ã€‚ â€‹ â€‹ Docker è‡ªå¼€æºåå—åˆ°å¹¿æ³›çš„å…³æ³¨å’Œè®¨è®ºï¼Œä»¥è‡³äº dotCloud å…¬å¸åæ¥éƒ½æ”¹åä¸º Docker Incã€‚Redhat å·²ç»åœ¨å…¶ RHEL6.5 ä¸­é›†ä¸­æ”¯æŒ Dockerï¼›Google ä¹Ÿåœ¨å…¶ PaaS äº§å“ä¸­å¹¿æ³›åº”ç”¨ã€‚ â€‹ Docker é¡¹ç›®çš„ç›®æ ‡æ˜¯å®ç°è½»é‡çº§çš„æ“ä½œç³»ç»Ÿè™šæ‹ŸåŒ–è§£å†³æ–¹æ¡ˆã€‚ Docker çš„åŸºç¡€æ˜¯ Linux å®¹å™¨ï¼ˆLXCï¼‰ç­‰æŠ€æœ¯ã€‚ â€‹ åœ¨ LXC çš„åŸºç¡€ä¸Š Docker è¿›è¡Œäº†è¿›ä¸€æ­¥çš„å°è£…ï¼Œè®©ç”¨æˆ·ä¸éœ€è¦å»å…³å¿ƒå®¹å™¨çš„ç®¡ç†ï¼Œä½¿å¾—æ“ä½œæ›´ä¸ºç®€ä¾¿ã€‚ç”¨æˆ·æ“ä½œ Docker çš„å®¹å™¨å°±åƒæ“ä½œä¸€ä¸ªå¿«é€Ÿè½»é‡çº§çš„è™šæ‹Ÿæœºä¸€æ ·ç®€å•ã€‚ ä¸ºä»€ä¹ˆé€‰æ‹©Docker? ï¼ˆ1ï¼‰ä¸Šæ‰‹å¿«ã€‚ â€‹ ç”¨æˆ·åªéœ€è¦å‡ åˆ†é’Ÿï¼Œå°±å¯ä»¥æŠŠè‡ªå·±çš„ç¨‹åºâ€œDockeråŒ–â€ã€‚Dockerä¾èµ–äºâ€œå†™æ—¶å¤åˆ¶â€ï¼ˆcopy-on-writeï¼‰æ¨¡å‹ï¼Œä½¿ä¿®æ”¹åº”ç”¨ç¨‹åºä¹Ÿéå¸¸è¿…é€Ÿï¼Œå¯ä»¥è¯´è¾¾åˆ°â€œéšå¿ƒæ‰€è‡´ï¼Œä»£ç å³æ”¹â€çš„å¢ƒç•Œã€‚ éšåï¼Œå°±å¯ä»¥åˆ›å»ºå®¹å™¨æ¥è¿è¡Œåº”ç”¨ç¨‹åºäº†ã€‚å¤§å¤šæ•°Dockerå®¹å™¨åªéœ€è¦ä¸åˆ°1ç§’ä¸­å³å¯å¯åŠ¨ã€‚ç”±äºå»é™¤äº†ç®¡ç†ç¨‹åºçš„å¼€é”€ï¼ŒDockerå®¹å™¨æ‹¥æœ‰å¾ˆé«˜çš„æ€§èƒ½ï¼ŒåŒæ—¶åŒä¸€å°å®¿ä¸»æœºä¸­ä¹Ÿå¯ä»¥è¿è¡Œæ›´å¤šçš„å®¹å™¨ï¼Œä½¿ç”¨æˆ·å°½å¯èƒ½çš„å……åˆ†åˆ©ç”¨ç³»ç»Ÿèµ„æºã€‚ ï¼ˆ2ï¼‰èŒè´£çš„é€»è¾‘åˆ†ç±» â€‹ ä½¿ç”¨Dockerï¼Œå¼€å‘äººå‘˜åªéœ€è¦å…³å¿ƒå®¹å™¨ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºï¼Œè€Œè¿ç»´äººå‘˜åªéœ€è¦å…³å¿ƒå¦‚ä½•ç®¡ç†å®¹å™¨ã€‚Dockerè®¾è®¡çš„ç›®çš„å°±æ˜¯è¦åŠ å¼ºå¼€å‘äººå‘˜å†™ä»£ç çš„å¼€å‘ç¯å¢ƒä¸åº”ç”¨ç¨‹åºè¦éƒ¨ç½²çš„ç”Ÿäº§ç¯å¢ƒä¸€è‡´æ€§ã€‚ä»è€Œé™ä½é‚£ç§â€œå¼€å‘æ—¶ä¸€åˆ‡æ­£å¸¸ï¼Œè‚¯å®šæ˜¯è¿ç»´çš„é—®é¢˜ï¼ˆæµ‹è¯•ç¯å¢ƒéƒ½æ˜¯æ­£å¸¸çš„ï¼Œä¸Šçº¿åå‡ºäº†é—®é¢˜å°±å½’ç»“ä¸ºè‚¯å®šæ˜¯è¿ç»´çš„é—®é¢˜ï¼‰â€ ï¼ˆ3ï¼‰å¿«é€Ÿé«˜æ•ˆçš„å¼€å‘ç”Ÿå‘½å‘¨æœŸ â€‹ Dockerçš„ç›®æ ‡ä¹‹ä¸€å°±æ˜¯ç¼©çŸ­ä»£ç ä»å¼€å‘ã€æµ‹è¯•åˆ°éƒ¨ç½²ã€ä¸Šçº¿è¿è¡Œçš„å‘¨æœŸï¼Œè®©ä½ çš„åº”ç”¨ç¨‹åºå…·å¤‡å¯ç§»æ¤æ€§ï¼Œæ˜“äºæ„å»ºï¼Œå¹¶æ˜“äºåä½œã€‚ï¼ˆé€šä¿—ä¸€ç‚¹è¯´ï¼ŒDockerå°±åƒä¸€ä¸ªç›’å­ï¼Œé‡Œé¢å¯ä»¥è£…å¾ˆå¤šç‰©ä»¶ï¼Œå¦‚æœéœ€è¦è¿™äº›ç‰©ä»¶çš„å¯ä»¥ç›´æ¥å°†è¯¥å¤§ç›’å­æ‹¿èµ°ï¼Œè€Œä¸éœ€è¦ä»è¯¥ç›’å­ä¸­ä¸€ä»¶ä»¶çš„å–ã€‚ï¼‰ ï¼ˆ4ï¼‰é¼“åŠ±ä½¿ç”¨é¢å‘æœåŠ¡çš„æ¶æ„ â€‹ Dockerè¿˜é¼“åŠ±é¢å‘æœåŠ¡çš„ä½“ç³»ç»“æ„å’Œå¾®æœåŠ¡æ¶æ„ã€‚Dockeræ¨èå•ä¸ªå®¹å™¨åªè¿è¡Œä¸€ä¸ªåº”ç”¨ç¨‹åºæˆ–è¿›ç¨‹ï¼Œè¿™æ ·å°±å½¢æˆäº†ä¸€ä¸ªåˆ†å¸ƒå¼çš„åº”ç”¨ç¨‹åºæ¨¡å‹ï¼Œåœ¨è¿™ç§æ¨¡å‹ä¸‹ï¼Œåº”ç”¨ç¨‹åºæˆ–è€…æœåŠ¡éƒ½å¯ä»¥è¡¨ç¤ºä¸ºä¸€ç³»åˆ—å†…éƒ¨äº’è”çš„å®¹å™¨ï¼Œä»è€Œä½¿åˆ†å¸ƒå¼éƒ¨ç½²åº”ç”¨ç¨‹åºï¼Œæ‰©å±•æˆ–è°ƒè¯•åº”ç”¨ç¨‹åºéƒ½å˜å¾—éå¸¸ç®€å•ï¼ŒåŒæ—¶ä¹Ÿæé«˜äº†ç¨‹åºçš„å†…çœæ€§ã€‚ï¼ˆå½“ç„¶ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªå®¹å™¨ä¸­è¿è¡Œå¤šä¸ªåº”ç”¨ç¨‹åºï¼‰ 1.3 å®¹å™¨ä¸è™šæ‹Ÿæœºæ¯”è¾ƒ â€‹ ä¸‹é¢çš„å›¾ç‰‡æ¯”è¾ƒäº† Docker å’Œä¼ ç»Ÿè™šæ‹ŸåŒ–æ–¹å¼çš„ä¸åŒä¹‹å¤„ï¼Œå¯è§å®¹å™¨æ˜¯åœ¨æ“ä½œç³»ç»Ÿå±‚é¢ä¸Šå®ç°è™šæ‹ŸåŒ–ï¼Œç›´æ¥å¤ç”¨æœ¬åœ°ä¸»æœºçš„æ“ä½œç³»ç»Ÿï¼Œè€Œä¼ ç»Ÿæ–¹å¼åˆ™æ˜¯åœ¨ç¡¬ä»¶å±‚é¢å®ç°ã€‚ ä¸ä¼ ç»Ÿçš„è™šæ‹Ÿæœºç›¸æ¯”ï¼ŒDockerä¼˜åŠ¿ä½“ç°ä¸ºå¯åŠ¨é€Ÿåº¦å¿«ã€å ç”¨ä½“ç§¯å°ã€‚ 1.4 Docker ç»„ä»¶ 1.4.1 DockeræœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ â€‹ Dockeræ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯-æœåŠ¡å™¨ï¼ˆC/Sï¼‰æ¶æ„ç¨‹åºã€‚Dockerå®¢æˆ·ç«¯åªéœ€è¦å‘DockeræœåŠ¡å™¨æˆ–è€…å®ˆæŠ¤è¿›ç¨‹å‘å‡ºè¯·æ±‚ï¼ŒæœåŠ¡å™¨æˆ–è€…å®ˆæŠ¤è¿›ç¨‹å°†å®Œæˆæ‰€æœ‰å·¥ä½œå¹¶è¿”å›ç»“æœã€‚Dockeræä¾›äº†ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·Dockerä»¥åŠä¸€æ•´å¥—RESTful APIã€‚ä½ å¯ä»¥åœ¨åŒä¸€å°å®¿ä¸»æœºä¸Šè¿è¡ŒDockerå®ˆæŠ¤è¿›ç¨‹å’Œå®¢æˆ·ç«¯ï¼Œä¹Ÿå¯ä»¥ä»æœ¬åœ°çš„Dockerå®¢æˆ·ç«¯è¿æ¥åˆ°è¿è¡Œåœ¨å¦ä¸€å°å®¿ä¸»æœºä¸Šçš„è¿œç¨‹Dockerå®ˆæŠ¤è¿›ç¨‹ã€‚ 1.4.2 Dockeré•œåƒä¸å®¹å™¨ â€‹ é•œåƒæ˜¯æ„å»ºDockerçš„åŸºçŸ³ã€‚ç”¨æˆ·åŸºäºé•œåƒæ¥è¿è¡Œè‡ªå·±çš„å®¹å™¨ã€‚é•œåƒä¹Ÿæ˜¯Dockerç”Ÿå‘½å‘¨æœŸä¸­çš„â€œæ„å»ºâ€éƒ¨åˆ†ã€‚é•œåƒæ˜¯åŸºäºè”åˆæ–‡ä»¶ç³»ç»Ÿçš„ä¸€ç§å±‚å¼ç»“æ„ï¼Œç”±ä¸€ç³»åˆ—æŒ‡ä»¤ä¸€æ­¥ä¸€æ­¥æ„å»ºå‡ºæ¥ã€‚ä¾‹å¦‚ï¼š æ·»åŠ ä¸€ä¸ªæ–‡ä»¶ï¼› æ‰§è¡Œä¸€ä¸ªå‘½ä»¤ï¼› æ‰“å¼€ä¸€ä¸ªçª—å£ã€‚ ä¹Ÿå¯ä»¥å°†é•œåƒå½“ä½œå®¹å™¨çš„â€œæºä»£ç â€ã€‚é•œåƒä½“ç§¯å¾ˆå°ï¼Œéå¸¸â€œä¾¿æºâ€ï¼Œæ˜“äºåˆ†äº«ã€å­˜å‚¨å’Œæ›´æ–°ã€‚ â€‹ Dockerå¯ä»¥å¸®åŠ©ä½ æ„å»ºå’Œéƒ¨ç½²å®¹å™¨ï¼Œä½ åªéœ€è¦æŠŠè‡ªå·±çš„åº”ç”¨ç¨‹åºæˆ–è€…æœåŠ¡æ‰“åŒ…æ”¾è¿›å®¹å™¨å³å¯ã€‚å®¹å™¨æ˜¯åŸºäºé•œåƒå¯åŠ¨èµ·æ¥çš„ï¼Œå®¹å™¨ä¸­å¯ä»¥è¿è¡Œä¸€ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹ã€‚æˆ‘ä»¬å¯ä»¥è®¤ä¸ºï¼Œé•œåƒæ˜¯Dockerç”Ÿå‘½å‘¨æœŸä¸­çš„æ„å»ºæˆ–è€…æ‰“åŒ…é˜¶æ®µï¼Œè€Œå®¹å™¨åˆ™æ˜¯å¯åŠ¨æˆ–è€…æ‰§è¡Œé˜¶æ®µã€‚ å®¹å™¨åŸºäºé•œåƒå¯åŠ¨ï¼Œä¸€æ—¦å®¹å™¨å¯åŠ¨å®Œæˆåï¼Œæˆ‘ä»¬å°±å¯ä»¥ç™»å½•åˆ°å®¹å™¨ä¸­å®‰è£…è‡ªå·±éœ€è¦çš„è½¯ä»¶æˆ–è€…æœåŠ¡ã€‚ æ‰€ä»¥Dockerå®¹å™¨å°±æ˜¯ï¼š â€‹ ä¸€ä¸ªé•œåƒæ ¼å¼ï¼› â€‹ ä¸€äº›åˆ—æ ‡å‡†æ“ä½œï¼› â€‹ ä¸€ä¸ªæ‰§è¡Œç¯å¢ƒã€‚ â€‹ Dockerå€Ÿé‰´äº†æ ‡å‡†é›†è£…ç®±çš„æ¦‚å¿µã€‚æ ‡å‡†é›†è£…ç®±å°†è´§ç‰©è¿å¾€ä¸–ç•Œå„åœ°ï¼ŒDockerå°†è¿™ä¸ªæ¨¡å‹è¿ç”¨åˆ°è‡ªå·±çš„è®¾è®¡ä¸­ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯ï¼šé›†è£…ç®±è¿è¾“è´§ç‰©ï¼Œè€ŒDockerè¿è¾“è½¯ä»¶ã€‚ å’Œé›†è£…ç®±ä¸€æ ·ï¼ŒDockeråœ¨æ‰§è¡Œä¸Šè¿°æ“ä½œæ—¶ï¼Œå¹¶ä¸å…³å¿ƒå®¹å™¨ä¸­åˆ°åº•è£…äº†ä»€ä¹ˆï¼Œå®ƒä¸ç®¡æ˜¯webæœåŠ¡å™¨ï¼Œè¿˜æ˜¯æ•°æ®åº“ï¼Œæˆ–è€…æ˜¯åº”ç”¨ç¨‹åºæœåŠ¡å™¨ä»€ä¹ˆçš„ã€‚æ‰€æœ‰çš„å®¹å™¨éƒ½æŒ‰ç…§ç›¸åŒçš„æ–¹å¼å°†å†…å®¹â€œè£…è½½â€è¿›å»ã€‚ Dockerä¹Ÿä¸å…³å¿ƒä½ è¦æŠŠå®¹å™¨è¿åˆ°ä½•æ–¹ï¼šæˆ‘ä»¬å¯ä»¥åœ¨è‡ªå·±çš„ç¬”è®°æœ¬ä¸­æ„å»ºå®¹å™¨ï¼Œä¸Šä¼ åˆ°Registryï¼Œç„¶åä¸‹è½½åˆ°ä¸€ä¸ªç‰©ç†çš„æˆ–è€…è™šæ‹Ÿçš„æœåŠ¡å™¨æ¥æµ‹è¯•ï¼Œåœ¨æŠŠå®¹å™¨éƒ¨ç½²åˆ°å…·ä½“çš„ä¸»æœºä¸­ã€‚åƒæ ‡å‡†é›†è£…ç®±ä¸€æ ·ï¼ŒDockerå®¹å™¨æ–¹ä¾¿æ›¿æ¢ï¼Œå¯ä»¥å åŠ ï¼Œæ˜“äºåˆ†å‘ï¼Œå¹¶ä¸”å°½é‡é€šç”¨ã€‚ 1.4.3 Registryï¼ˆæ³¨å†Œä¸­å¿ƒï¼‰ â€‹ Dockerç”¨Registryæ¥ä¿å­˜ç”¨æˆ·æ„å»ºçš„é•œåƒã€‚Registryåˆ†ä¸ºå…¬å…±å’Œç§æœ‰ä¸¤ç§ã€‚Dockerå…¬å¸è¿è¥å…¬å…±çš„Registryå«åšDocker Hubã€‚ç”¨æˆ·å¯ä»¥åœ¨Docker Hubæ³¨å†Œè´¦å·ï¼Œåˆ†äº«å¹¶ä¿å­˜è‡ªå·±çš„é•œåƒï¼ˆè¯´æ˜ï¼šåœ¨Docker Hubä¸‹è½½é•œåƒå·¨æ…¢ï¼Œå¯ä»¥è‡ªå·±æ„å»ºç§æœ‰çš„Registryï¼‰ã€‚ â€‹ https://hub.docker.com/ 2 Dockerå®‰è£…ä¸å¯åŠ¨ 2.1 å®‰è£…Docker â€‹ Dockerå®˜æ–¹å»ºè®®åœ¨Ubuntuä¸­å®‰è£…ï¼Œå› ä¸ºDockeræ˜¯åŸºäºUbuntuå‘å¸ƒçš„ï¼Œè€Œä¸”ä¸€èˆ¬Dockerå‡ºç°çš„é—®é¢˜Ubuntuæ˜¯æœ€å…ˆæ›´æ–°æˆ–è€…æ‰“è¡¥ä¸çš„ã€‚åœ¨å¾ˆå¤šç‰ˆæœ¬çš„CentOSä¸­æ˜¯ä¸æ”¯æŒæ›´æ–°æœ€æ–°çš„ä¸€äº›è¡¥ä¸åŒ…çš„ã€‚ â€‹ ç”±äºæˆ‘ä»¬å­¦ä¹ çš„ç¯å¢ƒéƒ½ä½¿ç”¨çš„æ˜¯CentOSï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬å°†Dockerå®‰è£…åˆ°CentOSä¸Šã€‚æ³¨æ„ï¼šè¿™é‡Œå»ºè®®å®‰è£…åœ¨CentOS7.xä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œåœ¨CentOS6.xçš„ç‰ˆæœ¬ä¸­ï¼Œå®‰è£…å‰éœ€è¦å®‰è£…å…¶ä»–å¾ˆå¤šçš„ç¯å¢ƒè€Œä¸”Dockerå¾ˆå¤šè¡¥ä¸ä¸æ”¯æŒæ›´æ–°ã€‚ â€‹ è¯·ç›´æ¥æŒ‚è½½è¯¾ç¨‹é…å¥—çš„Centos7.xé•œåƒ ï¼ˆ1ï¼‰yum åŒ…æ›´æ–°åˆ°æœ€æ–° sudo yum update ï¼ˆ2ï¼‰å®‰è£…éœ€è¦çš„è½¯ä»¶åŒ…ï¼Œ yum-util æä¾›yum-config-manageråŠŸèƒ½ï¼Œå¦å¤–ä¸¤ä¸ªæ˜¯devicemapperé©±åŠ¨ä¾èµ–çš„ sudo yum install -y yum-utils device-mapper-persistent-data lvm2 ï¼ˆ3ï¼‰è®¾ç½®yumæºä¸ºé˜¿é‡Œäº‘ sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo ï¼ˆ4ï¼‰å®‰è£…docker sudo yum install docker-ce ï¼ˆ5ï¼‰å®‰è£…åæŸ¥çœ‹dockerç‰ˆæœ¬ docker -v 2.2 è®¾ç½®ustcçš„é•œåƒ ustcæ˜¯è€ç‰Œçš„linuxé•œåƒæœåŠ¡æä¾›è€…äº†ï¼Œè¿˜åœ¨é¥è¿œçš„ubuntu 5.04ç‰ˆæœ¬çš„æ—¶å€™å°±åœ¨ç”¨ã€‚ustcçš„dockeré•œåƒåŠ é€Ÿå™¨é€Ÿåº¦å¾ˆå¿«ã€‚ustc docker mirrorçš„ä¼˜åŠ¿ä¹‹ä¸€å°±æ˜¯ä¸éœ€è¦æ³¨å†Œï¼Œæ˜¯çœŸæ­£çš„å…¬å…±æœåŠ¡ã€‚ https://lug.ustc.edu.cn/wiki/mirrors/help/docker ç¼–è¾‘è¯¥æ–‡ä»¶ï¼š vi /etc/docker/daemon.json åœ¨è¯¥æ–‡ä»¶ä¸­è¾“å…¥å¦‚ä¸‹å†…å®¹ï¼š { &quot;registry-mirrors&quot;: [&quot;https://docker.mirrors.ustc.edu.cn&quot;] } 2.3 Dockerçš„å¯åŠ¨ä¸åœæ­¢ systemctlå‘½ä»¤æ˜¯ç³»ç»ŸæœåŠ¡ç®¡ç†å™¨æŒ‡ä»¤ å¯åŠ¨dockerï¼š systemctl start docker åœæ­¢dockerï¼š systemctl stop docker é‡å¯dockerï¼š systemctl restart docker æŸ¥çœ‹dockerçŠ¶æ€ï¼š systemctl status docker å¼€æœºå¯åŠ¨ï¼š systemctl enable docker æŸ¥çœ‹dockeræ¦‚è¦ä¿¡æ¯ docker info æŸ¥çœ‹dockerå¸®åŠ©æ–‡æ¡£ docker --help 3 å¸¸ç”¨å‘½ä»¤ 3.1 é•œåƒç›¸å…³å‘½ä»¤ 3.1.1 æŸ¥çœ‹é•œåƒ docker images REPOSITORYï¼šé•œåƒåç§° TAGï¼šé•œåƒæ ‡ç­¾ IMAGE IDï¼šé•œåƒID CREATEDï¼šé•œåƒçš„åˆ›å»ºæ—¥æœŸï¼ˆä¸æ˜¯è·å–è¯¥é•œåƒçš„æ—¥æœŸï¼‰ SIZEï¼šé•œåƒå¤§å° è¿™äº›é•œåƒéƒ½æ˜¯å­˜å‚¨åœ¨Dockerå®¿ä¸»æœºçš„/var/lib/dockerç›®å½•ä¸‹ 3.1.2 æœç´¢é•œåƒ å¦‚æœä½ éœ€è¦ä»ç½‘ç»œä¸­æŸ¥æ‰¾éœ€è¦çš„é•œåƒï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æœç´¢ docker search é•œåƒåç§° NAMEï¼šä»“åº“åç§° DESCRIPTIONï¼šé•œåƒæè¿° STARSï¼šç”¨æˆ·è¯„ä»·ï¼Œååº”ä¸€ä¸ªé•œåƒçš„å—æ¬¢è¿ç¨‹åº¦ OFFICIALï¼šæ˜¯å¦å®˜æ–¹ AUTOMATEDï¼šè‡ªåŠ¨æ„å»ºï¼Œè¡¨ç¤ºè¯¥é•œåƒç”±Docker Hubè‡ªåŠ¨æ„å»ºæµç¨‹åˆ›å»ºçš„ 3.1.3 æ‹‰å–é•œåƒ æ‹‰å–é•œåƒå°±æ˜¯ä»ä¸­å¤®ä»“åº“ä¸­ä¸‹è½½é•œåƒåˆ°æœ¬åœ° docker pull é•œåƒåç§° ä¾‹å¦‚ï¼Œæˆ‘è¦ä¸‹è½½centos7é•œåƒ docker pull centos:7 Dockeré‡‡ç”¨è”åˆæ–‡ä»¶ç³»ç»Ÿï¼Œä¸åŒé•œåƒçš„ç›¸åŒæ–‡ä»¶æ— éœ€å†æ¬¡ä¸‹è½½ï¼š 4 åˆ é™¤é•œåƒ æŒ‰é•œåƒIDåˆ é™¤é•œåƒ docker rmi é•œåƒID åˆ é™¤æ‰€æœ‰é•œåƒ docker rmi `docker images -q` 3.2 å®¹å™¨ç›¸å…³å‘½ä»¤ 3.2.1 æŸ¥çœ‹å®¹å™¨ æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨ docker ps æŸ¥çœ‹æ‰€æœ‰å®¹å™¨ docker ps â€“a æŸ¥çœ‹æœ€åä¸€æ¬¡è¿è¡Œçš„å®¹å™¨ docker ps â€“l æŸ¥çœ‹åœæ­¢çš„å®¹å™¨ docker ps -f status=exited 3.2.2 åˆ›å»ºä¸å¯åŠ¨å®¹å™¨ åˆ›å»ºå®¹å™¨å¸¸ç”¨çš„å‚æ•°è¯´æ˜ï¼š åˆ›å»ºå®¹å™¨å‘½ä»¤ï¼šdocker run -iï¼šè¡¨ç¤ºè¿è¡Œå®¹å™¨ -tï¼šè¡¨ç¤ºå®¹å™¨å¯åŠ¨åä¼šè¿›å…¥å…¶å‘½ä»¤è¡Œã€‚åŠ å…¥è¿™ä¸¤ä¸ªå‚æ•°åï¼Œå®¹å™¨åˆ›å»ºå°±èƒ½ç™»å½•è¿›å»ã€‚å³åˆ†é…ä¸€ä¸ªä¼ªç»ˆç«¯ã€‚ --name :ä¸ºåˆ›å»ºçš„å®¹å™¨å‘½åã€‚ -vï¼šè¡¨ç¤ºç›®å½•æ˜ å°„å…³ç³»ï¼ˆå‰è€…æ˜¯å®¿ä¸»æœºç›®å½•ï¼Œåè€…æ˜¯æ˜ å°„åˆ°å®¿ä¸»æœºä¸Šçš„ç›®å½•ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨å¤šä¸ªï¼våšå¤šä¸ªç›®å½•æˆ–æ–‡ä»¶æ˜ å°„ã€‚æ³¨æ„ï¼šæœ€å¥½åšç›®å½•æ˜ å°„ï¼Œåœ¨å®¿ä¸»æœºä¸Šåšä¿®æ”¹ï¼Œç„¶åå…±äº«åˆ°å®¹å™¨ä¸Šã€‚ -dï¼šåœ¨runåé¢åŠ ä¸Š-då‚æ•°,åˆ™ä¼šåˆ›å»ºä¸€ä¸ªå®ˆæŠ¤å¼å®¹å™¨åœ¨åå°è¿è¡Œï¼ˆè¿™æ ·åˆ›å»ºå®¹å™¨åä¸ä¼šè‡ªåŠ¨ç™»å½•å®¹å™¨ï¼Œå¦‚æœåªåŠ -i -tä¸¤ä¸ªå‚æ•°ï¼Œåˆ›å»ºåå°±ä¼šè‡ªåŠ¨è¿›å»å®¹å™¨ï¼‰ã€‚ -pï¼šè¡¨ç¤ºç«¯å£æ˜ å°„ï¼Œå‰è€…æ˜¯å®¿ä¸»æœºç«¯å£ï¼Œåè€…æ˜¯å®¹å™¨å†…çš„æ˜ å°„ç«¯å£ã€‚å¯ä»¥ä½¿ç”¨å¤šä¸ª-påšå¤šä¸ªç«¯å£æ˜ å°„ ï¼ˆ1ï¼‰äº¤äº’å¼æ–¹å¼åˆ›å»ºå®¹å™¨ docker run -it --name=å®¹å™¨åç§° é•œåƒåç§°:æ ‡ç­¾ /bin/bash è¿™æ—¶æˆ‘ä»¬é€šè¿‡pså‘½ä»¤æŸ¥çœ‹ï¼Œå‘ç°å¯ä»¥çœ‹åˆ°å¯åŠ¨çš„å®¹å™¨ï¼ŒçŠ¶æ€ä¸ºå¯åŠ¨çŠ¶æ€ é€€å‡ºå½“å‰å®¹å™¨ exit ï¼ˆ2ï¼‰å®ˆæŠ¤å¼æ–¹å¼åˆ›å»ºå®¹å™¨ï¼š docker run -di --name=å®¹å™¨åç§° é•œåƒåç§°:æ ‡ç­¾ ç™»å½•å®ˆæŠ¤å¼å®¹å™¨æ–¹å¼ï¼š docker exec -it å®¹å™¨åç§° (æˆ–è€…å®¹å™¨ID) /bin/bash Exit # ä»å®¹å™¨ä¸­é€€å›ä¸»æœº CTRL+Q+P # å®¹å™¨ä¸åœæ­¢é€€å‡º 3.2.3 åœæ­¢ä¸å¯åŠ¨å®¹å™¨ åœæ­¢å®¹å™¨ï¼š docker stop å®¹å™¨åç§°ï¼ˆæˆ–è€…å®¹å™¨IDï¼‰ å¯åŠ¨å®¹å™¨ï¼š docker start å®¹å™¨åç§°ï¼ˆæˆ–è€…å®¹å™¨IDï¼‰ 3.2.4 æ–‡ä»¶æ‹·è´ å¦‚æœæˆ‘ä»¬éœ€è¦å°†æ–‡ä»¶æ‹·è´åˆ°å®¹å™¨å†…å¯ä»¥ä½¿ç”¨cpå‘½ä»¤ docker cp éœ€è¦æ‹·è´çš„æ–‡ä»¶æˆ–ç›®å½• å®¹å™¨åç§°:å®¹å™¨ç›®å½• ä¹Ÿå¯ä»¥å°†æ–‡ä»¶ä»å®¹å™¨å†…æ‹·è´å‡ºæ¥ docker cp å®¹å™¨åç§°:å®¹å™¨ç›®å½• éœ€è¦æ‹·è´çš„æ–‡ä»¶æˆ–ç›®å½• 3.2.5 ç›®å½•æŒ‚è½½ æˆ‘ä»¬å¯ä»¥åœ¨åˆ›å»ºå®¹å™¨çš„æ—¶å€™ï¼Œå°†å®¿ä¸»æœºçš„ç›®å½•ä¸å®¹å™¨å†…çš„ç›®å½•è¿›è¡Œæ˜ å°„ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä¿®æ”¹å®¿ä¸»æœºæŸä¸ªç›®å½•çš„æ–‡ä»¶ä»è€Œå»å½±å“å®¹å™¨ã€‚ åˆ›å»ºå®¹å™¨ æ·»åŠ -vå‚æ•° åè¾¹ä¸º å®¿ä¸»æœºç›®å½•:å®¹å™¨ç›®å½•ï¼Œä¾‹å¦‚ï¼š docker run -di -v /usr/local/myhtml:/usr/local/myhtml --name=mycentos3 centos:7 å¦‚æœä½ å…±äº«çš„æ˜¯å¤šçº§çš„ç›®å½•ï¼Œå¯èƒ½ä¼šå‡ºç°æƒé™ä¸è¶³çš„æç¤ºã€‚ è¿™æ˜¯å› ä¸ºCentOS7ä¸­çš„å®‰å…¨æ¨¡å—selinuxæŠŠæƒé™ç¦æ‰äº†ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ å‚æ•° --privileged=true æ¥è§£å†³æŒ‚è½½çš„ç›®å½•æ²¡æœ‰æƒé™çš„é—®é¢˜ åŒ¿åæŒ‚è½½ docker run -d -v å®¹å™¨å†…ç›®å½• é•œåƒå/id # åŒ¿åæŒ‚è½½ åŒ¿åæŒ‚è½½åï¼Œä½¿ç”¨docker volume lså‘½ä»¤æŸ¥çœ‹æ‰€æœ‰æŒ‚è½½çš„å·ï¼š æ¯ä¸€ä¸ªVOLUME NAMEå¯¹åº”ä¸€ä¸ªæŒ‚è½½çš„å·ï¼Œç”±äºæŒ‚è½½æ—¶æœªæŒ‡å®šä¸»æœºç›®å½•ï¼Œå› æ­¤æ— æ³•ç›´æ¥æ‰¾åˆ°ç›®å½•ã€‚ å…·åæŒ‚è½½ docker run -d -v å·åï¼šå®¹å™¨å†…ç›®å½• é•œåƒå/id # å…·åæŒ‚è½½ å¯ä»¥å‘ç°æŒ‚è½½çš„å·ï¼švolume01ï¼Œå¹¶é€šè¿‡docker volume inspect å·å å‘½ä»¤æ‰¾åˆ°ä¸»æœºå†…ç›®å½•ï¼š æ‰€æœ‰dockerå®¹å™¨å†…çš„å·ï¼Œåœ¨æœªæŒ‡å®šä¸»æœºå†…ç›®å½•æ—¶ï¼Œéƒ½åœ¨ï¼š/var/lib/docker/volumes/å·å/_data ä¸‹ï¼Œå¯é€šè¿‡å…·åæŒ‚è½½å¯ä»¥æ–¹ä¾¿çš„æ‰¾åˆ°å·ï¼Œå› æ­¤å¹¿æ³›ä½¿ç”¨è¿™ç§æ–¹å¼è¿›è¡ŒæŒ‚è½½ã€‚ æ•°æ®å·å®¹å™¨ docker run -it --name container02 --volumes from container01 é•œåƒå/id # å°†ä¸¤ä¸ªå®¹å™¨è¿›è¡ŒæŒ‚è½½ 3.2.6 æŸ¥çœ‹å®¹å™¨IPåœ°å€ æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å®¹å™¨è¿è¡Œçš„å„ç§æ•°æ® docker inspect å®¹å™¨åç§°ï¼ˆå®¹å™¨IDï¼‰ ä¹Ÿå¯ä»¥ç›´æ¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ç›´æ¥è¾“å‡ºIPåœ°å€ docker inspect --format='{{.NetworkSettings.IPAddress}}' å®¹å™¨åç§°ï¼ˆå®¹å™¨IDï¼‰ 3.2.7 åˆ é™¤å®¹å™¨ åˆ é™¤æŒ‡å®šçš„å®¹å™¨ï¼š docker rm å®¹å™¨åç§°ï¼ˆå®¹å™¨IDï¼‰ 3.2.8 å…¶ä»–å‘½ä»¤ docker start/restart/stop/kill å®¹å™¨å/id docker logs -tf --tail æ˜¾ç¤ºçš„æ—¥å¿—æ¡æ•° å®¹å™¨å/id # æŸ¥çœ‹æ—¥å¿— docker top å®¹å™¨å/id # æŸ¥çœ‹å®¹å™¨ä¸­çš„è¿›ç¨‹ä¿¡æ¯ docker inspect å®¹å™¨å/id # æŸ¥çœ‹é•œåƒçš„å…ƒæ•°æ® docker exec -it å®¹å™¨å/id /bin/bash # é€šå¸¸å®¹å™¨ä»¥åå°æ–¹å¼è¿è¡Œï¼Œéœ€è¦è¿›å…¥å…¶ä¸­ä¿®æ”¹é…ç½®ï¼šè¿›å…¥å®¹å™¨åå¼€å¯ä¸€ä¸ªæ–°ç»ˆç«¯ docker attach å®¹å™¨å/id # è¿›å…¥å®¹å™¨æ­£åœ¨æ‰§è¡Œçš„ç»ˆç«¯ docker cp å®¹å™¨å/id:å®¹å™¨å†…è·¯å¾„ ä¸»æœºæ–‡ä»¶è·¯å¾„ # ä»å®¹å™¨å†…æ‹·è´æ–‡ä»¶åˆ°ä¸»æœºä¸Š 4 Dockeré•œåƒè¯¦è§£ UnionFSï¼ˆè”åˆæ–‡ä»¶ç³»ç»Ÿï¼‰ è”åˆæ–‡ä»¶ç³»ç»Ÿï¼ˆUnionFSï¼‰æ˜¯ä¸€ç§åˆ†å±‚ã€è½»é‡çº§å¹¶ä¸”é«˜æ€§èƒ½çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒæ”¯æŒå¯¹æ–‡ä»¶ç³»ç»Ÿçš„ä¿®æ”¹ä½œä¸ºä¸€æ¬¡æäº¤æ¥ä¸€å±‚å±‚çš„å åŠ ï¼ŒåŒæ—¶å¯ä»¥å°†ä¸åŒç›®å½•æŒ‚è½½åˆ°åŒä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸‹ã€‚è”åˆæ–‡ä»¶ç³»ç»Ÿæ˜¯ Docker é•œåƒçš„åŸºç¡€ã€‚é•œåƒå¯ä»¥é€šè¿‡åˆ†å±‚æ¥è¿›è¡Œç»§æ‰¿ï¼ŒåŸºäºåŸºç¡€é•œåƒï¼ˆæ²¡æœ‰çˆ¶é•œåƒï¼‰ï¼Œå¯ä»¥åˆ¶ä½œå„ç§å…·ä½“çš„åº”ç”¨é•œåƒã€‚ ç‰¹æ€§ï¼šä¸€æ¬¡åŒæ—¶åŠ è½½å¤šä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œä½†ä»å¤–é¢çœ‹èµ·æ¥åªèƒ½çœ‹åˆ°ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿã€‚è”åˆåŠ è½½ä¼šæŠŠå„å±‚æ–‡ä»¶ç³»ç»Ÿå åŠ èµ·æ¥ï¼Œè¿™æ ·æœ€ç»ˆçš„æ–‡ä»¶ç³»ç»Ÿä¼šåŒ…å«æ‰€æœ‰åº•å±‚çš„æ–‡ä»¶å’Œç›®å½•ã€‚ é•œåƒåŠ è½½åŸç† Dockerçš„é•œåƒå®é™…ç”±ä¸€å±‚ä¸€å±‚çš„æ–‡ä»¶ç³»ç»Ÿç»„æˆï¼š bootfsï¼ˆboot file systemï¼‰ä¸»è¦åŒ…å«bootloaderå’Œkernelã€‚bootloaderä¸»è¦æ˜¯å¼•å¯¼åŠ è½½kernelï¼Œå®Œæˆåæ•´ä¸ªå†…æ ¸å°±éƒ½åœ¨å†…å­˜ä¸­äº†ã€‚æ­¤æ—¶å†…å­˜çš„ä½¿ç”¨æƒå·²ç”±bootfsè½¬äº¤ç»™å†…æ ¸ï¼Œç³»ç»Ÿå¸è½½bootfsã€‚å¯ä»¥è¢«ä¸åŒçš„Linuxå‘è¡Œç‰ˆå…¬ç”¨ã€‚ rootfsï¼ˆroot file systemï¼‰ï¼ŒåŒ…å«å…¸å‹Linuxç³»ç»Ÿä¸­çš„/devï¼Œ/procï¼Œ/binï¼Œ/etcç­‰æ ‡å‡†ç›®å½•å’Œæ–‡ä»¶ã€‚rootfså°±æ˜¯å„ç§ä¸åŒæ“ä½œç³»ç»Ÿå‘è¡Œç‰ˆï¼ˆUbuntuï¼ŒCentosç­‰ï¼‰ã€‚å› ä¸ºåº•å±‚ç›´æ¥ç”¨Hostçš„kernelï¼ŒrootfsåªåŒ…å«æœ€åŸºæœ¬çš„å‘½ä»¤ï¼Œå·¥å…·å’Œç¨‹åºå°±å¯ä»¥äº†ã€‚ åˆ†å±‚ç†è§£ æ‰€æœ‰çš„Dockeré•œåƒéƒ½èµ·å§‹äºä¸€ä¸ªåŸºç¡€é•œåƒå±‚ï¼Œå½“è¿›è¡Œä¿®æ”¹æˆ–å¢åŠ æ–°çš„å†…å®¹æ—¶ï¼Œå°±ä¼šåœ¨å½“å‰é•œåƒå±‚ä¹‹ä¸Šï¼Œåˆ›å»ºæ–°çš„å®¹å™¨å±‚ã€‚ å®¹å™¨åœ¨å¯åŠ¨æ—¶ä¼šåœ¨é•œåƒæœ€å¤–å±‚ä¸Šå»ºç«‹ä¸€å±‚å¯è¯»å†™çš„å®¹å™¨å±‚ï¼ˆR/Wï¼‰ï¼Œè€Œé•œåƒå±‚æ˜¯åªè¯»çš„ï¼ˆR/Oï¼‰ã€‚ docker commit -m=&quot;æè¿°ä¿¡æ¯&quot; -a=&quot;ä½œè€…&quot; å®¹å™¨id ç›®æ ‡é•œåƒå:[tag] # ç¼–è¾‘å®¹å™¨åæäº¤å®¹å™¨æˆä¸ºä¸€ä¸ªæ–°é•œåƒ 4 åº”ç”¨éƒ¨ç½² 4.1 MySQLéƒ¨ç½² ï¼ˆ1ï¼‰æ‹‰å–mysqlé•œåƒ docker pull centos/mysql-57-centos7 ï¼ˆ2ï¼‰åˆ›å»ºå®¹å™¨ docker run -di --name=tensquare_mysql -p 33306:3306 -e MYSQL_ROOT_PASSWORD=123456 mysql -p ä»£è¡¨ç«¯å£æ˜ å°„ï¼Œæ ¼å¼ä¸º å®¿ä¸»æœºæ˜ å°„ç«¯å£:å®¹å™¨è¿è¡Œç«¯å£ -e ä»£è¡¨æ·»åŠ ç¯å¢ƒå˜é‡ MYSQL_ROOT_PASSWORD æ˜¯rootç”¨æˆ·çš„ç™»é™†å¯†ç  ï¼ˆ3ï¼‰è¿œç¨‹ç™»å½•mysql è¿æ¥å®¿ä¸»æœºçš„IP ,æŒ‡å®šç«¯å£ä¸º33306 4.2 tomcatéƒ¨ç½² ï¼ˆ1ï¼‰æ‹‰å–é•œåƒ docker pull tomcat:7-jre7 ï¼ˆ2ï¼‰åˆ›å»ºå®¹å™¨ åˆ›å»ºå®¹å™¨ -pè¡¨ç¤ºåœ°å€æ˜ å°„ docker run -di --name=mytomcat -p 9000:8080 -v /usr/local/webapps:/usr/local/tomcat/webapps tomcat:7-jre7 4.3 Nginxéƒ¨ç½² ï¼ˆ1ï¼‰æ‹‰å–é•œåƒ docker pull nginx ï¼ˆ2ï¼‰åˆ›å»ºNginxå®¹å™¨ docker run -di --name=mynginx -p 80:80 nginx 4.4 Rediséƒ¨ç½² ï¼ˆ1ï¼‰æ‹‰å–é•œåƒ docker pull redis ï¼ˆ2ï¼‰åˆ›å»ºå®¹å™¨ docker run -di --name=myredis -p 6379:6379 redis 4.5 Redisé›†ç¾¤éƒ¨ç½² # åˆ›å»ºç½‘å¡ docker network create redis --subnet 172.38.0.0/16 # é€šè¿‡è„šæœ¬åˆ›å»ºå…­ä¸ªredisé…ç½® for port in $(seq 1 6);\\ do \\ mkdir -p /mydata/redis/node-${port}/conf touch /mydata/redis/node-${port}/conf/redis.conf cat &lt;&lt; EOF &gt;&gt; /mydata/redis/node-${port}/conf/redis.conf port 6379 bind 0.0.0.0 cluster-enabled yes cluster-config-file nodes.conf cluster-node-timeout 5000 cluster-announce-ip 172.38.0.1${port} cluster-announce-port 6379 cluster-announce-bus-port 16379 appendonly yes EOF done # é€šè¿‡è„šæœ¬è¿è¡Œå…­ä¸ªredis for port in $(seq 1 6);\\ docker run -p 637${port}:6379 -p 1667${port}:16379 --name redis-${port} \\ -v /mydata/redis/node-${port}/data:/data \\ -v /mydata/redis/node-${port}/conf/redis.conf:/etc/redis/redis.conf \\ -d --net redis --ip 172.38.0.1${port} redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf docker exec -it redis-1 /bin/sh #redisé»˜è®¤æ²¡æœ‰bash redis-cli --cluster create 172.38.0.11:6379 172.38.0.12:6379 172.38.0.13:6379 172.38.0.14:6379 172.38.0.15:6379 172.38.0.16:6379 --cluster-replicas 1 5 è¿ç§»ä¸å¤‡ä»½ 5.1 å®¹å™¨ä¿å­˜ä¸ºé•œåƒ æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å°†å®¹å™¨ä¿å­˜ä¸ºé•œåƒ docker commit mynginx mynginx_i 5.2 é•œåƒå¤‡ä»½ æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å°†é•œåƒä¿å­˜ä¸ºtar æ–‡ä»¶ docker save -o mynginx.tar mynginx_i 5.3 é•œåƒæ¢å¤ä¸è¿ç§» é¦–å…ˆæˆ‘ä»¬å…ˆåˆ é™¤æ‰mynginx_imgé•œåƒ ç„¶åæ‰§è¡Œæ­¤å‘½ä»¤è¿›è¡Œæ¢å¤ docker load -i mynginx.tar -i è¾“å…¥çš„æ–‡ä»¶ æ‰§è¡Œåå†æ¬¡æŸ¥çœ‹é•œåƒï¼Œå¯ä»¥çœ‹åˆ°é•œåƒå·²ç»æ¢å¤ 6 Dockerfile 6.1 ä»€ä¹ˆæ˜¯Dockerfile Dockerfileæ˜¯ç”±ä¸€ç³»åˆ—å‘½ä»¤å’Œå‚æ•°æ„æˆçš„è„šæœ¬ï¼Œè¿™äº›å‘½ä»¤åº”ç”¨äºåŸºç¡€é•œåƒå¹¶æœ€ç»ˆåˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒã€‚ 1ã€å¯¹äºå¼€å‘äººå‘˜ï¼šå¯ä»¥ä¸ºå¼€å‘å›¢é˜Ÿæä¾›ä¸€ä¸ªå®Œå…¨ä¸€è‡´çš„å¼€å‘ç¯å¢ƒï¼› 2ã€å¯¹äºæµ‹è¯•äººå‘˜ï¼šå¯ä»¥ç›´æ¥æ‹¿å¼€å‘æ—¶æ‰€æ„å»ºçš„é•œåƒæˆ–è€…é€šè¿‡Dockerfileæ–‡ä»¶æ„å»ºä¸€ä¸ªæ–°çš„é•œåƒå¼€å§‹å·¥ä½œäº†ï¼› 3ã€å¯¹äºè¿ç»´äººå‘˜ï¼šåœ¨éƒ¨ç½²æ—¶ï¼Œå¯ä»¥å®ç°åº”ç”¨çš„æ— ç¼ç§»æ¤ã€‚ 6.2 å¸¸ç”¨å‘½ä»¤ å‘½ä»¤ ä½œç”¨ FROM image_name:tag å®šä¹‰äº†ä½¿ç”¨å“ªä¸ªåŸºç¡€é•œåƒå¯åŠ¨æ„å»ºæµç¨‹ MAINTAINER user_name å£°æ˜é•œåƒçš„åˆ›å»ºè€… ENV key value è®¾ç½®ç¯å¢ƒå˜é‡ (å¯ä»¥å†™å¤šæ¡) RUN command æ˜¯Dockerfileçš„æ ¸å¿ƒéƒ¨åˆ†(å¯ä»¥å†™å¤šæ¡) ADD source_dir/file dest_dir/file å°†å®¿ä¸»æœºçš„æ–‡ä»¶å¤åˆ¶åˆ°å®¹å™¨å†…ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªå‹ç¼©æ–‡ä»¶ï¼Œå°†ä¼šåœ¨å¤åˆ¶åè‡ªåŠ¨è§£å‹ COPY source_dir/file dest_dir/file å’ŒADDç›¸ä¼¼ï¼Œä½†æ˜¯å¦‚æœæœ‰å‹ç¼©æ–‡ä»¶å¹¶ä¸èƒ½è§£å‹ WORKDIR path_dir è®¾ç½®å·¥ä½œç›®å½• 6.3 ä½¿ç”¨è„šæœ¬åˆ›å»ºé•œåƒ æ­¥éª¤ï¼š ï¼ˆ1ï¼‰åˆ›å»ºç›®å½• mkdir â€“p /usr/local/dockerjdk8 ï¼ˆ2ï¼‰ä¸‹è½½jdk-8u171-linux-x64.tar.gzå¹¶ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼ˆè™šæ‹Ÿæœºï¼‰ä¸­çš„/usr/local/dockerjdk8ç›®å½• ï¼ˆ3ï¼‰åˆ›å»ºæ–‡ä»¶Dockerfile vi Dockerfile #ä¾èµ–é•œåƒåç§°å’ŒID FROM centos:7 #æŒ‡å®šé•œåƒåˆ›å»ºè€…ä¿¡æ¯ MAINTAINER ITCAST #åˆ‡æ¢å·¥ä½œç›®å½• WORKDIR /usr RUN mkdir /usr/local/java #ADD æ˜¯ç›¸å¯¹è·¯å¾„jar,æŠŠjavaæ·»åŠ åˆ°å®¹å™¨ä¸­ ADD jdk-8u171-linux-x64.tar.gz /usr/local/java/ #é…ç½®javaç¯å¢ƒå˜é‡ ENV JAVA_HOME /usr/local/java/jdk1.8.0_171 ENV JRE_HOME $JAVA_HOME/jre ENV CLASSPATH $JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar:$JRE_HOME/lib:$CLASSPATH ENV PATH $JAVA_HOME/bin:$PATH ï¼ˆ4ï¼‰æ‰§è¡Œå‘½ä»¤æ„å»ºé•œåƒ docker build -t='jdk1.8' . æ³¨æ„åè¾¹çš„ç©ºæ ¼å’Œç‚¹ï¼Œä¸è¦çœç•¥ ï¼ˆ5ï¼‰æŸ¥çœ‹é•œåƒæ˜¯å¦å»ºç«‹å®Œæˆ docker images 7 Dockerç§æœ‰ä»“åº“ 7.1 ç§æœ‰ä»“åº“æ­å»ºä¸é…ç½® ï¼ˆ1ï¼‰æ‹‰å–ç§æœ‰ä»“åº“é•œåƒï¼ˆæ­¤æ­¥çœç•¥ï¼‰ docker pull registry ï¼ˆ2ï¼‰å¯åŠ¨ç§æœ‰ä»“åº“å®¹å™¨ docker run -di --name=registry -p 5000:5000 registry ï¼ˆ3ï¼‰æ‰“å¼€æµè§ˆå™¨ è¾“å…¥åœ°å€http://192.168.184.141:5000/v2/_catalogçœ‹åˆ°{&quot;repositories&quot;:[]} è¡¨ç¤ºç§æœ‰ä»“åº“æ­å»ºæˆåŠŸå¹¶ä¸”å†…å®¹ä¸ºç©º ï¼ˆ4ï¼‰ä¿®æ”¹daemon.json vi /etc/docker/daemon.json æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼Œä¿å­˜é€€å‡ºã€‚ {&quot;insecure-registries&quot;:[&quot;192.168.184.141:5000&quot;]} æ­¤æ­¥ç”¨äºè®© dockerä¿¡ä»»ç§æœ‰ä»“åº“åœ°å€ ï¼ˆ5ï¼‰é‡å¯docker æœåŠ¡ systemctl restart docker 7.2 é•œåƒä¸Šä¼ è‡³ç§æœ‰ä»“åº“ ï¼ˆ1ï¼‰æ ‡è®°æ­¤é•œåƒä¸ºç§æœ‰ä»“åº“çš„é•œåƒ docker tag jdk1.8 192.168.184.141:5000/jdk1.8 ï¼ˆ2ï¼‰å†æ¬¡å¯åŠ¨ç§æœå®¹å™¨ docker start registry ï¼ˆ3ï¼‰ä¸Šä¼ æ ‡è®°çš„é•œåƒ docker push 192.168.184.141:5000/jdk1.8 8 Dockerç½‘ç»œ 8.1 ç†è§£Doker0 é€šè¿‡å‘½ä»¤ip addræŸ¥çœ‹æœ¬åœ°ipåœ°å€ï¼Œæˆ‘ä»¬å‘ç°é™¤äº†æœ¬æœºå›ç¯åœ°å€å’ŒåŸƒé‡Œè¿œçš„å†…ç½‘åœ°å€å¤–ï¼Œè¿˜å¤šäº†ä¸€ä¸ªç½‘å¡ï¼šDocker0ï¼Œè¿™æ˜¯DockeræœåŠ¡å¯åŠ¨åè‡ªåŠ¨ç”Ÿæˆçš„ã€‚ è€Œå¦‚æœè¿›å…¥ä¸€ä¸ªæ­£åœ¨åå°è¿è¡Œçš„tomcatå®¹å™¨ï¼ŒåŒæ ·ä½¿ç”¨ip addrå‘½ä»¤ï¼Œå‘ç°å®¹å™¨å¾—åˆ°äº†ä¸€ä¸ªæ–°çš„ç½‘ç»œï¼š12: eth@if13ï¼Œipåœ°å€ï¼š172.17.0.2ã€‚è¿™æ˜¯Dockeråœ¨å®¹å™¨å¯åŠ¨æ—¶ä¸ºå…¶åˆ†é…çš„ã€‚ æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼šæ­¤æ—¶æˆ‘ä»¬çš„linuxä¸»æœºå¯ä»¥pingé€šå®¹å™¨å†…éƒ¨ï¼ˆ172.17.0.2ï¼‰å—ï¼Ÿï¼ˆæ³¨æ„ä¸å®¹å™¨æš´éœ²ç«¯å£ç›¸åŒºåˆ†) linuxå¯ä»¥pingé€šdockerå®¹å™¨å†…éƒ¨ï¼Œå› ä¸ºdocker0çš„ipåœ°å€ä¸º172.17.0.1ï¼Œå®¹å™¨ä¸º172.17.0.2ã€‚ åŸç†ï¼šæˆ‘ä»¬æ¯å¯åŠ¨ä¸€ä¸ªdockerå®¹å™¨ï¼Œdockerå°±ä¼šç»™å®¹å™¨åˆ†é…ä¸€ä¸ªé»˜è®¤çš„å¯ç”¨ipï¼Œæˆ‘ä»¬åªè¦å®‰è£…äº†dockerï¼Œå°±ä¼šæœ‰ä¸€ä¸ªç½‘å¡docker0(bridge)ã€‚ç½‘å¡é‡‡ç”¨æ¡¥æ¥æ¨¡å¼ï¼Œå¹¶ä½¿ç”¨veth-pairæŠ€æœ¯ï¼ˆveth-pairå°±æ˜¯ä¸€å †è™šæ‹Ÿè®¾å¤‡æ¥å£ï¼Œæˆå¯¹å‡ºç°ï¼Œä¸€æ®µè¿ç€åè®®ï¼Œä¸€æ®µå½¼æ­¤ç›¸è¿ï¼Œå……å½“ä¸€ä¸ªæ¡¥æ¢ã€‚ï¼‰ã€‚ è¿™æ—¶æˆ‘ä»¬é€€å‡ºå®¹å™¨ï¼Œå›åˆ°ä¸»æœºå†æ¬¡è§‚å¯Ÿä¸»æœºçš„ipåœ°å€ï¼š æˆ‘ä»¬æƒŠå¥‡åœ°å‘ç°äº†ä¸€ä¸ªæ–°ç½‘ç»œ13: vethda1df4b@if12ï¼Œå¯¹åº”å®¹å™¨å†…ç½‘ç»œåœ°å€çš„12: eth@if13ã€‚ å®¹å™¨å’Œå®¹å™¨ä¹‹é—´æ˜¯å¯ä»¥äº’ç›¸pingé€šçš„ï¼šå®¹å™¨1â†’Docker0â†’å®¹å™¨2 dockerä¸­çš„æ‰€æœ‰ç½‘ç»œæ¥å£éƒ½æ˜¯è™šæ‹Ÿçš„ ï¼Œè½¬å‘æ•ˆç‡é«˜ã€‚åˆ é™¤å®¹å™¨åï¼Œå¯¹åº”çš„ç½‘æ¡¥ä¹Ÿéšä¹‹åˆ é™¤ã€‚ 8.2 --link è‹¥ç¼–å†™ä¸€ä¸ªå¾®æœåŠ¡å¹¶è¿æ¥æ•°æ®åº“ï¼Œå¦‚æœæ•°æ®åº“ipæ”¹å˜ï¼Œå¦‚ä½•æ ¹æ®å®¹å™¨åè€Œä¸æ˜¯ipè®¿é—®å®¹å™¨ï¼Ÿæ˜¾ç„¶ï¼Œç›´æ¥ä½¿ç”¨å®¹å™¨åæ˜¯æ— æ³•pingé€šå®¹å™¨å†…éƒ¨çš„ï¼š è¿™æ—¶æˆ‘ä»¬å¯ä»¥åœ¨å®¹å™¨å¯åŠ¨å‘½ä»¤ä¸­åŠ å…¥ä¸€ä¸ªé€‰é¡¹ï¼š--linkï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥æ ¹æ®å®¹å™¨åæ¥è®¿é—®å®¹å™¨ã€‚ docker run -d -P --link å®¹å™¨å/id é•œåƒå/id ç„¶è€Œåå‘å°±ä¸å¯ä»¥pingé€šï¼Œè¿™æ˜¯å› ä¸º--linkçš„æœ¬è´¨æ˜¯æŠŠéœ€è¦è¿æ¥çš„å®¹å™¨å/idå†™å…¥å¯åŠ¨å®¹å™¨çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œå³å¢åŠ äº†ä¸€ä¸ªipå’Œå®¹å™¨å/idçš„æ˜ å°„ï¼š ç›®å‰å·²ç»ä¸å»ºè®®ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚ 8.3 è‡ªå®šä¹‰ç½‘ç»œ æˆ‘ä»¬ä½¿ç”¨å‘½ä»¤ï¼š docker network ls # æŸ¥çœ‹æ‰€æœ‰çš„dockerç½‘ç»œ dockerä¸­çš„ç½‘ç»œæ¨¡å¼æœ‰ï¼š bridgeï¼šæ¡¥æ¥ï¼ˆdockeré»˜è®¤ï¼‰/ noneï¼šä¸é…ç½®ç½‘ç»œ / hostï¼šå’Œå®¿ä¸»æœºå…±äº«ç½‘ç»œ docker run å‘½ä»¤é»˜è®¤å¸¦æœ‰ä¸€ä¸ªå‚æ•°--net bridgeï¼Œæ­¤å¤„çš„bridgeæŒ‡çš„å°±æ˜¯docker0ã€‚å¦‚æœæˆ‘ä»¬ä¸æƒ³ä½¿ç”¨docker0ï¼Œé‚£å¦‚ä½•åˆ›å»ºä¸€ä¸ªæ–°çš„ç½‘ç»œå‘¢ï¼Ÿ docker network create --driver ç½‘ç»œæ¨¡å¼ --subnet å­ç½‘ip --gateway ç½‘å…³ ç½‘ç»œå æˆ‘ä»¬ä¸ä»…åœ¨docker network lså‘½ä»¤ä¸‹å‘ç°äº†è¿™ä¸ªæ–°åˆ›å»ºçš„ç½‘ç»œnewnetï¼Œè¿˜å¯ä»¥ä½¿ç”¨docker network inspectå‘½ä»¤æŸ¥çœ‹å…¶è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬äº†æˆ‘ä»¬åˆ›å»ºæ—¶å®šä¹‰çš„å­ç½‘ipå’Œç½‘å…³ï¼š åªè¦ä¸¤ä¸ªå®¹å™¨å¯åŠ¨æ—¶éƒ½é€šè¿‡ --netï¼Œé€‰ç”¨äº†åŒä¸€ä¸ªå·²åˆ›å»ºçš„ç½‘ç»œï¼Œä¸åŒå®¹å™¨é—´å³å¯é€šè¿‡ipåœ°å€æˆ–å®¹å™¨å/idè¿é€š: 8.4 ç½‘ç»œè¿é€š å¯¹äºå»ºç«‹åœ¨ä¸åŒç½‘ç»œä¸‹(docker0, newnet)çš„ä¸¤ä¸ªå®¹å™¨tomcat01å’Œtomcat02ï¼Œä»–ä»¬çš„ç½‘æ®µä¸åŒï¼Œå› æ­¤æ˜¯æ— æ³•å½¼æ­¤pingé€šå®¹å™¨å†…éƒ¨çš„ï¼š è¿™æ—¶æˆ‘ä»¬éœ€è¦é€šè¿‡docker network connectå‘½ä»¤æ‰“é€šå®¹å™¨ä¸ç½‘ç»œä¹‹é—´çš„è¿æ¥ï¼š docker network connect ç½‘ç»œå å®¹å™¨å/id è¿™ä¸ªåŠŸèƒ½ç±»ä¼¼äºå°†ä¸€ä¸ªå®¹å™¨èµ‹äºˆå¤šä¸ªipåœ°å€ï¼ŒåŒæ ·å¯ä»¥ç”¨docker network inspectå‘½ä»¤æŸ¥çœ‹ç½‘ç»œè¿é€šåï¼Œè¯¥ç½‘ç»œçš„å˜åŒ–ï¼š åŸæœ¬newnetç½‘ç»œä¸­åªå«æœ‰tomcat02ï¼Œç°åœ¨å¢åŠ äº†tomcat01ï¼Œå› æ­¤å¯ä»¥è¿é€šã€‚ ","link":"https://tianxiawuhao.github.io/VSWRPm3xo/"},{"title":"Git æ“ä½œå‘½ä»¤æ¸…å•","content":"gitå·¥ä½œæµç¨‹å›¾ ä¸‹é¢æ˜¯å¸¸ç”¨ çš„Git å‘½ä»¤æ¸…å•ã€‚å‡ ä¸ªä¸“ç”¨åè¯çš„è¯‘åå¦‚ä¸‹ï¼š Workspaceï¼šå·¥ä½œåŒº Index / Stageï¼šæš‚å­˜åŒº Repositoryï¼šä»“åº“åŒºï¼ˆæˆ–æœ¬åœ°ä»“åº“ï¼‰ Remoteï¼šè¿œç¨‹ä»“åº“ ä¸€ã€æ–°å»ºä»£ç åº“ # åœ¨å½“å‰ç›®å½•æ–°å»ºä¸€ä¸ªGitä»£ç åº“ $ git init # æ–°å»ºä¸€ä¸ªç›®å½•ï¼Œå°†å…¶åˆå§‹åŒ–ä¸ºGitä»£ç åº“ $ git init [project-name] # ä¸‹è½½ä¸€ä¸ªé¡¹ç›®å’Œå®ƒçš„æ•´ä¸ªä»£ç å†å² $ git clone [url] äºŒã€é…ç½® Gitçš„è®¾ç½®æ–‡ä»¶ä¸º.gitconfigï¼Œå®ƒå¯ä»¥åœ¨ç”¨æˆ·ä¸»ç›®å½•ä¸‹ï¼ˆå…¨å±€é…ç½®ï¼‰ï¼Œä¹Ÿå¯ä»¥åœ¨é¡¹ç›®ç›®å½•ä¸‹ï¼ˆé¡¹ç›®é…ç½®ï¼‰ã€‚ # æ˜¾ç¤ºå½“å‰çš„Gité…ç½® $ git config --list # ç¼–è¾‘Gité…ç½®æ–‡ä»¶ $ git config -e [--global] # è®¾ç½®æäº¤ä»£ç æ—¶çš„ç”¨æˆ·ä¿¡æ¯ $ git config [--global] user.name &quot;[name]&quot; $ git config [--global] user.email &quot;[email address]&quot; ä¸‰ã€å¢åŠ /åˆ é™¤æ–‡ä»¶ # æ·»åŠ æŒ‡å®šæ–‡ä»¶åˆ°æš‚å­˜åŒº $ git add [file1] [file2] ... # æ·»åŠ æŒ‡å®šç›®å½•åˆ°æš‚å­˜åŒºï¼ŒåŒ…æ‹¬å­ç›®å½• $ git add [dir] # æ·»åŠ å½“å‰ç›®å½•çš„æ‰€æœ‰æ–‡ä»¶åˆ°æš‚å­˜åŒº $ git add . # æ·»åŠ æ¯ä¸ªå˜åŒ–å‰ï¼Œéƒ½ä¼šè¦æ±‚ç¡®è®¤ # å¯¹äºåŒä¸€ä¸ªæ–‡ä»¶çš„å¤šå¤„å˜åŒ–ï¼Œå¯ä»¥å®ç°åˆ†æ¬¡æäº¤ $ git add -p # åˆ é™¤å·¥ä½œåŒºæ–‡ä»¶ï¼Œå¹¶ä¸”å°†è¿™æ¬¡åˆ é™¤æ”¾å…¥æš‚å­˜åŒº $ git rm [file1] [file2] ... # åœæ­¢è¿½è¸ªæŒ‡å®šæ–‡ä»¶ï¼Œä½†è¯¥æ–‡ä»¶ä¼šä¿ç•™åœ¨å·¥ä½œåŒº $ git rm --cached [file] # æ”¹åæ–‡ä»¶ï¼Œå¹¶ä¸”å°†è¿™ä¸ªæ”¹åæ”¾å…¥æš‚å­˜åŒº $ git mv [file-original] [file-renamed] å››ã€ä»£ç æäº¤ # æäº¤æš‚å­˜åŒºåˆ°ä»“åº“åŒº $ git commit -m [message] # æäº¤æš‚å­˜åŒºçš„æŒ‡å®šæ–‡ä»¶åˆ°ä»“åº“åŒº $ git commit [file1] [file2] ... -m [message] # æäº¤å·¥ä½œåŒºè‡ªä¸Šæ¬¡commitä¹‹åçš„å˜åŒ–ï¼Œç›´æ¥åˆ°ä»“åº“åŒº $ git commit -a # æäº¤æ—¶æ˜¾ç¤ºæ‰€æœ‰diffä¿¡æ¯ $ git commit -v # ä½¿ç”¨ä¸€æ¬¡æ–°çš„commitï¼Œæ›¿ä»£ä¸Šä¸€æ¬¡æäº¤ # å¦‚æœä»£ç æ²¡æœ‰ä»»ä½•æ–°å˜åŒ–ï¼Œåˆ™ç”¨æ¥æ”¹å†™ä¸Šä¸€æ¬¡commitçš„æäº¤ä¿¡æ¯ $ git commit --amend -m [message] # é‡åšä¸Šä¸€æ¬¡commitï¼Œå¹¶åŒ…æ‹¬æŒ‡å®šæ–‡ä»¶çš„æ–°å˜åŒ– $ git commit --amend [file1] [file2] ... äº”ã€åˆ†æ”¯ # åˆ—å‡ºæ‰€æœ‰æœ¬åœ°åˆ†æ”¯ $ git branch # åˆ—å‡ºæ‰€æœ‰è¿œç¨‹åˆ†æ”¯ $ git branch -r # åˆ—å‡ºæ‰€æœ‰æœ¬åœ°åˆ†æ”¯å’Œè¿œç¨‹åˆ†æ”¯ $ git branch -a # æ–°å»ºä¸€ä¸ªåˆ†æ”¯ï¼Œä½†ä¾ç„¶åœç•™åœ¨å½“å‰åˆ†æ”¯ $ git branch [branch-name] # æ–°å»ºä¸€ä¸ªåˆ†æ”¯ï¼Œå¹¶åˆ‡æ¢åˆ°è¯¥åˆ†æ”¯ $ git checkout -b [branch] # æ–°å»ºä¸€ä¸ªåˆ†æ”¯ï¼ŒæŒ‡å‘æŒ‡å®šcommit $ git branch [branch] [commit] # æ–°å»ºä¸€ä¸ªåˆ†æ”¯ï¼Œä¸æŒ‡å®šçš„è¿œç¨‹åˆ†æ”¯å»ºç«‹è¿½è¸ªå…³ç³» $ git branch --track [branch] [remote-branch] # åˆ‡æ¢åˆ°æŒ‡å®šåˆ†æ”¯ï¼Œå¹¶æ›´æ–°å·¥ä½œåŒº $ git checkout [branch-name] # åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªåˆ†æ”¯ $ git checkout - # å»ºç«‹è¿½è¸ªå…³ç³»ï¼Œåœ¨ç°æœ‰åˆ†æ”¯ä¸æŒ‡å®šçš„è¿œç¨‹åˆ†æ”¯ä¹‹é—´ $ git branch --set-upstream [branch] [remote-branch] # åˆå¹¶æŒ‡å®šåˆ†æ”¯åˆ°å½“å‰åˆ†æ”¯ $ git merge [branch] # é€‰æ‹©ä¸€ä¸ªcommitï¼Œåˆå¹¶è¿›å½“å‰åˆ†æ”¯ $ git cherry-pick [commit] # åˆ é™¤åˆ†æ”¯ $ git branch -d [branch-name] # åˆ é™¤è¿œç¨‹åˆ†æ”¯ $ git push origin --delete [branch-name] $ git branch -dr [remote/branch] å…­ã€æ ‡ç­¾ # åˆ—å‡ºæ‰€æœ‰tag $ git tag # æ–°å»ºä¸€ä¸ªtagåœ¨å½“å‰commit $ git tag [tag] # æ–°å»ºä¸€ä¸ªtagåœ¨æŒ‡å®šcommit $ git tag [tag] [commit] # åˆ é™¤æœ¬åœ°tag $ git tag -d [tag] # åˆ é™¤è¿œç¨‹tag $ git push origin :refs/tags/[tagName] # æŸ¥çœ‹tagä¿¡æ¯ $ git show [tag] # æäº¤æŒ‡å®štag $ git push [remote] [tag] # æäº¤æ‰€æœ‰tag $ git push [remote] --tags # æ–°å»ºä¸€ä¸ªåˆ†æ”¯ï¼ŒæŒ‡å‘æŸä¸ªtag $ git checkout -b [branch] [tag] ä¸ƒã€æŸ¥çœ‹ä¿¡æ¯ # æ˜¾ç¤ºæœ‰å˜æ›´çš„æ–‡ä»¶ $ git status # æ˜¾ç¤ºå½“å‰åˆ†æ”¯çš„ç‰ˆæœ¬å†å² $ git log # æ˜¾ç¤ºcommitå†å²ï¼Œä»¥åŠæ¯æ¬¡commitå‘ç”Ÿå˜æ›´çš„æ–‡ä»¶ $ git log --stat # æœç´¢æäº¤å†å²ï¼Œæ ¹æ®å…³é”®è¯ $ git log -S [keyword] # æ˜¾ç¤ºæŸä¸ªcommitä¹‹åçš„æ‰€æœ‰å˜åŠ¨ï¼Œæ¯ä¸ªcommitå æ®ä¸€è¡Œ $ git log [tag] HEAD --pretty=format:%s # æ˜¾ç¤ºæŸä¸ªcommitä¹‹åçš„æ‰€æœ‰å˜åŠ¨ï¼Œå…¶&quot;æäº¤è¯´æ˜&quot;å¿…é¡»ç¬¦åˆæœç´¢æ¡ä»¶ $ git log [tag] HEAD --grep feature # æ˜¾ç¤ºæŸä¸ªæ–‡ä»¶çš„ç‰ˆæœ¬å†å²ï¼ŒåŒ…æ‹¬æ–‡ä»¶æ”¹å $ git log --follow [file] $ git whatchanged [file] # æ˜¾ç¤ºæŒ‡å®šæ–‡ä»¶ç›¸å…³çš„æ¯ä¸€æ¬¡diff $ git log -p [file] # æ˜¾ç¤ºè¿‡å»5æ¬¡æäº¤ $ git log -5 --pretty --oneline # æ˜¾ç¤ºæ‰€æœ‰æäº¤è¿‡çš„ç”¨æˆ·ï¼ŒæŒ‰æäº¤æ¬¡æ•°æ’åº $ git shortlog -sn # æ˜¾ç¤ºæŒ‡å®šæ–‡ä»¶æ˜¯ä»€ä¹ˆäººåœ¨ä»€ä¹ˆæ—¶é—´ä¿®æ”¹è¿‡ $ git blame [file] # æ˜¾ç¤ºæš‚å­˜åŒºå’Œå·¥ä½œåŒºçš„å·®å¼‚ $ git diff # æ˜¾ç¤ºæš‚å­˜åŒºå’Œä¸Šä¸€ä¸ªcommitçš„å·®å¼‚ $ git diff --cached [file] # æ˜¾ç¤ºå·¥ä½œåŒºä¸å½“å‰åˆ†æ”¯æœ€æ–°commitä¹‹é—´çš„å·®å¼‚ $ git diff HEAD # æ˜¾ç¤ºä¸¤æ¬¡æäº¤ä¹‹é—´çš„å·®å¼‚ $ git diff [first-branch]...[second-branch] # æ˜¾ç¤ºä»Šå¤©ä½ å†™äº†å¤šå°‘è¡Œä»£ç  $ git diff --shortstat &quot;@{0 day ago}&quot; # æ˜¾ç¤ºæŸæ¬¡æäº¤çš„å…ƒæ•°æ®å’Œå†…å®¹å˜åŒ– $ git show [commit] # æ˜¾ç¤ºæŸæ¬¡æäº¤å‘ç”Ÿå˜åŒ–çš„æ–‡ä»¶ $ git show --name-only [commit] # æ˜¾ç¤ºæŸæ¬¡æäº¤æ—¶ï¼ŒæŸä¸ªæ–‡ä»¶çš„å†…å®¹ $ git show [commit]:[filename] # æ˜¾ç¤ºå½“å‰åˆ†æ”¯çš„æœ€è¿‘å‡ æ¬¡æäº¤ $ git reflog å…«ã€è¿œç¨‹åŒæ­¥ # ä¸‹è½½è¿œç¨‹ä»“åº“çš„æ‰€æœ‰å˜åŠ¨ $ git fetch [remote] # æ˜¾ç¤ºæ‰€æœ‰è¿œç¨‹ä»“åº“ $ git remote -v # æ˜¾ç¤ºæŸä¸ªè¿œç¨‹ä»“åº“çš„ä¿¡æ¯ $ git remote show [remote] # å¢åŠ ä¸€ä¸ªæ–°çš„è¿œç¨‹ä»“åº“ï¼Œå¹¶å‘½å $ git remote add [shortname] [url] # å–å›è¿œç¨‹ä»“åº“çš„å˜åŒ–ï¼Œå¹¶ä¸æœ¬åœ°åˆ†æ”¯åˆå¹¶ $ git pull [remote] [branch] # ä¸Šä¼ æœ¬åœ°æŒ‡å®šåˆ†æ”¯åˆ°è¿œç¨‹ä»“åº“ $ git push [remote] [branch] # å¼ºè¡Œæ¨é€å½“å‰åˆ†æ”¯åˆ°è¿œç¨‹ä»“åº“ï¼Œå³ä½¿æœ‰å†²çª $ git push [remote] --force # æ¨é€æ‰€æœ‰åˆ†æ”¯åˆ°è¿œç¨‹ä»“åº“ $ git push [remote] --all ä¹ã€æ’¤é”€ # æ¢å¤æš‚å­˜åŒºçš„æŒ‡å®šæ–‡ä»¶åˆ°å·¥ä½œåŒº $ git checkout [file] # æ¢å¤æŸä¸ªcommitçš„æŒ‡å®šæ–‡ä»¶åˆ°æš‚å­˜åŒºå’Œå·¥ä½œåŒº $ git checkout [commit] [file] # æ¢å¤æš‚å­˜åŒºçš„æ‰€æœ‰æ–‡ä»¶åˆ°å·¥ä½œåŒº $ git checkout . # é‡ç½®æš‚å­˜åŒºçš„æŒ‡å®šæ–‡ä»¶ï¼Œä¸ä¸Šä¸€æ¬¡commitä¿æŒä¸€è‡´ï¼Œä½†å·¥ä½œåŒºä¸å˜ $ git reset [file] # é‡ç½®æš‚å­˜åŒºä¸å·¥ä½œåŒºï¼Œä¸ä¸Šä¸€æ¬¡commitä¿æŒä¸€è‡´ $ git reset --hard # é‡ç½®å½“å‰åˆ†æ”¯çš„æŒ‡é’ˆä¸ºæŒ‡å®šcommitï¼ŒåŒæ—¶é‡ç½®æš‚å­˜åŒºï¼Œä½†å·¥ä½œåŒºä¸å˜ $ git reset [commit] # é‡ç½®å½“å‰åˆ†æ”¯çš„HEADä¸ºæŒ‡å®šcommitï¼ŒåŒæ—¶é‡ç½®æš‚å­˜åŒºå’Œå·¥ä½œåŒºï¼Œä¸æŒ‡å®šcommitä¸€è‡´ $ git reset --hard [commit] # é‡ç½®å½“å‰HEADä¸ºæŒ‡å®šcommitï¼Œä½†ä¿æŒæš‚å­˜åŒºå’Œå·¥ä½œåŒºä¸å˜ $ git reset --keep [commit] # æ–°å»ºä¸€ä¸ªcommitï¼Œç”¨æ¥æ’¤é”€æŒ‡å®šcommit # åè€…çš„æ‰€æœ‰å˜åŒ–éƒ½å°†è¢«å‰è€…æŠµæ¶ˆï¼Œå¹¶ä¸”åº”ç”¨åˆ°å½“å‰åˆ†æ”¯ $ git revert [commit] # æš‚æ—¶å°†æœªæäº¤çš„å˜åŒ–ç§»é™¤ï¼Œç¨åå†ç§»å…¥ $ git stash $ git stash pop åã€å…¶ä»– # ç”Ÿæˆä¸€ä¸ªå¯ä¾›å‘å¸ƒçš„å‹ç¼©åŒ… $ git archive ","link":"https://tianxiawuhao.github.io/awhwcpAEp/"},{"title":"jaråŒ…å†…ç±»åŠ¨æ€åŠ è½½","content":"å®ä½“å¯¹è±¡ public class CmptDef { private String idCmptDef; //ç»„ä»¶åœ¨DBé‡Œçš„å”¯ä¸€IDå· private String name;//ç»„ä»¶çš„å”¯ä¸€åç§°ï¼Œåªèƒ½æ˜¯å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ç»„æˆï¼Œå¤§äº1å°é›¨50ï¼Œé€šå¸¸ä¸ºJarçš„åå­— private CmptCategory cmptCategory; //ç§ç±» private String fullQualifiedName; //ç»„ä»¶å…¥å£ç±»å…¨é™å®šå private String extraParas; //ç»„ä»¶é¢å¤–å‚æ•° private String formUrl; //ç»„ä»¶è‡ªå®šä¹‰è¡¨å• private Float version = 1.0f; //ç»„ä»¶ç‰ˆæœ¬ private CmptExecutePos executePos = CmptExecutePos.PRE; //ç»„ä»¶åœ¨ç½‘å…³ä¸­æ‰§è¡Œçš„ä½ç½® private Integer priority = 100; //ç»„ä»¶åœ¨ç›¸åŒä½ç½®çš„æ‰§è¡Œä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå°è¶Šé«˜ private Integer timeout = 1000;//ç»„ä»¶æ‰§è¡Œè¶…æ—¶æ—¶é—´ï¼Œå•ä½æ¯«ç§’ private String description; //ç»„ä»¶æè¿° private Boolean defaultVersion; //æ˜¯å¦æ˜¯é»˜è®¤æœ‰æ•ˆç‰ˆæœ¬ private CmptStatus cmptStatus = CmptStatus.editing; // ç»„ä»¶çŠ¶æ€ private String remarks; // ç»„ä»¶å‘å¸ƒæ—¶éœ€è¦å¡«å†™å¤‡æ³¨ä¿¡æ¯ private String code; // ç»„ä»¶codeï¼ŒåŒä¸€ä¸ªç»„ä»¶çš„å¤šä¸ªç‰ˆæœ¬çš„codeæ˜¯ä¸€æ ·çš„ private Date releaseTime; // ç»„ä»¶å‘å¸ƒæ—¶é—´ private CustomFormCode customFormCode; // è‡ªå®šä¹‰è¡¨å•é‡Œç±»å‹ private String cmptType; //ç»„ä»¶ç±»å‹ï¼ˆç‰¹æ®Šç»„ä»¶|æ™®é€šç»„ä»¶|é»˜è®¤ç»„ä»¶ï¼‰ } /** * ç»„ä»¶ç±»å‹ã€‚ */ public enum CmptCategory { AUTHENTICATION, //è®¤è¯ AUTHORIZATION, //é‰´æƒ FLOW_MANAGEMENT, //æµé‡ç®¡ç† REQUEST_COUNT_MANAGEMENT, //è¯·æ±‚æ¬¡æ•°ç®¡ç† CACHE, //ç¼“å­˜ ROUTER, //è·¯ç”± TRANSFORM, //æ•°æ®è½¬æ¢ LOGGER, //æ—¥å¿— OTHER//å…¶å®ƒ } /** * ç»„ä»¶æ‰§è¡Œçš„ä½ç½®ã€‚ */ public enum CmptExecutePos { PRE, //è°ƒç”¨ä¸Šæ¸¸æœåŠ¡å‰ ROUTING, //è°ƒç”¨ä¸­ AFTER //è°ƒç”¨å } public enum CmptStatus { editing, //ç¼–è¾‘ä¸­ published, //å·²ç»å‘å¸ƒ offline //å·²ç»ä¸‹çº¿ } /** * ç»„ä»¶é£æ ¼ã€‚ */ public enum CustomFormCode { RESTFUL_FORM, SQL_FORM, DUBBO_FORM, OTHER, MQ_FORM, WEBSERVICE_FORM } æ–¹æ³•æ¥å£ public interface ICmptService { /** * æ ¹æ®ç»„ä»¶ç±»åå’Œç‰ˆæœ¬ä»ç¼“å­˜ä¸­è·å–ç»„ä»¶,å¦‚æœä¸å­˜åœ¨åˆ™å°è¯•åŠ¨æ€åŠ è½½ç»„ä»¶ç±»ï¼Œå®ä¾‹åŒ–å¹¶åˆ·æ–°ç¼“å­˜åå†è·å–ï¼Œè¿˜æ˜¯ä¸å­˜åœ¨åˆ™è¿”å›nullï¼› * å¦å¤–é…ç½®æ›´æ–°ä¼šæœ‰å•ç‹¬çš„çº¿ç¨‹åˆ·æ–°ç¼“å­˜ã€‚ * * @return */ ICmpt getCmptInstance(final CmptDef cmptDef); /** * åˆ·æ–°APIå…³è”çš„ç»„ä»¶é…ç½®ä¿¡æ¯ * * @param apis * @param ignoreRefreshTime * @return */ boolean refreshCmptInstanceCache(List&lt;Api&gt; apis, boolean ignoreRefreshTime); /** * åˆ é™¤ç»„ä»¶å®ä¾‹ç¼“å­˜ * * @param fullQualifiedName * @param code */ void removeCmpt(final String fullQualifiedName, final Float version, final String code); } æ–¹æ³•å®ç° @Service public class CmptServiceImpl implements ICmptService { private static Logger logger = LoggerFactory.getLogger(CmptServiceImpl.class); @Value(&quot;${cmpt.dynamicLoadCmptClass}&quot;) private boolean dynamicLoadCmptClass; @Autowired private ICmptDefService cmptDefService; @Override public synchronized ICmpt getCmptInstance(final CmptDef cmptDef) { ICmpt cmpt = CmptInstanceHolder.getInstance().getCmpt(cmptDef.getFullQualifiedName(), cmptDef.getVersion(), cmptDef.getCode()); if (null == cmpt) { if (logger.isDebugEnabled()) { logger.debug(&quot;åå°„æ‹¿åˆ°å®ä¾‹&gt;&gt;&gt; &quot; + cmptDef.getFullQualifiedName()); } if (this.dynamicLoadCmptClass) { cmpt = CmptClassLoaderUtil.newInstance(cmptDef); } else { try { Class clazz = Class.forName(cmptDef.getFullQualifiedName()); cmpt = (ICmpt) clazz.newInstance(); } catch (Exception e) { e.printStackTrace(); } } if (null != cmpt) { if (cmpt instanceof AbstractCmpt) { //è®¾ç½®ç‰ˆæœ¬å· ((AbstractCmpt) cmpt).setVersion(cmptDef.getVersion()); ((AbstractCmpt) cmpt).setIdCmptDef(cmptDef.getIdCmptDef()); } CmptInstanceHolder.getInstance().addEntry(cmpt, cmptDef.getFullQualifiedName(), cmptDef.getVersion(), cmptDef.getCode()); } } else { if (logger.isDebugEnabled()) { logger.debug(&quot;ç¼“å­˜æ‹¿åˆ°å®ä¾‹&gt;&gt;&gt; &quot; + cmptDef.getFullQualifiedName()); } } if (null != cmpt) { ApplicationContext context = SpringContextHolder.getContext(); if (null != context) { ZkClient zkClient = context.getBean(ZkClient.class); if (null != zkClient) { BaseListener listener = zkClient.getListener(); listener.addObserver((AbstractCmpt) cmpt); } } } return cmpt; } @Override public boolean refreshCmptInstanceCache(List&lt;Api&gt; apis, boolean ignoreRefreshTime) { return false; } @Override public synchronized void removeCmpt(final String fullQualifiedName, final Float version, final String code) { ICmpt cmpt = CmptInstanceHolder.getInstance().getCmpt(fullQualifiedName, version, code); if (null != cmpt) { ApplicationContext context = SpringContextHolder.getContext(); if (null != context) { ZkClient zkClient = context.getBean(ZkClient.class); if (null != zkClient) { BaseListener listener = zkClient.getListener(); listener.deleteObserver((AbstractCmpt) cmpt); } } cmpt.destroy(); CmptDef cmptDef = CmptDefHolder.getInstance().getCmptDef(fullQualifiedName, version, code); if (null == cmptDef) { cmptDef = new CmptDef(); cmptDef.setFullQualifiedName(fullQualifiedName); cmptDef.setVersion(version); cmptDef.setCode(code); } //åˆ é™¤å¼•ç”¨å®ä½“ CmptInstanceHolder.getInstance().removeEntry(fullQualifiedName, version, code); cmpt = null; String jarPath = CmptClassLoaderUtil.getJarPath(cmptDef); if (logger.isDebugEnabled()) { logger.debug(&quot;å°è¯•å¸è½½jaråŒ…: &quot; + jarPath); } CmptClassLoaderManager.unLoadJar(jarPath); } CmptInstanceHolder.getInstance().removeEntry(fullQualifiedName, version, code); } } å·¥å…·ç±» /** * ç»„ä»¶é…ç½®ç¼“å­˜æŒæœ‰è€… */ public class CmptInstanceHolder { private static CmptInstanceHolder cmptInstanceHolder = new CmptInstanceHolder(); //APIæ‰€å…³è”çš„ç»„ä»¶é…ç½®ç¼“å­˜ key: fullQualifiedName value: ICmpt private Map&lt;String, ICmpt&gt; cmpts = new ConcurrentHashMap&lt;&gt;(); private CmptInstanceHolder() { } public static CmptInstanceHolder getInstance() { return CmptInstanceHolder.cmptInstanceHolder; } /** * æ ¹æ®ç±»ååŠ ç‰ˆæœ¬ä»ç¼“å­˜ä¸­è·å–ç»„ä»¶å®ä¾‹,å¦‚æœä¸å­˜åœ¨ç›´æ¥è¿”å›nullï¼› * * @return */ public ICmpt getCmpt(final String fullQualifiedName, final Float version, String code) { final String key = buildKey(fullQualifiedName, version, code); return this.cmpts.get(key); } /** * æ·»åŠ å¯¹è±¡ */ public void addEntry(final ICmpt cmpt, final String fullQualifiedName, final Float version, final String code) { if (cmpt == null || StringUtils.isEmpty(fullQualifiedName) || StringUtils.isEmpty(code)) { return; } final String key = buildKey(fullQualifiedName, version, code); removeEntry(fullQualifiedName, version, code); this.cmpts.put(key, cmpt); } private String buildKey(final String fullQualifiedName, Float version, final String code) { return fullQualifiedName + &quot;.&quot; + version + code; } public void removeEntry(final String fullQualifiedName, final Float version, final String code) { ICmpt remove = this.cmpts.remove(buildKey(fullQualifiedName, version, code)); if (null != remove) { remove.destroy(); } } /** * è·å–æ‰€æœ‰çš„ç»„ä»¶å®ä¾‹ * @return */ public Map&lt;String, ICmpt&gt; getAllCmpts(){ return this.cmpts; } } public class CmptClassLoaderUtil { private static Logger logger = LoggerFactory.getLogger(CmptClassLoaderUtil.class); public static ICmpt newInstance(final CmptDef cmptDef) { ICmpt cmpt = null; try { final String jarPath = getJarPath(cmptDef); logger.info(&quot;å°è¯•è½½å…¥jaråŒ…,jaråŒ…è·¯å¾„: &quot; + jarPath); //åŠ è½½ä¾èµ–jar CmptClassLoader cmptClassLoader = CmptClassLoaderManager.loadJar(cmptDef.getIdCmptDef(), jarPath, true); // åˆ›å»ºå®ä¾‹ if (null != cmptClassLoader) { cmpt = LoadClassUtil.newObject(cmptDef, ICmpt.class, cmptClassLoader); } else { logger.error(&quot;åŠ è½½ç»„ä»¶jaråŒ…å¤±è´¥! jarPath: &quot; + jarPath); } } catch (Exception e) { logger.error(&quot;ç»„ä»¶ç±»åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç±»åå’Œç‰ˆæœ¬æ˜¯å¦æ­£ç¡®ã€‚ClassName=&quot; + cmptDef.getFullQualifiedName() + &quot;, Version=&quot; + cmptDef.getVersion()); e.printStackTrace(); } return cmpt; } public static String getJarPath(final CmptDef cmptDef) { StringBuffer sb = new StringBuffer(); sb.append(AppConfigUtil.getValue(&quot;app.home&quot;)); sb.append(AppConfigUtil.getValue(&quot;cmpt.location&quot;)); sb.append(&quot;/&quot;); //å¼€å‘ä¸­å…³é—­å¤šçº§ç›®å½•,ä¸å¥½éƒ¨ç½² sb.append(cmptDef.getCode()); sb.append(&quot;/&quot;); sb.append(cmptDef.getVersion()); sb.append(&quot;/&quot;); String[] split = cmptDef.getFullQualifiedName().split(&quot;\\\\.&quot;); sb.append(split[split.length - 1]); sb.append(&quot;_&quot;); sb.append(cmptDef.getVersion()); sb.append(&quot;.jar&quot;); if (logger.isDebugEnabled()) { logger.debug(&quot;æ„å»ºjaråŒ…è·¯å¾„: &quot; + sb.toString()); } return sb.toString(); } } #linuxç‰ˆhomeç›®å½• app.home=/work/sharestore #ç»„ä»¶èµ„æºå­˜æ”¾è·¯å¾„ï¼Œ&lt;home&gt;/cmpt/&lt;code&gt;/&lt;version&gt;/&lt;name&gt;_&lt;version&gt;.jar,html cmpt.location=/cmpt /** * ç±»åŠ è½½å™¨ç®¡ç†, åŠ è½½, å¸è½½jaråŒ… */ public class CmptClassLoaderManager { private static final Logger logger = Logger.getLogger(CmptClassLoaderManager.class); private static Map&lt;String, CmptClassLoader&gt; classLoaderMap = new ConcurrentHashMap&lt;&gt;(); private CmptClassLoaderManager() { } /** * è½½å…¥JaråŒ…, åˆ¤æ–­æ˜¯å¦é‡æ–°è½½å…¥JaråŒ… * * @param fileName * @param isReloadJar * @return */ public static CmptClassLoader loadJar(String IdCmptDef, String fileName, boolean isReloadJar) { fileName = FileUtil.fixFileName(fileName); CmptClassLoader cmptClassLoader = classLoaderMap.get(IdCmptDef); if (isReloadJar || null == cmptClassLoader) { if (logger.isDebugEnabled()) { logger.debug(&quot;ä»æ–‡ä»¶è½½å…¥jarç»„ä»¶&quot;); } return loadJar(IdCmptDef, fileName); } else { if (logger.isDebugEnabled()) { logger.debug(&quot;ä»ç¼“å­˜è½½å…¥jarç»„ä»¶&quot;); } return cmptClassLoader; } } /** * è½½å…¥JaråŒ…, ä»¥æ–°JaråŒ…è½½å…¥ * * @param fileName * @return è¿”å›ä¸€ä¸ªç±»åŠ è½½å™¨ */ private static CmptClassLoader loadJar(String IdCmptDef, String fileName) { CmptClassLoader loader; try { boolean exists = new File(fileName).exists(); if (exists) { if (null == classLoaderMap.get(IdCmptDef) || unLoadJar(IdCmptDef)) { loader = new CmptClassLoader(); boolean loadJar = loader.addURL(fileName); if (loadJar) { classLoaderMap.put(IdCmptDef, loader); return loader; } else { loader.close(); } } } else { throw new IllegalArgumentException(&quot;ä¼ å…¥å‚æ•°é”™è¯¯,æ–‡ä»¶ä¸å­˜åœ¨! file: &quot; + fileName); } } catch (Exception e) { logger.error(&quot;&quot;,e); } return null; } public static boolean unLoadJar(String IdCmptDef) { boolean unLoadJar = false; if (logger.isDebugEnabled()) { logger.debug(&quot;è¯·æ±‚å¸è½½jaråŒ…: &quot; + IdCmptDef); } try { CmptClassLoader loader = classLoaderMap.remove(IdCmptDef); if (null != loader) { loader.close(); } unLoadJar = true; } catch (Exception e) { logger.error(&quot;&quot;,e); } return unLoadJar; } /** * è·å–ç»„ä»¶å®šä¹‰å¯¹åº”çš„å®ä¾‹çš„ç±»åŠ è½½å™¨ * * @param idCmptDef * @return */ public static ClassLoader getCmptClassLoader(String idCmptDef) { return classLoaderMap.get(idCmptDef); } } public class FileUtil { public static String fixFileName(String fileName) { if (null == fileName) fileName = &quot;&quot;; fileName = fileName.replaceAll(&quot;\\\\\\\\&quot;, &quot;/&quot;); fileName = fileName.replaceAll(&quot;//&quot;, &quot;/&quot;); return fileName; } } /** * ç±»åŠ è½½å™¨ç»ˆæç‰ˆ, åŠ è½½, å¸è½½jaråŒ… */ public class CmptClassLoader extends URLClassLoader { private static final Logger logger = Logger.getLogger(CmptClassLoader.class); CmptClassLoader(URL[] urls, ClassLoader parent) { super(urls, parent); } CmptClassLoader(URL[] urls) { super(urls); } CmptClassLoader(URL[] urls, ClassLoader parent, URLStreamHandlerFactory factory) { super(urls, parent, factory); } CmptClassLoader() { super(new URL[]{}, findParentClassLoader()); } /** * è½½å…¥Jar * * @param fileName * @return */ boolean addURL(String fileName) { try { URL url = new File(fileName).toURL(); URLClassPath ucp = this.getUCP(); ucp.addURL(url); } catch (Exception e) { e.printStackTrace(); return false; } return true; } /** * å®šä½å½“å‰çˆ¶ç±»åŠ è½½å™¨ * * @return */ private static ClassLoader findParentClassLoader() { ClassLoader parent = logger.getClass().getClassLoader(); if (parent == null) { throw new RuntimeException(&quot;æ— æ³•è·å–å½“å‰çˆ¶åŠ è½½å™¨!&quot;); } return parent; } private URLClassPath getUCP() { URLClassPath ucp = null; try { Field declaredField = URLClassLoader.class.getDeclaredField(&quot;ucp&quot;); declaredField.setAccessible(true); Object o = declaredField.get(this); ucp = (URLClassPath) o; } catch (IllegalAccessException e) { e.printStackTrace(); } catch (NoSuchFieldException e) { e.printStackTrace(); } return ucp; } @Override protected void finalize() throws Throwable { super.finalize(); this.close(); } } /** * ç±»åŠ è½½å™¨å·¥å…·ç±» */ public class LoadClassUtil { private final static LoadClassUtil LOAD_JAR_UTIL = new LoadClassUtil(); private static Logger logger = LoggerFactory.getLogger(LoadClassUtil.class); private LoadClassUtil() { } /** * è½½å…¥jaråŒ… * å°†jaråŒ…è·¯å¾„æ·»åŠ åˆ°ç³»ç»Ÿç±»åŠ è½½å™¨æ‰«æç±»å’Œèµ„æºçš„æ–‡ä»¶åˆ—è¡¨é‡Œ * * @param fileName jarç»å¯¹è·¯å¾„ * @return */ public static boolean loadJar(String fileName) { try { if (strNotNull(fileName) &amp;&amp; fileExists(fileName)) {//(ClassLoaderè¦ä¸å½“å‰ç¨‹åºåŒä¸€ä¸ªloader) getMethod().invoke(LOAD_JAR_UTIL.getClass().getClassLoader(), getURL(fileName));//æ·»åŠ è·¯å¾„URL //getMethod().invoke(Launcher.getLauncher().getClassLoader(), getURL(fileName));//æ·»åŠ è·¯å¾„URL return true; } else { throw new IllegalArgumentException(&quot;ä¼ å…¥å‚æ•°é”™è¯¯,æ–‡ä»¶æˆ–ä¸å­˜åœ¨! file: &quot; + fileName); } } catch (Exception e) { logger.error(&quot;&quot;,e); } return false; } /** * åˆ¤æ–­å­—ç¬¦ä¸²ä¸ä¸ºç©º * * @param str * @return */ private static boolean strNotNull(String str) { return null != str &amp;&amp; !str.equals(&quot;&quot;); } private static boolean fileExists(String fileName) { return new File(fileName).exists(); } /** * æ‹¿åˆ°æ·»åŠ æ‰«æç±»å’Œèµ„æºçš„è·¯å¾„URLçš„æ–¹æ³• * * @return * @throws NoSuchMethodException */ private static Method getMethod() throws NoSuchMethodException { Method method = URLClassLoader.class.getDeclaredMethod(&quot;addURL&quot;, URL.class); // ç ´è§£æ–¹æ³•çš„è®¿é—®æƒé™ method.setAccessible(true); return method; } /** * å¾—åˆ°ä¸€ä¸ªURL * * @param fileName * @return * @throws MalformedURLException */ private static URL getURL(String fileName) throws MalformedURLException { return new File(fileName).toURI().toURL(); } /** * åˆ›å»ºå¯¹è±¡å®ä¾‹ * * @param className å…¨é™å®šå * @return */ public static Object newObject(String className) { try { return Class.forName(className).newInstance(); } catch (Exception e) { logger.error(&quot;&quot;,e); } return null; } /** * åˆ›å»ºè½¬æ¢ç±»å‹åçš„å¯¹è±¡å®ä¾‹ * * @param className å…¨é™å®šå * @param tClass è¿”å›ç±»å‹ * @param &lt;T&gt; * @return */ public static &lt;T&gt; T newObject(String className, Class&lt;T&gt; tClass) { try { return (T) Class.forName(className).newInstance(); } catch (Exception e) { logger.error(&quot;&quot;,e); } return null; } /** * åˆ›å»ºè½¬æ¢ç±»å‹åçš„å¯¹è±¡å®ä¾‹ * * @param cmptDef ç»„ä»¶å®šä¹‰-&gt;å…¨é™å®šå * @param tClass è¿”å›ç±»å‹ * @param loader ç±»åŠ è½½å™¨ * @param &lt;T&gt; * @return */ public static &lt;T&gt; T newObject(CmptDef cmptDef, Class&lt;T&gt; tClass, ClassLoader loader) { try { String className = cmptDef.getFullQualifiedName(); Object newInstance = Class.forName(className, true, loader).newInstance(); return (T) newInstance; } catch (Exception e) { String jarPath = CmptClassLoaderUtil.getJarPath(cmptDef); logger.error(&quot;åˆ›å»ºç»„ä»¶å®ä¾‹å¤±è´¥! className=&quot; + cmptDef.getFullQualifiedName() + &quot; jarPath=&quot; + jarPath); logger.error(&quot;åˆ›å»ºå‡ºé”™ç»„ä»¶:&quot; + cmptDef.getName() + cmptDef.getVersion() + &quot; ,æ–‡ä»¶ä¿¡æ¯:&quot; + FileUtil.fileInfo(jarPath)); try { Class&lt;?&gt; aClass = loader.loadClass(cmptDef.getFullQualifiedName()); } catch (ClassNotFoundException e1) { e1.printStackTrace(); logger.error(&quot;ç±»æœªè½½å…¥:&quot; + cmptDef.getFullQualifiedName()); } } return null; } /** * æ‰§è¡Œå¯¹è±¡çš„æ–¹æ³• * * @param o å®ä¾‹å¯¹è±¡ * @param methodName æ–¹æ³•åç§° * @param args å½¢å‚ * @return */ public static Object invokeMethod(Object o, String methodName, Object... args) { try { Object invoke; if (null == args || args.length == 0) {//æœ‰ç¼ºé™·,å¦‚æœå½¢å‚æ˜¯ä»»æ„Object,ä½†ä¼ å…¥å‚æ•°æ˜¯null,æ— æ³•å¾—åˆ°å½¢å‚ç±»å‹,å¾—åˆ°æœ‰å‚çš„æ–¹æ³•. Method method = o.getClass().getMethod(methodName); invoke = method.invoke(o); } else { Method method = o.getClass().getMethod(methodName, args.getClass()); invoke = method.invoke(o, args); } return invoke; } catch (Exception e) { logger.error(&quot;&quot;,e); } return null; } } ç»„ä»¶å®ç°å…¬å…±æ¥å£ç±» public interface ICmpt { /** * ç»„ä»¶æ‰§è¡Œå…¥å£ * * @param request * @param configï¼Œç»„ä»¶å®ä¾‹çš„å‚æ•°é…ç½® * @param actionNode, å½“å‰æ‰§è¡Œçš„æµç¨‹èŠ‚ç‚¹ * @param procContextDTO, æµç¨‹å¼•æ“å®ä¾‹ä¸Šä¸‹æ–‡ * @return */ CmptResult execute(CmptRequest request, Map&lt;String, FieldDTO&gt; config, ActionNode actionNode, ProcContextDTO procContextDTO); /** * é”€æ¯ç»„ä»¶æŒæœ‰çš„ç‰¹æ®Šèµ„æºï¼Œæ¯”å¦‚çº¿ç¨‹ã€‚ */ void destroy(); } ","link":"https://tianxiawuhao.github.io/E2kaihQ5a/"},{"title":"mybatisçº§è”æŸ¥è¯¢","content":"ModelMapper.xml &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt; &lt;mapper namespace=&quot;com.haier.biz.mapper.ModelMapper&quot;&gt; &lt;resultMap id=&quot;BaseResultMap&quot; type=&quot;com.haier.biz.entity.Model&quot;&gt; &lt;id column=&quot;model_id&quot; jdbcType=&quot;BIGINT&quot; property=&quot;modelId&quot;/&gt; &lt;result column=&quot;equipment_model_mark&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;equipmentModelMark&quot;/&gt; &lt;result column=&quot;equipment_name&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;equipmentName&quot;/&gt; &lt;result column=&quot;specification_model&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;specificationModel&quot;/&gt; &lt;result column=&quot;model_description&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;modelDescription&quot;/&gt; &lt;result column=&quot;model_sort_key&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;modelSortKey&quot;/&gt; &lt;result column=&quot;model_classification_label&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;modelClassificationLabel&quot;/&gt; &lt;result column=&quot;tenant_product_id&quot; jdbcType=&quot;BIGINT&quot; property=&quot;tenantProductId&quot;/&gt; &lt;result column=&quot;tenant_product_name&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;tenantProductName&quot;/&gt; &lt;result column=&quot;manufacturer&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;manufacturer&quot;/&gt; &lt;result column=&quot;create_by&quot; jdbcType=&quot;BIGINT&quot; property=&quot;createBy&quot;/&gt; &lt;result column=&quot;create_time&quot; jdbcType=&quot;TIMESTAMP&quot; property=&quot;createTime&quot;/&gt; &lt;result column=&quot;update_by&quot; jdbcType=&quot;BIGINT&quot; property=&quot;updateBy&quot;/&gt; &lt;result column=&quot;update_time&quot; jdbcType=&quot;TIMESTAMP&quot; property=&quot;updateTime&quot;/&gt; &lt;/resultMap&gt; &lt;!--çº§è”æŸ¥è¯¢--&gt; &lt;resultMap id=&quot;BaseResultInstanceMap&quot; type=&quot;com.haier.biz.entity.DTO.ModelDTO&quot; extends=&quot;BaseResultMap&quot;&gt; &lt;result column=&quot;publishNumber&quot; jdbcType=&quot;BIGINT&quot; property=&quot;publishNumber&quot;/&gt; &lt;result column=&quot;customer_id&quot; jdbcType=&quot;BIGINT&quot; property=&quot;customerId&quot;/&gt; &lt;result column=&quot;topic&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;topic&quot;/&gt; &lt;!--propertyæ¥æºModelDTOå±æ€§ï¼Œcolumnæ¥æºäºselectInstancelListæŸ¥è¯¢--&gt; &lt;!--æŸ¥è¯¢å•æ¡--&gt; &lt;association property=&quot;equipmentPicture&quot; column=&quot;equipment_model_mark&quot; select=&quot;getEquipmentPicture&quot;&gt;&lt;/association&gt; &lt;association property=&quot;instanceNumber&quot; column=&quot;{equipmentModelMark=equipment_model_mark,customerId=customer_id}&quot; select=&quot;getCustomerInstanceNumber&quot;&gt;&lt;/association&gt; &lt;!--æŸ¥è¯¢åˆ—è¡¨--&gt; &lt;collection property=&quot;equipmentPictures&quot; column=&quot;equipment_model_mark&quot; select=&quot;getEquipmentPictures&quot;&gt;&lt;/collection&gt; &lt;/resultMap&gt; &lt;select id=&quot;selectInstancelList&quot; parameterType=&quot;com.haier.biz.entity.VO.InstanceSelectVo&quot; resultMap=&quot;BaseResultInstanceMap&quot;&gt; SELECT distinct model.model_id, equipment_model_mark, equipment_name, specification_model, model_description, model_sort_key, model_classification_label, tenant_product_id, tenant_product_name, manufacturer, model.create_by, model.create_time, model.update_by, model.update_time, 0 as publishNumber, relation_model_customer.customer_id, relation_model_customer.topic FROM model LEFT JOIN relation_model_customer on relation_model_customer.model_id=model.model_id &lt;where&gt; &lt;if test=&quot;customerId != null&quot;&gt; and relation_model_customer.customer_id = #{customerId} &lt;/if&gt; &lt;if test=&quot;modelSortKey != null and modelSortKey!=''&quot;&gt; and `model`.model_sort_key = #{modelSortKey} &lt;/if&gt; &lt;if test=&quot;equipmentName != null and equipmentName!=''&quot;&gt; and `model`.equipment_name like CONCAT('%', #{equipmentName,jdbcType=VARCHAR},'%') &lt;/if&gt; &lt;/where&gt; &lt;/select&gt; &lt;select id=&quot;getEquipmentPicture&quot; parameterType=&quot;java.lang.String&quot; resultType=&quot;java.lang.String&quot;&gt; SELECT model_instance_file_associate.file_object_key as equipmentPicture from model_instance_file_associate where model_instance_file_associate.file_type=4 and model_instance_file_associate.type=0 and model_instance_file_associate.del_flag=0 and model_instance_file_associate.model_or_instance_mark = #{equipmentModelMark,jdbcType=VARCHAR} limit 1 &lt;/select&gt; &lt;select id=&quot;getCustomerInstanceNumber&quot; parameterType=&quot;java.util.Map&quot; resultType=&quot;java.lang.Long&quot;&gt; SELECT count(*) from model_instance_associate left join `instance` on model_instance_associate.instance_mark=`instance`.instance_mark where model_instance_associate.equipment_model_mark = #{equipmentModelMark,jdbcType=VARCHAR} and `instance`.customer_id=#{customerId} &lt;/select&gt; &lt;select id=&quot;getEquipmentPictures&quot; parameterType=&quot;java.lang.String&quot; resultType=&quot;java.lang.String&quot;&gt; SELECT model_instance_file_associate.file_object_key as equipmentPictures from model_instance_file_associate where model_instance_file_associate.file_type=4 and model_instance_file_associate.type=0 and model_instance_file_associate.del_flag=0 and model_instance_file_associate.model_or_instance_mark = #{equipmentModelMark,jdbcType=VARCHAR} &lt;/select&gt; &lt;/mapper&gt; ModelMapper @Repository public interface ModelMapper extends BaseMapper&lt;Model&gt; { List&lt;ModelDTO&gt; selectInstancelList(InstanceSelectVo instanceSelectVo); List&lt;String&gt; getEquipmentPictures(@Param(&quot;equipmentModelMark&quot;) String equipmentModelMark); } ModelDTO @Data @EqualsAndHashCode(callSuper = false) @Accessors(chain = true) @AllArgsConstructor @NoArgsConstructor public class ModelDTO extends Model { @ApiModelProperty(value = &quot;äº§å“(æ¨¡å‹)å›¾ç‰‡(å–ç¬¬ä¸€å¼ )&quot;) private String equipmentPicture; @ApiModelProperty(value = &quot;äº§å“(æ¨¡å‹)å›¾ç‰‡&quot;) private List&lt;String&gt; equipmentPictures; @ApiModelProperty(value = &quot;å‘å¸ƒå®¢æˆ·æ•°&quot;) private Long publishNumber; @ApiModelProperty(value = &quot;å®ä¾‹è®¾å¤‡æ•°&quot;) private Long instanceNumber; @ApiModelProperty(value = &quot;ä½¿ç”¨æ–¹Id&quot;) private Long customerId; @ApiModelProperty(value = &quot;å®ä¾‹è®¾å¤‡è¿è¡Œæƒ…å†µ&quot;) private List&lt;NumberDTO&gt; equipmentList; @ApiModelProperty(value = &quot;kafkaå®æ—¶æ¨é€çš„topic&quot;) private String topic; } ","link":"https://tianxiawuhao.github.io/hIydIZSN1/"},{"title":"mysql ç®€å•å¯¼å…¥ clickhouse","content":"æ•°æ®è¿ç§»éœ€è¦ä» mysql å¯¼å…¥ clickhouse, clickhouse è‡ªèº«æ”¯æŒçš„ä¸‰ç§æ–¹å¼ ã€‚ create table engin mysql CREATE TABLE [IF NOT EXISTS] [db.]table_name [ON CLUSTER cluster] ( name1 [type1] [DEFAULT|MATERIALIZED|ALIAS expr1] [TTL expr1], name2 [type2] [DEFAULT|MATERIALIZED|ALIAS expr2] [TTL expr2], ... INDEX index_name1 expr1 TYPE type1(...) GRANULARITY value1, INDEX index_name2 expr2 TYPE type2(...) GRANULARITY value2 ) ENGINE = MySQL('host:port', 'database', 'table', 'user', 'password'[, replace_query, 'on_duplicate_clause']); å®˜æ–¹æ–‡æ¡£: https://clickhouse.yandex/docs/en/operations/table_engines/mysql/ æ³¨æ„ï¼Œå®é™…æ•°æ®å­˜å‚¨åœ¨è¿œç«¯ mysql æ•°æ®åº“ä¸­ï¼Œå¯ä»¥ç†è§£æˆå¤–è¡¨ã€‚ å¯ä»¥é€šè¿‡åœ¨ mysql å¢åˆ æ•°æ®è¿›è¡ŒéªŒè¯ã€‚ insert into select from -- å…ˆå»ºè¡¨ CREATE TABLE [IF NOT EXISTS] [db.]table_name [ON CLUSTER cluster] ( name1 [type1] [DEFAULT|MATERIALIZED|ALIAS expr1], name2 [type2] [DEFAULT|MATERIALIZED|ALIAS expr2], ... ) ENGINE = engine -- å¯¼å…¥æ•°æ® INSERT INTO [db.]table [(c1, c2, c3)] select åˆ—æˆ–è€…* from mysql('host:port', 'db', 'table_name', 'user', 'password') å¯ä»¥è‡ªå®šä¹‰åˆ—ç±»å‹ï¼Œåˆ—æ•°ï¼Œä½¿ç”¨ clickhouse å‡½æ•°å¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚ select toDate(xx) from mysql(&quot;host:port&quot;,&quot;db&quot;,&quot;table_name&quot;,&quot;user_name&quot;,&quot;password&quot;) create table as select from CREATE TABLE [IF NOT EXISTS] [db.]table_name ENGINE =Log AS SELECT * FROM mysql('host:port', 'db', 'article_clientuser_sum', 'user', 'password') ç½‘å‹æ–‡ç« : http://jackpgao.github.io/2018/02/04/ClickHouse-Use-MySQL-Data/ ä¸æ”¯æŒè‡ªå®šä¹‰åˆ—ï¼Œå‚è€ƒèµ„æ–™é‡Œçš„åšä¸»å†™çš„ ENGIN=MergeTree æµ‹è¯•å¤±è´¥ã€‚ å¯ä»¥ç†è§£æˆ create table å’Œ insert into select çš„ç»„åˆ ","link":"https://tianxiawuhao.github.io/BHjbgcFm-/"},{"title":"Thingsboardæºç ç¼–è¯‘","content":"ç¯å¢ƒå®‰è£… å¼€å‘ç¯å¢ƒè¦æ±‚ï¼š Jdk 1.11 ç‰ˆæœ¬ Postgresql 9 ä»¥ä¸Š Node.js Npm Maven 3.6 ä»¥ä¸Š Git å·¥å…· Idea å¼€å‘å·¥å…· Redis JDK ä¸‹è½½å®‰è£… JDK å®˜æ–¹ä¸‹è½½åœ°å€ï¼š Java Downloads | Oracle JDK ç‰ˆæœ¬é€‰æ‹© JDK11ï¼Œæˆ‘æœ¬åœ°ç¯å¢ƒæ˜¯ Windos10 64 ä½ï¼Œæ‰€ä»¥é€‰æ‹© jdk-11.0.13-windows-x64.exe ä¸‹è½½å¥½äº†ä¹‹åç›´æ¥é»˜è®¤å®‰è£…å°±è¡Œ å…å®‰è£…ç‰ˆæœ¬ ä¸‹è½½jdk11 http://openjdk.java.net/install/index.html è¿™ä¸ªé¡µé¢å¤§éƒ¨åˆ†éƒ½æ˜¯linuxç³»ç»Ÿçš„ï¼› ç„¶åæˆ‘ä»¬ç‚¹å‡»jdk.java.net ï¼Œæ¥ç€æˆ‘ä»¬é€‰æ‹©ä¸‹è½½Java SE 11ï¼› ä¸‹å¥½äº†åï¼Œæˆ‘ä»¬å¾—åˆ°è¿™æ ·çš„æ–‡ä»¶ï¼šopenjdk-11+28_windows-x64_bin.zipï¼Œè§£å‹åå¾—åˆ°ï¼šjdk-11è¿™æ ·çš„æ–‡ä»¶å¤¹ï¼›å°†è¯¥æ–‡ä»¶å¤¹æ”¾åˆ°ä½ ä¹ æƒ¯çš„åœ°æ–¹ï¼› é…ç½®ç¯å¢ƒå˜é‡ æ­¥éª¤ 1ï¼š åœ¨ JAVA_HOME ä¸­å¢åŠ  JDK çš„å®‰è£…åœ°å€ï¼šC:\\Program Files\\Java\\jdk1.8.0_221 æ­¥éª¤ 2ï¼š åœ¨ CLASSPATH ä¸­å¢åŠ  JDK çš„å®‰è£…åœ°å€ä¸­çš„æ–‡ä»¶ï¼š.;%JAVA_HOME%\\lib;%JAVA_HOME%\\lib\\dt.jar;%JAVA_HOME%\\lib\\tools.jar æ­¥éª¤ 3ï¼š åœ¨ Path ä¸­å¢åŠ  JDK çš„åœ°å€ï¼š%JAVA_HOME%\\bin;%JAVA_HOME%\\jre\\bin; æ­¥éª¤ 4 è¾“å…¥ä»¥ä¸‹å‘½ä»¤ java -version å¦‚æœèƒ½å‡ºç°ä»¥ä¸‹çš„æç¤ºä¿¡æ¯ï¼Œå°±ç®—å®‰è£…æˆåŠŸäº† å®‰è£… IDEA å‚è€ƒï¼šIDEA å®‰è£…æ•™ç¨‹ å®‰è£… Maven æ­¥éª¤ 1ï¼šä¸‹è½½ mavenï¼Œè¿›å…¥åœ°å€ï¼šhttp://maven.apache.org/download.cgi æ­¥éª¤ 2ï¼šä¸‹è½½åˆ°æœ¬åœ° æ­¥éª¤ 3ï¼šé…ç½®ç¯å¢ƒå˜é‡ å¢åŠ  MAVEN_HOMEï¼Œå³ maven çš„åœ°å€ï¼šD:\\tb\\apache-maven-3.6.1-binï¼Œè¯·æ³¨æ„ï¼Œå¦‚æœç›´æ¥è§£å‹ï¼Œæœ‰å¯èƒ½ä¼šæœ‰ä¸¤ä¸ª apache-maven-3.6.1-bin MAVEN_OPTSï¼Œå‚æ•°æ˜¯ -Xms128m -Xmx1024m ä¿®æ”¹ Pathï¼Œå¢åŠ  Maven çš„åœ°å€%MAVEN_HOME%\\bin; æµ‹è¯• Maven å®‰è£…ï¼Œæ‰“å¼€å‘½ä»¤è¡Œå·¥å…·ã€‚ä½¿ç”¨å‘½ä»¤ mvn -vï¼Œå¦‚æœèƒ½å‡ºç°ä»¥ä¸‹æç¤ºï¼Œå³å®‰è£…æˆåŠŸ Nodejs å®‰è£… æ­¥éª¤ 1ï¼šä¸‹è½½ Nodejs å®‰è£…åŒ…ï¼ŒNodejs å®˜ç½‘åœ°å€ï¼šhttps://nodejs.org/en/download/ æ­¥éª¤ 2ï¼šå®‰è£…å®Œæˆåï¼Œä½¿ç”¨å‘½ä»¤æŸ¥çœ‹ Nodejs æ˜¯å¦å·²ç»å®‰è£…å®Œæˆï¼Œèƒ½å‡ºç°ä»¥ä¸‹æç¤ºè¯´æ˜å·²ç»å®‰è£…æˆåŠŸ ! å®‰è£… git æ­¥éª¤ 1ï¼šä¸‹è½½ git å®‰è£…åŒ…ï¼Œgit å®˜ç½‘åœ°å€æ˜¯ï¼šhttps://git-scm.com/download/win æ­¥éª¤ 2ï¼šå®‰è£…å®Œæˆåï¼Œä½¿ç”¨å‘½ä»¤è¡Œæµ‹è¯• git å®‰è£… npm å…¨å±€ä¾èµ– æ­¥éª¤ 1ï¼šä½¿ç”¨ç®¡ç†å‘˜ CMD å‘½ä»¤è¡Œï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤ #npm ç¯å¢ƒè¯»å–ç¯å¢ƒå˜é‡åŒ… npm install -g cross-env #webpackæ‰“åŒ…å·¥å…· npm install -g webpack å®‰è£… redis Redis å®‰è£…å‚è€ƒï¼šhttps://www.iotschool.com/wiki/redis ç¯å¢ƒå®‰è£…åˆ°æ­¤ç»“æŸï¼Œæ¥ä¸‹æ¥æ˜¯é€šè¿‡ Git æ‹‰å–ä»£ç ã€‚ å…‹éš† thingsboard ä»£ç  ç¡®å®šä»£ç å­˜æ”¾ä½ç½® åœ¨æœ¬åœ°åˆ›å»ºä»£ç å­˜æ”¾ä½ç½®çš„æ–‡ä»¶ç›®å½•ï¼Œç„¶åè¿›å…¥å½“å‰ç›®å½•ç‚¹å‡»é¼ æ ‡å³é”®ï¼Œé€‰æ‹© Git Bash Here è¾“å…¥ git å‘½ä»¤å…‹éš†æºä»£ç  git clone https://github.com/thingsboard/thingsboard.git è€å¿ƒç­‰å¾…ä¸€æ®µæ—¶é—´åï¼Œçœ‹åˆ°ä»¥ä¸‹ç•Œé¢å°±ç®—ä¸‹è½½æˆåŠŸ åˆ‡æ¢ git åˆ†æ”¯ é»˜è®¤ä¸‹è½½çš„ä»£ç æ˜¯ master ä¸»åˆ†æ”¯çš„ï¼Œæˆ‘ä»¬å¼€å‘éœ€è¦åˆ‡æ¢åˆ°æœ€æ–°ç‰ˆæœ¬çš„åˆ†æ”¯ã€‚ æŸ¥çœ‹é¡¹ç›®æºç çš„æ‰€æœ‰åˆ†æ”¯ï¼Œä¸‹è½½æºç åï¼Œéœ€è¦è¿›å…¥åˆ° thingsboard æ–‡ä»¶å¤¹ å‘ç°æœ€æ–°å‘å¸ƒçš„ç‰ˆæœ¬æ˜¯ 2.4ï¼Œæ‰€ä»¥æˆ‘è¿™é‡Œé€‰æ‹© 2.4ï¼Œå½“ç„¶ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„æƒ…å†µè¿›è¡Œåˆ†æ”¯é€‰æ‹© è¾“å…¥å‘½ä»¤ä»¥ä¸‹ï¼Œå³å¯åˆ‡æ¢è‡³ 2.4 çš„åˆ†æ”¯ git checkout release-2.4 çœ‹åˆ°ä¸‹å›¾è¿™æ ·ï¼Œå³åˆ‡æ¢æˆæˆåŠŸ å‡†å¤‡å·¥ä½œ å¤–ç½‘è¿æ¥ å› ä¸º TB åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­éœ€è¦ä¾èµ–å¾ˆå¤šå›½å¤–çš„åŒ…ï¼Œé‚£ä¹ˆéœ€è¦å¤–ç½‘æ‰èƒ½è¿æ¥ï¼Œæœ‰è¿æ¥å¤–ç½‘æ”¯æŒï¼Œå¯ä»¥åˆ°ç¤¾åŒºæ±‚åŠ©ï¼šhttps://www.iotschool.com/topics/node8 è®¾ç½® Maven ä¸ºæ·˜å®é•œåƒ å·¥ç¨‹æ˜¯åŸºäº Maven ç®¡ç†ï¼Œç›´æ¥é€šè¿‡ idea openï¼Œä¹‹åä¼šè‡ªåŠ¨ä¸‹è½½å„ç§ä¾èµ–åŒ…ã€‚ä¾èµ–åŒ…çš„é»˜è®¤å­˜å‚¨åœ°å€ä¸ºï¼šC:\\Users\\ç”¨æˆ·å.m2\\repositoryï¼Œå†…å®¹å¦‚ä¸‹ï¼š $tree ~/.m2 -L 2 /home/jay/.m2 â””â”€â”€ repository â”œâ”€â”€ antlr â”œâ”€â”€ aopalliance â”œâ”€â”€ asm â”œâ”€â”€ backport-util-concurrent â”œâ”€â”€ ch ... ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä½¿ç”¨å®˜æ–¹é•œåƒæ›´æ–°ä¾èµ–åŒ…ï¼Œç½‘é€Ÿä¸ç¨³å®šï¼Œå¯å°† Maven é•œåƒæºè®¾ç½®ä¸ºæ·˜å®çš„ï¼Œåœ¨ maven å®‰è£…åŒ…ç›®å½•ä¸‹æ‰¾åˆ° settings.xml è®¾ç½® å¤§æ¦‚ä½ç½®æˆªå›¾ï¼š æŠŠ settings.xml é‡Œé¢å†…å®¹è®¾ç½®æˆä»¥ä¸‹ï¼š &lt;mirrors&gt; &lt;mirror&gt; &lt;!--This sends everything else to /public --&gt; &lt;id&gt;aliyun_nexus&lt;/id&gt; &lt;mirrorOf&gt;*,!maven_nexus_201&lt;/mirrorOf&gt; &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt; &lt;/mirror&gt; &lt;/mirrors&gt; ä¸ä¼šè®¾ç½®çš„ï¼Œå¯ä»¥å‚è€ƒè¿™ä¸ªæ–‡ä»¶ï¼šhttps://cdn.iotschool.com/iotschool/settings.xml thingsboard QQ ç¾¤ä¹Ÿæœ‰è¿™ä¸ªèµ„æºï¼š121202538 è®¾ç½® npm ä¸ºæ·˜å®é•œåƒ åŒä¸Šï¼Œç½‘é€Ÿä¸å¥½ npm è¿‡ç¨‹ä¸­ä¹Ÿä¼šä¸‹è½½å¤±è´¥ï¼Œè¿™æ˜¯å¯¼è‡´å¾ˆå¤šåŒå­¦ thingsboard ç¼–è¯‘å¤±è´¥çš„ä¸»è¦åŸå› ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¿›è¡Œç¼–è¯‘ä¹‹å‰ï¼Œä¹Ÿå°† npm æ›¿æ¢ä¸ºæ·˜å®é•œåƒï¼š npm install -g mirror-config-china --registry=http://registry.npm.taobao.org #ä½¿ç”¨æ·˜å®é•œåƒ npm config get registry #æŸ¥è¯¢å½“å‰é•œåƒ npm config rm registry #åˆ é™¤è‡ªå®šä¹‰é•œåƒï¼Œä½¿ç”¨å®˜æ–¹é•œåƒ npm info express è®¾ç½® IDEA ç®¡ç†å‘˜å¯åŠ¨ æˆ‘æœ¬åœ°å¼€å‘ç¯å¢ƒç¼–è¯‘é¡¹ç›®ä½¿ç”¨ IDEA å·¥å…·è¿›è¡Œç¼–è¯‘ï¼Œæ‰€ä»¥éœ€è¦è®¾ç½®ç®¡ç†å‘˜å¯åŠ¨ï¼Œè¿™æ ·æ‰æœ‰æ‰€æœ‰çš„æƒé™æ‰§è¡Œç¼–è¯‘å‘½ä»¤ã€‚ æ­¥éª¤ 1ï¼šç‚¹å‡» IDEA å›¾æ ‡å³é”®ï¼Œé€‰æ‹©å±æ€§ã€‚ æ­¥éª¤ 2ï¼šç‚¹å‡»å…¼å®¹æ€§ - æ›´æ”¹æ‰€æœ‰ç”¨æˆ·è®¾ç½® - ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œæ­¤ç¨‹åº å¼€å§‹ç¼–è¯‘ ç¼–è¯‘é¡¹ç›®è·Ÿç½‘é€Ÿæœ‰å…³ï¼Œæœ€å¥½è¿æ¥ä¸Šå¤–ç½‘è¿›è¡Œç¼–è¯‘ï¼Œä¸€èˆ¬ 5~30 åˆ†é’Ÿéƒ½æœ‰å¯èƒ½ï¼Œè¶…è¿‡ 30 åˆ†é’Ÿè¦æ£€æŸ¥ä½ çš„ç½‘ç»œã€‚ æ¸…ç†é¡¹ç›®ç¼–è¯‘æ–‡ä»¶ ä½¿ç”¨ IDEA Maven å·¥å…·è¿›è¡Œæ¸…ç† è¾“å…¥ç¼–è¯‘å‘½ä»¤å¼€å§‹ç¼–è¯‘ åœ¨ IDEA æ§åˆ¶å°ï¼ˆå·¦ä¸‹æ–¹ï¼‰Terminal è¾“å…¥ä»¥ä¸‹å‘½ä»¤è¿›è¡Œç¼–è¯‘ï¼š mvn clean install -DskipTests ç­‰ä¸€æ®µæ—¶é—´åï¼Œçœ‹åˆ°ä¸‹é¢è¿™å¼ å›¾å°±ç®—ç¼–è¯‘æˆåŠŸï¼Œå¦‚æœæ²¡æœ‰ç¼–è¯‘æˆåŠŸè¯·æŒ‰ç…§æœ¬æ•™ç¨‹æœ€åçš„å¸¸è§é—®é¢˜è¿›è¡Œæ’æŸ¥ï¼Œä¸€èˆ¬éƒ½æ˜¯ç½‘ç»œé—®é¢˜ã€‚å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œè¯·åˆ°ç¤¾åŒºthingsboard ä¸“é¢˜ä¸­æé—®ã€‚ å¸¸è§é—®é¢˜ pomåŒ…pkg.nameç­‰æ ‡ç­¾æœªå®šä¹‰ &lt;properties&gt; &lt;pkg.name&gt;thingsboard&lt;/pkg.name&gt; &lt;main.dir&gt;${basedir}&lt;/main.dir&gt; &lt;pkg.type&gt;java&lt;/pkg.type&gt; &lt;pkg.mainClass&gt;org.thingsboard.server.ThingsboardServerApplication&lt;/pkg.mainClass&gt; &lt;pkg.copyInstallScripts&gt;true&lt;/pkg.copyInstallScripts&gt; &lt;main.dir&gt;${basedir}&lt;/main.dir&gt; &lt;pkg.disabled&gt;true&lt;/pkg.disabled&gt; &lt;pkg.process-resources.phase&gt;none&lt;/pkg.process-resources.phase&gt; &lt;pkg.package.phase&gt;none&lt;/pkg.package.phase&gt; &lt;pkg.user&gt;thingsboard&lt;/pkg.user&gt; &lt;pkg.implementationTitle&gt;${project.name}&lt;/pkg.implementationTitle&gt; &lt;pkg.unixLogFolder&gt;/var/log/${pkg.name}&lt;/pkg.unixLogFolder&gt; &lt;pkg.installFolder&gt;/usr/share/${pkg.name}&lt;/pkg.installFolder&gt; &lt;/properties&gt; ç¼“å­˜å¯¼è‡´ç¼–è¯‘å¤±è´¥ æ¯æ¬¡ç¼–è¯‘å¤±è´¥è¿›è¡ŒäºŒæ¬¡ç¼–è¯‘æ—¶ï¼Œè¦æ¸…ç†ç¼“å­˜ï¼Œå¹¶æ€æ­»é—ç•™è¿›ç¨‹ æ­¥éª¤ 1ï¼šæ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼Œæ€æ­»é—ç•™è¿›ç¨‹ taskkill /f /im java.exe æ­¥éª¤ 2ï¼šä½¿ç”¨ IDEA Maven å·¥å…·è¿›è¡Œæ¸…ç† æ¸©é¦¨æç¤ºï¼šè¦è¿›è¡ŒäºŒæ¬¡ç¼–è¯‘å‰ï¼Œæœ€å¥½é‡å¯ä¸€æ¬¡ç”µè„‘ï¼ Server UI ç¼–è¯‘å¤±è´¥ [ERROR] Failed to execute goal com.github.eirslett:frontend-maven-plugin:1.0:npm (npm install) on project ui: Failed to run task: 'npm install' failed. (error code 1) -&gt; [Help 1] å¦‚æœé‡åˆ°è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»ä»¥ä¸‹å‡ ä¸ªåŸå› è¿›è¡Œåˆ†æï¼š åŸå›  1ï¼šnodeã€npm ç‰ˆæœ¬å·é—®é¢˜ æœ¬åœ°ç¯å¢ƒå®‰è£…çš„ nodeã€npm ç‰ˆæœ¬å·ä¸æºç ä¸­ pom.xml æ–‡ä»¶é…ç½®çš„ç‰ˆæœ¬å·ä¸ä¸€è‡´ã€‚ è§£å†³æ–¹æ¡ˆï¼š æ­¥éª¤ 1ï¼šä½¿ç”¨ node -vã€npm -v æŸ¥çœ‹å®‰è£…çš„ node å’Œ npm ç‰ˆæœ¬å· æ­¥éª¤ 2ï¼šä¿®æ”¹æºç ä¸­ pom.xml æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬å· &lt;configuration&gt; &lt;nodeVersion&gt;v12.13.1&lt;/nodeVersion&gt; &lt;npmVersion&gt;6.12.1&lt;/npmVersion&gt; &lt;/configuration&gt; éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶æœ‰ä¸‰å¤„ï¼Œä½ç½®å¦‚ä¸‹ï¼š åŸå›  2ï¼šnode-sass ä¸‹è½½å¤±è´¥ ç¼–è¯‘ Server UI æ—¶ï¼Œä¼šä¸‹è½½ node-sass ä¾èµ–ï¼Œå¦‚æœå› ä¸ºç½‘ç»œåŸå› æ²¡æœ‰ä¸‹è½½æˆåŠŸï¼Œä¹Ÿä¼šç¼–è¯‘å¤±è´¥ã€‚å¦‚æœä½ æ˜¯æŒ‰ç…§æœ¬æœ¬æ•™æä¸€æ­¥ä¸€æ­¥æ¥çš„ï¼Œåº”è¯¥ä¸ä¼šæœ‰é—®é¢˜ï¼Œä¸Šé¢å‡†å¤‡å·¥ä½œä¸­ï¼Œå°† npm é•œåƒæºåˆ‡æ¢ä¸ºæ·˜å®ï¼Œé‚£ä¹ˆä¸‹è½½ä¼šå¾ˆå¿«çš„ã€‚ [INFO] Downloading binary from https://github.com/sass/node-sass/releases/download/v4.12.0/win32-x64-72_binding.node [ERROR] Cannot download &quot;https://github.com/sass/node-sass/releases/download/v4.12.0/win32-x64-72_binding.node&quot;: [ERROR] [ERROR] ESOCKETTIMEDOUT [ERROR] [ERROR] Hint: If github.com is not accessible in your location [ERROR] try setting a proxy via HTTP_PROXY, e.g. [ERROR] [ERROR] export HTTP_PROXY=http://example.com:1234 [ERROR] [ERROR] or configure npm proxy via [ERROR] [ERROR] npm config set proxy http://example.com:8080 [INFO] [INFO] &gt; node-sass@4.12.0 postinstall F:\\workspace\\thingsboard\\thingsboard\\ui\\node_modules\\node-sass [INFO] &gt; node scripts/build.js [INFO] è§£å†³æ–¹æ¡ˆï¼šåˆ‡æ¢é•œåƒæºä¸ºæ·˜å® è§£å†³æ–¹æ¡ˆï¼šé‡å¯ç”µè„‘ï¼Œæ¸…ç†ç¼“å­˜ åŸå›  3ï¼šThingsboard 3.0 ç‰ˆæœ¬ç¼–è¯‘é‡åˆ°çš„é—®é¢˜ äº²æµ‹ï¼š2.4 ç‰ˆæœ¬ä¹Ÿå¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼æ¥è§£å†³ Failed to execute goal com.github.eirslett:frontend-maven-plugin:1.7.5:npm (npm install) on project ui-ngx: Failed to run task: 'npm install' failed. org.apache.commons.exec.ExecuteException: Process exited with an error: -4048 (Exit value: -4048) -&gt; [Help 1] è§£å†³æ–¹æ¡ˆï¼šhttps://www.iotschool.com/topics/84 åŸå›  4ï¼šäºŒæ¬¡ç¼–è¯‘å¯¼è‡´æ®‹ç•™è¿›ç¨‹ æŠ¥é”™ï¼š [ERROR] Failed to execute goal org.apache.maven.plugins:maven-clean-plugin:2.5:clean (default-clean) on project ui: Failed to clean project: Failed to delete F:\\workspace\\thingsboard\\thingsboard\\ui\\target\\node\\node.exe -&gt; [Help 1] Server Tool ç¼–è¯‘å¤±è´¥ [ERROR] Failed to execute goal on project tools: Could not resolve dependencies for project org.thingsboard:tools:jar:2.4.3: Failed to collect dependencies at org.eclipse.paho:org.eclipse.paho.client.mqttv3:jar:1.1.0: Failed to read artifact descriptor for org.eclipse.paho:org.eclipse.paho.clien t.mqttv3:jar:1.1.0: Could not transfer artifact org.eclipse.paho:org.eclipse.paho.client.mqttv3:pom:1.1.0 from/to aliyun_nexus (http://maven.aliyun.com/nexus/content/groups/public/): Failed to transfer file http://maven.aliyun.com/nexus/content/groups/public/org/eclipse/paho/org.eclipse.paho.cli ent.mqttv3/1.1.0/org.eclipse.paho.client.mqttv3-1.1.0.pom with status code 502 -&gt; [Help 1] ä¸€èˆ¬ç”±äºç½‘ç»œåŸå› ï¼ŒIoTSchool å°ç¼–è‡³å°‘ç¼–è¯‘äº† 3 æ¬¡æ‰æˆåŠŸï¼Œæ¯æ¬¡ç¼–è¯‘éƒ½é‡å¯ç”µè„‘ï¼Œå¹¶æ¸…ç†ç¯å¢ƒã€‚ è§£å†³æ–¹æ¡ˆï¼šå¦‚æœä½¿ç”¨çš„æ˜¯ mvn clean install -DskipTests å‘½ä»¤è¿›è¡Œç¼–è¯‘ï¼Œé‚£ä¹ˆå°±å¤šå°è¯•å‡ æ¬¡ï¼Œæ¯æ¬¡ç¼–è¯‘å‰ï¼Œè¦æ¸…ç†ç¯å¢ƒã€‚ å‚è€ƒï¼šhttps://github.com/thingsboard/performance-tests/issues/10 JavaScript Executor ç¼–è¯‘å¤±è´¥ JavaScript Executor Microservice ç¼–è¯‘å¤±è´¥ [ERROR] Failed to execute goal com.github.eirslett:frontend-maven-plugin:1.0:npm (npm install) on project js-executor: Failed to run task: 'npm install' failed. (error code 2) -&gt; [Help 1] [ERROR] [ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch. [ERROR] Re-run Maven using the -X switch to enable full debug logging. [ERROR] [ERROR] For more information about the errors and possible solutions, please read the following articles: [ERROR] [Help 1] http://cwiki.apache.org/confluence/display/MAVEN/MojoFailureException [ERROR] [ERROR] After correcting the problems, you can resume the build with the command [ERROR] mvn &lt;goals&gt; -rf :js-executor åŸå› ï¼šæœ¬åœ°ç¼“å­˜ç¼ºå°‘ fetched-v10.15.3-linux-x64 å’Œ fetched-v10.15.3-win-x64 è¿™ä¸¤ä¸ªæ–‡ä»¶ã€‚ è§£å†³æ–¹æ¡ˆï¼š æ­¥éª¤ 1ï¼šä¸‹è½½è¿™ä¸¤ä¸ªæ–‡ä»¶åˆ°æœ¬åœ°ï¼Œä¸‹è½½åè®°å¾—é‡å‘½åï¼Œä¸‹è½½åœ°å€ï¼šhttps://github.com/zeit/pkg-fetch/releases æ­¥éª¤ 2: å°†ä¸‹è½½çš„ä¸¤ä¸ªæ–‡ä»¶æ”¾åˆ°ï¼šæ”¾åˆ°ï¼šC:\\Users\\ä½ çš„ç”¨æˆ·å \\ .pkg-cache\\v2.6ã€‚å¹¶å°†åå­—åˆ†åˆ«ä¿®æ”¹ä¸ºï¼šfetched-v10.15.3-linux-x64 å’Œ fetched-v10.15.3-win-x64 å‚è€ƒï¼šhttps://github.com/thingsboard/thingsboard/issues/2084 License æ£€æŸ¥ä¸é€šè¿‡ [ERROR] Failed to execute goal com.mycila:license-maven-plugin:3.0:check (default) on project thingsboard: Some files do not have the expected license header -&gt; [Help 1] è§£å†³æ–¹æ¡ˆï¼šåœ¨æ ¹ç›®å½• pom.xml ä¸­å±è”½ license-maven-plugin æœç´¢ license-maven-pluginï¼Œå°†æ•´ä¸ª plugin éƒ½æ³¨é‡Šæ‰ Web UI ç¼–è¯‘å¤±è´¥ Web UI ç¼–è¯‘å¤±è´¥è¯·å‚è€ƒ[Server UI ç¼–è¯‘å¤±è´¥ç¬¬ä¸€ä¸ªåŸå› ](https://www.iotschool.com/wiki/tbinstall#Server Toolç¼–è¯‘å¤±è´¥) maven:Could not resolve dependencies for project org.thingsboard:application: é”™è¯¯ä¿¡æ¯ [ERROR] Failed to execute goal on project application: Could not resolve dependencies for project org.thingsboard:application:jar:2.4.1: The following artifacts could not be resolved: org.thingsboard.rule-engine:rule-engine-components:jar:2.4.1, org.thingsboard:dao:jar:2.4.1: Could not find artifact org.thingsboard.rule-engine:rule-engine-components:jar:2.4.1 in jenkins (http://repo.jenkins-ci.org/releases) -&gt; [Help 1] è§£å†³æ–¹æ¡ˆï¼šæ ¹ç›®å½•ä¸‹å» maven ç¼–è¯‘ï¼Œä¸è¦åœ¨æ¯ä¸ªå•ç‹¬ç¼–è¯‘ï¼Œå¦åˆ™ä¸èƒ½è‡ªåŠ¨è§£å†³ä¾èµ–ï¼Œå¦‚æœä½ å·²ç»åœ¨å­æ¨¡å—è¿›è¡Œäº†ç¼–è¯‘ï¼Œè¯·å›åˆ°æ ¹ç›®å½•å…ˆ clean ä¸€ä¸‹ï¼Œå†é‡æ–°ç¼–è¯‘ã€‚ maven:Failed to delete tb-http-transport.rpm é”™è¯¯ä¿¡æ¯ï¼š [ERROR] Failed to execute goal org.apache.maven.plugins:maven-clean-plugin:2.5:clean (default-clean) on project http: Failed to clean project: Failed to delete D:\\my_project\\thingsboard\\transport\\http\\target\\tb-http-transport.rpm -&gt; [Help 1] è§£å†³æ–¹æ¡ˆï¼šç¬¬ä¸€æ¬¡ç¼–è¯‘å¤±è´¥ï¼Œå†æ¬¡ç¼–è¯‘å¯èƒ½ä¼šæç¤ºè¯¥é”™è¯¯ï¼Œå¯ä»¥æ‰‹åŠ¨åˆ°æŠ¥é”™è·¯å¾„åˆ é™¤ï¼Œå¦‚æœæç¤ºæ–‡ä»¶æ­£åœ¨ä½¿ç”¨ï¼Œéœ€è¦åœ¨ä»»åŠ¡ç®¡ç†å™¨æ€æ­» java è¿›ç¨‹åå†æ‰‹åŠ¨åˆ é™¤ã€‚ npm:npm:cb() never called! é”™è¯¯ä¿¡æ¯ï¼š npm ERR! cb() never called! npm ERR! This is an error with npm itself. Please report this error at: npm ERR! &lt;https://npm.community&gt; npm ERR! A complete log of this run can be found in: npm ERR! C:\\Users\\yuren\\AppData\\Roaming\\npm-cache\\_logs\\2019-11-06T10_55_28_258Z-debug.log è§£å†³æ–¹æ¡ˆï¼š å°è¯• npm cache clean --force åå†æ¬¡ npm install æ— æœï¼› å°è¯•æ›´æ¢æ·˜å®é•œåƒæºåå†æ¬¡ npm install æ— æœï¼› æ€€ç–‘æœ‰äº›åŒ…ä¸‹è½½éœ€è¦ç¿»å¢™ï¼Œå…¨å±€ä»£ç†ç¿»å¢™åé—®é¢˜ä¾ç„¶å­˜åœ¨ï¼› å‚è€ƒç½‘ä¸Šå…³é—­æ‰€æœ‰ä»£ç†åé—®é¢˜ä¾ç„¶å­˜åœ¨ï¼› é€šè¿‡ log æ—¥å¿—åˆ†ææœ€åä¸€ä¸ªè§£åŒ…æŠ¥é”™çš„åœ°æ–¹ï¼Œå±è”½éœ€è¦çš„ material-design-iconsï¼Œæ–° modules rxjs ä»ç„¶æŠ¥é”™ï¼› extract material-design-icons@3.0.1 extracted to node_modules\\.staging\\material-design-icons-61b4d55e (72881ms) extract rxjs@6.5.2 extracted to node_modules\\.staging\\rxjs-e901ba4c (24280ms) å‚è€ƒ npm ERR cb() never called æ‰§è¡Œ npm install --no-package-lock ä¹‹åæç¤º npm ERR! path gitï¼Œæ·»åŠ  git åˆ°ç¯å¢ƒå˜é‡åæ­£å¸¸ã€‚ npm:npm ERR! path git é”™è¯¯ä¿¡æ¯ npm ERR! path git npm ERR! code ENOENT npm ERR! errno ENOENT npm ERR! syscall spawn git npm ERR! enoent Error while executing: npm ERR! enoent undefined ls-remote -h -t git://github.com/fabiobiondi/angular- è§£å†³æ–¹æ¡ˆï¼šæ·»åŠ  git åˆ°ç¯å¢ƒå˜é‡ã€‚ No compiler is provided in this environment é”™è¯¯ä¿¡æ¯ï¼š [ERROR] Failed to execute goal org.apache.maven.plugins:maven-compiler-plugin:3. 1:compile (default-compile) on project netty-mqtt: Compilation failure [ERROR] No compiler is provided in this environment. Perhaps you are running on a JRE rather than a JDK? éœ€è¦åœ¨ç¯å¢ƒå˜é‡ä¸­è®¾ç½® javaï¼ŒåŒ…å«%JAVA_HOME%bin;%JAVA_HOME%lib; Failed to execute goal org.thingsboard:gradle-maven-plugin:1.0.10:invoke (default) on project http: org.gradle.tooling.BuildException: Could not execute build using Gradle distribution 'https://services.gradle.org/distributions/gradle-6.3-bin.zip'. Failed to execute goal org.apache.maven.plugins:maven-compiler-plugin:3.8.1:compile (default-compile) on project rest-client: Compilation failure An unknown compilation problem occurred è¿™ä¸ªé—®é¢˜ä¸»è¦æ˜¯jdkç‰ˆæœ¬è·Ÿé¡¹ç›®ä¸ä¸€è‡´å¯¼è‡´çš„ï¼Œå¦‚æœé¡¹ç›®çš„ç‰ˆæœ¬æ˜¯å¤§äº(ä¸å«ï¼)3.2.1ï¼Œåˆ™éœ€è¦JDK11ï¼Œåä¹‹JDK8 ","link":"https://tianxiawuhao.github.io/DseKIIHw3/"},{"title":"ClickHouse-8åˆ†ç‰‡é›†ç¾¤","content":"ClickHouse-åˆ†ç‰‡é›†ç¾¤ å‰¯æœ¬è™½ç„¶èƒ½å¤Ÿæé«˜æ•°æ®çš„å¯ç”¨æ€§ï¼Œé™ä½ä¸¢å¤±é£é™©ï¼Œä½†æ˜¯æ¯å°æœåŠ¡å™¨å®é™…ä¸Šå¿…é¡»å®¹çº³å…¨é‡æ•°æ®ï¼Œå¯¹æ•°æ®çš„æ¨ªå‘æ‰©å®¹æ²¡æœ‰è§£å†³ã€‚ è¦è§£å†³æ•°æ®æ°´å¹³åˆ‡åˆ†çš„é—®é¢˜ï¼Œéœ€è¦å¼•å…¥åˆ†ç‰‡çš„æ¦‚å¿µã€‚é€šè¿‡åˆ†ç‰‡æŠŠä¸€ä»½å®Œæ•´çš„æ•°æ®è¿›è¡Œåˆ‡åˆ†ï¼Œä¸åŒçš„åˆ†ç‰‡åˆ†å¸ƒåˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œå†é€šè¿‡ Distributed è¡¨å¼•æ“æŠŠæ•°æ®æ‹¼æ¥èµ·æ¥ä¸€åŒä½¿ç”¨ã€‚ Distributed è¡¨å¼•æ“æœ¬èº«ä¸å­˜å‚¨æ•°æ®ï¼Œæœ‰ç‚¹ç±»ä¼¼äº MyCat ä¹‹äº MySqlï¼Œæˆä¸ºä¸€ç§ä¸­é—´ä»¶ï¼Œé€šè¿‡åˆ†å¸ƒå¼é€»è¾‘è¡¨æ¥å†™å…¥ã€åˆ†å‘ã€è·¯ç”±æ¥æ“ä½œå¤šå°èŠ‚ç‚¹ä¸åŒåˆ†ç‰‡çš„åˆ†å¸ƒå¼æ•°æ®ã€‚ æ³¨æ„ï¼šClickHouse çš„é›†ç¾¤æ˜¯è¡¨çº§åˆ«çš„ï¼Œå®é™…ä¼ä¸šä¸­ï¼Œå¤§éƒ¨åˆ†åšäº†é«˜å¯ç”¨ï¼Œä½†æ˜¯æ²¡æœ‰ç”¨åˆ†ç‰‡ï¼Œé¿å…é™ä½æŸ¥è¯¢æ€§èƒ½ä»¥åŠæ“ä½œé›†ç¾¤çš„å¤æ‚æ€§ã€‚ 1.é›†ç¾¤å†™å…¥æµç¨‹ï¼ˆ3 åˆ†ç‰‡ 2 å‰¯æœ¬å…± 6 ä¸ªèŠ‚ç‚¹ï¼‰ internal_replication:å†…éƒ¨å‰¯æœ¬åŒæ­¥ trueï¼šç”±åˆ†ç‰‡è‡ªå·±åŒæ­¥ falseï¼šç”±distributeè¡¨åŒæ­¥ï¼Œå‹åŠ›å¤§ 2.é›†ç¾¤è¯»å–æµç¨‹ï¼ˆ3 åˆ†ç‰‡ 2 å‰¯æœ¬å…± 6 ä¸ªèŠ‚ç‚¹ï¼‰ 3 åˆ†ç‰‡ 2 å‰¯æœ¬å…± 6 ä¸ªèŠ‚ç‚¹é›†ç¾¤é…ç½®ï¼ˆä¾›å‚è€ƒï¼‰ é…ç½®çš„ä½ç½®è¿˜æ˜¯åœ¨ä¹‹å‰çš„/etc/clickhouse-server/config.d/metrika.xmlï¼Œå†…å®¹å¦‚ä¸‹ æ³¨ï¼šä¹Ÿå¯ä»¥ä¸åˆ›å»ºå¤–éƒ¨æ–‡ä»¶ï¼Œç›´æ¥åœ¨ config.xml çš„&lt;remote_servers&gt;ä¸­æŒ‡å®š &lt;yandex&gt; &lt;remote_servers&gt; &lt;fz_cluster&gt; &lt;!-- é›†ç¾¤åç§°--&gt; &lt;shard&gt; &lt;!--é›†ç¾¤çš„ç¬¬ä¸€ä¸ªåˆ†ç‰‡--&gt; &lt;internal_replication&gt;true&lt;/internal_replication&gt; &lt;!--è¯¥åˆ†ç‰‡çš„ç¬¬ä¸€ä¸ªå‰¯æœ¬--&gt; &lt;replica&gt; &lt;host&gt;node01&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;/replica&gt; &lt;!--è¯¥åˆ†ç‰‡çš„ç¬¬äºŒä¸ªå‰¯æœ¬--&gt; &lt;replica&gt; &lt;host&gt;node02&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;shard&gt; &lt;!--é›†ç¾¤çš„ç¬¬äºŒä¸ªåˆ†ç‰‡--&gt; &lt;internal_replication&gt;true&lt;/internal_replication&gt; &lt;replica&gt; &lt;!--è¯¥åˆ†ç‰‡çš„ç¬¬ä¸€ä¸ªå‰¯æœ¬--&gt; &lt;host&gt;node03&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;/replica&gt; &lt;replica&gt; &lt;!--è¯¥åˆ†ç‰‡çš„ç¬¬äºŒä¸ªå‰¯æœ¬--&gt; &lt;host&gt;node04&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;shard&gt; &lt;!--é›†ç¾¤çš„ç¬¬ä¸‰ä¸ªåˆ†ç‰‡--&gt; &lt;internal_replication&gt;true&lt;/internal_replication&gt; &lt;replica&gt; &lt;!--è¯¥åˆ†ç‰‡çš„ç¬¬ä¸€ä¸ªå‰¯æœ¬--&gt; &lt;host&gt;node05&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;/replica&gt; &lt;replica&gt; &lt;!--è¯¥åˆ†ç‰‡çš„ç¬¬äºŒä¸ªå‰¯æœ¬--&gt; &lt;host&gt;node06&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;/fz_cluster&gt; &lt;/remote_servers&gt; &lt;/yandex&gt; 4 .é…ç½®ä¸‰èŠ‚ç‚¹ç‰ˆæœ¬é›†ç¾¤åŠå‰¯æœ¬ 4.1 é›†ç¾¤åŠå‰¯æœ¬è§„åˆ’ï¼ˆ2 ä¸ªåˆ†ç‰‡ï¼Œåªæœ‰ç¬¬ä¸€ä¸ªåˆ†ç‰‡æœ‰å‰¯æœ¬ï¼‰ 4.2 é…ç½®æ­¥éª¤ 1ï¼‰åœ¨ Node01 çš„/etc/clickhouse-server/config.d ç›®å½•ä¸‹åˆ›å»º metrika-shard.xml æ–‡ä»¶ vim /etc/clickhouse-server/config.d/metrika-shard.xml æ³¨ï¼šä¹Ÿå¯ä»¥ä¸åˆ›å»ºå¤–éƒ¨æ–‡ä»¶ï¼Œç›´æ¥åœ¨ config.xml çš„&lt;remote_servers&gt;ä¸­æŒ‡å®š &lt;?xml version=&quot;1.0&quot;?&gt; &lt;yandex&gt; &lt;remote_servers&gt; &lt;gmall_cluster&gt; &lt;!-- é›†ç¾¤åç§°--&gt; &lt;shard&gt; &lt;!--é›†ç¾¤çš„ç¬¬ä¸€ä¸ªåˆ†ç‰‡--&gt; &lt;internal_replication&gt;true&lt;/internal_replication&gt; &lt;replica&gt; &lt;!--è¯¥åˆ†ç‰‡çš„ç¬¬ä¸€ä¸ªå‰¯æœ¬--&gt; &lt;host&gt;Node01&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;1234qwer&lt;/password&gt; &lt;/replica&gt; &lt;replica&gt; &lt;!--è¯¥åˆ†ç‰‡çš„ç¬¬äºŒä¸ªå‰¯æœ¬--&gt; &lt;host&gt;Node02&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;1234qwer&lt;/password&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;shard&gt; &lt;!--é›†ç¾¤çš„ç¬¬äºŒä¸ªåˆ†ç‰‡--&gt; &lt;internal_replication&gt;true&lt;/internal_replication&gt; &lt;replica&gt; &lt;!--è¯¥åˆ†ç‰‡çš„ç¬¬ä¸€ä¸ªå‰¯æœ¬--&gt; &lt;host&gt;Node03&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;1234qwer&lt;/password&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;/gmall_cluster&gt; &lt;/remote_servers&gt; &lt;zookeeper-servers&gt; &lt;node index=&quot;1&quot;&gt; &lt;host&gt;Node01&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;node index=&quot;2&quot;&gt; &lt;host&gt;Node02&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;node index=&quot;3&quot;&gt; &lt;host&gt;Node03&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;/zookeeper-servers&gt; &lt;macros&gt; &lt;shard&gt;01&lt;/shard&gt; &lt;!--ä¸åŒæœºå™¨æ”¾çš„åˆ†ç‰‡æ•°ä¸ä¸€æ ·--&gt; &lt;replica&gt;rep_1_1&lt;/replica&gt; &lt;!--ä¸åŒæœºå™¨æ”¾çš„å‰¯æœ¬æ•°ä¸ä¸€æ ·--&gt; &lt;/macros&gt; &lt;/yandex&gt; 2ï¼‰å°† Node01 çš„ metrika-shard.xml åŒæ­¥åˆ° Node02 å’Œ Node03 scp /etc/clickhouse-server/config.d/metrika-shard.xml root@Node02:/etc/clickhouse-server/config.d/ scp /etc/clickhouse-server/config.d/metrika-shard.xml root@Node03:/etc/clickhouse-server/config.d/ 3ï¼‰ä¿®æ”¹ Node02 å’Œ Node03 ä¸­ metrika-shard.xml å®çš„é…ç½® ï¼ˆ1ï¼‰Node02 &lt;macros&gt; &lt;shard&gt;01&lt;/shard&gt; &lt;!--ä¸åŒæœºå™¨æ”¾çš„åˆ†ç‰‡æ•°ä¸ä¸€æ ·--&gt; &lt;replica&gt;rep_1_2&lt;/replica&gt; &lt;!--ä¸åŒæœºå™¨æ”¾çš„å‰¯æœ¬æ•°ä¸ä¸€æ ·--&gt; &lt;/macros&gt;1.2.3.4. ï¼ˆ2ï¼‰Node03 &lt;macros&gt; &lt;shard&gt;02&lt;/shard&gt; &lt;!--ä¸åŒæœºå™¨æ”¾çš„åˆ†ç‰‡æ•°ä¸ä¸€æ ·--&gt; &lt;replica&gt;rep_2_1&lt;/replica&gt; &lt;!--ä¸åŒæœºå™¨æ”¾çš„å‰¯æœ¬æ•°ä¸ä¸€æ ·--&gt; &lt;/macros&gt;1.2.3.4. 4ï¼‰åœ¨ Node01 ä¸Šä¿®æ”¹/etc/clickhouse-server/config.xml vim /etc/clickhouse-server/config.xml &lt;zookeeper incl=&quot;zookeeper-servers&quot; optional=&quot;true&quot; /&gt; &lt;include_from&gt;/etc/clickhouse-server/config.d/metrika-shard.xml&lt;/include_from&gt; 5ï¼‰åŒæ­¥/etc/clickhouse-server/config.xml åˆ° Node02 å’Œ Node03 scp /etc/clickhouse-server/config.xml root@Node02:/etc/clickhouse-server/ scp /etc/clickhouse-server/config.xml root@Node03:/etc/clickhouse-server/ 6ï¼‰é‡å¯ä¸‰å°æœåŠ¡å™¨ä¸Šçš„ ClickHouse æœåŠ¡ sudo clickhouse restart æŸ¥çœ‹é›†ç¾¤ superset-BI :) show clusters; SHOW CLUSTERS Query id: 391735d2-bf74-43f5-aa86-b6d203c357cd â”Œâ”€clusterâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ gmall_cluster â”‚ â”‚ test_cluster_one_shard_three_replicas_localhost â”‚ â”‚ test_cluster_two_shards â”‚ â”‚ test_cluster_two_shards_internal_replication â”‚ â”‚ test_cluster_two_shards_localhost â”‚ â”‚ test_shard_localhost â”‚ â”‚ test_shard_localhost_secure â”‚ â”‚ test_unavailable_shard â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 8 rows in set. Elapsed: 0.002 sec. 7ï¼‰åœ¨ Node01 ä¸Šæ‰§è¡Œå»ºè¡¨è¯­å¥ â¢ ä¼šè‡ªåŠ¨åŒæ­¥åˆ° Node02 å’Œ Node03 ä¸Š â¢ é›†ç¾¤åå­—è¦å’Œé…ç½®æ–‡ä»¶ä¸­çš„ä¸€è‡´ â¢ åˆ†ç‰‡å’Œå‰¯æœ¬åç§°ä»é…ç½®æ–‡ä»¶çš„å®å®šä¹‰ä¸­è·å– create table st_fz_order_mt_01 on cluster gmall_cluster ( id UInt32, sku_id String, total_amount Decimal(16,2), create_time Datetime ) engine =ReplicatedMergeTree('/clickhouse/tables/{shard}/st_fz_order_mt_01','{replica}') partition by toYYYYMMDD(create_time) primary key (id) order by (id,sku_id); create table st_fz_order_mt_01 on cluster gmall_cluster ( id UInt32, sku_id String, total_amount Decimal(16,2), create_time Datetime ) engine =ReplicatedMergeTree('/clickhouse/tables/{shard}/st_fz_order_mt_01','{replica}') partition by toYYYYMMDD(create_time) primary key (id) order by (id,sku_id); CREATE TABLE st_fz_order_mt_01 ON CLUSTER gmall_cluster ( `id` UInt32, `sku_id` String, `total_amount` Decimal(16, 2), `create_time` Datetime ) ENGINE = ReplicatedMergeTree('/clickhouse/tables/{shard}/st_fz_order_mt_01', '{replica}') PARTITION BY toYYYYMMDD(create_time) PRIMARY KEY id ORDER BY (id, sku_id) åœ¨Node02å’ŒNode03ä¸ŠæŸ¥çœ‹è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ show tables; 8ï¼‰åœ¨ Node02 ä¸Šåˆ›å»º Distribute åˆ†å¸ƒå¼è¡¨ create table st_fz_order_mt_all2 on cluster gmall_cluster ( id UInt32, sku_id String, total_amount Decimal(16,2), create_time Datetime )engine = Distributed(gmall_cluster,default, st_fz_order_mt_01,hiveHash(sku_id)); CREATE TABLE st_fz_order_mt_all2 ON CLUSTER gmall_cluster ( `id` UInt32, `sku_id` String, `total_amount` Decimal(16, 2), `create_time` Datetime ) ENGINE = Distributed(gmall_cluster, default, st_fz_order_mt_01, hiveHash(sku_id)) å‚æ•°å«ä¹‰ï¼š Distributedï¼ˆé›†ç¾¤åç§°ï¼Œåº“åï¼Œæœ¬åœ°è¡¨åï¼Œåˆ†ç‰‡é”®ï¼‰ åˆ†ç‰‡é”®å¿…é¡»æ˜¯æ•´å‹æ•°å­—ï¼Œæ‰€ä»¥ç”¨ hiveHash å‡½æ•°è½¬æ¢ï¼Œä¹Ÿå¯ä»¥ rand() 9ï¼‰åœ¨ Node01 ä¸Šæ’å…¥æµ‹è¯•æ•°æ® insert into st_order_mt_all2 values (201,'sku_001',1000.00,'2020-06-01 12:00:00') , (202,'sku_002',2000.00,'2020-06-01 12:00:00'), (203,'sku_004',2500.00,'2020-06-01 12:00:00'), (204,'sku_002',2000.00,'2020-06-01 12:00:00'), (205,'sku_003',600.00,'2020-06-02 12:00:00');1.2.3.4.5.6. 10ï¼‰é€šè¿‡æŸ¥è¯¢åˆ†å¸ƒå¼è¡¨å’Œæœ¬åœ°è¡¨è§‚å¯Ÿè¾“å‡ºç»“æœ ï¼ˆ1ï¼‰åˆ†å¸ƒå¼è¡¨ select * From st_fz_order_mt_all2; Query id: d8b676e9-c119-4483-8ca2-f0b5cd150a61 â”Œâ”€â”€idâ”€â”¬â”€sku_idâ”€â”€â”¬â”€total_amountâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€create_timeâ”€â” â”‚ 202 â”‚ sku_002 â”‚ 2000 â”‚ 2020-06-01 12:00:00 â”‚ â”‚ 203 â”‚ sku_004 â”‚ 2500 â”‚ 2020-06-01 12:00:00 â”‚ â”‚ 204 â”‚ sku_002 â”‚ 2000 â”‚ 2020-06-01 12:00:00 â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”Œâ”€â”€idâ”€â”¬â”€sku_idâ”€â”€â”¬â”€total_amountâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€create_timeâ”€â” â”‚ 205 â”‚ sku_003 â”‚ 600 â”‚ 2020-06-02 12:00:00 â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”Œâ”€â”€idâ”€â”¬â”€sku_idâ”€â”€â”¬â”€total_amountâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€create_timeâ”€â” â”‚ 201 â”‚ sku_001 â”‚ 1000 â”‚ 2020-06-01 12:00:00 â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ ï¼ˆ2ï¼‰æœ¬åœ°è¡¨ Node1: SELECT * FROM st_fz_order_mt_01 Query id: ddcb5176-e443-4253-9877-57fec8f57311 â”Œâ”€â”€idâ”€â”¬â”€sku_idâ”€â”€â”¬â”€total_amountâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€create_timeâ”€â” â”‚ 202 â”‚ sku_002 â”‚ 2000 â”‚ 2020-06-01 12:00:00 â”‚ â”‚ 203 â”‚ sku_004 â”‚ 2500 â”‚ 2020-06-01 12:00:00 â”‚ â”‚ 204 â”‚ sku_002 â”‚ 2000 â”‚ 2020-06-01 12:00:00 â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 3 rows in set. Elapsed: 0.002 sec. Node3: SELECT * FROM st_fz_order_mt_01 Query id: 7a336004-7040-4098-948e-1e7c5d983edb â”Œâ”€â”€idâ”€â”¬â”€sku_idâ”€â”€â”¬â”€total_amountâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€create_timeâ”€â” â”‚ 205 â”‚ sku_003 â”‚ 600 â”‚ 2020-06-02 12:00:00 â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”Œâ”€â”€idâ”€â”¬â”€sku_idâ”€â”€â”¬â”€total_amountâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€create_timeâ”€â” â”‚ 201 â”‚ sku_001 â”‚ 1000 â”‚ 2020-06-01 12:00:00 â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 2 rows in set. Elapsed: 0.002 sec. å¯ä»¥çœ‹åˆ°æ•°æ®åˆ†å¸ƒåœ¨Node1å’ŒNode3ä¸¤ä¸ªèŠ‚ç‚¹ä¸Šã€‚ ","link":"https://tianxiawuhao.github.io/vuilLU8qj/"},{"title":"ClickHouse-7å‰¯æœ¬","content":"1 å‰¯æœ¬å†™å…¥æµç¨‹ 2 é…ç½®æ­¥éª¤ å¯åŠ¨ zookeeper é›†ç¾¤ åœ¨ hadoop102 çš„/etc/clickhouse-server/config.d ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º metrika.xml çš„é…ç½®æ–‡ä»¶,å†…å®¹å¦‚ä¸‹ï¼š æ³¨ï¼šä¹Ÿå¯ä»¥ä¸åˆ›å»ºå¤–éƒ¨æ–‡ä»¶ï¼Œç›´æ¥åœ¨ config.xml ä¸­æŒ‡å®š &lt;?xml version=&quot;1.0&quot;?&gt; &lt;yandex&gt; &lt;zookeeper-servers&gt; &lt;node index=&quot;1&quot;&gt; &lt;host&gt;hadoop102&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;node index=&quot;2&quot;&gt; &lt;host&gt;hadoop103&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;node index=&quot;3&quot;&gt; &lt;host&gt;hadoop104&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;/zookeeper-servers&gt; &lt;/yandex&gt; åŒæ­¥åˆ° hadoop103 å’Œ hadoop104 ä¸Š sudo /home/atguigu/bin/xsync /etc/clickhouse-server/config.d/metrika.xml åœ¨ hadoop102 çš„/etc/clickhouse-server/config.xml ä¸­å¢åŠ  &lt;zookeeper incl=&quot;zookeeper-servers&quot; optional=&quot;true&quot; /&gt; &lt;include_from&gt;/etc/clickhouse-server/config.d/metrika.xml&lt;/include_from&gt; åŒæ­¥åˆ° hadoop103 å’Œ hadoop104 ä¸Š sudo /home/atguigu/bin/xsync /etc/clickhouse-server/config.xml åˆ†åˆ«åœ¨ hadoop102 å’Œ hadoop103 ä¸Šå¯åŠ¨ ClickHouse æœåŠ¡ æ³¨æ„ï¼šå› ä¸ºä¿®æ”¹äº†é…ç½®æ–‡ä»¶ï¼Œå¦‚æœä»¥å‰å¯åŠ¨äº†æœåŠ¡éœ€è¦é‡å¯ sudo clickhouse restart æ³¨æ„ï¼šæˆ‘ä»¬æ¼”ç¤ºå‰¯æœ¬æ“ä½œåªéœ€è¦åœ¨ hadoop102 å’Œ hadoop103 ä¸¤å°æœåŠ¡å™¨å³å¯ï¼Œä¸Šé¢çš„ æ“ä½œï¼Œæˆ‘ä»¬ hadoop104 å¯ä»¥ä½ ä¸ç”¨åŒæ­¥ï¼Œæˆ‘ä»¬è¿™é‡Œä¸ºäº†ä¿è¯é›†ç¾¤ä¸­èµ„æºçš„ä¸€è‡´æ€§ï¼Œåšäº†åŒ æ­¥ã€‚ åœ¨ hadoop102 å’Œ hadoop103 ä¸Šåˆ†åˆ«å»ºè¡¨ å‰¯æœ¬åªèƒ½åŒæ­¥æ•°æ®ï¼Œä¸èƒ½åŒæ­¥è¡¨ç»“æ„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨æ¯å°æœºå™¨ä¸Šè‡ªå·±æ‰‹åŠ¨å»ºè¡¨ create table t_order_rep2 ( id UInt32, sku_id String, total_amount Decimal(16,2), create_time Datetime ) engine = ReplicatedMergeTree('/clickhouse/table/01/t_order_rep','rep_102') partition by toYYYYMMDD(create_time) primary key (id) order by (id,sku_id); ReplicatedMergeTree(â€˜/clickhouse/table/01/t_order_repâ€™,â€˜rep_102â€™)ä¸­ï¼Œ ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åˆ†ç‰‡çš„ zk_path ï¼Œ ä¸€èˆ¬æŒ‰ç…§ï¼š/clickhouse/table/{shard}/{table_name} çš„æ ¼å¼å†™ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªåˆ†ç‰‡å°±å†™ 01 å³å¯ã€‚ ç¬¬äºŒä¸ªå‚æ•°æ˜¯å‰¯æœ¬åç§°ï¼Œç›¸åŒçš„åˆ†ç‰‡å‰¯æœ¬åç§°ä¸èƒ½ç›¸åŒã€‚ åœ¨ hadoop102 ä¸Šæ‰§è¡Œ insert è¯­å¥ insert into t_order_rep2 values (101,'sku_001',1000.00,'2020-06-01 12:00:00'), (102,'sku_002',2000.00,'2020-06-01 12:00:00'), (103,'sku_004',2500.00,'2020-06-01 12:00:00'), (104,'sku_002',2000.00,'2020-06-01 12:00:00'), (105,'sku_003',600.00,'2020-06-02 12:00:00'); åœ¨ hadoop103 ä¸Šæ‰§è¡Œ selectï¼Œå¯ä»¥æŸ¥è¯¢å‡ºç»“æœï¼Œè¯´æ˜å‰¯æœ¬é…ç½®æ­£ç¡® ","link":"https://tianxiawuhao.github.io/bps7a3f5p/"},{"title":"ClickHouse-6sqlæ“ä½œ","content":"1 Insert åŸºæœ¬ä¸æ ‡å‡† SQLï¼ˆMySQLï¼‰åŸºæœ¬ä¸€è‡´ æ ‡å‡† insert into [table_name] values(â€¦),(â€¦.) ä»è¡¨åˆ°è¡¨çš„æ’å…¥ insert into [table_name] select a,b,c from [table_name_2] 2 Update å’Œ Delete ClickHouse æä¾›äº† Delete å’Œ Update çš„èƒ½åŠ›ï¼Œè¿™ç±»æ“ä½œè¢«ç§°ä¸º Mutation æŸ¥è¯¢ï¼Œå®ƒå¯ä»¥çœ‹åš Alter çš„ä¸€ç§ã€‚ è™½ç„¶å¯ä»¥å®ç°ä¿®æ”¹å’Œåˆ é™¤ï¼Œä½†æ˜¯å’Œä¸€èˆ¬çš„ OLTP æ•°æ®åº“ä¸ä¸€æ ·ï¼ŒMutation è¯­å¥æ˜¯ä¸€ç§å¾ˆâ€œé‡â€çš„æ“ä½œï¼Œè€Œä¸”ä¸æ”¯æŒäº‹åŠ¡ã€‚ â€œé‡â€çš„åŸå› ä¸»è¦æ˜¯æ¯æ¬¡ä¿®æ”¹æˆ–è€…åˆ é™¤éƒ½ä¼šå¯¼è‡´æ”¾å¼ƒç›®æ ‡æ•°æ®çš„åŸæœ‰åˆ†åŒºï¼Œé‡å»ºæ–°åˆ†åŒºã€‚æ‰€ä»¥å°½é‡åšæ‰¹é‡çš„å˜æ›´ï¼Œä¸è¦è¿›è¡Œé¢‘ç¹å°æ•°æ®çš„æ“ä½œã€‚ åˆ é™¤æ“ä½œ alter table t_order_smt delete where sku_id ='sku_001'; ä¿®æ”¹æ“ä½œ alter table t_order_smt update total_amount=toDecimal32(2000.00,2) where id =102; ç”±äºæ“ä½œæ¯”è¾ƒâ€œé‡â€ï¼Œæ‰€ä»¥ Mutation è¯­å¥åˆ†ä¸¤æ­¥æ‰§è¡Œï¼ŒåŒæ­¥æ‰§è¡Œçš„éƒ¨åˆ†å…¶å®åªæ˜¯è¿›è¡Œæ–°å¢æ•°æ®æ–°å¢åˆ†åŒºå’Œå¹¶æŠŠæ—§åˆ†åŒºæ‰“ä¸Šé€»è¾‘ä¸Šçš„å¤±æ•ˆæ ‡è®°ã€‚ç›´åˆ°è§¦å‘åˆ†åŒºåˆå¹¶çš„æ—¶å€™ï¼Œæ‰ä¼šåˆ é™¤æ—§æ•°æ®é‡Šæ”¾ç£ç›˜ç©ºé—´ï¼Œä¸€èˆ¬ä¸ä¼šå¼€æ”¾è¿™æ ·çš„åŠŸèƒ½ç»™ç”¨æˆ·ï¼Œç”±ç®¡ç†å‘˜å®Œæˆã€‚ 3 æŸ¥è¯¢æ“ä½œ ClickHouse åŸºæœ¬ä¸Šä¸æ ‡å‡† SQL å·®åˆ«ä¸å¤§ æ”¯æŒå­æŸ¥è¯¢ æ”¯æŒ CTE(Common Table Expression å…¬ç”¨è¡¨è¡¨è¾¾å¼ with å­å¥) æ”¯æŒå„ç§ JOINï¼Œä½†æ˜¯ JOIN æ“ä½œæ— æ³•ä½¿ç”¨ç¼“å­˜, å°½é‡é¿å…ä½¿ç”¨ JOINï¼Œæ‰€ä»¥å³ä½¿æ˜¯ä¸¤æ¬¡ç›¸åŒçš„ JOIN è¯­å¥ï¼ŒClickHouse ä¹Ÿä¼šè§†ä¸ºä¸¤æ¡æ–° SQL çª—å£å‡½æ•° ä¸æ”¯æŒè‡ªå®šä¹‰å‡½æ•° GROUP BY æ“ä½œå¢åŠ äº† with rollup \\ with cube \\ with total ç”¨æ¥è®¡ç®—å°è®¡å’Œæ€»è®¡ã€‚ æ’å…¥æ•°æ® alter table t_order_mt delete where 1=1; insert into t_order_mt values (101,'sku_001',1000.00,'2020-06-01 12:00:00'), (101,'sku_002',2000.00,'2020-06-01 12:00:00'), (103,'sku_004',2500.00,'2020-06-01 12:00:00'), (104,'sku_002',2000.00,'2020-06-01 12:00:00'), (105,'sku_003',600.00,'2020-06-02 12:00:00'), (106,'sku_001',1000.00,'2020-06-04 12:00:00'), (107,'sku_002',2000.00,'2020-06-04 12:00:00'), (108,'sku_004',2500.00,'2020-06-04 12:00:00'), (109,'sku_002',2000.00,'2020-06-04 12:00:00'), (110,'sku_003',600.00,'2020-06-01 12:00:00'); with rollupï¼šä¸Šå·ï¼Œä»å³è‡³å·¦å»æ‰ç»´åº¦è¿›è¡Œå°è®¡ select id , sku_id,sum(total_amount) from t_order_mt group by id,sku_id with rollup; with cube : å¤šç»´åˆ†æï¼Œ ä»å³è‡³å·¦å»æ‰ç»´åº¦è¿›è¡Œå°è®¡ï¼Œå†ä»å·¦è‡³å³å»æ‰ç»´åº¦è¿›è¡Œå°è®¡ select id , sku_id,sum(total_amount) from t_order_mt group by id,sku_id with cube; with totals: åªè®¡ç®—åˆè®¡ select id , sku_id,sum(total_amount) from t_order_mt group by id,sku_id with totals; 4 alter æ“ä½œ åŒ MySQL çš„ä¿®æ”¹å­—æ®µåŸºæœ¬ä¸€è‡´ æ–°å¢å­—æ®µ alter table tableName add column newcolname String after col1; ä¿®æ”¹å­—æ®µç±»å‹ alter table tableName modify column newcolname String; åˆ é™¤å­—æ®µ alter table tableName drop column newcolname; 5 å¯¼å‡ºæ•°æ® è¿™ä¸ªç”¨çš„æ¯”è¾ƒå°‘ clickhouse-client --query &quot;select * from t_order_mt where create_time='2020-06-01 12:00:00'&quot; --format CSVWithNames&gt; /opt/module/data/rs1.csv æ›´å¤šæ”¯æŒæ ¼å¼å‚ç…§ï¼šhttps://clickhouse.com/docs/en/interfaces/formats/ ","link":"https://tianxiawuhao.github.io/3wkSNwWQy/"},{"title":"Clickhouse-5æ•°æ®åˆ†åŒº","content":"MergeTree æ•°æ®åˆ†åŒºè§„åˆ™ åˆ›å»ºæŒ‰ç…§æœˆä»½ä¸ºåˆ†åŒºæ¡ä»¶çš„è¡¨ tab_partition CREATE TABLE tab_partition(`dt` Date, `v` UInt8) ENGINE = MergeTree PARTITION BY toYYYYMM(dt) ORDER BY v; insert into tab_partition(dt,v) values ('2020-02-11',1),('2020-02-13',2); insert into tab_partition(dt,v) values ('2020-04-11',3),('2020-04-13',4); insert into tab_partition(dt,v) values ('2020-09-11',5),('2020-09-10',6); insert into tab_partition(dt,v) values ('2020-10-12',7),('2020-10-09',8); insert into tab_partition(dt,v) values ('2020-02-14',9),('2020-02-15',10); insert into tab_partition(dt,v) values ('2020-02-11',23),('2020-02-13',45); MergeTree å­˜å‚¨å¼•æ“åœ¨å†™å…¥æ•°æ®ä¹‹åç”Ÿæˆå¯¹åº”çš„åˆ†åŒºæ–‡ä»¶ä¸ºï¼š MergeTree çš„åˆ†åŒºç›®å½•æ˜¯åœ¨å†™å…¥æ•°æ®çš„è¿‡ç¨‹ä¸­è¢«åˆ›å»ºå‡ºæ¥ï¼Œæ¯ insert ä¸€æ¬¡ï¼Œå°±ä¼šåˆ›å»ºä¸€æ‰¹æ¬¡åˆ†åŒºç›®å½•ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœä»…åˆ›å»ºè¡¨ç»“æ„ï¼Œæ˜¯ä¸ä¼šåˆ›å»ºåˆ†åŒºç›®å½•çš„ï¼Œå› ä¸ºæœ¨æœ‰æ•°æ®ã€‚ MergeTree æ•°æ®åˆ†åŒºç›®å½•å‘½åè§„åˆ™å…¶è§„åˆ™ä¸ºï¼šPartitionID_MinBlockNum_MaxBlockNum_Level æ¯”å¦‚ 202002_4_4_0 å…¶ä¸­ 202002 æ˜¯åˆ†åŒºID ï¼Œ4_4 å¯¹åº”çš„æ˜¯ æœ€å°çš„æ•°æ®å—ç¼–å·å’Œæœ€å¤§çš„æ•°æ®å—ç¼–å·ï¼Œæœ€åçš„ _0 è¡¨ç¤ºç›®å‰åˆ†åŒºåˆå¹¶çš„å±‚çº§ã€‚ å„éƒ¨åˆ†çš„å«ä¹‰åŠå‘½åè§„åˆ™å¦‚ä¸‹ï¼š PartitionIDï¼šè¯¥å€¼ç”± insert æ•°æ®æ—¶åˆ†åŒºé”®çš„å€¼æ¥å†³å®šã€‚åˆ†åŒºé”®æ”¯æŒä½¿ç”¨ä»»ä½•ä¸€ä¸ªæˆ–è€…å¤šä¸ªå­—æ®µç»„åˆè¡¨è¾¾å¼ï¼Œé’ˆå¯¹å–å€¼æ•°æ®ç±»å‹çš„ä¸åŒï¼Œåˆ†åŒº ID çš„ç”Ÿæˆé€»è¾‘ç›®å‰æœ‰å››ç§è§„åˆ™ï¼š ä¸æŒ‡å®šåˆ†åŒºé”®ï¼šå¦‚æœå»ºè¡¨æ—¶æœªæŒ‡å®šåˆ†åŒºé”®ï¼Œåˆ™åˆ†åŒº ID é»˜è®¤ä½¿ç”¨ allï¼Œæ‰€æœ‰æ•°æ®éƒ½è¢«å†™å…¥ all åˆ†åŒºä¸­ã€‚ æ•´å‹å­—æ®µï¼šå¦‚æœåˆ†åŒºé”®å–å€¼æ˜¯æ•´å‹å­—æ®µï¼Œå¹¶ä¸”æ— æ³•è½¬æ¢ä¸º YYYYMMDD çš„æ ¼å¼ï¼Œåˆ™ä¼šæŒ‰ç…§è¯¥æ•´å‹å­—æ®µçš„å­—ç¬¦å½¢å¼è¾“å‡ºï¼Œä½œä¸ºåˆ†åŒº ID å–å€¼ã€‚ æ—¥æœŸç±»å‹ï¼šå¦‚æœåˆ†åŒºé”®å±äºæ—¥æœŸæ ¼å¼ï¼Œæˆ–å¯ä»¥è½¬æ¢ä¸º YYYYMMDD æ ¼å¼çš„æ•´å‹ï¼Œåˆ™æŒ‰ç…§ YYYYMMDD æ ¼å¼åŒ–åçš„å­—ç¬¦å½¢å¼è¾“å‡ºï¼Œä½œä¸ºåˆ†åŒº ID å–å€¼ã€‚ å…¶ä»–ç±»å‹ï¼šå¦‚æœä½¿ç”¨å…¶ä»–ç±»ä¼¼ Floatã€String ç­‰ç±»å‹ä½œä¸ºåˆ†åŒºé”®ï¼Œä¼šé€šè¿‡å¯¹å…¶æ’å…¥æ•°æ®çš„ 128 ä½ Hash å€¼ä½œä¸ºåˆ†åŒº ID çš„å–å€¼ã€‚ MinBlockNum å’Œ MaxBlockNumï¼šBlockNum æ˜¯ä¸€ä¸ªæ•´å‹çš„è‡ªå¢é•¿å‹ç¼–å·ï¼Œè¯¥ç¼–å·åœ¨å•å¼  MergeTree è¡¨ä¸­ä» 1 å¼€å§‹å…¨å±€ç´¯åŠ ï¼Œå½“æœ‰æ–°çš„åˆ†åŒºç›®å½•åˆ›å»ºåï¼Œè¯¥å€¼å°±åŠ  1ï¼Œå¯¹æ–°çš„åˆ†åŒºç›®å½•æ¥è®²ï¼ŒMinBlockNum å’Œ MaxBlockNum å–å€¼ç›¸åŒã€‚ä¾‹å¦‚ä¸Šé¢ç¤ºä¾‹æ•°æ®ä¸º 202002_1_1_0 202002_1_5_1ï¼Œä½†å½“åˆ†åŒºç›®å½•è¿›è¡Œåˆå¹¶åï¼Œå–å€¼è§„åˆ™ä¼šå‘ç”Ÿå˜åŒ–ï¼ŒMinBlockNum å–åŒä¸€åˆ†åŒºæ‰€æ¬²ç›®å½•ä¸­æœ€æ–°çš„ MinBlockNum å€¼ã€‚MaxBlockNum å–åŒä¸€åˆ†åŒºå†…æ‰€æœ‰ç›®å½•ä¸­çš„æœ€å¤§å€¼ã€‚ Levelï¼šè¡¨ç¤ºåˆå¹¶çš„å±‚çº§ã€‚ç›¸å½“äºæŸä¸ªåˆ†åŒºè¢«åˆå¹¶çš„æ¬¡æ•°ï¼Œå®ƒä¸æ˜¯ä»¥è¡¨å…¨å±€ç´¯åŠ ï¼Œè€Œæ˜¯ä»¥åˆ†åŒºä¸ºå•ä½ï¼Œåˆå§‹åˆ›å»ºçš„åˆ†åŒºï¼Œåˆå§‹å€¼ä¸º 0ï¼Œç›¸åŒåˆ†åŒº ID å‘ç”Ÿåˆå¹¶åŠ¨ä½œæ—¶ï¼Œåœ¨ç›¸åº”åˆ†åŒºå†…ç´¯è®¡åŠ  1ã€‚ MergeTree æ•°æ®åˆ†åŒºåˆå¹¶è§„åˆ™ éšç€æ•°æ®çš„å†™å…¥ MergeTree å­˜å‚¨å¼•æ“ä¼šå¾ˆå¤šåˆ†åŒºç›®å½•ã€‚å¦‚æœåˆ†åŒºç›®å½•æ•°å¤ªå¤šæ€ä¹ˆåŠï¼Ÿå› ä¸º Clickhouse çš„ MergeTree å­˜å‚¨å¼•æ“æ˜¯åŸºäº LSM å®ç°çš„ã€‚MergeTree å¯ä»¥é€šè¿‡åˆ†åŒºåˆå¹¶å°†å±äºç›¸åŒåˆ†åŒºçš„å¤šä¸ªç›®å½•åˆå¹¶ä¸ºä¸€ä¸ªæ–°çš„ç›®å½•ï¼ˆå®˜æ–¹æè¿°åœ¨ 10 åˆ° 15 åˆ†é’Ÿå†…ä¼šè¿›è¡Œåˆå¹¶ï¼Œä¹Ÿå¯ç›´æ¥æ‰§è¡Œ optimize è¯­å¥ï¼‰ï¼Œå·²ç»å­˜åœ¨çš„æ—§ç›®å½•ï¼ˆä¹Ÿå³ system.parts è¡¨ä¸­ activie ä¸º 0 çš„åˆ†åŒºï¼‰åœ¨ä¹‹åæŸä¸ªæ—¶åˆ»é€šè¿‡åå°ä»»åŠ¡åˆ é™¤ï¼ˆé»˜è®¤ 8 åˆ†é’Ÿï¼‰ã€‚ åˆ†åŒºåˆå¹¶ æˆ‘ä»¬å›é¡¾ä¹‹å‰åˆ›å»ºçš„è¡¨çš„åˆ†åŒºç›®å½• # ls 202002_1_1_0 202004_2_2_0 202009_3_3_0 202002_4_4_0 202002_5_5_0 æ‰‹å·¥è§¦å‘åˆ†åŒºåˆå¹¶ qabb-qa-ch00 :) optimize table tab_partition; OPTIMIZE TABLE tab_partition Ok. 0 rows in set. Elapsed: 0.003 sec. qabb-qa-ch00 :) select partition,name,part_type, active from system.parts where table ='tab_partition'; â”Œâ”€partitionâ”€â”¬â”€nameâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€part_typeâ”€â”¬â”€activeâ”€â” â”‚ 202002 â”‚ 202002_1_1_0 â”‚ Wide â”‚ 0 â”‚ â”‚ 202002 â”‚ 202002_1_5_1 â”‚ Wide â”‚ 1 â”‚ â”‚ 202002 â”‚ 202002_4_4_0 â”‚ Wide â”‚ 0 â”‚ â”‚ 202002 â”‚ 202002_5_5_0 â”‚ Wide â”‚ 0 â”‚ â”‚ 202004 â”‚ 202004_2_2_0 â”‚ Wide â”‚ 1 â”‚ â”‚ 202009 â”‚ 202009_3_3_0 â”‚ Wide â”‚ 1 â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 6 rows in set. Elapsed: 0.003 sec. å…¶ä¸­ active ä¸º 1 è¡¨ç¤ºç»è¿‡åˆå¹¶ä¹‹åçš„æœ€æ–°åˆ†åŒºï¼Œä¸º 0 åˆ™è¡¨ç¤ºæ—§åˆ†åŒºï¼ŒæŸ¥è¯¢æ—¶ä¼šè‡ªåŠ¨è¿‡æ»¤ active=0 çš„åˆ†åŒºã€‚ æˆ‘ä»¬é€šè¿‡åˆ†åŒº 202002 æœ€æ–°çš„åˆ†åŒºç›®å½• 202002_1_5_1 çœ‹åˆ°åˆå¹¶åˆ†åŒºæ–°ç›®å½•çš„å‘½åè§„åˆ™å¦‚ä¸‹ï¼š PartitionIDï¼šåˆ†åŒº ID ä¿æŒä¸å˜ MinBlockNumï¼šå–åŒä¸€ä¸ªåˆ†åŒºå†…æ‰€æœ‰ç›®å½•ä¸­æœ€å°çš„ MinBlockNum å€¼ MaxBlockNUmï¼šå–åŒä¸€ä¸ªåˆ†åŒºå†…æ‰€æœ‰ç›®å½•ä¸­æœ€å¤§çš„ MaxBlockNum å€¼ Levelï¼šå–åŒä¸€ä¸ªåˆ†åŒºå†…æœ€å¤§ Level å€¼å¹¶åŠ  1 åˆå¹¶ä¹‹åçš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š ","link":"https://tianxiawuhao.github.io/hle1ZXFqv/"},{"title":"ClickHouse-4è¡¨å¼•æ“","content":"1 è¡¨å¼•æ“çš„ä½¿ç”¨ è¡¨å¼•æ“æ˜¯ ClickHouse çš„ä¸€å¤§ç‰¹è‰²ã€‚å¯ä»¥è¯´ï¼Œè¡¨å¼•æ“å†³å®šäº†å¦‚ä½•å­˜å‚¨è¡¨çš„æ•°æ®ã€‚åŒ…æ‹¬ï¼š æ•°æ®çš„å­˜å‚¨æ–¹å¼å’Œä½ç½®ï¼Œå†™åˆ°å“ªé‡Œä»¥åŠä»å“ªé‡Œè¯»å–æ•°æ®ã€‚(é»˜è®¤æ˜¯åœ¨å®‰è£…è·¯å¾„ä¸‹çš„ data è·¯å¾„) æ”¯æŒå“ªäº›æŸ¥è¯¢ä»¥åŠå¦‚ä½•æ”¯æŒã€‚ï¼ˆæœ‰äº›è¯­æ³•åªæœ‰åœ¨ç‰¹å®šçš„å¼•æ“ä¸‹æ‰èƒ½ç”¨ï¼‰ å¹¶å‘æ•°æ®è®¿é—®ã€‚ ç´¢å¼•çš„ä½¿ç”¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚ æ˜¯å¦å¯ä»¥æ‰§è¡Œå¤šçº¿ç¨‹è¯·æ±‚ã€‚ æ•°æ®å¤åˆ¶å‚æ•°ã€‚ è¡¨å¼•æ“çš„ä½¿ç”¨æ–¹å¼å°±æ˜¯å¿…é¡»æ˜¾å¼åœ¨åˆ›å»ºè¡¨æ—¶å®šä¹‰è¯¥è¡¨ä½¿ç”¨çš„å¼•æ“ï¼Œä»¥åŠå¼•æ“ä½¿ç”¨çš„ç›¸å…³å‚æ•°ã€‚ ç‰¹åˆ«æ³¨æ„ï¼šå¼•æ“çš„åç§°å¤§å°å†™æ•æ„Ÿ, é©¼å³°å‘½å 2 TinyLog ä»¥åˆ—æ–‡ä»¶çš„å½¢å¼ä¿å­˜åœ¨ç£ç›˜ä¸Šï¼Œä¸æ”¯æŒç´¢å¼•ï¼Œæ²¡æœ‰å¹¶å‘æ§åˆ¶ã€‚ä¸€èˆ¬ä¿å­˜å°‘é‡æ•°æ®çš„å°è¡¨ï¼Œç”Ÿäº§ç¯å¢ƒä¸Šä½œç”¨æœ‰é™ã€‚å¯ä»¥ç”¨äºå¹³æ—¶ç»ƒä¹ æµ‹è¯•ç”¨ã€‚ å¦‚ï¼š create table t_tinylog ( id String, name String) engine=TinyLog; 3 Memory å†…å­˜å¼•æ“ï¼Œæ•°æ®ä»¥æœªå‹ç¼©çš„åŸå§‹å½¢å¼ç›´æ¥ä¿å­˜åœ¨å†…å­˜å½“ä¸­ï¼ŒæœåŠ¡å™¨é‡å¯æ•°æ®å°±ä¼šæ¶ˆå¤±ã€‚è¯»å†™æ“ä½œä¸ä¼šç›¸äº’é˜»å¡ï¼Œä¸æ”¯æŒç´¢å¼•ã€‚ç®€å•æŸ¥è¯¢ä¸‹æœ‰éå¸¸éå¸¸é«˜çš„æ€§èƒ½è¡¨ç°ï¼ˆè¶…è¿‡ 10G/sï¼‰ã€‚ ä¸€èˆ¬ç”¨åˆ°å®ƒçš„åœ°æ–¹ä¸å¤šï¼Œé™¤äº†ç”¨æ¥æµ‹è¯•ï¼Œå°±æ˜¯åœ¨éœ€è¦éå¸¸é«˜çš„æ€§èƒ½ï¼ŒåŒæ—¶æ•°æ®é‡åˆä¸å¤ªå¤§ï¼ˆä¸Šé™å¤§æ¦‚ 1 äº¿è¡Œï¼‰çš„åœºæ™¯ã€‚ 4 MergeTree ClickHouse ä¸­æœ€å¼ºå¤§çš„è¡¨å¼•æ“å½“å± MergeTreeï¼ˆåˆå¹¶æ ‘ï¼‰å¼•æ“åŠè¯¥ç³»åˆ—ï¼ˆ*MergeTreeï¼‰ä¸­çš„å…¶ä»–å¼•æ“ï¼Œæ”¯æŒç´¢å¼•å’Œåˆ†åŒºï¼Œåœ°ä½å¯ä»¥ç›¸å½“äº innodb ä¹‹äº Mysqlã€‚è€Œä¸”åŸºäº MergeTreeï¼Œè¿˜è¡ç”Ÿé™¤äº†å¾ˆå¤šå°å¼Ÿï¼Œä¹Ÿæ˜¯éå¸¸æœ‰ç‰¹è‰²çš„å¼•æ“ã€‚ å»ºè¡¨è¯­å¥ create table t_order_mt( id UInt32, sku_id String, total_amount Decimal(16,2), create_time Datetime ) engine =MergeTree partition by toYYYYMMDD(create_time) primary key (id) order by (id,sku_id); æ’å…¥æ•°æ® insert into t_order_mt values (101,'sku_001',1000.00,'2020-06-01 12:00:00') , (102,'sku_002',2000.00,'2020-06-01 11:00:00'), (102,'sku_004',2500.00,'2020-06-01 12:00:00'), (102,'sku_002',2000.00,'2020-06-01 13:00:00'), (102,'sku_002',12000.00,'2020-06-01 13:00:00'), (102,'sku_002',600.00,'2020-06-02 12:00:00'); MergeTree å…¶å®è¿˜æœ‰å¾ˆå¤šå‚æ•°(ç»å¤§å¤šæ•°ç”¨é»˜è®¤å€¼å³å¯)ï¼Œä½†æ˜¯ä¸‰ä¸ªå‚æ•°æ˜¯æ›´åŠ é‡è¦çš„ï¼Œä¹Ÿæ¶‰åŠäº†å…³äº MergeTree çš„å¾ˆå¤šæ¦‚å¿µã€‚ 4.1 partition by åˆ†åŒº(å¯é€‰) ä½œç”¨ å­¦è¿‡ hive çš„åº”è¯¥éƒ½ä¸é™Œç”Ÿï¼Œåˆ†åŒºçš„ç›®çš„ä¸»è¦æ˜¯é™ä½æ‰«æçš„èŒƒå›´ï¼Œä¼˜åŒ–æŸ¥è¯¢é€Ÿåº¦ï¼Œå¦‚æœä¸å¡«,åªä¼šä½¿ç”¨ä¸€ä¸ªåˆ†åŒº â€”â€” allã€‚ åˆ†åŒºç›®å½• MergeTree æ˜¯ä»¥åˆ—æ–‡ä»¶+ç´¢å¼•æ–‡ä»¶+è¡¨å®šä¹‰æ–‡ä»¶ç»„æˆçš„ï¼Œä½†æ˜¯å¦‚æœè®¾å®šäº†åˆ†åŒºé‚£ä¹ˆè¿™äº›æ–‡ä»¶å°±ä¼šä¿å­˜åˆ°ä¸åŒçš„åˆ†åŒºç›®å½•ä¸­ã€‚ç›®å½•ä¿å­˜åœ¨æœ¬åœ°ç£ç›˜ å¹¶è¡Œ åˆ†åŒºåï¼Œé¢å¯¹æ¶‰åŠè·¨åˆ†åŒºçš„æŸ¥è¯¢ç»Ÿè®¡ï¼ŒClickHouse ä¼šä»¥åˆ†åŒºä¸ºå•ä½å¹¶è¡Œå¤„ç†ï¼Œ å³ä¸€ä¸ªçº¿ç¨‹å¤„ç†ä¸€ä¸ªåˆ†åŒºå†…çš„æ•°æ®ã€‚ æ•°æ®å†™å…¥ä¸åˆ†åŒºåˆå¹¶ ä»»ä½•ä¸€ä¸ªæ‰¹æ¬¡çš„æ•°æ®å†™å…¥éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªä¸´æ—¶åˆ†åŒºï¼Œä¸ä¼šçº³å…¥ä»»ä½•ä¸€ä¸ªå·²æœ‰çš„åˆ†åŒºã€‚å†™å…¥åçš„æŸä¸ªæ—¶åˆ»ï¼ˆå¤§æ¦‚ 10-15 åˆ†é’Ÿåï¼‰ï¼ŒClickHouse ä¼šè‡ªåŠ¨æ‰§è¡Œåˆå¹¶æ“ä½œï¼ˆç­‰ä¸åŠä¹Ÿå¯ä»¥æ‰‹åŠ¨é€šè¿‡ optimize æ‰§è¡Œï¼‰ï¼ŒæŠŠä¸´æ—¶åˆ†åŒºçš„æ•°æ®ï¼Œåˆå¹¶åˆ°å·²æœ‰åˆ†åŒºä¸­ã€‚ optimize table xxxx final; ä¾‹å¦‚ å†æ¬¡æ‰§è¡Œä¸Šé¢çš„æ’å…¥æ“ä½œ insert into t_order_mt values (101,'sku_001',1000.00,'2020-06-01 12:00:00') , (102,'sku_002',2000.00,'2020-06-01 11:00:00'), (102,'sku_004',2500.00,'2020-06-01 12:00:00'), (102,'sku_002',2000.00,'2020-06-01 13:00:00'), (102,'sku_002',12000.00,'2020-06-01 13:00:00'), (102,'sku_002',600.00,'2020-06-02 12:00:00'); æŸ¥çœ‹æ•°æ®å¹¶æ²¡æœ‰çº³å…¥ä»»ä½•åˆ†åŒº æ‰‹åŠ¨ optimize ä¹‹å optimize table t_order_mt final; 4.2 primary key ä¸»é”®(å¯é€‰) ClickHouse ä¸­çš„ä¸»é”®ï¼Œå’Œå…¶ä»–æ•°æ®åº“ä¸å¤ªä¸€æ ·ï¼Œå®ƒåªæä¾›äº†æ•°æ®çš„ä¸€çº§ç´¢å¼•ï¼Œä½†æ˜¯å´ä¸æ˜¯å”¯ä¸€çº¦æŸã€‚è¿™å°±æ„å‘³ç€æ˜¯å¯ä»¥å­˜åœ¨ç›¸åŒ primary key çš„æ•°æ®çš„ã€‚ ä¸»é”®çš„è®¾å®šä¸»è¦ä¾æ®æ˜¯æŸ¥è¯¢è¯­å¥ä¸­çš„ where æ¡ä»¶ã€‚ æ ¹æ®æ¡ä»¶é€šè¿‡å¯¹ä¸»é”®è¿›è¡ŒæŸç§å½¢å¼çš„äºŒåˆ†æŸ¥æ‰¾ï¼Œèƒ½å¤Ÿå®šä½åˆ°å¯¹åº”çš„ index granularity,é¿å…äº†å…¨è¡¨æ‰«æã€‚ index granularityï¼š ç›´æ¥ç¿»è¯‘çš„è¯å°±æ˜¯ç´¢å¼•ç²’åº¦ï¼ŒæŒ‡åœ¨ç¨€ç–ç´¢å¼•ä¸­ä¸¤ä¸ªç›¸é‚»ç´¢å¼•å¯¹åº”æ•°æ®çš„é—´éš”ã€‚ClickHouse ä¸­çš„ MergeTree é»˜è®¤æ˜¯ 8192ã€‚å®˜æ–¹ä¸å»ºè®®ä¿®æ”¹è¿™ä¸ªå€¼ï¼Œé™¤éè¯¥åˆ—å­˜åœ¨å¤§é‡é‡å¤å€¼ï¼Œæ¯”å¦‚åœ¨ä¸€ä¸ªåˆ†åŒºä¸­å‡ ä¸‡è¡Œæ‰æœ‰ä¸€ä¸ªä¸åŒæ•°æ®ã€‚ ç¨€ç–ç´¢å¼•ï¼š ç¨€ç–ç´¢å¼•çš„å¥½å¤„å°±æ˜¯å¯ä»¥ç”¨å¾ˆå°‘çš„ç´¢å¼•æ•°æ®ï¼Œå®šä½æ›´å¤šçš„æ•°æ®ï¼Œä»£ä»·å°±æ˜¯åªèƒ½å®šä½åˆ°ç´¢å¼•ç²’åº¦çš„ç¬¬ä¸€è¡Œï¼Œç„¶åå†è¿›è¡Œè¿›è¡Œä¸€ç‚¹æ‰«æã€‚ 4.3 order byï¼ˆå¿…é€‰ï¼‰ order by è®¾å®šäº†åˆ†åŒºå†…çš„æ•°æ®æŒ‰ç…§å“ªäº›å­—æ®µé¡ºåºè¿›è¡Œæœ‰åºä¿å­˜ã€‚ order by æ˜¯ MergeTree ä¸­å”¯ä¸€ä¸€ä¸ªå¿…å¡«é¡¹ï¼Œç”šè‡³æ¯” primary key è¿˜é‡è¦ï¼Œå› ä¸ºå½“ç”¨æˆ·ä¸è®¾ç½®ä¸»é”®çš„æƒ…å†µï¼Œå¾ˆå¤šå¤„ç†ä¼šä¾ç…§ order by çš„å­—æ®µè¿›è¡Œå¤„ç†ï¼ˆæ¯”å¦‚åé¢ä¼šè®²çš„å»é‡å’Œæ±‡æ€»ï¼‰ã€‚ è¦æ±‚ï¼šä¸»é”®å¿…é¡»æ˜¯ order by å­—æ®µçš„å‰ç¼€å­—æ®µã€‚æœ‰ç‚¹ç±»ä¼¼ SQL ç´¢å¼•ä¸­çš„æœ€å·¦å‰ç¼€ã€‚ æ¯”å¦‚ order by å­—æ®µæ˜¯ (id,sku_id) é‚£ä¹ˆä¸»é”®å¿…é¡»æ˜¯ id æˆ–è€…(id,sku_id) 4.4 äºŒçº§ç´¢å¼•(è·³æ•°ç´¢å¼•) ç›®å‰åœ¨ ClickHouse çš„å®˜ç½‘ä¸ŠäºŒçº§ç´¢å¼•çš„åŠŸèƒ½åœ¨ v20.1.2.4 ä¹‹å‰æ˜¯è¢«æ ‡æ³¨ä¸ºå®éªŒæ€§çš„ï¼Œåœ¨è¿™ä¸ªç‰ˆæœ¬ä¹‹åé»˜è®¤æ˜¯å¼€å¯çš„ã€‚ è€ç‰ˆæœ¬ä½¿ç”¨äºŒçº§ç´¢å¼•å‰éœ€è¦å¢åŠ è®¾ç½® æ˜¯å¦å…è®¸ä½¿ç”¨å®éªŒæ€§çš„äºŒçº§ç´¢å¼•ï¼ˆv20.1.2.4 å¼€å§‹ï¼Œè¿™ä¸ªå‚æ•°å·²è¢«åˆ é™¤ï¼Œé»˜è®¤å¼€å¯ï¼‰ set allow_experimental_data_skipping_indices=1; åˆ›å»ºæµ‹è¯•è¡¨ create table t_order_mt2( id UInt32, sku_id String, total_amount Decimal(16,2), create_time Datetime, INDEX a total_amount TYPE minmax GRANULARITY 5 ) engine =MergeTree partition by toYYYYMMDD(create_time) primary key (id) order by (id, sku_id); æœ€ä¸»è¦çš„æ˜¯éœ€è¦åŠ ä¸Šè¿™ä¸€å¥ï¼šINDEX a total_amount TYPE minmax GRANULARITY 5 å…¶ä¸­ï¼š INDEX aï¼š å®šä¹‰ä¸€ä¸ªç´¢å¼•ï¼Œå¹¶å‘½åä¸º a total_amountï¼š ç´¢å¼•å­—æ®µåç§° TYPE minmaxï¼š å®šä¹‰ç±»å‹ï¼Œ ä¿å­˜æœ€å¤§æœ€å°å€¼ GRANULARITY Nï¼šæ˜¯è®¾å®šäºŒçº§ç´¢å¼•å¯¹äºä¸€çº§ç´¢å¼•ç²’åº¦çš„ç²’åº¦ã€‚ä¸€çº§ç´¢å¼•ä¼šè®°å½•æ¯ä¸ªåˆ†åŒºçš„æœ€å¤§æœ€å°å€¼ï¼ŒäºŒçº§ç´¢å¼•å°±æ˜¯åœ¨ä¸€çº§ç´¢å¼•çš„åŸºç¡€ä¸Šï¼Œå–æ¯ N ä¸ªåˆ†åŒºåˆåœ¨ä¸€èµ·çš„æœ€å¤§æœ€å°å€¼ã€‚ æ’å…¥æ•°æ® insert into t_order_mt2 values (101,'sku_001',1000.00,'2020-06-01 12:00:00') , (102,'sku_002',2000.00,'2020-06-01 11:00:00'), (102,'sku_004',2500.00,'2020-06-01 12:00:00'), (102,'sku_002',2000.00,'2020-06-01 13:00:00'), (102,'sku_002',12000.00,'2020-06-01 13:00:00'), (102,'sku_002',600.00,'2020-06-02 12:00:00'); å¯¹æ¯”æ•ˆæœ é‚£ä¹ˆåœ¨ä½¿ç”¨ä¸‹é¢è¯­å¥è¿›è¡Œæµ‹è¯•ï¼Œå¯ä»¥çœ‹å‡ºäºŒçº§ç´¢å¼•èƒ½å¤Ÿä¸ºéä¸»é”®å­—æ®µçš„æŸ¥è¯¢å‘æŒ¥ä½œç”¨ã€‚ clickhouse-client --send_logs_level=trace &lt;&lt;&lt; 'select * from t_order_mt2 where total_amount &gt; toDecimal32(900., 2)'; 4.5 æ•°æ® TTLï¼ˆæ•°æ®å­˜æ´»æ—¶é—´ï¼‰ TTL å³ Time To Liveï¼ŒMergeTree æä¾›äº†å¯ä»¥ç®¡ç†æ•°æ®è¡¨æˆ–è€…åˆ—çš„ç”Ÿå‘½å‘¨æœŸçš„åŠŸèƒ½ã€‚è¿‡æœŸçš„æ•°æ®ä¸ä¼šç«‹é©¬å¤„ç†ï¼Œåªæ˜¯ä¼šåšæ ‡è®°ï¼Œç­‰åˆ°åˆå¹¶æ—¶ä¸€èµ·å¤„ç†ã€‚ åˆ—çº§åˆ« TTL ï¼ˆ1ï¼‰åˆ›å»ºæµ‹è¯•è¡¨ create table t_order_mt3( id UInt32, sku_id String, total_amount Decimal(16,2) TTL create_time+interval 10 SECOND, create_time Datetime ) engine =MergeTree partition by toYYYYMMDD(create_time) primary key (id) order by (id, sku_id); åœ¨åˆ—ååŠ ä¸Šï¼š TTL create_time+interval 10 SECOND å…¶ä¸­ï¼š TTLï¼šå®šä¹‰ä¸€ä¸ªè¿‡æœŸæ—¶é—´ create_timeï¼šä½¿ç”¨äº†å½“å‰è¡¨ä¸­çš„ä¸€ä¸ª Datetime ç±»å‹çš„åˆ—ï¼ŒTTL ä¸­å¼•ç”¨çš„å­—æ®µä¸èƒ½æ˜¯ä¸»é”®å­—æ®µï¼Œä¸”ç±»å‹å¿…é¡»æ˜¯ æ—¥æœŸç±»å‹ Â± interval 10 SECONDï¼šéœ€è¦å¢åŠ /å‡å°‘çš„ æ—¶é—´é•¿åº¦ æ—¶é—´å•ä½ æ³¨ï¼šå¦‚æœåœ¨å»ºè¡¨æ—¶æ²¡æœ‰åŠ  TTL é…ç½®ï¼Œéœ€è¦åœ¨å»ºè¡¨ä¹‹ååŠ ï¼Œé‚£ä¹ˆåˆ™éœ€è¦ä½¿ç”¨å¦‚ä¸‹è¯­æ³•ï¼š ALTER TABLE è¡¨å MODIFY COLUMN åˆ—å åˆ—æ•°æ®ç±»å‹ TTL d + INTERVAL 10 SECOND; ï¼ˆ2ï¼‰æ’å…¥æ•°æ®ï¼ˆæ³¨æ„ï¼šæ ¹æ®å®é™…æ—¶é—´æ”¹å˜ï¼‰ insert into t_order_mt3 values (106,'sku_001',1000.00,'2020-06-12 22:52:30'), (107,'sku_002',2000.00,'2020-06-12 22:52:30'), (110,'sku_003',600.00,'2020-06-13 12:00:00'); ï¼ˆ3ï¼‰æ‰‹åŠ¨åˆå¹¶ï¼ŒæŸ¥çœ‹æ•ˆæœ,åˆ°æœŸåï¼ŒæŒ‡å®šçš„å­—æ®µæ•°æ®å½’ 0ï¼›å¦‚æœæ‰§è¡Œåˆå¹¶åè¿˜æ˜¯å¯ä»¥çœ‹åˆ°æ•°æ®ï¼Œå¯èƒ½æ˜¯éœ€è¦è®¾ç½®æ—¶åŒºï¼Œæˆ–è€…éœ€è¦é‡å¯ã€‚ è¡¨çº§ TTL ä¸åˆ—çº§ç›¸åŒï¼Œåœ¨å»ºè¡¨æ—¶ä¸å»ºè¡¨ä¹‹åéƒ½æœ‰å¯¹åº”çš„è¯­æ³•è¿›è¡Œè®¾ç½® ï¼ˆ1ï¼‰åœ¨å»ºè¡¨æ—¶ï¼Œå†™åœ¨ Order By çš„åé¢ CREATE TABLE example_table ( d DateTime, a Int ) ENGINE = MergeTree PARTITION BY toYYYYMM(d) ORDER BY d TTL d + INTERVAL 1 MONTH [DELETE], d + INTERVAL 1 WEEK TO VOLUME 'aaa', d + INTERVAL 2 WEEK TO DISK 'bbb'; è¯¥ç¤ºä¾‹ä¸­çš„ [DELETE]ã€TO VOLUMEâ€¦â€¦åœ¨ä¸‹æ–‡&quot;æ³¨æ„&quot;ä¸­è¯´æ˜ ï¼ˆ2ï¼‰åœ¨å»ºè¡¨ä¹‹åï¼Œä½¿ç”¨ alter alter table t_order_mt3 MODIFY TTL create_time + INTERVAL 10 SECOND; è¡¨çº§çš„ TTL ï¼Œå¦‚æœæ˜¯æŒ‰ç…§è¡¨ä¸­å­—æ®µå€¼åˆ¤æ–­æ˜¯å¦è¿‡æœŸï¼Œé‚£ä¹ˆä¸ä¼šæ•´è¡¨åˆ é™¤ï¼Œåªä¼šæ˜¯æŸä¸€è¡Œæ•°æ®åˆ°æœŸåˆ æŸä¸€è¡Œã€‚ æ³¨æ„ æ¶‰åŠåˆ¤æ–­çš„å­—æ®µå¿…é¡»æ˜¯ Date æˆ–è€… Datetime ç±»å‹ï¼Œæ¨èä½¿ç”¨åˆ†åŒºçš„æ—¥æœŸå­—æ®µã€‚ èƒ½å¤Ÿä½¿ç”¨çš„æ—¶é—´å•ä½ï¼š SECOND MINUTE HOUR DAY WEEK MONTH QUARTER YEAR ä¸Šæ–‡æåˆ°çš„ [DELETE]ã€TO VOLUMEâ€¦â€¦ è¡¨ç¤ºçš„æ˜¯è¿‡æœŸä¹‹åï¼Œéœ€è¦åšçš„æ“ä½œã€‚å¯é€‰çš„é…ç½®å¦‚ä¸‹ DELETE - åˆ é™¤æ•°æ® ï¼ˆé»˜è®¤ï¼Œä¸é…ç½®åˆ™åˆ é™¤ï¼‰; RECOMPRESS codec_name - ä½¿ç”¨codec_nameé‡æ–°å‹ç¼©æ•°æ®éƒ¨åˆ†ï¼› TO DISK â€˜aaaâ€™ - å°†æ•°æ®ç§»åŠ¨åˆ°ç£ç›˜ aaa ä¸Š TO VOLUME â€˜bbbâ€™ - å°†æ•°æ®ç§»åŠ¨åˆ°ç£ç›˜ bbb ä¸Š GROUP BY - èšåˆè¿‡æœŸè¡Œ 5 ReplacingMergeTree ReplacingMergeTree æ˜¯ MergeTree çš„ä¸€ä¸ªå˜ç§ï¼Œå®ƒå­˜å‚¨ç‰¹æ€§å®Œå…¨ç»§æ‰¿ MergeTreeï¼Œåªæ˜¯å¤šäº†ä¸€ä¸ªå»é‡çš„åŠŸèƒ½ã€‚ å°½ç®¡ MergeTree å¯ä»¥è®¾ç½®ä¸»é”®ï¼Œä½†æ˜¯ primary key å…¶å®æ²¡æœ‰å”¯ä¸€çº¦æŸçš„åŠŸèƒ½ã€‚å¦‚æœä½ æƒ³å¤„ç†æ‰é‡å¤çš„æ•°æ®ï¼Œå¯ä»¥å€ŸåŠ©è¿™ä¸ª ReplacingMergeTreeã€‚å»é‡æŒ‰ç…§order byçš„å­—æ®µå»é‡ å»é‡æ—¶æœº æ•°æ®çš„å»é‡åªä¼šåœ¨åˆå¹¶çš„è¿‡ç¨‹ä¸­å‡ºç°ã€‚åˆå¹¶ä¼šåœ¨æœªçŸ¥çš„æ—¶é—´åœ¨åå°è¿›è¡Œï¼Œæ‰€ä»¥ä½ æ— æ³•é¢„å…ˆä½œå‡ºè®¡åˆ’ã€‚æœ‰ä¸€äº›æ•°æ®å¯èƒ½ä»æœªè¢«å¤„ç†ã€‚ å»é‡èŒƒå›´ å¦‚æœè¡¨ç»è¿‡äº†åˆ†åŒºï¼Œå»é‡åªä¼šåœ¨åˆ†åŒºå†…éƒ¨è¿›è¡Œå»é‡ï¼Œä¸èƒ½æ‰§è¡Œè·¨åˆ†åŒºçš„å»é‡ã€‚ æ‰€ä»¥ ReplacingMergeTree èƒ½åŠ›æœ‰é™ï¼Œ ReplacingMergeTree é€‚ç”¨äºåœ¨åå°æ¸…é™¤é‡å¤çš„æ•°æ®ä»¥èŠ‚çœç©ºé—´ï¼Œä½†æ˜¯å®ƒä¸ä¿è¯æ²¡æœ‰é‡å¤çš„æ•°æ®å‡ºç°ã€‚ æ¡ˆä¾‹æ¼”ç¤º ï¼ˆ1ï¼‰åˆ›å»ºè¡¨ create table t_order_rmt( id UInt32, sku_id String, total_amount Decimal(16,2) , create_time Datetime ) engine =ReplacingMergeTree(create_time) partition by toYYYYMMDD(create_time) primary key (id) order by (id, sku_id); ReplacingMergeTree() å¡«å…¥çš„å‚æ•°ä¸ºç‰ˆæœ¬å­—æ®µï¼Œé‡å¤æ•°æ®ä¿ç•™ç‰ˆæœ¬å­—æ®µå€¼æœ€å¤§çš„ã€‚ å¦‚æœä¸å¡«ç‰ˆæœ¬å­—æ®µï¼Œé»˜è®¤æŒ‰ç…§æ’å…¥é¡ºåºä¿ç•™æœ€åä¸€æ¡ã€‚ ï¼ˆ2ï¼‰å‘è¡¨ä¸­æ’å…¥æ•°æ® insert into t_order_rmt values (101,'sku_001',1000.00,'2020-06-01 12:00:00') , (102,'sku_002',2000.00,'2020-06-01 11:00:00'), (102,'sku_004',2500.00,'2020-06-01 12:00:00'), (102,'sku_002',2000.00,'2020-06-01 13:00:00'), (102,'sku_002',12000.00,'2020-06-01 13:00:00'), (102,'sku_002',600.00,'2020-06-02 12:00:00'); ï¼ˆ3ï¼‰æ‰§è¡Œç¬¬ä¸€æ¬¡æŸ¥è¯¢ select * from t_order_rmt; ï¼ˆ4ï¼‰æ‰‹åŠ¨åˆå¹¶ OPTIMIZE TABLE t_order_rmt FINAL; ï¼ˆ5ï¼‰å†æ‰§è¡Œä¸€æ¬¡æŸ¥è¯¢ select * from t_order_rmt; é€šè¿‡æµ‹è¯•å¾—åˆ°ç»“è®º å®é™…ä¸Šæ˜¯ä½¿ç”¨ order by å­—æ®µä½œä¸ºå”¯ä¸€é”® å»é‡ä¸èƒ½è·¨åˆ†åŒº åªæœ‰åŒä¸€æ‰¹æ’å…¥ï¼ˆæ–°ç‰ˆæœ¬ï¼‰æˆ–åˆå¹¶åˆ†åŒºæ—¶æ‰ä¼šè¿›è¡Œå»é‡ è®¤å®šé‡å¤çš„æ•°æ®ä¿ç•™ï¼Œç‰ˆæœ¬å­—æ®µå€¼æœ€å¤§çš„ å¦‚æœç‰ˆæœ¬å­—æ®µç›¸åŒåˆ™æŒ‰æ’å…¥é¡ºåºä¿ç•™æœ€åä¸€ç¬” 6 SummingMergeTree å¯¹äºä¸æŸ¥è¯¢æ˜ç»†ï¼Œåªå…³å¿ƒä»¥ç»´åº¦è¿›è¡Œæ±‡æ€»èšåˆç»“æœçš„åœºæ™¯ã€‚å¦‚æœåªä½¿ç”¨æ™®é€šçš„MergeTreeçš„è¯ï¼Œæ— è®ºæ˜¯å­˜å‚¨ç©ºé—´çš„å¼€é”€ï¼Œè¿˜æ˜¯æŸ¥è¯¢æ—¶ä¸´æ—¶èšåˆçš„å¼€é”€éƒ½æ¯”è¾ƒå¤§ã€‚ ClickHouse ä¸ºäº†è¿™ç§åœºæ™¯ï¼Œæä¾›äº†ä¸€ç§èƒ½å¤Ÿâ€œé¢„èšåˆâ€çš„å¼•æ“ SummingMergeTreeã€‚è¯¥å¼•æ“èšåˆçš„ä¾æ®ä¾ç„¶æ˜¯ order by çš„å­—æ®µï¼Œç›¸å½“äºæŒ‰ç…§ order by çš„å­—æ®µåšäº†ä¸€æ¬¡ Group Byã€‚ æ¡ˆä¾‹æ¼”ç¤º ï¼ˆ1ï¼‰åˆ›å»ºè¡¨ create table t_order_smt( id UInt32, sku_id String, total_amount Decimal(16,2) , create_time Datetime ) engine =SummingMergeTree(total_amount) partition by toYYYYMMDD(create_time) primary key (id) order by (id,sku_id ); ï¼ˆ2ï¼‰æ’å…¥æ•°æ® insert into t_order_smt values (101,'sku_001',1000.00,'2020-06-01 12:00:00'), (102,'sku_002',2000.00,'2020-06-01 11:00:00'), (102,'sku_004',2500.00,'2020-06-01 12:00:00'), (102,'sku_002',2000.00,'2020-06-01 13:00:00'), (102,'sku_002',12000.00,'2020-06-01 13:00:00'), (102,'sku_002',600.00,'2020-06-02 12:00:00'); ï¼ˆ3ï¼‰æ‰§è¡Œç¬¬ä¸€æ¬¡æŸ¥è¯¢ select * from t_order_smt; ï¼ˆ4ï¼‰æ‰‹åŠ¨åˆå¹¶ OPTIMIZE TABLE t_order_smt FINAL; ï¼ˆ5ï¼‰å†æ‰§è¡Œä¸€æ¬¡æŸ¥è¯¢ select * from t_order_smt; é€šè¿‡ç»“æœå¯ä»¥å¾—åˆ°ä»¥ä¸‹ç»“è®º ä»¥ SummingMergeTreeï¼ˆï¼‰ä¸­æŒ‡å®šçš„åˆ—ä½œä¸ºæ±‡æ€»æ•°æ®åˆ— å¯ä»¥å¡«å†™å¤šåˆ—å¿…é¡»æ•°å­—åˆ—ï¼Œå¦‚æœä¸å¡«ï¼Œä»¥æ‰€æœ‰éç»´åº¦åˆ—ä¸”ä¸ºæ•°å­—åˆ—çš„å­—æ®µä¸ºæ±‡æ€»æ•°æ®åˆ— ä»¥ order by çš„åˆ—ä¸ºå‡†ï¼Œä½œä¸ºç»´åº¦åˆ— å…¶ä»–çš„åˆ—æŒ‰æ’å…¥é¡ºåºä¿ç•™ç¬¬ä¸€è¡Œ ä¸åœ¨ä¸€ä¸ªåˆ†åŒºçš„æ•°æ®ä¸ä¼šè¢«èšåˆ åªæœ‰åœ¨åŒä¸€æ‰¹æ¬¡æ’å…¥(æ–°ç‰ˆæœ¬)æˆ–åˆ†ç‰‡åˆå¹¶æ—¶æ‰ä¼šè¿›è¡Œèšåˆ å¼€å‘å»ºè®® è®¾è®¡èšåˆè¡¨çš„è¯ï¼Œå”¯ä¸€é”®å€¼ã€æµæ°´å·å¯ä»¥å»æ‰ï¼Œæ‰€æœ‰å­—æ®µå…¨éƒ¨æ˜¯ç»´åº¦ã€åº¦é‡æˆ–è€…æ—¶é—´æˆ³ã€‚ é—®é¢˜ èƒ½ä¸èƒ½ç›´æ¥æ‰§è¡Œä»¥ä¸‹ SQL å¾—åˆ°æ±‡æ€»å€¼ select total_amount from XXX where province_name=â€™â€™ and create_date=â€™xxxâ€™ ç­”ï¼š ä¸è¡Œï¼Œå¯èƒ½ä¼šåŒ…å«ä¸€äº›è¿˜æ²¡æ¥å¾—åŠèšåˆçš„ä¸´æ—¶æ˜ç»† å¦‚æœè¦æ˜¯è·å–æ±‡æ€»å€¼ï¼Œè¿˜æ˜¯éœ€è¦ä½¿ç”¨ sum è¿›è¡Œèšåˆï¼Œè¿™æ ·æ•ˆç‡ä¼šæœ‰ä¸€å®šçš„æé«˜ï¼Œä½†æœ¬èº« ClickHouse æ˜¯åˆ—å¼å­˜å‚¨çš„ï¼Œæ•ˆç‡æå‡æœ‰é™ï¼Œä¸ä¼šç‰¹åˆ«æ˜æ˜¾ã€‚ select sum(total_amount) from province_name=â€™â€™ and create_date=â€˜xxxâ€™ ","link":"https://tianxiawuhao.github.io/XvNkKhwMg/"},{"title":"ClickHouse-3æ•°æ®ç±»å‹","content":"1. æ•´å‹ å›ºå®šé•¿åº¦çš„æ•´å‹ï¼ŒåŒ…æ‹¬ æœ‰ç¬¦å·æ•´å‹(æœ‰æ­£æœ‰è´Ÿ) æˆ– æ— ç¬¦å·æ•´å‹ã€‚ ç±»æ¯” Java ç±»å‹ï¼š CHç±»å‹ Javaç±»å‹ æ•´å‹èŒƒå›´ï¼ˆ-2n-1~2n-1-1ï¼‰ Int8 - [-128 : 127] Byte Int16 - [-32768 : 32767] Short Int32 - [-2147483648 : 2147483647] Int Int64 - [-9223372036854775808 : 9223372036854775807] Long æ— ç¬¦å·æ•´å‹èŒƒå›´ï¼ˆ0~2n-1ï¼‰ UInt8 - [0 : 255] UInt16 - [0 : 65535] UInt32 - [0 : 4294967295] UInt64 - [0 : 18446744073709551615] åé¢çš„æ•°ç»„å°±ä»£è¡¨ä½æ•° ä½¿ç”¨åœºæ™¯ï¼š ä¸ªæ•°ã€æ•°é‡ã€ä¹Ÿå¯ä»¥å­˜å‚¨å‹ idã€‚ 2. æµ®ç‚¹å‹ ç±»æ¯” Java ç±»å‹ï¼š CHç±»å‹ Javaç±»å‹ Float32 float Float64 double å»ºè®®å°½å¯èƒ½ä»¥æ•´æ•°å½¢å¼å­˜å‚¨æ•°æ®ã€‚ä¾‹å¦‚ï¼Œå°†å›ºå®šç²¾åº¦çš„æ•°å­—è½¬æ¢ä¸ºæ•´æ•°å€¼ï¼Œå¦‚æ—¶é—´ç”¨æ¯«ç§’ä¸ºå•ä½è¡¨ç¤ºï¼Œå› ä¸ºæµ®ç‚¹å‹è¿›è¡Œè®¡ç®—æ—¶å¯èƒ½å¼•èµ·å››èˆäº”å…¥çš„è¯¯å·®ã€‚ ä½¿ç”¨åœºæ™¯ï¼šä¸€èˆ¬æ•°æ®å€¼æ¯”è¾ƒå°ï¼Œä¸æ¶‰åŠå¤§é‡çš„ç»Ÿè®¡è®¡ç®—ï¼Œç²¾åº¦è¦æ±‚ä¸é«˜çš„æ—¶å€™ã€‚æ¯”å¦‚ä¿å­˜å•†å“çš„é‡é‡ã€‚ 3. å¸ƒå°”å‹ æ²¡æœ‰å•ç‹¬çš„ç±»å‹æ¥å­˜å‚¨å¸ƒå°”å€¼ã€‚å¯ä»¥ä½¿ç”¨ UInt8 ç±»å‹ï¼Œå–å€¼é™åˆ¶ä¸º 0 æˆ– 1ã€‚ 4. Decimal å‹ æœ‰ç¬¦å·çš„æµ®ç‚¹æ•°ï¼Œå¯åœ¨åŠ ã€å‡å’Œä¹˜æ³•è¿ç®—è¿‡ç¨‹ä¸­ä¿æŒç²¾åº¦ã€‚å¯¹äºé™¤æ³•ï¼Œæœ€ä½æœ‰æ•ˆæ•°å­—ä¼šè¢«ä¸¢å¼ƒï¼ˆä¸å››èˆäº”å…¥ï¼‰ã€‚ æœ‰ä¸‰ç§å£°æ˜ (s æ ‡è¯†å°æ•°ä½)ï¼š Decimal32(s)ï¼Œ å³ ä¸€å…±æœ‰ 8 ä½ï¼Œå…¶ä¸­å°æ•°éƒ¨åˆ†å  s ä½ï¼Œç›¸å½“äº Mysql - Decimal(9-s,s) Decimal64(s)ï¼Œ å³ ä¸€å…±æœ‰ 18 ä½ï¼Œå…¶ä¸­å°æ•°éƒ¨åˆ†å  s ä½ï¼Œç›¸å½“äº Decimal(18-s,s) Decimal128(s)ï¼Œ å³ ä¸€å…±æœ‰ 38ä½ï¼Œå…¶ä¸­å°æ•°éƒ¨åˆ†å  s ä½ï¼Œç›¸å½“äº Decimal(38-s,s) ä½¿ç”¨åœºæ™¯ï¼š ä¸€èˆ¬é‡‘é¢å­—æ®µã€æ±‡ç‡ã€åˆ©ç‡ç­‰å­—æ®µä¸ºäº†ä¿è¯å°æ•°ç‚¹ç²¾åº¦ï¼Œéƒ½ä½¿ç”¨ Decimalè¿›è¡Œå­˜å‚¨ã€‚ 5. å­—ç¬¦ä¸² String - å¯¹åº” Mysql - Varchar å­—ç¬¦ä¸²å¯ä»¥ä»»æ„é•¿åº¦çš„ã€‚å®ƒå¯ä»¥åŒ…å«ä»»æ„çš„å­—èŠ‚é›†ï¼ŒåŒ…å«ç©ºå­—èŠ‚ã€‚ FixedString(N) å›ºå®šé•¿åº¦ N çš„å­—ç¬¦ä¸²ï¼ŒN å¿…é¡»æ˜¯ä¸¥æ ¼çš„æ­£è‡ªç„¶æ•°ã€‚å½“æœåŠ¡ç«¯è¯»å–é•¿åº¦å°äº N çš„å­—ç¬¦ä¸²æ—¶å€™ï¼Œé€šè¿‡åœ¨å­—ç¬¦ä¸²æœ«å°¾æ·»åŠ ç©ºå­—èŠ‚æ¥è¾¾åˆ° N å­—èŠ‚é•¿åº¦ã€‚ å½“æœåŠ¡ç«¯è¯»å–é•¿åº¦å¤§äº N çš„å­—ç¬¦ä¸²æ—¶å€™ï¼Œå°†è¿”å›é”™è¯¯æ¶ˆæ¯ã€‚ ä¸ String ç›¸æ¯”ï¼Œæå°‘ä¼šä½¿ç”¨ FixedStringï¼Œå› ä¸ºä½¿ç”¨èµ·æ¥ä¸æ˜¯å¾ˆæ–¹ä¾¿ã€‚ ä½¿ç”¨åœºæ™¯ï¼šåç§°ã€æ–‡å­—æè¿°ã€å­—ç¬¦å‹ç¼–ç ã€‚ å›ºå®šé•¿åº¦çš„å¯ä»¥ä¿å­˜ä¸€äº›å®šé•¿çš„å†…å®¹ï¼Œæ¯”å¦‚ä¸€äº›ç¼–ç ï¼Œæ€§åˆ«ç­‰ä½†æ˜¯è€ƒè™‘åˆ°ä¸€å®šçš„å˜åŒ–é£é™©ï¼Œå¸¦æ¥æ”¶ç›Šä¸å¤Ÿæ˜æ˜¾ï¼Œæ‰€ä»¥å®šé•¿å­—ç¬¦ä¸²ä½¿ç”¨æ„ä¹‰æœ‰é™ã€‚ 6. æšä¸¾ç±»å‹ åŒ…æ‹¬ Enum8 å’Œ Enum16 ç±»å‹ã€‚Enum ä¿å­˜ â€˜stringâ€™= integer çš„å¯¹åº”å…³ç³»ã€‚ Enum8 ç”¨ â€˜Stringâ€™= Int8 å¯¹æè¿°ã€‚ Enum16 ç”¨ â€˜Stringâ€™= Int16 å¯¹æè¿°ã€‚ åˆ›å»ºä¸€ä¸ªå¸¦æœ‰ä¸€ä¸ªæšä¸¾ Enum8(â€˜helloâ€™ = 1, â€˜worldâ€™ = 2) ç±»å‹çš„åˆ— CREATE TABLE t_enum ( x Enum8('hello' = 1, 'world' = 2) ) ENGINE = TinyLog; è¿™ä¸ª x åˆ—åªèƒ½å­˜å‚¨ç±»å‹å®šä¹‰ä¸­åˆ—å‡ºçš„å€¼ï¼šâ€˜helloâ€™æˆ–â€™worldâ€™ INSERT INTO t_enum VALUES ('hello'), ('world'), ('hello'); å¦‚æœå°è¯•ä¿å­˜ä»»ä½•å…¶ä»–å€¼ï¼ŒClickHouse æŠ›å‡ºå¼‚å¸¸ insert into t_enum values('a') å¦‚æœéœ€è¦çœ‹åˆ°å¯¹åº”è¡Œçš„æ•°å€¼ï¼Œåˆ™å¿…é¡»å°† Enum å€¼è½¬æ¢ä¸ºæ•´æ•°ç±»å‹ SELECT CAST(x, 'Int8') FROM t_enum; ä½¿ç”¨åœºæ™¯ï¼šå¯¹ä¸€äº›çŠ¶æ€ã€ç±»å‹çš„å­—æ®µç®—æ˜¯ä¸€ç§ç©ºé—´ä¼˜åŒ–ï¼Œä¹Ÿç®—æ˜¯ä¸€ç§æ•°æ®çº¦æŸã€‚ä½†æ˜¯å®é™…ä½¿ç”¨ä¸­å¾€å¾€å› ä¸ºä¸€äº›æ•°æ®å†…å®¹çš„å˜åŒ–å¢åŠ ä¸€å®šçš„ç»´æŠ¤æˆæœ¬ï¼Œç”šè‡³æ˜¯æ•°æ®ä¸¢å¤±é—®é¢˜ã€‚æ‰€ä»¥è°¨æ…ä½¿ç”¨ã€‚ 7. æ—¶é—´ç±»å‹ ç›®å‰ ClickHouse æœ‰ä¸‰ç§æ—¶é—´ç±»å‹ Date æ¥å—å¹´-æœˆ-æ—¥çš„å­—ç¬¦ä¸²æ¯”å¦‚ â€˜2019-12-16â€™ Datetime æ¥å—å¹´-æœˆ-æ—¥ æ—¶:åˆ†:ç§’çš„å­—ç¬¦ä¸²æ¯”å¦‚ â€˜2019-12-16 20:50:10â€™ Datetime64 æ¥å—å¹´-æœˆ-æ—¥ æ—¶:åˆ†:ç§’.äºšç§’çš„å­—ç¬¦ä¸²æ¯”å¦‚â€˜2019-12-16 20:50:10.66â€™ æ—¥æœŸç±»å‹ï¼Œç”¨ä¸¤ä¸ªå­—èŠ‚å­˜å‚¨ï¼Œè¡¨ç¤ºä» 1970-01-01 (æ— ç¬¦å·) åˆ°å½“å‰çš„æ—¥æœŸå€¼ã€‚ 8. æ•°ç»„ Array(T)ï¼šç”± T ç±»å‹å…ƒç´ ç»„æˆçš„æ•°ç»„ã€‚ T å¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼ŒåŒ…å«æ•°ç»„ç±»å‹ã€‚ ä½†ä¸æ¨èä½¿ç”¨å¤šç»´æ•°ç»„ï¼ŒClickHouse å¯¹å¤šç»´æ•°ç»„çš„æ”¯æŒæœ‰é™ã€‚ä¾‹å¦‚ï¼Œä¸èƒ½åœ¨ MergeTree è¡¨ä¸­å­˜å‚¨å¤šç»´æ•°ç»„ã€‚ åˆ›å»ºæ•°ç»„æ–¹å¼ 1ï¼Œä½¿ç”¨ array å‡½æ•°array(T) SELECT array(1, 2) AS x, toTypeName(x) ; åˆ›å»ºæ•°ç»„æ–¹å¼ 2ï¼šä½¿ç”¨æ–¹æ‹¬å·[] SELECT [1, 2] AS x, toTypeName(x); 9. å…¶ä»– è¿˜æœ‰å¾ˆå¤šæ•°æ®ç»“æ„ï¼Œå¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šhttps://clickhouse.com/docs/zh/sql-reference/data-types/ ","link":"https://tianxiawuhao.github.io/1h169zkFb/"},{"title":"Dockerå®‰è£…clickhouse","content":"ClickHouse å¾ˆå¤šå¤§å‚éƒ½åœ¨ç”¨ï¼Œæœ¬ç¯‡ä¸»è¦ä½¿ç”¨Dockerè¿›è¡Œå®‰è£… å®‰è£…é…ç½® åˆ›å»ºç›®å½•å¹¶æ›´æ”¹æƒé™ mkdir -p /app/cloud/clickhouse/data mkdir -p /app/cloud/clickhouse/conf mkdir -p /app/cloud/clickhouse/log chmod -R 777 /app/cloud/clickhouse/data chmod -R 777 /app/cloud/clickhouse/conf chmod -R 777 /app/cloud/clickhouse/log æ‹‰å–é•œåƒ docker pull yandex/clickhouse-server:20.3.5.21 docker pull yandex/clickhouse-client:20.3.5.21 æŸ¥çœ‹ https://hub.docker.com/r/yandex/clickhouse-server/dockerfile æ–‡ä»¶ï¼ŒEXPOSE 9000 8123 9009 äº†ä¸‰ä¸ªç«¯å£ åˆ›å»ºä¸´æ—¶å®¹å™¨ docker run --rm -d --name=clickhouse-server --ulimit nofile=262144:262144 -p 8123:8123 -p 9009:9009 -p 9000:9000 yandex/clickhouse-server:20.3.5.21 å¤åˆ¶ä¸´æ—¶å®¹å™¨å†…é…ç½®æ–‡ä»¶åˆ°å®¿ä¸»æœº docker cp clickhouse-server:/etc/clickhouse-server/config.xml D:/clickhouse/conf/config.xml docker cp clickhouse-server:/etc/clickhouse-server/users.xml D:/clickhouse/conf/users.xml åœæ‰ä¸´æ—¶å®¹å™¨ docker stop clickhouse-server åˆ›å»ºdefaultè´¦å·å¯†ç  PASSWORD=$(base64 &lt; /dev/urandom | head -c8); echo &quot;$PASSWORD&quot;; echo -n &quot;$PASSWORD&quot; | sha256sum | tr -d '-' SEGByR98 211371f5bc54970907173acf6facb35f0acbc17913e1b71b814117667c01d96d ä¼šè¾“å‡ºæ˜ç å’ŒSHA256å¯†ç  åˆ›å»ºrootè´¦å·å¯†ç  PASSWORD=$(base64 &lt; /dev/urandom | head -c8); echo &quot;$PASSWORD&quot;; echo -n &quot;$PASSWORD&quot; | sha256sum | tr -d '-' 092j3AnV 35542ded44184b1b4b6cd621e052662578025b58b4187176a3ad2b9548c8356e ä¼šè¾“å‡ºæ˜ç å’ŒSHA256å¯†ç  ä¿®æ”¹ D:/clickhouse/conf/users.xml æŠŠdefaultè´¦å·è®¾ä¸ºåªè¯»æƒé™ï¼Œå¹¶è®¾ç½®å¯†ç yandex--&gt;users--&gt;default--&gt;profileèŠ‚ç‚¹è®¾ä¸º readonly æ³¨é‡Šæ‰ yandex--&gt;users--&gt;default--&gt;password èŠ‚ç‚¹ æ–°å¢ yandex--&gt;users--&gt;default--&gt;password_sha256_hex èŠ‚ç‚¹ï¼Œå¡«å…¥ç”Ÿæˆçš„å¯†ç  ä¿®æ”¹defaultè´¦å· &lt;?xml version=&quot;1.0&quot;?&gt; &lt;yandex&gt; &lt;users&gt; &lt;default&gt; &lt;password_sha256_hex&gt;211371f5bc54970907173acf6facb35f0acbc17913e1b71b814117667c01d96d&lt;/password_sha256_hex&gt; &lt;networks incl=&quot;networks&quot; replace=&quot;replace&quot;&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;profile&gt;readonly&lt;/profile&gt; &lt;quota&gt;default&lt;/quota&gt; &lt;/default&gt; &lt;/users&gt; &lt;/yandex&gt; æ–°å¢rootè´¦å· &lt;?xml version=&quot;1.0&quot;?&gt; &lt;yandex&gt; &lt;users&gt; &lt;root&gt; &lt;password_sha256_hex&gt;35542ded44184b1b4b6cd621e052662578025b58b4187176a3ad2b9548c8356e&lt;/password_sha256_hex&gt; &lt;networks incl=&quot;networks&quot; replace=&quot;replace&quot;&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;profile&gt;default&lt;/profile&gt; &lt;quota&gt;default&lt;/quota&gt; &lt;/root&gt; &lt;/users&gt; &lt;/yandex&gt; åˆ›å»ºå®¹å™¨ docker run -d --name=clickhouse-server -p 8123:8123 -p 9009:9009 -p 9000:9000 --ulimit nofile=262144:262144 -v D:/clickhouse/data:/var/lib/clickhouse:rw -v D:/clickhouse/conf/config.xml:/etc/clickhouse-server/config.xml -v D:/clickhouse/conf/users.xml:/etc/clickhouse-server/users.xml -v D:/clickhouse/log:/var/log/clickhouse-server:rw yandex/clickhouse-server æ“ä½œ docker exec -it docker-clickhouse /bin/bash è¿›å…¥å®¹å™¨ clickhouse-client è¿›å…¥clickhouseå‘½ä»¤è¡Œ ","link":"https://tianxiawuhao.github.io/BBgY7nkHa/"},{"title":"ClickHouse-2åˆè¯†","content":"ä¸€ã€ç®€ä»‹ 1.1 ClickHouse æ˜¯ä»€ä¹ˆï¼Ÿ ClickHouse æ˜¯ Yandexï¼ˆä¿„ç½—æ–¯æœ€å¤§çš„æœç´¢å¼•æ“ï¼‰å¼€æºçš„ä¸€ä¸ªç”¨äºå®æ—¶æ•°æ®åˆ†æçš„åŸºäºåˆ—å­˜å‚¨çš„æ•°æ®åº“ï¼Œå…¶å¤„ç†æ•°æ®çš„é€Ÿåº¦æ¯”ä¼ ç»Ÿæ–¹æ³•å¿« 100-1000 å€ã€‚ClickHouse çš„æ€§èƒ½è¶…è¿‡äº†ç›®å‰å¸‚åœºä¸Šå¯æ¯”çš„é¢å‘åˆ—çš„ DBMSï¼Œæ¯ç§’é’Ÿæ¯å°æœåŠ¡å™¨æ¯ç§’å¤„ç†æ•°äº¿è‡³åäº¿å¤šè¡Œå’Œæ•°ååƒå…†å­—èŠ‚çš„æ•°æ®ã€‚ 1.2 ClickHouseçš„ä¸€äº›ç‰¹æ€§ï¼š å¿«é€Ÿï¼šClickHouse ä¼šå……åˆ†åˆ©ç”¨æ‰€æœ‰å¯ç”¨çš„ç¡¬ä»¶ï¼Œä»¥å°½å¯èƒ½å¿«åœ°å¤„ç†æ¯ä¸ªæŸ¥è¯¢ã€‚å•ä¸ªæŸ¥è¯¢çš„å³°å€¼å¤„ç†æ€§èƒ½è¶…è¿‡æ¯ç§’ 2 TBï¼ˆè§£å‹ç¼©åï¼Œä»…ä½¿ç”¨çš„åˆ—ï¼‰ã€‚åœ¨åˆ†å¸ƒå¼è®¾ç½®ä¸­ï¼Œè¯»å–æ˜¯åœ¨å¥åº·å‰¯æœ¬ä¹‹é—´è‡ªåŠ¨å¹³è¡¡çš„ï¼Œä»¥é¿å…å¢åŠ å»¶è¿Ÿã€‚ å®¹é”™ï¼šClickHouse æ”¯æŒå¤šä¸»æœºå¼‚æ­¥å¤åˆ¶ï¼Œå¹¶ä¸”å¯ä»¥è·¨å¤šä¸ªæ•°æ®ä¸­å¿ƒè¿›è¡Œéƒ¨ç½²ã€‚æ‰€æœ‰èŠ‚ç‚¹éƒ½ç›¸ç­‰ï¼Œè¿™å¯ä»¥é¿å…å‡ºç°å•ç‚¹æ•…éšœã€‚å•ä¸ªèŠ‚ç‚¹æˆ–æ•´ä¸ªæ•°æ®ä¸­å¿ƒçš„åœæœºæ—¶é—´ä¸ä¼šå½±å“ç³»ç»Ÿçš„è¯»å†™å¯ç”¨æ€§ã€‚ å¯ä¼¸ç¼©ï¼šClickHouse å¯ä»¥åœ¨å‚ç›´å’Œæ°´å¹³æ–¹å‘ä¸Šå¾ˆå¥½åœ°ç¼©æ”¾ã€‚ClickHouse æ˜“äºè°ƒæ•´ä»¥åœ¨å…·æœ‰æ•°ç™¾æˆ–æ•°åƒä¸ªèŠ‚ç‚¹çš„ç¾¤é›†ä¸Šæˆ–åœ¨å•ä¸ªæœåŠ¡å™¨ä¸Šï¼Œç”šè‡³åœ¨å°å‹è™šæ‹Ÿæœºä¸Šæ‰§è¡Œã€‚å½“å‰ï¼Œæ¯ä¸ªå•èŠ‚ç‚¹å®‰è£…çš„æ•°æ®é‡è¶…è¿‡æ•°ä¸‡äº¿è¡Œæˆ–æ•°ç™¾å…†å…†å­—èŠ‚ã€‚ æ˜“ç”¨ï¼šClickHouse ç®€å•æ˜“ç”¨ï¼Œå¼€ç®±å³ç”¨ã€‚å®ƒç®€åŒ–äº†æ‰€æœ‰æ•°æ®å¤„ç†ï¼šå°†æ‰€æœ‰ç»“æ„åŒ–æ•°æ®å¸æ”¶åˆ°ç³»ç»Ÿä¸­ï¼Œå¹¶ä¸”ç«‹å³å¯ç”¨äºæ„å»ºæŠ¥å‘Šã€‚SQL å…è®¸è¡¨è¾¾æœŸæœ›çš„ç»“æœï¼Œè€Œæ— éœ€æ¶‰åŠæŸäº› DBMS ä¸­å¯ä»¥æ‰¾åˆ°çš„ä»»ä½•è‡ªå®šä¹‰éæ ‡å‡† APIã€‚ å……åˆ†åˆ©ç”¨ç¡¬ä»¶ï¼šClickHouse ä¸å…·æœ‰ç›¸åŒçš„å¯ç”¨ I/O ååé‡å’Œ CPU å®¹é‡çš„ä¼ ç»Ÿçš„é¢å‘è¡Œçš„ç³»ç»Ÿç›¸æ¯”ï¼Œå…¶å¤„ç†å…¸å‹çš„åˆ†ææŸ¥è¯¢è¦å¿«ä¸¤åˆ°ä¸‰ä¸ªæ•°é‡çº§ã€‚åˆ—å¼å­˜å‚¨æ ¼å¼å…è®¸åœ¨ RAM ä¸­å®¹çº³æ›´å¤šçƒ­æ•°æ®ï¼Œä»è€Œç¼©çŸ­äº†å“åº”æ—¶é—´ã€‚ æé«˜ CPU æ•ˆç‡ï¼šå‘é‡åŒ–æŸ¥è¯¢æ‰§è¡Œæ¶‰åŠç›¸å…³çš„ SIMD å¤„ç†å™¨æŒ‡ä»¤å’Œè¿è¡Œæ—¶ä»£ç ç”Ÿæˆã€‚å¤„ç†åˆ—ä¸­çš„æ•°æ®ä¼šæé«˜ CPU è¡Œç¼“å­˜çš„å‘½ä¸­ç‡ã€‚ ä¼˜åŒ–ç£ç›˜è®¿é—®ï¼šClickHouse å¯ä»¥æœ€å¤§ç¨‹åº¦åœ°å‡å°‘èŒƒå›´æŸ¥è¯¢çš„æ¬¡æ•°ï¼Œä»è€Œæé«˜äº†ä½¿ç”¨æ—‹è½¬ç£ç›˜é©±åŠ¨å™¨çš„æ•ˆç‡ï¼Œå› ä¸ºå®ƒå¯ä»¥ä¿æŒè¿ç»­å­˜å‚¨æ•°æ®ã€‚ æœ€å°åŒ–æ•°æ®ä¼ è¾“ï¼šClickHouse ä½¿å…¬å¸æ— éœ€ä½¿ç”¨ä¸“é—¨é’ˆå¯¹é«˜æ€§èƒ½è®¡ç®—çš„ä¸“ç”¨ç½‘ç»œå³å¯ç®¡ç†å…¶æ•°æ®ã€‚ ä½•æ—¶ä½¿ç”¨ ClickHouseï¼š ç”¨äºåˆ†æç»“æ„è‰¯å¥½ä¸”ä¸å¯å˜çš„äº‹ä»¶æˆ–æ—¥å¿—æµï¼Œå»ºè®®å°†æ¯ä¸ªæ­¤ç±»æµæ”¾å…¥å…·æœ‰é¢„è¿æ¥ç»´åº¦çš„å•ä¸ªå®½è¡¨ä¸­ã€‚ ä½•æ—¶ä¸ä½¿ç”¨ ClickHouseï¼š ä¸é€‚åˆäº‹åŠ¡æ€§å·¥ä½œè´Ÿè½½ï¼ˆOLTPï¼‰ã€é«˜ä»·å€¼çš„é”®å€¼è¯·æ±‚ã€Blob æˆ–æ–‡æ¡£å­˜å‚¨ã€‚ 1.3 ä¸ºä»€ä¹ˆ ClickHouse é€Ÿåº¦è¿™ä¹ˆå¿«ï¼Ÿ é¦–å…ˆæˆ‘ä»¬äº†è§£ä¸€ä¸‹ OLAP åœºæ™¯çš„ç‰¹ç‚¹ï¼š è¯»å¤šäºå†™ã€‚ å¤§å®½è¡¨ï¼Œè¯»å¤§é‡è¡Œä½†æ˜¯å°‘é‡åˆ—ï¼Œç»“æœé›†è¾ƒå°ã€‚ æ•°æ®æ‰¹é‡å†™å…¥ï¼Œä¸”æ•°æ®ä¸æ›´æ–°æˆ–å°‘æ›´æ–°ã€‚ é’ˆå¯¹åˆ†æç±»æŸ¥è¯¢ï¼Œé€šå¸¸åªéœ€è¦è¯»å–è¡¨çš„ä¸€å°éƒ¨åˆ†åˆ—ã€‚åœ¨åˆ—å¼æ•°æ®åº“ä¸­ä½ å¯ä»¥åªè¯»å–ä½ éœ€è¦çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œå¦‚æœåªéœ€è¦è¯»å– 100 åˆ—ä¸­çš„ 5 åˆ—ï¼Œè¿™å°†å¸®åŠ©ä½ æœ€å°‘å‡å°‘ 20 å€çš„ I/O æ¶ˆè€—ã€‚ ç”±äºæ•°æ®æ€»æ˜¯æ‰“åŒ…æˆæ‰¹é‡è¯»å–çš„ï¼Œæ‰€ä»¥å‹ç¼©æ˜¯éå¸¸å®¹æ˜“çš„ã€‚åŒæ—¶æ•°æ®æŒ‰åˆ—åˆ†åˆ«å­˜å‚¨è¿™ä¹Ÿæ›´å®¹æ˜“å‹ç¼©ã€‚è¿™è¿›ä¸€æ­¥é™ä½äº† I/O çš„ä½“ç§¯ã€‚ç”±äº I/O çš„é™ä½ï¼Œè¿™å°†å¸®åŠ©æ›´å¤šçš„æ•°æ®è¢«ç³»ç»Ÿç¼“å­˜ã€‚ ä¾‹å¦‚ï¼ŒæŸ¥è¯¢ã€Šç»Ÿè®¡æ¯ä¸ªå¹¿å‘Šå¹³å°çš„è®°å½•æ•°é‡ã€‹éœ€è¦è¯»å–ã€Šå¹¿å‘Šå¹³å° IDã€‹è¿™ä¸€åˆ—ï¼Œå®ƒåœ¨æœªå‹ç¼©çš„æƒ…å†µä¸‹éœ€è¦ 1 ä¸ªå­—èŠ‚è¿›è¡Œå­˜å‚¨ã€‚å¦‚æœå¤§éƒ¨åˆ†æµé‡ä¸æ˜¯æ¥è‡ªå¹¿å‘Šå¹³å°ï¼Œé‚£ä¹ˆè¿™ä¸€åˆ—è‡³å°‘å¯ä»¥ä»¥åå€çš„å‹ç¼©ç‡è¢«å‹ç¼©ã€‚å½“é‡‡ç”¨å¿«é€Ÿå‹ç¼©ç®—æ³•ï¼Œå®ƒçš„è§£å‹é€Ÿåº¦æœ€å°‘åœ¨åäº¿å­—èŠ‚ï¼ˆæœªå‹ç¼©æ•°æ®ï¼‰æ¯ç§’ã€‚æ¢å¥è¯è¯´ï¼Œè¿™ä¸ªæŸ¥è¯¢å¯ä»¥åœ¨å•ä¸ªæœåŠ¡å™¨ä¸Šä»¥æ¯ç§’å¤§çº¦å‡ åäº¿è¡Œçš„é€Ÿåº¦è¿›è¡Œå¤„ç†ã€‚è¿™å®é™…ä¸Šæ˜¯å½“å‰å®ç°çš„é€Ÿåº¦ã€‚ ClickHouse ä» OLAP åœºæ™¯éœ€æ±‚å‡ºå‘ï¼Œå®šåˆ¶å¼€å‘äº†ä¸€å¥—å…¨æ–°çš„é«˜æ•ˆåˆ—å¼å­˜å‚¨å¼•æ“ column-oriented å›¾ç‰‡æ¥æºè§æ°´å°ç›¸æ¯”äºè¡Œå¼å­˜å‚¨ï¼Œåˆ—å¼å­˜å‚¨åœ¨åˆ†æåœºæ™¯ä¸‹æœ‰ç€è®¸å¤šä¼˜è‰¯çš„ç‰¹æ€§ã€‚ å¦‚å‰æ‰€è¿°ï¼Œåˆ†æåœºæ™¯ä¸­å¾€å¾€éœ€è¦è¯»å¤§é‡è¡Œä½†æ˜¯å°‘æ•°å‡ ä¸ªåˆ—ã€‚åœ¨è¡Œå­˜æ¨¡å¼ä¸‹ï¼Œæ•°æ®æŒ‰è¡Œè¿ç»­å­˜å‚¨ï¼Œæ‰€æœ‰åˆ—çš„æ•°æ®éƒ½å­˜å‚¨åœ¨ä¸€ä¸ª block ä¸­ï¼Œä¸å‚ä¸è®¡ç®—çš„åˆ—åœ¨ IO æ—¶ä¹Ÿè¦å…¨éƒ¨è¯»å‡ºï¼Œè¯»å–æ“ä½œè¢«ä¸¥é‡æ”¾å¤§ã€‚è€Œåˆ—å­˜æ¨¡å¼ä¸‹ï¼Œåªéœ€è¦è¯»å–å‚ä¸è®¡ç®—çš„åˆ—å³å¯ï¼Œæå¤§çš„å‡ä½äº† IO costï¼ŒåŠ é€Ÿäº†æŸ¥è¯¢ã€‚ åŒä¸€åˆ—ä¸­çš„æ•°æ®å±äºåŒä¸€ç±»å‹ï¼Œå‹ç¼©æ•ˆæœæ˜¾è‘—ã€‚åˆ—å­˜å¾€å¾€æœ‰ç€é«˜è¾¾åå€ç”šè‡³æ›´é«˜çš„å‹ç¼©æ¯”ï¼ŒèŠ‚çœäº†å¤§é‡çš„å­˜å‚¨ç©ºé—´ï¼Œé™ä½äº†å­˜å‚¨æˆæœ¬ã€‚ æ›´é«˜çš„å‹ç¼©æ¯”æ„å‘³ç€æ›´å°çš„ data sizeï¼Œä»ç£ç›˜ä¸­è¯»å–ç›¸åº”æ•°æ®è€—æ—¶æ›´çŸ­ã€‚ è‡ªç”±çš„å‹ç¼©ç®—æ³•é€‰æ‹©ã€‚ä¸åŒåˆ—çš„æ•°æ®å…·æœ‰ä¸åŒçš„æ•°æ®ç±»å‹ï¼Œé€‚ç”¨çš„å‹ç¼©ç®—æ³•ä¹Ÿå°±ä¸å°½ç›¸åŒã€‚å¯ä»¥é’ˆå¯¹ä¸åŒåˆ—ç±»å‹ï¼Œé€‰æ‹©æœ€åˆé€‚çš„å‹ç¼©ç®—æ³•ã€‚ é«˜å‹ç¼©æ¯”ï¼Œæ„å‘³ç€åŒç­‰å¤§å°çš„å†…å­˜èƒ½å¤Ÿå­˜æ”¾æ›´å¤šæ•°æ®ï¼Œç³»ç»Ÿ cache æ•ˆæœæ›´å¥½ã€‚ ","link":"https://tianxiawuhao.github.io/GwxNFXsxh/"},{"title":"Clickhouse-1å®‰è£…","content":"1.ClickHouseçš„å®‰è£… 1.1 å‡†å¤‡å·¥ä½œ ä¸‹è½½RPMåŒ…: https://repo.yandex.ru/clickhouse/rpm/stable/x86_64/ ä¸‹è½½å®Œæ¯•å¦‚ä¸‹: â€‹ 1.1.1 ç¡®å®šé˜²ç«å¢™å¤„äºå…³é—­çŠ¶æ€ ç›¸å…³å‘½ä»¤: sudo systemctl status firewalld sudo systemctl start firewalld sudo systemctl stop firewalld sudo systemctl restart firewalld 1.1.2 CentOSå–æ¶ˆæ‰“å¼€æ–‡ä»¶æ•°é™åˆ¶ Ã˜ åœ¨ /etc/security/limits.confæ–‡ä»¶çš„æœ«å°¾åŠ å…¥ä»¥ä¸‹å†…å®¹ vim /etc/security/limits.conf * soft nofile 65536 * hard nofile 65536 * soft nproc 131072 * hard nproc 131072 Ã˜ åœ¨/etc/security/limits.d/20-nproc.confæ–‡ä»¶çš„æœ«å°¾åŠ å…¥ä»¥ä¸‹å†…å®¹ vim /etc/security/limits.d/20-nproc.conf * soft nofile 65536 * hard nofile 65536 * soft nproc 131072 * hard nproc 131072 Ã˜ æ‰§è¡ŒåŒæ­¥æ“ä½œ(åŒæ­¥åˆ°é›†ç¾¤å…¶ä»–æœºå™¨) xsync /etc/security/limits.conf xsync /etc/security/limits.d/20-nproc.conf 1.1.3 å®‰è£…ä¾èµ– sudo yum install -y libtool sudo yum install -y *unixODBC* åŒæ ·åœ¨é›†ç¾¤å…¶ä»–æœºå™¨ä¸Šæ‰§è¡Œä»¥ä¸Šæ“ä½œ 1.1.4 CentOSå–æ¶ˆSELINUX SELINUX(ç¾å›½å¼€æºçš„linuxå®‰å…¨å¢å¼ºåŠŸèƒ½) Ã˜ ä¿®æ”¹/etc/selinux/configä¸­çš„SELINUX=disabled sudo vim /etc/selinux/config SELINUX=disabled Ã˜ æ‰§è¡ŒåŒæ­¥æ“ä½œ sudo /home/atguigu/bin/xsync /etc/selinux/config Ã˜ é‡å¯ä¸‰å°æœåŠ¡å™¨ 1.1.5 å°†å®‰è£…æ–‡ä»¶åŒæ­¥åˆ°å…¶ä»–ä¸¤ä¸ªæœåŠ¡å™¨ 1.1.6 åˆ†åˆ«åœ¨ä¸‰å°æœºå­ä¸Šå®‰è£…è¿™4ä¸ªrpmæ–‡ä»¶ sudo rpm -ivh *.rpm(æå‰æŠŠå››ä¸ª*.rpmæ”¾åœ¨ä¸€ä¸ªç›®å½•ä¸‹) sudo rpm -qa|grep clickhouseæŸ¥çœ‹å®‰è£…æƒ…å†µ 1.1.7 ä¿®æ”¹é…ç½®æ–‡ä»¶ vim /etc/clickhouse-server/config.xml æŠŠ &lt;listen_host&gt;::&lt;/listen_host&gt; çš„æ³¨é‡Šæ‰“å¼€ï¼Œè¿™æ ·çš„è¯æ‰èƒ½è®©ClickHouseè¢«é™¤æœ¬æœºä»¥å¤–çš„æœåŠ¡å™¨è®¿é—® #åˆ†å‘é…ç½®æ–‡ä»¶ xsync /etc/clickhouse-server/config.xml 1.1.8 å¯åŠ¨Server sudo systemctl start clickhouse-server 1.1.9 ä¸‰å°æœºå™¨ä¸Šå…³é—­å¼€æœºè‡ªå¯ systemctl disable clickhouse-server 1.1.10 ä½¿ç”¨clientè¿æ¥server clickhouse-client -m Clickhouseå¸¸ç”¨ç«¯å£å·: ç¬¬2ç«  å‰¯æœ¬ å‰¯æœ¬çš„ç›®çš„ä¸»è¦æ˜¯ä¿éšœæ•°æ®çš„é«˜å¯ç”¨æ€§ï¼Œå³ä½¿ä¸€å°ClickHouseèŠ‚ç‚¹å®•æœºï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥ä»å…¶ä»–æœåŠ¡å™¨è·å¾—ç›¸åŒçš„æ•°æ®ã€‚ 2.1 å‰¯æœ¬å†™å…¥æµç¨‹ 2.2 é…ç½®æ­¥éª¤ Ã˜ å¯åŠ¨zookeeperé›†ç¾¤ Ã˜ æ³¨æ„:æœåŠ¡å™¨çš„hostnameéœ€è¦æ”¹æˆå¯¹åº”çš„ck101ã€ck102ã€ck103 Ã˜ åœ¨/etc/clickhouse-server/config.dç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸ºmetrika.xmlçš„é…ç½®æ–‡ä»¶,å†…å®¹å¦‚ä¸‹ï¼š &lt;?xml version=&quot;1.0&quot;?&gt; &lt;yandex&gt; &lt;zookeeper-servers&gt; &lt;node index=&quot;1&quot;&gt; &lt;host&gt;ck101&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;node index=&quot;2&quot;&gt; &lt;host&gt;ck102&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;node index=&quot;3&quot;&gt; &lt;host&gt;ck103&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;/zookeeper-servers&gt; &lt;/yandex&gt; Ã˜ åŒæ­¥åˆ°å¦å¤–ä¸¤ä¸ªæœºå™¨ä¸Š xsync /etc/clickhouse-server/config.d/metrika.xml Ã˜ åœ¨ /etc/clickhouse-server/config.xmlä¸­å¢åŠ  &lt;zookeeper incl=&quot;zookeeper-servers&quot; optional=&quot;true&quot; /&gt; &lt;include_from&gt;/etc/clickhouse-server/config.d/metrika.xml&lt;/include_from&gt; Ã˜ åŒæ­¥åˆ°å¦å¤–ä¸¤ä¸ªæœºå™¨ä¸Š xsync /etc/clickhouse-server/config.xml Ã˜ åˆ†åˆ«åœ¨å¦å¤–ä¸¤ä¸ªæœºå™¨ä¸Šå¯åŠ¨ClickHouseæœåŠ¡ æ³¨æ„ï¼šå› ä¸ºä¿®æ”¹äº†é…ç½®æ–‡ä»¶ï¼Œå¦‚æœä»¥å‰å¯åŠ¨äº†æœåŠ¡éœ€è¦é‡å¯ systemctl start clickhouse-server Ã˜ åœ¨å¦å¤–ä¸¤ä¸ªæœºå™¨ä¸Šåˆ†åˆ«å»ºè¡¨ å‰¯æœ¬åªèƒ½åŒæ­¥æ•°æ®ï¼Œä¸èƒ½åŒæ­¥è¡¨ç»“æ„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨æ¯å°æœºå™¨ä¸Šè‡ªå·±æ‰‹åŠ¨å»ºè¡¨ Ck101 create table t_order_rep ( id UInt32, sku_id String, total_amount Decimal(16,2), create_time Datetime ) engine =ReplicatedMergeTree('/clickhouse/table/01/t_order_rep','rep_102') partition by toYYYYMMDD(create_time) primary key (id) order by (id,sku_id); Ck102 create table t_order_rep ( id UInt32, sku_id String, total_amount Decimal(16,2), create_time Datetime ) engine =ReplicatedMergeTree('/clickhouse/table/01/t_order_rep','rep_103') partition by toYYYYMMDD(create_time) primary key (id) order by (id,sku_id); å‚æ•°è§£é‡Š ReplicatedMergeTree ä¸­ï¼Œ ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åˆ†ç‰‡çš„zk_pathä¸€èˆ¬æŒ‰ç…§ï¼š /clickhouse/table/{shard}/{table_name} çš„æ ¼å¼å†™ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªåˆ†ç‰‡å°±å†™01å³å¯ã€‚ ç¬¬äºŒä¸ªå‚æ•°æ˜¯å‰¯æœ¬åç§°ï¼Œç›¸åŒçš„åˆ†ç‰‡å‰¯æœ¬åç§°ä¸èƒ½ç›¸åŒã€‚ Ã˜ åœ¨ck101ä¸Šæ‰§è¡Œinsertè¯­å¥ insert into t_order_rep values (101,'sku_001',1000.00,'2020-06-01 12:00:00'), (102,'sku_002',2000.00,'2020-06-01 12:00:00'), (103,'sku_004',2500.00,'2020-06-01 12:00:00'), (104,'sku_002',2000.00,'2020-06-01 12:00:00'), (105,'sku_003',600.00,'2020-06-02 12:00:00'); Ã˜ åœ¨ck102ä¸Šæ‰§è¡Œselectï¼Œå¯ä»¥æŸ¥è¯¢å‡ºç»“æœï¼Œè¯´æ˜å‰¯æœ¬é…ç½®æ­£ç¡® ç¬¬3ç«  åˆ†ç‰‡é›†ç¾¤ å‰¯æœ¬è™½ç„¶èƒ½å¤Ÿæé«˜æ•°æ®çš„å¯ç”¨æ€§ï¼Œé™ä½ä¸¢å¤±é£é™©ï¼Œä½†æ˜¯æ¯å°æœåŠ¡å™¨å®é™…ä¸Šå¿…é¡»å®¹çº³å…¨é‡æ•°æ®ï¼Œå¯¹æ•°æ®çš„æ¨ªå‘æ‰©å®¹æ²¡æœ‰è§£å†³ã€‚ è¦è§£å†³æ•°æ®æ°´å¹³åˆ‡åˆ†çš„é—®é¢˜ï¼Œéœ€è¦å¼•å…¥åˆ†ç‰‡çš„æ¦‚å¿µã€‚é€šè¿‡åˆ†ç‰‡æŠŠä¸€ä»½å®Œæ•´çš„æ•°æ®è¿›è¡Œåˆ‡åˆ†ï¼Œä¸åŒçš„åˆ†ç‰‡åˆ†å¸ƒåˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œå†é€šè¿‡Distributedè¡¨å¼•æ“æŠŠæ•°æ®æ‹¼æ¥èµ·æ¥ä¸€åŒä½¿ç”¨ã€‚ Distributedè¡¨å¼•æ“æœ¬èº«ä¸å­˜å‚¨æ•°æ®ï¼Œæœ‰ç‚¹ç±»ä¼¼äºMyCatä¹‹äºMySqlï¼Œæˆä¸ºä¸€ç§ä¸­é—´ä»¶ï¼Œé€šè¿‡åˆ†å¸ƒå¼é€»è¾‘è¡¨æ¥å†™å…¥ã€åˆ†å‘ã€è·¯ç”±æ¥æ“ä½œå¤šå°èŠ‚ç‚¹ä¸åŒåˆ†ç‰‡çš„åˆ†å¸ƒå¼æ•°æ®ã€‚ æ³¨æ„ï¼šClickHouseçš„é›†ç¾¤æ˜¯è¡¨çº§åˆ«çš„ï¼Œå®é™…ä¼ä¸šä¸­ï¼Œå¤§éƒ¨åˆ†åšäº†é«˜å¯ç”¨ï¼Œä½†æ˜¯æ²¡æœ‰ç”¨åˆ†ç‰‡ï¼Œé¿å…é™ä½æŸ¥è¯¢æ€§èƒ½ä»¥åŠæ“ä½œé›†ç¾¤çš„å¤æ‚æ€§ã€‚ 3.1 é›†ç¾¤å†™å…¥æµç¨‹ï¼ˆ3åˆ†ç‰‡2å‰¯æœ¬å…±6ä¸ªèŠ‚ç‚¹ï¼‰ 3.2 é›†ç¾¤è¯»å–æµç¨‹ï¼ˆ3åˆ†ç‰‡2å‰¯æœ¬å…±6ä¸ªèŠ‚ç‚¹ï¼‰ 3.3 é…ç½®ä¸‰èŠ‚ç‚¹ç‰ˆæœ¬é›†ç¾¤åŠå‰¯æœ¬ 3.3.1 é›†ç¾¤åŠå‰¯æœ¬è§„åˆ’ï¼ˆ2ä¸ªåˆ†ç‰‡ï¼Œåªæœ‰ç¬¬ä¸€ä¸ªåˆ†ç‰‡æœ‰å‰¯æœ¬ï¼‰ ck101 ck102 ck103 01 rep_1_1 01 rep_1_2 02 rep_2_1 3.3.2 é…ç½®æ­¥éª¤ (1) åœ¨ck101çš„/etc/clickhouse-server/config.dç›®å½•ä¸‹åˆ›å»ºmetrika-shard.xmlæ–‡ä»¶ &lt;?xml version=&quot;1.0&quot;?&gt; &lt;yandex&gt; &lt;remote_servers&gt; &lt;my_cluster&gt; &lt;!-- é›†ç¾¤åç§°--&gt; &lt;shard&gt; &lt;!--é›†ç¾¤çš„ç¬¬ä¸€ä¸ªåˆ†ç‰‡--&gt; &lt;internal_replication&gt;true&lt;/internal_replication&gt; &lt;replica&gt; &lt;!--è¯¥åˆ†ç‰‡çš„ç¬¬ä¸€ä¸ªå‰¯æœ¬--&gt; &lt;host&gt;ck101&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;/replica&gt; &lt;replica&gt; &lt;!--è¯¥åˆ†ç‰‡çš„ç¬¬äºŒä¸ªå‰¯æœ¬--&gt; &lt;host&gt;ck102&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;shard&gt; &lt;!--é›†ç¾¤çš„ç¬¬äºŒä¸ªåˆ†ç‰‡--&gt; &lt;internal_replication&gt;true&lt;/internal_replication&gt; &lt;replica&gt; &lt;!--è¯¥åˆ†ç‰‡çš„ç¬¬ä¸€ä¸ªå‰¯æœ¬--&gt; &lt;host&gt;ck103&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;/my_cluster&gt; &lt;/remote_servers&gt; &lt;zookeeper-servers&gt; &lt;node index=&quot;1&quot;&gt; &lt;host&gt; ck101&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;node index=&quot;2&quot;&gt; &lt;host&gt; ck102&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;node index=&quot;3&quot;&gt; &lt;host&gt; ck103&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;/zookeeper-servers&gt; &lt;macros&gt; &lt;shard&gt;01&lt;/shard&gt; &lt;!--ä¸åŒæœºå™¨æ”¾çš„åˆ†ç‰‡æ•°ä¸ä¸€æ ·--&gt; &lt;replica&gt;rep_1_1&lt;/replica&gt; &lt;!--ä¸åŒæœºå™¨æ”¾çš„å‰¯æœ¬æ•°ä¸ä¸€æ ·--&gt; &lt;/macros&gt; &lt;/yandex&gt; (2) å°†ck101çš„metrika-shard.xmlåŒæ­¥åˆ°102å’Œ103 xsync /etc/clickhouse-server/config.d/metrika-shard.xml (3) ä¿®æ”¹102å’Œ103ä¸­metrika-shard.xmlå®çš„é…ç½® Ã˜ 102 vim /etc/clickhouse-server/config.d/metrika-shard.xml Ã˜ 103 vim /etc/clickhouse-server/config.d/metrika-shard.xml (4) åœ¨hadoop102ä¸Šä¿®æ”¹/etc/clickhouse-server/config.xml (5) åŒæ­¥/etc/clickhouse-server/config.xmlåˆ°103å’Œ104 sudo /home/atguigu/bin/xsync /etc/clickhouse-server/config.xml (6) é‡å¯ä¸‰å°æœåŠ¡å™¨ä¸Šçš„ClickHouseæœåŠ¡ systemctl stop clickhouse-server systemctl start clickhouse-server systemctl status clickhouse-server (7) åœ¨ck101ä¸Šæ‰§è¡Œå»ºè¡¨è¯­å¥ Ã˜ ä¼šè‡ªåŠ¨åŒæ­¥åˆ°ck102å’Œck103ä¸Š Ã˜ é›†ç¾¤åå­—è¦å’Œé…ç½®æ–‡ä»¶ä¸­çš„ä¸€è‡´ Ã˜ åˆ†ç‰‡å’Œå‰¯æœ¬åç§°ä»é…ç½®æ–‡ä»¶çš„å®å®šä¹‰ä¸­è·å– create table st_order_mt on cluster my_cluster ( id UInt32, sku_id String, total_amount Decimal(16,2), create_time Datetime ) engine =ReplicatedMergeTree('/clickhouse/tables/{shard}/st_order_mt','{replica}') partition by toYYYYMMDD(create_time) primary key (id) order by (id,sku_id); å¯ä»¥åˆ°ck102å’Œck103ä¸ŠæŸ¥çœ‹è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ (8) åœ¨ck101ä¸Šåˆ›å»ºDistribute åˆ†å¸ƒå¼è¡¨ create table st_order_mt_all on cluster my_cluster ( id UInt32, sku_id String, total_amount Decimal(16,2), create_time Datetime )engine = Distributed(my_cluster,default, st_order_mt,hiveHash(sku_id)); å‚æ•°å«ä¹‰ â€‹ Distributed(é›†ç¾¤åç§°ï¼Œåº“åï¼Œæœ¬åœ°è¡¨åï¼Œåˆ†ç‰‡é”®) åˆ†ç‰‡é”®å¿…é¡»æ˜¯æ•´å‹æ•°å­—ï¼Œæ‰€ä»¥ç”¨hiveHashå‡½æ•°è½¬æ¢ï¼Œä¹Ÿå¯ä»¥rand() (9) åœ¨ck101ä¸Šæ’å…¥æµ‹è¯•æ•°æ® insert into st_order_mt_all values (201,'sku_001',1000.00,'2020-06-01 12:00:00') , (202,'sku_002',2000.00,'2020-06-01 12:00:00'), (203,'sku_004',2500.00,'2020-06-01 12:00:00'), (204,'sku_002',2000.00,'2020-06-01 12:00:00'), (205,'sku_003',600.00,'2020-06-02 12:00:00'); (10) é€šè¿‡æŸ¥è¯¢åˆ†å¸ƒå¼è¡¨å’Œæœ¬åœ°è¡¨è§‚å¯Ÿè¾“å‡ºç»“æœ Ã˜ åˆ†å¸ƒå¼è¡¨ SELECT * FROM st_order_mt_all; Ã˜ æœ¬åœ°è¡¨ select * from st_order_mt; Ã˜ è§‚å¯Ÿæ•°æ®çš„åˆ†å¸ƒ st_order_mt_all Ck101: st_order_mt Ck102: st_order_mt Ck103: st_order_mt ç¬¬4ç«  ç‰ˆæœ¬ä¿¡æ¯ Clickhouse: clickhouse-21.9.4.35 Zookeeper: zookeeper-3.4.6 ","link":"https://tianxiawuhao.github.io/r2VmiGgor/"},{"title":"Kafka æ¶æ„æ·±å…¥","content":"3.1 Kafka å·¥ä½œæµç¨‹åŠæ–‡ä»¶å­˜å‚¨æœºåˆ¶ Kafka ä¸­æ¶ˆæ¯æ˜¯ä»¥ topic è¿›è¡Œåˆ†ç±»çš„ï¼Œ ç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯ï¼Œéƒ½æ˜¯é¢å‘ topic çš„ã€‚ topic æ˜¯é€»è¾‘ä¸Šçš„æ¦‚å¿µï¼Œè€Œ partition æ˜¯ç‰©ç†ä¸Šçš„æ¦‚å¿µï¼Œæ¯ä¸ª partition å¯¹åº”äºä¸€ä¸ª log æ–‡ä»¶ï¼Œè¯¥ log æ–‡ä»¶ä¸­å­˜å‚¨çš„å°±æ˜¯ producer ç”Ÿäº§çš„æ•°æ®ã€‚ Producer ç”Ÿäº§çš„æ•°æ®ä¼šè¢«ä¸æ–­è¿½åŠ åˆ°è¯¥ log æ–‡ä»¶æœ«ç«¯ï¼Œä¸”æ¯æ¡æ•°æ®éƒ½æœ‰è‡ªå·±çš„ offsetã€‚ æ¶ˆè´¹è€…ç»„ä¸­çš„æ¯ä¸ªæ¶ˆè´¹è€…ï¼Œ éƒ½ä¼šå®æ—¶è®°å½•è‡ªå·±æ¶ˆè´¹åˆ°äº†å“ªä¸ª offsetï¼Œä»¥ä¾¿å‡ºé”™æ¢å¤æ—¶ï¼Œä»ä¸Šæ¬¡çš„ä½ç½®ç»§ç»­æ¶ˆè´¹ ã€‚ ç”±äºç”Ÿäº§è€…ç”Ÿäº§çš„æ¶ˆæ¯ä¼šä¸æ–­è¿½åŠ åˆ° log æ–‡ä»¶æœ«å°¾ï¼Œ ä¸ºé˜²æ­¢ log æ–‡ä»¶è¿‡å¤§å¯¼è‡´æ•°æ®å®šä½æ•ˆç‡ä½ä¸‹ï¼Œ Kafka é‡‡å–äº†åˆ†ç‰‡å’Œç´¢å¼•æœºåˆ¶ï¼Œå°†æ¯ä¸ª partition åˆ†ä¸ºå¤šä¸ª segmentã€‚ æ¯ä¸ª segment å¯¹åº”ä¸¤ä¸ªæ–‡ä»¶â€”â€”â€œ.indexâ€æ–‡ä»¶å’Œâ€œ.logâ€æ–‡ä»¶ã€‚ è¿™äº›æ–‡ä»¶ä½äºä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹ï¼Œ è¯¥æ–‡ä»¶å¤¹çš„å‘½åè§„åˆ™ä¸ºï¼š topicåç§°+åˆ†åŒºåºå·ã€‚ä¾‹å¦‚ï¼Œ first è¿™ä¸ª topic æœ‰ä¸‰ä¸ªåˆ†åŒºï¼Œåˆ™å…¶å¯¹åº”çš„æ–‡ä»¶å¤¹ä¸º first-0,first-1,first-2ã€‚ 00000000000000000000.index 00000000000000000000.log 00000000000000170410.index 00000000000000170410.log 00000000000000239430.index 00000000000000239430.log index å’Œ log æ–‡ä»¶ä»¥å½“å‰ segment çš„ç¬¬ä¸€æ¡æ¶ˆæ¯çš„ offset å‘½åã€‚ä¸‹å›¾ä¸º index æ–‡ä»¶å’Œ logæ–‡ä»¶çš„ç»“æ„ç¤ºæ„å›¾ã€‚ â€œ.indexâ€æ–‡ä»¶å­˜å‚¨å¤§é‡çš„ç´¢å¼•ä¿¡æ¯ï¼Œâ€œ.logâ€æ–‡ä»¶å­˜å‚¨å¤§é‡çš„æ•°æ®ï¼Œç´¢å¼•æ–‡ä»¶ä¸­çš„å…ƒæ•°æ®æŒ‡å‘å¯¹åº”æ•°æ®æ–‡ä»¶ä¸­ message çš„ç‰©ç†åç§»åœ°å€ã€‚ 3.2 Kafka ç”Ÿäº§è€… 3.2.1 åˆ†åŒºç­–ç•¥ åˆ†åŒºçš„åŸå›  ï¼ˆ1ï¼‰ æ–¹ä¾¿åœ¨é›†ç¾¤ä¸­æ‰©å±•ï¼Œæ¯ä¸ª Partition å¯ä»¥é€šè¿‡è°ƒæ•´ä»¥é€‚åº”å®ƒæ‰€åœ¨çš„æœºå™¨ï¼Œè€Œä¸€ä¸ª topic åˆå¯ä»¥æœ‰å¤šä¸ª Partition ç»„æˆï¼Œå› æ­¤æ•´ä¸ªé›†ç¾¤å°±å¯ä»¥é€‚åº”ä»»æ„å¤§å°çš„æ•°æ®äº†ï¼› ï¼ˆ2ï¼‰ å¯ä»¥æé«˜å¹¶å‘ï¼Œå› ä¸ºå¯ä»¥ä»¥ Partition ä¸ºå•ä½è¯»å†™äº†ã€‚ åˆ†åŒºçš„åŸåˆ™ æˆ‘ä»¬éœ€è¦å°† producer å‘é€çš„æ•°æ®å°è£…æˆä¸€ä¸ª ProducerRecord å¯¹è±¡ã€‚ ï¼ˆ1ï¼‰ æŒ‡æ˜ partition çš„æƒ…å†µä¸‹ï¼Œç›´æ¥å°†æŒ‡æ˜çš„å€¼ç›´æ¥ä½œä¸º partiton å€¼ï¼› ï¼ˆ2ï¼‰æ²¡æœ‰æŒ‡æ˜ partition å€¼ä½†æœ‰ key çš„æƒ…å†µä¸‹ï¼Œå°† key çš„ hash å€¼ä¸ topic çš„ partition æ•°è¿›è¡Œå–ä½™å¾—åˆ° partition å€¼ï¼› ï¼ˆ3ï¼‰ æ—¢æ²¡æœ‰ partition å€¼åˆæ²¡æœ‰ key å€¼çš„æƒ…å†µä¸‹ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶éšæœºç”Ÿæˆä¸€ä¸ªæ•´æ•°ï¼ˆå é¢æ¯æ¬¡è°ƒç”¨åœ¨è¿™ä¸ªæ•´æ•°ä¸Šè‡ªå¢ï¼‰ï¼Œå°†è¿™ä¸ªå€¼ä¸ topic å¯ç”¨çš„ partition æ€»æ•°å–ä½™å¾—åˆ° partition å€¼ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„ round-robin ç®—æ³•ã€‚ 3.2.2 æ•°æ®å¯é æ€§ä¿è¯ ä¸ºä¿è¯ producer å‘é€çš„æ•°æ®ï¼Œèƒ½å¯é çš„å‘é€åˆ°æŒ‡å®šçš„ topicï¼Œ topic çš„æ¯ä¸ª partition æ”¶åˆ° producer å‘é€çš„æ•°æ®åï¼Œ éƒ½éœ€è¦å‘ producer å‘é€ ackï¼ˆacknowledgement ç¡®è®¤æ”¶åˆ°ï¼‰ ï¼Œå¦‚æœ producer æ”¶åˆ° ackï¼Œ å°±ä¼šè¿›è¡Œä¸‹ä¸€è½®çš„å‘é€ï¼Œå¦åˆ™é‡æ–°å‘é€æ•°æ®ã€‚ 1ï¼‰ å‰¯æœ¬æ•°æ®åŒæ­¥ç­–ç•¥ æ–¹æ¡ˆ ä¼˜ç‚¹ ç¼ºç‚¹ åŠæ•°ä»¥ä¸Šå®ŒæˆåŒæ­¥ï¼Œ å°±å‘ é€ ack å»¶è¿Ÿä½ é€‰ä¸¾æ–°çš„ leader æ—¶ï¼Œ å®¹å¿ n å° èŠ‚ç‚¹çš„æ•…éšœï¼Œéœ€è¦ 2n+1 ä¸ªå‰¯ æœ¬ å…¨éƒ¨å®ŒæˆåŒæ­¥ï¼Œæ‰å‘é€ ack é€‰ä¸¾æ–°çš„ leader æ—¶ï¼Œ å®¹å¿ n å° èŠ‚ç‚¹çš„æ•…éšœï¼Œéœ€è¦ n+1 ä¸ªå‰¯ æœ¬ å»¶è¿Ÿé«˜ Kafka é€‰æ‹©äº†ç¬¬äºŒç§æ–¹æ¡ˆï¼ŒåŸå› å¦‚ä¸‹ï¼š åŒæ ·ä¸ºäº†å®¹å¿ n å°èŠ‚ç‚¹çš„æ•…éšœï¼Œç¬¬ä¸€ç§æ–¹æ¡ˆéœ€è¦ 2n+1 ä¸ªå‰¯æœ¬ï¼Œè€Œç¬¬äºŒç§æ–¹æ¡ˆåªéœ€è¦ n+1 ä¸ªå‰¯æœ¬ï¼Œè€Œ Kafka çš„æ¯ä¸ªåˆ†åŒºéƒ½æœ‰å¤§é‡çš„æ•°æ®ï¼Œ ç¬¬ä¸€ç§æ–¹æ¡ˆä¼šé€ æˆå¤§é‡æ•°æ®çš„å†—ä½™ã€‚ è™½ç„¶ç¬¬äºŒç§æ–¹æ¡ˆçš„ç½‘ç»œå»¶è¿Ÿä¼šæ¯”è¾ƒé«˜ï¼Œä½†ç½‘ç»œå»¶è¿Ÿå¯¹ Kafka çš„å½±å“è¾ƒå°ã€‚ 2ï¼‰ ISR é‡‡ç”¨ç¬¬äºŒç§æ–¹æ¡ˆä¹‹åï¼Œè®¾æƒ³ä»¥ä¸‹æƒ…æ™¯ï¼š leader æ”¶åˆ°æ•°æ®ï¼Œæ‰€æœ‰ follower éƒ½å¼€å§‹åŒæ­¥æ•°æ®ï¼Œ ä½†æœ‰ä¸€ä¸ª followerï¼Œå› ä¸ºæŸç§æ•…éšœï¼Œè¿Ÿè¿Ÿä¸èƒ½ä¸ leader è¿›è¡ŒåŒæ­¥ï¼Œé‚£ leader å°±è¦ä¸€ç›´ç­‰ä¸‹å»ï¼Œ ç›´åˆ°å®ƒå®ŒæˆåŒæ­¥ï¼Œæ‰èƒ½å‘é€ ackã€‚è¿™ä¸ªé—®é¢˜æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ Leader ç»´æŠ¤äº†ä¸€ä¸ªåŠ¨æ€çš„ in-sync replica set (ISR)ï¼Œæ„ä¸ºå’Œ leader ä¿æŒåŒæ­¥çš„ follower é›† åˆã€‚å½“ ISR ä¸­çš„ follower å®Œæˆæ•°æ®çš„åŒæ­¥ä¹‹åï¼Œ leader å°±ä¼šç»™ follower å‘é€ ackã€‚å¦‚æœ follower é•¿ æ—¶ é—´ æœª å‘ leader åŒ æ­¥ æ•° æ® ï¼Œ åˆ™ è¯¥ follower å°† è¢« è¸¢ å‡º ISR ï¼Œ è¯¥ æ—¶ é—´ é˜ˆ å€¼ ç”±replica.lag.time.max.ms å‚æ•°è®¾å®šã€‚ Leader å‘ç”Ÿæ•…éšœä¹‹åï¼Œå°±ä¼šä» ISR ä¸­é€‰ä¸¾æ–°çš„ leaderã€‚ 3ï¼‰ ack åº”ç­”æœºåˆ¶ å¯¹äºæŸäº›ä¸å¤ªé‡è¦çš„æ•°æ®ï¼Œå¯¹æ•°æ®çš„å¯é æ€§è¦æ±‚ä¸æ˜¯å¾ˆé«˜ï¼Œèƒ½å¤Ÿå®¹å¿æ•°æ®çš„å°‘é‡ä¸¢å¤±ï¼Œ æ‰€ä»¥æ²¡å¿…è¦ç­‰ ISR ä¸­çš„ follower å…¨éƒ¨æ¥æ”¶æˆåŠŸã€‚ æ‰€ä»¥ Kafka ä¸ºç”¨æˆ·æä¾›äº†ä¸‰ç§å¯é æ€§çº§åˆ«ï¼Œç”¨æˆ·æ ¹æ®å¯¹å¯é æ€§å’Œå»¶è¿Ÿçš„è¦æ±‚è¿›è¡Œæƒè¡¡ï¼Œ é€‰æ‹©ä»¥ä¸‹çš„é…ç½®ã€‚ acks å‚æ•°é…ç½®ï¼š acksï¼š 0ï¼š producer ä¸ç­‰å¾… broker çš„ ackï¼Œè¿™ä¸€æ“ä½œæä¾›äº†ä¸€ä¸ªæœ€ä½çš„å»¶è¿Ÿï¼Œ broker ä¸€æ¥æ”¶åˆ°è¿˜ æ²¡æœ‰å†™å…¥ç£ç›˜å°±å·²ç»è¿”å›ï¼Œå½“ broker æ•…éšœæ—¶æœ‰å¯èƒ½ä¸¢å¤±æ•°æ®ï¼› 1ï¼š producer ç­‰å¾… broker çš„ ackï¼Œ partition çš„ leader è½ç›˜æˆåŠŸåè¿”å› ackï¼Œå¦‚æœåœ¨ follower åŒæ­¥æˆåŠŸä¹‹å‰ leader æ•…éšœï¼Œé‚£ä¹ˆå°†ä¼šä¸¢å¤±æ•°æ®ï¼› -1ï¼ˆallï¼‰ ï¼š producer ç­‰å¾… broker çš„ ackï¼Œ partition çš„ leader å’Œ follower å…¨éƒ¨è½ç›˜æˆåŠŸåæ‰ è¿”å› ackã€‚ä½†æ˜¯å¦‚æœåœ¨ follower åŒæ­¥å®Œæˆåï¼Œ broker å‘é€ ack ä¹‹å‰ï¼Œ leader å‘ç”Ÿæ•…éšœï¼Œé‚£ä¹ˆä¼š é€ æˆæ•°æ®é‡å¤ã€‚ 4ï¼‰ æ•…éšœå¤„ç†ç»†èŠ‚ LEOï¼šæŒ‡çš„æ˜¯æ¯ä¸ªå‰¯æœ¬æœ€å¤§çš„ offsetï¼› HWï¼šæŒ‡çš„æ˜¯æ¶ˆè´¹è€…èƒ½è§åˆ°çš„æœ€å¤§çš„ offsetï¼Œ ISR é˜Ÿåˆ—ä¸­æœ€å°çš„ LEOã€‚ ï¼ˆ1ï¼‰ follower æ•…éšœ follower å‘ç”Ÿæ•…éšœåä¼šè¢«ä¸´æ—¶è¸¢å‡º ISRï¼Œå¾…è¯¥ follower æ¢å¤åï¼Œ follower ä¼šè¯»å–æœ¬åœ°ç£ç›˜è®°å½•çš„ä¸Šæ¬¡çš„ HWï¼Œå¹¶å°† log æ–‡ä»¶é«˜äº HW çš„éƒ¨åˆ†æˆªå–æ‰ï¼Œä» HW å¼€å§‹å‘ leader è¿›è¡ŒåŒæ­¥ã€‚ç­‰è¯¥ follower çš„ LEO å¤§äºç­‰äºè¯¥ Partition çš„ HWï¼Œå³ follower è¿½ä¸Š leader ä¹‹åï¼Œå°±å¯ä»¥é‡æ–°åŠ å…¥ ISR äº†ã€‚ ï¼ˆ2ï¼‰ leader æ•…éšœ leader å‘ç”Ÿæ•…éšœä¹‹åï¼Œä¼šä» ISR ä¸­é€‰å‡ºä¸€ä¸ªæ–°çš„ leaderï¼Œä¹‹åï¼Œä¸ºä¿è¯å¤šä¸ªå‰¯æœ¬ä¹‹é—´çš„ æ•°æ®ä¸€è‡´æ€§ï¼Œ å…¶ä½™çš„ follower ä¼šå…ˆå°†å„è‡ªçš„ log æ–‡ä»¶é«˜äº HW çš„éƒ¨åˆ†æˆªæ‰ï¼Œç„¶åä»æ–°çš„ leaderåŒæ­¥æ•°æ®ã€‚ æ³¨æ„ï¼š è¿™åªèƒ½ä¿è¯å‰¯æœ¬ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ï¼Œå¹¶ä¸èƒ½ä¿è¯æ•°æ®ä¸ä¸¢å¤±æˆ–è€…ä¸é‡å¤ã€‚ 3.2.3 Exactly Once è¯­ä¹‰ å°†æœåŠ¡å™¨çš„ ACK çº§åˆ«è®¾ç½®ä¸º-1ï¼Œå¯ä»¥ä¿è¯ Producer åˆ° Server ä¹‹é—´ä¸ä¼šä¸¢å¤±æ•°æ®ï¼Œå³ At Least Once è¯­ä¹‰ã€‚ç›¸å¯¹çš„ï¼Œå°†æœåŠ¡å™¨ ACK çº§åˆ«è®¾ç½®ä¸º 0ï¼Œå¯ä»¥ä¿è¯ç”Ÿäº§è€…æ¯æ¡æ¶ˆæ¯åªä¼šè¢« å‘é€ä¸€æ¬¡ï¼Œå³ At Most Once è¯­ä¹‰ã€‚ At Least Once å¯ä»¥ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œä½†æ˜¯ä¸èƒ½ä¿è¯æ•°æ®ä¸é‡å¤ï¼›ç›¸å¯¹çš„ï¼Œ At Most Once å¯ä»¥ä¿è¯æ•°æ®ä¸é‡å¤ï¼Œä½†æ˜¯ä¸èƒ½ä¿è¯æ•°æ®ä¸ä¸¢å¤±ã€‚ ä½†æ˜¯ï¼Œå¯¹äºä¸€äº›éå¸¸é‡è¦çš„ä¿¡æ¯ï¼Œæ¯”å¦‚è¯´ äº¤æ˜“æ•°æ®ï¼Œä¸‹æ¸¸æ•°æ®æ¶ˆè´¹è€…è¦æ±‚æ•°æ®æ—¢ä¸é‡å¤ä¹Ÿä¸ä¸¢å¤±ï¼Œå³ Exactly Once è¯­ä¹‰ã€‚ åœ¨ 0.11 ç‰ˆ æœ¬ä»¥å‰çš„ Kafkaï¼Œå¯¹æ­¤æ˜¯æ— èƒ½ä¸ºåŠ›çš„ï¼Œåªèƒ½ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œå†åœ¨ä¸‹æ¸¸æ¶ˆè´¹è€…å¯¹æ•°æ®åšå…¨å±€ å»é‡ã€‚å¯¹äºå¤šä¸ªä¸‹æ¸¸åº”ç”¨çš„æƒ…å†µï¼Œæ¯ä¸ªéƒ½éœ€è¦å•ç‹¬åšå…¨å±€å»é‡ï¼Œè¿™å°±å¯¹æ€§èƒ½é€ æˆäº†å¾ˆå¤§å½±å“ã€‚ 0.11 ç‰ˆæœ¬çš„ Kafkaï¼Œå¼•å…¥äº†ä¸€é¡¹é‡å¤§ç‰¹æ€§ï¼šå¹‚ç­‰æ€§ã€‚æ‰€è°“çš„å¹‚ç­‰æ€§å°±æ˜¯æŒ‡ Producer ä¸è®ºå‘ Server å‘é€å¤šå°‘æ¬¡é‡å¤æ•°æ®ï¼Œ Server ç«¯éƒ½åªä¼šæŒä¹…åŒ–ä¸€æ¡ã€‚å¹‚ç­‰æ€§ç»“åˆ At Least Once è¯­ä¹‰ï¼Œå°±æ„æˆäº† Kafka çš„ Exactly Once è¯­ä¹‰ã€‚å³ï¼š At Least Once + å¹‚ç­‰æ€§ = Exactly Once è¦å¯ç”¨å¹‚ç­‰æ€§ï¼Œåªéœ€è¦å°† Producer çš„å‚æ•°ä¸­ enable.idompotence è®¾ç½®ä¸º true å³å¯ã€‚ Kafka çš„å¹‚ç­‰æ€§å®ç°å…¶å®å°±æ˜¯å°†åŸæ¥ä¸‹æ¸¸éœ€è¦åšçš„å»é‡æ”¾åœ¨äº†æ•°æ®ä¸Šæ¸¸ã€‚å¼€å¯å¹‚ç­‰æ€§çš„ Producer åœ¨ åˆå§‹åŒ–çš„æ—¶å€™ä¼šè¢«åˆ†é…ä¸€ä¸ª PIDï¼Œå‘å¾€åŒä¸€ Partition çš„æ¶ˆæ¯ä¼šé™„å¸¦ Sequence Numberã€‚è€Œ Broker ç«¯ä¼šå¯¹&lt;PID, Partition, SeqNumber&gt;åšç¼“å­˜ï¼Œå½“å…·æœ‰ç›¸åŒä¸»é”®çš„æ¶ˆæ¯æäº¤æ—¶ï¼Œ Broker åª ä¼šæŒä¹…åŒ–ä¸€æ¡ã€‚ ä½†æ˜¯ PID é‡å¯å°±ä¼šå˜åŒ–ï¼ŒåŒæ—¶ä¸åŒçš„ Partition ä¹Ÿå…·æœ‰ä¸åŒä¸»é”®ï¼Œæ‰€ä»¥å¹‚ç­‰æ€§æ— æ³•ä¿è¯è·¨ åˆ†åŒºè·¨ä¼šè¯çš„ Exactly Onceã€‚ 3.3 Kafka æ¶ˆè´¹è€… 3.3.1 æ¶ˆè´¹æ–¹å¼ consumer é‡‡ç”¨ pullï¼ˆæ‹‰ï¼‰ æ¨¡å¼ä» broker ä¸­è¯»å–æ•°æ®ã€‚ pushï¼ˆæ¨ï¼‰æ¨¡å¼å¾ˆéš¾é€‚åº”æ¶ˆè´¹é€Ÿç‡ä¸åŒçš„æ¶ˆè´¹è€…ï¼Œå› ä¸ºæ¶ˆæ¯å‘é€é€Ÿç‡æ˜¯ç”± broker å†³å®šçš„ã€‚ å®ƒçš„ç›®æ ‡æ˜¯å°½å¯èƒ½ä»¥æœ€å¿«é€Ÿåº¦ä¼ é€’æ¶ˆæ¯ï¼Œä½†æ˜¯è¿™æ ·å¾ˆå®¹æ˜“é€ æˆ consumer æ¥ä¸åŠå¤„ç†æ¶ˆæ¯ï¼Œ å…¸å‹çš„è¡¨ç°å°±æ˜¯æ‹’ç»æœåŠ¡ä»¥åŠç½‘ç»œæ‹¥å¡ã€‚è€Œ pull æ¨¡å¼åˆ™å¯ä»¥æ ¹æ® consumer çš„æ¶ˆè´¹èƒ½åŠ›ä»¥é€‚ å½“çš„é€Ÿç‡æ¶ˆè´¹æ¶ˆæ¯ã€‚ pull æ¨¡å¼ä¸è¶³ä¹‹å¤„æ˜¯ï¼Œå¦‚æœ kafka æ²¡æœ‰æ•°æ®ï¼Œæ¶ˆè´¹è€…å¯èƒ½ä¼šé™·å…¥å¾ªç¯ä¸­ï¼Œ ä¸€ç›´è¿”å›ç©ºæ•° æ®ã€‚ é’ˆå¯¹è¿™ä¸€ç‚¹ï¼Œ Kafka çš„æ¶ˆè´¹è€…åœ¨æ¶ˆè´¹æ•°æ®æ—¶ä¼šä¼ å…¥ä¸€ä¸ªæ—¶é•¿å‚æ•° timeoutï¼Œå¦‚æœå½“å‰æ²¡æœ‰ æ•°æ®å¯ä¾›æ¶ˆè´¹ï¼Œ consumer ä¼šç­‰å¾…ä¸€æ®µæ—¶é—´ä¹‹åå†è¿”å›ï¼Œè¿™æ®µæ—¶é•¿å³ä¸º timeoutã€‚ 3.3.2 åˆ†åŒºåˆ†é…ç­–ç•¥ ä¸€ä¸ª consumer group ä¸­æœ‰å¤šä¸ª consumerï¼Œä¸€ä¸ª topic æœ‰å¤šä¸ª partitionï¼Œæ‰€ä»¥å¿…ç„¶ä¼šæ¶‰åŠ åˆ° partition çš„åˆ†é…é—®é¢˜ï¼Œå³ç¡®å®šé‚£ä¸ª partition ç”±å“ªä¸ª consumer æ¥æ¶ˆè´¹ã€‚ Kafka æœ‰ä¸¤ç§åˆ†é…ç­–ç•¥ï¼Œä¸€æ˜¯ RoundRobinï¼Œä¸€æ˜¯ Rangeã€‚ å½“æ¶ˆè´¹è€…ä¸ªæ•°æ”¹å˜æ—¶ï¼Œä¼šç”¨åˆ°åˆ†åŒºåˆ†é…ç­–ç•¥ 1ï¼‰ RoundRobin RoundRobinAssignorç­–ç•¥çš„åŸç†æ˜¯å°†æ¶ˆè´¹ç»„å†…æ‰€æœ‰æ¶ˆè´¹è€…ä»¥åŠæ¶ˆè´¹è€…æ‰€è®¢é˜…çš„æ‰€æœ‰topicçš„partitionæŒ‰ç…§å­—å…¸åºæ’åºï¼Œç„¶åé€šè¿‡è½®è¯¢æ–¹å¼é€ä¸ªå°†åˆ†åŒºä»¥æ­¤åˆ†é…ç»™æ¯ä¸ªæ¶ˆè´¹è€…ã€‚RoundRobinAssignorç­–ç•¥å¯¹åº”çš„partition.assignment.strategyå‚æ•°å€¼ä¸ºï¼šorg.apache.kafka.clients.consumer.RoundRobinAssignorã€‚ ä½¿ç”¨RoundRobinç­–ç•¥æœ‰ä¸¤ä¸ªå‰ææ¡ä»¶å¿…é¡»æ»¡è¶³ï¼š åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„é‡Œé¢çš„æ‰€æœ‰æ¶ˆè´¹è€…çš„num.streamsï¼ˆæ¶ˆè´¹è€…æ¶ˆè´¹çº¿ç¨‹æ•°ï¼‰å¿…é¡»ç›¸ç­‰ï¼› æ¯ä¸ªæ¶ˆè´¹è€…è®¢é˜…çš„ä¸»é¢˜å¿…é¡»ç›¸åŒã€‚ æ‰€ä»¥è¿™é‡Œå‡è®¾å‰é¢æåˆ°çš„2ä¸ªæ¶ˆè´¹è€…çš„num.streams = 2ã€‚RoundRobinç­–ç•¥çš„å·¥ä½œåŸç†ï¼šå°†æ‰€æœ‰ä¸»é¢˜çš„åˆ†åŒºç»„æˆ TopicAndPartition åˆ—è¡¨ï¼Œç„¶åå¯¹ TopicAndPartition åˆ—è¡¨æŒ‰ç…§ hashCode è¿›è¡Œæ’åº,åœ¨æˆ‘ä»¬çš„ä¾‹å­é‡Œé¢ï¼ŒæŒ‰ç…§ hashCode æ’åºå®Œçš„topic-partitionsç»„ä¾æ¬¡ä¸ºT1-5, T1-3, T1-0, T1-8, T1-2, T1-1, T1-4, T1-7, T1-6, T1-9ï¼Œæˆ‘ä»¬çš„æ¶ˆè´¹è€…çº¿ç¨‹æ’åºä¸ºC1-0, C1-1, C2-0, C2-1ï¼Œæœ€ååˆ†åŒºåˆ†é…çš„ç»“æœä¸ºï¼š C1-0 å°†æ¶ˆè´¹ T1-5, T1-2, T1-6 åˆ†åŒºï¼› C1-1 å°†æ¶ˆè´¹ T1-3, T1-1, T1-9 åˆ†åŒºï¼› C2-0 å°†æ¶ˆè´¹ T1-0, T1-4 åˆ†åŒºï¼› C2-1 å°†æ¶ˆè´¹ T1-8, T1-7 åˆ†åŒºï¼› 2ï¼‰ Rangeï¼ˆé»˜è®¤ç­–ç•¥ï¼‰ Rangeæ˜¯å¯¹æ¯ä¸ªTopicè€Œè¨€çš„ï¼ˆå³ä¸€ä¸ªTopicä¸€ä¸ªTopicåˆ†ï¼‰ï¼Œé¦–å…ˆå¯¹åŒä¸€ä¸ªTopicé‡Œé¢çš„åˆ†åŒºæŒ‰ç…§åºå·è¿›è¡Œæ’åºï¼Œå¹¶å¯¹æ¶ˆè´¹è€…æŒ‰ç…§å­—æ¯é¡ºåºè¿›è¡Œæ’åºã€‚ç„¶åç”¨Partitionsåˆ†åŒºçš„ä¸ªæ•°é™¤ä»¥æ¶ˆè´¹è€…çº¿ç¨‹çš„æ€»æ•°æ¥å†³å®šæ¯ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹æ¶ˆè´¹å‡ ä¸ªåˆ†åŒºã€‚å¦‚æœé™¤ä¸å°½ï¼Œé‚£ä¹ˆå‰é¢å‡ ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹å°†ä¼šå¤šæ¶ˆè´¹ä¸€ä¸ªåˆ†åŒºã€‚ å‡è®¾n=åˆ†åŒºæ•°/æ¶ˆè´¹è€…æ•°é‡ï¼Œm=åˆ†åŒºæ•°%æ¶ˆè´¹è€…æ•°é‡ï¼Œé‚£ä¹ˆå‰mä¸ªæ¶ˆè´¹è€…æ¯ä¸ªåˆ†é…n+1ä¸ªåˆ†åŒºï¼Œåé¢çš„ï¼ˆæ¶ˆè´¹è€…æ•°é‡-mï¼‰ä¸ªæ¶ˆè´¹è€…æ¯ä¸ªåˆ†é…nä¸ªåˆ†åŒºã€‚ å‡å¦‚æœ‰10ä¸ªåˆ†åŒºï¼Œ3ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹ï¼ŒæŠŠåˆ†åŒºæŒ‰ç…§åºå·æ’åˆ—0ï¼Œ1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ5ï¼Œ6ï¼Œ7ï¼Œ8ï¼Œ9ï¼›æ¶ˆè´¹è€…çº¿ç¨‹ä¸ºC1-0ï¼ŒC2-0ï¼ŒC2-1ï¼Œé‚£ä¹ˆç”¨partitionæ•°é™¤ä»¥æ¶ˆè´¹è€…çº¿ç¨‹çš„æ€»æ•°æ¥å†³å®šæ¯ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹æ¶ˆè´¹å‡ ä¸ªpartitionï¼Œå¦‚æœé™¤ä¸å°½ï¼Œå‰é¢å‡ ä¸ªæ¶ˆè´¹è€…å°†ä¼šå¤šæ¶ˆè´¹ä¸€ä¸ªåˆ†åŒºã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­é‡Œé¢ï¼Œæˆ‘ä»¬æœ‰10ä¸ªåˆ†åŒºï¼Œ3ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹ï¼Œ10/3 = 3ï¼Œè€Œä¸”é™¤é™¤ä¸å°½ï¼Œé‚£ä¹ˆæ¶ˆè´¹è€…çº¿ç¨‹C1-0å°†ä¼šå¤šæ¶ˆè´¹ä¸€ä¸ªåˆ†åŒºï¼Œæ‰€ä»¥æœ€ååˆ†åŒºåˆ†é…çš„ç»“æœçœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š C1-0ï¼š0ï¼Œ1ï¼Œ2ï¼Œ3 C2-0ï¼š4ï¼Œ5ï¼Œ6 C2-1ï¼š7ï¼Œ8ï¼Œ9 3.3.3 offset çš„ç»´æŠ¤ ç”±äº consumer åœ¨æ¶ˆè´¹è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡ºç°æ–­ç”µå®•æœºç­‰æ•…éšœï¼Œ consumer æ¢å¤åï¼Œéœ€è¦ä»æ•… éšœå‰çš„ä½ç½®çš„ç»§ç»­æ¶ˆè´¹ï¼Œæ‰€ä»¥ consumer éœ€è¦å®æ—¶è®°å½•è‡ªå·±æ¶ˆè´¹åˆ°äº†å“ªä¸ª offsetï¼Œä»¥ä¾¿æ•…éšœæ¢ å¤åç»§ç»­æ¶ˆè´¹ã€‚ Kafka 0.9 ç‰ˆæœ¬ä¹‹å‰ï¼Œ consumer é»˜è®¤å°† offset ä¿å­˜åœ¨ Zookeeper ä¸­ï¼Œä» 0.9 ç‰ˆæœ¬å¼€å§‹ï¼Œ consumer é»˜è®¤å°† offset ä¿å­˜åœ¨ Kafka ä¸€ä¸ªå†…ç½®çš„ topic ä¸­ï¼Œè¯¥ topic ä¸º__consumer_offsetsã€‚ 1ï¼‰ä¿®æ”¹é…ç½®æ–‡ä»¶ consumer.properties exclude.internal.topics=false 2ï¼‰è¯»å– offset 0.11.0.0 ä¹‹å‰ç‰ˆæœ¬: bin/kafka-console-consumer.sh --topic __consumer_offsets --zookeeper hadoop102:2181 --formatter &quot;kafka.coordinator.GroupMetadataManager\\$OffsetsMessageFormatter&quot; --consumer.config config/consumer.properties --from-beginning 0.11.0.0 ä¹‹åç‰ˆæœ¬(å«): bin/kafka-console-consumer.sh --topic __consumer_offsets -- zookeeper hadoop102:2181 --formatter &quot;kafka.coordinator.group.GroupMetadataManager\\$OffsetsMessageForm atter&quot; --consumer.config config/consumer.properties --frombeginning 3.3.4 æ¶ˆè´¹è€…ç»„æ¡ˆä¾‹ 1ï¼‰ éœ€æ±‚ï¼šæµ‹è¯•åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸­çš„æ¶ˆè´¹è€…ï¼Œ åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ã€‚ 2ï¼‰ æ¡ˆä¾‹å®æ“ ï¼ˆ1ï¼‰åœ¨ hadoop102ã€ hadoop103 ä¸Šä¿®æ”¹/opt/module/kafka/config/consumer.properties é…ç½® æ–‡ä»¶ä¸­çš„ group.id å±æ€§ä¸ºä»»æ„ç»„åã€‚ [atguigu@hadoop103 config]$ vi consumer.properties group.id=atguigu ï¼ˆ2ï¼‰åœ¨ hadoop102ã€ hadoop103 ä¸Šåˆ†åˆ«å¯åŠ¨æ¶ˆè´¹è€… [atguigu@hadoop102 kafka]$ bin/kafka-console-consumer.sh \\ --zookeeper hadoop102:2181 --topic first --consumer.config config/consumer.properties [atguigu@hadoop103 kafka]$ bin/kafka-console-consumer.sh --bootstrap-server hadoop102:9092 --topic first --consumer.config config/consumer.properties ï¼ˆ3ï¼‰åœ¨ hadoop104 ä¸Šå¯åŠ¨ç”Ÿäº§è€… [atguigu@hadoop104 kafka]$ bin/kafka-console-producer.sh \\ --broker-list hadoop102:9092 --topic first &gt;hello world ï¼ˆ4ï¼‰æŸ¥çœ‹ hadoop102 å’Œ hadoop103 çš„æ¥æ”¶è€…ã€‚ åŒä¸€æ—¶åˆ»æ¶ˆè´¹ç»„å†…åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯ã€‚ 3.4 Kafka é«˜æ•ˆè¯»å†™æ•°æ® 1ï¼‰é¡ºåºå†™ç£ç›˜ Kafka çš„ producer ç”Ÿäº§æ•°æ®ï¼Œè¦å†™å…¥åˆ° log æ–‡ä»¶ä¸­ï¼Œå†™çš„è¿‡ç¨‹æ˜¯ä¸€ç›´è¿½åŠ åˆ°æ–‡ä»¶æœ«ç«¯ï¼Œ ä¸ºé¡ºåºå†™ã€‚ å®˜ç½‘æœ‰æ•°æ®è¡¨æ˜ï¼ŒåŒæ ·çš„ç£ç›˜ï¼Œé¡ºåºå†™èƒ½åˆ° 600M/sï¼Œè€Œéšæœºå†™åªæœ‰ 100K/sã€‚è¿™ ä¸ç£ç›˜çš„æœºæ¢°æœºæ„æœ‰å…³ï¼Œé¡ºåºå†™ä¹‹æ‰€ä»¥å¿«ï¼Œæ˜¯å› ä¸ºå…¶çœå»äº†å¤§é‡ç£å¤´å¯»å€çš„æ—¶é—´ã€‚ 2ï¼‰é›¶å¤åˆ¶æŠ€æœ¯ 3ï¼‰åˆ†å¸ƒå¼ 3.5 Zookeeper åœ¨ Kafka ä¸­çš„ä½œç”¨ Kafka é›†ç¾¤ä¸­æœ‰ä¸€ä¸ª broker ä¼šè¢«é€‰ä¸¾ä¸º Controllerï¼Œè´Ÿè´£ç®¡ç†é›†ç¾¤ broker çš„ä¸Šä¸‹çº¿ï¼Œæ‰€æœ‰ topic çš„åˆ†åŒºå‰¯æœ¬åˆ†é…å’Œ leader é€‰ä¸¾ç­‰å·¥ä½œã€‚Controller çš„ç®¡ç†å·¥ä½œéƒ½æ˜¯ä¾èµ–äº Zookeeper çš„ã€‚ ä»¥ä¸‹ä¸º partition çš„ leader é€‰ä¸¾è¿‡ç¨‹ï¼š 3.6 Kafka äº‹åŠ¡ Kafka ä» 0.11 ç‰ˆæœ¬å¼€å§‹å¼•å…¥äº†äº‹åŠ¡æ”¯æŒã€‚äº‹åŠ¡å¯ä»¥ä¿è¯ Kafka åœ¨ Exactly Once è¯­ä¹‰çš„åŸº ç¡€ä¸Šï¼Œç”Ÿäº§å’Œæ¶ˆè´¹å¯ä»¥è·¨åˆ†åŒºå’Œä¼šè¯ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚ 3.6.1 Producer äº‹åŠ¡ ä¸ºäº†å®ç°è·¨åˆ†åŒºè·¨ä¼šè¯çš„äº‹åŠ¡ï¼Œéœ€è¦å¼•å…¥ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ Transaction IDï¼Œå¹¶å°† Producer è·å¾—çš„PID å’ŒTransaction ID ç»‘å®šã€‚è¿™æ ·å½“Producer é‡å¯åå°±å¯ä»¥é€šè¿‡æ­£åœ¨è¿›è¡Œçš„ Transaction ID è·å¾—åŸæ¥çš„ PIDã€‚ ä¸ºäº†ç®¡ç† Transactionï¼Œ Kafka å¼•å…¥äº†ä¸€ä¸ªæ–°çš„ç»„ä»¶ Transaction Coordinatorã€‚ Producer å°±æ˜¯é€šè¿‡å’Œ Transaction Coordinator äº¤äº’è·å¾— Transaction ID å¯¹åº”çš„ä»»åŠ¡çŠ¶æ€ã€‚ Transaction Coordinator è¿˜è´Ÿè´£å°†äº‹åŠ¡æ‰€æœ‰å†™å…¥ Kafka çš„ä¸€ä¸ªå†…éƒ¨ Topicï¼Œè¿™æ ·å³ä½¿æ•´ä¸ªæœåŠ¡é‡å¯ï¼Œç”±äºäº‹åŠ¡çŠ¶æ€å¾—åˆ°ä¿å­˜ï¼Œè¿›è¡Œä¸­çš„äº‹åŠ¡çŠ¶æ€å¯ä»¥å¾—åˆ°æ¢å¤ï¼Œä»è€Œç»§ç»­è¿›è¡Œã€‚ 3.6.2 Consumer äº‹åŠ¡ ä¸Šè¿°äº‹åŠ¡æœºåˆ¶ä¸»è¦æ˜¯ä» Producer æ–¹é¢è€ƒè™‘ï¼Œå¯¹äº Consumer è€Œè¨€ï¼Œäº‹åŠ¡çš„ä¿è¯å°±ä¼šç›¸å¯¹ è¾ƒå¼±ï¼Œå°¤å…¶æ—¶æ— æ³•ä¿è¯ Commit çš„ä¿¡æ¯è¢«ç²¾ç¡®æ¶ˆè´¹ã€‚è¿™æ˜¯ç”±äº Consumer å¯ä»¥é€šè¿‡ offset è®¿ é—®ä»»æ„ä¿¡æ¯ï¼Œè€Œä¸”ä¸åŒçš„ Segment File ç”Ÿå‘½å‘¨æœŸä¸åŒï¼ŒåŒä¸€äº‹åŠ¡çš„æ¶ˆæ¯å¯èƒ½ä¼šå‡ºç°é‡å¯åè¢« åˆ é™¤çš„æƒ…å†µã€‚ ","link":"https://tianxiawuhao.github.io/KM-0yw6ab/"},{"title":"kafkaå¸¸ç”¨å‘½ä»¤","content":"ç®¡ç† ## åˆ›å»ºtopicï¼ˆ4ä¸ªåˆ†åŒºï¼Œ2ä¸ªå‰¯æœ¬ï¼‰ bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 2 --partitions 4 --topic test ### kafkaç‰ˆæœ¬ &gt;= 2.2 bin/kafka-topics.sh --create --bootstrap-server localhost:9092 --replication-factor 1 --partitions 1 --topic test ## åˆ†åŒºæ‰©å®¹ ### kafkaç‰ˆæœ¬ &lt; 2.2 bin/kafka-topics.sh --zookeeper localhost:2181 --alter --topic topic1 --partitions 2 ### kafkaç‰ˆæœ¬ &gt;= 2.2 bin/kafka-topics.sh --bootstrap-server broker_host:port --alter --topic topic1 --partitions 2 ## åˆ é™¤topic bin/kafka-topics.sh --zookeeper localhost:2181 --delete --topic test æŸ¥è¯¢ ## æŸ¥è¯¢é›†ç¾¤æè¿° bin/kafka-topics.sh --describe --zookeeper 127.0.0.1:2181 ## æŸ¥è¯¢é›†ç¾¤æè¿°ï¼ˆæ–°ï¼‰ bin/kafka-topics.sh --bootstrap-server localhost:9092 --topic foo --describe ## topicåˆ—è¡¨æŸ¥è¯¢ bin/kafka-topics.sh --zookeeper 127.0.0.1:2181 --list ## topicåˆ—è¡¨æŸ¥è¯¢ï¼ˆæ”¯æŒ0.9ç‰ˆæœ¬+ï¼‰ bin/kafka-topics.sh --list --bootstrap-server localhost:9092 ## æ¶ˆè´¹è€…åˆ—è¡¨æŸ¥è¯¢ï¼ˆå­˜å‚¨åœ¨zkä¸­çš„ï¼‰ bin/kafka-consumer-groups.sh --zookeeper localhost:2181 --list ## æ¶ˆè´¹è€…åˆ—è¡¨æŸ¥è¯¢ï¼ˆæ”¯æŒ0.9ç‰ˆæœ¬+ï¼‰ bin/kafka-consumer-groups.sh --new-consumer --bootstrap-server localhost:9092 --list ## æ¶ˆè´¹è€…åˆ—è¡¨æŸ¥è¯¢ï¼ˆæ”¯æŒ0.10ç‰ˆæœ¬+ï¼‰ bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 --list ## æ˜¾ç¤ºæŸä¸ªæ¶ˆè´¹ç»„çš„æ¶ˆè´¹è¯¦æƒ…ï¼ˆä»…æ”¯æŒoffsetå­˜å‚¨åœ¨zookeeperä¸Šçš„ï¼‰ bin/kafka-run-class.sh kafka.tools.ConsumerOffsetChecker --zookeeper localhost:2181 --group test ## æ˜¾ç¤ºæŸä¸ªæ¶ˆè´¹ç»„çš„æ¶ˆè´¹è¯¦æƒ…ï¼ˆ0.9ç‰ˆæœ¬ - 0.10.1.0 ä¹‹å‰ï¼‰ bin/kafka-consumer-groups.sh --new-consumer --bootstrap-server localhost:9092 --describe --group test-consumer-group ## æ˜¾ç¤ºæŸä¸ªæ¶ˆè´¹ç»„çš„æ¶ˆè´¹è¯¦æƒ…ï¼ˆ0.10.1.0ç‰ˆæœ¬+ï¼‰ bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 --describe --group my-group å‘é€å’Œæ¶ˆè´¹ ## ç”Ÿäº§è€… bin/kafka-console-producer.sh --broker-list localhost:9092 --topic test ## æ¶ˆè´¹è€…ï¼ˆå·²å¤±æ•ˆï¼‰ bin/kafka-console-consumer.sh --zookeeper localhost:2181 --topic test ## ç”Ÿäº§è€…ï¼ˆæ”¯æŒ0.9ç‰ˆæœ¬+ï¼‰ bin/kafka-console-producer.sh --broker-list localhost:9092 --topic test --producer.config config/producer.properties ## æ¶ˆè´¹è€…ï¼ˆæ”¯æŒ0.9ç‰ˆæœ¬+ï¼Œå·²å¤±æ•ˆï¼‰ bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic test --new-consumer --from-beginning --consumer.config config/consumer.properties ## æ¶ˆè´¹è€…ï¼ˆæœ€æ–°ï¼‰ bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic test --from-beginning --consumer.config config/consumer.properties ## kafka-verifiable-consumer.shï¼ˆæ¶ˆè´¹è€…äº‹ä»¶ï¼Œä¾‹å¦‚ï¼šoffsetæäº¤ç­‰ï¼‰ bin/kafka-verifiable-consumer.sh --broker-list localhost:9092 --topic test --group-id groupName ## é«˜çº§ç‚¹çš„ç”¨æ³• bin/kafka-simple-consumer-shell.sh --brist localhost:9092 --topic test --partition 0 --offset 1234 --max-messages 10 åˆ‡æ¢leader ## kafkaç‰ˆæœ¬ &lt;= 2.4 bin/kafka-preferred-replica-election.sh --zookeeper zk_host:port/chroot ## kafkaæ–°ç‰ˆæœ¬ bin/kafka-preferred-replica-election.sh --bootstrap-server broker_host:port kafkaè‡ªå¸¦å‹æµ‹å‘½ä»¤ bin/kafka-producer-perf-test.sh --topic test --num-records 100 --record-size 1 --throughput 100 --producer-props bootstrap.servers=localhost:9092 kafkaæŒç»­å‘é€æ¶ˆæ¯ æŒç»­å‘é€æ¶ˆæ¯åˆ°æŒ‡å®šçš„topicä¸­ï¼Œä¸”æ¯æ¡å‘é€çš„æ¶ˆæ¯éƒ½ä¼šæœ‰å“åº”ä¿¡æ¯ï¼š kafka-verifiable-producer.sh --broker-list $(hostname -i):9092 --topic test --max-messages 100000 zookeeper-shell.sh å¦‚æœkafkaé›†ç¾¤çš„zké…ç½®äº†chrootè·¯å¾„ï¼Œé‚£ä¹ˆéœ€è¦åŠ ä¸Š/pathã€‚ bin/zookeeper-shell.sh localhost:2181[/path] ls /brokers/ids get /brokers/ids/0 è¿ç§»åˆ†åŒº åˆ›å»ºè§„åˆ™json cat &gt; increase-replication-factor.json &lt;&lt;EOF {&quot;version&quot;:1, &quot;partitions&quot;:[ {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:1,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:2,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:3,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:4,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:5,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:6,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:7,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:8,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:9,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:10,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:11,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:12,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:13,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:14,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:15,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:16,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:17,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:18,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:19,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:20,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:21,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:22,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:23,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:24,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:25,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:26,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:27,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:28,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:29,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:30,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:31,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:32,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:33,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:34,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:35,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:36,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:37,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:38,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:39,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:40,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:41,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:42,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:43,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:44,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:45,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:46,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:47,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:48,&quot;replicas&quot;:[0,1]}, {&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:49,&quot;replicas&quot;:[0,1]}] } EOF æ‰§è¡Œ bin/kafka-reassign-partitions.sh --zookeeper localhost:2181 --reassignment-json-file increase-replication-factor.json --execute éªŒè¯ bin/kafka-reassign-partitions.sh --zookeeper localhost:2181 --reassignment-json-file increase-replication-factor.json --verify åˆ é™¤æ¶ˆè´¹è€…ç»„ æŸ¥è¯¢æ¶ˆè´¹è€…ç»„åˆ—è¡¨ï¼š kafka-consumer-groups.sh --bootstrap-server 172.31.1.245:9092 --list æŸ¥è¯¢æ¶ˆè´¹è€…ç»„æ˜ç»†ï¼š kafka-consumer-groups.sh --bootstrap-server {Kafka instance connection address} --describe --group {consumer group name} åˆ é™¤æ¶ˆè´¹è€…ç»„ï¼š kafka-consumer-groups.sh --bootstrap-server {Kafka instance connection address} --delete --group {consumer group name} ","link":"https://tianxiawuhao.github.io/cvzf4T4Wn/"},{"title":"zookeeperé€‰ä¸¾è¿‡ç¨‹","content":"åˆå§‹åŒ–é€‰ä¸¾ è¿è¡ŒæœŸé—´é€‰ä¸¾ ","link":"https://tianxiawuhao.github.io/Rz0qPOGXr/"},{"title":"ReentrantLockæºç è¯¦è§£","content":"ReentrantLocké‡å…¥é”ï¼Œæ˜¯å®ç°Lockæ¥å£çš„ä¸€ä¸ªç±»ï¼Œä¹Ÿæ˜¯åœ¨å®é™…ç¼–ç¨‹ä¸­ä½¿ç”¨é¢‘ç‡å¾ˆé«˜çš„ä¸€ä¸ªé”ï¼Œæ”¯æŒé‡å…¥æ€§ï¼Œè¡¨ç¤ºèƒ½å¤Ÿå¯¹å…±äº«èµ„æºèƒ½å¤Ÿé‡å¤åŠ é”ï¼Œå³å½“å‰çº¿ç¨‹è·å–è¯¥é”å†æ¬¡è·å–ä¸ä¼šè¢«é˜»å¡ã€‚ ReentrantLockè¿˜æ”¯æŒå…¬å¹³é”å’Œéå…¬å¹³é”ä¸¤ç§æ–¹å¼ã€‚é‚£ä¹ˆï¼Œè¦æƒ³å®Œå®Œå…¨å…¨çš„å¼„æ‡‚ReentrantLockçš„è¯ï¼Œä¸»è¦ä¹Ÿå°±æ˜¯ReentrantLockåŒæ­¥è¯­ä¹‰çš„å­¦ä¹ ï¼š é‡å…¥æ€§çš„å®ç°åŸç†ï¼› å…¬å¹³é”å’Œéå…¬å¹³é” ReentrantLockæºç è§£æ åŠ é” //ä½¿ç”¨æ¡ˆä¾‹ class Bank{ /** * volatileå®ç° */ private int count=0; /** * ä½¿ç”¨å¯é‡å…¥é” */ private Lock lock=new ReentrantLock(); public void getCount(){ System.out.println(&quot;è´¦æˆ·ä½™é¢ä¸ºï¼š&quot;+count); } /** * åŒæ­¥æ–¹æ³•å®ç°å­˜é’± * @param money */ public void save(int money){ lock.lock(); try { count+=money; System.out.println(System.currentTimeMillis()+&quot;å­˜è¿›ï¼š&quot;+money); } catch (Exception e) { // TODO Auto-generated catch block e.printStackTrace(); }finally { lock.unlock();//é‡Šæ”¾é” } } /** * åŒæ­¥ä»£ç å—å®ç°å–é’± * @param money */ public void remove(int money){ if (count-money&lt;0) { System.err.println(&quot;ä½™é¢ä¸è¶³ã€‚&quot;); return; } lock.lock(); try { count-=money; System.err.println(System.currentTimeMillis()+&quot;å–å‡ºï¼š&quot;+money); } catch (Exception e) { // TODO Auto-generated catch block e.printStackTrace(); }finally { lock.unlock(); } } } /** * Creates an instance of {@code ReentrantLock}. * This is equivalent to using {@code ReentrantLock(false)}. */ public ReentrantLock() { sync = new NonfairSync(); } /** * Creates an instance of {@code ReentrantLock} with the * given fairness policy. * * @param fair {@code true} if this lock should use a fair ordering policy */ public ReentrantLock(boolean fair) { sync = fair ? new FairSync() : new NonfairSync(); } åˆå§‹åŒ–é»˜è®¤ä½¿ç”¨éå…¬å¹³é” å…¬å¹³é”å’Œéå…¬å¹³é”ç»§æ‰¿AbstractQueuedSynchronizeræ¥å£ï¼ˆæŠ½è±¡çš„é˜Ÿåˆ—å¼çš„åŒæ­¥å™¨ï¼ŒAQSå®šä¹‰äº†ä¸€å¥—å¤šçº¿ç¨‹è®¿é—®å…±äº«èµ„æºçš„åŒæ­¥å™¨æ¡†æ¶ï¼‰ AQSæ¡†æ¶ NonfairSyncçš„ç±»ç»§æ‰¿å…³ç³» FairSyncçš„ç±»ç»§æ‰¿å…³ç³» ä¸‹é¢ä»¥éå…¬å¹³é”ä¸ºä¾‹ /** * Performs lock. Try immediate barge, backing up to normal * acquire on failure. */ //åŠ é”æµç¨‹çœŸæ­£æ„ä¹‰ä¸Šçš„å…¥å£ final void lock() { //ä»¥casæ–¹å¼å°è¯•å°†AQSä¸­çš„stateä»0æ›´æ–°ä¸º1 if (compareAndSetState(0, 1)) setExclusiveOwnerThread(Thread.currentThread());//è·å–é”æˆåŠŸåˆ™å°†å½“å‰çº¿ç¨‹æ ‡è®°ä¸ºæŒæœ‰é”çš„çº¿ç¨‹,ç„¶åç›´æ¥è¿”å› else acquire(1);//è·å–é”å¤±è´¥åˆ™æ‰§è¡Œè¯¥æ–¹æ³• } åŠ é”æ—¶è°ƒç”¨lockæ–¹æ³•ï¼Œé¦–å…ˆåˆ¤æ–­AQSä¸­çš„sateå‚æ•°æ˜¯å¦è¢«æ ‡è®°,å°è¯•ä»¥casæ–¹å¼å°è¯•å°†AQSä¸­çš„stateä»0æ›´æ–°ä¸º1ï¼ŒæˆåŠŸå°†å½“å‰çº¿ç¨‹èµ‹äºˆAQS å¤±è´¥åˆ™è°ƒç”¨AQSç±»çš„acquire(1)æ–¹æ³• //éå…¬å¹³æ¨¡å¼ä¸‹å°è¯•è·å–é”çš„æ–¹æ³• protected final boolean tryAcquire(int acquires) { return nonfairTryAcquire(acquires); } /** * Performs non-fair tryLock. tryAcquire is implemented in * subclasses, but both need nonfair try for trylock method. */ final boolean nonfairTryAcquire(int acquires) { final Thread current = Thread.currentThread();//è·å–å½“å‰çº¿ç¨‹å®ä¾‹ int c = getState();//è·å–stateå˜é‡çš„å€¼,å³å½“å‰é”è¢«é‡å…¥çš„æ¬¡æ•° if (c == 0) { //stateä¸º0,è¯´æ˜å½“å‰é”æœªè¢«ä»»ä½•çº¿ç¨‹æŒæœ‰ if (compareAndSetState(0, acquires)) { //ä»¥casæ–¹å¼è·å–é” setExclusiveOwnerThread(current); //å°†å½“å‰çº¿ç¨‹æ ‡è®°ä¸ºæŒæœ‰é”çš„çº¿ç¨‹ return true;//è·å–é”æˆåŠŸ,éé‡å…¥ } } else if (current == getExclusiveOwnerThread()) { //å½“å‰çº¿ç¨‹å°±æ˜¯æŒæœ‰é”çš„çº¿ç¨‹,è¯´æ˜è¯¥é”è¢«é‡å…¥äº† int nextc = c + acquires;//è®¡ç®—stateå˜é‡è¦æ›´æ–°çš„å€¼ if (nextc &lt; 0) // overflow throw new Error(&quot;Maximum lock count exceeded&quot;); setState(nextc);//éåŒæ­¥æ–¹å¼æ›´æ–°stateå€¼ return true; //è·å–é”æˆåŠŸ,é‡å…¥ } return false; //èµ°åˆ°è¿™é‡Œè¯´æ˜å°è¯•è·å–é”å¤±è´¥ } è¿™æ˜¯éå…¬å¹³æ¨¡å¼ä¸‹è·å–é”çš„é€šç”¨æ–¹æ³•ã€‚å®ƒå›Šæ‹¬äº†å½“å‰çº¿ç¨‹åœ¨å°è¯•è·å–é”æ—¶çš„æ‰€æœ‰å¯èƒ½æƒ…å†µï¼š 1.å½“å‰é”æœªè¢«ä»»ä½•çº¿ç¨‹æŒæœ‰(state=0),åˆ™ä»¥casæ–¹å¼è·å–é”,è‹¥è·å–æˆåŠŸåˆ™è®¾ç½®exclusiveOwnerThreadä¸ºå½“å‰çº¿ç¨‹,ç„¶åè¿”å›æˆåŠŸçš„ç»“æœï¼›è‹¥caså¤±è´¥,è¯´æ˜åœ¨å¾—åˆ°state=0å’Œcasè·å–é”ä¹‹é—´æœ‰å…¶ä»–çº¿ç¨‹å·²ç»è·å–äº†é”,è¿”å›å¤±è´¥ç»“æœã€‚ 2.è‹¥é”å·²ç»è¢«å½“å‰çº¿ç¨‹è·å–(state&gt;0,exclusiveOwnerThreadä¸ºå½“å‰çº¿ç¨‹),åˆ™å°†é”çš„é‡å…¥æ¬¡æ•°åŠ 1(state+1),ç„¶åè¿”å›æˆåŠŸç»“æœã€‚å› ä¸ºè¯¥çº¿ç¨‹ä¹‹å‰å·²ç»è·å¾—äº†é”,æ‰€ä»¥è¿™ä¸ªç´¯åŠ æ“ä½œä¸ç”¨åŒæ­¥ã€‚ 3.è‹¥å½“å‰é”å·²ç»è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰(state&gt;0,exclusiveOwnerThreadä¸ä¸ºå½“å‰çº¿ç¨‹),åˆ™ç›´æ¥è¿”å›å¤±è´¥ç»“æœ å› ä¸ºæˆ‘ä»¬ç”¨stateæ¥ç»Ÿè®¡é”è¢«çº¿ç¨‹é‡å…¥çš„æ¬¡æ•°,æ‰€ä»¥å½“å‰çº¿ç¨‹å°è¯•è·å–é”çš„æ“ä½œæ˜¯å¦æˆåŠŸå¯ä»¥ç®€åŒ–ä¸º:stateå€¼æ˜¯å¦æˆåŠŸç´¯åŠ 1,æ˜¯åˆ™å°è¯•è·å–é”æˆåŠŸ,å¦åˆ™å°è¯•è·å–é”å¤±è´¥ã€‚ å…¶å®è¿™é‡Œè¿˜å¯ä»¥æ€è€ƒä¸€ä¸ªé—®é¢˜:nonfairTryAcquireå·²ç»å®ç°äº†ä¸€ä¸ªå›Šæ‹¬æ‰€æœ‰å¯èƒ½æƒ…å†µçš„å°è¯•è·å–é”çš„æ–¹å¼,ä¸ºä½•åœ¨åˆšè¿›å…¥lockæ–¹æ³•æ—¶è¿˜è¦é€šè¿‡compareAndSetState(0, 1)å»è·å–é”,æ¯•ç«Ÿåè€…åªæœ‰åœ¨é”æœªè¢«ä»»ä½•çº¿ç¨‹æŒæœ‰æ—¶æ‰èƒ½æ‰§è¡ŒæˆåŠŸ,æˆ‘ä»¬å®Œå…¨å¯ä»¥æŠŠcompareAndSetState(0, 1)å»æ‰,å¯¹æœ€åçš„ç»“æœä¸ä¼šæœ‰ä»»ä½•å½±å“ã€‚è¿™ç§åœ¨è¿›è¡Œé€šç”¨é€»è¾‘å¤„ç†ä¹‹å‰é’ˆå¯¹æŸäº›ç‰¹æ®Šæƒ…å†µæå‰è¿›è¡Œå¤„ç†çš„æ–¹å¼åœ¨åé¢è¿˜ä¼šçœ‹åˆ°,ä¸€ä¸ªç›´è§‚çš„æƒ³æ³•å°±æ˜¯å®ƒèƒ½æå‡æ€§èƒ½ï¼Œè€Œä»£ä»·æ˜¯ç‰ºç‰²ä¸€å®šçš„ä»£ç ç®€æ´æ€§ã€‚ é€€å›åˆ°ä¸Šå±‚çš„acquireæ–¹æ³•, public final void acquire(int arg) { if (!tryAcquire(arg) &amp;&amp; //å½“å‰çº¿ç¨‹å°è¯•è·å–é”,è‹¥è·å–æˆåŠŸè¿”å›true,å¦åˆ™false acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) //åªæœ‰å½“å‰çº¿ç¨‹è·å–é”å¤±è´¥æ‰ä¼šæ‰§è¡Œè€…è¿™éƒ¨åˆ†ä»£ç  selfInterrupt(); } tryAcquire(arg)è¿”å›æˆåŠŸ,åˆ™è¯´æ˜å½“å‰çº¿ç¨‹æˆåŠŸè·å–äº†é”(ç¬¬ä¸€æ¬¡è·å–æˆ–è€…é‡å…¥),ç”±å–åå’Œ&amp;&amp;å¯çŸ¥,æ•´ä¸ªæµç¨‹åˆ°è¿™ç»“æŸï¼Œåªæœ‰å½“å‰çº¿ç¨‹è·å–é”å¤±è´¥æ‰ä¼šæ‰§è¡Œåé¢çš„åˆ¤æ–­ã€‚å…ˆæ¥çœ‹addWaiter(Node.EXCLUSIVE)éƒ¨åˆ†,è¿™éƒ¨åˆ†ä»£ç æè¿°äº†å½“çº¿ç¨‹è·å–é”å¤±è´¥æ—¶å¦‚ä½•å®‰å…¨çš„åŠ å…¥åŒæ­¥ç­‰å¾…é˜Ÿåˆ—ã€‚ è¿™éƒ¨åˆ†é€»è¾‘åœ¨addWaiter()æ–¹æ³•ä¸­ /** * Creates and enqueues node for current thread and given mode. * * @param mode Node.EXCLUSIVE for exclusive, Node.SHARED for shared * @return the new node */ private Node addWaiter(Node mode) { Node node = new Node(Thread.currentThread(), mode);//é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ–°èŠ‚ç‚¹,å¹¶å°†å½“å‰çº¿ç¨‹å®ä¾‹å°è£…åœ¨å†…éƒ¨,modeè¿™é‡Œä¸ºnull // Try the fast path of enq; backup to full enq on failure Node pred = tail; if (pred != null) { node.prev = pred; if (compareAndSetTail(pred, node)) { pred.next = node; return node; } } enq(node);//å…¥é˜Ÿçš„é€»è¾‘è¿™é‡Œéƒ½æœ‰ return node; } é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªæ–°èŠ‚ç‚¹,å¹¶å°†å½“å‰çº¿ç¨‹å®ä¾‹å°è£…åœ¨å…¶å†…éƒ¨,ä¹‹åæˆ‘ä»¬ç›´æ¥çœ‹enq(node)æ–¹æ³•å°±å¯ä»¥äº†,ä¸­é—´è¿™éƒ¨åˆ†é€»è¾‘åœ¨enq(node)ä¸­éƒ½æœ‰,ä¹‹æ‰€ä»¥åŠ ä¸Šè¿™éƒ¨åˆ†â€œé‡å¤ä»£ç â€å’Œå°è¯•è·å–é”æ—¶çš„â€œé‡å¤ä»£ç â€ä¸€æ ·,å¯¹æŸäº›ç‰¹æ®Šæƒ…å†µ è¿›è¡Œæå‰å¤„ç†,ç‰ºç‰²ä¸€å®šçš„ä»£ç å¯è¯»æ€§æ¢å–æ€§èƒ½æå‡ã€‚ /** * Inserts node into queue, initializing if necessary. See picture above. * @param node the node to insert * @return node's predecessor */ private Node enq(final Node node) { for (;;) { Node t = tail;//tæŒ‡å‘å½“å‰é˜Ÿåˆ—çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹,é˜Ÿåˆ—ä¸ºç©ºåˆ™ä¸ºnull if (t == null) { // Must initialize //é˜Ÿåˆ—ä¸ºç©º if (compareAndSetHead(new Node())) //æ„é€ æ–°ç»“ç‚¹,CASæ–¹å¼è®¾ç½®ä¸ºé˜Ÿåˆ—é¦–å…ƒç´ ,å½“head==nullæ—¶æ›´æ–°æˆåŠŸ tail = head;//å°¾æŒ‡é’ˆæŒ‡å‘é¦–ç»“ç‚¹ } else { //é˜Ÿåˆ—ä¸ä¸ºç©º node.prev = t; if (compareAndSetTail(t, node)) { //CASå°†å°¾æŒ‡é’ˆæŒ‡å‘å½“å‰ç»“ç‚¹,å½“t(åŸæ¥çš„å°¾æŒ‡é’ˆ)==tail(å½“å‰çœŸå®çš„å°¾æŒ‡é’ˆ)æ—¶æ‰§è¡ŒæˆåŠŸ t.next = node; //åŸå°¾ç»“ç‚¹çš„nextæŒ‡é’ˆæŒ‡å‘å½“å‰ç»“ç‚¹ return t; } } } } è¿™é‡Œæœ‰ä¸¤ä¸ªCASæ“ä½œ: compareAndSetHead(new Node()),CASæ–¹å¼æ›´æ–°headæŒ‡é’ˆ,ä»…å½“åŸå€¼ä¸ºnullæ—¶æ›´æ–°æˆåŠŸ /** * CAS head field. Used only by enq. */ private final boolean compareAndSetHead(Node update) { return unsafe.compareAndSwapObject(this, headOffset, null, update); } compareAndSetTail(t, node),CASæ–¹å¼æ›´æ–°tialæŒ‡é’ˆ,ä»…å½“åŸå€¼ä¸ºtæ—¶æ›´æ–°æˆåŠŸ /** * CAS tail field. Used only by enq. */ private final boolean compareAndSetTail(Node expect, Node update) { return unsafe.compareAndSwapObject(this, tailOffset, expect, update); } å¤–å±‚çš„forå¾ªç¯ä¿è¯äº†æ‰€æœ‰è·å–é”å¤±è´¥çš„çº¿ç¨‹ç»è¿‡å¤±è´¥é‡è¯•åæœ€åéƒ½èƒ½åŠ å…¥åŒæ­¥é˜Ÿåˆ—ã€‚å› ä¸ºAQSçš„åŒæ­¥é˜Ÿåˆ—æ˜¯ä¸å¸¦å“¨å…µç»“ç‚¹çš„,æ•…å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶è¦è¿›è¡Œç‰¹æ®Šå¤„ç†,è¿™éƒ¨åˆ†åœ¨ifåˆ†å¥ä¸­ã€‚æ³¨æ„å½“å‰çº¿ç¨‹æ‰€åœ¨çš„ç»“ç‚¹ä¸èƒ½ç›´æ¥æ’å…¥ ç©ºé˜Ÿåˆ—,å› ä¸ºé˜»å¡çš„çº¿ç¨‹æ˜¯ç”±å‰é©±ç»“ç‚¹è¿›è¡Œå”¤é†’çš„ã€‚æ•…å…ˆè¦æ’å…¥ä¸€ä¸ªç»“ç‚¹ä½œä¸ºé˜Ÿåˆ—é¦–å…ƒç´ ,å½“é”é‡Šæ”¾æ—¶ç”±å®ƒæ¥å”¤é†’åé¢è¢«é˜»å¡çš„çº¿ç¨‹,ä»é€»è¾‘ä¸Šè¿™ä¸ªé˜Ÿåˆ—é¦–å…ƒç´ ä¹Ÿå¯ä»¥è¡¨ç¤ºå½“å‰æ­£è·å–é”çš„çº¿ç¨‹,è™½ç„¶å¹¶ä¸ä¸€å®šçœŸå®æŒæœ‰å…¶çº¿ç¨‹å®ä¾‹ã€‚ é¦–å…ˆé€šè¿‡new Node()åˆ›å»ºä¸€ä¸ªç©ºç»“ç‚¹ï¼Œç„¶åä»¥CASæ–¹å¼è®©å¤´æŒ‡é’ˆæŒ‡å‘è¯¥ç»“ç‚¹(è¯¥ç»“ç‚¹å¹¶éå½“å‰çº¿ç¨‹æ‰€åœ¨çš„ç»“ç‚¹),è‹¥è¯¥æ“ä½œæˆåŠŸ,åˆ™å°†å°¾æŒ‡é’ˆä¹ŸæŒ‡å‘è¯¥ç»“ç‚¹ã€‚è¿™éƒ¨åˆ†çš„æ“ä½œæµç¨‹å¯ä»¥ç”¨ä¸‹å›¾è¡¨ç¤º å½“é˜Ÿåˆ—ä¸ä¸ºç©º,åˆ™æ‰§è¡Œé€šç”¨çš„å…¥é˜Ÿé€»è¾‘,è¿™éƒ¨åˆ†åœ¨elseåˆ†å¥ä¸­ else { //é˜Ÿåˆ—ä¸ä¸ºç©º node.prev = t; if (compareAndSetTail(t, node)) { //CASå°†å°¾æŒ‡é’ˆæŒ‡å‘å½“å‰ç»“ç‚¹,å½“t(åŸæ¥çš„å°¾æŒ‡é’ˆ)==tail(å½“å‰çœŸå®çš„å°¾æŒ‡é’ˆ)æ—¶æ‰§è¡ŒæˆåŠŸ t.next = node; //åŸå°¾ç»“ç‚¹çš„nextæŒ‡é’ˆæŒ‡å‘å½“å‰ç»“ç‚¹ return t; } é¦–å…ˆå½“å‰çº¿ç¨‹æ‰€åœ¨çš„ç»“ç‚¹çš„å‰å‘æŒ‡é’ˆpreæŒ‡å‘å½“å‰çº¿ç¨‹è®¤ä¸ºçš„å°¾ç»“ç‚¹,æºç ä¸­ç”¨tè¡¨ç¤ºã€‚ç„¶åä»¥CASçš„æ–¹å¼å°†å°¾æŒ‡é’ˆæŒ‡å‘å½“å‰ç»“ç‚¹,è¯¥æ“ä½œä»…å½“tail=t,å³å°¾æŒ‡é’ˆåœ¨è¿›è¡ŒCASå‰æœªæ”¹å˜æ—¶æˆåŠŸã€‚è‹¥CASæ‰§è¡ŒæˆåŠŸ,åˆ™å°†åŸå°¾ç»“ç‚¹çš„åå‘æŒ‡é’ˆnextæŒ‡å‘æ–°çš„å°¾ç»“ç‚¹ã€‚æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º æ•´ä¸ªå…¥é˜Ÿçš„è¿‡ç¨‹å¹¶ä¸å¤æ‚,æ˜¯å…¸å‹çš„CASåŠ å¤±è´¥é‡è¯•çš„ä¹è§‚é”ç­–ç•¥ã€‚å…¶ä¸­åªæœ‰æ›´æ–°å¤´æŒ‡é’ˆå’Œæ›´æ–°å°¾æŒ‡é’ˆè¿™ä¸¤æ­¥è¿›è¡Œäº†CASåŒæ­¥,å¯ä»¥é¢„è§é«˜å¹¶å‘åœºæ™¯ä¸‹æ€§èƒ½æ˜¯éå¸¸å¥½çš„ã€‚ä½†æ˜¯æœ¬ç€è´¨ç–‘ç²¾ç¥æˆ‘ä»¬ä¸ç¦ä¼šæ€è€ƒä¸‹è¿™ä¹ˆåšçœŸçš„çº¿ç¨‹å®‰å…¨å—ï¼Ÿ 1.é˜Ÿåˆ—ä¸ºç©ºçš„æƒ…å†µ: å› ä¸ºé˜Ÿåˆ—ä¸ºç©º,æ•…head=tail=null,å‡è®¾çº¿ç¨‹æ‰§è¡Œ2æˆåŠŸ,åˆ™åœ¨å…¶æ‰§è¡Œ3ä¹‹å‰,å› ä¸ºtail=null,å…¶ä»–è¿›å…¥è¯¥æ–¹æ³•çš„çº¿ç¨‹å› ä¸ºheadä¸ä¸ºnullå°†åœ¨2å¤„ä¸åœçš„å¤±è´¥,æ‰€ä»¥3å³ä½¿æ²¡æœ‰åŒæ­¥ä¹Ÿä¸ä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ 2.é˜Ÿåˆ—ä¸ä¸ºç©ºçš„æƒ…å†µ: å‡è®¾çº¿ç¨‹æ‰§è¡Œ5æˆåŠŸ,åˆ™æ­¤æ—¶4çš„æ“ä½œå¿…ç„¶ä¹Ÿæ˜¯æ­£ç¡®çš„(å½“å‰ç»“ç‚¹çš„prevæŒ‡é’ˆç¡®å®æŒ‡å‘äº†é˜Ÿåˆ—å°¾ç»“ç‚¹,æ¢å¥è¯è¯´tailæŒ‡é’ˆæ²¡æœ‰æ”¹å˜,å¦‚è‹¥ä¸ç„¶5å¿…ç„¶æ‰§è¡Œå¤±è´¥),åˆå› ä¸º4æ‰§è¡ŒæˆåŠŸ,å½“å‰èŠ‚ç‚¹åœ¨é˜Ÿåˆ—ä¸­çš„æ¬¡åºå·²ç»ç¡®å®šäº†,æ‰€ä»¥6ä½•æ—¶æ‰§è¡Œå¯¹çº¿ç¨‹å®‰å…¨ä¸ä¼šæœ‰ä»»ä½•å½±å“,æ¯”å¦‚ä¸‹é¢è¿™ç§æƒ…å†µ ä¸ºäº†ç¡®ä¿çœŸçš„ç†è§£äº†å®ƒ,å¯ä»¥æ€è€ƒè¿™ä¸ªé—®é¢˜:æŠŠenqæ–¹æ³•å›¾ä¸­çš„4æ”¾åˆ°5ä¹‹å,æ•´ä¸ªå…¥é˜Ÿçš„è¿‡ç¨‹è¿˜çº¿ç¨‹å®‰å…¨å—ï¼Ÿ åˆ°è¿™ä¸ºæ­¢,è·å–é”å¤±è´¥çš„çº¿ç¨‹åŠ å…¥åŒæ­¥é˜Ÿåˆ—çš„é€»è¾‘å°±ç»“æŸäº†ã€‚ä½†æ˜¯çº¿ç¨‹åŠ å…¥åŒæ­¥é˜Ÿåˆ—åä¼šåšä»€ä¹ˆæˆ‘ä»¬å¹¶ä¸æ¸…æ¥š,è¿™éƒ¨åˆ†åœ¨acquireQueuedæ–¹æ³•ä¸­ acquireQueuedæ–¹æ³•çš„æºç  /** * Acquires in exclusive uninterruptible mode for thread already in * queue. Used by condition wait methods as well as acquire. * * @param node the node * @param arg the acquire argument * @return {@code true} if interrupted while waiting */ final boolean acquireQueued(final Node node, int arg) { boolean failed = true; try { boolean interrupted = false; //æ­»å¾ªç¯,æ­£å¸¸æƒ…å†µä¸‹çº¿ç¨‹åªæœ‰è·å¾—é”æ‰èƒ½è·³å‡ºå¾ªç¯ for (;;) { final Node p = node.predecessor();//è·å¾—å½“å‰çº¿ç¨‹æ‰€åœ¨ç»“ç‚¹çš„å‰é©±ç»“ç‚¹ //ç¬¬ä¸€ä¸ªifåˆ†å¥ if (p == head &amp;&amp; tryAcquire(arg)) { setHead(node); //å°†å½“å‰ç»“ç‚¹è®¾ç½®ä¸ºé˜Ÿåˆ—å¤´ç»“ç‚¹ p.next = null; // help GC failed = false; return interrupted;//æ­£å¸¸æƒ…å†µä¸‹æ­»å¾ªç¯å”¯ä¸€çš„å‡ºå£ } //ç¬¬äºŒä¸ªifåˆ†å¥ if (shouldParkAfterFailedAcquire(p, node) &amp;&amp; //åˆ¤æ–­æ˜¯å¦è¦é˜»å¡å½“å‰çº¿ç¨‹ parkAndCheckInterrupt()) //é˜»å¡å½“å‰çº¿ç¨‹ interrupted = true; } } finally { if (failed) cancelAcquire(node); } } è¿™æ®µä»£ç ä¸»è¦çš„å†…å®¹éƒ½åœ¨forå¾ªç¯ä¸­,è¿™æ˜¯ä¸€ä¸ªæ­»å¾ªç¯,ä¸»è¦æœ‰ä¸¤ä¸ªifåˆ†å¥æ„æˆã€‚ç¬¬ä¸€ä¸ªifåˆ†å¥ä¸­,å½“å‰çº¿ç¨‹é¦–å…ˆä¼šåˆ¤æ–­å‰é©±ç»“ç‚¹æ˜¯å¦æ˜¯å¤´ç»“ç‚¹,å¦‚æœæ˜¯åˆ™å°è¯•è·å–é”,è·å–é”æˆåŠŸåˆ™ä¼šè®¾ç½®å½“å‰ç»“ç‚¹ä¸ºå¤´ç»“ç‚¹(æ›´æ–°å¤´æŒ‡é’ˆ)ã€‚ä¸ºä»€ä¹ˆå¿…é¡»å‰é©±ç»“ç‚¹ä¸ºå¤´ç»“ç‚¹æ‰å°è¯•å»è·å–é”ï¼Ÿå› ä¸ºå¤´ç»“ç‚¹è¡¨ç¤ºå½“å‰æ­£å æœ‰é”çš„çº¿ç¨‹,æ­£å¸¸æƒ…å†µä¸‹è¯¥çº¿ç¨‹é‡Šæ”¾é”åä¼šé€šçŸ¥åé¢ç»“ç‚¹ä¸­é˜»å¡çš„çº¿ç¨‹,é˜»å¡çº¿ç¨‹è¢«å”¤é†’åå»è·å–é”,è¿™æ˜¯æˆ‘ä»¬å¸Œæœ›çœ‹åˆ°çš„ã€‚ç„¶è€Œè¿˜æœ‰ä¸€ç§æƒ…å†µ,å°±æ˜¯å‰é©±ç»“ç‚¹å–æ¶ˆäº†ç­‰å¾…,æ­¤æ—¶å½“å‰çº¿ç¨‹ä¹Ÿä¼šè¢«å”¤é†’,è¿™æ—¶å€™å°±ä¸åº”è¯¥å»è·å–é”,è€Œæ˜¯å¾€å‰å›æº¯ä¸€ç›´æ‰¾åˆ°ä¸€ä¸ªæ²¡æœ‰å–æ¶ˆç­‰å¾…çš„ç»“ç‚¹,ç„¶åå°†è‡ªèº«è¿æ¥åœ¨å®ƒåé¢ã€‚ä¸€æ—¦æˆ‘ä»¬æˆåŠŸè·å–äº†é”å¹¶æˆåŠŸå°†è‡ªèº«è®¾ç½®ä¸ºå¤´ç»“ç‚¹,å°±ä¼šè·³å‡ºforå¾ªç¯ã€‚å¦åˆ™å°±ä¼šæ‰§è¡Œç¬¬äºŒä¸ªifåˆ†å¥:ç¡®ä¿å‰é©±ç»“ç‚¹çš„çŠ¶æ€ä¸ºSIGNAL,ç„¶åé˜»å¡å½“å‰çº¿ç¨‹ã€‚ å…ˆæ¥çœ‹shouldParkAfterFailedAcquire(p, node)ï¼Œä»æ–¹æ³•åä¸Šæˆ‘ä»¬å¯ä»¥å¤§æ¦‚çŒœå‡ºè¿™æ˜¯åˆ¤æ–­æ˜¯å¦è¦é˜»å¡å½“å‰çº¿ç¨‹çš„,æ–¹æ³•å†…å®¹å¦‚ä¸‹ /** * Checks and updates status for a node that failed to acquire. * Returns true if thread should block. This is the main signal * control in all acquire loops. Requires that pred == node.prev. * * @param pred node's predecessor holding status * @param node the node * @return {@code true} if thread should block */ private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) { int ws = pred.waitStatus; if (ws == Node.SIGNAL) //çŠ¶æ€ä¸ºSIGNAL /* * This node has already set status asking a release * to signal it, so it can safely park. */ return true; if (ws &gt; 0) { //çŠ¶æ€ä¸ºCANCELLED, /* * Predecessor was cancelled. Skip over predecessors and * indicate retry. */ do { node.prev = pred = pred.prev; } while (pred.waitStatus &gt; 0); pred.next = node; } else { //çŠ¶æ€ä¸ºåˆå§‹åŒ–çŠ¶æ€(ReentrentLockè¯­å¢ƒä¸‹) /* * waitStatus must be 0 or PROPAGATE. Indicate that we * need a signal, but don't park yet. Caller will need to * retry to make sure it cannot acquire before parking. */ compareAndSetWaitStatus(pred, ws, Node.SIGNAL); } return false; } å¯ä»¥çœ‹åˆ°é’ˆå¯¹å‰é©±ç»“ç‚¹predçš„çŠ¶æ€ä¼šè¿›è¡Œä¸åŒçš„å¤„ç† 1.predçŠ¶æ€ä¸ºSIGNAL,åˆ™è¿”å›true,è¡¨ç¤ºè¦é˜»å¡å½“å‰çº¿ç¨‹ã€‚ 2.predçŠ¶æ€ä¸ºCANCELLED,åˆ™ä¸€ç›´å¾€é˜Ÿåˆ—å¤´éƒ¨å›æº¯ç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªçŠ¶æ€ä¸ä¸ºCANCELLEDçš„ç»“ç‚¹,å°†å½“å‰èŠ‚ç‚¹nodeæŒ‚åœ¨è¿™ä¸ªç»“ç‚¹çš„åé¢ã€‚ 3.predçš„çŠ¶æ€ä¸ºåˆå§‹åŒ–çŠ¶æ€,æ­¤æ—¶é€šè¿‡compareAndSetWaitStatus(pred, ws, Node.SIGNAL)æ–¹æ³•å°†predçš„çŠ¶æ€æ”¹ä¸ºSIGNALã€‚ å…¶å®è¿™ä¸ªæ–¹æ³•çš„å«ä¹‰å¾ˆç®€å•,å°±æ˜¯ç¡®ä¿å½“å‰ç»“ç‚¹çš„å‰é©±ç»“ç‚¹çš„çŠ¶æ€ä¸ºSIGNAL,SIGNALæ„å‘³ç€çº¿ç¨‹é‡Šæ”¾é”åä¼šå”¤é†’åé¢é˜»å¡çš„çº¿ç¨‹ã€‚æ¯•ç«Ÿ,åªæœ‰ç¡®ä¿èƒ½å¤Ÿè¢«å”¤é†’ï¼Œå½“å‰çº¿ç¨‹æ‰èƒ½æ”¾å¿ƒçš„é˜»å¡ã€‚ ä½†æ˜¯è¦æ³¨æ„åªæœ‰åœ¨å‰é©±ç»“ç‚¹å·²ç»æ˜¯SIGNALçŠ¶æ€åæ‰ä¼šæ‰§è¡Œåé¢çš„æ–¹æ³•ç«‹å³é˜»å¡,å¯¹åº”ä¸Šé¢çš„ç¬¬ä¸€ç§æƒ…å†µã€‚å…¶ä»–ä¸¤ç§æƒ…å†µåˆ™å› ä¸ºè¿”å›falseè€Œé‡æ–°æ‰§è¡Œä¸€é forå¾ªç¯ã€‚è¿™ç§å»¶è¿Ÿé˜»å¡å…¶å®ä¹Ÿæ˜¯ä¸€ç§é«˜å¹¶å‘åœºæ™¯ä¸‹çš„ä¼˜åŒ–,è¯•æƒ³æˆ‘å¦‚æœåœ¨é‡æ–°æ‰§è¡Œå¾ªç¯çš„æ—¶å€™æˆåŠŸè·å–äº†é”,æ˜¯ä¸æ˜¯çº¿ç¨‹é˜»å¡å”¤é†’çš„å¼€é”€å°±çœäº†å‘¢ï¼Ÿ æœ€åæˆ‘ä»¬æ¥çœ‹çœ‹é˜»å¡çº¿ç¨‹çš„æ–¹æ³•parkAndCheckInterrupt shouldParkAfterFailedAcquireè¿”å›trueè¡¨ç¤ºåº”è¯¥é˜»å¡å½“å‰çº¿ç¨‹,åˆ™ä¼šæ‰§è¡ŒparkAndCheckInterruptæ–¹æ³•,è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒç®€å•,åº•å±‚è°ƒç”¨äº†LockSupportæ¥é˜»å¡å½“å‰çº¿ç¨‹,æºç å¦‚ä¸‹: /** * Convenience method to park and then check if interrupted * * @return {@code true} if interrupted */ private final boolean parkAndCheckInterrupt() { LockSupport.park(this); return Thread.interrupted(); } è¯¥æ–¹æ³•å†…éƒ¨é€šè¿‡è°ƒç”¨LockSupportçš„parkæ–¹æ³•æ¥é˜»å¡å½“å‰çº¿ç¨‹ LockSupportå°±æ˜¯é€šè¿‡æ§åˆ¶å˜é‡_counteræ¥å¯¹çº¿ç¨‹é˜»å¡å”¤é†’è¿›è¡Œæ§åˆ¶çš„ã€‚åŸç†æœ‰ç‚¹ç±»ä¼¼äºä¿¡å·é‡æœºåˆ¶ã€‚ å½“è°ƒç”¨park()æ–¹æ³•æ—¶ï¼Œä¼šå°†_counterç½®ä¸º0ï¼ŒåŒæ—¶åˆ¤æ–­å‰å€¼ï¼Œå°äº1è¯´æ˜å‰é¢è¢«unparkè¿‡,åˆ™ç›´æ¥é€€å‡ºï¼Œå¦åˆ™å°†ä½¿è¯¥çº¿ç¨‹é˜»å¡ã€‚ å½“è°ƒç”¨unpark()æ–¹æ³•æ—¶ï¼Œä¼šå°†_counterç½®ä¸º1ï¼ŒåŒæ—¶åˆ¤æ–­å‰å€¼ï¼Œå°äº1ä¼šè¿›è¡Œçº¿ç¨‹å”¤é†’ï¼Œå¦åˆ™ç›´æ¥é€€å‡ºã€‚ å½¢è±¡çš„ç†è§£ï¼Œçº¿ç¨‹é˜»å¡éœ€è¦æ¶ˆè€—å‡­è¯(permit)ï¼Œè¿™ä¸ªå‡­è¯æœ€å¤šåªæœ‰1ä¸ªã€‚å½“è°ƒç”¨parkæ–¹æ³•æ—¶ï¼Œå¦‚æœæœ‰å‡­è¯ï¼Œåˆ™ä¼šç›´æ¥æ¶ˆè€—æ‰è¿™ä¸ªå‡­è¯ç„¶åæ­£å¸¸é€€å‡ºï¼›ä½†æ˜¯å¦‚æœæ²¡æœ‰å‡­è¯ï¼Œå°±å¿…é¡»é˜»å¡ç­‰å¾…å‡­è¯å¯ç”¨ï¼›è€Œunparkåˆ™ç›¸åï¼Œå®ƒä¼šå¢åŠ ä¸€ä¸ªå‡­è¯ï¼Œä½†å‡­è¯æœ€å¤šåªèƒ½æœ‰1ä¸ªã€‚ ä¸ºä»€ä¹ˆå¯ä»¥å…ˆå”¤é†’çº¿ç¨‹åé˜»å¡çº¿ç¨‹ï¼Ÿ å› ä¸ºunparkè·å¾—äº†ä¸€ä¸ªå‡­è¯,ä¹‹åè°ƒç”¨parkå› ä¸ºæœ‰å‡­è¯æ¶ˆè´¹ï¼Œæ•…ä¸ä¼šé˜»å¡ã€‚ ä¸ºä»€ä¹ˆå”¤é†’ä¸¤æ¬¡åé˜»å¡ä¸¤æ¬¡ä¼šé˜»å¡çº¿ç¨‹ã€‚ å› ä¸ºå‡­è¯çš„æ•°é‡æœ€å¤šä¸º1ï¼Œè¿ç»­è°ƒç”¨ä¸¤æ¬¡unparkå’Œè°ƒç”¨ä¸€æ¬¡unparkæ•ˆæœä¸€æ ·ï¼Œåªä¼šå¢åŠ ä¸€ä¸ªå‡­è¯ï¼›è€Œè°ƒç”¨ä¸¤æ¬¡parkå´éœ€è¦æ¶ˆè´¹ä¸¤ä¸ªå‡­è¯ã€‚ ä¸‹é¢é€šè¿‡ä¸€å¼ æµç¨‹å›¾æ¥è¯´æ˜çº¿ç¨‹ä»åŠ å…¥åŒæ­¥é˜Ÿåˆ—åˆ°æˆåŠŸè·å–é”çš„è¿‡ç¨‹ æ¦‚æ‹¬çš„è¯´,çº¿ç¨‹åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ä¼šå°è¯•è·å–é”,å¤±è´¥åˆ™è¢«é˜»å¡,è¢«å”¤é†’åä¼šä¸åœçš„é‡å¤è¿™ä¸ªè¿‡ç¨‹,ç›´åˆ°çº¿ç¨‹çœŸæ­£æŒæœ‰äº†é”,å¹¶å°†è‡ªèº«ç»“ç‚¹ç½®äºé˜Ÿåˆ—å¤´éƒ¨ã€‚ ReentrantLockéå…¬å¹³æ¨¡å¼ä¸‹çš„åŠ é”æµç¨‹å¦‚ä¸‹ è§£é” è§£é”æºç å¦‚ä¸‹ï¼š public void unlock() { sync.release(1); } public final boolean release(int arg) { if (tryRelease(arg)) { //é‡Šæ”¾é”(state-1),è‹¥é‡Šæ”¾åé”å¯è¢«å…¶ä»–çº¿ç¨‹è·å–(state=0),è¿”å›true Node h = head; //å½“å‰é˜Ÿåˆ—ä¸ä¸ºç©ºä¸”å¤´ç»“ç‚¹çŠ¶æ€ä¸ä¸ºåˆå§‹åŒ–çŠ¶æ€(0) if (h != null &amp;&amp; h.waitStatus != 0) unparkSuccessor(h); //å”¤é†’åŒæ­¥é˜Ÿåˆ—ä¸­è¢«é˜»å¡çš„çº¿ç¨‹ return true; } return false; } æ­£ç¡®æ‰¾åˆ°syncçš„å®ç°ç±»,æ‰¾åˆ°çœŸæ­£çš„å…¥å£æ–¹æ³•,ä¸»è¦å†…å®¹éƒ½åœ¨ä¸€ä¸ªifè¯­å¥ä¸­,å…ˆçœ‹ä¸‹åˆ¤æ–­æ¡ä»¶tryReleaseæ–¹æ³• protected final boolean tryRelease(int releases) { int c = getState() - releases; //è®¡ç®—å¾…æ›´æ–°çš„stateå€¼ if (Thread.currentThread() != getExclusiveOwnerThread()) throw new IllegalMonitorStateException(); boolean free = false; if (c == 0) { //å¾…æ›´æ–°çš„stateå€¼ä¸º0,è¯´æ˜æŒæœ‰é”çš„çº¿ç¨‹æœªé‡å…¥,ä¸€æ—¦é‡Šæ”¾é”å…¶ä»–çº¿ç¨‹å°†èƒ½è·å– free = true; setExclusiveOwnerThread(null);//æ¸…é™¤é”çš„æŒæœ‰çº¿ç¨‹æ ‡è®° } setState(c);//æ›´æ–°stateå€¼ return free; } tryReleaseå…¶å®åªæ˜¯å°†çº¿ç¨‹æŒæœ‰é”çš„æ¬¡æ•°å‡1,å³å°†stateå€¼å‡1,è‹¥å‡å°‘åçº¿ç¨‹å°†å®Œå…¨é‡Šæ”¾é”(stateå€¼ä¸º0),åˆ™è¯¥æ–¹æ³•å°†è¿”å›true,å¦åˆ™è¿”å›falseã€‚ç”±äºæ‰§è¡Œè¯¥æ–¹æ³•çš„çº¿ç¨‹å¿…ç„¶æŒæœ‰é”,æ•…è¯¥æ–¹æ³•ä¸éœ€è¦ä»»ä½•åŒæ­¥æ“ä½œã€‚ è‹¥å½“å‰çº¿ç¨‹å·²ç»å®Œå…¨é‡Šæ”¾é”,å³é”å¯è¢«å…¶ä»–çº¿ç¨‹ä½¿ç”¨,åˆ™è¿˜åº”è¯¥å”¤é†’åç»­ç­‰å¾…çº¿ç¨‹ã€‚ä¸è¿‡åœ¨æ­¤ä¹‹å‰éœ€è¦è¿›è¡Œä¸¤ä¸ªæ¡ä»¶çš„åˆ¤æ–­ï¼š h!=nullæ˜¯ä¸ºäº†é˜²æ­¢é˜Ÿåˆ—ä¸ºç©º,å³æ²¡æœ‰ä»»ä½•çº¿ç¨‹å¤„äºç­‰å¾…é˜Ÿåˆ—ä¸­,é‚£ä¹ˆä¹Ÿå°±ä¸éœ€è¦è¿›è¡Œå”¤é†’çš„æ“ä½œ h.waitStatus != 0æ˜¯ä¸ºäº†é˜²æ­¢é˜Ÿåˆ—ä¸­è™½æœ‰çº¿ç¨‹,ä½†è¯¥çº¿ç¨‹è¿˜æœªé˜»å¡,ç”±å‰é¢çš„åˆ†æçŸ¥,çº¿ç¨‹åœ¨é˜»å¡è‡ªå·±å‰å¿…é¡»è®¾ç½®å‰é©±ç»“ç‚¹çš„çŠ¶æ€ä¸ºSIGNAL,å¦åˆ™å®ƒä¸ä¼šé˜»å¡è‡ªå·±ã€‚ æ¥ä¸‹æ¥å°±æ˜¯å”¤é†’çº¿ç¨‹çš„æ“ä½œ,unparkSuccessor(h)æºç å¦‚ä¸‹ private void unparkSuccessor(Node node) { /* * If status is negative (i.e., possibly needing signal) try * to clear in anticipation of signalling. It is OK if this * fails or if status is changed by waiting thread. */ int ws = node.waitStatus; if (ws &lt; 0) compareAndSetWaitStatus(node, ws, 0); /* * Thread to unpark is held in successor, which is normally * just the next node. But if cancelled or apparently null, * traverse backwards from tail to find the actual * non-cancelled successor. */ Node s = node.next; if (s == null || s.waitStatus &gt; 0) { s = null; for (Node t = tail; t != null &amp;&amp; t != node; t = t.prev) if (t.waitStatus &lt;= 0) s = t; } if (s != null) LockSupport.unpark(s.thread); } ä¸€èˆ¬æƒ…å†µä¸‹åªè¦å”¤é†’åç»§ç»“ç‚¹çš„çº¿ç¨‹å°±è¡Œäº†,ä½†æ˜¯åç»§ç»“ç‚¹å¯èƒ½å·²ç»å–æ¶ˆç­‰å¾…,æ‰€ä»¥ä»é˜Ÿåˆ—å°¾éƒ¨å¾€å‰å›æº¯,æ‰¾åˆ°ç¦»å¤´ç»“ç‚¹æœ€è¿‘çš„æ­£å¸¸ç»“ç‚¹,å¹¶å”¤é†’å…¶çº¿ç¨‹ã€‚ è§£é”æµç¨‹æºç æ€»ç»“ å…¬å¹³é”ç›¸æ¯”éå…¬å¹³é”çš„ä¸åŒ å…¬å¹³é”æ¨¡å¼ä¸‹,å¯¹é”çš„è·å–æœ‰ä¸¥æ ¼çš„æ¡ä»¶é™åˆ¶ã€‚åœ¨åŒæ­¥é˜Ÿåˆ—æœ‰çº¿ç¨‹ç­‰å¾…çš„æƒ…å†µä¸‹,æ‰€æœ‰çº¿ç¨‹åœ¨è·å–é”å‰å¿…é¡»å…ˆåŠ å…¥åŒæ­¥é˜Ÿåˆ—ã€‚é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹æŒ‰åŠ å…¥é˜Ÿåˆ—çš„å…ˆåæ¬¡åºè·å¾—é”ã€‚ ä»å…¬å¹³é”åŠ é”çš„å…¥å£å¼€å§‹, å¯¹æ¯”éå…¬å¹³é”,å°‘äº†éé‡å…¥å¼è·å–é”çš„æ–¹æ³•,è¿™æ˜¯ç¬¬ä¸€ä¸ªä¸åŒç‚¹ æ¥ç€çœ‹è·å–é”çš„é€šç”¨æ–¹æ³•tryAcquire(),è¯¥æ–¹æ³•åœ¨çº¿ç¨‹æœªè¿›å…¥é˜Ÿåˆ—,åŠ å…¥é˜Ÿåˆ—é˜»å¡å‰å’Œé˜»å¡åè¢«å”¤é†’æ—¶éƒ½ä¼šæ‰§è¡Œã€‚ åœ¨çœŸæ­£CASè·å–é”ä¹‹å‰åŠ äº†åˆ¤æ–­,å†…å®¹å¦‚ä¸‹ public final boolean hasQueuedPredecessors() { // The correctness of this depends on head being initialized // before tail and on head.next being accurate if the current // thread is first in queue. Node t = tail; // Read fields in reverse initialization order Node h = head; Node s; return h != t &amp;&amp; ((s = h.next) == null || s.thread != Thread.currentThread()); } ä»æ–¹æ³•åæˆ‘ä»¬å°±å¯çŸ¥é“è¿™æ˜¯åˆ¤æ–­é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰ä¼˜å…ˆçº§æ›´é«˜çš„ç­‰å¾…çº¿ç¨‹,é˜Ÿåˆ—ä¸­å“ªä¸ªçº¿ç¨‹ä¼˜å…ˆçº§æœ€é«˜ï¼Ÿç”±äºå¤´ç»“ç‚¹æ˜¯å½“å‰è·å–é”çš„çº¿ç¨‹,é˜Ÿåˆ—ä¸­çš„ç¬¬äºŒä¸ªç»“ç‚¹ä»£è¡¨çš„çº¿ç¨‹ä¼˜å…ˆçº§æœ€é«˜ã€‚ é‚£ä¹ˆæˆ‘ä»¬åªè¦åˆ¤æ–­é˜Ÿåˆ—ä¸­ç¬¬äºŒä¸ªç»“ç‚¹æ˜¯å¦å­˜åœ¨ä»¥åŠè¿™ä¸ªç»“ç‚¹æ˜¯å¦ä»£è¡¨å½“å‰çº¿ç¨‹å°±è¡Œäº†ã€‚è¿™é‡Œåˆ†äº†ä¸¤ç§æƒ…å†µè¿›è¡Œæ¢è®¨: ç¬¬äºŒä¸ªç»“ç‚¹å·²ç»å®Œå…¨æ’å…¥,ä½†æ˜¯è¿™ä¸ªç»“ç‚¹æ˜¯å¦å°±æ˜¯å½“å‰çº¿ç¨‹æ‰€åœ¨ç»“ç‚¹è¿˜æœªçŸ¥,æ‰€ä»¥é€šè¿‡s.thread != Thread.currentThread()è¿›è¡Œåˆ¤æ–­,å¦‚æœä¸ºtrue,è¯´æ˜ç¬¬äºŒä¸ªç»“ç‚¹ä»£è¡¨å…¶ä»–çº¿ç¨‹ã€‚ ç¬¬äºŒä¸ªç»“ç‚¹å¹¶æœªå®Œå…¨æ’å…¥,æˆ‘ä»¬çŸ¥é“ç»“ç‚¹å…¥é˜Ÿä¸€å…±åˆ†ä¸‰æ­¥ï¼š 1.å¾…æ’å…¥ç»“ç‚¹çš„preæŒ‡é’ˆæŒ‡å‘åŸå°¾ç»“ç‚¹ 2.CASæ›´æ–°å°¾æŒ‡é’ˆ 3.åŸå°¾ç»“ç‚¹çš„nextæŒ‡é’ˆæŒ‡å‘æ–°æ’å…¥ç»“ç‚¹ æ‰€ä»¥(s = h.next) == null å°±æ˜¯ç”¨æ¥åˆ¤æ–­2åˆšæ‰§è¡ŒæˆåŠŸä½†è¿˜æœªæ‰§è¡Œ3è¿™ç§æƒ…å†µçš„ã€‚è¿™ç§æƒ…å†µç¬¬äºŒä¸ªç»“ç‚¹å¿…ç„¶å±äºå…¶ä»–çº¿ç¨‹ã€‚ ä»¥ä¸Šä¸¤ç§æƒ…å†µéƒ½ä¼šä½¿è¯¥æ–¹æ³•è¿”å›true,å³å½“å‰æœ‰ä¼˜å…ˆçº§æ›´é«˜çš„çº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…,é‚£ä¹ˆå½“å‰çº¿ç¨‹å°†ä¸ä¼šæ‰§è¡ŒCASæ“ä½œå»è·å–é”,ä¿è¯äº†çº¿ç¨‹è·å–é”çš„é¡ºåºä¸åŠ å…¥åŒæ­¥é˜Ÿåˆ—çš„é¡ºåºä¸€è‡´ï¼Œå¾ˆå¥½çš„ä¿è¯äº†å…¬å¹³æ€§,ä½†ä¹Ÿå¢åŠ äº†è·å–é”çš„æˆæœ¬ã€‚ ä¸€äº›ç–‘é—®çš„è§£ç­” ä¸ºä»€ä¹ˆåŸºäºFIFOçš„åŒæ­¥é˜Ÿåˆ—å¯ä»¥å®ç°éå…¬å¹³é”ï¼Ÿ ç”±FIFOé˜Ÿåˆ—çš„ç‰¹æ€§çŸ¥,å…ˆåŠ å…¥åŒæ­¥é˜Ÿåˆ—ç­‰å¾…çš„çº¿ç¨‹ä¼šæ¯”ååŠ å…¥çš„çº¿ç¨‹æ›´é è¿‘é˜Ÿåˆ—çš„å¤´éƒ¨,é‚£ä¹ˆå®ƒå°†æ¯”åè€…æ›´æ—©çš„è¢«å”¤é†’,å®ƒä¹Ÿå°±èƒ½æ›´æ—©çš„å¾—åˆ°é”ã€‚ä»è¿™ä¸ªæ„ä¹‰ä¸Š,å¯¹äºåœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ç­‰å¾…çš„çº¿ç¨‹è€Œè¨€,å®ƒä»¬è·å¾—é”çš„é¡ºåºå’ŒåŠ å…¥åŒæ­¥é˜Ÿåˆ—çš„é¡ºåºä¸€è‡´ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸€ç§å…¬å¹³æ¨¡å¼ã€‚ç„¶è€Œ,çº¿ç¨‹å¹¶éåªæœ‰åœ¨åŠ å…¥é˜Ÿåˆ—åæ‰æœ‰æœºä¼šè·å¾—é”,å“ªæ€•åŒæ­¥é˜Ÿåˆ—ä¸­å·²æœ‰çº¿ç¨‹åœ¨ç­‰å¾…,éå…¬å¹³é”çš„ä¸å…¬å¹³ä¹‹å¤„å°±åœ¨äºæ­¤ã€‚å›çœ‹ä¸‹éå…¬å¹³é”çš„åŠ é”æµç¨‹,çº¿ç¨‹åœ¨è¿›å…¥åŒæ­¥é˜Ÿåˆ—ç­‰å¾…ä¹‹å‰æœ‰ä¸¤æ¬¡æŠ¢å é”çš„æœºä¼š: ç¬¬ä¸€æ¬¡æ˜¯éé‡å…¥å¼çš„è·å–é”,åªæœ‰åœ¨å½“å‰é”æœªè¢«ä»»ä½•çº¿ç¨‹å æœ‰(åŒ…æ‹¬è‡ªèº«)æ—¶æ‰èƒ½æˆåŠŸ; ç¬¬äºŒæ¬¡æ˜¯åœ¨è¿›å…¥åŒæ­¥é˜Ÿåˆ—å‰,åŒ…å«æ‰€æœ‰æƒ…å†µçš„è·å–é”çš„æ–¹å¼ã€‚ åªæœ‰è¿™ä¸¤æ¬¡è·å–é”éƒ½å¤±è´¥å,çº¿ç¨‹æ‰ä¼šæ„é€ ç»“ç‚¹å¹¶åŠ å…¥åŒæ­¥é˜Ÿåˆ—ç­‰å¾…ã€‚è€Œçº¿ç¨‹é‡Šæ”¾é”æ—¶æ˜¯å…ˆé‡Šæ”¾é”(ä¿®æ”¹stateå€¼),ç„¶åæ‰å”¤é†’åç»§ç»“ç‚¹çš„çº¿ç¨‹çš„ã€‚è¯•æƒ³ä¸‹è¿™ç§æƒ…å†µ,çº¿ç¨‹Aå·²ç»é‡Šæ”¾é”,ä½†è¿˜æ²¡æ¥å¾—åŠå”¤é†’åç»§çº¿ç¨‹C,è€Œè¿™æ—¶å¦ä¸€ä¸ªçº¿ç¨‹Båˆšå¥½å°è¯•è·å–é”,æ­¤æ—¶é”æ°å¥½ä¸è¢«ä»»ä½•çº¿ç¨‹æŒæœ‰,å®ƒå°†æˆåŠŸè·å–é”è€Œä¸ç”¨åŠ å…¥é˜Ÿåˆ—ç­‰å¾…ã€‚çº¿ç¨‹Cè¢«å”¤é†’å°è¯•è·å–é”,è€Œæ­¤æ—¶é”å·²ç»è¢«çº¿ç¨‹BæŠ¢å ,æ•…è€Œå…¶è·å–å¤±è´¥å¹¶ç»§ç»­åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ã€‚æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º å¦‚æœä»¥çº¿ç¨‹ç¬¬ä¸€æ¬¡å°è¯•è·å–é”åˆ°æœ€åæˆåŠŸè·å–é”çš„æ¬¡åºæ¥çœ‹,éå…¬å¹³é”ç¡®å®å¾ˆä¸å…¬å¹³ã€‚å› ä¸ºåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…å¾ˆä¹…çš„çº¿ç¨‹ç›¸æ¯”è¿˜æœªè¿›å…¥é˜Ÿåˆ—ç­‰å¾…çš„çº¿ç¨‹å¹¶æ²¡æœ‰ä¼˜å…ˆæƒ,ç”šè‡³ç«äº‰ä¹Ÿå¤„äºåŠ£åŠ¿:åœ¨é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹è¦ç­‰å¾…å…¶ä»–çº¿ç¨‹å”¤é†’,åœ¨è·å–é”ä¹‹å‰è¿˜è¦æ£€æŸ¥å‰é©±ç»“ç‚¹æ˜¯å¦ä¸ºå¤´ç»“ç‚¹ã€‚åœ¨é”ç«äº‰æ¿€çƒˆçš„æƒ…å†µä¸‹,åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…çš„çº¿ç¨‹å¯èƒ½è¿Ÿè¿Ÿç«äº‰ä¸åˆ°é”ã€‚è¿™ä¹Ÿå°±éå…¬å¹³åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ä¼šå‡ºç°çš„é¥¥é¥¿é—®é¢˜ã€‚é‚£æˆ‘ä»¬å†å¼€å‘ä¸­ä¸ºä»€ä¹ˆå¤§å¤šä½¿ç”¨ä¼šå¯¼è‡´é¥¥é¥¿çš„éå…¬å¹³é”ï¼Ÿå¾ˆç®€å•,å› ä¸ºå®ƒæ€§èƒ½å¥½å•Šã€‚ ä¸ºä»€ä¹ˆéå…¬å¹³é”æ€§èƒ½å¥½ éå…¬å¹³é”å¯¹é”çš„ç«äº‰æ˜¯æŠ¢å å¼çš„(é˜Ÿåˆ—ä¸­çº¿ç¨‹é™¤å¤–),çº¿ç¨‹åœ¨è¿›å…¥ç­‰å¾…é˜Ÿåˆ—å‰å¯ä»¥è¿›è¡Œä¸¤æ¬¡å°è¯•,è¿™å¤§å¤§å¢åŠ äº†è·å–é”çš„æœºä¼šã€‚è¿™ç§å¥½å¤„ä½“ç°åœ¨ä¸¤ä¸ªæ–¹é¢: 1.çº¿ç¨‹ä¸å¿…åŠ å…¥ç­‰å¾…é˜Ÿåˆ—å°±å¯ä»¥è·å¾—é”,ä¸ä»…å…å»äº†æ„é€ ç»“ç‚¹å¹¶åŠ å…¥é˜Ÿåˆ—çš„ç¹çæ“ä½œ,åŒæ—¶ä¹ŸèŠ‚çœäº†çº¿ç¨‹é˜»å¡å”¤é†’çš„å¼€é”€,çº¿ç¨‹é˜»å¡å’Œå”¤é†’æ¶‰åŠåˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡çš„åˆ‡æ¢å’Œæ“ä½œç³»ç»Ÿçš„ç³»ç»Ÿè°ƒç”¨,æ˜¯éå¸¸è€—æ—¶çš„ã€‚åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹,å¦‚æœçº¿ç¨‹æŒæœ‰é”çš„æ—¶é—´éå¸¸çŸ­,çŸ­åˆ°çº¿ç¨‹å…¥é˜Ÿé˜»å¡çš„è¿‡ç¨‹è¶…è¿‡çº¿ç¨‹æŒæœ‰å¹¶é‡Šæ”¾é”çš„æ—¶é—´å¼€é”€,é‚£ä¹ˆè¿™ç§æŠ¢å å¼ç‰¹æ€§å¯¹å¹¶å‘æ€§èƒ½çš„æå‡ä¼šæ›´åŠ æ˜æ˜¾ã€‚ 2.å‡å°‘CASç«äº‰ã€‚å¦‚æœçº¿ç¨‹å¿…é¡»è¦åŠ å…¥é˜»å¡é˜Ÿåˆ—æ‰èƒ½è·å–é”,é‚£å…¥é˜Ÿæ—¶CASç«äº‰å°†å˜å¾—å¼‚å¸¸æ¿€çƒˆ,CASæ“ä½œè™½ç„¶ä¸ä¼šå¯¼è‡´å¤±è´¥çº¿ç¨‹æŒ‚èµ·,ä½†ä¸æ–­å¤±è´¥é‡è¯•å¯¼è‡´çš„å¯¹CPUçš„æµªè´¹ä¹Ÿä¸èƒ½å¿½è§†ã€‚é™¤æ­¤ä¹‹å¤–,åŠ é”æµç¨‹ä¸­è‡³å°‘æœ‰ä¸¤å¤„é€šè¿‡å°†æŸäº›ç‰¹æ®Šæƒ…å†µæå‰æ¥å‡å°‘CASæ“ä½œçš„ç«äº‰,å¢åŠ å¹¶å‘æƒ…å†µä¸‹çš„æ€§èƒ½ã€‚ä¸€å¤„å°±æ˜¯è·å–é”æ—¶å°†éé‡å…¥çš„æƒ…å†µæå‰,å¦‚ä¸‹å›¾æ‰€ç¤º å¦ä¸€å¤„å°±æ˜¯å…¥é˜Ÿçš„æ“ä½œ,å°†åŒæ­¥é˜Ÿåˆ—éç©ºçš„æƒ…å†µæå‰å¤„ç† è¿™ä¸¤éƒ¨åˆ†çš„ä»£ç åœ¨ä¹‹åçš„é€šç”¨é€»è¾‘å¤„ç†ä¸­éƒ½æœ‰,å¾ˆæ˜¾ç„¶å±äºé‡å¤ä»£ç ,ä½†å› ä¸ºé¿å…äº†æ‰§è¡Œæ— æ„ä¹‰çš„æµç¨‹ä»£ç ,æ¯”å¦‚forå¾ªç¯,è·å–åŒæ­¥çŠ¶æ€ç­‰,é«˜å¹¶å‘åœºæ™¯ä¸‹ä¹Ÿèƒ½å‡å°‘CASç«äº‰å¤±è´¥çš„å¯èƒ½ã€‚ è¯»å†™é”ReentrantReadWriteLock é¦–å…ˆæ˜ç¡®ä¸€ä¸‹ï¼Œä¸æ˜¯è¯´ ReentrantLock ä¸å¥½ï¼Œåªæ˜¯ ReentrantLock æŸäº›æ—¶å€™æœ‰å±€é™ã€‚å¦‚æœä½¿ç”¨ ReentrantLockï¼Œå¯èƒ½æœ¬èº«æ˜¯ä¸ºäº†é˜²æ­¢çº¿ç¨‹ A åœ¨å†™æ•°æ®ã€çº¿ç¨‹ B åœ¨è¯»æ•°æ®é€ æˆçš„æ•°æ®ä¸ä¸€è‡´ï¼Œä½†è¿™æ ·ï¼Œå¦‚æœçº¿ç¨‹ C åœ¨è¯»æ•°æ®ã€çº¿ç¨‹ D ä¹Ÿåœ¨è¯»æ•°æ®ï¼Œè¯»æ•°æ®æ˜¯ä¸ä¼šæ”¹å˜æ•°æ®çš„ï¼Œæ²¡æœ‰å¿…è¦åŠ é”ï¼Œä½†æ˜¯è¿˜æ˜¯åŠ é”äº†ï¼Œé™ä½äº†ç¨‹åºçš„æ€§èƒ½ã€‚å› ä¸ºè¿™ä¸ªï¼Œæ‰è¯ç”Ÿäº†è¯»å†™é” ReadWriteLockã€‚ ReadWriteLock æ˜¯ä¸€ä¸ªè¯»å†™é”æ¥å£ï¼Œè¯»å†™é”æ˜¯ç”¨æ¥æå‡å¹¶å‘ç¨‹åºæ€§èƒ½çš„é”åˆ†ç¦»æŠ€æœ¯ï¼ŒReentrantReadWriteLock æ˜¯ ReadWriteLock æ¥å£çš„ä¸€ä¸ªå…·ä½“å®ç°ï¼Œå®ç°äº†è¯»å†™çš„åˆ†ç¦»ï¼Œè¯»é”æ˜¯å…±äº«çš„ï¼Œå†™é”æ˜¯ç‹¬å çš„ï¼Œè¯»å’Œè¯»ä¹‹é—´ä¸ä¼šäº’æ–¥ï¼Œè¯»å’Œå†™ã€å†™å’Œè¯»ã€å†™å’Œå†™ä¹‹é—´æ‰ä¼šäº’æ–¥ï¼Œæå‡äº†è¯»å†™çš„æ€§èƒ½ã€‚ è€Œè¯»å†™é”æœ‰ä»¥ä¸‹ä¸‰ä¸ªé‡è¦çš„ç‰¹æ€§ï¼š ï¼ˆ1ï¼‰å…¬å¹³é€‰æ‹©æ€§ï¼šæ”¯æŒéå…¬å¹³ï¼ˆé»˜è®¤ï¼‰å’Œå…¬å¹³çš„é”è·å–æ–¹å¼ï¼Œååé‡è¿˜æ˜¯éå…¬å¹³ä¼˜äºå…¬å¹³ã€‚ ï¼ˆ2ï¼‰é‡è¿›å…¥ï¼šè¯»é”å’Œå†™é”éƒ½æ”¯æŒçº¿ç¨‹é‡è¿›å…¥ã€‚ ","link":"https://tianxiawuhao.github.io/CxCcIUkNX/"},{"title":"nettyé›¶æ‹·è´","content":"é›¶æ‹·è´çš„åº”ç”¨ç¨‹åºè¦æ±‚å†…æ ¸ï¼ˆkernelï¼‰ç›´æ¥å°†æ•°æ®ä»ç£ç›˜æ–‡ä»¶æ‹·è´åˆ°å¥—æ¥å­—ï¼ˆSocketï¼‰ï¼Œè€Œæ— é¡»é€šè¿‡åº”ç”¨ç¨‹åºã€‚é›¶æ‹·è´ä¸ä»…æé«˜äº†åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼Œè€Œä¸”å‡å°‘äº†å†…æ ¸å’Œç”¨æˆ·æ¨¡å¼è§ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ æ•°æ®ä¼ è¾“ï¼šä¼ ç»Ÿæ–¹æ³• ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œå¹¶å°†æ•°æ®ä¼ è¾“åˆ°ç½‘ç»œä¸Šçš„å¦ä¸€ä¸ªç¨‹åºçš„åœºæ™¯ï¼šä»ä¸‹å›¾å¯ä»¥çœ‹å‡ºï¼Œæ‹·è´çš„æ“ä½œéœ€è¦4æ¬¡ç”¨æˆ·æ¨¡å¼å’Œå†…æ ¸æ¨¡å¼ä¹‹é—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè€Œä¸”åœ¨æ“ä½œå®Œæˆå‰æ•°æ®è¢«å¤åˆ¶äº†4æ¬¡ã€‚(DMAï¼šç›´æ¥å†…å­˜æ‹·è´) ä»ç£ç›˜ä¸­copyæ”¾åˆ°ä¸€ä¸ªå†…å­˜bufä¸­ï¼Œç„¶åå°†bufé€šè¿‡socketä¼ è¾“ç»™ç”¨æˆ·,ä¸‹é¢æ˜¯ä¼ªä»£ç å®ç°ï¼š read(file, tmp_buf, len); write(socket, tmp_buf, len); ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºæ–‡ä»¶ç»å†äº†4æ¬¡copyè¿‡ç¨‹ï¼š 1.é¦–å…ˆï¼Œè°ƒç”¨readæ–¹æ³•ï¼Œæ–‡ä»¶ä»useræ¨¡å¼æ‹·è´åˆ°äº†kernelæ¨¡å¼ï¼›ï¼ˆç”¨æˆ·æ¨¡å¼-&gt;å†…æ ¸æ¨¡å¼çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œåœ¨å†…éƒ¨å‘é€sys_read() ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œå­˜å‚¨åˆ°ä¸€ä¸ªå†…æ ¸åœ°å€ç©ºé—´ç¼“å­˜åŒºä¸­ï¼‰ 2.ä¹‹åCPUæ§åˆ¶å°†kernelæ¨¡å¼æ•°æ®æ‹·è´åˆ°useræ¨¡å¼ä¸‹ï¼›ï¼ˆå†…æ ¸æ¨¡å¼-&gt; ç”¨æˆ·æ¨¡å¼çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œread()è°ƒç”¨è¿”å›ï¼Œæ•°æ®è¢«å­˜å‚¨åˆ°ç”¨æˆ·åœ°å€ç©ºé—´çš„ç¼“å­˜åŒºä¸­ï¼‰ 3.è°ƒç”¨writeæ—¶å€™ï¼Œå…ˆå°†useræ¨¡å¼ä¸‹çš„å†…å®¹copyåˆ°kernelæ¨¡å¼ä¸‹çš„socketçš„bufferä¸­ï¼ˆç”¨æˆ·æ¨¡å¼-&gt;å†…æ ¸æ¨¡å¼ï¼Œæ•°æ®å†æ¬¡è¢«æ”¾ç½®åœ¨å†…æ ¸ç¼“å­˜åŒºä¸­ï¼Œsendï¼ˆï¼‰å¥—æ¥å­—è°ƒç”¨ï¼‰ 4.æœ€åå°†kernelæ¨¡å¼ä¸‹çš„socket bufferçš„æ•°æ®copyåˆ°ç½‘å¡è®¾å¤‡ä¸­ï¼›ï¼ˆsendå¥—æ¥å­—è°ƒç”¨è¿”å›ï¼‰ ä»å›¾ä¸­çœ‹2ï¼Œ3ä¸¤æ¬¡copyæ˜¯å¤šä½™çš„ï¼Œæ•°æ®ä»kernelæ¨¡å¼åˆ°useræ¨¡å¼èµ°äº†ä¸€åœˆï¼Œæµªè´¹äº†2æ¬¡copyã€‚ æ•°æ®ä¼ è¾“ï¼šmmap ä¼˜åŒ– mmap é€šè¿‡å†…å­˜æ˜ å°„ï¼Œå°†æ–‡ä»¶æ˜ å°„åˆ°å†…æ ¸ç¼“å†²åŒºï¼ŒåŒæ—¶ï¼Œç”¨æˆ·ç©ºé—´å¯ä»¥å…±äº«å†…æ ¸ç©ºé—´çš„æ•°æ®ã€‚è¿™æ ·ï¼Œåœ¨è¿›è¡Œç½‘ç»œä¼ è¾“æ—¶ï¼Œå°±å¯ä»¥å‡å°‘å†…æ ¸ç©ºé—´åˆ°ç”¨æˆ·ç©ºé—´çš„æ‹·è´æ¬¡æ•°ã€‚å¦‚ä¸‹å›¾ï¼š å¦‚ä¸Šå›¾ï¼Œuser buffer å’Œ kernel buffer å…±äº« index.htmlã€‚å¦‚æœä½ æƒ³æŠŠç¡¬ç›˜çš„ index.html ä¼ è¾“åˆ°ç½‘ç»œä¸­ï¼Œå†ä¹Ÿä¸ç”¨æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå†ä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ° Socket ç¼“å†²åŒºã€‚ ç°åœ¨ï¼Œä½ åªéœ€è¦ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ° Socket ç¼“å†²åŒºå³å¯ï¼Œè¿™å°†å‡å°‘ä¸€æ¬¡å†…å­˜æ‹·è´ï¼ˆä» 4 æ¬¡å˜æˆäº† 3 æ¬¡ï¼‰ï¼Œä½†ä¸å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°ã€‚ æ•°æ®ä¼ è¾“ï¼šé›¶æ‹·è´æ–¹æ³• ä»ä¼ ç»Ÿçš„åœºæ™¯çœ‹ï¼Œä¼šæ³¨æ„åˆ°ä¸Šå›¾ï¼Œç¬¬2æ¬¡å’Œç¬¬3æ¬¡æ‹·è´æ ¹æœ¬å°±æ˜¯å¤šä½™çš„ã€‚åº”ç”¨ç¨‹åºåªæ˜¯èµ·åˆ°ç¼“å­˜æ•°æ®è¢«å°†ä¼ å›åˆ°å¥—æ¥å­—çš„ä½œç”¨è€Œå·²ï¼Œåˆ«æ— ä»–ç”¨ã€‚ åº”ç”¨ç¨‹åºä½¿ç”¨zero-copyæ¥è¯·æ±‚kernelç›´æ¥æŠŠdiskçš„æ•°æ®ä¼ è¾“åˆ°socketä¸­ï¼Œè€Œä¸æ˜¯é€šè¿‡åº”ç”¨ç¨‹åºä¼ è¾“ã€‚zero-copyå¤§å¤§æé«˜äº†åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼Œå¹¶ä¸”å‡å°‘äº†kernelå’Œuseræ¨¡å¼çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ æ•°æ®å¯ä»¥ç›´æ¥ä»read buffer è¯»ç¼“å­˜åŒºä¼ è¾“åˆ°å¥—æ¥å­—ç¼“å†²åŒºï¼Œä¹Ÿå°±æ˜¯çœå»äº†å°†æ“ä½œç³»ç»Ÿçš„read buffer æ‹·è´åˆ°ç¨‹åºçš„bufferï¼Œä»¥åŠä»ç¨‹åºbufferæ‹·è´åˆ°socket bufferçš„æ­¥éª¤ï¼Œç›´æ¥å°†read bufferæ‹·è´åˆ°socket bufferã€‚JDK NIOä¸­çš„çš„transferTo() æ–¹æ³•å°±èƒ½å¤Ÿè®©æ‚¨å®ç°è¿™ä¸ªæ“ä½œï¼Œè¿™ä¸ªå®ç°ä¾èµ–äºæ“ä½œç³»ç»Ÿåº•å±‚çš„sendFileï¼ˆï¼‰å®ç°çš„ï¼š public void transferTo(long position, long count, WritableByteChannel target); åº•å±‚è°ƒç”¨sendFileæ–¹æ³•ï¼š #include &lt;sys/socket.h&gt; ssize_t sendfile(int out_fd, int in_fd, off_t *offset, size_t count); ä½¿ç”¨äº†zero-copyæŠ€æœ¯åï¼Œæ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹ï¼š 1.transferTo()æ–¹æ³•ä½¿å¾—æ–‡ä»¶çš„å†…å®¹ç›´æ¥copyåˆ°äº†ä¸€ä¸ªread bufferï¼ˆkernel bufferï¼‰ä¸­ 2.ç„¶åæ•°æ®ï¼ˆkernel bufferï¼‰copyåˆ°socket bufferä¸­ 3.æœ€åå°†socket bufferä¸­çš„æ•°æ®copyåˆ°ç½‘å¡è®¾å¤‡ï¼ˆprotocol engineï¼‰ä¸­ä¼ è¾“ï¼› è¿™ä¸ªæ˜¾ç„¶æ˜¯ä¸€ä¸ªä¼Ÿå¤§çš„è¿›æ­¥ï¼šè¿™é‡Œä¸Šä¸‹æ–‡åˆ‡æ¢ä»4æ¬¡å‡å°‘åˆ°2æ¬¡ï¼ŒåŒæ—¶æŠŠæ•°æ®copyçš„æ¬¡æ•°ä»4æ¬¡é™ä½åˆ°3æ¬¡ï¼› ä½†æ˜¯è¿™æ˜¯zero-copyä¹ˆï¼Œç­”æ¡ˆæ˜¯å¦å®šçš„ï¼› linux 2.1 å†…æ ¸å¼€å§‹å¼•å…¥äº†sendfileå‡½æ•°ï¼Œç”¨äºå°†æ–‡ä»¶é€šè¿‡socketä¼ è¾“ã€‚ sendfile(socket, file, len); è¯¥å‡½æ•°é€šè¿‡ä¸€æ¬¡è°ƒç”¨å®Œæˆäº†æ–‡ä»¶çš„ä¼ è¾“ã€‚ è¯¥å‡½æ•°é€šè¿‡ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨å®Œæˆäº†æ–‡ä»¶çš„ä¼ è¾“ï¼Œå‡å°‘äº†åŸæ¥read/writeæ–¹å¼çš„æ¨¡å¼åˆ‡æ¢ã€‚æ­¤å¤–æ›´æ˜¯å‡å°‘äº†æ•°æ®çš„copyï¼Œsendfileçš„è¯¦ç»†è¿‡ç¨‹å¦‚å›¾ï¼š é€šè¿‡sendfileä¼ é€æ–‡ä»¶åªéœ€è¦ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œå½“è°ƒç”¨sendfileæ—¶ï¼š 1.é¦–å…ˆé€šè¿‡DMAå°†æ•°æ®ä»ç£ç›˜è¯»å–åˆ°kernel bufferä¸­ 2.ç„¶åå°†kernel bufferæ•°æ®æ‹·è´åˆ°socket bufferä¸­ 3.æœ€åå°†socket bufferä¸­çš„æ•°æ®copyåˆ°ç½‘å¡è®¾å¤‡ä¸­ï¼ˆprotocol bufferï¼‰å‘é€ï¼› sendfileä¸read/writeæ¨¡å¼ç›¸æ¯”ï¼Œå°‘äº†ä¸€æ¬¡copyã€‚ä½†æ˜¯ä»ä¸Šè¿°è¿‡ç¨‹ä¸­å‘ç°ä»kernel bufferä¸­å°†æ•°æ®copyåˆ°socket bufferæ˜¯æ²¡æœ‰å¿…è¦çš„ï¼› Linux2.4 å†…æ ¸å¯¹sendfileåšäº†æ”¹è¿›ï¼Œå¦‚å›¾ï¼š æ”¹è¿›åçš„å¤„ç†è¿‡ç¨‹å¦‚ä¸‹ï¼š å°†æ–‡ä»¶æ‹·è´åˆ°kernel bufferä¸­ï¼›(DMAå¼•æ“å°†æ–‡ä»¶å†…å®¹copyåˆ°å†…æ ¸ç¼“å­˜åŒº) å‘socket bufferä¸­è¿½åŠ å½“å‰è¦å‘ç”Ÿçš„æ•°æ®åœ¨kernel bufferä¸­çš„ä½ç½®å’Œåç§»é‡ï¼› æ ¹æ®socket bufferä¸­çš„ä½ç½®å’Œåç§»é‡ç›´æ¥å°†kernel bufferçš„æ•°æ®copyåˆ°ç½‘å¡è®¾å¤‡ï¼ˆprotocol engineï¼‰ä¸­ï¼› ä»å›¾ä¸­çœ‹åˆ°ï¼Œlinux 2.1å†…æ ¸ä¸­çš„ â€œæ•°æ®è¢«copyåˆ°socket bufferâ€çš„åŠ¨ä½œï¼Œåœ¨Linux2.4 å†…æ ¸åšäº†ä¼˜åŒ–ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯åªåŒ…å«å…³äºæ•°æ®çš„ä½ç½®å’Œé•¿åº¦çš„ä¿¡æ¯çš„æè¿°ç¬¦è¢«è¿½åŠ åˆ°äº†socket buffer ç¼“å†²åŒºä¸­ã€‚DMAå¼•æ“ç›´æ¥æŠŠæ•°æ®ä»å†…æ ¸ç¼“å†²åŒºä¼ è¾“åˆ°åè®®å¼•æ“ï¼ˆprotocol engineï¼‰ï¼Œä»è€Œæ¶ˆé™¤äº†æœ€åä¸€æ¬¡CPU copyã€‚ç»è¿‡ä¸Šè¿°è¿‡ç¨‹ï¼Œæ•°æ®åªç»è¿‡äº†2æ¬¡copyå°±ä»ç£ç›˜ä¼ é€å‡ºå»äº†ã€‚è¿™ä¸ªæ‰æ˜¯çœŸæ­£çš„Zero-Copy(è¿™é‡Œçš„é›¶æ‹·è´æ˜¯é’ˆå¯¹kernelæ¥è®²çš„ï¼Œæ•°æ®åœ¨kernelæ¨¡å¼ä¸‹æ˜¯Zero-Copy)ã€‚ æ­£æ˜¯Linux2.4çš„å†…æ ¸åšäº†æ”¹è¿›ï¼ŒJavaä¸­çš„TransferTo()å®ç°äº†Zero-Copy,å¦‚ä¸‹å›¾ï¼š Zero-CopyæŠ€æœ¯çš„ä½¿ç”¨åœºæ™¯æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚Kafka, åˆæˆ–è€…æ˜¯Nettyç­‰ï¼Œå¯ä»¥å¤§å¤§æå‡ç¨‹åºçš„æ€§èƒ½ã€‚ é¦–å…ˆæˆ‘ä»¬è¯´é›¶æ‹·è´ï¼Œæ˜¯ä»æ“ä½œç³»ç»Ÿçš„è§’åº¦æ¥è¯´çš„ã€‚å› ä¸ºå†…æ ¸ç¼“å†²åŒºä¹‹é—´ï¼Œæ²¡æœ‰æ•°æ®æ˜¯é‡å¤çš„ï¼ˆåªæœ‰ kernel buffer æœ‰ä¸€ä»½æ•°æ®ï¼ŒsendFile 2.1 ç‰ˆæœ¬å®é™…ä¸Šæœ‰ 2 ä»½æ•°æ®ï¼Œç®—ä¸ä¸Šé›¶æ‹·è´ï¼‰ã€‚ä¾‹å¦‚æˆ‘ä»¬åˆšå¼€å§‹çš„ä¾‹å­ï¼Œå†…æ ¸ç¼“å­˜åŒºå’Œ Socket ç¼“å†²åŒºçš„æ•°æ®å°±æ˜¯é‡å¤çš„ã€‚ è€Œé›¶æ‹·è´ä¸ä»…ä»…å¸¦æ¥æ›´å°‘çš„æ•°æ®å¤åˆ¶ï¼Œè¿˜èƒ½å¸¦æ¥å…¶ä»–çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œä¾‹å¦‚æ›´å°‘çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ›´å°‘çš„ CPU ç¼“å­˜ä¼ªå…±äº«ä»¥åŠæ—  CPU æ ¡éªŒå’Œè®¡ç®—ã€‚ mmap å’Œ sendFile çš„åŒºåˆ«ã€‚ mmap é€‚åˆå°æ•°æ®é‡è¯»å†™ï¼ŒsendFile é€‚åˆå¤§æ–‡ä»¶ä¼ è¾“ã€‚ mmap éœ€è¦ 4 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œ3 æ¬¡æ•°æ®æ‹·è´ï¼›sendFile éœ€è¦ 3 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæœ€å°‘ 2 æ¬¡æ•°æ®æ‹·è´ã€‚ sendFile å¯ä»¥åˆ©ç”¨ DMA æ–¹å¼ï¼Œå‡å°‘ CPU æ‹·è´ï¼Œmmap åˆ™ä¸èƒ½ï¼ˆå¿…é¡»ä»å†…æ ¸æ‹·è´åˆ° Socket ç¼“å†²åŒºï¼‰ã€‚ åœ¨è¿™ä¸ªé€‰æ‹©ä¸Šï¼šrocketMQ åœ¨æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œä½¿ç”¨äº† mmapã€‚kafka ä½¿ç”¨äº† sendFileã€‚ ","link":"https://tianxiawuhao.github.io/Ts_mpMa6r/"},{"title":"nettyå¼‚æ­¥ä»»åŠ¡è°ƒåº¦ ( TaskQueue | ScheduleTaskQueue | SocketChannel ç®¡ç† )","content":" ä¸€ã€ ä»»åŠ¡é˜Ÿåˆ— ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ Task åº”ç”¨åœºæ™¯ : è‡ªå®šä¹‰ä»»åŠ¡ : è‡ªå·±å¼€å‘çš„ä»»åŠ¡ , ç„¶åå°†è¯¥ä»»åŠ¡æäº¤åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ ; è‡ªå®šä¹‰å®šæ—¶ä»»åŠ¡ : è‡ªå·±å¼€å‘çš„ä»»åŠ¡ , ç„¶åå°†è¯¥ä»»åŠ¡æäº¤åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ , åŒæ—¶å¯ä»¥æŒ‡å®šä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ ; å…¶å®ƒçº¿ç¨‹è°ƒåº¦ä»»åŠ¡ : ä¸Šé¢çš„ä»»åŠ¡éƒ½æ˜¯åœ¨å½“å‰çš„ NioEventLoop ( ååº”å™¨ Reactor çº¿ç¨‹ ) ä¸­çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­æ’é˜Ÿæ‰§è¡Œ , åœ¨å…¶å®ƒçº¿ç¨‹ä¸­ä¹Ÿå¯ä»¥è°ƒåº¦æœ¬çº¿ç¨‹çš„ Channel é€šé“ä¸è¯¥çº¿ç¨‹å¯¹åº”çš„å®¢æˆ·ç«¯è¿›è¡Œæ•°æ®è¯»å†™ ; äºŒã€ å¤„ç†å™¨ Handler åŒæ­¥å¼‚æ­¥æ“ä½œ åœ¨ä¹‹å‰çš„ Netty æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯é¡¹ç›®ä¸­ , ç”¨æˆ·è‡ªå®šä¹‰çš„ Handler å¤„ç†å™¨ , è¯¥å¤„ç†å™¨ç»§æ‰¿äº† ChannelInboundHandlerAdapter ç±» , åœ¨é‡å†™çš„ public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception æ–¹æ³•ä¸­ , æ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘è¦æ³¨æ„ä»¥ä¸‹ä¸¤ç‚¹ : åŒæ­¥æ“ä½œ : å¦‚æœåœ¨è¯¥ä¸šåŠ¡é€»è¾‘ä¸­åªæ‰§è¡Œä¸€ä¸ªçŸ­æ—¶é—´çš„æ“ä½œ , é‚£ä¹ˆå¯ä»¥ç›´æ¥æ‰§è¡Œ ; å¼‚æ­¥æ“ä½œ : å¦‚æœåœ¨è¯¥ä¸šåŠ¡é€»è¾‘ä¸­æ‰§è¡Œè®¿é—®æ•°æ®åº“ , è®¿é—®ç½‘ç»œ , è¯»å†™æœ¬åœ°æ–‡ä»¶ , æ‰§è¡Œä¸€ç³»åˆ—å¤æ‚è®¡ç®—ç­‰è€—æ—¶æ“ä½œ , è‚¯å®šä¸èƒ½åœ¨è¯¥æ–¹æ³•ä¸­å¤„ç† , è¿™æ ·ä¼šé˜»å¡æ•´ä¸ªçº¿ç¨‹ ; æ­£ç¡®çš„åšæ³•æ˜¯å°†è€—æ—¶çš„æ“ä½œæ”¾å…¥ä»»åŠ¡é˜Ÿåˆ— TaskQueue , å¼‚æ­¥æ‰§è¡Œ ; åœ¨ ChannelInboundHandlerAdapter çš„ channelRead æ–¹æ³•æ‰§è¡Œæ—¶ , å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯çš„ååº”å™¨ Reactor çº¿ç¨‹ NioEventLoop æ˜¯å¤„äºé˜»å¡çŠ¶æ€çš„ , æ­¤æ—¶æœåŠ¡å™¨ç«¯ä¸å®¢æˆ·ç«¯åŒæ—¶éƒ½å¤„äºé˜»å¡çŠ¶æ€ , è¿™æ ·è‚¯å®šä¸è¡Œ , å› ä¸º NioEventLoop éœ€è¦ä¸ºå¤šä¸ªå®¢æˆ·ç«¯æœåŠ¡ , ä¸èƒ½å› ä¸ºä¸å•ä¸€å®¢æˆ·ç«¯äº¤äº’è€Œäº§ç”Ÿé˜»å¡ ; ä¸‰ã€ å¼‚æ­¥ä»»åŠ¡ ( ç”¨æˆ·è‡ªå®šä¹‰ä»»åŠ¡ ) ç”¨æˆ·è‡ªå®šä¹‰ä»»åŠ¡æµç¨‹ : â‘  è·å–é€šé“ : é¦–å…ˆè·å– é€šé“ Channel ; â‘¡ è·å–çº¿ç¨‹ : è·å–é€šé“å¯¹åº”çš„ EventLoop çº¿ç¨‹ , å°±æ˜¯ NioEventLoop , è¯¥ NioEventLoop ä¸­å°è£…äº†ä»»åŠ¡é˜Ÿåˆ— TaskQueue ; â‘¢ ä»»åŠ¡å…¥é˜Ÿ : å‘ä»»åŠ¡é˜Ÿåˆ— TaskQueue ä¸­æ”¾å…¥å¼‚æ­¥ä»»åŠ¡ Runnable , è°ƒç”¨ NioEventLoop çº¿ç¨‹çš„ execute æ–¹æ³• , å³å¯å°†ä¸Šè¿° Runnable å¼‚æ­¥ä»»åŠ¡æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ— TaskQueue ; å¤šä»»åŠ¡æ‰§è¡Œ : å¦‚æœç”¨æˆ·è¿ç»­å‘ä»»åŠ¡é˜Ÿåˆ—ä¸­æ”¾å…¥äº†å¤šä¸ªä»»åŠ¡ , NioEventLoop ä¼šæŒ‰ç…§é¡ºåºå…ˆåæ‰§è¡Œè¿™äº›ä»»åŠ¡ , æ³¨æ„ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ æ˜¯å…ˆåæ‰§è¡Œ , ä¸æ˜¯åŒæ—¶æ‰§è¡Œ ; é¡ºåºæ‰§è¡Œä»»åŠ¡ ( ä¸æ˜¯å¹¶å‘ ) : ä»»åŠ¡é˜Ÿåˆ—ä»»åŠ¡æ‰§è¡Œæœºåˆ¶æ˜¯é¡ºåºæ‰§è¡Œçš„ ; å…ˆæ‰§è¡Œç¬¬ä¸€ä¸ª , æ‰§è¡Œå®Œæ¯•å , ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ç¬¬äºŒä¸ªä»»åŠ¡ , æ‰§è¡Œå®Œæ¯•ä¹‹å , ä¾æ¬¡ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡æ‰§è¡Œ , å‰ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•å , æ‰ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä¸‹ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œ ; ä»£ç ç¤ºä¾‹ : ç›‘å¬åˆ°å®¢æˆ·ç«¯ä¸Šä¼ æ•°æ®å , channelRead å›è°ƒ , æ‰§è¡Œ è·å–é€šé“ -&gt; è·å–çº¿ç¨‹ -&gt; å¼‚æ­¥ä»»åŠ¡è°ƒåº¦ æµç¨‹ ; /** * Handler å¤„ç†è€…, æ˜¯ NioEventLoop çº¿ç¨‹ä¸­å¤„ç†ä¸šåŠ¡é€»è¾‘çš„ç±» * * ç»§æ‰¿ : è¯¥ä¸šåŠ¡é€»è¾‘å¤„ç†è€… ( Handler ) å¿…é¡»ç»§æ‰¿ Netty ä¸­çš„ ChannelInboundHandlerAdapter ç±» * æ‰å¯ä»¥è®¾ç½®ç»™ NioEventLoop çº¿ç¨‹ * * è§„èŒƒ : è¯¥ Handler ç±»ä¸­éœ€è¦æŒ‰ç…§ä¸šåŠ¡é€»è¾‘å¤„ç†è§„èŒƒè¿›è¡Œå¼€å‘ */ public class ServerHandr extends ChannelInboundHandlerAdapter { /** * è¯»å–æ•°æ® : åœ¨æœåŠ¡å™¨ç«¯è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ•°æ® * @param ctx * é€šé“å¤„ç†è€…ä¸Šä¸‹æ–‡å¯¹è±¡ : å°è£…äº† ç®¡é“ ( Pipeline ) , é€šé“ ( Channel ), å®¢æˆ·ç«¯åœ°å€ä¿¡æ¯ * ç®¡é“ ( Pipeline ) : æ³¨é‡ä¸šåŠ¡é€»è¾‘å¤„ç† , å¯ä»¥å…³è”å¾ˆå¤š Handler * é€šé“ ( Channel ) : æ³¨é‡æ•°æ®è¯»å†™ * @param msg * å®¢æˆ·ç«¯ä¸Šä¼ çš„æ•°æ® * @throws Exception */ @Override public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception { // 1 . ä» ChannelHandlerContext ctx ä¸­è·å–é€šé“ Channel channel = ctx.channel(); // 2 . è·å–é€šé“å¯¹åº”çš„äº‹ä»¶å¾ªç¯ EventLoop eventLoop = channel.eventLoop(); // 3 . åœ¨ Runnable ä¸­ç”¨æˆ·è‡ªå®šä¹‰è€—æ—¶æ“ä½œ, å¼‚æ­¥æ‰§è¡Œè¯¥æ“ä½œ, è¯¥æ“ä½œä¸èƒ½é˜»å¡åœ¨æ­¤å¤„æ‰§è¡Œ eventLoop.execute(new Runnable() { @Override public void run() { //æ‰§è¡Œè€—æ—¶æ“ä½œ } }); } } å››ã€ å¼‚æ­¥ä»»åŠ¡ ( ç”¨æˆ·è‡ªå®šä¹‰å®šæ—¶ä»»åŠ¡ ) ç”¨æˆ·è‡ªå®šä¹‰å®šæ—¶ä»»åŠ¡ ä¸ ç”¨æˆ·è‡ªå®šä¹‰ä»»åŠ¡æµç¨‹åŸºæœ¬ç±»ä¼¼ , æœ‰ä»¥ä¸‹ä¸¤ä¸ªä¸åŒä¹‹å¤„ : â‘  è°ƒåº¦æ–¹æ³• : å®šæ—¶å¼‚æ­¥ä»»åŠ¡ä½¿ç”¨ schedule æ–¹æ³•è¿›è¡Œè°ƒåº¦ ; æ™®é€šå¼‚æ­¥ä»»åŠ¡ä½¿ç”¨ execute æ–¹æ³•è¿›è¡Œè°ƒåº¦ ; â‘¡ ä»»åŠ¡é˜Ÿåˆ— : å®šæ—¶å¼‚æ­¥ä»»åŠ¡æäº¤åˆ° ScheduleTaskQueue ä»»åŠ¡é˜Ÿåˆ—ä¸­ ; æ™®é€šå¼‚æ­¥ä»»åŠ¡æäº¤åˆ° TaskQueue ä»»åŠ¡é˜Ÿåˆ—ä¸­ ; ç”¨æˆ·è‡ªå®šä¹‰å®šæ—¶ä»»åŠ¡æµç¨‹ : â‘  è·å–é€šé“ : é¦–å…ˆè·å– é€šé“ Channel ; â‘¡ è·å–çº¿ç¨‹ : è·å–é€šé“å¯¹åº”çš„ EventLoop çº¿ç¨‹ , å°±æ˜¯ NioEventLoop , è¯¥ NioEventLoop ä¸­å°è£…äº†ä»»åŠ¡é˜Ÿåˆ— TaskQueue ; â‘¢ ä»»åŠ¡å…¥é˜Ÿ : å‘ä»»åŠ¡é˜Ÿåˆ— ScheduleTaskQueue ä¸­æ”¾å…¥å¼‚æ­¥ä»»åŠ¡ Runnable , è°ƒç”¨ NioEventLoop çº¿ç¨‹çš„ schedule æ–¹æ³• , å³å¯å°†ä¸Šè¿° Runnable å¼‚æ­¥ä»»åŠ¡æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ— ScheduleTaskQueue ; ä»£ç ç¤ºä¾‹ : ç›‘å¬åˆ°å®¢æˆ·ç«¯ä¸Šä¼ æ•°æ®å , channelRead å›è°ƒ , æ‰§è¡Œ è·å–é€šé“ -&gt; è·å–çº¿ç¨‹ -&gt; å¼‚æ­¥ä»»åŠ¡è°ƒåº¦ æµç¨‹ ; /** * Handler å¤„ç†è€…, æ˜¯ NioEventLoop çº¿ç¨‹ä¸­å¤„ç†ä¸šåŠ¡é€»è¾‘çš„ç±» * * ç»§æ‰¿ : è¯¥ä¸šåŠ¡é€»è¾‘å¤„ç†è€… ( Handler ) å¿…é¡»ç»§æ‰¿ Netty ä¸­çš„ ChannelInboundHandlerAdapter ç±» * æ‰å¯ä»¥è®¾ç½®ç»™ NioEventLoop çº¿ç¨‹ * * è§„èŒƒ : è¯¥ Handler ç±»ä¸­éœ€è¦æŒ‰ç…§ä¸šåŠ¡é€»è¾‘å¤„ç†è§„èŒƒè¿›è¡Œå¼€å‘ */ public class ServerHandr extends ChannelInboundHandlerAdapter { /** * è¯»å–æ•°æ® : åœ¨æœåŠ¡å™¨ç«¯è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ•°æ® * @param ctx * é€šé“å¤„ç†è€…ä¸Šä¸‹æ–‡å¯¹è±¡ : å°è£…äº† ç®¡é“ ( Pipeline ) , é€šé“ ( Channel ), å®¢æˆ·ç«¯åœ°å€ä¿¡æ¯ * ç®¡é“ ( Pipeline ) : æ³¨é‡ä¸šåŠ¡é€»è¾‘å¤„ç† , å¯ä»¥å…³è”å¾ˆå¤š Handler * é€šé“ ( Channel ) : æ³¨é‡æ•°æ®è¯»å†™ * @param msg * å®¢æˆ·ç«¯ä¸Šä¼ çš„æ•°æ® * @throws Exception */ @Override public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception { // 1 . ä» ChannelHandlerContext ctx ä¸­è·å–é€šé“ Channel channel = ctx.channel(); // 2 . è·å–é€šé“å¯¹åº”çš„äº‹ä»¶å¾ªç¯ EventLoop eventLoop = channel.eventLoop(); // 3 . åœ¨ Runnable ä¸­ç”¨æˆ·è‡ªå®šä¹‰è€—æ—¶æ“ä½œ, å¼‚æ­¥æ‰§è¡Œè¯¥æ“ä½œ, è¯¥æ“ä½œä¸èƒ½é˜»å¡åœ¨æ­¤å¤„æ‰§è¡Œ // schedule(Runnable command, long delay, TimeUnit unit) // Runnable command å‚æ•° : å¼‚æ­¥ä»»åŠ¡ // long delay å‚æ•° : å»¶è¿Ÿæ‰§è¡Œæ—¶é—´ // TimeUnit unitå‚æ•° : å»¶è¿Ÿæ—¶é—´å•ä½, ç§’, æ¯«ç§’, åˆ†é’Ÿ eventLoop.schedule(new Runnable() { @Override public void run() { //æ‰§è¡Œè€—æ—¶æ“ä½œ } }, 100, TimeUnit.MILLISECONDS); } } äº”ã€ å¼‚æ­¥ä»»åŠ¡ ( å…¶å®ƒçº¿ç¨‹å‘æœ¬çº¿ç¨‹è°ƒåº¦ä»»åŠ¡ ) é€šè¿‡EventExecutorGroupçº¿ç¨‹æ± è·å–ä¸åŒçº¿ç¨‹æ‰§è¡Œå¼‚æ­¥è€—æ—¶ä»»åŠ¡ ä»£ç ç¤ºä¾‹ï¼ˆä¸€ï¼‰ // æœåŠ¡å™¨å¯åŠ¨å¯¹è±¡, éœ€è¦ä¸ºè¯¥å¯¹è±¡é…ç½®å„ç§å‚æ•° ServerBootstrap bootstrap = new ServerBootstrap(); // æ·»åŠ çº¿ç¨‹ç»„å¼‚æ­¥æ‰§è¡Œè€—æ—¶ä»»åŠ¡ final EventExecutorGroup businessGroup = new DefaultEventExecutorGroup(16); bootstrap.group(bossGroup, workerGroup) // è®¾ç½® ä¸»ä» çº¿ç¨‹ç»„ , åˆ†åˆ«å¯¹åº” ä¸» Reactor å’Œ ä» Reactor .channel(NioServerSocketChannel.class) // è®¾ç½® NIO ç½‘ç»œå¥—æ¥å­—é€šé“ç±»å‹ .option(ChannelOption.SO_BACKLOG, 128) // è®¾ç½®çº¿ç¨‹é˜Ÿåˆ—ç»´æŠ¤çš„è¿æ¥ä¸ªæ•° .childOption(ChannelOption.SO_KEEPALIVE, true) // è®¾ç½®è¿æ¥çŠ¶æ€è¡Œä¸º, ä¿æŒè¿æ¥çŠ¶æ€ .childHandler( // ä¸º WorkerGroup çº¿ç¨‹æ± å¯¹åº”çš„ NioEventLoop è®¾ç½®å¯¹åº”çš„äº‹ä»¶ å¤„ç†å™¨ Handler new ChannelInitializer&lt;SocketChannel&gt;() {// åˆ›å»ºé€šé“åˆå§‹åŒ–å¯¹è±¡ @Override protected void initChannel(SocketChannel ch) throws Exception { // è¯¥æ–¹æ³•åœ¨æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯è¿æ¥å»ºç«‹æˆåŠŸåä¼šå›è°ƒ // ä¸º ç®¡é“ Pipeline è®¾ç½®å¤„ç†å™¨ Hanedler ch.pipeline().addLast(businessGroup,new NettyServerHandler()); } } ); ä»£ç ç¤ºä¾‹ï¼ˆäºŒï¼‰ public class NettyServerHandler extends SimpleChannelInboundHandler&lt;Object&gt; { final EventExecutorGroup businessGroup = new DefaultEventExecutorGroup(16); @Override protected void channelRead0(ChannelHandlerContext ctx, Object obj) throws Exception { businessGroup.submit(new Callable&lt;Object&gt;() { @Override public Object call() throws Exception { //ä¸šåŠ¡å¤„ç† return null; } }); } } ","link":"https://tianxiawuhao.github.io/b3vVP1a3A/"},{"title":"netty_nio_Reactoræ¨¡å¼","content":"Reactoræœ‰ä¸‰ç§æ¨¡å¼ï¼š å•reactorå•çº¿ç¨‹å·¥ä½œåŸç†å›¾ dispatchä¸handleråœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­å¤„ç†. rediså°±æ˜¯é‡‡ç”¨è¿™ç§æ¨¡å¼ å•reactorå¤šçº¿ç¨‹å·¥ä½œåŸç†å›¾ ï¼ˆ1ï¼‰ reactorå¯¹è±¡é€šè¿‡selectç›‘æ§å®¢æˆ·ç«¯è¯·æ±‚äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åï¼Œé€šè¿‡dispatchè¿›è¡Œåˆ†å‘ ï¼ˆ2ï¼‰å¦‚æœå»ºç«‹è¿æ¥è¯·æ±‚ï¼Œåˆ™ç”±Acceptoré€šè¿‡acceptå¤„ç†è¿æ¥è¯·æ±‚ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªHandlerå¯¹è±¡å¤„ç†å®Œæˆè¿æ¥åçš„å„ç§äº‹ä»¶ ï¼ˆ3ï¼‰å¦‚æœä¸æ˜¯è¿æ¥è¯·æ±‚ï¼Œåˆ™ç”±reactoråˆ†å‘è°ƒç”¨è¿æ¥å¯¹åº”çš„Handleræ¥å¤„ç† ï¼ˆ4ï¼‰Handleråªè´Ÿè´£å“åº”äº‹ä»¶ï¼Œä¸åšå…·ä½“çš„ä¸šåŠ¡å¤„ç†ï¼Œ é€šè¿‡readè¯»å–æ•°æ®ååˆ†å‘ç»™åé¢çš„workçº¿ç¨‹æ± ä¸­çš„æŸä¸ªçº¿ç¨‹ã€‚ ï¼ˆ5ï¼‰workçº¿ç¨‹æ± ä¼šåˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹å®ŒæˆçœŸæ­£çš„ä¸šåŠ¡ ï¼Œå¹¶å°†å¤„ç†å®Œçš„ä¸šåŠ¡ç»“æœè¿”å›ç»™Handler ï¼ˆ6ï¼‰Handleræ”¶åˆ°å“åº”ç»“æœåï¼Œé€šè¿‡sendå°†ç»“æœè¿”å›ç»™client ä¼˜ç‚¹ï¼š ï¼ˆ1ï¼‰ å¯ä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸cpuçš„å¤„ç†èƒ½åŠ› ï¼ˆ2ï¼‰ å¤šçº¿ç¨‹æ•°æ®å…±äº«å’Œè®¿é—®æ¯”è¾ƒå¤æ‚ ï¼Œreactorå¤„ç†äº†æ‰€æœ‰çš„äº‹ä»¶ç›‘å¬å’Œå“åº”ï¼Œè€Œä¸”æ˜¯åœ¨å•çº¿ç¨‹ä¸­è¿è¡Œï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯å®¹æ˜“å‡ºç°æ€§èƒ½ç“¶é¢ˆ ä¸»ä»reactorå¤šçº¿ç¨‹å·¥ä½œåŸç†å›¾ ï¼ˆ1ï¼‰Reactorä¸»çº¿ç¨‹MainReactorå¯¹è±¡é€šè¿‡selectç›‘å¬è¿æ¥äº‹ä»¶ï¼Œæ”¶åˆ°è¿æ¥äº‹ä»¶åï¼Œé€šè¿‡Acceptorå¤„ç†è¿æ¥äº‹ä»¶ ï¼ˆ2ï¼‰å½“Acceptorå¤„ç†è¿æ¥äº‹ä»¶åï¼ŒMainReactorå°†è¿æ¥åˆ†é…ç»™SubReactor, ï¼ˆ3ï¼‰SubReactorå°†è¿æ¥åŠ å…¥åˆ°è¿æ¥ç›‘å¬é˜Ÿåˆ—è¿›è¡Œç›‘å¬ï¼Œå¹¶åˆ›å»ºHandlerè¿›è¡Œå„ç§äº‹ä»¶å¤„ç† ï¼ˆ4ï¼‰å½“æœ‰æ–°çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œ subreactorå°±ä¼šè°ƒç”¨å¯¹åº”çš„handlerå¤„ç†ï¼Œ ï¼ˆ5ï¼‰handleré€šè¿‡readè¯»å–æ•°æ®åï¼Œåˆ†å‘ç»™åé¢çš„workerçº¿ç¨‹å¤„ç† ï¼ˆ6ï¼‰workerçº¿ç¨‹æ± ä¼šåˆ†é…ç‹¬ç«‹çš„workerçº¿ç¨‹è¿›è¡Œä¸šåŠ¡å¤„ç†ï¼Œå¹¶è¿”å›ç»“æœ ï¼ˆ7ï¼‰handleræ”¶åˆ°å“åº”ç»“æœåï¼Œå†é€šè¿‡sendå°†ç»“æœè¿”å›ç»™client å®ç°Reactoræ¨¡å¼æˆ‘ä»¬éœ€è¦å®ç°ä»¥ä¸‹å‡ ä¸ªç±»ï¼š InputSource: å¤–éƒ¨è¾“å…¥ç±»ï¼Œç”¨æ¥è¡¨ç¤ºéœ€è¦reactorå»å¤„ç†çš„åŸå§‹å¯¹è±¡ Event: reactoræ¨¡å¼çš„äº‹ä»¶ç±»ï¼Œå¯ä»¥ç†è§£ä¸ºå°†è¾“å…¥åŸå§‹å¯¹è±¡æ ¹æ®ä¸åŒçŠ¶æ€åŒ…è£…æˆä¸€ä¸ªäº‹ä»¶ç±»ï¼Œreactoræ¨¡å¼é‡Œå¤„ç†çš„æ–—å£«eventäº‹ä»¶å¯¹è±¡ EventType: æšä¸¾ç±»å‹è¡¨ç¤ºäº‹ä»¶çš„ä¸åŒç±»å‹ EventHandler: å¤„ç†äº‹ä»¶çš„æŠ½è±¡ç±»ï¼Œé‡Œé¢åŒ…å«äº†ä¸åŒäº‹ä»¶å¤„ç†å™¨çš„å…¬å…±é€»è¾‘å’Œå…¬å…±å¯¹è±¡ AcceptEventHandler\\ReadEventhandlerç­‰: ç»§æ‰¿è‡ªEventHandlerçš„å…·ä½“äº‹ä»¶å¤„ç†å™¨çš„å®ç°ç±»ï¼Œä¸€èˆ¬æ ¹æ®äº‹ä»¶ä¸åŒçš„çŠ¶æ€æ¥å®šä¹‰ä¸åŒçš„å¤„ç†å™¨ Dispatcher: äº‹ä»¶åˆ†å‘å™¨ï¼Œæ•´ä¸ªreactoræ¨¡å¼è§£å†³çš„ä¸»è¦é—®é¢˜å°±æ˜¯åœ¨æ¥æ”¶åˆ°ä»»åŠ¡åæ ¹æ®åˆ†å‘å™¨å¿«é€Ÿè¿›è¡Œåˆ†å‘ç»™ç›¸åº”çš„äº‹ä»¶å¤„ç†å™¨ï¼Œä¸éœ€è¦ä»å¼€å§‹çŠ¶æ€å°±é˜»å¡ Selector: äº‹ä»¶è½®å¾ªé€‰æ‹©å™¨ï¼Œselectorä¸»è¦å®ç°äº†è½®å¾ªé˜Ÿåˆ—ä¸­çš„äº‹ä»¶çŠ¶æ€ï¼Œå–å‡ºå½“å‰èƒ½å¤Ÿå¤„ç†çš„çŠ¶æ€ Acceptor:reactorçš„äº‹ä»¶æ¥æ”¶ç±»ï¼Œè´Ÿè´£åˆå§‹åŒ–selectorå’Œæ¥æ”¶ç¼“å†²é˜Ÿåˆ— Server:è´Ÿè´£å¯åŠ¨reactoræœåŠ¡å¹¶å¯åŠ¨ç›¸å…³æœåŠ¡æ¥æ”¶è¯·æ±‚ InputSource.java import lombok.AllArgsConstructor; import lombok.Data; @Data @AllArgsConstructor public class InputSource { private final Object data; private final long id; } Event.java import lombok.Getter; import lombok.Setter; @Getter @Setter public class Event { private InputSource source; private EventType type; } EventType public enum EventType { ACCEPT, READ, WRITE; } EventHandler.java @Getter @Setter public abstract class EventHandler { private InputSource source; public abstract void handle(Event event); } AcceptEventHandler.java public class AcceptEventHandler extends EventHandler { private Selector selector; public AcceptEventHandler(Selector selector) { this.selector = selector; } @Override public void handle(Event event) { //å¤„ç†Acceptçš„eventäº‹ä»¶ if (event.getType() == EventType.ACCEPT) { //TODO å¤„ç†ACCEPTçŠ¶æ€çš„äº‹ä»¶ //å°†äº‹ä»¶çŠ¶æ€æ”¹ä¸ºä¸‹ä¸€ä¸ªREADçŠ¶æ€ï¼Œå¹¶æ”¾å…¥selectorçš„ç¼“å†²é˜Ÿåˆ—ä¸­ Event readEvent = new Event(); readEvent.setSource(event.getSource()); readEvent.setType(EventType.READ); selector.addEvent(readEvent); } } } Dispatcher.java import java.util.List; import java.util.Map; import java.util.concurrent.ConcurrentHashMap; public class Dispatcher { //é€šè¿‡ConcurrentHashMapæ¥ç»´æŠ¤ä¸åŒäº‹ä»¶å¤„ç†å™¨ Map&lt;EventType, EventHandler&gt; eventHandlerMap = new ConcurrentHashMap&lt;EventType, EventHandler&gt;(); //æœ¬ä¾‹åªç»´æŠ¤ä¸€ä¸ªselectorè´Ÿè´£äº‹ä»¶é€‰æ‹©ï¼Œnettyä¸ºäº†ä¿è¯æ€§èƒ½å®ç°äº†å¤šä¸ªselectoræ¥ä¿è¯å¾ªç¯å¤„ç†æ€§èƒ½ï¼Œä¸åŒäº‹ä»¶åŠ å…¥ä¸åŒçš„selectorçš„äº‹ä»¶ç¼“å†²é˜Ÿåˆ— Selector selector; Dispatcher(Selector selector) { this.selector = selector; } //åœ¨Dispatcherä¸­æ³¨å†ŒeventHandler public void registEventHandler(EventType eventType, EventHandler eventHandler) { eventHandlerMap.put(eventType, eventHandler); } public void removeEventHandler(EventType eventType) { eventHandlerMap.remove(eventType); } public void handleEvents() { dispatch(); } //æ­¤ä¾‹åªæ˜¯å®ç°äº†ç®€å•çš„äº‹ä»¶åˆ†å‘ç»™ç›¸åº”çš„å¤„ç†å™¨å¤„ç†ï¼Œä¾‹å­ä¸­çš„å¤„ç†å™¨éƒ½æ˜¯åŒæ­¥ï¼Œåœ¨reactoræ¨¡å¼çš„å…¸å‹å®ç°NIOä¸­éƒ½æ˜¯åœ¨handleå¼‚æ­¥å¤„ç†ï¼Œæ¥ä¿è¯éé˜»å¡ private void dispatch() { while (true) { List&lt;Event&gt; events = selector.select(); for (Event event : events) { EventHandler eventHandler = eventHandlerMap.get(event.getType()); eventHandler.handle(event); } } } } Selector.java import java.util.ArrayList; import java.util.List; import java.util.concurrent.BlockingQueue; import java.util.concurrent.LinkedBlockingQueue; public class Selector { //å®šä¹‰ä¸€ä¸ªé“¾è¡¨é˜»å¡queueå®ç°ç¼“å†²é˜Ÿåˆ—ï¼Œç”¨äºä¿è¯çº¿ç¨‹å®‰å…¨ private final BlockingQueue&lt;Event&gt; eventQueue = new LinkedBlockingQueue&lt;Event&gt;(); //å®šä¹‰ä¸€ä¸ªobjectç”¨äºsynchronizeæ–¹æ³•å—ä¸Šé” private final Object lock = new Object(); List&lt;Event&gt; select() { return select(0); } // List&lt;Event&gt; select(long timeout) { if (timeout &gt; 0) { if (eventQueue.isEmpty()) { synchronized (lock) { if (eventQueue.isEmpty()) { try { lock.wait(timeout); } catch (InterruptedException ignored) { } } } } } //TODO ä¾‹å­ä¸­åªæ˜¯ç®€å•çš„å°†eventåˆ—è¡¨å…¨éƒ¨è¿”å›ï¼Œå¯ä»¥åœ¨æ­¤å¤„å¢åŠ ä¸šåŠ¡é€»è¾‘ï¼Œé€‰å‡ºç¬¦åˆæ¡ä»¶çš„eventè¿›è¡Œè¿”å› List&lt;Event&gt; events = new ArrayList&lt;Event&gt;(); eventQueue.drainTo(events); return events; } public void addEvent(Event e) { //å°†eventäº‹ä»¶åŠ å…¥é˜Ÿåˆ— boolean success = eventQueue.offer(e); if (success) { synchronized (lock) { //å¦‚æœæœ‰æ–°å¢äº‹ä»¶åˆ™å¯¹lockå¯¹è±¡è§£é” lock.notify(); } } } } Acceptor.java import java.util.concurrent.BlockingQueue; import java.util.concurrent.LinkedBlockingQueue; public class Acceptor implements Runnable{ private final int port; // server socket port private final Selector selector; // ä»£è¡¨ serversocketï¼Œé€šè¿‡LinkedBlockingQueueæ¥æ¨¡æ‹Ÿå¤–éƒ¨è¾“å…¥è¯·æ±‚é˜Ÿåˆ— private final BlockingQueue&lt;InputSource&gt; sourceQueue = new LinkedBlockingQueue&lt;InputSource&gt;(); Acceptor(Selector selector, int port) { this.selector = selector; this.port = port; } //å¤–éƒ¨æœ‰è¾“å…¥è¯·æ±‚åï¼Œéœ€è¦åŠ å…¥åˆ°è¯·æ±‚é˜Ÿåˆ—ä¸­ public void addNewConnection(InputSource source) { sourceQueue.offer(source); } public int getPort() { return this.port; } public void run() { while (true) { InputSource source = null; try { // ç›¸å½“äº serversocket.accept()ï¼Œæ¥æ”¶è¾“å…¥è¯·æ±‚ï¼Œè¯¥ä¾‹ä»è¯·æ±‚é˜Ÿåˆ—ä¸­è·å–è¾“å…¥è¯·æ±‚ source = sourceQueue.take(); } catch (InterruptedException e) { // ignore it; } //æ¥æ”¶åˆ°InputSourceåå°†æ¥æ”¶åˆ°eventè®¾ç½®typeä¸ºACCEPTï¼Œå¹¶å°†sourceèµ‹å€¼ç»™event if (source != null) { Event acceptEvent = new Event(); acceptEvent.setSource(source); acceptEvent.setType(EventType.ACCEPT); selector.addEvent(acceptEvent); } } } } Server.java public class Server { Selector selector = new Selector(); Dispatcher eventLooper = new Dispatcher(selector); Acceptor acceptor; Server(int port) { acceptor = new Acceptor(selector, port); } public void start() { eventLooper.registEventHandler(EventType.ACCEPT, new AcceptEventHandler(selector)); new Thread(acceptor, &quot;Acceptor-&quot; + acceptor.getPort()).start(); eventLooper.handleEvents(); } } ","link":"https://tianxiawuhao.github.io/wvy4g9Zbn/"},{"title":"saikuè‡ªåŠ¨å¯¹æ¥kylin","content":"saikué€šè¿‡æ·»åŠ schemaå’Œdatasourceçš„å½¢å¼ç®¡ç†å¯¹æ¥å…¥ç³»ç»Ÿçš„æ•°æ®æºï¼Œç„¶åæä¾›ç•Œé¢ä½œä¸ºç›´è§‚çš„åˆ†ææ•°æ®æ–¹å¼ï¼Œç•Œé¢äº§ç”Ÿmdxï¼Œç”±mondrianè¿æ¥æ•°æ®æºï¼Œè§£æmdxå’Œæ‰§è¡ŒæŸ¥è¯¢ kylinæä¾›å¤§è§„æ¨¡æ•°æ®çš„olapèƒ½åŠ›ï¼Œé€šè¿‡saikuä¸kylinçš„å¯¹æ¥ï¼Œåˆ©ç”¨saikuçš„å‹å¥½ç•Œé¢æ¥å¾ˆæ–¹é¢çš„æŸ¥è¯¢ å¦‚ä¸Šçš„æ•´åˆï¼Œéœ€è¦æ‰‹åŠ¨é…ç½®æ•°æ®æºï¼Œç¼–å†™schemaçš„æ“ä½œï¼Œæ„Ÿè§‰æ¯”è¾ƒç¹çï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹saikuçš„ä»£ç ï¼Œåˆ°kylinä¸­è·å–projectå’Œcubeçš„å„ç§ä¿¡æ¯ï¼Œæ ¹æ®ä¸€å®šè§„åˆ™è½¬æ¢ç”Ÿæˆschemaå¹¶ä½œä¸ºæ•°æ®æºç®¡ç†èµ·æ¥ï¼Œè¿™æ ·å°±å¾ˆç›´æ¥å°†saikuä¸kylinæ— ç¼å¯¹æ¥èµ·æ¥ã€‚ ä»£ç æ¡ˆä¾‹ saiku-wabapp #saiku-beans.properties sylin.user=ADMIN sylin.password=ADMIN sylin.cube.url=http://localhost:7070/kylin/api/cubes sylin.cubedesc.url=http://localhost:7070/kylin/api/cube_desc sylin.model.url=http://localhost:7070/kylin/api/model sylin.url=localhost:7070 //saiku-beans.xml &lt;bean id=&quot;repositoryDsManager&quot; class=&quot;org.saiku.service.datasource.RepositoryDatasourceManager&quot; init-method=&quot;load&quot; destroy-method=&quot;unload&quot;&gt; &lt;!--aop:scoped-proxy/--&gt; ...... &lt;property name=&quot;sylinUser&quot; value=&quot;${sylin.user}&quot;/&gt; &lt;property name=&quot;sylinPassWord&quot; value=&quot;${sylin.password}&quot;/&gt; &lt;property name=&quot;sylinCubeUrl&quot; value=&quot;${sylin.cube.url}&quot;/&gt; &lt;property name=&quot;sylinCubeDescUrl&quot; value=&quot;${sylin.cubedesc.url}&quot;/&gt; &lt;property name=&quot;sylinModelUrl&quot; value=&quot;${sylin.model.url}&quot;/&gt; &lt;property name=&quot;sylinUrl&quot; value=&quot;${sylin.url}&quot;/&gt; &lt;/bean&gt; saiku-service public class RepositoryDatasourceManager implements IDatasourceManager, ApplicationListener&lt;HttpSessionCreatedEvent&gt; { private String sylinUser; private String sylinPassWord; private String sylinCubeUrl; private String sylinCubeDescUrl; private String sylinModelUrl; private String sylinUrl; //get.setçœç•¥ ...... private void loadDatasources(Properties ext) { datasources.clear(); List&lt;DataSource&gt; exporteddatasources = null; try { String result = execute(sylinCubeUrl); JSONArray ja = JSON.parseArray(result); for (int i = 0; i &lt; ja.size(); i++) { JSONObject js = JSONObject.parseObject(ja.getString(i)); String newCubeName = js.getString(&quot;project&quot;) + &quot;#&quot; + js.getString(&quot;name&quot;); datasources.put(js.getString(&quot;name&quot;), getSaikuDatasource(newCubeName)); } } catch (Exception e) { log.error(&quot;Failed add sylin cube to datasource&quot;, e); e.printStackTrace(); } ...... } private SaikuDatasource getSaikuDatasource(String datasourceName) throws Exception { if (datasourceName.contains(&quot;#&quot;)) { String cubeName = datasourceName.split(&quot;#&quot;)[1].trim(); String cubeDescString = execute(sylinCubeDescUrl + &quot;/&quot; + cubeName); CubeDesc cubeDesc = OBJECT_MAPPER.readValue(JSON.parseArray(cubeDescString).getString(0), CubeDesc.class); //CubeDesc cubeDesc = JSONObject.parseObject(JSON.parseArray(cubeDescString).getString(0), CubeDesc.class); String modelName = cubeDesc.getModelName(); String cubeModelString = execute(sylinModelUrl + &quot;/&quot; + modelName); DataModelDesc modelDesc = OBJECT_MAPPER.readValue(cubeModelString, DataModelDesc.class); //DataModelDesc modelDesc = JSONObject.parseObject(cubeModelString, DataModelDesc.class); if (cubeDesc != null &amp;&amp; modelDesc != null) { addSchema(SchemaUtil.createSchema(datasourceName, cubeDesc, modelDesc), &quot;/datasources/&quot; + datasourceName.replace(&quot;#&quot;, &quot;.&quot;) + &quot;.xml&quot;, datasourceName); } String project = new String(); if (datasourceName.contains(&quot;#&quot;)) { project = datasourceName.split(&quot;#&quot;)[0].trim(); } else { project = datasourceName; } Properties properties = new Properties(); properties.put(&quot;location&quot;, &quot;jdbc:mondrian:Jdbc=jdbc:kylin://&quot; + sylinUrl + &quot;/&quot; + project + &quot;;JdbcDrivers=org.apache.kylin.jdbc.Driver&quot; + &quot;;Catalog=mondrian:///datasources/&quot; + datasourceName.replace(&quot;#&quot;, &quot;.&quot;) + &quot;.xml&quot;); properties.put(&quot;driver&quot;, &quot;mondrian.olap4j.MondrianOlap4jDriver&quot;); properties.put(&quot;username&quot;, sylinUser); properties.put(&quot;password&quot;, sylinPassWord); properties.put(&quot;security.enabled&quot;, false); properties.put(&quot;advanced&quot;, false); return new SaikuDatasource(cubeName, SaikuDatasource.Type.OLAP, properties); } return null; } private String execute(String url) throws URISyntaxException, IOException { int httpConnectionTimeoutMs = 30000; int httpSocketTimeoutMs = 120000; final HttpParams httpParams = new BasicHttpParams(); final PoolingClientConnectionManager cm = new PoolingClientConnectionManager(); HttpConnectionParams.setSoTimeout(httpParams, httpSocketTimeoutMs); HttpConnectionParams.setConnectionTimeout(httpParams, httpConnectionTimeoutMs); cm.setDefaultMaxPerRoute(20); cm.setMaxTotal(200); HttpGet get = newGet(url); get.setURI(new URI(url)); DefaultHttpClient client = new DefaultHttpClient(cm, httpParams); if (sylinUser != null &amp;&amp; sylinPassWord != null) { CredentialsProvider provider = new BasicCredentialsProvider(); UsernamePasswordCredentials credentials = new UsernamePasswordCredentials(sylinUser, sylinPassWord); provider.setCredentials(AuthScope.ANY, credentials); client.setCredentialsProvider(provider); } HttpResponse response = client.execute(get); if (response.getStatusLine().getStatusCode() != 200) { throw new IOException(&quot;Invalid response &quot; + response.getStatusLine().getStatusCode()); } String result = getContent(response); return result; } private HttpGet newGet(String url) { HttpGet get = new HttpGet(); addHttpHeaders(get); return get; } private void addHttpHeaders(HttpRequestBase method) { method.addHeader(&quot;Accept&quot;, &quot;application/json, text/plain, */*&quot;); method.addHeader(&quot;Content-Type&quot;, &quot;application/json&quot;); String basicAuth = DatatypeConverter .printBase64Binary((sylinUser + &quot;:&quot; + sylinPassWord).getBytes(StandardCharsets.UTF_8)); method.addHeader(&quot;Authorization&quot;, &quot;Basic &quot; + basicAuth); } private String getContent(HttpResponse response) throws IOException { InputStreamReader reader = null; BufferedReader rd = null; StringBuffer result = new StringBuffer(); try { reader = new InputStreamReader(response.getEntity().getContent(), StandardCharsets.UTF_8); rd = new BufferedReader(reader); String line = null; while ((line = rd.readLine()) != null) { result.append(line); } } finally { IOUtils.closeQuietly(reader); IOUtils.closeQuietly(rd); } return result.toString(); } } mondrian3.0è¯­æ³•å·¥å…·ç±» package org.saiku.service.util; import org.apache.kylin.cube.model.CubeDesc; import org.apache.kylin.cube.model.DimensionDesc; import org.apache.kylin.metadata.model.*; import java.util.*; public class SchemaUtil1 { private static String newLine = &quot;\\r\\n&quot;; private static Set&lt;String&gt; aggSet = new HashSet&lt;String&gt;(){ { add(&quot;sum&quot;); add(&quot;min&quot;); add(&quot;max&quot;); add(&quot;count&quot;); add(&quot;count_distinct&quot;); } }; public static String createSchema(String dataSourceName, CubeDesc cubeDesc, DataModelDesc modelDesc) { StringBuffer sb = new StringBuffer(); sb = appendSchema(sb, dataSourceName, cubeDesc, modelDesc); return sb.toString(); } public static StringBuffer appendSchema(StringBuffer sb, String dataSourceName, CubeDesc cubeDesc, DataModelDesc modelDesc) { sb.append(&quot;&lt;?xml version='1.0'?&gt;&quot;).append(newLine) .append(&quot;&lt;Schema name='&quot; + dataSourceName.split(&quot;#&quot;)[0].trim()+&quot;'&gt;&quot;) .append(newLine); sb = appendCube(sb, dataSourceName, cubeDesc, modelDesc); sb.append(&quot;&lt;/Schema&gt;&quot;).append(newLine); return sb; } public static StringBuffer appendCube(StringBuffer sb, String cubeName, CubeDesc cubeDesc, DataModelDesc modelDesc) { sb.append(&quot;&lt;Cube name='&quot; + cubeName.split(&quot;#&quot;)[1] + &quot;'&gt;&quot;).append(newLine); sb.append(&quot;&lt;Table name='&quot;+dealTableName(modelDesc.getRootFactTableName())+&quot;'/&gt;&quot;).append(newLine); HashMap&lt;String,String&gt; aliasTableMap = new HashMap&lt;String,String&gt;(); HashMap&lt;String,String&gt; aliasTableJoinMap = new HashMap&lt;String,String&gt;(); aliasTableMap.put(dealTableName(modelDesc.getRootFactTableName()),dealTableName(modelDesc.getRootFactTableName())); for(JoinTableDesc joinTableDesc:modelDesc.getJoinTables()) { aliasTableMap.put(joinTableDesc.getAlias(),dealTableName(joinTableDesc.getTable())); if(joinTableDesc.getJoin().getPrimaryKey().length == 1){ aliasTableJoinMap.put(dealTableName(joinTableDesc.getAlias()),joinTableDesc.getJoin().getPrimaryKey()[0].concat(&quot;#&quot;).concat(joinTableDesc.getJoin().getForeignKey()[0])); } } for(DimensionDesc dimensionDesc: cubeDesc.getDimensions()){ // tableSet.add(dealTableName(dimensionDesc.getTable())); if(aliasTableMap.get(dealTableName(dimensionDesc.getTable())).equals(dealTableName(modelDesc.getRootFactTableName()))){ sb.append(&quot;&lt;Dimension name='&quot;+dimensionDesc.getName()+&quot;'&gt;&quot;).append(newLine); sb.append(&quot;&lt;Hierarchy name='&quot;+dimensionDesc.getName()+&quot;' hasAll='true' allMemberName='All &quot;+dimensionDesc.getName()+&quot;'&gt;&quot;).append(newLine); }else if(aliasTableJoinMap.get(dealTableName(dimensionDesc.getTable()))==null){ continue; } else if(aliasTableJoinMap.get(dealTableName(dimensionDesc.getTable()))!=null &amp;&amp; aliasTableJoinMap.get(dealTableName(dimensionDesc.getTable())).split(&quot;#&quot;)[1].split(&quot;\\\\.&quot;)[0] .equals(dealTableName(modelDesc.getRootFactTableName()))){ sb.append(&quot;&lt;Dimension name='&quot;+dimensionDesc.getName()+&quot;' foreignKey='&quot;+aliasTableJoinMap.get(dealTableName(dimensionDesc.getTable())) .split(&quot;#&quot;)[1].split(&quot;\\\\.&quot;)[1]+&quot;'&gt;&quot;).append(newLine); sb.append(&quot;&lt;Hierarchy name='&quot;+dimensionDesc.getName()+&quot;' hasAll='true' allMemberName='All &quot;+dimensionDesc.getName()+&quot;' primaryKey='&quot;+ aliasTableJoinMap.get(dealTableName(dimensionDesc.getTable())).split(&quot;#&quot;)[0].split(&quot;\\\\.&quot;)[1]+&quot;'&gt;&quot;).append(newLine); sb.append(&quot;&lt;Table name='&quot;+aliasTableMap.get(dealTableName(dimensionDesc.getTable()))+&quot;'/&gt;&quot;).append(newLine); } else if(aliasTableJoinMap.get(aliasTableJoinMap.get(dealTableName(dimensionDesc.getTable())).split(&quot;#&quot;)[1].split(&quot;\\\\.&quot;)[0]) .split(&quot;#&quot;)[1].split(&quot;\\\\.&quot;)[0].equals(dealTableName(modelDesc.getRootFactTableName()))){ sb.append(&quot;&lt;Dimension name='&quot;+dimensionDesc.getName()+&quot;' foreignKey='&quot;+aliasTableJoinMap.get(aliasTableJoinMap.get(dealTableName(dimensionDesc.getTable())) .split(&quot;#&quot;)[1].split(&quot;\\\\.&quot;)[0]).split(&quot;#&quot;)[1].split(&quot;\\\\.&quot;)[1]+&quot;'&gt;&quot;).append(newLine); sb.append(&quot;&lt;Hierarchy name='&quot;+dimensionDesc.getName()+&quot;' hasAll='true' allMemberName='All &quot;+dimensionDesc.getName()+&quot;' primaryKey='&quot;+ aliasTableJoinMap.get(aliasTableJoinMap.get(dealTableName(dimensionDesc.getTable())).split(&quot;#&quot;)[1].split(&quot;\\\\.&quot;)[0]) .split(&quot;#&quot;)[0].split(&quot;\\\\.&quot;)[1]+&quot;' primaryKeyTable='&quot;+aliasTableMap.get(aliasTableJoinMap.get(dealTableName(dimensionDesc.getTable())) .split(&quot;#&quot;)[1].split(&quot;\\\\.&quot;)[0])+&quot;'&gt;&quot;).append(newLine); sb.append(&quot;&lt;Join leftKey='&quot;+aliasTableJoinMap.get(dealTableName(dimensionDesc.getTable())).split(&quot;#&quot;)[1].split(&quot;\\\\.&quot;)[1]+&quot;' rightAlias='&quot;+aliasTableMap.get(dimensionDesc.getTable())+ &quot;' rightKey='&quot;+aliasTableJoinMap.get(dealTableName(dimensionDesc.getTable())).split(&quot;#&quot;)[0].split(&quot;\\\\.&quot;)[1]+&quot;'&gt;&quot;).append(newLine); sb.append(&quot;&lt;Table name='&quot;+aliasTableMap.get(aliasTableJoinMap.get(dealTableName(dimensionDesc.getTable())).split(&quot;#&quot;)[1].split(&quot;\\\\.&quot;)[0])+&quot;'/&gt;&quot;).append(newLine); sb.append(&quot;&lt;Table name='&quot;+aliasTableMap.get(dimensionDesc.getTable())+&quot;'/&gt;&quot;).append(newLine); sb.append(&quot;&lt;/Join&gt;&quot;).append(newLine); } else { continue; } Set&lt;String&gt; columns = getColumns(dimensionDesc); for(String column:columns){ sb.append(&quot;&lt;Level name='&quot;+column+&quot;' column='&quot;+column+&quot;' table='&quot;+aliasTableMap.get(dimensionDesc.getTable())+&quot;'/&gt;&quot;).append(newLine); } sb.append(&quot;&lt;/Hierarchy&gt;&quot;).append(newLine); sb.append(&quot;&lt;/Dimension&gt;&quot;).append(newLine); } for (MeasureDesc measureDesc : cubeDesc.getMeasures()) { int i=0; String table = measureDesc.getFunction().getParameter().getValue().split(&quot;\\\\.&quot;)[0]; final boolean flag = Arrays.stream(modelDesc.getJoinTables()).anyMatch(item -&gt; table.equals(dealTableName(item.getTable()))); if(table.equals(dealTableName(modelDesc.getRootFactTableName()))||flag||table.equals(&quot;1&quot;)){ addMeasure(sb,measureDesc,getColumn(cubeDesc,modelDesc,dealTableName(modelDesc.getRootFactTableName()))); } } sb.append(&quot;&lt;/Cube&gt;&quot;).append(newLine); return sb; } public static String dealTableName(String tableName){ if(tableName.contains(&quot;.&quot;)) return tableName.split(&quot;\\\\.&quot;)[1]; else return tableName; } public static StringBuffer addMeasure(StringBuffer sb, MeasureDesc measureDesc, String defaultColumn) { FunctionDesc funtionDesc = measureDesc.getFunction(); String aggregator = funtionDesc.getExpression().trim().toLowerCase(); if(aggSet.contains(aggregator.toLowerCase())){ //mondrian only have distinct-count if(aggregator.equals(&quot;count_distinct&quot;)){ aggregator = &quot;distinct-count&quot;; } if(funtionDesc.getParameter().getValue().equals(&quot;1&quot;)) { sb.append(&quot;&lt;Measure aggregator='&quot; + aggregator + &quot;' column='&quot; + defaultColumn + &quot;' name='&quot; + measureDesc.getName() + &quot;' visible='true'/&gt;&quot;) .append(newLine); } else sb.append(&quot;&lt;Measure aggregator='&quot; + aggregator + &quot;' column='&quot; + funtionDesc.getParameter().getValue().split(&quot;\\\\.&quot;)[1] + &quot;' name='&quot; + measureDesc.getName() + &quot;' visible='true'/&gt;&quot;) .append(newLine); return sb; } return sb; } public static String getColumn(CubeDesc cubeDesc,DataModelDesc dataModelDesc,String tableName){ List&lt;MeasureDesc&gt; measureDescList = cubeDesc.getMeasures(); for(MeasureDesc measureDesc:measureDescList){ if(measureDesc.getFunction().getParameter().getValue().split(&quot;\\\\.&quot;)[0].equals(tableName)){ return measureDesc.getFunction().getParameter().getValue().split(&quot;\\\\.&quot;)[1]; } } if(dataModelDesc.getMetrics().length&gt;0){ return dataModelDesc.getMetrics()[0]; } for(ModelDimensionDesc modelDimensionDesc:dataModelDesc.getDimensions()){ if(modelDimensionDesc.getTable().equals(tableName)){ return modelDimensionDesc.getColumns()[0]; } } return null; } public static Set&lt;String&gt; getColumns(DimensionDesc dimensionDesc){ Set&lt;String&gt; columns = new HashSet&lt;String&gt;(); if (dimensionDesc.getColumn() != null || dimensionDesc.getDerived() != null) { if(dimensionDesc.getColumn() != null) { columns.add(dimensionDesc.getColumn()); } if (dimensionDesc.getDerived() != null) { for (String derived : dimensionDesc.getDerived()) { columns.add(derived); } } } else { columns.add(dimensionDesc.getName()); } return columns; } } &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;Schema name=&quot;Mondrian&quot;&gt; &lt;!--æ¨¡å‹å®šä¹‰--&gt; &lt;Cube name=&quot;Person&quot;&gt; &lt;!--ç«‹æ–¹ä½“ ï¼Œä¸€ä¸ªç«‹æ–¹ä½“æœ‰å¤šä¸ªç»´åº¦--&gt; &lt;Table name=&quot;PERSON&quot; /&gt; &lt;!--ç«‹æ–¹ä½“å¯¹åº”çš„è¡¨ --&gt; &lt;Dimension name=&quot;éƒ¨é—¨&quot; foreignKey=&quot;USERID&quot; &gt; &lt;!--å®šä¹‰ç»´åº¦ --&gt; &lt;Hierarchy hasAll=&quot;true&quot; primaryKey=&quot;USERID&quot; allMemberName=&quot;æ‰€æœ‰éƒ¨é—¨&quot; &gt; &lt;!--å®šä¹‰ç»´åº¦ä¸‹é¢çš„å±‚æ¬¡ï¼Œå±‚æ¬¡åŒ…å«å¾ˆå¤šå±‚ --&gt; &lt;Table name=&quot;PERSON&quot; alias=&quot;a&quot;/&gt; &lt;!--å®šä¹‰ç»´åº¦è·å–æ•°æ®çš„æ¥æº-è¡¨ --&gt; &lt;Level name=&quot;éƒ¨é—¨&quot; column=&quot;DEPARTMENT&quot; uniqueMembers=&quot;true&quot; /&gt; &lt;!--å®šä¹‰å±‚æ¬¡çš„å±‚ï¼Œæ¯ä¸ªå±‚å¯¹åº”æ•°æ®åº“ä¸­å¯¹åº”çš„å­—æ®µ --&gt; &lt;Level name=&quot;å§“å&quot; column=&quot;USERNAME&quot; uniqueMembers=&quot;true&quot; /&gt; &lt;/Hierarchy&gt; &lt;/Dimension&gt; &lt;Dimension name=&quot;æ€§åˆ«&quot; foreignKey=&quot;USERID&quot; &gt; &lt;Hierarchy hasAll=&quot;true&quot; primaryKey=&quot;USERID&quot; allMemberName=&quot;æ‰€æœ‰æ€§åˆ«&quot;&gt; &lt;Table name=&quot;PERSON&quot; alias=&quot;b&quot; /&gt; &lt;Level name=&quot;æ€§åˆ«&quot; column=&quot;SEX&quot; uniqueMembers=&quot;true&quot; /&gt; &lt;/Hierarchy&gt; &lt;/Dimension&gt; &lt;Dimension name=&quot;ä¸“ä¸šæŠ€æœ¯èµ„æ ¼ç±»åˆ«&quot; foreignKey=&quot;USERID&quot; &gt; &lt;Hierarchy hasAll=&quot;true&quot; primaryKey=&quot;USERID&quot; allMemberName=&quot;æ‰€æœ‰ä¸“ä¸šæŠ€æœ¯èµ„æ ¼ç±»åˆ«&quot;&gt; &lt;Table name=&quot;PERSON&quot; alias=&quot;c&quot; /&gt; &lt;Level name=&quot;èµ„æ ¼ç±»åˆ«&quot; column=&quot;ZYJSLB&quot; uniqueMembers=&quot;true&quot; /&gt; &lt;/Hierarchy&gt; &lt;/Dimension&gt; &lt;Dimension name=&quot;ä¸“ä¸šæŠ€æœ¯èµ„æ ¼ç­‰çº§&quot; foreignKey=&quot;USERID&quot; &gt; &lt;Hierarchy hasAll=&quot;true&quot; primaryKey=&quot;USERID&quot; allMemberName=&quot;æ‰€æœ‰ä¸“ä¸šæŠ€æœ¯èµ„æ ¼ç­‰çº§&quot;&gt; &lt;Table name=&quot;PERSON&quot; alias=&quot;d&quot; /&gt; &lt;Level name=&quot;èµ„æ ¼ç­‰çº§&quot; column=&quot;ZYJSDJ&quot; uniqueMembers=&quot;true&quot; /&gt; &lt;/Hierarchy&gt; &lt;/Dimension&gt; &lt;Dimension name=&quot;èŒç³»&quot; foreignKey=&quot;USERID&quot; &gt; &lt;Hierarchy hasAll=&quot;true&quot; primaryKey=&quot;USERID&quot; allMemberName=&quot;æ‰€æœ‰èŒç³»&quot;&gt; &lt;Table name=&quot;PERSON&quot; alias=&quot;e&quot; /&gt; &lt;Level name=&quot;èŒç³»&quot; column=&quot;ZHIXI&quot; uniqueMembers=&quot;true&quot; /&gt; &lt;/Hierarchy&gt; &lt;/Dimension&gt; &lt;Dimension name=&quot;æ°‘æ—&quot; foreignKey=&quot;USERID&quot; &gt; &lt;Hierarchy hasAll=&quot;true&quot; primaryKey=&quot;USERID&quot; allMemberName=&quot;æ‰€æœ‰æ°‘æ—&quot;&gt; &lt;Table name=&quot;PERSON&quot; alias=&quot;f&quot; /&gt; &lt;Level name=&quot;æ°‘æ—&quot; column=&quot;NATIONALITY&quot; uniqueMembers=&quot;true&quot; /&gt; &lt;/Hierarchy&gt; &lt;/Dimension&gt; &lt;Dimension name=&quot;å­¦å†&quot; foreignKey=&quot;USERID&quot; &gt; &lt;Hierarchy hasAll=&quot;true&quot; primaryKey=&quot;USERID&quot; allMemberName=&quot;æ‰€æœ‰å­¦å†&quot;&gt; &lt;Table name=&quot;PERSON&quot; alias=&quot;g&quot; /&gt; &lt;Level name=&quot;å­¦å†&quot; column=&quot;XUELI&quot; uniqueMembers=&quot;true&quot; /&gt; &lt;/Hierarchy&gt; &lt;/Dimension&gt; &lt;Measure name=&quot;äººæ•°&quot; column=&quot;USERID&quot; aggregator=&quot;distinct count&quot; /&gt; &lt;!--æŒ‡æ ‡/åº¦é‡ï¼Œé‡‡ç”¨distinct countèšåˆ --&gt; &lt;/Cube&gt; &lt;/Schema&gt; mondrian4.0è¯­æ³•å·¥å…·ç±» package org.saiku.service.util; import org.apache.kylin.cube.model.CubeDesc; import org.apache.kylin.cube.model.DimensionDesc; import org.apache.kylin.cube.model.RowKeyDesc; import org.apache.kylin.metadata.model.*; import java.util.*; public class SchemaUtil { private static final String newLine = &quot;\\r\\n&quot;; private static Map&lt;String, String&gt; map; public static String createSchema(String dataSourceName, CubeDesc cubeDesc, DataModelDesc modelDesc) { StringBuffer sb = new StringBuffer(); sb = appendSchema(sb, dataSourceName, cubeDesc, modelDesc); // System.out.println(&quot;********************************&quot; + sb.toString()); return sb.toString(); } public static StringBuffer appendSchema(StringBuffer sb, String dataSourceName, CubeDesc cubeDesc, DataModelDesc modelDesc) { sb.append(&quot;&lt;?xml version='1.0'?&gt;&quot;).append(newLine) .append(&quot;&lt;Schema name='&quot;).append(dataSourceName.split(&quot;#&quot;)[0].trim()).append(&quot;' metamodelVersion='4.0'&gt;&quot;) // .append(&quot;&lt;Schema name='&quot; + dataSourceName + &quot;' metamodelVersion='4.0'&gt;&quot;) .append(newLine); appendTable(sb, modelDesc); appendDimension(sb, modelDesc); appendCube(sb, dataSourceName, cubeDesc, modelDesc); sb.append(&quot;&lt;/Schema&gt;&quot;).append(newLine); return sb; } public static StringBuffer appendTable(StringBuffer sb, DataModelDesc modelDesc) { StringBuilder linkSb = new StringBuilder(); //è·å–æ‰€æœ‰å…³ç³»è¡¨ final List&lt;ModelDimensionDesc&gt; tables = modelDesc.getDimensions(); sb.append(&quot;&lt;PhysicalSchema&gt;&quot;).append(newLine); //æ·»åŠ è¡¨å…³è”å…³ç³» final JoinTableDesc[] joinTables = modelDesc.getJoinTables(); for (JoinTableDesc joinTableDesc : joinTables) { String factTablename = dealModelTableName(joinTableDesc.getJoin().getForeignKey()[0]); String Column = dealTableName(joinTableDesc.getJoin().getForeignKey()[0]); String joinTablename = dealModelTableName(joinTableDesc.getJoin().getPrimaryKey()[0]); String joinColumn = dealTableName(joinTableDesc.getJoin().getPrimaryKey()[0]); linkSb.append(&quot;&lt;Link source='&quot;).append(factTablename).append(&quot;' target='&quot;).append(joinTablename).append(&quot;'&gt;&quot;).append(newLine) .append(&quot;&lt;ForeignKey&gt;&quot;).append(newLine) .append(&quot;&lt;Column name='&quot;).append(Column).append(&quot;'/&gt;&quot;).append(newLine) .append(&quot;&lt;/ForeignKey&gt;&quot;).append(newLine) .append(&quot;&lt;/Link&gt;&quot;).append(newLine); //æ¸…ç©ºmap map = new HashMap&lt;&gt;(); tables.forEach(item -&gt; { if (item.getTable().equals(factTablename)) { map.put(factTablename, Column); } if (item.getTable().equals(joinTablename)) { map.put(joinTablename, joinColumn); } }); } //æ·»åŠ è¡¨ for (String tableName : map.keySet()) { sb.append(&quot;&lt;Table name='&quot;).append(tableName).append(&quot;'&gt;&quot;).append(newLine) .append(&quot;&lt;Key&gt;&quot;).append(newLine).append(&quot;&lt;Column name='&quot;).append(map.get(tableName)).append(&quot;'/&gt;&quot;).append(newLine) .append(&quot;&lt;/Key&gt;&quot;).append(newLine) .append(&quot;&lt;/Table&gt;&quot;).append(newLine); } sb.append(linkSb); linkSb.delete(0, linkSb.length()); sb.append(&quot;&lt;/PhysicalSchema&gt;&quot;).append(newLine); return sb; } public static Map&lt;String, JoinDesc&gt; getJoinDesc(DataModelDesc modelDesc) { Map&lt;String, JoinDesc&gt; joinDescMap = new HashMap&lt;String, JoinDesc&gt;(); for (JoinTableDesc lookupDesc : modelDesc.getJoinTables()) { if (!joinDescMap.containsKey(dealTableName(lookupDesc.getTable()))) joinDescMap.put(dealTableName(lookupDesc.getTable()), lookupDesc.getJoin()); } return joinDescMap; } public static void appendDimension(StringBuffer sb, DataModelDesc modelDesc) { StringBuilder hierSb = new StringBuilder(); for (ModelDimensionDesc dimensionDesc : modelDesc.getDimensions()) { sb.append(&quot;&lt;Dimension name='&quot;).append(dimensionDesc.getTable()).append(&quot;' key='&quot;).append(map.get(dimensionDesc.getTable())).append(&quot;' table='&quot;).append(dimensionDesc.getTable()).append(&quot;'&gt;&quot;).append(newLine); sb.append(&quot;&lt;Attributes&gt;&quot;).append(newLine); hierSb.append(&quot;&lt;Hierarchies&gt;&quot;).append(newLine); hierSb.append(&quot;&lt;Hierarchy name='&quot;).append(dimensionDesc.getTable()).append(&quot;' hasAll='true'&gt;&quot;).append(newLine); for (String column : dimensionDesc.getColumns()) { // add Attributes to stringbuffer addAttribute(sb, column); addHierarchy(hierSb, column); } sb.append(&quot;&lt;/Attributes&gt;&quot;).append(newLine); hierSb.append(&quot;&lt;/Hierarchy&gt;&quot;).append(newLine); hierSb.append(&quot;&lt;/Hierarchies&gt;&quot;).append(newLine); sb.append(hierSb); hierSb.delete(0, hierSb.length()); sb.append(&quot;&lt;/Dimension&gt;&quot;).append(newLine); } } public static Set&lt;String&gt; getColumns(DimensionDesc dimensionDesc) { Set&lt;String&gt; columns = new HashSet&lt;String&gt;(); if (dimensionDesc.getColumn() != null || dimensionDesc.getDerived() != null) { if (dimensionDesc.getColumn() != null) { // for (String column : dimensionDesc.getColumn()) { columns.add(dimensionDesc.getColumn()); // } } if (dimensionDesc.getDerived() != null) { columns.addAll(Arrays.asList(dimensionDesc.getDerived())); } } else { columns.add(dimensionDesc.getName()); } return columns; } public static StringBuffer addAttribute(StringBuffer sb, String attr) { sb.append(&quot;&lt;Attribute name='&quot;).append(attr).append(&quot;' keyColumn='&quot;).append(attr).append(&quot;' hasHierarchy='false'/&gt;&quot;).append(newLine); return sb; } public static void addHierarchy(StringBuilder sb, String attr) { sb.append(&quot;&lt;Level attribute='&quot;).append(attr).append(&quot;'/&gt;&quot;).append(newLine); } public static String dealTableName(String tableName) { if (tableName.contains(&quot;.&quot;)) return tableName.split(&quot;\\\\.&quot;)[1]; else return tableName; } public static String dealModelTableName(String tableName) { if (tableName.contains(&quot;.&quot;)) return tableName.split(&quot;\\\\.&quot;)[0]; else return tableName; } public static StringBuffer appendCube(StringBuffer sb, String cubeName, CubeDesc cubeDesc, DataModelDesc modelDesc) { sb.append(&quot;&lt;Cube name='&quot;).append(cubeName.split(&quot;#&quot;)[1].trim()).append(&quot;'&gt;&quot;).append(newLine); addCubeDimension(sb, modelDesc.getDimensions()); sb.append(&quot;&lt;MeasureGroups&gt;&quot;).append(newLine); Map&lt;String, Map&lt;String, MeasureDesc&gt;&gt; allMap = new HashMap(); MeasureDesc one = new MeasureDesc(); for (MeasureDesc measureDesc : cubeDesc.getMeasures()) { final String tableName = dealModelTableName(measureDesc.getFunction().getParameter().getValue()); final String columnName = dealTableName(measureDesc.getFunction().getParameter().getValue()); if (&quot;1&quot;.equals(tableName)) { one = measureDesc; } else { if (Objects.isNull(allMap.get(tableName))) { Map&lt;String, MeasureDesc&gt; map = new HashMap(); if (Objects.nonNull(one)) { map.put(columnName, one); one = null; } map.put(columnName, measureDesc); allMap.put(tableName, map); } else { allMap.get(tableName).put(columnName, measureDesc); } } } allMap.forEach((tableName, value) -&gt; { sb.append(&quot;&lt;MeasureGroup table='&quot;).append(dealTableName(tableName)).append(&quot;'&gt;&quot;).append(newLine); addDimensionLink(sb, modelDesc); sb.append(&quot;&lt;Measures&gt;&quot;).append(newLine); value.forEach((columnName, measureDesc) -&gt; { addMeasure(sb, measureDesc, getColumn(cubeDesc)); }); sb.append(&quot;&lt;/Measures&gt;&quot;).append(newLine); sb.append(&quot;&lt;/MeasureGroup&gt;&quot;).append(newLine); }); sb.append(&quot;&lt;/MeasureGroups&gt;&quot;).append(newLine); sb.append(&quot;&lt;/Cube&gt;&quot;).append(newLine); return sb; } public static void addCubeDimension(StringBuffer sb, List&lt;ModelDimensionDesc&gt; dimensionDescs) { sb.append(&quot;&lt;Dimensions&gt;&quot;).append(newLine); for (ModelDimensionDesc dimensionDesc : dimensionDescs) { sb.append(&quot;&lt;Dimension source='&quot;).append(dimensionDesc.getTable()).append(&quot;' visible='true'/&gt;&quot;).append(newLine); } sb.append(&quot;&lt;/Dimensions&gt;&quot;).append(newLine); } public static void addDimensionLink(StringBuffer sb, DataModelDesc modelDesc) { sb.append(&quot;&lt;DimensionLinks&gt;&quot;).append(newLine); for(ModelDimensionDesc dimensionDesc : modelDesc.getDimensions()) { if(dimensionDesc.getTable().contains(dealTableName(modelDesc.getRootFactTableName()))) { sb.append(&quot;&lt;FactLink dimension='&quot;).append(dimensionDesc.getTable()).append(&quot;'/&gt;&quot;).append(newLine); }else{ sb.append(&quot;&lt;ForeignKeyLink dimension='&quot;).append(dimensionDesc.getTable()).append(&quot;' foreignKeyColumn='&quot;).append(map.get(dimensionDesc.getTable())).append(&quot;'/&gt;&quot;).append(newLine); } } sb.append(&quot; &lt;/DimensionLinks&gt;&quot;).append(newLine); } public static StringBuffer addMeasure(StringBuffer sb, MeasureDesc measureDesc, String defaultColumn) { FunctionDesc funtionDesc = measureDesc.getFunction(); String aggregator = funtionDesc.getExpression().trim().toLowerCase(); //mondrian only have distinct-count if (aggregator.equals(&quot;count_distinct&quot;)) { aggregator = &quot;distinct-count&quot;; } if (funtionDesc.getParameter().getValue().equals(&quot;1&quot;)) { sb.append(&quot;&lt;Measure aggregator='&quot;).append(aggregator).append(&quot;' column='&quot;).append(dealTableName(defaultColumn)).append(&quot;' name='&quot;).append(measureDesc.getName()).append(&quot;' visible='true'/&gt;&quot;) .append(newLine); } else sb.append(&quot;&lt;Measure aggregator='&quot;).append(aggregator).append(&quot;' column='&quot;).append(dealTableName(funtionDesc.getParameter().getValue())).append(&quot;' name='&quot;).append(measureDesc.getName()).append(&quot;' visible='true'/&gt;&quot;) .append(newLine); return sb; } public static Set&lt;String&gt; getTables(List&lt;DimensionDesc&gt; dimensionDescList) { Set&lt;String&gt; tables = new HashSet&lt;String&gt;(); for (DimensionDesc dimensionDesc : dimensionDescList) { String table = dealTableName(dimensionDesc.getTable()); tables.add(table); } return tables; } public static String getColumn(CubeDesc cubeDesc) { RowKeyDesc rowKey = cubeDesc.getRowkey(); return rowKey.getRowKeyColumns()[0].getColumn(); } } &lt;?xml version='1.0'?&gt; &lt;Schema name='xiaowei' metamodelVersion='4.0'&gt; &lt;PhysicalSchema&gt; &lt;Table name='TBL_FARM_INCOME_STATICS'&gt; &lt;Key&gt; &lt;Column name='COMPANY_ID'/&gt; &lt;/Key&gt; &lt;/Table&gt; &lt;Table name='TBL_CUSTOMER'&gt; &lt;Key&gt; &lt;Column name='COMPANY_ID'/&gt; &lt;/Key&gt; &lt;/Table&gt; &lt;Link source='TBL_FARM_INCOME_STATICS' target='TBL_CUSTOMER'&gt; &lt;ForeignKey&gt; &lt;Column name='COMPANY_ID'/&gt; &lt;/ForeignKey&gt; &lt;/Link&gt; &lt;/PhysicalSchema&gt; &lt;Dimension name='TBL_FARM_INCOME_STATICS' table='TBL_FARM_INCOME_STATICS' key='COMPANY_ID'&gt; &lt;Attributes&gt; &lt;Attribute name='COMPANY_ID' keyColumn='COMPANY_ID' hasHierarchy='false'/&gt; &lt;Attribute name='INCOME_DATE' keyColumn='INCOME_DATE' hasHierarchy='false'/&gt; &lt;/Attributes&gt; &lt;Hierarchies&gt; &lt;Hierarchy name='TBL_FARM_INCOME_STATICS' allMemberName='All Warehouses'&gt; &lt;Level attribute='COMPANY_ID'/&gt; &lt;Level attribute='INCOME_DATE'/&gt; &lt;/Hierarchy&gt; &lt;/Hierarchies&gt; &lt;/Dimension&gt; &lt;Dimension name='TBL_CUSTOMER' table='TBL_CUSTOMER' key='COMPANY_ID'&gt; &lt;Attributes&gt; &lt;Attribute name='COMPANY_ID' keyColumn='COMPANY_ID' hasHierarchy='false'/&gt; &lt;Attribute name='CUSTOMER_TYPE' keyColumn='CUSTOMER_TYPE' hasHierarchy='false'/&gt; &lt;Attribute name='PHONE' keyColumn='PHONE' hasHierarchy='false'/&gt; &lt;/Attributes&gt; &lt;Hierarchies&gt; &lt;Hierarchy name='TBL_CUSTOMER' allMemberName='All Warehouses'&gt; &lt;Level attribute='COMPANY_ID'/&gt; &lt;Level attribute='CUSTOMER_TYPE'/&gt; &lt;Level attribute='PHONE'/&gt; &lt;/Hierarchy&gt; &lt;/Hierarchies&gt; &lt;/Dimension&gt; &lt;Cube name='tbl_farm_income_statics'&gt; &lt;Dimensions&gt; &lt;Dimension source='TBL_FARM_INCOME_STATICS' visible='true'/&gt; &lt;Dimension source='TBL_CUSTOMER' visible='true'/&gt; &lt;/Dimensions&gt; &lt;MeasureGroups&gt; &lt;MeasureGroup table='TBL_CUSTOMER'&gt; &lt;Measures&gt; &lt;Measure aggregator='sum' column='CONSUME_AMMOUT' name='CONSUME_AMMOUT_SUM' visible='true'/&gt; &lt;/Measures&gt; &lt;DimensionLinks&gt; &lt;FactLink dimension='TBL_FARM_INCOME_STATICS'/&gt; &lt;ForeignKeyLink dimension='TBL_CUSTOMER' foreignKeyColumn='COMPANY_ID'/&gt; &lt;/DimensionLinks&gt; &lt;/MeasureGroup&gt; &lt;MeasureGroup table='TBL_FARM_INCOME_STATICS'&gt; &lt;Measures&gt; &lt;Measure aggregator='count' column='COMPANY_ID' name='_COUNT_' visible='true'/&gt; &lt;Measure aggregator='sum' column='REFUND_AMOUNT' name='REFUND_AMOUNT_SUM' visible='true'/&gt; &lt;Measure aggregator='sum' column='COMMON_REFUND_AMOUNT' name='COMMON_REFUND_AMOUNT_SUM' visible='true'/&gt; &lt;Measure aggregator='sum' column='COMMON_INCOME' name='COMMON_INCOME_SUM' visible='true'/&gt; &lt;Measure aggregator='sum' column='SALE_AMOUNT' name='SALE_AMOUNT_SUM' visible='true'/&gt; &lt;Measure aggregator='sum' column='RENEW_AMOUNT' name='RENEW_AMOUNT_SUM' visible='true'/&gt; &lt;Measure aggregator='sum' column='TOTAL_AMOUNT' name='TOTAL_AMOUNT_SUM' visible='true'/&gt; &lt;/Measures&gt; &lt;DimensionLinks&gt; &lt;FactLink dimension='TBL_FARM_INCOME_STATICS'/&gt; &lt;ForeignKeyLink dimension='TBL_CUSTOMER' foreignKeyColumn='COMPANY_ID'/&gt; &lt;/DimensionLinks&gt; &lt;/MeasureGroup&gt; &lt;/MeasureGroups&gt; &lt;/Cube&gt; &lt;/Schema&gt; ","link":"https://tianxiawuhao.github.io/0wQHSTDWt/"},{"title":"åŒæ­¥ å¼‚æ­¥ é˜»å¡ éé˜»å¡","content":"IOæ“ä½œ IOåˆ†ä¸¤é˜¶æ®µï¼ˆä¸€æ—¦æ‹¿åˆ°æ•°æ®åå°±å˜æˆäº†æ•°æ®æ“ä½œï¼Œä¸å†æ˜¯IOï¼‰ï¼š 1.æ•°æ®å‡†å¤‡é˜¶æ®µ 2.å†…æ ¸ç©ºé—´å¤åˆ¶æ•°æ®åˆ°ç”¨æˆ·è¿›ç¨‹ç¼“å†²åŒºï¼ˆç”¨æˆ·ç©ºé—´ï¼‰é˜¶æ®µ åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œç¨‹åºè¿è¡Œçš„ç©ºé—´åˆ†ä¸ºå†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´ã€‚ åº”ç”¨ç¨‹åºéƒ½æ˜¯è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´çš„ï¼Œæ‰€ä»¥å®ƒä»¬èƒ½æ“ä½œçš„æ•°æ®ä¹Ÿéƒ½åœ¨ç”¨æˆ·ç©ºé—´ã€‚ é˜»å¡IOå’Œéé˜»å¡IOçš„åŒºåˆ«åœ¨äºç¬¬ä¸€æ­¥å‘èµ·IOè¯·æ±‚æ˜¯å¦ä¼šè¢«é˜»å¡ï¼š å¦‚æœé˜»å¡ç›´åˆ°å®Œæˆé‚£ä¹ˆå°±æ˜¯ä¼ ç»Ÿçš„é˜»å¡IOï¼Œå¦‚æœä¸é˜»å¡ï¼Œé‚£ä¹ˆå°±æ˜¯éé˜»å¡IOã€‚ ä¸€èˆ¬æ¥è®²ï¼š é˜»å¡IOæ¨¡å‹ã€éé˜»å¡IOæ¨¡å‹ã€IOå¤ç”¨æ¨¡å‹(select/poll/epoll)ã€ä¿¡å·é©±åŠ¨IOæ¨¡å‹éƒ½å±äºåŒæ­¥IOï¼Œå› ä¸ºé˜¶æ®µ2æ˜¯é˜»å¡çš„(å°½ç®¡æ—¶é—´å¾ˆçŸ­)ã€‚ åŒæ­¥IOå’Œå¼‚æ­¥IOçš„åŒºåˆ«å°±åœ¨äºç¬¬äºŒä¸ªæ­¥éª¤æ˜¯å¦é˜»å¡ï¼š å¦‚æœä¸é˜»å¡ï¼Œè€Œæ˜¯æ“ä½œç³»ç»Ÿå¸®ä½ åšå®ŒIOæ“ä½œå†å°†ç»“æœè¿”å›ç»™ä½ ï¼Œé‚£ä¹ˆå°±æ˜¯å¼‚æ­¥IO åŒæ­¥å’Œå¼‚æ­¥IO é˜»å¡å’Œéé˜»å¡IO åŒæ­¥å’Œå¼‚æ­¥IOçš„æ¦‚å¿µï¼š åŒæ­¥æ˜¯ç”¨æˆ·çº¿ç¨‹å‘èµ·I/Oè¯·æ±‚åéœ€è¦ç­‰å¾…æˆ–è€…è½®è¯¢å†…æ ¸I/Oæ“ä½œå®Œæˆåæ‰èƒ½ç»§ç»­æ‰§è¡Œ å¼‚æ­¥æ˜¯ç”¨æˆ·çº¿ç¨‹å‘èµ·I/Oè¯·æ±‚åä»éœ€è¦ç»§ç»­æ‰§è¡Œï¼Œå½“å†…æ ¸I/Oæ“ä½œå®Œæˆåä¼šé€šçŸ¥ç”¨æˆ·çº¿ç¨‹ï¼Œæˆ–è€…è°ƒç”¨ç”¨æˆ·çº¿ç¨‹æ³¨å†Œçš„å›è°ƒå‡½æ•° é˜»å¡å’Œéé˜»å¡IOçš„æ¦‚å¿µï¼š é˜»å¡æ˜¯æŒ‡I/Oæ“ä½œéœ€è¦å½»åº•å®Œæˆåæ‰èƒ½è¿”å›ç”¨æˆ·ç©ºé—´ éé˜»å¡æ˜¯æŒ‡I/Oæ“ä½œè¢«è°ƒç”¨åç«‹å³è¿”å›ä¸€ä¸ªçŠ¶æ€å€¼ï¼Œæ— éœ€ç­‰I/Oæ“ä½œå½»åº•å®Œæˆ åŒæ­¥ä¸å¼‚æ­¥ï¼ˆçº¿ç¨‹é—´è°ƒç”¨ï¼‰ åŒæ­¥ä¸å¼‚æ­¥æ˜¯å¯¹åº”äºè°ƒç”¨è€…ä¸è¢«è°ƒç”¨è€…ï¼Œå®ƒä»¬æ˜¯çº¿ç¨‹ä¹‹é—´çš„å…³ç³»ï¼Œä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´è¦ä¹ˆæ˜¯åŒæ­¥çš„ï¼Œè¦ä¹ˆæ˜¯å¼‚æ­¥çš„ åŒæ­¥æ“ä½œæ—¶ï¼Œè°ƒç”¨è€…éœ€è¦ç­‰å¾…è¢«è°ƒç”¨è€…è¿”å›ç»“æœï¼Œæ‰ä¼šè¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œ è€Œå¼‚æ­¥åˆ™ç›¸åï¼Œè°ƒç”¨è€…ä¸éœ€è¦ç­‰å¾…è¢«è°ƒç”¨è€…è¿”å›è°ƒç”¨ï¼Œå³å¯è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œï¼Œè¢«è°ƒç”¨è€…é€šå¸¸ä¾é äº‹ä»¶ã€å›è°ƒç­‰æœºåˆ¶æ¥é€šçŸ¥è°ƒç”¨è€…ç»“æœ é˜»å¡ä¸éé˜»å¡ï¼ˆçº¿ç¨‹å†…è°ƒç”¨ï¼‰ é˜»å¡ä¸éé˜»å¡æ˜¯å¯¹åŒä¸€ä¸ªçº¿ç¨‹æ¥è¯´çš„ï¼Œåœ¨æŸä¸ªæ—¶åˆ»ï¼Œçº¿ç¨‹è¦ä¹ˆå¤„äºé˜»å¡ï¼Œè¦ä¹ˆå¤„äºéé˜»å¡ é˜»å¡å’Œéé˜»å¡å…³æ³¨çš„æ˜¯ç¨‹åºåœ¨ç­‰å¾…è°ƒç”¨ç»“æœï¼ˆæ¶ˆæ¯ï¼Œè¿”å›å€¼ï¼‰æ—¶çš„çŠ¶æ€ï¼š é˜»å¡è°ƒç”¨æ˜¯æŒ‡è°ƒç”¨ç»“æœè¿”å›ä¹‹å‰ï¼Œå½“å‰çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ã€‚è°ƒç”¨çº¿ç¨‹åªæœ‰åœ¨å¾—åˆ°ç»“æœä¹‹åæ‰ä¼šè¿”å›ã€‚ éé˜»å¡è°ƒç”¨æŒ‡åœ¨ä¸èƒ½ç«‹åˆ»å¾—åˆ°ç»“æœä¹‹å‰ï¼Œè¯¥è°ƒç”¨ä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ã€‚ åŒæ­¥ä¸å¼‚æ­¥è°ƒç”¨/çº¿ç¨‹/é€šä¿¡ åŒæ­¥å°±æ˜¯ä¸¤ç§ä¸œè¥¿é€šè¿‡ä¸€ç§æœºåˆ¶å®ç°æ­¥è°ƒä¸€è‡´ï¼Œå¼‚æ­¥æ˜¯ä¸¤ç§ä¸œè¥¿ä¸å¿…æ­¥è°ƒä¸€è‡´ ä¸€ã€åŒæ­¥è°ƒç”¨ä¸å¼‚æ­¥è°ƒç”¨ï¼š åœ¨ç”¨åœ¨è°ƒç”¨åœºæ™¯ä¸­ï¼Œæ— éæ˜¯å¯¹è°ƒç”¨ç»“æœçš„ä¸åŒå¤„ç†ã€‚ åŒæ­¥è°ƒç”¨å°±æ˜¯è°ƒç”¨ä¸€ä½†è¿”å›ï¼Œå°±èƒ½çŸ¥é“ç»“æœï¼Œè€Œå¼‚æ­¥æ˜¯è¿”å›æ—¶ä¸ä¸€å®šçŸ¥é“ç»“æœï¼Œè¿˜å¾—é€šè¿‡å…¶ä»–æœºåˆ¶æ¥è·çŸ¥ç»“æœï¼Œå¦‚ï¼š a. çŠ¶æ€ b. é€šçŸ¥ c. å›è°ƒå‡½æ•° äºŒã€åŒæ­¥çº¿ç¨‹ä¸å¼‚æ­¥çº¿ç¨‹ï¼š åŒæ­¥çº¿ç¨‹ï¼šå³ä¸¤ä¸ªçº¿ç¨‹æ­¥è°ƒè¦ä¸€è‡´ï¼Œå…¶ä¸­ä¸€ä¸ªçº¿ç¨‹å¯èƒ½è¦é˜»å¡ç­‰å¾…å¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„è¿è¡Œï¼Œè¦ç›¸äº’åå•†ã€‚å¿«çš„é˜»å¡ä¸€ä¸‹ç­‰åˆ°æ…¢çš„æ­¥è°ƒä¸€è‡´ã€‚ å¼‚æ­¥çº¿ç¨‹ï¼šæ­¥è°ƒä¸ç”¨ä¸€è‡´ï¼Œå„è‡ªæŒ‰å„è‡ªçš„æ­¥è°ƒè¿è¡Œï¼Œä¸å—å¦ä¸€ä¸ªçº¿ç¨‹çš„å½±å“ã€‚ ä¸‰ã€åŒæ­¥é€šä¿¡ä¸å¼‚æ­¥é€šä¿¡ï¼š åŒæ­¥å’Œå¼‚æ­¥æ˜¯æŒ‡ï¼šå‘é€æ–¹å’Œæ¥æ”¶æ–¹æ˜¯å¦åè°ƒæ­¥è°ƒä¸€è‡´ åŒæ­¥é€šä¿¡æ˜¯æŒ‡ï¼šå‘é€æ–¹å’Œæ¥æ”¶æ–¹é€šè¿‡ä¸€å®šæœºåˆ¶ï¼Œå®ç°æ”¶å‘æ­¥è°ƒåè°ƒã€‚ å¦‚ï¼šå‘é€æ–¹å‘å‡ºæ•°æ®åï¼Œç­‰æ¥æ”¶æ–¹å‘å›å“åº”ä»¥åæ‰å‘ä¸‹ä¸€ä¸ªæ•°æ®åŒ…çš„é€šè®¯æ–¹å¼ å¼‚æ­¥é€šä¿¡æ˜¯æŒ‡ï¼šå‘é€æ–¹çš„å‘é€ä¸ç®¡æ¥æ”¶æ–¹çš„æ¥æ”¶çŠ¶æ€ã€‚ å¦‚ï¼šå‘é€æ–¹å‘å‡ºæ•°æ®åï¼Œä¸ç­‰æ¥æ”¶æ–¹å‘å›å“åº”ï¼Œæ¥ç€å‘é€ä¸‹ä¸ªæ•°æ®åŒ…çš„é€šè®¯æ–¹å¼ã€‚ é˜»å¡å¯ä»¥æ˜¯å®ç°åŒæ­¥çš„ä¸€ç§æ‰‹æ®µï¼ä¾‹å¦‚ä¸¤ä¸ªä¸œè¥¿éœ€è¦åŒæ­¥ï¼Œä¸€æ—¦å‡ºç°ä¸åŒæ­¥æƒ…å†µï¼Œæˆ‘å°±é˜»å¡å¿«çš„ä¸€æ–¹ï¼Œä½¿åŒæ–¹è¾¾åˆ°åŒæ­¥ã€‚ åŒæ­¥æ˜¯ä¸¤ä¸ªå¯¹è±¡ä¹‹é—´çš„å…³ç³»ï¼Œè€Œé˜»å¡æ˜¯ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€ã€‚ å››ç§ç»„åˆæ–¹å¼ åŒæ­¥é˜»å¡æ–¹å¼ï¼š å‘é€æ–¹å‘é€è¯·æ±‚ä¹‹åä¸€ç›´ç­‰å¾…å“åº”ã€‚ æ¥æ”¶æ–¹å¤„ç†è¯·æ±‚æ—¶è¿›è¡Œçš„IOæ“ä½œå¦‚æœä¸èƒ½é©¬ä¸Šç­‰åˆ°è¿”å›ç»“æœï¼Œå°±ä¸€ç›´ç­‰åˆ°è¿”å›ç»“æœåï¼Œæ‰å“åº”å‘é€æ–¹ï¼ŒæœŸé—´ä¸èƒ½è¿›è¡Œå…¶ä»–å·¥ä½œã€‚ åŒæ­¥éé˜»å¡æ–¹å¼ï¼š å‘é€æ–¹å‘é€è¯·æ±‚ä¹‹åï¼Œä¸€ç›´ç­‰å¾…å“åº”ã€‚ æ¥å—æ–¹å¤„ç†è¯·æ±‚æ—¶è¿›è¡Œçš„IOæ“ä½œå¦‚æœä¸èƒ½é©¬ä¸Šçš„å¾—åˆ°ç»“æœï¼Œå°±ç«‹å³è¿”å›ï¼Œå–åšå…¶ä»–äº‹æƒ…ã€‚ ä½†æ˜¯ç”±äºæ²¡æœ‰å¾—åˆ°è¯·æ±‚å¤„ç†ç»“æœï¼Œä¸å“åº”å‘é€æ–¹ï¼Œå‘é€æ–¹ä¸€ç›´ç­‰å¾…ã€‚ å½“IOæ“ä½œå®Œæˆä»¥åï¼Œå°†å®ŒæˆçŠ¶æ€å’Œç»“æœé€šçŸ¥æ¥æ”¶æ–¹ï¼Œæ¥æ”¶æ–¹å†å“åº”å‘é€æ–¹ï¼Œå‘é€æ–¹æ‰è¿›å…¥ä¸‹ä¸€æ¬¡è¯·æ±‚è¿‡ç¨‹ã€‚ï¼ˆå®é™…ä¸åº”ç”¨ï¼‰ å¼‚æ­¥é˜»å¡æ–¹å¼ï¼š å‘é€æ–¹å‘æ¥æ”¶æ–¹è¯·æ±‚åï¼Œä¸ç­‰å¾…å“åº”ï¼Œå¯ä»¥ç»§ç»­å…¶ä»–å·¥ä½œã€‚ æ¥æ”¶æ–¹å¤„ç†è¯·æ±‚æ—¶è¿›è¡ŒIOæ“ä½œå¦‚æœä¸èƒ½é©¬ä¸Šå¾—åˆ°ç»“æœï¼Œå°±ä¸€ç›´ç­‰åˆ°è¿”å›ç»“æœåï¼Œæ‰å“åº”å‘é€æ–¹ï¼ŒæœŸé—´ä¸èƒ½è¿›è¡Œå…¶ä»–æ“ä½œã€‚ ï¼ˆå®é™…ä¸åº”ç”¨ï¼‰ å¼‚æ­¥éé˜»å¡æ–¹å¼ï¼š å‘é€æ–¹å‘æ¥æ”¶æ–¹è¯·æ±‚åï¼Œä¸ç­‰å¾…å“åº”ï¼Œå¯ä»¥ç»§ç»­å…¶ä»–å·¥ä½œã€‚ æ¥æ”¶æ–¹å¤„ç†è¯·æ±‚æ—¶è¿›è¡ŒIOæ“ä½œå¦‚æœä¸èƒ½é©¬ä¸Šå¾—åˆ°ç»“æœï¼Œä¹Ÿä¸ç­‰å¾…ï¼Œè€Œæ˜¯é©¬ä¸Šè¿”å›å»åšå…¶ä»–äº‹æƒ…ã€‚ å½“IOæ“ä½œå®Œæˆä»¥åï¼Œå°†å®ŒæˆçŠ¶æ€å’Œç»“æœé€šçŸ¥æ¥æ”¶æ–¹ï¼Œæ¥æ”¶æ–¹å†å“åº”å‘é€æ–¹ã€‚ï¼ˆæ•ˆç‡æœ€é«˜ï¼‰ ","link":"https://tianxiawuhao.github.io/1SOcADwUR/"},{"title":"NIO-FileChannel","content":"NIOä»‹ç» åœ¨è®²è§£Channelä¹‹å‰ï¼Œé¦–å…ˆäº†è§£ä¸€ä¸‹NIOï¼Œ Java NIOå…¨ç§°java non-blocking IOï¼Œæ˜¯ä»Java 1.4ç‰ˆæœ¬å¼€å§‹å¼•å…¥çš„ä¸€ä¸ªæ–°çš„IO APIï¼ˆNew IOï¼‰ï¼Œå¯ä»¥æ›¿ä»£æ ‡å‡†çš„Java IO APIï¼ŒNIOä¸åŸæ¥çš„IOæœ‰åŒæ ·çš„ä½œç”¨å’Œç›®çš„ï¼Œä½†æ˜¯ä½¿ç”¨çš„æ–¹å¼å®Œå…¨ä¸åŒã€‚IOä¸ NIOåŒºåˆ«ï¼š IO NIO é¢å‘æµï¼ˆStream Orientendï¼‰ é¢å‘ç¼“å†²åŒºï¼ˆBuffer Orientendï¼‰ é˜»å¡IOï¼ˆBlocking IO ) éé˜»å¡IOï¼ˆNon Blocking IOï¼‰ é€‰æ‹©å™¨ï¼ˆSelectorï¼‰ NIOæ”¯æŒé¢å‘ç¼“å†²åŒºçš„ã€åŸºäºé€šé“çš„IOæ“ä½œå¹¶ä»¥æ›´åŠ é«˜æ•ˆçš„æ–¹å¼è¿›è¡Œæ–‡ä»¶çš„è¯»å†™æ“ä½œï¼Œå…¶æ ¸å¿ƒAPIä¸ºChannel(é€šé“)ï¼ŒBuffer(ç¼“å†²åŒº), Selector(é€‰æ‹©å™¨)ã€‚Channelè´Ÿè´£ä¼ è¾“ï¼ŒBufferè´Ÿè´£å­˜å‚¨ ã€‚ ç¼“å†²åŒº public class BioTest { @Test public void test1() { //1.åˆå§‹åŒ–ç¼“å†²åŒºæ•°ç»„ ByteBuffer bf = ByteBuffer.allocate(1024); System.out.println(&quot;==========allocate============&quot;); System.out.println(bf.position()); System.out.println(bf.limit()); System.out.println(bf.capacity()); //2.putæ’å…¥æ•°æ® bf.put(&quot;asasas&quot;.getBytes()); System.out.println(&quot;==========put============&quot;); System.out.println(bf.position()); System.out.println(bf.limit()); System.out.println(bf.capacity()); //3.æ”¹ä¸ºè¯»çŠ¶æ€ bf.flip(); System.out.println(&quot;==========flip============&quot;); System.out.println(bf.position()); System.out.println(bf.limit()); System.out.println(bf.capacity()); //4.è·å–ç¼“å†²åŒºæ•°æ® final byte[] bytes = new byte[bf.limit()]; bf.get(bytes); System.out.println(&quot;==========get============&quot;); System.out.println(new String(bytes,0,bytes.length)); System.out.println(bf.position()); System.out.println(bf.limit()); System.out.println(bf.capacity()); //5.é‡ç½®è¯»çŠ¶æ€ bf.rewind(); System.out.println(&quot;==========rewind============&quot;); System.out.println(bf.position()); System.out.println(bf.limit()); System.out.println(bf.capacity()); //6.æ¸…é™¤æ•°æ®æ ‡è¯† bf.clear(); System.out.println(&quot;==========clear============&quot;); System.out.println(bf.position()); System.out.println(bf.limit()); System.out.println(bf.capacity()); } } ç›´æ¥ç¼“å†²åŒºä¸éç›´æ¥ç¼“å†²åŒºï¼š éç›´æ¥ç¼“å†²åŒºï¼šé€šè¿‡ allocate() æ–¹æ³•åˆ†é…ç¼“å†²åŒºï¼Œå°†ç¼“å†²åŒºå»ºç«‹åœ¨ JVM çš„å†…å­˜ä¸­ ç›´æ¥ç¼“å†²åŒºï¼šé€šè¿‡ allocateDirect() æ–¹æ³•åˆ†é…ç›´æ¥ç¼“å†²åŒºï¼Œå°†ç¼“å†²åŒºå»ºç«‹åœ¨ç‰©ç†å†…å­˜ä¸­ã€‚å¯ä»¥æé«˜æ•ˆç‡ å­—èŠ‚ç¼“å†²åŒºè¦ä¹ˆæ˜¯ç›´æ¥çš„ï¼Œè¦ä¹ˆæ˜¯éç›´æ¥çš„ã€‚å¦‚æœä¸ºç›´æ¥å­—èŠ‚ç¼“å†²åŒºï¼Œåˆ™ Java è™šæ‹Ÿæœºä¼šå°½æœ€å¤§åŠªåŠ›ç›´æ¥åœ¨æœº æ­¤ç¼“å†²åŒºä¸Šæ‰§è¡Œæœ¬æœº I/O æ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ¯æ¬¡è°ƒç”¨åŸºç¡€æ“ä½œç³»ç»Ÿçš„ä¸€ä¸ªæœ¬æœº I/O æ“ä½œä¹‹å‰ï¼ˆæˆ–ä¹‹åï¼‰ï¼Œ è™šæ‹Ÿæœºéƒ½ä¼šå°½é‡é¿å…å°†ç¼“å†²åŒºçš„å†…å®¹å¤åˆ¶åˆ°ä¸­é—´ç¼“å†²åŒºä¸­ï¼ˆæˆ–ä»ä¸­é—´ç¼“å†²åŒºä¸­å¤åˆ¶å†…å®¹ï¼‰ã€‚ ç›´æ¥å­—èŠ‚ç¼“å†²åŒºå¯ä»¥é€šè¿‡è°ƒç”¨æ­¤ç±»çš„ allocateDirect() å·¥å‚æ–¹æ³• æ¥åˆ›å»ºã€‚æ­¤æ–¹æ³•è¿”å›çš„ ç¼“å†²åŒºè¿›è¡Œåˆ†é…å’Œå–æ¶ˆåˆ†é…æ‰€éœ€æˆæœ¬é€šå¸¸é«˜äºéç›´æ¥ç¼“å†²åŒº ã€‚ç›´æ¥ç¼“å†²åŒºçš„å†…å®¹å¯ä»¥é©»ç•™åœ¨å¸¸è§„çš„åƒåœ¾å›æ”¶å †ä¹‹å¤–ï¼Œå› æ­¤ï¼Œå®ƒä»¬å¯¹åº”ç”¨ç¨‹åºçš„å†…å­˜éœ€æ±‚é‡é€ æˆçš„å½±å“å¯èƒ½å¹¶ä¸æ˜æ˜¾ã€‚æ‰€ä»¥ï¼Œå»ºè®®å°†ç›´æ¥ç¼“å†²åŒºä¸»è¦åˆ†é…ç»™é‚£äº›æ˜“å—åŸºç¡€ç³»ç»Ÿçš„æœ¬æœº I/O æ“ä½œå½±å“çš„å¤§å‹ã€æŒä¹…çš„ç¼“å†²åŒºã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæœ€å¥½ä»…åœ¨ç›´æ¥ç¼“å†²åŒºèƒ½åœ¨ç¨‹åºæ€§èƒ½æ–¹é¢å¸¦æ¥æ˜æ˜¾å¥½å¤„æ—¶åˆ†é…å®ƒä»¬ã€‚ ç›´æ¥å­—èŠ‚ç¼“å†²åŒºè¿˜å¯ä»¥è¿‡ é€šè¿‡FileChannel çš„ map() æ–¹æ³• å°†æ–‡ä»¶åŒºåŸŸç›´æ¥æ˜ å°„åˆ°å†…å­˜ä¸­æ¥åˆ›å»º ã€‚è¯¥æ–¹æ³•è¿”å›MappedByteBuffer ã€‚Java å¹³å°çš„å®ç°æœ‰åŠ©äºé€šè¿‡ JNI ä»æœ¬æœºä»£ç åˆ›å»ºç›´æ¥å­—èŠ‚ç¼“å†²åŒºã€‚å¦‚æœä»¥ä¸Šè¿™äº›ç¼“å†²åŒºä¸­çš„æŸä¸ªç¼“å†²åŒºå®ä¾‹æŒ‡çš„æ˜¯ä¸å¯è®¿é—®çš„å†…å­˜åŒºåŸŸï¼Œåˆ™è¯•å›¾è®¿é—®è¯¥åŒºåŸŸä¸ä¼šæ›´æ”¹è¯¥ç¼“å†²åŒºçš„å†…å®¹ï¼Œå¹¶ä¸”å°†ä¼šåœ¨è®¿é—®æœŸé—´æˆ–ç¨åçš„æŸä¸ªæ—¶é—´å¯¼è‡´æŠ›å‡ºä¸ç¡®å®šçš„å¼‚å¸¸ã€‚ å­—èŠ‚ç¼“å†²åŒºæ˜¯ç›´æ¥ç¼“å†²åŒºè¿˜æ˜¯éç›´æ¥ç¼“å†²åŒºå¯é€šè¿‡è°ƒç”¨å…¶ isDirect() æ–¹æ³•æ¥ç¡®å®šã€‚æä¾›æ­¤æ–¹æ³•æ˜¯ä¸ºäº†èƒ½å¤Ÿåœ¨æ€§èƒ½å…³é”®å‹ä»£ç ä¸­æ‰§è¡Œæ˜¾å¼ç¼“å†²åŒºç®¡ç†ã€‚ éç›´æ¥ç¼“å†²åŒºï¼š ç›´æ¥ç¼“å†²åŒºï¼š é€šé“ï¼ˆChannel ï¼‰ é€šé“è¡¨ç¤ºæ‰“å¼€åˆ° IO è®¾å¤‡(ä¾‹å¦‚ï¼šæ–‡ä»¶ã€å¥—æ¥å­—)çš„è¿æ¥ã€‚è‹¥éœ€è¦ä½¿ç”¨ NIO ç³»ç»Ÿï¼Œéœ€è¦è·å–ç”¨äºè¿æ¥ IO è®¾å¤‡çš„é€šé“ä»¥åŠç”¨äºå®¹çº³æ•°æ®çš„ç¼“å†²åŒºã€‚ç„¶åæ“ä½œç¼“å†²åŒºï¼Œå¯¹æ•°æ®è¿›è¡Œå¤„ç†ã€‚ Channelç›¸æ¯”IOä¸­çš„Streamæ›´åŠ é«˜æ•ˆï¼Œå¯ä»¥å¼‚æ­¥åŒå‘ä¼ è¾“ï¼Œä½†æ˜¯å¿…é¡»å’Œbufferä¸€èµ·ä½¿ç”¨ã€‚ ä¸»è¦å®ç°ç±» FileChannelï¼Œè¯»å†™æ–‡ä»¶ä¸­çš„æ•°æ®ã€‚ SocketChannelï¼Œé€šè¿‡TCPè¯»å†™ç½‘ç»œä¸­çš„æ•°æ®ã€‚ ServerSockectChannelï¼Œç›‘å¬æ–°è¿›æ¥çš„TCPè¿æ¥ï¼ŒåƒWebæœåŠ¡å™¨é‚£æ ·ã€‚å¯¹æ¯ä¸€ä¸ªæ–°è¿›æ¥çš„è¿æ¥éƒ½ä¼šåˆ›å»ºä¸€ä¸ªSocketChannelã€‚ DatagramChannelï¼Œé€šè¿‡UDPè¯»å†™ç½‘ç»œä¸­çš„æ•°æ®ã€‚ Channelèšé›†(gather)å†™å…¥ èšé›†å†™å…¥ï¼ˆ Gathering Writesï¼‰æ˜¯æŒ‡å°†å¤šä¸ª Buffer ä¸­çš„æ•°æ®â€œèšé›†â€åˆ° Channelã€‚ ç‰¹åˆ«æ³¨æ„ï¼šæŒ‰ç…§ç¼“å†²åŒºçš„é¡ºåºï¼Œå†™å…¥ position å’Œ limit ä¹‹é—´çš„æ•°æ®åˆ° Channel ã€‚ Channelåˆ†æ•£(scatter)è¯»å– åˆ†æ•£è¯»å–ï¼ˆ Scattering Readsï¼‰æ˜¯æŒ‡ä» Channel ä¸­è¯»å–çš„æ•°æ®â€œåˆ†æ•£â€ åˆ°å¤šä¸ª Buffer ä¸­ã€‚ ç‰¹åˆ«æ³¨æ„ï¼šæŒ‰ç…§ç¼“å†²åŒºçš„é¡ºåºï¼Œä» Channel ä¸­è¯»å–çš„æ•°æ®ä¾æ¬¡å°† Buffer å¡«æ»¡ã€‚ â€œé›¶æ‹·è´â€ï¼ˆFileChannelçš„transferToå’ŒtransferFromï¼‰ Java NIOä¸­æä¾›çš„FileChannelæ‹¥æœ‰transferToå’ŒtransferFromä¸¤ä¸ªæ–¹æ³•ï¼Œå¯ç›´æ¥æŠŠFileChannelä¸­çš„æ•°æ®æ‹·è´åˆ°å¦å¤–ä¸€ä¸ªChannelï¼Œæˆ–è€…ç›´æ¥æŠŠå¦å¤–ä¸€ä¸ªChannelä¸­çš„æ•°æ®æ‹·è´åˆ°FileChannelã€‚è¯¥æ¥å£å¸¸è¢«ç”¨äºé«˜æ•ˆçš„ç½‘ç»œ/æ–‡ä»¶çš„æ•°æ®ä¼ è¾“å’Œå¤§æ–‡ä»¶æ‹·è´ã€‚åœ¨æ“ä½œç³»ç»Ÿæ”¯æŒçš„æƒ…å†µä¸‹ï¼Œé€šè¿‡è¯¥æ–¹æ³•ä¼ è¾“æ•°æ®å¹¶ä¸éœ€è¦å°†æºæ•°æ®ä»å†…æ ¸æ€æ‹·è´åˆ°ç”¨æˆ·æ€ï¼Œå†ä»ç”¨æˆ·æ€æ‹·è´åˆ°ç›®æ ‡é€šé“çš„å†…æ ¸æ€ï¼ŒåŒæ—¶ä¹Ÿé¿å…äº†ä¸¤æ¬¡ç”¨æˆ·æ€å’Œå†…æ ¸æ€é—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä¹Ÿå³ä½¿ç”¨äº†â€œé›¶æ‹·è´â€ï¼Œæ‰€ä»¥å…¶æ€§èƒ½ä¸€èˆ¬é«˜äºJava IOä¸­æä¾›çš„æ–¹æ³•ã€‚ ä»£ç æ¡ˆä¾‹ /** * @author wuhao * @desc æœ¬åœ°io: * FileInputStreanm/FileOutputStream * RandomAccessFile * ç½‘ç»œio: * Socket * ServerSocket * DatagramSocket * @date 2021-09-17 15:22:26 */ public class ChannelTest { //åˆ©ç”¨é€šé“å®Œæˆæ–‡ä»¶çš„å¤åˆ¶,éç›´æ¥ç¼“å†²åŒº @Test @SneakyThrows public void test(){ FileInputStream fis = new FileInputStream(&quot;D:\\\\1.jpg&quot;); FileOutputStream fos = new FileOutputStream(&quot;D:\\\\2.jpg&quot;); //è·å–é€šé“ FileChannel inChannel = fis.getChannel(); FileChannel outChannel = fos.getChannel(); //åˆ†é…æŒ‡å®šå¤§å°ç¼“å­˜åŒº ByteBuffer buff = ByteBuffer.allocate(1024);// position 0 ,limit 1024 //å°†é€šé“çš„æ•°æ®å­˜å…¥ç¼“å­˜åŒº while(inChannel.read(buff)!=-1){// position 1024 ,limit 1024 ,ç›¸å½“äºput //åˆ‡æ¢è¯»æ¨¡å¼ buff.flip();//position 0 ,limit 1024 //å°†ç¼“å­˜å»çš„æ•°æ®å†™å…¥é€šé“ outChannel.write(buff);//position 1024 ,limit 1024,ç›¸å½“äºget //æ¸…ç©ºç¼“å†²åŒº buff.clear();//position 0 ,limit 1024 } outChannel.close(); inChannel.close(); fis.close(); fos.close(); } //åˆ©ç”¨é€šé“å®Œæˆæ–‡ä»¶çš„å¤åˆ¶,ç›´æ¥ç¼“å†²åŒº,åˆ©ç”¨ç‰©ç†å†…å­˜æ˜ å°„æ–‡ä»¶ //ä¼šå‡ºç°æ–‡ä»¶å¤åˆ¶å®Œäº†ï¼Œä½†ç¨‹åºè¿˜æ²¡ç»“æŸï¼ŒåŸå› æ˜¯JVMèµ„æºè¿˜åœ¨ç”¨ï¼Œå½“åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶ä¹‹åç¨‹åºå°±ä¼šç»“æŸ,ä¸ç¨³å®š @Test @SneakyThrows public void test1(){ FileChannel inChannel = FileChannel.open(Paths.get(&quot;D:\\\\1.jpg&quot;), StandardOpenOption.READ); FileChannel outChannel = FileChannel.open(Paths.get(&quot;D:\\\\4.jpg&quot;), StandardOpenOption.READ,StandardOpenOption.WRITE,StandardOpenOption.CREATE); //å†…å­˜æ˜ å°„æ–‡ä»¶ MappedByteBuffer inMapBuff = inChannel.map(FileChannel.MapMode.READ_ONLY, 0, inChannel.size());//==allocateDirect MappedByteBuffer outMapBuff = outChannel.map(FileChannel.MapMode.READ_WRITE, 0, inChannel.size()); byte[] by = new byte[inMapBuff.limit()]; inMapBuff.get(by); outMapBuff.put(by); outChannel.close(); inChannel.close(); } /** * ä»æºä¿¡é“è¯»å–å­—èŠ‚åˆ°è¿™ä¸ªé€šé“çš„æ–‡ä»¶ä¸­ã€‚å¦‚æœæºé€šé“çš„å‰©ä½™ç©ºé—´å°äº count ä¸ªå­—èŠ‚ï¼Œåˆ™æ‰€ä¼ è¾“çš„å­—èŠ‚æ•°è¦å°äºè¯·æ±‚çš„å­—èŠ‚æ•°ã€‚è¿™ç§æ–¹æ³•å¯èƒ½æ¯”ä»æºé€šé“è¯»å–å¹¶å†™å…¥æ­¤é€šé“çš„ç®€å•å¾ªç¯æ›´æœ‰æ•ˆç‡ã€‚ * @param SRC æºé€šé“ * @param position è°ƒåŠ¨å¼€å§‹çš„æ–‡ä»¶å†…çš„ä½ç½®ï¼Œå¿…é¡»æ˜¯éè´Ÿçš„ * @param count è¦ä¼ è¾“çš„æœ€å¤§å­—èŠ‚æ•°ï¼Œå¿…é¡»æ˜¯éè´Ÿ * @return ä¼ è¾“æ–‡ä»¶çš„å¤§å°ï¼ˆå•ä½å­—èŠ‚ï¼‰ï¼Œå¯èƒ½ä¸ºé›¶ï¼Œ * public abstract long transferFrom(ReadableByteChannel src, long position, long count) throws IOException; */ //å¤åˆ¶å›¾ç‰‡ï¼Œåˆ©ç”¨ç›´æ¥ç¼“å­˜åŒº @Test @SneakyThrows public void test2(){ FileChannel inChannel = FileChannel.open(Paths.get(&quot;D:\\\\1.jpg&quot;), StandardOpenOption.READ); FileChannel outChannel = FileChannel.open(Paths.get(&quot;D:\\\\2.jpg&quot;), StandardOpenOption.READ, StandardOpenOption.WRITE, StandardOpenOption.CREATE); outChannel.transferFrom(inChannel, 0, inChannel.size()); inChannel.close(); outChannel.close(); } /** * å°†å­—èŠ‚ä»è¿™ä¸ªé€šé“çš„æ–‡ä»¶ä¼ è¾“åˆ°ç»™å®šçš„å¯å†™å­—èŠ‚é€šé“ã€‚ * @param position è°ƒåŠ¨å¼€å§‹çš„æ–‡ä»¶å†…çš„ä½ç½®ï¼Œå¿…é¡»æ˜¯éè´Ÿçš„ * @param count è¦ä¼ è¾“çš„æœ€å¤§å­—èŠ‚æ•°ï¼Œå¿…é¡»æ˜¯éè´Ÿ * @param target ç›®æ ‡é€šé“ * @return ä¼ è¾“æ–‡ä»¶çš„å¤§å°ï¼ˆå•ä½å­—èŠ‚ï¼‰ï¼Œå¯èƒ½ä¸ºé›¶ï¼Œ * public abstract long transferTo(long position, long count, WritableByteChannel target) throws IOException; */ //å¤åˆ¶å›¾ç‰‡ï¼Œåˆ©ç”¨ç›´æ¥ç¼“å­˜åŒº @Test @SneakyThrows public void test3(){ FileChannel inChannel = FileChannel.open(Paths.get(&quot;D:\\\\1.jpg&quot;), StandardOpenOption.READ); FileChannel outChannel = FileChannel.open(Paths.get(&quot;D:\\\\3.jpg&quot;), StandardOpenOption.READ, StandardOpenOption.WRITE, StandardOpenOption.CREATE); inChannel.transferTo(0, inChannel.size(), outChannel); inChannel.close(); outChannel.close(); } // åˆ†æ•£è¯»å–èšé›†å†™å…¥å®ç°æ–‡ä»¶å¤åˆ¶ @Test @SneakyThrows public void test4(){ RandomAccessFile randomAccessFile = null; RandomAccessFile randomAccessFile1 = null; FileChannel inChannel = null; FileChannel outChannel = null; try { randomAccessFile = new RandomAccessFile(new File(&quot;d:\\\\old.txt&quot;), &quot;rw&quot;); randomAccessFile1 = new RandomAccessFile(new File(&quot;d:\\\\new.txt&quot;), &quot;rw&quot;); inChannel = randomAccessFile.getChannel(); outChannel = randomAccessFile1.getChannel(); // åˆ†æ•£ä¸ºä¸‰ä¸ªbytebufferè¯»å–,capcityè¦è®¾ç½®çš„è¶³å¤Ÿå¤§ï¼Œä¸ç„¶å¦‚æœæ–‡ä»¶å¤ªå¤§ï¼Œä¼šå¯¼è‡´å¤åˆ¶çš„å†…å®¹ä¸å®Œæ•´ ByteBuffer byteBuffer1 = ByteBuffer.allocate(1024); ByteBuffer byteBuffer2 = ByteBuffer.allocate(1024); ByteBuffer byteBuffer3 = ByteBuffer.allocate(10240); ByteBuffer[] bbs = new ByteBuffer[]{byteBuffer1,byteBuffer2,byteBuffer3}; inChannel.read(bbs);// åˆ†æ•£è¯»å– // åˆ‡æ¢ä¸ºå†™å…¥æ¨¡å¼ for (int i = 0; i &lt; bbs.length; i++) { bbs[i].flip(); } outChannel.write(bbs); } catch (Exception ex) { ex.printStackTrace(); } } } ","link":"https://tianxiawuhao.github.io/7Wmx9Q2PP/"},{"title":"æœåŠ¡å™¨å˜æ…¢è¯Šæ–­å‘½ä»¤","content":"topå‘½ä»¤è¯¦è§£ ç¬¬ä¸€è¡Œï¼Œä»»åŠ¡é˜Ÿåˆ—ä¿¡æ¯ï¼ŒåŒ uptime å‘½ä»¤çš„æ‰§è¡Œç»“æœ ç³»ç»Ÿæ—¶é—´ï¼š07:27:05 è¿è¡Œæ—¶é—´ï¼šup 1:57 min, å½“å‰ç™»å½•ç”¨æˆ·ï¼š 3 user è´Ÿè½½å‡è¡¡(uptime) load average: 0.00, 0.00, 0.00 averageåé¢çš„ä¸‰ä¸ªæ•°åˆ†åˆ«æ˜¯1åˆ†é’Ÿã€5åˆ†é’Ÿã€15åˆ†é’Ÿçš„è´Ÿè½½æƒ…å†µã€‚ load averageæ•°æ®æ˜¯æ¯éš”5ç§’é’Ÿæ£€æŸ¥ä¸€æ¬¡æ´»è·ƒçš„è¿›ç¨‹æ•°ï¼Œç„¶åæŒ‰ç‰¹å®šç®—æ³•è®¡ç®—å‡ºçš„æ•°å€¼ã€‚å¦‚æœè¿™ä¸ªæ•°é™¤ä»¥é€»è¾‘CPUçš„æ•°é‡ï¼Œç»“æœé«˜äº5çš„æ—¶å€™å°±è¡¨æ˜ç³»ç»Ÿåœ¨è¶…è´Ÿè·è¿è½¬äº† ç¬¬äºŒè¡Œï¼ŒTasks â€” ä»»åŠ¡ï¼ˆè¿›ç¨‹ï¼‰ æ€»è¿›ç¨‹:150 total, è¿è¡Œ:1 running, ä¼‘çœ :149 sleeping, åœæ­¢: 0 stopped, åƒµå°¸è¿›ç¨‹: 0 zombie ç¬¬ä¸‰è¡Œï¼ŒcpuçŠ¶æ€ä¿¡æ¯ 0.0%usã€user spaceã€‘â€” ç”¨æˆ·ç©ºé—´å ç”¨CPUçš„ç™¾åˆ†æ¯”ã€‚ 0.3%syã€sysctlã€‘â€” å†…æ ¸ç©ºé—´å ç”¨CPUçš„ç™¾åˆ†æ¯”ã€‚ 0.0%niã€ã€‘â€” æ”¹å˜è¿‡ä¼˜å…ˆçº§çš„è¿›ç¨‹å ç”¨CPUçš„ç™¾åˆ†æ¯” 99.7%idã€idoltã€‘â€” ç©ºé—²CPUç™¾åˆ†æ¯” 0.0%waã€waitã€‘â€” IOç­‰å¾…å ç”¨CPUçš„ç™¾åˆ†æ¯” 0.0%hiã€Hardware IRQã€‘â€” ç¡¬ä¸­æ–­å ç”¨CPUçš„ç™¾åˆ†æ¯” 0.0%siã€Software Interruptsã€‘â€” è½¯ä¸­æ–­å ç”¨CPUçš„ç™¾åˆ†æ¯” ç¬¬å››è¡Œ,å†…å­˜çŠ¶æ€ 1003020k total, 234464k used, 777824k free, 24084k buffersã€ç¼“å­˜çš„å†…å­˜é‡ã€‘ ç¬¬äº”è¡Œï¼Œswapäº¤æ¢åˆ†åŒºä¿¡æ¯ 2031612k total, 536k used, 2031076k free, 505864k cachedã€ç¼“å†²çš„äº¤æ¢åŒºæ€»é‡ã€‘ å¤‡æ³¨ï¼š å¯ç”¨å†…å­˜=free + buffer + cached å¯¹äºå†…å­˜ç›‘æ§ï¼Œåœ¨topé‡Œæˆ‘ä»¬è¦æ—¶åˆ»ç›‘æ§ç¬¬äº”è¡Œswapäº¤æ¢åˆ†åŒºçš„usedï¼Œå¦‚æœè¿™ä¸ªæ•°å€¼åœ¨ä¸æ–­çš„å˜åŒ–ï¼Œè¯´æ˜å†…æ ¸åœ¨ä¸æ–­è¿›è¡Œå†…å­˜å’Œswapçš„æ•°æ®äº¤æ¢ï¼Œè¿™æ˜¯çœŸæ­£çš„å†…å­˜ä¸å¤Ÿç”¨äº†ã€‚ ç¬¬å››è¡Œä¸­ä½¿ç”¨ä¸­çš„å†…å­˜æ€»é‡ï¼ˆusedï¼‰æŒ‡çš„æ˜¯ç°åœ¨ç³»ç»Ÿå†…æ ¸æ§åˆ¶çš„å†…å­˜æ•°ï¼Œ ç¬¬å››è¡Œä¸­ç©ºé—²å†…å­˜æ€»é‡ï¼ˆfreeï¼‰æ˜¯å†…æ ¸è¿˜æœªçº³å…¥å…¶ç®¡æ§èŒƒå›´çš„æ•°é‡ã€‚ çº³å…¥å†…æ ¸ç®¡ç†çš„å†…å­˜ä¸è§å¾—éƒ½åœ¨ä½¿ç”¨ä¸­ï¼Œè¿˜åŒ…æ‹¬è¿‡å»ä½¿ç”¨è¿‡çš„ç°åœ¨å¯ä»¥è¢«é‡å¤åˆ©ç”¨çš„å†…å­˜ï¼Œå†…æ ¸å¹¶ä¸æŠŠè¿™äº›å¯è¢«é‡æ–°ä½¿ç”¨çš„å†…å­˜äº¤è¿˜åˆ°freeä¸­å»ï¼Œå› æ­¤åœ¨linuxä¸Šfreeå†…å­˜ä¼šè¶Šæ¥è¶Šå°‘ï¼Œä½†ä¸ç”¨ä¸ºæ­¤æ‹…å¿ƒã€‚ ç¬¬å…­è¡Œï¼Œç©ºè¡Œ ç¬¬ä¸ƒè¡Œä»¥ä¸‹ï¼šå„è¿›ç¨‹ï¼ˆä»»åŠ¡ï¼‰çš„çŠ¶æ€ç›‘æ§ PID â€” è¿›ç¨‹id USER â€” è¿›ç¨‹æ‰€æœ‰è€… PR â€” è¿›ç¨‹ä¼˜å…ˆçº§ NI â€” niceå€¼ã€‚è´Ÿå€¼è¡¨ç¤ºé«˜ä¼˜å…ˆçº§ï¼Œæ­£å€¼è¡¨ç¤ºä½ä¼˜å…ˆçº§ VIRT â€” è¿›ç¨‹ä½¿ç”¨çš„è™šæ‹Ÿå†…å­˜æ€»é‡ï¼Œå•ä½kbã€‚VIRT=SWAP+RES RES â€” è¿›ç¨‹ä½¿ç”¨çš„ã€æœªè¢«æ¢å‡ºçš„ç‰©ç†å†…å­˜å¤§å°ï¼Œå•ä½kbã€‚RES=CODE+DATA SHR â€” å…±äº«å†…å­˜å¤§å°ï¼Œå•ä½kb S â€”è¿›ç¨‹çŠ¶æ€ã€‚D=ä¸å¯ä¸­æ–­çš„ç¡çœ çŠ¶æ€ R=è¿è¡Œ S=ç¡çœ  T=è·Ÿè¸ª/åœæ­¢ Z=åƒµå°¸è¿›ç¨‹ %CPU â€” ä¸Šæ¬¡æ›´æ–°åˆ°ç°åœ¨çš„CPUæ—¶é—´å ç”¨ç™¾åˆ†æ¯” %MEM â€” è¿›ç¨‹ä½¿ç”¨çš„ç‰©ç†å†…å­˜ç™¾åˆ†æ¯” TIME+ â€” è¿›ç¨‹ä½¿ç”¨çš„CPUæ—¶é—´æ€»è®¡ï¼Œå•ä½1/100ç§’ COMMAND â€” è¿›ç¨‹åç§°ï¼ˆå‘½ä»¤å/å‘½ä»¤è¡Œï¼‰ è¯¦è§£ **VIRTï¼švirtual memory usage è™šæ‹Ÿå†…å­˜ **1ã€è¿›ç¨‹â€œéœ€è¦çš„â€è™šæ‹Ÿå†…å­˜å¤§å°ï¼ŒåŒ…æ‹¬è¿›ç¨‹ä½¿ç”¨çš„åº“ã€ä»£ç ã€æ•°æ®ç­‰ 2ã€å‡å¦‚è¿›ç¨‹ç”³è¯·100mçš„å†…å­˜ï¼Œä½†å®é™…åªä½¿ç”¨äº†10mï¼Œé‚£ä¹ˆå®ƒä¼šå¢é•¿100mï¼Œè€Œä¸æ˜¯å®é™…çš„ä½¿ç”¨é‡ RESï¼šresident memory usage å¸¸é©»å†…å­˜ 1ã€è¿›ç¨‹å½“å‰ä½¿ç”¨çš„å†…å­˜å¤§å°ï¼Œä½†ä¸åŒ…æ‹¬swap out 2ã€åŒ…å«å…¶ä»–è¿›ç¨‹çš„å…±äº« 3ã€å¦‚æœç”³è¯·100mçš„å†…å­˜ï¼Œå®é™…ä½¿ç”¨10mï¼Œå®ƒåªå¢é•¿10mï¼Œä¸VIRTç›¸å 4ã€å…³äºåº“å ç”¨å†…å­˜çš„æƒ…å†µï¼Œå®ƒåªç»Ÿè®¡åŠ è½½çš„åº“æ–‡ä»¶æ‰€å å†…å­˜å¤§å° SHRï¼šshared memory å…±äº«å†…å­˜ 1ã€é™¤äº†è‡ªèº«è¿›ç¨‹çš„å…±äº«å†…å­˜ï¼Œä¹ŸåŒ…æ‹¬å…¶ä»–è¿›ç¨‹çš„å…±äº«å†…å­˜ 2ã€è™½ç„¶è¿›ç¨‹åªä½¿ç”¨äº†å‡ ä¸ªå…±äº«åº“çš„å‡½æ•°ï¼Œä½†å®ƒåŒ…å«äº†æ•´ä¸ªå…±äº«åº“çš„å¤§å° 3ã€è®¡ç®—æŸä¸ªè¿›ç¨‹æ‰€å çš„ç‰©ç†å†…å­˜å¤§å°å…¬å¼ï¼šRES â€“ SHR 4ã€swap outåï¼Œå®ƒå°†ä¼šé™ä¸‹æ¥ DATA 1ã€æ•°æ®å ç”¨çš„å†…å­˜ã€‚å¦‚æœtopæ²¡æœ‰æ˜¾ç¤ºï¼ŒæŒ‰fé”®å¯ä»¥æ˜¾ç¤ºå‡ºæ¥ã€‚ 2ã€çœŸæ­£çš„è¯¥ç¨‹åºè¦æ±‚çš„æ•°æ®ç©ºé—´ï¼Œæ˜¯çœŸæ­£åœ¨è¿è¡Œä¸­è¦ä½¿ç”¨çš„ã€‚ top è¿è¡Œä¸­å¯ä»¥é€šè¿‡ top çš„å†…éƒ¨å‘½ä»¤å¯¹è¿›ç¨‹çš„æ˜¾ç¤ºæ–¹å¼è¿›è¡Œæ§åˆ¶ã€‚å†…éƒ¨å‘½ä»¤å¦‚ä¸‹ï¼š s â€“ æ”¹å˜ç”»é¢æ›´æ–°é¢‘ç‡ l â€“ å…³é—­æˆ–å¼€å¯ç¬¬ä¸€éƒ¨åˆ†ç¬¬ä¸€è¡Œ top ä¿¡æ¯çš„è¡¨ç¤º t â€“ å…³é—­æˆ–å¼€å¯ç¬¬ä¸€éƒ¨åˆ†ç¬¬äºŒè¡Œ Tasks å’Œç¬¬ä¸‰è¡Œ Cpus ä¿¡æ¯çš„è¡¨ç¤º m â€“ å…³é—­æˆ–å¼€å¯ç¬¬ä¸€éƒ¨åˆ†ç¬¬å››è¡Œ Mem å’Œ ç¬¬äº”è¡Œ Swap ä¿¡æ¯çš„è¡¨ç¤º N â€“ ä»¥ PID çš„å¤§å°çš„é¡ºåºæ’åˆ—è¡¨ç¤ºè¿›ç¨‹åˆ—è¡¨ P â€“ ä»¥ CPU å ç”¨ç‡å¤§å°çš„é¡ºåºæ’åˆ—è¿›ç¨‹åˆ—è¡¨ M â€“ ä»¥å†…å­˜å ç”¨ç‡å¤§å°çš„é¡ºåºæ’åˆ—è¿›ç¨‹åˆ—è¡¨ h â€“ æ˜¾ç¤ºå¸®åŠ© n â€“ è®¾ç½®åœ¨è¿›ç¨‹åˆ—è¡¨æ‰€æ˜¾ç¤ºè¿›ç¨‹çš„æ•°é‡ q â€“ é€€å‡º top s â€“ æ”¹å˜ç”»é¢æ›´æ–°å‘¨æœŸ vmstatå‘½ä»¤è¯¦è§£ vmstatå‘½ä»¤æ˜¯æœ€å¸¸è§çš„Linux/Unixç›‘æ§å·¥å…·ï¼Œå¯ä»¥å±•ç°ç»™å®šæ—¶é—´é—´éš”çš„æœåŠ¡å™¨çš„çŠ¶æ€å€¼,åŒ…æ‹¬æœåŠ¡å™¨çš„CPUä½¿ç”¨ç‡ï¼Œå†…å­˜ä½¿ç”¨ï¼Œè™šæ‹Ÿå†…å­˜äº¤æ¢æƒ…å†µ,IOè¯»å†™æƒ…å†µã€‚è¿™ä¸ªå‘½ä»¤æ˜¯æˆ‘æŸ¥çœ‹Linux/Unixæœ€å–œçˆ±çš„å‘½ä»¤ï¼Œä¸€ä¸ªæ˜¯Linux/Unixéƒ½æ”¯æŒï¼ŒäºŒæ˜¯ç›¸æ¯”topï¼Œæˆ‘å¯ä»¥çœ‹åˆ°æ•´ä¸ªæœºå™¨çš„CPU,å†…å­˜,IOçš„ä½¿ç”¨æƒ…å†µï¼Œè€Œä¸æ˜¯å•å•çœ‹åˆ°å„ä¸ªè¿›ç¨‹çš„CPUä½¿ç”¨ç‡å’Œå†…å­˜ä½¿ç”¨ç‡(ä½¿ç”¨åœºæ™¯ä¸ä¸€æ ·)ã€‚ ä¸€èˆ¬vmstatå·¥å…·çš„ä½¿ç”¨æ˜¯é€šè¿‡ä¸¤ä¸ªæ•°å­—å‚æ•°æ¥å®Œæˆçš„ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯é‡‡æ ·çš„æ—¶é—´é—´éš”æ•°ï¼Œå•ä½æ˜¯ç§’ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯é‡‡æ ·çš„æ¬¡æ•°ï¼Œå¦‚: root@ubuntu:~# vmstat 2 1 procs -----------memory---------- ---swap-- -----io---- -system-- ----cpu---- r b swpd free buff cache si so bi bo in cs us sy id wa 1 0 0 3498472 315836 3819540 0 0 0 1 2 0 0 0 100 0 2è¡¨ç¤ºæ¯ä¸ªä¸¤ç§’é‡‡é›†ä¸€æ¬¡æœåŠ¡å™¨çŠ¶æ€ï¼Œ1è¡¨ç¤ºåªé‡‡é›†ä¸€æ¬¡ã€‚ å®é™…ä¸Šï¼Œåœ¨åº”ç”¨è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸€æ®µæ—¶é—´å†…ä¸€ç›´ç›‘æ§ï¼Œä¸æƒ³ç›‘æ§ç›´æ¥ç»“æŸvmstatå°±è¡Œäº†,ä¾‹å¦‚: root@ubuntu:~# vmstat 2 procs -----------memory---------- ---swap-- -----io---- -system-- ----cpu---- r b swpd free buff cache si so bi bo in cs us sy id wa 1 0 0 3499840 315836 3819660 0 0 0 1 2 0 0 0 100 0 0 0 0 3499584 315836 3819660 0 0 0 0 88 158 0 0 100 0 0 0 0 3499708 315836 3819660 0 0 0 2 86 162 0 0 100 0 0 0 0 3499708 315836 3819660 0 0 0 10 81 151 0 0 100 0 1 0 0 3499732 315836 3819660 0 0 0 2 83 154 0 0 100 0 è¿™è¡¨ç¤ºvmstatæ¯2ç§’é‡‡é›†æ•°æ®ï¼Œä¸€ç›´é‡‡é›†ï¼Œç›´åˆ°æˆ‘ç»“æŸç¨‹åºï¼Œè¿™é‡Œé‡‡é›†äº†5æ¬¡æ•°æ®æˆ‘å°±ç»“æŸäº†ç¨‹åºã€‚ å‚æ•°è¯¦è§£ r è¡¨ç¤ºè¿è¡Œé˜Ÿåˆ—(å°±æ˜¯è¯´å¤šå°‘ä¸ªè¿›ç¨‹çœŸçš„åˆ†é…åˆ°CPU)ï¼Œæˆ‘æµ‹è¯•çš„æœåŠ¡å™¨ç›®å‰CPUæ¯”è¾ƒç©ºé—²ï¼Œæ²¡ä»€ä¹ˆç¨‹åºåœ¨è·‘ï¼Œå½“è¿™ä¸ªå€¼è¶…è¿‡äº†CPUæ•°ç›®ï¼Œå°±ä¼šå‡ºç°CPUç“¶é¢ˆäº†ã€‚è¿™ä¸ªä¹Ÿå’Œtopçš„è´Ÿè½½æœ‰å…³ç³»ï¼Œä¸€èˆ¬è´Ÿè½½è¶…è¿‡äº†3å°±æ¯”è¾ƒé«˜ï¼Œè¶…è¿‡äº†5å°±é«˜ï¼Œè¶…è¿‡äº†10å°±ä¸æ­£å¸¸äº†ï¼ŒæœåŠ¡å™¨çš„çŠ¶æ€å¾ˆå±é™©ã€‚topçš„è´Ÿè½½ç±»ä¼¼æ¯ç§’çš„è¿è¡Œé˜Ÿåˆ—ã€‚å¦‚æœè¿è¡Œé˜Ÿåˆ—è¿‡å¤§ï¼Œè¡¨ç¤ºä½ çš„CPUå¾ˆç¹å¿™ï¼Œä¸€èˆ¬ä¼šé€ æˆCPUä½¿ç”¨ç‡å¾ˆé«˜ã€‚ b è¡¨ç¤ºé˜»å¡çš„è¿›ç¨‹,è¿™ä¸ªä¸å¤šè¯´ï¼Œè¿›ç¨‹é˜»å¡ï¼Œå¤§å®¶æ‡‚çš„ã€‚ swpd è™šæ‹Ÿå†…å­˜å·²ä½¿ç”¨çš„å¤§å°ï¼Œå¦‚æœå¤§äº0ï¼Œè¡¨ç¤ºä½ çš„æœºå™¨ç‰©ç†å†…å­˜ä¸è¶³äº†ï¼Œå¦‚æœä¸æ˜¯ç¨‹åºå†…å­˜æ³„éœ²çš„åŸå› ï¼Œé‚£ä¹ˆä½ è¯¥å‡çº§å†…å­˜äº†æˆ–è€…æŠŠè€—å†…å­˜çš„ä»»åŠ¡è¿ç§»åˆ°å…¶ä»–æœºå™¨ã€‚ free ç©ºé—²çš„ç‰©ç†å†…å­˜çš„å¤§å°ï¼Œæˆ‘çš„æœºå™¨å†…å­˜æ€»å…±8Gï¼Œå‰©ä½™3415Mã€‚ buff Linux/Unixç³»ç»Ÿæ˜¯ç”¨æ¥å­˜å‚¨ï¼Œç›®å½•é‡Œé¢æœ‰ä»€ä¹ˆå†…å®¹ï¼Œæƒé™ç­‰çš„ç¼“å­˜ï¼Œæˆ‘æœ¬æœºå¤§æ¦‚å ç”¨300å¤šM cache cacheç›´æ¥ç”¨æ¥è®°å¿†æˆ‘ä»¬æ‰“å¼€çš„æ–‡ä»¶,ç»™æ–‡ä»¶åšç¼“å†²ï¼Œæˆ‘æœ¬æœºå¤§æ¦‚å ç”¨300å¤šM(è¿™é‡Œæ˜¯Linux/Unixçš„èªæ˜ä¹‹å¤„ï¼ŒæŠŠç©ºé—²çš„ç‰©ç†å†…å­˜çš„ä¸€éƒ¨åˆ†æ‹¿æ¥åšæ–‡ä»¶å’Œç›®å½•çš„ç¼“å­˜ï¼Œæ˜¯ä¸ºäº†æé«˜ ç¨‹åºæ‰§è¡Œçš„æ€§èƒ½ï¼Œå½“ç¨‹åºä½¿ç”¨å†…å­˜æ—¶ï¼Œbuffer/cachedä¼šå¾ˆå¿«åœ°è¢«ä½¿ç”¨ã€‚) si æ¯ç§’ä»ç£ç›˜è¯»å…¥è™šæ‹Ÿå†…å­˜çš„å¤§å°ï¼Œå¦‚æœè¿™ä¸ªå€¼å¤§äº0ï¼Œè¡¨ç¤ºç‰©ç†å†…å­˜ä¸å¤Ÿç”¨æˆ–è€…å†…å­˜æ³„éœ²äº†ï¼Œè¦æŸ¥æ‰¾è€—å†…å­˜è¿›ç¨‹è§£å†³æ‰ã€‚æˆ‘çš„æœºå™¨å†…å­˜å……è£•ï¼Œä¸€åˆ‡æ­£å¸¸ã€‚ so æ¯ç§’è™šæ‹Ÿå†…å­˜å†™å…¥ç£ç›˜çš„å¤§å°ï¼Œå¦‚æœè¿™ä¸ªå€¼å¤§äº0ï¼ŒåŒä¸Šã€‚ bi å—è®¾å¤‡æ¯ç§’æ¥æ”¶çš„å—æ•°é‡ï¼Œè¿™é‡Œçš„å—è®¾å¤‡æ˜¯æŒ‡ç³»ç»Ÿä¸Šæ‰€æœ‰çš„ç£ç›˜å’Œå…¶ä»–å—è®¾å¤‡ï¼Œé»˜è®¤å—å¤§å°æ˜¯1024byteï¼Œæˆ‘æœ¬æœºä¸Šæ²¡ä»€ä¹ˆIOæ“ä½œï¼Œæ‰€ä»¥ä¸€ç›´æ˜¯0ï¼Œä½†æ˜¯æˆ‘æ›¾åœ¨å¤„ç†æ‹·è´å¤§é‡æ•°æ®(2-3T)çš„æœºå™¨ä¸Šçœ‹è¿‡å¯ä»¥è¾¾åˆ°140000/sï¼Œç£ç›˜å†™å…¥é€Ÿåº¦å·®ä¸å¤š140Mæ¯ç§’ bo å—è®¾å¤‡æ¯ç§’å‘é€çš„å—æ•°é‡ï¼Œä¾‹å¦‚æˆ‘ä»¬è¯»å–æ–‡ä»¶ï¼Œboå°±è¦å¤§äº0ã€‚biå’Œboä¸€èˆ¬éƒ½è¦æ¥è¿‘0ï¼Œä¸ç„¶å°±æ˜¯IOè¿‡äºé¢‘ç¹ï¼Œéœ€è¦è°ƒæ•´ã€‚ in æ¯ç§’CPUçš„ä¸­æ–­æ¬¡æ•°ï¼ŒåŒ…æ‹¬æ—¶é—´ä¸­æ–­ cs æ¯ç§’ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°ï¼Œä¾‹å¦‚æˆ‘ä»¬è°ƒç”¨ç³»ç»Ÿå‡½æ•°ï¼Œå°±è¦è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œçº¿ç¨‹çš„åˆ‡æ¢ï¼Œä¹Ÿè¦è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿™ä¸ªå€¼è¦è¶Šå°è¶Šå¥½ï¼Œå¤ªå¤§äº†ï¼Œè¦è€ƒè™‘è°ƒä½çº¿ç¨‹æˆ–è€…è¿›ç¨‹çš„æ•°ç›®,ä¾‹å¦‚åœ¨apacheå’Œnginxè¿™ç§webæœåŠ¡å™¨ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬åšæ€§èƒ½æµ‹è¯•æ—¶ä¼šè¿›è¡Œå‡ åƒå¹¶å‘ç”šè‡³å‡ ä¸‡å¹¶å‘çš„æµ‹è¯•ï¼Œé€‰æ‹©webæœåŠ¡å™¨çš„è¿›ç¨‹å¯ä»¥ç”±è¿›ç¨‹æˆ–è€…çº¿ç¨‹çš„å³°å€¼ä¸€ç›´ä¸‹è°ƒï¼Œå‹æµ‹ï¼Œç›´åˆ°csåˆ°ä¸€ä¸ªæ¯”è¾ƒå°çš„å€¼ï¼Œè¿™ä¸ªè¿›ç¨‹å’Œçº¿ç¨‹æ•°å°±æ˜¯æ¯”è¾ƒåˆé€‚çš„å€¼äº†ã€‚ç³»ç»Ÿè°ƒç”¨ä¹Ÿæ˜¯ï¼Œæ¯æ¬¡è°ƒç”¨ç³»ç»Ÿå‡½æ•°ï¼Œæˆ‘ä»¬çš„ä»£ç å°±ä¼šè¿›å…¥å†…æ ¸ç©ºé—´ï¼Œå¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿™ä¸ªæ˜¯å¾ˆè€—èµ„æºï¼Œä¹Ÿè¦å°½é‡é¿å…é¢‘ç¹è°ƒç”¨ç³»ç»Ÿå‡½æ•°ã€‚ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°è¿‡å¤šè¡¨ç¤ºä½ çš„CPUå¤§éƒ¨åˆ†æµªè´¹åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¯¼è‡´CPUå¹²æ­£ç»äº‹çš„æ—¶é—´å°‘äº†ï¼ŒCPUæ²¡æœ‰å……åˆ†åˆ©ç”¨ï¼Œæ˜¯ä¸å¯å–çš„ã€‚ us ç”¨æˆ·CPUæ—¶é—´ï¼Œæˆ‘æ›¾ç»åœ¨ä¸€ä¸ªåšåŠ å¯†è§£å¯†å¾ˆé¢‘ç¹çš„æœåŠ¡å™¨ä¸Šï¼Œå¯ä»¥çœ‹åˆ°usæ¥è¿‘100,rè¿è¡Œé˜Ÿåˆ—è¾¾åˆ°80(æœºå™¨åœ¨åšå‹åŠ›æµ‹è¯•ï¼Œæ€§èƒ½è¡¨ç°ä¸ä½³)ã€‚ sy ç³»ç»ŸCPUæ—¶é—´ï¼Œå¦‚æœå¤ªé«˜ï¼Œè¡¨ç¤ºç³»ç»Ÿè°ƒç”¨æ—¶é—´é•¿ï¼Œä¾‹å¦‚æ˜¯IOæ“ä½œé¢‘ç¹ã€‚ id ç©ºé—² CPUæ—¶é—´ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œid + us + sy = 100,ä¸€èˆ¬æˆ‘è®¤ä¸ºidæ˜¯ç©ºé—²CPUä½¿ç”¨ç‡ï¼Œusæ˜¯ç”¨æˆ·CPUä½¿ç”¨ç‡ï¼Œsyæ˜¯ç³»ç»ŸCPUä½¿ç”¨ç‡ã€‚ wt ç­‰å¾…IO CPUæ—¶é—´ã€‚ pidå‘½ä»¤è¯¦è§£ pidstatæ˜¯sysstatå·¥å…·çš„ä¸€ä¸ªå‘½ä»¤ï¼Œç”¨äºç›‘æ§å…¨éƒ¨æˆ–æŒ‡å®šè¿›ç¨‹çš„cpuã€å†…å­˜ã€çº¿ç¨‹ã€è®¾å¤‡IOç­‰ç³»ç»Ÿèµ„æºçš„å ç”¨æƒ…å†µã€‚pidstaté¦–æ¬¡è¿è¡Œæ—¶æ˜¾ç¤ºè‡ªç³»ç»Ÿå¯åŠ¨å¼€å§‹çš„å„é¡¹ç»Ÿè®¡ä¿¡æ¯ï¼Œä¹‹åè¿è¡Œpidstatå°†æ˜¾ç¤ºè‡ªä¸Šæ¬¡è¿è¡Œè¯¥å‘½ä»¤ä»¥åçš„ç»Ÿè®¡ä¿¡æ¯ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡æŒ‡å®šç»Ÿè®¡çš„æ¬¡æ•°å’Œæ—¶é—´æ¥è·å¾—æ‰€éœ€çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ pidstat çš„ç”¨æ³•ï¼š pidstat [ é€‰é¡¹ ] [ &lt;æ—¶é—´é—´éš”&gt; ] [ &lt;æ¬¡æ•°&gt; ] å¦‚ä¸‹å›¾ï¼š å¸¸ç”¨çš„å‚æ•°ï¼š -uï¼šé»˜è®¤çš„å‚æ•°ï¼Œæ˜¾ç¤ºå„ä¸ªè¿›ç¨‹çš„cpuä½¿ç”¨ç»Ÿè®¡ -rï¼šæ˜¾ç¤ºå„ä¸ªè¿›ç¨‹çš„å†…å­˜ä½¿ç”¨ç»Ÿè®¡ -dï¼šæ˜¾ç¤ºå„ä¸ªè¿›ç¨‹çš„IOä½¿ç”¨æƒ…å†µ -pï¼šæŒ‡å®šè¿›ç¨‹å· -wï¼šæ˜¾ç¤ºæ¯ä¸ªè¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æƒ…å†µ -tï¼šæ˜¾ç¤ºé€‰æ‹©ä»»åŠ¡çš„çº¿ç¨‹çš„ç»Ÿè®¡ä¿¡æ¯å¤–çš„é¢å¤–ä¿¡æ¯ -T { TASK | CHILD | ALL } è¿™ä¸ªé€‰é¡¹æŒ‡å®šäº†pidstatç›‘æ§çš„ã€‚TASKè¡¨ç¤ºæŠ¥å‘Šç‹¬ç«‹çš„taskï¼ŒCHILDå…³é”®å­—è¡¨ç¤ºæŠ¥å‘Šè¿›ç¨‹ä¸‹æ‰€æœ‰çº¿ç¨‹ç»Ÿè®¡ä¿¡æ¯ã€‚ALLè¡¨ç¤ºæŠ¥å‘Šç‹¬ç«‹çš„taskå’Œtaskä¸‹é¢çš„æ‰€æœ‰çº¿ç¨‹ã€‚ æ³¨æ„ï¼štaskå’Œå­çº¿ç¨‹çš„å…¨å±€çš„ç»Ÿè®¡ä¿¡æ¯å’Œpidstaté€‰é¡¹æ— å…³ã€‚è¿™äº›ç»Ÿè®¡ä¿¡æ¯ä¸ä¼šå¯¹åº”åˆ°å½“å‰çš„ç»Ÿè®¡é—´éš”ï¼Œè¿™äº›ç»Ÿè®¡ä¿¡æ¯åªæœ‰åœ¨å­çº¿ç¨‹killæˆ–è€…å®Œæˆçš„æ—¶å€™æ‰ä¼šè¢«æ”¶é›†ã€‚ -Vï¼šç‰ˆæœ¬å· -hï¼šåœ¨ä¸€è¡Œä¸Šæ˜¾ç¤ºäº†æ‰€æœ‰æ´»åŠ¨ï¼Œè¿™æ ·å…¶ä»–ç¨‹åºå¯ä»¥å®¹æ˜“è§£æã€‚ -Iï¼šåœ¨SMPç¯å¢ƒï¼Œè¡¨ç¤ºä»»åŠ¡çš„CPUä½¿ç”¨ç‡/å†…æ ¸æ•°é‡ -lï¼šæ˜¾ç¤ºå‘½ä»¤åå’Œæ‰€æœ‰å‚æ•° pidstat pidstat -u -p ALL pidstat å’Œ pidstat -u -p ALL æ˜¯ç­‰æ•ˆçš„ã€‚ pidstat é»˜è®¤æ˜¾ç¤ºäº†æ‰€æœ‰è¿›ç¨‹çš„cpuä½¿ç”¨ç‡ã€‚ å‚æ•°è¯¦è§£ PIDï¼šè¿›ç¨‹ID %usrï¼šè¿›ç¨‹åœ¨ç”¨æˆ·ç©ºé—´å ç”¨cpuçš„ç™¾åˆ†æ¯” %systemï¼šè¿›ç¨‹åœ¨å†…æ ¸ç©ºé—´å ç”¨cpuçš„ç™¾åˆ†æ¯” %guestï¼šè¿›ç¨‹åœ¨è™šæ‹Ÿæœºå ç”¨cpuçš„ç™¾åˆ†æ¯” %CPUï¼šè¿›ç¨‹å ç”¨cpuçš„ç™¾åˆ†æ¯” CPUï¼šå¤„ç†è¿›ç¨‹çš„cpuç¼–å· Commandï¼šå½“å‰è¿›ç¨‹å¯¹åº”çš„å‘½ä»¤ freeå‘½ä»¤è¯¦è§£ free å‘½ä»¤æ˜¾ç¤ºç³»ç»Ÿå†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼ŒåŒ…æ‹¬ç‰©ç†å†…å­˜ã€äº¤æ¢å†…å­˜(swap)å’Œå†…æ ¸ç¼“å†²åŒºå†…å­˜ã€‚ å¦‚æœåŠ ä¸Š -h é€‰é¡¹ï¼Œè¾“å‡ºçš„ç»“æœä¼šå‹å¥½å¾ˆå¤šï¼š æœ‰æ—¶æˆ‘ä»¬éœ€è¦æŒç»­çš„è§‚å¯Ÿå†…å­˜çš„çŠ¶å†µï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨ -s é€‰é¡¹å¹¶æŒ‡å®šé—´éš”çš„ç§’æ•°ï¼š $ free -h -s 3 ä¸Šé¢çš„å‘½ä»¤æ¯éš” 3 ç§’è¾“å‡ºä¸€æ¬¡å†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œç›´åˆ°ä½ æŒ‰ä¸‹ ctrl + cã€‚ ç”±äº free å‘½ä»¤æœ¬èº«æ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥æœ¬æ–‡çš„é‡ç‚¹ä¼šæ”¾åœ¨å¦‚ä½•é€šè¿‡ free å‘½ä»¤äº†è§£ç³»ç»Ÿå½“å‰çš„å†…å­˜ä½¿ç”¨çŠ¶å†µã€‚ è¾“å‡ºè¯´æ˜ Mem è¡Œ(ç¬¬äºŒè¡Œ)æ˜¯å†…å­˜çš„ä½¿ç”¨æƒ…å†µã€‚ Swap è¡Œ(ç¬¬ä¸‰è¡Œ)æ˜¯äº¤æ¢ç©ºé—´çš„ä½¿ç”¨æƒ…å†µã€‚ total åˆ—æ˜¾ç¤ºç³»ç»Ÿæ€»çš„å¯ç”¨ç‰©ç†å†…å­˜å’Œäº¤æ¢ç©ºé—´å¤§å°ã€‚ used åˆ—æ˜¾ç¤ºå·²ç»è¢«ä½¿ç”¨çš„ç‰©ç†å†…å­˜å’Œäº¤æ¢ç©ºé—´ã€‚ free åˆ—æ˜¾ç¤ºè¿˜æœ‰å¤šå°‘ç‰©ç†å†…å­˜å’Œäº¤æ¢ç©ºé—´å¯ç”¨ä½¿ç”¨ã€‚ shared åˆ—æ˜¾ç¤ºè¢«å…±äº«ä½¿ç”¨çš„ç‰©ç†å†…å­˜å¤§å°ã€‚ buff/cache åˆ—æ˜¾ç¤ºè¢« buffer å’Œ cache ä½¿ç”¨çš„ç‰©ç†å†…å­˜å¤§å°ã€‚ available åˆ—æ˜¾ç¤ºè¿˜å¯ä»¥è¢«åº”ç”¨ç¨‹åºä½¿ç”¨çš„ç‰©ç†å†…å­˜å¤§å°ã€‚ dfå‘½ä»¤è¯¦è§£ Linux dfï¼ˆè‹±æ–‡å…¨æ‹¼ï¼šdisk freeï¼‰ å‘½ä»¤ç”¨äºæ˜¾ç¤ºç›®å‰åœ¨ Linux ç³»ç»Ÿä¸Šçš„æ–‡ä»¶ç³»ç»Ÿç£ç›˜ä½¿ç”¨æƒ…å†µç»Ÿè®¡ã€‚ è¯­æ³• df [é€‰é¡¹]... [FILE]... æ–‡ä»¶-a, --all åŒ…å«æ‰€æœ‰çš„å…·æœ‰ 0 Blocks çš„æ–‡ä»¶ç³»ç»Ÿ æ–‡ä»¶--block-size={SIZE} ä½¿ç”¨ {SIZE} å¤§å°çš„ Blocks æ–‡ä»¶-h, --human-readable ä½¿ç”¨äººç±»å¯è¯»çš„æ ¼å¼(é¢„è®¾å€¼æ˜¯ä¸åŠ è¿™ä¸ªé€‰é¡¹çš„...) æ–‡ä»¶-H, --si å¾ˆåƒ -h, ä½†æ˜¯ç”¨ 1000 ä¸ºå•ä½è€Œä¸æ˜¯ç”¨ 1024 æ–‡ä»¶-i, --inodes åˆ—å‡º inode èµ„è®¯ï¼Œä¸åˆ—å‡ºå·²ä½¿ç”¨ block æ–‡ä»¶-k, --kilobytes å°±åƒæ˜¯ --block-size=1024 æ–‡ä»¶-l, --local é™åˆ¶åˆ—å‡ºçš„æ–‡ä»¶ç»“æ„ æ–‡ä»¶-m, --megabytes å°±åƒ --block-size=1048576 æ–‡ä»¶--no-sync å–å¾—èµ„è®¯å‰ä¸ sync (é¢„è®¾å€¼) æ–‡ä»¶-P, --portability ä½¿ç”¨ POSIX è¾“å‡ºæ ¼å¼ æ–‡ä»¶--sync åœ¨å–å¾—èµ„è®¯å‰ sync æ–‡ä»¶-t, --type=TYPE é™åˆ¶åˆ—å‡ºæ–‡ä»¶ç³»ç»Ÿçš„ TYPE æ–‡ä»¶-T, --print-type æ˜¾ç¤ºæ–‡ä»¶ç³»ç»Ÿçš„å½¢å¼ æ–‡ä»¶-x, --exclude-type=TYPE é™åˆ¶åˆ—å‡ºæ–‡ä»¶ç³»ç»Ÿä¸è¦æ˜¾ç¤º TYPE æ–‡ä»¶-v (å¿½ç•¥) æ–‡ä»¶--help æ˜¾ç¤ºè¿™ä¸ªå¸®æ‰‹å¹¶ä¸”ç¦»å¼€ æ–‡ä»¶--version è¾“å‡ºç‰ˆæœ¬èµ„è®¯å¹¶ä¸”ç¦»å¼€ å®ä¾‹ æ˜¾ç¤ºæ–‡ä»¶ç³»ç»Ÿçš„ç£ç›˜ä½¿ç”¨æƒ…å†µç»Ÿè®¡ï¼š # df Filesystem 1K-blocks Used Available Use% Mounted on /dev/sda6 29640780 4320704 23814388 16% / udev 1536756 4 1536752 1% /dev tmpfs 617620 888 616732 1% /run none 5120 0 5120 0% /run/lock none 1544044 156 1543888 1% /run/shm ç¬¬ä¸€åˆ—æŒ‡å®šæ–‡ä»¶ç³»ç»Ÿçš„åç§°ï¼Œç¬¬äºŒåˆ—æŒ‡å®šä¸€ä¸ªç‰¹å®šçš„æ–‡ä»¶ç³»ç»Ÿ1K-å—1Kæ˜¯1024å­—èŠ‚ä¸ºå•ä½çš„æ€»å†…å­˜ã€‚ç”¨å’Œå¯ç”¨åˆ—æ­£åœ¨ä½¿ç”¨ä¸­ï¼Œåˆ†åˆ«æŒ‡å®šçš„å†…å­˜é‡ã€‚ ä½¿ç”¨åˆ—æŒ‡å®šä½¿ç”¨çš„å†…å­˜çš„ç™¾åˆ†æ¯”ï¼Œè€Œæœ€åä¸€æ &quot;å®‰è£…åœ¨&quot;æŒ‡å®šçš„æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ç‚¹ã€‚ dfä¹Ÿå¯ä»¥æ˜¾ç¤ºç£ç›˜ä½¿ç”¨çš„æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ï¼š # df test Filesystem 1K-blocks Used Available Use% Mounted on /dev/sda6 29640780 4320600 23814492 16% / ç”¨ä¸€ä¸ª-ié€‰é¡¹çš„dfå‘½ä»¤çš„è¾“å‡ºæ˜¾ç¤ºinodeä¿¡æ¯è€Œéå—ä½¿ç”¨é‡ã€‚ df -i Filesystem Inodes IUsed IFree IUse% Mounted on /dev/sda6 1884160 261964 1622196 14% / udev 212748 560 212188 1% /dev tmpfs 216392 477 215915 1% /run none 216392 3 216389 1% /run/lock none 216392 8 216384 1% /run/shm æ˜¾ç¤ºæ‰€æœ‰çš„ä¿¡æ¯: # df --total Filesystem 1K-blocks Used Available Use% Mounted on /dev/sda6 29640780 4320720 23814372 16% / udev 1536756 4 1536752 1% /dev tmpfs 617620 892 616728 1% /run none 5120 0 5120 0% /run/lock none 1544044 156 1543888 1% /run/shm total 33344320 4321772 27516860 14% æˆ‘ä»¬çœ‹åˆ°è¾“å‡ºçš„æœ«å°¾ï¼ŒåŒ…å«ä¸€ä¸ªé¢å¤–çš„è¡Œï¼Œæ˜¾ç¤ºæ€»çš„æ¯ä¸€åˆ—ã€‚ -hé€‰é¡¹ï¼Œé€šè¿‡å®ƒå¯ä»¥äº§ç”Ÿå¯è¯»çš„æ ¼å¼dfå‘½ä»¤çš„è¾“å‡ºï¼š # df -h Filesystem Size Used Avail Use% Mounted on /dev/sda6 29G 4.2G 23G 16% / udev 1.5G 4.0K 1.5G 1% /dev tmpfs 604M 892K 603M 1% /run none 5.0M 0 5.0M 0% /run/lock none 1.5G 156K 1.5G 1% /run/shm æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¾“å‡ºæ˜¾ç¤ºçš„æ•°å­—å½¢å¼çš„'G'ï¼ˆåƒå…†å­—èŠ‚ï¼‰ï¼Œ&quot;M&quot;ï¼ˆå…†å­—èŠ‚ï¼‰å’Œ&quot;K&quot;ï¼ˆåƒå­—èŠ‚ï¼‰ã€‚ è¿™ä½¿è¾“å‡ºå®¹æ˜“é˜…è¯»å’Œç†è§£ï¼Œä»è€Œä½¿æ˜¾ç¤ºå¯è¯»çš„ã€‚è¯·æ³¨æ„ï¼Œç¬¬äºŒåˆ—çš„åç§°ä¹Ÿå‘ç”Ÿäº†å˜åŒ–ï¼Œä¸ºäº†ä½¿æ˜¾ç¤ºå¯è¯»çš„&quot;å¤§å°&quot;ã€‚ iostatå‘½ä»¤è¯¦è§£ ç”¨æ³•ï¼šiostat [ é€‰é¡¹ ] [ &lt;æ—¶é—´é—´éš”&gt; [ &lt;æ¬¡æ•°&gt; ]] å¸¸ç”¨é€‰é¡¹è¯´æ˜ï¼š -cï¼šåªæ˜¾ç¤ºç³»ç»ŸCPUç»Ÿè®¡ä¿¡æ¯ï¼Œå³å•ç‹¬è¾“å‡ºavg-cpuç»“æœï¼Œä¸åŒ…æ‹¬deviceç»“æœ -dï¼šå•ç‹¬è¾“å‡ºDeviceç»“æœï¼Œä¸åŒ…æ‹¬cpuç»“æœ -k/-mï¼šè¾“å‡ºç»“æœä»¥kB/mBä¸ºå•ä½ï¼Œè€Œä¸æ˜¯ä»¥æ‰‡åŒºæ•°ä¸ºå•ä½ -x:è¾“å‡ºæ›´è¯¦ç»†çš„ioè®¾å¤‡ç»Ÿè®¡ä¿¡æ¯ interval/countï¼šæ¯æ¬¡è¾“å‡ºé—´éš”æ—¶é—´ï¼Œcountè¡¨ç¤ºè¾“å‡ºæ¬¡æ•°ï¼Œä¸å¸¦countè¡¨ç¤ºå¾ªç¯è¾“å‡º è¯´æ˜ï¼šæ›´å¤šé€‰é¡¹ä½¿ç”¨ä½¿ç”¨man iostatæŸ¥çœ‹ å®ä¾‹ 1ã€iostatï¼Œç»“æœä¸ºä»ç³»ç»Ÿå¼€æœºåˆ°å½“å‰æ‰§è¡Œæ—¶åˆ»çš„ç»Ÿè®¡ä¿¡æ¯ è¾“å‡ºå«ä¹‰ï¼š avg-cpu: æ€»ä½“cpuä½¿ç”¨æƒ…å†µç»Ÿè®¡ä¿¡æ¯ï¼Œå¯¹äºå¤šæ ¸cpuï¼Œè¿™é‡Œä¸ºæ‰€æœ‰cpuçš„å¹³å‡å€¼ã€‚é‡ç‚¹å…³æ³¨iowaitå€¼ï¼Œè¡¨ç¤ºCPUç”¨äºç­‰å¾…ioè¯·æ±‚çš„å®Œæˆæ—¶é—´ã€‚ Device: å„ç£ç›˜è®¾å¤‡çš„IOç»Ÿè®¡ä¿¡æ¯ã€‚å„åˆ—å«ä¹‰å¦‚ä¸‹ï¼š Device: ä»¥sdXå½¢å¼æ˜¾ç¤ºçš„è®¾å¤‡åç§° tps: æ¯ç§’è¿›ç¨‹ä¸‹å‘çš„IOè¯»ã€å†™è¯·æ±‚æ•°é‡ KB_read/s: æ¯ç§’ä»é©±åŠ¨å™¨è¯»å…¥çš„æ•°æ®é‡ï¼Œå•ä½ä¸ºKã€‚ KB_wrtn/s: æ¯ç§’ä»é©±åŠ¨å™¨å†™å…¥çš„æ•°æ®é‡ï¼Œå•ä½ä¸ºKã€‚ KB_read: è¯»å…¥æ•°æ®æ€»é‡ï¼Œå•ä½ä¸ºKã€‚ KB_wrtn: å†™å…¥æ•°æ®æ€»é‡ï¼Œå•ä½ä¸ºKã€‚ 2ã€iostat -x -k -d 1 2ã€‚æ¯éš”1Sè¾“å‡ºç£ç›˜IOçš„è¯¦ç»†è¯¦ç»†ï¼Œæ€»å…±é‡‡æ ·2æ¬¡ã€‚ ä»¥ä¸Šå„åˆ—çš„å«ä¹‰å¦‚ä¸‹ï¼š rrqm/s: æ¯ç§’å¯¹è¯¥è®¾å¤‡çš„è¯»è¯·æ±‚è¢«åˆå¹¶æ¬¡æ•°ï¼Œæ–‡ä»¶ç³»ç»Ÿä¼šå¯¹è¯»å–åŒå—(block)çš„è¯·æ±‚è¿›è¡Œåˆå¹¶ wrqm/s: æ¯ç§’å¯¹è¯¥è®¾å¤‡çš„å†™è¯·æ±‚è¢«åˆå¹¶æ¬¡æ•° r/s: æ¯ç§’å®Œæˆçš„è¯»æ¬¡æ•° w/s: æ¯ç§’å®Œæˆçš„å†™æ¬¡æ•° rkB/s: æ¯ç§’è¯»æ•°æ®é‡(kBä¸ºå•ä½) wkB/s: æ¯ç§’å†™æ•°æ®é‡(kBä¸ºå•ä½) avgrq-sz:å¹³å‡æ¯æ¬¡IOæ“ä½œçš„æ•°æ®é‡(æ‰‡åŒºæ•°ä¸ºå•ä½) avgqu-sz: å¹³å‡ç­‰å¾…å¤„ç†çš„IOè¯·æ±‚é˜Ÿåˆ—é•¿åº¦ await: å¹³å‡æ¯æ¬¡IOè¯·æ±‚ç­‰å¾…æ—¶é—´(åŒ…æ‹¬ç­‰å¾…æ—¶é—´å’Œå¤„ç†æ—¶é—´ï¼Œæ¯«ç§’ä¸ºå•ä½) svctm: å¹³å‡æ¯æ¬¡IOè¯·æ±‚çš„å¤„ç†æ—¶é—´(æ¯«ç§’ä¸ºå•ä½) %util: é‡‡ç”¨å‘¨æœŸå†…ç”¨äºIOæ“ä½œçš„æ—¶é—´æ¯”ç‡ï¼Œå³IOé˜Ÿåˆ—éç©ºçš„æ—¶é—´æ¯”ç‡ é‡ç‚¹å…³æ³¨å‚æ•° 1ã€iowait% è¡¨ç¤ºCPUç­‰å¾…IOæ—¶é—´å æ•´ä¸ªCPUå‘¨æœŸçš„ç™¾åˆ†æ¯”ï¼Œå¦‚æœiowaitå€¼è¶…è¿‡50%ï¼Œæˆ–è€…æ˜æ˜¾å¤§äº%systemã€%userä»¥åŠ%idleï¼Œè¡¨ç¤ºIOå¯èƒ½å­˜åœ¨é—®é¢˜ã€‚ 2ã€avgqu-sz è¡¨ç¤ºç£ç›˜IOé˜Ÿåˆ—é•¿åº¦ï¼Œå³IOç­‰å¾…ä¸ªæ•°ã€‚ 3ã€await è¡¨ç¤ºæ¯æ¬¡IOè¯·æ±‚ç­‰å¾…æ—¶é—´ï¼ŒåŒ…æ‹¬ç­‰å¾…æ—¶é—´å’Œå¤„ç†æ—¶é—´ 4ã€svctm è¡¨ç¤ºæ¯æ¬¡IOè¯·æ±‚å¤„ç†çš„æ—¶é—´ 5ã€%util è¡¨ç¤ºç£ç›˜å¿™ç¢Œæƒ…å†µï¼Œä¸€èˆ¬è¯¥å€¼è¶…è¿‡80%è¡¨ç¤ºè¯¥ç£ç›˜å¯èƒ½å¤„äºç¹å¿™çŠ¶æ€ã€‚ ifstatå‘½ä»¤è¯¦è§£ ç»Ÿè®¡ç½‘ç»œæ¥å£æµé‡çŠ¶æ€ ä¸‹è½½ wget http://gael.roualland.free.fr/ifstat/ifstat-1.1.tar.gz ç¼–è¯‘å®‰è£… tar -zxvf ifstat-1.1.tar.gz cd ifstat-1.1 ./configure make make install # é»˜è®¤ä¼šå®‰è£…åˆ°/usr/local/bin/ç›®å½•ä¸­ æ³¨é‡Šï¼šæ‰§è¡Œwhich ifstatè¾“å‡º/usr/local/bin/ifstat é€‰é¡¹ -l ç›‘æµ‹ç¯è·¯ç½‘ç»œæ¥å£ï¼ˆloï¼‰ã€‚ç¼ºçœæƒ…å†µä¸‹ï¼Œifstatç›‘æµ‹æ´»åŠ¨çš„æ‰€æœ‰éç¯è·¯ç½‘ç»œæ¥å£ã€‚ç»ä½¿ç”¨å‘ç°ï¼ŒåŠ ä¸Š-lå‚æ•°èƒ½ç›‘æµ‹æ‰€æœ‰çš„ç½‘ç»œæ¥å£çš„ä¿¡æ¯ï¼Œè€Œä¸æ˜¯åªç›‘æµ‹ loçš„æ¥å£ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒåŠ ä¸Š-lå‚æ•°æ¯”ä¸åŠ -lå‚æ•°ä¼šå¤šä¸€ä¸ªloæ¥å£çš„çŠ¶æ€ä¿¡æ¯ã€‚ -a ç›‘æµ‹èƒ½æ£€æµ‹åˆ°çš„æ‰€æœ‰ç½‘ç»œæ¥å£çš„çŠ¶æ€ä¿¡æ¯ã€‚ä½¿ç”¨å‘ç°ï¼Œæ¯”åŠ ä¸Š-lå‚æ•°è¿˜å¤šä¸€ä¸ªplip0çš„æ¥å£ä¿¡æ¯ï¼Œæœç´¢ä¸€ä¸‹å‘ç°è¿™æ˜¯å¹¶å£ï¼ˆç½‘ç»œè®¾å¤‡ä¸­æœ‰ä¸€ ä¸ªå«PLIP (Parallel Line Internet Protocol). å®ƒæä¾›äº†å¹¶å£...ï¼‰ -z éšè—æµé‡æ˜¯æ— çš„æ¥å£ï¼Œä¾‹å¦‚é‚£äº›æ¥å£è™½ç„¶å¯åŠ¨äº†ä½†æ˜¯æœªç”¨çš„ -i æŒ‡å®šè¦ç›‘æµ‹çš„æ¥å£,åé¢è·Ÿç½‘ç»œæ¥å£å -s ç­‰äºåŠ -d snmp:[comm@][#]host[/nn]] å‚æ•°ï¼Œé€šè¿‡SNMPæŸ¥è¯¢ä¸€ä¸ªè¿œç¨‹ä¸»æœº -h æ˜¾ç¤ºç®€çŸ­çš„å¸®åŠ©ä¿¡æ¯ -n å…³é—­æ˜¾ç¤ºå‘¨æœŸæ€§å‡ºç°çš„å¤´éƒ¨ä¿¡æ¯ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œä¸åŠ -nå‚æ•°è¿è¡Œifstatæ—¶æœ€é¡¶éƒ¨ä¼šå‡ºç°ç½‘ç»œæ¥å£çš„åç§°ï¼Œå½“ä¸€å±æ˜¾ç¤ºä¸ä¸‹æ—¶ï¼Œä¼šå†ä¸€æ¬¡å‡ºç°æ¥å£çš„åç§°ï¼Œæç¤ºæˆ‘ä»¬æ˜¾ç¤ºçš„æµé‡ä¿¡æ¯å…·ä½“æ˜¯å“ªä¸ªç½‘ç»œæ¥å£çš„ã€‚åŠ ä¸Š-nå‚æ•°æŠŠå‘¨æœŸæ€§çš„æ˜¾ç¤ºæ¥å£åç§°å…³é—­ï¼Œåªæ˜¾ç¤ºä¸€æ¬¡ï¼‰ -t åœ¨æ¯ä¸€è¡Œçš„å¼€å¤´åŠ ä¸€ä¸ªæ—¶é—´ æˆ³ï¼ˆèƒ½å‘Šè¯‰æˆ‘ä»¬å…·ä½“çš„æ—¶é—´ï¼‰ -T æŠ¥å‘Šæ‰€æœ‰ç›‘æµ‹æ¥å£çš„å…¨éƒ¨å¸¦å®½ï¼ˆæœ€åä¸€åˆ—æœ‰ä¸ªtotalï¼Œæ˜¾ç¤ºæ‰€æœ‰çš„æ¥å£çš„inæµé‡å’Œæ‰€æœ‰æ¥å£çš„outæµé‡ï¼Œç®€å•çš„æŠŠæ‰€æœ‰æ¥å£çš„inæµé‡ç›¸åŠ ,outæµé‡ç›¸ åŠ ï¼‰ -w ç”¨æŒ‡å®šçš„åˆ—å®½ï¼Œè€Œä¸æ˜¯ä¸ºäº†é€‚åº”æ¥å£åç§°çš„é•¿åº¦è€Œå»è‡ªåŠ¨æ”¾å¤§åˆ—å®½ -W å¦‚æœå†…å®¹æ¯”ç»ˆç«¯çª—å£çš„å®½åº¦è¿˜è¦å®½å°±è‡ªåŠ¨æ¢è¡Œ -S åœ¨åŒä¸€è¡Œä¿æŒçŠ¶æ€æ›´æ–°ï¼ˆä¸æ»šåŠ¨ä¸æ¢è¡Œï¼‰æ³¨ï¼šå¦‚æœä¸å–œæ¬¢å±å¹•æ»šåŠ¨åˆ™æ­¤é¡¹éå¸¸æ–¹ä¾¿ï¼Œä¸bmonçš„æ˜¾ç¤ºæ–¹å¼ç±»ä¼¼ -b ç”¨kbits/sæ˜¾ç¤ºå¸¦å®½è€Œä¸æ˜¯kbytes/s -q å®‰é™æ¨¡å¼ï¼Œè­¦å‘Šä¿¡æ¯ä¸å‡ºç° -v æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯ -d æŒ‡å®šä¸€ä¸ªé©±åŠ¨æ¥æ”¶é›†çŠ¶æ€ä¿¡æ¯ å®ä¾‹ é»˜è®¤ä½¿ç”¨ #ifstat eth0 eth1 KB/s in KB/s out KB/s in KB/s out 0.07 0.20 0.00 0.00 0.07 0.15 0.58 0.00 é»˜è®¤ifstatä¸ç›‘æ§å›ç¯æ¥å£ï¼Œæ˜¾ç¤ºçš„æµé‡å•ä½æ˜¯KBã€‚ ifstat -tT time eth0 eth1 eth2 eth3 Total HH:MM:ss KB/s in KB/s out KB/s in KB/s out KB/s in KB/s out KB/s in KB/s out KB/s in KB/s out 16:53:04 0.84 0.62 1256.27 1173.05 0.12 0.18 0.00 0.00 1257.22 1173.86 16:53:05 0.57 0.40 0.57 0.76 0.00 0.00 0.00 0.00 1.14 1.17 16:53:06 1.58 0.71 0.42 0.78 0.00 0.00 0.00 0.00 2.01 1.48 16:53:07 0.57 0.40 1.91 2.61 0.00 0.00 0.00 0.00 2.48 3.01 16:53:08 0.73 0.40 924.02 1248.91 0.00 0.00 0.00 0.00 924.76 1249.31 ç›‘æ§æ‰€æœ‰ç½‘ç»œæ¥å£ ifstat -a lo eth0 eth1 KB/s in KB/s out KB/s in KB/s out KB/s in KB/s out 0.00 0.00 0.28 0.58 0.06 0.06 0.00 0.00 1.41 1.13 0.00 0.00 0.61 0.61 0.26 0.23 0.00 0.00 ","link":"https://tianxiawuhao.github.io/Um55sd5Z3/"},{"title":"CAS/ABA/AtomicReference","content":"é”æ˜¯ç”¨æ¥åšå¹¶å‘æœ€ç®€å•çš„æ–¹å¼ï¼Œå½“ç„¶ä»£ä»·ä¹Ÿæ˜¯æœ€é«˜çš„ã€‚ ç‹¬å é”æ˜¯ä¸€ç§æ‚²è§‚é”ï¼Œsynchronizedå°±æ˜¯ä¸€ç§ç‹¬å é”ï¼›å®ƒå‡è®¾æœ€åçš„æƒ…å†µï¼Œå¹¶ä¸”åªæœ‰åœ¨ç¡®ä¿å…¶å®ƒçº¿ç¨‹ä¸ä¼šé€ æˆå¹²æ‰°çš„æƒ…å†µä¸‹æ‰§è¡Œï¼Œä¼šå¯¼è‡´å…¶å®ƒæ‰€æœ‰éœ€è¦é”çš„çº¿ç¨‹æŒ‚èµ·ç›´åˆ°æŒæœ‰é”çš„çº¿ç¨‹é‡Šæ”¾é”ã€‚ æ‰€è°“ä¹è§‚é”å°±æ˜¯æ¯æ¬¡ä¸åŠ é”,å‡è®¾æ²¡æœ‰å†²çªè€Œå»å®ŒæˆæŸé¡¹æ“ä½œ;å¦‚æœå‘ç”Ÿå†²çªäº†é‚£å°±å»é‡è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚ CAS(Compare And Swap)æ˜¯ä¸€ç§æœ‰åçš„æ— é”ç®—æ³•ã€‚CASç®—æ³•æ˜¯ä¹è§‚é”çš„ä¸€ç§å®ç°ã€‚CASæœ‰3ä¸ªæ“ä½œæ•°ï¼Œå†…å­˜å€¼Vï¼Œæ—§çš„é¢„æœŸå€¼Aï¼Œè¦ä¿®æ”¹çš„æ–°å€¼Bã€‚å½“ä¸”ä»…å½“é¢„æœŸå€¼Aå’Œå†…å­˜å€¼Vç›¸åŒæ—¶ï¼Œå°†å†…å­˜å€¼Vä¿®æ”¹ä¸ºBå¹¶è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚ æ³¨:synchronizedå’ŒReentrantLockéƒ½æ˜¯æ‚²è§‚é”ã€‚ æ³¨:ä»€ä¹ˆæ—¶å€™ä½¿ç”¨æ‚²è§‚é”æ•ˆç‡æ›´é«˜ã€ä»€ä¹ˆä½¿ç”¨ä½¿ç”¨ä¹è§‚é”æ•ˆç‡æ›´é«˜ï¼Œè¦æ ¹æ®å®é™…æƒ…å†µæ¥åˆ¤æ–­é€‰æ‹©ã€‚ æç¤º:atomicä¸­åŒ…ä¸‹çš„ç±»ï¼Œé‡‡ç”¨çš„å³ä¸ºCASä¹è§‚ç®—æ³•ã€‚ ä»¥AtomicIntegerçš„public final int getAndSet(int newValue)æ–¹æ³•ï¼Œè¿›è¡Œç®€å•è¯´æ˜ï¼Œ è¯¥æ–¹æ³•æ˜¯è¿™æ ·çš„: å…¶è°ƒç”¨äº†Unsafeç±»çš„public final int getAndSetInt(Object var1, long var2, int var4)æ–¹æ³•: è€Œè¯¥æ–¹æ³•åˆdo{â€¦}while(â€¦)å¾ªç¯è°ƒç”¨äº†æœ¬åœ°æ–¹æ³•public final native boolean compareAndSwapInt(Object var1, long var2, int var4, int var5); æ³¨:è‡³äºWindows/Linuxä¸‹public final native boolean compareAndSwapInt(Object var1, long var2, int var4, int var5)æœ¬åœ°æ–¹æ³•æ˜¯å¦‚ä½•å®ç°çš„ï¼Œæ¨èé˜…è¯»https://blog.csdn.net/v123411739/article/details/79561458ã€‚ CAS(Compare And Swap)åŸç†ç®€è¿°ï¼š æŸä¸€çº¿ç¨‹æ‰§è¡Œä¸€ä¸ªCASé€»è¾‘(å¦‚ä¸Šå›¾çº¿ç¨‹A),å¦‚æœä¸­é€”æœ‰å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†å…±äº«å˜é‡çš„å€¼(å¦‚:ä¸Šå›¾ä¸­çº¿ç¨‹Aæ‰§è¡Œåˆ°ç¬‘è„¸é‚£ä¸€åˆ»æ—¶),å¯¼è‡´è¿™ä¸ªçº¿ç¨‹çš„CASé€»è¾‘è¿ç®—åå¾—åˆ°çš„å€¼ä¸æœŸæœ›ç»“æœä¸ä¸€è‡´ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹ä¼šå†æ¬¡æ‰§è¡ŒCASé€»è¾‘(è¿™é‡Œæ˜¯ä¸€ä¸ªdo whileå¾ªç¯),ç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚ ABAé—®é¢˜ï¼š å°±æ˜¯è¯´ä¸€ä¸ªçº¿ç¨‹æŠŠæ•°æ®Aå˜ä¸ºäº†Bï¼Œç„¶ååˆé‡æ–°å˜æˆäº†Aã€‚æ­¤æ—¶å¦å¤–ä¸€ä¸ªçº¿ç¨‹è¯»å–çš„æ—¶å€™ï¼Œå‘ç°Aæ²¡æœ‰å˜åŒ–ï¼Œå°±è¯¯ä»¥ä¸ºæ˜¯åŸæ¥çš„é‚£ä¸ªAã€‚è¿™å°±æ˜¯æœ‰åçš„ABAé—®é¢˜ã€‚ æ³¨:æ ¹æ®å®é™…æƒ…å†µï¼Œåˆ¤æ–­æ˜¯å¦å¤„ç†ABAé—®é¢˜ã€‚å¦‚æœABAé—®é¢˜å¹¶ä¸ä¼šå½±å“æˆ‘ä»¬çš„ä¸šåŠ¡ç»“æœï¼Œå¯ä»¥é€‰æ‹©æ€§å¤„ç†æˆ–ä¸å¤„ç†;å¦‚æœ ABAä¼šå½±å“æˆ‘ä»¬çš„ä¸šåŠ¡ç»“æœçš„ï¼Œè¿™æ—¶å°±å¿…é¡»å¤„ç†ABAé—®é¢˜äº†ã€‚ è¿½æ³¨:å¯¹äºAtomicIntegerç­‰,æ²¡æœ‰ä»€ä¹ˆå¯ä¿®æ”¹çš„å±æ€§;ä¸”æˆ‘ä»¬åªåœ¨æ„å…¶ç»“æœå€¼ï¼Œæ‰€ä»¥å¯¹äºè¿™äº›ç±»æ¥è¯´ï¼Œæœ¬èº«å°±ç®—å‘ç”Ÿäº†ABAç°è±¡ï¼Œä¹Ÿä¸ä¼šå¯¹åŸçº¿ç¨‹çš„ç»“æœé€ æˆä»€ä¹ˆå½±å“ã€‚ AtomicReferenceåŸå­åº”ç”¨ç±»ï¼Œå¯ä»¥ä¿è¯ä½ åœ¨ä¿®æ”¹å¯¹è±¡å¼•ç”¨æ—¶çš„çº¿ç¨‹å®‰å…¨æ€§ï¼Œæ¯”è¾ƒæ—¶å¯ä»¥æŒ‰ç…§åç§»é‡è¿›è¡Œ æ€æ ·ä½¿ç”¨AtomicReferenceï¼š AtomicReference&lt;String&gt; ar = new AtomicReference&lt;String&gt;(); ar.set(&quot;hello&quot;); //CASæ“ä½œæ›´æ–° ar.compareAndSet(&quot;hello&quot;, &quot;hello1&quot;); AtomicReferenceçš„æˆå‘˜å˜é‡ï¼š private static final long serialVersionUID = -1848883965231344442L; //unsafeç±»,æä¾›casæ“ä½œçš„åŠŸèƒ½ private static final Unsafe unsafe = Unsafe.getUnsafe(); //valueå˜é‡çš„åç§»åœ°å€,è¯´çš„å°±æ˜¯ä¸‹é¢é‚£ä¸ªvalue,è¿™ä¸ªåç§»åœ°å€åœ¨staticå—é‡Œåˆå§‹åŒ– private static final long valueOffset; //å®é™…ä¼ å…¥éœ€è¦åŸå­æ“ä½œçš„é‚£ä¸ªç±»å®ä¾‹ private volatile V value; ç±»è£…è½½çš„æ—¶å€™åˆå§‹åŒ–åç§»åœ°å€ï¼š static { try { valueOffset = unsafe.objectFieldOffset (AtomicReference.class.getDeclaredField(&quot;value&quot;)); } catch (Exception ex) { throw new Error(ex); } } compareAndSetæ–¹æ³•ï¼š //å°±æ˜¯è°ƒç”¨Unsafeçš„casæ“ä½œ,ä¼ å…¥å¯¹è±¡,expectå€¼,åç§»åœ°å€,éœ€è¦æ›´æ–°çš„å€¼,å³å¯,å¦‚æœæ›´æ–°æˆåŠŸ,è¿”å›true,å¦‚æœå¤±è´¥,è¿”å›false public final boolean compareAndSet(V expect, V update) { return unsafe.compareAndSwapObject(this, valueOffset, expect, update); } å¯¹äºStringå˜é‡æ¥è¯´,å¿…é¡»æ˜¯å¯¹è±¡ç›¸åŒæ‰è§†ä¸ºç›¸åŒ,è€Œä¸æ˜¯å­—ç¬¦ä¸²çš„å†…å®¹ç›¸åŒå°±å¯ä»¥ç›¸åŒ: AtomicReference&lt;String&gt; ar = new AtomicReference&lt;String&gt;(); ar.set(&quot;hello&quot;); System.out.println(ar.compareAndSet(new String(&quot;hello&quot;), &quot;hello1&quot;));//false AtomicReferenceå¯è§£å†³volatileä¸å…·æœ‰åŸå­æ€§i++æ“ä½œ AtomicReferenceå¯ä»¥ä¿è¯ç»“æœæ˜¯æ­£ç¡®çš„. private static volatile Integer num1 = 0; private static AtomicReference&lt;Integer&gt; ar=new AtomicReference&lt;Integer&gt;(num1); public void dfasd111() throws InterruptedException{ for (int i = 0; i &lt; 1000; i++) { new Thread(new Runnable(){ @Override public void run() { for (int i = 0; i &lt; 10000; i++) while(true){ Integer temp=ar.get(); if(ar.compareAndSet(temp, temp+1))break; } } }).start(); } Thread.sleep(10000); System.out.println(ar.get()); //10000000 } ç±»ä¼¼i++è¿™æ ·çš„&quot;è¯»-æ”¹-å†™&quot;å¤åˆæ“ä½œ(åœ¨ä¸€ä¸ªæ“ä½œåºåˆ—ä¸­, åä¸€ä¸ªæ“ä½œä¾èµ–å‰ä¸€æ¬¡æ“ä½œçš„ç»“æœ), åœ¨å¤šçº¿ç¨‹å¹¶å‘å¤„ç†çš„æ—¶å€™ä¼šå‡ºç°é—®é¢˜, å› ä¸ºå¯èƒ½ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å˜é‡, è€Œå¦ä¸€ä¸ªçº¿ç¨‹æ²¡æœ‰å¯Ÿè§‰åˆ°è¿™æ ·å˜åŒ–, å½“ä½¿ç”¨åŸå­å˜é‡ä¹‹å, åˆ™å°†ä¸€ç³»åˆ—çš„å¤åˆæ“ä½œåˆå¹¶ä¸ºä¸€ä¸ªåŸå­æ“ä½œ,ä»è€Œé¿å…è¿™ç§é—®é¢˜, i++=&gt;i.incrementAndGet() è¿™é‡Œçš„compareAndSetæ–¹æ³•å³casæ“ä½œæœ¬èº«æ˜¯åŸå­çš„ï¼Œä½†æ˜¯åœ¨æŸäº›åœºæ™¯ä¸‹ä¼šå‡ºç°å¼‚å¸¸åœºæ™¯ æ­¤å¤„è¯´ä¸€ä¸‹ABAé—®é¢˜ï¼š æ¯”å¦‚ï¼Œæˆ‘ä»¬åªæ˜¯ç®€å•å¾—è¦åšä¸€ä¸ªæ•°å€¼åŠ æ³•ï¼Œå³ä½¿åœ¨æˆ‘å–å¾—æœŸæœ›å€¼åï¼Œè¿™ä¸ªæ•°å­—è¢«ä¸æ–­çš„ä¿®æ”¹ï¼Œåªè¦å®ƒæœ€ç»ˆæ”¹å›äº†æˆ‘çš„æœŸæœ›å€¼ï¼Œæˆ‘çš„åŠ æ³•è®¡ç®—å°±ä¸ä¼šå‡ºé”™ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ä½ ä¿®æ”¹çš„å¯¹è±¡æ²¡æœ‰è¿‡ç¨‹çš„çŠ¶æ€ä¿¡æ¯ï¼Œæ‰€æœ‰çš„ä¿¡æ¯éƒ½åªä¿å­˜äºå¯¹è±¡çš„æ•°å€¼æœ¬èº«ã€‚ ä½†æ˜¯ï¼Œåœ¨ç°å®ä¸­ï¼Œè¿˜å¯èƒ½å­˜åœ¨å¦å¤–ä¸€ç§åœºæ™¯ã€‚å°±æ˜¯æˆ‘ä»¬æ˜¯å¦èƒ½ä¿®æ”¹å¯¹è±¡çš„å€¼ï¼Œä¸ä»…å–å†³äºå½“å‰å€¼ï¼Œè¿˜å’Œå¯¹è±¡çš„è¿‡ç¨‹å˜åŒ–æœ‰å…³ï¼Œè¿™æ—¶ï¼ŒAtomicReferenceå°±æ— èƒ½ä¸ºåŠ›äº†ã€‚ AtomicStampedReferenceä¸AtomicReferenceçš„åŒºåˆ«ï¼š AtomicStampedReferenceå®ƒå†…éƒ¨ä¸ä»…ç»´æŠ¤äº†å¯¹è±¡å€¼ï¼Œè¿˜ç»´æŠ¤äº†ä¸€ä¸ªæ—¶é—´æˆ³ï¼ˆæˆ‘è¿™é‡ŒæŠŠå®ƒç§°ä¸ºæ—¶é—´æˆ³ï¼Œå®é™…ä¸Šå®ƒå¯ä»¥ä½¿ä»»ä½•ä¸€ä¸ªæ•´æ•°ï¼Œå®ƒä½¿ç”¨æ•´æ•°æ¥è¡¨ç¤ºçŠ¶æ€å€¼ï¼‰ã€‚å½“AtomicStampedReferenceå¯¹åº”çš„æ•°å€¼è¢«ä¿®æ”¹æ—¶ï¼Œé™¤äº†æ›´æ–°æ•°æ®æœ¬èº«å¤–ï¼Œè¿˜å¿…é¡»è¦æ›´æ–°æ—¶é—´æˆ³ã€‚å½“AtomicStampedReferenceè®¾ç½®å¯¹è±¡å€¼æ—¶ï¼Œå¯¹è±¡å€¼ä»¥åŠæ—¶é—´æˆ³éƒ½å¿…é¡»æ»¡è¶³æœŸæœ›å€¼ï¼Œå†™å…¥æ‰ä¼šæˆåŠŸã€‚å› æ­¤ï¼Œå³ä½¿å¯¹è±¡å€¼è¢«åå¤è¯»å†™ï¼Œå†™å›åŸå€¼ï¼Œåªè¦æ—¶é—´æˆ³å‘ç”Ÿå˜åŒ–ï¼Œå°±èƒ½é˜²æ­¢ä¸æ°å½“çš„å†™å…¥ã€‚ è§£å†³ABAé—®é¢˜ public static void main(String[] args) { String str1 = &quot;aaa&quot;; String str2 = &quot;bbb&quot;; AtomicStampedReference&lt;String&gt; reference = new AtomicStampedReference&lt;String&gt;(str1,1); reference.compareAndSet(str1,str2,reference.getStamp(),reference.getStamp()+1); System.out.println(&quot;reference.getReference() = &quot; + reference.getReference()); boolean b = reference.attemptStamp(str2, reference.getStamp() + 1); System.out.println(&quot;b: &quot;+b); System.out.println(&quot;reference.getStamp() = &quot;+reference.getStamp()); boolean c = reference.weakCompareAndSet(str2,&quot;ccc&quot;,4, reference.getStamp()+1); System.out.println(&quot;reference.getReference() = &quot;+reference.getReference()); System.out.println(&quot;c = &quot; + c); } è¾“å‡º: reference.getReference() = bbb b: true reference.getStamp() = 3 reference.getReference() = bbb c = false ","link":"https://tianxiawuhao.github.io/2nzKhQbUe/"},{"title":"ä»£ç†æ¨¡å¼","content":"é™æ€ä»£ç†ã€JDKåŠ¨æ€ä»£ç†ä»¥åŠCGLIBåŠ¨æ€ä»£ç† ä»£ç†æ¨¡å¼æ˜¯javaä¸­æœ€å¸¸ç”¨çš„è®¾è®¡æ¨¡å¼ä¹‹ä¸€ï¼Œå°¤å…¶æ˜¯åœ¨springæ¡†æ¶ä¸­å¹¿æ³›åº”ç”¨ã€‚å¯¹äºjavaçš„ä»£ç†æ¨¡å¼ï¼Œä¸€èˆ¬å¯åˆ†ä¸ºï¼šé™æ€ä»£ç†ã€åŠ¨æ€ä»£ç†ã€ä»¥åŠCGLIBå®ç°åŠ¨æ€ä»£ç†ã€‚ å¯¹äºä¸Šè¿°ä¸‰ç§ä»£ç†æ¨¡å¼ï¼Œåˆ†åˆ«è¿›è¡Œè¯´æ˜ã€‚ é™æ€ä»£ç† é™æ€ä»£ç†å…¶å®å°±æ˜¯åœ¨ç¨‹åºè¿è¡Œä¹‹å‰ï¼Œæå‰å†™å¥½è¢«ä»£ç†æ–¹æ³•çš„ä»£ç†ç±»ï¼Œç¼–è¯‘åè¿è¡Œã€‚åœ¨ç¨‹åºè¿è¡Œä¹‹å‰ï¼Œclasså·²ç»å­˜åœ¨ã€‚ ä¸‹é¢æˆ‘ä»¬å®ç°ä¸€ä¸ªé™æ€ä»£ç†demo: å®šä¹‰ä¸€ä¸ªæ¥å£Target package com.test.proxy; public interface Target { public String execute(); } TargetImpl å®ç°æ¥å£Target package com.test.proxy; public class TargetImpl implements Target { @Override public String execute() { System.out.println(&quot;TargetImpl executeï¼&quot;); return &quot;execute&quot;; } } ä»£ç†ç±» package com.test.proxy; public class Proxy implements Target{ private Target target; public Proxy(Target target) { this.target = target; } @Override public String execute() { System.out.println(&quot;perProcess&quot;); String result = this.target.execute(); System.out.println(&quot;postProcess&quot;); return result; } } æµ‹è¯•ç±»: package com.test.proxy; public class ProxyTest { public static void main(String[] args) { Target target = new TargetImpl(); Proxy p = new Proxy(target); String result = p.execute(); System.out.println(result); } } è¿è¡Œç»“æœ: perProcess TargetImpl executeï¼ postProcess execute é™æ€ä»£ç†éœ€è¦é’ˆå¯¹è¢«ä»£ç†çš„æ–¹æ³•æå‰å†™å¥½ä»£ç†ç±»ï¼Œå¦‚æœè¢«ä»£ç†çš„æ–¹æ³•éå¸¸å¤šåˆ™éœ€è¦ç¼–å†™å¾ˆå¤šä»£ç ï¼Œå› æ­¤ï¼Œå¯¹äºä¸Šè¿°ç¼ºç‚¹ï¼Œé€šè¿‡åŠ¨æ€ä»£ç†çš„æ–¹å¼è¿›è¡Œäº†å¼¥è¡¥ã€‚ åŠ¨æ€ä»£ç† jdkä»£ç† åŠ¨æ€ä»£ç†ä¸»è¦æ˜¯é€šè¿‡åå°„æœºåˆ¶ï¼Œåœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆæ‰€éœ€ä»£ç†çš„class. æ¥å£ package com.test.dynamic; public interface Target { public String execute(); } å®ç°ç±» package com.test.dynamic; public class TargetImpl implements Target { @Override public String execute() { System.out.println(&quot;TargetImpl executeï¼&quot;); return &quot;execute&quot;; } } ä»£ç†ç±» package com.test.dynamic; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Method; public class DynamicProxyHandler implements InvocationHandler{ private Target target; public DynamicProxyHandler(Target target) { this.target = target; } @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { System.out.println(&quot;========before==========&quot;); Object result = method.invoke(target,args); System.out.println(&quot;========after===========&quot;); return result; } } æµ‹è¯•ç±» package com.test.dynamic; import java.lang.reflect.Proxy; public class DynamicProxyTest { public static void main(String[] args) { Target target = new TargetImpl(); DynamicProxyHandler handler = new DynamicProxyHandler(target); Target proxySubject = (Target) Proxy.newProxyInstance(TargetImpl.class.getClassLoader(),TargetImpl.class.getInterfaces(),handler); String result = proxySubject.execute(); System.out.println(result); } } è¿è¡Œç»“æœï¼š before== TargetImpl executeï¼ after=== execute æ— è®ºæ˜¯åŠ¨æ€ä»£ç†è¿˜æ˜¯é™æ€å¸¦é¢†ï¼Œéƒ½éœ€è¦å®šä¹‰æ¥å£ï¼Œç„¶åæ‰èƒ½å®ç°ä»£ç†åŠŸèƒ½ã€‚è¿™åŒæ ·å­˜åœ¨å±€é™æ€§ï¼Œå› æ­¤ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå‡ºç°äº†ç¬¬ä¸‰ç§ä»£ç†æ–¹å¼ï¼šcglibä»£ç†ã€‚ cglibä»£ç† CGLibé‡‡ç”¨äº†éå¸¸åº•å±‚çš„å­—èŠ‚ç æŠ€æœ¯ï¼Œå…¶åŸç†æ˜¯é€šè¿‡å­—èŠ‚ç æŠ€æœ¯ä¸ºä¸€ä¸ªç±»åˆ›å»ºå­ç±»ï¼Œå¹¶åœ¨å­ç±»ä¸­é‡‡ç”¨æ–¹æ³•æ‹¦æˆªçš„æŠ€æœ¯æ‹¦æˆªæ‰€æœ‰çˆ¶ç±»æ–¹æ³•çš„è°ƒç”¨ï¼Œé¡ºåŠ¿ç»‡å…¥æ¨ªåˆ‡é€»è¾‘ã€‚JDKåŠ¨æ€ä»£ç†ä¸CGLibåŠ¨æ€ä»£ç†å‡æ˜¯å®ç°Spring AOPçš„åŸºç¡€ã€‚ ç›®æ ‡ç±» package com.test.cglib; public class Target { public String execute() { String message = &quot;-----------test------------&quot;; System.out.println(message); return message; } } é€šç”¨ä»£ç†ç±» package com.test.cglib; import net.sf.cglib.proxy.MethodInterceptor; import net.sf.cglib.proxy.MethodProxy; import java.lang.reflect.Method; public class MyMethodInterceptor implements MethodInterceptor{ @Override public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable { System.out.println(&quot;&gt;&gt;&gt;&gt;MethodInterceptor start...&quot;); Object result = proxy.invokeSuper(obj,args); System.out.println(&quot;&gt;&gt;&gt;&gt;MethodInterceptor ending...&quot;); return &quot;result&quot;; } } æµ‹è¯•ç±» package com.test.cglib; import net.sf.cglib.proxy.Enhancer; public class CglibTest { public static void main(String[] args) { System.out.println(&quot;***************&quot;); Target target = new Target(); CglibTest test = new CglibTest(); Target proxyTarget = (Target) test.createProxy(Target.class); String res = proxyTarget.execute(); System.out.println(res); } public Object createProxy(Class targetClass) { Enhancer enhancer = new Enhancer(); enhancer.setSuperclass(targetClass); enhancer.setCallback(new MyMethodInterceptor()); return enhancer.create(); } } æ‰§è¡Œç»“æœ: MethodInterceptor start... -----------test------------ MethodInterceptor ending... result ä»£ç†å¯¹è±¡çš„ç”Ÿæˆè¿‡ç¨‹ç”±Enhancerç±»å®ç°ï¼Œå¤§æ¦‚æ­¥éª¤å¦‚ä¸‹ï¼š ç”Ÿæˆä»£ç†ç±»Classçš„äºŒè¿›åˆ¶å­—èŠ‚ç ï¼› é€šè¿‡Class.forNameåŠ è½½äºŒè¿›åˆ¶å­—èŠ‚ç ï¼Œç”ŸæˆClasså¯¹è±¡ï¼› é€šè¿‡åå°„æœºåˆ¶è·å–å®ä¾‹æ„é€ ï¼Œå¹¶åˆå§‹åŒ–ä»£ç†ç±»å¯¹è±¡ã€‚ ","link":"https://tianxiawuhao.github.io/CO5c8R39E/"},{"title":"OOM","content":"Stack overflow public class StackOverFlowErrorDemo { public static void main(String[] args) { StackOverFlowError(); } private static void StackOverFlowError() { StackOverFlowError(); } } Exception in thread &quot;main&quot; java.lang.StackOverflowError at com.example.interview.oom.StackOverFlowErrorDemo.StackOverFlowError(StackOverFlowErrorDemo.java:14) é€’å½’è°ƒç”¨è‡ªèº«æ–¹æ³•ï¼Œä¸æ–­å‘æ ˆå†…å‹å…¥æ ˆå¸§ï¼Œç›´åˆ°æ’‘ç ´æ ˆç©ºé—´ï¼Œé‡å¤æ¬¡æ•°ä¸ç¡®å®š OutOfMemoryErrorï¼šJava heap space /** * @author wuhao * @desc -Xmx10m -Xms10m -XX:+PrintGCDetails * æœ€å¤§å †å†…å­˜10M,åˆå§‹å †å†…å­˜10M,æ‰“å°GCè¯¦ç»†ä¿¡æ¯ * @date 2021-09-10 15:14:50 */ public class JavaHeapSpaceDemo { public static void main(String[] args) { // String str= &quot;java&quot;; // while (true){ // str+=str+new Random().nextInt(111111)+new Random().nextInt(121312); // str.intern(); // } //åˆ›å»ºå¤§å¯¹è±¡ byte[] bytes=new byte[20*1024*1024]; } } Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: Java heap space at com.example.interview.oom.JavaHeapSpaceDemo.main(JavaHeapSpaceDemo.java:18) å¸¸é‡æ± ï¼Œå¯¹è±¡ç©ºé—´åœ°å€ä½äºå †ç©ºé—´ä¸­ï¼Œå¾ªç¯ç”ŸæˆStringæˆ–è€…ç”Ÿæˆè¶…å¤§å¯¹è±¡ä¼šå¯¼è‡´å †ç©ºé—´è¢«å æ»¡æº¢å‡º OutOfMemoryErrorï¼šGC overhead limit exceeded /** * @author wuhao * @desc -Xmx20m -Xms10m -XX:+PrintGCDetails * æœ€å¤§å †å†…å­˜20M,åˆå§‹å †å†…å­˜10M,å †å¤–å†…å­˜(ç›´æ¥å†…å­˜)5M,æ‰“å°GCä¿¡æ¯ * GC overhead limit exceeded:è¶…å‡ºGCå¼€é”€é™åˆ¶ * @date 2021-09-10 15:24:48 */ public class GCOverHeadDemo { public static void main(String[] args) { int i=0; List&lt;String&gt; list=new ArrayList&lt;&gt;(); while (true){ list.add(String.valueOf(++i).intern()); } } } [Full GC (Ergonomics) [PSYoungGen: 2560K-&gt;0K(4608K)] [ParOldGen: 13581K-&gt;818K(10752K)] 16141K-&gt;818K(15360K), [Metaspace: 3626K-&gt;3626K(1056768K)], 0.0078165 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] Heap PSYoungGen total 4608K, used 219K [0x00000000ff980000, 0x0000000100000000, 0x0000000100000000) eden space 2560K, 8% used [0x00000000ff980000,0x00000000ff9b6f28,0x00000000ffc00000) from space 2048K, 0% used [0x00000000ffe00000,0x00000000ffe00000,0x0000000100000000) to space 2048K, 0% used [0x00000000ffc00000,0x00000000ffc00000,0x00000000ffe00000) ParOldGen total 10752K, used 818K [0x00000000fec00000, 0x00000000ff680000, 0x00000000ff980000) object space 10752K, 7% used [0x00000000fec00000,0x00000000fecccac0,0x00000000ff680000) Metaspace used 3719K, capacity 4536K, committed 4864K, reserved 1056768K class space used 406K, capacity 428K, committed 512K, reserved 1048576K Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: GC overhead limit exceeded at java.lang.Integer.toString(Integer.java:401) at java.lang.String.valueOf(String.java:3099) at com.example.interview.oom.GCOverHeadDemo.main(GCOverHeadDemo.java:17) æœ€å¤§å †å†…å­˜è¦å¤§äºåˆå§‹å †å†…å­˜ç»™GCåˆ›é€ æ¡ä»¶ï¼Œå¦‚æœä¸¤å€¼ç›¸ç­‰å°±æ²¡æœ‰é‡æ–°åˆ†é…å †ç©ºé—´æ“ä½œä¼šç›´æ¥çˆ†å‡ºJava heap spaceå¼‚å¸¸ OutOfMemoryErrorï¼šDirect buffer memory import java.nio.ByteBuffer; /** * @author wuhao * @desc -Xmx20m -Xms10m -XX:+PrintGCDetails -XX:MaxDirectMemorySize=5m * æœ€å¤§å †å†…å­˜20M,åˆå§‹å †å†…å­˜10M,å †å¤–å†…å­˜(ç›´æ¥å†…å­˜)5M,æ‰“å°GCä¿¡æ¯ * @date 2021-09-10 15:38:57 */ public class DirectBufferMemoryDemo { public static void main(String[] args) { System.out.println(&quot;é…ç½®çš„DirectMemory&quot;+(sun.misc.VM.maxDirectMemory()/(double)1024/1024)+&quot;mb&quot;); ByteBuffer bf=ByteBuffer.allocateDirect(6*1024*1024); } } [GC (Allocation Failure) [PSYoungGen: 2048K-&gt;504K(2560K)] 2048K-&gt;758K(9728K), 0.0008256 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] é…ç½®çš„DirectMemory5.0mb [GC (System.gc()) [PSYoungGen: 908K-&gt;504K(2560K)] 1162K-&gt;862K(9728K), 0.0009251 secs] [Times: user=0.06 sys=0.00, real=0.00 secs] [Full GC (System.gc()) [PSYoungGen: 504K-&gt;0K(2560K)] [ParOldGen: 358K-&gt;801K(7168K)] 862K-&gt;801K(9728K), [Metaspace: 3500K-&gt;3500K(1056768K)], 0.0046698 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: Direct buffer memory at java.nio.Bits.reserveMemory(Bits.java:694) at java.nio.DirectByteBuffer.&lt;init&gt;(DirectByteBuffer.java:123) at java.nio.ByteBuffer.allocateDirect(ByteBuffer.java:311) at com.example.interview.oom.DirectBufferMemoryDemo.main(DirectBufferMemoryDemo.java:13) Heap PSYoungGen total 2560K, used 1068K [0x00000000ff980000, 0x00000000ffc80000, 0x0000000100000000) eden space 2048K, 52% used [0x00000000ff980000,0x00000000ffa8b200,0x00000000ffb80000) from space 512K, 0% used [0x00000000ffc00000,0x00000000ffc00000,0x00000000ffc80000) to space 512K, 0% used [0x00000000ffb80000,0x00000000ffb80000,0x00000000ffc00000) ParOldGen total 7168K, used 801K [0x00000000fec00000, 0x00000000ff300000, 0x00000000ff980000) object space 7168K, 11% used [0x00000000fec00000,0x00000000fecc86d0,0x00000000ff300000) Metaspace used 4057K, capacity 4568K, committed 4864K, reserved 1056768K class space used 446K, capacity 460K, committed 512K, reserved 1048576K allocateDirectåˆ†é…çš„å­—èŠ‚ç¼“å†²åŒºç”¨ä¸­æ–‡å«åšç›´æ¥ç¼“å†²åŒºï¼ˆDirectByteBufferï¼‰ï¼Œç”¨allocateåˆ†é…çš„ByteBufferå«åšå †å­—èŠ‚ç¼“å†²åŒº(HeapByteBuffer).. å…¶å®æ ¹æ®ç±»åå°±å¯ä»¥çœ‹å‡ºï¼ŒHeapByteBufferæ‰€åˆ›å»ºçš„å­—èŠ‚ç¼“å†²åŒºå°±æ˜¯åœ¨jvmå †ä¸­çš„ï¼Œå³å†…éƒ¨æ‰€ç»´æŠ¤çš„javaå­—èŠ‚æ•°ç»„ã€‚è€ŒDirectByteBufferæ˜¯ç›´æ¥æ“ä½œæ“ä½œç³»ç»Ÿæœ¬åœ°ä»£ç åˆ›å»ºçš„å†…å­˜ç¼“å†²æ•°ç»„ï¼ˆcã€c++çš„æ•°ç»„ï¼‰ã€‚ HeapByteBufferåº•å±‚å…¶å®æ˜¯javaçš„å­—èŠ‚æ•°ç»„ï¼Œè€Œjavaå­—èŠ‚æ•°ç»„æ˜¯ä¸€ä¸ªjavaå¯¹è±¡ï¼Œå¯¹è±¡çš„å†…å­˜æ˜¯ç”±jvmçš„å †è¿›è¡Œç®¡ç†çš„ï¼Œé‚£ä¹ˆä¸å¯é¿å…çš„æ˜¯GCæ—¶å¹´è½»ä»£çš„edenã€suvivoråˆ°è€å¹´ä»£çš„å„ç§å¤åˆ¶ä»¥åŠå›æ”¶ã€‚ã€‚ã€‚å½“å­—èŠ‚æ•°ç»„æ¯”è¾ƒå°çš„æ—¶å€™è¿˜å¥½è¯´ï¼Œå¦‚æœæ˜¯å¤§å¯¹è±¡ï¼Œé‚£ä¹ˆå¯¹äºjvmçš„GCæ¥è¯´æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„è´Ÿæ‹…ã€‚ã€‚è€Œä½¿ç”¨DirectByteBufferï¼Œåˆ™æ˜¯æŠŠå­—èŠ‚æ•°ç»„äº¤ç»™æ“ä½œç³»ç»Ÿç®¡ç†ï¼ˆå †å¤–å†…å­˜ï¼‰ OutOfMemoryErrorï¼šUnable to create to native thread public class UnableToCreateToNativeThreadDemo { public static void main(String[] args) { for (int i = 0; ; i++) { System.out.println(&quot;================ i=&quot; + i); new Thread(() -&gt; { try { Thread.sleep(Integer.MAX_VALUE); } catch (InterruptedException e) { e.printStackTrace(); } }, &quot;&quot; + i).start(); } } } linuxä¸€èˆ¬ç”¨æˆ·å¯ä»¥æœ€å¤§åˆ›å»º1024ä¸ªçº¿ç¨‹ï¼Œä¸è¦åœ¨ç”µè„‘ä¸Šéšæ„å°è¯• meta space /** * @author wuhao * @desc -XX:MetaspaceSize=8m -XX:MaxMetaspaceSize=8m -XX:+PrintGCDetails * @date 2021-09-13 10:36:15 */ public class MetaSpaceOOMDemo { static class OOMTest{ } public static void main(String[] args) { int i=0; try { while (true){ i++; Enhancer enhancer=new Enhancer(); enhancer.setSuperclass(OOMTest.class); enhancer.setUseCache(false); enhancer.setCallback(new MethodInterceptor() { @Override public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable { return methodProxy.invokeSuper(o,args); } }); enhancer.create(); } }catch (Throwable e){ System.out.println(&quot;=========&quot;+i+&quot;æ¬¡åå‘ç”Ÿäº†å¼‚å¸¸&quot;); } } } [Full GC (Last ditch collection) [PSYoungGen: 0K-&gt;0K(116224K)] [ParOldGen: 2016K-&gt;2016K(225792K)] 2016K-&gt;2016K(342016K), [Metaspace: 9911K-&gt;9911K(1058816K)], 0.0093402 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] Heap PSYoungGen total 116224K, used 3425K [0x00000000d6400000, 0x00000000de400000, 0x0000000100000000) eden space 115712K, 2% used [0x00000000d6400000,0x00000000d67584a0,0x00000000dd500000) from space 512K, 0% used [0x00000000de380000,0x00000000de380000,0x00000000de400000) to space 5120K, 0% used [0x00000000dda00000,0x00000000dda00000,0x00000000ddf00000) ParOldGen total 225792K, used 2016K [0x0000000082c00000, 0x0000000090880000, 0x00000000d6400000) object space 225792K, 0% used [0x0000000082c00000,0x0000000082df8128,0x0000000090880000) Metaspace used 9942K, capacity 10090K, committed 10240K, reserved 1058816K class space used 884K, capacity 913K, committed 1024K, reserved 1048576K Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: Metaspace ","link":"https://tianxiawuhao.github.io/QvbaHSogu/"},{"title":"ç±»åŠ è½½","content":"ç±»åŠ è½½è¿‡ç¨‹ åœ¨javaä¸­ç¼–è¯‘å¹¶ä¸è¿›è¡Œé“¾æ¥å·¥ä½œï¼Œç±»å‹çš„åŠ è½½ã€é“¾æ¥å’Œåˆå§‹åŒ–å·¥ä½œéƒ½æ˜¯åœ¨jvmæ‰§è¡Œè¿‡ç¨‹ä¸­è¿›è¡Œçš„ã€‚åœ¨Javaç¨‹åºå¯åŠ¨æ—¶ï¼Œjvmé€šè¿‡åŠ è½½æŒ‡å®šçš„ç±»ï¼Œç„¶åè°ƒç”¨è¯¥ç±»çš„mainæ–¹æ³•è€Œå¯åŠ¨ã€‚åœ¨JVMå¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œ å¤–éƒ¨classå­—èŠ‚ç æ–‡ä»¶ä¼šç»è¿‡ä¸€ç³»åˆ—è¿‡ç¨‹è½¬åŒ–ä¸ºJVMä¸­æ‰§è¡Œçš„æ•°æ®ï¼Œè¿™ä¸€ç³»åˆ—è¿‡ç¨‹æˆ‘ä»¬ç§°ä¸ºç±»åŠ è½½è¿‡ç¨‹ã€‚ ç±»åŠ è½½æ•´ä½“æµç¨‹ ä»ç±»è¢«JVMåŠ è½½åˆ°å†…å­˜å¼€å§‹åˆ°å¸è½½å‡ºå†…å­˜ä¸ºæ­¢ï¼Œæ•´ä¸ªç”Ÿå‘½å‘¨æœŸåŒ…æ‹¬ï¼šåŠ è½½ã€é“¾æ¥ã€åˆå§‹åŒ–ã€ä½¿ç”¨å’Œå¸è½½äº”ä¸ªè¿‡ç¨‹ã€‚å…¶ä¸­é“¾æ¥åˆåŒ…æ‹¬éªŒè¯ã€å‡†å¤‡å’Œè§£æä¸‰ä¸ªè¿‡ç¨‹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ç±»åŠ è½½æ—¶æœº javaè™šæ‹Ÿæœºè§„èŒƒé€šè¿‡å¯¹åˆå§‹åŒ–é˜¶æ®µè¿›è¡Œä¸¥æ ¼è§„å®šï¼Œæ¥ä¿è¯åˆå§‹åŒ–çš„å®Œæˆï¼Œè€Œä½œä¸ºå…¶ä¹‹å‰çš„å¿…é¡»å¯åŠ¨çš„è¿‡ç¨‹ï¼ŒåŠ è½½ã€éªŒè¯ã€å‡†å¤‡ä¹Ÿéœ€è¦åœ¨æ­¤ä¹‹å‰å¼€å§‹ã€‚ Javaè™šæ‹Ÿæœºè§„å®šï¼Œä»¥ä¸‹äº”ç§æƒ…å†µå¿…é¡»å¯¹ç±»è¿›è¡Œåˆå§‹åŒ–ï¼š è™šæ‹Ÿæœºåœ¨ç”¨æˆ·æŒ‡å®šåŒ…å«mainæ–¹æ³•çš„ä¸»ç±»åå¯åŠ¨æ—¶ï¼Œå¿…é¡»å…ˆå¯¹ä¸»ç±»è¿›è¡Œåˆå§‹åŒ–ã€‚ å½“ä½¿ç”¨newå…³é”®å­—å¯¹ç±»è¿›è¡Œå®ä¾‹åŒ–æ—¶ã€è¯»å–æˆ–è€…å†™å…¥ç±»çš„é™æ€å­—æ®µæ—¶ã€è°ƒç”¨ç±»çš„é™æ€æ–¹æ³•æ—¶ï¼Œå¿…é¡»å…ˆè§¦å‘å¯¹è¯¥ç±»çš„å®ä¾‹åŒ–ã€‚ ä½¿ç”¨åå°„å¯¹ç±»è¿›è¡Œåå°„è°ƒç”¨æ—¶ï¼Œå¦‚æœè¯¥ç±»æ²¡æœ‰åˆå§‹åŒ–å…ˆå¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ã€‚ åˆå§‹åŒ–ä¸€ä¸ªç±»ï¼Œè€Œè¯¥ç±»çš„çˆ¶ç±»è¿˜æœªåˆå§‹åŒ–ï¼Œéœ€è¦å…ˆå¯¹å…¶çˆ¶ç±»è¿›è¡Œåˆå§‹åŒ–ã€‚ åœ¨JDK1.7ä¹‹åçš„ç‰ˆæœ¬ä¸­ä½¿ç”¨åŠ¨æ€è¯­è¨€æ”¯æŒï¼Œjava.lang.invoke.MethodHandleå®ä¾‹è§£æçš„ç»“æœæ˜¯REF_getStaticã€REF_putStaticã€REF_invokeStaticçš„æ–¹æ³•å¥æŸ„ï¼Œè€Œè¯¥å¥æŸ„å¯¹åº”çš„ç±» è¿˜æœªåˆå§‹åŒ–ï¼Œå¿…é¡»å…ˆè§¦å‘å…¶å®ä¾‹åŒ–ã€‚ åŠ è½½ åœ¨åŠ è½½é˜¶æ®µï¼Œè™šæ‹Ÿæœºéœ€è¦å®Œæˆä¸‰ä»¶äº‹ï¼š é€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåæ¥è·å–æ­¤ç±»çš„classå­—èŠ‚ç äºŒè¿›åˆ¶æµã€‚ å°†è¿™ä¸ªå­—èŠ‚ç äºŒè¿›åˆ¶æµä¸­çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºä¸­çš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ã€‚ åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¯¥ç±»çš„java.lang.Classå¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºä¸­è¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£ã€‚ å¯¹äºClasså¯¹è±¡ï¼ŒJavaè™šæ‹Ÿæœºè§„èŒƒå¹¶æ²¡æœ‰è§„å®šè¦å­˜å‚¨åœ¨å †ä¸­ï¼ŒHotSpotè™šæ‹Ÿæœºå°†å…¶å­˜æ”¾åœ¨æ–¹æ³•åŒºä¸­ã€‚ éªŒè¯ éªŒè¯ä½œä¸ºé“¾æ¥çš„ç¬¬ä¸€æ­¥ï¼Œå¤§è‡´ä¼šå®Œæˆå››ä¸ªé˜¶æ®µçš„æ£€éªŒï¼š æ–‡ä»¶æ ¼å¼éªŒè¯ï¼šè¯¥é˜¶æ®µä¸»è¦åœ¨å­—èŠ‚æµè½¬åŒ–ä¸ºæ–¹æ³•åŒºä¸­çš„è¿è¡Œæ—¶æ•°æ®æ—¶ï¼Œè´Ÿè´£æ£€æŸ¥å­—èŠ‚æµæ˜¯å¦ç¬¦åˆClassæ–‡ä»¶è§„èŒƒï¼Œä¿è¯å…¶å¯ä»¥æ­£ç¡®çš„è¢«è§£æå¹¶å­˜å‚¨åœ¨æ–¹æ³•åŒºä¸­ã€‚åé¢çš„æ£€æŸ¥éƒ½æ˜¯åŸºäºæ–¹æ³•åŒºçš„ å­˜å‚¨ç»“æ„è¿›è¡Œæ£€éªŒï¼Œä¸ä¼šå†ç›´æ¥æ“ä½œå­—èŠ‚æµã€‚ å…ƒæ•°æ®éªŒè¯ï¼šè¯¥é˜¶æ®µè´Ÿè´£åˆ†æå­˜å‚¨äºæ–¹æ³•åŒºçš„ç»“æ„æ˜¯å¦ç¬¦åˆJavaè¯­è¨€è§„èŒƒã€‚æ­¤é˜¶æ®µè¿›è¡Œæ•°æ®ç±»å‹çš„æ ¡éªŒï¼Œä¿è¯ç¬¦åˆä¸å­˜åœ¨éæ³•çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚ å­—èŠ‚ç éªŒè¯ï¼šå…ƒæ•°æ®éªŒè¯ä¿è¯äº†å­—èŠ‚ç ä¸­çš„æ•°æ®ç¬¦åˆè¯­è¨€çš„è§„èŒƒï¼Œè¯¥é˜¶æ®µåˆ™è´Ÿè´£åˆ†ææ•°æ®æµå’Œæ§åˆ¶æµï¼Œç¡®å®šæ–¹æ³•ä½“çš„åˆæ³•æ€§ï¼Œä¿è¯è¢«æ ¡éªŒçš„æ–¹æ³•åœ¨è¿è¡Œæ—¶ä¸ä¼šå±å®³è™šæ‹Ÿæœºçš„è¿è¡Œã€‚ ç¬¦å·å¼•ç”¨éªŒè¯ï¼šåœ¨è§£æé˜¶æ®µä¼šå°†è™šæ‹Ÿæœºä¸­çš„ç¬¦å·å¼•ç”¨è½¬åŒ–ä¸ºç›´æ¥å¼•ç”¨ï¼Œè¯¥é˜¶æ®µåˆ™è´Ÿè´£å¯¹å„ç§ç¬¦å·å¼•ç”¨è¿›è¡ŒåŒ¹é…æ€§æ ¡éªŒï¼Œä¿è¯å¤–éƒ¨ä¾èµ–çœŸå®å­˜åœ¨ï¼Œå¹¶ä¸”ç¬¦åˆå¤–éƒ¨ä¾èµ–ç±»ã€å­—æ®µã€æ–¹æ³•çš„è®¿é—®æ€§ã€‚ å‡†å¤‡ å‡†å¤‡é˜¶æ®µæ­£å¼ä¸ºç±»çš„å­—æ®µå˜é‡ï¼ˆè¢«staticä¿®é¥°çš„ç±»å˜é‡ï¼‰åˆ†é…å†…å­˜å¹¶è®¾ç½®åˆå§‹å€¼ã€‚è¿™äº›å˜é‡å­˜å‚¨åœ¨æ–¹æ³•åŒºä¸­ã€‚å½“ç±»å­—æ®µä¸ºå¸¸é‡ç±»å‹ï¼ˆå³è¢«static finalä¿®é¥°ï¼‰ï¼Œç”±äºå­—æ®µçš„å€¼å·²ç»ç¡®å®šï¼Œå¹¶ä¸ä¼šåœ¨åé¢ä¿®æ”¹ï¼Œæ­¤æ—¶ä¼šç›´æ¥èµ‹å€¼ä¸ºæŒ‡å®šçš„å€¼ã€‚ è§£æ è§£æé˜¶æ®µå°†å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨ã€‚åœ¨å­—èŠ‚ç æ–‡ä»¶ä¸­ï¼Œç±»ã€æ¥å£ã€å­—æ®µã€æ–¹æ³•ç­‰ç±»å‹éƒ½æ˜¯ç”±ä¸€ç»„ç¬¦å·æ¥è¡¨ç¤ºã€‚å…¶å½¢å¼ç”±javaè™šæ‹Ÿæœºè§„èŒƒä¸­çš„Classæ–‡ä»¶æ ¼å¼å®šä¹‰ã€‚åœ¨è™šæ‹Ÿæœºæ‰§è¡Œ æŒ‡å®šæŒ‡ä»¤ä¹‹å‰ï¼Œéœ€è¦å°†ç¬¦å·å¼•ç”¨è½¬åŒ–ä¸ºç›®æ ‡çš„æŒ‡é’ˆã€ç›¸å¯¹åç§»é‡æˆ–è€…å¥æŸ„ï¼Œè¿™æ ·å¯ä»¥é€šè¿‡æ­¤ç±»ç›´æ¥å¼•ç”¨åœ¨å†…å­˜ä¸­å®šä½è°ƒç”¨çš„å…·ä½“ä½ç½®ã€‚ åˆå§‹åŒ– åœ¨ç±»çš„classæ–‡ä»¶ä¸­ã€‚åŒ…å«ä¸¤ä¸ªç‰¹æ®Šçš„æ–¹æ³•ï¼šclinitå’Œinitï¼Œè¿™ä¸¤æ–¹æ³•ç”±ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆï¼Œåˆ†åˆ«ä»£è¡¨ç±»æ„é€ å™¨å’Œæ„é€ å‡½æ•°ï¼Œå…¶ä¸­æ„é€ å‡½æ•°ç¼–ç¨‹å®ç°ï¼Œåˆå§‹åŒ–é˜¶æ®µå°±æ˜¯è´Ÿè´£è°ƒç”¨ç±»æ„é€ å™¨ï¼Œæ¥åˆå§‹åŒ– å˜é‡å’Œèµ„æºã€‚ clinitæ–¹æ³•ç”±ç¼–è¯‘å™¨è‡ªåŠ¨æ”¶é›†ç±»çš„èµ‹å€¼åŠ¨ä½œå’Œé™æ€è¯­å¥å—ï¼ˆstaticï¼‰ä¸­çš„è¯­å¥åˆå¹¶ç”Ÿæˆçš„ï¼Œæœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š ç¼–è¯‘å™¨æ”¶é›†é¡ºåºåˆä»£ç é¡ºåºå†³å®šï¼Œé™æ€è¯­å¥å—åªèƒ½è®¿é—®å®ƒä¹‹å‰å®šä¹‰çš„å˜é‡ï¼Œåœ¨å®ƒä¹‹åå®šä¹‰çš„å˜é‡åªèƒ½è¿›è¡Œèµ‹å€¼ä¸èƒ½è®¿é—®ã€‚ è™šæ‹Ÿæœºä¿è¯åœ¨å­ç±»çš„clinitæ–¹æ³•æ‰§è¡Œå‰ï¼Œçˆ¶ç±»çš„clinitå·²ç»æ‰§è¡Œå®Œæ¯•ã€‚ clinitä¸æ˜¯å¿…é¡»çš„ï¼Œå¦‚æœä¸€ä¸ªç±»æˆ–æ¥å£æ²¡æœ‰å˜é‡èµ‹å€¼å’Œé™æ€ä»£ç å—ï¼Œåˆ™ç¼–è¯‘å™¨å¯ä»¥ä¸ç”Ÿæˆclinitã€‚ è™šæ‹Ÿæœºä¼šä¿è¯clinitæ–¹æ³•åœ¨å¤šçº¿ç¨‹ä¸­è¢«æ­£ç¡®çš„åŠ é”å’ŒåŒæ­¥ã€‚å¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶åˆå§‹åŒ–ä¸€ä¸ªç±»ï¼Œé‚£ä¹ˆåªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œclinitï¼Œå…¶ä»–çº¿ç¨‹ä¼šè¢«é˜»å¡ã€‚ åŒäº²å§”æ´¾æ¨¡å‹ ç±»åŠ è½½å™¨ å®šä¹‰ï¼šå®ç°ç±»åŠ è½½é˜¶æ®µçš„â€œé€šè¿‡ä¸€ä¸ªé‡Œçš„å…¨é™å®šåæ¥è·å–æè¿°æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµâ€çš„åŠ¨ä½œçš„ä»£ç æ¨¡å—æˆä¸ºâ€œç±»åŠ è½½å™¨â€ã€‚å¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œéƒ½éœ€è¦ç”±åŠ è½½å®ƒçš„ç±»åŠ è½½å™¨å’Œè¿™ä¸ªç±»æœ¬èº«ä¸€åŒç¡®ç«‹å…¶åœ¨javaè™šæ‹Ÿæœºä¸­çš„å”¯ä¸€æ€§ï¼Œæ¯ä¸€ä¸ªç±»åŠ è½½å™¨ï¼Œéƒ½æ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç±»åç§°ç©ºé—´ã€‚æ¯”è¾ƒä¸¤ä¸ªç±»æ˜¯å¦â€œç›¸ç­‰â€ï¼Œåªæœ‰åœ¨è¿™ä¸¤ä¸ªç±»æ˜¯åŒä¸€ä¸ªç±»åŠ è½½å™¨åŠ è½½çš„å‰æä¸‹æ‰æœ‰æ„ä¹‰ã€‚ ç±»åŠ è½½å™¨ç§ç±» ä»Javaè™šæ‹Ÿæœºçš„è§’åº¦åªæœ‰ä¸¤ç§ç±»åŠ è½½å™¨ï¼š ï¼ˆ1ï¼‰å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootStrap ClassLoaderï¼‰ï¼Œè¿™ä¸ªç±»åŠ è½½å™¨ä½¿ç”¨C++è¯­è¨€å®ç°ï¼Œæ˜¯è™šæ‹Ÿæœºè‡ªèº«çš„ä¸€éƒ¨åˆ†ã€‚ ï¼ˆ2ï¼‰å¦ä¸€ç§å°±æ˜¯æ‰€æœ‰å…¶ä»–ç±»çš„åŠ è½½å™¨ï¼Œè¿™äº›ç±»åŠ è½½å™¨éƒ½æ˜¯ç”±Javaè¯­è¨€å®ç°ï¼Œç‹¬ç«‹äºè™šæ‹Ÿæœºå¤–éƒ¨ï¼Œå¹¶ä¸”éƒ½ç»§æ‰¿è‡ªæŠ½è±¡ç±»java.lang.ClassLoaderã€‚ ä»Javaå¼€å‘äººå‘˜çš„è§’åº¦ï¼Œç±»åŠ è½½å™¨è¿˜å¯åˆ†ä¸º3ç§ç³»ç»Ÿæä¾›çš„ç±»åŠ è½½å™¨å’Œç”¨æˆ·è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ã€‚ ï¼ˆ1ï¼‰å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootStrap ClassLoaderï¼‰ï¼šè´Ÿè´£åŠ è½½å­˜æ”¾java_home\\libç›®å½•ä¸­çš„ï¼Œæˆ–è€…è¢«-Xbootclasspathå‚æ•°æ‰€æŒ‡å®šçš„è·¯å¾„ä¸­çš„ç±»ã€‚ ï¼ˆ2ï¼‰æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension ClassLoaderï¼‰ï¼šè¿™ä¸ªåŠ è½½å™¨sun.misc.Launcher ExtClassLoaderå®ç°ï¼Œå®ƒè´Ÿè´£åŠ è½½java_home\\lib\\extç›®å½•ä¸­çš„ï¼Œæˆ–è€…è¢«java.ext.dirsç³»ç»Ÿå˜é‡æ‰€æŒ‡å®šçš„è·¯å¾„ä¸­çš„æ‰€æœ‰ç±»åº“ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨æ‰©å±•ç±»åŠ è½½å™¨ã€‚ å¦‚æœåº”ç”¨ç¨‹åºä¸­æ²¡æœ‰è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ è¿™ä¸ªå°±æ˜¯ç¨‹åºä¸­é»˜è®¤çš„ç±»åŠ è½½å™¨ã€‚ ï¼ˆ3ï¼‰è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼ˆUser ClassLoaderï¼‰ï¼šç”¨æˆ·è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ã€‚ç”¨æˆ·åœ¨ç¼–å†™è‡ªå·±å®šä¹‰çš„ç±»åŠ è½½å™¨æ—¶ï¼Œå¦‚æœéœ€è¦æŠŠè¯·æ±‚å§”æ´¾ç»™å¼•å¯¼ç±»åŠ è½½å™¨ï¼Œé‚£ç›´æ¥ä½¿ç”¨nummä»£æ›¿å³å¯ã€‚è¦åˆ›å»ºç”¨æˆ·è‡ªå·± çš„ç±»åŠ è½½å™¨ï¼Œåªéœ€è¦ç»§æ‰¿java.lang.ClassLoaderï¼Œç„¶åè¦†ç›–å®ƒçš„findClass(String name)æ–¹æ³•å³å¯ã€‚å¦‚æœè¦ç¬¦åˆåŒäº²å§”æ´¾æ¨¡å‹ï¼Œåˆ™é‡å†™findClass()æ–¹æ³•ã€‚å¦‚æœè¦ç ´åçš„è¯ï¼Œåˆ™é‡å†™ loadClass()æ–¹æ³•ã€‚ åŒäº²å§”æ´¾æ¨¡å‹ ä¸Šå›¾å±•ç¤ºçš„ç±»åŠ è½½å™¨ä¹‹é—´çš„è¿™ç§å±‚æ¬¡å…³ç³»ç§°ä¸ºç±»åŠ è½½å™¨çš„åŒäº²å§”æ´¾æ¨¡å‹ã€‚ åŒäº²å§”æ´¾æ¨¡å‹è¦æ±‚é™¤äº†é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ä¹‹å¤–ï¼Œå…¶ä½™çš„ç±»åŠ è½½å™¨éƒ½åº”å½“æœ‰è‡ªå·±çš„çˆ¶ç±»åŠ è½½å™¨ã€‚ ç±»åŠ è½½å™¨çš„åŒäº²å§”æ´¾æ¨¡å‹åœ¨jdk1.2è¢«å¼•å…¥ï¼Œä½†å®ƒä¸æ˜¯ä¸€ä¸ªå¼ºåˆ¶æ€§çš„çº¦æŸæ¨¡å‹ï¼Œè€Œæ˜¯Javaè®¾è®¡è€…æ¨èç»™å¼€å‘è€…çš„ä¸€ç§ç±»åŠ è½½å™¨çš„å®ç°æ–¹å¼ã€‚ åŒäº²å§”æ´¾æ¨¡å‹çš„å·¥ä½œè¿‡ç¨‹å¦‚ä¸‹ï¼š å½“ä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°æŸä¸ªç±»çš„åŠ è½½è¯·æ±‚æ—¶ï¼Œè¯¥ç±»åŠ è½½å™¨ä¸ä¼šå»åŠ è½½è¯¥ç±»ï¼Œè€Œæ˜¯å…ˆæŸ¥çœ‹è¯¥ç±»åŠ è½½å™¨çš„ç¼“å­˜ç©ºé—´æ˜¯å¦å·²ç»åŠ è½½äº†è¯¥ç±»ï¼Œå¦‚æœå·²ç»åŠ è½½è¿‡äº†å°±ç›´æ¥è¿”å›ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™å§”æ‰˜ç»™çˆ¶äº²åŠ è½½å™¨å»åŠ è½½ï¼ˆä¹Ÿæ˜¯å…ˆæŸ¥çœ‹çˆ¶äº²åŠ è½½å™¨çš„ç¼“å­˜ç©ºé—´æ˜¯å¦å·²ç»åŠ è½½è¿‡è¯¥ç±»ï¼Œå¦‚æœå·²åŠ è½½åˆ™ç›´æ¥è¿”å›ï¼‰ï¼Œæ¯ä¸€å±‚éƒ½æ˜¯å¦‚æ­¤ï¼Œå¦‚æœç¼“å­˜ç©ºé—´ä¸­éƒ½æ²¡æœ‰åŠ è½½è¿‡è¯¥ç±»çš„è®°å½•ï¼Œæœ€ç»ˆç±»åŠ è½½çš„è¯·æ±‚å°±ä¼šä¼ é€åˆ°é¡¶ç«¯çš„å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œå¦‚æœå¯åŠ¨ç±»åŠ è½½å™¨ä¸èƒ½åŠ è½½è¯¥ç±»ï¼Œåˆ™è¿”å›ç»™æ‹“å±•ç±»åŠ è½½å™¨ï¼ˆå„¿å­ï¼‰å»å°è¯•åŠ è½½ï¼Œå¦‚æœè¿˜æ˜¯ä¸èƒ½åŠ è½½ï¼Œåˆ™å†åˆ°åº”ç”¨ç±»åŠ è½½å™¨ï¼Œå†åˆ°è‡ªå®šä¹‰åŠ è½½å™¨åŠ è½½ å¯¹è±¡çš„åˆ›å»ºã€å­˜å‚¨å’Œè®¿é—® å¯¹è±¡çš„åˆ›å»º ç±»åŠ è½½æ£€æŸ¥ï¼šè™šæ‹Ÿæœºé‡åˆ°ä¸€æ¡newæŒ‡ä»¤ï¼Œé¦–å…ˆæ£€æŸ¥è¿™ä¸ªæŒ‡ä»¤çš„å‚æ•°æ˜¯å¦èƒ½åœ¨å¸¸é‡æ± ä¸­ï¼ˆClassæ–‡ä»¶çš„é™æ€å¸¸é‡æ± ï¼‰å®šä½åˆ°è¿™ä¸ªç±»çš„ç¬¦å·å¼•ç”¨ï¼Œå¹¶ä¸”æ£€æŸ¥è¿™ä¸ªç¬¦å·å¼•ç”¨ä»£è¡¨çš„ç±»æ˜¯å¦ å·²ç»è¢«åŠ è½½ã€è§£æå’Œåˆå§‹åŒ–è¿‡ã€‚å¦‚æœæ²¡æœ‰ï¼Œé‚£å¿…é¡»å…ˆæ‰§è¡Œç›¸åº”çš„ç±»åŠ è½½è¿‡ç¨‹ã€‚ åˆ†é…å†…å­˜ï¼šå¯¹è±¡æ‰€éœ€å†…å­˜å¤§å°åœ¨ç±»åŠ è½½å®Œæˆåä¾¿å¯å®Œå…¨ç¡®å®šï¼Œä¸ºå¯¹è±¡åˆ†é…ç©ºé—´çš„ä»»åŠ¡ç­‰åŒäºæŠŠä¸€å—ç¡®å®šå¤§å°çš„å†…å­˜ä»Javaå †ä¸­åˆ’åˆ†å‡ºæ¥ã€‚ä½†æ˜¯ä¸åŒåƒåœ¾å›æ”¶å™¨çš„ç®—æ³•ä¼šå¯¼è‡´å †å†…å­˜å­˜åœ¨ä¸¤ç§æƒ…å†µï¼šç»å¯¹è§„æ•´å’Œç›¸äº’äº¤é”™ã€‚ï¼ˆæ¯”å¦‚æ ‡è®°æ¸…æ¥šç®—æ³•å’Œæ ‡è®°æ•´ç†ç®—æ³•ï¼‰ ï¼ˆ1ï¼‰æŒ‡é’ˆç¢°æ’ï¼šå‡è®¾Javaå †å†…å­˜æ˜¯ç»å¯¹è§„æ•´çš„ï¼Œæ‰€æœ‰ç”¨è¿‡çš„å†…å­˜éƒ½å­˜æ”¾åœ¨ä¸€èµ·ï¼Œç©ºé—²çš„å†…å­˜å­˜æ”¾åœ¨å¦ä¸€è¾¹ï¼Œä¸­é—´æ”¾ç€ä¸€ä¸ªæŒ‡ç¤ºå™¨ä½œä¸ºåˆ†ç•Œç‚¹çš„æŒ‡ç¤ºå™¨ï¼Œæ‰€åˆ†é…çš„å†…å­˜å°±ä»…ä»…æ˜¯æŠŠé‚£ä¸ªæŒ‡é’ˆå‘ç©ºé—²ç©ºé—´é‚£è¾¹æŒªåŠ¨ä¸€æ®µä¸å¯¹è±¡å¤§å°ç›¸ç­‰çš„è·ç¦»ï¼Œè¿™ç§åˆ†é…æ–¹å¼æˆä¸ºâ€æŒ‡é’ˆç¢°æ’â€œã€‚ ï¼ˆ2ï¼‰ç©ºé—²åˆ—è¡¨ï¼šå¦‚æœæ˜¯ç›¸äº’äº¤é”™çš„ï¼Œé‚£ä¹ˆè™šæ‹Ÿæœºä¼šç»´æŠ¤ä¸€ä¸ªåˆ—è¡¨ï¼Œè®°å½•å“ªäº›å†…å­˜å—æ˜¯å¯ç”¨çš„ï¼Œåœ¨åˆ†é…çš„æ—¶å€™ä»åˆ—è¡¨ä¸­æ‰¾åˆ°ä¸€å—è¶³å¤Ÿå¤§çš„ç©ºé—´åˆ’ç»™å¯¹è±¡å®ä¾‹ï¼Œå¹¶æ›´æ–°åˆ—è¡¨ä¸Šçš„è®°å½•ã€‚è¿™ç§åˆ†é…æ–¹å¼æˆä¸ºâ€ç©ºé—²åˆ—è¡¨â€œã€‚ åˆ†é…å†…å­˜çš„å¹¶å‘é—®é¢˜ï¼šå³ä½¿æ˜¯ä»…ä»…ä¿®æ”¹ä¸€ä¸ªæŒ‡é’ˆæ‰€æŒ‡å‘çš„ä½ç½®ï¼Œåœ¨å¹¶å‘æƒ…å†µä¸‹ä¹Ÿä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯èƒ½å‡ºç°æ­£åœ¨ç»™å¯¹è±¡Aåˆ†é…å†…å­˜ï¼ŒæŒ‡é’ˆè¿˜æ²¡æ¥å¾—åŠä¿®æ”¹ï¼Œå¯¹è±¡BåˆåŒæ—¶ä½¿ç”¨äº†åŸæ¥çš„ æŒ‡é’ˆæ¥åˆ†é…å†…å­˜çš„æƒ…å†µã€‚é’ˆå¯¹è¿™ä¸ªé—®é¢˜æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š ï¼ˆ1ï¼‰å¤±è´¥é‡è¯•ï¼šå¯¹åˆ†é…å†…å­˜ç©ºé—´çš„åŠ¨ä½œè¿›è¡ŒåŒæ­¥å¤„ç†ï¼Œè™šæ‹Ÿæœºé‡‡ç”¨CASå’Œå¤±è´¥é‡è¯•æœºåˆ¶ä¿è¯æ›´æ–°æ“ä½œçš„åŸå­æ€§ã€‚ ï¼ˆ2ï¼‰æœ¬åœ°çº¿ç¨‹åˆ†é…ç¼“å­˜ï¼šå“ªä¸ªçº¿ç¨‹è¦åˆ†é…å†…å­˜ï¼Œå°±åœ¨å“ªä¸ªçº¿ç¨‹çš„TLABï¼ˆThread Local Allocation Bufferï¼‰ä¸Šåˆ†é…ï¼Œåªæœ‰TLABç”¨å®Œå¹¶åˆ†é…æ–°çš„TLABæ—¶ï¼Œæ‰éœ€è¦åŒæ­¥é”å®šã€‚ å†…å­˜ç©ºé—´åˆå§‹åŒ–é›¶å€¼ï¼šå†…å­˜åˆ†é…å®Œæˆåï¼Œè™šæ‹Ÿæœºéœ€è¦å°†åˆ†é…åˆ°çš„å†…å­˜ç©ºé—´éƒ½åˆå§‹åŒ–é›¶å€¼ï¼Œè¿™ä¸€æ­¥æ“ä½œä¿è¯äº†å¯¹è±¡çš„å®ä¾‹å­—æ®µï¼ˆæˆå‘˜å˜é‡ï¼‰åœ¨Javaä»£ç ä¸­å¯ä»¥ä¸èµ‹å€¼å°±ç›´æ¥ä½¿ç”¨ï¼Œç¨‹åºèƒ½å¤Ÿè®¿é—®åˆ°è¿™äº›å­—æ®µçš„æ•°æ®ç±»å‹æ‰€å¯¹åº”çš„é›¶å€¼ã€‚ å¯¹è±¡è®¾ç½®ï¼šæ¥ä¸‹æ¥è™šæ‹Ÿæœºä¼šå¯¹å¯¹è±¡è¿›è¡Œå¿…è¦çš„è®¾ç½®ï¼Œä¾‹å¦‚è¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹ï¼Œå¦‚ä½•æ‰èƒ½æ‰¾åˆ°ç±»çš„å…ƒæ•°æ®ä¿¡æ¯ã€å¯¹è±¡çš„å“ˆå¸Œå—ã€å¯¹è±¡çš„GCåˆ†ä»£å¹´é¾„ç­‰ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯å­˜æ”¾åœ¨å¯¹è±¡å¤´ä¸­ã€‚è‡³æ­¤ä¸€ä¸ªæ–°çš„å¯¹è±¡äº§ç”Ÿäº†ã€‚ å®ä¾‹æ„é€ å™¨çš„initæ–¹æ³•ï¼šè™½ç„¶å¯¹è±¡äº§ç”Ÿäº†ï¼Œä½†æ˜¯initæ–¹æ³•å¹¶æ²¡æœ‰æ‰§è¡Œï¼Œæ‰€æ¬²å­—æ®µè¿˜éœ€è¦èµ‹å€¼ï¼ˆåŒ…æ‹¬æˆå‘˜å˜é‡èµ‹å€¼ï¼Œæ™®é€šè¯­å¥å—æ‰§è¡Œï¼Œæ„é€ å‡½æ•°æ‰§è¡Œç­‰ã€‚ï¼‰ Clinitå’Œinit Clinit ç±»æ„é€ å™¨çš„æ–¹æ³•ï¼Œä¸ç±»çš„åˆå§‹åŒ–æœ‰å…³ã€‚ä¾‹å¦‚é™æ€å˜é‡ï¼ˆç±»å˜é‡ï¼‰å’Œé™æ€å¯¹è±¡èµ‹å€¼ï¼Œé™æ€è¯­å¥å—çš„æ‰§è¡Œã€‚å¦‚æœä¸€ä¸ªç±»ä¸­æ²¡æœ‰é™æ€è¯­å¥å—ï¼Œä¹Ÿæ²¡æœ‰é™æ€å˜é‡æˆ–é™æ€å¯¹è±¡çš„èµ‹å€¼ï¼Œ é‚£ä¹ˆç¼–è¯‘å™¨å¯ä»¥ä¸ä¸ºè¿™ä¸ªç±»ç”Ÿæˆæ–¹æ³•ã€‚ init å®ä¾‹æ„é€ å™¨ï¼ˆå³æˆå‘˜å˜é‡ï¼Œæˆå‘˜å¯¹è±¡ç­‰ï¼‰ï¼Œä¾‹å¦‚æˆå‘˜å˜é‡å’Œæˆå‘˜å¯¹è±¡çš„èµ‹å€¼ï¼Œæ™®é€šè¯­å¥å—çš„æ‰§è¡Œï¼Œæ„é€ å‡½æ•°çš„æ‰§è¡Œã€‚ å¯¹è±¡çš„å†…å­˜å¸ƒå±€ åœ¨HotSpotè™šæ‹Ÿæœºä¸­ï¼Œå¯¹è±¡åœ¨å†…å­˜ä¸­å­˜å‚¨çš„å¸ƒå±€å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªåŒºåŸŸï¼šå¯¹è±¡å¤´ã€å®ä¾‹æ•°æ®å’Œå¯¹é½å¡«å……ã€‚ å¯¹è±¡å¤´ å¯¹è±¡å¤´åŒ…æ‹¬ä¸¤éƒ¨åˆ†ä¿¡æ¯ï¼šè¿è¡Œæ—¶æ•°æ®å’Œç±»å‹æŒ‡é’ˆã€‚ è¿è¡Œæ—¶æ•°æ® ç¬¬ä¸€éƒ¨åˆ†ç”¨äºå­˜å‚¨å¯¹è±¡è‡ªèº«çš„è¿è¡Œæ—¶æ•°æ®ï¼Œå¦‚å“ˆå¸Œå—ï¼ˆHashCodeï¼‰ã€GCåˆ†ä»£å¹´é¾„ã€é”çŠ¶æ€æ ‡å¿—ã€çº¿ç¨‹æŒæœ‰çš„é”ã€åå‘çº¿ç¨‹IDã€åå‘æ—¶é—´æˆ³ç­‰ã€‚ ä¸‹é¢æ˜¯HotSpotè™šæ‹Ÿæœºå¯¹è±¡å¤´Mark Wordï¼š ç±»å‹æŒ‡é’ˆ å¯¹è±¡å¤´çš„å¦ä¸€éƒ¨åˆ†æ˜¯ç±»å‹æŒ‡é’ˆï¼Œå³å¯¹è±¡æŒ‡å‘ä»–å…ƒæ•°æ®çš„æŒ‡é’ˆï¼Œè™šæ‹Ÿæœºå¯ä»¥é€šè¿‡è¿™ä¸ªæŒ‡é’ˆç¡®å®šè¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹ã€‚ä½†æ˜¯å¦‚æœå¯¹è±¡æ˜¯ä¸€ä¸ªJavaæ•°ç»„ï¼Œé‚£ä¹ˆåœ¨å¯¹è±¡å¤´ä¸­è¿˜å¿…é¡»æœ‰ä¸€å—ç”¨äºè®°å½•æ•°æ®é•¿åº¦çš„æ•°æ®ã€‚ å¯¹è±¡çš„å®ä¾‹æ•°æ® æ¥ç€æ•°æ®å¤´çš„æ˜¯å¯¹è±¡çš„å®ä¾‹æ•°æ®ï¼Œè¿™éƒ¨åˆ†æ˜¯çœŸæ­£å­˜å‚¨çš„æœ‰æ•ˆä¿¡æ¯ã€‚æ— è®ºæ˜¯ä»çˆ¶ç±»ä¸­ç»§æ‰¿ä¸‹æ¥çš„è¿˜æ˜¯åœ¨å­ç±»ä¸­å®šä¹‰çš„ï¼Œéƒ½éœ€è¦è®°å½•ä¸‹æ¥ã€‚ å¯¹é½å¡«å…… æœ€åä¸€éƒ¨åˆ†å¯¹é½å¡«å……å¹¶ä¸æ˜¯å¿…ç„¶å­˜åœ¨çš„ï¼Œä¹Ÿæ²¡æœ‰ç‰¹åˆ«çš„å«ä¹‰ï¼Œä»…ä»…èµ·ç€å ä½ç¬¦çš„ä½œç”¨ã€‚ç”±äºHotSpotè™šæ‹Ÿæœºçš„è‡ªåŠ¨å†…å­˜ç®¡ç†ç³»ç»Ÿè¦æ±‚å¯¹è±¡çš„èµ·å§‹åœ°å€å¿…é¡»æ˜¯8å­—èŠ‚çš„æ•´æ•°å€ï¼Œä¹Ÿå°±æ˜¯ å¯¹è±¡çš„å¤§å°å¿…é¡»æ˜¯8å­—èŠ‚çš„æ•´æ•°å€ã€‚è€Œå¯¹è±¡å¤´éƒ¨åˆ†æ˜¯8å­—èŠ‚çš„å€æ•°ï¼Œå½“å®ä¾‹æ•°æ®æ²¡æœ‰å¯¹é½çš„æ—¶å€™ï¼Œéœ€è¦å¯¹é½å¡«å……å‡‘å¤Ÿ8å­—èŠ‚çš„æ•´æ•°å€ã€‚ å¯¹è±¡çš„è®¿é—®å®šä½ å»ºç«‹å¯¹è±¡æ˜¯ä¸ºäº†ä½¿ç”¨å¯¹è±¡ï¼Œæˆ‘ä»¬çš„Javaç¨‹åºéœ€è¦é€šè¿‡æ ˆä¸Šçš„å¼•ç”¨æ•°æ®æ¥æ“ä½œå †ä¸Šçš„å…·ä½“å¯¹è±¡ã€‚å¯¹è±¡çš„è®¿é—®æ–¹å¼å–å†³äºè™šæ‹Ÿæœºçš„å®ç°ï¼Œç›®å‰ä¸»æµçš„è®¿é—®æ–¹å¼æœ‰ä½¿ç”¨å¥æŸ„å’Œç›´æ¥æŒ‡é’ˆä¸¤ç§ã€‚ å¥æŸ„å¼•ç”¨å’Œç›´æ¥å¼•ç”¨ä¸åŒåœ¨äºï¼šä½¿ç”¨å¥æŸ„å¼•ç”¨çš„è¯ï¼Œé‚£ä¹ˆJavaå¯¹å †ä¸­å°†ä¼šåˆ’åˆ†å‡ºä¸€å—å†…å­˜æ¥ä½œä¸ºå¥æŸ„æ± ï¼Œå¼•ç”¨ä¸­å­˜å‚¨çš„å°±æ˜¯å¯¹è±¡çš„å¥æŸ„åœ°å€ï¼Œä½†æ˜¯ç›´æ¥å¼•ç”¨å¼•ç”¨ä¸­å­˜å‚¨çš„ç›´æ¥å°±æ˜¯å¯¹è±¡åœ°å€ã€‚Javaä½¿ç”¨çš„æ˜¯ç›´æ¥æŒ‡é’ˆè®¿é—®å¯¹è±¡çš„æ–¹å¼ï¼Œå› ä¸ºå®ƒæœ€å¤§çš„å¥½å¤„å°±æ˜¯é€Ÿåº¦æ›´å¿«ï¼Œå®ƒèŠ‚çœäº†ä¸€æ¬¡æŒ‡é’ˆå®šä½çš„æ—¶é—´å¼€é”€ï¼Œç”±äºå¯¹è±¡çš„è®¿é—®åœ¨Javaä¸­éå¸¸é¢‘ç¹ï¼Œå› æ­¤è¿™ç±»å¼€é”€ç§¯å°‘æˆå¤šåä¹Ÿæ˜¯ä¸€é¡¹ éå¸¸å¯è§‚çš„æ‰§è¡Œæˆæœ¬ã€‚ ä¸‹é¢æ˜¯é€šè¿‡ç›´æ¥æŒ‡é’ˆè®¿é—®å¯¹è±¡ ","link":"https://tianxiawuhao.github.io/DikSLfU_z/"},{"title":"çº¿ç¨‹æ± ThreadPoolExecutor","content":"Executorsç›®å‰æä¾›äº†5ç§ä¸åŒçš„çº¿ç¨‹æ± åˆ›å»ºé…ç½®ï¼š newCachedThreadPoolï¼ˆï¼‰ï¼Œå®ƒæ˜¯ç”¨æ¥å¤„ç†å¤§é‡çŸ­æ—¶é—´å·¥ä½œä»»åŠ¡çš„çº¿ç¨‹æ± ï¼Œå…·æœ‰å‡ ä¸ªé²œæ˜ç‰¹ç‚¹ï¼šå®ƒä¼šè¯•å›¾ç¼“å­˜çº¿ç¨‹å¹¶é‡ç”¨ï¼Œå½“æ— ç¼“å­˜çº¿ç¨‹å¯ç”¨æ—¶ï¼Œå°±ä¼šåˆ›å»ºæ–°çš„å·¥ä½œçº¿ç¨‹ï¼›å¦‚æœçº¿ç¨‹é—²ç½®æ—¶é—´è¶…è¿‡60ç§’ï¼Œåˆ™è¢«ç»ˆæ­¢å¹¶ç§»é™¤ç¼“å­˜ï¼›é•¿æ—¶é—´é—²ç½®æ—¶ï¼Œè¿™ç§çº¿ç¨‹æ± ï¼Œä¸ä¼šæ¶ˆè€—ä»€ä¹ˆèµ„æºã€‚å…¶å†…éƒ¨ä½¿ç”¨SynchronousQueueä½œä¸ºå·¥ä½œé˜Ÿåˆ—ã€‚ newFixedThreadPoolï¼ˆint nThreadsï¼‰ï¼Œé‡ç”¨æŒ‡å®šæ•°ç›®ï¼ˆnThreadsï¼‰çš„çº¿ç¨‹ï¼Œå…¶èƒŒåä½¿ç”¨çš„æ˜¯æ— ç•Œçš„å·¥ä½œé˜Ÿåˆ—ï¼Œä»»ä½•æ—¶å€™æœ€å¤šæœ‰nThreadsä¸ªå·¥ä½œçº¿ç¨‹æ˜¯æ´»åŠ¨çš„ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœä»»åŠ¡æ•°é‡è¶…è¿‡äº†æ´»åŠ¨çº¿ç¨‹æ•°ç›®ï¼Œå°†åœ¨å·¥ä½œé˜Ÿåˆ—ä¸­ç­‰å¾…ç©ºé—²çº¿ç¨‹å‡ºç°ï¼›å¦‚æœå·¥ä½œçº¿ç¨‹é€€å‡ºï¼Œå°†ä¼šæœ‰æ–°çš„å·¥ä½œçº¿ç¨‹è¢«åˆ›å»ºï¼Œä»¥è¡¥è¶³æŒ‡å®šæ•°ç›®nThreadsã€‚ newSingleThreadExecutor()ï¼Œå®ƒçš„ç‰¹ç‚¹åœ¨äºå·¥ä½œçº¿ç¨‹æ•°ç›®é™åˆ¶ä¸º1ï¼Œæ“ä½œä¸€ä¸ªæ— ç•Œçš„å·¥ä½œé˜Ÿåˆ—ï¼Œæ‰€ä»¥å®ƒä¿è¯äº†æ‰€æœ‰çš„ä»»åŠ¡éƒ½æ˜¯è¢«é¡ºåºæ‰§è¡Œï¼Œæœ€å¤šä¼šæœ‰ä¸€ä¸ªä»»åŠ¡å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œå¹¶ä¸”ä¸äºˆè®¸ä½¿ç”¨è€…æ”¹åŠ¨çº¿ç¨‹æ± å®ä¾‹ï¼Œå› æ­¤å¯ä»¥é¿å…æ”¹å˜çº¿ç¨‹æ•°ç›®ã€‚ newSingleThreadScheduledExecutor()å’ŒnewScheduledThreadPool(int corePoolSize)ï¼Œåˆ›å»ºçš„æ˜¯ä¸ªScheduledExecutorServiceï¼Œå¯ä»¥è¿›è¡Œå®šæ—¶æˆ–å‘¨æœŸæ€§çš„å·¥ä½œè°ƒåº¦ï¼ŒåŒºåˆ«åœ¨äºå•ä¸€å·¥ä½œçº¿ç¨‹è¿˜æ˜¯å¤šä¸ªå·¥ä½œçº¿ç¨‹ã€‚ newWorkStealingPool(int parallelism)ï¼Œè¿™æ˜¯ä¸€ä¸ªç»å¸¸è¢«äººå¿½ç•¥çš„çº¿ç¨‹æ± ï¼ŒJava 8 æ‰åŠ å…¥è¿™ä¸ªåˆ›å»ºæ–¹æ³•ï¼Œå…¶å†…éƒ¨ä¼šæ„å»ºForkJoinPoolï¼Œåˆ©ç”¨Work-Stealingç®—æ³•ï¼Œå¹¶è¡Œåœ°å¤„ç†ä»»åŠ¡ï¼Œä¸ä¿è¯å¤„ç†é¡ºåºã€‚ public class MyThreadPool { public static void main(String[] args) { // ExecutorService executorService = Executors.newFixedThreadPool(5); // ExecutorService executorService= Executors.newSingleThreadExecutor(); // ExecutorService executorService= Executors.newCachedThreadPool(); // ExecutorService executorService= Executors.newScheduledThreadPool(5); ExecutorService executorService = new ThreadPoolExecutor(2, 5, 2, TimeUnit.SECONDS, new LinkedBlockingQueue&lt;Runnable&gt;(3), Executors.defaultThreadFactory(), new ThreadPoolExecutor.AbortPolicy() ); ThreadPoolInit(executorService); } private static void ThreadPoolInit(ExecutorService executorService) { try { for (int i = 1; i &lt;= 10; i++) { executorService.execute(() -&gt; { System.out.println(Thread.currentThread().getName() + &quot;åŠç†ä¸šåŠ¡&quot;); }); } } catch (Exception e) { e.printStackTrace(); } finally { executorService.shutdown(); } } } Executoræ¡†æ¶çš„åŸºæœ¬ç»„æˆ è€Œæˆ‘ä»¬åˆ›å»ºæ—¶ï¼Œä¸€èˆ¬ä½¿ç”¨å®ƒçš„å­ç±»ï¼šThreadPoolExecutor. public ThreadPoolExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, ThreadFactory threadFactory, RejectedExecutionHandler handler) è¿™æ˜¯å…¶ä¸­æœ€é‡è¦çš„ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å†³å®šäº†åˆ›å»ºå‡ºæ¥çš„çº¿ç¨‹æ± çš„å„ç§å±æ€§ï¼Œä¸‹é¢ä¾é ä¸€å¼ å›¾æ¥æ›´å¥½çš„ç†è§£çº¿ç¨‹æ± å’Œè¿™å‡ ä¸ªå‚æ•°ï¼š ï¼ˆ1ï¼‰corePoolSizeï¼šçº¿ç¨‹æ± ä¸­å¸¸é©»æ ¸å¿ƒçº¿ç¨‹æ•° ï¼ˆ2ï¼‰maximumPoolSizeï¼šçº¿ç¨‹æ± èƒ½å¤Ÿå®¹çº³åŒæ—¶æ‰§è¡Œçš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œæ­¤å€¼å¿…é¡»å¤§äºç­‰äº1 ï¼ˆ3ï¼‰keepAliveTimeï¼šå¤šä½™çš„ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´ã€‚å½“å‰çº¿ç¨‹æ± æ•°é‡è¶…è¿‡corePoolSizeæ—¶ï¼Œå½“ç©ºé—²æ—¶é—´åˆ°è¾¾keepAliveTimeå€¼æ—¶ï¼Œå¤šä½™ç©ºé—²çº¿ç¨‹ä¼šè¢«é”€æ¯ç›´åˆ°åªå‰©ä¸‹corePoolSizeä¸ªçº¿ç¨‹ä¸ºæ­¢ã€‚ ï¼ˆ4ï¼‰unitï¼škeepAliveTimeçš„æ—¶é—´å•ä½ ï¼ˆ5ï¼‰workQueueï¼šä»»åŠ¡é˜Ÿåˆ—ï¼Œè¢«æäº¤ä½†å°šæœªæ‰§è¡Œçš„ä»»åŠ¡ ï¼ˆ6ï¼‰threadFactoryï¼šè¡¨ç¤ºç”Ÿæˆçº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹çš„çº¿ç¨‹å·¥å‚ï¼Œç”¨äºåˆ›å»ºçº¿ç¨‹ï¼Œä¸€èˆ¬ä¸ºé»˜è®¤çº¿ç¨‹å·¥å‚å³å¯ ï¼ˆ7ï¼‰handlerï¼šæ‹’ç»ç­–ç•¥ï¼Œè¡¨ç¤ºå½“é˜Ÿåˆ—æ»¡äº†å¹¶ä¸”å·¥ä½œçº¿ç¨‹å¤§äºç­‰äºçº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°ï¼ˆmaximumPoolSizeï¼‰æ—¶å¦‚ä½•æ¥æ‹’ç»æ¥è¯·æ±‚çš„Runnableçš„ç­–ç•¥ handlerçš„æ‹’ç»ç­–ç•¥ï¼š æœ‰å››ç§ï¼š ç¬¬ä¸€ç§AbortPolicy:ä¸æ‰§è¡Œæ–°ä»»åŠ¡ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œæç¤ºçº¿ç¨‹æ± å·²æ»¡ ç¬¬äºŒç§DisCardPolicy:ä¸æ‰§è¡Œæ–°ä»»åŠ¡ï¼Œä¹Ÿä¸æŠ›å‡ºå¼‚å¸¸ ç¬¬ä¸‰ç§DisCardOldSetPolicy:å°†æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªä»»åŠ¡æ›¿æ¢ä¸ºå½“å‰æ–°è¿›æ¥çš„ä»»åŠ¡æ‰§è¡Œ ç¬¬å››ç§CallerRunsPolicy:ç›´æ¥è°ƒç”¨executeæ¥æ‰§è¡Œå½“å‰ä»»åŠ¡ åœ¨springé¡¹ç›®ä¸­çš„ä½¿ç”¨ å…ˆåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± çš„é…ç½®ï¼Œè®©Spring BootåŠ è½½ï¼Œç”¨æ¥å®šä¹‰å¦‚ä½•åˆ›å»ºä¸€ä¸ªThreadPoolTaskExecutorï¼Œè¦ä½¿ç”¨@Configurationå’Œ@EnableAsyncè¿™ä¸¤ä¸ªæ³¨è§£ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸ªé…ç½®ç±»ï¼Œå¹¶ä¸”æ˜¯çº¿ç¨‹æ± çš„é…ç½®ç±» @Configuration @EnableAsync public class ExecutorConfig { private static final Logger logger = LoggerFactory.getLogger(ExecutorConfig.class); @Value(&quot;${async.executor.thread.core_pool_size}&quot;) private int corePoolSize; @Value(&quot;${async.executor.thread.max_pool_size}&quot;) private int maxPoolSize; @Value(&quot;${async.executor.thread.queue_capacity}&quot;) private int queueCapacity; @Value(&quot;${async.executor.thread.name.prefix}&quot;) private String namePrefix; @Bean(name = &quot;asyncServiceExecutor&quot;) public Executor asyncServiceExecutor() { logger.info(&quot;start asyncServiceExecutor&quot;); ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor(); //é…ç½®æ ¸å¿ƒçº¿ç¨‹æ•° executor.setCorePoolSize(corePoolSize); //é…ç½®æœ€å¤§çº¿ç¨‹æ•° executor.setMaxPoolSize(maxPoolSize); //é…ç½®é˜Ÿåˆ—å¤§å° executor.setQueueCapacity(queueCapacity); //é…ç½®çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹çš„åç§°å‰ç¼€ executor.setThreadNamePrefix(namePrefix); // rejection-policyï¼šå½“poolå·²ç»è¾¾åˆ°max sizeçš„æ—¶å€™ï¼Œå¦‚ä½•å¤„ç†æ–°ä»»åŠ¡ // CALLER_RUNSï¼šä¸åœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œè€Œæ˜¯æœ‰è°ƒç”¨è€…æ‰€åœ¨çš„çº¿ç¨‹æ¥æ‰§è¡Œ executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy()); //æ‰§è¡Œåˆå§‹åŒ– executor.initialize(); return executor; } } @Valueæ˜¯æˆ‘é…ç½®åœ¨application.propertiesï¼Œå¯ä»¥å‚è€ƒé…ç½®ï¼Œè‡ªç”±å®šä¹‰ # å¼‚æ­¥çº¿ç¨‹é…ç½® # é…ç½®æ ¸å¿ƒçº¿ç¨‹æ•° async.executor.thread.core_pool_size = 5 # é…ç½®æœ€å¤§çº¿ç¨‹æ•° async.executor.thread.max_pool_size = 5 # é…ç½®é˜Ÿåˆ—å¤§å° async.executor.thread.queue_capacity = 99999 # é…ç½®çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹çš„åç§°å‰ç¼€ async.executor.thread.name.prefix = async-service- åˆ›å»ºä¸€ä¸ªServiceæ¥å£ï¼Œæ˜¯å¼‚æ­¥çº¿ç¨‹çš„æ¥å£ public interface AsyncService { /** * æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ * å¯ä»¥æ ¹æ®éœ€æ±‚ï¼Œè‡ªå·±åŠ å‚æ•°æ‹Ÿå®šï¼Œæˆ‘è¿™é‡Œå°±åšä¸ªæµ‹è¯•æ¼”ç¤º */ void executeAsync(); } å®ç°ç±» @Service public class AsyncServiceImpl implements AsyncService { private static final Logger logger = LoggerFactory.getLogger(AsyncServiceImpl.class); @Override @Async(&quot;asyncServiceExecutor&quot;) public void executeAsync() { logger.info(&quot;start executeAsync&quot;); System.out.println(&quot;å¼‚æ­¥çº¿ç¨‹è¦åšçš„äº‹æƒ…&quot;); System.out.println(&quot;å¯ä»¥åœ¨è¿™é‡Œæ‰§è¡Œæ‰¹é‡æ’å…¥ç­‰è€—æ—¶çš„äº‹æƒ…&quot;); logger.info(&quot;end executeAsync&quot;); } } å°†Serviceå±‚çš„æœåŠ¡å¼‚æ­¥åŒ–ï¼Œåœ¨executeAsync()æ–¹æ³•ä¸Šå¢åŠ æ³¨è§£@Async(&quot;asyncServiceExecutor&quot;)ï¼ŒasyncServiceExecutoræ–¹æ³•æ˜¯å‰é¢ExecutorConfig.java ä¸­çš„æ–¹æ³•åï¼Œè¡¨æ˜executeAsyncæ–¹æ³•è¿›å…¥çš„çº¿ç¨‹æ± æ˜¯asyncServiceExecutoræ–¹æ³•åˆ›å»ºçš„ æ¥ä¸‹æ¥å°±æ˜¯åœ¨Controlleré‡Œæˆ–è€…æ˜¯å“ªé‡Œé€šè¿‡æ³¨è§£@Autowiredæ³¨å…¥è¿™ä¸ªService @Autowired private AsyncService asyncService; @GetMapping(&quot;/async&quot;) public void async(){ asyncService.executeAsync(); } ç”¨postmainæˆ–è€…å…¶ä»–å·¥å…·æ¥å¤šæ¬¡æµ‹è¯•è¯·æ±‚ä¸€ä¸‹ 2018-07-16 22:15:47.655 INFO 10516 --- [async-service-5] c.u.d.e.executor.impl.AsyncServiceImpl : start executeAsync å¼‚æ­¥çº¿ç¨‹è¦åšçš„äº‹æƒ… å¯ä»¥åœ¨è¿™é‡Œæ‰§è¡Œæ‰¹é‡æ’å…¥ç­‰è€—æ—¶çš„äº‹æƒ… 2018-07-16 22:15:47.655 INFO 10516 --- [async-service-5] c.u.d.e.executor.impl.AsyncServiceImpl : end executeAsync 2018-07-16 22:15:47.770 INFO 10516 --- [async-service-1] c.u.d.e.executor.impl.AsyncServiceImpl : start executeAsync å¼‚æ­¥çº¿ç¨‹è¦åšçš„äº‹æƒ… å¯ä»¥åœ¨è¿™é‡Œæ‰§è¡Œæ‰¹é‡æ’å…¥ç­‰è€—æ—¶çš„äº‹æƒ… 2018-07-16 22:15:47.770 INFO 10516 --- [async-service-1] c.u.d.e.executor.impl.AsyncServiceImpl : end executeAsync 2018-07-16 22:15:47.816 INFO 10516 --- [async-service-2] c.u.d.e.executor.impl.AsyncServiceImpl : start executeAsync å¼‚æ­¥çº¿ç¨‹è¦åšçš„äº‹æƒ… å¯ä»¥åœ¨è¿™é‡Œæ‰§è¡Œæ‰¹é‡æ’å…¥ç­‰è€—æ—¶çš„äº‹æƒ… 2018-07-16 22:15:47.816 INFO 10516 --- [async-service-2] c.u.d.e.executor.impl.AsyncServiceImpl : end executeAsync 2018-07-16 22:15:48.833 INFO 10516 --- [async-service-3] c.u.d.e.executor.impl.AsyncServiceImpl : start executeAsync å¼‚æ­¥çº¿ç¨‹è¦åšçš„äº‹æƒ… å¯ä»¥åœ¨è¿™é‡Œæ‰§è¡Œæ‰¹é‡æ’å…¥ç­‰è€—æ—¶çš„äº‹æƒ… 2018-07-16 22:15:48.834 INFO 10516 --- [async-service-3] c.u.d.e.executor.impl.AsyncServiceImpl : end executeAsync 2018-07-16 22:15:48.986 INFO 10516 --- [async-service-4] c.u.d.e.executor.impl.AsyncServiceImpl : start executeAsync å¼‚æ­¥çº¿ç¨‹è¦åšçš„äº‹æƒ… å¯ä»¥åœ¨è¿™é‡Œæ‰§è¡Œæ‰¹é‡æ’å…¥ç­‰è€—æ—¶çš„äº‹æƒ… 2018-07-16 22:15:48.987 INFO 10516 --- [async-service-4] c.u.d.e.executor.impl.AsyncServiceImpl : end executeAsync é€šè¿‡ä»¥ä¸Šæ—¥å¿—å¯ä»¥å‘ç°ï¼Œ[async-service-]æ˜¯æœ‰å¤šä¸ªçº¿ç¨‹çš„ï¼Œæ˜¾ç„¶å·²ç»åœ¨æˆ‘ä»¬é…ç½®çš„çº¿ç¨‹æ± ä¸­æ‰§è¡Œäº†ï¼Œå¹¶ä¸”æ¯æ¬¡è¯·æ±‚ä¸­ï¼Œcontrollerçš„èµ·å§‹å’Œç»“æŸæ—¥å¿—éƒ½æ˜¯è¿ç»­æ‰“å°çš„ï¼Œè¡¨æ˜æ¯æ¬¡è¯·æ±‚éƒ½å¿«é€Ÿå“åº”äº†ï¼Œè€Œè€—æ—¶çš„æ“ä½œéƒ½ç•™ç»™çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å»å¼‚æ­¥æ‰§è¡Œï¼› è™½ç„¶æˆ‘ä»¬å·²ç»ç”¨ä¸Šäº†çº¿ç¨‹æ± ï¼Œä½†æ˜¯è¿˜ä¸æ¸…æ¥šçº¿ç¨‹æ± å½“æ—¶çš„æƒ…å†µï¼Œæœ‰å¤šå°‘çº¿ç¨‹åœ¨æ‰§è¡Œï¼Œå¤šå°‘åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…å‘¢ï¼Ÿè¿™é‡Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªThreadPoolTaskExecutorçš„å­ç±»ï¼Œåœ¨æ¯æ¬¡æäº¤çº¿ç¨‹çš„æ—¶å€™éƒ½ä¼šå°†å½“å‰çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶å†µæ‰“å°å‡ºæ¥ import org.slf4j.Logger; import org.slf4j.LoggerFactory; import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor; import org.springframework.util.concurrent.ListenableFuture; import java.util.concurrent.Callable; import java.util.concurrent.Future; import java.util.concurrent.ThreadPoolExecutor; /** * @Author: ChenBin * @Date: 2018/7/16/0016 22:19 */ public class VisiableThreadPoolTaskExecutor extends ThreadPoolTaskExecutor { private static final Logger logger = LoggerFactory.getLogger(VisiableThreadPoolTaskExecutor.class); private void showThreadPoolInfo(String prefix) { ThreadPoolExecutor threadPoolExecutor = getThreadPoolExecutor(); if (null == threadPoolExecutor) { return; } logger.info(&quot;{}, {},taskCount [{}], completedTaskCount [{}], activeCount [{}], queueSize [{}]&quot;, this.getThreadNamePrefix(), prefix, threadPoolExecutor.getTaskCount(), threadPoolExecutor.getCompletedTaskCount(), threadPoolExecutor.getActiveCount(), threadPoolExecutor.getQueue().size()); } @Override public void execute(Runnable task) { showThreadPoolInfo(&quot;1. do execute&quot;); super.execute(task); } @Override public void execute(Runnable task, long startTimeout) { showThreadPoolInfo(&quot;2. do execute&quot;); super.execute(task, startTimeout); } @Override public Future&lt;?&gt; submit(Runnable task) { showThreadPoolInfo(&quot;1. do submit&quot;); return super.submit(task); } @Override public &lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task) { showThreadPoolInfo(&quot;2. do submit&quot;); return super.submit(task); } @Override public ListenableFuture&lt;?&gt; submitListenable(Runnable task) { showThreadPoolInfo(&quot;1. do submitListenable&quot;); return super.submitListenable(task); } @Override public &lt;T&gt; ListenableFuture&lt;T&gt; submitListenable(Callable&lt;T&gt; task) { showThreadPoolInfo(&quot;2. do submitListenable&quot;); return super.submitListenable(task); } } å¦‚ä¸Šæ‰€ç¤ºï¼ŒshowThreadPoolInfoæ–¹æ³•ä¸­å°†ä»»åŠ¡æ€»æ•°ã€å·²å®Œæˆæ•°ã€æ´»è·ƒçº¿ç¨‹æ•°ï¼Œé˜Ÿåˆ—å¤§å°éƒ½æ‰“å°å‡ºæ¥äº†ï¼Œç„¶åOverrideäº†çˆ¶ç±»çš„executeã€submitç­‰æ–¹æ³•ï¼Œåœ¨é‡Œé¢è°ƒç”¨showThreadPoolInfoæ–¹æ³•ï¼Œè¿™æ ·æ¯æ¬¡æœ‰ä»»åŠ¡è¢«æäº¤åˆ°çº¿ç¨‹æ± çš„æ—¶å€™ï¼Œéƒ½ä¼šå°†å½“å‰çº¿ç¨‹æ± çš„åŸºæœ¬æƒ…å†µæ‰“å°åˆ°æ—¥å¿—ä¸­ï¼› ä¿®æ”¹ExecutorConfig.javaçš„asyncServiceExecutoræ–¹æ³•ï¼Œå°†ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor()æ”¹ä¸ºThreadPoolTaskExecutor executor = new VisiableThreadPoolTaskExecutor() @Bean(name = &quot;asyncServiceExecutor&quot;) public Executor asyncServiceExecutor() { logger.info(&quot;start asyncServiceExecutor&quot;); //åœ¨è¿™é‡Œä¿®æ”¹ ThreadPoolTaskExecutor executor = new VisiableThreadPoolTaskExecutor(); //é…ç½®æ ¸å¿ƒçº¿ç¨‹æ•° executor.setCorePoolSize(corePoolSize); //é…ç½®æœ€å¤§çº¿ç¨‹æ•° executor.setMaxPoolSize(maxPoolSize); //é…ç½®é˜Ÿåˆ—å¤§å° executor.setQueueCapacity(queueCapacity); //é…ç½®çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹çš„åç§°å‰ç¼€ executor.setThreadNamePrefix(namePrefix); // rejection-policyï¼šå½“poolå·²ç»è¾¾åˆ°max sizeçš„æ—¶å€™ï¼Œå¦‚ä½•å¤„ç†æ–°ä»»åŠ¡ // CALLER_RUNSï¼šä¸åœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œè€Œæ˜¯æœ‰è°ƒç”¨è€…æ‰€åœ¨çš„çº¿ç¨‹æ¥æ‰§è¡Œ executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy()); //æ‰§è¡Œåˆå§‹åŒ– executor.initialize(); return executor; } å†æ¬¡å¯åŠ¨è¯¥å·¥ç¨‹æµ‹è¯• 2018-07-16 22:23:30.951 INFO 14088 --- [nio-8087-exec-2] u.d.e.e.i.VisiableThreadPoolTaskExecutor : async-service-, 2. do submit,taskCount [0], completedTaskCount [0], activeCount [0], queueSize [0] 2018-07-16 22:23:30.952 INFO 14088 --- [async-service-1] c.u.d.e.executor.impl.AsyncServiceImpl : start executeAsync å¼‚æ­¥çº¿ç¨‹è¦åšçš„äº‹æƒ… å¯ä»¥åœ¨è¿™é‡Œæ‰§è¡Œæ‰¹é‡æ’å…¥ç­‰è€—æ—¶çš„äº‹æƒ… 2018-07-16 22:23:30.953 INFO 14088 --- [async-service-1] c.u.d.e.executor.impl.AsyncServiceImpl : end executeAsync 2018-07-16 22:23:31.351 INFO 14088 --- [nio-8087-exec-3] u.d.e.e.i.VisiableThreadPoolTaskExecutor : async-service-, 2. do submit,taskCount [1], completedTaskCount [1], activeCount [0], queueSize [0] 2018-07-16 22:23:31.353 INFO 14088 --- [async-service-2] c.u.d.e.executor.impl.AsyncServiceImpl : start executeAsync å¼‚æ­¥çº¿ç¨‹è¦åšçš„äº‹æƒ… å¯ä»¥åœ¨è¿™é‡Œæ‰§è¡Œæ‰¹é‡æ’å…¥ç­‰è€—æ—¶çš„äº‹æƒ… 2018-07-16 22:23:31.353 INFO 14088 --- [async-service-2] c.u.d.e.executor.impl.AsyncServiceImpl : end executeAsync 2018-07-16 22:23:31.927 INFO 14088 --- [nio-8087-exec-5] u.d.e.e.i.VisiableThreadPoolTaskExecutor : async-service-, 2. do submit,taskCount [2], completedTaskCount [2], activeCount [0], queueSize [0] 2018-07-16 22:23:31.929 INFO 14088 --- [async-service-3] c.u.d.e.executor.impl.AsyncServiceImpl : start executeAsync å¼‚æ­¥çº¿ç¨‹è¦åšçš„äº‹æƒ… å¯ä»¥åœ¨è¿™é‡Œæ‰§è¡Œæ‰¹é‡æ’å…¥ç­‰è€—æ—¶çš„äº‹æƒ… 2018-07-16 22:23:31.930 INFO 14088 --- [async-service-3] c.u.d.e.executor.impl.AsyncServiceImpl : end executeAsync 2018-07-16 22:23:32.496 INFO 14088 --- [nio-8087-exec-7] u.d.e.e.i.VisiableThreadPoolTaskExecutor : async-service-, 2. do submit,taskCount [3], completedTaskCount [3], activeCount [0], queueSize [0] 2018-07-16 22:23:32.498 INFO 14088 --- [async-service-4] c.u.d.e.executor.impl.AsyncServiceImpl : start executeAsync å¼‚æ­¥çº¿ç¨‹è¦åšçš„äº‹æƒ… å¯ä»¥åœ¨è¿™é‡Œæ‰§è¡Œæ‰¹é‡æ’å…¥ç­‰è€—æ—¶çš„äº‹æƒ… 2018-07-16 22:23:32.499 INFO 14088 --- [async-service-4] c.u.d.e.executor.impl.AsyncServiceImpl : end executeAsync æ³¨æ„è¿™ä¸€è¡Œæ—¥å¿—ï¼š 2018-07-16 22:23:32.496 INFO 14088 --- [nio-8087-exec-7] u.d.e.e.i.VisiableThreadPoolTaskExecutor : async-service-, 2. do submit,taskCount [3], completedTaskCount [3], activeCount [0], queueSize [0] è¿™è¯´æ˜æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± çš„æ—¶å€™ï¼Œè°ƒç”¨çš„æ˜¯submit(Callable task)è¿™ä¸ªæ–¹æ³•ï¼Œå½“å‰å·²ç»æäº¤äº†3ä¸ªä»»åŠ¡ï¼Œå®Œæˆäº†3ä¸ªï¼Œå½“å‰æœ‰0ä¸ªçº¿ç¨‹åœ¨å¤„ç†ä»»åŠ¡ï¼Œè¿˜å‰©0ä¸ªä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œçº¿ç¨‹æ± çš„åŸºæœ¬æƒ…å†µä¸€è·¯äº†ç„¶ ","link":"https://tianxiawuhao.github.io/y8VkHlUlp/"},{"title":"æ‰‹å†™ä¸€ä¸ªç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼","content":"import lombok.SneakyThrows; import org.springframework.util.StringUtils; import java.util.concurrent.ArrayBlockingQueue; import java.util.concurrent.BlockingQueue; import java.util.concurrent.TimeUnit; import java.util.concurrent.atomic.AtomicInteger; class MyResource { private volatile Boolean FLAG = true; private final AtomicInteger atomicInteger = new AtomicInteger(); BlockingQueue&lt;String&gt; blockingQueue = null; public MyResource(BlockingQueue&lt;String&gt; blockingQueue) { this.blockingQueue = blockingQueue; System.out.println(blockingQueue.getClass().getName()); } @SneakyThrows public void myProd() { String data = null; while (FLAG) { data = String.valueOf(atomicInteger.incrementAndGet()); if (blockingQueue.offer(data, 2L, TimeUnit.SECONDS)) { System.out.println(Thread.currentThread().getName() + &quot;æ’å…¥æ•°æ®&quot; + data + &quot;æˆåŠŸ&quot;); } else { System.out.println(Thread.currentThread().getName() + &quot;æ’å…¥æ•°æ®&quot; + data + &quot;å¤±è´¥&quot;); } TimeUnit.SECONDS.sleep(1L); } System.out.println(Thread.currentThread().getName() + &quot;ç”Ÿäº§åœæ­¢&quot;); } @SneakyThrows public void myConsumer() { String result = null; while (FLAG) { result = blockingQueue.poll(2L, TimeUnit.SECONDS); if (StringUtils.isEmpty(result)) { FLAG = false; System.out.println(Thread.currentThread().getName() + &quot;è¶…è¿‡2ç§’æ²¡æœ‰å–åˆ°å€¼ï¼Œç»“æŸ&quot;); return; } System.out.println(Thread.currentThread().getName() + &quot;æ¶ˆè´¹æ•°æ®&quot; + result + &quot;æˆåŠŸ&quot;); } } public void stop(){ FLAG=false; } } public class ProdConsumer_BlockQueue { @SneakyThrows public static void main(String[] args) { MyResource myResource = new MyResource(new ArrayBlockingQueue&lt;&gt;(10)); new Thread(() -&gt; { System.out.println(Thread.currentThread().getName() + &quot;ç”Ÿäº§çº¿ç¨‹å¯åŠ¨&quot;); myResource.myProd(); }, &quot;Prod&quot;).start(); new Thread(() -&gt; { System.out.println(Thread.currentThread().getName() + &quot;æ¶ˆè´¹çº¿ç¨‹å¯åŠ¨&quot;); myResource.myConsumer(); }, &quot;Consumer&quot;).start(); TimeUnit.SECONDS.sleep(5L); System.out.println(&quot;5ç§’æ—¶é—´åˆ°ï¼Œç»“æŸ&quot;); myResource.stop(); } } ","link":"https://tianxiawuhao.github.io/5QxJ3UtmK/"},{"title":"é˜»å¡é˜Ÿåˆ—BlockingQueue","content":"ä¸ºä»€ä¹ˆè¦ä½¿ç”¨é˜»å¡é˜Ÿåˆ— ä¹‹å‰ï¼Œä»‹ç»äº†ä¸€ä¸‹ ThreadPoolExecutor çš„å„å‚æ•°çš„å«ä¹‰ï¼ˆçº¿ç¨‹æ± ThreadPoolExecutorï¼‰ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ª BlockingQueueï¼Œå®ƒæ˜¯ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ã€‚é‚£ä¹ˆï¼Œå°ä¼™ä¼´ä»¬æœ‰æ²¡æœ‰æƒ³è¿‡ï¼Œä¸ºä»€ä¹ˆæ­¤å¤„çš„çº¿ç¨‹æ± è¦ç”¨é˜»å¡é˜Ÿåˆ—å‘¢ï¼Ÿ æˆ‘ä»¬çŸ¥é“é˜Ÿåˆ—æ˜¯å…ˆè¿›å…ˆå‡ºçš„ã€‚å½“æ”¾å…¥ä¸€ä¸ªå…ƒç´ çš„æ—¶å€™ï¼Œä¼šæ”¾åœ¨é˜Ÿåˆ—çš„æœ«å°¾ï¼Œå–å‡ºå…ƒç´ çš„æ—¶å€™ï¼Œä¼šä»é˜Ÿå¤´å–ã€‚é‚£ä¹ˆï¼Œå½“é˜Ÿåˆ—ä¸ºç©ºæˆ–è€…é˜Ÿåˆ—æ»¡çš„æ—¶å€™æ€ä¹ˆåŠå‘¢ã€‚ è¿™æ—¶ï¼Œé˜»å¡é˜Ÿåˆ—ï¼Œä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬å¤„ç†è¿™ç§æƒ…å†µã€‚ å½“é˜»å¡é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™ï¼Œä»é˜Ÿåˆ—ä¸­å–å…ƒç´ çš„æ“ä½œå°±ä¼šè¢«é˜»å¡ã€‚å½“é˜»å¡é˜Ÿåˆ—æ»¡çš„æ—¶å€™ï¼Œå¾€é˜Ÿåˆ—ä¸­æ”¾å…¥å…ƒç´ çš„æ“ä½œå°±ä¼šè¢«é˜»å¡ã€‚ è€Œåï¼Œä¸€æ—¦ç©ºé˜Ÿåˆ—æœ‰æ•°æ®äº†ï¼Œæˆ–è€…æ»¡é˜Ÿåˆ—æœ‰ç©ºä½™ä½ç½®æ—¶ï¼Œè¢«é˜»å¡çš„çº¿ç¨‹å°±ä¼šè¢«è‡ªåŠ¨å”¤é†’ã€‚ è¿™å°±æ˜¯é˜»å¡é˜Ÿåˆ—çš„å¥½å¤„ï¼Œä½ ä¸éœ€è¦å…³å¿ƒçº¿ç¨‹ä½•æ—¶è¢«é˜»å¡ï¼Œä¹Ÿä¸éœ€è¦å…³å¿ƒçº¿ç¨‹ä½•æ—¶è¢«å”¤é†’ï¼Œä¸€åˆ‡éƒ½ç”±é˜»å¡é˜Ÿåˆ—è‡ªåŠ¨å¸®æˆ‘ä»¬å®Œæˆã€‚æˆ‘ä»¬åªéœ€è¦å…³æ³¨å…·ä½“çš„ä¸šåŠ¡é€»è¾‘å°±å¯ä»¥äº†ã€‚ è€Œè¿™ç§é˜»å¡é˜Ÿåˆ—ç»å¸¸ç”¨åœ¨ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼ä¸­ã€‚ï¼ˆå¯å‚çœ‹ï¼šæ‰‹å†™ä¸€ä¸ªç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼ï¼‰ å¸¸ç”¨çš„é˜»å¡é˜Ÿåˆ— é‚£ä¹ˆï¼Œä¸€èˆ¬æˆ‘ä»¬ç”¨åˆ°çš„é˜»å¡é˜Ÿåˆ—æœ‰å“ªäº›å‘¢ã€‚ä¸‹é¢ï¼Œé€šè¿‡ideaçš„ç±»å›¾ï¼Œåˆ—å‡ºæ¥å¸¸ç”¨çš„é˜»å¡é˜Ÿåˆ—ï¼Œç„¶åä¸€ä¸ªä¸€ä¸ªè®²è§£ï¼ˆä¸æ‡‚æ€ä¹ˆç”¨çš„ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼šæ€ä¹ˆç”¨IDEAå¿«é€ŸæŸ¥çœ‹ç±»å›¾å…³ç³»ï¼‰ã€‚ é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œæ‰€æœ‰å¸¸ç”¨çš„æ–¹æ³•éƒ½åœ¨ BlockingQueue æ¥å£ä¸­å®šä¹‰ã€‚å¦‚ æ’å…¥å…ƒç´ çš„æ–¹æ³•ï¼š putï¼Œofferï¼Œaddã€‚ç§»é™¤å…ƒç´ çš„æ–¹æ³•ï¼š removeï¼Œpollï¼Œtakeã€‚ å®ƒä»¬æœ‰å››ç§ä¸åŒçš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯åœ¨å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œç¬¬äºŒç§æ˜¯åœ¨å¤±è´¥æ—¶è¿”å›ç‰¹æ®Šå€¼ï¼Œç¬¬ä¸‰ç§æ˜¯ä¸€ç›´é˜»å¡å½“å‰çº¿ç¨‹ï¼Œæœ€åä¸€ç§æ˜¯åœ¨æŒ‡å®šæ—¶é—´å†…é˜»å¡ï¼Œå¦åˆ™è¿”å›ç‰¹æ®Šå€¼ã€‚ï¼ˆä»¥ä¸Šç‰¹æ®Šå€¼ï¼Œæ˜¯æŒ‡åœ¨æ’å…¥å…ƒç´ æ—¶ï¼Œå¤±è´¥è¿”å›falseï¼Œåœ¨å–å‡ºå…ƒç´ æ—¶ï¼Œå¤±è´¥è¿”å›nullï¼‰ æŠ›å¼‚å¸¸ ç‰¹æ®Šå€¼ é˜»å¡ è¶…æ—¶ æ’å…¥ add(e) offer(e) put(e) offer(e,time,unit) ç§»é™¤ remove() poll() take() poll(time,unit) 1ï¼‰ ArrayBlockingQueue è¿™æ˜¯ä¸€ä¸ªç”±æ•°ç»„ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚é¦–å…ˆçœ‹ä¸‹å®ƒçš„æ„é€ æ–¹æ³•ï¼Œæœ‰ä¸‰ä¸ªã€‚ ç¬¬ä¸€ä¸ªå¯ä»¥æŒ‡å®šé˜Ÿåˆ—çš„å¤§å°ï¼Œç¬¬äºŒä¸ªè¿˜å¯ä»¥æŒ‡å®šé˜Ÿåˆ—æ˜¯å¦å…¬å¹³ï¼Œä¸æŒ‡å®šçš„è¯ï¼Œé»˜è®¤æ˜¯éå…¬å¹³ã€‚å®ƒæ˜¯ä½¿ç”¨ ReentrantLock çš„å…¬å¹³é”å’Œéå…¬å¹³é”å®ç°çš„ï¼ˆåç»­è®²è§£AQSæ—¶ï¼Œä¼šè¯¦ç»†è¯´æ˜ï¼‰ã€‚ ç®€å•ç†è§£å°±æ˜¯ï¼ŒReentrantLock å†…éƒ¨ä¼šç»´æŠ¤ä¸€ä¸ªæœ‰å…ˆåé¡ºåºçš„ç­‰å¾…é˜Ÿåˆ—ï¼Œå‡å¦‚æœ‰äº”ä¸ªä»»åŠ¡ä¸€èµ·è¿‡æ¥ï¼Œéƒ½è¢«é˜»å¡äº†ã€‚å¦‚æœæ˜¯å…¬å¹³çš„ï¼Œåˆ™ç­‰å¾…é˜Ÿåˆ—ä¸­ç­‰å¾…æœ€ä¹…çš„ä»»åŠ¡å°±ä¼šå…ˆè¿›å…¥é˜»å¡é˜Ÿåˆ—ã€‚å¦‚æœæ˜¯éå…¬å¹³çš„ï¼Œé‚£ä¹ˆè¿™äº”ä¸ªçº¿ç¨‹å°±éœ€è¦æŠ¢é”ï¼Œè°å…ˆæŠ¢åˆ°ï¼Œè°å°±å…ˆè¿›å…¥é˜»å¡é˜Ÿåˆ—ã€‚ ç¬¬ä¸‰ä¸ªæ„é€ æ–¹æ³•ï¼Œæ˜¯æŠŠä¸€ä¸ªé›†åˆçš„å…ƒç´ åˆå§‹åŒ–åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ã€‚ å¦å¤–ï¼ŒArrayBlockingQueue æ²¡æœ‰å®ç°è¯»å†™åˆ†ç¦»ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¯»å’Œå†™æ˜¯ä¸èƒ½åŒæ—¶è¿›è¡Œçš„ã€‚å› ä¸ºï¼Œå®ƒè¯»å†™æ—¶ç”¨çš„æ˜¯åŒä¸€æŠŠé”ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š 2) LinkedBlockingQueue è¿™æ˜¯ä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚å®ƒçš„æ„é€ æ–¹æ³•æœ‰ä¸‰ä¸ªã€‚ å¯ä»¥çœ‹åˆ°å’Œ ArrayBlockingQueue çš„æ„é€ æ–¹æ³•å¤§åŒå°å¼‚ï¼Œä¸è¿‡æ˜¯ï¼ŒLinkedBlockingQueue å¯ä»¥ä¸æŒ‡å®šé˜Ÿåˆ—çš„å¤§å°ï¼Œé»˜è®¤å€¼æ˜¯ Integer.MAX_VALUE ã€‚ ä½†æ˜¯ï¼Œæœ€å¥½ä¸è¦è¿™æ ·åšï¼Œå»ºè®®æŒ‡å®šä¸€ä¸ªå›ºå®šå¤§å°ã€‚å› ä¸ºï¼Œå¦‚æœç”Ÿäº§è€…çš„é€Ÿåº¦æ¯”æ¶ˆè´¹è€…çš„é€Ÿåº¦å¤§çš„å¤šçš„æƒ…å†µä¸‹ï¼Œè¿™ä¼šå¯¼è‡´é˜»å¡é˜Ÿåˆ—ä¸€ç›´è†¨èƒ€ï¼Œç›´åˆ°ç³»ç»Ÿå†…å­˜è¢«è€—å°½ï¼ˆæ­¤æ—¶ï¼Œè¿˜æ²¡è¾¾åˆ°é˜Ÿåˆ—å®¹é‡çš„æœ€å¤§å€¼ï¼‰ã€‚ æ­¤å¤–ï¼ŒLinkedBlockingQueue å®ç°äº†è¯»å†™åˆ†ç¦»ï¼Œå¯ä»¥å®ç°æ•°æ®çš„è¯»å’Œå†™äº’ä¸å½±å“ï¼Œè¿™åœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œå¯¹äºæ•ˆç‡çš„æé«˜æ— ç–‘æ˜¯éå¸¸å·¨å¤§çš„ã€‚ 3ï¼‰ SynchronousQueue è¿™æ˜¯ä¸€ä¸ªæ²¡æœ‰ç¼“å†²çš„æ— ç•Œé˜Ÿåˆ—ã€‚ä»€ä¹ˆæ„æ€ï¼Œçœ‹ä¸€ä¸‹å®ƒçš„ size æ–¹æ³•ï¼š æ€»æ˜¯è¿”å› 0 ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªæ²¡æœ‰å®¹é‡çš„é˜Ÿåˆ—ã€‚ å½“æ‰§è¡Œæ’å…¥å…ƒç´ çš„æ“ä½œæ—¶ï¼Œå¿…é¡»ç­‰å¾…ä¸€ä¸ªå–å‡ºæ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œputå…ƒç´ çš„æ—¶å€™ï¼Œå¿…é¡»ç­‰å¾… take æ“ä½œã€‚ é‚£ä¹ˆï¼Œæœ‰çš„åŒå­¦å°±å¥½å¥‡äº†ï¼Œè¿™æ²¡æœ‰å®¹é‡ï¼Œè¿˜å«ä»€ä¹ˆé˜Ÿåˆ—å•Šï¼Œè¿™æœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ã€‚ æˆ‘çš„ç†è§£æ˜¯ï¼Œè¿™é€‚ç”¨äºå¹¶å‘ä»»åŠ¡ä¸å¤§ï¼Œè€Œä¸”ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„é€Ÿåº¦ç›¸å·®ä¸å¤šçš„åœºæ™¯ä¸‹ï¼Œç›´æ¥æŠŠç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å¯¹æ¥ï¼Œä¸ç”¨ç»è¿‡é˜Ÿåˆ—çš„å…¥é˜Ÿå‡ºé˜Ÿè¿™ä¸€ç³»åˆ—æ“ä½œã€‚æ‰€ä»¥ï¼Œæ•ˆç‡ä¸Šä¼šé«˜ä¸€äº›ã€‚ å¯ä»¥å»æŸ¥çœ‹ä¸€ä¸‹ Excutors.newCachedThreadPool æ–¹æ³•ç”¨çš„å°±æ˜¯è¿™ç§é˜Ÿåˆ—ã€‚ è¿™ä¸ªé˜Ÿåˆ—æœ‰ä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼Œç”¨äºä¼ å…¥æ˜¯å…¬å¹³è¿˜æ˜¯éå…¬å¹³ï¼Œé»˜è®¤æ˜¯éå…¬å¹³ã€‚ 4ï¼‰PriorityBlockingQueue è¿™æ˜¯ä¸€ä¸ªæ”¯æŒä¼˜å…ˆçº§æ’åºçš„æ— ç•Œé˜Ÿåˆ—ã€‚æœ‰å››ä¸ªæ„é€ æ–¹æ³•ï¼š å¯ä»¥æŒ‡å®šåˆå§‹å®¹é‡å¤§å°ï¼ˆæ³¨æ„åˆå§‹å®¹é‡å¹¶ä¸ä»£è¡¨æœ€å¤§å®¹é‡ï¼‰ï¼Œæˆ–è€…ä¸æŒ‡å®šï¼Œé»˜è®¤å¤§å°ä¸º 11ã€‚ä¹Ÿå¯ä»¥ä¼ å…¥ä¸€ä¸ªæ¯”è¾ƒå™¨ï¼ŒæŠŠå…ƒç´ æŒ‰ä¸€å®šçš„è§„åˆ™æ’åºï¼Œä¸æŒ‡å®šæ¯”è¾ƒå™¨çš„è¯ï¼Œé»˜è®¤æ˜¯è‡ªç„¶é¡ºåºã€‚ PriorityBlockingQueue æ˜¯åŸºäºäºŒå‰æ ‘æœ€å°å †å®ç°çš„ï¼Œæ¯å½“å–å…ƒç´ çš„æ—¶å€™ï¼Œå°±ä¼šæŠŠä¼˜å…ˆçº§æœ€é«˜çš„å…ƒç´ å–å‡ºæ¥ã€‚æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ï¼š public class Person { private int id; private String name; public int getId() { return id; } public void setId(int id) { this.id = id; } public String getName() { return name; } public void setName(String name) { this.name = name; } @Override public String toString() { return &quot;Person{&quot; + &quot;id=&quot; + id + &quot;, name='&quot; + name + '\\'' + '}'; } public Person(int id, String name) { this.id = id; this.name = name; } public Person() { } } public class QueueTest { public static void main(String[] args) throws InterruptedException { PriorityBlockingQueue&lt;Person&gt; priorityBlockingQueue = new PriorityBlockingQueue&lt;&gt;(1, new Comparator&lt;Person&gt;() { @Override public int compare(Person o1, Person o2) { return o1.getId() - o2.getId(); } }); Person p2 = new Person(7, &quot;æå››&quot;); Person p1 = new Person(9, &quot;å¼ ä¸‰&quot;); Person p3 = new Person(6, &quot;ç‹äº”&quot;); Person p4 = new Person(2, &quot;èµµå…­&quot;); priorityBlockingQueue.add(p1); priorityBlockingQueue.add(p2); priorityBlockingQueue.add(p3); priorityBlockingQueue.add(p4); //ç”±äºäºŒå‰æ ‘æœ€å°å †å®ç°ï¼Œç”¨è¿™ç§æ–¹å¼ç›´æ¥æ‰“å°å…ƒç´ ï¼Œä¸èƒ½ä¿è¯æœ‰åº System.out.println(priorityBlockingQueue); System.out.println(priorityBlockingQueue.take()); System.out.println(priorityBlockingQueue); System.out.println(priorityBlockingQueue.take()); System.out.println(priorityBlockingQueue); } } æ‰“å°ç»“æœï¼š [Person{id=2, name='èµµå…­'}, Person{id=6, name='ç‹äº”'}, Person{id=7, name='æå››'}, Person{id=9, name='å¼ ä¸‰'}] Person{id=2, name='èµµå…­'} [Person{id=6, name='ç‹äº”'}, Person{id=9, name='å¼ ä¸‰'}, Person{id=7, name='æå››'}] Person{id=6, name='ç‹äº”'} [Person{id=7, name='æå››'}, Person{id=9, name='å¼ ä¸‰'}] å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€æ¬¡å–å‡ºçš„æ˜¯ id æœ€å°å€¼ 2ï¼Œ ç¬¬äºŒæ¬¡å–å‡ºçš„æ˜¯ 6 ã€‚ 5ï¼‰DelayQueue è¿™æ˜¯ä¸€ä¸ªå¸¦æœ‰å»¶è¿Ÿæ—¶é—´çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚é˜Ÿåˆ—ä¸­çš„å…ƒç´ ï¼Œåªæœ‰ç­‰å»¶æ—¶æ—¶é—´åˆ°äº†ï¼Œæ‰èƒ½å–å‡ºæ¥ã€‚æ­¤é˜Ÿåˆ—ä¸€èˆ¬ç”¨äºè¿‡æœŸæ•°æ®çš„åˆ é™¤ï¼Œæˆ–ä»»åŠ¡è°ƒåº¦ã€‚ä»¥ä¸‹ï¼Œæ¨¡æ‹Ÿä¸€ä¸‹å®šé•¿æ—¶é—´çš„æ•°æ®åˆ é™¤ã€‚ é¦–å…ˆå®šä¹‰æ•°æ®å…ƒç´ ï¼Œéœ€è¦å®ç° Delayed æ¥å£ï¼Œå®ç° getDelay æ–¹æ³•ç”¨äºè®¡ç®—å‰©ä½™æ—¶é—´ï¼Œå’Œ CompareToæ–¹æ³•ç”¨äºä¼˜å…ˆçº§æ’åºã€‚ public class DelayData implements Delayed { private int id; private String name; //æ•°æ®åˆ°æœŸæ—¶é—´ private long endTime; private TimeUnit timeUnit = TimeUnit.MILLISECONDS; public int getId() { return id; } public void setId(int id) { this.id = id; } public String getName() { return name; } public void setName(String name) { this.name = name; } public long getEndTime() { return endTime; } public void setEndTime(long endTime) { this.endTime = endTime; } public DelayData(int id, String name, long endTime) { this.id = id; this.name = name; //éœ€è¦æŠŠä¼ å…¥çš„æ—¶é—´endTime åŠ ä¸Šå½“å‰ç³»ç»Ÿæ—¶é—´ï¼Œä½œä¸ºæ•°æ®çš„åˆ°æœŸæ—¶é—´ this.endTime = endTime + System.currentTimeMillis(); } public DelayData() { } @Override public long getDelay(TimeUnit unit) { return this.endTime - System.currentTimeMillis(); } @Override public int compareTo(Delayed o) { return o.getDelay(this.timeUnit) - this.getDelay(this.timeUnit) &lt; 0 ? 1: -1; } } æ¨¡æ‹Ÿä¸‰æ¡æ•°æ®ï¼Œåˆ†åˆ«è®¾ç½®ä¸åŒçš„è¿‡æœŸæ—¶é—´ï¼š public class ProcessData { public static void main(String[] args) throws InterruptedException { DelayQueue&lt;DelayData&gt; delayQueue = new DelayQueue&lt;&gt;(); DelayData a = new DelayData(5, &quot;A&quot;, 5000); DelayData b = new DelayData(8, &quot;B&quot;, 8000); DelayData c = new DelayData(2, &quot;C&quot;, 2000); delayQueue.add(a); delayQueue.add(b); delayQueue.add(c); System.out.println(&quot;å¼€å§‹è®¡æ—¶æ—¶é—´:&quot; + System.currentTimeMillis()); for (int i = 0; i &lt; 3; i++) { DelayData data = delayQueue.take(); System.out.println(&quot;id:&quot;+data.getId()+&quot;ï¼Œæ•°æ®:&quot;+data.getName()+&quot;è¢«ç§»é™¤ï¼Œå½“å‰æ—¶é—´:&quot;+System.currentTimeMillis()); } } } æœ€åç»“æœï¼š å¼€å§‹è®¡æ—¶æ—¶é—´:1583333583216 id:2ï¼Œæ•°æ®:Cè¢«ç§»é™¤ï¼Œå½“å‰æ—¶é—´:1583333585216 id:5ï¼Œæ•°æ®:Aè¢«ç§»é™¤ï¼Œå½“å‰æ—¶é—´:1583333588216 id:8ï¼Œæ•°æ®:Bè¢«ç§»é™¤ï¼Œå½“å‰æ—¶é—´:1583333591216 å¯ä»¥çœ‹åˆ°ï¼Œæ•°æ®æ˜¯æŒ‰è¿‡æœŸæ—¶é—´é•¿çŸ­ï¼ŒæŒ‰é¡ºåºç§»é™¤çš„ã€‚Cçš„æ—¶é—´æœ€çŸ­ 2 ç§’ï¼Œç„¶åè¿‡äº† 3 ç§’ A ä¹Ÿè¿‡æœŸï¼Œå†è¿‡ 3 ç§’ï¼ŒB è¿‡æœŸã€‚ ","link":"https://tianxiawuhao.github.io/volSqv4Kf/"},{"title":"Redisçš„ç¼“å­˜æ·˜æ±°ç­–ç•¥LRU","content":"redisç¼“å­˜æ·˜æ±°ç­–ç•¥ä¸Redisé”®çš„è¿‡æœŸåˆ é™¤ç­–ç•¥å¹¶ä¸å®Œå…¨ç›¸åŒï¼Œå‰è€…æ˜¯åœ¨Rediså†…å­˜ä½¿ç”¨è¶…è¿‡ä¸€å®šå€¼çš„æ—¶å€™ï¼ˆä¸€èˆ¬è¿™ä¸ªå€¼å¯ä»¥é…ç½®ï¼‰ä½¿ç”¨çš„æ·˜æ±°ç­–ç•¥ï¼›è€Œåè€…æ˜¯é€šè¿‡å®šæœŸåˆ é™¤+æƒ°æ€§åˆ é™¤ä¸¤è€…ç»“åˆçš„æ–¹å¼è¿›è¡Œå†…å­˜æ·˜æ±°çš„ã€‚ Rediså†…å­˜ä¸è¶³çš„ç¼“å­˜æ·˜æ±°ç­–ç•¥ noevictionï¼šå½“å†…å­˜ä½¿ç”¨è¶…è¿‡é…ç½®çš„æ—¶å€™ä¼šè¿”å›é”™è¯¯ï¼Œä¸ä¼šé©±é€ä»»ä½•é”® allkeys-lruï¼šåŠ å…¥é”®çš„æ—¶å€™ï¼Œå¦‚æœè¿‡é™ï¼Œé¦–å…ˆé€šè¿‡LRUç®—æ³•é©±é€æœ€ä¹…æ²¡æœ‰ä½¿ç”¨çš„é”® volatile-lruï¼šåŠ å…¥é”®çš„æ—¶å€™å¦‚æœè¿‡é™ï¼Œé¦–å…ˆä»è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®é›†åˆä¸­é©±é€æœ€ä¹…æ²¡æœ‰ä½¿ç”¨çš„é”® allkeys-randomï¼šåŠ å…¥é”®çš„æ—¶å€™å¦‚æœè¿‡é™ï¼Œä»æ‰€æœ‰keyéšæœºåˆ é™¤ volatile-randomï¼šåŠ å…¥é”®çš„æ—¶å€™å¦‚æœè¿‡é™ï¼Œä»è¿‡æœŸé”®çš„é›†åˆä¸­éšæœºé©±é€ volatile-ttlï¼šä»é…ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ä¸­é©±é€é©¬ä¸Šå°±è¦è¿‡æœŸçš„é”® volatile-lfuï¼šä»æ‰€æœ‰é…ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ä¸­é©±é€ä½¿ç”¨é¢‘ç‡æœ€å°‘çš„é”® allkeys-lfuï¼šä»æ‰€æœ‰é”®ä¸­é©±é€ä½¿ç”¨é¢‘ç‡æœ€å°‘çš„é”® lruç®—æ³•å®ç° å–å·§ç®—æ³• import java.util.LinkedHashMap; import java.util.Map; class LRUCache&lt;K,V&gt; extends LinkedHashMap&lt;K,V&gt; { private int capacity; /** * the ordering mode * - &lt;tt&gt;true&lt;/tt&gt; for access-order, * - &lt;tt&gt;false&lt;/tt&gt; for insertion-order * @param capacity */ public LRUCache(int capacity) { super(capacity, 0.75F, true); this.capacity = capacity; } //æ•°æ®è¶…è¿‡å®¹é‡å¤§å°åˆ é™¤ @Override protected boolean removeEldestEntry(Map.Entry&lt;K,V&gt; eldest) { return super.size()&gt;capacity; } } æ•°æ®ç»“æ„å®ç° import java.util.HashMap; import java.util.Map; class LRUCacheDemo { //æ„å»ºæ‰¿è½½ä½“node class Node&lt;K, V&gt; { K key; V value; Node&lt;K, V&gt; prev; Node&lt;K, V&gt; next; public Node() { this.prev = this.next = null; } public Node(K key, V value) { this.key = key; this.value = value; this.prev = this.next = null; } } //æ„å»ºåŒå‘é˜Ÿåˆ— class DoubleLinkedList&lt;K, V&gt; { Node&lt;K, V&gt; head; Node&lt;K, V&gt; tail; public DoubleLinkedList() { head = new Node&lt;&gt;(); tail = new Node&lt;&gt;(); head.next = tail; tail.prev = head; } //æ·»åŠ å¤´èŠ‚ç‚¹ public void addHead(Node&lt;K, V&gt; node) { node.next = head.next; node.prev = head; head.next.prev = node; head.next = node; } //åˆ é™¤èŠ‚ç‚¹ public void removeNode(Node&lt;K, V&gt; node) { node.next.prev = node.prev; node.prev.next = node.next; node.prev = null; node.next = null; } //è·å–æœ€åä¸€ä¸ªèŠ‚ç‚¹ public Node getLast() { return tail.prev; } } private int cacheSize; Map&lt;Object, Node&lt;Object, Object&gt;&gt; map; DoubleLinkedList&lt;Object, Object&gt; doubleLinkedList; public LRUCacheDemo(int cacheSize) { this.cacheSize = cacheSize; this.map = new HashMap&lt;&gt;(); this.doubleLinkedList = new DoubleLinkedList&lt;&gt;(); } public Object get(Object key) { if (!map.containsKey(key)) { return -1; } final Node&lt;Object, Object&gt; node = map.get(key); this.doubleLinkedList.removeNode(node); this.doubleLinkedList.addHead(node); return node.value; } public void put(Object key, Object value) { if (map.containsKey(key)) { final Node&lt;Object, Object&gt; node = map.get(key); node.value = value; map.put(key, node); this.doubleLinkedList.removeNode(node); this.doubleLinkedList.addHead(node); }else{ if(map.size()==this.cacheSize){ final Node last = this.doubleLinkedList.getLast(); map.remove(last.key); doubleLinkedList.removeNode(last); } //æ–°å¢ Node&lt;Object,Object&gt; newNode=new Node&lt;&gt;(key,value); map.put(key, newNode); this.doubleLinkedList.addHead(newNode); } } } ","link":"https://tianxiawuhao.github.io/bGEB86JC1/"},{"title":"listã€setã€mapç­‰é›†åˆç±»çº¿ç¨‹ä¸å®‰å…¨çš„é—®é¢˜åŠè§£å†³æ–¹æ³•","content":"List ArrayListä¸æ˜¯çº¿ç¨‹å®‰å…¨ç±»ï¼Œåœ¨å¤šçº¿ç¨‹åŒæ—¶å†™çš„æƒ…å†µä¸‹ï¼Œä¼šæŠ›å‡ºjava.util.ConcurrentModificationExceptionå¼‚å¸¸ã€‚ private static void listNotSafe() { List&lt;String&gt; list=new ArrayList&lt;&gt;(); for (int i = 1; i &lt;= 30; i++) { new Thread(() -&gt; { list.add(UUID.randomUUID().toString().substring(0, 8)); System.out.println(Thread.currentThread().getName() + &quot;\\t&quot; + list); }, String.valueOf(i)).start(); } } è§£å†³æ–¹æ³•ï¼š ä½¿ç”¨Vectorï¼ˆArrayListæ‰€æœ‰æ–¹æ³•åŠ synchronizedï¼Œå¤ªé‡ï¼‰ã€‚ ä½¿ç”¨Collections.synchronizedList()è½¬æ¢æˆçº¿ç¨‹å®‰å…¨ç±»ã€‚ ä½¿ç”¨java.concurrent.CopyOnWriteArrayListï¼ˆæ¨èï¼‰ã€‚ CopyOnWriteArrayListè¿™æ˜¯JUCçš„ç±»ï¼Œé€šè¿‡å†™æ—¶å¤åˆ¶æ¥å®ç°è¯»å†™åˆ†ç¦»ã€‚æ¯”å¦‚å…¶add()æ–¹æ³•ï¼Œå°±æ˜¯å…ˆå¤åˆ¶ä¸€ä¸ªæ–°æ•°ç»„ï¼Œé•¿åº¦ä¸ºåŸæ•°ç»„é•¿åº¦+1ï¼Œç„¶åå°†æ–°æ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ è®¾ä¸ºæ·»åŠ çš„å…ƒç´ ã€‚ public boolean add(E e) { final ReentrantLock lock = this.lock; lock.lock(); try { //å¾—åˆ°æ—§æ•°ç»„ Object[] elements = getArray(); int len = elements.length; //å¤åˆ¶æ–°æ•°ç»„ Object[] newElements = Arrays.copyOf(elements, len + 1); //è®¾ç½®æ–°å…ƒç´  newElements[len] = e; //è®¾ç½®æ–°æ•°ç»„ setArray(newElements); return true; } finally { lock.unlock(); } } Set è·ŸListç±»ä¼¼ï¼ŒHashSetå’ŒTreeSetéƒ½ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸ä¹‹å¯¹åº”çš„æœ‰CopyOnWriteSetè¿™ä¸ªçº¿ç¨‹å®‰å…¨ç±»ã€‚è¿™ä¸ªç±»åº•å±‚ç»´æŠ¤äº†ä¸€ä¸ªCopyOnWriteArrayListæ•°ç»„ã€‚ private final CopyOnWriteArrayList&lt;E&gt; al; public CopyOnWriteArraySet() { al = new CopyOnWriteArrayList&lt;E&gt;(); } ä½¿ç”¨Collections.synchronizedList()è½¬æ¢æˆçº¿ç¨‹å®‰å…¨ç±»ã€‚ HashSetå’ŒHashMap HashSetåº•å±‚æ˜¯ç”¨HashMapå®ç°çš„ã€‚æ—¢ç„¶æ˜¯ç”¨HashMapå®ç°çš„ï¼Œé‚£HashMap.put()éœ€è¦ä¼ ä¸¤ä¸ªå‚æ•°ï¼Œè€ŒHashSet.add()åªä¼ ä¸€ä¸ªå‚æ•°ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿå®é™…ä¸ŠHashSet.add()å°±æ˜¯è°ƒç”¨çš„HashMap.put()ï¼Œåªä¸è¿‡Valueè¢«å†™æ­»äº†ï¼Œæ˜¯ä¸€ä¸ªprivate static final Objectå¯¹è±¡ã€‚ Map HashMapä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ŒHashtableæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯è·ŸVectorç±»ä¼¼ï¼Œå¤ªé‡é‡çº§ã€‚æ‰€ä»¥ä¹Ÿæœ‰ç±»ä¼¼CopyOnWriteMapï¼Œåªä¸è¿‡å«ConcurrentHashMapã€‚ å…³äºé›†åˆå®‰å…¨ç±» import java.util.*; import java.util.concurrent.ConcurrentHashMap; import java.util.concurrent.CopyOnWriteArrayList; import java.util.concurrent.CopyOnWriteArraySet; public class ContainerNotSafeDemo { public static void main(String[] args) { listNotSafe(); setNoSafe(); mapNotSafe(); } private static void mapNotSafe() { //Map&lt;String,String&gt; map=new HashMap&lt;&gt;(); Map&lt;String, String&gt; map = new ConcurrentHashMap&lt;&gt;(); for (int i = 1; i &lt;= 30; i++) { new Thread(() -&gt; { map.put(Thread.currentThread().getName(), UUID.randomUUID().toString().substring(0, 8)); System.out.println(Thread.currentThread().getName() + &quot;\\t&quot; + map); }, String.valueOf(i)).start(); } } private static void setNoSafe() { //Set&lt;String&gt; set=new HashSet&lt;&gt;(); Set&lt;String&gt; set = new CopyOnWriteArraySet&lt;&gt;(); for (int i = 1; i &lt;= 30; i++) { new Thread(() -&gt; { set.add(UUID.randomUUID().toString().substring(0, 8)); System.out.println(Thread.currentThread().getName() + &quot;\\t&quot; + set); }, String.valueOf(i)).start(); } } private static void listNotSafe() { //List&lt;String&gt; list=new ArrayList&lt;&gt;(); List&lt;String&gt; list = new CopyOnWriteArrayList&lt;&gt;(); for (int i = 1; i &lt;= 30; i++) { new Thread(() -&gt; { list.add(UUID.randomUUID().toString().substring(0, 8)); System.out.println(Thread.currentThread().getName() + &quot;\\t&quot; + list); }, String.valueOf(i)).start(); } } } ","link":"https://tianxiawuhao.github.io/GALzQf_b-/"},{"title":"gradleä¾èµ–,æ’ä»¶","content":"ä¾èµ– configurations è®¾ç½®configurations é…ç½®ä¾èµ–ä¿¡æ¯ build.gradle configurations { // é’ˆå¯¹éœ€è¦ç»„ä»¶APIçš„æ¶ˆè´¹è€…çš„é…ç½® exposedApi { // canBeResolved ä¸ºtrue åˆ™ä¸ºå¯è§£æé…ç½®ï¼Œä¸ºæ¶ˆè´¹è€… canBeResolved = false // canBeConsumed ä¸ºtrue åˆ™ä¸ºæ¶ˆè´¹æé…ç½®ï¼Œä¸ºç”Ÿäº§è€… canBeConsumed = true } // ä¸ºéœ€è¦å®ç°è¯¥ç»„ä»¶çš„æ¶ˆè´¹è€…æä¾›çš„é…ç½®ã€‚ exposedRuntime { canBeResolved = false canBeConsumed = true } } ä¾èµ–æ–¹å¼ æ¨¡å—ä¾èµ– build.gradle dependencies { runtimeOnly group: 'org.springframework', name: 'spring-core', version: '2.5' runtimeOnly 'org.springframework:spring-core:2.5', 'org.springframework:spring-aop:2.5' runtimeOnly( [group: 'org.springframework', name: 'spring-core', version: '2.5'], [group: 'org.springframework', name: 'spring-aop', version: '2.5'] ) runtimeOnly('org.hibernate:hibernate:3.0.5') { transitive = true } runtimeOnly group: 'org.hibernate', name: 'hibernate', version: '3.0.5', transitive: true runtimeOnly(group: 'org.hibernate', name: 'hibernate', version: '3.0.5') { transitive = true } } æ–‡ä»¶ä¾èµ– build.gradle dependencies { runtimeOnly files('libs/a.jar', 'libs/b.jar') runtimeOnly fileTree('libs') { include '*.jar' } } é¡¹ç›®ä¾èµ– build.gradle dependencies { implementation project(':shared') } ä¾èµ–æ–¹å¼ compileOnly â€”ç”¨äºç¼–è¯‘ç”Ÿäº§ä»£ç æ‰€å¿…éœ€çš„ä¾èµ–å…³ç³»ï¼Œä½†ä¸åº”è¯¥å±äºè¿è¡Œæ—¶ç±»è·¯å¾„çš„ä¸€éƒ¨åˆ† implementationï¼ˆå–ä»£compileï¼‰-ç”¨äºç¼–è¯‘å’Œè¿è¡Œæ—¶ runtimeOnlyï¼ˆå–ä»£runtimeï¼‰-ä»…åœ¨è¿è¡Œæ—¶ä½¿ç”¨ï¼Œä¸ç”¨äºç¼–è¯‘ testCompileOnlyâ€”ä¸compileOnlyæµ‹è¯•ç›¸åŒ testImplementation â€”æµ‹è¯•ç›¸å½“äº implementation testRuntimeOnly â€”æµ‹è¯•ç›¸å½“äº runtimeOnly repositories æµè¡Œçš„å…¬å…±å­˜å‚¨åº“åŒ…æ‹¬Maven Centralï¼Œ Bintray JCenterå’ŒGoogle Androidå­˜å‚¨åº“ã€‚ repositories { mavenCentral() // Maven Centralå­˜å‚¨åº“ jcenter() // JCenter Mavenå­˜å‚¨åº“ google() // Google Mavenå­˜å‚¨åº“ mavenLocal() // å°†æœ¬åœ°Mavenç¼“å­˜æ·»åŠ ä¸ºå­˜å‚¨åº“ï¼ˆä¸æ¨èï¼‰ //flatå­˜å‚¨åº“è§£æå™¨ flatDir { dirs 'lib' } flatDir { dirs 'lib1', 'lib2' } //æ·»åŠ å®šåˆ¶çš„Mavenä»“åº“ maven { url &quot;http://repo.mycompany.com/maven2&quot; // ä¸ºJARæ–‡ä»¶æ·»åŠ é™„åŠ çš„Mavenå­˜å‚¨åº“ artifactUrls &quot;http://repo.mycompany.com/jars&quot; } //Ivy ivy { url &quot;http://repo.mycompany.com/repo&quot; layout &quot;maven&quot; // æœ‰æ•ˆçš„å‘½åå¸ƒå±€å€¼æ˜¯'gradle'ï¼ˆé»˜è®¤å€¼ï¼‰'maven'å’Œ'ivy'ã€‚ } } å£°æ˜å­˜å‚¨åº“è¿‡æ»¤å™¨ å£°æ˜å­˜å‚¨åº“å†…å®¹ build.gradle repositories { maven { url &quot;https://repo.mycompany.com/maven2&quot; content { // this repository *only* contains artifacts with group &quot;my.company&quot; includeGroup &quot;my.company&quot; } } jcenter { content { // this repository contains everything BUT artifacts with group starting with &quot;my.company&quot; excludeGroupByRegex &quot;my\\\\.company.*&quot; } } } é»˜è®¤æƒ…å†µä¸‹ï¼Œå­˜å‚¨åº“åŒ…å«æ‰€æœ‰å†…å®¹ï¼Œä¸åŒ…å«ä»»ä½•å†…å®¹ï¼š å¦‚æœå£°æ˜includeï¼Œé‚£ä¹ˆå®ƒæ’é™¤äº†ä¸€åˆ‡ include ä»¥å¤–çš„å†…å®¹ã€‚ å¦‚æœå£°æ˜excludeï¼Œåˆ™å®ƒå°†åŒ…æ‹¬é™¤excludeä¹‹å¤–çš„æ‰€æœ‰å†…å®¹ã€‚ å¦‚æœå£°æ˜includeå’Œexcludeï¼Œåˆ™å®ƒä»…åŒ…æ‹¬æ˜¾å¼åŒ…æ‹¬ä½†ä¸æ’é™¤çš„å†…å®¹ã€‚ åˆ†å‰²å¿«ç…§å’Œå‘è¡Œç‰ˆ build.gradle repositories { maven { url &quot;https://repo.mycompany.com/releases&quot; mavenContent { releasesOnly() } } maven { url &quot;https://repo.mycompany.com/snapshots&quot; mavenContent { snapshotsOnly() } } } æ”¯æŒçš„å…ƒæ•°æ®æº å—æ”¯æŒçš„å…ƒæ•°æ®æº å…ƒæ•°æ®æº æè¿° æ’åº Maven Ivy/flat dir gradleMetadata() å¯»æ‰¾Gradle.moduleæ–‡ä»¶ 1 æ˜¯ æ˜¯ mavenPom() æŸ¥æ‰¾Maven.pomæ–‡ä»¶ 2 æ˜¯ æ˜¯ ivyDescriptor() æŸ¥æ‰¾ivy.xmlæ–‡ä»¶ 2 æ²¡æœ‰ æ˜¯ artifact() ç›´æ¥å¯»æ‰¾artifact 3 æ˜¯ æ˜¯ ä»Gradle 5.3å¼€å§‹ï¼Œè§£æå…ƒæ•°æ®æ–‡ä»¶ï¼ˆæ— è®ºæ˜¯Ivyè¿˜æ˜¯Mavenï¼‰æ—¶ï¼ŒGradleå°†å¯»æ‰¾ä¸€ä¸ªæ ‡è®°ï¼ŒæŒ‡ç¤ºå­˜åœ¨åŒ¹é…çš„Gradle Moduleå…ƒæ•°æ®æ–‡ä»¶ã€‚å¦‚æœæ‰¾åˆ°å®ƒï¼Œå®ƒå°†ä»£æ›¿Ivyæˆ–Mavenæ–‡ä»¶ä½¿ç”¨ã€‚ ä»Gradle5.6å¼€å§‹ï¼Œæ‚¨å¯ä»¥é€šè¿‡æ·»åŠ ignoreGradleMetadataRedirection()åˆ°metadataSourceså£°æ˜æ¥ç¦ç”¨æ­¤è¡Œä¸ºã€‚ ä¾‹.ä¸ä½¿ç”¨gradleå…ƒæ•°æ®é‡å®šå‘çš„Mavenå­˜å‚¨åº“ build.gradle repositories { maven { url &quot;http://repo.mycompany.com/repo&quot; metadataSources { mavenPom() artifact() ignoreGradleMetadataRedirection() } } } GAVåæ ‡ GAVåæ ‡ä¸€èˆ¬æŒ‡groupï¼Œartifactï¼Œversion å˜ä½“ æ„å»ºå˜ä½“æ˜¯é’ˆå¯¹ä¸åŒç¯å¢ƒçš„é…ç½®ï¼Œä¾‹å¦‚androidå¼€å‘ä¸­ä¸€èˆ¬æœ‰debugå’Œreleaseä¸¤ç§å˜ä½“ å£°æ˜åŠŸèƒ½å˜ä½“ å¯ä»¥é€šè¿‡åº”ç”¨javaæˆ–java-libraryæ’ä»¶æ¥å£°æ˜åŠŸèƒ½å˜ä½“ã€‚ä»¥ä¸‹ä»£ç è¯´æ˜äº†å¦‚ä½•å£°æ˜åä¸ºmongodbSupportçš„åŠŸèƒ½ï¼š ç¤ºä¾‹1.å£°æ˜ä¸€ä¸ªåŠŸèƒ½å˜é‡ Groovy``Kotlin build.gradle group = 'org.gradle.demo' version = '1.0' java { registerFeature('mongodbSupport') { usingSourceSet(sourceSets.main) } } å…ƒæ•°æ® ä»å­˜å‚¨åº“ä¸­æå–çš„æ¯ä¸ªæ¨¡å—éƒ½æœ‰ä¸ä¹‹å…³è”çš„å…ƒæ•°æ®ï¼Œä¾‹å¦‚å…¶ç»„ï¼Œåç§°ï¼Œç‰ˆæœ¬ä»¥åŠå®ƒæä¾›çš„å¸¦æœ‰å·¥ä»¶å’Œä¾èµ–é¡¹çš„ä¸åŒå˜ä½“ å¯é…ç½®ç»„ä»¶å…ƒæ•°æ®è§„åˆ™çš„ç¤ºä¾‹ build.gradle class TargetJvmVersionRule implements ComponentMetadataRule { final Integer jvmVersion @Inject TargetJvmVersionRule(Integer jvmVersion) { this.jvmVersion = jvmVersion } @Inject ObjectFactory getObjects() { } void execute(ComponentMetadataContext context) { context.details.withVariant(&quot;compile&quot;) { attributes { attribute(TargetJvmVersion.TARGET_JVM_VERSION_ATTRIBUTE, jvmVersion) attribute(Usage.USAGE_ATTRIBUTE, objects.named(Usage, Usage.JAVA_API)) } } } } dependencies { components { withModule(&quot;commons-io:commons-io&quot;, TargetJvmVersionRule) { params(7) } withModule(&quot;commons-collections:commons-collections&quot;, TargetJvmVersionRule) { params(8) } } implementation(&quot;commons-io:commons-io:2.6&quot;) implementation(&quot;commons-collections:commons-collections:3.2.2&quot;) } å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•è¿›è¡Œä¿®æ”¹å˜ä½“ï¼š allVariantsï¼šä¿®æ”¹ç»„ä»¶çš„æ‰€æœ‰å˜ä½“ withVariant(name)ï¼šä¿®æ”¹ç”±åç§°æ ‡è¯†çš„å•ä¸ªå˜ä½“ addVariant(name)æˆ–addVariant(name, base)ï¼šä»å¤´å¼€å§‹ æˆ–é€šè¿‡ å¤åˆ¶ ç°æœ‰å˜ä½“çš„è¯¦ç»†ä¿¡æ¯ï¼ˆåŸºç¡€ï¼‰å‘ç»„ä»¶æ·»åŠ æ–°å˜ä½“ å¯ä»¥è°ƒæ•´æ¯ä¸ªå˜ä½“çš„ä»¥ä¸‹è¯¦ç»†ä¿¡æ¯ï¼š æ ‡è¯†å˜ä½“çš„å±æ€§-attributes {}å— è¯¥å˜ä½“æä¾›çš„åŠŸèƒ½-withCapabilities { }å— å˜ä½“çš„ä¾èµ–é¡¹ï¼ŒåŒ…æ‹¬ä¸°å¯Œçš„ç‰ˆæœ¬-withDependencies {}å— å˜ä½“çš„ä¾èµ–å…³ç³»çº¦æŸï¼ŒåŒ…æ‹¬ä¸°å¯Œç‰ˆæœ¬-withDependencyConstraints {}å— æ„æˆå˜ä½“å®é™…å†…å®¹çš„å·²å‘å¸ƒæ–‡ä»¶çš„ä½ç½®-withFiles { }å— å¹³å° ä½¿ç”¨å¹³å° è·å–å¹³å°ä¸­å£°æ˜çš„ç‰ˆæœ¬ build.gradle dependencies { // get recommended versions from the platform project api platform(project(':platform')) // no version required api 'commons-httpclient:commons-httpclient' } platformè¡¨ç¤ºæ³•æ˜¯ä¸€ç§ç®€å†™è¡¨ç¤ºæ³•ï¼Œå®é™…ä¸Šåœ¨åå°æ‰§è¡Œäº†ä¸€äº›æ“ä½œï¼š å®ƒå°†org.gradle.categoryå±æ€§è®¾ç½®ä¸ºplatformï¼Œè¿™æ„å‘³ç€Gradleå°†é€‰æ‹©ä¾èµ–é¡¹çš„ å¹³å° ç»„ä»¶ã€‚ å®ƒé»˜è®¤è®¾ç½®endorseStrictVersionsè¡Œä¸ºï¼Œ è¿™æ„å‘³ç€å¦‚æœå¹³å°å£°æ˜äº†ä¸¥æ ¼çš„ä¾èµ–å…³ç³»ï¼Œåˆ™å°†å¼ºåˆ¶æ‰§è¡Œå®ƒä»¬ã€‚ è¿™æ„å‘³ç€é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯¹å¹³å°çš„ä¾èµ–é¡¹ä¼šè§¦å‘è¯¥å¹³å°ä¸­å®šä¹‰çš„æ‰€æœ‰ä¸¥æ ¼ç‰ˆæœ¬çš„ç»§æ‰¿ï¼Œ è¿™å¯¹äºå¹³å°ä½œè€…ç¡®ä¿æ‰€æœ‰ä½¿ç”¨è€…åœ¨ä¾èµ–é¡¹çš„ç‰ˆæœ¬æ–¹é¢éƒ½éµå¾ªè‡ªå·±çš„å†³å®šå¾ˆæœ‰ç”¨ã€‚ å¯ä»¥é€šè¿‡æ˜¾å¼è°ƒç”¨doNotEndorseStrictVersionsæ–¹æ³•æ¥å°†å…¶å…³é—­ã€‚ ä¾‹.ä¾é ä¸€ä¸ªBOMå¯¼å…¥å…¶ä¾èµ–çº¦æŸ build.gradle dependencies { // import a BOM implementation platform('org.springframework.boot:spring-boot-dependencies:1.5.8.RELEASE') // define dependencies without versions implementation 'com.google.code.gson:gson' implementation 'dom4j:dom4j' } å¯¼å…¥BOMï¼Œç¡®ä¿å…¶å®šä¹‰çš„ç‰ˆæœ¬è¦†ç›–æ‰¾åˆ°çš„ä»»ä½•å…¶ä»–ç‰ˆæœ¬ build.gradle dependencies { // import a BOM. The versions used in this file will override any other version found in the graph implementation enforcedPlatform('org.springframework.boot:spring-boot-dependencies:1.5.8.RELEASE') // define dependencies without versions implementation 'com.google.code.gson:gson' implementation 'dom4j:dom4j' // this version will be overridden by the one found in the BOM implementation 'org.codehaus.groovy:groovy:1.8.6' } Capability å£°æ˜ç»„ä»¶çš„capability build.gradle configurations { apiElements { outgoing { capability(&quot;com.acme:my-library:1.0&quot;) capability(&quot;com.other:module:1.1&quot;) } } runtimeElements { outgoing { capability(&quot;com.acme:my-library:1.0&quot;) capability(&quot;com.other:module:1.1&quot;) } } } è§£å†³å†²çª æŒ‰Capabilityï¼ˆèƒ½åŠ›ï¼‰è§£å†³å†²çªï¼Œï¼ˆè‹¥å­˜åœ¨ç›¸åŒèƒ½åŠ›çš„ä¾èµ–æ€§ä¼šå¤±è´¥ï¼‰ build.gradle @CompileStatic class AsmCapability implements ComponentMetadataRule { void execute(ComponentMetadataContext context) { context.details.with { if (id.group == &quot;asm&quot; &amp;&amp; id.name == &quot;asm&quot;) { allVariants { it.withCapabilities { // Declare that ASM provides the org.ow2.asm:asm capability, but with an older version it.addCapability(&quot;org.ow2.asm&quot;, &quot;asm&quot;, id.version) } } } } } } ä¸€ä¸ªå¸¦æœ‰æ—¥å¿—æ¡†æ¶éšå¼å†²çªçš„æ„å»ºæ–‡ä»¶ build.gradle dependencies { // Activate the &quot;LoggingCapability&quot; rule components.all(LoggingCapability) } @CompileStatic class LoggingCapability implements ComponentMetadataRule { final static Set&lt;String&gt; LOGGING_MODULES = [&quot;log4j&quot;, &quot;log4j-over-slf4j&quot;] as Set&lt;String&gt; void execute(ComponentMetadataContext context) { context.details.with { if (LOGGING_MODULES.contains(id.name)) { allVariants { it.withCapabilities { // Declare that both log4j and log4j-over-slf4j provide the same capability it.addCapability(&quot;log4j&quot;, &quot;log4j&quot;, id.version) } } } } } } ç‰ˆæœ¬ ç‰ˆæœ¬è§„åˆ™ Gradleæ”¯æŒä¸åŒçš„ç‰ˆæœ¬å­—ç¬¦ä¸²å£°æ˜æ–¹å¼ï¼š ä¸€ä¸ªç¡®åˆ‡çš„ç‰ˆæœ¬ï¼šæ¯”å¦‚1.3ï¼Œ1.3.0-beta3ï¼Œ1.0-20150201.131010-1 ä¸€ä¸ªMavené£æ ¼çš„ç‰ˆæœ¬èŒƒå›´ï¼šä¾‹å¦‚ [1.0,) [1.1, 2.0) (1.2, 1.5] [å’Œ]çš„ç¬¦å·è¡¨ç¤ºåŒ…å«æ€§çº¦æŸ; (å’Œ)è¡¨ç¤ºæ’ä»–æ€§çº¦æŸã€‚ å½“ä¸Šç•Œæˆ–ä¸‹ç•Œç¼ºå¤±æ—¶ï¼Œè¯¥èŒƒå›´æ²¡æœ‰ä¸Šç•Œæˆ–ä¸‹ç•Œã€‚ ç¬¦å·]å¯ä»¥è¢«ç”¨æ¥ä»£æ›¿(ç”¨äºæ’ä»–æ€§ä¸‹ç•Œï¼Œ[ä»£æ›¿)ç”¨äºæ’ä»–æ€§ä¸Šç•Œã€‚ä¾‹å¦‚]1.0, 2.0[ å‰ç¼€ç‰ˆæœ¬èŒƒå›´ï¼šä¾‹å¦‚ 1.+ 1.3.+ ä»…åŒ…å«ä¸+ä¹‹å‰éƒ¨åˆ†å®Œå…¨åŒ¹é…çš„ç‰ˆæœ¬ã€‚ +æœ¬èº«çš„èŒƒå›´å°†åŒ…æ‹¬ä»»ä½•ç‰ˆæœ¬ã€‚ ä¸€ä¸ªlatest-statusç‰ˆæœ¬ï¼šä¾‹å¦‚latest.integrationï¼Œlatest.release Mavençš„SNAPSHOTç‰ˆæœ¬æ ‡è¯†ç¬¦ï¼šä¾‹å¦‚1.0-SNAPSHOTï¼Œ1.4.9-beta1-SNAPSHOT ç‰ˆæœ¬æ’åº æ¯ä¸ªç‰ˆæœ¬å‡åˆ†ä¸ºå…¶ç»„æˆçš„â€œéƒ¨åˆ†â€ï¼š å­—ç¬¦[. - _ +]ç”¨äºåˆ†éš”ç‰ˆæœ¬çš„ä¸åŒâ€œéƒ¨åˆ†â€ã€‚ åŒæ—¶åŒ…å«æ•°å­—å’Œå­—æ¯çš„ä»»ä½•éƒ¨åˆ†éƒ½å°†åˆ†ä¸ºä»¥ä¸‹å„ä¸ªéƒ¨åˆ†ï¼š 1a1 == 1.a.1 ä»…æ¯”è¾ƒç‰ˆæœ¬çš„å„ä¸ªéƒ¨åˆ†ã€‚å®é™…çš„åˆ†éš”ç¬¦å¹¶ä¸é‡è¦ï¼š1.a.1 == 1-a+1 == 1.a-1 == 1a1 ä½¿ç”¨ä»¥ä¸‹è§„åˆ™æ¯”è¾ƒ2ä¸ªç‰ˆæœ¬çš„ç­‰æ•ˆéƒ¨åˆ†ï¼š å¦‚æœä¸¤ä¸ªéƒ¨åˆ†éƒ½æ˜¯æ•°å­—ï¼Œåˆ™æœ€é«˜æ•°å­—å€¼ è¾ƒé«˜ ï¼š1.1&lt;1.2 å¦‚æœä¸€ä¸ªéƒ¨åˆ†æ˜¯æ•°å€¼ï¼Œåˆ™è®¤ä¸ºå®ƒ é«˜äº éæ•°å­—éƒ¨åˆ†ï¼š1.a&lt;1.1 å¦‚æœä¸¤ä¸ªéƒ¨åˆ†éƒ½ä¸æ˜¯æ•°å­—ï¼Œåˆ™æŒ‰å­—æ¯é¡ºåºæ¯”è¾ƒï¼ŒåŒºåˆ†å¤§å°å†™ï¼š1.A&lt; 1.B&lt; 1.a&lt;1.b æœ‰é¢å¤–æ•°å­—éƒ¨åˆ†çš„ç‰ˆæœ¬è¢«è®¤ä¸ºæ¯”æ²¡æœ‰æ•°å­—éƒ¨åˆ†çš„ç‰ˆæœ¬é«˜ï¼š1.1&lt;1.1.0 å¸¦æœ‰é¢å¤–çš„éæ•°å­—éƒ¨åˆ†çš„ç‰ˆæœ¬è¢«è®¤ä¸ºæ¯”æ²¡æœ‰æ•°å­—éƒ¨åˆ†çš„ç‰ˆæœ¬ä½ï¼š1.1.a&lt;1.1 æŸäº›å­—ç¬¦ä¸²å€¼å‡ºäºæ’åºç›®çš„å…·æœ‰ç‰¹æ®Šå«ä¹‰ï¼š å­—ç¬¦ä¸²devè¢«è®¤ä¸ºæ¯”ä»»ä½•å…¶ä»–å­—ç¬¦ä¸²éƒ¨åˆ†ä½ï¼š1.0-dev&lt; 1.0-alpha&lt; 1.0-rcã€‚ å­—ç¬¦ä¸²rcã€releaseå’Œfinalè¢«è®¤ä¸ºæ¯”ä»»ä½•å…¶ä»–å­—ç¬¦ä¸²éƒ¨åˆ†éƒ½é«˜ï¼ˆæŒ‰é¡ºåºæ’åˆ—ï¼š1.0-zeta&lt; 1.0-rc&lt; 1.0-release&lt; 1.0-final&lt; 1.0ã€‚ å­—ç¬¦ä¸²SNAPSHOTæ²¡æœ‰ç‰¹æ®Šæ„ä¹‰ï¼Œå’Œå…¶ä»–å­—ç¬¦ä¸²éƒ¨åˆ†ä¸€æ ·æŒ‰å­—æ¯é¡ºåºæ’åºï¼š1.0-alpha&lt; 1.0-SNAPSHOT&lt; 1.0-zeta&lt; 1.0-rc&lt; 1.0ã€‚ æ•°å€¼å¿«ç…§ç‰ˆæœ¬æ²¡æœ‰ç‰¹æ®Šæ„ä¹‰ï¼Œå’Œå…¶ä»–æ•°å€¼éƒ¨åˆ†ä¸€æ ·è¿›è¡Œæ’åºï¼š1.0&lt; 1.0-20150201.121010-123&lt; 1.1ã€‚ ç®€å•æ¥è¯´:æ•°å­—&gt;final&gt;release&gt;rc&gt;å­—æ¯&gt;dev å£°æ˜æ²¡æœ‰ç‰ˆæœ¬çš„ä¾èµ– å¯¹äºè¾ƒå¤§çš„é¡¹ç›®ï¼Œå»ºè®®çš„åšæ³•æ˜¯å£°æ˜æ²¡æœ‰ç‰ˆæœ¬çš„ä¾èµ–é¡¹ï¼Œ å¹¶å°†ä¾èµ–é¡¹çº¦æŸ ç”¨äºç‰ˆæœ¬å£°æ˜ã€‚ ä¼˜åŠ¿åœ¨äºï¼Œä¾èµ–å…³ç³»çº¦æŸä½¿æ‚¨å¯ä»¥åœ¨ä¸€å¤„ç®¡ç†æ‰€æœ‰ä¾èµ–å…³ç³»çš„ç‰ˆæœ¬ï¼ŒåŒ…æ‹¬å¯ä¼ é€’çš„ä¾èµ–å…³ç³»ã€‚ build.gradle dependencies { implementation 'org.springframework:spring-web' } dependencies { constraints { implementation 'org.springframework:spring-web:5.0.2.RELEASE' } } ä¾èµ–æ–¹å¼ strictly ä¸è¯¥ç‰ˆæœ¬ç¬¦å·ä¸åŒ¹é…çš„ä»»ä½•ç‰ˆæœ¬å°†è¢«æ’é™¤ã€‚è¿™æ˜¯æœ€å¼ºçš„ç‰ˆæœ¬å£°æ˜ã€‚ åœ¨å£°æ˜çš„ä¾èµ–é¡¹ä¸Šï¼Œstrictlyå¯ä»¥é™çº§ç‰ˆæœ¬ã€‚ åœ¨ä¼ é€’ä¾èµ–é¡¹ä¸Šï¼Œå¦‚æœæ— æ³•é€‰æ‹©æ­¤å­å¥å¯æ¥å—çš„ç‰ˆæœ¬ï¼Œå°†å¯¼è‡´ä¾èµ–é¡¹è§£æå¤±è´¥ã€‚ æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§è¦†ç›–ä¾èµ–é¡¹ç‰ˆæœ¬ã€‚ è¯¥æœ¯è¯­æ”¯æŒåŠ¨æ€ç‰ˆæœ¬ã€‚ å®šä¹‰åï¼Œå°†è¦†ç›–å…ˆå‰çš„requireå£°æ˜å¹¶æ¸…é™¤ä¹‹å‰çš„ rejectã€‚ require è¡¨ç¤ºæ‰€é€‰ç‰ˆæœ¬ä¸èƒ½ä½äºrequireå¯æ¥å—çš„ç‰ˆæœ¬ï¼Œä½†å¯ä»¥é€šè¿‡å†²çªè§£å†³æ–¹æ¡ˆæé«˜ï¼Œå³ä½¿æ›´é«˜ç‰ˆæœ¬å…·æœ‰æ’ä»–æ€§æ›´é«˜çš„ç•Œé™ã€‚ è¿™å°±æ˜¯ä¾èµ–é¡¹ä¸Šçš„ç›´æ¥ç‰ˆæœ¬æ‰€è½¬æ¢çš„å†…å®¹ã€‚è¯¥æœ¯è¯­æ”¯æŒåŠ¨æ€ç‰ˆæœ¬ã€‚ å®šä¹‰åï¼Œå°†è¦†ç›–å…ˆå‰çš„strictlyå£°æ˜å¹¶æ¸…é™¤ä¹‹å‰çš„ rejectã€‚ prefer è¿™æ˜¯ä¸€ä¸ªéå¸¸è½¯çš„ç‰ˆæœ¬å£°æ˜ã€‚ä»…å½“å¯¹è¯¥æ¨¡å—çš„ç‰ˆæœ¬æ²¡æœ‰æ›´å¼ºçš„éåŠ¨æ€è§‚ç‚¹æ—¶ï¼Œæ‰é€‚ç”¨ã€‚ è¯¥æœ¯è¯­ä¸æ”¯æŒåŠ¨æ€ç‰ˆæœ¬ã€‚ å®šä¹‰å¯ä»¥è¡¥å……strictlyæˆ–requireã€‚ åœ¨çº§åˆ«å±‚æ¬¡ç»“æ„ä¹‹å¤–è¿˜æœ‰ä¸€ä¸ªé™„åŠ æœ¯è¯­ï¼š reject å£°æ˜æ¨¡å—ä¸æ¥å—ç‰¹å®šç‰ˆæœ¬ã€‚å¦‚æœå”¯ä¸€çš„å¯é€‰ç‰ˆæœ¬ä¹Ÿè¢«æ‹’ç»ï¼Œè¿™å°†å¯¼è‡´ä¾èµ–é¡¹è§£æå¤±è´¥ã€‚è¯¥æœ¯è¯­æ”¯æŒåŠ¨æ€ç‰ˆæœ¬ã€‚ åŠ¨æ€ç‰ˆæœ¬ build.gradle plugins { id 'java-library' } repositories { mavenCentral() } dependencies { implementation 'org.springframework:spring-web:5.+' } ç‰ˆæœ¬å¿«ç…§ å£°æ˜ä¸€ä¸ªç‰ˆæœ¬å˜åŒ–çš„ä¾èµ– build.gradle plugins { id 'java-library' } repositories { mavenCentral() maven { url 'https://repo.spring.io/snapshot/' } } dependencies { implementation 'org.springframework:spring-web:5.0.3.BUILD-SNAPSHOT' } ä»¥ç¼–ç¨‹æ–¹å¼æ§åˆ¶ä¾èµ–é¡¹ç¼“å­˜ æ‚¨å¯ä»¥ä½¿ç”¨ResolutionStrategy å¯¹é…ç½®è¿›è¡Œç¼–ç¨‹æ¥å¾®è°ƒç¼“å­˜çš„æŸäº›æ–¹é¢ã€‚ å¦‚æœæ‚¨æƒ³æ°¸ä¹…æ›´æ”¹è®¾ç½®ï¼Œåˆ™ç¼–ç¨‹æ–¹å¼éå¸¸æœ‰ç”¨ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒGradleå°†åŠ¨æ€ç‰ˆæœ¬ç¼“å­˜24å°æ—¶ã€‚ è¦æ›´æ”¹Gradleå°†è§£æåçš„ç‰ˆæœ¬ç¼“å­˜ä¸ºåŠ¨æ€ç‰ˆæœ¬çš„æ—¶é—´ï¼Œè¯·ä½¿ç”¨ï¼š ä¾‹.åŠ¨æ€ç‰ˆæœ¬ç¼“å­˜æ§åˆ¶ build.gradle configurations.all { resolutionStrategy.cacheDynamicVersionsFor 10, 'minutes' } é»˜è®¤æƒ…å†µä¸‹ï¼ŒGradleä¼šå°†æ›´æ”¹çš„æ¨¡å—ç¼“å­˜24å°æ—¶ã€‚ è¦æ›´æ”¹Gradleå°†ä¸ºæ›´æ”¹çš„æ¨¡å—ç¼“å­˜å…ƒæ•°æ®å’Œå·¥ä»¶çš„æ—¶é—´ï¼Œè¯·ä½¿ç”¨ï¼š ä¾‹.æ”¹å˜æ¨¡å—ç¼“å­˜æ§åˆ¶ build.gradle configurations.all { resolutionStrategy.cacheChangingModulesFor 4, 'hours' } é”å®šé…ç½® é”å®šç‰¹å®šé…ç½® build.gradle configurations { compileClasspath { resolutionStrategy.activateDependencyLocking() } } é”å®šæ‰€æœ‰é…ç½® build.gradle dependencyLocking { lockAllConfigurations() } è§£é”ç‰¹å®šé…ç½® build.gradle configurations { compileClasspath { resolutionStrategy.deactivateDependencyLocking() } } é”å®šbuildscriptç±»è·¯å¾„é…ç½® å¦‚æœå°†æ’ä»¶åº”ç”¨äºæ„å»ºï¼Œåˆ™å¯èƒ½è¿˜éœ€è¦åˆ©ç”¨ä¾èµ–é”å®šã€‚ä¸ºäº†é”å®šç”¨äºè„šæœ¬æ’ä»¶çš„classpathé…ç½®ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š build.gradle buildscript { configurations.classpath { resolutionStrategy.activateDependencyLocking() } } ä½¿ç”¨é”å®šæ¨¡å¼å¾®è°ƒä¾èµ–é¡¹é”å®šè¡Œä¸º è™½ç„¶é»˜è®¤é”å®šæ¨¡å¼çš„è¡Œä¸ºå¦‚ä¸Šæ‰€è¿°ï¼Œä½†æ˜¯è¿˜æœ‰å…¶ä»–ä¸¤ç§æ¨¡å¼å¯ç”¨ï¼š Strictæ¨¡å¼ ï¼šåœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œé™¤äº†ä¸Šè¿°éªŒè¯å¤–ï¼Œå¦‚æœè¢«æ ‡è®°ä¸ºé”å®šçš„é…ç½®æ²¡æœ‰ä¸ä¹‹ç›¸å…³è”çš„é”å®šçŠ¶æ€ï¼Œåˆ™ä¾èµ–æ€§é”å®šå°†å¤±è´¥ã€‚ Lenientæ¨¡å¼ï¼šåœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œä¾å­˜å…³ç³»é”å®šä»å°†å›ºå®šåŠ¨æ€ç‰ˆæœ¬ï¼Œä½†é™¤æ­¤ä¹‹å¤–ï¼Œä¾èµ–è§£æçš„å˜åŒ–ä¸å†æ˜¯é”™è¯¯ã€‚ é”å®šæ¨¡å¼å¯ä»¥ä»dependencyLockingå—ä¸­è¿›è¡Œæ§åˆ¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š build.gradle dependencyLocking { lockMode = LockMode.STRICT } ç‰ˆæœ¬å†²çª ç”¨forceå¼ºåˆ¶æ‰§è¡Œä¸€ä¸ªä¾èµ–ç‰ˆæœ¬ build.gradle dependencies { implementation 'org.apache.httpcomponents:httpclient:4.5.4' implementation('commons-codec:commons-codec:1.9') { force = true } } æ’é™¤ç‰¹å®šä¾èµ–å£°æ˜çš„ä¼ é€’ä¾èµ– build.gradle dependencies { implementation('commons-beanutils:commons-beanutils:1.9.4') { exclude group: 'commons-collections', module: 'commons-collections' } } ç‰ˆæœ¬å†²çªæ—¶å¤±è´¥ build.gradle configurations.all { resolutionStrategy { failOnVersionConflict() } } ä½¿ç”¨åŠ¨æ€ç‰ˆæœ¬æ—¶å¤±è´¥ build.gradle configurations.all { resolutionStrategy { failOnDynamicVersions() } } æ”¹å˜ç‰ˆæœ¬æ—¶å¤±è´¥ build.gradle configurations.all { resolutionStrategy { failOnChangingVersions() } } è§£ææ— æ³•å†ç°æ—¶å¤±è´¥ build.gradle configurations.all { resolutionStrategy { failOnNonReproducibleResolution() } } æ’ä»¶ æ’ä»¶ä½œç”¨ï¼šå°†æ’ä»¶åº”ç”¨äºé¡¹ç›®å¯ä»¥ä½¿æ’ä»¶æ‰©å±•é¡¹ç›®çš„åŠŸèƒ½ã€‚å®ƒå¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š æ‰©å±•Gradleæ¨¡å‹ï¼ˆä¾‹å¦‚ï¼Œæ·»åŠ å¯ä»¥é…ç½®çš„æ–°DSLå…ƒç´ ï¼‰ æ ¹æ®çº¦å®šé…ç½®é¡¹ç›®ï¼ˆä¾‹å¦‚ï¼Œæ·»åŠ æ–°ä»»åŠ¡æˆ–é…ç½®åˆç†çš„é»˜è®¤å€¼ï¼‰ åº”ç”¨ç‰¹å®šçš„é…ç½®ï¼ˆä¾‹å¦‚ï¼Œæ·»åŠ ç»„ç»‡å­˜å‚¨åº“æˆ–å¼ºåˆ¶æ‰§è¡Œæ ‡å‡†ï¼‰ ç®€å•æ¥è¯´ï¼Œæ’ä»¶å¯ä»¥æ‹“å±•é¡¹ç›®åŠŸèƒ½ï¼Œå¦‚ä»»åŠ¡ï¼Œä¾èµ–ï¼Œæ‹“å±•å±æ€§ï¼Œçº¦æŸ æ’ä»¶ç±»å‹ äºŒè¿›åˆ¶æ’ä»¶ ï¼šé€šè¿‡å®ç°æ’ä»¶æ¥å£ä»¥ç¼–ç¨‹æ–¹å¼ç¼–å†™äºŒè¿›åˆ¶æ’ä»¶ï¼Œæˆ–ä½¿ç”¨Gradleçš„ä¸€ç§DSLè¯­è¨€ä»¥å£°æ˜æ–¹å¼ç¼–å†™äºŒè¿›åˆ¶æ’ä»¶ è„šæœ¬æ’ä»¶ ï¼šè„šæœ¬æ’ä»¶æ˜¯å…¶ä»–æ„å»ºè„šæœ¬ï¼Œå¯ä»¥è¿›ä¸€æ­¥é…ç½®æ„å»ºï¼Œå¹¶é€šå¸¸é‡‡ç”¨å£°æ˜å¼æ–¹æ³•æ¥æ“çºµæ„å»º æ’ä»¶é€šå¸¸èµ·åˆæ˜¯è„šæœ¬æ’ä»¶ï¼ˆå› ä¸ºå®ƒä»¬æ˜“äºç¼–å†™ï¼‰ï¼Œç„¶åï¼Œéšç€ä»£ç å˜å¾—æ›´æœ‰ä»·å€¼ï¼Œå®ƒè¢«è¿ç§»åˆ°å¯ä»¥è½»æ¾æµ‹è¯•å¹¶åœ¨å¤šä¸ªé¡¹ç›®æˆ–ç»„ç»‡ä¹‹é—´å…±äº«çš„äºŒè¿›åˆ¶æ’ä»¶ã€‚ åº”ç”¨æ’ä»¶ äºŒè¿›åˆ¶æ’ä»¶ å®ç°äº†org.gradle.api.Pluginæ¥å£ apply plugin: 'com.android.application' apply plugin apply plugin: 'java' //id == apply plugin: org.gradle.api.plugins.JavaPlugin //ç±»å‹ == apply plugin: JavaPlugin //org.gradle.api.pluginsé»˜è®¤å¯¼å…¥ plugins DSL plugins { id 'java' //åº”ç”¨æ ¸å¿ƒæ’ä»¶ id 'com.jfrog.bintray' version '0.4.1' //åº”ç”¨ç¤¾åŒºæ’ä»¶ id 'com.example.hello' version '1.0.0' apply false //ä½¿ç”¨`apply false`è¯­æ³•å‘Šè¯‰Gradleä¸è¦å°†æ’ä»¶åº”ç”¨äºå½“å‰é¡¹ç›® } è„šæœ¬æ’ä»¶ è„šæœ¬æ’ä»¶ä¼šè‡ªåŠ¨è§£æï¼Œå¯ä»¥ä»æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿæˆ–è¿œç¨‹ä½ç½®çš„è„šæœ¬ä¸­åº”ç”¨ã€‚å¯ä»¥å°†å¤šä¸ªè„šæœ¬æ’ä»¶ï¼ˆä»»æ„ä¸€ç§å½¢å¼ï¼‰åº”ç”¨äºç»™å®šç›®æ ‡ã€‚ apply from:'version.gradle' applyå¯ä¼ å…¥å†…å®¹ void apply(Map&lt;String,? options); void apply(Closure closure); void apply(Action&lt;? super ObjectConfigurationAction&gt; action); å®šä¹‰æ’ä»¶ å®šä¹‰ä¸€ä¸ªå¸¦æœ‰IDçš„buildSrcæ’ä»¶ buildSrc / build.gradle plugins { id 'java-gradle-plugin' } gradlePlugin { plugins { myPlugins { id = 'my-plugin' implementationClass = 'my.MyPlugin' } } } ç¬¬ä¸‰æ–¹æ’ä»¶ é€šè¿‡å°†æ’ä»¶æ·»åŠ åˆ°æ„å»ºè„šæœ¬classpathä¸­ï¼Œç„¶ååº”ç”¨è¯¥æ’ä»¶ï¼Œå¯ä»¥å°†å·²å‘å¸ƒä¸ºå¤–éƒ¨jaræ–‡ä»¶çš„äºŒè¿›åˆ¶æ’ä»¶æ·»åŠ åˆ°é¡¹ç›®ä¸­ã€‚å¯ä»¥ä½¿ç”¨buildscript {}å—å°†å¤–éƒ¨jaræ·»åŠ åˆ°æ„å»ºè„šæœ¬classpathä¸­ã€‚ buildscript { repositories { google() jcenter() } dependencies { classpath &quot;com.android.tools.build:gradle:4.0.1&quot; } } æ’ä»¶ç®¡ç† pluginManagement {}å—åªèƒ½å‡ºç°åœ¨settings.gradleæ–‡ä»¶ä¸­ï¼Œå¿…é¡»æ˜¯æ–‡ä»¶ä¸­çš„ç¬¬ä¸€ä¸ªå—ï¼Œä¹Ÿå¯ä»¥ä»¥settingså½¢å¼å‡ºç°åœ¨åˆå§‹åŒ–è„šæœ¬ä¸­ã€‚ settings.gradle pluginManagement { plugins { } resolutionStrategy { } repositories { } } rootProject.name = 'plugin-management' init.gradle settingsEvaluated { settings -&gt; settings.pluginManagement { plugins { } resolutionStrategy { } repositories { } } } ä¾‹ï¼šé€šè¿‡pluginManagementç®¡ç†æ’ä»¶ç‰ˆæœ¬ã€‚ settings.gradle pluginManagement { plugins { id 'com.example.hello' version &quot;${helloPluginVersion}&quot; } } gradle.properties helloPluginVersion=1.0.0 è‡ªå®šä¹‰æ’ä»¶å­˜å‚¨åº“ è¦æŒ‡å®šè‡ªå®šä¹‰æ’ä»¶å­˜å‚¨åº“ï¼Œè¯·ä½¿ç”¨repositories {}å—å…¶ä¸­çš„pluginManagement {}ï¼š settings.gradle pluginManagement { repositories { maven { url '../maven-repo' } gradlePluginPortal() ivy { url '../ivy-repo' } } } javaåº“ å¯¼å…¥java apply plugin:'java' è‡ªå®šä¹‰è·¯å¾„ sourceSets { main { java { srcDirs = ['src'] } } test { java { srcDirs = ['test'] } } } sourceSets { main { java { srcDir 'thirdParty/src/main/java' } } } å¯¼å…¥ä¾èµ– repositories { jcenter() } dependencies { implementation group:'com.android.support',name:'appcompat-v7',version:'28.0.0' implementation 'com.android.support:appcompat-v7:28.0.0' implementation protect(':p') implementation file('libs/ss.jar','libs/ss2.jar') implementation fileTree(dir: &quot;libs&quot;, include: [&quot;*.jar&quot;]) } å¤šé¡¹ç›® è®¾ç½® settings.gradle include ':app' rootProject.name = &quot;GradleTest&quot; å®‰å“å®ç”¨ è®¾ç½®ç­¾å android { signingConfig = { release { storeFile file(&quot;MYKEY.keystore&quot;) storePassword &quot;storePassword&quot; keyAlias &quot;keyAlias&quot; keyPassword &quot;keyPassword&quot; } } } è‡ªå®šä¹‰è¾“å‡ºapkæ–‡ä»¶åç§° applicationVariants.all { variant -&gt; variant.outputs.all { output -&gt; def fileName = &quot;è‡ªå®šä¹‰åç§°_${variant.versionName}_release.apk&quot; def outFile = output.outputFile if (outFile != null &amp;&amp; outFile.name.endsWith('.apk')) { outputFileName = fileName } } } åŠ¨æ€AndroidManifest &lt;meta-data android:name=&quot;paramName&quot; android:value=&quot;${PARAM_NAME}&quot;&gt; android { productFlavors{ google{ manifestPlaceholders.put(&quot;PARAM_NAME&quot;,'google') } } } å¤šæ¸ é“ android { productFlavors{ google{ }, baidu{ } } productFlavors.all{ flavor-&gt; manifestPlaceholders.put(&quot;PARAM_NAME&quot;,name) } } adbè®¾ç½® adbå·¥å…· android { adbOptions{ timeOutInMs = 5000 //5sè¶…æ—¶ installOptions '-r','-s' //å®‰è£…æŒ‡ä»¤ } } dexOptions dexå·¥å…· android { dexOptions{ incremental true //å¢é‡ javaMaxHeapSize '4G'//dxæœ€å¤§é˜Ÿå†…å­˜ jumboMode true //å¼ºåˆ¶å¼€å¯jumboè·³è¿‡65535é™åˆ¶ preDexLibraries true //æé«˜å¢é‡æ„å»ºé€Ÿåº¦ threadCount 1 //dxçº¿ç¨‹æ•°é‡ } } Ant ä¾‹.å°†åµŒå¥—å…ƒç´ ä¼ é€’ç»™Antä»» build.gradle task zip { doLast { ant.zip(destfile: 'archive.zip') { fileset(dir: 'src') { include(name: '**.xml') exclude(name: '**.java') } } } } ä¾‹.ä½¿ç”¨Antç±»å‹ build.gradle task list { doLast { def path = ant.path { fileset(dir: 'libs', includes: '*.jar') } path.list().each { println it } } } ä¾‹.ä½¿ç”¨å®šåˆ¶çš„Antä»»åŠ¡ build.gradle task check { doLast { ant.taskdef(resource: 'checkstyletask.properties') { classpath { fileset(dir: 'libs', includes: '*.jar') } } ant.checkstyle(config: 'checkstyle.xml') { fileset(dir: 'src') } } } Lint Lintï¼šandroid toolç›®å½•ä¸‹çš„å·¥å…·ï¼Œä¸€ä¸ªä»£ç æ‰«æå·¥å…·ï¼Œèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬è¯†åˆ«èµ„æºã€ä»£ç ç»“æ„å­˜åœ¨çš„é—®é¢˜ lintOptions android { lintOptions{ abortOnError true //å‘ç”Ÿé”™è¯¯æ—¶æ¨å‡ºGradle absolutePaths true //é…ç½®é”™è¯¯è¾“å‡ºæ˜¯å¦æ˜¾ç¤ºç»å¯¹è·¯å¾„ check 'NewApi','InlinedApi' // æ£€æŸ¥lint checkçš„issue id enable 'NewApi','InlinedApi' //å¯åŠ¨ lint checkçš„issue id disable 'NewApi','InlinedApi' //å…³é—­ lint checkçš„issue id checkAllWarnings true //æ£€æŸ¥æ‰€æœ‰è­¦å‘Šissue ignoreWarning true //å¿½ç•¥è­¦å‘Šæ£€æŸ¥ï¼Œé»˜è®¤false checkReleaseBuilds true //æ£€æŸ¥è‡´å‘½é”™è¯¯ï¼Œé»˜è®¤true explainIssues true //é”™è¯¯æŠ¥å‘Šæ˜¯å¦åŒ…å«è§£é‡Šè¯´æ˜ï¼Œé»˜è®¤true htmlOutput new File(&quot;/xx.html&quot;) //htmlæŠ¥å‘Šè¾“å‡ºè·¯å¾„ htmlReport true // æ˜¯å¦ç”ŸæˆhtmlæŠ¥å‘Šï¼Œé»˜è®¤true lintConfig new File(&quot;/xx.xml&quot;) //linté…ç½® noLines true // è¾“å‡ºä¸å¸¦è¡Œå· é»˜è®¤true quite true // å®‰é™æ¨¡å¼ showAll true //æ˜¯å¦æ˜¾ç¤ºæ‰€æœ‰è¾“å‡ºï¼Œä¸æˆªæ–­ } } ","link":"https://tianxiawuhao.github.io/Fe3q50EYd/"},{"title":"gradle-Logging","content":"Logging æ—¥å¿—çº§åˆ« æ—¥å¿—çº§åˆ« è¯´æ˜ ERROR é”™è¯¯è®¯æ¯ QUIET é‡è¦ä¿¡æ¯æ¶ˆæ¯ WARNING è­¦å‘Šè®¯æ¯ LIFECYCLE è¿›åº¦ä¿¡æ¯æ¶ˆæ¯ INFO ä¿¡æ¯è®¯æ¯ DEBUG è°ƒè¯•ä¿¡æ¯ é€‰æ‹©æ—¥å¿—çº§åˆ« å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œé€‰é¡¹æˆ–è€…gradle.propertiesæ–‡ä»¶é…ç½® é€‰é¡¹ è¾“å‡ºæ—¥å¿—çº§åˆ« æ²¡æœ‰è®°å½•é€‰é¡¹ LIFECYCLEåŠæ›´é«˜ -q or--quiet QUIETåŠæ›´é«˜ -w or --warn WARNINGåŠæ›´é«˜ -i or --info INFOåŠæ›´é«˜ -d or --debug DEBUGåŠæ›´é«˜ç‰ˆæœ¬ï¼ˆå³æ‰€æœ‰æ—¥å¿—æ¶ˆæ¯ï¼‰ Stacktraceå‘½ä»¤è¡Œé€‰é¡¹ -s or --stacktrace æ‰“å°ç®€æ´çš„å †æ ˆè·Ÿè¸ªä¿¡æ¯ï¼Œæ¨èä½¿ç”¨ -S or --full-stacktrace æ‰“å°å®Œæ•´çš„å †æ ˆè·Ÿè¸ªä¿¡æ¯ã€‚ ç¼–å†™æ—¥å¿— ä½¿ç”¨stdoutç¼–å†™æ—¥å¿—æ¶ˆæ¯ println 'A message which is logged at QUIET level' ç¼–å†™è‡ªå·±çš„æ—¥å¿—æ¶ˆæ¯ logger.quiet('An info log message which is always logged.') logger.error('An error log message.') logger.warn('A warning log message.') logger.lifecycle('A lifecycle info log message.') logger.info('An info log message.') logger.debug('A debug log message.') logger.trace('A trace log message.') // Gradle never logs TRACE level logs // ç”¨å ä½ç¬¦å†™ä¸€æ¡æ—¥å¿—æ¶ˆæ¯ logger.info('A {} log message', 'info') loggeræ„å»ºè„šæœ¬æä¾›äº†ä¸€ä¸ªå±æ€§ï¼Œè¯¥è„šæœ¬æ˜¯Loggerçš„å®ä¾‹ã€‚è¯¥æ¥å£æ‰©å±•äº†SLF4JLoggeræ¥å£ï¼Œå¹¶å‘å…¶ä¸­æ·»åŠ äº†ä¸€äº›Gradleç‰¹å®šçš„æ–¹æ³• ä½¿ç”¨SLF4Jå†™å…¥æ—¥å¿—æ¶ˆæ¯ import org.slf4j.LoggerFactory def slf4jLogger = LoggerFactory.getLogger('some-logger') slf4jLogger.info('An info log message logged using SLF4j') æ„å»ºç”Ÿå‘½å‘¨æœŸ Gradleçš„æ ¸å¿ƒæ˜¯ä¸€ç§åŸºäºä¾èµ–æ€§çš„ç¼–ç¨‹è¯­è¨€ï¼Œè¿™æ„å‘³ç€ä½ å¯ä»¥å®šä¹‰ä»»åŠ¡å’Œä»»åŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚ Gradleä¿è¯è¿™äº›ä»»åŠ¡æŒ‰ç…§å…¶ä¾èµ–å…³ç³»çš„é¡ºåºæ‰§è¡Œï¼Œå¹¶ä¸”æ¯ä¸ªä»»åŠ¡åªæ‰§è¡Œä¸€æ¬¡ã€‚ è¿™äº›ä»»åŠ¡å½¢æˆä¸€ä¸ªå®šå‘æ— ç¯å›¾ã€‚ æ„å»ºé˜¶æ®µ Gradleæ„å»ºå…·æœ‰ä¸‰ä¸ªä¸åŒçš„é˜¶æ®µã€‚ åˆå§‹åŒ– Gradleæ”¯æŒå•é¡¹ç›®å’Œå¤šé¡¹ç›®æ„å»ºã€‚åœ¨åˆå§‹åŒ–é˜¶æ®µï¼ŒGradleå†³å®šè¦å‚ä¸æ„å»ºçš„é¡¹ç›®ï¼Œå¹¶ä¸ºæ¯ä¸ªé¡¹ç›®åˆ›å»ºä¸€ä¸ªProjectå®ä¾‹ã€‚ é…ç½® åœ¨æ­¤é˜¶æ®µï¼Œå°†é…ç½®é¡¹ç›®å¯¹è±¡ã€‚æ‰§è¡Œä½œä¸ºæ„å»ºä¸€éƒ¨åˆ†çš„ æ‰€æœ‰ é¡¹ç›®çš„æ„å»ºè„šæœ¬ã€‚ æ‰§è¡Œ Gradleç¡®å®šè¦åœ¨é…ç½®é˜¶æ®µåˆ›å»ºå’Œé…ç½®çš„ä»»åŠ¡å­é›†ã€‚å­é›†ç”±ä¼ é€’ç»™gradleå‘½ä»¤çš„ä»»åŠ¡åç§°å‚æ•°å’Œå½“å‰ç›®å½•ç¡®å®šã€‚ç„¶åGradleæ‰§è¡Œæ¯ä¸ªé€‰å®šçš„ä»»åŠ¡ã€‚ è®¾ç½®æ–‡ä»¶ é»˜è®¤åç§°æ˜¯settings.gradle é¡¹ç›®æ„å»ºåœ¨å¤šé¡¹ç›®å±‚æ¬¡ç»“æ„çš„æ ¹é¡¹ç›®ä¸­å¿…é¡»å…·æœ‰ä¸€ä¸ªsettings.gradleæ–‡ä»¶ã€‚ å¯¹äºå•é¡¹ç›®æ„å»ºï¼Œè®¾ç½®æ–‡ä»¶æ˜¯å¯é€‰çš„ åˆå§‹åŒ– æŸ¥æ‰¾settings.gradleæ–‡ä»¶åˆ¤æ–­æ˜¯å¦å¤šé¡¹ç›® æ²¡æœ‰settings.gradleæˆ–settings.gradleæ²¡æœ‰å¤šé¡¹ç›®é…ç½®åˆ™ä¸ºå•é¡¹ç›® ä¾‹ï¼šå°†testä»»åŠ¡æ·»åŠ åˆ°æ¯ä¸ªå…·æœ‰ç‰¹å®šå±æ€§é›†çš„é¡¹ç›® build.gradle allprojects { afterEvaluate { project -&gt; if (project.hasTests) { println &quot;Adding test task to $project&quot; project.task('test') { doLast { println &quot;Running tests for $project&quot; } } } } } è¾“å‡º gradle -q test &gt; gradle -q test Adding test task to project ':project-a' Running tests for project ':project-a' åˆå§‹åŒ–è„šæœ¬ åˆå§‹åŒ–è„šæœ¬ä¸Gradleä¸­çš„å…¶ä»–è„šæœ¬ç›¸ä¼¼ã€‚ä½†æ˜¯ï¼Œè¿™äº›è„šæœ¬åœ¨æ„å»ºå¼€å§‹ä¹‹å‰è¿è¡Œã€‚åˆå§‹åŒ–è„šæœ¬ä¸èƒ½è®¿é—®buildSrcé¡¹ç›®ä¸­çš„ç±»ã€‚ ä½¿ç”¨åˆå§‹åŒ–è„šæœ¬ æœ‰å‡ ç§ä½¿ç”¨åˆå§‹åŒ–è„šæœ¬çš„æ–¹æ³•ï¼š åœ¨å‘½ä»¤è¡Œä¸­æŒ‡å®šä¸€ä¸ªæ–‡ä»¶ã€‚å‘½ä»¤è¡Œé€‰é¡¹æ˜¯-Iæˆ–-init-scriptï¼Œåé¢æ˜¯è„šæœ¬çš„è·¯å¾„ã€‚ å‘½ä»¤è¡Œé€‰é¡¹å¯ä»¥å‡ºç°ä¸€æ¬¡ä»¥ä¸Šï¼Œæ¯æ¬¡éƒ½ä¼šæ·»åŠ å¦ä¸€ä¸ª init è„šæœ¬ã€‚ å¦‚æœå‘½ä»¤è¡Œä¸ŠæŒ‡å®šçš„æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç¼–è¯‘å°†å¤±è´¥ã€‚ åœ¨ USER_HOME /.gradle/ç›®å½•ä¸­æ”¾ç½®ä¸€ä¸ªåä¸ºinit.gradleï¼ˆæˆ–init.gradle.ktsKotlinï¼‰çš„æ–‡ä»¶ã€‚ åœ¨ USER_HOME /.gradle/init.d/ç›®å½•ä¸­æ”¾ç½®ä¸€ä¸ªä»¥.gradleï¼ˆæˆ–.init.gradle.ktsKotlinï¼‰ç»“å°¾çš„æ–‡ä»¶ã€‚ åœ¨Gradleå‘è¡Œç‰ˆçš„ GRADLE_HOME /init.d/ç›®å½•ä¸­æ”¾ç½®ä¸€ä¸ªä»¥.gradleï¼ˆæˆ–.init.gradle.ktsKotlinï¼‰ç»“å°¾çš„æ–‡ä»¶ã€‚è¿™ä½¿æ‚¨å¯ä»¥æ‰“åŒ…åŒ…å«ä¸€äº›è‡ªå®šä¹‰æ„å»ºé€»è¾‘å’Œæ’ä»¶çš„è‡ªå®šä¹‰Gradleå‘è¡Œç‰ˆã€‚æ‚¨å¯ä»¥å°†å…¶ä¸Gradle Wrapperç»“åˆä½¿ç”¨ï¼Œä»¥ä½¿è‡ªå®šä¹‰é€»è¾‘å¯ç”¨äºä¼ä¸šä¸­çš„æ‰€æœ‰å†…éƒ¨ç‰ˆæœ¬ã€‚ å¦‚æœå‘ç°ä¸€ä¸ªä»¥ä¸Šçš„åˆå§‹åŒ–è„šæœ¬ï¼Œå®ƒä»¬å°†æŒ‰ç…§ä¸Šé¢æŒ‡å®šçš„é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚ ç¤ºä¾‹ build.gradle repositories { mavenCentral() } task showRepos { doLast { println &quot;All repos:&quot; println repositories.collect { it.name } } } init.gradle allprojects { repositories { mavenLocal() } } è¿è¡Œä»»åŠ¡ï¼š gradle --init-script init.gradle -q showRepos åˆå§‹åŒ–è„šæœ¬é‡Œé¢ä¾èµ–æ·»åŠ ä¾èµ– init.gradle initscript { repositories { mavenCentral() } dependencies { classpath 'org.apache.commons:commons-math:2.0' } } å¤šé¡¹ç›® å¯åœ¨settings.gradleæ–‡ä»¶ä¸­è®¾ç½®å¤šä¸ªé¡¹ç›®å…³ç³»ï¼Œå¦‚ä¸‹é¡¹ç›®ç»“æ„ . â”œâ”€â”€ app â”‚ ... â”‚ â””â”€â”€ build.gradle â””â”€â”€ settings.gradle settings.gradle rootProject.name = 'basic-multiproject' //æ ¹é¡¹ç›®å include 'app' //å­é¡¹ç›® å­é¡¹ç›®é—´ä¾èµ– dependencies { implementation(project(&quot;:shared&quot;)) } ","link":"https://tianxiawuhao.github.io/wYNztHepH/"},{"title":"GroovyåŸºç¡€","content":"GroovyåŸºç¡€ åŸºæœ¬è§„åˆ™ æ²¡æœ‰åˆ†å· æ–¹æ³•æ‹¬å·å¯ä»¥çœç•¥ æ–¹æ³•å¯ä»¥ä¸å†™returnï¼Œè¿”å›æœ€åä¸€å¥ä»£ç  ä»£ç å—å¯ä»¥ä½œä¸ºå‚æ•°ä¼ é€’ å®šä¹‰ def param = 'hello world' def param1 = &quot;hello world&quot; println &quot;${param1} ,li&quot; ${}é‡Œé¢å¯ä»¥æ”¾å˜é‡ï¼Œä¹Ÿå¯ä»¥æ˜¯è¡¨è¾¾å¼ï¼Œåªæœ‰åŒå¼•å·é‡Œé¢å¯ä»¥ä½¿ç”¨ å£°æ˜å˜é‡ å¯ä»¥åœ¨æ„å»ºè„šæœ¬ä¸­å£°æ˜ä¸¤ç§å˜é‡ï¼šå±€éƒ¨å˜é‡å’Œé¢å¤–å±æ€§ã€‚ å±€éƒ¨å˜é‡ å±€éƒ¨å˜é‡ç”¨defå…³é”®å­—å£°æ˜ã€‚å®ƒä»¬ä»…åœ¨å£°æ˜å®ƒä»¬çš„èŒƒå›´å†…å¯è§ã€‚å±€éƒ¨å˜é‡æ˜¯åŸºç¡€Groovyè¯­è¨€çš„åŠŸèƒ½ã€‚ def dest = &quot;dest&quot; task copy(type: Copy) { from &quot;source&quot; into dest } extå±æ€§ Gradleçš„åŸŸæ¨¡å‹ä¸­çš„æ‰€æœ‰å¢å¼ºå¯¹è±¡éƒ½å¯ä»¥å®¹çº³é¢å¤–çš„ç”¨æˆ·å®šä¹‰å±æ€§ã€‚ å¯ä»¥é€šè¿‡æ‹¥æœ‰å¯¹è±¡çš„extå±æ€§æ·»åŠ ï¼Œè¯»å–å’Œè®¾ç½®å…¶ä»–å±æ€§ã€‚å¯ä»¥ä½¿ç”¨ä¸€ä¸ªextå—ä¸€æ¬¡æ·»åŠ å¤šä¸ªå±æ€§ã€‚ plugins { id 'java' } ext { springVersion = &quot;3.1.0.RELEASE&quot; emailNotification = &quot;build@master.org&quot; } sourceSets.all { ext.purpose = null } sourceSets { main { purpose = &quot;production&quot; } test { purpose = &quot;test&quot; } plugin { purpose = &quot;production&quot; } } task printProperties { doLast { println springVersion println emailNotification sourceSets.matching { it.purpose == &quot;production&quot; }.each { println it.name } } } è¾“å‡º gradle -q printProperties &gt; gradle -q printProperties 3.1.0.RELEASE build@master.org main plugin å˜é‡èŒƒå›´ï¼šæœ¬åœ°å’Œè„šæœ¬èŒƒå›´ ç”¨ç±»å‹ä¿®é¥°ç¬¦å£°æ˜çš„å˜é‡åœ¨é—­åŒ…ä¸­å¯è§ï¼Œä½†åœ¨æ–¹æ³•ä¸­ä¸å¯è§ã€‚ String localScope1 = 'localScope1' def localScope2 = 'localScope2' scriptScope = 'scriptScope' println localScope1 println localScope2 println scriptScope closure = { println localScope1 println localScope2 println scriptScope } def method() { try { localScope1 } catch (MissingPropertyException e) { println 'localScope1NotAvailable' } try { localScope2 } catch(MissingPropertyException e) { println 'localScope2NotAvailable' } println scriptScope } closure.call() method() è¾“å‡º groovy scope.groovy &gt; groovyä½œç”¨åŸŸ localScope1 localScope2 scriptScope localScope1 localScope2 scriptScope localScope1NotAvailable localScope2NotAvailable scriptScope å¯¹è±¡ ä½¿ç”¨å¯¹è±¡ æ‚¨å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ˜“è¯»çš„æ–¹å¼é…ç½®ä»»æ„å¯¹è±¡ã€‚ build.gradle import java.text.FieldPosition task configure { doLast { def pos = configure(new FieldPosition(10)) { beginIndex = 1 endIndex = 5 } println pos.beginIndex println pos.endIndex } } &gt; gradle -q configure 1 5 ä½¿ç”¨å¤–éƒ¨è„šæœ¬é…ç½®ä»»æ„å¯¹è±¡ æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨å¤–éƒ¨è„šæœ¬é…ç½®ä»»æ„å¯¹è±¡ã€‚ build.gradle task configure { doLast { def pos = new java.text.FieldPosition(10) // Apply the script apply from: 'other.gradle', to: pos println pos.beginIndex println pos.endIndex } } other.gradle // Set properties. beginIndex = 1 endIndex = 5 è¾“å‡º gradle -q configure &gt; gradle -q configure 1 5 å±æ€§è®¿é—®å™¨ Groovyè‡ªåŠ¨å°†å±æ€§å¼•ç”¨è½¬æ¢ä¸ºå¯¹é€‚å½“çš„getteræˆ–setteræ–¹æ³•çš„è°ƒç”¨ã€‚ build.gradle // Using a getter method println project.buildDir println getProject().getBuildDir() // Using a setter method project.buildDir = 'target' getProject().setBuildDir('target') é—­åŒ… é—­åŒ…ï¼ˆé—­åˆä»£ç å—ï¼Œå¯ä»¥å¼•ç”¨ä¼ å…¥çš„å˜é‡ï¼‰ task testClosure { doLast { func { println it } funa { a, b -&gt; println a + b } } } def funa(closure) { closure(10, 3) } def func(closure) { closure(10) } é—­åŒ…å§”æ‰˜ æ¯ä¸ªé—­åŒ…éƒ½æœ‰ä¸€ä¸ªdelegateå¯¹è±¡ï¼ŒGroovyä½¿ç”¨è¯¥å¯¹è±¡æ¥æŸ¥æ‰¾ä¸æ˜¯é—­åŒ…çš„å±€éƒ¨å˜é‡æˆ–å‚æ•°çš„å˜é‡å’Œæ–¹æ³•å¼•ç”¨ã€‚ ä¾‹.é—­åŒ…å§”æ‰˜ class Info { int id; String code; def log() { println(&quot;code:${code};id:${id}&quot;) } } def info(Closure&lt;Info&gt; closure) { Info p = new Info() closure.delegate = p // å§”æ‰˜æ¨¡å¼ä¼˜å…ˆ closure.setResolveStrategy(Closure.DELEGATE_FIRST) closure(p) } task configClosure { doLast { info { code = &quot;cix&quot; id = 1 log() } } } è¾“å‡º &gt; Task :configClosure code:cix;id:1 BUILD SUCCESSFUL in 276ms ä¾‹ï¼šä½¿ç”¨å¿…åŒ…å§”æ‰˜è®¾ç½®ä¾èµ– dependencies { assert delegate == project.dependencies testImplementation('junit:junit:4.13') delegate.testImplementation('junit:junit:4.13') } æ–¹æ³• æ–¹æ³•è°ƒç”¨ä¸Šçš„å¯é€‰æ‹¬å· æ‹¬å·å¯¹äºæ–¹æ³•è°ƒç”¨æ˜¯å¯é€‰çš„ã€‚ build.gradle test.systemProperty 'some.prop', 'value' test.systemProperty('some.prop', 'value') é—­åŒ…ä½œä¸ºæ–¹æ³•ä¸­çš„æœ€åä¸€ä¸ªå‚æ•° å½“æ–¹æ³•çš„æœ€åä¸€ä¸ªå‚æ•°æ˜¯é—­åŒ…æ—¶ï¼Œå¯ä»¥å°†é—­åŒ…æ”¾åœ¨æ–¹æ³•è°ƒç”¨ä¹‹åï¼š build.gradle repositories { println &quot;in a closure&quot; } repositories() { println &quot;in a closure&quot; } repositories({ println &quot;in a closure&quot; }) é›†åˆ List def list = [1,2,3,4] println list[0] // 1 println list[-1] // 4 æœ€åä¸€ä¸ª println list[-2] // 3 å€’æ•°ç¬¬äºŒä¸ª println list[0..2] // ç¬¬1-3ä¸ª list.each { //è¿­ä»£ println it } Map def map= ['name':'li', 'age':18] println map[name] // li println map.age // 18 list.each { //è¿­ä»£ println &quot;${it.key}:${it.value}&quot; } JavaBean class A{ private int a; //å¯é€šè¿‡A().a è·å–ä¿®æ”¹ public int getB(){//å¯é€šè¿‡A().bè·å–ï¼Œä½†ä¸èƒ½ä¿®æ”¹ 1 } } build.gradle // List literal test.includes = ['org/gradle/api/**', 'org/gradle/internal/**'] List&lt;String&gt; list = new ArrayList&lt;String&gt;() list.add('org/gradle/api/**') list.add('org/gradle/internal/**') test.includes = list // Map literal. Map&lt;String, String&gt; map = [key1:'value1', key2: 'value2'] // Groovy will coerce named arguments // into a single map argument apply plugin: 'java' é»˜è®¤å¯¼å…¥ ä¸ºäº†ä½¿æ„å»ºè„šæœ¬æ›´ç®€æ´ï¼ŒGradleè‡ªåŠ¨å‘Gradleè„šæœ¬æ·»åŠ äº†ä¸€äº›ç±»ã€‚ import org.gradle.* import org.gradle.api.* import org.gradle.api.artifacts.* import org.gradle.api.artifacts.component.* import org.gradle.api.artifacts.dsl.* import org.gradle.api.artifacts.ivy.* import org.gradle.api.artifacts.maven.* import org.gradle.api.artifacts.query.* import org.gradle.api.artifacts.repositories.* import org.gradle.api.artifacts.result.* import org.gradle.api.artifacts.transform.* import org.gradle.api.artifacts.type.* import org.gradle.api.artifacts.verification.* import org.gradle.api.attributes.* import org.gradle.api.attributes.java.* import org.gradle.api.capabilities.* import org.gradle.api.component.* import org.gradle.api.credentials.* import org.gradle.api.distribution.* import org.gradle.api.distribution.plugins.* import org.gradle.api.execution.* import org.gradle.api.file.* import org.gradle.api.initialization.* import org.gradle.api.initialization.definition.* import org.gradle.api.initialization.dsl.* import org.gradle.api.invocation.* import org.gradle.api.java.archives.* import org.gradle.api.jvm.* import org.gradle.api.logging.* import org.gradle.api.logging.configuration.* import org.gradle.api.model.* import org.gradle.api.plugins.* import org.gradle.api.plugins.antlr.* import org.gradle.api.plugins.quality.* import org.gradle.api.plugins.scala.* import org.gradle.api.provider.* import org.gradle.api.publish.* import org.gradle.api.publish.ivy.* import org.gradle.api.publish.ivy.plugins.* import org.gradle.api.publish.ivy.tasks.* import org.gradle.api.publish.maven.* import org.gradle.api.publish.maven.plugins.* import org.gradle.api.publish.maven.tasks.* import org.gradle.api.publish.plugins.* import org.gradle.api.publish.tasks.* import org.gradle.api.reflect.* import org.gradle.api.reporting.* import org.gradle.api.reporting.components.* import org.gradle.api.reporting.dependencies.* import org.gradle.api.reporting.dependents.* import org.gradle.api.reporting.model.* import org.gradle.api.reporting.plugins.* import org.gradle.api.resources.* import org.gradle.api.services.* import org.gradle.api.specs.* import org.gradle.api.tasks.* import org.gradle.api.tasks.ant.* import org.gradle.api.tasks.application.* import org.gradle.api.tasks.bundling.* import org.gradle.api.tasks.compile.* import org.gradle.api.tasks.diagnostics.* import org.gradle.api.tasks.incremental.* import org.gradle.api.tasks.javadoc.* import org.gradle.api.tasks.options.* import org.gradle.api.tasks.scala.* import org.gradle.api.tasks.testing.* import org.gradle.api.tasks.testing.junit.* import org.gradle.api.tasks.testing.junitplatform.* import org.gradle.api.tasks.testing.testng.* import org.gradle.api.tasks.util.* import org.gradle.api.tasks.wrapper.* import org.gradle.authentication.* import org.gradle.authentication.aws.* import org.gradle.authentication.http.* import org.gradle.build.event.* import org.gradle.buildinit.plugins.* import org.gradle.buildinit.tasks.* import org.gradle.caching.* import org.gradle.caching.configuration.* import org.gradle.caching.http.* import org.gradle.caching.local.* import org.gradle.concurrent.* import org.gradle.external.javadoc.* import org.gradle.ide.visualstudio.* import org.gradle.ide.visualstudio.plugins.* import org.gradle.ide.visualstudio.tasks.* import org.gradle.ide.xcode.* import org.gradle.ide.xcode.plugins.* import org.gradle.ide.xcode.tasks.* import org.gradle.ivy.* import org.gradle.jvm.* import org.gradle.jvm.application.scripts.* import org.gradle.jvm.application.tasks.* import org.gradle.jvm.platform.* import org.gradle.jvm.plugins.* import org.gradle.jvm.tasks.* import org.gradle.jvm.tasks.api.* import org.gradle.jvm.test.* import org.gradle.jvm.toolchain.* import org.gradle.language.* import org.gradle.language.assembler.* import org.gradle.language.assembler.plugins.* import org.gradle.language.assembler.tasks.* import org.gradle.language.base.* import org.gradle.language.base.artifact.* import org.gradle.language.base.compile.* import org.gradle.language.base.plugins.* import org.gradle.language.base.sources.* import org.gradle.language.c.* import org.gradle.language.c.plugins.* import org.gradle.language.c.tasks.* import org.gradle.language.coffeescript.* import org.gradle.language.cpp.* import org.gradle.language.cpp.plugins.* import org.gradle.language.cpp.tasks.* import org.gradle.language.java.* import org.gradle.language.java.artifact.* import org.gradle.language.java.plugins.* import org.gradle.language.java.tasks.* import org.gradle.language.javascript.* import org.gradle.language.jvm.* import org.gradle.language.jvm.plugins.* import org.gradle.language.jvm.tasks.* import org.gradle.language.nativeplatform.* import org.gradle.language.nativeplatform.tasks.* import org.gradle.language.objectivec.* import org.gradle.language.objectivec.plugins.* import org.gradle.language.objectivec.tasks.* import org.gradle.language.objectivecpp.* import org.gradle.language.objectivecpp.plugins.* import org.gradle.language.objectivecpp.tasks.* import org.gradle.language.plugins.* import org.gradle.language.rc.* import org.gradle.language.rc.plugins.* import org.gradle.language.rc.tasks.* import org.gradle.language.routes.* import org.gradle.language.scala.* import org.gradle.language.scala.plugins.* import org.gradle.language.scala.tasks.* import org.gradle.language.scala.toolchain.* import org.gradle.language.swift.* import org.gradle.language.swift.plugins.* import org.gradle.language.swift.tasks.* import org.gradle.language.twirl.* import org.gradle.maven.* import org.gradle.model.* import org.gradle.nativeplatform.* import org.gradle.nativeplatform.platform.* import org.gradle.nativeplatform.plugins.* import org.gradle.nativeplatform.tasks.* import org.gradle.nativeplatform.test.* import org.gradle.nativeplatform.test.cpp.* import org.gradle.nativeplatform.test.cpp.plugins.* import org.gradle.nativeplatform.test.cunit.* import org.gradle.nativeplatform.test.cunit.plugins.* import org.gradle.nativeplatform.test.cunit.tasks.* import org.gradle.nativeplatform.test.googletest.* import org.gradle.nativeplatform.test.googletest.plugins.* import org.gradle.nativeplatform.test.plugins.* import org.gradle.nativeplatform.test.tasks.* import org.gradle.nativeplatform.test.xctest.* import org.gradle.nativeplatform.test.xctest.plugins.* import org.gradle.nativeplatform.test.xctest.tasks.* import org.gradle.nativeplatform.toolchain.* import org.gradle.nativeplatform.toolchain.plugins.* import org.gradle.normalization.* import org.gradle.platform.base.* import org.gradle.platform.base.binary.* import org.gradle.platform.base.component.* import org.gradle.platform.base.plugins.* import org.gradle.play.* import org.gradle.play.distribution.* import org.gradle.play.platform.* import org.gradle.play.plugins.* import org.gradle.play.plugins.ide.* import org.gradle.play.tasks.* import org.gradle.play.toolchain.* import org.gradle.plugin.devel.* import org.gradle.plugin.devel.plugins.* import org.gradle.plugin.devel.tasks.* import org.gradle.plugin.management.* import org.gradle.plugin.use.* import org.gradle.plugins.ear.* import org.gradle.plugins.ear.descriptor.* import org.gradle.plugins.ide.* import org.gradle.plugins.ide.api.* import org.gradle.plugins.ide.eclipse.* import org.gradle.plugins.ide.idea.* import org.gradle.plugins.javascript.base.* import org.gradle.plugins.javascript.coffeescript.* import org.gradle.plugins.javascript.envjs.* import org.gradle.plugins.javascript.envjs.browser.* import org.gradle.plugins.javascript.envjs.http.* import org.gradle.plugins.javascript.envjs.http.simple.* import org.gradle.plugins.javascript.jshint.* import org.gradle.plugins.javascript.rhino.* import org.gradle.plugins.signing.* import org.gradle.plugins.signing.signatory.* import org.gradle.plugins.signing.signatory.pgp.* import org.gradle.plugins.signing.type.* import org.gradle.plugins.signing.type.pgp.* import org.gradle.process.* import org.gradle.swiftpm.* import org.gradle.swiftpm.plugins.* import org.gradle.swiftpm.tasks.* import org.gradle.testing.base.* import org.gradle.testing.base.plugins.* import org.gradle.testing.jacoco.plugins.* import org.gradle.testing.jacoco.tasks.* import org.gradle.testing.jacoco.tasks.rules.* import org.gradle.testkit.runner.* import org.gradle.vcs.* import org.gradle.vcs.git.* import org.gradle.work.* import org.gradle.workers.* å¯¼å…¥ä¾èµ– buildscript { repositories { mavenCentral() } dependencies { classpath group: 'commons-codec', name: 'commons-codec', version: '1.2' } } ","link":"https://tianxiawuhao.github.io/4WWjxpN2N/"},{"title":"gradleé¡¹ç›®ä¸ä»»åŠ¡","content":"é¡¹ç›®ä¸ä»»åŠ¡ Gradleä¸­çš„æ‰€æœ‰å†…å®¹éƒ½ä½äºä¸¤ä¸ªåŸºæœ¬æ¦‚å¿µä¹‹ä¸Šï¼š projects ï¼šæ¯ä¸ªGradleæ„å»ºéƒ½ç”±ä¸€ä¸ªæˆ–å¤šä¸ª projectsç»„æˆ ï¼Œä¸€ä¸ªprojectsä»£è¡¨ä»€ä¹ˆå–å†³äºæ‚¨ä½¿ç”¨Gradleåšçš„äº‹æƒ…ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªprojectså¯èƒ½ä»£è¡¨ä¸€ä¸ªJARåº“æˆ–ä¸€ä¸ªWebåº”ç”¨ç¨‹åºã€‚ tasks ï¼šæ¯ä¸ªprojectsç”±ä¸€ä¸ªæˆ–å¤šä¸ª tasksç»„æˆ ã€‚tasksä»£è¡¨æ„å»ºæ‰§è¡Œçš„ä¸€äº›åŸå­å·¥ä½œã€‚è¿™å¯èƒ½æ˜¯ç¼–è¯‘æŸäº›ç±»ï¼Œåˆ›å»ºJARï¼Œç”ŸæˆJavadocæˆ–å°†ä¸€äº›å­˜æ¡£å‘å¸ƒåˆ°å­˜å‚¨åº“ã€‚ é¡¹ç›® è¡¨.é¡¹ç›®å±æ€§ åç§° ç±»å‹ é»˜è®¤å€¼ project Project è¯¥Projectå®ä¾‹ name String é¡¹ç›®ç›®å½•çš„åç§°ã€‚ path String é¡¹ç›®çš„ç»å¯¹è·¯å¾„ã€‚ description String é¡¹ç›®è¯´æ˜ã€‚ projectDir File åŒ…å«æ„å»ºè„šæœ¬çš„ç›®å½•ã€‚ buildDir File projectDir /build group Object unspecified version Object unspecified ant ant build ä¸€ä¸ªAntBuilderå®ä¾‹ ä»»åŠ¡ å®šä¹‰ä»»åŠ¡ ä½¿ç”¨å­—ç¬¦ä¸²ä½œä¸ºä»»åŠ¡åç§°å®šä¹‰ä»»åŠ¡ ä½¿ç”¨taskså®¹å™¨å®šä¹‰ä»»åŠ¡ ä½¿ç”¨DSLç‰¹å®šè¯­æ³•å®šä¹‰ä»»åŠ¡ ä¾‹ï¼š build.gradle // ä½¿ç”¨å­—ç¬¦ä¸²ä½œä¸ºä»»åŠ¡åç§°å®šä¹‰ä»»åŠ¡ task('hello') { doLast { println &quot;hello&quot; } } // ä½¿ç”¨taskså®¹å™¨å®šä¹‰ä»»åŠ¡ tasks.create('hello') { doLast { println &quot;hello&quot; } } // ä½¿ç”¨DSLç‰¹å®šè¯­æ³•å®šä¹‰ä»»åŠ¡ task(hello) { doLast { println &quot;hello&quot; } } task('copy', type: Copy) { from(file('srcDir')) into(buildDir) } å®šä½ä»»åŠ¡ ä½¿ç”¨DSLç‰¹å®šè¯­æ³•è®¿é—®ä»»åŠ¡ é€šè¿‡ä»»åŠ¡é›†åˆè®¿é—®ä»»åŠ¡ é€šè¿‡è·¯å¾„è®¿é—® æŒ‰ä»»åŠ¡ç±»å‹è®¿é—®ä»»åŠ¡ task hello task copy(type: Copy) // ä½¿ç”¨DSLç‰¹å®šè¯­æ³•è®¿é—®ä»»åŠ¡ println hello.name println project.hello.name println copy.destinationDir println project.copy.destinationDir // é€šè¿‡ä»»åŠ¡é›†åˆè®¿é—®ä»»åŠ¡ println tasks.hello.name println tasks.named('hello').get().name println tasks.copy.destinationDir println tasks.named('copy').get().destinationDir //æŒ‰ä»»åŠ¡ç±»å‹è®¿é—®ä»»åŠ¡ tasks.withType(Tar).configureEach { enabled = false } task test { dependsOn tasks.withType(Copy) } é€šè¿‡è·¯å¾„è®¿é—® project-a / build.gradle task hello build.gradle task hello println tasks.getByPath('hello').path println tasks.getByPath(':hello').path println tasks.getByPath('project-a:hello').path println tasks.getByPath(':project-a:hello').path é…ç½®ä»»åŠ¡ ä½¿ç”¨APIé…ç½®ä»»åŠ¡ ä¾‹ï¼š build.gradle Copy myCopy = tasks.getByName(&quot;myCopy&quot;) myCopy.from 'resources' myCopy.into 'target' myCopy.include('**/*.txt', '**/*.xml', '**/*.properties') ä½¿ç”¨DSLç‰¹å®šè¯­æ³•é…ç½®ä»»åŠ¡ ä¾‹ï¼š build.gradle // Configure task using Groovy dynamic task configuration block myCopy { from 'resources' into 'target' } myCopy.include('**/*.txt', '**/*.xml', '**/*.properties') ç”¨é…ç½®å—å®šä¹‰ä¸€ä¸ªä»»åŠ¡ ä¾‹ï¼š build.gradle task copy(type: Copy) { from 'resources' into 'target' include('**/*.txt', '**/*.xml', '**/*.properties') } å°†å‚æ•°ä¼ é€’ç»™ä»»åŠ¡æ„é€ å‡½æ•° ä¸Taskåœ¨åˆ›å»ºåé…ç½®å¯å˜å±æ€§ç›¸åï¼Œæ‚¨å¯ä»¥å°†å‚æ•°å€¼ä¼ é€’ç»™Taskç±»çš„æ„é€ å‡½æ•°ã€‚ä¸ºäº†å°†å€¼ä¼ é€’ç»™Taskæ„é€ å‡½æ•°ï¼Œæ‚¨å¿…é¡»ä½¿ç”¨@javax.inject.Injectæ³¨é‡Šç›¸å…³çš„æ„é€ å‡½æ•°ã€‚ é¦–å…ˆåˆ›å»ºå¸¦æœ‰@Injectæ„é€ å‡½æ•°çš„ä»»åŠ¡ç±» class CustomTask extends DefaultTask { final String message final int number @Inject CustomTask(String message, int number) { this.message = message this.number = number } } ç„¶ååˆ›å»ºä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶åœ¨å‚æ•°åˆ—è¡¨çš„æœ«å°¾ä¼ é€’æ„é€ å‡½æ•°å‚æ•°ã€‚ tasks.create('myTask', CustomTask, 'hello', 42) ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨Mapåˆ›å»ºå¸¦æœ‰æ„é€ å‡½æ•°å‚æ•°çš„ä»»åŠ¡ task myTask(type: CustomTask, constructorArgs: ['hello', 42]) å‘ä»»åŠ¡æ·»åŠ ä¾èµ–é¡¹ ä»å¦ä¸€ä¸ªé¡¹ç›®æ·»åŠ å¯¹ä»»åŠ¡çš„ä¾èµ– project('project-a') { task taskX { dependsOn ':project-b:taskY' doLast { println 'taskX' } } } project('project-b') { task taskY { doLast { println 'taskY' } } } ä½¿ç”¨ä»»åŠ¡å¯¹è±¡æ·»åŠ ä¾èµ– task taskX { doLast { println 'taskX' } } task taskY { doLast { println 'taskY' } } taskX.dependsOn taskY ä½¿ç”¨æƒ°æ€§å—æ·»åŠ ä¾èµ–é¡¹ task taskX { doLast { println 'taskX' } } // Using a Groovy Closure taskX.dependsOn { tasks.findAll { task -&gt; task.name.startsWith('lib') } } task lib1 { doLast { println 'lib1' } } task lib2 { doLast { println 'lib2' } } task notALib { doLast { println 'notALib' } } ä»»åŠ¡æ’åº æ§åˆ¶ä»»åŠ¡æ’åºçš„ä¸¤ç§æ–¹å¼ï¼š must run after ï¼šå¿…é¡»åœ¨ä¹‹åè¿è¡Œ should run afterï¼šåº”è¯¥åœ¨ä¹‹åè¿è¡Œ ä¾‹ task taskX { doLast { println 'taskX' } } task taskY { doLast { println 'taskY' } } taskY.mustRunAfter taskX should run afterè¢«å¿½ç•¥çš„æƒ…å†µ å¼•å…¥æ’åºå‘¨æœŸã€‚ ä½¿ç”¨å¹¶è¡Œæ‰§è¡Œæ—¶ï¼Œé™¤äº† &quot;should run after &quot;ä»»åŠ¡å¤–ï¼Œä¸€ä¸ªä»»åŠ¡çš„æ‰€æœ‰ä¾èµ–å…³ç³»éƒ½å·²è¢«æ»¡è¶³ï¼Œ å¼•å…¥æ’åºå‘¨æœŸä¾‹å­ task taskX { doLast { println 'taskX' } } task taskY { doLast { println 'taskY' } } task taskZ { doLast { println 'taskZ' } } taskX.dependsOn taskY taskY.dependsOn taskZ taskZ.shouldRunAfter taskX ä¸ºä»»åŠ¡æ·»åŠ æè¿° æ‚¨å¯ä»¥åœ¨ä»»åŠ¡ä¸­æ·»åŠ æè¿°ã€‚æ‰§è¡Œgradle tasksæ—¶å°†æ˜¾ç¤ºæ­¤æè¿°ã€‚ build.gradle task copy(type: Copy) { description 'Copies the resource directory to the target directory.' from 'resources' into 'target' include('**/*.txt', '**/*.xml', '**/*.properties') } è·³è¿‡ä»»åŠ¡ onlyIfè·³è¿‡ hello.onlyIf { !project.hasProperty('skipHello') } //StopExecutionExceptionè·³è¿‡ compile.doFirst { if (true) { throw new StopExecutionException() } } ç¦ç”¨ä»»åŠ¡ task disableMe { doLast { println 'This should not be printed if the task is disabled.' } } disableMe.enabled = false ä»»åŠ¡è¶…æ—¶ task hangingTask() { doLast { Thread.sleep(100000) } timeout = Duration.ofMillis(500) } ä»»åŠ¡è§„åˆ™ æœ‰æ—¶æ‚¨æƒ³æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡çš„è¡Œä¸ºå–å†³äºè¾ƒå¤§æˆ–æ— é™æ•°é‡çš„å‚æ•°å€¼èŒƒå›´ã€‚æä¾›æ­¤ç±»ä»»åŠ¡çš„ä¸€ç§éå¸¸å¥½çš„è¡¨è¾¾æ–¹å¼æ˜¯ä»»åŠ¡è§„åˆ™ï¼š ä»»åŠ¡è§„åˆ™ tasks.addRule(&quot;Pattern: ping&lt;ID&gt;&quot;) { String taskName -&gt; if (taskName.startsWith(&quot;ping&quot;)) { task(taskName) { doLast { println &quot;Pinging: &quot; + (taskName - 'ping') } } } } task groupPing { dependsOn pingServer1, pingServer2 } &gt; gradle -q groupPing Pingï¼šServer1 Pingï¼šServer2 ç»ˆç»“å™¨ä»»åŠ¡ è®¡åˆ’è¿è¡Œç»ˆç»“ä»»åŠ¡æ—¶ï¼Œç»ˆç»“ä»»åŠ¡ä¼šè‡ªåŠ¨æ·»åŠ åˆ°ä»»åŠ¡å›¾ä¸­ã€‚å³ä½¿å®Œæˆä»»åŠ¡å¤±è´¥ï¼Œä¹Ÿå°†æ‰§è¡Œç»ˆç»“å™¨ä»»åŠ¡ã€‚ task taskX { doLast { println 'taskX' } } task taskY { doLast { println 'taskY' } } taskX.finalizedBy taskY &gt; gradle -q taskX TaskX TaskY åŠ¨æ€ä»»åŠ¡ Groovyæˆ–Kotlinçš„åŠŸèƒ½å¯ç”¨äºå®šä¹‰ä»»åŠ¡ä»¥å¤–çš„å…¶ä»–åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œæ‚¨è¿˜å¯ä»¥ä½¿ç”¨å®ƒæ¥åŠ¨æ€åˆ›å»ºä»»åŠ¡ã€‚ build.gradle 4.times { counter -&gt; task &quot;task$counter&quot; { doLast { println &quot;I'm task number $counter&quot; } } } gradle -q task1 è¾“å‡º &gt; gradle -q task1 I'm task number 1 Groovy_DSLå¿«æ·æ–¹å¼ç¬¦å· è®¿é—®ä»»åŠ¡æœ‰ä¸€ç§æ–¹ä¾¿çš„è¡¨ç¤ºæ³•ã€‚æ¯ä¸ªä»»åŠ¡éƒ½å¯ä»¥ä½œä¸ºæ„å»ºè„šæœ¬çš„å±æ€§æ¥ä½¿ç”¨ï¼š ä¾‹.ä½œä¸ºæ„å»ºè„šæœ¬çš„å±æ€§è®¿é—®ä»»åŠ¡ build.gradle task hello { doLast { println 'Hello world!' } } hello.doLast { println &quot;Greetings from the $hello.name task.&quot; } è¾“å‡º gradle -q hello &gt; gradle -q hello Hello world! Greetings from the hello task. è¿™å°†å¯ç”¨éå¸¸å¯è¯»çš„ä»£ç ï¼Œå°¤å…¶æ˜¯åœ¨ä½¿ç”¨æ’ä»¶æä¾›çš„ä»»åŠ¡ï¼ˆä¾‹å¦‚compileä»»åŠ¡ï¼‰æ—¶ã€‚ é¢å¤–ä»»åŠ¡å±æ€§ æ‚¨å¯ä»¥å°†è‡ªå·±çš„å±æ€§æ·»åŠ åˆ°ä»»åŠ¡ã€‚è¦æ·»åŠ åä¸ºçš„å±æ€§myPropertyï¼Œè¯·è®¾ç½®ext.myPropertyä¸ºåˆå§‹å€¼ã€‚ä»é‚£æ—¶èµ·ï¼Œå¯ä»¥åƒé¢„å®šä¹‰çš„ä»»åŠ¡å±æ€§ä¸€æ ·è¯»å–å’Œè®¾ç½®å±æ€§ã€‚ build.gradle task myTask { ext.myProperty = &quot;myValue&quot; } task printTaskProperties { doLast { println myTask.myProperty } } è¾“å‡º gradle -q printTaskProperties &gt; gradle -q printTaskProperties myValue é¢å¤–çš„å±æ€§ä¸ä»…é™äºä»»åŠ¡ã€‚æ‚¨å¯ä»¥åœ¨Extraå±æ€§ä¸­é˜…è¯»æœ‰å…³å®ƒä»¬çš„æ›´å¤šä¿¡æ¯ã€‚ é»˜è®¤ä»»åŠ¡ Gradleå…è®¸æ‚¨å®šä¹‰ä¸€ä¸ªæˆ–å¤šä¸ªé»˜è®¤ä»»åŠ¡ã€‚ build.gradle defaultTasks 'clean', 'run' task clean { doLast { println 'Default Cleaning!' } } task run { doLast { println 'Default Running!' } } task other { doLast { println &quot;I'm not a default task!&quot; } } è¾“å‡º gradle -q &gt; gradle -q Default Cleaning! Default Running! è¿™ç­‰æ•ˆäºè¿è¡Œgradle clean runã€‚åœ¨å¤šé¡¹ç›®æ„å»ºä¸­ï¼Œæ¯ä¸ªå­é¡¹ç›®å¯ä»¥æœ‰å…¶è‡ªå·±çš„ç‰¹å®šé»˜è®¤ä»»åŠ¡ã€‚å¦‚æœå­é¡¹ç›®æœªæŒ‡å®šé»˜è®¤ä»»åŠ¡ï¼Œåˆ™ä½¿ç”¨çˆ¶é¡¹ç›®çš„é»˜è®¤ä»»åŠ¡ï¼ˆå¦‚æœå·²å®šä¹‰ï¼‰ã€‚ ","link":"https://tianxiawuhao.github.io/lhyr_DiZc/"},{"title":"GradleåŸºç¡€","content":"Gradleæ¦‚è¿° Gradleæ˜¯ä¸“æ³¨äºçµæ´»æ€§å’Œæ€§èƒ½çš„å¼€æºæ„å»ºè‡ªåŠ¨åŒ–å·¥å…·ï¼Œä¸€èˆ¬ä½¿ç”¨Groovyæˆ–KotlinDSLç¼–å†™æ„å»ºè„šæœ¬ã€‚ æœ¬æ–‡åªä½¿ç”¨Groovy Gradleçš„ç‰¹ç‚¹ï¼š é«˜æ€§èƒ½ Gradleé€šè¿‡ä»…è¿è¡Œéœ€è¦è¿è¡Œçš„ä»»åŠ¡æ¥é¿å…ä¸å¿…è¦çš„å·¥ä½œã€‚ å¯ä»¥ä½¿ç”¨æ„å»ºç¼“å­˜æ¥é‡ç”¨ä»¥å‰è¿è¡Œçš„ä»»åŠ¡è¾“å‡ºï¼Œç”šè‡³å¯ä»¥ä½¿ç”¨å…¶ä»–è®¡ç®—æœºï¼ˆå…·æœ‰å…±äº«çš„æ„å»ºç¼“å­˜ï¼‰é‡ç”¨ä»»åŠ¡è¾“å‡ºã€‚ JVMåŸºç¡€ Gradleåœ¨JVMä¸Šè¿è¡Œã€‚ç†Ÿæ‚‰Javaçš„ç”¨æˆ·æ¥å¯ä»¥åœ¨æ„å»ºé€»è¾‘ä¸­ä½¿ç”¨æ ‡å‡†Java APIï¼Œä¾‹å¦‚è‡ªå®šä¹‰ä»»åŠ¡ç±»å‹å’Œæ’ä»¶ã€‚ è¿™ä½¿å¾—Gradleè·¨å¹³å°æ›´åŠ ç®€å•ã€‚ï¼ˆGradleä¸ä»…é™äºæ„å»ºJVMé¡¹ç›®ï¼Œå®ƒç”šè‡³é™„å¸¦å¯¹æ„å»ºæœ¬æœºé¡¹ç›®çš„æ”¯æŒã€‚ï¼‰ çº¦æŸ å’ŒMavenä¸€æ ·ï¼ŒGradleé€šè¿‡å®ç°çº¦æŸä½¿å¸¸è§ç±»å‹çš„é¡¹ç›®ï¼ˆä¾‹å¦‚Javaé¡¹ç›®ï¼‰æ˜“äºæ„å»ºã€‚ åº”ç”¨é€‚å½“çš„æ’ä»¶ï¼Œæ‚¨å¯ä»¥è½»æ¾åœ°ä¸ºè®¸å¤šé¡¹ç›®ä½¿ç”¨ç²¾ç®€çš„æ„å»ºè„šæœ¬ã€‚ ä½†æ˜¯è¿™äº›çº¦å®šå¹¶æ²¡æœ‰é™åˆ¶æ‚¨ï¼šGradleå…è®¸æ‚¨è¦†ç›–å®ƒä»¬ï¼Œæ·»åŠ è‡ªå·±çš„ä»»åŠ¡ä»¥åŠå¯¹åŸºäºçº¦å®šçš„æ„å»ºè¿›è¡Œè®¸å¤šå…¶ä»–è‡ªå®šä¹‰æ“ä½œã€‚ å¯æ‰©å±•æ€§ æ‚¨å¯ä»¥è½»æ¾æ‰©å±•Gradleä»¥æä¾›æ‚¨è‡ªå·±çš„ä»»åŠ¡ç±»å‹ç”šè‡³æ„å»ºæ¨¡å‹ã€‚ IDEæ”¯æŒ æ”¯æŒIDEï¼šAndroid Studioï¼ŒIntelliJ IDEAï¼ŒEclipseå’ŒNetBeansã€‚ Gradleè¿˜æ”¯æŒç”Ÿæˆå°†é¡¹ç›®åŠ è½½åˆ°Visual Studioæ‰€éœ€çš„è§£å†³æ–¹æ¡ˆæ–‡ä»¶ã€‚ å¯æ´å¯Ÿæ€§ æ„å»ºæ‰«ææä¾›äº†æœ‰å…³æ„å»ºè¿è¡Œçš„å¹¿æ³›ä¿¡æ¯ï¼Œå¯ç”¨äºè¯†åˆ«æ„å»ºé—®é¢˜ã€‚ä»–ä»¬ç‰¹åˆ«æ“…é•¿å¸®åŠ©æ‚¨ç¡®å®šæ„å»ºæ€§èƒ½çš„é—®é¢˜ã€‚ æ‚¨è¿˜å¯ä»¥ä¸å…¶ä»–äººå…±äº«æ„å»ºæ‰«æï¼Œå¦‚æœæ‚¨éœ€è¦å’¨è¯¢ä»¥è§£å†³æ„å»ºé—®é¢˜ï¼Œè¿™å°†ç‰¹åˆ«æœ‰ç”¨ã€‚ æ‚¨éœ€è¦äº†è§£æœ‰å…³Gradleçš„äº”ä»¶äº‹ æœ¬èŠ‚åœ¨å®˜æ–¹æ–‡æ¡£é‡Œé¢åå¤æåŠï¼Œå…·ä½“å¯è§Gradleæ–‡æ¡£ 1. Gradleæ˜¯é€šç”¨çš„æ„å»ºå·¥å…· Gradleå…è®¸æ‚¨æ„å»ºä»»ä½•è½¯ä»¶ï¼Œå› ä¸ºå®ƒä¸å…³å¿ƒä½ å…·ä½“çš„å·¥ä½œã€‚ 2. æ ¸å¿ƒæ¨¡å‹åŸºäºä»»åŠ¡ Gradleå°†å…¶æ„å»ºæ¨¡å‹å»ºæ¨¡ä¸ºä»»åŠ¡ï¼ˆå·¥ä½œå•å…ƒï¼‰çš„æœ‰å‘æ— ç¯å›¾ï¼ˆDAGï¼‰ã€‚è¿™æ„å‘³ç€æ„å»ºå®è´¨ä¸Šé…ç½®äº†ä¸€ç»„ä»»åŠ¡ï¼Œå¹¶æ ¹æ®å®ƒä»¬çš„ä¾èµ–å…³ç³»å°†å®ƒä»¬è¿æ¥åœ¨ä¸€èµ·ä»¥åˆ›å»ºè¯¥DAGã€‚åˆ›å»ºä»»åŠ¡å›¾åï¼ŒGradleå°†ç¡®å®šéœ€è¦æŒ‰é¡ºåºè¿è¡Œçš„ä»»åŠ¡ï¼Œç„¶åç»§ç»­æ‰§è¡Œå®ƒä»¬ã€‚ ä»»åŠ¡æœ¬èº«åŒ…æ‹¬ä»¥ä¸‹éƒ¨åˆ†ï¼Œå®ƒä»¬é€šè¿‡ä¾èµ–é“¾æ¥åœ¨ä¸€èµ·ï¼š åŠ¨ä½œ-åšæŸäº‹çš„å·¥ä½œï¼Œä¾‹å¦‚å¤åˆ¶æ–‡ä»¶æˆ–ç¼–è¯‘æºä»£ç  è¾“å…¥-æ“ä½œä½¿ç”¨æˆ–å¯¹å…¶è¿›è¡Œæ“ä½œçš„å€¼ï¼Œæ–‡ä»¶å’Œç›®å½• è¾“å‡º-æ“ä½œä¿®æ”¹æˆ–ç”Ÿæˆçš„æ–‡ä»¶å’Œç›®å½• 3. Gradleæœ‰å‡ ä¸ªå›ºå®šçš„æ„å»ºé˜¶æ®µ é‡è¦çš„æ˜¯è¦äº†è§£Gradleåˆ†ä¸‰ä¸ªé˜¶æ®µè¯„ä¼°å’Œæ‰§è¡Œæ„å»ºè„šæœ¬ï¼š åˆå§‹åŒ– è®¾ç½®æ„å»ºç¯å¢ƒï¼Œå¹¶ç¡®å®šå“ªäº›é¡¹ç›®å°†å‚ä¸å…¶ä¸­ã€‚ é…ç½® æ„é€ å’Œé…ç½®æ„å»ºçš„ä»»åŠ¡å›¾ï¼Œç„¶åæ ¹æ®ç”¨æˆ·è¦è¿è¡Œçš„ä»»åŠ¡ç¡®å®šéœ€è¦è¿è¡Œçš„ä»»åŠ¡å’Œè¿è¡Œé¡ºåºã€‚ æ‰§è¡Œ è¿è¡Œåœ¨é…ç½®é˜¶æ®µç»“æŸæ—¶é€‰æ‹©çš„ä»»åŠ¡ã€‚ è¿™äº›é˜¶æ®µæ„æˆäº†Gradleçš„æ„å»ºç”Ÿå‘½å‘¨æœŸã€‚ 4. Gradleçš„æ‰©å±•æ–¹å¼ä¸æ­¢ä¸€ç§ Gradleæ†ç»‘çš„æ„å»ºé€»è¾‘ä¸å¯èƒ½æ»¡è¶³æ‰€æœ‰æ„å»ºæƒ…å†µï¼Œå¤§å¤šæ•°æ„å»ºéƒ½æœ‰ä¸€äº›ç‰¹æ®Šè¦æ±‚ï¼Œä½ éœ€è¦æ·»åŠ è‡ªå®šä¹‰æ„å»ºé€»è¾‘ã€‚Gradleæä¾›äº†å¤šç§æœºåˆ¶æ¥æ‰©å±•å®ƒï¼Œä¾‹å¦‚ï¼š è‡ªå®šä¹‰ä»»åŠ¡ç±»å‹ã€‚ è‡ªå®šä¹‰ä»»åŠ¡åŠ¨ä½œã€‚ é¡¹ç›®å’Œä»»åŠ¡çš„é¢å¤–å±æ€§ã€‚ è‡ªå®šä¹‰çº¦æŸã€‚ è‡ªå®šä¹‰moduleã€‚ 5. æ„å»ºè„šæœ¬é’ˆå¯¹APIè¿è¡Œ å¯ä»¥å°†Gradleçš„æ„å»ºè„šæœ¬è§†ä¸ºå¯æ‰§è¡Œä»£ç ï¼Œä½†è®¾è®¡è‰¯å¥½çš„æ„å»ºè„šæœ¬æè¿°äº†æ„å»ºè½¯ä»¶éœ€è¦å“ªäº›æ­¥éª¤ï¼Œè€Œä¸å…³å¿ƒè¿™äº›æ­¥éª¤åº”è¯¥å¦‚ä½•å®Œæˆå·¥ä½œã€‚ ç”±äºGradleåœ¨JVMä¸Šè¿è¡Œï¼Œå› æ­¤æ„å»ºè„šæœ¬ä¹Ÿå¯ä»¥ä½¿ç”¨æ ‡å‡†Java APIã€‚Groovyæ„å»ºè„šæœ¬å¯ä»¥å¦å¤–ä½¿ç”¨Groovy APIï¼Œè€ŒKotlinæ„å»ºè„šæœ¬å¯ä»¥ä½¿ç”¨Kotlinã€‚ åŠŸèƒ½çš„ç”Ÿå‘½å‘¨æœŸ åŠŸèƒ½å¯ä»¥å¤„äºä»¥ä¸‹å››ç§çŠ¶æ€ä¹‹ä¸€ï¼š Internalï¼šå†…éƒ¨åŠŸèƒ½ï¼Œä¸æä¾›æ¥å£ Incubatingï¼š å­µåŒ–åŠŸèƒ½ã€‚åœ¨æˆä¸ºå…¬å…±åŠŸèƒ½ä¹‹å‰ä¼šç»§ç»­æ›´æ”¹ Publicï¼šå…¬å…±åŠŸèƒ½ï¼Œå¯æ”¾å¿ƒä½¿ç”¨ Deprecatedï¼šåºŸå¼ƒåŠŸèƒ½ï¼Œå°†åœ¨æœªæ¥åˆ é™¤ Gradleå®‰è£… å®‰è£…JDK å®‰è£…JDKè¿‡ç¨‹å·²æœ‰å¤ªå¤šèµ„æ–™ï¼Œæœ¬æ–‡ä¸åšè¯¦ç»†ä»‹ç»ã€‚å¯ä½¿ç”¨å‘½ä»¤æ£€æµ‹è‡ªå·±ç”µè„‘æ˜¯å¦æˆåŠŸå®‰è£… å®‰è£…Gradle ç”¨è½¯ä»¶åŒ…å®‰è£…Gradle SDKMAN sdk install gradle Homebrew brew install gradle æ‰‹åŠ¨å®‰è£…ï¼ˆæ¨èæ–¹å¼ï¼‰ ä¸‹è½½ services.gradle.org/distributions ï¼ˆå…¨éƒ¨ç‰ˆæœ¬ç›®å½•åœ°å€ï¼Œå¯ä»¥æŸ¥çœ‹æœ€æ–°ç‰ˆæœ¬ï¼‰ services.gradle.org/distributions/gradle-7.5-all.zip ï¼ˆæˆªæ­¢è‡³2022.07.18æœ€æ–°ï¼‰ å»ºè®®ä¸‹è½½ï¼šservices.gradle.org/distributions/gradle-7.0.2-all.zip (æ”¯æŒjdk8) æ–‡ä»¶ä»‹ç» gradle-7.0.2-docs.zip //æ–‡æ¡£ gradle-7.0.2-src.zip //æºç  gradle-7.0.2-bin.zip //è½¯ä»¶åŒ… gradle-7.0.2-all.zip //å…¨éƒ¨æ–‡ä»¶ bin ï¼šè¿è¡Œæ–‡ä»¶ libï¼šä¾èµ–åº“ docsï¼šæ–‡æ¡£ srcï¼šæºæ–‡ä»¶ init.d :åˆå§‹åŒ–è„šæœ¬ç›®å½•ï¼Œå¯è‡ªå·±æ·»åŠ  é…ç½®ç¯å¢ƒå˜é‡ export GRADLE_HOME=/Users/temp/gradle-7.0.2 export PATH=$PATH:$GRADLE_HOME/bin è¿è¡Œ è¾“å…¥gradle -v æ£€æµ‹æ˜¯å¦é…ç½®æˆåŠŸ HelloWord ç¼–å†™ä¸€ä¸ªbuild.gradleæ–‡ä»¶ï¼Œè¾“å…¥ä»¥ä¸‹å†…å®¹ task hello{ doLast { println 'Hello World' } } å‘½ä»¤è¡Œè¾“å…¥gradle -q helloå³å¯è¿è¡Œ Gradle Wrapper å®šä¹‰ Gradle Wrapperæ˜¯ä¸€ä¸ªè„šæœ¬ï¼Œå¯è°ƒç”¨Gradleçš„å£°æ˜ç‰ˆæœ¬ï¼Œå¹¶åœ¨å¿…è¦æ—¶é¢„å…ˆä¸‹è½½ã€‚å› æ­¤ï¼Œå¼€å‘äººå‘˜å¯ä»¥å¿«é€Ÿå¯åŠ¨å¹¶è¿è¡ŒGradleé¡¹ç›®ï¼Œè€Œæ— éœ€éµå¾ªæ‰‹åŠ¨å®‰è£…è¿‡ç¨‹ æ·»åŠ wrapper åœ¨build.gradleåŒçº§ç›®å½•ä¸‹ä½¿ç”¨å‘½ä»¤gradle wrapperå¯ä»¥ç”Ÿæˆgradle wrapperç›®å½• gradle wrapper gradle-wrapper.jar WrapJARæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«ç”¨äºä¸‹è½½Gradleå‘è¡Œç‰ˆçš„ä»£ç ã€‚ gradle-wrapper.properties ä¸€ä¸ªå±æ€§æ–‡ä»¶ï¼Œè´Ÿè´£é…ç½®Wrapperè¿è¡Œæ—¶è¡Œä¸ºï¼Œä¾‹å¦‚ä¸è¯¥ç‰ˆæœ¬å…¼å®¹çš„Gradleç‰ˆæœ¬ã€‚è¯·æ³¨æ„ï¼Œæ›´å¤šå¸¸è§„è®¾ç½®ï¼ˆä¾‹å¦‚ï¼Œå°† Wrapé…ç½®ä¸ºä½¿ç”¨ä»£ç†ï¼‰éœ€è¦è¿›å…¥å…¶ä»–æ–‡ä»¶ã€‚ gradlewï¼Œ gradlew.bat ä¸€ä¸ªshellè„šæœ¬å’Œä¸€ä¸ªWindowsæ‰¹å¤„ç†è„šæœ¬ï¼Œç”¨äºä½¿ç”¨ Wrapç¨‹åºæ‰§è¡Œæ„å»ºã€‚ å¯ä»¥é€šè¿‡å‘½ä»¤æ§åˆ¶ç”Ÿæˆé€‰é¡¹ #ç”¨äºä¸‹è½½å’Œæ‰§è¡Œ Wrapç¨‹åºçš„Gradleç‰ˆæœ¬ã€‚ --gradle-version #Wrapä½¿ç”¨çš„Gradleåˆ†å¸ƒç±»å‹ã€‚å¯ç”¨çš„é€‰é¡¹æ˜¯binå’Œallã€‚é»˜è®¤å€¼ä¸ºbinã€‚ --distribution-type #æŒ‡å‘Gradleåˆ†å‘ZIPæ–‡ä»¶çš„å®Œæ•´URLã€‚ä½¿ç”¨æ­¤é€‰é¡¹ï¼Œ--gradle-versionå¹¶ä¸”--distribution- typeè¿‡æ—¶çš„ç½‘å€å·²ç»åŒ…å«æ­¤ä¿¡æ¯ã€‚å¦‚æœæ‚¨æƒ³åœ¨å…¬å¸ç½‘ç»œå†…éƒ¨æ‰˜ç®¡Gradleå‘è¡Œç‰ˆï¼Œåˆ™æ­¤é€‰é¡¹éå¸¸æœ‰ä»·å€¼ã€‚ --gradle-distribution-url #SHA256å“ˆå¸Œå’Œç”¨äºéªŒè¯ä¸‹è½½çš„Gradleåˆ†å¸ƒã€‚ --gradle-distribution-sha256-sum ä¾‹ï¼š gradle wrapper --gradle-version 7.0.2 --distribution-type all Wrapperå±æ€§æ–‡ä»¶ ä¸€èˆ¬ç”ŸæˆWrapperä¼šå¾—åˆ°å¦‚ä¸‹å±æ€§æ–‡ä»¶ gradle-wrapper.properties distributionBase=GRADLE_USER_HOME distributionPath=wrapper/dists distributionUrl=https\\://services.gradle.org/distributions/gradle-7.4.1-bin.zip zipStoreBase=GRADLE_USER_HOME zipStorePath=wrapper/dists GRADLE_USER_HOMEæ˜¯ä½ çš„ç¯å¢ƒå˜é‡ï¼Œå¦‚æœæ²¡é…ç½®ï¼Œåˆ™é»˜è®¤æ˜¯ç”¨æˆ·ç›®å½•ä¸‹çš„.gradleæ–‡ä»¶å¤¹ distributionBase ä¸‹è½½çš„ Gradleå‹ç¼©åŒ…è§£å‹åå­˜å‚¨çš„ä¸»ç›®å½• distributionPath ç›¸å¯¹äº distributionBaseçš„è§£å‹åçš„ Gradleå‹ç¼©åŒ…çš„è·¯å¾„ zipStoreBase åŒ distributionBaseï¼Œåªä¸è¿‡æ˜¯å­˜æ”¾ zipå‹ç¼©åŒ…çš„ zipStorePath åŒ distributionPathï¼Œåªä¸è¿‡æ˜¯å­˜æ”¾ zipå‹ç¼©åŒ…çš„ distributionUrl Gradleå‘è¡Œç‰ˆå‹ç¼©åŒ…çš„ä¸‹è½½åœ°å€ ä½¿ç”¨wrapperæ„å»º åœ¨ gradlewç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤ï¼š windowsï¼š gradlew.bat build shellï¼š ./gradlew build å‡çº§ æ›´æ”¹gradle-wrapper.propertiesæ–‡ä»¶ä¸­çš„distributionUrlå±æ€§ ä½¿ç”¨gradlew wrap --gradle-version å‘½ä»¤ ./gradlew wrap --gradle-version 7.4.2 è‡ªå®šä¹‰Gradle_Wrap å¯ä»¥é€šè¿‡è‡ªå®šä¹‰wrapperå°‘å»ä¸€äº›é‡å¤æ“ä½œæˆ–å®šåˆ¶åŠŸèƒ½ï¼Œå¦‚ build.gradle tasks.named('wrapper') { distributionType = Wrapper.DistributionType.ALL } task wrapper(type: Wrapper) { gradleVersion = '7.4.2' } Gradle ç¯å¢ƒ ç¯å¢ƒå˜é‡ GRADLE_OPTS æŒ‡å®šå¯åŠ¨Gradleå®¢æˆ·ç«¯VMæ—¶è¦ä½¿ç”¨çš„JVMå‚æ•°ã€‚å®¢æˆ·ç«¯VMä»…å¤„ç†å‘½ä»¤è¡Œè¾“å…¥/è¾“å‡ºï¼Œå› æ­¤å¾ˆå°‘éœ€è¦æ›´æ”¹å…¶VMé€‰é¡¹ã€‚å®é™…çš„æ„å»ºç”±Gradleå®ˆæŠ¤ç¨‹åºè¿è¡Œï¼Œä¸å—æ­¤ç¯å¢ƒå˜é‡çš„å½±å“ã€‚ GRADLE_USER_HOME æŒ‡å®šGradleç”¨æˆ·çš„ä¸»ç›®å½•ï¼ˆå¦‚æœæœªè®¾ç½®ï¼Œåˆ™é»˜è®¤ä¸º$USER_HOME/.gradleï¼‰ã€‚ JAVA_HOME æŒ‡å®šè¦ç”¨äºå®¢æˆ·ç«¯VMçš„JDKå®‰è£…ç›®å½•ã€‚é™¤éGradleå±æ€§æ–‡ä»¶ä½¿ç”¨org.gradle.java.homeæŒ‡å®šäº†å¦ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œå¦åˆ™æ­¤è™šæ‹Ÿæœºä¹Ÿç”¨äºå®ˆæŠ¤ç¨‹åºã€‚ æ³¨æ„ï¼šå‘½ä»¤è¡Œé€‰é¡¹å’Œç³»ç»Ÿå±æ€§ä¼˜å…ˆäºç¯å¢ƒå˜é‡ã€‚ Gradleå±æ€§ ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è‡ªå·±é…ç½®ä½ çš„é¡¹ç›®å±æ€§ï¼Œå¦‚æœå­˜åœ¨å¤šä¸ªï¼Œåˆ™ä»ä¸Šåˆ°ä¸‹ä¼˜å…ˆè¯»å– ï¼š ç³»ç»Ÿå±æ€§ï¼Œä¾‹å¦‚åœ¨å‘½ä»¤è¡Œä¸Šè®¾ç½® -Dgradle.user.home GRADLE_USER_HOMEç›®å½•ä¸­çš„gradle.properties é¡¹ç›®æ ¹ç›®å½•ä¸­çš„gradle.properties Gradleå®‰è£…ç›®å½•ä¸­çš„gradle.properties gradle.properties # å½“è®¾ç½®ä¸ºtrueæ—¶ï¼ŒGradleå°†åœ¨å¯èƒ½çš„æƒ…å†µä¸‹é‡ç”¨ä»»ä½•å…ˆå‰æ„å»ºçš„ä»»åŠ¡è¾“å‡ºï¼Œä»è€Œä½¿æ„å»ºé€Ÿåº¦æ›´å¿« org.gradle.caching=true # è®¾ç½®ä¸ºtrueæ—¶ï¼Œå•ä¸ªè¾“å…¥å±æ€§å“ˆå¸Œå€¼å’Œæ¯ä¸ªä»»åŠ¡çš„æ„å»ºç¼“å­˜é”®éƒ½è®°å½•åœ¨æ§åˆ¶å°ä¸Šã€‚ org.gradle.caching.debug=true # å¯ç”¨æŒ‰éœ€å­µåŒ–é…ç½®ï¼ŒGradleå°†å°è¯•ä»…é…ç½®å¿…è¦çš„é¡¹ç›®ã€‚ org.gradle.configureondemand=true # è‡ªå®šä¹‰æ§åˆ¶å°è¾“å‡ºçš„é¢œè‰²æˆ–è¯¦ç»†ç¨‹åº¦ã€‚é»˜è®¤å€¼å–å†³äºGradleçš„è°ƒç”¨æ–¹å¼ã€‚å¯é€‰(auto,plain,rich,verbose) org.gradle.console=auto # å½“è®¾ç½®trueçš„Gradleå®ˆæŠ¤è¿›ç¨‹æ¥è¿è¡Œæ„å»ºã€‚é»˜è®¤å€¼ä¸ºtrueã€‚ org.gradle.daemon=true # åœ¨æŒ‡å®šçš„ç©ºé—²æ¯«ç§’æ•°åï¼ŒGradleå®ˆæŠ¤ç¨‹åºå°†è‡ªè¡Œç»ˆæ­¢ã€‚é»˜è®¤å€¼ä¸º10800000ï¼ˆ3å°æ—¶ï¼‰ã€‚ org.gradle.daemon.idletimeout=10800000 # è®¾ç½®trueä¸ºæ—¶ï¼ŒGradleå°†åœ¨å¯ç”¨è¿œç¨‹è°ƒè¯•çš„æƒ…å†µä¸‹è¿è¡Œæ„å»ºï¼Œä¾¦å¬ç«¯å£5005ã€‚ # è¯·æ³¨æ„ï¼Œè¿™ç­‰åŒäºæ·»åŠ -agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005åˆ°JVMå‘½ä»¤è¡Œï¼Œå¹¶ä¸”å°†æŒ‚èµ·è™šæ‹Ÿæœºï¼Œç›´åˆ°è¿æ¥äº†è°ƒè¯•å™¨ã€‚ # é»˜è®¤å€¼ä¸ºfalseã€‚ org.gradle.debug=true # æŒ‡å®šç”¨äºGradleæ„å»ºè¿‡ç¨‹çš„Javaä¸»é¡µã€‚å¯ä»¥å°†å€¼è®¾ç½®ä¸ºjdkæˆ–jreä½ç½®ï¼Œä½†æ˜¯ï¼Œæ ¹æ®æ‚¨çš„æ„å»ºæ–¹å¼ï¼Œä½¿ç”¨JDKæ›´å®‰å…¨ã€‚ # å¦‚æœæœªæŒ‡å®šè®¾ç½®ï¼Œåˆ™ä»æ‚¨çš„ç¯å¢ƒï¼ˆJAVA_HOMEæˆ–çš„è·¯å¾„javaï¼‰æ´¾ç”Ÿåˆç†çš„é»˜è®¤å€¼ã€‚è¿™ä¸ä¼šå½±å“ç”¨äºå¯åŠ¨Gradleå®¢æˆ·ç«¯VMçš„Javaç‰ˆæœ¬ï¼ˆè¯·å‚é˜…ç¯å¢ƒå˜é‡ï¼‰ã€‚ org.gradle.java.home=/usr/bin/java # æŒ‡å®šç”¨äºGradleå®ˆæŠ¤ç¨‹åºçš„JVMå‚æ•°ã€‚è¯¥è®¾ç½®å¯¹äºé…ç½®JVMå†…å­˜è®¾ç½®ä»¥æé«˜æ„å»ºæ€§èƒ½ç‰¹åˆ«æœ‰ç”¨ã€‚è¿™ä¸ä¼šå½±å“Gradleå®¢æˆ·ç«¯VMçš„JVMè®¾ç½®ã€‚ org.gradle.jvmargs=-Xmx2048m # å½“è®¾ç½®ä¸ºquiet,warn,lifecycle,info,debugæ—¶ï¼ŒGradleå°†ä½¿ç”¨æ­¤æ—¥å¿—çº§åˆ«ã€‚è¿™äº›å€¼ä¸åŒºåˆ†å¤§å°å†™ã€‚è¯¥lifecycleçº§åˆ«æ˜¯é»˜è®¤çº§åˆ«ã€‚ # å¯é€‰(quiet,warn,lifecycle,info,debug) org.gradle.logging.level=debug # é…ç½®åï¼ŒGradleå°†åˆ†å‰åˆ°org.gradle.workers.maxJVMä»¥å¹¶è¡Œæ‰§è¡Œé¡¹ç›® org.gradle.parallel=true # æŒ‡å®šGradleå®ˆæŠ¤ç¨‹åºåŠå…¶å¯åŠ¨çš„æ‰€æœ‰è¿›ç¨‹çš„è°ƒåº¦ä¼˜å…ˆçº§ã€‚é»˜è®¤å€¼ä¸ºnormalã€‚(low,normal) org.gradle.priority=normal # åœ¨ç›‘è§†æ–‡ä»¶ç³»ç»Ÿæ—¶é…ç½®è¯¦ç»†æ—¥å¿—è®°å½•ã€‚ é»˜è®¤ä¸ºå…³é—­ ã€‚ org.gradle.vfs.verbose=true # åˆ‡æ¢è§‚çœ‹æ–‡ä»¶ç³»ç»Ÿã€‚å…è®¸Gradleåœ¨ä¸‹ä¸€ä¸ªç‰ˆæœ¬ä¸­é‡ç”¨æœ‰å…³æ–‡ä»¶ç³»ç»Ÿçš„ä¿¡æ¯ã€‚ é»˜è®¤ä¸ºå…³é—­ ã€‚ org.gradle.vfs.watch=true # å½“è®¾ç½®ä¸ºallï¼Œsummaryæˆ–è€…noneï¼ŒGradleä¼šä½¿ç”¨ä¸åŒçš„é¢„è­¦ç±»å‹çš„æ˜¾ç¤ºå™¨ã€‚(all,fail,summary,none) org.gradle.warning.mode=all # é…ç½®åï¼ŒGradleå°†æœ€å¤šä½¿ç”¨ç»™å®šæ•°é‡çš„å·¥äººã€‚é»˜è®¤å€¼ä¸ºCPUå¤„ç†å™¨æ•°ã€‚ org.gradle.workers.max=5 ç³»ç»Ÿå±æ€§ # æŒ‡å®šç”¨æˆ·åä»¥ä½¿ç”¨HTTPåŸºæœ¬è®¤è¯ä»æœåŠ¡å™¨ä¸‹è½½Gradleå‘è¡Œç‰ˆ systemProp.gradle.wrapperUser = myuser # æŒ‡å®šä½¿ç”¨Gradle Wrapperä¸‹è½½Gradleå‘è¡Œç‰ˆçš„å¯†ç  systemProp.gradle.wrapperPassword = mypassword # æŒ‡å®šGradleç”¨æˆ·çš„ä¸»ç›®å½• systemProp.gradle.user.home=(path to directory) é¡¹ç›®å±æ€§ org.gradle.project.foo = bar å®ˆæŠ¤ç¨‹åº Gradleåœ¨Javaè™šæ‹Ÿæœºï¼ˆJVMï¼‰ä¸Šè¿è¡Œï¼Œå¹¶ä½¿ç”¨ä¸€äº›æ”¯æŒåº“ï¼Œè¿™äº›åº“éœ€è¦å¾ˆçŸ­çš„åˆå§‹åŒ–æ—¶é—´ã€‚ä½†æœ‰æ—¶å¯åŠ¨ä¼šæ¯”è¾ƒæ…¢ã€‚ è§£å†³æ­¤é—®é¢˜çš„æ–¹æ³•æ˜¯Gradle Daemon ï¼šè¿™æ˜¯ä¸€ä¸ªé•¿æœŸå­˜åœ¨çš„åå°è¿›ç¨‹ï¼Œä¸ä»¥å‰ç›¸æ¯”ï¼Œå®ƒå¯ä»¥æ›´å¿«åœ°æ‰§è¡Œæ„å»ºã€‚ å¯é€šè¿‡å‘½ä»¤è·å–è¿è¡Œå®ˆæŠ¤ç¨‹åºçŠ¶æ€ IDLEä¸ºç©ºé—²ï¼ŒBUSYä¸ºç¹å¿™ï¼ŒSTOPPEDåˆ™å·²å…³é—­ å®ˆæŠ¤ç¨‹åºé»˜è®¤æ‰“å¼€ï¼Œå¯é€šè¿‡ä»¥ä¸‹å±æ€§å…³é—­ .gradle/gradle.properties org.gradle.daemon=false ä¹Ÿå¯ç”¨å‘½ä»¤gradle --stopæ‰‹åŠ¨å…³é—­å®ˆæŠ¤ç¨‹åº Gradleå‘½ä»¤è¡Œ å‘½ä»¤è¡Œæ ¼å¼ gradle [taskName ...] [--option-name ...] å¦‚æœæŒ‡å®šäº†å¤šä¸ªä»»åŠ¡ï¼Œåˆ™åº”ä»¥ç©ºæ ¼åˆ†éš”ã€‚ é€‰é¡¹å’Œå‚æ•°ä¹‹é—´å»ºè®®ä½¿ç”¨=æ¥æŒ‡å®šã€‚ --console=plain å¯ç”¨è¡Œä¸ºçš„é€‰é¡¹å…·æœ‰é•¿å½¢å¼çš„é€‰é¡¹ï¼Œå¹¶å¸¦æœ‰ç”±æŒ‡å®šçš„åå‡½æ•°--no-ã€‚ä»¥ä¸‹æ˜¯ç›¸åçš„æƒ…å†µã€‚ --build-cache --no-build-cache è®¸å¤šå‘½ä»¤å…·æœ‰ç¼©å†™ã€‚ä¾‹å¦‚ä»¥ä¸‹å‘½ä»¤æ˜¯ç­‰æ•ˆçš„ï¼š --help -h ä½¿ç”¨Wrapperæ—¶å€™åº”è¯¥ç”¨./gradlewæˆ–gradlew.batå–ä»£gradle #è·å–å¸®åŠ© gradle -? gradle -h gradle -help # æ˜¾ç¤ºæ‰€é€‰é¡¹ç›®çš„å­é¡¹ç›®åˆ—è¡¨ï¼Œä»¥å±‚æ¬¡ç»“æ„æ˜¾ç¤ºã€‚ gradle projects #æŸ¥çœ‹å¯æ‰§è¡Œtask gradle task #æŸ¥çœ‹å¯æ‰§è¡Œtaskå¸®åŠ© gradle help -task # åœ¨Gradleæ„å»ºä¸­ï¼Œé€šå¸¸çš„`build`ä»»åŠ¡æ˜¯æŒ‡å®šç»„è£…æ‰€æœ‰è¾“å‡ºå¹¶è¿è¡Œæ‰€æœ‰æ£€æŸ¥ã€‚ gradle build # æ‰§è¡Œæ‰€æœ‰éªŒè¯ä»»åŠ¡ï¼ˆåŒ…æ‹¬testå’Œlintingï¼‰ã€‚ gradle check # æ¸…ç†é¡¹ç›® gradle clean #å¼ºåˆ¶åˆ·æ–°ä¾èµ– gradle --refresh-dependencies assemble #ç¼©å†™è°ƒç”¨ gradle startCmd == gradle sc # æ‰§è¡Œä»»åŠ¡ gradle myTask # æ‰§è¡Œå¤šä¸ªä»»åŠ¡ gradle myTask test # æ‰§è¡Œ distä»»åŠ¡ä½†æ’é™¤testä»»åŠ¡ gradle dist --exclude-task test # å¼ºåˆ¶æ‰§è¡Œä»»åŠ¡ gradle test --rerun-tasks # æŒç»­æ„å»º # gradle test --continue # ç”Ÿæˆæ‰«æä¼šæä¾›å®Œæ•´çš„å¯è§†åŒ–æŠ¥å‘Šï¼Œè¯´æ˜å“ªäº›ä¾èµ–é¡¹å­˜åœ¨äºå“ªäº›é…ç½®ï¼Œå¯ä¼ é€’ä¾èµ–é¡¹å’Œä¾èµ–é¡¹ç‰ˆæœ¬é€‰æ‹©ä¸­ã€‚ $ gradle myTask --scan # æ‰€é€‰é¡¹ç›®çš„ä¾èµ–é¡¹åˆ—è¡¨ $ gradle dependencies ","link":"https://tianxiawuhao.github.io/Ke4qDxE4l/"},{"title":"gradleè¯¦æƒ…","content":"ä¸€ ä¾èµ–ç®¡ç† implementation:ä¼šå°†æŒ‡å®šçš„ä¾èµ–æ·»åŠ åˆ°ç¼–è¯‘è·¯å¾„ï¼Œå¹¶ä¸”ä¼šå°†è¯¥ä¾èµ–æ‰“åŒ…åˆ°è¾“å‡ºï¼Œä½†æ˜¯è¿™ä¸ªä¾èµ–åœ¨ç¼–è¯‘æ—¶ä¸èƒ½æš´éœ²ç»™å…¶ä»–æ¨¡å—ï¼Œä¾‹å¦‚ä¾èµ–æ­¤æ¨¡å—çš„å…¶ä»–æ¨¡å—ã€‚è¿™ç§æ–¹å¼æŒ‡å®šçš„ä¾èµ–åœ¨ç¼–è¯‘æ—¶åªèƒ½åœ¨å½“å‰æ¨¡å—ä¸­è®¿é—®ã€‚ api:ä½¿ç”¨apié…ç½®çš„ä¾èµ–ä¼šå°†å¯¹åº”çš„ä¾èµ–æ·»åŠ åˆ°ç¼–è¯‘è·¯å¾„ï¼Œå¹¶å°†ä¾èµ–æ‰“åŒ…è¾“å‡ºï¼Œä½†æ˜¯è¿™ä¸ªä¾èµ–æ˜¯å¯ä»¥ä¼ é€’çš„ï¼Œæ¯”å¦‚æ¨¡å—Aä¾èµ–æ¨¡å—Bï¼ŒBä¾èµ–åº“Cï¼Œæ¨¡å—Båœ¨ç¼–è¯‘æ—¶èƒ½å¤Ÿè®¿é—®åˆ°åº“Cï¼Œä½†æ˜¯ä¸implemetationä¸åŒçš„æ˜¯ï¼Œåœ¨æ¨¡å—Aä¸­åº“Cä¹Ÿæ˜¯å¯ä»¥è®¿é—®çš„ã€‚ compileOnly:compileOnlyä¿®é¥°çš„ä¾èµ–ä¼šæ·»åŠ åˆ°ç¼–è¯‘è·¯å¾„ä¸­ï¼Œä½†æ˜¯ä¸ä¼šæ‰“åŒ…ï¼Œå› æ­¤åªèƒ½åœ¨ç¼–è¯‘æ—¶è®¿é—®ï¼Œä¸”compileOnlyä¿®é¥°çš„ä¾èµ–ä¸ä¼šä¼ é€’ã€‚ runtimeOnly:è¿™ä¸ªä¸compileOnlyç›¸åï¼Œå®ƒä¿®é¥°çš„ä¾èµ–ä¸ä¼šæ·»åŠ åˆ°ç¼–è¯‘è·¯å¾„ä¸­ï¼Œä½†æ˜¯è¢«æ‰“åŒ…ï¼Œè¿è¡Œæ—¶ä½¿ç”¨ã€‚æ²¡æœ‰ä½¿ç”¨è¿‡ã€‚ annotationProcessor:ç”¨äºæ³¨è§£å¤„ç†å™¨çš„ä¾èµ–é…ç½® dependencies { // æœ¬åœ°é¡¹ç›® api project(':com.test.core:core-common') //å¤–éƒ¨ä¾èµ– implementation 'org.springframework.boot:spring-boot-starter' compileOnly 'org.projectlombok:lombok' annotationProcessor 'org.projectlombok:lombok' testImplementation 'org.springframework.boot:spring-boot-starter-test' } äºŒ ä»“åº“ è¿œç¨‹ä»“åº“ ä½¿ç”¨Mavenä¸­å¤®ä»“åº“ï¼Œmavenä»“åº“çš„URLä¸ºï¼šhttp://repo1.maven.org/maven2/ repositories { mavenCentral() } ä½¿ç”¨Mavenè¿œç¨‹ä»“åº“ repositories { //é˜¿é‡Œäº‘è¿œç¨‹ä»“åº“ maven { url 'https://maven.aliyun.com/repository/central'} maven { url 'https://maven.aliyun.com/repository/public' } mavenCentral() } æœ¬åœ°ä»“åº“ é…ç½®Gradleä½¿ç”¨mavenæœ¬åœ°ä»“åº“ï¼šCRADLE_USER_HOMEï¼šD:.m2\\repository ä¿®æ”¹é…ç½®build.gradleï¼š /** * æŒ‡å®šæ‰€ä½¿ç”¨çš„ä»“åº“ï¼ŒmavenCentral()è¡¨ç¤ºä½¿ç”¨ä¸­å¤®ä»“åº“ï¼Œ * æ­¤åˆ»é¡¹ç›®ä¸­æ‰€éœ€è¦çš„jaråŒ…éƒ½ä¼šé»˜è®¤ä»ä¸­å¤®ä»“åº“ä¸‹è½½åˆ°æœ¬åœ°æŒ‡å®šç›®å½• * é…ç½®mavenLocal()è¡¨ç¤ºå¼•å…¥jaråŒ…çš„æ—¶å€™ï¼Œå…ˆä»æœ¬åœ°ä»“åº“ä¸­æ‰¾ï¼Œæ²¡æœ‰å†å»ä¸­å¤®ä»“åº“ä¸‹è½½ */ repositories { mavenLocal() mavenCentral() } ä¿®æ”¹æˆ–è€…æ·»åŠ é¢å¤–çš„ç§æœ‰ä»“åº“åœ°å€ ç›´æ¥ä¿®æ”¹ settings.gradle æ¥æ·»åŠ å…¶å®ƒä»“åº“ï¼š // settings.gradle //pluginManagement {}å—åªèƒ½å‡ºç°åœ¨settings.gradleæ–‡ä»¶ä¸­ï¼Œå¿…é¡»æ˜¯æ–‡ä»¶ä¸­çš„ç¬¬ä¸€ä¸ªå—ï¼Œä¹Ÿå¯ä»¥ä»¥settingså½¢å¼å‡ºç°åœ¨åˆå§‹åŒ–è„šæœ¬ä¸­ã€‚ pluginManagement { repositories { maven { url 'https://maven.aliyun.com/repository/central'} maven { url 'https://maven.aliyun.com/repository/public' } mavenCentral() gradlePluginPortal() maven { url 'https://repo.spring.io/release' } if (version.endsWith('-SNAPSHOT')) { maven { url &quot;https://repo.spring.io/snapshot&quot; } } } } ä¸‰ å¤šé¡¹ç›®æ„å»º å¤šé¡¹ç›®æ„æˆï¼šallProjects = rooté¡¹ç›®+å„å­é¡¹ç›® settingsæ–‡ä»¶å£°æ˜äº†æ‰€éœ€çš„é…ç½®æ¥å®ä¾‹åŒ–é¡¹ç›®çš„å±‚æ¬¡ç»“æ„ã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸ªæ–‡ä»¶è¢«å‘½åä¸ºsettings.gradleï¼Œå¹¶ä¸”å’Œæ ¹é¡¹ç›®çš„build.gradleæ–‡ä»¶æ”¾åœ¨ä¸€èµ·ï¼Œè¯¥æ–‡ä»¶åœ¨åˆå§‹åŒ–é˜¶æ®µè¢«æ‰§è¡Œã€‚æ ¹é¡¹ç›®å°±åƒä¸€ä¸ªå®¹å™¨ï¼Œå­é¡¹ç›®ä¼šè¿­ä»£è®¿é—®å®ƒçš„é…ç½®å¹¶æ³¨å…¥åˆ°è‡ªå·±çš„é…ç½®ä¸­ã€‚ å¤šé¡¹ç›®æ„å»º å¤šé¡¹ç›®æ„å»ºæ€»æ˜¯éœ€è¦æŒ‡å®šä¸€ä¸ªæ ‘æ ¹ï¼Œæ ‘ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªé¡¹ç›®ï¼Œæ¯ä¸€ä¸ªProjectå¯¹è±¡éƒ½æŒ‡å®šæœ‰ä¸€ä¸ªè¡¨ç¤ºåœ¨æ ‘ä¸­ä½ç½®çš„è·¯å¾„ï¼›åœ¨è®¾ç½®æ–‡ä»¶ä¸­æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ä¸€å¥—æ–¹æ³•æ¥è‡ªå®šä¹‰æ„å»ºé¡¹ç›®æ ‘ã€‚ settings.gradleä½œç”¨å°±æ˜¯ç”¨äºå¤šé¡¹ç›®æ„å»ºï¼Œä¸€èˆ¬åƒè¿™æ ·ï¼š //çˆ¶æ¨¡å—åç§° rootProject.name = 'nacos' //å¼•å…¥å­æ¨¡å— include 'sentinel' include 'openfeign' include 'loadbalancer' include 'gateway' include 'rocketmq' include 'sleuth' include 'seata' include 'provide' findProject(':iot-service:user-center')?.name = 'user-center' buildScript buildScriptå—çš„repositoriesä¸»è¦æ˜¯ä¸ºäº†Gradleè„šæœ¬è‡ªèº«çš„æ‰§è¡Œï¼Œè·å–è„šæœ¬ä¾èµ–æ’ä»¶ã€‚ buildscriptä¸­çš„å£°æ˜æ˜¯gradleè„šæœ¬è‡ªèº«éœ€è¦ä½¿ç”¨çš„èµ„æºã€‚å¯ä»¥å£°æ˜çš„èµ„æºåŒ…æ‹¬ä¾èµ–é¡¹ã€ç¬¬ä¸‰æ–¹æ’ä»¶ã€mavenä»“åº“åœ°å€ç­‰ã€‚ gradleåœ¨æ‰§è¡Œè„šæœ¬æ—¶ï¼Œä¼šä¼˜å…ˆæ‰§è¡Œbuildscriptä»£ç å—ä¸­çš„å†…å®¹ï¼Œç„¶åæ‰ä¼šæ‰§è¡Œå‰©ä½™çš„buildè„šæœ¬ã€‚ buildscript { ext { //spring-cloud-dependencies 2020.0.0 é»˜è®¤ä¸åœ¨åŠ è½½bootstrap é…ç½®æ–‡ä»¶ï¼Œ //å¦‚æœé¡¹ç›®ä¸­è¦ç”¨bootstrap é…ç½®æ–‡ä»¶ éœ€è¦æ‰‹åŠ¨æ·»åŠ spring-cloud-starter-bootstrap ä¾èµ–ï¼Œä¸ç„¶å¯åŠ¨é¡¹ç›®ä¼šæŠ¥é”™çš„ã€‚ set('springCloudVersion', &quot;2021.0.3&quot;) //å®šä¹‰ä¸€ä¸ªå˜é‡ï¼Œç»Ÿä¸€è§„å®šspringbootçš„ç‰ˆæœ¬ set('springBootVersion', &quot;2.6.8&quot;) set('alibabaVersion', &quot;2.2.7.RELEASE&quot;) set('lombok', &quot;1.18.16&quot;) set('knife4j', &quot;2.0.9&quot;) set('hutool', &quot;4.6.3&quot;) set('rocketmq', &quot;2.2.2&quot;) } repositories { mavenLocal() maven { url 'https://maven.aliyun.com/repository/central' } maven { url 'https://maven.aliyun.com/repository/public' } mavenCentral() } dependencies { //ç”¨æ¥æ‰“åŒ… classpath(&quot;org.springframework.boot:spring-boot-gradle-plugin:${springBootVersion}&quot;) } } extï¼šextæ˜¯è‡ªå®šä¹‰å±æ€§ï¼Œç°åœ¨å¾ˆå¤šäººéƒ½å–œæ¬¢æŠŠæ‰€æœ‰å…³äºç‰ˆæœ¬çš„ä¿¡æ¯éƒ½åˆ©ç”¨extæ”¾åœ¨å¦ä¸€ä¸ªè‡ªå·±æ–°å»ºçš„gradleæ–‡ä»¶ä¸­é›†ä¸­ç®¡ç†ã€‚ allprojects allprojectså—çš„repositoriesç”¨äºå¤šé¡¹ç›®æ„å»ºï¼Œä¸ºæ‰€æœ‰é¡¹ç›®æä¾›å…±åŒæ‰€éœ€ä¾èµ–åŒ…ã€‚è€Œå­é¡¹ç›®å¯ä»¥é…ç½®è‡ªå·±çš„repositoriesä»¥è·å–è‡ªå·±ç‹¬éœ€çš„ä¾èµ–åŒ…ã€‚ buildscriptå’Œallprojectsçš„ä½œç”¨å’ŒåŒºåˆ«ï¼š buildscriptä¸­çš„å£°æ˜æ˜¯gradleè„šæœ¬è‡ªèº«éœ€è¦ä½¿ç”¨çš„èµ„æºï¼Œå°±æ˜¯è¯´å®ƒè‡ªå·±éœ€è¦çš„èµ„æºï¼Œè·Ÿä½ å…¶å®ƒæ¨¡å—å…¶å®å¹¶æ²¡æœ‰ä»€ä¹ˆå…³ç³»ã€‚è€Œallprojectså£°æ˜çš„å´æ˜¯æ‰€æœ‰moduleæ‰€éœ€è¦ä½¿ç”¨çš„èµ„æºï¼Œå°±æ˜¯è¯´ä½ çš„æ¯ä¸ªmoduleéƒ½éœ€è¦ç”¨åŒä¸€ä¸ªç¬¬ä¸‰åº“çš„æ—¶å€™ï¼Œå¯ä»¥åœ¨allprojectsé‡Œé¢å£°æ˜ã€‚ allprojects { apply plugin: 'java-library' apply plugin: 'idea' //ä¸‹é¢ä¸¤å¥å¿…é¡»åœ¨æ‰€æœ‰å­é¡¹ç›®ä¸­æ·»åŠ ï¼Œå¦åˆ™å¯¼è‡´importäº†çœ‹èµ·æ¥æ²¡é—®é¢˜ï¼Œä½†æ˜¯ç¼–è¯‘æ—¶æ‰¾ä¸åˆ°å…¶ä»–æ¨¡å—çš„ç±»ã€‚ group = 'com.example' version = '0.0.1-SNAPSHOT' // æŒ‡å®šJDKç‰ˆæœ¬ sourceCompatibility = 1.8 targetCompatibility = 1.8 repositories { mavenLocal() maven { url 'https://maven.aliyun.com/repository/central' } maven { url 'https://maven.aliyun.com/repository/public' } mavenCentral() } //æŒ‡å®šç¼–ç æ ¼å¼ tasks.withType(JavaCompile) { options.encoding = &quot;UTF-8&quot; } } subprojectså­é¡¹ç›®é€šç”¨é…ç½® subprojectsæ˜¯å¯¹æ‰€æœ‰Child Projectçš„é…ç½®: subprojects { apply plugin: 'java-library' apply plugin: 'idea' apply plugin: 'org.springframework.boot' //dependency-management æ’ä»¶ apply plugin: 'io.spring.dependency-management' repositories { mavenLocal() maven { url 'https://maven.aliyun.com/repository/central' } maven { url 'https://maven.aliyun.com/repository/public' } mavenCentral() } dependencies { implementation(enforcedPlatform(&quot;org.springframework.cloud:spring-cloud-dependencies:${springCloudVersion}&quot;)) implementation(enforcedPlatform(&quot;com.alibaba.cloud:spring-cloud-alibaba-dependencies:${alibabaVersion}&quot;)) implementation(enforcedPlatform(&quot;org.springframework.boot:spring-boot-dependencies:${springBootVersion}&quot;)) implementation &quot;com.github.xiaoymin:knife4j-spring-boot-starter:${knife4j}&quot; implementation &quot;cn.hutool:hutool-all:${hutool}&quot; implementation 'org.springframework.boot:spring-boot-starter' implementation 'com.alibaba.cloud:spring-cloud-starter-alibaba-nacos-config' implementation('com.alibaba.cloud:spring-cloud-starter-alibaba-nacos-discovery'){ exclude group: 'org.springframework.cloud', module: 'spring-cloud-starter-netflix-ribbon' } implementation 'org.springframework.cloud:spring-cloud-starter-bootstrap' compileOnly(&quot;org.projectlombok:lombok:${lombok}&quot;) annotationProcessor 'org.springframework.boot:spring-boot-configuration-processor' annotationProcessor(&quot;org.projectlombok:lombok:${lombok}&quot;) testImplementation(&quot;org.springframework.boot:spring-boot-starter-test:${springBootVersion}&quot;) } jar { manifest.attributes provider: 'gradle' } } å›› gradle.properties gradleä¸­çš„å¸¸ç”¨å±æ€§å¯ä»¥å†™åœ¨gradle.propertiesä¸­ã€‚ ä¸€èˆ¬æˆ‘ä»¬éƒ½æŠŠå…¨å±€å±æ€§éƒ½ç¼–å†™åœ¨ä¸€ä¸ªå·¥å…·ç±»ä¸­ï¼Œå¦‚æœæ˜¯æœ‰ç¯å¢ƒçš„åˆ‡æ¢çš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿˜ä¼šå®šä¹‰ä¸€ä¸ªæ ‡å¿—æ¥è¿›è¡Œç›¸åº”çš„å˜æ¢ã€‚å¯¹äºé¡¹ç›®è€Œè¨€ï¼Œæœ‰æ—¶å€™éœ€è¦é…ç½®æŸäº›æ•æ„Ÿä¿¡æ¯ã€‚æ¯”å¦‚å¯†ç ï¼Œå¸å·ç­‰ã€‚è€Œè¿™äº›ä¿¡æ¯éœ€è¦è¢«å¾ˆå¤šç±»å…±åŒä½¿ç”¨ï¼Œæ‰€ä»¥å¿…é¡»æœ‰ä¸€ä¸ªå…¨å±€çš„é…ç½®ã€‚å½“éœ€è¦æŠŠé¡¹ç›®pushåˆ°gitä¸Šæ—¶ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›åˆ«äººçœ‹åˆ°æˆ‘ä»¬é¡¹ç›®çš„keyï¼Œtokenç­‰ã€‚æˆ‘ä»¬å¯ä»¥å°†è¿™äº›ä¿¡æ¯è®¾ç½®åœ¨gradle.propertiesä¸­ã€‚ åªæœ‰åœ¨Androidä¸­æ‰å¯ä½¿ç”¨ã€‚ AppKey = 1234567890 åœ¨build.gradle(module app)ä¸­è¿›è¡Œå˜é‡çš„é‡å®šä¹‰ï¼Œå³å°†é…ç½®å†…å®¹è½¬åŒ–æˆjavaèƒ½å¤Ÿä½¿ç”¨çš„å½¢å¼: android { buildTypes { release { minifyEnabled true proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro' //buildConfigFieldç”¨äºç»™BuildConfigæ–‡ä»¶æ·»åŠ ä¸€ä¸ªå­—æ®µ buildConfigField(&quot;String&quot;,&quot;KEY&quot;,&quot;\\&quot;${AppKey}\\&quot;&quot;) } debug{ buildConfigField(&quot;String&quot;,&quot;KEY&quot;,&quot;\\&quot;${AppKey}\\&quot;&quot;) } } } äº” Gradle æ’ä»¶(Plugins) Gradle ä¹Ÿå¯ä»¥ç”¨ä¸‹é¢çš„æ–¹å¼å£°æ˜ä½¿ç”¨çš„æ’ä»¶ï¼š // plugins DSL plugins { id 'org.springframework.boot' version '2.2.1.RELEASE' id 'io.spring.dependency-management' version '1.0.8.RELEASE' id 'java' } // apply plugin apply plugin: 'java-library' apply plugin: 'idea' apply plugin: 'org.springframework.boot' //dependency-management æ’ä»¶ apply plugin: 'io.spring.dependency-management' å…¶å®æ˜¯ä» Gradle å®˜æ–¹çš„æ’ä»¶ä»“åº“https://plugins.gradle.org/m2/ä¸‹è½½çš„ã€‚ å…­ å¸¸è§çš„taskå‘½ä»¤ build:å½“è¿è¡Œgradle buildå‘½ä»¤æ—¶Gradleå°†ä¼šç¼–è¯‘å’Œæµ‹è¯•ä½ çš„ä»£ç ï¼Œå¹¶ä¸”åˆ›å»ºä¸€ä¸ªåŒ…å«ç±»å’Œèµ„æºçš„JARæ–‡ä»¶ã€‚ clean:å½“è¿è¡Œgradle cleanå‘½ä»¤æ—¶Gradleå°†ä¼šåˆ é™¤buildç”Ÿæˆçš„ç›®å½•å’Œæ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶ã€‚ assemble:å½“è¿è¡Œgradle assembleå‘½ä»¤æ—¶Gradleå°†ä¼šç¼–è¯‘å¹¶æ‰“åŒ…ä»£ç ï¼Œä½†æ˜¯å¹¶ä¸è¿è¡Œå•å…ƒæµ‹è¯•ã€‚ check:å½“è¿è¡Œgradle checkå‘½ä»¤æ—¶Gradleå°†ä¼šç¼–è¯‘å¹¶æµ‹è¯•ä½ çš„ä»£ç ï¼Œå…¶ä»–çš„æ’ä»¶ä¼šåŠ å…¥æ›´å¤šçš„æ£€æŸ¥æ­¥éª¤ã€‚ ä¸ƒ gradle-wrapper Wrapperæ˜¯å¯¹Gradleçš„ä¸€å±‚åŒ…è£…ï¼Œä¾¿äºåœ¨å›¢é˜Ÿå¼€å‘è¿‡ç¨‹ä¸­ç»Ÿä¸€Gradleæ„å»ºçš„ç‰ˆæœ¬å·ï¼Œè¿™æ ·å¤§å®¶éƒ½å¯ä»¥ä½¿ç”¨ç»Ÿä¸€çš„Gradleç‰ˆæœ¬è¿›è¡Œæ„å»ºã€‚ distributionBase=GRADLE_USER_HOME distributionPath=wrapper/dists distributionUrl=https\\://services.gradle.org/distributions/gradle-7.4.2-bin.zip #distributionUrl=file:///E:/gradle/gradle-7.4.2-all.zip zipStoreBase=GRADLE_USER_HOME zipStorePath=wrapper/dists distributionUrlæ˜¯è¦ä¸‹è½½çš„gradleçš„åœ°å€ï¼Œä½¿ç”¨å“ªä¸ªç‰ˆæœ¬çš„gradleï¼Œå°±åœ¨è¿™é‡Œä¿®æ”¹ã€‚ gradleçš„3ç§ç‰ˆæœ¬ï¼š gradle-xx-all.zipæ˜¯å®Œæ•´ç‰ˆï¼ŒåŒ…å«äº†å„ç§äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæºä»£ç æ–‡ä»¶ï¼Œå’Œç¦»çº¿çš„æ–‡æ¡£ã€‚ gradle-xx-bin.zipæ˜¯äºŒè¿›åˆ¶ç‰ˆï¼ŒåªåŒ…å«äº†äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå¯æ‰§è¡Œæ–‡ä»¶ï¼‰ï¼Œæ²¡æœ‰æ–‡æ¡£å’Œæºä»£ç ã€‚ gradle-xx-src.zipæ˜¯æºç ç‰ˆï¼ŒåªåŒ…å«äº†Gradleæºä»£ç ï¼Œä¸èƒ½ç”¨æ¥ç¼–è¯‘ä½ çš„å·¥ç¨‹ã€‚ zipStoreBaseå’ŒzipStorePathç»„åˆåœ¨ä¸€èµ·ï¼Œæ˜¯ä¸‹è½½çš„gradle-3.1-bin.zipæ‰€å­˜æ”¾çš„ä½ç½®ã€‚ zipStorePathæ˜¯zipStoreBaseæŒ‡å®šçš„ç›®å½•ä¸‹çš„å­ç›®å½•ã€‚ distributionBaseå’ŒdistributionPathç»„åˆåœ¨ä¸€èµ·ï¼Œæ˜¯è§£å‹gradle-5.6.4-bin.zipä¹‹åçš„æ–‡ä»¶çš„å­˜æ”¾ä½ç½®ã€‚ distributionPathæ˜¯distributionBaseæŒ‡å®šçš„ç›®å½•ä¸‹çš„å­ç›®å½•ã€‚ ä¸‹è½½ä½ç½®å¯ä»¥å’Œè§£å‹ä½ç½®ä¸ä¸€æ ·ã€‚ zipStoreBaseå’ŒdistributionBaseæœ‰ä¸¤ç§å–å€¼ï¼šGRADLE_USER_HOMEå’ŒPROJECTã€‚ å…¶ä¸­ï¼ŒGRADLE_USER_HOMEè¡¨ç¤ºç”¨æˆ·ç›®å½•ã€‚ åœ¨windowsä¸‹æ˜¯%USERPROFILE%/.gradleï¼Œä¾‹å¦‚C:\\Users&lt;user_name&gt;.gradle\\ã€‚ åœ¨linuxä¸‹æ˜¯$HOME/.gradleï¼Œä¾‹å¦‚~/.gradleã€‚ PROJECTè¡¨ç¤ºå·¥ç¨‹çš„å½“å‰ç›®å½•ï¼Œå³gradlewæ‰€åœ¨çš„ç›®å½•ã€‚ å…« ä¾èµ–åˆ†ç»„ Gradle ä¾èµ–æ˜¯åˆ†ç»„çš„ ,åˆ†ç»„æ˜¯åœ¨ org.gradle.api.Project ä¸­çš„ configurations ä¸­é…ç½®çš„ ,å¦‚ &quot; implementation &quot; , &quot; compile &quot; ç­‰éƒ½æ˜¯åˆ†ç»„ , è¿™äº›åˆ†ç»„éƒ½æ˜¯åœ¨ org.gradle.api.Project#configurations ä¸­è¿›è¡Œé…ç½® , ä¹Ÿå°±æ˜¯ build.gradle#configurations ä¸­é…ç½® ; build.gradle#configurations è‡ªå®šä¹‰ä¾èµ–åˆ†ç»„ åœ¨ build.gradle ä¸­é…ç½® configurations : configurations { hello { } } åˆ™å¯ä»¥åœ¨ dependencies ä¸­ä½¿ä¸Šè¿°åœ¨ configurations é…ç½®çš„ä¾èµ–åˆ†ç»„ hello , dependencies { hello 'com.android.support:appcompat-v7:28.0.0' } ä¹ ä¾èµ–ç‰ˆæœ¬å†²çª Gradleå¯¹è§£å†³ä¼ é€’ä¾èµ–æä¾›äº†ä¸¤ç§ç­–ç•¥ï¼Œä½¿ç”¨æœ€æ–°ç‰ˆæœ¬æˆ–è€…ç›´æ¥å¯¼è‡´æ„å»ºå¤±è´¥ã€‚é»˜è®¤çš„ç­–ç•¥æ˜¯ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ã€‚è™½ç„¶è¿™æ ·çš„ç­–ç•¥èƒ½å¤Ÿè§£å†³ä¸€äº›é—®é¢˜ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸å¤Ÿã€‚å¸¸è§çš„ä¸€ç§æƒ…å†µæ˜¯ï¼ŒNoSuchMethondæˆ–è€…ClassNotFoundã€‚è¿™æ—¶å€™ï¼Œä½ å¯èƒ½éœ€è¦ä¸€äº›ç‰¹æ®Šæ‰‹æ®µï¼Œæ¯”å¦‚æ’é™¤ä¸æƒ³è¦çš„ä¼ é€’ä¾èµ–ã€‚ æ’é™¤ä¼ é€’ä¾èµ–çš„æ–¹å¼æœ‰ä¸¤ç§ï¼š 1.ä½¿ç”¨transitive = falseæ’é™¤ 2.åœ¨å…·ä½“çš„æŸä¸ªdependencyä¸­ä½¿ç”¨excludeæ’é™¤ 3.ä½¿ç”¨forceå¼ºåˆ¶ä¾èµ–æŸä¸ªç‰ˆæœ¬ (1) æ–¹æ¡ˆä¸€ï¼šé’ˆå¯¹ A æˆ– D é…ç½® transitiveã€‚ è¿™é‡Œé’ˆå¯¹Aé…ç½®ï¼Œä¸è§£æAæ¨¡å—çš„ä¼ é€’ä¾èµ–ï¼Œå› æ­¤å½“å‰Moduleçš„ä¾èµ–å…³ç³»æ ‘ä¸­ä¸å†åŒ…å« B1 å’Œ Cï¼Œè¿™é‡Œéœ€è¦æ‰‹åŠ¨æ·»åŠ ä¾èµ– C dependencies { implementation A { transitive = false } implementation C implementation D { //transitive = false } } (2) æ–¹æ¡ˆäºŒï¼šé’ˆå¯¹ A æˆ– D é…ç½® excludeè§„åˆ™ï¼Œæ­¤å¤„é’ˆå¯¹Aé…ç½®ï¼Œä¾èµ–å…³ç³»æ ‘ä¸­ä¸å†åŒ…å«B1 dependencies { implementation A { exclude B1 } implementation D { //exclude B2 } } (3) æ–¹æ¡ˆä¸‰ï¼šä½¿ç”¨forceå¼ºåˆ¶ä¾èµ–æŸä¸ªç‰ˆæœ¬ï¼Œå¦‚å¼ºåˆ¶ä¾èµ– B1 æˆ–è€… B2 ä»¥ä¸‹æ˜¯åœ¨é¡¶å±‚build.gradleä¸­é…ç½®ï¼Œå¼ºåˆ¶æ‰€æœ‰moduleä¾èµ–B1 configurations.all { resolutionStrategy { force B1 // force B2 } } å springcloud-gradleç®¡ç† parent:settings.gradle rootProject.name = 'nacos' include 'sentinel' include 'openfeign' include 'loadbalancer' include 'gateway' include 'rocketmq' include 'sleuth' include 'seata' include 'provide' parent:build.gradle buildscript { ext { //spring-cloud-dependencies 2020.0.0 é»˜è®¤ä¸åœ¨åŠ è½½bootstrap é…ç½®æ–‡ä»¶ï¼Œ //å¦‚æœé¡¹ç›®ä¸­è¦ç”¨bootstrap é…ç½®æ–‡ä»¶ éœ€è¦æ‰‹åŠ¨æ·»åŠ spring-cloud-starter-bootstrap ä¾èµ–ï¼Œä¸ç„¶å¯åŠ¨é¡¹ç›®ä¼šæŠ¥é”™çš„ã€‚ set('springCloudVersion', &quot;2021.0.3&quot;) //å®šä¹‰ä¸€ä¸ªå˜é‡ï¼Œç»Ÿä¸€è§„å®šspringbootçš„ç‰ˆæœ¬ set('springBootVersion', &quot;2.6.8&quot;) set('alibabaVersion', &quot;2.2.7.RELEASE&quot;) set('lombok', &quot;1.18.16&quot;) set('knife4j', &quot;2.0.9&quot;) set('hutool', &quot;4.6.3&quot;) set('rocketmq', &quot;2.2.2&quot;) } repositories { mavenLocal() maven { url 'https://maven.aliyun.com/repository/central' } maven { url 'https://maven.aliyun.com/repository/public' } mavenCentral() } dependencies { //ç”¨æ¥æ‰“åŒ… classpath(&quot;org.springframework.boot:spring-boot-gradle-plugin:${springBootVersion}&quot;) } } allprojects { apply plugin: 'java-library' apply plugin: 'idea' //ä¸‹é¢ä¸¤å¥å¿…é¡»åœ¨æ‰€æœ‰å­é¡¹ç›®ä¸­æ·»åŠ ï¼Œå¦åˆ™å¯¼è‡´importäº†çœ‹èµ·æ¥æ²¡é—®é¢˜ï¼Œä½†æ˜¯ç¼–è¯‘æ—¶æ‰¾ä¸åˆ°å…¶ä»–æ¨¡å—çš„ç±»ã€‚ group = 'com.example' version = '0.0.1-SNAPSHOT' // æŒ‡å®šJDKç‰ˆæœ¬ sourceCompatibility = 1.8 targetCompatibility = 1.8 repositories { mavenLocal() maven { url 'https://maven.aliyun.com/repository/central' } maven { url 'https://maven.aliyun.com/repository/public' } mavenCentral() } //æŒ‡å®šç¼–ç æ ¼å¼ tasks.withType(JavaCompile) { options.encoding = &quot;UTF-8&quot; } } subprojects { apply plugin: 'java-library' apply plugin: 'idea' apply plugin: 'org.springframework.boot' //dependency-management æ’ä»¶ apply plugin: 'io.spring.dependency-management' dependencies { implementation(enforcedPlatform(&quot;org.springframework.cloud:spring-cloud-dependencies:${springCloudVersion}&quot;)) implementation(enforcedPlatform(&quot;com.alibaba.cloud:spring-cloud-alibaba-dependencies:${alibabaVersion}&quot;)) implementation(enforcedPlatform(&quot;org.springframework.boot:spring-boot-dependencies:${springBootVersion}&quot;)) implementation &quot;com.github.xiaoymin:knife4j-spring-boot-starter:${knife4j}&quot; implementation &quot;cn.hutool:hutool-all:${hutool}&quot; implementation 'org.springframework.boot:spring-boot-starter' implementation 'com.alibaba.cloud:spring-cloud-starter-alibaba-nacos-config' implementation('com.alibaba.cloud:spring-cloud-starter-alibaba-nacos-discovery'){ exclude group: 'org.springframework.cloud', module: 'spring-cloud-starter-netflix-ribbon' } implementation 'org.springframework.cloud:spring-cloud-starter-bootstrap' compileOnly(&quot;org.projectlombok:lombok:${lombok}&quot;) annotationProcessor 'org.springframework.boot:spring-boot-configuration-processor' annotationProcessor(&quot;org.projectlombok:lombok:${lombok}&quot;) testImplementation(&quot;org.springframework.boot:spring-boot-starter-test:${springBootVersion}&quot;) } jar { manifest.attributes provider: 'gradle' } } gateway:build.gradle dependencies { implementation &quot;org.springframework.cloud:spring-cloud-starter-gateway&quot; implementation &quot;org.springframework.cloud:spring-cloud-starter-loadbalancer&quot; } openfeign:build.gradle dependencies { implementation 'org.springframework.boot:spring-boot-starter-web' implementation &quot;org.springframework.cloud:spring-cloud-starter-openfeign&quot; implementation &quot;org.springframework.cloud:spring-cloud-starter-loadbalancer&quot; } rocketmq:build.gradle dependencies { implementation 'org.springframework.boot:spring-boot-starter-web' implementation &quot;org.apache.rocketmq:rocketmq-spring-boot-starter:${rocketmq}&quot; } sentinel:build.gradle dependencies { implementation 'org.springframework.boot:spring-boot-starter-web' implementation 'com.alibaba.cloud:spring-cloud-starter-alibaba-sentinel' implementation 'org.springframework.boot:spring-boot-starter-actuator' } é¡¹ç›®æ„å»º--Gradle--Dockeræ‰“åŒ… åœ¨build.gradleä¸­å¼•å…¥æ’ä»¶ã€‚ id &quot;com.google.cloud.tools.jib&quot; version &quot;3.2.1&quot; é…ç½® é…ç½®æ‰“åŒ…æ—¶çš„åŸºç¡€é•œåƒã€å®¹å™¨é…ç½®ã€ç§æœåœ°å€ç­‰ï¼Œå’ŒMaven æ’ä»¶ä¸­çš„ä¸€æ ·ï¼Œåªæ˜¯é‡‡ç”¨é—­åŒ…çš„ä¹¦å†™æ–¹å¼ã€‚ Jib å®˜ç½‘æ–‡æ¡£ jib { // åŸºç¡€é•œåƒï¼Œæ¥è‡ªdockerhub,å¦‚æœæ˜¯ç§æœï¼Œéœ€è¦åŠ ä¸Šé‰´æƒä¿¡æ¯ï¼Œå’Œtoä¸‹çš„authèŠ‚ç‚¹ç›¸åŒ // https://hub.docker.com/ from { image = 'xx' } // æ„å»ºåçš„é•œåƒåç§°ä»¥åŠç§æœåœ°å€ã€é‰´æƒä¿¡æ¯ to { image = 'xx' auth { username = 'ç™»å½•è´¦å·' password = 'ç™»å½•å¯†ç ' } } // å®¹å™¨ç›¸å…³è®¾ç½® container { // åˆ›å»ºæ—¶é—´ creationTime = new Date() // JVM å¯åŠ¨å‚æ•° jvmFlags = ['-Djava.security.egd=file:/dev/./urandom', '-Dspring.profiles.active=prod', '-Dfile.encoding=utf-8', '-Duser.timezone=GMT+08'] // å¯åŠ¨ç±» // mainClass = 'com.xxx.RunApplication' // å®¹å™¨åœ¨è¿è¡Œæ—¶å…¬å¼€çš„ç«¯å£ ports = ['8080'] // æ”¾ç½®åº”ç”¨ç¨‹åºå†…å®¹çš„å®¹å™¨ä¸Šçš„æ ¹ç›®å½• appRoot = '/deploy/service' } } ä½¿ç”¨IdeaDockeræ’ä»¶å¸ƒç½² Ideaå®‰è£…æ’ä»¶ å®‰è£…dockeræ’ä»¶ é…ç½®dockerï¼š é…ç½®Dockerfileæ–‡ä»¶ 1ï¼‰æ–°å»ºDockerfileæ–‡ä»¶ä¼šè‡ªåŠ¨å¼¹å‡ºã€‚ åœ¨å·¥ç¨‹æ ¹ç›®å½•ä¸‹æ–°å»ºDockerfileæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š FROM openjdk:8 COPY build/libs/iot-eruake-1.0.0.jar app.jar RUN bash -c &quot;touch /app.jar&quot; EXPOSE 8080 ENTRYPOINT [&quot;java&quot;,&quot;-jar&quot;,&quot;app.jar&quot;] åˆ›å»ºdockeré•œåƒ å‘å¸ƒå®Œæˆ ","link":"https://tianxiawuhao.github.io/29jyrX-eN/"},{"title":"IdWorkeré›ªèŠ±ç®—æ³•","content":"package com.ihrm.common.utils; import java.lang.management.ManagementFactory; import java.net.InetAddress; import java.net.NetworkInterface; //é›ªèŠ±ç®—æ³•ä»£ç å®ç° public class IdWorker { // æ—¶é—´èµ·å§‹æ ‡è®°ç‚¹ï¼Œä½œä¸ºåŸºå‡†ï¼Œä¸€èˆ¬å–ç³»ç»Ÿçš„æœ€è¿‘æ—¶é—´ï¼ˆä¸€æ—¦ç¡®å®šä¸èƒ½å˜åŠ¨ï¼‰ private final static long twepoch = 1288834974657L; // æœºå™¨æ ‡è¯†ä½æ•° private final static long workerIdBits = 5L; // æ•°æ®ä¸­å¿ƒæ ‡è¯†ä½æ•° private final static long datacenterIdBits = 5L; // æœºå™¨IDæœ€å¤§å€¼ private final static long maxWorkerId = -1L ^ (-1L &lt;&lt; workerIdBits); // æ•°æ®ä¸­å¿ƒIDæœ€å¤§å€¼ private final static long maxDatacenterId = -1L ^ (-1L &lt;&lt; datacenterIdBits); // æ¯«ç§’å†…è‡ªå¢ä½ private final static long sequenceBits = 12L; // æœºå™¨IDåå·¦ç§»12ä½ private final static long workerIdShift = sequenceBits; // æ•°æ®ä¸­å¿ƒIDå·¦ç§»17ä½ private final static long datacenterIdShift = sequenceBits + workerIdBits; // æ—¶é—´æ¯«ç§’å·¦ç§»22ä½ private final static long timestampLeftShift = sequenceBits + workerIdBits + datacenterIdBits; //æ¯«ç§’å†…è‡ªå¢æœ€å¤§å€¼ private final static long sequenceMask = -1L ^ (-1L &lt;&lt; sequenceBits); /* ä¸Šæ¬¡ç”Ÿäº§idæ—¶é—´æˆ³ */ private static long lastTimestamp = -1L; // 0ï¼Œå¹¶å‘æ§åˆ¶ private long sequence = 0L; private final long workerId; // æ•°æ®æ ‡è¯†idéƒ¨åˆ† private final long datacenterId; public IdWorker() { this.datacenterId = getDatacenterId(maxDatacenterId); this.workerId = getMaxWorkerId(datacenterId, maxWorkerId); } /** * @param workerId å·¥ä½œæœºå™¨ID * @param datacenterId åºåˆ—å· */ public IdWorker(long workerId, long datacenterId) { if (workerId &gt; maxWorkerId || workerId &lt; 0) { throw new IllegalArgumentException(String.format(&quot;worker Id can't be greater than % d or less than 0&quot;, maxWorkerId)); } if (datacenterId &gt; maxDatacenterId || datacenterId &lt; 0) { throw new IllegalArgumentException(String.format(&quot;datacenter Id can't be greater than % d or less than 0&quot;, maxDatacenterId)); } this.workerId = workerId; this.datacenterId = datacenterId; } /** * è·å–ä¸‹ä¸€ä¸ªID * * @return */ public synchronized long nextId() { long timestamp = timeGen(); if (timestamp &lt; lastTimestamp) { throw new RuntimeException(String.format(&quot;Clock moved backwards. Refusing to generate id for %d milliseconds &quot;, lastTimestamp - timestamp)); } if (lastTimestamp == timestamp) { // å½“å‰æ¯«ç§’å†…ï¼Œåˆ™+1 sequence = (sequence + 1) &amp; sequenceMask; if (sequence == 0) { // å½“å‰æ¯«ç§’å†…è®¡æ•°æ»¡äº†ï¼Œåˆ™ç­‰å¾…ä¸‹ä¸€ç§’ timestamp = tilNextMillis(lastTimestamp); } } else { sequence = 0L; } lastTimestamp = timestamp; // IDåç§»ç»„åˆç”Ÿæˆæœ€ç»ˆçš„IDï¼Œå¹¶è¿”å›ID long nextId = ((timestamp - twepoch) &lt;&lt; timestampLeftShift) | (datacenterId &lt;&lt; datacenterIdShift) | (workerId &lt;&lt; workerIdShift) | sequence; return nextId; } private long tilNextMillis(final long lastTimestamp) { long timestamp = this.timeGen(); while (timestamp &lt;= lastTimestamp) { timestamp = this.timeGen(); } return timestamp; } private long timeGen() { return System.currentTimeMillis(); } /** * &lt;p&gt; * è·å– maxWorkerId * &lt;/p&gt; */ protected static long getMaxWorkerId(long datacenterId, long maxWorkerId) { StringBuffer mpid = new StringBuffer(); mpid.append(datacenterId); String name = ManagementFactory.getRuntimeMXBean().getName(); if (!name.isEmpty()) { /* * GET jvmPid */ mpid.append(name.split(&quot;@&quot;)[0]); } /* * MAC + PID çš„ hashcode è·å–16ä¸ªä½ä½ */ return (mpid.toString().hashCode() &amp; 0xffff) % (maxWorkerId + 1); } /** * &lt;p&gt; * æ•°æ®æ ‡è¯†idéƒ¨åˆ† * &lt;/p&gt; */ protected static long getDatacenterId(long maxDatacenterId) { long id = 0L; try { InetAddress ip = InetAddress.getLocalHost(); NetworkInterface network = NetworkInterface.getByInetAddress(ip); if (network == null) { id = 1L; } else { byte[] mac = network.getHardwareAddress(); id = ((0x000000FF &amp; (long) mac[mac.length - 1]) | (0x0000FF00 &amp; (((long) mac[mac.length - 2]) &lt;&lt; 8))) &gt;&gt; 6; id = id % (maxDatacenterId + 1); } } catch (Exception e) { System.out.println(&quot; getDatacenterId: &quot; + e.getMessage()); } return id; } } ","link":"https://tianxiawuhao.github.io/4WluurBt3/"},{"title":"RestTemplate","content":"springç¯å¢ƒä¸‹ é¦–å…ˆå¯¼å…¥springboot çš„ web åŒ… &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; åœ¨å¯åŠ¨ç±»åŒåŒ…ä¸‹åˆ›å»ºRestTemplate.javaç±» import org.apache.http.client.HttpClient; import org.apache.http.client.config.RequestConfig; import org.apache.http.impl.client.DefaultHttpRequestRetryHandler; import org.apache.http.impl.client.HttpClientBuilder; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import org.springframework.http.client.ClientHttpRequestFactory; import org.springframework.http.client.HttpComponentsClientHttpRequestFactory; import org.springframework.web.client.RestTemplate; @Configuration public class RestTempleConfig { @Bean public RestTemplate restTemplate() { //ç”Ÿæˆä¸€ä¸ªè®¾ç½®äº†è¿æ¥è¶…æ—¶æ—¶é—´ã€è¯·æ±‚è¶…æ—¶æ—¶é—´ RequestConfig config = RequestConfig.custom() .setConnectionRequestTimeout(10000) .setConnectTimeout(10000) .setSocketTimeout(30000).build(); // è®¾ç½®å¼‚å¸¸é‡è¯• HttpClientBuilder builder = HttpClientBuilder.create() .setDefaultRequestConfig(config) .setRetryHandler(new DefaultHttpRequestRetryHandler(3, false)); HttpClient httpClient = builder.build(); ClientHttpRequestFactory requestFactory = new HttpComponentsClientHttpRequestFactory(httpClient); RestTemplate restTemplate = new RestTemplate(requestFactory); // æ—¥å¿—æ‹¦æˆª //restTemplate.setInterceptors(Collections.singletonList(new RestTemplateConsumerLogger())); return restTemplate; } } éspringç¯å¢ƒä¸‹ å¯¼å…¥ç›¸å…³ä¾èµ–åŒ…(æ³¨æ„ç‰ˆæœ¬ç›¸é€‚åº”) &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-web&lt;/artifactId&gt; &lt;version&gt;5.2.16.RELEASE&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.httpcomponents&lt;/groupId&gt; &lt;artifactId&gt;httpclient&lt;/artifactId&gt; &lt;version&gt;4.5.2&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-core&lt;/artifactId&gt; &lt;version&gt;2.12.1&lt;/version&gt; &lt;scope&gt;compile&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt; &lt;version&gt;2.12.1&lt;/version&gt; &lt;scope&gt;compile&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-annotations&lt;/artifactId&gt; &lt;version&gt;2.12.1&lt;/version&gt; &lt;scope&gt;compile&lt;/scope&gt; &lt;/dependency&gt; RestTemplate RestTemplateå®šä¹‰äº†36ä¸ªä¸RESTèµ„æºäº¤äº’çš„æ–¹æ³•ï¼Œå¤§å¤šæ•°éƒ½å¯¹åº”äºHTTPçš„æ–¹æ³•ã€‚ å…¶ä¸­åªæœ‰11ä¸ªç‹¬ç«‹çš„æ–¹æ³•ï¼Œå…¶ä¸­æœ‰åä¸ªæœ‰ä¸‰ç§é‡è½½å½¢å¼ï¼Œè€Œç¬¬åä¸€ä¸ªåˆ™é‡è½½äº†å…­æ¬¡ï¼Œè¿™æ ·ä¸€å…±å½¢æˆäº†36ä¸ªæ–¹æ³•ã€‚ getForEntity() å‘é€ä¸€ä¸ªHTTP GETè¯·æ±‚ï¼Œè¿”å›çš„ResponseEntityåŒ…å«äº†å“åº”ä½“æ‰€æ˜ å°„æˆçš„å¯¹è±¡ getForObject() å‘é€ä¸€ä¸ªHTTP GETè¯·æ±‚ï¼Œè¿”å›çš„è¯·æ±‚ä½“å°†æ˜ å°„ä¸ºä¸€ä¸ªå¯¹è±¡ postForEntity() POST æ•°æ®åˆ°ä¸€ä¸ªURLï¼Œè¿”å›åŒ…å«ä¸€ä¸ªå¯¹è±¡çš„ResponseEntityï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯ä»å“åº”ä½“ä¸­æ˜ å°„å¾—åˆ°çš„ postForObject() POST æ•°æ®åˆ°ä¸€ä¸ªURLï¼Œè¿”å›æ ¹æ®å“åº”ä½“åŒ¹é…å½¢æˆçš„å¯¹è±¡ exchange() åœ¨URLä¸Šæ‰§è¡Œç‰¹å®šçš„HTTPæ–¹æ³•ï¼Œè¿”å›åŒ…å«å¯¹è±¡çš„ResponseEntityï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯ä»å“åº”ä½“ä¸­æ˜ å°„å¾—åˆ°çš„ execute() åœ¨URLä¸Šæ‰§è¡Œç‰¹å®šçš„HTTPæ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªä»å“åº”ä½“æ˜ å°„å¾—åˆ°çš„å¯¹è±¡ delete() åœ¨ç‰¹å®šçš„URLä¸Šå¯¹èµ„æºæ‰§è¡ŒHTTP DELETEæ“ä½œ headForHeaders() å‘é€HTTP HEADè¯·æ±‚ï¼Œè¿”å›åŒ…å«ç‰¹å®šèµ„æºURLçš„HTTPå¤´ optionsForAllow() å‘é€HTTP OPTIONSè¯·æ±‚ï¼Œè¿”å›å¯¹ç‰¹å®šURLçš„Allowå¤´ä¿¡æ¯ postForLocation() POST æ•°æ®åˆ°ä¸€ä¸ªURLï¼Œè¿”å›æ–°åˆ›å»ºèµ„æºçš„URL put() PUT èµ„æºåˆ°ç‰¹å®šçš„URL getForEntity getè¯·æ±‚å°±å’Œæ­£å¸¸åœ¨æµè§ˆå™¨urlä¸Šå‘é€è¯·æ±‚ä¸€æ · RestTemplate restTemplate = new RestTemplate(); ResponseEntity&lt;String&gt; responseEntity=restTemplate.getForEntity(url+&quot;?name={1}&quot;, String.class, &quot;username&quot;); String body = responseEntity.getBody(); RestTemplate restTemplate = new RestTemplate(); ResponseEntity&lt;TokenBeen&gt; responseEntity =restTemplate.getForEntity(url+&quot;?name={1}&quot;, TokenBeen.class, &quot;username&quot;); if(responseEntity!=null){ TokenBeen body = responseEntity.getBody(); } #æ³¨æ„mapçš„keyè¦å’Œå‚æ•°ä¸­å ä½ç¬¦ç›¸åŒ RestTemplate restTemplate = new RestTemplate(); Map&lt;String, String&gt; params = new HashMap&lt;&gt;(); params.put(&quot;name&quot;, &quot;username&quot;); ResponseEntity&lt;String&gt; responseEntity = restTemplate.getForEntity(url+&quot;?name={name}&quot;, String.class, params); String body = responseEntity.getBody(); RestTemplate restTemplate = new RestTemplate(); UriComponents uriConponents = UriComponentsBuilder.fromUriString(url+&quot;?name={name}&quot;).build().expand(&quot;username&quot;).encode(); URI uri = uriConponents.toUri(); ResponseEntity&lt;String&gt; responseEntity = restTemplate.getForEntity(uri, String.class); String body = responseEntity.getBody(); @GetMapping(&quot;getForEntity/{id}&quot;) public User getById(@PathVariable(name = &quot;id&quot;) String id) { ResponseEntity&lt;User&gt; response = restTemplate.getForEntity(&quot;http://localhost/get/{id}&quot;, User.class, id); User user = response.getBody(); return user; } getForObject getForObject å’Œ getForEntity ç”¨æ³•å‡ ä¹ç›¸åŒ,getForObjectå‡½æ•°å¯ä»¥çœ‹ä½œæ˜¯å¯¹getForEntityè¿›ä¸€æ­¥å°è£…,æŒ‡ç¤ºè¿”å›å€¼è¿”å›çš„æ˜¯å“åº”ä½“,çœå»äº†æˆ‘ä»¬ å†å» getBody() RestTemplate restTemplate = new RestTemplate(); //æ³¨æ„å‚æ•°ä¸­æ˜¯uri UriComponents uriConponents = UriComponentsBuilder.fromUriString(url+&quot;?name={name}&quot;).build().expand(&quot;username&quot;).encode(); URI uri = uriConponents.toUri(); String body = restTemplate.getForObject(uri, String.class); RestTemplate restTemplate = new RestTemplate(); //æ³¨æ„å‚æ•°ä¸­æ˜¯uri UriComponents uriConponents = UriComponentsBuilder.fromUriString(url+&quot;?name={name}&quot;).build().expand(&quot;username&quot;).encode(); URI uri = uriConponents.toUri(); TokenBeen body = restTemplate.getForObject(uri, TokenBeen.class); @GetMapping(&quot;getForObject/{id}&quot;) public User getById(@PathVariable(name = &quot;id&quot;) String id) { User user = restTemplate.getForObject(&quot;http://localhost/get/{id}&quot;, User.class, id); return user; } postForEntity public &lt;T&gt; T postForObject(String url, @Nullable Object request, Class&lt;T&gt; responseType, Object... uriVariables)throws RestClientException {} public &lt;T&gt; T postForObject(String url, @Nullable Object request, Class&lt;T&gt; responseType, Map&lt;String, ?&gt; uriVariables) throws RestClientException {} public &lt;T&gt; T postForObject(URI url, @Nullable Object request, Class&lt;T&gt; responseType) throws RestClientException {} RestTemplate restTemplate = new RestTemplate(); HttpHeaders headers = new HttpHeaders(); //headerå‚æ•° MediaType type = MediaType.parseMediaType(&quot;application/json; charset=UTF-8&quot;); headers.setContentType(type); headers.add(&quot;Accept&quot;, MediaType.APPLICATION_JSON.toString()); //bodyå‚æ•° JSONObject param = new JSONObject(); param.put(&quot;username&quot;, &quot;123&quot;); HttpEntity&lt;JSONObject&gt; formEntity = new HttpEntity&lt;&gt;(param, headers); //å‘é€è¯·æ±‚ String result = restTemplate.postForObject(url, formEntity, String.class); @RequestMapping(&quot;saveUser&quot;) public String save(User user) { ResponseEntity&lt;String&gt; response = restTemplate.postForEntity(&quot;http://localhost/save&quot;, user, String.class); String body = response.getBody(); return body; } postForObject ç”¨æ³•ä¸ getForObject ä¸€æ · @RequestMapping(&quot;saveUser&quot;) public String save(User user) { String body = restTemplate.postForObject(&quot;http://localhost/save&quot;, user, String.class); return body; } exchange @PostMapping(&quot;demo&quot;) public void demo(Integer id, String name){ HttpHeaders headers = new HttpHeaders();//headerå‚æ•° headers.add(&quot;authorization&quot;,Auth); headers.setContentType(MediaType.APPLICATION_JSON); JSONObject content = new JSONObject();//æ”¾å…¥bodyä¸­çš„jsonå‚æ•° content.put(&quot;userId&quot;, id); content.put(&quot;name&quot;, name); //postå‘é€ HttpEntity&lt;JSONObject&gt; request = new HttpEntity&lt;&gt;(content,headers); //ç»„è£… ResponseEntity&lt;String&gt; response = template.exchange(&quot;http://localhost:8080/demo&quot;,HttpMethod.POST,request,String.class); //è¿”å›æŒ‡å®šå¯¹è±¡ ParameterizedTypeReference&lt;User&gt; responseBodyType = new ParameterizedTypeReference&lt;RestBean&lt;String&gt;&gt;() {}; User user = template.exchange(&quot;http://localhost:8080/demo&quot;,HttpMethod.POST,request,responseBodyType); //getå‘é€ HttpEntity&lt;String&gt; request = new HttpEntity&lt;&gt;(&quot;parameters&quot;,headers); //ç»„è£… ResponseEntity&lt;String&gt; response = template.exchange(&quot;http://localhost:8080/demo&quot;,HttpMethod.GET,request,String.class); //è¿”å›æŒ‡å®šå¯¹è±¡ ResponseEntity&lt;User&gt; response = template.exchange(&quot;http://localhost:8080/demo&quot;,HttpMethod.GET,request,User.class); } ","link":"https://tianxiawuhao.github.io/fFTlwaLS_/"},{"title":"SpringBoot  JWTå®ç°","content":"SpringBoot JWTå®ç° ï¼ˆåªæ˜¯å®ç°äº†jwt,æ²¡æœ‰ç”Ÿæˆè¯ä¹¦,å®‰å…¨æ€§å¾—ä¸åˆ°ä¿éšœ,è¯ä¹¦å®‰å…¨éªŒè¯æŸ¥çœ‹Spring security JWTï¼‰ &lt;dependency&gt; &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt; &lt;artifactId&gt;jjwt&lt;/artifactId&gt; &lt;version&gt;0.6.0&lt;/version&gt; &lt;/dependency&gt; import io.jsonwebtoken.JwtBuilder; import io.jsonwebtoken.Jwts; import io.jsonwebtoken.SignatureAlgorithm; import java.util.Date; public class CreateJwtTest3 { public static void main(String[] args) { //ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œæˆ‘ä»¬å°†è¿‡æœŸæ—¶é—´è®¾ç½®ä¸º1åˆ†é’Ÿ long now = System.currentTimeMillis();//å½“å‰æ—¶é—´ long exp = now + 1000 * 60;//è¿‡æœŸæ—¶é—´ä¸º1åˆ†é’Ÿ JwtBuilder builder = Jwts.builder().setId(&quot;888&quot;) .setSubject(&quot;å°ç™½&quot;) .setIssuedAt(new Date()) .signWith(SignatureAlgorithm.HS256, &quot;itcast&quot;) .setExpiration(new Date(exp)) .claim(&quot;roles&quot;, &quot;admin&quot;) //è‡ªå®šä¹‰claimså­˜å‚¨æ•°æ® .claim(&quot;logo&quot;, &quot;logo.png&quot;); System.out.println(builder.compact()); } } import io.jsonwebtoken.Claims; import io.jsonwebtoken.Jwts; import org.apache.commons.lang3.time.DateFormatUtils; import java.util.Date; public class ParseJwtTest { public static void main(String[] args) { String token = &quot;eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1NjExMDE3MzIsImV4cCI6MTU2MTEwMTc5MSwicm9sZXMiOiJhZG1pbiIsImxvZ28iOiJsb2dvLnBuZyJ9.5iVVdTw747L3ScHeCqle-bwj3cezK8NnE7VilQWOr8Y&quot;; Claims claims = Jwts.parser().setSigningKey(&quot;itcast&quot;).parseClaimsJws(token).getBody(); System.out.println(&quot;id:&quot; + claims.getId()); System.out.println(&quot;subject:&quot; + claims.getSubject()); System.out.println(&quot;roles:&quot; + claims.get(&quot;roles&quot;)); System.out.println(&quot;logo:&quot; + claims.get(&quot;logo&quot;)); System.out.println(&quot;ç­¾å‘æ—¶é—´:&quot;+ DateFormatUtils.format(claims.getIssuedAt(),&quot;yyyy-MM-dd hh:mm:ss&quot;)); System.out.println(&quot;è¿‡æœŸæ—¶é—´:&quot;+DateFormatUtils.format(claims.getExpiration(),&quot;yyyy-MM-dd hh:mm:ss&quot;)); System.out.println(&quot;å½“å‰æ—¶é—´:&quot;+DateFormatUtils.format(new Date(),&quot;yyyy-MM-dd hh:mm:ss&quot;)); } } ","link":"https://tianxiawuhao.github.io/ZsckGVdlz/"},{"title":"JWTä»‹ç»","content":"JWTä»‹ç» åœ¨ä»‹ç»JWTä¹‹å‰å…ˆçœ‹ä¸€ä¸‹ä¼ ç»Ÿæ ¡éªŒä»¤ç‰Œçš„æ–¹æ³•ï¼Œå¦‚ä¸‹å›¾ï¼š èµ„æºæœåŠ¡å™¨æˆæƒæµç¨‹å¦‚ä¸Šå›¾ï¼Œå®¢æˆ·ç«¯å…ˆå»æˆæƒæœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œï¼Œç”³è¯·ä»¤ç‰Œåï¼Œæºå¸¦ä»¤ç‰Œè®¿é—®èµ„æºæœåŠ¡å™¨ï¼Œèµ„æºæœåŠ¡å™¨è®¿é—®æˆæƒæœåŠ¡æ ¡éªŒä»¤ç‰Œçš„åˆæ³•æ€§ï¼ŒæˆæƒæœåŠ¡ä¼šè¿”å›æ ¡éªŒç»“æœï¼Œå¦‚æœæ ¡éªŒæˆåŠŸä¼šè¿”å›ç”¨æˆ·ä¿¡æ¯ç»™èµ„æºæœåŠ¡å™¨ï¼Œèµ„æºæœåŠ¡å™¨å¦‚æœæ¥æ”¶åˆ°çš„æ ¡éªŒç»“æœé€šè¿‡äº†ï¼Œåˆ™è¿”å›èµ„æºç»™å®¢æˆ·ç«¯ é—®é¢˜ï¼š ä¼ ç»Ÿæˆæƒæ–¹æ³•çš„é—®é¢˜æ˜¯ç”¨æˆ·æ¯æ¬¡è¯·æ±‚èµ„æºæœåŠ¡ï¼Œèµ„æºæœåŠ¡éƒ½éœ€è¦æºå¸¦ä»¤ç‰Œè®¿é—®è®¤è¯æœåŠ¡å»æ ¡éªŒä»¤ç‰Œçš„åˆæ³•æ€§ï¼Œå¹¶æ ¹æ®ä»¤ç‰Œè·å–ç”¨æˆ·çš„ç›¸å…³ä¿¡æ¯ï¼Œæ€§èƒ½ä½ä¸‹ã€‚ è§£å†³ï¼š ä½¿ç”¨JWTçš„æ€è·¯æ˜¯ï¼Œç”¨æˆ·è®¤è¯é€šè¿‡ä¼šå¾—åˆ°ä¸€ä¸ªJWTä»¤ç‰Œï¼ŒJWTä»¤ç‰Œä¸­å·²ç»åŒ…æ‹¬äº†ç”¨æˆ·ç›¸å…³çš„ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯åªéœ€è¦æºå¸¦JWTè®¿é—®èµ„æºæœåŠ¡ï¼Œèµ„æºæœåŠ¡æ ¹æ®äº‹å…ˆçº¦å®šçš„ç®—æ³•è‡ªè¡Œå®Œæˆä»¤ç‰Œæ ¡éªŒï¼Œæ— éœ€æ¯æ¬¡éƒ½è¯·æ±‚è®¤è¯æœåŠ¡å®Œæˆæˆæƒã€‚ JWTä»¤ç‰Œæˆæƒè¿‡ç¨‹å¦‚ä¸‹å›¾ï¼š ä»€ä¹ˆæ˜¯JWTï¼Ÿ JSON Web Tokenï¼ˆJWTï¼‰æ˜¯ä¸€ä¸ªå¼€æ”¾çš„è¡Œä¸šæ ‡å‡†ï¼ˆRFC 7519ï¼‰ï¼Œå®ƒå®šä¹‰äº†ä¸€ç§ç®€ä»‹çš„ã€è‡ªåŒ…å«çš„åè®®æ ¼å¼ï¼Œç”¨äºåœ¨é€šä¿¡åŒæ–¹ä¼ é€’jsonå¯¹è±¡ï¼Œä¼ é€’çš„ä¿¡æ¯ç»è¿‡æ•°å­—ç­¾åå¯ä»¥è¢«éªŒè¯å’Œä¿¡ä»»ã€‚JWTå¯ä»¥ä½¿ç”¨HMACç®—æ³•æˆ–ä½¿ç”¨RSAçš„å…¬é’¥/ç§é’¥å¯¹æ¥ç­¾åï¼Œé˜²æ­¢è¢«ç¯¡æ”¹ã€‚ å®˜ç½‘ï¼šhttps://jwt.io/ æ ‡å‡†ï¼šhttps://tools.ietf.org/html/rfc7519 ä¼˜ç‚¹ï¼š jwtåŸºäºjsonï¼Œéå¸¸æ–¹ä¾¿è§£æã€‚ å¯ä»¥åœ¨ä»¤ç‰Œä¸­è‡ªå®šä¹‰ä¸°å¯Œçš„å†…å®¹ï¼Œæ˜“æ‰©å±•ã€‚ é€šè¿‡éå¯¹ç§°åŠ å¯†ç®—æ³•åŠæ•°å­—ç­¾åæŠ€æœ¯ï¼ŒJWTé˜²æ­¢ç¯¡æ”¹ï¼Œå®‰å…¨æ€§é«˜ã€‚ èµ„æºæœåŠ¡ä½¿ç”¨JWTå¯ä¸ä¾èµ–è®¤è¯æœåŠ¡å³å¯å®Œæˆæˆæƒã€‚ ç¼ºç‚¹ï¼š JWTä»¤ç‰Œè¾ƒé•¿ï¼Œå å­˜å‚¨ç©ºé—´æ¯”è¾ƒå¤§ã€‚ ä»¤ç‰Œç»“æ„ é€šè¿‡å­¦ä¹ JWTä»¤ç‰Œç»“æ„ä¸ºè‡ªå®šä¹‰jwtä»¤ç‰Œæ‰“å¥½åŸºç¡€ã€‚ JWTä»¤ç‰Œç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œæ¯éƒ¨åˆ†ä¸­é—´ä½¿ç”¨ç‚¹ï¼ˆ.ï¼‰åˆ†éš”ï¼Œæ¯”å¦‚ï¼šxxxxx.yyyyy.zzzzz Header å¤´éƒ¨åŒ…æ‹¬ä»¤ç‰Œçš„ç±»å‹ï¼ˆå³JWTï¼‰åŠä½¿ç”¨çš„å“ˆå¸Œç®—æ³•ï¼ˆå¦‚HMAC SHA256æˆ–RSAï¼‰ ä¸€ä¸ªä¾‹å­å¦‚ä¸‹ï¼š ä¸‹è¾¹æ˜¯Headeréƒ¨åˆ†çš„å†…å®¹ { &quot;alg&quot;: &quot;HS256&quot;, &quot;typ&quot;: &quot;JWT&quot; } å°†ä¸Šè¾¹çš„å†…å®¹ä½¿ç”¨Base64Urlç¼–ç ï¼Œå¾—åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²å°±æ˜¯JWTä»¤ç‰Œçš„ç¬¬ä¸€éƒ¨åˆ†ã€‚ Payload ç¬¬äºŒéƒ¨åˆ†æ˜¯è´Ÿè½½ï¼Œå†…å®¹ä¹Ÿæ˜¯ä¸€ä¸ªjsonå¯¹è±¡ï¼Œå®ƒæ˜¯å­˜æ”¾æœ‰æ•ˆä¿¡æ¯çš„åœ°æ–¹ï¼Œå®ƒå¯ä»¥å­˜æ”¾jwtæä¾›çš„ç°æˆå­—æ®µï¼Œæ¯”å¦‚ï¼šissï¼ˆç­¾å‘è€…ï¼‰,expï¼ˆè¿‡æœŸæ—¶é—´æˆ³ï¼‰, subï¼ˆé¢å‘çš„ç”¨æˆ·ï¼‰ç­‰ï¼Œä¹Ÿå¯è‡ªå®šä¹‰å­—æ®µã€‚ æ­¤éƒ¨åˆ†ä¸å»ºè®®å­˜æ”¾æ•æ„Ÿä¿¡æ¯ï¼Œå› ä¸ºæ­¤éƒ¨åˆ†å¯ä»¥è§£ç è¿˜åŸåŸå§‹å†…å®¹ã€‚ æœ€åå°†ç¬¬äºŒéƒ¨åˆ†è´Ÿè½½ä½¿ç”¨Base64Urlç¼–ç ï¼Œå¾—åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²å°±æ˜¯JWTä»¤ç‰Œçš„ç¬¬äºŒéƒ¨åˆ†ã€‚ { &quot;sub&quot;: &quot;1234567890&quot;, &quot;name&quot;: &quot;456&quot;, &quot;admin&quot;: true } Signature ç¬¬ä¸‰éƒ¨åˆ†æ˜¯ç­¾åï¼Œæ­¤éƒ¨åˆ†ç”¨äºé˜²æ­¢jwtå†…å®¹è¢«ç¯¡æ”¹ã€‚è¿™ä¸ªéƒ¨åˆ†ä½¿ç”¨base64urlå°†å‰ä¸¤éƒ¨åˆ†è¿›è¡Œç¼–ç ï¼Œç¼–ç åä½¿ç”¨ç‚¹ï¼ˆ.ï¼‰è¿æ¥ç»„æˆå­—ç¬¦ä¸²ï¼Œæœ€åä½¿ç”¨headerä¸­å£°æ˜ç­¾åç®—æ³•è¿›è¡Œç­¾åã€‚ HMACSHA256(base64UrlEncode(header) + &quot;.&quot; +base64UrlEncode(payload),secret) base64UrlEncode(header)ï¼šjwtä»¤ç‰Œçš„ç¬¬ä¸€éƒ¨åˆ†ã€‚ base64UrlEncode(payload)ï¼šjwtä»¤ç‰Œçš„ç¬¬äºŒéƒ¨åˆ†ã€‚ secretï¼šç­¾åæ‰€ä½¿ç”¨çš„å¯†é’¥ã€‚ JWTå…¥é—¨ Spring Security æä¾›å¯¹JWTçš„æ”¯æŒï¼Œæœ¬èŠ‚æˆ‘ä»¬ä½¿ç”¨Spring Security æä¾›çš„JwtHelperæ¥åˆ›å»ºJWTä»¤ç‰Œï¼Œæ ¡éªŒJWTä»¤ç‰Œç­‰æ“ä½œã€‚ ç”Ÿæˆç§é’¥å’Œå…¬é’¥ JWTä»¤ç‰Œç”Ÿæˆé‡‡ç”¨éå¯¹ç§°åŠ å¯†ç®—æ³• ç”Ÿæˆå¯†é’¥è¯ä¹¦ ä¸‹è¾¹å‘½ä»¤ç”Ÿæˆå¯†é’¥è¯ä¹¦ï¼Œé‡‡ç”¨RSA ç®—æ³•æ¯ä¸ªè¯ä¹¦åŒ…å«å…¬é’¥å’Œç§é’¥ keytool -genkeypair -alias xckey -keyalg RSA -keypass xuecheng -keystore xc.keystore -storepass xuechengkeystore Keytool æ˜¯ä¸€ä¸ªjavaæä¾›çš„è¯ä¹¦ç®¡ç†å·¥å…· -aliasï¼šå¯†é’¥çš„åˆ«å -keyalgï¼šä½¿ç”¨çš„hashç®—æ³• -keypassï¼šå¯†é’¥çš„è®¿é—®å¯†ç  -keystoreï¼šå¯†é’¥åº“æ–‡ä»¶åï¼Œxc.keystoreä¿å­˜äº†ç”Ÿæˆçš„è¯ä¹¦ -storepassï¼šå¯†é’¥åº“çš„è®¿é—®å¯†ç  æŸ¥è¯¢è¯ä¹¦ä¿¡æ¯ keytool -list -keystore xc.keystore åˆ é™¤åˆ«å keytool -delete -alias xckey -keystore xc.keystore å¯¼å‡ºå…¬é’¥ opensslæ˜¯ä¸€ä¸ªåŠ è§£å¯†å·¥å…·åŒ…ï¼Œè¿™é‡Œä½¿ç”¨opensslæ¥å¯¼å‡ºå…¬é’¥ä¿¡æ¯ã€‚å®‰è£… opensslï¼šhttp://slproweb.com/products/Win32OpenSSL.html é…ç½®opensslçš„pathç¯å¢ƒå˜é‡ï¼Œæœ¬æ–‡é…ç½®åœ¨D:\\OpenSSL-Win64\\bin cmdè¿›å…¥xc.keystoreæ–‡ä»¶æ‰€åœ¨ç›®å½•æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š keytool â€list â€rfc â€â€keystore xc.keystore | openssl x509 â€inform pem â€pubkey è¾“å…¥å¯†é’¥åº“å¯†ç ï¼š ä¸‹è¾¹è¿™ä¸€æ®µå°±æ˜¯å…¬é’¥å†…å®¹ï¼š -----BEGIN PUBLIC KEY----- MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAijyxMdq4S6L1Af1rtB8SjCZHNgsQG8JTfGy55eYvzG0B/E4AudR2prSRBvF7NYPL47scRCNPgLnvbQczBHbBug6uOr78qnWsYxHlW6Aa5dI5NsmOD4DLtSw8eX0hFyK5Fj6ScYOSFBz9cd1nNTvx2+oIv0lJDcpQdQhsfgsEr1ntvWterZt/8r7xNN83gHYuZ6TM5MYvjQNBc5qC7Krs9wM7UoQuL+s0X6RlOib7/mcLn/lFLsLDdYQAZkSDx/6+t+1oHdMarChIPYT1sx9Dwj2j2mvFNDTKKKKAq0cv14Vrhz67Vjmz2yMJePDqUi0JYS2r0iIo7n8vN7s83v5uOQIDAQAB -----END PUBLIC KEY----- å°†ä¸Šè¾¹çš„å…¬é’¥æ‹·è´åˆ°æ–‡æœ¬æ–‡ä»¶ä¸­ï¼Œåˆå¹¶ä¸ºä¸€è¡Œã€‚ ç”Ÿæˆjwtä»¤ç‰Œ åœ¨è®¤è¯å·¥ç¨‹åˆ›å»ºæµ‹è¯•ç±»ï¼Œæµ‹è¯•jwtä»¤ç‰Œçš„ç”Ÿæˆä¸éªŒè¯ã€‚ @Test public void testCreateJwt(){ //è¯ä¹¦æ–‡ä»¶ String key_location = &quot;xc.keystore&quot;; //å¯†é’¥åº“å¯†ç  String keystore_password = &quot;xuechengkeystore&quot;; //è®¿é—®è¯ä¹¦è·¯å¾„ ClassPathResource resource = new ClassPathResource(key_location); //å¯†é’¥å·¥å‚ KeyStoreKeyFactory keyStoreKeyFactory = new KeyStoreKeyFactory(resource, keystore_password.toCharArray()); //å¯†é’¥çš„å¯†ç ï¼Œæ­¤å¯†ç å’Œåˆ«åè¦åŒ¹é… String keypassword = &quot;xuecheng&quot;; //å¯†é’¥åˆ«å String alias = &quot;xckey&quot;; //å¯†é’¥å¯¹ï¼ˆå¯†é’¥å’Œå…¬é’¥ï¼‰ KeyPair keyPair = keyStoreKeyFactory.getKeyPair(alias,keypassword.toCharArray()); //ç§é’¥ RSAPrivateKey aPrivate = (RSAPrivateKey) keyPair.getPrivate(); //å®šä¹‰payloadä¿¡æ¯ Map&lt;String, Object&gt; tokenMap = new HashMap&lt;&gt;(); tokenMap.put(&quot;id&quot;, &quot;123&quot;); tokenMap.put(&quot;name&quot;, &quot;mrt&quot;); tokenMap.put(&quot;roles&quot;, &quot;r01,r02&quot;); tokenMap.put(&quot;ext&quot;, &quot;1&quot;); //ç”Ÿæˆjwtä»¤ç‰Œ Jwt jwt = JwtHelper.encode(JSON.toJSONString(tokenMap), new RsaSigner(aPrivate)); //å–å‡ºjwtä»¤ç‰Œ String token = jwt.getEncoded(); System.out.println(&quot;token=&quot;+token); } //èµ„æºæœåŠ¡ä½¿ç”¨å…¬é’¥éªŒè¯jwtçš„åˆæ³•æ€§ï¼Œå¹¶å¯¹jwtè§£ç  éªŒè¯jwtä»¤ç‰Œ @Test public void testVerify(){ //jwtä»¤ç‰Œ String token =&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHQiOiIxIiwicm9sZXMiOiJyMDEscjAyIiwibmFtZSI6Im1ydCIsImlkIjoiMTIzIn0.KK7_67N5d1Dthd1PgDHMsbi0UlmjGRcm_XJUUwseJ2eZyJJWoPP2IcEZgAU3tUaaKEHUf9wSRwaDgwhrwfyIcSHbs8oy3zOQEL8j5AOjzBBs7vnRmB7DbSaQD7eJiQVJOXO1QpdmEFgjhc_IBCVTJCVWgZw60IEW1_Lg5tqaLvCiIl26K48pJB5fle2zgYMzqR1L2LyTFkq39rG57VOqqSCi3dapsZQd4ctq95SJCXgGdrUDWtD52rp5o6_0uqâ€mrbRdRxkrQfsa1j8C5IW2â€T4eUmiN3f9wF9JxUK1__XC1OQkOnâ€ZTBCdqwWIygDFbU7sf6KzfHJTm5vfjp6NIA&quot;; //å…¬é’¥ String publickey = &quot;â€â€â€â€â€BEGIN PUBLIC KEYâ€â€â€â€â€ MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAijyxMdq4S6L1Af1rtB8SjCZHNgsQG8JTfGy55eYvzG0B/E4AudR2prSRBvF7NYPL47scRCNPgLnvbQczBHbBug6uOr78qnWsYxHlW6Aa5dI5NsmOD4DLtSw8eX0hFyK5Fj6ScYOSFBz9cd1nNTvx2+oIv0lJDcpQdQhsfgsEr1ntvWterZt/8r7xNN83gHYuZ6TM5MYvjQNBc5qC7Krs9wM7UoQuL+s0X6RlOib7/mcLn/lFLsLDdYQAZkSDx/6+t+1oHdMarChIPYT1sx9Dwj2j2mvFNDTKKKKAq0cv14Vrhz67Vjmz2yMJePDqUi0JYS2r0iIo7n8vN7s83v5u OQIDAQAB â€â€â€â€â€END PUBLIC KEYâ€â€â€â€â€&quot;; //æ ¡éªŒjwt Jwt jwt = JwtHelper.decodeAndVerify(token, new RsaVerifier(publickey)); //è·å–jwtåŸå§‹å†…å®¹ String claims = jwt.getClaims(); //jwtä»¤ç‰Œ String encoded = jwt.getEncoded(); System.out.println(encoded); } ","link":"https://tianxiawuhao.github.io/wWtT_Oc9B/"},{"title":"zookeeperæ¦‚è¿°","content":"zookeeperæ˜¯ä»€ä¹ˆ Zookeeper åˆ†å¸ƒå¼æœåŠ¡æ¡†æ¶æ˜¯Apache Hadoop çš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œå®ƒä¸»è¦æ˜¯ç”¨æ¥è§£å†³åˆ†å¸ƒå¼åº”ç”¨ä¸­ç»å¸¸é‡åˆ°çš„ä¸€äº›æ•°æ®ç®¡ç†é—®é¢˜ï¼Œå¦‚ï¼šç»Ÿä¸€å‘½åæœåŠ¡ã€çŠ¶æ€åŒæ­¥æœåŠ¡ã€é›†ç¾¤ç®¡ç†ã€åˆ†å¸ƒå¼åº”ç”¨é…ç½®é¡¹çš„ç®¡ç†ç­‰ã€‚ ç®€å•çš„è¯´ï¼Œzookeeper=æ–‡ä»¶ç³»ç»Ÿ+é€šçŸ¥æœºåˆ¶ã€‚ zookeeperæä¾›äº†ä»€ä¹ˆ 1ã€ æ–‡ä»¶ç³»ç»Ÿ Zookeeperç»´æŠ¤ä¸€ä¸ªç±»ä¼¼æ–‡ä»¶ç³»ç»Ÿçš„æ•°æ®ç»“æ„ï¼š â€‹ â€‹ æ¯ä¸ªå­ç›®å½•é¡¹å¦‚ NameService éƒ½è¢«ç§°ä½œä¸º znodeï¼Œå’Œæ–‡ä»¶ç³»ç»Ÿä¸€æ ·ï¼Œæˆ‘ä»¬èƒ½å¤Ÿè‡ªç”±çš„å¢åŠ ã€åˆ é™¤znodeï¼Œåœ¨ä¸€ä¸ªznodeä¸‹å¢åŠ ã€åˆ é™¤å­znodeï¼Œå”¯ä¸€çš„ä¸åŒåœ¨äºznodeæ˜¯å¯ä»¥å­˜å‚¨æ•°æ®çš„ã€‚ æœ‰å››ç§ç±»å‹çš„znodeï¼š PERSISTENT-æŒä¹…åŒ–ç›®å½•èŠ‚ç‚¹ å®¢æˆ·ç«¯ä¸zookeeperæ–­å¼€è¿æ¥åï¼Œè¯¥èŠ‚ç‚¹ä¾æ—§å­˜åœ¨ PERSISTENT_SEQUENTIAL-æŒä¹…åŒ–é¡ºåºç¼–å·ç›®å½•èŠ‚ç‚¹ å®¢æˆ·ç«¯ä¸zookeeperæ–­å¼€è¿æ¥åï¼Œè¯¥èŠ‚ç‚¹ä¾æ—§å­˜åœ¨ï¼Œåªæ˜¯Zookeeperç»™è¯¥èŠ‚ç‚¹åç§°è¿›è¡Œé¡ºåºç¼–å· EPHEMERAL-ä¸´æ—¶ç›®å½•èŠ‚ç‚¹ å®¢æˆ·ç«¯ä¸zookeeperæ–­å¼€è¿æ¥åï¼Œè¯¥èŠ‚ç‚¹è¢«åˆ é™¤ EPHEMERAL_SEQUENTIAL-ä¸´æ—¶é¡ºåºç¼–å·ç›®å½•èŠ‚ç‚¹ å®¢æˆ·ç«¯ä¸zookeeperæ–­å¼€è¿æ¥åï¼Œè¯¥èŠ‚ç‚¹è¢«åˆ é™¤ï¼Œåªæ˜¯Zookeeperç»™è¯¥èŠ‚ç‚¹åç§°è¿›è¡Œé¡ºåºç¼–å· 2ã€ é€šçŸ¥æœºåˆ¶ â€‹ å®¢æˆ·ç«¯æ³¨å†Œç›‘å¬å®ƒå…³å¿ƒçš„ç›®å½•èŠ‚ç‚¹ï¼Œå½“ç›®å½•èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–ï¼ˆæ•°æ®æ”¹å˜ã€è¢«åˆ é™¤ã€å­ç›®å½•èŠ‚ç‚¹å¢åŠ åˆ é™¤ï¼‰æ—¶ï¼Œzookeeperä¼šé€šçŸ¥å®¢æˆ·ç«¯ã€‚ æˆ‘ä»¬èƒ½ç”¨zookeeperåšä»€ä¹ˆ 1ã€ å‘½åæœåŠ¡ â€‹ è¿™ä¸ªä¼¼ä¹æœ€ç®€å•ï¼Œåœ¨zookeeperçš„æ–‡ä»¶ç³»ç»Ÿé‡Œåˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œå³æœ‰å”¯ä¸€çš„pathã€‚åœ¨æˆ‘ä»¬ä½¿ç”¨tborgæ— æ³•ç¡®å®šä¸Šæ¸¸ç¨‹åºçš„éƒ¨ç½²æœºå™¨æ—¶å³å¯ä¸ä¸‹æ¸¸ç¨‹åºçº¦å®šå¥½pathï¼Œé€šè¿‡pathå³èƒ½äº’ç›¸æ¢ç´¢å‘ç°ï¼Œä¸è§ä¸æ•£äº†ã€‚ 2ã€ é…ç½®ç®¡ç† â€‹ ç¨‹åºæ€»æ˜¯éœ€è¦é…ç½®çš„ï¼Œå¦‚æœç¨‹åºåˆ†æ•£éƒ¨ç½²åœ¨å¤šå°æœºå™¨ä¸Šï¼Œè¦é€ä¸ªæ”¹å˜é…ç½®å°±å˜å¾—å›°éš¾ã€‚å¥½å§ï¼Œç°åœ¨æŠŠè¿™äº›é…ç½®å…¨éƒ¨æ”¾åˆ°zookeeperä¸Šå»ï¼Œä¿å­˜åœ¨ Zookeeper çš„æŸä¸ªç›®å½•èŠ‚ç‚¹ä¸­ï¼Œç„¶åæ‰€æœ‰ç›¸å…³åº”ç”¨ç¨‹åºå¯¹è¿™ä¸ªç›®å½•èŠ‚ç‚¹è¿›è¡Œç›‘å¬ï¼Œä¸€æ—¦é…ç½®ä¿¡æ¯å‘ç”Ÿå˜åŒ–ï¼Œæ¯ä¸ªåº”ç”¨ç¨‹åºå°±ä¼šæ”¶åˆ° Zookeeper çš„é€šçŸ¥ï¼Œç„¶åä» Zookeeper è·å–æ–°çš„é…ç½®ä¿¡æ¯åº”ç”¨åˆ°ç³»ç»Ÿä¸­å°±å¥½ã€‚ â€‹ 3ã€ é›†ç¾¤ç®¡ç† æ‰€è°“é›†ç¾¤ç®¡ç†æ— åœ¨ä¹ä¸¤ç‚¹ï¼šæ˜¯å¦æœ‰æœºå™¨é€€å‡ºå’ŒåŠ å…¥ã€é€‰ä¸¾masterã€‚ â€‹ å¯¹äºç¬¬ä¸€ç‚¹ï¼Œæ‰€æœ‰æœºå™¨çº¦å®šåœ¨çˆ¶ç›®å½•GroupMembersä¸‹åˆ›å»ºä¸´æ—¶ç›®å½•èŠ‚ç‚¹ï¼Œç„¶åç›‘å¬çˆ¶ç›®å½•èŠ‚ç‚¹çš„å­èŠ‚ç‚¹å˜åŒ–æ¶ˆæ¯ã€‚ä¸€æ—¦æœ‰æœºå™¨æŒ‚æ‰ï¼Œè¯¥æœºå™¨ä¸ zookeeperçš„è¿æ¥æ–­å¼€ï¼Œå…¶æ‰€åˆ›å»ºçš„ä¸´æ—¶ç›®å½•èŠ‚ç‚¹è¢«åˆ é™¤ï¼Œæ‰€æœ‰å…¶ä»–æœºå™¨éƒ½æ”¶åˆ°é€šçŸ¥ï¼šæŸä¸ªå…„å¼Ÿç›®å½•è¢«åˆ é™¤ï¼Œäºæ˜¯ï¼Œæ‰€æœ‰äººéƒ½çŸ¥é“ï¼šå®ƒä¸‹èˆ¹äº†ã€‚æ–°æœºå™¨åŠ å…¥ ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œæ‰€æœ‰æœºå™¨æ”¶åˆ°é€šçŸ¥ï¼šæ–°å…„å¼Ÿç›®å½•åŠ å…¥ã€‚ â€‹ å¯¹äºç¬¬äºŒç‚¹ï¼Œæˆ‘ä»¬ç¨å¾®æ”¹å˜ä¸€ä¸‹ï¼Œæ‰€æœ‰æœºå™¨åˆ›å»ºä¸´æ—¶é¡ºåºç¼–å·ç›®å½•èŠ‚ç‚¹ï¼Œæ¯æ¬¡é€‰å–ç¼–å·æœ€å°çš„æœºå™¨ä½œä¸ºmasterå°±å¥½ã€‚ â€‹ 4ã€ åˆ†å¸ƒå¼é” â€‹ æœ‰äº†zookeeperçš„ä¸€è‡´æ€§æ–‡ä»¶ç³»ç»Ÿï¼Œé”çš„é—®é¢˜å˜å¾—å®¹æ˜“ã€‚é”æœåŠ¡å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ä¸ªæ˜¯ä¿æŒç‹¬å ï¼Œå¦ä¸€ä¸ªæ˜¯æ§åˆ¶æ—¶åºã€‚ â€‹ å¯¹äºç¬¬ä¸€ç±»ï¼Œæˆ‘ä»¬å°†zookeeperä¸Šçš„ä¸€ä¸ªznodeçœ‹ä½œæ˜¯ä¸€æŠŠé”ï¼Œé€šè¿‡createznodeçš„æ–¹å¼æ¥å®ç°ã€‚æ‰€æœ‰å®¢æˆ·ç«¯éƒ½å»åˆ›å»º /distribute_lock èŠ‚ç‚¹ï¼Œæœ€ç»ˆæˆåŠŸåˆ›å»ºçš„é‚£ä¸ªå®¢æˆ·ç«¯ä¹Ÿå³æ‹¥æœ‰äº†è¿™æŠŠé”ã€‚å•æ‰€æœ‰è¨€ï¼šæ¥ä¹Ÿå†²å†²ï¼Œå»ä¹Ÿå†²å†²ï¼Œç”¨å®Œåˆ é™¤æ‰è‡ªå·±åˆ›å»ºçš„distribute_lock èŠ‚ç‚¹å°±é‡Šæ”¾å‡ºé”ã€‚ â€‹ å¯¹äºç¬¬äºŒç±»ï¼Œ /distribute_lock å·²ç»é¢„å…ˆå­˜åœ¨ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯åœ¨å®ƒä¸‹é¢åˆ›å»ºä¸´æ—¶é¡ºåºç¼–å·ç›®å½•èŠ‚ç‚¹ï¼Œå’Œé€‰masterä¸€æ ·ï¼Œç¼–å·æœ€å°çš„è·å¾—é”ï¼Œç”¨å®Œåˆ é™¤ï¼Œä¾æ¬¡æ–¹ä¾¿ã€‚ â€‹ 5ã€é˜Ÿåˆ—ç®¡ç† ä¸¤ç§ç±»å‹çš„é˜Ÿåˆ—ï¼š åŒæ­¥é˜Ÿåˆ—ï¼Œå½“ä¸€ä¸ªé˜Ÿåˆ—çš„æˆå‘˜éƒ½èšé½æ—¶ï¼Œè¿™ä¸ªé˜Ÿåˆ—æ‰å¯ç”¨ï¼Œå¦åˆ™ä¸€ç›´ç­‰å¾…æ‰€æœ‰æˆå‘˜åˆ°è¾¾ã€‚ é˜Ÿåˆ—æŒ‰ç…§ FIFO æ–¹å¼è¿›è¡Œå…¥é˜Ÿå’Œå‡ºé˜Ÿæ“ä½œã€‚ ç¬¬ä¸€ç±»ï¼Œåœ¨çº¦å®šç›®å½•ä¸‹åˆ›å»ºä¸´æ—¶ç›®å½•èŠ‚ç‚¹ï¼Œç›‘å¬èŠ‚ç‚¹æ•°ç›®æ˜¯å¦æ˜¯æˆ‘ä»¬è¦æ±‚çš„æ•°ç›®ã€‚ ç¬¬äºŒç±»ï¼Œå’Œåˆ†å¸ƒå¼é”æœåŠ¡ä¸­çš„æ§åˆ¶æ—¶åºåœºæ™¯åŸºæœ¬åŸç†ä¸€è‡´ï¼Œå…¥åˆ—æœ‰ç¼–å·ï¼Œå‡ºåˆ—æŒ‰ç¼–å·ã€‚ â€‹ ç»ˆäºäº†è§£å®Œæˆ‘ä»¬èƒ½ç”¨zookeeperåšä»€ä¹ˆäº†ï¼Œå¯æ˜¯ä½œä¸ºä¸€ä¸ªç¨‹åºå‘˜ï¼Œæˆ‘ä»¬æ€»æ˜¯æƒ³ç‹‚çƒ­äº†è§£zookeeperæ˜¯å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹çš„ï¼Œå•ç‚¹ç»´æŠ¤ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿæ²¡æœ‰ä»€ä¹ˆéš¾åº¦ï¼Œå¯æ˜¯å¦‚æœæ˜¯ä¸€ä¸ªé›†ç¾¤ç»´æŠ¤ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¿æŒæ•°æ®çš„ä¸€è‡´æ€§å°±éå¸¸å›°éš¾äº†ã€‚ 6ã€åˆ†å¸ƒå¼ä¸æ•°æ®å¤åˆ¶ Zookeeperä½œä¸ºä¸€ä¸ªé›†ç¾¤æä¾›ä¸€è‡´çš„æ•°æ®æœåŠ¡ï¼Œè‡ªç„¶ï¼Œå®ƒè¦åœ¨æ‰€æœ‰æœºå™¨é—´åšæ•°æ®å¤åˆ¶ã€‚æ•°æ®å¤åˆ¶çš„å¥½å¤„ï¼š å®¹é”™ ä¸€ä¸ªèŠ‚ç‚¹å‡ºé”™ï¼Œä¸è‡´äºè®©æ•´ä¸ªç³»ç»Ÿåœæ­¢å·¥ä½œï¼Œåˆ«çš„èŠ‚ç‚¹å¯ä»¥æ¥ç®¡å®ƒçš„å·¥ä½œï¼› æé«˜ç³»ç»Ÿçš„æ‰©å±•èƒ½åŠ› æŠŠè´Ÿè½½åˆ†å¸ƒåˆ°å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œæˆ–è€…å¢åŠ èŠ‚ç‚¹æ¥æé«˜ç³»ç»Ÿçš„è´Ÿè½½èƒ½åŠ›ï¼› æé«˜æ€§èƒ½ è®©å®¢æˆ·ç«¯æœ¬åœ°è®¿é—®å°±è¿‘çš„èŠ‚ç‚¹ï¼Œæé«˜ç”¨æˆ·è®¿é—®é€Ÿåº¦ã€‚ ä»å®¢æˆ·ç«¯è¯»å†™è®¿é—®çš„é€æ˜åº¦æ¥çœ‹ï¼Œæ•°æ®å¤åˆ¶é›†ç¾¤ç³»ç»Ÿåˆ†ä¸‹é¢ä¸¤ç§ï¼š å†™ä¸»(WriteMaster) å¯¹æ•°æ®çš„ä¿®æ”¹æäº¤ç»™æŒ‡å®šçš„èŠ‚ç‚¹ã€‚è¯»æ— æ­¤é™åˆ¶ï¼Œå¯ä»¥è¯»å–ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹ã€‚è¿™ç§æƒ…å†µä¸‹å®¢æˆ·ç«¯éœ€è¦å¯¹è¯»ä¸å†™è¿›è¡ŒåŒºåˆ«ï¼Œä¿—ç§°è¯»å†™åˆ†ç¦»ï¼› å†™ä»»æ„(Write Any) å¯¹æ•°æ®çš„ä¿®æ”¹å¯æäº¤ç»™ä»»æ„çš„èŠ‚ç‚¹ï¼Œè·Ÿè¯»ä¸€æ ·ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯å¯¹é›†ç¾¤èŠ‚ç‚¹çš„è§’è‰²ä¸å˜åŒ–é€æ˜ã€‚ â€‹ å¯¹zookeeperæ¥è¯´ï¼Œå®ƒé‡‡ç”¨çš„æ–¹å¼æ˜¯å†™ä»»æ„ã€‚é€šè¿‡å¢åŠ æœºå™¨ï¼Œå®ƒçš„è¯»ååèƒ½åŠ›å’Œå“åº”èƒ½åŠ›æ‰©å±•æ€§éå¸¸å¥½ï¼Œè€Œå†™ï¼Œéšç€æœºå™¨çš„å¢å¤šååèƒ½åŠ›è‚¯å®šä¸‹é™ï¼ˆè¿™ ä¹Ÿæ˜¯å®ƒå»ºç«‹observerçš„åŸå› ï¼‰ï¼Œè€Œå“åº”èƒ½åŠ›åˆ™å–å†³äºå…·ä½“å®ç°æ–¹å¼ï¼Œæ˜¯å»¶è¿Ÿå¤åˆ¶ä¿æŒæœ€ç»ˆä¸€è‡´æ€§ï¼Œè¿˜æ˜¯ç«‹å³å¤åˆ¶å¿«é€Ÿå“åº”ã€‚ æˆ‘ä»¬å…³æ³¨çš„é‡ç‚¹è¿˜æ˜¯åœ¨å¦‚ä½•ä¿è¯æ•°æ®åœ¨é›†ç¾¤æ‰€æœ‰æœºå™¨çš„ä¸€è‡´æ€§ï¼Œè¿™å°±æ¶‰åŠåˆ°paxosç®—æ³•ã€‚ 7ã€æ•°æ®ä¸€è‡´æ€§ä¸paxosç®—æ³• â€‹ æ®è¯´Paxosç®—æ³•çš„éš¾ç†è§£ä¸ç®—æ³•çš„çŸ¥ååº¦ä¸€æ ·ä»¤äººæ•¬ä»°ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆçœ‹å¦‚ä½•ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§ï¼Œè¿™é‡Œæœ‰ä¸ªåŸåˆ™å°±æ˜¯ï¼š åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼æ•°æ®åº“ç³»ç»Ÿä¸­ï¼Œå¦‚æœå„èŠ‚ç‚¹çš„åˆå§‹çŠ¶æ€ä¸€è‡´ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æ‰§è¡Œç›¸åŒçš„æ“ä½œåºåˆ—ï¼Œé‚£ä¹ˆä»–ä»¬æœ€åèƒ½å¾—åˆ°ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€ã€‚ â€‹ Paxosç®—æ³•è§£å†³çš„ä»€ä¹ˆé—®é¢˜å‘¢ï¼Œè§£å†³çš„å°±æ˜¯ä¿è¯æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œç›¸åŒçš„æ“ä½œåºåˆ—ã€‚å¥½å§ï¼Œè¿™è¿˜ä¸ç®€å•ï¼Œmasterç»´æŠ¤ä¸€ä¸ªå…¨å±€å†™é˜Ÿåˆ—ï¼Œæ‰€æœ‰å†™æ“ä½œéƒ½å¿…é¡» æ”¾å…¥è¿™ä¸ªé˜Ÿåˆ—ç¼–å·ï¼Œé‚£ä¹ˆæ— è®ºæˆ‘ä»¬å†™å¤šå°‘ä¸ªèŠ‚ç‚¹ï¼Œåªè¦å†™æ“ä½œæ˜¯æŒ‰ç¼–å·æ¥çš„ï¼Œå°±èƒ½ä¿è¯ä¸€è‡´æ€§ã€‚æ²¡é”™ï¼Œå°±æ˜¯è¿™æ ·ï¼Œå¯æ˜¯å¦‚æœmasteræŒ‚äº†å‘¢ã€‚ â€‹ Paxosç®—æ³•é€šè¿‡æŠ•ç¥¨æ¥å¯¹å†™æ“ä½œè¿›è¡Œå…¨å±€ç¼–å·ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªå†™æ“ä½œè¢«æ‰¹å‡†ï¼ŒåŒæ—¶å¹¶å‘çš„å†™æ“ä½œè¦å»äº‰å–é€‰ç¥¨ï¼Œåªæœ‰è·å¾—è¿‡åŠæ•°é€‰ç¥¨çš„å†™æ“ä½œæ‰ä¼šè¢« æ‰¹å‡†ï¼ˆæ‰€ä»¥æ°¸è¿œåªä¼šæœ‰ä¸€ä¸ªå†™æ“ä½œå¾—åˆ°æ‰¹å‡†ï¼‰ï¼Œå…¶ä»–çš„å†™æ“ä½œç«äº‰å¤±è´¥åªå¥½å†å‘èµ·ä¸€è½®æŠ•ç¥¨ï¼Œå°±è¿™æ ·ï¼Œåœ¨æ—¥å¤ä¸€æ—¥å¹´å¤ä¸€å¹´çš„æŠ•ç¥¨ä¸­ï¼Œæ‰€æœ‰å†™æ“ä½œéƒ½è¢«ä¸¥æ ¼ç¼–å·æ’ åºã€‚ç¼–å·ä¸¥æ ¼é€’å¢ï¼Œå½“ä¸€ä¸ªèŠ‚ç‚¹æ¥å—äº†ä¸€ä¸ªç¼–å·ä¸º100çš„å†™æ“ä½œï¼Œä¹‹ååˆæ¥å—åˆ°ç¼–å·ä¸º99çš„å†™æ“ä½œï¼ˆå› ä¸ºç½‘ç»œå»¶è¿Ÿç­‰å¾ˆå¤šä¸å¯é¢„è§åŸå› ï¼‰ï¼Œå®ƒé©¬ä¸Šèƒ½æ„è¯†åˆ°è‡ªå·± æ•°æ®ä¸ä¸€è‡´äº†ï¼Œè‡ªåŠ¨åœæ­¢å¯¹å¤–æœåŠ¡å¹¶é‡å¯åŒæ­¥è¿‡ç¨‹ã€‚ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹æŒ‚æ‰éƒ½ä¸ä¼šå½±å“æ•´ä¸ªé›†ç¾¤çš„æ•°æ®ä¸€è‡´æ€§ï¼ˆæ€»2n+1å°ï¼Œé™¤éæŒ‚æ‰å¤§äºnå°ï¼‰ã€‚ æ€»ç»“ â€‹ Zookeeper ä½œä¸º Hadoop é¡¹ç›®ä¸­çš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œæ˜¯ Hadoop é›†ç¾¤ç®¡ç†çš„ä¸€ä¸ªå¿…ä¸å¯å°‘çš„æ¨¡å—ï¼Œå®ƒä¸»è¦ç”¨æ¥æ§åˆ¶é›†ç¾¤ä¸­çš„æ•°æ®ï¼Œå¦‚å®ƒç®¡ç† Hadoop é›†ç¾¤ä¸­çš„ NameNodeï¼Œè¿˜æœ‰ Hbase ä¸­ Master Electionã€Server ä¹‹é—´çŠ¶æ€åŒæ­¥ç­‰ã€‚ Zookeeperå·¥ä½œåŸç† â€‹ ZooKeeperæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„ï¼Œå¼€æ”¾æºç çš„åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºåè°ƒæœåŠ¡ï¼Œå®ƒåŒ…å«ä¸€ä¸ªç®€å•çš„åŸè¯­é›†ï¼Œåˆ†å¸ƒå¼åº”ç”¨ç¨‹åºå¯ä»¥åŸºäºå®ƒå®ç°åŒæ­¥æœåŠ¡ï¼Œé…ç½®ç»´æŠ¤å’Œ å‘½åæœåŠ¡ç­‰ã€‚Zookeeperæ˜¯hadoopçš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œå…¶å‘å±•å†ç¨‹æ— éœ€èµ˜è¿°ã€‚åœ¨åˆ†å¸ƒå¼åº”ç”¨ä¸­ï¼Œç”±äºå·¥ç¨‹å¸ˆä¸èƒ½å¾ˆå¥½åœ°ä½¿ç”¨é”æœºåˆ¶ï¼Œä»¥åŠåŸºäºæ¶ˆæ¯çš„åè°ƒ æœºåˆ¶ä¸é€‚åˆåœ¨æŸäº›åº”ç”¨ä¸­ä½¿ç”¨ï¼Œå› æ­¤éœ€è¦æœ‰ä¸€ç§å¯é çš„ã€å¯æ‰©å±•çš„ã€åˆ†å¸ƒå¼çš„ã€å¯é…ç½®çš„åè°ƒæœºåˆ¶æ¥ç»Ÿä¸€ç³»ç»Ÿçš„çŠ¶æ€ã€‚Zookeeperçš„ç›®çš„å°±åœ¨äºæ­¤ã€‚ Zookeeperçš„åŸºæœ¬æ¦‚å¿µ 1.1 è§’è‰² Zookeeperä¸­çš„è§’è‰²ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç±»ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š â€‹ ç³»ç»Ÿæ¨¡å‹å¦‚å›¾æ‰€ç¤ºï¼š â€‹ 1.2 è®¾è®¡ç›®çš„ æœ€ç»ˆä¸€è‡´æ€§ï¼šclientä¸è®ºè¿æ¥åˆ°å“ªä¸ªServerï¼Œå±•ç¤ºç»™å®ƒéƒ½æ˜¯åŒä¸€ä¸ªè§†å›¾ï¼Œè¿™æ˜¯zookeeperæœ€é‡è¦çš„æ€§èƒ½ã€‚ å¯é æ€§ï¼šå…·æœ‰ç®€å•ã€å¥å£®ã€è‰¯å¥½çš„æ€§èƒ½ï¼Œå¦‚æœæ¶ˆæ¯mè¢«ä¸€å°æœåŠ¡å™¨æ¥å—ï¼Œé‚£ä¹ˆå®ƒå°†è¢«æ‰€æœ‰çš„æœåŠ¡å™¨æ¥å—ã€‚ å®æ—¶æ€§ï¼šZookeeperä¿è¯å®¢æˆ·ç«¯å°†åœ¨ä¸€ä¸ªæ—¶é—´é—´éš”èŒƒå›´å†…è·å¾—æœåŠ¡å™¨çš„æ›´æ–°ä¿¡æ¯ï¼Œæˆ–è€…æœåŠ¡å™¨å¤±æ•ˆçš„ä¿¡æ¯ã€‚ä½†ç”±äºç½‘ç»œå»¶æ—¶ç­‰åŸå› ï¼ŒZookeeperä¸èƒ½ä¿è¯ä¸¤ä¸ªå®¢æˆ·ç«¯èƒ½åŒæ—¶å¾—åˆ°åˆšæ›´æ–°çš„æ•°æ®ï¼Œå¦‚æœéœ€è¦æœ€æ–°æ•°æ®ï¼Œåº”è¯¥åœ¨è¯»æ•°æ®ä¹‹å‰è°ƒç”¨sync()æ¥å£ã€‚ ç­‰å¾…æ— å…³ï¼ˆwait-freeï¼‰ï¼šæ…¢çš„æˆ–è€…å¤±æ•ˆçš„clientä¸å¾—å¹²é¢„å¿«é€Ÿçš„clientçš„è¯·æ±‚ï¼Œä½¿å¾—æ¯ä¸ªclientéƒ½èƒ½æœ‰æ•ˆçš„ç­‰å¾…ã€‚ åŸå­æ€§ï¼šæ›´æ–°åªèƒ½æˆåŠŸæˆ–è€…å¤±è´¥ï¼Œæ²¡æœ‰ä¸­é—´çŠ¶æ€ã€‚ é¡ºåºæ€§ï¼šåŒ…æ‹¬å…¨å±€æœ‰åºå’Œååºä¸¤ç§ï¼šå…¨å±€æœ‰åºæ˜¯æŒ‡å¦‚æœåœ¨ä¸€å°æœåŠ¡å™¨ä¸Šæ¶ˆæ¯aåœ¨æ¶ˆæ¯bå‰å‘å¸ƒï¼Œåˆ™åœ¨æ‰€æœ‰Serverä¸Šæ¶ˆæ¯aéƒ½å°†åœ¨æ¶ˆæ¯bå‰è¢«å‘å¸ƒï¼›ååºæ˜¯æŒ‡å¦‚æœä¸€ä¸ªæ¶ˆæ¯båœ¨æ¶ˆæ¯aåè¢«åŒä¸€ä¸ªå‘é€è€…å‘å¸ƒï¼Œaå¿…å°†æ’åœ¨bå‰é¢ã€‚ ZooKeeperçš„æµç¨‹è®¾è®¡ â€‹ Zookeeperçš„æ ¸å¿ƒæ˜¯åŸå­å¹¿æ’­ï¼Œè¿™ä¸ªæœºåˆ¶ä¿è¯äº†å„ä¸ªServerä¹‹é—´çš„åŒæ­¥ã€‚å®ç°è¿™ä¸ªæœºåˆ¶çš„åè®®å«åšZabåè®®ã€‚Zabåè®®æœ‰ä¸¤ç§æ¨¡å¼ï¼Œå®ƒä»¬åˆ† åˆ«æ˜¯æ¢å¤æ¨¡å¼ï¼ˆé€‰ä¸»ï¼‰å’Œå¹¿æ’­æ¨¡å¼ï¼ˆåŒæ­¥ï¼‰ã€‚å½“æœåŠ¡å¯åŠ¨æˆ–è€…åœ¨é¢†å¯¼è€…å´©æºƒåï¼ŒZabå°±è¿›å…¥äº†æ¢å¤æ¨¡å¼ï¼Œå½“é¢†å¯¼è€…è¢«é€‰ä¸¾å‡ºæ¥ï¼Œä¸”å¤§å¤šæ•°Serverå®Œæˆäº†å’Œ leaderçš„çŠ¶æ€åŒæ­¥ä»¥åï¼Œæ¢å¤æ¨¡å¼å°±ç»“æŸäº†ã€‚çŠ¶æ€åŒæ­¥ä¿è¯äº†leaderå’ŒServerå…·æœ‰ç›¸åŒçš„ç³»ç»ŸçŠ¶æ€ã€‚ â€‹ ä¸ºäº†ä¿è¯äº‹åŠ¡çš„é¡ºåºä¸€è‡´æ€§ï¼Œzookeeperé‡‡ç”¨äº†é€’å¢çš„äº‹åŠ¡idå·ï¼ˆzxidï¼‰æ¥æ ‡è¯†äº‹åŠ¡ã€‚æ‰€æœ‰çš„æè®®ï¼ˆproposalï¼‰éƒ½åœ¨è¢«æå‡ºçš„æ—¶å€™åŠ ä¸Š äº†zxidã€‚å®ç°ä¸­zxidæ˜¯ä¸€ä¸ª64ä½çš„æ•°å­—ï¼Œå®ƒé«˜32ä½æ˜¯epochç”¨æ¥æ ‡è¯†leaderå…³ç³»æ˜¯å¦æ”¹å˜ï¼Œæ¯æ¬¡ä¸€ä¸ªleaderè¢«é€‰å‡ºæ¥ï¼Œå®ƒéƒ½ä¼šæœ‰ä¸€ä¸ª æ–°çš„epochï¼Œæ ‡è¯†å½“å‰å±äºé‚£ä¸ªleaderçš„ç»Ÿæ²»æ—¶æœŸã€‚ä½32ä½ç”¨äºé€’å¢è®¡æ•°ã€‚ æ¯ä¸ªServeråœ¨å·¥ä½œè¿‡ç¨‹ä¸­æœ‰ä¸‰ç§çŠ¶æ€ï¼š LOOKINGï¼šå½“å‰Serverä¸çŸ¥é“leaderæ˜¯è°ï¼Œæ­£åœ¨æœå¯» LEADINGï¼šå½“å‰Serverå³ä¸ºé€‰ä¸¾å‡ºæ¥çš„leader FOLLOWINGï¼šleaderå·²ç»é€‰ä¸¾å‡ºæ¥ï¼Œå½“å‰Serverä¸ä¹‹åŒæ­¥ 2.1 é€‰ä¸»æµç¨‹ å½“leaderå´©æºƒæˆ–è€…leaderå¤±å»å¤§å¤šæ•°çš„followerï¼Œè¿™æ—¶å€™zkè¿›å…¥æ¢å¤æ¨¡å¼ï¼Œæ¢å¤æ¨¡å¼éœ€è¦é‡æ–°é€‰ä¸¾å‡ºä¸€ä¸ªæ–°çš„leaderï¼Œè®©æ‰€æœ‰çš„ Serveréƒ½æ¢å¤åˆ°ä¸€ä¸ªæ­£ç¡®çš„çŠ¶æ€ã€‚Zkçš„é€‰ä¸¾ç®—æ³•æœ‰ä¸¤ç§ï¼šä¸€ç§æ˜¯åŸºäºbasic paxoså®ç°çš„ï¼Œå¦å¤–ä¸€ç§æ˜¯åŸºäºfast paxosç®—æ³•å®ç°çš„ã€‚ç³»ç»Ÿé»˜è®¤çš„é€‰ä¸¾ç®—æ³•ä¸ºfast paxosã€‚å…ˆä»‹ç»basic paxosæµç¨‹ï¼š â€‹ 1 .é€‰ä¸¾çº¿ç¨‹ç”±å½“å‰Serverå‘èµ·é€‰ä¸¾çš„çº¿ç¨‹æ‹…ä»»ï¼Œå…¶ä¸»è¦åŠŸèƒ½æ˜¯å¯¹æŠ•ç¥¨ç»“æœè¿›è¡Œç»Ÿè®¡ï¼Œå¹¶é€‰å‡ºæ¨èçš„Serverï¼› â€‹ 2 .é€‰ä¸¾çº¿ç¨‹é¦–å…ˆå‘æ‰€æœ‰Serverå‘èµ·ä¸€æ¬¡è¯¢é—®(åŒ…æ‹¬è‡ªå·±)ï¼› â€‹ 3 .é€‰ä¸¾çº¿ç¨‹æ”¶åˆ°å›å¤åï¼ŒéªŒè¯æ˜¯å¦æ˜¯è‡ªå·±å‘èµ·çš„è¯¢é—®(éªŒè¯zxidæ˜¯å¦ä¸€è‡´)ï¼Œç„¶åè·å–å¯¹æ–¹çš„id(myid)ï¼Œå¹¶å­˜å‚¨åˆ°å½“å‰è¯¢é—®å¯¹è±¡åˆ—è¡¨ä¸­ï¼Œæœ€åè·å–å¯¹æ–¹æè®®çš„leaderç›¸å…³ä¿¡æ¯( id,zxid)ï¼Œå¹¶å°†è¿™äº›ä¿¡æ¯å­˜å‚¨åˆ°å½“æ¬¡é€‰ä¸¾çš„æŠ•ç¥¨è®°å½•è¡¨ä¸­ï¼› â€‹ 4. æ”¶åˆ°æ‰€æœ‰Serverå›å¤ä»¥åï¼Œå°±è®¡ç®—å‡ºzxidæœ€å¤§çš„é‚£ä¸ªServerï¼Œå¹¶å°†è¿™ä¸ªServerç›¸å…³ä¿¡æ¯è®¾ç½®æˆä¸‹ä¸€æ¬¡è¦æŠ•ç¥¨çš„Serverï¼› â€‹ 5. çº¿ç¨‹å°†å½“å‰zxidæœ€å¤§çš„Serverè®¾ç½®ä¸ºå½“å‰Serverè¦æ¨èçš„Leaderï¼Œå¦‚æœæ­¤æ—¶è·èƒœçš„Serverè·å¾—n/2 + 1çš„Serverç¥¨æ•°ï¼Œ è®¾ç½®å½“å‰æ¨èçš„leaderä¸ºè·èƒœçš„Serverï¼Œå°†æ ¹æ®è·èƒœçš„Serverç›¸å…³ä¿¡æ¯è®¾ç½®è‡ªå·±çš„çŠ¶æ€ï¼Œå¦åˆ™ï¼Œç»§ç»­è¿™ä¸ªè¿‡ç¨‹ï¼Œç›´åˆ°leaderè¢«é€‰ä¸¾å‡ºæ¥ã€‚ é€šè¿‡æµç¨‹åˆ†ææˆ‘ä»¬å¯ä»¥å¾—å‡ºï¼šè¦ä½¿Leaderè·å¾—å¤šæ•°Serverçš„æ”¯æŒï¼Œåˆ™Serveræ€»æ•°å¿…é¡»æ˜¯å¥‡æ•°2n+1ï¼Œä¸”å­˜æ´»çš„Serverçš„æ•°ç›®ä¸å¾—å°‘äºn+1. æ¯ä¸ªServerå¯åŠ¨åéƒ½ä¼šé‡å¤ä»¥ä¸Šæµç¨‹ã€‚åœ¨æ¢å¤æ¨¡å¼ä¸‹ï¼Œå¦‚æœæ˜¯åˆšä»å´©æºƒçŠ¶æ€æ¢å¤çš„æˆ–è€…åˆšå¯åŠ¨çš„serverè¿˜ä¼šä»ç£ç›˜å¿«ç…§ä¸­æ¢å¤æ•°æ®å’Œä¼šè¯ä¿¡æ¯ï¼Œzkä¼šè®°å½•äº‹åŠ¡æ—¥å¿—å¹¶å®šæœŸè¿›è¡Œå¿«ç…§ï¼Œæ–¹ä¾¿åœ¨æ¢å¤æ—¶è¿›è¡ŒçŠ¶æ€æ¢å¤ã€‚é€‰ä¸»çš„å…·ä½“æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š â€‹ fast paxosæµç¨‹æ˜¯åœ¨é€‰ä¸¾è¿‡ç¨‹ä¸­ï¼ŒæŸServeré¦–å…ˆå‘æ‰€æœ‰Serveræè®®è‡ªå·±è¦æˆä¸ºleaderï¼Œå½“å…¶å®ƒServeræ”¶åˆ°æè®®ä»¥åï¼Œè§£å†³epochå’Œ zxidçš„å†²çªï¼Œå¹¶æ¥å—å¯¹æ–¹çš„æè®®ï¼Œç„¶åå‘å¯¹æ–¹å‘é€æ¥å—æè®®å®Œæˆçš„æ¶ˆæ¯ï¼Œé‡å¤è¿™ä¸ªæµç¨‹ï¼Œæœ€åä¸€å®šèƒ½é€‰ä¸¾å‡ºLeaderã€‚å…¶æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š 2.2 åŒæ­¥æµç¨‹ é€‰å®Œleaderä»¥åï¼Œzkå°±è¿›å…¥çŠ¶æ€åŒæ­¥è¿‡ç¨‹ã€‚ â€‹ 1. leaderç­‰å¾…serverè¿æ¥ï¼› â€‹ 2 .Followerè¿æ¥leaderï¼Œå°†æœ€å¤§çš„zxidå‘é€ç»™leaderï¼› â€‹ 3 .Leaderæ ¹æ®followerçš„zxidç¡®å®šåŒæ­¥ç‚¹ï¼› â€‹ 4 .å®ŒæˆåŒæ­¥åé€šçŸ¥follower å·²ç»æˆä¸ºuptodateçŠ¶æ€ï¼› â€‹ 5 .Followeræ”¶åˆ°uptodateæ¶ˆæ¯åï¼Œåˆå¯ä»¥é‡æ–°æ¥å—clientçš„è¯·æ±‚è¿›è¡ŒæœåŠ¡äº†ã€‚ æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š â€‹ 2.3 å·¥ä½œæµç¨‹ 2.3.1 Leaderå·¥ä½œæµç¨‹ Leaderä¸»è¦æœ‰ä¸‰ä¸ªåŠŸèƒ½ï¼š â€‹ 1 .æ¢å¤æ•°æ®ï¼› â€‹ 2 .ç»´æŒä¸Learnerçš„å¿ƒè·³ï¼Œæ¥æ”¶Learnerè¯·æ±‚å¹¶åˆ¤æ–­Learnerçš„è¯·æ±‚æ¶ˆæ¯ç±»å‹ï¼› â€‹ 3 .Learnerçš„æ¶ˆæ¯ç±»å‹ä¸»è¦æœ‰PINGæ¶ˆæ¯ã€REQUESTæ¶ˆæ¯ã€ACKæ¶ˆæ¯ã€REVALIDATEæ¶ˆæ¯ï¼Œæ ¹æ®ä¸åŒçš„æ¶ˆæ¯ç±»å‹ï¼Œè¿›è¡Œä¸åŒçš„å¤„ç†ã€‚ â€‹ PINGæ¶ˆæ¯æ˜¯æŒ‡Learnerçš„å¿ƒè·³ä¿¡æ¯ï¼›REQUESTæ¶ˆæ¯æ˜¯Followerå‘é€çš„æè®®ä¿¡æ¯ï¼ŒåŒ…æ‹¬å†™è¯·æ±‚åŠåŒæ­¥è¯·æ±‚ï¼›ACKæ¶ˆæ¯æ˜¯ Followerçš„å¯¹æè®®çš„å›å¤ï¼Œè¶…è¿‡åŠæ•°çš„Followeré€šè¿‡ï¼Œåˆ™commitè¯¥æè®®ï¼›REVALIDATEæ¶ˆæ¯æ˜¯ç”¨æ¥å»¶é•¿SESSIONæœ‰æ•ˆæ—¶é—´ã€‚ Leaderçš„å·¥ä½œæµç¨‹ç®€å›¾å¦‚ä¸‹æ‰€ç¤ºï¼Œåœ¨å®é™…å®ç°ä¸­ï¼Œæµç¨‹è¦æ¯”ä¸‹å›¾å¤æ‚å¾—å¤šï¼Œå¯åŠ¨äº†ä¸‰ä¸ªçº¿ç¨‹æ¥å®ç°åŠŸèƒ½ã€‚ â€‹ 2.3.2 Followerå·¥ä½œæµç¨‹ Followerä¸»è¦æœ‰å››ä¸ªåŠŸèƒ½ï¼š â€‹ 1. å‘Leaderå‘é€è¯·æ±‚ï¼ˆPINGæ¶ˆæ¯ã€REQUESTæ¶ˆæ¯ã€ACKæ¶ˆæ¯ã€REVALIDATEæ¶ˆæ¯ï¼‰ï¼› â€‹ 2 .æ¥æ”¶Leaderæ¶ˆæ¯å¹¶è¿›è¡Œå¤„ç†ï¼› â€‹ 3 .æ¥æ”¶Clientçš„è¯·æ±‚ï¼Œå¦‚æœä¸ºå†™è¯·æ±‚ï¼Œå‘é€ç»™Leaderè¿›è¡ŒæŠ•ç¥¨ï¼› â€‹ 4 .è¿”å›Clientç»“æœã€‚ Followerçš„æ¶ˆæ¯å¾ªç¯å¤„ç†å¦‚ä¸‹å‡ ç§æ¥è‡ªLeaderçš„æ¶ˆæ¯ï¼š â€‹ 1 .PINGæ¶ˆæ¯ï¼š å¿ƒè·³æ¶ˆæ¯ï¼› â€‹ 2 .PROPOSALæ¶ˆæ¯ï¼šLeaderå‘èµ·çš„ææ¡ˆï¼Œè¦æ±‚FolloweræŠ•ç¥¨ï¼› â€‹ 3 .COMMITæ¶ˆæ¯ï¼šæœåŠ¡å™¨ç«¯æœ€æ–°ä¸€æ¬¡ææ¡ˆçš„ä¿¡æ¯ï¼› â€‹ 4 .UPTODATEæ¶ˆæ¯ï¼šè¡¨æ˜åŒæ­¥å®Œæˆï¼› â€‹ 5 .REVALIDATEæ¶ˆæ¯ï¼šæ ¹æ®Leaderçš„REVALIDATEç»“æœï¼Œå…³é—­å¾…revalidateçš„sessionè¿˜æ˜¯å…è®¸å…¶æ¥å—æ¶ˆæ¯ï¼› â€‹ 6 .SYNCæ¶ˆæ¯ï¼šè¿”å›SYNCç»“æœåˆ°å®¢æˆ·ç«¯ï¼Œè¿™ä¸ªæ¶ˆæ¯æœ€åˆç”±å®¢æˆ·ç«¯å‘èµ·ï¼Œç”¨æ¥å¼ºåˆ¶å¾—åˆ°æœ€æ–°çš„æ›´æ–°ã€‚ Followerçš„å·¥ä½œæµç¨‹ç®€å›¾å¦‚ä¸‹æ‰€ç¤ºï¼Œåœ¨å®é™…å®ç°ä¸­ï¼ŒFolloweræ˜¯é€šè¿‡5ä¸ªçº¿ç¨‹æ¥å®ç°åŠŸèƒ½çš„ã€‚ â€‹ å¯¹äºobserverçš„æµç¨‹ä¸å†å™è¿°ï¼Œobserveræµç¨‹å’ŒFollowerçš„å”¯ä¸€ä¸åŒçš„åœ°æ–¹å°±æ˜¯observerä¸ä¼šå‚åŠ leaderå‘èµ·çš„æŠ•ç¥¨ã€‚ ","link":"https://tianxiawuhao.github.io/DOckY7njv/"},{"title":"Gossipåè®®","content":"Gossip Gossipåè®®æ˜¯ä¸€ä¸ªé€šä¿¡åè®®ï¼Œä¸€ç§ä¼ æ’­æ¶ˆæ¯çš„æ–¹å¼ï¼Œçµæ„Ÿæ¥è‡ªäºï¼šç˜Ÿç–«ã€ç¤¾äº¤ç½‘ç»œç­‰ã€‚ä½¿ç”¨Gossipåè®®çš„æœ‰ï¼šRedis Clusterã€Consulã€Apache Cassandraç­‰ã€‚ å…­åº¦åˆ†éš”ç†è®º è¯´åˆ°ç¤¾äº¤ç½‘ç»œï¼Œå°±ä¸å¾—ä¸æè‘—åçš„å…­åº¦åˆ†éš”ç†è®ºã€‚1967å¹´ï¼Œå“ˆä½›å¤§å­¦çš„å¿ƒç†å­¦æ•™æˆStanley Milgramæƒ³è¦æç»˜ä¸€ä¸ªè¿ç»“äººä¸ç¤¾åŒºçš„äººé™…è¿ç³»ç½‘ã€‚åšè¿‡ä¸€æ¬¡è¿é”ä¿¡å®éªŒï¼Œç»“æœå‘ç°äº†â€œå…­åº¦åˆ†éš”â€ç°è±¡ã€‚ç®€å•åœ°è¯´ï¼šâ€œä½ å’Œä»»ä½•ä¸€ä¸ªé™Œç”Ÿäººä¹‹é—´æ‰€é—´éš”çš„äººä¸ä¼šè¶…è¿‡å…­ä¸ªï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæœ€å¤šé€šè¿‡å…­ä¸ªäººä½ å°±èƒ½å¤Ÿè®¤è¯†ä»»ä½•ä¸€ä¸ªé™Œç”Ÿäººã€‚ æ•°å­¦è§£é‡Šè¯¥ç†è®ºï¼šè‹¥æ¯ä¸ªäººå¹³å‡è®¤è¯†260äººï¼Œå…¶å…­åº¦å°±æ˜¯260â†‘6 =1,188,137,600,000ã€‚æ¶ˆé™¤ä¸€äº›èŠ‚ç‚¹é‡å¤ï¼Œé‚£ä¹Ÿå‡ ä¹è¦†ç›–äº†æ•´ä¸ªåœ°çƒäººå£è‹¥å¹²å¤šå¤šå€ï¼Œè¿™ä¹Ÿæ˜¯Gossipåè®®çš„é›å½¢ã€‚ åŸç† Gossipåè®®åŸºæœ¬æ€æƒ³å°±æ˜¯ï¼šä¸€ä¸ªèŠ‚ç‚¹æƒ³è¦åˆ†äº«ä¸€äº›ä¿¡æ¯ç»™ç½‘ç»œä¸­çš„å…¶ä»–çš„ä¸€äº›èŠ‚ç‚¹ã€‚äºæ˜¯ï¼Œå®ƒå‘¨æœŸæ€§çš„éšæœºé€‰æ‹©ä¸€äº›èŠ‚ç‚¹ï¼Œå¹¶æŠŠä¿¡æ¯ä¼ é€’ç»™è¿™äº›èŠ‚ç‚¹ã€‚è¿™äº›æ”¶åˆ°ä¿¡æ¯çš„èŠ‚ç‚¹æ¥ä¸‹æ¥ä¼šåšåŒæ ·çš„äº‹æƒ…ï¼Œå³æŠŠè¿™äº›ä¿¡æ¯ä¼ é€’ç»™å…¶ä»–ä¸€äº›éšæœºé€‰æ‹©çš„èŠ‚ç‚¹ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œä¿¡æ¯ä¼šå‘¨æœŸæ€§çš„ä¼ é€’ç»™Nä¸ªç›®æ ‡èŠ‚ç‚¹ï¼Œè€Œä¸åªæ˜¯ä¸€ä¸ªã€‚è¿™ä¸ªNè¢«ç§°ä¸ºfanoutï¼ˆè¿™ä¸ªå•è¯çš„æœ¬æ„æ˜¯æ‰‡å‡ºï¼‰ã€‚ ç”¨é€” Gossipåè®®çš„ä¸»è¦ç”¨é€”å°±æ˜¯ä¿¡æ¯ä¼ æ’­å’Œæ‰©æ•£ï¼šå³æŠŠä¸€äº›å‘ç”Ÿçš„äº‹ä»¶ä¼ æ’­åˆ°å…¨ä¸–ç•Œã€‚å®ƒä»¬ä¹Ÿè¢«ç”¨äºæ•°æ®åº“å¤åˆ¶ï¼Œä¿¡æ¯æ‰©æ•£ï¼Œé›†ç¾¤æˆå‘˜èº«ä»½ç¡®è®¤ï¼Œæ•…éšœæ¢æµ‹ç­‰ã€‚ åŸºäºGossipåè®®çš„ä¸€äº›æœ‰åçš„ç³»ç»Ÿï¼šApache Cassandraï¼ŒRedisï¼ˆClusteræ¨¡å¼ï¼‰ï¼ŒConsulç­‰ã€‚ å›¾è§£ æ¥ä¸‹æ¥é€šè¿‡å¤šå¼ å›¾ç‰‡å‰–æGossipåè®®æ˜¯å¦‚ä½•è¿è¡Œçš„ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒGossipåè®®æ˜¯å‘¨æœŸå¾ªç¯æ‰§è¡Œçš„ã€‚å›¾ä¸­çš„å…¬å¼è¡¨ç¤ºGossipåè®®æŠŠä¿¡æ¯ä¼ æ’­åˆ°æ¯ä¸€ä¸ªèŠ‚ç‚¹éœ€è¦å¤šå°‘æ¬¡å¾ªç¯åŠ¨ä½œï¼Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œå…¬å¼ä¸­çš„20è¡¨ç¤ºæ•´ä¸ªé›†ç¾¤æœ‰20ä¸ªèŠ‚ç‚¹ï¼Œ4è¡¨ç¤ºæŸä¸ªèŠ‚ç‚¹ä¼šå‘4ä¸ªç›®æ ‡èŠ‚ç‚¹ä¼ æ’­æ¶ˆæ¯ï¼š Gossip Protocol å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œçº¢è‰²çš„èŠ‚ç‚¹è¡¨ç¤ºå…¶å·²ç»â€œå—åˆ°æ„ŸæŸ“â€ï¼Œå³æ¥ä¸‹æ¥è¦ä¼ æ’­ä¿¡æ¯çš„æºå¤´ï¼Œè¿çº¿è¡¨ç¤ºè¿™ä¸ªåˆå§‹åŒ–æ„ŸæŸ“çš„èŠ‚ç‚¹èƒ½æ­£å¸¸è¿æ¥çš„èŠ‚ç‚¹ï¼ˆå…¶ä¸èƒ½è¿æ¥çš„èŠ‚ç‚¹åªèƒ½é æ¥ä¸‹æ¥æ„ŸæŸ“çš„èŠ‚ç‚¹å‘å…¶ä¼ æ’­æ¶ˆæ¯ï¼‰ã€‚å¹¶ä¸”Nç­‰äº4ï¼Œæˆ‘ä»¬å‡è®¾4æ ¹è¾ƒç²—çš„çº¿è·¯ï¼Œå°±æ˜¯å®ƒç¬¬ä¸€æ¬¡ä¼ æ’­æ¶ˆæ¯çš„çº¿è·¯ï¼š first infected node ç¬¬ä¸€æ¬¡æ¶ˆæ¯å®Œæˆä¼ æ’­åï¼Œæ–°å¢äº†4ä¸ªèŠ‚ç‚¹ä¼šè¢«â€œæ„ŸæŸ“â€ï¼Œå³è¿™4ä¸ªèŠ‚ç‚¹ä¹Ÿæ”¶åˆ°äº†æ¶ˆæ¯ã€‚è¿™æ—¶å€™ï¼Œæ€»è®¡æœ‰5ä¸ªèŠ‚ç‚¹å˜æˆçº¢è‰²ï¼š infected nodes é‚£ä¹ˆåœ¨ä¸‹ä¸€æ¬¡ä¼ æ’­å‘¨æœŸæ—¶ï¼Œæ€»è®¡æœ‰5ä¸ªèŠ‚ç‚¹ï¼Œä¸”è¿™5ä¸ªèŠ‚ç‚¹æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šå‘4ä¸ªèŠ‚ç‚¹ä¼ æ’­æ¶ˆæ¯ã€‚æœ€åï¼Œç»è¿‡3æ¬¡å¾ªç¯ï¼Œ20ä¸ªèŠ‚ç‚¹å…¨éƒ¨è¢«æ„ŸæŸ“ï¼ˆéƒ½å˜æˆçº¢è‰²èŠ‚ç‚¹ï¼‰ï¼Œå³è¯´æ˜éœ€è¦ä¼ æ’­çš„æ¶ˆæ¯å·²ç»ä¼ æ’­ç»™äº†æ‰€æœ‰èŠ‚ç‚¹ï¼š infected all nodes éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œ20ä¸ªèŠ‚ç‚¹ä¸”è®¾ç½®fanout=4ï¼Œå…¬å¼ç»“æœæ˜¯2.16ï¼Œè¿™åªæ˜¯ä¸ªè¿‘ä¼¼å€¼ã€‚çœŸå®ä¼ é€’æ—¶ï¼Œå¯èƒ½éœ€è¦3æ¬¡ç”šè‡³4æ¬¡å¾ªç¯æ‰èƒ½è®©æ‰€æœ‰èŠ‚ç‚¹æ”¶åˆ°æ¶ˆæ¯ã€‚è¿™æ˜¯å› ä¸ºæ¯ä¸ªèŠ‚ç‚¹åœ¨ä¼ æ’­æ¶ˆæ¯çš„æ—¶å€™ï¼Œæ˜¯éšæœºé€‰æ‹©Nä¸ªèŠ‚ç‚¹çš„ï¼Œè¿™æ ·çš„è¯ï¼Œå°±æœ‰å¯èƒ½æŸä¸ªèŠ‚ç‚¹ä¼šè¢«é€‰ä¸­2æ¬¡ç”šè‡³æ›´å¤šæ¬¡ã€‚ å‘é€æ¶ˆæ¯ ç”±å‰é¢å¯¹Gossipåè®®å›¾è§£åˆ†æå¯çŸ¥ï¼ŒèŠ‚ç‚¹ä¼ æ’­æ¶ˆæ¯æ˜¯å‘¨æœŸæ€§çš„ï¼Œå¹¶ä¸”æ¯ä¸ªèŠ‚ç‚¹æœ‰å®ƒè‡ªå·±çš„å‘¨æœŸã€‚å¦å¤–ï¼ŒèŠ‚ç‚¹å‘é€æ¶ˆæ¯æ—¶çš„ç›®æ ‡èŠ‚ç‚¹æ•°ç”±å‚æ•°fanoutå†³å®šã€‚è‡³äºå¾€å“ªäº›ç›®æ ‡èŠ‚ç‚¹å‘é€ï¼Œåˆ™æ˜¯éšæœºçš„ã€‚ ä¸€æ—¦æ¶ˆæ¯è¢«å‘é€åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œé‚£ä¹ˆç›®æ ‡èŠ‚ç‚¹ä¹Ÿä¼šè¢«æ„ŸæŸ“ã€‚ä¸€æ—¦æŸä¸ªèŠ‚ç‚¹è¢«æ„ŸæŸ“ï¼Œé‚£ä¹ˆå®ƒä¹Ÿä¼šå‘å…¶ä»–èŠ‚ç‚¹ä¼ æ’­æ¶ˆæ¯ï¼Œè¯•å›¾æ„ŸæŸ“æ›´å¤šçš„èŠ‚ç‚¹ã€‚æœ€ç»ˆï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½ä¼šè¢«æ„ŸæŸ“ï¼Œå³æ¶ˆæ¯è¢«åŒæ­¥ç»™äº†æ‰€æœ‰èŠ‚ç‚¹ï¼š å¯æ‰©å±•æ€§ Gossipåè®®æ˜¯å¯æ‰©å±•çš„ï¼Œå› ä¸ºå®ƒåªéœ€è¦O(logN) ä¸ªå‘¨æœŸå°±èƒ½æŠŠæ¶ˆæ¯ä¼ æ’­ç»™æ‰€æœ‰èŠ‚ç‚¹ã€‚æŸä¸ªèŠ‚ç‚¹åœ¨å¾€å›ºå®šæ•°é‡èŠ‚ç‚¹ä¼ æ’­æ¶ˆæ¯è¿‡ç¨‹ä¸­ï¼Œå¹¶ä¸éœ€è¦ç­‰å¾…ç¡®è®¤ï¼ˆackï¼‰ï¼Œå¹¶ä¸”ï¼Œå³ä½¿æŸæ¡æ¶ˆæ¯ä¼ æ’­è¿‡ç¨‹ä¸­ä¸¢å¤±ï¼Œå®ƒä¹Ÿä¸éœ€è¦åšä»»ä½•è¡¥å¿æªæ–½ã€‚æ‰“ä¸ªæ¯”æ–¹ï¼ŒæŸä¸ªèŠ‚ç‚¹æœ¬æ¥éœ€è¦å°†æ¶ˆæ¯ä¼ æ’­ç»™4ä¸ªèŠ‚ç‚¹ï¼Œä½†æ˜¯ç”±äºç½‘ç»œæˆ–è€…å…¶ä»–åŸå› ï¼Œåªæœ‰3ä¸ªæ¶ˆæ¯æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œå³ä½¿è¿™æ ·ï¼Œè¿™å¯¹æœ€ç»ˆæ‰€æœ‰èŠ‚ç‚¹æ¥æ”¶åˆ°æ¶ˆæ¯æ˜¯æ²¡æœ‰ä»»ä½•å½±å“çš„ã€‚ å¦‚ä¸‹è¡¨æ ¼æ‰€ç¤ºï¼Œå‡å®šfanout=4ï¼Œé‚£ä¹ˆåœ¨èŠ‚ç‚¹æ•°åˆ†åˆ«æ˜¯20ã€40ã€80ã€160æ—¶ï¼Œæ¶ˆæ¯ä¼ æ’­åˆ°æ‰€æœ‰èŠ‚ç‚¹éœ€è¦çš„å¾ªç¯æ¬¡æ•°å¯¹æ¯”ï¼Œåœ¨èŠ‚ç‚¹æˆå€æ‰©å¤§çš„æƒ…å†µä¸‹ï¼Œå¾ªç¯æ¬¡æ•°å¹¶æ²¡æœ‰å¢åŠ å¾ˆå¤šã€‚æ‰€ä»¥ï¼ŒGossipåè®®å…·å¤‡å¯æ‰©å±•æ€§ï¼š å¤±è´¥å®¹é”™ Gossipä¹Ÿå…·å¤‡å¤±è´¥å®¹é”™çš„èƒ½åŠ›ï¼Œå³ä½¿ç½‘ç»œæ•…éšœç­‰ä¸€äº›é—®é¢˜ï¼ŒGossipåè®®ä¾ç„¶èƒ½å¾ˆå¥½çš„è¿è¡Œã€‚å› ä¸ºä¸€ä¸ªèŠ‚ç‚¹ä¼šå¤šæ¬¡åˆ†äº«æŸä¸ªéœ€è¦ä¼ æ’­çš„ä¿¡æ¯ï¼Œå³ä½¿ä¸èƒ½è¿é€šæŸä¸ªèŠ‚ç‚¹ï¼Œå…¶ä»–è¢«æ„ŸæŸ“çš„èŠ‚ç‚¹ä¹Ÿä¼šå°è¯•å‘è¿™ä¸ªèŠ‚ç‚¹ä¼ æ’­ä¿¡æ¯ã€‚ å¥å£®æ€§ Gossipåè®®ä¸‹ï¼Œæ²¡æœ‰ä»»ä½•æ‰®æ¼”ç‰¹æ®Šè§’è‰²çš„èŠ‚ç‚¹ï¼ˆæ¯”å¦‚leaderç­‰ï¼‰ã€‚ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹æ— è®ºä»€ä¹ˆæ—¶å€™ä¸‹çº¿æˆ–è€…åŠ å…¥ï¼Œå¹¶ä¸ä¼šç ´åæ•´ä¸ªç³»ç»Ÿçš„æœåŠ¡è´¨é‡ã€‚ ç„¶è€Œï¼ŒGossipåè®®ä¹Ÿæœ‰ä¸å®Œç¾çš„åœ°æ–¹ï¼Œä¾‹å¦‚ï¼Œæ‹œå åº­é—®é¢˜ï¼ˆByzantineï¼‰ã€‚å³ï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ¶æ„ä¼ æ’­æ¶ˆæ¯çš„èŠ‚ç‚¹ï¼ŒGossipåè®®çš„åˆ†å¸ƒå¼ç³»ç»Ÿå°±ä¼šå‡ºé—®é¢˜ã€‚ ä½œè€…ï¼šé˜¿é£çš„åšå®¢ åŸæ–‡åœ°å€ï¼šhttps://www.jianshu.com/p/54eab117e6ae ","link":"https://tianxiawuhao.github.io/BmWrFaJAQ/"},{"title":"CAP/BASE","content":"CAPåŸåˆ™ CAPåŸåˆ™åˆç§°CAPå®šç†ï¼ŒæŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œ Consistencyï¼ˆä¸€è‡´æ€§ï¼‰ã€ Availabilityï¼ˆå¯ç”¨æ€§ï¼‰ã€Partition toleranceï¼ˆåˆ†åŒºå®¹é”™æ€§ï¼‰ï¼Œä¸‰è€…ä¸å¯å¾—å…¼ã€‚ CAPåŸåˆ™æ˜¯NOSQLæ•°æ®åº“çš„åŸºçŸ³ã€‚ åˆ†å¸ƒå¼ç³»ç»Ÿçš„CAPç†è®ºï¼šç†è®ºé¦–å…ˆæŠŠåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ä¸‰ä¸ªç‰¹æ€§è¿›è¡Œäº†å¦‚ä¸‹å½’çº³ï¼š ä¸€è‡´æ€§ï¼ˆCï¼‰ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ‰€æœ‰æ•°æ®å¤‡ä»½ï¼Œåœ¨åŒä¸€æ—¶åˆ»æ˜¯å¦åŒæ ·çš„å€¼ã€‚ï¼ˆç­‰åŒäºæ‰€æœ‰èŠ‚ç‚¹è®¿é—®åŒä¸€ä»½æœ€æ–°çš„æ•°æ®å‰¯æœ¬ï¼‰ å¯ç”¨æ€§ï¼ˆAï¼‰ï¼šåœ¨é›†ç¾¤ä¸­ä¸€éƒ¨åˆ†èŠ‚ç‚¹æ•…éšœåï¼Œé›†ç¾¤æ•´ä½“æ˜¯å¦è¿˜èƒ½å“åº”å®¢æˆ·ç«¯çš„è¯»å†™è¯·æ±‚ã€‚ï¼ˆå¯¹æ•°æ®æ›´æ–°å…·å¤‡é«˜å¯ç”¨æ€§ï¼‰ åˆ†åŒºå®¹å¿æ€§ï¼ˆPï¼‰ï¼šä»¥å®é™…æ•ˆæœè€Œè¨€ï¼Œåˆ†åŒºç›¸å½“äºå¯¹é€šä¿¡çš„æ—¶é™è¦æ±‚ã€‚ç³»ç»Ÿå¦‚æœä¸èƒ½åœ¨æ—¶é™å†…è¾¾æˆæ•°æ®æ­£å¸¸è¿”å›ï¼Œå°±æ„å‘³ç€å‘ç”Ÿäº†åˆ†åŒºçš„æƒ…å†µï¼Œå¿…é¡»å°±å½“å‰æ“ä½œåœ¨Cå’ŒAä¹‹é—´åšå‡ºé€‰æ‹©ã€‚ ä¸€è‡´æ€§ä¸å¯ç”¨æ€§çš„å†³æ‹©ç¼–è¾‘ CAPç†è®ºå°±æ˜¯è¯´åœ¨åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿä¸­ï¼Œæœ€å¤šåªèƒ½å®ç°ä¸Šé¢çš„ä¸¤ç‚¹ã€‚è€Œç”±äºå½“å‰çš„ç½‘ç»œç¡¬ä»¶è‚¯å®šä¼šå‡ºç°å»¶è¿Ÿä¸¢åŒ…ç­‰é—®é¢˜ï¼Œæ‰€ä»¥åˆ†åŒºå®¹å¿æ€§æ˜¯æˆ‘ä»¬å¿…é¡»éœ€è¦å®ç°çš„ã€‚æ‰€ä»¥æˆ‘ä»¬åªèƒ½åœ¨ä¸€è‡´æ€§å’Œå¯ç”¨æ€§ä¹‹é—´è¿›è¡Œæƒè¡¡ï¼Œæ²¡æœ‰NoSQLç³»ç»Ÿèƒ½åŒæ—¶ä¿è¯è¿™ä¸‰ç‚¹ã€‚ å¯¹äºweb2.0ç½‘ç«™æ¥è¯´ï¼Œå…³ç³»æ•°æ®åº“çš„å¾ˆå¤šä¸»è¦ç‰¹æ€§å´å¾€å¾€æ— ç”¨æ­¦ä¹‹åœ° æ•°æ®åº“äº‹åŠ¡ä¸€è‡´æ€§éœ€æ±‚ å¾ˆå¤šwebå®æ—¶ç³»ç»Ÿå¹¶ä¸è¦æ±‚ä¸¥æ ¼çš„æ•°æ®åº“äº‹åŠ¡ï¼Œå¯¹è¯»ä¸€è‡´æ€§çš„è¦æ±‚å¾ˆä½ï¼Œæœ‰äº›åœºåˆå¯¹å†™ä¸€è‡´æ€§è¦æ±‚å¹¶ä¸é«˜ã€‚å…è®¸å®ç°æœ€ç»ˆä¸€è‡´æ€§ã€‚ æ•°æ®åº“çš„å†™å®æ—¶æ€§å’Œè¯»å®æ—¶æ€§éœ€æ±‚ å¯¹å…³ç³»æ•°æ®åº“æ¥è¯´ï¼Œæ’å…¥ä¸€æ¡æ•°æ®ä¹‹åç«‹åˆ»æŸ¥è¯¢ï¼Œæ˜¯è‚¯å®šå¯ä»¥è¯»å‡ºæ¥è¿™æ¡æ•°æ®çš„ï¼Œä½†æ˜¯å¯¹äºå¾ˆå¤šwebåº”ç”¨æ¥è¯´ï¼Œå¹¶ä¸è¦æ±‚è¿™ä¹ˆé«˜çš„å®æ—¶æ€§ï¼Œæ¯”æ–¹è¯´å‘ä¸€æ¡æ¶ˆæ¯ä¹‹ åï¼Œè¿‡å‡ ç§’ä¹ƒè‡³åå‡ ç§’ä¹‹åï¼Œæˆ‘çš„è®¢é˜…è€…æ‰çœ‹åˆ°è¿™æ¡åŠ¨æ€æ˜¯å®Œå…¨å¯ä»¥æ¥å—çš„ã€‚ å¯¹å¤æ‚çš„SQLæŸ¥è¯¢ï¼Œç‰¹åˆ«æ˜¯å¤šè¡¨å…³è”æŸ¥è¯¢çš„éœ€æ±‚ ä»»ä½•å¤§æ•°æ®é‡çš„webç³»ç»Ÿï¼Œéƒ½éå¸¸å¿Œè®³å¤šä¸ªå¤§è¡¨çš„å…³è”æŸ¥è¯¢ï¼Œä»¥åŠå¤æ‚çš„æ•°æ®åˆ†æç±»å‹çš„æŠ¥è¡¨æŸ¥è¯¢ï¼Œç‰¹åˆ«æ˜¯SNSç±»å‹çš„ç½‘ç«™ï¼Œä»éœ€æ±‚ä»¥åŠäº§å“è®¾è®¡è§’ åº¦ï¼Œå°±é¿å…äº†è¿™ç§æƒ…å†µçš„äº§ç”Ÿã€‚å¾€å¾€æ›´å¤šçš„åªæ˜¯å•è¡¨çš„ä¸»é”®æŸ¥è¯¢ï¼Œä»¥åŠå•è¡¨çš„ç®€å•æ¡ä»¶åˆ†é¡µæŸ¥è¯¢ï¼ŒSQLçš„åŠŸèƒ½è¢«æå¤§çš„å¼±åŒ–äº†ã€‚ CAPå®šç†çš„è¯æ˜ ç°åœ¨æˆ‘ä»¬å°±æ¥è¯æ˜ä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆä¸èƒ½åŒæ—¶æ»¡è¶³ä¸‰ä¸ªç‰¹æ€§ï¼Ÿ å‡è®¾æœ‰ä¸¤å°æœåŠ¡å™¨ï¼Œä¸€å°æ”¾ç€åº”ç”¨Aå’Œæ•°æ®åº“Vï¼Œä¸€å°æ”¾ç€åº”ç”¨Bå’Œæ•°æ®åº“Vï¼Œä»–ä»¬ä¹‹é—´çš„ç½‘ç»œå¯ä»¥äº’é€šï¼Œä¹Ÿå°±ç›¸å½“äºåˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸¤ä¸ªéƒ¨åˆ†ã€‚ åœ¨æ»¡è¶³ä¸€è‡´æ€§çš„æ—¶å€™ï¼Œä¸¤å°æœåŠ¡å™¨ N1å’ŒN2ï¼Œä¸€å¼€å§‹ä¸¤å°æœåŠ¡å™¨çš„æ•°æ®æ˜¯ä¸€æ ·çš„ï¼ŒDB0=DB0ã€‚åœ¨æ»¡è¶³å¯ç”¨æ€§çš„æ—¶å€™ï¼Œç”¨æˆ·ä¸ç®¡æ˜¯è¯·æ±‚N1æˆ–è€…N2ï¼Œéƒ½ä¼šå¾—åˆ°ç«‹å³å“åº”ã€‚åœ¨æ»¡è¶³åˆ†åŒºå®¹é”™æ€§çš„æƒ…å†µä¸‹ï¼ŒN1å’ŒN2æœ‰ä»»ä½•ä¸€æ–¹å®•æœºï¼Œæˆ–è€…ç½‘ç»œä¸é€šçš„æ—¶å€™ï¼Œéƒ½ä¸ä¼šå½±å“N1å’ŒN2å½¼æ­¤ä¹‹é—´çš„æ­£å¸¸è¿ä½œã€‚ å½“ç”¨æˆ·é€šè¿‡N1ä¸­çš„Aåº”ç”¨è¯·æ±‚æ•°æ®æ›´æ–°åˆ°æœåŠ¡å™¨DB0åï¼Œè¿™æ—¶N1ä¸­çš„æœåŠ¡å™¨DB0å˜ä¸ºDB1ï¼Œé€šè¿‡åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ•°æ®åŒæ­¥æ›´æ–°æ“ä½œï¼ŒN2æœåŠ¡å™¨ä¸­çš„æ•°æ®åº“V0ä¹Ÿæ›´æ–°ä¸ºäº†DB1ï¼Œè¿™æ—¶ï¼Œç”¨æˆ·é€šè¿‡Bå‘æ•°æ®åº“å‘èµ·è¯·æ±‚å¾—åˆ°çš„æ•°æ®å°±æ˜¯å³æ—¶æ›´æ–°åçš„æ•°æ®DB1ã€‚ ä¸Šé¢æ˜¯æ­£å¸¸è¿ä½œçš„æƒ…å†µï¼Œä½†åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæœ€å¤§çš„é—®é¢˜å°±æ˜¯ç½‘ç»œä¼ è¾“é—®é¢˜ï¼Œç°åœ¨å‡è®¾ä¸€ç§æç«¯æƒ…å†µï¼ŒN1å’ŒN2ä¹‹é—´çš„ç½‘ç»œæ–­å¼€äº†ï¼Œä½†æˆ‘ä»¬ä»è¦æ”¯æŒè¿™ç§ç½‘ç»œå¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯æ»¡è¶³åˆ†åŒºå®¹é”™æ€§ï¼Œé‚£ä¹ˆè¿™æ ·èƒ½ä¸èƒ½åŒæ—¶æ»¡è¶³ä¸€è‡´æ€§å’Œå¯ç”¨æ€§å‘¢ï¼Ÿ å‡è®¾N1å’ŒN2ä¹‹é—´é€šä¿¡çš„æ—¶å€™ç½‘ç»œçªç„¶å‡ºç°æ•…éšœï¼Œæœ‰ç”¨æˆ·å‘N1å‘é€æ•°æ®æ›´æ–°è¯·æ±‚ï¼Œé‚£N1ä¸­çš„æ•°æ®DB0å°†è¢«æ›´æ–°ä¸ºDB1ï¼Œç”±äºç½‘ç»œæ˜¯æ–­å¼€çš„ï¼ŒN2ä¸­çš„æ•°æ®åº“ä»æ—§æ˜¯DB0ï¼› å¦‚æœè¿™ä¸ªæ—¶å€™ï¼Œæœ‰ç”¨æˆ·å‘N2å‘é€æ•°æ®è¯»å–è¯·æ±‚ï¼Œç”±äºæ•°æ®è¿˜æ²¡æœ‰è¿›è¡ŒåŒæ­¥ï¼Œåº”ç”¨ç¨‹åºæ²¡åŠæ³•ç«‹å³ç»™ç”¨æˆ·è¿”å›æœ€æ–°çš„æ•°æ®DB1ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿæœ‰äºŒç§é€‰æ‹©ï¼Œç¬¬ä¸€ï¼Œç‰ºç‰²æ•°æ®ä¸€è‡´æ€§ï¼Œå“åº”æ—§çš„æ•°æ®DB0ç»™ç”¨æˆ·ï¼›ç¬¬äºŒï¼Œç‰ºç‰²å¯ç”¨æ€§ï¼Œé˜»å¡ç­‰å¾…ï¼Œç›´åˆ°ç½‘ç»œè¿æ¥æ¢å¤ï¼Œæ•°æ®æ›´æ–°æ“ä½œå®Œæˆä¹‹åï¼Œå†ç»™ç”¨æˆ·å“åº”æœ€æ–°çš„æ•°æ®DB1ã€‚ ä¸Šé¢çš„è¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œä½†ä¹Ÿè¯´æ˜äº†è¦æ»¡è¶³åˆ†åŒºå®¹é”™æ€§çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œåªèƒ½åœ¨ä¸€è‡´æ€§å’Œå¯ç”¨æ€§ä¸¤è€…ä¸­ï¼Œé€‰æ‹©å…¶ä¸­ä¸€ä¸ªã€‚ä¹Ÿå°±æ˜¯è¯´åˆ†å¸ƒå¼ç³»ç»Ÿä¸å¯èƒ½åŒæ—¶æ»¡è¶³ä¸‰ä¸ªç‰¹æ€§ã€‚è¿™å°±éœ€è¦æˆ‘ä»¬åœ¨æ­å»ºç³»ç»Ÿæ—¶è¿›è¡Œå–èˆäº†ï¼Œé‚£ä¹ˆï¼Œæ€ä¹ˆå–èˆæ‰æ˜¯æ›´å¥½çš„ç­–ç•¥å‘¢? å–èˆç­–ç•¥ CAPä¸‰ä¸ªç‰¹æ€§åªèƒ½æ»¡è¶³å…¶ä¸­ä¸¤ä¸ªï¼Œé‚£ä¹ˆå–èˆçš„ç­–ç•¥å°±å…±æœ‰ä¸‰ç§ï¼š CA without Pï¼š å¦‚æœä¸è¦æ±‚Pï¼ˆä¸å…è®¸åˆ†åŒºï¼‰ï¼Œåˆ™Cï¼ˆå¼ºä¸€è‡´æ€§ï¼‰å’ŒAï¼ˆå¯ç”¨æ€§ï¼‰æ˜¯å¯ä»¥ä¿è¯çš„ã€‚ä½†æ”¾å¼ƒPçš„åŒæ—¶ä¹Ÿå°±æ„å‘³ç€æ”¾å¼ƒäº†ç³»ç»Ÿçš„æ‰©å±•æ€§ï¼Œä¹Ÿå°±æ˜¯åˆ†å¸ƒå¼èŠ‚ç‚¹å—é™ï¼Œæ²¡åŠæ³•éƒ¨ç½²å­èŠ‚ç‚¹ï¼Œè¿™æ˜¯è¿èƒŒåˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡çš„åˆè¡·çš„ã€‚ä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“RDBMSï¼šOracleã€MySQLå°±æ˜¯CAã€‚ CP without Aï¼š å¦‚æœä¸è¦æ±‚Aï¼ˆå¯ç”¨ï¼‰ï¼Œç›¸å½“äºæ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦åœ¨æœåŠ¡å™¨ä¹‹é—´ä¿æŒå¼ºä¸€è‡´ï¼Œè€ŒPï¼ˆåˆ†åŒºï¼‰ä¼šå¯¼è‡´åŒæ­¥æ—¶é—´æ— é™å»¶é•¿(ä¹Ÿå°±æ˜¯ç­‰å¾…æ•°æ®åŒæ­¥å®Œæ‰èƒ½æ­£å¸¸è®¿é—®æœåŠ¡)ï¼Œä¸€æ—¦å‘ç”Ÿç½‘ç»œæ•…éšœæˆ–è€…æ¶ˆæ¯ä¸¢å¤±ç­‰æƒ…å†µï¼Œå°±è¦ç‰ºç‰²ç”¨æˆ·çš„ä½“éªŒï¼Œç­‰å¾…æ‰€æœ‰æ•°æ®å…¨éƒ¨ä¸€è‡´äº†ä¹‹åå†è®©ç”¨æˆ·è®¿é—®ç³»ç»Ÿã€‚è®¾è®¡æˆCPçš„ç³»ç»Ÿå…¶å®ä¸å°‘ï¼Œæœ€å…¸å‹çš„å°±æ˜¯åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œå¦‚Redisã€HBaseç­‰ã€‚å¯¹äºè¿™äº›åˆ†å¸ƒå¼æ•°æ®åº“æ¥è¯´ï¼Œæ•°æ®çš„ä¸€è‡´æ€§æ˜¯æœ€åŸºæœ¬çš„è¦æ±‚ï¼Œå› ä¸ºå¦‚æœè¿è¿™ä¸ªæ ‡å‡†éƒ½è¾¾ä¸åˆ°ï¼Œé‚£ä¹ˆç›´æ¥é‡‡ç”¨å…³ç³»å‹æ•°æ®åº“å°±å¥½ï¼Œæ²¡å¿…è¦å†æµªè´¹èµ„æºæ¥éƒ¨ç½²åˆ†å¸ƒå¼æ•°æ®åº“ã€‚ AP wihtout Cï¼š è¦é«˜å¯ç”¨å¹¶å…è®¸åˆ†åŒºï¼Œåˆ™éœ€æ”¾å¼ƒä¸€è‡´æ€§ã€‚ä¸€æ—¦åˆ†åŒºå‘ç”Ÿï¼ŒèŠ‚ç‚¹ä¹‹é—´å¯èƒ½ä¼šå¤±å»è”ç³»ï¼Œä¸ºäº†é«˜å¯ç”¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹åªèƒ½ç”¨æœ¬åœ°æ•°æ®æä¾›æœåŠ¡ï¼Œè€Œè¿™æ ·ä¼šå¯¼è‡´å…¨å±€æ•°æ®çš„ä¸ä¸€è‡´æ€§ã€‚å…¸å‹çš„åº”ç”¨å°±å¦‚æŸç±³çš„æŠ¢è´­æ‰‹æœºåœºæ™¯ï¼Œå¯èƒ½å‰å‡ ç§’ä½ æµè§ˆå•†å“çš„æ—¶å€™é¡µé¢æç¤ºæ˜¯æœ‰åº“å­˜çš„ï¼Œå½“ä½ é€‰æ‹©å®Œå•†å“å‡†å¤‡ä¸‹å•çš„æ—¶å€™ï¼Œç³»ç»Ÿæç¤ºä½ ä¸‹å•å¤±è´¥ï¼Œå•†å“å·²å”®å®Œã€‚è¿™å…¶å®å°±æ˜¯å…ˆåœ¨ Aï¼ˆå¯ç”¨æ€§ï¼‰æ–¹é¢ä¿è¯ç³»ç»Ÿå¯ä»¥æ­£å¸¸çš„æœåŠ¡ï¼Œç„¶ååœ¨æ•°æ®çš„ä¸€è‡´æ€§æ–¹é¢åšäº†äº›ç‰ºç‰²ï¼Œè™½ç„¶å¤šå°‘ä¼šå½±å“ä¸€äº›ç”¨æˆ·ä½“éªŒï¼Œä½†ä¹Ÿä¸è‡³äºé€ æˆç”¨æˆ·è´­ç‰©æµç¨‹çš„ä¸¥é‡é˜»å¡ã€‚ BASEç†è®º BASEæ˜¯Basically Availableï¼ˆåŸºæœ¬å¯ç”¨ï¼‰ã€Soft stateï¼ˆè½¯çŠ¶æ€ï¼‰å’ŒEventually consistentï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰ä¸‰ä¸ªçŸ­è¯­çš„ç®€å†™ï¼ŒBASEæ˜¯å¯¹CAPä¸­ä¸€è‡´æ€§å’Œå¯ç”¨æ€§æƒè¡¡çš„ç»“æœï¼Œå…¶æ¥æºäºå¯¹å¤§è§„æ¨¡äº’è”ç½‘ç³»ç»Ÿåˆ†å¸ƒå¼å®è·µçš„ç»“è®ºï¼Œæ˜¯åŸºäºCAPå®šç†é€æ­¥æ¼”åŒ–è€Œæ¥çš„ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯å³ä½¿æ— æ³•åšåˆ°å¼ºä¸€è‡´æ€§ï¼ˆStrong consistencyï¼‰ï¼Œä½†æ¯ä¸ªåº”ç”¨éƒ½å¯ä»¥æ ¹æ®è‡ªèº«çš„ä¸šåŠ¡ç‰¹ç‚¹ï¼Œé‡‡ç”¨é€‚å½“çš„æ–¹å¼æ¥ä½¿ç³»ç»Ÿè¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ï¼ˆEventual consistencyï¼‰ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ç€é‡å¯¹BASEä¸­çš„ä¸‰è¦ç´ è¿›è¡Œè¯¦ç»†è®²è§£ã€‚ åŸºæœ¬å¯ç”¨ åŸºæœ¬å¯ç”¨æ˜¯æŒ‡åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å‡ºç°ä¸å¯é¢„çŸ¥æ•…éšœçš„æ—¶å€™ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§â€”â€”ä½†è¯·æ³¨æ„ï¼Œè¿™ç»ä¸ç­‰ä»·äºç³»ç»Ÿä¸å¯ç”¨ï¼Œä»¥ä¸‹ä¸¤ä¸ªå°±æ˜¯â€œåŸºæœ¬å¯ç”¨â€çš„å…¸å‹ä¾‹å­ã€‚ å“åº”æ—¶é—´ä¸Šçš„æŸå¤±ï¼šæ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªåœ¨çº¿æœç´¢å¼•æ“éœ€è¦0.5ç§’å†…è¿”å›ç»™ç”¨æˆ·ç›¸åº”çš„æŸ¥è¯¢ç»“æœï¼Œä½†ç”±äºå‡ºç°å¼‚å¸¸ï¼ˆæ¯”å¦‚ç³»ç»Ÿéƒ¨åˆ†æœºæˆ¿å‘ç”Ÿæ–­ç”µæˆ–æ–­ç½‘æ•…éšœï¼‰ï¼ŒæŸ¥è¯¢ç»“æœçš„å“åº”æ—¶é—´å¢åŠ åˆ°äº†1~2ç§’ã€‚ åŠŸèƒ½ä¸Šçš„æŸå¤±ï¼šæ­£å¸¸æƒ…å†µä¸‹ï¼Œåœ¨ä¸€ä¸ªç”µå­å•†åŠ¡ç½‘ç«™ä¸Šè¿›è¡Œè´­ç‰©ï¼Œæ¶ˆè´¹è€…å‡ ä¹èƒ½å¤Ÿé¡ºåˆ©åœ°å®Œæˆæ¯ä¸€ç¬”è®¢å•ï¼Œä½†æ˜¯åœ¨ä¸€äº›èŠ‚æ—¥å¤§ä¿ƒè´­ç‰©é«˜å³°çš„æ—¶å€™ï¼Œç”±äºæ¶ˆè´¹è€…çš„è´­ç‰©è¡Œä¸ºæ¿€å¢ï¼Œä¸ºäº†ä¿æŠ¤è´­ç‰©ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œéƒ¨åˆ†æ¶ˆè´¹è€…å¯èƒ½ä¼šè¢«å¼•å¯¼åˆ°ä¸€ä¸ªé™çº§é¡µé¢ã€‚ å¼±çŠ¶æ€ å¼±çŠ¶æ€ä¹Ÿç§°ä¸ºè½¯çŠ¶æ€ï¼Œå’Œç¡¬çŠ¶æ€ç›¸å¯¹ï¼Œæ˜¯æŒ‡å…è®¸ç³»ç»Ÿä¸­çš„æ•°æ®å­˜åœ¨ä¸­é—´çŠ¶æ€ï¼Œå¹¶è®¤ä¸ºè¯¥ä¸­é—´çŠ¶æ€çš„å­˜åœ¨ä¸ä¼šå½±å“ç³»ç»Ÿçš„æ•´ä½“å¯ç”¨æ€§ï¼Œå³å…è®¸ç³»ç»Ÿåœ¨ä¸åŒèŠ‚ç‚¹çš„æ•°æ®å‰¯æœ¬ä¹‹é—´è¿›è¡Œæ•°æ®åŒæ­¥çš„è¿‡ç¨‹å­˜åœ¨å»¶æ—¶ã€‚ æœ€ç»ˆä¸€è‡´æ€§ æœ€ç»ˆä¸€è‡´æ€§å¼ºè°ƒçš„æ˜¯ç³»ç»Ÿä¸­æ‰€æœ‰çš„æ•°æ®å‰¯æœ¬ï¼Œåœ¨ç»è¿‡ä¸€æ®µæ—¶é—´çš„åŒæ­¥åï¼Œæœ€ç»ˆèƒ½å¤Ÿè¾¾åˆ°ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€ã€‚å› æ­¤ï¼Œæœ€ç»ˆä¸€è‡´æ€§çš„æœ¬è´¨æ˜¯éœ€è¦ç³»ç»Ÿä¿è¯æœ€ç»ˆæ•°æ®èƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´ï¼Œè€Œä¸éœ€è¦å®æ—¶ä¿è¯ç³»ç»Ÿæ•°æ®çš„å¼ºä¸€è‡´æ€§ äºšé©¬é€Šé¦–å¸­æŠ€æœ¯å®˜Werner Vogelsåœ¨äº2008å¹´å‘è¡¨çš„ä¸€ç¯‡æ–‡ç« ä¸­å¯¹æœ€ç»ˆä¸€è‡´æ€§è¿›è¡Œäº†éå¸¸è¯¦ç»†çš„ä»‹ç»ã€‚ä»–è®¤ä¸ºæœ€ç»ˆä¸€è‡´æ€§æ˜¯ä¸€ç§ç‰¹æ®Šçš„å¼±ä¸€è‡´æ€§ï¼šç³»ç»Ÿèƒ½å¤Ÿä¿è¯åœ¨æ²¡æœ‰å…¶ä»–æ–°çš„æ›´æ–°æ“ä½œçš„æƒ…å†µä¸‹ï¼Œæ•°æ®æœ€ç»ˆä¸€å®šèƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´çš„çŠ¶æ€ï¼Œå› æ­¤æ‰€æœ‰å®¢æˆ·ç«¯å¯¹ç³»ç»Ÿçš„æ•°æ®è®¿é—®éƒ½èƒ½å¤Ÿè·å–åˆ°æœ€æ–°çš„å€¼ã€‚åŒæ—¶ï¼Œåœ¨æ²¡æœ‰å‘ç”Ÿæ•…éšœçš„å‰æä¸‹ï¼Œæ•°æ®è¾¾åˆ°ä¸€è‡´çŠ¶æ€çš„æ—¶é—´å»¶è¿Ÿï¼Œå–å†³äºç½‘ç»œå»¶è¿Ÿï¼Œç³»ç»Ÿè´Ÿè½½å’Œæ•°æ®å¤åˆ¶æ–¹æ¡ˆè®¾è®¡ç­‰å› ç´ ã€‚ åœ¨å®é™…å·¥ç¨‹å®è·µä¸­ï¼Œæœ€ç»ˆä¸€è‡´æ€§å­˜åœ¨ä»¥ä¸‹äº”ç±»ä¸»è¦å˜ç§ã€‚ å› æœä¸€è‡´æ€§ï¼š å› æœä¸€è‡´æ€§æ˜¯æŒ‡ï¼Œå¦‚æœè¿›ç¨‹Aåœ¨æ›´æ–°å®ŒæŸä¸ªæ•°æ®é¡¹åé€šçŸ¥äº†è¿›ç¨‹Bï¼Œé‚£ä¹ˆè¿›ç¨‹Bä¹‹åå¯¹è¯¥æ•°æ®é¡¹çš„è®¿é—®éƒ½åº”è¯¥èƒ½å¤Ÿè·å–åˆ°è¿›ç¨‹Aæ›´æ–°åçš„æœ€æ–°å€¼ï¼Œå¹¶ä¸”å¦‚æœè¿›ç¨‹Bè¦å¯¹è¯¥æ•°æ®é¡¹è¿›è¡Œæ›´æ–°æ“ä½œçš„è¯ï¼ŒåŠ¡å¿…åŸºäºè¿›ç¨‹Aæ›´æ–°åçš„æœ€æ–°å€¼ï¼Œå³ä¸èƒ½å‘ç”Ÿä¸¢å¤±æ›´æ–°æƒ…å†µã€‚ä¸æ­¤åŒæ—¶ï¼Œä¸è¿›ç¨‹Aæ— å› æœå…³ç³»çš„è¿›ç¨‹Cçš„æ•°æ®è®¿é—®åˆ™æ²¡æœ‰è¿™æ ·çš„é™åˆ¶ã€‚ è¯»å·±ä¹‹æ‰€å†™ï¼š è¯»å·±ä¹‹æ‰€å†™æ˜¯æŒ‡ï¼Œè¿›ç¨‹Aæ›´æ–°ä¸€ä¸ªæ•°æ®é¡¹ä¹‹åï¼Œå®ƒè‡ªå·±æ€»æ˜¯èƒ½å¤Ÿè®¿é—®åˆ°æ›´æ–°è¿‡çš„æœ€æ–°å€¼ï¼Œè€Œä¸ä¼šçœ‹åˆ°æ—§å€¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºå•ä¸ªæ•°æ®è·å–è€…è€Œè¨€ï¼Œå…¶è¯»å–åˆ°çš„æ•°æ®ä¸€å®šä¸ä¼šæ¯”è‡ªå·±ä¸Šæ¬¡å†™å…¥çš„å€¼æ—§ã€‚å› æ­¤ï¼Œè¯»å·±ä¹‹æ‰€å†™ä¹Ÿå¯ä»¥çœ‹ä½œæ˜¯ä¸€ç§ç‰¹æ®Šçš„å› æœä¸€è‡´æ€§ã€‚ ä¼šè¯ä¸€è‡´æ€§ï¼š ä¼šè¯ä¸€è‡´æ€§å°†å¯¹ç³»ç»Ÿæ•°æ®çš„è®¿é—®è¿‡ç¨‹æ¡†å®šåœ¨äº†ä¸€ä¸ªä¼šè¯å½“ä¸­ï¼šç³»ç»Ÿèƒ½ä¿è¯åœ¨åŒä¸€ä¸ªæœ‰æ•ˆçš„ä¼šè¯ä¸­å®ç°â€œè¯»å·±ä¹‹æ‰€å†™â€çš„ä¸€è‡´æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰§è¡Œæ›´æ–°æ“ä½œä¹‹åï¼Œå®¢æˆ·ç«¯èƒ½å¤Ÿåœ¨åŒä¸€ä¸ªä¼šè¯ä¸­å§‹ç»ˆè¯»å–åˆ°è¯¥æ•°æ®é¡¹çš„æœ€æ–°å€¼ã€‚ å•è°ƒè¯»ä¸€è‡´æ€§ï¼š å•è°ƒè¯»ä¸€è‡´æ€§æ˜¯æŒ‡å¦‚æœä¸€ä¸ªè¿›ç¨‹ä»ç³»ç»Ÿä¸­è¯»å–å‡ºä¸€ä¸ªæ•°æ®é¡¹çš„æŸä¸ªå€¼åï¼Œé‚£ä¹ˆç³»ç»Ÿå¯¹äºè¯¥è¿›ç¨‹åç»­çš„ä»»ä½•æ•°æ®è®¿é—®éƒ½ä¸åº”è¯¥è¿”å›æ›´æ—§çš„å€¼ã€‚ å•è°ƒå†™ä¸€è‡´æ€§ï¼š å•è°ƒå†™ä¸€è‡´æ€§æ˜¯æŒ‡ï¼Œä¸€ä¸ªç³»ç»Ÿéœ€è¦èƒ½å¤Ÿä¿è¯æ¥è‡ªåŒä¸€ä¸ªè¿›ç¨‹çš„å†™æ“ä½œè¢«é¡ºåºåœ°æ‰§è¡Œã€‚ ä»¥ä¸Šå°±æ˜¯æœ€ç»ˆä¸€è‡´æ€§çš„äº”ç±»å¸¸è§çš„å˜ç§ï¼Œåœ¨æ—¶é—´ç³»ç»Ÿå®è·µä¸­ï¼Œå¯ä»¥å°†å…¶ä¸­çš„è‹¥å¹²ä¸ªå˜ç§äº’ç›¸ç»“åˆèµ·æ¥ï¼Œä»¥æ„å»ºä¸€ä¸ªå…·æœ‰æœ€ç»ˆä¸€è‡´æ€§çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚äº‹å®ä¸Šï¼Œå¯ä»¥å°†å…¶ä¸­çš„è‹¥å¹²ä¸ªå˜ç§ç›¸äº’ç»“åˆèµ·æ¥ï¼Œä»¥æ„å»ºä¸€ä¸ªå…·æœ‰æœ€ç»ˆä¸€è‡´æ€§ç‰¹æ€§çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚äº‹å®ä¸Šï¼Œæœ€ç»ˆä¸€è‡´æ€§å¹¶ä¸æ˜¯åªæœ‰é‚£äº›å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿæ‰è®¾è®¡çš„ç‰¹æ€§ï¼Œè®¸å¤šç°ä»£çš„å…³ç³»å‹æ•°æ®åº“éƒ½é‡‡ç”¨äº†æœ€ç»ˆä¸€è‡´æ€§æ¨¡å‹ã€‚åœ¨ç°ä»£å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œå¤§å¤šéƒ½ä¼šé‡‡ç”¨åŒæ­¥å’Œå¼‚æ­¥æ–¹å¼æ¥å®ç°ä¸»å¤‡æ•°æ®å¤åˆ¶æŠ€æœ¯ã€‚åœ¨åŒæ­¥æ–¹å¼ä¸­ï¼Œæ•°æ®çš„å¤åˆ¶å›½è€»é¥é€šå¸¸æ˜¯æ›´æ–°äº‹åŠ¡çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤åœ¨äº‹åŠ¡å®Œæˆåï¼Œä¸»å¤‡æ•°æ®åº“çš„æ•°æ®å°±ä¼šè¾¾åˆ°ä¸€è‡´ã€‚è€Œåœ¨å¼‚æ­¥æ–¹å¼ä¸­ï¼Œå¤‡åº“çš„æ›´æ–°å¾€å¾€å­˜åœ¨å»¶æ—¶ï¼Œè¿™å–å†³äºäº‹åŠ¡æ—¥å¿—åœ¨ä¸»å¤‡æ•°æ®åº“ä¹‹é—´ä¼ è¾“çš„æ—¶é—´é•¿çŸ­ï¼Œå¦‚æœä¼ è¾“æ—¶é—´è¿‡é•¿æˆ–è€…ç”šè‡³åœ¨æ—¥å¿—ä¼ è¾“è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸å¯¼è‡´æ— æ³•åŠæ—¶å°†äº‹åŠ¡åº”ç”¨åˆ°å¤‡åº“ä¸Šï¼Œé‚£ä¹ˆç‹ æ˜¾ç„¶ï¼Œä»å¤‡åº“ä¸­è¯»å–çš„çš„æ•°æ®å°†æ˜¯æ—§çš„ï¼Œå› æ­¤å°±å‡ºç°äº†ä¸ä¸€è‡´çš„æƒ…å†µã€‚å½“ç„¶ï¼Œæ— è®ºæ˜¯é‡‡ç”¨å¤šæ¬¡é‡è¯•è¿˜æ˜¯è®¤ä¸ºæ•°æ®è®¢æ­£ï¼Œå…³ç³»å‹æ•°æ®åº“è¿˜æ˜¯èƒ½æä¿è¯æœ€ç»ˆæ•°æ®è¾¾åˆ°ä¸€è‡´â€”â€”è¿™å°±æ˜¯ç³»ç»Ÿæä¾›æœ€ç»ˆä¸€è‡´æ€§ä¿è¯çš„ç»å…¸æ¡ˆä¾‹ã€‚ æ€»çš„æ¥è¯´ï¼ŒBASEç†è®ºé¢å‘çš„æ˜¯å¤§å‹é«˜å¯ç”¨å¯æ‰©å±•çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå’Œä¼ ç»Ÿäº‹åŠ¡çš„ACIDç‰¹æ€§ä½¿ç›¸åçš„ï¼Œå®ƒå®Œå…¨ä¸åŒäºACIDçš„å¼ºä¸€è‡´æ€§æ¨¡å‹ï¼Œè€Œæ˜¯æå‡ºé€šè¿‡ç‰ºç‰²å¼ºä¸€è‡´æ€§æ¥è·å¾—å¯ç”¨æ€§ï¼Œå¹¶å…è®¸æ•°æ®åœ¨ä¸€æ®µæ—¶é—´å†…æ˜¯ä¸ä¸€è‡´çš„ï¼Œä½†æœ€ç»ˆè¾¾åˆ°ä¸€è‡´çŠ¶æ€ã€‚ä½†åŒæ—¶ï¼Œåœ¨å®é™…çš„åˆ†å¸ƒå¼åœºæ™¯ä¸­ï¼Œä¸åŒä¸šåŠ¡å•å…ƒå’Œç»„ä»¶å¯¹æ•°æ®ä¸€è‡´æ€§çš„è¦æ±‚æ˜¯ä¸åŒçš„ï¼Œå› æ­¤åœ¨å…·ä½“çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„è®¾è®¡è¿‡ç¨‹ä¸­ï¼ŒACIDç‰¹æ€§ä¸BASEç†è®ºå¾€å¾€åˆä¼šç»“åˆåœ¨ä¸€èµ·ä½¿ç”¨ã€‚ ","link":"https://tianxiawuhao.github.io/cxyiXFW2S/"},{"title":"MyBatis ç¼“å­˜è¯¦è§£","content":"ç¼“å­˜æ˜¯ä¸€èˆ¬çš„ORM æ¡†æ¶éƒ½ä¼šæä¾›çš„åŠŸèƒ½ï¼Œç›®çš„å°±æ˜¯æå‡æŸ¥è¯¢çš„æ•ˆç‡å’Œå‡å°‘æ•°æ®åº“çš„å‹åŠ›ã€‚è·ŸHibernate ä¸€æ ·ï¼ŒMyBatis ä¹Ÿæœ‰ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜ï¼Œå¹¶ä¸”é¢„ç•™äº†é›†æˆç¬¬ä¸‰æ–¹ç¼“å­˜çš„æ¥å£ã€‚ ç¼“å­˜ä½“ç³»ç»“æ„ï¼š MyBatis è·Ÿç¼“å­˜ç›¸å…³çš„ç±»éƒ½åœ¨cache åŒ…é‡Œé¢ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªCache æ¥å£ï¼Œåªæœ‰ä¸€ä¸ªé»˜è®¤çš„å®ç°ç±» PerpetualCacheï¼Œå®ƒæ˜¯ç”¨HashMap å®ç°çš„ã€‚ æ‰€æœ‰çš„ç¼“å­˜å®ç°ç±»æ€»ä½“ä¸Šå¯åˆ†ä¸ºä¸‰ç±»ï¼šåŸºæœ¬ç¼“å­˜ã€æ·˜æ±°ç®—æ³•ç¼“å­˜ã€è£…é¥°å™¨ç¼“å­˜ã€‚ ç¼“å­˜å®ç°ç±» æè¿° ä½œç”¨ è£…é¥°æ¡ä»¶ åŸºæœ¬ç¼“å­˜ ç¼“å­˜åŸºæœ¬å®ç°ç±» é»˜è®¤æ˜¯PerpetualCacheï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰æ¯”å¦‚RedisCacheç­‰ï¼Œå…·å¤‡åŸºæœ¬åŠŸèƒ½çš„ç¼“å­˜ç±» æ—  LruCache LRUç­–ç•¥çš„ç¼“å­˜ å½“ç¼“å­˜è¾¾åˆ°ä¸Šé™æ—¶ï¼Œåˆ é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ç¼“å­˜ eviction=â€œLRUâ€ ï¼ˆé»˜è®¤ï¼‰ FifoCache FIFOç­–ç•¥çš„ç¼“å­˜ å½“ç¼“å­˜è¾¾åˆ°ä¸Šé™æ—¶ï¼Œåˆ é™¤æœ€å…ˆå…¥é˜Ÿçš„ç¼“å­˜ eviction=â€œFIFOâ€ SoftCache/WeakCache å¸¦æ¸…ç†ç­–ç•¥çš„ç¼“å­˜ é€šè¿‡JVMçš„è½¯å¼•ç”¨å’Œå¼±å¼•ç”¨æ¥å®ç°ç¼“å­˜ï¼Œå½“JVMå†…å­˜ä¸è¶³æ—¶ï¼Œä¼šè‡ªåŠ¨æ¸…ç†æ‰è¿™äº›ç¼“å­˜ eviction=â€œSOFTâ€/eviction=â€œWEAKâ€ LoggingCache å¸¦æ—¥å¿—åŠŸèƒ½çš„ç¼“å­˜ æ¯”å¦‚è¾“å‡ºç¼“å­˜å‘½ä¸­ç‡ åŸºæœ¬ SynchronizedCache åŒæ­¥ç¼“å­˜ åŸºäºSynchronizedå…³é”®å­—å®ç°ï¼Œè§£å†³å¹¶å‘é—®é¢˜ åŸºæœ¬ BlockingCache é˜»å¡ç¼“å­˜ é€šè¿‡åœ¨get/putæ–¹å¼ä¸­åŠ é”ï¼Œä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ“ä½œç¼“å­˜ï¼ŒåŸºäºJavaé‡å…¥é”å®ç° blocking=true SerializedCache æ”¯æŒåºåˆ—åŒ–çš„ç¼“å­˜ å°†å¯¹è±¡åºåˆ—åŒ–ä»¥åå­˜åˆ°ç¼“å­˜ä¸­ï¼Œå–å‡ºæ˜¯ååºåˆ—åŒ– readOnly=false(é»˜è®¤) ScheduledCache å®šæ—¶è°ƒåº¦çš„ç¼“å­˜ åœ¨è¿›è¡Œ get/put/remove/getSize ç­‰æ“ä½œå‰ï¼Œåˆ¤æ–­ ç¼“å­˜æ—¶é—´æ˜¯å¦è¶…è¿‡äº†è®¾ç½®çš„æœ€é•¿ç¼“å­˜æ—¶é—´ï¼ˆé»˜è®¤æ˜¯ ä¸€å°æ—¶ï¼‰ï¼Œå¦‚æœæ˜¯åˆ™æ¸…ç©ºç¼“å­˜â€“å³æ¯éš”ä¸€æ®µæ—¶é—´æ¸… ç©ºä¸€æ¬¡ç¼“å­˜ flushIntervalä¸ä¸ºç©º TransactionalCache äº‹åŠ¡ç¼“å­˜ åœ¨äºŒçº§ç¼“å­˜ä¸­ä½¿ç”¨ï¼Œå¯ä»¥ä¸€æ¬¡å­˜å…¥å¤šä¸ªç¼“å­˜ï¼Œåˆ é™¤å¤šä¸ªç¼“å­˜ åœ¨TransactionalCacheManagerä¸­ç”¨Mapç»´æŠ¤å¯¹åº”å…³ç³» ä¸€çº§ç¼“å­˜ï¼ˆæœ¬åœ°ç¼“å­˜ï¼‰ ä¸€çº§ç¼“å­˜ä¹Ÿå«æœ¬åœ°ç¼“å­˜ï¼ŒMyBatis çš„ä¸€çº§ç¼“å­˜æ˜¯åœ¨ä¼šè¯ï¼ˆSqlSessionï¼‰å±‚é¢è¿›è¡Œç¼“å­˜çš„ã€‚MyBatis çš„ä¸€çº§ç¼“å­˜æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œä¸éœ€è¦ä»»ä½•çš„é…ç½®ã€‚é¦–å…ˆæˆ‘ä»¬å¿…é¡»å»å¼„æ¸…æ¥šä¸€ä¸ªé—®é¢˜ï¼Œåœ¨MyBatis æ‰§è¡Œçš„æµç¨‹é‡Œé¢ï¼Œæ¶‰åŠåˆ°è¿™ä¹ˆå¤šçš„å¯¹è±¡ï¼Œé‚£ä¹ˆç¼“å­˜PerpetualCache åº”è¯¥æ”¾åœ¨å“ªä¸ªå¯¹è±¡é‡Œé¢å»ç»´æŠ¤ï¼Ÿå¦‚æœè¦åœ¨åŒä¸€ä¸ªä¼šè¯é‡Œé¢å…±äº«ä¸€çº§ç¼“å­˜ï¼Œè¿™ä¸ªå¯¹è±¡è‚¯å®šæ˜¯åœ¨SqlSession é‡Œé¢åˆ›å»ºçš„ï¼Œä½œä¸ºSqlSession çš„ä¸€ä¸ªå±æ€§ã€‚ DefaultSqlSession é‡Œé¢åªæœ‰ä¸¤ä¸ªå±æ€§ï¼ŒConfiguration æ˜¯å…¨å±€çš„ï¼Œæ‰€ä»¥ç¼“å­˜åªå¯èƒ½æ”¾åœ¨Executor é‡Œé¢ç»´æŠ¤â€”â€”SimpleExecutor/ReuseExecutor/BatchExecutor çš„çˆ¶ç±»BaseExecutor çš„æ„é€ å‡½æ•°ä¸­æŒæœ‰äº†PerpetualCacheã€‚åœ¨åŒä¸€ä¸ªä¼šè¯é‡Œé¢ï¼Œå¤šæ¬¡æ‰§è¡Œç›¸åŒçš„SQL è¯­å¥ï¼Œä¼šç›´æ¥ä»å†…å­˜å–åˆ°ç¼“å­˜çš„ç»“æœï¼Œä¸ä¼šå†å‘é€SQL åˆ°æ•°æ®åº“ã€‚ä½†æ˜¯ä¸åŒçš„ä¼šè¯é‡Œé¢ï¼Œå³ä½¿æ‰§è¡Œçš„SQL ä¸€æ¨¡ä¸€æ ·ï¼ˆé€šè¿‡ä¸€ä¸ªMapper çš„åŒä¸€ä¸ªæ–¹æ³•çš„ç›¸åŒå‚æ•°è°ƒç”¨ï¼‰ï¼Œä¹Ÿä¸èƒ½ä½¿ç”¨åˆ°ä¸€çº§ç¼“å­˜ã€‚ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒMyBatisä¼šåœ¨ä¸€æ¬¡ä¼šè¯çš„è¡¨ç¤º----ä¸€ä¸ªSqlSessionå¯¹è±¡ä¸­åˆ›å»ºä¸€ä¸ªæœ¬åœ°ç¼“å­˜(local cache)ï¼Œå¯¹äºæ¯ä¸€æ¬¡æŸ¥è¯¢ï¼Œéƒ½ä¼šå°è¯•æ ¹æ®æŸ¥è¯¢çš„æ¡ä»¶å»æœ¬åœ°ç¼“å­˜ä¸­æŸ¥æ‰¾æ˜¯å¦åœ¨ç¼“å­˜ä¸­ï¼Œå¦‚æœåœ¨ç¼“å­˜ä¸­ï¼Œå°±ç›´æ¥ä»ç¼“å­˜ä¸­å–å‡ºï¼Œç„¶åè¿”å›ç»™ç”¨æˆ·ï¼›å¦åˆ™ï¼Œä»æ•°æ®åº“è¯»å–æ•°æ®ï¼Œå°†æŸ¥è¯¢ç»“æœå­˜å…¥ç¼“å­˜å¹¶è¿”å›ç»™ç”¨æˆ·ã€‚ ä¸€çº§ç¼“å­˜çš„ç”Ÿå‘½å‘¨æœŸæœ‰å¤šé•¿ï¼Ÿ MyBatisåœ¨å¼€å¯ä¸€ä¸ªæ•°æ®åº“ä¼šè¯æ—¶ï¼Œä¼š åˆ›å»ºä¸€ä¸ªæ–°çš„SqlSessionå¯¹è±¡ï¼ŒSqlSessionå¯¹è±¡ä¸­ä¼šæœ‰ä¸€ä¸ªæ–°çš„Executorå¯¹è±¡ï¼ŒExecutorå¯¹è±¡ä¸­æŒæœ‰ä¸€ä¸ªæ–°çš„PerpetualCacheå¯¹è±¡ï¼›å½“ä¼šè¯ç»“æŸæ—¶ï¼ŒSqlSessionå¯¹è±¡åŠå…¶å†…éƒ¨çš„Executorå¯¹è±¡è¿˜æœ‰PerpetualCacheå¯¹è±¡ä¹Ÿä¸€å¹¶é‡Šæ”¾æ‰ã€‚ å¦‚æœSqlSessionè°ƒç”¨äº†close()æ–¹æ³•ï¼Œä¼šé‡Šæ”¾æ‰ä¸€çº§ç¼“å­˜PerpetualCacheå¯¹è±¡ï¼Œä¸€çº§ç¼“å­˜å°†ä¸å¯ç”¨ï¼› å¦‚æœSqlSessionè°ƒç”¨äº†clearCache()ï¼Œä¼šæ¸…ç©ºPerpetualCacheå¯¹è±¡ä¸­çš„æ•°æ®ï¼Œä½†æ˜¯è¯¥å¯¹è±¡ä»å¯ä½¿ç”¨ï¼› SqlSessionä¸­æ‰§è¡Œäº†ä»»ä½•ä¸€ä¸ªupdateæ“ä½œ(update()ã€delete()ã€insert()) ï¼Œéƒ½ä¼šæ¸…ç©ºPerpetualCacheå¯¹è±¡çš„æ•°æ®ï¼Œä½†æ˜¯è¯¥å¯¹è±¡å¯ä»¥ç»§ç»­ä½¿ç”¨ï¼› SqlSession ä¸€çº§ç¼“å­˜çš„å·¥ä½œæµç¨‹ï¼š å¯¹äºæŸä¸ªæŸ¥è¯¢ï¼Œæ ¹æ®statementId,params,rowBoundsæ¥æ„å»ºä¸€ä¸ªkeyå€¼ï¼Œæ ¹æ®è¿™ä¸ªkeyå€¼å»ç¼“å­˜Cacheä¸­å–å‡ºå¯¹åº”çš„keyå€¼å­˜å‚¨çš„ç¼“å­˜ç»“æœ åˆ¤æ–­ä»Cacheä¸­æ ¹æ®ç‰¹å®šçš„keyå€¼å–çš„æ•°æ®æ•°æ®æ˜¯å¦ä¸ºç©ºï¼Œå³æ˜¯å¦å‘½ä¸­ï¼› å¦‚æœå‘½ä¸­ï¼Œåˆ™ç›´æ¥å°†ç¼“å­˜ç»“æœè¿”å›ï¼› å¦‚æœæ²¡å‘½ä¸­ï¼š å»æ•°æ®åº“ä¸­æŸ¥è¯¢æ•°æ®ï¼Œå¾—åˆ°æŸ¥è¯¢ç»“æœï¼› å°†keyå’ŒæŸ¥è¯¢åˆ°çš„ç»“æœåˆ†åˆ«ä½œä¸ºkey,valueå¯¹å­˜å‚¨åˆ°Cacheä¸­ï¼› å°†æŸ¥è¯¢ç»“æœè¿”å›ï¼› æ¥ä¸‹æ¥æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ï¼ŒMyBatis çš„ä¸€çº§ç¼“å­˜åˆ°åº•æ˜¯ä¸æ˜¯åªèƒ½åœ¨ä¸€ä¸ªä¼šè¯é‡Œé¢å…±äº«ï¼Œä»¥åŠè·¨ä¼šè¯ï¼ˆä¸åŒsessionï¼‰æ“ä½œç›¸åŒçš„æ•°æ®ä¼šäº§ç”Ÿä»€ä¹ˆé—®é¢˜ã€‚åˆ¤æ–­æ˜¯å¦å‘½ä¸­ç¼“å­˜ï¼šå¦‚æœå†æ¬¡å‘é€SQL åˆ°æ•°æ®åº“æ‰§è¡Œï¼Œè¯´æ˜æ²¡æœ‰å‘½ä¸­ç¼“å­˜ï¼›å¦‚æœç›´æ¥æ‰“å°å¯¹è±¡ï¼Œè¯´æ˜æ˜¯ä»å†…å­˜ç¼“å­˜ä¸­å–åˆ°äº†ç»“æœã€‚ åœ¨åŒä¸€ä¸ªsession ä¸­å…±äº«ï¼ˆä¸åŒsession ä¸èƒ½å…±äº«ï¼‰ åŒä¸€ä¸ªä¼šè¯ä¸­ï¼Œupdateï¼ˆåŒ…æ‹¬deleteï¼‰ä¼šå¯¼è‡´ä¸€çº§ç¼“å­˜è¢«æ¸…ç©º å…¶ä»–ä¼šè¯æ›´æ–°äº†æ•°æ®ï¼Œå¯¼è‡´è¯»å–åˆ°è„æ•°æ®ï¼ˆä¸€çº§ç¼“å­˜ä¸èƒ½è·¨ä¼šè¯å…±äº«ï¼‰ ä¸€çº§ç¼“å­˜çš„ä¸è¶³ï¼š ä½¿ç”¨ä¸€çº§ç¼“å­˜çš„æ—¶å€™ï¼Œå› ä¸ºç¼“å­˜ä¸èƒ½è·¨ä¼šè¯å…±äº«ï¼Œä¸åŒçš„ä¼šè¯ä¹‹é—´å¯¹äºç›¸åŒçš„æ•°æ®å¯èƒ½æœ‰ä¸ä¸€æ ·çš„ç¼“å­˜ã€‚åœ¨æœ‰å¤šä¸ªä¼šè¯æˆ–è€…åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œä¼šå­˜åœ¨è„æ•°æ®çš„é—®é¢˜ã€‚å¦‚æœè¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±è¦ç”¨åˆ°äºŒçº§ç¼“å­˜ã€‚MyBatis ä¸€çº§ç¼“å­˜ï¼ˆMyBaits ç§°å…¶ä¸º Local Cacheï¼‰æ— æ³•å…³é—­ï¼Œä½†æ˜¯æœ‰ä¸¤ç§çº§åˆ«å¯é€‰ï¼š session çº§åˆ«çš„ç¼“å­˜ï¼Œåœ¨åŒä¸€ä¸ª sqlSession å†…ï¼Œå¯¹åŒæ ·çš„æŸ¥è¯¢å°†ä¸å†æŸ¥è¯¢æ•°æ®åº“ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­ã€‚ statement çº§åˆ«çš„ç¼“å­˜ï¼Œé¿å‘ï¼š ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥å°†ä¸€çº§ç¼“å­˜çš„çº§åˆ«è®¾ä¸º statement çº§åˆ«çš„ï¼Œè¿™æ ·æ¯æ¬¡æŸ¥è¯¢ç»“æŸéƒ½ä¼šæ¸…æ‰ä¸€çº§ç¼“å­˜ã€‚ äºŒçº§ç¼“å­˜ äºŒçº§ç¼“å­˜æ˜¯ç”¨æ¥è§£å†³ä¸€çº§ç¼“å­˜ä¸èƒ½è·¨ä¼šè¯å…±äº«çš„é—®é¢˜çš„ï¼ŒèŒƒå›´æ˜¯namespace çº§åˆ«çš„ï¼Œå¯ä»¥è¢«å¤šä¸ªSqlSession å…±äº«ï¼ˆåªè¦æ˜¯åŒä¸€ä¸ªæ¥å£é‡Œé¢çš„ç›¸åŒæ–¹æ³•ï¼Œéƒ½å¯ä»¥å…±äº«ï¼‰ï¼Œç”Ÿå‘½å‘¨æœŸå’Œåº”ç”¨åŒæ­¥ã€‚å¦‚æœä½ çš„MyBatisä½¿ç”¨äº†äºŒçº§ç¼“å­˜ï¼Œå¹¶ä¸”ä½ çš„Mapperå’Œselectè¯­å¥ä¹Ÿé…ç½®ä½¿ç”¨äº†äºŒçº§ç¼“å­˜ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡ŒselectæŸ¥è¯¢çš„æ—¶å€™ï¼ŒMyBatisä¼šå…ˆä»äºŒçº§ç¼“å­˜ä¸­å–è¾“å…¥ï¼Œå…¶æ¬¡æ‰æ˜¯ä¸€çº§ç¼“å­˜ï¼Œå³MyBatisæŸ¥è¯¢æ•°æ®çš„é¡ºåºæ˜¯ï¼šäºŒçº§ç¼“å­˜ â€”&gt; ä¸€çº§ç¼“å­˜ â€”&gt; æ•°æ®åº“ã€‚ ä½œä¸ºä¸€ä¸ªä½œç”¨èŒƒå›´æ›´å¹¿çš„ç¼“å­˜ï¼Œå®ƒè‚¯å®šæ˜¯åœ¨SqlSession çš„å¤–å±‚ï¼Œå¦åˆ™ä¸å¯èƒ½è¢«å¤šä¸ªSqlSession å…±äº«ã€‚è€Œä¸€çº§ç¼“å­˜æ˜¯åœ¨SqlSession å†…éƒ¨çš„ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œè‚¯å®šæ˜¯å·¥ä½œåœ¨ä¸€çº§ç¼“å­˜ä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯åªæœ‰å–ä¸åˆ°äºŒçº§ç¼“å­˜çš„æƒ…å†µä¸‹æ‰åˆ°ä¸€ä¸ªä¼šè¯ä¸­å»å–ä¸€çº§ç¼“å­˜ã€‚ç¬¬äºŒä¸ªé—®é¢˜ï¼ŒäºŒçº§ç¼“å­˜æ”¾åœ¨å“ªä¸ªå¯¹è±¡ä¸­ç»´æŠ¤å‘¢ï¼Ÿ è¦è·¨ä¼šè¯å…±äº«çš„è¯ï¼ŒSqlSession æœ¬èº«å’Œå®ƒé‡Œé¢çš„BaseExecutor å·²ç»æ»¡è¶³ä¸äº†éœ€æ±‚äº†ï¼Œé‚£æˆ‘ä»¬åº”è¯¥åœ¨BaseExecutor ä¹‹å¤–åˆ›å»ºä¸€ä¸ªå¯¹è±¡ã€‚ å®é™…ä¸ŠMyBatis ç”¨äº†ä¸€ä¸ªè£…é¥°å™¨çš„ç±»æ¥ç»´æŠ¤ï¼Œå°±æ˜¯CachingExecutorã€‚å¦‚æœå¯ç”¨äº†äºŒçº§ç¼“å­˜ï¼ŒMyBatis åœ¨åˆ›å»ºExecutor å¯¹è±¡çš„æ—¶å€™ä¼šå¯¹Executor è¿›è¡Œè£…é¥°ã€‚CachingExecutor å¯¹äºæŸ¥è¯¢è¯·æ±‚ï¼Œä¼šåˆ¤æ–­äºŒçº§ç¼“å­˜æ˜¯å¦æœ‰ç¼“å­˜ç»“æœï¼Œå¦‚æœæœ‰å°±ç›´æ¥è¿”å›ï¼Œå¦‚æœæ²¡æœ‰å§”æ´¾äº¤ç»™çœŸæ­£çš„æŸ¥è¯¢å™¨Executor å®ç°ç±»ï¼Œæ¯”å¦‚SimpleExecutor æ¥æ‰§è¡ŒæŸ¥è¯¢ï¼Œå†èµ°åˆ°ä¸€çº§ç¼“å­˜çš„æµç¨‹ã€‚æœ€åä¼šæŠŠç»“æœç¼“å­˜èµ·æ¥ï¼Œå¹¶ä¸”è¿”å›ç»™ç”¨æˆ·ã€‚ å¼€å¯äºŒçº§ç¼“å­˜çš„æ–¹æ³• ç¬¬ä¸€æ­¥ï¼šé…ç½® mybatis.configuration.cache-enabled=trueï¼Œåªè¦æ²¡æœ‰æ˜¾å¼åœ°è®¾ç½®cacheEnabled=falseï¼Œéƒ½ä¼šç”¨CachingExecutor è£…é¥°åŸºæœ¬çš„æ‰§è¡Œå™¨ã€‚ ç¬¬äºŒæ­¥ï¼šåœ¨Mapper.xml ä¸­é…ç½®æ ‡ç­¾ï¼š &lt;cache type=&quot;org.apache.ibatis.cache.impl.PerpetualCache&quot; size=&quot;1024&quot; eviction=&quot;LRU&quot; flushInterval=&quot;120000&quot; readOnly=&quot;false&quot;/&gt; åŸºæœ¬ä¸Šå°±æ˜¯è¿™æ ·ã€‚è¿™ä¸ªç®€å•è¯­å¥çš„æ•ˆæœå¦‚ä¸‹: æ˜ å°„è¯­å¥æ–‡ä»¶ä¸­çš„æ‰€æœ‰ select è¯­å¥çš„ç»“æœå°†ä¼šè¢«ç¼“å­˜ã€‚ æ˜ å°„è¯­å¥æ–‡ä»¶ä¸­çš„æ‰€æœ‰ insertã€update å’Œ delete è¯­å¥ä¼šåˆ·æ–°ç¼“å­˜ã€‚ ç¼“å­˜ä¼šä½¿ç”¨æœ€è¿‘æœ€å°‘ä½¿ç”¨ç®—æ³•ï¼ˆLRU, Least Recently Usedï¼‰ç®—æ³•æ¥æ¸…é™¤ä¸éœ€è¦çš„ç¼“å­˜ã€‚ ç¼“å­˜ä¸ä¼šå®šæ—¶è¿›è¡Œåˆ·æ–°ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œæ²¡æœ‰åˆ·æ–°é—´éš”ï¼‰ã€‚ ç¼“å­˜ä¼šä¿å­˜åˆ—è¡¨æˆ–å¯¹è±¡ï¼ˆæ— è®ºæŸ¥è¯¢æ–¹æ³•è¿”å›å“ªç§ï¼‰çš„ 1024 ä¸ªå¼•ç”¨ã€‚ ç¼“å­˜ä¼šè¢«è§†ä¸ºè¯»/å†™ç¼“å­˜ï¼Œè¿™æ„å‘³ç€è·å–åˆ°çš„å¯¹è±¡å¹¶ä¸æ˜¯å…±äº«çš„ï¼Œå¯ä»¥å®‰å…¨åœ°è¢«è°ƒç”¨è€…ä¿®æ”¹ï¼Œè€Œä¸å¹²æ‰°å…¶ä»–è°ƒç”¨è€…æˆ–çº¿ç¨‹æ‰€åšçš„æ½œåœ¨ä¿®æ”¹ã€‚ è¿™ä¸ªæ›´é«˜çº§çš„é…ç½®åˆ›å»ºäº†ä¸€ä¸ª FIFO ç¼“å­˜ï¼Œæ¯éš” 60 ç§’åˆ·æ–°ï¼Œæœ€å¤šå¯ä»¥å­˜å‚¨ç»“æœå¯¹è±¡æˆ–åˆ—è¡¨çš„ 512 ä¸ªå¼•ç”¨ï¼Œè€Œä¸”è¿”å›çš„å¯¹è±¡è¢«è®¤ä¸ºæ˜¯åªè¯»çš„ï¼Œå› æ­¤å¯¹å®ƒä»¬è¿›è¡Œä¿®æ”¹å¯èƒ½ä¼šåœ¨ä¸åŒçº¿ç¨‹ä¸­çš„è°ƒç”¨è€…äº§ç”Ÿå†²çªã€‚å¯ç”¨çš„æ¸…é™¤ç­–ç•¥æœ‰ï¼š LRU â€“ æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼šç§»é™¤æœ€é•¿æ—¶é—´ä¸è¢«ä½¿ç”¨çš„å¯¹è±¡ã€‚ FIFO â€“ å…ˆè¿›å…ˆå‡ºï¼šæŒ‰å¯¹è±¡è¿›å…¥ç¼“å­˜çš„é¡ºåºæ¥ç§»é™¤å®ƒä»¬ã€‚ SOFT â€“ è½¯å¼•ç”¨ï¼šåŸºäºåƒåœ¾å›æ”¶å™¨çŠ¶æ€å’Œè½¯å¼•ç”¨è§„åˆ™ç§»é™¤å¯¹è±¡ã€‚ WEAK â€“ å¼±å¼•ç”¨ï¼šæ›´ç§¯æåœ°åŸºäºåƒåœ¾æ”¶é›†å™¨çŠ¶æ€å’Œå¼±å¼•ç”¨è§„åˆ™ç§»é™¤å¯¹è±¡ã€‚ é»˜è®¤çš„æ¸…é™¤ç­–ç•¥æ˜¯ LRUã€‚ flushIntervalï¼ˆåˆ·æ–°é—´éš”ï¼‰å±æ€§å¯ä»¥è¢«è®¾ç½®ä¸ºä»»æ„çš„æ­£æ•´æ•°ï¼Œè®¾ç½®çš„å€¼åº”è¯¥æ˜¯ä¸€ä¸ªä»¥æ¯«ç§’ä¸ºå•ä½çš„åˆç†æ—¶é—´é‡ã€‚ é»˜è®¤æƒ…å†µæ˜¯ä¸è®¾ç½®ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰åˆ·æ–°é—´éš”ï¼Œç¼“å­˜ä»…ä»…ä¼šåœ¨è°ƒç”¨è¯­å¥æ—¶åˆ·æ–°ã€‚ sizeï¼ˆå¼•ç”¨æ•°ç›®ï¼‰å±æ€§å¯ä»¥è¢«è®¾ç½®ä¸ºä»»æ„æ­£æ•´æ•°ï¼Œè¦æ³¨æ„æ¬²ç¼“å­˜å¯¹è±¡çš„å¤§å°å’Œè¿è¡Œç¯å¢ƒä¸­å¯ç”¨çš„å†…å­˜èµ„æºã€‚é»˜è®¤å€¼æ˜¯ 1024ã€‚ readOnlyï¼ˆåªè¯»ï¼‰å±æ€§å¯ä»¥è¢«è®¾ç½®ä¸º true æˆ– falseã€‚åªè¯»çš„ç¼“å­˜ä¼šç»™æ‰€æœ‰è°ƒç”¨è€…è¿”å›ç¼“å­˜å¯¹è±¡çš„ç›¸åŒå®ä¾‹ã€‚ å› æ­¤è¿™äº›å¯¹è±¡ä¸èƒ½è¢«ä¿®æ”¹ã€‚è¿™å°±æä¾›äº†å¯è§‚çš„æ€§èƒ½æå‡ã€‚è€Œå¯è¯»å†™çš„ç¼“å­˜ä¼šï¼ˆé€šè¿‡åºåˆ—åŒ–ï¼‰è¿”å›ç¼“å­˜å¯¹è±¡çš„æ‹·è´ã€‚ é€Ÿåº¦ä¸Šä¼šæ…¢ä¸€äº›ï¼Œä½†æ˜¯æ›´å®‰å…¨ï¼Œå› æ­¤é»˜è®¤å€¼æ˜¯ falseã€‚ æ³¨ï¼šäºŒçº§ç¼“å­˜æ˜¯äº‹åŠ¡æ€§çš„ã€‚è¿™æ„å‘³ç€ï¼Œå½“ SqlSession å®Œæˆå¹¶æäº¤æ—¶ï¼Œæˆ–æ˜¯å®Œæˆå¹¶å›æ»šï¼Œä½†æ²¡æœ‰æ‰§è¡Œ flushCache=true çš„ insert/delete/update è¯­å¥æ—¶ï¼Œç¼“å­˜ä¼šè·å¾—æ›´æ–°ã€‚ Mapper.xml é…ç½®äº†ä¹‹åï¼Œselect()ä¼šè¢«ç¼“å­˜ã€‚update()ã€delete()ã€insert()ä¼šåˆ·æ–°ç¼“å­˜ã€‚ï¼šå¦‚æœcacheEnabled=trueï¼ŒMapper.xml æ²¡æœ‰é…ç½®æ ‡ç­¾ï¼Œè¿˜æœ‰äºŒçº§ç¼“å­˜å—ï¼Ÿï¼ˆæ²¡æœ‰ï¼‰è¿˜ä¼šå‡ºç°CachingExecutor åŒ…è£…å¯¹è±¡å—ï¼Ÿï¼ˆä¼šï¼‰ åªè¦cacheEnabled=true åŸºæœ¬æ‰§è¡Œå™¨å°±ä¼šè¢«è£…é¥°ã€‚æœ‰æ²¡æœ‰é…ç½®ï¼Œå†³å®šäº†åœ¨å¯åŠ¨çš„æ—¶å€™ä¼šä¸ä¼šåˆ›å»ºè¿™ä¸ªmapper çš„Cache å¯¹è±¡ï¼Œåªæ˜¯æœ€ç»ˆä¼šå½±å“åˆ°CachingExecutorquery æ–¹æ³•é‡Œé¢çš„åˆ¤æ–­ã€‚å¦‚æœæŸäº›æŸ¥è¯¢æ–¹æ³•å¯¹æ•°æ®çš„å®æ—¶æ€§è¦æ±‚å¾ˆé«˜ï¼Œä¸éœ€è¦äºŒçº§ç¼“å­˜ï¼Œæ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬å¯ä»¥åœ¨å•ä¸ªStatement ID ä¸Šæ˜¾å¼å…³é—­äºŒçº§ç¼“å­˜ï¼ˆé»˜è®¤æ˜¯trueï¼‰ï¼š &lt;select id=&quot;selectBlog&quot; resultMap=&quot;BaseResultMap&quot; useCache=&quot;false&quot;&gt; ç¬¬ä¸‰æ–¹ç¼“å­˜åšäºŒçº§ç¼“å­˜ é™¤äº†MyBatis è‡ªå¸¦çš„äºŒçº§ç¼“å­˜ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡å®ç°Cache æ¥å£æ¥è‡ªå®šä¹‰äºŒçº§ç¼“å­˜ã€‚MyBatis å®˜æ–¹æä¾›äº†ä¸€äº›ç¬¬ä¸‰æ–¹ç¼“å­˜é›†æˆæ–¹å¼ï¼Œæ¯”å¦‚ehcache å’Œredisï¼šhttps://github.com/mybatis/redis-cache ,è¿™é‡Œå°±ä¸è¿‡å¤šä»‹ç»äº†ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ç‹¬ç«‹çš„ç¼“å­˜æœåŠ¡ï¼Œä¸ä½¿ç”¨MyBatis è‡ªå¸¦çš„äºŒçº§ç¼“å­˜ã€‚ pom æ–‡ä»¶å¼•å…¥ä¾èµ–ï¼š &lt;dependency&gt; &lt;groupId&gt;org.mybatis.caches&lt;/groupId&gt; &lt;artifactId&gt;mybatis-redis&lt;/artifactId&gt; &lt;version&gt;1.0.0-beta2&lt;/version&gt; &lt;/dependency&gt; MybatisRedisCache import com.xxx.util.JsonUtils; import org.apache.ibatis.cache.Cache; import org.apache.logging.log4j.LogManager; import org.apache.logging.log4j.Logger; import org.springframework.data.redis.core.RedisTemplate; import java.util.concurrent.locks.ReadWriteLock; import java.util.concurrent.locks.ReentrantReadWriteLock; /** * Mybatis - redisäºŒçº§ç¼“å­˜ * */ public final class MybatisRedisCache implements Cache { /** * æ—¥å¿—å·¥å…·ç±» */ private static final Logger logger = LogManager.getLogger(MybatisRedisCache.class); /** * è¯»å†™é” */ private final ReadWriteLock readWriteLock = new ReentrantReadWriteLock(); /** * ID */ private String id; /** * é›†æˆredisTemplate */ private static RedisTemplate redisTemplate; public MybatisRedisCache() { } public MybatisRedisCache(String id) { if (id == null) { throw new IllegalArgumentException(&quot;Cache instances require an ID&quot;); } else { logger.debug(&quot;MybatisRedisCache.id={}&quot;, id); this.id = id; } } @Override public String getId() { return this.id; } @Override public int getSize() { try { Long size = redisTemplate.opsForHash().size(this.id.toString()); logger.debug(&quot;MybatisRedisCache.getSize: {}-&gt;{}&quot;, id, size); return size.intValue(); } catch (Exception e) { e.printStackTrace(); } return 0; } @Override public void putObject(final Object key, final Object value) { try { logger.debug(&quot;MybatisRedisCache.putObject: {}-&gt;{}-&gt;{}&quot;, id, key, JsonUtils.toJson(value)); redisTemplate.opsForHash().put(this.id.toString(), key.toString(), value); } catch (Exception e) { e.printStackTrace(); } } @Override public Object getObject(final Object key) { try { Object hashVal = redisTemplate.opsForHash().get(this.id.toString(), key.toString()); logger.debug(&quot;MybatisRedisCache.getObject: {}-&gt;{}-&gt;{}&quot;, id, key, JsonUtils.toJson(hashVal)); return hashVal; } catch (Exception e) { e.printStackTrace(); return null; } } @Override public Object removeObject(final Object key) { try { redisTemplate.opsForHash().delete(this.id.toString(), key.toString()); logger.debug(&quot;MybatisRedisCache.removeObject: {}-&gt;{}-&gt;{}&quot;, id, key); } catch (Exception e) { e.printStackTrace(); } return null; } @Override public void clear() { try { redisTemplate.delete(this.id.toString()); logger.debug(&quot;MybatisRedisCache.clear: {}&quot;, id); } catch (Exception e) { e.printStackTrace(); } } @Override public ReadWriteLock getReadWriteLock() { return this.readWriteLock; } @Override public String toString() { return &quot;MybatisRedisCache {&quot; + this.id + &quot;}&quot;; } /** * è®¾ç½®redisTemplate * * @param redisTemplate */ public void setRedisTemplate(RedisTemplate redisTemplate) { MybatisRedisCache.redisTemplate = redisTemplate; } } RedisConfig import com.fasterxml.jackson.annotation.JsonAutoDetect; import com.fasterxml.jackson.annotation.PropertyAccessor; import com.fasterxml.jackson.databind.ObjectMapper; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import org.springframework.data.redis.connection.RedisConnectionFactory; import org.springframework.data.redis.core.RedisTemplate; import org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer; import org.springframework.data.redis.serializer.StringRedisSerializer; /** * Redisé…ç½® * */ @Configuration public class RedisConfig { /** * é…ç½®RedisTemplate * * @param factory * @return */ @Bean public RedisTemplate redisTemplate(RedisConnectionFactory factory, Jackson2JsonRedisSerializer redisJsonSerializer) { RedisTemplate&lt;Object, Object&gt; template = new RedisTemplate&lt;&gt;(); //redisè¿æ¥å·¥å‚ template.setConnectionFactory(factory); StringRedisSerializer stringRedisSerializer = new StringRedisSerializer(); //redis.keyåºåˆ—åŒ–å™¨ template.setKeySerializer(stringRedisSerializer); //redis.valueåºåˆ—åŒ–å™¨ template.setValueSerializer(redisJsonSerializer); //redis.hash.keyåºåˆ—åŒ–å™¨ template.setHashKeySerializer(stringRedisSerializer); //redis.hash.valueåºåˆ—åŒ–å™¨ template.setHashValueSerializer(redisJsonSerializer); //è°ƒç”¨å…¶ä»–åˆå§‹åŒ–é€»è¾‘ template.afterPropertiesSet(); //è¿™é‡Œè®¾ç½®redisäº‹åŠ¡ä¸€è‡´ template.setEnableTransactionSupport(true); return template; } /** * é…ç½®redis Jsonåºåˆ—åŒ–å™¨ * * @return */ @Bean public Jackson2JsonRedisSerializer redisJsonSerializer() { //ä½¿ç”¨Jackson2JsonRedisSerializeræ¥åºåˆ—åŒ–å’Œååºåˆ—åŒ–redisçš„valueå€¼ï¼ˆé»˜è®¤ä½¿ç”¨JDKçš„åºåˆ—åŒ–æ–¹å¼ï¼‰ Jackson2JsonRedisSerializer serializer = new Jackson2JsonRedisSerializer(Object.class); ObjectMapper mapper = new ObjectMapper(); mapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY); mapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL); serializer.setObjectMapper(mapper); return serializer; } } å¼€å¯MybatisäºŒçº§ç¼“å­˜è®¾ç½® æ–¹å¼1ï¼šmybatis-config.xml &lt;configuration&gt; &lt;settings&gt; &lt;!-- å¼€å¯äºŒçº§ç¼“å­˜ --&gt; &lt;setting name=&quot;cacheEnabled&quot; value=&quot;true&quot;/&gt; &lt;/settings&gt; ... &lt;/configuration&gt; æ–¹å¼2ï¼šSpringboot - application.properties #ä½¿å…¨å±€çš„æ˜ å°„å™¨å¯ç”¨æˆ–ç¦ç”¨ç¼“å­˜ã€‚ mybatis.configuration.cache-enabled=true Mapper.xml é…ç½®ï¼Œtype ä½¿ç”¨RedisCacheï¼š &lt;cache type=&quot;org.mybatis.caches.redis.RedisCache&quot; eviction=&quot;FIFO&quot; flushInterval=&quot;60000&quot; size=&quot;512&quot; readOnly=&quot;true&quot;/&gt; redis.properties é…ç½®ï¼š host=localhost port=6379 connectionTimeout=5000 soTimeout=5000 database=0 ","link":"https://tianxiawuhao.github.io/P-yYZmx9j/"},{"title":"springBootæ¦‚è¿°","content":"Spring Boot ä¼˜ç‚¹ å®¹æ˜“ä¸Šæ‰‹ï¼Œæå‡å¼€å‘æ•ˆç‡ï¼Œä¸º Spring å¼€å‘æä¾›ä¸€ä¸ªæ›´å¿«ã€æ›´å¹¿æ³›çš„å…¥é—¨ä½“éªŒã€‚ å¼€ç®±å³ç”¨ï¼Œè¿œç¦»ç¹ççš„é…ç½®ã€‚ æä¾›äº†ä¸€ç³»åˆ—å¤§å‹é¡¹ç›®é€šç”¨çš„éä¸šåŠ¡æ€§åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼šå†…åµŒæœåŠ¡å™¨ã€å®‰å…¨ç®¡ç†ã€è¿è¡Œæ•°æ®ç›‘æ§ã€è¿è¡ŒçŠ¶å†µæ£€æŸ¥å’Œå¤–éƒ¨åŒ–é…ç½®ç­‰ã€‚ æ²¡æœ‰ä»£ç ç”Ÿæˆï¼Œä¹Ÿä¸éœ€è¦XMLé…ç½®ã€‚ é¿å…å¤§é‡çš„ Maven å¯¼å…¥å’Œå„ç§ç‰ˆæœ¬å†²çªã€‚ Spring Boot çš„æ ¸å¿ƒæ³¨è§£æ˜¯å“ªä¸ªï¼Ÿå®ƒä¸»è¦ç”±å“ªå‡ ä¸ªæ³¨è§£ç»„æˆçš„ï¼Ÿ å¯åŠ¨ç±»ä¸Šé¢çš„æ³¨è§£æ˜¯@SpringBootApplicationï¼Œå®ƒä¹Ÿæ˜¯ Spring Boot çš„æ ¸å¿ƒæ³¨è§£ï¼Œä¸»è¦ç»„åˆåŒ…å«äº†ä»¥ä¸‹ 3 ä¸ªæ³¨è§£ï¼š @SpringBootConfigurationï¼šç»„åˆäº† @Configuration æ³¨è§£ï¼Œå®ç°é…ç½®æ–‡ä»¶çš„åŠŸèƒ½ã€‚ @EnableAutoConfigurationï¼šæ‰“å¼€è‡ªåŠ¨é…ç½®çš„åŠŸèƒ½ï¼Œä¹Ÿå¯ä»¥å…³é—­æŸä¸ªè‡ªåŠ¨é…ç½®çš„é€‰é¡¹ï¼Œå¦‚å…³é—­æ•°æ®æºè‡ªåŠ¨é…ç½®åŠŸèƒ½ï¼š @SpringBootApplication(exclude = { DataSourceAutoConfiguration.class })ã€‚ @ComponentScanï¼šSpringç»„ä»¶æ‰«æã€‚ æ‰€æœ‰å…¶å®ƒ Spring ç»„ä»¶(å¦‚Controllerå±‚ã€Serviceå±‚ã€Daoå±‚ã€å®šæ—¶å™¨ç­‰)éƒ½å¿…é¡»æ”¾åœ¨åº”ç”¨ @SpringBootApplication æ³¨è§£æ‰€åœ¨ç±»çš„åŒåŒ…æˆ–è€…å…¶å­åŒ…ä¸‹é¢ï¼Œå› ä¸ºåº”ç”¨ä»å¯åŠ¨ç±»å¼€å§‹å¯åŠ¨ï¼Œç„¶åä¼šæ‰«æå¯åŠ¨ç±»åŒåŒ…åŠå…¶å­åŒ…ä¸‹é¢çš„ç»„ä»¶ï¼Œå¦‚æœæ”¾åœ¨å…¶å®ƒåœ°æ–¹åˆ™ä¼šå› ä¸ºæ‰«æä¸åˆ°è€ŒåŠ è½½ä¸äº† JavaConfig Spring JavaConfig æ˜¯ Spring ç¤¾åŒºçš„äº§å“ï¼Œå®ƒæä¾›äº†é…ç½® Spring IoC å®¹å™¨çš„çº¯Java æ–¹æ³•ã€‚å› æ­¤å®ƒæœ‰åŠ©äºé¿å…ä½¿ç”¨ XML é…ç½®ã€‚ä½¿ç”¨ JavaConfig çš„ä¼˜ç‚¹åœ¨äºï¼š ï¼ˆ1ï¼‰é¢å‘å¯¹è±¡çš„é…ç½®ã€‚ç”±äºé…ç½®è¢«å®šä¹‰ä¸º JavaConfig ä¸­çš„ç±»ï¼Œå› æ­¤ç”¨æˆ·å¯ä»¥å……åˆ†åˆ©ç”¨ Java ä¸­çš„é¢å‘å¯¹è±¡åŠŸèƒ½ã€‚ä¸€ä¸ªé…ç½®ç±»å¯ä»¥ç»§æ‰¿å¦ä¸€ä¸ªï¼Œé‡å†™å®ƒçš„@Bean æ–¹æ³•ç­‰ã€‚ ï¼ˆ2ï¼‰å‡å°‘æˆ–æ¶ˆé™¤ XML é…ç½®ã€‚åŸºäºä¾èµ–æ³¨å…¥åŸåˆ™çš„å¤–åŒ–é…ç½®çš„å¥½å¤„å·²è¢«è¯æ˜ã€‚ä½†æ˜¯ï¼Œè®¸å¤šå¼€å‘äººå‘˜ä¸å¸Œæœ›åœ¨ XML å’Œ Java ä¹‹é—´æ¥å›åˆ‡æ¢ã€‚JavaConfig ä¸ºå¼€å‘äººå‘˜æä¾›äº†ä¸€ç§çº¯ Java æ–¹æ³•æ¥é…ç½®ä¸ XML é…ç½®æ¦‚å¿µç›¸ä¼¼çš„ Spring å®¹å™¨ã€‚ä»æŠ€æœ¯è§’åº¦æ¥è®²ï¼Œåªä½¿ç”¨ JavaConfig é…ç½®ç±»æ¥é…ç½®å®¹å™¨æ˜¯å¯è¡Œçš„ï¼Œä½†å®é™…ä¸Šå¾ˆå¤šäººè®¤ä¸ºå°†JavaConfig ä¸ XML æ··åˆåŒ¹é…æ˜¯ç†æƒ³çš„ã€‚ ï¼ˆ3ï¼‰ç±»å‹å®‰å…¨å’Œé‡æ„å‹å¥½ã€‚JavaConfig æä¾›äº†ä¸€ç§ç±»å‹å®‰å…¨çš„æ–¹æ³•æ¥é…ç½® Springå®¹å™¨ã€‚ç”±äº Java 5.0 å¯¹æ³›å‹çš„æ”¯æŒï¼Œç°åœ¨å¯ä»¥æŒ‰ç±»å‹è€Œä¸æ˜¯æŒ‰åç§°æ£€ç´¢ beanï¼Œä¸éœ€è¦ä»»ä½•å¼ºåˆ¶è½¬æ¢æˆ–åŸºäºå­—ç¬¦ä¸²çš„æŸ¥æ‰¾ã€‚ /** * @ConfigurationProperties è¡¨ç¤º å‘Šè¯‰ SpringBoot å°†æœ¬ç±»ä¸­çš„æ‰€æœ‰å±æ€§å’Œé…ç½®æ–‡ä»¶ä¸­ç›¸å…³çš„é…ç½®è¿›è¡Œç»‘å®šï¼› * prefix = &quot;user&quot; è¡¨ç¤º å°†é…ç½®æ–‡ä»¶ä¸­ key ä¸º user çš„ä¸‹é¢æ‰€æœ‰çš„å±æ€§ä¸æœ¬ç±»å±æ€§è¿›è¡Œä¸€ä¸€æ˜ å°„æ³¨å…¥å€¼ï¼Œå¦‚æœé…ç½®æ–‡ä»¶ä¸­ * ä¸å­˜åœ¨ &quot;user&quot; çš„ keyï¼Œåˆ™ä¸ä¼šä¸º POJO æ³¨å…¥å€¼ï¼Œå±æ€§å€¼ä»ç„¶ä¸ºé»˜è®¤å€¼ * @Component å°†æœ¬æ¥æ ‡è¯†ä¸ºä¸€ä¸ª Spring ç»„ä»¶ï¼Œå› ä¸ºåªæœ‰æ˜¯å®¹å™¨ä¸­çš„ç»„ä»¶ï¼Œå®¹å™¨æ‰ä¼šä¸º @ConfigurationProperties æä¾›æ­¤æ³¨å…¥åŠŸèƒ½ * @PropertySource (value = { &quot; classpath : user.properties &quot; }) æŒ‡æ˜åŠ è½½ç±»è·¯å¾„ä¸‹çš„å“ªä¸ªé…ç½®æ–‡ä»¶æ¥æ³¨å…¥å€¼ */ @PropertySource(value = {&quot;classpath:user.properties&quot;}) @Component @ConfigurationProperties(prefix = &quot;user&quot;) public class User { private Integer id; private String lastName; private Integer age; private Date birthday; private List&lt;String&gt; colorList; private Map&lt;String, String&gt; cityMap; } /** * æ–‡ä¸­çš„@Configuration å¯ä»¥æ›¿æ¢ä¸º@Componentè¿è¡Œç»“æœæ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯ä¸¤è€…æ˜¯æœ‰ä¸åŒçš„ï¼Œ@Configurationä¼šä¸ºé…ç½®ç±»ç”ŸæˆCGLIBä»£ç†Classï¼Œ@Componentä¸ä¼š */ @PropertySource(value = {&quot;classpath:user.properties&quot;}) @Configuration public class User { @Value(${user.id}) private Integer id; @Value(${user.lastName}) private String lastName; @Value(${user.age}) private Integer age; @Value(${user.birthday}) private Date birthday; @Value(${user.colorList}) private List&lt;String&gt; colorList; @Value(${user.maps}) private Map&lt;String, String&gt; cityMap; } user.properties user.id=111 user.lastName=å¼ æ— å¿Œ user.age=120 user.birthday=2018/07/11 user.colorList=red,yellow,green,blacnk user.cityMap.mapK1=é•¿æ²™å¸‚ user.cityMap.mapK2=æ·±åœ³å¸‚ user.maps=&quot;{mapK1: 'é•¿æ²™å¸‚', mapK2: 'æ·±åœ³å¸‚'}&quot; Spring Boot è‡ªåŠ¨é…ç½® æ³¨è§£ @EnableAutoConfiguration, @Configuration, @ConditionalOnClass å°±æ˜¯è‡ªåŠ¨é…ç½®çš„æ ¸å¿ƒï¼Œ @EnableAutoConfiguration ç»™å®¹å™¨å¯¼å…¥META-INF/spring.factories é‡Œå®šä¹‰çš„è‡ªåŠ¨é…ç½®ç±»ã€‚ ç­›é€‰æœ‰æ•ˆçš„è‡ªåŠ¨é…ç½®ç±»ã€‚ æ¯ä¸€ä¸ªè‡ªåŠ¨é…ç½®ç±»ç»“åˆå¯¹åº”çš„ xxxProperties.java è¯»å–é…ç½®æ–‡ä»¶è¿›è¡Œè‡ªåŠ¨é…ç½®åŠŸèƒ½ Spring Boot é…ç½®åŠ è½½é¡ºåº Spring Boot æ”¯æŒå¤šç§å¤–éƒ¨é…ç½®æ–¹å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œä»ä¸Šå¾€ä¸‹åŠ è½½ä¼˜å…ˆçº§ç”±é«˜åˆ°ä½ï¼Œå†…å®¹ç›¸åŒæ—¶è¦†ç›–ï¼Œä¸ç›¸åŒæ—¶ç´¯åŠ ã€‚ å¦‚æœåœ¨ä¸åŒçš„ç›®å½•ä¸­å­˜åœ¨å¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œå®ƒçš„è¯»å–é¡ºåºæ˜¯ï¼š 1ã€config/application.propertiesï¼ˆé¡¹ç›®æ ¹ç›®å½•ä¸­configç›®å½•ä¸‹ï¼‰ 2ã€config/application.yml 3ã€application.propertiesï¼ˆé¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼‰ 4ã€application.yml 5ã€resources/config/application.propertiesï¼ˆé¡¹ç›®resourcesç›®å½•ä¸­configç›®å½•ä¸‹ï¼‰ 6ã€resources/config/application.yml 7ã€resources/application.propertiesï¼ˆé¡¹ç›®çš„resourcesç›®å½•ä¸‹ï¼‰ 8ã€resources/application.yml YAML é…ç½® YAML ç°åœ¨å¯ä»¥ç®—æ˜¯éå¸¸æµè¡Œçš„ä¸€ç§é…ç½®æ–‡ä»¶æ ¼å¼äº†ï¼Œæ— è®ºæ˜¯å‰ç«¯è¿˜æ˜¯åç«¯ï¼Œéƒ½å¯ä»¥è§åˆ° YAML é…ç½®ã€‚é‚£ä¹ˆ YAML é…ç½®å’Œä¼ ç»Ÿçš„ properties é…ç½®ç›¸æ¯”åˆ°åº•æœ‰å“ªäº›ä¼˜åŠ¿å‘¢ï¼Ÿ é…ç½®æœ‰åºï¼Œåœ¨ä¸€äº›ç‰¹æ®Šçš„åœºæ™¯ä¸‹ï¼Œé…ç½®æœ‰åºå¾ˆå…³é”® æ”¯æŒæ•°ç»„ï¼Œæ•°ç»„ä¸­çš„å…ƒç´ å¯ä»¥æ˜¯åŸºæœ¬æ•°æ®ç±»å‹ä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡ ç®€æ´ ç›¸æ¯” properties é…ç½®æ–‡ä»¶ï¼ŒYAML è¿˜æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯ä¸æ”¯æŒ @PropertySource æ³¨è§£å¯¼å…¥è‡ªå®šä¹‰çš„ YAML é…ç½®ã€‚ Spring Boot æ˜¯å¦å¯ä»¥ä½¿ç”¨ XML é…ç½® Spring Boot æ¨èä½¿ç”¨ Java é…ç½®è€Œé XML é…ç½®ï¼Œä½†æ˜¯ Spring Boot ä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨ XML é…ç½®ï¼Œé€šè¿‡ @ImportResource æ³¨è§£å¯ä»¥å¼•å…¥ä¸€ä¸ª XML é…ç½®ã€‚ spring boot æ ¸å¿ƒé…ç½®æ–‡ä»¶bootstrap.propertieså’Œ application.properties æœ‰ä½•åŒºåˆ« å•çº¯åš Spring Boot å¼€å‘ï¼Œå¯èƒ½ä¸å¤ªå®¹æ˜“é‡åˆ° bootstrap.properties é…ç½®æ–‡ä»¶ï¼Œä½†æ˜¯åœ¨ç»“åˆ Spring Cloud æ—¶ï¼Œè¿™ä¸ªé…ç½®å°±ä¼šç»å¸¸é‡åˆ°äº†ï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦åŠ è½½ä¸€äº›è¿œç¨‹é…ç½®æ–‡ä»¶çš„æ—¶ä¾¯ã€‚ spring boot æ ¸å¿ƒçš„ä¸¤ä¸ªé…ç½®æ–‡ä»¶ï¼š bootstrap (. yml æˆ–è€… . properties)ï¼šboostrap ç”±çˆ¶ ApplicationContext åŠ è½½çš„ï¼Œæ¯” applicaton ä¼˜å…ˆåŠ è½½ï¼Œé…ç½®åœ¨åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡çš„å¼•å¯¼é˜¶æ®µç”Ÿæ•ˆã€‚ä¸€èˆ¬æ¥è¯´æˆ‘ä»¬åœ¨ Spring Cloud Config æˆ–è€… Nacos ä¸­ä¼šç”¨åˆ°å®ƒã€‚ä¸” boostrap é‡Œé¢çš„å±æ€§ä¸èƒ½è¢«è¦†ç›–ï¼› application (. yml æˆ–è€… . properties)ï¼š ç”±ApplicatonContext åŠ è½½ï¼Œç”¨äº spring boot é¡¹ç›®çš„è‡ªåŠ¨åŒ–é…ç½®ã€‚ Spring Profiles spring: profiles: active: devel #æŒ‡å®šæ¿€æ´»å“ªä¸ªç¯å¢ƒé…ç½®ï¼Œæ¿€æ´»åï¼Œç¬¬ä¸€ä¸ªæ–‡æ¡£å†…å®¹å¤±æ•ˆ;ä¸æŒ‡å®šæ—¶ï¼Œä»¥ç¬¬ä¸€ä¸ªæ–‡æ¡£ä¸ºå‡† server: port: 8083 --- #&quot;---&quot;ç”¨äºåˆ†éš”ä¸åŒçš„profilesï¼ˆï¼‰æ–‡æ¡£å— spring: profiles: devel #æŒ‡å®šç¯å¢ƒæ ‡è¯†ä¸º&quot;devel&quot;,ç›¸å½“äº&quot;application-{profile}.properties/yml&quot;ä¸­çš„profile server: port: 8081 --- spring: profiles: deploy #æŒ‡å®šç¯å¢ƒæ ‡è¯†ä¸º&quot;deploy&quot;,ç›¸å½“äº&quot;application-{profile}.properties/yml&quot;ä¸­çš„profile server: port: 8082 æ¯”è¾ƒä¸€ä¸‹ Spring Security å’Œ Shiro å„è‡ªçš„ä¼˜ç¼ºç‚¹ ç”±äº Spring Boot å®˜æ–¹æä¾›äº†å¤§é‡çš„éå¸¸æ–¹ä¾¿çš„å¼€ç®±å³ç”¨çš„ Starter ï¼ŒåŒ…æ‹¬ Spring Security çš„ Starter ï¼Œä½¿å¾—åœ¨ Spring Boot ä¸­ä½¿ç”¨ Spring Security å˜å¾—æ›´åŠ å®¹æ˜“ï¼Œç”šè‡³åªéœ€è¦æ·»åŠ ä¸€ä¸ªä¾èµ–å°±å¯ä»¥ä¿æŠ¤æ‰€æœ‰çš„æ¥å£ï¼Œæ‰€ä»¥ï¼Œå¦‚æœæ˜¯ Spring Boot é¡¹ç›®ï¼Œä¸€èˆ¬é€‰æ‹© Spring Security ã€‚å½“ç„¶è¿™åªæ˜¯ä¸€ä¸ªå»ºè®®çš„ç»„åˆï¼Œå•çº¯ä»æŠ€æœ¯ä¸Šæ¥è¯´ï¼Œæ— è®ºæ€ä¹ˆç»„åˆï¼Œéƒ½æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚Shiro å’Œ Spring Security ç›¸æ¯”ï¼Œä¸»è¦æœ‰å¦‚ä¸‹ä¸€äº›ç‰¹ç‚¹ï¼š Spring Security æ˜¯ä¸€ä¸ªé‡é‡çº§çš„å®‰å…¨ç®¡ç†æ¡†æ¶ï¼›Shiro åˆ™æ˜¯ä¸€ä¸ªè½»é‡çº§çš„å®‰å…¨ç®¡ç†æ¡†æ¶ Spring Security æ¦‚å¿µå¤æ‚ï¼Œé…ç½®ç¹çï¼›Shiro æ¦‚å¿µç®€å•ã€é…ç½®ç®€å• Spring Security åŠŸèƒ½å¼ºå¤§ï¼›Shiro åŠŸèƒ½ç®€å• Spring Boot ä¸­å¦‚ä½•è§£å†³è·¨åŸŸé—®é¢˜ è·¨åŸŸå¯ä»¥åœ¨å‰ç«¯é€šè¿‡ JSONP æ¥è§£å†³ï¼Œä½†æ˜¯ JSONP åªå¯ä»¥å‘é€ GET è¯·æ±‚ï¼Œæ— æ³•å‘é€å…¶ä»–ç±»å‹çš„è¯·æ±‚ï¼Œåœ¨ RESTful é£æ ¼çš„åº”ç”¨ä¸­ï¼Œå°±æ˜¾å¾—éå¸¸é¸¡è‚‹ï¼Œå› æ­¤æˆ‘ä»¬æ¨èåœ¨åç«¯é€šè¿‡ CORSï¼Œ(Cross-origin resource sharingï¼‰ æ¥è§£å†³è·¨åŸŸé—®é¢˜ã€‚è¿™ç§è§£å†³æ–¹æ¡ˆå¹¶é Spring Boot ç‰¹æœ‰çš„ï¼Œåœ¨ä¼ ç»Ÿçš„ SSM æ¡†æ¶ä¸­ï¼Œå°±å¯ä»¥é€šè¿‡ CORS æ¥è§£å†³è·¨åŸŸé—®é¢˜ï¼Œåªä¸è¿‡ä¹‹å‰æˆ‘ä»¬æ˜¯åœ¨ XML æ–‡ä»¶ä¸­é…ç½® CORS ï¼Œç°åœ¨å¯ä»¥é€šè¿‡å®ç°WebMvcConfigureræ¥å£ç„¶åé‡å†™addCorsMappingsæ–¹æ³•è§£å†³è·¨åŸŸé—®é¢˜ã€‚ @Configuration public class CorsConfig implements WebMvcConfigurer { @Override public void addCorsMappings(CorsRegistry registry) { registry.addMapping(&quot;/**&quot;) .allowedOrigins(&quot;*&quot;) .allowCredentials(true) .allowedMethods(&quot;GET&quot;, &quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;, &quot;OPTIONS&quot;) .maxAge(3600); } } é¡¹ç›®ä¸­å‰åç«¯åˆ†ç¦»éƒ¨ç½²ï¼Œæ‰€ä»¥éœ€è¦è§£å†³è·¨åŸŸçš„é—®é¢˜ã€‚ æˆ‘ä»¬ä½¿ç”¨cookieå­˜æ”¾ç”¨æˆ·ç™»å½•çš„ä¿¡æ¯ï¼Œåœ¨springæ‹¦æˆªå™¨è¿›è¡Œæƒé™æ§åˆ¶ï¼Œå½“æƒé™ä¸ç¬¦åˆæ—¶ï¼Œç›´æ¥è¿”å›ç»™ç”¨æˆ·å›ºå®šçš„jsonç»“æœã€‚ å½“ç”¨æˆ·ç™»å½•ä»¥åï¼Œæ­£å¸¸ä½¿ç”¨ï¼›å½“ç”¨æˆ·é€€å‡ºç™»å½•çŠ¶æ€æ—¶æˆ–è€…tokenè¿‡æœŸæ—¶ï¼Œç”±äºæ‹¦æˆªå™¨å’Œè·¨åŸŸçš„é¡ºåºæœ‰é—®é¢˜ï¼Œå‡ºç°äº†è·¨åŸŸçš„ç°è±¡ã€‚ æˆ‘ä»¬çŸ¥é“ä¸€ä¸ªhttpè¯·æ±‚ï¼Œå…ˆèµ°filterï¼Œåˆ°è¾¾servletåæ‰è¿›è¡Œæ‹¦æˆªå™¨çš„å¤„ç†ï¼Œå¦‚æœæˆ‘ä»¬æŠŠcorsæ”¾åœ¨filteré‡Œï¼Œå°±å¯ä»¥ä¼˜å…ˆäºæƒé™æ‹¦æˆªå™¨æ‰§è¡Œã€‚ @Configuration public class CorsConfig { @Bean public CorsFilter corsFilter() { CorsConfiguration corsConfiguration = new CorsConfiguration(); corsConfiguration.addAllowedOrigin(&quot;*&quot;); corsConfiguration.addAllowedHeader(&quot;*&quot;); corsConfiguration.addAllowedMethod(&quot;*&quot;); corsConfiguration.setAllowCredentials(true); UrlBasedCorsConfigurationSource urlBasedCorsConfigurationSource = new UrlBasedCorsConfigurationSource(); urlBasedCorsConfigurationSource.registerCorsConfiguration(&quot;/**&quot;, corsConfiguration); return new CorsFilter(urlBasedCorsConfigurationSource); } } Spring Boot ä¸­çš„ç›‘è§†å™¨ Spring boot actuator æ˜¯ spring å¯åŠ¨æ¡†æ¶ä¸­çš„é‡è¦åŠŸèƒ½ä¹‹ä¸€ã€‚Spring boot ç›‘è§†å™¨å¯å¸®åŠ©æ‚¨è®¿é—®ç”Ÿäº§ç¯å¢ƒä¸­æ­£åœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åºçš„å½“å‰çŠ¶æ€ã€‚æœ‰å‡ ä¸ªæŒ‡æ ‡å¿…é¡»åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿›è¡Œæ£€æŸ¥å’Œç›‘æ§ã€‚å³ä½¿ä¸€äº›å¤–éƒ¨åº”ç”¨ç¨‹åºå¯èƒ½æ­£åœ¨ä½¿ç”¨è¿™äº›æœåŠ¡æ¥å‘ç›¸å…³äººå‘˜è§¦å‘è­¦æŠ¥æ¶ˆæ¯ã€‚ç›‘è§†å™¨æ¨¡å—å…¬å¼€äº†ä¸€ç»„å¯ç›´æ¥ä½œä¸º HTTP URL è®¿é—®çš„REST ç«¯ç‚¹æ¥æ£€æŸ¥çŠ¶æ€ã€‚ æ³¨å†Œ Servlet ä¸‰å¤§ç»„ä»¶ Servletã€Filterã€Listener ç»§æ‰¿ï¼Œæ¥å£å®ç°æ–¹å¼ ServletRegistrationBean æ³¨å†Œ Servlet 1ã€è‡ªå®šä¹‰ç±»ç»§æ‰¿ javax.servlet.http.HttpServletï¼Œç„¶åé‡å†™å…¶ doGet ä¸ doPost æ–¹æ³•ï¼Œåœ¨æ–¹æ³•ä¸­ç¼–å†™æ§åˆ¶ä»£ç ï¼› 2ã€ç¬¬äºŒæ­¥å°† ServletRegistrationBean ç»„ä»¶æ·»åŠ åˆ° Spring å®¹å™¨ä¸­ import javax.servlet.ServletException; import javax.servlet.http.HttpServlet; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; import java.io.IOException; /** * Created by Administrator * æ ‡å‡†çš„ Servlet å®ç° HttpServletï¼›é‡å†™å…¶ doGet ã€doPost æ–¹æ³• */ public class BookServlet extends HttpServlet { @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException { this.doPost(req, resp); } @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException { System.out.println(&quot;:com.lct.servlet.BookServlet:&quot; + req.getRequestURL()); /**è®²æ±‚è½¬å‘åˆ°åå°çš„ user/users è¯·æ±‚å»ï¼Œå³ä¼šè¿›å…¥*/ req.getRequestDispatcher(&quot;user/users&quot;).forward(req, resp); } } 3ã€ä¸Šé¢ Serlvet è½¬å‘åˆ°ä¸‹é¢çš„ UserControllr æ§åˆ¶å™¨ä¸­ 4ã€@Configuration é…ç½®ç±»ç›¸å½“äºä»¥å‰çš„ beans.xml ä¸­çš„é…ç½®ï¼Œå°† ServletRegistrationBean ä¹Ÿæ·»åŠ åˆ° Spring å®¹å™¨ä¸­æ¥ import com.lct.component.MyLocaleResolve; import com.lct.servlet.BookServlet; import org.springframework.boot.web.server.WebServerFactoryCustomizer; import org.springframework.boot.web.servlet.ServletRegistrationBean; import org.springframework.boot.web.servlet.server.ConfigurableServletWebServerFactory; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import org.springframework.web.servlet.LocaleResolver; /** * Created by Administrator * è‡ªå®šä¹‰é…ç½®ç±» */ @Configuration public class MyMvcConfig { /** * æ³¨å†Œ Servlet ä¸‰å¤§ç»„ä»¶ ä¹‹ Servlet * æ·»åŠ  ServletRegistrationBean ï¼Œå°±ç›¸å½“äºä»¥å‰åœ¨ web.xml ä¸­é…ç½®çš„ &lt;servlet&gt;&lt;/servlet&gt;æ ‡ç­¾ */ @Bean public ServletRegistrationBean myServlet() { /**ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸ªä¸å®šå‚æ•°ç»„ï¼Œå¯ä»¥é…ç½®æ˜ å°„å¤šä¸ªè¯·æ±‚ * ç›¸å½“äºä»¥å‰åœ¨ web.xmlä¸­é…ç½®çš„ &lt;servlet-mapptin&gt;&lt;/servlet-mapptin&gt;*/ ServletRegistrationBean registrationBean = new ServletRegistrationBean(new BookServlet(), &quot;/bookServlet&quot;); return registrationBean; } } 5ã€è¿è¡Œæµ‹è¯•ï¼š FilterRegistrationBean æ³¨å†Œ Filter 1ã€Filter(è¿‡æ»¤å™¨) æ˜¯ Servlet æŠ€æœ¯ä¸­æœ€å®ç”¨çš„æŠ€æœ¯ä¹‹ä¸€ 2ã€Web å¼€å‘äººå‘˜é€šè¿‡ Filter æŠ€æœ¯ï¼Œå¯¹ web æœåŠ¡å™¨ç®¡ç†çš„æ‰€æœ‰ web èµ„æº(å¦‚åŠ¨æ€çš„ Jspã€ Servletï¼Œä»¥åŠé™æ€çš„ imageã€ htmlã€CSSã€JS æ–‡ä»¶ç­‰) è¿›è¡Œè¿‡æ»¤æ‹¦æˆªï¼Œä»è€Œå®ç°ä¸€äº›ç‰¹æ®Šçš„åŠŸèƒ½(å¦‚å®ç° URL çº§åˆ«çš„æƒé™è®¿é—®æ§åˆ¶ã€è¿‡æ»¤æ•æ„Ÿè¯æ±‡ã€å‹ç¼©å“åº”ä¿¡æ¯ç­‰) 3ã€Filter ä¸»è¦ç”¨äºå¯¹ç”¨æˆ·è¯·æ±‚è¿›è¡Œé¢„å¤„ç†ï¼Œä¹Ÿå¯ä»¥å¯¹ HttpServletResponse è¿›è¡ŒåæœŸå¤„ç†(å¦‚ç¼–ç è®¾ç½®ï¼Œè¿”å›æ—¶ç¦ç”¨æµè§ˆå™¨ç¼“å­˜ç­‰) 4ã€Filter ä½¿ç”¨å®Œæ•´æµç¨‹ï¼šFilter å¯¹ç”¨æˆ·è¯·æ±‚è¿›è¡Œé¢„å¤„ç†ï¼Œæ¥ç€å°†è¯·æ±‚äº¤ç»™ Servlet è¿›è¡Œå¤„ç†å¹¶ç”Ÿæˆå“åº”ï¼Œæœ€å Filter å†å¯¹æœåŠ¡å™¨å“åº”è¿›è¡Œåå¤„ç†ã€‚ 5ã€Servlet çš„ Filter ç»å¸¸ä¼šæ‹¿æ¥ä¸ Spring MVC çš„ Interceptor(æ‹¦æˆªå™¨) åšå¯¹æ¯” â€‹ 1ï¼‰æ‹¦æˆªå™¨æ˜¯åŸºäº Java çš„åå°„æœºåˆ¶çš„ï¼Œè€Œè¿‡æ»¤å™¨æ˜¯åŸºäºå‡½æ•°å›è°ƒ â€‹ 2ï¼‰æ‹¦æˆªå™¨ä¸ä¾èµ–ä¸ servle tå®¹å™¨ï¼Œè¿‡æ»¤å™¨ä¾èµ–ä¸ servlet å®¹å™¨ â€‹ 3ï¼‰æ‹¦æˆªå™¨å¯ä»¥è®¿é—® action ä¸Šä¸‹æ–‡ã€å€¼æ ˆé‡Œçš„å¯¹è±¡ï¼Œè€Œè¿‡æ»¤å™¨ä¸èƒ½è®¿é—® â€‹ 4ï¼‰åœ¨ action çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œæ‹¦æˆªå™¨å¯ä»¥å¤šæ¬¡è¢«è°ƒç”¨ï¼Œè€Œè¿‡æ»¤å™¨åªèƒ½åœ¨å®¹å™¨åˆå§‹åŒ–æ—¶è¢«è°ƒç”¨ä¸€æ¬¡ â€‹ 5ï¼‰æ‹¦æˆªå™¨å¯ä»¥è·å– IOC å®¹å™¨ä¸­çš„å„ä¸ª beanï¼Œè€Œè¿‡æ»¤å™¨å°±ä¸è¡Œï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œåœ¨æ‹¦æˆªå™¨é‡Œæ³¨å…¥ä¸€ä¸ª serviceï¼Œå¯ä»¥è°ƒç”¨ä¸šåŠ¡é€»è¾‘ â€‹ 6ï¼‰SpringMVC æœ‰è‡ªå·±çš„æ‹¦æˆªå™¨ import javax.servlet.*; import javax.servlet.http.HttpServletRequest; import java.io.IOException; /** * Created by Administrator * æ ‡å‡† Servlet è¿‡æ»¤å™¨ï¼Œå®ç° javax.servlet.Filter æ¥å£ * å¹¶é‡å†™å®ƒçš„ ä¸‰ä¸ªæ–¹æ³• */ public class SystemFilter implements Filter { @Override public void init(FilterConfig filterConfig) throws ServletException { System.out.println(&quot;javax.servlet.Filterï¼šï¼šæœåŠ¡å™¨å¯åŠ¨....&quot;); } @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException { /** * è½¬ä¸º HttpServletRequest è¾“å‡ºè¯·æ±‚è·¯å¾„ å®¹æ˜“æŸ¥çœ‹ è¯·æ±‚åœ°å€ */ HttpServletRequest request = (HttpServletRequest) servletRequest; System.out.println(&quot;javax.servlet.Filterï¼šï¼šè¿‡æ»¤å™¨æ”¾è¡Œå‰....&quot; + request.getRequestURL()); filterChain.doFilter(servletRequest, servletResponse); System.out.println(&quot;javax.servlet.Filterï¼šï¼šè¿‡æ»¤å™¨è¿”å›å....&quot; + request.getRequestURL()); } @Override public void destroy() { System.out.println(&quot;javax.servlet.Filterï¼šï¼šæœåŠ¡å™¨å…³é—­....&quot;); } } 6ã€ä½¿ç”¨ FilterRegistrationBean æ·»åŠ  FIlter ï¼š import com.lct.component.MyLocaleResolve; import com.lct.filter.SystemFilter; import com.lct.servlet.BookServlet; import org.springframework.boot.web.server.WebServerFactoryCustomizer; import org.springframework.boot.web.servlet.FilterRegistrationBean; import org.springframework.boot.web.servlet.ServletRegistrationBean; import org.springframework.boot.web.servlet.server.ConfigurableServletWebServerFactory; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import org.springframework.web.servlet.LocaleResolver; import javax.servlet.DispatcherType; import java.util.Arrays; /** * Created by Administrator * è‡ªå®šä¹‰é…ç½®ç±» */ @Configuration public class MyMvcConfig { /** * æ³¨å†Œ Servlet ä¸‰å¤§ç»„ä»¶ ä¹‹ Filter (è¿‡æ»¤å™¨) * æ·»åŠ  FilterRegistrationBean ï¼Œå°±ç›¸å½“äºä»¥å‰åœ¨ web.xml ä¸­é…ç½®çš„ &lt;filter&gt;&lt;/filter&gt; æ ‡ç­¾ */ @Bean public FilterRegistrationBean myFilter() { FilterRegistrationBean registrationBean = new FilterRegistrationBean(); /**åŒæ ·æ·»åŠ è‡ªå®šä¹‰çš„ Filter*/ registrationBean.setFilter(new SystemFilter()); /**ç„¶åè®¾ç½®è¿‡æ»¤çš„è·¯å¾„ï¼Œå‚æ•°æ˜¯ä¸ªé›†åˆ ,ç›¸å½“äº web.xmlä¸­é…ç½®çš„ &lt;filter-mapptin&gt;&lt;/filter-mapptin&gt; * &quot;/*&quot;: è¡¨ç¤ºè¿‡æ»¤æ‰€æœ‰ get ä¸ post è¯·æ±‚*/ registrationBean.setUrlPatterns(Arrays.asList(&quot;/*&quot;)); /** * setDispatcherTypes ç›¸å½“äº web.xml é…ç½®ä¸­ &lt;filter-mapptin&gt; ä¸‹çš„ &lt;dispatcher&gt; æ ‡ç­¾ * ç”¨äºè¿‡æ»¤éå¸¸è§„çš„ get ã€post è¯·æ±‚ * REQUESTï¼šé»˜è®¤æ–¹å¼ï¼Œå†™äº†ä¹‹åä¼šè¿‡æ»¤æ‰€æœ‰é™æ€èµ„æºçš„è¯·æ±‚ * FORWARDï¼šè¿‡æ»¤æ‰€æœ‰çš„è½¬å‘è¯·æ±‚ï¼Œæ— è®ºæ˜¯ jsp ä¸­çš„ &lt;jsp:forward&lt;/&gt;ã€&lt;%@ page errorPage= %&gt;ã€è¿˜æ˜¯åå°çš„è½¬å‘ * INCLUDEï¼šè¿‡æ»¤ jsp ä¸­çš„åŠ¨æ€åŒ…å«&lt;jsp:include è¯·æ±‚ * ERRORï¼šè¿‡æ»¤åœ¨ web.xml é…ç½®çš„å…¨å±€é”™è¯¯é¡µé¢ * äº†è§£å³å¯ï¼Œå®é™…ä¸­ä¹Ÿå¾ˆå°‘è¿™ä¹ˆåš */ registrationBean.setDispatcherTypes(DispatcherType.REQUEST); return registrationBean; } } ServletListenerRegistrationBean æ³¨å†Œ Listener 1ã€è‡ªå®šä¹‰ç›‘å¬å™¨ï¼š import javax.servlet.ServletContextEvent; import javax.servlet.ServletContextListener; /** * Created by Administrator on 2018/8/11 0011. * æ ‡å‡† Servlet ç›‘å¬å™¨ï¼Œå®ç° javax.servlet.ServletContextListener æ¥å£ * ç„¶åå®ç°æ–¹æ³• * ServletContextListenerï¼šå±äº Servlet åº”ç”¨å¯åŠ¨å…³é—­ç›‘å¬å™¨ï¼Œç›‘å¬å®¹å™¨åˆå§‹åŒ–ä¸é”€æ¯ */ public class SystemListener implements ServletContextListener { @Override public void contextInitialized(ServletContextEvent servletContextEvent) { System.out.println(&quot;com.lct.listener.SystemListener::æœåŠ¡å™¨å¯åŠ¨.....&quot;); } @Override public void contextDestroyed(ServletContextEvent servletContextEvent) { System.out.println(&quot;com.lct.listener.SystemListener::æœåŠ¡å™¨å…³é—­.....&quot;); } } 2ã€æ³¨å†Œ ServletListenerRegistrationBeanï¼š import com.lct.component.MyLocaleResolve; import com.lct.filter.SystemFilter; import com.lct.listener.SystemListener; import com.lct.servlet.BookServlet; import org.springframework.boot.web.server.WebServerFactoryCustomizer; import org.springframework.boot.web.servlet.FilterRegistrationBean; import org.springframework.boot.web.servlet.ServletListenerRegistrationBean; import org.springframework.boot.web.servlet.ServletRegistrationBean; import org.springframework.boot.web.servlet.server.ConfigurableServletWebServerFactory; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import org.springframework.web.servlet.LocaleResolver; import java.util.Arrays; /** * Created by Administrator * è‡ªå®šä¹‰é…ç½®ç±» */ @Configuration public class MyMvcConfig { /** * æ³¨å†Œ Servlet ä¸‰å¤§ç»„ä»¶ ä¹‹ Listner * æ·»åŠ  ServletListenerRegistrationBean ï¼Œå°±ç›¸å½“äºä»¥å‰åœ¨ web.xml ä¸­é…ç½®çš„ &lt;listener&gt;&lt;/listener&gt;æ ‡ç­¾ */ @Bean public ServletListenerRegistrationBean myListener() { /**ServletListenerRegistrationBean&lt;T extends EventListener&gt; å±äºçš„æ˜¯æ³›å‹ï¼Œå¯ä»¥æ³¨å†Œå¸¸è§çš„ä»»æ„ç›‘å¬å™¨ * å°†è‡ªå·±çš„ç›‘å¬å™¨æ³¨å†Œè¿›æ¥*/ ServletListenerRegistrationBean registrationBean = new ServletListenerRegistrationBean(new SystemListener()); return registrationBean; } } æ³¨è§£æ–¹å¼ 1ã€Servlet ä¸‰å¤§ç»„ä»¶ Servletã€Filterã€Listener åœ¨ä¼ ç»Ÿé¡¹ç›®ä¸­éœ€è¦åœ¨ web.xml ä¸­è¿›è¡Œç›¸åº”çš„é…ç½®ã€‚Servlet 3.0 å¼€å§‹åœ¨ javax.servlet.annotation åŒ…ä¸‹æä¾› 3 ä¸ªå¯¹åº” çš„ @WebServletã€@WebFilterã€@WebListener æ³¨è§£æ¥ç®€åŒ–æ“ä½œã€‚ 2ã€Spring Boot åº”ç”¨ä¸­è¿™ä¸‰ä¸ªæ³¨è§£é»˜è®¤æ˜¯ä¸è¢«æ‰«æçš„ï¼Œéœ€è¦åœ¨é¡¹ç›®å¯åŠ¨ç±»ä¸Šæ·»åŠ  @ServletComponentScan æ³¨è§£, è¡¨ç¤ºå¯¹ Servlet ç»„ä»¶æ‰«æã€‚ @WebServlet import javax.servlet.ServletException; import javax.servlet.annotation.WebServlet; import javax.servlet.http.HttpServlet; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; import java.io.IOException; /** * æ ‡å‡†çš„ Servlet ï¼Œå®ç° javax.servlet.http.HttpServlet. é‡å†™å…¶ doGet ã€doPost æ–¹æ³• * name :è¡¨ç¤º servlet åç§°ï¼Œå¯ä»¥ä¸å†™ï¼Œé»˜è®¤ä¸ºç©º * urlPatterns: è¡¨ç¤ºè¯·æ±‚çš„è·¯å¾„ï¼Œå¦‚ http://ip:port/context-path/userServlet */ @WebServlet(name = &quot;UserServlet&quot;, urlPatterns = {&quot;/userServlet&quot;}) public class UserServlet extends HttpServlet { @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException { this.doPost(req, resp); } @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException { StringBuffer requestURL = req.getRequestURL(); System.out.println(&quot;com.wmx.servlet.UserServlet -- &quot; + requestURL); resp.sendRedirect(&quot;/index.html&quot;);//æµè§ˆå™¨é‡å®šå‘åˆ°æœåŠ¡å™¨ä¸‹çš„ index.html é¡µé¢ } } @WebFilter import javax.servlet.*; import javax.servlet.annotation.WebFilter; import javax.servlet.http.HttpServletRequest; import java.io.IOException; /** * æ ‡å‡† Servlet è¿‡æ»¤å™¨ï¼Œå®ç° javax.servlet.Filter æ¥å£ï¼Œå¹¶é‡ç°å®ƒçš„ 3 ä¸ªæ–¹æ³• * filterNameï¼šè¡¨ç¤ºè¿‡æ»¤å™¨åç§°ï¼Œå¯ä»¥ä¸å†™ * valueï¼šé…ç½®è¯·æ±‚è¿‡æ»¤çš„è§„åˆ™ï¼Œå¦‚ &quot;/*&quot; è¡¨ç¤ºè¿‡æ»¤æ‰€æœ‰è¯·æ±‚ï¼ŒåŒ…æ‹¬é™æ€èµ„æºï¼Œå¦‚ &quot;/user/*&quot; è¡¨ç¤º /user å¼€å¤´çš„æ‰€æœ‰è¯·æ±‚ */ @WebFilter(filterName = &quot;SystemFilter&quot;, value = {&quot;/*&quot;}) public class SystemFilter implements Filter { @Override public void init(FilterConfig filterConfig) throws ServletException { System.out.println(&quot;com.wmx.servlet.SystemFilter -- ç³»ç»Ÿå¯åŠ¨...&quot;); } @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException { //è½¬ä¸º HttpServletRequest è¾“å‡ºè¯·æ±‚è·¯å¾„ HttpServletRequest request = (HttpServletRequest) servletRequest; System.out.println(&quot;com.wmx.servlet.SystemFilter -- è¿‡æ»¤å™¨æ”¾è¡Œå‰....&quot; + request.getRequestURL()); filterChain.doFilter(servletRequest, servletResponse); System.out.println(&quot;com.wmx.servlet.SystemFilter -- è¿‡æ»¤å™¨è¿”å›å....&quot; + request.getRequestURL()); } @Override public void destroy() { System.out.println(&quot;com.wmx.servlet.SystemFilter -- ç³»ç»Ÿå…³é—­...&quot;); } } @WebListener import javax.servlet.ServletContextEvent; import javax.servlet.ServletContextListener; import javax.servlet.annotation.WebListener; /** * æ ‡å‡† Servlet ç›‘å¬å™¨ï¼Œå®ç° javax.servlet.ServletContextListener æ¥å£ï¼Œå¹¶é‡å†™æ–¹æ³• * ServletContextListener å±äº Servlet åº”ç”¨å¯åŠ¨å…³é—­ç›‘å¬å™¨ï¼Œç›‘å¬å®¹å™¨åˆå§‹åŒ–ä¸é”€æ¯ã€‚å¸¸ç”¨çš„ç›‘å¬å™¨è¿˜æœ‰ï¼š * ServletRequestListenerï¼šHttpServletRequest å¯¹è±¡çš„åˆ›å»ºå’Œé”€æ¯ç›‘å¬å™¨ * HttpSessionListenerï¼šHttpSession æ•°æ®å¯¹è±¡åˆ›å»ºå’Œé”€æ¯ç›‘å¬å™¨ * HttpSessionAttributeListener ç›‘å¬HttpSessionä¸­å±æ€§å˜åŒ– * ServletRequestAttributeListener ç›‘å¬ServletRequestä¸­å±æ€§å˜åŒ– */ @WebListener public class SystemListener implements ServletContextListener { @Override public void contextInitialized(ServletContextEvent sce) { System.out.println(&quot;com.wmx.servlet.SystemListener -- æœåŠ¡å™¨å¯åŠ¨.&quot;); } @Override public void contextDestroyed(ServletContextEvent sce) { System.out.println(&quot;com.wmx.servlet.SystemListener -- æœåŠ¡å™¨å…³é—­.&quot;); } } @ServletComponentScan Spring Boot åº”ç”¨ä¸­è¿™ä¸‰ä¸ªæ³¨è§£é»˜è®¤æ˜¯ä¸è¢«æ‰«æçš„ï¼Œéœ€è¦åœ¨é¡¹ç›®å¯åŠ¨ç±»ä¸Šæ·»åŠ  @ServletComponentScan æ³¨è§£, è¡¨ç¤ºå¯¹ Servlet ç»„ä»¶æ‰«æã€‚ import org.springframework.boot.SpringApplication; import org.springframework.boot.autoconfigure.SpringBootApplication; import org.springframework.boot.web.servlet.ServletComponentScan; @SpringBootApplication @ServletComponentScan //å¯¹ servlet æ³¨è§£è¿›è¡Œæ‰«æ public class RedisStuWebApplication { public static void main(String[] args) { SpringApplication.run(RedisStuWebApplication.class, args); } } ","link":"https://tianxiawuhao.github.io/O58auJO44/"},{"title":"SpringMVCå·¥ä½œåŸç†","content":"SpringMVCçš„å·¥ä½œåŸç†å›¾ï¼š SpringMVCæµç¨‹ 1ã€ ç”¨æˆ·å‘é€è¯·æ±‚è‡³å‰ç«¯æ§åˆ¶å™¨DispatcherServletã€‚ 2ã€ DispatcherServletæ”¶åˆ°è¯·æ±‚è°ƒç”¨HandlerMappingå¤„ç†å™¨æ˜ å°„å™¨ã€‚ 3ã€ å¤„ç†å™¨æ˜ å°„å™¨æ‰¾åˆ°å…·ä½“çš„å¤„ç†å™¨(å¯ä»¥æ ¹æ®xmlé…ç½®ã€æ³¨è§£è¿›è¡ŒæŸ¥æ‰¾)ï¼Œç”Ÿæˆå¤„ç†å™¨å¯¹è±¡åŠå¤„ç†å™¨æ‹¦æˆªå™¨(å¦‚æœæœ‰åˆ™ç”Ÿæˆ)ä¸€å¹¶è¿”å›ç»™DispatcherServletã€‚ 4ã€ DispatcherServletè°ƒç”¨HandlerAdapterå¤„ç†å™¨é€‚é…å™¨ã€‚ 5ã€ HandlerAdapterç»è¿‡é€‚é…è°ƒç”¨å…·ä½“çš„å¤„ç†å™¨(Controllerï¼Œä¹Ÿå«åç«¯æ§åˆ¶å™¨)ã€‚ 6ã€ Controlleræ‰§è¡Œå®Œæˆè¿”å›ModelAndViewã€‚ 7ã€ HandlerAdapterå°†controlleræ‰§è¡Œç»“æœModelAndViewè¿”å›ç»™DispatcherServletã€‚ 8ã€ DispatcherServletå°†ModelAndViewä¼ ç»™ViewResloverè§†å›¾è§£æå™¨ã€‚ 9ã€ ViewResloverè§£æåè¿”å›å…·ä½“Viewã€‚ 10ã€DispatcherServletæ ¹æ®Viewè¿›è¡Œæ¸²æŸ“è§†å›¾ï¼ˆå³å°†æ¨¡å‹æ•°æ®å¡«å……è‡³è§†å›¾ä¸­ï¼‰ã€‚ 11ã€ DispatcherServletå“åº”ç”¨æˆ·ã€‚ ç»„ä»¶è¯´æ˜ï¼š ä»¥ä¸‹ç»„ä»¶é€šå¸¸ä½¿ç”¨æ¡†æ¶æä¾›å®ç°ï¼š DispatcherServletï¼šä½œä¸ºå‰ç«¯æ§åˆ¶å™¨ï¼Œæ•´ä¸ªæµç¨‹æ§åˆ¶çš„ä¸­å¿ƒï¼Œæ§åˆ¶å…¶å®ƒç»„ä»¶æ‰§è¡Œï¼Œç»Ÿä¸€è°ƒåº¦ï¼Œé™ä½ç»„ä»¶ä¹‹é—´çš„è€¦åˆæ€§ï¼Œæé«˜æ¯ä¸ªç»„ä»¶çš„æ‰©å±•æ€§ã€‚ HandlerMappingï¼šé€šè¿‡æ‰©å±•å¤„ç†å™¨æ˜ å°„å™¨å®ç°ä¸åŒçš„æ˜ å°„æ–¹å¼ï¼Œä¾‹å¦‚ï¼šé…ç½®æ–‡ä»¶æ–¹å¼ï¼Œå®ç°æ¥å£æ–¹å¼ï¼Œæ³¨è§£æ–¹å¼ç­‰ã€‚ HandlAdapterï¼šé€šè¿‡æ‰©å±•å¤„ç†å™¨é€‚é…å™¨ï¼Œæ”¯æŒæ›´å¤šç±»å‹çš„å¤„ç†å™¨ã€‚ ViewResolverï¼šé€šè¿‡æ‰©å±•è§†å›¾è§£æå™¨ï¼Œæ”¯æŒæ›´å¤šç±»å‹çš„è§†å›¾è§£æï¼Œä¾‹å¦‚ï¼šjspã€freemarkerã€pdfã€excelç­‰ã€‚ ç»„ä»¶ï¼š 1ã€å‰ç«¯æ§åˆ¶å™¨DispatcherServletï¼ˆä¸éœ€è¦å·¥ç¨‹å¸ˆå¼€å‘ï¼‰,ç”±æ¡†æ¶æä¾› ä½œç”¨ï¼šæ¥æ”¶è¯·æ±‚ï¼Œå“åº”ç»“æœï¼Œç›¸å½“äºè½¬å‘å™¨ï¼Œä¸­å¤®å¤„ç†å™¨ã€‚æœ‰äº†dispatcherServletå‡å°‘äº†å…¶å®ƒç»„ä»¶ä¹‹é—´çš„è€¦åˆåº¦ã€‚ ç”¨æˆ·è¯·æ±‚åˆ°è¾¾å‰ç«¯æ§åˆ¶å™¨ï¼Œå®ƒå°±ç›¸å½“äºmvcæ¨¡å¼ä¸­çš„cï¼ŒdispatcherServletæ˜¯æ•´ä¸ªæµç¨‹æ§åˆ¶çš„ä¸­å¿ƒï¼Œç”±å®ƒè°ƒç”¨å…¶å®ƒç»„ä»¶å¤„ç†ç”¨æˆ·çš„è¯·æ±‚ï¼ŒdispatcherServletçš„å­˜åœ¨é™ä½äº†ç»„ä»¶ä¹‹é—´çš„è€¦åˆæ€§ã€‚ 2ã€å¤„ç†å™¨æ˜ å°„å™¨HandlerMapping(ä¸éœ€è¦å·¥ç¨‹å¸ˆå¼€å‘),ç”±æ¡†æ¶æä¾› ä½œç”¨ï¼šæ ¹æ®è¯·æ±‚çš„urlæŸ¥æ‰¾Handler HandlerMappingè´Ÿè´£æ ¹æ®ç”¨æˆ·è¯·æ±‚æ‰¾åˆ°Handlerå³å¤„ç†å™¨ï¼Œspringmvcæä¾›äº†ä¸åŒçš„æ˜ å°„å™¨å®ç°ä¸åŒçš„æ˜ å°„æ–¹å¼ï¼Œä¾‹å¦‚ï¼šé…ç½®æ–‡ä»¶æ–¹å¼ï¼Œå®ç°æ¥å£æ–¹å¼ï¼Œæ³¨è§£æ–¹å¼ç­‰ã€‚ 3ã€å¤„ç†å™¨é€‚é…å™¨HandlerAdapter ä½œç”¨ï¼šæŒ‰ç…§ç‰¹å®šè§„åˆ™ï¼ˆHandlerAdapterè¦æ±‚çš„è§„åˆ™ï¼‰å»æ‰§è¡ŒHandler é€šè¿‡HandlerAdapterå¯¹å¤„ç†å™¨è¿›è¡Œæ‰§è¡Œï¼Œè¿™æ˜¯é€‚é…å™¨æ¨¡å¼çš„åº”ç”¨ï¼Œé€šè¿‡æ‰©å±•é€‚é…å™¨å¯ä»¥å¯¹æ›´å¤šç±»å‹çš„å¤„ç†å™¨è¿›è¡Œæ‰§è¡Œã€‚ 4ã€å¤„ç†å™¨Handler(éœ€è¦å·¥ç¨‹å¸ˆå¼€å‘) æ³¨æ„ï¼šç¼–å†™Handleræ—¶æŒ‰ç…§HandlerAdapterçš„è¦æ±‚å»åšï¼Œè¿™æ ·é€‚é…å™¨æ‰å¯ä»¥å»æ­£ç¡®æ‰§è¡ŒHandler Handler æ˜¯ç»§DispatcherServletå‰ç«¯æ§åˆ¶å™¨çš„åç«¯æ§åˆ¶å™¨ï¼Œåœ¨DispatcherServletçš„æ§åˆ¶ä¸‹Handlerå¯¹å…·ä½“çš„ç”¨æˆ·è¯·æ±‚è¿›è¡Œå¤„ç†ã€‚ ç”±äºHandleræ¶‰åŠåˆ°å…·ä½“çš„ç”¨æˆ·ä¸šåŠ¡è¯·æ±‚ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µéœ€è¦å·¥ç¨‹å¸ˆæ ¹æ®ä¸šåŠ¡éœ€æ±‚å¼€å‘Handlerã€‚ 5ã€è§†å›¾è§£æå™¨View resolver(ä¸éœ€è¦å·¥ç¨‹å¸ˆå¼€å‘),ç”±æ¡†æ¶æä¾› ä½œç”¨ï¼šè¿›è¡Œè§†å›¾è§£æï¼Œæ ¹æ®é€»è¾‘è§†å›¾åè§£ææˆçœŸæ­£çš„è§†å›¾ï¼ˆviewï¼‰ View Resolverè´Ÿè´£å°†å¤„ç†ç»“æœç”ŸæˆViewè§†å›¾ï¼ŒView Resolveré¦–å…ˆæ ¹æ®é€»è¾‘è§†å›¾åè§£ææˆç‰©ç†è§†å›¾åå³å…·ä½“çš„é¡µé¢åœ°å€ï¼Œå†ç”ŸæˆViewè§†å›¾å¯¹è±¡ï¼Œæœ€åå¯¹Viewè¿›è¡Œæ¸²æŸ“å°†å¤„ç†ç»“æœé€šè¿‡é¡µé¢å±•ç¤ºç»™ç”¨æˆ·ã€‚ springmvcæ¡†æ¶æä¾›äº†å¾ˆå¤šçš„Viewè§†å›¾ç±»å‹ï¼ŒåŒ…æ‹¬ï¼šjstlViewã€freemarkerViewã€pdfViewç­‰ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹éœ€è¦é€šè¿‡é¡µé¢æ ‡ç­¾æˆ–é¡µé¢æ¨¡ç‰ˆæŠ€æœ¯å°†æ¨¡å‹æ•°æ®é€šè¿‡é¡µé¢å±•ç¤ºç»™ç”¨æˆ·ï¼Œéœ€è¦ç”±å·¥ç¨‹å¸ˆæ ¹æ®ä¸šåŠ¡éœ€æ±‚å¼€å‘å…·ä½“çš„é¡µé¢ã€‚ 6ã€è§†å›¾View(éœ€è¦å·¥ç¨‹å¸ˆå¼€å‘jsp...) Viewæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ç°ç±»æ”¯æŒä¸åŒçš„Viewç±»å‹ï¼ˆjspã€freemarkerã€pdf...ï¼‰ æ ¸å¿ƒæ¶æ„çš„å…·ä½“æµç¨‹æ­¥éª¤å¦‚ä¸‹ï¼š 1ã€é¦–å…ˆç”¨æˆ·å‘é€è¯·æ±‚â€”â€”&gt;DispatcherServletï¼Œå‰ç«¯æ§åˆ¶å™¨æ”¶åˆ°è¯·æ±‚åè‡ªå·±ä¸è¿›è¡Œå¤„ç†ï¼Œè€Œæ˜¯å§”æ‰˜ç»™å…¶ä»–çš„è§£æå™¨è¿›è¡Œå¤„ç†ï¼Œä½œä¸ºç»Ÿä¸€è®¿é—®ç‚¹ï¼Œè¿›è¡Œå…¨å±€çš„æµç¨‹æ§åˆ¶ï¼› 2ã€DispatcherServletâ€”â€”&gt;HandlerMappingï¼Œ HandlerMapping å°†ä¼šæŠŠè¯·æ±‚æ˜ å°„ä¸ºHandlerExecutionChain å¯¹è±¡ï¼ˆåŒ…å«ä¸€ä¸ªHandler å¤„ç†å™¨ï¼ˆé¡µé¢æ§åˆ¶å™¨ï¼‰å¯¹è±¡ã€å¤šä¸ªHandlerInterceptor æ‹¦æˆªå™¨ï¼‰å¯¹è±¡ï¼Œé€šè¿‡è¿™ç§ç­–ç•¥æ¨¡å¼ï¼Œå¾ˆå®¹æ˜“æ·»åŠ æ–°çš„æ˜ å°„ç­–ç•¥ï¼› 3ã€DispatcherServletâ€”â€”&gt;HandlerAdapterï¼ŒHandlerAdapter å°†ä¼šæŠŠå¤„ç†å™¨åŒ…è£…ä¸ºé€‚é…å™¨ï¼Œä»è€Œæ”¯æŒå¤šç§ç±»å‹çš„å¤„ç†å™¨ï¼Œå³é€‚é…å™¨è®¾è®¡æ¨¡å¼çš„åº”ç”¨ï¼Œä»è€Œå¾ˆå®¹æ˜“æ”¯æŒå¾ˆå¤šç±»å‹çš„å¤„ç†å™¨ï¼› 4ã€HandlerAdapterâ€”â€”&gt;å¤„ç†å™¨åŠŸèƒ½å¤„ç†æ–¹æ³•çš„è°ƒç”¨ï¼ŒHandlerAdapter å°†ä¼šæ ¹æ®é€‚é…çš„ç»“æœè°ƒç”¨çœŸæ­£çš„å¤„ç†å™¨çš„åŠŸèƒ½å¤„ç†æ–¹æ³•ï¼Œå®ŒæˆåŠŸèƒ½å¤„ç†ï¼›å¹¶è¿”å›ä¸€ä¸ªModelAndView å¯¹è±¡ï¼ˆåŒ…å«æ¨¡å‹æ•°æ®ã€é€»è¾‘è§†å›¾åï¼‰ï¼› 5ã€ModelAndViewçš„é€»è¾‘è§†å›¾åâ€”â€”&gt; ViewResolverï¼Œ ViewResolver å°†æŠŠé€»è¾‘è§†å›¾åè§£æä¸ºå…·ä½“çš„Viewï¼Œé€šè¿‡è¿™ç§ç­–ç•¥æ¨¡å¼ï¼Œå¾ˆå®¹æ˜“æ›´æ¢å…¶ä»–è§†å›¾æŠ€æœ¯ï¼› 6ã€Viewâ€”â€”&gt;æ¸²æŸ“ï¼ŒViewä¼šæ ¹æ®ä¼ è¿›æ¥çš„Modelæ¨¡å‹æ•°æ®è¿›è¡Œæ¸²æŸ“ï¼Œæ­¤å¤„çš„Modelå®é™…æ˜¯ä¸€ä¸ªMapæ•°æ®ç»“æ„ï¼Œå› æ­¤å¾ˆå®¹æ˜“æ”¯æŒå…¶ä»–è§†å›¾æŠ€æœ¯ï¼› 7ã€è¿”å›æ§åˆ¶æƒç»™DispatcherServletï¼Œç”±DispatcherServletè¿”å›å“åº”ç»™ç”¨æˆ·ï¼Œåˆ°æ­¤ä¸€ä¸ªæµç¨‹ç»“æŸã€‚ ä¸‹è¾¹ä¸¤ä¸ªç»„ä»¶é€šå¸¸æƒ…å†µä¸‹éœ€è¦å¼€å‘ï¼š Handlerï¼šå¤„ç†å™¨ï¼Œå³åç«¯æ§åˆ¶å™¨ç”¨controllerè¡¨ç¤ºã€‚ Viewï¼šè§†å›¾ï¼Œå³å±•ç¤ºç»™ç”¨æˆ·çš„ç•Œé¢ï¼Œè§†å›¾ä¸­é€šå¸¸éœ€è¦æ ‡ç­¾è¯­è¨€å±•ç¤ºæ¨¡å‹æ•°æ®ã€‚ åœ¨è®²SpringMVCä¹‹å‰æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ä»€ä¹ˆæ˜¯MVCæ¨¡å¼ MVCï¼šMVCæ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ MVCçš„åŸç†å›¾ï¼š åˆ†æï¼š M-Model æ¨¡å‹ï¼ˆå®Œæˆä¸šåŠ¡é€»è¾‘ï¼šæœ‰javaBeanæ„æˆï¼Œservice+dao+entityï¼‰ V-View è§†å›¾ï¼ˆåšç•Œé¢çš„å±•ç¤º jspï¼Œhtmlâ€¦â€¦ï¼‰ C-Controller æ§åˆ¶å™¨ï¼ˆæ¥æ”¶è¯·æ±‚â€”&gt;è°ƒç”¨æ¨¡å‹â€”&gt;æ ¹æ®ç»“æœæ´¾å‘é¡µé¢ï¼‰ springMVCæ˜¯ä»€ä¹ˆï¼š springMVCæ˜¯ä¸€ä¸ªMVCçš„å¼€æºæ¡†æ¶ï¼ŒspringMVC=struts2+springï¼ŒspringMVCå°±ç›¸å½“äºæ˜¯Struts2åŠ ä¸Šsringçš„æ•´åˆï¼Œä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªç–‘æƒ‘å°±æ˜¯ï¼ŒspringMVCå’Œspringæ˜¯ä»€ä¹ˆæ ·çš„å…³ç³»å‘¢ï¼Ÿè¿™ä¸ªåœ¨ç™¾åº¦ç™¾ç§‘ä¸Šæœ‰ä¸€ä¸ªå¾ˆå¥½çš„è§£é‡Šï¼šæ„æ€æ˜¯è¯´ï¼ŒspringMVCæ˜¯springçš„ä¸€ä¸ªåç»­äº§å“ï¼Œå…¶å®å°±æ˜¯springåœ¨åŸæœ‰åŸºç¡€ä¸Šï¼Œåˆæä¾›äº†webåº”ç”¨çš„MVCæ¨¡å—ï¼Œå¯ä»¥ç®€å•çš„æŠŠspringMVCç†è§£ä¸ºæ˜¯springçš„ä¸€ä¸ªæ¨¡å—ï¼ˆç±»ä¼¼AOPï¼ŒIOCè¿™æ ·çš„æ¨¡å—ï¼‰ï¼Œç½‘ç»œä¸Šç»å¸¸ä¼šè¯´springMVCå’Œspringæ— ç¼é›†æˆï¼Œå…¶å®springMVCå°±æ˜¯springçš„ä¸€ä¸ªå­æ¨¡å—ï¼Œæ‰€ä»¥æ ¹æœ¬ä¸éœ€è¦åŒspringè¿›è¡Œæ•´åˆã€‚ SpringMVCçš„åŸç†å›¾ï¼š çœ‹åˆ°è¿™ä¸ªå›¾å¤§å®¶å¯èƒ½ä¼šæœ‰å¾ˆå¤šçš„ç–‘æƒ‘ï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå›¾çš„æ­¥éª¤ï¼šï¼ˆå¯ä»¥å¯¹æ¯”MVCçš„åŸç†å›¾è¿›è¡Œç†è§£ï¼‰ ç¬¬ä¸€æ­¥:ç”¨æˆ·å‘èµ·è¯·æ±‚åˆ°å‰ç«¯æ§åˆ¶å™¨ï¼ˆDispatcherServletï¼‰ ç¬¬äºŒæ­¥ï¼šå‰ç«¯æ§åˆ¶å™¨è¯·æ±‚å¤„ç†å™¨æ˜ å°„å™¨ï¼ˆHandlerMapperingï¼‰å»æŸ¥æ‰¾å¤„ç†å™¨ï¼ˆHandleï¼‰ï¼šé€šè¿‡xmlé…ç½®æˆ–è€…æ³¨è§£è¿›è¡ŒæŸ¥æ‰¾ ç¬¬ä¸‰æ­¥ï¼šæ‰¾åˆ°ä»¥åå¤„ç†å™¨æ˜ å°„å™¨ï¼ˆHandlerMapperingï¼‰åƒå‰ç«¯æ§åˆ¶å™¨è¿”å›æ‰§è¡Œé“¾ï¼ˆHandlerExecutionChainï¼‰ ç¬¬å››æ­¥ï¼šå‰ç«¯æ§åˆ¶å™¨ï¼ˆDispatcherServletï¼‰è°ƒç”¨å¤„ç†å™¨é€‚é…å™¨ï¼ˆHandlerAdapterï¼‰å»æ‰§è¡Œå¤„ç†å™¨ï¼ˆHandlerï¼‰ ç¬¬äº”æ­¥ï¼šå¤„ç†å™¨é€‚é…å™¨å»æ‰§è¡ŒHandler ç¬¬å…­æ­¥ï¼šHandleræ‰§è¡Œå®Œç»™å¤„ç†å™¨é€‚é…å™¨è¿”å›ModelAndView ç¬¬ä¸ƒæ­¥ï¼šå¤„ç†å™¨é€‚é…å™¨å‘å‰ç«¯æ§åˆ¶å™¨è¿”å›ModelAndView ç¬¬å…«æ­¥ï¼šå‰ç«¯æ§åˆ¶å™¨è¯·æ±‚è§†å›¾è§£æå™¨ï¼ˆViewResolverï¼‰å»è¿›è¡Œè§†å›¾è§£æ ç¬¬ä¹æ­¥ï¼šè§†å›¾è§£æå™¨åƒå‰ç«¯æ§åˆ¶å™¨è¿”å›View ç¬¬åæ­¥ï¼šå‰ç«¯æ§åˆ¶å™¨å¯¹è§†å›¾è¿›è¡Œæ¸²æŸ“ ç¬¬åä¸€æ­¥ï¼šå‰ç«¯æ§åˆ¶å™¨å‘ç”¨æˆ·å“åº”ç»“æœ çœ‹åˆ°è¿™äº›æ­¥éª¤æˆ‘ç›¸ä¿¡å¤§å®¶å¾ˆæ„Ÿè§‰éå¸¸çš„ä¹±ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼Œä½†æ˜¯è¿™é‡Œä¸»è¦æ˜¯è¦å¤§å®¶ç†è§£springMVCä¸­çš„å‡ ä¸ªç»„ä»¶ï¼š å‰ç«¯æ§åˆ¶å™¨ï¼ˆDispatcherServletï¼‰ï¼šæ¥æ”¶è¯·æ±‚ï¼Œå“åº”ç»“æœï¼Œç›¸å½“äºç”µè„‘çš„CPUã€‚ å¤„ç†å™¨æ˜ å°„å™¨ï¼ˆHandlerMappingï¼‰ï¼šæ ¹æ®URLå»æŸ¥æ‰¾å¤„ç†å™¨ å¤„ç†å™¨ï¼ˆHandlerï¼‰ï¼šï¼ˆéœ€è¦ç¨‹åºå‘˜å»å†™ä»£ç å¤„ç†é€»è¾‘çš„ï¼‰ å¤„ç†å™¨é€‚é…å™¨ï¼ˆHandlerAdapterï¼‰ï¼šä¼šæŠŠå¤„ç†å™¨åŒ…è£…æˆé€‚é…å™¨ï¼Œè¿™æ ·å°±å¯ä»¥æ”¯æŒå¤šç§ç±»å‹çš„å¤„ç†å™¨ï¼Œç±»æ¯”ç¬”è®°æœ¬çš„é€‚é…å™¨ï¼ˆé€‚é…å™¨æ¨¡å¼çš„åº”ç”¨ï¼‰ è§†å›¾è§£æå™¨ï¼ˆViewResovlerï¼‰ï¼šè¿›è¡Œè§†å›¾è§£æï¼Œå¤šè¿”å›çš„å­—ç¬¦ä¸²ï¼Œè¿›è¡Œå¤„ç†ï¼Œå¯ä»¥è§£ææˆå¯¹åº”çš„é¡µé¢ ","link":"https://tianxiawuhao.github.io/7cW_XVJ41/"},{"title":"elasticSearchåŸºç¡€æ¦‚å¿µæ±‡æ€»","content":"1.ä»€ä¹ˆæ˜¯ElasticSearchï¼Ÿ Elasticsearchæ˜¯ä¸€ä¸ªåŸºäºLuceneçš„æœç´¢å¼•æ“ã€‚å®ƒæä¾›äº†å…·æœ‰HTTP Webç•Œé¢å’Œæ— æ¶æ„JSONæ–‡æ¡£çš„åˆ†å¸ƒå¼ï¼Œå¤šç§Ÿæˆ·èƒ½åŠ›çš„å…¨æ–‡æœç´¢å¼•æ“ã€‚Elasticsearchæ˜¯ç”¨Javaå¼€å‘çš„ï¼Œæ ¹æ®Apacheè®¸å¯æ¡æ¬¾ä½œä¸ºå¼€æºå‘å¸ƒã€‚å®ƒå¯ä»¥ç”¨äºå…¨æ–‡æœç´¢ï¼Œç»“æ„åŒ–æœç´¢ä»¥åŠåˆ†æï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥å°†è¿™ä¸‰è€…è¿›è¡Œç»„åˆã€‚ 2.ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Elasticsearch? ç”¨æ•°æ®åº“ï¼Œä¹Ÿå¯ä»¥å®ç°æœç´¢çš„åŠŸèƒ½ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦æœç´¢å¼•æ“å‘¢ï¼Ÿ å°±åƒ Stackoverflow çš„ç½‘å‹è¯´çš„ï¼š A relational database can store data and also index it. A search engine can index data but also store it. æ•°æ®åº“ï¼ˆç†è®ºä¸Šæ¥è®²ï¼ŒES ä¹Ÿæ˜¯æ•°æ®åº“ï¼Œè¿™é‡Œçš„æ•°æ®åº“ï¼ŒæŒ‡çš„æ˜¯å…³ç³»å‹æ•°æ®åº“ï¼‰ï¼Œé¦–å…ˆæ˜¯å­˜å‚¨ï¼Œæœç´¢åªæ˜¯é¡ºä¾¿æä¾›çš„åŠŸèƒ½ï¼Œ è€Œæœç´¢å¼•æ“ï¼Œé¦–å…ˆæ˜¯æœç´¢ï¼Œä½†æ˜¯ä¸æŠŠæ•°æ®å­˜ä¸‹æ¥å°±æœä¸äº†ï¼Œæ‰€ä»¥åªå¥½å­˜ä¸€å­˜ã€‚ æœ¯ä¸šæœ‰ä¸“æ”»ï¼Œä¸“æ”»æœç´¢çš„æœç´¢å¼•æ“ï¼Œè‡ªç„¶ä¼šæä¾›æ›´å¼ºå¤§çš„æœç´¢èƒ½åŠ›ã€‚ã€‚ Elasticsearchæ˜¯åˆ†å¸ƒå¼çš„ã€‚ä¸éœ€è¦å…¶ä»–ç»„ä»¶ï¼Œåˆ†å‘æ˜¯å®æ—¶çš„ï¼Œè¢«å«åšâ€Push replicationâ€ã€‚ Elasticsearch å®Œå…¨æ”¯æŒ Apache Lucene çš„æ¥è¿‘å®æ—¶çš„æœç´¢ã€‚ å¤„ç†å¤šç§Ÿæˆ·ï¼ˆmultitenancyï¼‰ä¸éœ€è¦ç‰¹æ®Šé…ç½®ï¼Œè€ŒSolråˆ™éœ€è¦æ›´å¤šçš„é«˜çº§è®¾ç½®ã€‚ Elasticsearch é‡‡ç”¨ Gateway çš„æ¦‚å¿µï¼Œä½¿å¾—å®Œå¤‡ä»½æ›´åŠ ç®€å•ã€‚ å„èŠ‚ç‚¹ç»„æˆå¯¹ç­‰çš„ç½‘ç»œç»“æ„ï¼ŒæŸäº›èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶ä¼šè‡ªåŠ¨åˆ†é…å…¶ä»–èŠ‚ç‚¹ä»£æ›¿å…¶è¿›è¡Œå·¥ä½œã€‚ 3.Elasticsearchæ˜¯å¦‚ä½•å®ç°Masteré€‰ä¸¾çš„ï¼Ÿ Elasticsearchçš„é€‰ä¸»æ˜¯ZenDiscoveryæ¨¡å—è´Ÿè´£çš„ï¼Œä¸»è¦åŒ…å«Pingï¼ˆèŠ‚ç‚¹ä¹‹é—´é€šè¿‡è¿™ä¸ªRPCæ¥å‘ç°å½¼æ­¤ï¼‰å’ŒUnicastï¼ˆå•æ’­æ¨¡å—åŒ…å«ä¸€ä¸ªä¸»æœºåˆ—è¡¨ä»¥æ§åˆ¶å“ªäº›èŠ‚ç‚¹éœ€è¦pingé€šï¼‰è¿™ä¸¤éƒ¨åˆ†ï¼› å¯¹æ‰€æœ‰å¯ä»¥æˆä¸ºmasterçš„èŠ‚ç‚¹ï¼ˆnode.master: trueï¼‰æ ¹æ®nodeIdå­—å…¸æ’åºï¼Œæ¯æ¬¡é€‰ä¸¾æ¯ä¸ªèŠ‚ç‚¹éƒ½æŠŠè‡ªå·±æ‰€çŸ¥é“èŠ‚ç‚¹æ’ä¸€æ¬¡åºï¼Œç„¶åé€‰å‡ºç¬¬ä¸€ä¸ªï¼ˆç¬¬0ä½ï¼‰èŠ‚ç‚¹ï¼Œæš‚ä¸”è®¤ä¸ºå®ƒæ˜¯masterèŠ‚ç‚¹ã€‚ å¦‚æœå¯¹æŸä¸ªèŠ‚ç‚¹çš„æŠ•ç¥¨æ•°è¾¾åˆ°ä¸€å®šçš„å€¼ï¼ˆå¯ä»¥æˆä¸ºmasterèŠ‚ç‚¹æ•°n/2+1ï¼‰å¹¶ä¸”è¯¥èŠ‚ç‚¹è‡ªå·±ä¹Ÿé€‰ä¸¾è‡ªå·±ï¼Œé‚£è¿™ä¸ªèŠ‚ç‚¹å°±æ˜¯masterã€‚å¦åˆ™é‡æ–°é€‰ä¸¾ä¸€ç›´åˆ°æ»¡è¶³ä¸Šè¿°æ¡ä»¶ã€‚ è¡¥å……ï¼šmasterèŠ‚ç‚¹çš„èŒè´£ä¸»è¦åŒ…æ‹¬é›†ç¾¤ã€èŠ‚ç‚¹å’Œç´¢å¼•çš„ç®¡ç†ï¼Œä¸è´Ÿè´£æ–‡æ¡£çº§åˆ«çš„ç®¡ç†ï¼›dataèŠ‚ç‚¹å¯ä»¥å…³é—­httpåŠŸèƒ½ã€‚ 4.Elasticsearchä¸­å¦‚ä½•é¿å…è„‘è£‚ï¼Ÿ ä¸ºäº†é¿å…äº§ç”Ÿè„‘è£‚ï¼ŒESé‡‡ç”¨äº†å¸¸è§çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ€è·¯ï¼Œä¿è¯é€‰ä¸¾å‡ºçš„masterè¢«å¤šæ•°æ´¾(quorum)çš„master-eligible nodeè®¤å¯ï¼Œä»¥æ­¤æ¥ä¿è¯åªæœ‰ä¸€ä¸ªmasterã€‚è¿™ä¸ªquorumé€šè¿‡ä»¥ä¸‹é…ç½®è¿›è¡Œé…ç½®ï¼š conf/elasticsearch.yml: discovery.zen.minimum_master_nodes: 2 5.Elasticsearchä¸­çš„å€’æ’ç´¢å¼• ä¸ºä»€ä¹ˆå«å€’æ’ç´¢å¼• åœ¨æ²¡æœ‰æœç´¢å¼•æ“æ—¶ï¼Œæˆ‘ä»¬æ˜¯ç›´æ¥è¾“å…¥ä¸€ä¸ªç½‘å€ï¼Œç„¶åè·å–ç½‘ç«™å†…å®¹ï¼Œè¿™æ—¶æˆ‘ä»¬çš„è¡Œä¸ºæ˜¯ï¼šdocument -&gt; to -&gt; words é€šè¿‡æ–‡ç« ï¼Œè·å–é‡Œé¢çš„å•è¯ï¼Œæ­¤è°“ã€Œæ­£å‘ç´¢å¼•ã€ï¼Œforward index.åæ¥ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿè¾“å…¥ä¸€ä¸ªå•è¯ï¼Œæ‰¾åˆ°å«æœ‰è¿™ä¸ªå•è¯ï¼Œæˆ–è€…å’Œè¿™ä¸ªå•è¯æœ‰å…³ç³»çš„æ–‡ç« ï¼šword -&gt; to -&gt; documentsäºæ˜¯æˆ‘ä»¬æŠŠè¿™ç§ç´¢å¼•ï¼Œæˆä¸ºinverted indexï¼Œç›´è¯‘è¿‡æ¥ï¼Œåº”è¯¥å«ã€Œåå‘ç´¢å¼•ã€ï¼Œå›½å†…ç¿»è¯‘æˆã€Œå€’æ’ç´¢å¼•ã€ã€‚ å€’æ’ç´¢å¼•çš„å†…éƒ¨ç»“æ„ é¦–å…ˆï¼Œåœ¨æ•°æ®ç”Ÿæˆçš„æ—¶å€™ï¼Œæ¯”å¦‚çˆ¬è™«çˆ¬åˆ°ä¸€ç¯‡æ–‡ç« ï¼Œè¿™æ—¶æˆ‘ä»¬éœ€è¦å¯¹è¿™ç¯‡æ–‡ç« è¿›è¡Œåˆ†æï¼Œå°†æ–‡æœ¬æ‹†è§£æˆä¸€ä¸ªä¸ªå•è¯ã€‚ è¿™ä¸ªè¿‡ç¨‹å¾ˆå¤æ‚ï¼Œæ¯”å¦‚â€œç”Ÿå­˜è¿˜æ˜¯æ­»äº¡â€ï¼Œä½ è¦å¦‚ä½•è®©åˆ†è¯å™¨è‡ªåŠ¨å°†å®ƒåˆ†è§£ä¸ºâ€œç”Ÿå­˜â€ã€â€œè¿˜æ˜¯â€ã€â€œæ­»äº¡â€ä¸‰ä¸ªè¯è¯­ï¼Œç„¶åæŠŠâ€œè¿˜æ˜¯â€è¿™ä¸ªæ— æ„ä¹‰çš„è¯è¯­å¹²æ‰ã€‚è¿™é‡Œä¸å±•å¼€ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥æŸ¥çœ‹å…³äºã€Œåˆ†æå™¨ã€çš„å†…å®¹ã€‚ æ¥ç€ï¼ŒæŠŠè¿™ä¸¤ä¸ªè¯è¯­ä»¥åŠå®ƒå¯¹åº”çš„æ–‡æ¡£idå­˜ä¸‹æ¥ï¼š word documentId ç”Ÿå­˜ 1 æ­»äº¡ 1 æ¥ç€çˆ¬è™«ç»§ç»­çˆ¬ï¼Œåˆçˆ¬åˆ°ä¸€ä¸ªå«æœ‰â€œç”Ÿå­˜â€çš„æ–‡æ¡£ï¼Œäºæ˜¯ç´¢å¼•å˜æˆï¼š word documentId ç”Ÿå­˜ 1ï¼Œ2 æ­»äº¡ 1 ä¸‹æ¬¡æœç´¢â€œç”Ÿå­˜â€ï¼Œå°±ä¼šè¿”å›æ–‡æ¡£IDæ˜¯ 1ã€2ä¸¤ä»½æ–‡æ¡£ã€‚ç„¶è€Œä¸Šé¢è¿™å¥—ç´¢å¼•çš„å®ç°ï¼Œç»™å°å­©å­å½“ç©å…·ç©è¿˜è¡Œï¼Œè¦ä¸Šç”Ÿäº§ç¯å¢ƒï¼Œé‚£è¿˜è¿œç€ã€‚æƒ³æƒ³çœ‹ï¼Œè¿™ä¸ªä¸–ç•Œä¸Šé‚£ä¹ˆå¤šå•è¯ï¼Œä¸­æ–‡ã€è‹±æ–‡ã€æ—¥æ–‡ã€éŸ©æ–‡ â€¦ ä½ æ¯æ¬¡æœç´¢ä¸€ä¸ªå•è¯ï¼Œæˆ‘éƒ½è¦å…¨å±€éå†ä¸€éï¼Œå¾ˆæ˜æ˜¾ä¸è¡Œã€‚äºæ˜¯æœ‰äº†æ’åºï¼Œæˆ‘ä»¬éœ€è¦å¯¹å•è¯è¿›è¡Œæ’åºï¼Œåƒ B+ æ ‘ä¸€æ ·ï¼Œå¯ä»¥åœ¨é¡µé‡Œå®ç°äºŒåˆ†æŸ¥æ‰¾ã€‚å…‰æ’åºè¿˜ä¸è¡Œï¼Œä½ å•è¯éƒ½æ”¾åœ¨ç£ç›˜å‘¢ï¼Œç£ç›˜ IO æ…¢çš„ä¸å¾—äº†ï¼Œæ‰€ä»¥ Mysql ç‰¹æ„æŠŠç´¢å¼•ç¼“å­˜åˆ°äº†å†…å­˜ã€‚ä½ è¯´å¥½ï¼Œæˆ‘ä¹Ÿå­¦ Mysql çš„ï¼Œæ”¾å†…å­˜ï¼Œ3ï¼Œ2ï¼Œ1ï¼Œæ”¾ï¼Œå“å½“ï¼Œå†…å­˜çˆ†äº†ã€‚å“ªæœ¬å­—å…¸ï¼Œä¼šæŠŠæ‰€æœ‰å•è¯éƒ½è´´åœ¨ç›®å½•é‡Œçš„ï¼Ÿ æ‰€ä»¥ï¼Œä¸Šå›¾ï¼š Lucene çš„å€’æ’ç´¢ï¼Œå¢åŠ äº†æœ€å·¦è¾¹çš„ä¸€å±‚ã€Œå­—å…¸æ ‘ã€term indexï¼Œå®ƒä¸å­˜å‚¨æ‰€æœ‰çš„å•è¯ï¼Œåªå­˜å‚¨å•è¯å‰ç¼€ï¼Œé€šè¿‡å­—å…¸æ ‘æ‰¾åˆ°å•è¯æ‰€åœ¨çš„å—ï¼Œä¹Ÿå°±æ˜¯å•è¯çš„å¤§æ¦‚ä½ç½®ï¼Œå†åœ¨å—é‡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œæ‰¾åˆ°å¯¹åº”çš„å•è¯ï¼Œå†æ‰¾åˆ°å•è¯å¯¹åº”çš„æ–‡æ¡£åˆ—è¡¨ã€‚ å½“ç„¶ï¼Œå†…å­˜å¯¸åœŸå¯¸é‡‘ï¼Œèƒ½çœåˆ™çœï¼Œæ‰€ä»¥ Lucene è¿˜ç”¨äº† FSTï¼ˆFinite State Transducersï¼‰å¯¹å®ƒè¿›ä¸€æ­¥å‹ç¼©ã€‚ æœ€å³è¾¹çš„ Posting List ï¼Œåˆ«çœ‹å®ƒåªæ˜¯å­˜ä¸€ä¸ªæ–‡æ¡£ ID æ•°ç»„ï¼Œä½†æ˜¯å®ƒåœ¨è®¾è®¡æ—¶ï¼Œé‡åˆ°çš„é—®é¢˜å¯ä¸å°‘ã€‚ Frame Of Reference åŸç”Ÿçš„ Posting List æœ‰ä¸¤ä¸ªç—›ç‚¹ï¼š å¦‚ä½•å‹ç¼©ä»¥èŠ‚çœç£ç›˜ç©ºé—´ å¦‚ä½•å¿«é€Ÿæ±‚äº¤å¹¶é›†ï¼ˆintersections and unionsï¼‰ å…ˆæ¥èŠèŠå‹ç¼©ã€‚æˆ‘ä»¬æ¥ç®€åŒ–ä¸‹ Lucene è¦é¢å¯¹çš„é—®é¢˜ï¼Œå‡è®¾æœ‰è¿™æ ·ä¸€ä¸ªæ•°ç»„ï¼š[73, 300, 302, 332, 343, 372] Lucene é‡Œï¼Œæ•°æ®æ˜¯æŒ‰ Segment å­˜å‚¨çš„ï¼Œæ¯ä¸ª Segment æœ€å¤šå­˜ 65536 ä¸ªæ–‡æ¡£ IDï¼Œ æ‰€ä»¥æ–‡æ¡£ ID çš„èŒƒå›´ï¼Œä» 0 åˆ° 2^16-1ï¼Œæ‰€ä»¥å¦‚æœä¸è¿›è¡Œä»»ä½•å¤„ç†ï¼Œé‚£ä¹ˆæ¯ä¸ªå…ƒç´ éƒ½ä¼šå ç”¨ 2 bytes ï¼Œå¯¹åº”ä¸Šé¢çš„æ•°ç»„ï¼Œå°±æ˜¯ 6 * 2 = 12 bytes. æ€ä¹ˆå‹ç¼©å‘¢ï¼Ÿ å‹ç¼©ï¼Œå°±æ˜¯å°½å¯èƒ½é™ä½æ¯ä¸ªæ•°æ®å ç”¨çš„ç©ºé—´ï¼ŒåŒæ—¶åˆèƒ½è®©ä¿¡æ¯ä¸å¤±çœŸï¼Œèƒ½å¤Ÿè¿˜åŸå›æ¥ã€‚ Step 1ï¼šDelta-encode â€”â€” å¢é‡ç¼–ç  æˆ‘ä»¬åªè®°å½•å…ƒç´ ä¸å…ƒç´ ä¹‹é—´çš„å¢é‡ï¼Œäºæ˜¯æ•°ç»„å˜æˆäº†ï¼š[73, 227, 2, 30, 11, 29] Step 2ï¼šSplit into blocks â€”â€” åˆ†å‰²æˆå— Luceneé‡Œæ¯ä¸ªå—æ˜¯ 256 ä¸ªæ–‡æ¡£ IDï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ¯ä¸ªå—ï¼Œå¢é‡ç¼–ç åï¼Œæ¯ä¸ªå…ƒç´ éƒ½ä¸ä¼šè¶…è¿‡ 256ï¼ˆ1 byteï¼‰.ä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºï¼Œæˆ‘ä»¬å‡è®¾æ¯ä¸ªå—æ˜¯ 3 ä¸ªæ–‡æ¡£ IDï¼š [73, 227, 2], [30, 11, 29] Step 3ï¼šBit packing â€”â€” æŒ‰éœ€åˆ†é…ç©ºé—´ å¯¹äºç¬¬ä¸€ä¸ªå—ï¼Œ[73, 227, 2]ï¼Œæœ€å¤§å…ƒç´ æ˜¯227ï¼Œéœ€è¦ 8 bitsï¼Œå¥½ï¼Œé‚£æˆ‘ç»™ä½ è¿™ä¸ªå—çš„æ¯ä¸ªå…ƒç´ ï¼Œéƒ½åˆ†é… 8 bitsçš„ç©ºé—´ã€‚ä½†æ˜¯å¯¹äºç¬¬äºŒä¸ªå—ï¼Œ[30, 11, 29]ï¼Œæœ€å¤§çš„å…ƒç´ æ‰30ï¼Œåªéœ€è¦ 5 bitsï¼Œé‚£æˆ‘å°±ç»™ä½ æ¯ä¸ªå…ƒç´ ï¼Œåªåˆ†é… 5 bits çš„ç©ºé—´ï¼Œè¶³çŸ£ã€‚è¿™ä¸€æ­¥ï¼Œå¯ä»¥è¯´æ˜¯æŠŠåå•¬å‘æŒ¥åˆ°æè‡´ï¼Œç²¾æ‰“ç»†ç®—ï¼ŒæŒ‰éœ€åˆ†é…ã€‚ ä»¥ä¸Šä¸‰ä¸ªæ­¥éª¤ï¼Œå…±åŒç»„æˆäº†ä¸€é¡¹ç¼–ç æŠ€æœ¯ï¼ŒFrame Of Referenceï¼ˆFORï¼‰ï¼š Roaring bitmaps æ¥ç€æ¥èŠèŠ Posting List çš„ç¬¬äºŒä¸ªç—›ç‚¹ â€”â€” å¦‚ä½•å¿«é€Ÿæ±‚äº¤å¹¶é›†ï¼ˆintersections and unionsï¼‰ã€‚ åœ¨ Lucene ä¸­æŸ¥è¯¢ï¼Œé€šå¸¸ä¸åªæœ‰ä¸€ä¸ªæŸ¥è¯¢æ¡ä»¶ï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³æœç´¢ï¼š å«æœ‰â€œç”Ÿå­˜â€ç›¸å…³è¯è¯­çš„æ–‡æ¡£ æ–‡æ¡£å‘å¸ƒæ—¶é—´åœ¨æœ€è¿‘ä¸€ä¸ªæœˆ æ–‡æ¡£å‘å¸ƒè€…æ˜¯å¹³å°çš„ç‰¹çº¦ä½œè€… è¿™æ ·å°±éœ€è¦æ ¹æ®ä¸‰ä¸ªå­—æ®µï¼Œå»ä¸‰æ£µå€’æ’ç´¢å¼•é‡Œå»æŸ¥ï¼Œå½“ç„¶ï¼Œç£ç›˜é‡Œçš„æ•°æ®ï¼Œä¸Šä¸€èŠ‚æåˆ°è¿‡ï¼Œç”¨äº† FOR è¿›è¡Œå‹ç¼©ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æŠŠæ•°æ®è¿›è¡Œåå‘å¤„ç†ï¼Œå³è§£å‹ï¼Œæ‰èƒ½è¿˜åŸæˆåŸå§‹çš„æ–‡æ¡£ IDï¼Œç„¶åæŠŠè¿™ä¸‰ä¸ªæ–‡æ¡£ ID æ•°ç»„åœ¨å†…å­˜ä¸­åšä¸€ä¸ªäº¤é›†ã€‚ å³ä½¿æ²¡æœ‰å¤šæ¡ä»¶æŸ¥è¯¢ï¼Œ Lucene ä¹Ÿéœ€è¦é¢‘ç¹æ±‚å¹¶é›†ï¼Œå› ä¸º Lucene æ˜¯åˆ†ç‰‡å­˜å‚¨çš„ã€‚ åŒæ ·ï¼Œæˆ‘ä»¬æŠŠ Lucene é‡åˆ°çš„é—®é¢˜ï¼Œç®€åŒ–æˆä¸€é“ç®—æ³•é¢˜ã€‚ å‡è®¾æœ‰ä¸‹é¢ä¸‰ä¸ªæ•°ç»„ï¼š [64, 300, 303, 343] [73, 300, 302, 303, 343, 372] [303, 311, 333, 343] æ±‚å®ƒä»¬çš„äº¤é›†ã€‚ Option 1: Integer æ•°ç»„ ç›´æ¥ç”¨åŸå§‹çš„æ–‡æ¡£ ID ï¼Œå¯èƒ½ä½ ä¼šè¯´ï¼Œé‚£å°±é€ä¸ªæ•°ç»„éå†ä¸€éå§ï¼Œéå†å®Œå°±çŸ¥é“äº¤é›†æ˜¯ä»€ä¹ˆäº†ã€‚ å…¶å®å¯¹äºæœ‰åºçš„æ•°ç»„ï¼Œç”¨è·³è¡¨ï¼ˆskip tableï¼‰å¯ä»¥æ›´é«˜æ•ˆï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼Œå› ä¸ºä¸ç®¡æ˜¯ä»æ€§èƒ½ï¼Œè¿˜æ˜¯ç©ºé—´ä¸Šè€ƒè™‘ï¼ŒInteger æ•°ç»„éƒ½ä¸é è°±ï¼Œå‡è®¾æœ‰100M ä¸ªæ–‡æ¡£ IDï¼Œæ¯ä¸ªæ–‡æ¡£ ID å  2 bytesï¼Œé‚£å·²ç»æ˜¯ 200 MBï¼Œè€Œè¿™äº›æ•°æ®æ˜¯è¦æ”¾åˆ°å†…å­˜ä¸­è¿›è¡Œå¤„ç†çš„ï¼ŒæŠŠè¿™ä¹ˆå¤§é‡çš„æ•°æ®ï¼Œä»ç£ç›˜è§£å‹åä¸¢åˆ°å†…å­˜ï¼Œå†…å­˜è‚¯å®šæ’‘ä¸ä½ã€‚ Option 2: Bitmap å‡è®¾æœ‰è¿™æ ·ä¸€ä¸ªæ•°ç»„ï¼š[3,6,7,10] é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¿™æ ·æ¥è¡¨ç¤ºï¼š[0,0,1,0,0,1,1,0,0,1] çœ‹å‡ºæ¥äº†ä¹ˆï¼Œå¯¹ï¼Œæˆ‘ä»¬ç”¨ 0 è¡¨ç¤ºè§’æ ‡å¯¹åº”çš„æ•°å­—ä¸å­˜åœ¨ï¼Œç”¨ 1 è¡¨ç¤ºå­˜åœ¨ã€‚ è¿™æ ·å¸¦æ¥äº†ä¸¤ä¸ªå¥½å¤„ï¼š èŠ‚çœç©ºé—´ï¼šæ—¢ç„¶æˆ‘ä»¬åªéœ€è¦0å’Œ1ï¼Œé‚£æ¯ä¸ªæ–‡æ¡£ ID å°±åªéœ€è¦ 1 bitï¼Œè¿˜æ˜¯å‡è®¾æœ‰ 100M ä¸ªæ–‡æ¡£ï¼Œé‚£åªéœ€è¦ 100M bits = 100M * 1/8 bytes = 12.5 MBï¼Œæ¯”ä¹‹å‰ç”¨ Integer æ•°ç»„ çš„ 200 MBï¼Œä¼˜ç§€å¤ªå¤š è¿ç®—æ›´å¿«ï¼š0 å’Œ 1ï¼Œå¤©ç„¶å°±é€‚åˆè¿›è¡Œä½è¿ç®—ï¼Œæ±‚äº¤é›†ï¼Œã€Œä¸ã€ä¸€ä¸‹ï¼Œæ±‚å¹¶é›†ï¼Œã€Œæˆ–ã€ä¸€ä¸‹ï¼Œä¸€åˆ‡éƒ½å›å½’åˆ°è®¡ç®—æœºçš„èµ·ç‚¹ Option 3: Roaring Bitmaps ç»†å¿ƒçš„ä½ å¯èƒ½å‘ç°äº†ï¼Œbitmap æœ‰ä¸ªç¡¬ä¼¤ï¼Œå°±æ˜¯ä¸ç®¡ä½ æœ‰å¤šå°‘ä¸ªæ–‡æ¡£ï¼Œä½ å ç”¨çš„ç©ºé—´éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä¹‹å‰è¯´è¿‡ï¼ŒLucene Posting List çš„æ¯ä¸ª Segement æœ€å¤šæ”¾ 65536 ä¸ªæ–‡æ¡£IDï¼Œä¸¾ä¸€ä¸ªæç«¯çš„ä¾‹å­ï¼Œæœ‰ä¸€ä¸ªæ•°ç»„ï¼Œé‡Œé¢åªæœ‰ä¸¤ä¸ªæ–‡æ¡£ IDï¼š[0, 65535]ç”¨ Bitmapï¼Œè¦æ€ä¹ˆè¡¨ç¤ºï¼Ÿ[1,0,0,0,â€¦.(è¶…çº§å¤šä¸ª0),â€¦,0,0,1] ä½ éœ€è¦ 65536 ä¸ª bitï¼Œä¹Ÿå°±æ˜¯ 65536/8 = 8192 bytesï¼Œè€Œç”¨ Integer æ•°ç»„ï¼Œä½ åªéœ€è¦ 2 * 2 bytes = 4 bytes å‘µå‘µï¼Œæ­»æ¿çš„ bitmapã€‚å¯è§åœ¨æ–‡æ¡£æ•°é‡ä¸å¤šçš„æ—¶å€™ï¼Œä½¿ç”¨ Integer æ•°ç»„æ›´åŠ èŠ‚çœå†…å­˜ã€‚ æˆ‘ä»¬æ¥ç®—ä¸€ä¸‹ä¸´ç•Œå€¼ï¼Œå¾ˆç®€å•ï¼Œæ— è®ºæ–‡æ¡£æ•°é‡å¤šå°‘ï¼Œbitmapéƒ½éœ€è¦ 8192 bytesï¼Œè€Œ Integer æ•°ç»„åˆ™å’Œæ–‡æ¡£æ•°é‡æˆçº¿æ€§ç›¸å…³ï¼Œæ¯ä¸ªæ–‡æ¡£ ID å  2 bytesï¼Œæ‰€ä»¥ï¼š8192 / 2 = 4096å½“æ–‡æ¡£æ•°é‡å°‘äº 4096 æ—¶ï¼Œç”¨ Integer æ•°ç»„ï¼Œå¦åˆ™ï¼Œç”¨ bitmap. è¿™é‡Œè¡¥å……ä¸€ä¸‹ Roaring bitmaps å’Œ ä¹‹å‰è®²çš„ Frame Of Reference çš„å…³ç³»ã€‚ Frame Of Reference æ˜¯å‹ç¼©æ•°æ®ï¼Œå‡å°‘ç£ç›˜å ç”¨ç©ºé—´ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬ä»ç£ç›˜å–æ•°æ®æ—¶ï¼Œä¹Ÿéœ€è¦ä¸€ä¸ªåå‘çš„è¿‡ç¨‹ï¼Œå³è§£å‹ï¼Œè§£å‹åæ‰æœ‰æˆ‘ä»¬ä¸Šé¢çœ‹åˆ°çš„è¿™æ ·å­çš„æ–‡æ¡£IDæ•°ç»„ï¼š[73, 300, 302, 303, 343, 372] ï¼Œæ¥ç€æˆ‘ä»¬éœ€è¦å¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼Œæ±‚äº¤é›†æˆ–è€…å¹¶é›†ï¼Œè¿™æ—¶å€™æ•°æ®æ˜¯éœ€è¦æ”¾åˆ°å†…å­˜è¿›è¡Œå¤„ç†çš„ï¼Œæˆ‘ä»¬æœ‰ä¸‰ä¸ªè¿™æ ·çš„æ•°ç»„ï¼Œè¿™äº›æ•°ç»„å¯èƒ½å¾ˆå¤§ï¼Œè€Œå†…å­˜ç©ºé—´æ¯”ç£ç›˜è¿˜å®è´µï¼Œäºæ˜¯éœ€è¦æ›´å¼ºæœ‰åŠ›çš„å‹ç¼©ç®—æ³•ï¼ŒåŒæ—¶è¿˜è¦æœ‰åˆ©äºå¿«é€Ÿçš„æ±‚äº¤å¹¶é›†ï¼Œäºæ˜¯æœ‰äº†Roaring Bitmaps ç®—æ³•ã€‚ å¦å¤–ï¼ŒLucene è¿˜ä¼šæŠŠä»ç£ç›˜å–å‡ºæ¥çš„æ•°æ®ï¼Œé€šè¿‡ Roaring bitmaps å¤„ç†åï¼Œç¼“å­˜åˆ°å†…å­˜ä¸­ï¼ŒLucene ç§°ä¹‹ä¸º filter cache. 6.ElasticSearchä¸­çš„é›†ç¾¤ã€èŠ‚ç‚¹ã€ç´¢å¼•ã€æ–‡æ¡£ã€ç±»å‹æ˜¯ä»€ä¹ˆï¼Ÿ ç¾¤é›† æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹ï¼ˆæœåŠ¡å™¨ï¼‰çš„é›†åˆï¼Œå®ƒä»¬å…±åŒä¿å­˜æ‚¨çš„æ•´ä¸ªæ•°æ®ï¼Œå¹¶æä¾›è·¨æ‰€æœ‰èŠ‚ç‚¹çš„è”åˆç´¢å¼•å’Œæœç´¢åŠŸèƒ½ã€‚ç¾¤é›†ç”±å”¯ä¸€åç§°æ ‡è¯†ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸ºâ€œelasticsearchâ€ã€‚æ­¤åç§°å¾ˆé‡è¦ï¼Œå› ä¸ºå¦‚æœèŠ‚ç‚¹è®¾ç½®ä¸ºæŒ‰åç§°åŠ å…¥ç¾¤é›†ï¼Œåˆ™è¯¥èŠ‚ç‚¹åªèƒ½æ˜¯ç¾¤é›†çš„ä¸€éƒ¨åˆ†ã€‚ èŠ‚ç‚¹ æ˜¯å±äºé›†ç¾¤ä¸€éƒ¨åˆ†çš„å•ä¸ªæœåŠ¡å™¨ã€‚å®ƒå­˜å‚¨æ•°æ®å¹¶å‚ä¸ç¾¤é›†ç´¢å¼•å’Œæœç´¢åŠŸèƒ½ã€‚ ç´¢å¼• å°±åƒå…³ç³»æ•°æ®åº“ä¸­çš„â€œæ•°æ®åº“â€ã€‚å®ƒæœ‰ä¸€ä¸ªå®šä¹‰å¤šç§ç±»å‹çš„æ˜ å°„ã€‚ç´¢å¼•æ˜¯é€»è¾‘åç§°ç©ºé—´ï¼Œæ˜ å°„åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªä¸»åˆ†ç‰‡ï¼Œå¹¶ä¸”å¯ä»¥æœ‰é›¶ä¸ªæˆ–å¤šä¸ªå‰¯æœ¬åˆ†ç‰‡ã€‚ MySQL =&gt;æ•°æ®åº“ ElasticSearch =&gt;ç´¢å¼• æ–‡æ¡£ ç±»ä¼¼äºå…³ç³»æ•°æ®åº“ä¸­çš„ä¸€è¡Œã€‚ä¸åŒä¹‹å¤„åœ¨äºç´¢å¼•ä¸­çš„æ¯ä¸ªæ–‡æ¡£å¯ä»¥å…·æœ‰ä¸åŒçš„ç»“æ„ï¼ˆå­—æ®µï¼‰ï¼Œä½†æ˜¯å¯¹äºé€šç”¨å­—æ®µåº”è¯¥å…·æœ‰ç›¸åŒçš„æ•°æ®ç±»å‹ã€‚ MySQL =&gt; Databases =&gt;Tables =&gt; Columns / Rows ElasticSearch =&gt; Indices =&gt; Types =&gt;å…·æœ‰å±æ€§çš„æ–‡æ¡£ ç±»å‹ æ˜¯ç´¢å¼•çš„é€»è¾‘ç±»åˆ«/åˆ†åŒºï¼Œå…¶è¯­ä¹‰å®Œå…¨å–å†³äºç”¨æˆ·ã€‚ 7.ElasticSearchä¸­çš„åˆ†ç‰‡æ˜¯ä»€ä¹ˆ? åœ¨å¤§å¤šæ•°ç¯å¢ƒä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½åœ¨å•ç‹¬çš„ç›’å­æˆ–è™šæ‹Ÿæœºä¸Šè¿è¡Œã€‚ ç´¢å¼• - åœ¨Elasticsearchä¸­ï¼Œç´¢å¼•æ˜¯æ–‡æ¡£çš„é›†åˆã€‚ åˆ†ç‰‡ -å› ä¸ºElasticsearchæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æœç´¢å¼•æ“ï¼Œæ‰€ä»¥ç´¢å¼•é€šå¸¸è¢«åˆ†å‰²æˆåˆ†å¸ƒåœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šçš„è¢«ç§°ä¸ºåˆ†ç‰‡çš„å…ƒç´ ã€‚ Segment -æ¯ä¸ªshardï¼ˆåˆ†ç‰‡ï¼‰åŒ…å«å¤šä¸ªsegmentï¼ˆæ®µï¼‰ï¼Œæ¯ä¸€ä¸ªsegmentéƒ½æ˜¯ä¸€ä¸ªå€’æ’ç´¢å¼• åœ¨æŸ¥è¯¢çš„æ—¶ï¼Œä¼šæŠŠæ‰€æœ‰çš„segmentæŸ¥è¯¢ç»“æœæ±‡æ€»å½’å¹¶åæœ€ä¸ºæœ€ç»ˆçš„åˆ†ç‰‡æŸ¥è¯¢ç»“æœè¿”å› 1.segmentæ˜¯ä¸å¯å˜çš„ï¼Œç‰©ç†ä¸Šä½ å¹¶ä¸èƒ½ä»ä¸­åˆ é™¤ä¿¡æ¯ï¼Œæ‰€ä»¥åœ¨åˆ é™¤æ–‡æ¡£çš„æ—¶å€™ï¼Œæ˜¯åœ¨æ–‡æ¡£ä¸Šé¢æ‰“ä¸Šä¸€ä¸ªåˆ é™¤çš„æ ‡è®°ï¼Œç„¶ååœ¨æ‰§è¡Œæ®µåˆå¹¶çš„æ—¶å€™ï¼Œè¿›è¡Œåˆ é™¤ 2.ç´¢å¼•segmentæ®µçš„ä¸ªæ•°è¶Šå¤šï¼Œæœç´¢æ€§èƒ½è¶Šä½ä¸”æ¶ˆè€—å†…å­˜æ›´å¤š â€‹ å‰¯æœ¬ -ä¸€ä¸ªç´¢å¼•è¢«åˆ†è§£æˆç¢ç‰‡ä»¥ä¾¿äºåˆ†å‘å’Œæ‰©å±•ã€‚å‰¯æœ¬æ˜¯åˆ†ç‰‡çš„å‰¯æœ¬ã€‚ â€‹ åˆ†æå™¨ -åœ¨ElasticSearchä¸­ç´¢å¼•æ•°æ®æ—¶ï¼Œæ•°æ®ç”±ä¸ºç´¢å¼•å®šä¹‰çš„Analyzeråœ¨å†…éƒ¨è¿›è¡Œè½¬æ¢ã€‚ åˆ†æå™¨ç”±ä¸€ä¸ªTokenizerå’Œé›¶ä¸ªæˆ–å¤šä¸ªTokenFilterç»„æˆã€‚ç¼–è¯‘å™¨å¯ä»¥åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªCharFilterä¹‹å‰ã€‚åˆ†ææ¨¡å—å…è®¸æ‚¨åœ¨é€»è¾‘åç§°ä¸‹æ³¨å†Œåˆ†æå™¨ï¼Œç„¶åå¯ä»¥åœ¨æ˜ å°„å®šä¹‰æˆ–æŸäº›APIä¸­å¼•ç”¨å®ƒä»¬ã€‚Elasticsearché™„å¸¦äº†è®¸å¤šå¯ä»¥éšæ—¶ä½¿ç”¨çš„é¢„å»ºåˆ†æå™¨ã€‚æˆ–è€…ï¼Œæ‚¨å¯ä»¥ç»„åˆå†…ç½®çš„å­—ç¬¦è¿‡æ»¤å™¨ï¼Œç¼–è¯‘å™¨å’Œè¿‡æ»¤å™¨å™¨æ¥åˆ›å»ºè‡ªå®šä¹‰åˆ†æå™¨ã€‚ â€‹ ç¼–è¯‘å™¨ -ç¼–è¯‘å™¨ç”¨äºå°†å­—ç¬¦ä¸²åˆ†è§£ä¸ºæœ¯è¯­æˆ–æ ‡è®°æµã€‚ä¸€ä¸ªç®€å•çš„ç¼–è¯‘å™¨å¯èƒ½ä¼šå°†å­—ç¬¦ä¸²æ‹†åˆ†ä¸ºä»»ä½•é‡åˆ°ç©ºæ ¼æˆ–æ ‡ç‚¹çš„åœ°æ–¹ã€‚Elasticsearchæœ‰è®¸å¤šå†…ç½®æ ‡è®°å™¨ï¼Œå¯ç”¨äºæ„å»ºè‡ªå®šä¹‰åˆ†æå™¨ã€‚ 8.è¯¦ç»†æè¿°ä¸€ä¸‹Elasticsearchç´¢å¼•æ–‡æ¡£çš„è¿‡ç¨‹ã€‚ åè°ƒèŠ‚ç‚¹é»˜è®¤ä½¿ç”¨æ–‡æ¡£IDå‚ä¸è®¡ç®—ï¼ˆä¹Ÿæ”¯æŒé€šè¿‡routingï¼‰ï¼Œä»¥ä¾¿ä¸ºè·¯ç”±æä¾›åˆé€‚çš„åˆ†ç‰‡ã€‚ shard = hash(document_id) % (num_of_primary_shards) å½“åˆ†ç‰‡æ‰€åœ¨çš„èŠ‚ç‚¹æ¥æ”¶åˆ°æ¥è‡ªåè°ƒèŠ‚ç‚¹çš„è¯·æ±‚åï¼Œä¼šå°†è¯·æ±‚å†™å…¥åˆ°Memory Bufferï¼Œç„¶åå®šæ—¶ï¼ˆé»˜è®¤æ˜¯æ¯éš”1ç§’ï¼‰å†™å…¥åˆ°Filesystem Cacheï¼Œè¿™ä¸ªä»Momery Bufferåˆ°Filesystem Cacheçš„è¿‡ç¨‹å°±å«åšrefreshï¼› å½“ç„¶åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå­˜åœ¨Momery Bufferå’ŒFilesystem Cacheçš„æ•°æ®å¯èƒ½ä¼šä¸¢å¤±ï¼ŒESæ˜¯é€šè¿‡translogçš„æœºåˆ¶æ¥ä¿è¯æ•°æ®çš„å¯é æ€§çš„ã€‚å…¶å®ç°æœºåˆ¶æ˜¯æ¥æ”¶åˆ°è¯·æ±‚åï¼ŒåŒæ—¶ä¹Ÿä¼šå†™å…¥åˆ°translogä¸­ï¼Œå½“Filesystem cacheä¸­çš„æ•°æ®å†™å…¥åˆ°ç£ç›˜ä¸­æ—¶ï¼Œæ‰ä¼šæ¸…é™¤æ‰ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšflushï¼› åœ¨flushè¿‡ç¨‹ä¸­ï¼Œå†…å­˜ä¸­çš„ç¼“å†²å°†è¢«æ¸…é™¤ï¼Œå†…å®¹è¢«å†™å…¥ä¸€ä¸ªæ–°æ®µï¼Œæ®µçš„fsyncå°†åˆ›å»ºä¸€ä¸ªæ–°çš„æäº¤ç‚¹ï¼Œå¹¶å°†å†…å®¹åˆ·æ–°åˆ°ç£ç›˜ï¼Œæ—§çš„translogå°†è¢«åˆ é™¤å¹¶å¼€å§‹ä¸€ä¸ªæ–°çš„translogã€‚ flushè§¦å‘çš„æ—¶æœºæ˜¯å®šæ—¶è§¦å‘ï¼ˆé»˜è®¤30åˆ†é’Ÿï¼‰æˆ–è€…translogå˜å¾—å¤ªå¤§ï¼ˆé»˜è®¤ä¸º512Mï¼‰æ—¶ï¼› è¡¥å……ï¼šå…³äºLuceneçš„Segementï¼š Luceneç´¢å¼•æ˜¯ç”±å¤šä¸ªæ®µç»„æˆï¼Œæ®µæœ¬èº«æ˜¯ä¸€ä¸ªåŠŸèƒ½é½å…¨çš„å€’æ’ç´¢å¼•ã€‚ æ®µæ˜¯ä¸å¯å˜çš„ï¼Œå…è®¸Luceneå°†æ–°çš„æ–‡æ¡£å¢é‡åœ°æ·»åŠ åˆ°ç´¢å¼•ä¸­ï¼Œè€Œä¸ç”¨ä»å¤´é‡å»ºç´¢å¼•ã€‚ å¯¹äºæ¯ä¸€ä¸ªæœç´¢è¯·æ±‚è€Œè¨€ï¼Œç´¢å¼•ä¸­çš„æ‰€æœ‰æ®µéƒ½ä¼šè¢«æœç´¢ï¼Œå¹¶ä¸”æ¯ä¸ªæ®µä¼šæ¶ˆè€—CPUçš„æ—¶é’Ÿå‘¨ã€æ–‡ä»¶å¥æŸ„å’Œå†…å­˜ã€‚è¿™æ„å‘³ç€æ®µçš„æ•°é‡è¶Šå¤šï¼Œæœç´¢æ€§èƒ½ä¼šè¶Šä½ã€‚ ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒElasticsearchä¼šåˆå¹¶å°æ®µåˆ°ä¸€ä¸ªè¾ƒå¤§çš„æ®µï¼Œæäº¤æ–°çš„åˆå¹¶æ®µåˆ°ç£ç›˜ï¼Œå¹¶åˆ é™¤é‚£äº›æ—§çš„å°æ®µã€‚ 9.è¯¦ç»†æè¿°ä¸€ä¸‹Elasticsearchæ›´æ–°å’Œåˆ é™¤æ–‡æ¡£çš„è¿‡ç¨‹ åˆ é™¤å’Œæ›´æ–°ä¹Ÿéƒ½æ˜¯å†™æ“ä½œï¼Œä½†æ˜¯Elasticsearchä¸­çš„æ–‡æ¡£æ˜¯ä¸å¯å˜çš„ï¼Œå› æ­¤ä¸èƒ½è¢«åˆ é™¤æˆ–è€…æ”¹åŠ¨ä»¥å±•ç¤ºå…¶å˜æ›´ï¼› ç£ç›˜ä¸Šçš„æ¯ä¸ªæ®µéƒ½æœ‰ä¸€ä¸ªç›¸åº”çš„.delæ–‡ä»¶ã€‚å½“åˆ é™¤è¯·æ±‚å‘é€åï¼Œæ–‡æ¡£å¹¶æ²¡æœ‰çœŸçš„è¢«åˆ é™¤ï¼Œè€Œæ˜¯åœ¨.delæ–‡ä»¶ä¸­è¢«æ ‡è®°ä¸ºåˆ é™¤ã€‚è¯¥æ–‡æ¡£ä¾ç„¶èƒ½åŒ¹é…æŸ¥è¯¢ï¼Œä½†æ˜¯ä¼šåœ¨ç»“æœä¸­è¢«è¿‡æ»¤æ‰ã€‚å½“æ®µåˆå¹¶æ—¶ï¼Œåœ¨.delæ–‡ä»¶ä¸­è¢«æ ‡è®°ä¸ºåˆ é™¤çš„æ–‡æ¡£å°†ä¸ä¼šè¢«å†™å…¥æ–°æ®µã€‚ åœ¨æ–°çš„æ–‡æ¡£è¢«åˆ›å»ºæ—¶ï¼ŒElasticsearchä¼šä¸ºè¯¥æ–‡æ¡£æŒ‡å®šä¸€ä¸ªç‰ˆæœ¬å·ï¼Œå½“æ‰§è¡Œæ›´æ–°æ—¶ï¼Œæ—§ç‰ˆæœ¬çš„æ–‡æ¡£åœ¨.delæ–‡ä»¶ä¸­è¢«æ ‡è®°ä¸ºåˆ é™¤ï¼Œæ–°ç‰ˆæœ¬çš„æ–‡æ¡£è¢«ç´¢å¼•åˆ°ä¸€ä¸ªæ–°æ®µã€‚æ—§ç‰ˆæœ¬çš„æ–‡æ¡£ä¾ç„¶èƒ½åŒ¹é…æŸ¥è¯¢ï¼Œä½†æ˜¯ä¼šåœ¨ç»“æœä¸­è¢«è¿‡æ»¤æ‰ã€‚ 10.è¯¦ç»†æè¿°ä¸€ä¸‹Elasticsearchæœç´¢çš„è¿‡ç¨‹ æœç´¢è¢«æ‰§è¡Œæˆä¸€ä¸ªä¸¤é˜¶æ®µè¿‡ç¨‹ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º Query Then Fetchï¼› åœ¨åˆå§‹æŸ¥è¯¢é˜¶æ®µæ—¶ï¼ŒæŸ¥è¯¢ä¼šå¹¿æ’­åˆ°ç´¢å¼•ä¸­æ¯ä¸€ä¸ªåˆ†ç‰‡æ‹·è´ï¼ˆä¸»åˆ†ç‰‡æˆ–è€…å‰¯æœ¬åˆ†ç‰‡ï¼‰ã€‚ æ¯ä¸ªåˆ†ç‰‡åœ¨æœ¬åœ°æ‰§è¡Œæœç´¢å¹¶æ„å»ºä¸€ä¸ªåŒ¹é…æ–‡æ¡£çš„å¤§å°ä¸º from + size çš„ä¼˜å…ˆé˜Ÿåˆ—ã€‚PSï¼šåœ¨æœç´¢çš„æ—¶å€™æ˜¯ä¼šæŸ¥è¯¢Filesystem Cacheçš„ï¼Œä½†æ˜¯æœ‰éƒ¨åˆ†æ•°æ®è¿˜åœ¨Memory Bufferï¼Œæ‰€ä»¥æœç´¢æ˜¯è¿‘å®æ—¶çš„ã€‚ æ¯ä¸ªåˆ†ç‰‡è¿”å›å„è‡ªä¼˜å…ˆé˜Ÿåˆ—ä¸­ æ‰€æœ‰æ–‡æ¡£çš„ ID å’Œæ’åºå€¼ ç»™åè°ƒèŠ‚ç‚¹ï¼Œå®ƒåˆå¹¶è¿™äº›å€¼åˆ°è‡ªå·±çš„ä¼˜å…ˆé˜Ÿåˆ—ä¸­æ¥äº§ç”Ÿä¸€ä¸ªå…¨å±€æ’åºåçš„ç»“æœåˆ—è¡¨ã€‚ æ¥ä¸‹æ¥å°±æ˜¯ å–å›é˜¶æ®µï¼Œåè°ƒèŠ‚ç‚¹è¾¨åˆ«å‡ºå“ªäº›æ–‡æ¡£éœ€è¦è¢«å–å›å¹¶å‘ç›¸å…³çš„åˆ†ç‰‡æäº¤å¤šä¸ª GET è¯·æ±‚ã€‚æ¯ä¸ªåˆ†ç‰‡åŠ è½½å¹¶ ä¸°å¯Œ æ–‡æ¡£ï¼Œå¦‚æœæœ‰éœ€è¦çš„è¯ï¼Œæ¥ç€è¿”å›æ–‡æ¡£ç»™åè°ƒèŠ‚ç‚¹ã€‚ä¸€æ—¦æ‰€æœ‰çš„æ–‡æ¡£éƒ½è¢«å–å›äº†ï¼Œåè°ƒèŠ‚ç‚¹è¿”å›ç»“æœç»™å®¢æˆ·ç«¯ã€‚ è¡¥å……ï¼šQuery Then Fetchçš„æœç´¢ç±»å‹åœ¨æ–‡æ¡£ç›¸å…³æ€§æ‰“åˆ†çš„æ—¶å€™å‚è€ƒçš„æ˜¯æœ¬åˆ†ç‰‡çš„æ•°æ®ï¼Œè¿™æ ·åœ¨æ–‡æ¡£æ•°é‡è¾ƒå°‘çš„æ—¶å€™å¯èƒ½ä¸å¤Ÿå‡†ç¡®ï¼ŒDFS Query Then Fetchå¢åŠ äº†ä¸€ä¸ªé¢„æŸ¥è¯¢çš„å¤„ç†ï¼Œè¯¢é—®Termå’ŒDocument frequencyï¼Œè¿™ä¸ªè¯„åˆ†æ›´å‡†ç¡®ï¼Œä½†æ˜¯æ€§èƒ½ä¼šå˜å·®ã€‚ 11.Elasticsearchå¯¹äºå¤§æ•°æ®é‡ï¼ˆä¸Šäº¿é‡çº§ï¼‰çš„èšåˆå¦‚ä½•å®ç°ï¼Ÿ Elasticsearch æä¾›çš„é¦–ä¸ªè¿‘ä¼¼èšåˆæ˜¯cardinality åº¦é‡ã€‚å®ƒæä¾›ä¸€ä¸ªå­—æ®µçš„åŸºæ•°ï¼Œå³è¯¥å­—æ®µçš„distinctæˆ–è€…uniqueå€¼çš„æ•°ç›®ã€‚å®ƒæ˜¯åŸºäºHLLç®—æ³•çš„ã€‚HLL ä¼šå…ˆå¯¹æˆ‘ä»¬çš„è¾“å…¥ä½œå“ˆå¸Œè¿ç®—ï¼Œç„¶åæ ¹æ®å“ˆå¸Œè¿ç®—çš„ç»“æœä¸­çš„ bits åšæ¦‚ç‡ä¼°ç®—ä»è€Œå¾—åˆ°åŸºæ•°ã€‚å…¶ç‰¹ç‚¹æ˜¯ï¼šå¯é…ç½®çš„ç²¾åº¦ï¼Œç”¨æ¥æ§åˆ¶å†…å­˜çš„ä½¿ç”¨ï¼ˆæ›´ç²¾ç¡® ï¼ æ›´å¤šå†…å­˜ï¼‰ï¼›å°çš„æ•°æ®é›†ç²¾åº¦æ˜¯éå¸¸é«˜çš„ï¼›æˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®å‚æ•°ï¼Œæ¥è®¾ç½®å»é‡éœ€è¦çš„å›ºå®šå†…å­˜ä½¿ç”¨é‡ã€‚æ— è®ºæ•°åƒè¿˜æ˜¯æ•°åäº¿çš„å”¯ä¸€å€¼ï¼Œå†…å­˜ä½¿ç”¨é‡åªä¸ä½ é…ç½®çš„ç²¾ç¡®åº¦ç›¸å…³ã€‚ 12.åœ¨å¹¶å‘æƒ…å†µä¸‹ï¼ŒElasticsearchå¦‚æœä¿è¯è¯»å†™ä¸€è‡´ï¼Ÿ å¯ä»¥é€šè¿‡ç‰ˆæœ¬å·ä½¿ç”¨ä¹è§‚å¹¶å‘æ§åˆ¶ï¼Œä»¥ç¡®ä¿æ–°ç‰ˆæœ¬ä¸ä¼šè¢«æ—§ç‰ˆæœ¬è¦†ç›–ï¼Œç”±åº”ç”¨å±‚æ¥å¤„ç†å…·ä½“çš„å†²çªï¼› å¦å¤–å¯¹äºå†™æ“ä½œï¼Œä¸€è‡´æ€§çº§åˆ«æ”¯æŒquorum/one/allï¼Œé»˜è®¤ä¸ºquorumï¼Œå³åªæœ‰å½“å¤§å¤šæ•°åˆ†ç‰‡å¯ç”¨æ—¶æ‰å…è®¸å†™æ“ä½œã€‚ä½†å³ä½¿å¤§å¤šæ•°å¯ç”¨ï¼Œä¹Ÿå¯èƒ½å­˜åœ¨å› ä¸ºç½‘ç»œç­‰åŸå› å¯¼è‡´å†™å…¥å‰¯æœ¬å¤±è´¥ï¼Œè¿™æ ·è¯¥å‰¯æœ¬è¢«è®¤ä¸ºæ•…éšœï¼Œåˆ†ç‰‡å°†ä¼šåœ¨ä¸€ä¸ªä¸åŒçš„èŠ‚ç‚¹ä¸Šé‡å»ºã€‚ å¯¹äºè¯»æ“ä½œï¼Œå¯ä»¥è®¾ç½®replicationä¸ºsync(é»˜è®¤)ï¼Œè¿™ä½¿å¾—æ“ä½œåœ¨ä¸»åˆ†ç‰‡å’Œå‰¯æœ¬åˆ†ç‰‡éƒ½å®Œæˆåæ‰ä¼šè¿”å›ï¼›å¦‚æœè®¾ç½®replicationä¸ºasyncæ—¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½®æœç´¢è¯·æ±‚å‚æ•°_preferenceä¸ºprimaryæ¥æŸ¥è¯¢ä¸»åˆ†ç‰‡ï¼Œç¡®ä¿æ–‡æ¡£æ˜¯æœ€æ–°ç‰ˆæœ¬ã€‚ ","link":"https://tianxiawuhao.github.io/w_tIMVx00/"},{"title":"elasticSearchæŸ¥è¯¢è¯­å¥","content":" åŸæ–‡ï¼šhttps://distributedbytes.timojo.com/2016/07/23-useful-elasticsearch-example-queries.html ä½œè€…ï¼šTim Ojo ä¸ºäº†æ¼”ç¤ºä¸åŒç±»å‹çš„ ElasticSearch çš„æŸ¥è¯¢ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä»¥ä¸‹å­—æ®µæœç´¢ä¹¦ç±æ–‡æ¡£çš„é›†åˆï¼ˆ titleï¼ˆæ ‡é¢˜ï¼‰, authorsï¼ˆä½œè€…ï¼‰, summaryï¼ˆæ‘˜è¦ï¼‰, publish_dateï¼ˆå‘å¸ƒæ—¥æœŸï¼‰å’Œ num_reviewsï¼ˆæµè§ˆæ•°ï¼‰ï¼‰ã€‚ åœ¨è¿™ä¹‹å‰ï¼Œé¦–å…ˆæˆ‘ä»¬åº”è¯¥å…ˆåˆ›å»ºä¸€ä¸ªæ–°çš„ç´¢å¼•ï¼ˆindexï¼‰ï¼Œå¹¶æ‰¹é‡å¯¼å…¥ä¸€äº›æ–‡æ¡£ï¼š åˆ›å»ºç´¢å¼•ï¼š PUT /bookdb_index { &quot;settings&quot;: { &quot;number_of_shards&quot;: 1 }} æ‰¹é‡ä¸Šä¼ æ–‡æ¡£ï¼š POST /bookdb_index/book/_bulk { &quot;index&quot;: { &quot;_id&quot;: 1 }} { &quot;title&quot;: &quot;Elasticsearch: The Definitive Guide&quot;, &quot;authors&quot;: [&quot;clinton gormley&quot;, &quot;zachary tong&quot;], &quot;summary&quot; : &quot;A distibuted real-time search and analytics engine&quot;, &quot;publish_date&quot; : &quot;2015-02-07&quot;, &quot;num_reviews&quot;: 20, &quot;publisher&quot;: &quot;oreilly&quot; } { &quot;index&quot;: { &quot;_id&quot;: 2 }} { &quot;title&quot;: &quot;Taming Text: How to Find, Organize, and Manipulate It&quot;, &quot;authors&quot;: [&quot;grant ingersoll&quot;, &quot;thomas morton&quot;, &quot;drew farris&quot;], &quot;summary&quot; : &quot;organize text using approaches such as full-text search, proper name recognition, clustering, tagging, information extraction, and summarization&quot;, &quot;publish_date&quot; : &quot;2013-01-24&quot;, &quot;num_reviews&quot;: 12, &quot;publisher&quot;: &quot;manning&quot; } { &quot;index&quot;: { &quot;_id&quot;: 3 }} { &quot;title&quot;: &quot;Elasticsearch in Action&quot;, &quot;authors&quot;: [&quot;radu gheorge&quot;, &quot;matthew lee hinman&quot;, &quot;roy russo&quot;], &quot;summary&quot; : &quot;build scalable search applications using Elasticsearch without having to do complex low-level programming or understand advanced data science algorithms&quot;, &quot;publish_date&quot; : &quot;2015-12-03&quot;, &quot;num_reviews&quot;: 18, &quot;publisher&quot;: &quot;manning&quot; } { &quot;index&quot;: { &quot;_id&quot;: 4 }} { &quot;title&quot;: &quot;Solr in Action&quot;, &quot;authors&quot;: [&quot;trey grainger&quot;, &quot;timothy potter&quot;], &quot;summary&quot; : &quot;Comprehensive guide to implementing a scalable search engine using Apache Solr&quot;, &quot;publish_date&quot; : &quot;2014-04-05&quot;, &quot;num_reviews&quot;: 23, &quot;publisher&quot;: &quot;manning&quot; } ä¾‹å­ 1.åŸºæœ¬æ¯”å¯¹æŸ¥è¯¢ æ‰§è¡ŒåŸºæœ¬çš„å…¨æ–‡æœ¬ï¼ˆåŒ¹é…ï¼‰æŸ¥è¯¢æœ‰ä¸¤ç§æ–¹å¼ï¼šä½¿ç”¨Search Lite APIï¼ˆå®ƒå¸Œæœ›æ‰€æœ‰æœç´¢å‚æ•°éƒ½ä½œä¸ºURLçš„ä¸€éƒ¨åˆ†ä¼ å…¥ï¼‰ï¼Œæˆ–ä½¿ç”¨å®Œæ•´çš„JSONè¯·æ±‚æ­£æ–‡ï¼ˆå…è®¸æ‚¨ä½¿ç”¨å®Œæ•´çš„Elasticsearch DSL)ã€‚ è¿™æ˜¯ä¸€ä¸ªåŸºæœ¬çš„åŒ¹é…æŸ¥è¯¢ï¼Œå®ƒåœ¨æ‰€æœ‰å­—æ®µä¸­æœç´¢å­—ç¬¦ä¸²â€œ guideâ€ GET /bookdb_index/book/_search?q=guide [Results] &quot;hits&quot;: [ { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;1&quot;, &quot;_score&quot;: 0.28168046, &quot;_source&quot;: { &quot;title&quot;: &quot;Elasticsearch: The Definitive Guide&quot;, &quot;authors&quot;: [ &quot;clinton gormley&quot;, &quot;zachary tong&quot; ], &quot;summary&quot;: &quot;A distibuted real-time search and analytics engine&quot;, &quot;publish_date&quot;: &quot;2015-02-07&quot;, &quot;num_reviews&quot;: 20, &quot;publisher&quot;: &quot;manning&quot; } }, { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;4&quot;, &quot;_score&quot;: 0.24144039, &quot;_source&quot;: { &quot;title&quot;: &quot;Solr in Action&quot;, &quot;authors&quot;: [ &quot;trey grainger&quot;, &quot;timothy potter&quot; ], &quot;summary&quot;: &quot;Comprehensive guide to implementing a scalable search engine using Apache Solr&quot;, &quot;publish_date&quot;: &quot;2014-04-05&quot;, &quot;num_reviews&quot;: 23, &quot;publisher&quot;: &quot;manning&quot; } } ] è¯¥æŸ¥è¯¢çš„å®Œæ•´ç‰ˆæœ¬å¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶äº§ç”Ÿçš„ç»“æœä¸ä¸Šè¿°æœç´¢ç²¾ç®€ç‰ˆç›¸åŒã€‚ { &quot;query&quot;: { &quot;multi_match&quot; : { &quot;query&quot; : &quot;guide&quot;, &quot;fields&quot; : [&quot;_all&quot;] } } } ä½¿ç”¨multi_matchå…³é”®å­—ä»£æ›¿å…³é”®å­—matchæ˜¯å¯¹å¤šä¸ªå­—æ®µè¿è¡Œç›¸åŒæŸ¥è¯¢çš„ä¾¿æ·å¿«æ·æ–¹å¼ã€‚è¯¥fieldså±æ€§æŒ‡å®šè¦æŸ¥è¯¢çš„å­—æ®µï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¦æŸ¥è¯¢æ–‡æ¡£ä¸­çš„æ‰€æœ‰å­—æ®µã€‚ è¿™ä¸¤ä¸ªAPIå‡å…è®¸æ‚¨æŒ‡å®šè¦æœç´¢çš„å­—æ®µã€‚ä¾‹å¦‚ï¼Œè¦åœ¨æ ‡é¢˜å­—æ®µä¸­æœç´¢å¸¦æœ‰â€œin actionâ€å­—æ ·çš„å›¾ä¹¦ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š GET /bookdb_index/book/_search?q=title:in action [Results] &quot;hits&quot;: [ { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;4&quot;, &quot;_score&quot;: 0.6259885, &quot;_source&quot;: { &quot;title&quot;: &quot;Solr in Action&quot;, &quot;authors&quot;: [ &quot;trey grainger&quot;, &quot;timothy potter&quot; ], &quot;summary&quot;: &quot;Comprehensive guide to implementing a scalable search engine using Apache Solr&quot;, &quot;publish_date&quot;: &quot;2014-04-05&quot;, &quot;num_reviews&quot;: 23, &quot;publisher&quot;: &quot;manning&quot; } }, { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;3&quot;, &quot;_score&quot;: 0.5975345, &quot;_source&quot;: { &quot;title&quot;: &quot;Elasticsearch in Action&quot;, &quot;authors&quot;: [ &quot;radu gheorge&quot;, &quot;matthew lee hinman&quot;, &quot;roy russo&quot; ], &quot;summary&quot;: &quot;build scalable search applications using Elasticsearch without having to do complex low-level programming or understand advanced data science algorithms&quot;, &quot;publish_date&quot;: &quot;2015-12-03&quot;, &quot;num_reviews&quot;: 18, &quot;publisher&quot;: &quot;manning&quot; } } ] ä½†æ˜¯ï¼Œå…¨èº«DSLåœ¨åˆ›å»ºæ›´å¤æ‚çš„æŸ¥è¯¢ï¼ˆå¦‚æˆ‘ä»¬å°†åœ¨åé¢çœ‹åˆ°ï¼‰ä»¥åŠæŒ‡å®šæ‚¨å¸Œæœ›å¦‚ä½•è¿”å›ç»“æœæ–¹é¢ç»™æ‚¨æ›´å¤§çš„çµæ´»æ€§ã€‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æŒ‡å®šè¦è¿”å›çš„ç»“æœæ•°ï¼Œå¼€å§‹çš„åç§»é‡ï¼ˆç”¨äºåˆ†é¡µï¼‰ï¼Œè¦è¿”å›çš„æ–‡æ¡£å­—æ®µä»¥åŠæœ¯è¯­çªå‡ºæ˜¾ç¤ºã€‚ POST /bookdb_index/book/_search { &quot;query&quot;: { &quot;match&quot; : { &quot;title&quot; : &quot;in action&quot; } }, &quot;size&quot;: 2, &quot;from&quot;: 0, &quot;_source&quot;: [ &quot;title&quot;, &quot;summary&quot;, &quot;publish_date&quot; ], &quot;highlight&quot;: { &quot;fields&quot; : { &quot;title&quot; : {} } } } [Results] &quot;hits&quot;: { &quot;total&quot;: 2, &quot;max_score&quot;: 0.9105287, &quot;hits&quot;: [ { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;3&quot;, &quot;_score&quot;: 0.9105287, &quot;_source&quot;: { &quot;summary&quot;: &quot;build scalable search applications using Elasticsearch without having to do complex low-level programming or understand advanced data science algorithms&quot;, &quot;title&quot;: &quot;Elasticsearch in Action&quot;, &quot;publish_date&quot;: &quot;2015-12-03&quot; }, &quot;highlight&quot;: { &quot;title&quot;: [ &quot;Elasticsearch &lt;em&gt;in&lt;/em&gt; &lt;em&gt;Action&lt;/em&gt;&quot; ] } }, { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;4&quot;, &quot;_score&quot;: 0.9105287, &quot;_source&quot;: { &quot;summary&quot;: &quot;Comprehensive guide to implementing a scalable search engine using Apache Solr&quot;, &quot;title&quot;: &quot;Solr in Action&quot;, &quot;publish_date&quot;: &quot;2014-04-05&quot; }, &quot;highlight&quot;: { &quot;title&quot;: [ &quot;Solr &lt;em&gt;in&lt;/em&gt; &lt;em&gt;Action&lt;/em&gt;&quot; ] } } ] } æ³¨æ„ï¼šå¯¹äºå¤šå­—æŸ¥è¯¢ï¼Œè¯¥matchæŸ¥è¯¢ä½¿æ‚¨å¯ä»¥æŒ‡å®šæ˜¯å¦ä½¿ç”¨andè¿ç®—ç¬¦è€Œä¸æ˜¯é»˜è®¤orè¿ç®—ç¬¦ã€‚æ‚¨è¿˜å¯ä»¥æŒ‡å®šminimum_should_matché€‰é¡¹æ¥è°ƒæ•´è¿”å›ç»“æœçš„ç›¸å…³æ€§ã€‚å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°è¯¦ç»†ä¿¡æ¯ã€‚ 2.å¤šå­—æ®µæœç´¢ æ­£å¦‚æˆ‘ä»¬å·²ç»çœ‹åˆ°çš„ï¼Œè¦åœ¨æœç´¢ä¸­æŸ¥è¯¢å¤šä¸ªæ–‡æ¡£å­—æ®µï¼ˆä¾‹å¦‚ï¼Œåœ¨æ ‡é¢˜å’Œæ‘˜è¦ä¸­æœç´¢ç›¸åŒçš„æŸ¥è¯¢å­—ç¬¦ä¸²ï¼‰ï¼Œåˆ™å¯ä»¥ä½¿ç”¨è¯¥multi_matchæŸ¥è¯¢ã€‚ POST /bookdb_index/book/_search { &quot;query&quot;: { &quot;multi_match&quot; : { &quot;query&quot; : &quot;elasticsearch guide&quot;, &quot;fields&quot;: [&quot;title&quot;, &quot;summary&quot;] } } } [Results] &quot;hits&quot;: { &quot;total&quot;: 3, &quot;max_score&quot;: 0.9448582, &quot;hits&quot;: [ { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;1&quot;, &quot;_score&quot;: 0.9448582, &quot;_source&quot;: { &quot;title&quot;: &quot;Elasticsearch: The Definitive Guide&quot;, &quot;authors&quot;: [ &quot;clinton gormley&quot;, &quot;zachary tong&quot; ], &quot;summary&quot;: &quot;A distibuted real-time search and analytics engine&quot;, &quot;publish_date&quot;: &quot;2015-02-07&quot;, &quot;num_reviews&quot;: 20, &quot;publisher&quot;: &quot;manning&quot; } }, { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;3&quot;, &quot;_score&quot;: 0.17312013, &quot;_source&quot;: { &quot;title&quot;: &quot;Elasticsearch in Action&quot;, &quot;authors&quot;: [ &quot;radu gheorge&quot;, &quot;matthew lee hinman&quot;, &quot;roy russo&quot; ], &quot;summary&quot;: &quot;build scalable search applications using Elasticsearch without having to do complex low-level programming or understand advanced data science algorithms&quot;, &quot;publish_date&quot;: &quot;2015-12-03&quot;, &quot;num_reviews&quot;: 18, &quot;publisher&quot;: &quot;manning&quot; } }, { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;4&quot;, &quot;_score&quot;: 0.14965448, &quot;_source&quot;: { &quot;title&quot;: &quot;Solr in Action&quot;, &quot;authors&quot;: [ &quot;trey grainger&quot;, &quot;timothy potter&quot; ], &quot;summary&quot;: &quot;Comprehensive guide to implementing a scalable search engine using Apache Solr&quot;, &quot;publish_date&quot;: &quot;2014-04-05&quot;, &quot;num_reviews&quot;: 23, &quot;publisher&quot;: &quot;manning&quot; } } ] } è¯·æ³¨æ„ï¼Œå‘½ä¸­æ•°å­—3ç›¸åŒ¹é…ï¼Œå› ä¸ºåœ¨æ‘˜è¦ä¸­æ‰¾åˆ°äº†â€œæŒ‡å—â€ä¸€è¯ã€‚ 3.æé«˜å­—æ®µé‡è¦æ€§ ç”±äºæˆ‘ä»¬æ­£åœ¨å¤šä¸ªå­—æ®µä¸­è¿›è¡Œæœç´¢ï¼Œå› æ­¤æˆ‘ä»¬å¯èƒ½å¸Œæœ›æé«˜ç‰¹å®šå­—æ®µä¸­çš„å¾—åˆ†ã€‚åœ¨ä»¥ä¸‹äººä¸ºè®¾è®¡çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†æ‘˜è¦å­—æ®µçš„å¾—åˆ†æé«˜äº†3å€ï¼Œä»¥æé«˜æ‘˜è¦å­—æ®µçš„é‡è¦æ€§ï¼Œè¿™åè¿‡æ¥åˆä¼šå¢åŠ æ–‡æ¡£_id 4çš„ç›¸å…³æ€§ã€‚ POST /bookdb_index/book/_search { &quot;query&quot;: { &quot;multi_match&quot; : { &quot;query&quot; : &quot;elasticsearch guide&quot;, &quot;fields&quot;: [&quot;title&quot;, &quot;summary^3&quot;] } }, &quot;_source&quot;: [&quot;title&quot;, &quot;summary&quot;, &quot;publish_date&quot;] } [Results] &quot;hits&quot;: [ { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;1&quot;, &quot;_score&quot;: 0.31495273, &quot;_source&quot;: { &quot;summary&quot;: &quot;A distibuted real-time search and analytics engine&quot;, &quot;title&quot;: &quot;Elasticsearch: The Definitive Guide&quot;, &quot;publish_date&quot;: &quot;2015-02-07&quot; } }, { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;4&quot;, &quot;_score&quot;: 0.14965448, &quot;_source&quot;: { &quot;summary&quot;: &quot;Comprehensive guide to implementing a scalable search engine using Apache Solr&quot;, &quot;title&quot;: &quot;Solr in Action&quot;, &quot;publish_date&quot;: &quot;2014-04-05&quot; } }, { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;3&quot;, &quot;_score&quot;: 0.13094766, &quot;_source&quot;: { &quot;summary&quot;: &quot;build scalable search applications using Elasticsearch without having to do complex low-level programming or understand advanced data science algorithms&quot;, &quot;title&quot;: &quot;Elasticsearch in Action&quot;, &quot;publish_date&quot;: &quot;2015-12-03&quot; } } ] æ³¨æ„ ï¼šBoostingä¸ä»…ä»…æ„å‘³ç€è®¡ç®—å‡ºçš„åˆ†æ•°ä¼šä¹˜ä»¥Boostingç³»æ•°ã€‚å®é™…åº”ç”¨çš„å‡å‹å€¼ç»è¿‡å½’ä¸€åŒ–å’Œä¸€äº›å†…éƒ¨ä¼˜åŒ–ã€‚æœ‰å…³å¢å¼ºå·¥ä½œåŸç†çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ ElasticsearchæŒ‡å—ã€‚ 4.å¸ƒå°”æŸ¥è¯¢ AND / OR / NOTè¿ç®—ç¬¦å¯ç”¨äºå¾®è°ƒæˆ‘ä»¬çš„æœç´¢æŸ¥è¯¢ï¼Œä»¥æä¾›æ›´ç›¸å…³æˆ–æ›´å…·ä½“çš„ç»“æœã€‚è¿™æ˜¯åœ¨æœç´¢APIä¸­ä½œä¸ºboolæŸ¥è¯¢å®ç°çš„ã€‚è¯¥boolæŸ¥è¯¢æ¥å—ä¸€ä¸ªmustå‚æ•°ï¼ˆç­‰åŒäºANDï¼‰ï¼Œä¸€ä¸ªmust_notå‚æ•°ï¼ˆç­‰åŒäºNOTï¼‰å’Œä¸€ä¸ªshouldå‚æ•°ï¼ˆç­‰åŒäºORï¼‰ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘è¦æœç´¢ä¹¦åä¸­å¸¦æœ‰â€œ Elasticsearchâ€æˆ–â€œ Solrâ€å­—æ ·çš„ä¹¦ï¼Œåˆ™ANDç”±â€œå…‹æ—é¡¿Â·æˆˆå§†åˆ©â€ï¼ˆclinton gormleyï¼‰åˆ›ä½œï¼Œè€Œä¸ç”±â€œ radu gheorgeâ€ï¼ˆradu gheorgeï¼‰åˆ›ä½œï¼š POST /bookdb_index/book/_search { &quot;query&quot;: { &quot;bool&quot;: { &quot;must&quot;: { &quot;bool&quot; : { &quot;should&quot;: [ { &quot;match&quot;: { &quot;title&quot;: &quot;Elasticsearch&quot; }}, { &quot;match&quot;: { &quot;title&quot;: &quot;Solr&quot; }} ] } }, &quot;must&quot;: { &quot;match&quot;: { &quot;authors&quot;: &quot;clinton gormely&quot; }}, &quot;must_not&quot;: { &quot;match&quot;: {&quot;authors&quot;: &quot;radu gheorge&quot; }} } } } [Results] &quot;hits&quot;: [ { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;1&quot;, &quot;_score&quot;: 0.3672021, &quot;_source&quot;: { &quot;title&quot;: &quot;Elasticsearch: The Definitive Guide&quot;, &quot;authors&quot;: [ &quot;clinton gormley&quot;, &quot;zachary tong&quot; ], &quot;summary&quot;: &quot;A distibuted real-time search and analytics engine&quot;, &quot;publish_date&quot;: &quot;2015-02-07&quot;, &quot;num_reviews&quot;: 20, &quot;publisher&quot;: &quot;oreilly&quot; } } ] æ³¨æ„ï¼šå¦‚æ‚¨æ‰€è§ï¼Œå¸ƒå°”æŸ¥è¯¢å¯ä»¥åŒ…è£…ä»»ä½•å…¶ä»–æŸ¥è¯¢ç±»å‹ï¼ŒåŒ…æ‹¬å…¶ä»–å¸ƒå°”æŸ¥è¯¢ï¼Œä»¥åˆ›å»ºä»»æ„å¤æ‚æˆ–æ·±åº¦åµŒå¥—çš„æŸ¥è¯¢ã€‚ 5.æ¨¡ç³ŠæŸ¥è¯¢ å¯ä»¥åœ¨â€œåŒ¹é…â€å’Œâ€œå¤šåŒ¹é…â€æŸ¥è¯¢ä¸­å¯ç”¨æ¨¡ç³ŠåŒ¹é…ï¼Œä»¥æ•è·æ‹¼å†™é”™è¯¯ã€‚æ¨¡ç³Šç¨‹åº¦æ˜¯æ ¹æ®è·åŸå§‹å•è¯çš„Levenshteinè·ç¦»æŒ‡å®šçš„ã€‚ POST /bookdb_index/book/_search { &quot;query&quot;: { &quot;multi_match&quot; : { &quot;query&quot; : &quot;comprihensiv guide&quot;, &quot;fields&quot;: [&quot;title&quot;, &quot;summary&quot;], &quot;fuzziness&quot;: &quot;AUTO&quot; } }, &quot;_source&quot;: [&quot;title&quot;, &quot;summary&quot;, &quot;publish_date&quot;], &quot;size&quot;: 1 } [Results] &quot;hits&quot;: [ { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;4&quot;, &quot;_score&quot;: 0.5961596, &quot;_source&quot;: { &quot;summary&quot;: &quot;Comprehensive guide to implementing a scalable search engine using Apache Solr&quot;, &quot;title&quot;: &quot;Solr in Action&quot;, &quot;publish_date&quot;: &quot;2014-04-05&quot; } } ] æ³¨æ„ï¼šæ¨¡ç³Šåº¦å€¼&quot;AUTO&quot;ç­‰äºæŒ‡å®š2æœ¯è¯­é•¿åº¦å¤§äº5æ—¶çš„å€¼ã€‚ä½†æ˜¯ï¼Œè®¾ç½®80ï¼…çš„äººç±»æ‹¼å†™é”™è¯¯çš„ç¼–è¾‘è·ç¦»ä¸º1ï¼Œå¹¶å°†æ¨¡ç³Šåº¦è®¾ç½®ä¸º1å¯ä»¥æ”¹å–„æ•´ä½“æœç´¢æ€§èƒ½ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ã€ŠElasticsearchæœ€ç»ˆæŒ‡å—ã€‹çš„â€œé”™åˆ«å­—å’Œæ‹¼å†™é”™è¯¯â€ä¸€ç« ã€‚ 6.é€šé…ç¬¦æŸ¥è¯¢ é€šé…ç¬¦æŸ¥è¯¢ä½¿æ‚¨å¯ä»¥æŒ‡å®šè¦åŒ¹é…çš„æ¨¡å¼ï¼Œè€Œä¸æ˜¯æ•´ä¸ªæœ¯è¯­ã€‚?åŒ¹é…ä»»ä½•å­—ç¬¦å¹¶*åŒ¹é…é›¶ä¸ªæˆ–å¤šä¸ªå­—ç¬¦ã€‚ä¾‹å¦‚ï¼Œè¦æŸ¥æ‰¾æ‰€æœ‰ä½œè€…å§“åä»¥å­—æ¯â€œ tâ€å¼€å¤´çš„è®°å½• POST /bookdb_index/book/_search { &quot;query&quot;: { &quot;wildcard&quot; : { &quot;authors&quot; : &quot;t*&quot; } }, &quot;_source&quot;: [&quot;title&quot;, &quot;authors&quot;], &quot;highlight&quot;: { &quot;fields&quot; : { &quot;authors&quot; : {} } } } [Results] &quot;hits&quot;: [ { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;1&quot;, &quot;_score&quot;: 1, &quot;_source&quot;: { &quot;title&quot;: &quot;Elasticsearch: The Definitive Guide&quot;, &quot;authors&quot;: [ &quot;clinton gormley&quot;, &quot;zachary tong&quot; ] }, &quot;highlight&quot;: { &quot;authors&quot;: [ &quot;zachary &lt;em&gt;tong&lt;/em&gt;&quot; ] } }, { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;2&quot;, &quot;_score&quot;: 1, &quot;_source&quot;: { &quot;title&quot;: &quot;Taming Text: How to Find, Organize, and Manipulate It&quot;, &quot;authors&quot;: [ &quot;grant ingersoll&quot;, &quot;thomas morton&quot;, &quot;drew farris&quot; ] }, &quot;highlight&quot;: { &quot;authors&quot;: [ &quot;&lt;em&gt;thomas&lt;/em&gt; morton&quot; ] } }, { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;4&quot;, &quot;_score&quot;: 1, &quot;_source&quot;: { &quot;title&quot;: &quot;Solr in Action&quot;, &quot;authors&quot;: [ &quot;trey grainger&quot;, &quot;timothy potter&quot; ] }, &quot;highlight&quot;: { &quot;authors&quot;: [ &quot;&lt;em&gt;trey&lt;/em&gt; grainger&quot;, &quot;&lt;em&gt;timothy&lt;/em&gt; potter&quot; ] } } ] 7.æ­£åˆ™è¡¨è¾¾å¼æŸ¥è¯¢ æ­£åˆ™è¡¨è¾¾å¼æŸ¥è¯¢ä½¿æ‚¨å¯ä»¥æŒ‡å®šæ¯”é€šé…ç¬¦æŸ¥è¯¢æ›´å¤æ‚çš„æ¨¡å¼ã€‚ POST /bookdb_index/book/_search { &quot;query&quot;: { &quot;regexp&quot; : { &quot;authors&quot; : &quot;t[a-z]*y&quot; } }, &quot;_source&quot;: [&quot;title&quot;, &quot;authors&quot;], &quot;highlight&quot;: { &quot;fields&quot; : { &quot;authors&quot; : {} } } } [Results] &quot;hits&quot;: [ { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;4&quot;, &quot;_score&quot;: 1, &quot;_source&quot;: { &quot;title&quot;: &quot;Solr in Action&quot;, &quot;authors&quot;: [ &quot;trey grainger&quot;, &quot;timothy potter&quot; ] }, &quot;highlight&quot;: { &quot;authors&quot;: [ &quot;&lt;em&gt;trey&lt;/em&gt; grainger&quot;, &quot;&lt;em&gt;timothy&lt;/em&gt; potter&quot; ] } } ] 8.åŒ¹é…è¯ç»„æŸ¥è¯¢ åŒ¹é…è¯ç»„æŸ¥è¯¢è¦æ±‚æŸ¥è¯¢å­—ç¬¦ä¸²ä¸­çš„æ‰€æœ‰æœ¯è¯­éƒ½å­˜åœ¨äºæ–‡æ¡£ä¸­ï¼Œå¹¶æŒ‰ç…§æŸ¥è¯¢å­—ç¬¦ä¸²ä¸­æŒ‡å®šçš„é¡ºåºå¹¶ä¸”å½¼æ­¤æ¥è¿‘ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæœ¯è¯­å¿…é¡»å½¼æ­¤å®Œå…¨å¹³è¡Œï¼Œä½†æ˜¯æ‚¨å¯ä»¥æŒ‡å®šä¸€ä¸ªslopå€¼ï¼Œè¯¥å€¼æŒ‡ç¤ºåœ¨ä»å°†æ–‡æ¡£è§†ä¸ºåŒ¹é…é¡¹æ—¶å…è®¸ç›¸éš”å¤šè¿œçš„æœ¯è¯­ã€‚ POST /bookdb_index/book/_search { &quot;query&quot;: { &quot;multi_match&quot; : { &quot;query&quot;: &quot;search engine&quot;, &quot;fields&quot;: [&quot;title&quot;, &quot;summary&quot;], &quot;type&quot;: &quot;phrase&quot;, &quot;slop&quot;: 3 } }, &quot;_source&quot;: [ &quot;title&quot;, &quot;summary&quot;, &quot;publish_date&quot; ] } [Results] &quot;hits&quot;: [ { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;4&quot;, &quot;_score&quot;: 0.22327082, &quot;_source&quot;: { &quot;summary&quot;: &quot;Comprehensive guide to implementing a scalable search engine using Apache Solr&quot;, &quot;title&quot;: &quot;Solr in Action&quot;, &quot;publish_date&quot;: &quot;2014-04-05&quot; } }, { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;1&quot;, &quot;_score&quot;: 0.16113183, &quot;_source&quot;: { &quot;summary&quot;: &quot;A distibuted real-time search and analytics engine&quot;, &quot;title&quot;: &quot;Elasticsearch: The Definitive Guide&quot;, &quot;publish_date&quot;: &quot;2015-02-07&quot; } } ] æ³¨æ„ï¼šåœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œå¯¹äºéçŸ­è¯­ç±»å‹æŸ¥è¯¢ï¼Œæ–‡æ¡£çš„_id 1å¾—åˆ†é€šå¸¸æ›´é«˜ï¼Œå¹¶ä¸”_id 4ç”±äºå…¶å­—æ®µé•¿åº¦è¾ƒçŸ­è€Œå‡ºç°åœ¨æ–‡æ¡£çš„å‰é¢ã€‚ä½†æ˜¯ï¼Œåœ¨è¿›è¡ŒçŸ­è¯­æŸ¥è¯¢æ—¶ï¼Œä¼šè€ƒè™‘åˆ°æœ¯è¯­çš„æ¥è¿‘åº¦ï¼Œå› æ­¤æ–‡æ¡£_id 4å¾—åˆ†ä¼šæ›´é«˜ã€‚ 9.åŒ¹é…è¯ç»„å‰ç¼€ åŒ¹é…è¯ç»„å‰ç¼€æŸ¥è¯¢å¯åœ¨æŸ¥è¯¢æ—¶æä¾›â€œæŒ‰éœ€è¾“å…¥â€æˆ–â€œç©·äººâ€ç‰ˆæœ¬çš„è‡ªåŠ¨å®ŒæˆåŠŸèƒ½ï¼Œè€Œæ— éœ€ä»¥ä»»ä½•æ–¹å¼å‡†å¤‡æ•°æ®ã€‚åƒmatch_phraseæŸ¥è¯¢ä¸€æ ·ï¼Œå®ƒæ¥å—ä¸€ä¸ªslopå‚æ•°ä»¥ä½¿å•è¯é¡ºåºå’Œç›¸å¯¹ä½ç½®çš„åˆšæ€§é™ä½ä¸€äº›ã€‚æˆ‘è¿˜æ¥å—è¯¥max_expansionså‚æ•°æ¥é™åˆ¶åŒ¹é…é¡¹çš„æ•°é‡ï¼Œä»¥é™ä½èµ„æºå¼ºåº¦ã€‚ POST /bookdb_index/book/_search { &quot;query&quot;: { &quot;match_phrase_prefix&quot; : { &quot;summary&quot;: { &quot;query&quot;: &quot;search en&quot;, &quot;slop&quot;: 3, &quot;max_expansions&quot;: 10 } } }, &quot;_source&quot;: [ &quot;title&quot;, &quot;summary&quot;, &quot;publish_date&quot; ] } [Results] &quot;hits&quot;: [ { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;4&quot;, &quot;_score&quot;: 0.5161346, &quot;_source&quot;: { &quot;summary&quot;: &quot;Comprehensive guide to implementing a scalable search engine using Apache Solr&quot;, &quot;title&quot;: &quot;Solr in Action&quot;, &quot;publish_date&quot;: &quot;2014-04-05&quot; } }, { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;1&quot;, &quot;_score&quot;: 0.37248808, &quot;_source&quot;: { &quot;summary&quot;: &quot;A distibuted real-time search and analytics engine&quot;, &quot;title&quot;: &quot;Elasticsearch: The Definitive Guide&quot;, &quot;publish_date&quot;: &quot;2015-02-07&quot; } } ] æ³¨æ„ï¼šâ€œæŒ‰ç±»å‹æŸ¥è¯¢æ—¶æœç´¢â€ä¼šé™ä½æ€§èƒ½ã€‚æ›´å¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯æŒ‰ç±»å‹è¿›è¡Œç´¢å¼•æ—¶é—´æœç´¢ã€‚è¯·æŸ¥çœ‹å®Œæˆæç¤ºAPIæˆ–ä½¿ç”¨Edge-Ngramè¿‡æ»¤å™¨ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚ 10.è¯·æ±‚å‚æ•° è¯¥query_stringæŸ¥è¯¢æä¾›äº†ä¸€ç§ä»¥ç®€æ´çš„é€Ÿè®°è¯­æ³•æ‰§è¡Œå¤šé‡åŒ¹é…æŸ¥è¯¢ï¼Œå¸ƒå°”æŸ¥è¯¢ï¼Œå¢å¼ºæŸ¥è¯¢ï¼Œæ¨¡ç³ŠåŒ¹é…ï¼Œé€šé…ç¬¦ï¼Œæ­£åˆ™è¡¨è¾¾å¼å’ŒèŒƒå›´æŸ¥è¯¢çš„æ–¹æ³•ã€‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯¹æœ¯è¯­â€œ saerchç®—æ³•â€æ‰§è¡Œæ¨¡ç³Šæœç´¢ï¼Œå…¶ä¸­ä½œè€…ä¹‹ä¸€æ˜¯â€œ grant ingersollâ€æˆ–â€œ tom mortonâ€ã€‚æˆ‘ä»¬æœç´¢æ‰€æœ‰å­—æ®µï¼Œä½†å¯¹æ‘˜è¦å­—æ®µåŠ 2ã€‚ POST /bookdb_index/book/_search { &quot;query&quot;: { &quot;query_string&quot; : { &quot;query&quot;: &quot;(saerch~1 algorithm~1) AND (grant ingersoll) OR (tom morton)&quot;, &quot;fields&quot;: [&quot;_all&quot;, &quot;summary^2&quot;] } }, &quot;_source&quot;: [ &quot;title&quot;, &quot;summary&quot;, &quot;authors&quot; ], &quot;highlight&quot;: { &quot;fields&quot; : { &quot;summary&quot; : {} } } } [Results] &quot;hits&quot;: [ { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;2&quot;, &quot;_score&quot;: 0.14558059, &quot;_source&quot;: { &quot;summary&quot;: &quot;organize text using approaches such as full-text search, proper name recognition, clustering, tagging, information extraction, and summarization&quot;, &quot;title&quot;: &quot;Taming Text: How to Find, Organize, and Manipulate It&quot;, &quot;authors&quot;: [ &quot;grant ingersoll&quot;, &quot;thomas morton&quot;, &quot;drew farris&quot; ] }, &quot;highlight&quot;: { &quot;summary&quot;: [ &quot;organize text using approaches such as full-text &lt;em&gt;search&lt;/em&gt;, proper name recognition, clustering, tagging, information extraction, and summarization&quot; ] } } ] 11.ç®€å•æŸ¥è¯¢å­—ç¬¦ä¸² è¯¥simple_query_stringæŸ¥è¯¢æ˜¯è¯¥æŸ¥è¯¢çš„ä¸€ç§ç‰ˆæœ¬query_stringï¼Œå®ƒæ›´é€‚åˆåœ¨æš´éœ²ç»™ç”¨æˆ·çš„å•ä¸ªæœç´¢æ¡†ä¸­ä½¿ç”¨ã€‚å®ƒåˆ†åˆ«ç”¨+ / | /-ä»£æ›¿äº†AND / OR / NOTçš„ä½¿ç”¨ï¼Œå¹¶ä¸”ä¸¢å¼ƒäº†æŸ¥è¯¢çš„æ— æ•ˆéƒ¨åˆ†ï¼Œè€Œä¸æ˜¯åœ¨ç”¨æˆ·çŠ¯é”™æ—¶æŠ›å‡ºå¼‚å¸¸ã€‚ POST /bookdb_index/book/_search { &quot;query&quot;: { &quot;simple_query_string&quot; : { &quot;query&quot;: &quot;(saerch~1 algorithm~1) + (grant ingersoll) | (tom morton)&quot;, &quot;fields&quot;: [&quot;_all&quot;, &quot;summary^2&quot;] } }, &quot;_source&quot;: [ &quot;title&quot;, &quot;summary&quot;, &quot;authors&quot; ], &quot;highlight&quot;: { &quot;fields&quot; : { &quot;summary&quot; : {} } } } 12.æœ¯è¯­æŸ¥è¯¢ ä»¥ä¸Šç¤ºä¾‹æ˜¯å…¨æ–‡æœç´¢çš„ç¤ºä¾‹ã€‚æœ‰æ—¶ï¼Œæˆ‘ä»¬å¯¹ç»“æ„åŒ–æœç´¢æ›´æ„Ÿå…´è¶£ï¼Œåœ¨ç»“æ„åŒ–æœç´¢ä¸­æˆ‘ä»¬å¸Œæœ›æ‰¾åˆ°å®Œå…¨åŒ¹é…å¹¶è¿”å›ç»“æœã€‚åœ¨termä¸termsæŸ¥è¯¢å¸®åŠ©æˆ‘ä»¬åœ¨è¿™é‡Œã€‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æ­£åœ¨æœç´¢Manning Publicationså‡ºç‰ˆçš„ç´¢å¼•ä¸­çš„æ‰€æœ‰ä¹¦ç±ã€‚ POST /bookdb_index/book/_search { &quot;query&quot;: { &quot;term&quot; : { &quot;publisher&quot;: &quot;manning&quot; } }, &quot;_source&quot; : [&quot;title&quot;,&quot;publish_date&quot;,&quot;publisher&quot;] } [Results] &quot;hits&quot;: [ { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;2&quot;, &quot;_score&quot;: 1.2231436, &quot;_source&quot;: { &quot;publisher&quot;: &quot;manning&quot;, &quot;title&quot;: &quot;Taming Text: How to Find, Organize, and Manipulate It&quot;, &quot;publish_date&quot;: &quot;2013-01-24&quot; } }, { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;3&quot;, &quot;_score&quot;: 1.2231436, &quot;_source&quot;: { &quot;publisher&quot;: &quot;manning&quot;, &quot;title&quot;: &quot;Elasticsearch in Action&quot;, &quot;publish_date&quot;: &quot;2015-12-03&quot; } }, { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;4&quot;, &quot;_score&quot;: 1.2231436, &quot;_source&quot;: { &quot;publisher&quot;: &quot;manning&quot;, &quot;title&quot;: &quot;Solr in Action&quot;, &quot;publish_date&quot;: &quot;2014-04-05&quot; } } ] å¯ä»¥ä½¿ç”¨termså…³é”®å­—ä»£æ›¿å¹¶ä¼ é€’æœç´¢è¯æ•°ç»„æ¥æŒ‡å®šå¤šä¸ªè¯ã€‚ { &quot;query&quot;: { &quot;terms&quot; : { &quot;publisher&quot;: [&quot;oreilly&quot;, &quot;packt&quot;] } } } 13.å­—è¯æŸ¥è¯¢-æ’åº æœ¯è¯­æŸ¥è¯¢ç»“æœï¼ˆä¸ä»»ä½•å…¶ä»–æŸ¥è¯¢ç»“æœä¸€æ ·ï¼‰å¯ä»¥è½»æ¾åœ°è¿›è¡Œæ’åºã€‚ä¹Ÿå…è®¸å¤šçº§æ’åº POST /bookdb_index/book/_search { &quot;query&quot;: { &quot;term&quot; : { &quot;publisher&quot;: &quot;manning&quot; } }, &quot;_source&quot; : [&quot;title&quot;,&quot;publish_date&quot;,&quot;publisher&quot;], &quot;sort&quot;: [ { &quot;publish_date&quot;: {&quot;order&quot;:&quot;desc&quot;}}, { &quot;title&quot;: { &quot;order&quot;: &quot;desc&quot; }} ] } [Results] &quot;hits&quot;: [ { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;3&quot;, &quot;_score&quot;: null, &quot;_source&quot;: { &quot;publisher&quot;: &quot;manning&quot;, &quot;title&quot;: &quot;Elasticsearch in Action&quot;, &quot;publish_date&quot;: &quot;2015-12-03&quot; }, &quot;sort&quot;: [ 1449100800000, &quot;in&quot; ] }, { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;4&quot;, &quot;_score&quot;: null, &quot;_source&quot;: { &quot;publisher&quot;: &quot;manning&quot;, &quot;title&quot;: &quot;Solr in Action&quot;, &quot;publish_date&quot;: &quot;2014-04-05&quot; }, &quot;sort&quot;: [ 1396656000000, &quot;solr&quot; ] }, { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;2&quot;, &quot;_score&quot;: null, &quot;_source&quot;: { &quot;publisher&quot;: &quot;manning&quot;, &quot;title&quot;: &quot;Taming Text: How to Find, Organize, and Manipulate It&quot;, &quot;publish_date&quot;: &quot;2013-01-24&quot; }, &quot;sort&quot;: [ 1358985600000, &quot;to&quot; ] } ] 14.èŒƒå›´æŸ¥è¯¢ å¦ä¸€ä¸ªç»“æ„åŒ–æŸ¥è¯¢ç¤ºä¾‹æ˜¯èŒƒå›´æŸ¥è¯¢ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æœç´¢2015å¹´å‡ºç‰ˆçš„å›¾ä¹¦ã€‚ POST /bookdb_index/book/_search { &quot;query&quot;: { &quot;range&quot; : { &quot;publish_date&quot;: { &quot;gte&quot;: &quot;2015-01-01&quot;, &quot;lte&quot;: &quot;2015-12-31&quot; } } }, &quot;_source&quot; : [&quot;title&quot;,&quot;publish_date&quot;,&quot;publisher&quot;] } [Results] &quot;hits&quot;: [ { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;1&quot;, &quot;_score&quot;: 1, &quot;_source&quot;: { &quot;publisher&quot;: &quot;oreilly&quot;, &quot;title&quot;: &quot;Elasticsearch: The Definitive Guide&quot;, &quot;publish_date&quot;: &quot;2015-02-07&quot; } }, { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;3&quot;, &quot;_score&quot;: 1, &quot;_source&quot;: { &quot;publisher&quot;: &quot;manning&quot;, &quot;title&quot;: &quot;Elasticsearch in Action&quot;, &quot;publish_date&quot;: &quot;2015-12-03&quot; } } ] æ³¨æ„ï¼šèŒƒå›´æŸ¥è¯¢é€‚ç”¨äºæ—¥æœŸï¼Œæ•°å­—å’Œå­—ç¬¦ä¸²ç±»å‹å­—æ®µã€‚ 15.è¿‡æ»¤æŸ¥è¯¢ ç­›é€‰æŸ¥è¯¢å…è®¸æ‚¨ç­›é€‰æŸ¥è¯¢ç»“æœã€‚å¯¹äºæˆ‘ä»¬çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬æ­£åœ¨æŸ¥è¯¢æ ‡é¢˜æˆ–æ‘˜è¦ä¸­å¸¦æœ‰â€œ Elasticsearchâ€ä¸€è¯çš„å›¾ä¹¦ï¼Œä½†æˆ‘ä»¬å¸Œæœ›å°†æœç´¢ç»“æœè¿‡æ»¤ä¸ºä»…åŒ…å«20æ¡æˆ–æ›´å¤šè¯„è®ºçš„å›¾ä¹¦ã€‚ POST /bookdb_index/book/_search { &quot;query&quot;: { &quot;filtered&quot;: { &quot;query&quot; : { &quot;multi_match&quot;: { &quot;query&quot;: &quot;elasticsearch&quot;, &quot;fields&quot;: [&quot;title&quot;,&quot;summary&quot;] } }, &quot;filter&quot;: { &quot;range&quot; : { &quot;num_reviews&quot;: { &quot;gte&quot;: 20 } } } } }, &quot;_source&quot; : [&quot;title&quot;,&quot;summary&quot;,&quot;publisher&quot;, &quot;num_reviews&quot;] } [Results] &quot;hits&quot;: [ { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;1&quot;, &quot;_score&quot;: 0.5955761, &quot;_source&quot;: { &quot;summary&quot;: &quot;A distibuted real-time search and analytics engine&quot;, &quot;publisher&quot;: &quot;oreilly&quot;, &quot;num_reviews&quot;: 20, &quot;title&quot;: &quot;Elasticsearch: The Definitive Guide&quot; } } ] æ³¨æ„ï¼šç­›é€‰æŸ¥è¯¢å¹¶ä¸è¦æ±‚å­˜åœ¨è¦å¯¹å…¶è¿›è¡Œç­›é€‰çš„æŸ¥è¯¢ã€‚å¦‚æœæœªæŒ‡å®šmatch_allæŸ¥è¯¢ï¼Œåˆ™è¿è¡ŒæŸ¥è¯¢ï¼Œè¯¥æŸ¥è¯¢åŸºæœ¬ä¸Šè¿”å›ç´¢å¼•ä¸­çš„æ‰€æœ‰æ–‡æ¡£ï¼Œç„¶åå¯¹å…¶è¿›è¡Œè¿‡æ»¤ã€‚å®é™…ä¸Šï¼Œé¦–å…ˆè¿è¡Œè¿‡æ»¤å™¨ï¼Œä»¥å‡å°‘éœ€è¦æŸ¥è¯¢çš„è¡¨é¢ç§¯ã€‚æ­¤å¤–ï¼Œè¿‡æ»¤å™¨åœ¨é¦–æ¬¡ä½¿ç”¨åä¼šè¢«ç¼“å­˜ï¼Œè¿™ä½¿å…¶æ€§èƒ½éå¸¸å¥½ã€‚ æ›´æ–°ï¼šå·²è¿‡æ»¤çš„æŸ¥è¯¢å·²ä»å³å°†æ¨å‡ºçš„Elasticsearch 5.0ä¸­åˆ é™¤ï¼Œä»¥æ”¯æŒboolæŸ¥è¯¢ã€‚è¿™æ˜¯ä¸ä¸Šé¢ç›¸åŒçš„ç¤ºä¾‹ï¼Œæ”¹å†™ä¸ºä½¿ç”¨boolæŸ¥è¯¢ã€‚è¿”å›çš„ç»“æœå®Œå…¨ç›¸åŒã€‚ POST /bookdb_index/book/_search { &quot;query&quot;: { &quot;bool&quot;: { &quot;must&quot; : { &quot;multi_match&quot;: { &quot;query&quot;: &quot;elasticsearch&quot;, &quot;fields&quot;: [&quot;title&quot;,&quot;summary&quot;] } }, &quot;filter&quot;: { &quot;range&quot; : { &quot;num_reviews&quot;: { &quot;gte&quot;: 20 } } } } }, &quot;_source&quot; : [&quot;title&quot;,&quot;summary&quot;,&quot;publisher&quot;, &quot;num_reviews&quot;] } åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œè¿™ä¹Ÿé€‚ç”¨äºå¤šä¸ªè¿‡æ»¤å™¨ã€‚ 16.å¤šä¸ªè¿‡æ»¤å™¨ å¯ä»¥é€šè¿‡ä½¿ç”¨è¿‡æ»¤å™¨æ¥ç»„åˆå¤šä¸ªè¿‡æ»¤boolå™¨ã€‚åœ¨ä¸‹ä¸€ä¸ªç¤ºä¾‹ä¸­ï¼Œè¿‡æ»¤å™¨ç¡®å®šè¿”å›çš„ç»“æœå¿…é¡»è‡³å°‘å…·æœ‰20æ¡è¯„è®ºï¼Œä¸å¾—åœ¨2015å¹´ä¹‹å‰å‘å¸ƒï¼Œè€Œåº”ç”±oreillyå‘å¸ƒã€‚ POST /bookdb_index/book/_search { &quot;query&quot;: { &quot;filtered&quot;: { &quot;query&quot; : { &quot;multi_match&quot;: { &quot;query&quot;: &quot;elasticsearch&quot;, &quot;fields&quot;: [&quot;title&quot;,&quot;summary&quot;] } }, &quot;filter&quot;: { &quot;bool&quot;: { &quot;must&quot;: { &quot;range&quot; : { &quot;num_reviews&quot;: { &quot;gte&quot;: 20 } } }, &quot;must_not&quot;: { &quot;range&quot; : { &quot;publish_date&quot;: { &quot;lte&quot;: &quot;2014-12-31&quot; } } }, &quot;should&quot;: { &quot;term&quot;: { &quot;publisher&quot;: &quot;oreilly&quot; } } } } } }, &quot;_source&quot; : [&quot;title&quot;,&quot;summary&quot;,&quot;publisher&quot;, &quot;num_reviews&quot;, &quot;publish_date&quot;] } [Results] &quot;hits&quot;: [ { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;1&quot;, &quot;_score&quot;: 0.5955761, &quot;_source&quot;: { &quot;summary&quot;: &quot;A distibuted real-time search and analytics engine&quot;, &quot;publisher&quot;: &quot;oreilly&quot;, &quot;num_reviews&quot;: 20, &quot;title&quot;: &quot;Elasticsearch: The Definitive Guide&quot;, &quot;publish_date&quot;: &quot;2015-02-07&quot; } } ] 17.åŠŸèƒ½è¯„åˆ†ï¼šå­—æ®µå€¼å› å­ åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½å¸Œæœ›å°†æ–‡æ¡£ä¸­ç‰¹å®šå­—æ®µçš„å€¼çº³å…¥ç›¸å…³æ€§åˆ†æ•°çš„è®¡ç®—ä¸­ã€‚åœ¨æ‚¨å¸Œæœ›æ ¹æ®æ–‡æ¡£çš„å—æ¬¢è¿ç¨‹åº¦æé«˜å…¶ç›¸å…³æ€§çš„æƒ…å†µä¸‹ï¼Œè¿™æ˜¯å…¸å‹çš„æƒ…å†µã€‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›å¢åŠ å—æ¬¢è¿çš„ä¹¦ç±ï¼ˆæ ¹æ®è¯„è®ºæ•°åˆ¤æ–­ï¼‰ã€‚ä½¿ç”¨field_value_factoråŠŸèƒ½è¯„åˆ†å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚ POST /bookdb_index/book/_search { &quot;query&quot;: { &quot;function_score&quot;: { &quot;query&quot;: { &quot;multi_match&quot; : { &quot;query&quot; : &quot;search engine&quot;, &quot;fields&quot;: [&quot;title&quot;, &quot;summary&quot;] } }, &quot;field_value_factor&quot;: { &quot;field&quot; : &quot;num_reviews&quot;, &quot;modifier&quot;: &quot;log1p&quot;, &quot;factor&quot; : 2 } } }, &quot;_source&quot;: [&quot;title&quot;, &quot;summary&quot;, &quot;publish_date&quot;, &quot;num_reviews&quot;] } [Results] &quot;hits&quot;: [ { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;1&quot;, &quot;_score&quot;: 0.44831306, &quot;_source&quot;: { &quot;summary&quot;: &quot;A distibuted real-time search and analytics engine&quot;, &quot;num_reviews&quot;: 20, &quot;title&quot;: &quot;Elasticsearch: The Definitive Guide&quot;, &quot;publish_date&quot;: &quot;2015-02-07&quot; } }, { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;4&quot;, &quot;_score&quot;: 0.3718407, &quot;_source&quot;: { &quot;summary&quot;: &quot;Comprehensive guide to implementing a scalable search engine using Apache Solr&quot;, &quot;num_reviews&quot;: 23, &quot;title&quot;: &quot;Solr in Action&quot;, &quot;publish_date&quot;: &quot;2014-04-05&quot; } }, { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;3&quot;, &quot;_score&quot;: 0.046479136, &quot;_source&quot;: { &quot;summary&quot;: &quot;build scalable search applications using Elasticsearch without having to do complex low-level programming or understand advanced data science algorithms&quot;, &quot;num_reviews&quot;: 18, &quot;title&quot;: &quot;Elasticsearch in Action&quot;, &quot;publish_date&quot;: &quot;2015-12-03&quot; } }, { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;2&quot;, &quot;_score&quot;: 0.041432835, &quot;_source&quot;: { &quot;summary&quot;: &quot;organize text using approaches such as full-text search, proper name recognition, clustering, tagging, information extraction, and summarization&quot;, &quot;num_reviews&quot;: 12, &quot;title&quot;: &quot;Taming Text: How to Find, Organize, and Manipulate It&quot;, &quot;publish_date&quot;: &quot;2013-01-24&quot; } } ] æ³¨æ„1ï¼šæˆ‘ä»¬æœ¬æ¥å¯ä»¥è¿è¡Œå¸¸è§„multi_matchæŸ¥è¯¢å¹¶æŒ‰num_reviewså­—æ®µè¿›è¡Œæ’åºï¼Œä½†æ˜¯è¿™æ ·å°±å¤±å»äº†è¿›è¡Œç›¸å…³æ€§è¯„åˆ†çš„å¥½å¤„ã€‚ æ³¨æ„2ï¼šè¿˜æœ‰è®¸å¤šå…¶ä»–å‚æ•°å¯ä»¥è°ƒæ•´å¯¹åŸå§‹ç›¸å…³æ€§å¾—åˆ†çš„å¢å¼ºæ•ˆæœï¼Œä¾‹å¦‚â€œä¿®é¥°ç¬¦â€ï¼Œâ€œå› å­â€ï¼Œâ€œ boost_modeâ€ç­‰ã€‚è¿™äº›å‚æ•°åœ¨ElasticsearchæŒ‡å—ä¸­è¿›è¡Œäº†è¯¦ç»†æ¢è®¨ã€‚ 18.ä½œç”¨åˆ†å€¼ï¼šè¡°å‡åŠŸèƒ½ å‡è®¾æ‚¨ä¸æƒ³ä»¥æŸä¸ªå­—æ®µçš„å€¼é€’å¢ï¼Œè€Œå¸Œæœ›æ‹¥æœ‰ç†æƒ³çš„ç›®æ ‡å€¼ï¼Œå¹¶ä¸”å¸Œæœ›è¯¥å¢ç›Šå› å­éšç€è·ç¦»è¯¥å€¼çš„å¢åŠ è€Œè¡°å‡ã€‚è¿™é€šå¸¸åœ¨åŸºäºçº¬åº¦/ç»åº¦ï¼Œä»·æ ¼æˆ–æ—¥æœŸç­‰æ•°å­—å­—æ®µçš„æå‡ä¸­å¾ˆæœ‰ç”¨ã€‚åœ¨æˆ‘ä»¬ç²¾å¿ƒè®¾è®¡çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æ­£åœ¨æœç´¢ç†æƒ³æƒ…å†µä¸‹äº2014å¹´6æœˆå·¦å³å‡ºç‰ˆçš„â€œæœç´¢å¼•æ“â€ä¹¦ç±ã€‚ POST /bookdb_index/book/_search { &quot;query&quot;: { &quot;function_score&quot;: { &quot;query&quot;: { &quot;multi_match&quot; : { &quot;query&quot; : &quot;search engine&quot;, &quot;fields&quot;: [&quot;title&quot;, &quot;summary&quot;] } }, &quot;functions&quot;: [ { &quot;exp&quot;: { &quot;publish_date&quot; : { &quot;origin&quot;: &quot;2014-06-15&quot;, &quot;offset&quot;: &quot;7d&quot;, &quot;scale&quot; : &quot;30d&quot; } } } ], &quot;boost_mode&quot; : &quot;replace&quot; } }, &quot;_source&quot;: [&quot;title&quot;, &quot;summary&quot;, &quot;publish_date&quot;, &quot;num_reviews&quot;] } [Results] &quot;hits&quot;: [ { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;4&quot;, &quot;_score&quot;: 0.27420625, &quot;_source&quot;: { &quot;summary&quot;: &quot;Comprehensive guide to implementing a scalable search engine using Apache Solr&quot;, &quot;num_reviews&quot;: 23, &quot;title&quot;: &quot;Solr in Action&quot;, &quot;publish_date&quot;: &quot;2014-04-05&quot; } }, { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;1&quot;, &quot;_score&quot;: 0.005920768, &quot;_source&quot;: { &quot;summary&quot;: &quot;A distibuted real-time search and analytics engine&quot;, &quot;num_reviews&quot;: 20, &quot;title&quot;: &quot;Elasticsearch: The Definitive Guide&quot;, &quot;publish_date&quot;: &quot;2015-02-07&quot; } }, { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;2&quot;, &quot;_score&quot;: 0.000011564, &quot;_source&quot;: { &quot;summary&quot;: &quot;organize text using approaches such as full-text search, proper name recognition, clustering, tagging, information extraction, and summarization&quot;, &quot;num_reviews&quot;: 12, &quot;title&quot;: &quot;Taming Text: How to Find, Organize, and Manipulate It&quot;, &quot;publish_date&quot;: &quot;2013-01-24&quot; } }, { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;3&quot;, &quot;_score&quot;: 0.0000059171475, &quot;_source&quot;: { &quot;summary&quot;: &quot;build scalable search applications using Elasticsearch without having to do complex low-level programming or understand advanced data science algorithms&quot;, &quot;num_reviews&quot;: 18, &quot;title&quot;: &quot;Elasticsearch in Action&quot;, &quot;publish_date&quot;: &quot;2015-12-03&quot; } } ] 19.åŠŸèƒ½è¯„åˆ†ï¼šè„šæœ¬è¯„åˆ† å¦‚æœå†…ç½®çš„è¯„åˆ†åŠŸèƒ½æ— æ³•æ»¡è¶³æ‚¨çš„éœ€æ±‚ï¼Œåˆ™å¯ä»¥é€‰æ‹©æŒ‡å®šGroovyè„šæœ¬è¿›è¡Œè¯„åˆ†ã€‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›æŒ‡å®šä¸€ä¸ªè„šæœ¬ï¼Œè¯¥è„šæœ¬åœ¨å†³å®šè¦è€ƒè™‘è¯„è®ºæ•°é‡çš„å› ç´ ä¹‹å‰ï¼Œå…ˆè€ƒè™‘publish_dateã€‚è¾ƒæ–°çš„ä¹¦å¯èƒ½æ²¡æœ‰é‚£ä¹ˆå¤šçš„è¯„è®ºï¼Œå› æ­¤ä¸åº”å› æ­¤å—åˆ°æƒ©ç½šã€‚ è¯„åˆ†è„šæœ¬å¦‚ä¸‹æ‰€ç¤ºï¼š publish_date = doc['publish_date'].value num_reviews = doc['num_reviews'].value if (publish_date &gt; Date.parse('yyyy-MM-dd', threshold).getTime()) { my_score = Math.log(2.5 + num_reviews) } else { my_score = Math.log(1 + num_reviews) } return my_score è¦åŠ¨æ€ä½¿ç”¨è¯„åˆ†è„šæœ¬ï¼Œæˆ‘ä»¬ä½¿ç”¨script_scoreå‚æ•° POST /bookdb_index/book/_search { &quot;query&quot;: { &quot;function_score&quot;: { &quot;query&quot;: { &quot;multi_match&quot; : { &quot;query&quot; : &quot;search engine&quot;, &quot;fields&quot;: [&quot;title&quot;, &quot;summary&quot;] } }, &quot;functions&quot;: [ { &quot;script_score&quot;: { &quot;params&quot; : { &quot;threshold&quot;: &quot;2015-07-30&quot; }, &quot;script&quot;: &quot;publish_date = doc['publish_date'].value; num_reviews = doc['num_reviews'].value; if (publish_date &gt; Date.parse('yyyy-MM-dd', threshold).getTime()) { return log(2.5 + num_reviews) }; return log(1 + num_reviews);&quot; } } ] } }, &quot;_source&quot;: [&quot;title&quot;, &quot;summary&quot;, &quot;publish_date&quot;, &quot;num_reviews&quot;] } [Results] &quot;hits&quot;: { &quot;total&quot;: 4, &quot;max_score&quot;: 0.8463001, &quot;hits&quot;: [ { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;1&quot;, &quot;_score&quot;: 0.8463001, &quot;_source&quot;: { &quot;summary&quot;: &quot;A distibuted real-time search and analytics engine&quot;, &quot;num_reviews&quot;: 20, &quot;title&quot;: &quot;Elasticsearch: The Definitive Guide&quot;, &quot;publish_date&quot;: &quot;2015-02-07&quot; } }, { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;4&quot;, &quot;_score&quot;: 0.7067348, &quot;_source&quot;: { &quot;summary&quot;: &quot;Comprehensive guide to implementing a scalable search engine using Apache Solr&quot;, &quot;num_reviews&quot;: 23, &quot;title&quot;: &quot;Solr in Action&quot;, &quot;publish_date&quot;: &quot;2014-04-05&quot; } }, { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;3&quot;, &quot;_score&quot;: 0.08952084, &quot;_source&quot;: { &quot;summary&quot;: &quot;build scalable search applications using Elasticsearch without having to do complex low-level programming or understand advanced data science algorithms&quot;, &quot;num_reviews&quot;: 18, &quot;title&quot;: &quot;Elasticsearch in Action&quot;, &quot;publish_date&quot;: &quot;2015-12-03&quot; } }, { &quot;_index&quot;: &quot;bookdb_index&quot;, &quot;_type&quot;: &quot;book&quot;, &quot;_id&quot;: &quot;2&quot;, &quot;_score&quot;: 0.07602123, &quot;_source&quot;: { &quot;summary&quot;: &quot;organize text using approaches such as full-text search, proper name recognition, clustering, tagging, information extraction, and summarization&quot;, &quot;num_reviews&quot;: 12, &quot;title&quot;: &quot;Taming Text: How to Find, Organize, and Manipulate It&quot;, &quot;publish_date&quot;: &quot;2013-01-24&quot; } } ] } æ³¨æ„1ï¼šè¦ä½¿ç”¨åŠ¨æ€è„šæœ¬ï¼Œå¿…é¡»ä¸ºconfig/elasticsearch.yamlæ–‡ä»¶ä¸­çš„Elasticsearchå®ä¾‹å¯ç”¨åŠ¨æ€è„šæœ¬ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨å­˜å‚¨åœ¨ElasticsearchæœåŠ¡å™¨ä¸Šçš„è„šæœ¬ã€‚æŸ¥é˜…Elasticsearchå‚è€ƒæ–‡æ¡£äº†è§£æ›´å¤šä¿¡æ¯ã€‚ æ³¨æ„2 ï¼šJSONæ— æ³•åŒ…å«åµŒå…¥çš„æ¢è¡Œç¬¦ï¼Œå› æ­¤åˆ†å·ç”¨äºåˆ†éš”è¯­å¥ã€‚ ","link":"https://tianxiawuhao.github.io/AdeCmc8BU/"},{"title":"dockerå®‰è£…ELK","content":"Dockeréƒ¨ç½²ElasticSearch æœç´¢ElasticSearché•œåƒ docker search elasticsearch æ‹‰å–é•œåƒ æ‹‰å–é•œåƒçš„æ—¶å€™ï¼Œå¯ä»¥æŒ‡å®šç‰ˆæœ¬ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œé»˜è®¤ä½¿ç”¨latestã€‚ docker pull elasticsearch:7.12.0 æŸ¥çœ‹é•œåƒ docker images docker å¯åŠ¨ elasticsearch # --name : ä¸º elasticsearch å®¹å™¨èµ·ä¸ªåˆ«å # -e : æŒ‡å®šä¸ºå•èŠ‚ç‚¹é›†ç¾¤æ¨¡å¼ # -iï¼šè¡¨ç¤ºè¿è¡Œå®¹å™¨ # -tï¼šè¡¨ç¤ºå®¹å™¨å¯åŠ¨åä¼šè¿›å…¥å…¶å‘½ä»¤è¡Œã€‚åŠ å…¥è¿™ä¸¤ä¸ªå‚æ•°åï¼Œå®¹å™¨åˆ›å»ºå°±èƒ½ç™»å½•è¿›å»ã€‚å³åˆ†é…ä¸€ä¸ªä¼ªç»ˆç«¯ã€‚ # -vï¼šè¡¨ç¤ºç›®å½•æ˜ å°„å…³ç³»ï¼ˆå‰è€…æ˜¯å®¿ä¸»æœºç›®å½•ï¼Œåè€…æ˜¯æ˜ å°„åˆ°å®¿ä¸»æœºä¸Šçš„ç›®å½•ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨å¤šä¸ªï¼våšå¤šä¸ªç›®å½•æˆ–æ–‡ä»¶æ˜ å°„ã€‚æ³¨æ„ï¼šæœ€å¥½åšç›®å½•æ˜ å°„ï¼Œåœ¨å®¿ä¸»æœºä¸Šåšä¿®æ”¹ï¼Œç„¶åå…±äº«åˆ°å®¹å™¨ä¸Šã€‚ # -dï¼šåœ¨runåé¢åŠ ä¸Š-då‚æ•°,åˆ™ä¼šåˆ›å»ºä¸€ä¸ªå®ˆæŠ¤å¼å®¹å™¨åœ¨åå°è¿è¡Œï¼ˆè¿™æ ·åˆ›å»ºå®¹å™¨åä¸ä¼šè‡ªåŠ¨ç™»å½•å®¹å™¨ï¼Œå¦‚æœåªåŠ -i -tä¸¤ä¸ªå‚æ•°ï¼Œåˆ›å»ºåå°±ä¼šè‡ªåŠ¨è¿›å»å®¹å™¨ï¼‰ã€‚ # -pï¼šè¡¨ç¤ºç«¯å£æ˜ å°„ï¼Œå‰è€…æ˜¯å®¿ä¸»æœºç«¯å£ï¼Œåè€…æ˜¯å®¹å™¨å†…çš„æ˜ å°„ç«¯å£ã€‚å¯ä»¥ä½¿ç”¨å¤šä¸ª-påšå¤šä¸ªç«¯å£æ˜ å°„ docker run -di --name elasticsearch -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; elasticsearch:7.12.0 elasticsearché…ç½® åˆ›å»ºelasticsearchæ»šåŠ¨ç­–ç•¥ # å®šä¹‰å®¡è®¡æ—¥å¿—ç®¡ç†ç­–ç•¥ curl -X PUT &quot;${host}/_ilm/policy/audit_policy&quot; -H 'Content-Type: application/json' -d' { &quot;policy&quot;: { &quot;phases&quot;: { &quot;hot&quot;: { &quot;actions&quot;: { &quot;rollover&quot;: { &quot;max_size&quot;: &quot;30GB&quot;, &quot;max_age&quot;: &quot;180d&quot; } } }, &quot;delete&quot;: { &quot;min_age&quot;: &quot;180d&quot;, &quot;actions&quot;: { &quot;delete&quot;: {} } } } } } çƒ­æ•°æ®æœ€å¤§30G,æœ€å¤š180å¤©ï¼Œæ•°æ®æœ€å°‘ä¿æŒ180å¤©ååˆ é™¤ åˆ›å»ºç´¢å¼•æ¨¡æ¿ # å¯¼å‡ºæ—¥å¿—ç´¢å¼•æ¨¡æ¿ curl -X PUT &quot;${host}/_template/export_log_index_template&quot; -H 'Content-Type: application/json' -d' { &quot;index_patterns&quot;: [ &quot;export_log_index*&quot; ], &quot;settings&quot;: { &quot;number_of_shards&quot;: 1, &quot;number_of_replicas&quot;: 1, &quot;index.lifecycle.name&quot;: &quot;audit_policy&quot;, &quot;index.lifecycle.rollover_alias&quot;: &quot;export_log_index&quot;, &quot;index.max_result_window&quot;: &quot;100000&quot; }, &quot;mappings&quot;: { &quot;properties&quot;: { &quot;applicationSide&quot;: { &quot;type&quot;: &quot;integer&quot; }, &quot;exportComment&quot;: { &quot;type&quot;: &quot;keyword&quot; }, &quot;exportFileSize&quot;: { &quot;type&quot;: &quot;integer&quot; }, &quot;exportType&quot;: { &quot;type&quot;: &quot;integer&quot; }, &quot;id&quot;: { &quot;type&quot;: &quot;keyword&quot; }, &quot;operationTime&quot;: { &quot;type&quot;: &quot;date&quot;, &quot;store&quot;: true, &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot; }, &quot;operationUser&quot;: { &quot;type&quot;: &quot;keyword&quot; }, &quot;operationUserName&quot;: { &quot;type&quot;: &quot;text&quot;, &quot;analyzer&quot;: &quot;ik_max_word&quot;, &quot;fields&quot;: { &quot;keyword&quot;: { &quot;type&quot;: &quot;keyword&quot; } } }, &quot;remarks&quot;: { &quot;type&quot;: &quot;keyword&quot; }, &quot;successful&quot;: { &quot;type&quot;: &quot;boolean&quot; } } } } åˆ›å»ºç´¢å¼• # åˆ›å»ºå¯¼å‡ºæ—¥å¿—ç´¢å¼•ï¼ŒæŒ‰æ—¥æœŸå‘½å curl -X PUT &quot;${host}/%3Cexport_log_index-%7Bnow%2Fd%7D-1%3E&quot; -H 'Content-Type: application/json' -d' { &quot;aliases&quot;: { &quot;export_log_index&quot;: { &quot;is_write_index&quot;: true } } } docker å®‰è£… kibana æ‹‰å–é•œåƒ æ‹‰å–é•œåƒçš„æ—¶å€™ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯, kibana çš„ç‰ˆæœ¬æœ€å¥½ä¸ elasticsearch ä¿æŒä¸€è‡´, é¿å…å‘ç”Ÿä¸å¿…è¦çš„é”™è¯¯ docker pull kibana:7.12.0 æŸ¥çœ‹é•œåƒ docker images docker å¯åŠ¨ kibana # -e : æŒ‡å®šç¯å¢ƒå˜é‡é…ç½®, æä¾›æ±‰åŒ– # --like : å»ºç«‹ä¸¤ä¸ªå®¹å™¨ä¹‹é—´çš„å…³è”, kibana å…³è”åˆ° es docker run -di --name kibana --link elasticsearch:elasticsearch -e &quot;I18N_LOCALE=zh-CN&quot; -p 5601:5601 kibana:7.12.0 # kibana çš„æ±‰åŒ–æˆ‘æ„Ÿè§‰åšçš„å¹¶ä¸å¥½ # å¦‚æœä¸ä¹ æƒ¯æ±‰åŒ–, å¯ä»¥æŠŠæ¡ä»¶å»é™¤ docker run -di --name kibana --link elasticsearch:elasticsearch -p 5601:5601 kibana:7.12.0 Docker å®‰è£… Logstash æ‹‰å–é•œåƒ æ‹‰å–é•œåƒçš„æ—¶å€™ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯, Logstash çš„ç‰ˆæœ¬æœ€å¥½ä¸ elasticsearch ä¿æŒä¸€è‡´, é¿å…å‘ç”Ÿä¸å¿…è¦çš„é”™è¯¯ docker pull logstash:7.12.0 æŸ¥çœ‹é•œåƒ docker images æ–‡ä»¶æ˜ å°„ åœ¨æœ¬æœºå»ºç«‹é…ç½®æ–‡ä»¶å’Œç›®å½•,ç”¨æ¥å­˜æ”¾æ‰€æœ‰é…ç½®çš„æ˜ å°„ /usr/local/logstash/config/logstash.yml /usr/local/logstash/conf.d/ logstash.yml (æ–‡ä»¶å†…å®¹) path.config: /usr/share/logstash/conf.d/*.conf path.logs: /var/log/logstash conf.d/configuration.conf (æ–‡ä»¶å†…å®¹) Filebeatå’Œelasticsearchçš„äº¤äº’ input { beats { port =&gt; 5044 codec =&gt; &quot;json&quot; } } output { elasticsearch { hosts =&gt; [&quot;elasticsearch:9200&quot;]ï¼Œ index =&gt; &quot;export_log_index&quot; } stdout { codec =&gt; rubydebug } } mysqlå’Œelasticsearchçš„äº¤äº’ input { jdbc { jdbc_driver_class =&gt; &quot;com.mysql.jdbc.Driver&quot; jdbc_connection_string =&gt; &quot;jdbc:mysql://localhost:3306/db_example&quot; jdbc_user =&gt; root jdbc_password =&gt; ymruan123 #å¯ç”¨è¿½è¸ªï¼Œå¦‚æœä¸ºtrueï¼Œåˆ™éœ€è¦æŒ‡å®štracking_column use_column_value =&gt; true #æŒ‡å®šè¿½è¸ªçš„å­—æ®µï¼Œ tracking_column =&gt; &quot;last_updated&quot; #è¿½è¸ªå­—æ®µçš„ç±»å‹ï¼Œç›®å‰åªæœ‰æ•°å­—(numeric)å’Œæ—¶é—´ç±»å‹(timestamp)ï¼Œé»˜è®¤æ˜¯æ•°å­—ç±»å‹ tracking_column_type =&gt; &quot;numeric&quot; #è®°å½•æœ€åä¸€æ¬¡è¿è¡Œçš„ç»“æœ record_last_run =&gt; true #ä¸Šé¢è¿è¡Œç»“æœçš„ä¿å­˜ä½ç½® last_run_metadata_path =&gt; &quot;jdbc-position.txt&quot; statement =&gt; &quot;SELECT * FROM user where last_updated &gt;:sql_last_value;&quot; schedule =&gt; &quot; * * * * * *&quot; } } output { elasticsearch { document_id =&gt; &quot;%{id}&quot; document_type =&gt; &quot;_doc&quot; index =&gt; &quot;export_log_index&quot; hosts =&gt; [&quot;http://localhost:9200&quot;] } stdout{ codec =&gt; rubydebug } } kafkaå’Œelasticsearchçš„äº¤äº’ input { kafka{ topics =&gt; &quot;topic_export&quot; #kafkaä¸­topicåç§°ï¼Œè®°å¾—åˆ›å»ºè¯¥topic group_id =&gt; &quot;group_export&quot; #é»˜è®¤ä¸ºâ€œlogstashâ€ codec =&gt; &quot;json&quot; #ä¸Shipperç«¯outputé…ç½®é¡¹ä¸€è‡´ consumer_threads =&gt; 1 #æ¶ˆè´¹çº¿ç¨‹æ•°ï¼Œé›†ç¾¤ä¸­æ‰€æœ‰logstashç›¸åŠ æœ€å¥½ç­‰äº topic åˆ†åŒºæ•° bootstrap_servers =&gt; &quot;kafka:9092&quot; decorate_events =&gt; true #åœ¨è¾“å‡ºæ¶ˆæ¯çš„æ—¶å€™å›è¾“å‡ºè‡ªèº«çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼šæ¶ˆè´¹æ¶ˆæ¯çš„å¤§å°ã€topicæ¥æºä»¥åŠconsumerçš„groupä¿¡æ¯ã€‚ type =&gt; &quot;topic_export&quot; tags =&gt; [&quot;canal&quot;] # æ ‡ç­¾ï¼Œé¢å¤–ä½¿ç”¨è¯¥å‚æ•°å¯ä»¥åœ¨elastciä¸­åˆ›å»ºä¸åŒç´¢å¼• } } filter { # æŠŠé»˜è®¤çš„dataå­—æ®µé‡å‘½åä¸ºmessageå­—æ®µï¼Œæ–¹ä¾¿åœ¨elasticä¸­æ˜¾ç¤º mutate { rename =&gt; [&quot;data&quot;, &quot;message&quot;] } # è¿˜å¯ä»¥ä½¿ç”¨å…¶ä»–çš„å¤„ç†æ–¹å¼ï¼Œåœ¨æ­¤å°±ä¸å†åˆ—å‡ºæ¥äº† } output { elasticsearch { hosts =&gt; [&quot;http://172.17.107.187:9203&quot;, &quot;http://172.17.107.187:9201&quot;,&quot;http://172.17.107.187:9202&quot;] index =&gt; &quot;export_log_index&quot; # decorate_events=trueçš„ä½œç”¨ï¼Œå¯ä»¥ä½¿ç”¨metadataä¸­çš„æ•°æ® #user =&gt; &quot;elastic&quot; #password =&gt; &quot;escluter123456&quot; } } logbackå’Œå’Œelasticsearchçš„äº¤äº’ å¼•å…¥ä¾èµ– &lt;dependency&gt; &lt;groupId&gt;net.logstash.logback&lt;/groupId&gt; &lt;artifactId&gt;logstash-logback-encoder&lt;/artifactId&gt; &lt;version&gt;4.10&lt;/version&gt; &lt;/dependency&gt; å‚æ•°é…ç½® input { # åº”ç”¨æ—¥å¿— tcp{ type =&gt; &quot;app&quot; mode =&gt; &quot;server&quot; host =&gt; &quot;0.0.0.0&quot; port =&gt; 4560 codec =&gt; json } } output { elasticsearch { hosts =&gt; &quot;http://127.0.0.1:9200&quot; index =&gt; &quot;export_log_index&quot; } } åº”ç”¨æ—¥å¿—å…¥å£ç«¯å£ä¸º4560ï¼Œéœ€è¦é…ç½®javaå®¢æˆ·ç«¯logstashå…¥å£ &lt;!-- è¿™ä¸ªæ˜¯æ§åˆ¶å°æ—¥å¿—è¾“å‡ºæ ¼å¼ æ–¹ä¾¿è°ƒè¯•å¯¹æ¯”--&gt; &lt;appender name=&quot;console&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt; &lt;encoder&gt; &lt;pattern&gt;%d{yyyy-MM-dd HH:mm:ss} %contextName %-5level %logger{50} -%msg%n&lt;/pattern&gt; &lt;/encoder&gt; &lt;/appender&gt; &lt;!--å¼€å¯tcpæ ¼å¼çš„logstashä¼ è¾“ï¼Œé€šè¿‡TCPåè®®è¿æ¥Logstash--&gt; &lt;appender name=&quot;STASH&quot; class=&quot;net.logstash.logback.appender.LogstashTcpSocketAppender&quot;&gt; &lt;destination&gt;127.0.0.1:9600&lt;/destination&gt; &lt;encoder class=&quot;net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder&quot;&gt; &lt;!--ä¸­æ–‡åºåˆ—åŒ–--&gt; &lt;jsonFactoryDecorator class=&quot;net.logstash.logback.decorate.CharacterEscapesJsonFactoryDecorator&quot;&gt; &lt;escape&gt; &lt;targetCharacterCode&gt;10&lt;/targetCharacterCode&gt; &lt;escapeSequence&gt;\\u2028&lt;/escapeSequence&gt; &lt;/escape&gt; &lt;/jsonFactoryDecorator&gt; &lt;providers&gt; &lt;pattern&gt; &lt;pattern&gt; &lt;!--{ &quot;timestamp&quot;:&quot;%date{ISO8601}&quot;, &quot;user&quot;:&quot;test&quot;, &quot;message&quot;:&quot;[%d{yyyy-MM-dd HH:mm:ss.SSS}][%p][%t][%l{80}|%L]%m&quot;}%n }--&gt; { &quot;timestamp&quot;: &quot;%date{\\&quot;yyyy-MM-dd' 'HH:mm:ss,SSSZ\\&quot;}&quot;, &quot;level&quot;: &quot;%level&quot;, &quot;thread&quot;: &quot;%thread&quot;, &quot;class_name&quot;: &quot;%class&quot;, &quot;line_number&quot;: &quot;%line&quot;, &quot;message&quot;: &quot;%message&quot;, &quot;stack_trace&quot;: &quot;%exception{5}&quot;, &quot;req_id&quot;: &quot;%X{reqId}&quot;, &quot;elapsed_time&quot;: &quot;#asLong{%X{elapsedTime}}&quot; } &lt;/pattern&gt; &lt;/pattern&gt; &lt;/providers&gt; &lt;!--æ ¼å¼åŒ–è¾“å‡ºï¼š%dè¡¨ç¤ºæ—¥æœŸï¼Œ%threadè¡¨ç¤ºçº¿ç¨‹åï¼Œ%-5levelï¼šçº§åˆ«ä»å·¦æ˜¾ç¤º5ä¸ªå­—ç¬¦å®½åº¦%msgï¼šæ—¥å¿—æ¶ˆæ¯ï¼Œ%næ˜¯æ¢è¡Œç¬¦--&gt; &lt;/encoder&gt; &lt;keepAliveDuration&gt;5 minutes&lt;/keepAliveDuration&gt; &lt;/appender&gt; &lt;root level=&quot;INFO&quot;&gt; &lt;appender-ref ref=&quot;STASH&quot;/&gt; &lt;appender-ref ref=&quot;console&quot;/&gt; &lt;/root&gt; docker å¯åŠ¨ Logstash #dockerå®¹å™¨äº’è®¿ è¿è¡Œå®¹å™¨çš„æ—¶å€™åŠ ä¸Šå‚æ•°link docker run -id -p 5044:5044 --name logstash --link elasticsearch --link beats -v /usr/local/logstash/config/logstash.yml:/usr/share/logstash/config/logstash.yml -v /usr/local/logstash/conf.d/:/usr/share/logstash/conf.d/ logstash:7.4.1 Docker å®‰è£… Filebeat æ‹‰å–é•œåƒ æ‹‰å–é•œåƒçš„æ—¶å€™ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯, Filebeat çš„ç‰ˆæœ¬æœ€å¥½ä¸ elasticsearch ä¿æŒä¸€è‡´, é¿å…å‘ç”Ÿä¸å¿…è¦çš„é”™è¯¯ docker pull store/elastic/filebeat:7.12.0 æŸ¥çœ‹é•œåƒ docker images æ–‡ä»¶æ˜ å°„ ä¸‹è½½é»˜è®¤å®˜æ–¹é…ç½®æ–‡ä»¶ wget https://raw.githubusercontent.com/elastic/beats/7.12/deploy/docker/filebeat.docker.yml æ³¨æ„ï¼šæ–‡ä»¶æ”¾åœ¨å®¿ä¸»æœº/data/elk/filebeatç›®å½•ä¸‹ æ‰“å¼€é…ç½®æ–‡ä»¶ vim filebeat.docker.ymlï¼Œå†…å®¹å¦‚ä¸‹ï¼š # æ—¥å¿—è¾“å…¥é…ç½® filebeat.inputs: - type: log enabled: true paths: # éœ€è¦æ”¶é›†çš„æ—¥å¿—æ‰€åœ¨çš„ä½ç½®ï¼Œå¯ä½¿ç”¨é€šé…ç¬¦è¿›è¡Œé…ç½® #- /data/elk/*.log - /logs/*/*.log #æ—¥å¿—è¾“å‡ºé…ç½®(é‡‡ç”¨ logstash æ”¶é›†æ—¥å¿—ï¼Œ5044ä¸ºlogstashç«¯å£) output.logstash: hosts: ['192.168.12.183:5044'] dockerè¿è¡ŒFilebeat docker run --name filebeat --user=root -d --net somenetwork --volume=&quot;/usr/local/filebeat/log/nginx/:/var/log/nginx/&quot; --volume=&quot;/data/elk/filebeat/filebeat.docker.yml:/usr/share/filebeat/filebeat.yml&quot; --volume=&quot;/var/lib/docker/containers:/var/lib/docker/containers:ro&quot; --volume=&quot;/var/run/docker.sock:/var/run/docker.sock:ro&quot; store/elastic/filebeat:7.12.0 ","link":"https://tianxiawuhao.github.io/3D5Sr6L0c/"},{"title":"springBoot,mybatis,druidæ•´åˆ","content":"springBoot,mybatis,druidå•æ•°æ®æºæ•´åˆ é¡¹ç›®æ¡†æ¶ pom.xml &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;parent&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt; &lt;version&gt;2.4.5&lt;/version&gt; &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt; &lt;/parent&gt; &lt;groupId&gt;com.example&lt;/groupId&gt; &lt;artifactId&gt;datasources&lt;/artifactId&gt; &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt; &lt;name&gt;datasources&lt;/name&gt; &lt;description&gt;Demo project for Spring Boot&lt;/description&gt; &lt;properties&gt; &lt;java.version&gt;1.8&lt;/java.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;optional&gt;true&lt;/optional&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;mysql&lt;/groupId&gt; &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt; &lt;version&gt;5.1.45&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.alibaba&lt;/groupId&gt; &lt;artifactId&gt;druid&lt;/artifactId&gt; &lt;version&gt;1.1.10&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.baomidou&lt;/groupId&gt; &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt; &lt;version&gt;3.2.0&lt;/version&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt; &lt;configuration&gt; &lt;excludes&gt; &lt;exclude&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;/exclude&gt; &lt;/excludes&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt; &lt;/project&gt; application.yml spring: datasource: username: root password: 123456 url: jdbc:mysql://localhost:3306/datatest?characterEncoding=utf-8&amp;useSSl=false driver-class-name: com.mysql.jdbc.Driver type: com.alibaba.druid.pool.DruidDataSource druid: initialSize: 10 # åˆå§‹åŒ–æ—¶å»ºç«‹ç‰©ç†è¿æ¥çš„ä¸ªæ•°ã€‚åˆå§‹åŒ–å‘ç”Ÿåœ¨æ˜¾ç¤ºè°ƒç”¨initæ–¹æ³•ï¼Œæˆ–è€…ç¬¬ä¸€æ¬¡getConnectionæ—¶ minIdle: 10 # æœ€å°è¿æ¥æ± æ•°é‡ maxActive: 200 # æœ€å¤§è¿æ¥æ± æ•°é‡ maxWait: 60000 # è·å–è¿æ¥æ—¶æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œå•ä½æ¯«ç§’ã€‚é…ç½®äº†maxWaitä¹‹åï¼Œç¼ºçœå¯ç”¨å…¬å¹³é”ï¼Œå¹¶å‘æ•ˆç‡ä¼šæœ‰æ‰€ä¸‹é™ï¼Œå¦‚æœéœ€è¦å¯ä»¥é€šè¿‡é…ç½® timeBetweenEvictionRunsMillis: 60000 # å…³é—­ç©ºé—²è¿æ¥çš„æ£€æµ‹æ—¶é—´é—´éš”.Destroyçº¿ç¨‹ä¼šæ£€æµ‹è¿æ¥çš„é—´éš”æ—¶é—´ï¼Œå¦‚æœè¿æ¥ç©ºé—²æ—¶é—´å¤§äºç­‰äºminEvictableIdleTimeMillisåˆ™å…³é—­ç‰©ç†è¿æ¥ã€‚ minEvictableIdleTimeMillis: 300000 # è¿æ¥çš„æœ€å°ç”Ÿå­˜æ—¶é—´.è¿æ¥ä¿æŒç©ºé—²è€Œä¸è¢«é©±é€çš„æœ€å°æ—¶é—´ validationQuery: SELECT 1 FROM DUAL # éªŒè¯æ•°æ®åº“æœåŠ¡å¯ç”¨æ€§çš„sql.ç”¨æ¥æ£€æµ‹è¿æ¥æ˜¯å¦æœ‰æ•ˆçš„sql å› æ•°æ®åº“æ–¹è¨€è€Œå·®, ä¾‹å¦‚ oracle åº”è¯¥å†™æˆ SELECT 1 FROM DUAL testWhileIdle: true # ç”³è¯·è¿æ¥æ—¶æ£€æµ‹ç©ºé—²æ—¶é—´ï¼Œæ ¹æ®ç©ºé—²æ—¶é—´å†æ£€æµ‹è¿æ¥æ˜¯å¦æœ‰æ•ˆ.å»ºè®®é…ç½®ä¸ºtrueï¼Œä¸å½±å“æ€§èƒ½ï¼Œå¹¶ä¸”ä¿è¯å®‰å…¨æ€§ã€‚ç”³è¯·è¿æ¥çš„æ—¶å€™æ£€æµ‹ï¼Œå¦‚æœç©ºé—²æ—¶é—´å¤§äºtimeBetweenEvictionRun testOnBorrow: false # ç”³è¯·è¿æ¥æ—¶ç›´æ¥æ£€æµ‹è¿æ¥æ˜¯å¦æœ‰æ•ˆ.ç”³è¯·è¿æ¥æ—¶æ‰§è¡ŒvalidationQueryæ£€æµ‹è¿æ¥æ˜¯å¦æœ‰æ•ˆï¼Œåšäº†è¿™ä¸ªé…ç½®ä¼šé™ä½æ€§èƒ½ã€‚ testOnReturn: false # å½’è¿˜è¿æ¥æ—¶æ£€æµ‹è¿æ¥æ˜¯å¦æœ‰æ•ˆ.å½’è¿˜è¿æ¥æ—¶æ‰§è¡ŒvalidationQueryæ£€æµ‹è¿æ¥æ˜¯å¦æœ‰æ•ˆï¼Œåšäº†è¿™ä¸ªé…ç½®ä¼šé™ä½æ€§èƒ½ã€‚ poolPreparedStatements: true # å¼€å¯PSCache maxPoolPreparedStatementPerConnectionSize: 20 #è®¾ç½®PSCacheå€¼ connectionErrorRetryAttempts: 3 # è¿æ¥å‡ºé”™åå†å°è¯•è¿æ¥ä¸‰æ¬¡ breakAfterAcquireFailure: true # æ•°æ®åº“æœåŠ¡å®•æœºè‡ªåŠ¨é‡è¿æœºåˆ¶ timeBetweenConnectErrorMillis: 300000 # è¿æ¥å‡ºé”™åé‡è¯•æ—¶é—´é—´éš” asyncInit: true # å¼‚æ­¥åˆå§‹åŒ–ç­–ç•¥ remove-abandoned: true # æ˜¯å¦è‡ªåŠ¨å›æ”¶è¶…æ—¶è¿æ¥ remove-abandoned-timeout: 1800 # è¶…æ—¶æ—¶é—´(ä»¥ç§’æ•°ä¸ºå•ä½) transaction-query-timeout: 6000 # äº‹åŠ¡è¶…æ—¶æ—¶é—´ filters: stat,wall,log4j2 connectionProperties: druid.stat.mergeSql=true;druid.stat.slowSqlMillis=500 #mybatisæ˜¯ç‹¬ç«‹èŠ‚ç‚¹ï¼Œéœ€è¦å•ç‹¬é…ç½® mybatis-plus: mapper-locations: classpath*:mapper/*.xml type-aliases-package: com.example.datasources.entity configuration: map-underscore-to-camel-case: true DruidConfig @Configuration public class DruidConfig { @Bean public ServletRegistrationBean statViewServlet(){ ServletRegistrationBean&lt;StatViewServlet&gt; bean = new ServletRegistrationBean&lt;StatViewServlet&gt;( new StatViewServlet(), &quot;/druid/*&quot; ); Map&lt;String,String&gt; iniParms=new HashMap&lt;&gt;( ); iniParms.put( &quot;loginUsername&quot;,&quot;admin&quot; );//ç™»å½•druidçš„ç”¨æˆ·å iniParms.put( &quot;loginPassword&quot;,&quot;123456&quot; );//ç™»å½•druidçš„å¯†ç  iniParms.put(&quot;allow&quot;,&quot;&quot;);//é»˜è®¤å…è®¸æ‰€æœ‰ //iniParms.put( &quot;deny&quot;,&quot;192.168.***.***&quot; );//æ‹’ç»çš„ipåœ°å€ bean.setInitParameters( iniParms ); return bean; } @Bean public FilterRegistrationBean webStatFilter(){ FilterRegistrationBean bean= new FilterRegistrationBean(); bean.setFilter(new WebStatFilter()); Map&lt;String,String&gt; iniParms=new HashMap&lt;&gt;(); iniParms.put( &quot;excliusions&quot;, &quot;*.js,*.gif,*.jpg,*.bmp,*.png,*.css,*.ico,/druid/*&quot;);//ä½¿é™æ€æ–‡ä»¶è®¿é—®ï¼Œè¿˜æœ‰/druid/* çš„è®¿é—®ä¸è¢«æ‹¦æˆª bean.setInitParameters( iniParms ); bean.setUrlPatterns( Arrays.asList(&quot;/*&quot;)); return bean; } } è®¿é—®Druid http://localhost:8080/druid/login.html springBoot,mybatis,druidå¤šæ•°æ®æºæ•´åˆ é¡¹ç›®æ¶æ„ pom.xml &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;parent&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt; &lt;version&gt;2.4.5&lt;/version&gt; &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt; &lt;/parent&gt; &lt;groupId&gt;com.example&lt;/groupId&gt; &lt;artifactId&gt;datasources&lt;/artifactId&gt; &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt; &lt;name&gt;datasources&lt;/name&gt; &lt;description&gt;Demo project for Spring Boot&lt;/description&gt; &lt;properties&gt; &lt;java.version&gt;1.8&lt;/java.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;optional&gt;true&lt;/optional&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;mysql&lt;/groupId&gt; &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt; &lt;version&gt;5.1.45&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.alibaba&lt;/groupId&gt; &lt;artifactId&gt;druid&lt;/artifactId&gt; &lt;version&gt;1.1.10&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-configuration-processor&lt;/artifactId&gt; &lt;optional&gt;true&lt;/optional&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.baomidou&lt;/groupId&gt; &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt; &lt;version&gt;3.2.0&lt;/version&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt; &lt;configuration&gt; &lt;excludes&gt; &lt;exclude&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;/exclude&gt; &lt;/excludes&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt; &lt;/project&gt; application.yml spring: datasource: #ä½¿ç”¨druidè¿æ¥æ±  type: com.alibaba.druid.pool.DruidDataSource # è‡ªå®šä¹‰çš„ä¸»æ•°æ®æºé…ç½®ä¿¡æ¯ primary: datasource: #druidç›¸å…³é…ç½® druid: #ç›‘æ§ç»Ÿè®¡æ‹¦æˆªçš„filters filters: stat driverClassName: com.mysql.jdbc.Driver #é…ç½®åŸºæœ¬å±æ€§ url: jdbc:mysql://127.0.0.1:3306/primary_database?useUnicode=true&amp;characterEncoding=UTF-8&amp;allowMultiQueries=true&amp;autoReconnect=true&amp;useSSL=false username: root password: 123456 #é…ç½®åˆå§‹åŒ–å¤§å°/æœ€å°/æœ€å¤§ initialSize: 1 minIdle: 1 maxActive: 20 #è·å–è¿æ¥ç­‰å¾…è¶…æ—¶æ—¶é—´ maxWait: 60000 #é—´éš”å¤šä¹…è¿›è¡Œä¸€æ¬¡æ£€æµ‹ï¼Œæ£€æµ‹éœ€è¦å…³é—­çš„ç©ºé—²è¿æ¥ timeBetweenEvictionRunsMillis: 60000 #ä¸€ä¸ªè¿æ¥åœ¨æ± ä¸­æœ€å°ç”Ÿå­˜çš„æ—¶é—´ minEvictableIdleTimeMillis: 300000 validationQuery: SELECT 'x' testWhileIdle: true testOnBorrow: false testOnReturn: false #æ‰“å¼€PSCacheï¼Œå¹¶æŒ‡å®šæ¯ä¸ªè¿æ¥ä¸ŠPSCacheçš„å¤§å°ã€‚oracleè®¾ä¸ºtrueï¼Œmysqlè®¾ä¸ºfalseã€‚åˆ†åº“åˆ†è¡¨è¾ƒå¤šæ¨èè®¾ç½®ä¸ºfalse poolPreparedStatements: false maxPoolPreparedStatementPerConnectionSize: 20 # è‡ªå®šä¹‰çš„ä»æ•°æ®æºé…ç½®ä¿¡æ¯ back: datasource: #druidç›¸å…³é…ç½® druid: #ç›‘æ§ç»Ÿè®¡æ‹¦æˆªçš„filters filters: stat driverClassName: com.mysql.jdbc.Driver #é…ç½®åŸºæœ¬å±æ€§ url: jdbc:mysql://127.0.0.1:3306/back_database?useUnicode=true&amp;characterEncoding=UTF-8&amp;allowMultiQueries=true&amp;autoReconnect=true&amp;useSSL=false username: root password: 123456 #é…ç½®åˆå§‹åŒ–å¤§å°/æœ€å°/æœ€å¤§ initialSize: 1 minIdle: 1 maxActive: 20 #è·å–è¿æ¥ç­‰å¾…è¶…æ—¶æ—¶é—´ maxWait: 60000 #é—´éš”å¤šä¹…è¿›è¡Œä¸€æ¬¡æ£€æµ‹ï¼Œæ£€æµ‹éœ€è¦å…³é—­çš„ç©ºé—²è¿æ¥ timeBetweenEvictionRunsMillis: 60000 #ä¸€ä¸ªè¿æ¥åœ¨æ± ä¸­æœ€å°ç”Ÿå­˜çš„æ—¶é—´ minEvictableIdleTimeMillis: 300000 validationQuery: SELECT 'x' testWhileIdle: true testOnBorrow: false testOnReturn: false #æ‰“å¼€PSCacheï¼Œå¹¶æŒ‡å®šæ¯ä¸ªè¿æ¥ä¸ŠPSCacheçš„å¤§å°ã€‚oracleè®¾ä¸ºtrueï¼Œmysqlè®¾ä¸ºfalseã€‚åˆ†åº“åˆ†è¡¨è¾ƒå¤šæ¨èè®¾ç½®ä¸ºfalse poolPreparedStatements: false maxPoolPreparedStatementPerConnectionSize: 20 DruidConfig @Configuration public class DruidConfig { @Bean public ServletRegistrationBean statViewServlet(){ ServletRegistrationBean&lt;StatViewServlet&gt; bean = new ServletRegistrationBean&lt;StatViewServlet&gt;( new StatViewServlet(), &quot;/druid/*&quot; ); Map&lt;String,String&gt; iniParms=new HashMap&lt;&gt;( ); iniParms.put( &quot;loginUsername&quot;,&quot;admin&quot; );//ç™»å½•druidçš„ç”¨æˆ·å iniParms.put( &quot;loginPassword&quot;,&quot;123456&quot; );//ç™»å½•druidçš„å¯†ç  iniParms.put(&quot;allow&quot;,&quot;&quot;);//é»˜è®¤å…è®¸æ‰€æœ‰ //iniParms.put( &quot;deny&quot;,&quot;192.168.***.***&quot; );//æ‹’ç»çš„ipåœ°å€ bean.setInitParameters( iniParms ); return bean; } @Bean public FilterRegistrationBean webStatFilter(){ FilterRegistrationBean bean= new FilterRegistrationBean(); bean.setFilter(new WebStatFilter()); Map&lt;String,String&gt; iniParms=new HashMap&lt;&gt;(); iniParms.put( &quot;excliusions&quot;, &quot;*.js,*.gif,*.jpg,*.bmp,*.png,*.css,*.ico,/druid/*&quot;);//ä½¿é™æ€æ–‡ä»¶è®¿é—®ï¼Œè¿˜æœ‰/druid/* çš„è®¿é—®ä¸è¢«æ‹¦æˆª bean.setInitParameters( iniParms ); bean.setUrlPatterns( Arrays.asList(&quot;/*&quot;)); return bean; } } PrimaryDataBaseConfig /** * @Description: ä¸»æ•°æ®æºé…ç½®ç±» */ @Data @Configuration // å‰ç¼€ä¸ºprimary.datasource.druidçš„é…ç½®ä¿¡æ¯ @ConfigurationProperties(prefix = &quot;primary.datasource.druid&quot;) @MapperScan(basePackages = PrimaryDataBaseConfig.PACKAGE, sqlSessionFactoryRef = &quot;primarySqlSessionFactory&quot;) public class PrimaryDataBaseConfig { /** * daoå±‚çš„åŒ…è·¯å¾„ */ static final String PACKAGE = &quot;com.example.datasources.dao.primary&quot;; /** * mapperæ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„ */ private static final String MAPPER_LOCATION = &quot;classpath:mapper/primary/*.xml&quot;; private String filters; private String url; private String username; private String password; private String driverClassName; private int initialSize; private int minIdle; private int maxActive; private long maxWait; private long timeBetweenEvictionRunsMillis; private long minEvictableIdleTimeMillis; private String validationQuery; private boolean testWhileIdle; private boolean testOnBorrow; private boolean testOnReturn; private boolean poolPreparedStatements; private int maxPoolPreparedStatementPerConnectionSize; // ä¸»æ•°æ®æºä½¿ç”¨@Primaryæ³¨è§£è¿›è¡Œæ ‡è¯† @Primary @Bean(name = &quot;primaryDataSource&quot;) public DataSource primaryDataSource() throws SQLException { DruidDataSource druid = new DruidDataSource(); // ç›‘æ§ç»Ÿè®¡æ‹¦æˆªçš„filters druid.setFilters(filters); // é…ç½®åŸºæœ¬å±æ€§ druid.setDriverClassName(driverClassName); druid.setUsername(username); druid.setPassword(password); druid.setUrl(url); //åˆå§‹åŒ–æ—¶å»ºç«‹ç‰©ç†è¿æ¥çš„ä¸ªæ•° druid.setInitialSize(initialSize); //æœ€å¤§è¿æ¥æ± æ•°é‡ druid.setMaxActive(maxActive); //æœ€å°è¿æ¥æ± æ•°é‡ druid.setMinIdle(minIdle); //è·å–è¿æ¥æ—¶æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œå•ä½æ¯«ç§’ã€‚ druid.setMaxWait(maxWait); //é—´éš”å¤šä¹…è¿›è¡Œä¸€æ¬¡æ£€æµ‹ï¼Œæ£€æµ‹éœ€è¦å…³é—­çš„ç©ºé—²è¿æ¥ druid.setTimeBetweenEvictionRunsMillis(timeBetweenEvictionRunsMillis); //ä¸€ä¸ªè¿æ¥åœ¨æ± ä¸­æœ€å°ç”Ÿå­˜çš„æ—¶é—´ druid.setMinEvictableIdleTimeMillis(minEvictableIdleTimeMillis); //ç”¨æ¥æ£€æµ‹è¿æ¥æ˜¯å¦æœ‰æ•ˆçš„sql druid.setValidationQuery(validationQuery); //å»ºè®®é…ç½®ä¸ºtrueï¼Œä¸å½±å“æ€§èƒ½ï¼Œå¹¶ä¸”ä¿è¯å®‰å…¨æ€§ã€‚ druid.setTestWhileIdle(testWhileIdle); //ç”³è¯·è¿æ¥æ—¶æ‰§è¡ŒvalidationQueryæ£€æµ‹è¿æ¥æ˜¯å¦æœ‰æ•ˆ druid.setTestOnBorrow(testOnBorrow); druid.setTestOnReturn(testOnReturn); //æ˜¯å¦ç¼“å­˜preparedStatementï¼Œä¹Ÿå°±æ˜¯PSCacheï¼Œoracleè®¾ä¸ºtrueï¼Œmysqlè®¾ä¸ºfalseã€‚åˆ†åº“åˆ†è¡¨è¾ƒå¤šæ¨èè®¾ç½®ä¸ºfalse druid.setPoolPreparedStatements(poolPreparedStatements); // æ‰“å¼€PSCacheæ—¶ï¼ŒæŒ‡å®šæ¯ä¸ªè¿æ¥ä¸ŠPSCacheçš„å¤§å° druid.setMaxPoolPreparedStatementPerConnectionSize(maxPoolPreparedStatementPerConnectionSize); return druid; } // åˆ›å»ºè¯¥æ•°æ®æºçš„äº‹åŠ¡ç®¡ç† @Primary @Bean(name = &quot;primaryTransactionManager&quot;) public DataSourceTransactionManager primaryTransactionManager() throws SQLException { return new DataSourceTransactionManager(primaryDataSource()); } // åˆ›å»ºMybatisçš„è¿æ¥ä¼šè¯å·¥å‚å®ä¾‹ @Primary @Bean(name = &quot;primarySqlSessionFactory&quot;) public SqlSessionFactory primarySqlSessionFactory(@Qualifier(&quot;primaryDataSource&quot;) DataSource primaryDataSource) throws Exception { final SqlSessionFactoryBean sessionFactory = new SqlSessionFactoryBean(); sessionFactory.setDataSource(primaryDataSource); // è®¾ç½®æ•°æ®æºbean sessionFactory.setMapperLocations(new PathMatchingResourcePatternResolver() .getResources(PrimaryDataBaseConfig.MAPPER_LOCATION)); // è®¾ç½®mapperæ–‡ä»¶è·¯å¾„ return sessionFactory.getObject(); } } BackDataBaseConfig /** * @Description: ä»æ•°æ®æºé…ç½®ç±» */ @Data @Configuration @ConfigurationProperties(prefix = &quot;back.datasource.druid&quot;) @MapperScan(basePackages = BackDataBaseConfig.PACKAGE, sqlSessionFactoryRef = &quot;backSqlSessionFactory&quot;) public class BackDataBaseConfig { /** * daoå±‚çš„åŒ…è·¯å¾„ */ static final String PACKAGE = &quot;com.example.datasources.dao.back&quot;; /** * mapperæ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„ */ private static final String MAPPER_LOCATION = &quot;classpath:mapper/back/*.xml&quot;; private String filters; private String url; private String username; private String password; private String driverClassName; private int initialSize; private int minIdle; private int maxActive; private long maxWait; private long timeBetweenEvictionRunsMillis; private long minEvictableIdleTimeMillis; private String validationQuery; private boolean testWhileIdle; private boolean testOnBorrow; private boolean testOnReturn; private boolean poolPreparedStatements; private int maxPoolPreparedStatementPerConnectionSize; @Bean(name = &quot;backDataSource&quot;) public DataSource backDataSource() throws SQLException { DruidDataSource druid = new DruidDataSource(); // ç›‘æ§ç»Ÿè®¡æ‹¦æˆªçš„filters druid.setFilters(filters); // é…ç½®åŸºæœ¬å±æ€§ druid.setDriverClassName(driverClassName); druid.setUsername(username); druid.setPassword(password); druid.setUrl(url); //åˆå§‹åŒ–æ—¶å»ºç«‹ç‰©ç†è¿æ¥çš„ä¸ªæ•° druid.setInitialSize(initialSize); //æœ€å¤§è¿æ¥æ± æ•°é‡ druid.setMaxActive(maxActive); //æœ€å°è¿æ¥æ± æ•°é‡ druid.setMinIdle(minIdle); //è·å–è¿æ¥æ—¶æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œå•ä½æ¯«ç§’ã€‚ druid.setMaxWait(maxWait); //é—´éš”å¤šä¹…è¿›è¡Œä¸€æ¬¡æ£€æµ‹ï¼Œæ£€æµ‹éœ€è¦å…³é—­çš„ç©ºé—²è¿æ¥ druid.setTimeBetweenEvictionRunsMillis(timeBetweenEvictionRunsMillis); //ä¸€ä¸ªè¿æ¥åœ¨æ± ä¸­æœ€å°ç”Ÿå­˜çš„æ—¶é—´ druid.setMinEvictableIdleTimeMillis(minEvictableIdleTimeMillis); //ç”¨æ¥æ£€æµ‹è¿æ¥æ˜¯å¦æœ‰æ•ˆçš„sql druid.setValidationQuery(validationQuery); //å»ºè®®é…ç½®ä¸ºtrueï¼Œä¸å½±å“æ€§èƒ½ï¼Œå¹¶ä¸”ä¿è¯å®‰å…¨æ€§ã€‚ druid.setTestWhileIdle(testWhileIdle); //ç”³è¯·è¿æ¥æ—¶æ‰§è¡ŒvalidationQueryæ£€æµ‹è¿æ¥æ˜¯å¦æœ‰æ•ˆ druid.setTestOnBorrow(testOnBorrow); druid.setTestOnReturn(testOnReturn); //æ˜¯å¦ç¼“å­˜preparedStatementï¼Œä¹Ÿå°±æ˜¯PSCacheï¼Œoracleè®¾ä¸ºtrueï¼Œmysqlè®¾ä¸ºfalseã€‚åˆ†åº“åˆ†è¡¨è¾ƒå¤šæ¨èè®¾ç½®ä¸ºfalse druid.setPoolPreparedStatements(poolPreparedStatements); // æ‰“å¼€PSCacheæ—¶ï¼ŒæŒ‡å®šæ¯ä¸ªè¿æ¥ä¸ŠPSCacheçš„å¤§å° druid.setMaxPoolPreparedStatementPerConnectionSize(maxPoolPreparedStatementPerConnectionSize); return druid; } @Bean(name = &quot;backTransactionManager&quot;) public DataSourceTransactionManager backTransactionManager() throws SQLException { return new DataSourceTransactionManager(backDataSource()); } @Bean(name = &quot;backSqlSessionFactory&quot;) public SqlSessionFactory backSqlSessionFactory(@Qualifier(&quot;backDataSource&quot;) DataSource backDataSource) throws Exception { final SqlSessionFactoryBean sessionFactory = new SqlSessionFactoryBean(); sessionFactory.setDataSource(backDataSource); sessionFactory.setMapperLocations(new PathMatchingResourcePatternResolver() .getResources(BackDataBaseConfig.MAPPER_LOCATION)); return sessionFactory.getObject(); } } è®¿é—®Druid http://localhost:8080/druid/login.html springBoot,mybatis,druidä¸»ä»å¤‡ä»½ é¡¹ç›®æ¶æ„ pom.xml &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;parent&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt; &lt;version&gt;2.4.5&lt;/version&gt; &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt; &lt;/parent&gt; &lt;groupId&gt;com.example&lt;/groupId&gt; &lt;artifactId&gt;datasources&lt;/artifactId&gt; &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt; &lt;name&gt;datasources&lt;/name&gt; &lt;description&gt;Demo project for Spring Boot&lt;/description&gt; &lt;properties&gt; &lt;java.version&gt;1.8&lt;/java.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;optional&gt;true&lt;/optional&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;mysql&lt;/groupId&gt; &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt; &lt;version&gt;5.1.45&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.alibaba&lt;/groupId&gt; &lt;artifactId&gt;druid&lt;/artifactId&gt; &lt;version&gt;1.1.10&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-configuration-processor&lt;/artifactId&gt; &lt;optional&gt;true&lt;/optional&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.baomidou&lt;/groupId&gt; &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt; &lt;version&gt;3.2.0&lt;/version&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt; &lt;configuration&gt; &lt;excludes&gt; &lt;exclude&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;/exclude&gt; &lt;/excludes&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt; &lt;/project&gt; application.yml spring: datasource: #ä½¿ç”¨druidè¿æ¥æ±  type: com.alibaba.druid.pool.DruidDataSource # è‡ªå®šä¹‰çš„ä¸»æ•°æ®æºé…ç½®ä¿¡æ¯ primary: datasource: #druidç›¸å…³é…ç½® druid: #ç›‘æ§ç»Ÿè®¡æ‹¦æˆªçš„filters filters: stat driverClassName: com.mysql.jdbc.Driver #é…ç½®åŸºæœ¬å±æ€§ url: jdbc:mysql://127.0.0.1:3306/primary_database?useUnicode=true&amp;characterEncoding=UTF-8&amp;allowMultiQueries=true&amp;autoReconnect=true&amp;useSSL=false username: root password: 123456 #é…ç½®åˆå§‹åŒ–å¤§å°/æœ€å°/æœ€å¤§ initialSize: 1 minIdle: 1 maxActive: 20 #è·å–è¿æ¥ç­‰å¾…è¶…æ—¶æ—¶é—´ maxWait: 60000 #é—´éš”å¤šä¹…è¿›è¡Œä¸€æ¬¡æ£€æµ‹ï¼Œæ£€æµ‹éœ€è¦å…³é—­çš„ç©ºé—²è¿æ¥ timeBetweenEvictionRunsMillis: 60000 #ä¸€ä¸ªè¿æ¥åœ¨æ± ä¸­æœ€å°ç”Ÿå­˜çš„æ—¶é—´ minEvictableIdleTimeMillis: 300000 validationQuery: SELECT 'x' testWhileIdle: true testOnBorrow: false testOnReturn: false #æ‰“å¼€PSCacheï¼Œå¹¶æŒ‡å®šæ¯ä¸ªè¿æ¥ä¸ŠPSCacheçš„å¤§å°ã€‚oracleè®¾ä¸ºtrueï¼Œmysqlè®¾ä¸ºfalseã€‚åˆ†åº“åˆ†è¡¨è¾ƒå¤šæ¨èè®¾ç½®ä¸ºfalse poolPreparedStatements: false maxPoolPreparedStatementPerConnectionSize: 20 # è‡ªå®šä¹‰çš„ä»æ•°æ®æºé…ç½®ä¿¡æ¯ back: datasource: #druidç›¸å…³é…ç½® druid: #ç›‘æ§ç»Ÿè®¡æ‹¦æˆªçš„filters filters: stat driverClassName: com.mysql.jdbc.Driver #é…ç½®åŸºæœ¬å±æ€§ url: jdbc:mysql://127.0.0.1:3306/back_database?useUnicode=true&amp;characterEncoding=UTF-8&amp;allowMultiQueries=true&amp;autoReconnect=true&amp;useSSL=false username: root password: 123456 #é…ç½®åˆå§‹åŒ–å¤§å°/æœ€å°/æœ€å¤§ initialSize: 1 minIdle: 1 maxActive: 20 #è·å–è¿æ¥ç­‰å¾…è¶…æ—¶æ—¶é—´ maxWait: 60000 #é—´éš”å¤šä¹…è¿›è¡Œä¸€æ¬¡æ£€æµ‹ï¼Œæ£€æµ‹éœ€è¦å…³é—­çš„ç©ºé—²è¿æ¥ timeBetweenEvictionRunsMillis: 60000 #ä¸€ä¸ªè¿æ¥åœ¨æ± ä¸­æœ€å°ç”Ÿå­˜çš„æ—¶é—´ minEvictableIdleTimeMillis: 300000 validationQuery: SELECT 'x' testWhileIdle: true testOnBorrow: false testOnReturn: false #æ‰“å¼€PSCacheï¼Œå¹¶æŒ‡å®šæ¯ä¸ªè¿æ¥ä¸ŠPSCacheçš„å¤§å°ã€‚oracleè®¾ä¸ºtrueï¼Œmysqlè®¾ä¸ºfalseã€‚åˆ†åº“åˆ†è¡¨è¾ƒå¤šæ¨èè®¾ç½®ä¸ºfalse poolPreparedStatements: false maxPoolPreparedStatementPerConnectionSize: 20 DruidConfig @Configuration public class DruidConfig { public final static String MAPPER_XML_PATH = &quot;classpath:mapper/*.xml&quot;; @ConfigurationProperties(prefix = &quot;master.datasource.druid&quot;) @Bean(name = &quot;masterDataSource&quot;) public DataSource masterDataSource() { return new DruidDataSource(); } @Bean public PlatformTransactionManager txManager(DataSource dynamicDataSource) { return new DataSourceTransactionManager(dynamicDataSource); } @ConfigurationProperties(prefix = &quot;slave.datasource.druid&quot;) @Bean public DataSource slaveDataSource(){ return new DruidDataSource(); } @Bean public DynamicDataSource dynamicDataSource(){ DynamicDataSource dynamicDataSource=new DynamicDataSource(); Map&lt;Object,Object&gt; map=new HashMap&lt;&gt;(); map.put(DbUtil.master,masterDataSource()); map.put(DbUtil.slave,slaveDataSource()); dynamicDataSource.setDefaultTargetDataSource(masterDataSource()); dynamicDataSource.setTargetDataSources(map); return dynamicDataSource; } @Bean public SqlSessionFactoryBean sqlSessionFactoryBean(DataSource dynamicDataSource) throws IOException { SqlSessionFactoryBean sqlSessionFactory = new SqlSessionFactoryBean(); sqlSessionFactory.setDataSource(dynamicDataSource); sqlSessionFactory.setMapperLocations(new PathMatchingResourcePatternResolver().getResources(MAPPER_XML_PATH)); return sqlSessionFactory; } @Bean public SqlSessionTemplate sqlSessionTemplate(SqlSessionFactoryBean sqlSessionFactoryBean) throws Exception { SqlSessionTemplate sqlSessionTemplate = new SqlSessionTemplate(sqlSessionFactoryBean.getObject()); return sqlSessionTemplate; } @Bean public ServletRegistrationBean statViewServlet(){ ServletRegistrationBean&lt;StatViewServlet&gt; bean = new ServletRegistrationBean&lt;StatViewServlet&gt;( new StatViewServlet(), &quot;/druid/*&quot; ); Map&lt;String,String&gt; iniParms=new HashMap&lt;&gt;( ); iniParms.put( &quot;loginUsername&quot;,&quot;admin&quot; );//ç™»å½•druidçš„ç”¨æˆ·å iniParms.put( &quot;loginPassword&quot;,&quot;123456&quot; );//ç™»å½•druidçš„å¯†ç  iniParms.put(&quot;allow&quot;,&quot;&quot;);//é»˜è®¤å…è®¸æ‰€æœ‰ //iniParms.put( &quot;deny&quot;,&quot;192.168.***.***&quot; );//æ‹’ç»çš„ipåœ°å€ bean.setInitParameters( iniParms ); return bean; } @Bean public FilterRegistrationBean webStatFilter(){ FilterRegistrationBean bean= new FilterRegistrationBean(); bean.setFilter(new WebStatFilter()); Map&lt;String,String&gt; iniParms=new HashMap&lt;&gt;(); iniParms.put( &quot;excliusions&quot;, &quot;*.js,*.gif,*.jpg,*.bmp,*.png,*.css,*.ico,/druid/*&quot;);//ä½¿é™æ€æ–‡ä»¶è®¿é—®ï¼Œè¿˜æœ‰/druid/* çš„è®¿é—®ä¸è¢«æ‹¦æˆª bean.setInitParameters( iniParms ); bean.setUrlPatterns( Arrays.asList(&quot;/*&quot;)); return bean; } }@Configuration public class DruidConfig { @Bean public ServletRegistrationBean statViewServlet(){ ServletRegistrationBean&lt;StatViewServlet&gt; bean = new ServletRegistrationBean&lt;StatViewServlet&gt;( new StatViewServlet(), &quot;/druid/*&quot; ); Map&lt;String,String&gt; iniParms=new HashMap&lt;&gt;( ); iniParms.put( &quot;loginUsername&quot;,&quot;admin&quot; );//ç™»å½•druidçš„ç”¨æˆ·å iniParms.put( &quot;loginPassword&quot;,&quot;123456&quot; );//ç™»å½•druidçš„å¯†ç  iniParms.put(&quot;allow&quot;,&quot;&quot;);//é»˜è®¤å…è®¸æ‰€æœ‰ //iniParms.put( &quot;deny&quot;,&quot;192.168.***.***&quot; );//æ‹’ç»çš„ipåœ°å€ bean.setInitParameters( iniParms ); return bean; } @Bean public FilterRegistrationBean webStatFilter(){ FilterRegistrationBean bean= new FilterRegistrationBean(); bean.setFilter(new WebStatFilter()); Map&lt;String,String&gt; iniParms=new HashMap&lt;&gt;(); iniParms.put( &quot;excliusions&quot;, &quot;*.js,*.gif,*.jpg,*.bmp,*.png,*.css,*.ico,/druid/*&quot;);//ä½¿é™æ€æ–‡ä»¶è®¿é—®ï¼Œè¿˜æœ‰/druid/* çš„è®¿é—®ä¸è¢«æ‹¦æˆª bean.setInitParameters( iniParms ); bean.setUrlPatterns( Arrays.asList(&quot;/*&quot;)); return bean; } } MasterDataSource /** * è‡ªå®šä¹‰ä¸»æ•°æ®åº“æ³¨è§£ */ @Target(ElementType.METHOD) @Retention(RetentionPolicy.RUNTIME) public @interface MasterDataSource { String value() default &quot;&quot;; } DatabaseAOP /** * aopä»daoå±‚åˆ¤æ–­ä½¿ç”¨å“ªä¸ªæ•°æ®åº“ * @MasterDataSourceæ ‡è¯†ä½¿ç”¨ä¸»æ•°æ®åº“ * ä¸æ ‡è¯†ä½¿ç”¨ä»æ•°æ®åº“ */ @Aspect @Component public class DatabaseAOP { @Pointcut(value = &quot;execution(* com.example.datasources.dao..*.*(..))&quot;) public void pointCut() { } @Before(&quot;pointCut()&quot;) public void before(JoinPoint joinPoint) { MethodSignature methodSignature = (MethodSignature) joinPoint.getSignature(); Method method = methodSignature.getMethod(); boolean isExist = method.isAnnotationPresent(MasterDataSource.class); if (!isExist) { DbUtil.setDb(DbUtil.slave); return; } DbUtil.setDb(DbUtil.master); } } DbUtil /** * å­˜å‚¨å½“å‰çº¿ç¨‹ä½¿ç”¨æ•°æ®åº“æ ‡è¯† */ public class DbUtil { public static String master=&quot;master&quot;; public static String slave=&quot;slave&quot;; private static final ThreadLocal&lt;String&gt; threadLocal=new ThreadLocal(); public static void setDb(String db){ threadLocal.set(db); } public static String getDb(){ return threadLocal.get(); } } DynamicDataSource /** * springçš„jdbcæä¾›äº†åŠ¨æ€æ•°æ®æºçš„å…¥å£ * ç»§æ‰¿AbstractRoutingDataSourceè¦†ç›–determineCurrentLookupKey()æ–¹æ³• è¿”å›å½“å‰ä½¿ç”¨æ•°æ®åº“ */ @Slf4j public class DynamicDataSource extends AbstractRoutingDataSource { @Override protected Object determineCurrentLookupKey() { log.info(&quot;å½“å‰ä½¿ç”¨æ•°æ®åº“ï¼š{}&quot;, DbUtil.getDb()); return DbUtil.getDb(); } } CityMapper /** * springBootå¯åŠ¨å…¥å£DatasourcesApplicationæ³¨è§£@MapperScan(basePackages = &quot;com.example.datasources.dao&quot;) * èµ·åˆ°å’Œ@Mapperä¸€æ ·çš„ä½œç”¨ * æ·»åŠ äº†@Mapperæ³¨è§£ä¹‹åè¿™ä¸ªæ¥å£åœ¨ç¼–è¯‘æ—¶ä¼šç”Ÿæˆç›¸åº”çš„å®ç°ç±»ï¼Œä¸å†éœ€è¦å†™mapperæ˜ å°„æ–‡ä»¶ï¼Œå¯ä»¥æŒ‰ä¸‹æ–¹@Select(&quot;select * from city where city_name like CONCAT('%', #{cityName},'%')&quot;)å®ç°åŠŸèƒ½ï¼Œ@Autowiredæ³¨è§£ä¹Ÿéœ€è¦é€šè¿‡@Mapperæ³¨è§£å®ç°æ¥å£çš„åŠ¨æ€ä»£ç†å®ç°ç±» */ @Mapper @Component public interface CityMapper { /** * @MasterDataSourceæŒ‡å®šä½¿ç”¨ä¸»æ•°æ®åº“æ–°å¢ * ä¸æŒ‡å®šé»˜è®¤ä½¿ç”¨ä»æ•°æ®åº“ */ @MasterDataSource void insertCity(City city); /** * æ ¹æ®åŸå¸‚åç§°ï¼ŒæŸ¥è¯¢åŸå¸‚ä¿¡æ¯ * * @param cityName åŸå¸‚å * é»˜è®¤ä½¿ç”¨ä»æ•°æ®åº“ */ //@Select(&quot;select * from city where city_name like CONCAT('%', #{cityName},'%')&quot;) List&lt;City&gt; selectByName(@Param(&quot;cityName&quot;) String cityName); } CityMapper.xml &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt; &lt;mapper namespace=&quot;com.example.datasources.dao.CityMapper&quot;&gt; &lt;resultMap id=&quot;BaseResultMap&quot; type=&quot;com.example.datasources.entity.City&quot;&gt; &lt;id column=&quot;id&quot; jdbcType=&quot;INTEGER&quot; property=&quot;id&quot;/&gt; &lt;result column=&quot;city_name&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;cityName&quot;/&gt; &lt;/resultMap&gt; &lt;sql id=&quot;Base_Column_List&quot;&gt; id,city_name &lt;/sql&gt; &lt;insert id=&quot;insertCity&quot; parameterType=&quot;com.example.datasources.entity.City&quot;&gt; INSERT into city (id,city_name) VALUES (#{id,jdbcType=INTEGER}, #{cityName,jdbcType=VARCHAR}); &lt;/insert&gt; &lt;select id=&quot;selectByName&quot; resultMap=&quot;BaseResultMap&quot;&gt; select &lt;include refid=&quot;Base_Column_List&quot;/&gt; from city where city_name like CONCAT('%', #{cityName},'%') &lt;/select&gt; &lt;/mapper&gt; ","link":"https://tianxiawuhao.github.io/Ari4Sf8A0/"},{"title":"SpringBootåŸºç¡€","content":"ä¸€ã€SpringBootç®€ä»‹ 1.1 åŸæœ‰Springä¼˜ç¼ºç‚¹åˆ†æ 1.1.1 Springçš„ä¼˜ç‚¹åˆ†æ Springæ˜¯Javaä¼ä¸šç‰ˆï¼ˆJava Enterprise Editionï¼ŒJEEï¼Œä¹Ÿç§°J2EEï¼‰çš„è½»é‡çº§ä»£æ›¿å“ã€‚æ— éœ€å¼€å‘é‡é‡çº§çš„Enterprise JavaBeanï¼ˆEJBï¼‰ï¼ŒSpringä¸ºä¼ä¸šçº§Javaå¼€å‘æä¾›äº†ä¸€ç§ç›¸å¯¹ç®€å•çš„æ–¹æ³•ï¼Œé€šè¿‡ä¾èµ–æ³¨å…¥å’Œé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œç”¨ç®€å•çš„Javaå¯¹è±¡ï¼ˆPlain Old Java Objectï¼ŒPOJOï¼‰å®ç°äº†EJBçš„åŠŸèƒ½ã€‚ 1.1.2 Springçš„ç¼ºç‚¹åˆ†æ è™½ç„¶Springçš„ç»„ä»¶ä»£ç æ˜¯è½»é‡çº§çš„ï¼Œä½†å®ƒçš„é…ç½®å´æ˜¯é‡é‡çº§çš„ã€‚ä¸€å¼€å§‹ï¼ŒSpringç”¨XMLé…ç½®ï¼Œè€Œä¸”æ˜¯å¾ˆå¤šXMLé…ç½®ã€‚Spring 2.5å¼•å…¥äº†åŸºäºæ³¨è§£çš„ç»„ä»¶æ‰«æï¼Œè¿™æ¶ˆé™¤äº†å¤§é‡é’ˆå¯¹åº”ç”¨ç¨‹åºè‡ªèº«ç»„ä»¶çš„æ˜¾å¼XMLé…ç½®ã€‚Spring 3.0å¼•å…¥äº†åŸºäºJavaçš„é…ç½®ï¼Œè¿™æ˜¯ä¸€ç§ç±»å‹å®‰å…¨çš„å¯é‡æ„é…ç½®æ–¹å¼ï¼Œå¯ä»¥ä»£æ›¿XMLã€‚ æ‰€æœ‰è¿™äº›é…ç½®éƒ½ä»£è¡¨äº†å¼€å‘æ—¶çš„æŸè€—ã€‚å› ä¸ºåœ¨æ€è€ƒSpringç‰¹æ€§é…ç½®å’Œè§£å†³ä¸šåŠ¡é—®é¢˜ä¹‹é—´éœ€è¦è¿›è¡Œæ€ç»´åˆ‡æ¢ï¼Œæ‰€ä»¥ç¼–å†™é…ç½®æŒ¤å äº†ç¼–å†™åº”ç”¨ç¨‹åºé€»è¾‘çš„æ—¶é—´ã€‚å’Œæ‰€æœ‰æ¡†æ¶ä¸€æ ·ï¼ŒSpringå®ç”¨ï¼Œä½†ä¸æ­¤åŒæ—¶å®ƒè¦æ±‚çš„å›æŠ¥ä¹Ÿä¸å°‘ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œé¡¹ç›®çš„ä¾èµ–ç®¡ç†ä¹Ÿæ˜¯ä¸€ä»¶è€—æ—¶è€—åŠ›çš„äº‹æƒ…ã€‚åœ¨ç¯å¢ƒæ­å»ºæ—¶ï¼Œéœ€è¦åˆ†æè¦å¯¼å…¥å“ªäº›åº“çš„åæ ‡ï¼Œè€Œä¸”è¿˜éœ€è¦åˆ†æå¯¼å…¥ä¸ä¹‹æœ‰ä¾èµ–å…³ç³»çš„å…¶ä»–åº“çš„åæ ‡ï¼Œä¸€æ—¦é€‰é”™äº†ä¾èµ–çš„ç‰ˆæœ¬ï¼Œéšä¹‹è€Œæ¥çš„ä¸å…¼å®¹é—®é¢˜å°±ä¼šä¸¥é‡é˜»ç¢é¡¹ç›®çš„å¼€å‘è¿›åº¦ã€‚ 1.2 SpringBootçš„æ¦‚è¿° 1.2.1 SpringBootè§£å†³ä¸Šè¿°Springçš„ç¼ºç‚¹ SpringBootå¯¹ä¸Šè¿°Springçš„ç¼ºç‚¹è¿›è¡Œçš„æ”¹å–„å’Œä¼˜åŒ–ï¼ŒåŸºäºçº¦å®šä¼˜äºé…ç½®çš„æ€æƒ³ï¼Œå¯ä»¥è®©å¼€å‘äººå‘˜ä¸å¿…åœ¨é…ç½®ä¸é€»è¾‘ä¸šåŠ¡ä¹‹é—´è¿›è¡Œæ€ç»´çš„åˆ‡æ¢ï¼Œå…¨èº«å¿ƒçš„æŠ•å…¥åˆ°é€»è¾‘ä¸šåŠ¡çš„ä»£ç ç¼–å†™ä¸­ï¼Œä»è€Œå¤§å¤§æé«˜äº†å¼€å‘çš„æ•ˆç‡ï¼Œä¸€å®šç¨‹åº¦ä¸Šç¼©çŸ­äº†é¡¹ç›®å‘¨æœŸã€‚ 1.2.2 SpringBootçš„ç‰¹ç‚¹ ä¸ºåŸºäºSpringçš„å¼€å‘æä¾›æ›´å¿«çš„å…¥é—¨ä½“éªŒ å¼€ç®±å³ç”¨ï¼Œæ²¡æœ‰ä»£ç ç”Ÿæˆï¼Œä¹Ÿæ— éœ€XMLé…ç½®ã€‚åŒæ—¶ä¹Ÿå¯ä»¥ä¿®æ”¹é»˜è®¤å€¼æ¥æ»¡è¶³ç‰¹å®šçš„éœ€æ±‚ æä¾›äº†ä¸€äº›å¤§å‹é¡¹ç›®ä¸­å¸¸è§çš„éåŠŸèƒ½æ€§ç‰¹æ€§ï¼Œå¦‚åµŒå…¥å¼æœåŠ¡å™¨ã€å®‰å…¨ã€æŒ‡æ ‡ï¼Œå¥åº·æ£€æµ‹ã€å¤–éƒ¨é…ç½®ç­‰ SpringBootä¸æ˜¯å¯¹SpringåŠŸèƒ½ä¸Šçš„å¢å¼ºï¼Œè€Œæ˜¯æä¾›äº†ä¸€ç§å¿«é€Ÿä½¿ç”¨Springçš„æ–¹å¼ 1.2.3 SpringBootçš„æ ¸å¿ƒåŠŸèƒ½ èµ·æ­¥ä¾èµ– èµ·æ­¥ä¾èµ–æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªMavené¡¹ç›®å¯¹è±¡æ¨¡å‹ï¼ˆProject Object Modelï¼ŒPOMï¼‰ï¼Œå®šä¹‰äº†å¯¹å…¶ä»–åº“çš„ä¼ é€’ä¾èµ–ï¼Œè¿™äº›ä¸œè¥¿åŠ åœ¨ä¸€èµ·å³æ”¯æŒæŸé¡¹åŠŸèƒ½ã€‚ ç®€å•çš„è¯´ï¼Œèµ·æ­¥ä¾èµ–å°±æ˜¯å°†å…·å¤‡æŸç§åŠŸèƒ½çš„åæ ‡æ‰“åŒ…åˆ°ä¸€èµ·ï¼Œå¹¶æä¾›ä¸€äº›é»˜è®¤çš„åŠŸèƒ½ã€‚ è‡ªåŠ¨é…ç½® Spring Bootçš„è‡ªåŠ¨é…ç½®æ˜¯ä¸€ä¸ªè¿è¡Œæ—¶ï¼ˆæ›´å‡†ç¡®åœ°è¯´ï¼Œæ˜¯åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶ï¼‰çš„è¿‡ç¨‹ï¼Œè€ƒè™‘äº†ä¼—å¤šå› ç´ ï¼Œæ‰å†³å®šSpringé…ç½®åº”è¯¥ç”¨å“ªä¸ªï¼Œä¸è¯¥ç”¨å“ªä¸ªã€‚è¯¥è¿‡ç¨‹æ˜¯Springè‡ªåŠ¨å®Œæˆçš„ã€‚ â€‹ æ³¨æ„ï¼šèµ·æ­¥ä¾èµ–å’Œè‡ªåŠ¨é…ç½®çš„åŸç†å‰–æä¼šåœ¨ç¬¬ä¸‰ç« ã€ŠSpringBootåŸç†åˆ†æã€‹è¿›è¡Œè¯¦ç»†è®²è§£ äºŒã€SpringBootå¿«é€Ÿå…¥é—¨ 2.1 ä»£ç å®ç° 2.1.1 åˆ›å»ºMavenå·¥ç¨‹ ä½¿ç”¨ideaå·¥å…·åˆ›å»ºä¸€ä¸ªmavenå·¥ç¨‹ï¼Œè¯¥å·¥ç¨‹ä¸ºæ™®é€šçš„javaå·¥ç¨‹å³å¯ 2.1.2 æ·»åŠ SpringBootçš„èµ·æ­¥ä¾èµ– SpringBootè¦æ±‚ï¼Œé¡¹ç›®è¦ç»§æ‰¿SpringBootçš„èµ·æ­¥ä¾èµ–spring-boot-starter-parent &lt;parent&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt; &lt;version&gt;2.0.1.RELEASE&lt;/version&gt; &lt;/parent&gt; SpringBootè¦é›†æˆSpringMVCè¿›è¡ŒControllerçš„å¼€å‘ï¼Œæ‰€ä»¥é¡¹ç›®è¦å¯¼å…¥webçš„å¯åŠ¨ä¾èµ– &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;/dependencies&gt; 2.1.3 ç¼–å†™SpringBootå¼•å¯¼ç±» è¦é€šè¿‡SpringBootæä¾›çš„å¼•å¯¼ç±»èµ·æ­¥SpringBootæ‰å¯ä»¥è¿›è¡Œè®¿é—® package com.itheima; import org.springframework.boot.SpringApplication; import org.springframework.boot.autoconfigure.SpringBootApplication; @SpringBootApplication public class MySpringBootApplication { public static void main(String[] args) { SpringApplication.run(MySpringBootApplication.class); } } 2.1.4 ç¼–å†™Controller åœ¨å¼•å¯¼ç±»MySpringBootApplicationåŒçº§åŒ…æˆ–è€…å­çº§åŒ…ä¸­åˆ›å»ºQuickStartController package com.itheima.controller; import org.springframework.stereotype.Controller; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.ResponseBody; @Controller public class QuickStartController { @RequestMapping(&quot;/quick&quot;) @ResponseBody public String quick(){ return &quot;springboot è®¿é—®æˆåŠŸ!&quot;; } } 2.1.5 æµ‹è¯• æ‰§è¡ŒSpringBootèµ·æ­¥ç±»çš„ä¸»æ–¹æ³•ï¼Œæ§åˆ¶å°æ‰“å°æ—¥å¿—å¦‚ä¸‹ï¼š . ____ _ __ _ _ /\\\\ / ___'_ __ _ _(_)_ __ __ _ \\ \\ \\ \\ ( ( )\\___ | '_ | '_| | '_ \\/ _` | \\ \\ \\ \\ \\\\/ ___)| |_)| | | | | || (_| | ) ) ) ) ' |____| .__|_| |_|_| |_\\__, | / / / / =========|_|==============|___/=/_/_/_/ :: Spring Boot :: (v2.0.1.RELEASE) 2018-05-08 14:29:59.714 INFO 5672 --- [ main] com.itheima.MySpringBootApplication : Starting MySpringBootApplication on DESKTOP-RRUNFUH with PID 5672 (C:\\Users\\muzimoo\\IdeaProjects\\IdeaTest\\springboot_quick\\target\\classes started by muzimoo in C:\\Users\\muzimoo\\IdeaProjects\\IdeaTest) ... ... ... o.s.w.s.handler.SimpleUrlHandlerMapping : Mapped URL path [/**] onto handler of type [class org.springframework.web.servlet.resource.ResourceHttpRequestHandler] 2018-05-08 14:30:03.126 INFO 5672 --- [ main] o.s.j.e.a.AnnotationMBeanExporter : Registering beans for JMX exposure on startup 2018-05-08 14:30:03.196 INFO 5672 --- [ main] o.s.b.w.embedded.tomcat.TomcatWebServer : Tomcat started on port(s): 8080 (http) with context path '' 2018-05-08 14:30:03.206 INFO 5672 --- [ main] com.itheima.MySpringBootApplication : Started MySpringBootApplication in 4.252 seconds (JVM running for 5.583) é€šè¿‡æ—¥å¿—å‘ç°ï¼ŒTomcat started on port(s): 8080 (http) with context path '' tomcatå·²ç»èµ·æ­¥ï¼Œç«¯å£ç›‘å¬8080ï¼Œwebåº”ç”¨çš„è™šæ‹Ÿå·¥ç¨‹åç§°ä¸ºç©º æ‰“å¼€æµè§ˆå™¨è®¿é—®urlåœ°å€ä¸ºï¼šhttp://localhost:8080/quick 2.2 å¿«é€Ÿå…¥é—¨è§£æ 2.2.2 SpringBootä»£ç è§£æ @SpringBootApplicationï¼šæ ‡æ³¨SpringBootçš„å¯åŠ¨ç±»ï¼Œè¯¥æ³¨è§£å…·å¤‡å¤šç§åŠŸèƒ½ï¼ˆåé¢è¯¦ç»†å‰–æï¼‰ SpringApplication.run(MySpringBootApplication.class) ä»£è¡¨è¿è¡ŒSpringBootçš„å¯åŠ¨ç±»ï¼Œå‚æ•°ä¸ºSpringBootå¯åŠ¨ç±»çš„å­—èŠ‚ç å¯¹è±¡ 2.2.3 SpringBootå·¥ç¨‹çƒ­éƒ¨ç½² æˆ‘ä»¬åœ¨å¼€å‘ä¸­åå¤ä¿®æ”¹ç±»ã€é¡µé¢ç­‰èµ„æºï¼Œæ¯æ¬¡ä¿®æ”¹åéƒ½æ˜¯éœ€è¦é‡æ–°å¯åŠ¨æ‰ç”Ÿæ•ˆï¼Œè¿™æ ·æ¯æ¬¡å¯åŠ¨éƒ½å¾ˆéº»çƒ¦ï¼Œæµªè´¹äº†å¤§é‡çš„æ—¶é—´ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¿®æ”¹ä»£ç åä¸é‡å¯å°±èƒ½ç”Ÿæ•ˆï¼Œåœ¨ pom.xml ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®å°±å¯ä»¥å®ç°è¿™æ ·çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºçƒ­éƒ¨ç½²ã€‚ &lt;!--çƒ­éƒ¨ç½²é…ç½®--&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt; &lt;/dependency&gt; æ³¨æ„ï¼šIDEAè¿›è¡ŒSpringBootçƒ­éƒ¨ç½²å¤±è´¥åŸå›  å‡ºç°è¿™ç§æƒ…å†µï¼Œå¹¶ä¸æ˜¯çƒ­éƒ¨ç½²é…ç½®é—®é¢˜ï¼Œå…¶æ ¹æœ¬åŸå› æ˜¯å› ä¸ºIntellij IEDAé»˜è®¤æƒ…å†µä¸‹ä¸ä¼šè‡ªåŠ¨ç¼–è¯‘ï¼Œéœ€è¦å¯¹IDEAè¿›è¡Œè‡ªåŠ¨ç¼–è¯‘çš„è®¾ç½®ï¼Œå¦‚ä¸‹ï¼š ç„¶å Shift+Ctrl+Alt+/ï¼Œé€‰æ‹©Registry 2.2.4 ä½¿ç”¨ideaå¿«é€Ÿåˆ›å»ºSpringBooté¡¹ç›® é€šè¿‡ideaå¿«é€Ÿåˆ›å»ºçš„SpringBooté¡¹ç›®çš„pom.xmlä¸­å·²ç»å¯¼å…¥äº†æˆ‘ä»¬é€‰æ‹©çš„webçš„èµ·æ­¥ä¾èµ–çš„åæ ‡ &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;groupId&gt;com.itheima&lt;/groupId&gt; &lt;artifactId&gt;springboot_quick2&lt;/artifactId&gt; &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt; &lt;packaging&gt;jar&lt;/packaging&gt; &lt;name&gt;springboot_quick2&lt;/name&gt; &lt;description&gt;Demo project for Spring Boot&lt;/description&gt; &lt;parent&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt; &lt;version&gt;2.0.1.RELEASE&lt;/version&gt; &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt; &lt;/parent&gt; &lt;properties&gt; &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt; &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt; &lt;java.version&gt;9&lt;/java.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt; &lt;/project&gt; å¯ä»¥ä½¿ç”¨å¿«é€Ÿå…¥é—¨çš„æ–¹å¼åˆ›å»ºControllerè¿›è¡Œè®¿é—®ï¼Œæ­¤å¤„ä¸å†èµ˜è¿° ä¸‰ã€SpringBootåŸç†åˆ†æ 3.1 èµ·æ­¥ä¾èµ–åŸç†åˆ†æ 3.1.1 åˆ†æspring-boot-starter-parent æŒ‰ä½Ctrlç‚¹å‡»pom.xmlä¸­çš„spring-boot-starter-parentï¼Œè·³è½¬åˆ°äº†spring-boot-starter-parentçš„pom.xmlï¼Œxmlé…ç½®å¦‚ä¸‹ï¼ˆåªæ‘˜æŠ„äº†éƒ¨åˆ†é‡ç‚¹é…ç½®ï¼‰ï¼š &lt;parent&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-dependencies&lt;/artifactId&gt; &lt;version&gt;2.0.1.RELEASE&lt;/version&gt; &lt;relativePath&gt;../../spring-boot-dependencies&lt;/relativePath&gt; &lt;/parent&gt; æŒ‰ä½Ctrlç‚¹å‡»pom.xmlä¸­çš„spring-boot-starter-dependenciesï¼Œè·³è½¬åˆ°äº†spring-boot-starter-dependenciesçš„pom.xmlï¼Œxmlé…ç½®å¦‚ä¸‹ï¼ˆåªæ‘˜æŠ„äº†éƒ¨åˆ†é‡ç‚¹é…ç½®ï¼‰ï¼š &lt;properties&gt; &lt;activemq.version&gt;5.15.3&lt;/activemq.version&gt; &lt;antlr2.version&gt;2.7.7&lt;/antlr2.version&gt; &lt;appengine-sdk.version&gt;1.9.63&lt;/appengine-sdk.version&gt; &lt;artemis.version&gt;2.4.0&lt;/artemis.version&gt; &lt;aspectj.version&gt;1.8.13&lt;/aspectj.version&gt; &lt;assertj.version&gt;3.9.1&lt;/assertj.version&gt; &lt;atomikos.version&gt;4.0.6&lt;/atomikos.version&gt; &lt;bitronix.version&gt;2.1.4&lt;/bitronix.version&gt; &lt;build-helper-maven-plugin.version&gt;3.0.0&lt;/build-helper-maven-plugin.version&gt; &lt;byte-buddy.version&gt;1.7.11&lt;/byte-buddy.version&gt; ... ... ... &lt;/properties&gt; &lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot&lt;/artifactId&gt; &lt;version&gt;2.0.1.RELEASE&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-test&lt;/artifactId&gt; &lt;version&gt;2.0.1.RELEASE&lt;/version&gt; &lt;/dependency&gt; ... ... ... &lt;/dependencies&gt; &lt;/dependencyManagement&gt; &lt;build&gt; &lt;pluginManagement&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.jetbrains.kotlin&lt;/groupId&gt; &lt;artifactId&gt;kotlin-maven-plugin&lt;/artifactId&gt; &lt;version&gt;${kotlin.version}&lt;/version&gt; &lt;/plugin&gt; &lt;plugin&gt; &lt;groupId&gt;org.jooq&lt;/groupId&gt; &lt;artifactId&gt;jooq-codegen-maven&lt;/artifactId&gt; &lt;version&gt;${jooq.version}&lt;/version&gt; &lt;/plugin&gt; &lt;plugin&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt; &lt;version&gt;2.0.1.RELEASE&lt;/version&gt; &lt;/plugin&gt; ... ... ... &lt;/plugins&gt; &lt;/pluginManagement&gt; &lt;/build&gt; ä»ä¸Šé¢çš„spring-boot-starter-dependenciesçš„pom.xmlä¸­æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œä¸€éƒ¨åˆ†åæ ‡çš„ç‰ˆæœ¬ã€ä¾èµ–ç®¡ç†ã€æ’ä»¶ç®¡ç†å·²ç»å®šä¹‰å¥½ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„SpringBootå·¥ç¨‹ç»§æ‰¿spring-boot-starter-parentåå·²ç»å…·å¤‡ç‰ˆæœ¬é”å®šç­‰é…ç½®äº†ã€‚æ‰€ä»¥èµ·æ­¥ä¾èµ–çš„ä½œç”¨å°±æ˜¯è¿›è¡Œä¾èµ–çš„ä¼ é€’ã€‚ 3.1.2 åˆ†æspring-boot-starter-web æŒ‰ä½Ctrlç‚¹å‡»pom.xmlä¸­çš„spring-boot-starter-webï¼Œè·³è½¬åˆ°äº†spring-boot-starter-webçš„pom.xmlï¼Œxmlé…ç½®å¦‚ä¸‹ï¼ˆåªæ‘˜æŠ„äº†éƒ¨åˆ†é‡ç‚¹é…ç½®ï¼‰ï¼š &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;project xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot; xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;parent&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starters&lt;/artifactId&gt; &lt;version&gt;2.0.1.RELEASE&lt;/version&gt; &lt;/parent&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;version&gt;2.0.1.RELEASE&lt;/version&gt; &lt;name&gt;Spring Boot Web Starter&lt;/name&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt; &lt;version&gt;2.0.1.RELEASE&lt;/version&gt; &lt;scope&gt;compile&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-json&lt;/artifactId&gt; &lt;version&gt;2.0.1.RELEASE&lt;/version&gt; &lt;scope&gt;compile&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-tomcat&lt;/artifactId&gt; &lt;version&gt;2.0.1.RELEASE&lt;/version&gt; &lt;scope&gt;compile&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.hibernate.validator&lt;/groupId&gt; &lt;artifactId&gt;hibernate-validator&lt;/artifactId&gt; &lt;version&gt;6.0.9.Final&lt;/version&gt; &lt;scope&gt;compile&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-web&lt;/artifactId&gt; &lt;version&gt;5.0.5.RELEASE&lt;/version&gt; &lt;scope&gt;compile&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-webmvc&lt;/artifactId&gt; &lt;version&gt;5.0.5.RELEASE&lt;/version&gt; &lt;scope&gt;compile&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;/project&gt; ä»ä¸Šé¢çš„spring-boot-starter-webçš„pom.xmlä¸­æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œspring-boot-starter-webå°±æ˜¯å°†webå¼€å‘è¦ä½¿ç”¨çš„spring-webã€spring-webmvcç­‰åæ ‡è¿›è¡Œäº†â€œæ‰“åŒ…â€ï¼Œè¿™æ ·æˆ‘ä»¬çš„å·¥ç¨‹åªè¦å¼•å…¥spring-boot-starter-webèµ·æ­¥ä¾èµ–çš„åæ ‡å°±å¯ä»¥è¿›è¡Œwebå¼€å‘äº†ï¼ŒåŒæ ·ä½“ç°äº†ä¾èµ–ä¼ é€’çš„ä½œç”¨ã€‚ 3.2 è‡ªåŠ¨é…ç½®åŸç†è§£æ æŒ‰ä½Ctrlç‚¹å‡»æŸ¥çœ‹å¯åŠ¨ç±»MySpringBootApplicationä¸Šçš„æ³¨è§£@SpringBootApplication @SpringBootApplication public class MySpringBootApplication { public static void main(String[] args) { SpringApplication.run(MySpringBootApplication.class); } } æ³¨è§£@SpringBootApplicationçš„æºç  @Target(ElementType.TYPE) @Retention(RetentionPolicy.RUNTIME) @Documented @Inherited @SpringBootConfiguration @EnableAutoConfiguration @ComponentScan(excludeFilters = { @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class), @Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) }) public @interface SpringBootApplication { /** * Exclude specific auto-configuration classes such that they will never be applied. * @return the classes to exclude */ @AliasFor(annotation = EnableAutoConfiguration.class) Class&lt;?&gt;[] exclude() default {}; ... ... ... } @SpringBootConfigurationï¼šç­‰åŒä¸@Configurationï¼Œæ—¢æ ‡æ³¨è¯¥ç±»æ˜¯Springçš„ä¸€ä¸ªé…ç½®ç±» @EnableAutoConfigurationï¼šSpringBootè‡ªåŠ¨é…ç½®åŠŸèƒ½å¼€å¯ æŒ‰ä½Ctrlç‚¹å‡»æŸ¥çœ‹æ³¨è§£@EnableAutoConfiguration @Target(ElementType.TYPE) @Retention(RetentionPolicy.RUNTIME) @Documented @Inherited @AutoConfigurationPackage @Import(AutoConfigurationImportSelector.class) public @interface EnableAutoConfiguration { ... ... ... } @Import(AutoConfigurationImportSelector.class) å¯¼å…¥äº†AutoConfigurationImportSelectorç±» æŒ‰ä½Ctrlç‚¹å‡»æŸ¥çœ‹AutoConfigurationImportSelectoræºç  public String[] selectImports(AnnotationMetadata annotationMetadata) { ... ... ... List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata, attributes); configurations = removeDuplicates(configurations); Set&lt;String&gt; exclusions = getExclusions(annotationMetadata, attributes); checkExcludedClasses(configurations, exclusions); configurations.removeAll(exclusions); configurations = filter(configurations, autoConfigurationMetadata); fireAutoConfigurationImportEvents(configurations, exclusions); return StringUtils.toStringArray(configurations); } protected List&lt;String&gt; getCandidateConfigurations(AnnotationMetadata metadata, AnnotationAttributes attributes) { List&lt;String&gt; configurations = SpringFactoriesLoader.loadFactoryNames( getSpringFactoriesLoaderFactoryClass(), getBeanClassLoader()); return configurations; } SpringFactoriesLoader.loadFactoryNames æ–¹æ³•çš„ä½œç”¨å°±æ˜¯ä»META-INF/spring.factoriesæ–‡ä»¶ä¸­è¯»å–æŒ‡å®šç±»å¯¹åº”çš„ç±»åç§°åˆ—è¡¨ spring.factories æ–‡ä»¶ä¸­æœ‰å…³è‡ªåŠ¨é…ç½®çš„é…ç½®ä¿¡æ¯å¦‚ä¸‹ï¼š ... ... ... org.springframework.boot.autoconfigure.web.reactive.function.client.WebClientAutoConfiguration,\\ org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration,\\ org.springframework.boot.autoconfigure.web.servlet.ServletWebServerFactoryAutoConfiguration,\\ org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration,\\ org.springframework.boot.autoconfigure.web.servlet.HttpEncodingAutoConfiguration,\\ org.springframework.boot.autoconfigure.web.servlet.MultipartAutoConfiguration,\\ ... ... ... ä¸Šé¢é…ç½®æ–‡ä»¶å­˜åœ¨å¤§é‡çš„ä»¥Configurationä¸ºç»“å°¾çš„ç±»åç§°ï¼Œè¿™äº›ç±»å°±æ˜¯å­˜æœ‰è‡ªåŠ¨é…ç½®ä¿¡æ¯çš„ç±»ï¼Œè€ŒSpringApplicationåœ¨è·å–è¿™äº›ç±»ååå†åŠ è½½ æˆ‘ä»¬ä»¥ServletWebServerFactoryAutoConfigurationä¸ºä¾‹æ¥åˆ†ææºç ï¼š @Configuration @AutoConfigureOrder(Ordered.HIGHEST_PRECEDENCE) @ConditionalOnClass(ServletRequest.class) @ConditionalOnWebApplication(type = Type.SERVLET) @EnableConfigurationProperties(ServerProperties.class) @Import({ ServletWebServerFactoryAutoConfiguration.BeanPostProcessorsRegistrar.class, ServletWebServerFactoryConfiguration.EmbeddedTomcat.class, ServletWebServerFactoryConfiguration.EmbeddedJetty.class, ServletWebServerFactoryConfiguration.EmbeddedUndertow.class }) public class ServletWebServerFactoryAutoConfiguration { ... ... ... } @EnableConfigurationProperties(ServerProperties.class) ä»£è¡¨åŠ è½½ServerPropertiesæœåŠ¡å™¨é…ç½®å±æ€§ç±» è¿›å…¥ServerProperties.classæºç å¦‚ä¸‹ï¼š @ConfigurationProperties(prefix = &quot;server&quot;, ignoreUnknownFields = true) public class ServerProperties { /** * Server HTTP port. */ private Integer port; /** * Network address to which the server should bind. */ private InetAddress address; ... ... ... } prefix = &quot;server&quot; è¡¨ç¤ºSpringBooté…ç½®æ–‡ä»¶ä¸­çš„å‰ç¼€ï¼ŒSpringBootä¼šå°†é…ç½®æ–‡ä»¶ä¸­ä»¥serverå¼€å§‹çš„å±æ€§æ˜ å°„åˆ°è¯¥ç±»çš„å­—æ®µä¸­ã€‚æ˜ å°„å…³ç³»å¦‚ä¸‹ï¼š å››ã€SpringBootçš„é…ç½®æ–‡ä»¶ 4.1 SpringBooté…ç½®æ–‡ä»¶ç±»å‹ 4.1.1 SpringBooté…ç½®æ–‡ä»¶ç±»å‹å’Œä½œç”¨ SpringBootæ˜¯åŸºäºçº¦å®šçš„ï¼Œæ‰€ä»¥å¾ˆå¤šé…ç½®éƒ½æœ‰é»˜è®¤å€¼ï¼Œä½†å¦‚æœæƒ³ä½¿ç”¨è‡ªå·±çš„é…ç½®æ›¿æ¢é»˜è®¤é…ç½®çš„è¯ï¼Œå°±å¯ä»¥ä½¿ç”¨application.propertiesæˆ–è€…application.ymlï¼ˆapplication.yamlï¼‰è¿›è¡Œé…ç½®ã€‚ SpringBooté»˜è®¤ä¼šä»Resourcesç›®å½•ä¸‹åŠ è½½application.propertiesæˆ–application.ymlï¼ˆapplication.yamlï¼‰æ–‡ä»¶ å…¶ä¸­ï¼Œapplication.propertiesæ–‡ä»¶æ˜¯é”®å€¼å¯¹ç±»å‹çš„æ–‡ä»¶ï¼Œä¹‹å‰ä¸€ç›´åœ¨ä½¿ç”¨ï¼Œæ‰€ä»¥æ­¤å¤„ä¸åœ¨å¯¹propertiesæ–‡ä»¶çš„æ ¼å¼è¿›è¡Œé˜è¿°ã€‚é™¤äº†propertiesæ–‡ä»¶å¤–ï¼ŒSpringBootè¿˜å¯ä»¥ä½¿ç”¨ymlæ–‡ä»¶è¿›è¡Œé…ç½®ï¼Œä¸‹é¢å¯¹ymlæ–‡ä»¶è¿›è¡Œè®²è§£ã€‚ 4.1.2 application.ymlé…ç½®æ–‡ä»¶ 4.1.2.1 ymlé…ç½®æ–‡ä»¶ç®€ä»‹ YMLæ–‡ä»¶æ ¼å¼æ˜¯YAML (YAML Aint Markup Language)ç¼–å†™çš„æ–‡ä»¶æ ¼å¼ï¼ŒYAMLæ˜¯ä¸€ç§ç›´è§‚çš„èƒ½å¤Ÿè¢«ç”µè„‘è¯†åˆ«çš„çš„æ•°æ®æ•°æ®åºåˆ—åŒ–æ ¼å¼ï¼Œå¹¶ä¸”å®¹æ˜“è¢«äººç±»é˜…è¯»ï¼Œå®¹æ˜“å’Œè„šæœ¬è¯­è¨€äº¤äº’çš„ï¼Œå¯ä»¥è¢«æ”¯æŒYAMLåº“çš„ä¸åŒçš„ç¼–ç¨‹è¯­è¨€ç¨‹åºå¯¼å…¥ï¼Œæ¯”å¦‚ï¼š C/C++, Ruby, Python, Java, Perl, C#, PHPç­‰ã€‚YMLæ–‡ä»¶æ˜¯ä»¥æ•°æ®ä¸ºæ ¸å¿ƒçš„ï¼Œæ¯”ä¼ ç»Ÿçš„xmlæ–¹å¼æ›´åŠ ç®€æ´ã€‚ YMLæ–‡ä»¶çš„æ‰©å±•åå¯ä»¥ä½¿ç”¨.ymlæˆ–è€….yamlã€‚ 4.1.2.2 ymlé…ç½®æ–‡ä»¶çš„è¯­æ³• 4.1.2.2.1 é…ç½®æ™®é€šæ•°æ® è¯­æ³•ï¼š key: value ç¤ºä¾‹ä»£ç ï¼š name: haohao æ³¨æ„ï¼švalueä¹‹å‰æœ‰ä¸€ä¸ªç©ºæ ¼ 4.1.2.2.2 é…ç½®å¯¹è±¡æ•°æ® è¯­æ³•ï¼š â€‹ key: â€‹ key1: value1 â€‹ key2: value2 â€‹ æˆ–è€…ï¼š â€‹ key: {key1: value1,key2: value2} ç¤ºä¾‹ä»£ç ï¼š person: name: haohao age: 31 addr: beijing #æˆ–è€… person: {name: haohao,age: 31,addr: beijing} æ³¨æ„ï¼škey1å‰é¢çš„ç©ºæ ¼ä¸ªæ•°ä¸é™å®šï¼Œåœ¨ymlè¯­æ³•ä¸­ï¼Œç›¸åŒç¼©è¿›ä»£è¡¨åŒä¸€ä¸ªçº§åˆ« 4.1.2.2.3 é…ç½®æ•°ç»„ï¼ˆListã€Setï¼‰æ•°æ® è¯­æ³•ï¼š â€‹ key: â€‹ - value1 â€‹ - value2 æˆ–è€…ï¼š â€‹ key: [value1,value2] ç¤ºä¾‹ä»£ç ï¼š city: - beijing - tianjin - shanghai - chongqing #æˆ–è€… city: [beijing,tianjin,shanghai,chongqing] #é›†åˆä¸­çš„å…ƒç´ æ˜¯å¯¹è±¡å½¢å¼ student: - name: zhangsan age: 18 score: 100 - name: lisi age: 28 score: 88 - name: wangwu age: 38 score: 90 æ³¨æ„ï¼švalue1ä¸ä¹‹é—´çš„ - ä¹‹é—´å­˜åœ¨ä¸€ä¸ªç©ºæ ¼ 4.1.3 SpringBooté…ç½®ä¿¡æ¯çš„æŸ¥è¯¢ ä¸Šé¢æåŠè¿‡ï¼ŒSpringBootçš„é…ç½®æ–‡ä»¶ï¼Œä¸»è¦çš„ç›®çš„å°±æ˜¯å¯¹é…ç½®ä¿¡æ¯è¿›è¡Œä¿®æ”¹çš„ï¼Œä½†åœ¨é…ç½®æ—¶çš„keyä»å“ªé‡Œå»æŸ¥è¯¢å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥æŸ¥é˜…SpringBootçš„å®˜æ–¹æ–‡æ¡£,æ–‡æ¡£URLï¼šhttps://docs.spring.io/spring-boot/docs/2.0.1.RELEASE/reference/htmlsingle/#common-application-properties å¸¸ç”¨çš„é…ç½®æ‘˜æŠ„å¦‚ä¸‹ï¼š # QUARTZ SCHEDULER (QuartzProperties) spring.quartz.jdbc.initialize-schema=embedded # Database schema initialization mode. spring.quartz.jdbc.schema=classpath:org/quartz/impl/jdbcjobstore/tables_@@platform@@.sql # Path to the SQL file to use to initialize the database schema. spring.quartz.job-store-type=memory # Quartz job store type. spring.quartz.properties.*= # Additional Quartz Scheduler properties. # ---------------------------------------- # WEB PROPERTIES # ---------------------------------------- # EMBEDDED SERVER CONFIGURATION (ServerProperties) server.port=8080 # Server HTTP port. server.servlet.context-path= # Context path of the application. server.servlet.path=/ # Path of the main dispatcher servlet. # HTTP encoding (HttpEncodingProperties) spring.http.encoding.charset=UTF-8 # Charset of HTTP requests and responses. Added to the &quot;Content-Type&quot; header if not set explicitly. # JACKSON (JacksonProperties) spring.jackson.date-format= # Date format string or a fully-qualified date format class name. For instance, `yyyy-MM-dd HH:mm:ss`. # SPRING MVC (WebMvcProperties) spring.mvc.servlet.load-on-startup=-1 # Load on startup priority of the dispatcher servlet. spring.mvc.static-path-pattern=/** # Path pattern used for static resources. spring.mvc.view.prefix= # Spring MVC view prefix. spring.mvc.view.suffix= # Spring MVC view suffix. # DATASOURCE (DataSourceAutoConfiguration &amp; DataSourceProperties) spring.datasource.driver-class-name= # Fully qualified name of the JDBC driver. Auto-detected based on the URL by default. spring.datasource.password= # Login password of the database. spring.datasource.url= # JDBC URL of the database. spring.datasource.username= # Login username of the database. # JEST (Elasticsearch HTTP client) (JestProperties) spring.elasticsearch.jest.password= # Login password. spring.elasticsearch.jest.proxy.host= # Proxy host the HTTP client should use. spring.elasticsearch.jest.proxy.port= # Proxy port the HTTP client should use. spring.elasticsearch.jest.read-timeout=3s # Read timeout. spring.elasticsearch.jest.username= # Login username. æˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®application.poperties æˆ–è€… application.yml æ¥ä¿®æ”¹SpringBootçš„é»˜è®¤é…ç½® ä¾‹å¦‚ï¼š application.propertiesæ–‡ä»¶ server.port=8888 server.servlet.context-path=demo application.ymlæ–‡ä»¶ server: port: 8888 servlet: context-path: /demo 4.2 é…ç½®æ–‡ä»¶ä¸é…ç½®ç±»çš„å±æ€§æ˜ å°„æ–¹å¼ 4.2.1 ä½¿ç”¨æ³¨è§£@Valueæ˜ å°„ æˆ‘ä»¬å¯ä»¥é€šè¿‡@Valueæ³¨è§£å°†é…ç½®æ–‡ä»¶ä¸­çš„å€¼æ˜ å°„åˆ°ä¸€ä¸ªSpringç®¡ç†çš„Beançš„å­—æ®µä¸Š ä¾‹å¦‚ï¼š application.propertiesé…ç½®å¦‚ä¸‹ï¼š person: name: zhangsan age: 18 æˆ–è€…ï¼Œapplication.ymlé…ç½®å¦‚ä¸‹ï¼š person: name: zhangsan age: 18 å®ä½“Beanä»£ç å¦‚ä¸‹ï¼š @Controller public class QuickStartController { @Value(&quot;${person.name}&quot;) private String name; @Value(&quot;${person.age}&quot;) private Integer age; @RequestMapping(&quot;/quick&quot;) @ResponseBody public String quick(){ return &quot;springboot è®¿é—®æˆåŠŸ! name=&quot;+name+&quot;,age=&quot;+age; } } æµè§ˆå™¨è®¿é—®åœ°å€ï¼šhttp://localhost:8080/quick ç»“æœå¦‚ä¸‹ï¼š 4.2.2 ä½¿ç”¨æ³¨è§£@ConfigurationPropertiesæ˜ å°„ é€šè¿‡æ³¨è§£@ConfigurationProperties(prefix=&quot;é…ç½®æ–‡ä»¶ä¸­çš„keyçš„å‰ç¼€&quot;)å¯ä»¥å°†é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®è‡ªåŠ¨ä¸å®ä½“è¿›è¡Œæ˜ å°„ application.propertiesé…ç½®å¦‚ä¸‹ï¼š person: name: zhangsan age: 18 æˆ–è€…ï¼Œapplication.ymlé…ç½®å¦‚ä¸‹ï¼š person: name: zhangsan age: 18 å®ä½“Beanä»£ç å¦‚ä¸‹ï¼š @Controller @ConfigurationProperties(prefix = &quot;person&quot;) public class QuickStartController { private String name; private Integer age; @RequestMapping(&quot;/quick&quot;) @ResponseBody public String quick(){ return &quot;springboot è®¿é—®æˆåŠŸ! name=&quot;+name+&quot;,age=&quot;+age; } public void setName(String name) { this.name = name; } public void setAge(Integer age) { this.age = age; } } æµè§ˆå™¨è®¿é—®åœ°å€ï¼šhttp://localhost:8080/quick ç»“æœå¦‚ä¸‹ï¼š æ³¨æ„ï¼šä½¿ç”¨@ConfigurationPropertiesæ–¹å¼å¯ä»¥è¿›è¡Œé…ç½®æ–‡ä»¶ä¸å®ä½“å­—æ®µçš„è‡ªåŠ¨æ˜ å°„ï¼Œä½†éœ€è¦å­—æ®µå¿…é¡»æä¾›setæ–¹æ³•æ‰å¯ä»¥ï¼Œè€Œä½¿ç”¨@Valueæ³¨è§£ä¿®é¥°çš„å­—æ®µä¸éœ€è¦æä¾›setæ–¹æ³• äº”ã€SpringBootä¸æ•´åˆå…¶ä»–æŠ€æœ¯ 5.1 SpringBootæ•´åˆMybatis 5.1.1 æ·»åŠ Mybatisçš„èµ·æ­¥ä¾èµ– &lt;!--mybatisèµ·æ­¥ä¾èµ–--&gt; &lt;dependency&gt; &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt; &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt; &lt;version&gt;1.1.1&lt;/version&gt; &lt;/dependency&gt; 5.1.2 æ·»åŠ æ•°æ®åº“é©±åŠ¨åæ ‡ &lt;!-- MySQLè¿æ¥é©±åŠ¨ --&gt; &lt;dependency&gt; &lt;groupId&gt;mysql&lt;/groupId&gt; &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt; &lt;/dependency&gt; 5.1.3 æ·»åŠ æ•°æ®åº“è¿æ¥ä¿¡æ¯ åœ¨application.propertiesä¸­æ·»åŠ æ•°æ®é‡çš„è¿æ¥ä¿¡æ¯ #DB Configuration: spring.datasource.driverClassName=com.mysql.jdbc.Driver spring.datasource.url=jdbc:mysql://127.0.0.1:3306/test?useUnicode=true&amp;characterEncoding=utf8 spring.datasource.username=root spring.datasource.password=root 5.1.4 åˆ›å»ºuserè¡¨ åœ¨testæ•°æ®åº“ä¸­åˆ›å»ºuserè¡¨ -- ---------------------------- -- Table structure for `user` -- ---------------------------- DROP TABLE IF EXISTS `user`; CREATE TABLE `user` ( `id` int(11) NOT NULL AUTO_INCREMENT, `username` varchar(50) DEFAULT NULL, `password` varchar(50) DEFAULT NULL, `name` varchar(50) DEFAULT NULL, PRIMARY KEY (`id`) ) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=utf8; -- ---------------------------- -- Records of user -- ---------------------------- INSERT INTO `user` VALUES ('1', 'zhangsan', '123', 'å¼ ä¸‰'); INSERT INTO `user` VALUES ('2', 'lisi', '123', 'æå››'); 5.1.5 åˆ›å»ºå®ä½“Bean public class User { // ä¸»é”® private Long id; // ç”¨æˆ·å private String username; // å¯†ç  private String password; // å§“å private String name; //æ­¤å¤„çœç•¥getterå’Œsetteræ–¹æ³• .. .. } 5.1.6 ç¼–å†™Mapper @Mapper public interface UserMapper { public List&lt;User&gt; queryUserList(); } æ³¨æ„ï¼š@Mapperæ ‡è®°è¯¥ç±»æ˜¯ä¸€ä¸ªmybatisçš„mapperæ¥å£ï¼Œå¯ä»¥è¢«spring bootè‡ªåŠ¨æ‰«æåˆ°springä¸Šä¸‹æ–‡ä¸­ 5.1.7 é…ç½®Mapperæ˜ å°„æ–‡ä»¶ åœ¨src\\main\\resources\\mapperè·¯å¾„ä¸‹åŠ å…¥UserMapper.xmlé…ç½®æ–‡ä»¶&quot; &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt; &lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot; &gt; &lt;mapper namespace=&quot;com.itheima.mapper.UserMapper&quot;&gt; &lt;select id=&quot;queryUserList&quot; resultType=&quot;user&quot;&gt; select * from user &lt;/select&gt; &lt;/mapper&gt; 5.1.8 åœ¨application.propertiesä¸­æ·»åŠ mybatisçš„ä¿¡æ¯ #springé›†æˆMybatisç¯å¢ƒ #pojoåˆ«åæ‰«æåŒ… mybatis.type-aliases-package=com.itheima.domain #åŠ è½½Mybatisæ˜ å°„æ–‡ä»¶ mybatis.mapper-locations=classpath:mapper/*Mapper.xml 5.1.9 ç¼–å†™æµ‹è¯•Controller @Controller public class MapperController { @Autowired private UserMapper userMapper; @RequestMapping(&quot;/queryUser&quot;) @ResponseBody public List&lt;User&gt; queryUser(){ List&lt;User&gt; users = userMapper.queryUserList(); return users; } } 5.1.10 æµ‹è¯• 5.2 SpringBootæ•´åˆJunit 5.2.1 æ·»åŠ Junitçš„èµ·æ­¥ä¾èµ– &lt;!--æµ‹è¯•çš„èµ·æ­¥ä¾èµ–--&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; 5.2.2 ç¼–å†™æµ‹è¯•ç±» package com.itheima.test; import com.itheima.MySpringBootApplication; import com.itheima.domain.User; import com.itheima.mapper.UserMapper; import org.junit.Test; import org.junit.runner.RunWith; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.boot.test.context.SpringBootTest; import org.springframework.test.context.junit4.SpringRunner; import java.util.List; @RunWith(SpringRunner.class) @SpringBootTest(classes = MySpringBootApplication.class) public class MapperTest { @Autowired private UserMapper userMapper; @Test public void test() { List&lt;User&gt; users = userMapper.queryUserList(); System.out.println(users); } } å…¶ä¸­ï¼Œ SpringRunnerç»§æ‰¿è‡ªSpringJUnit4ClassRunnerï¼Œä½¿ç”¨å“ªä¸€ä¸ªSpringæä¾›çš„æµ‹è¯•æµ‹è¯•å¼•æ“éƒ½å¯ä»¥ public final class SpringRunner extends SpringJUnit4ClassRunner @SpringBootTestçš„å±æ€§æŒ‡å®šçš„æ˜¯å¼•å¯¼ç±»çš„å­—èŠ‚ç å¯¹è±¡ 5.2.3 æ§åˆ¶å°æ‰“å°ä¿¡æ¯ 5.3 SpringBootæ•´åˆSpring Data JPA 5.3.1 æ·»åŠ Spring Data JPAçš„èµ·æ­¥ä¾èµ– &lt;!-- springBoot JPAçš„èµ·æ­¥ä¾èµ– --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt; &lt;/dependency&gt; 5.3.2 æ·»åŠ æ•°æ®åº“é©±åŠ¨ä¾èµ– &lt;!-- MySQLè¿æ¥é©±åŠ¨ --&gt; &lt;dependency&gt; &lt;groupId&gt;mysql&lt;/groupId&gt; &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt; &lt;/dependency&gt; 5.3.3 åœ¨application.propertiesä¸­é…ç½®æ•°æ®åº“å’Œjpaçš„ç›¸å…³å±æ€§ #DB Configuration: spring.datasource.driverClassName=com.mysql.jdbc.Driver spring.datasource.url=jdbc:mysql://127.0.0.1:3306/test?useUnicode=true&amp;characterEncoding=utf8 spring.datasource.username=root spring.datasource.password=root #JPA Configuration: spring.jpa.database=MySQL spring.jpa.show-sql=true spring.jpa.generate-ddl=true spring.jpa.hibernate.ddl-auto=update spring.jpa.hibernate.naming_strategy=org.hibernate.cfg.ImprovedNamingStrategy 5.3.4 åˆ›å»ºå®ä½“é…ç½®å®ä½“ @Entity public class User { // ä¸»é”® @Id @GeneratedValue(strategy = GenerationType.IDENTITY) private Long id; // ç”¨æˆ·å private String username; // å¯†ç  private String password; // å§“å private String name; //æ­¤å¤„çœç•¥setterå’Œgetteræ–¹æ³•... ... } 5.3.5 ç¼–å†™UserRepository public interface UserRepository extends JpaRepository&lt;User,Long&gt;{ public List&lt;User&gt; findAll(); } 5.3.6 ç¼–å†™æµ‹è¯•ç±» @RunWith(SpringRunner.class) @SpringBootTest(classes=MySpringBootApplication.class) public class JpaTest { @Autowired private UserRepository userRepository; @Test public void test(){ List&lt;User&gt; users = userRepository.findAll(); System.out.println(users); } } 5.3.7 æ§åˆ¶å°æ‰“å°ä¿¡æ¯ æ³¨æ„ï¼šå¦‚æœæ˜¯jdk9ï¼Œæ‰§è¡ŒæŠ¥é”™å¦‚ä¸‹ï¼š åŸå› ï¼šjdkç¼ºå°‘ç›¸åº”çš„jar è§£å†³æ–¹æ¡ˆï¼šæ‰‹åŠ¨å¯¼å…¥å¯¹åº”çš„mavenåæ ‡ï¼Œå¦‚ä¸‹ï¼š &lt;!--jdk9éœ€è¦å¯¼å…¥å¦‚ä¸‹åæ ‡--&gt; &lt;dependency&gt; &lt;groupId&gt;javax.xml.bind&lt;/groupId&gt; &lt;artifactId&gt;jaxb-api&lt;/artifactId&gt; &lt;version&gt;2.3.0&lt;/version&gt; &lt;/dependency&gt; 5.4 SpringBootæ•´åˆRedis 5.4.1 æ·»åŠ redisçš„èµ·æ­¥ä¾èµ– &lt;!-- é…ç½®ä½¿ç”¨rediså¯åŠ¨å™¨ --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt; &lt;/dependency&gt; 5.4.2 é…ç½®redisçš„è¿æ¥ä¿¡æ¯ #Redis spring.redis.host=127.0.0.1 spring.redis.port=6379 5.4.3 æ³¨å…¥RedisTemplateæµ‹è¯•redisæ“ä½œ @RunWith(SpringRunner.class) @SpringBootTest(classes = SpringbootJpaApplication.class) public class RedisTest { @Autowired private UserRepository userRepository; @Autowired private RedisTemplate&lt;String, String&gt; redisTemplate; @Test public void test() throws JsonProcessingException { //ä»redisç¼“å­˜ä¸­è·å¾—æŒ‡å®šçš„æ•°æ® String userListData = redisTemplate.boundValueOps(&quot;user.findAll&quot;).get(); //å¦‚æœredisä¸­æ²¡æœ‰æ•°æ®çš„è¯ if(null==userListData){ //æŸ¥è¯¢æ•°æ®åº“è·å¾—æ•°æ® List&lt;User&gt; all = userRepository.findAll(); //è½¬æ¢æˆjsonæ ¼å¼å­—ç¬¦ä¸² ObjectMapper om = new ObjectMapper(); userListData = om.writeValueAsString(all); //å°†æ•°æ®å­˜å‚¨åˆ°redisä¸­ï¼Œä¸‹æ¬¡åœ¨æŸ¥è¯¢ç›´æ¥ä»redisä¸­è·å¾—æ•°æ®ï¼Œä¸ç”¨åœ¨æŸ¥è¯¢æ•°æ®åº“ redisTemplate.boundValueOps(&quot;user.findAll&quot;).set(userListData); System.out.println(&quot;===============ä»æ•°æ®åº“è·å¾—æ•°æ®===============&quot;); }else{ System.out.println(&quot;===============ä»redisç¼“å­˜ä¸­è·å¾—æ•°æ®===============&quot;); } System.out.println(userListData); } } ","link":"https://tianxiawuhao.github.io/RosSxJXYD/"},{"title":"SpringBootè‡ªåŠ¨è£…é…åŸç†","content":"SpringBootè‡ªåŠ¨é…ç½® ä»ä»£ç é‡Œçœ‹é¡¹ç›®SpringBootçš„é¡¹ç›®å¯åŠ¨ç±»åªæœ‰ä¸€ä¸ªæ³¨è§£@SpringBootApplicationå’Œä¸€ä¸ªrunæ–¹æ³•ã€‚ @SpringBootApplication public class Application { public static void main(String[] args) { SpringApplication.run(Application.class, args); } } ç›´æ¥çœ‹@SpringBootApplicationçš„ä»£ç ï¼š @Target({ElementType.TYPE}) @Retention(RetentionPolicy.RUNTIME) @Documented @Inherited @SpringBootConfiguration @EnableAutoConfiguration @ComponentScan( excludeFilters = {@Filter( type = FilterType.CUSTOM, classes = {TypeExcludeFilter.class} ), @Filter( type = FilterType.CUSTOM, classes = {AutoConfigurationExcludeFilter.class} )} ) public @interface SpringBootApplication { @AliasFor( annotation = EnableAutoConfiguration.class, attribute = &quot;exclude&quot; ) Class&lt;?&gt;[] exclude() default {}; @AliasFor( annotation = EnableAutoConfiguration.class, attribute = &quot;excludeName&quot; ) String[] excludeName() default {}; @AliasFor( annotation = ComponentScan.class, attribute = &quot;basePackages&quot; ) String[] scanBasePackages() default {}; @AliasFor( annotation = ComponentScan.class, attribute = &quot;basePackageClasses&quot; ) Class&lt;?&gt;[] scanBasePackageClasses() default {}; } @SpringBootApplicationï¼šåŒ…å«äº†@SpringBootConfigurationï¼ˆæ‰“å¼€æ˜¯@Configurationï¼‰ï¼Œ@EnableAutoConfigurationï¼Œ@ComponentScanæ³¨è§£ã€‚ @Configuration JavaConfigå½¢å¼çš„Spring Iocå®¹å™¨çš„é…ç½®ç±»ä½¿ç”¨çš„é‚£ä¸ª@Configurationï¼ŒSpringBootç¤¾åŒºæ¨èä½¿ç”¨åŸºäºJavaConfigçš„é…ç½®å½¢å¼ï¼Œæ‰€ä»¥ï¼Œè¿™é‡Œçš„å¯åŠ¨ç±»æ ‡æ³¨äº†@Configurationä¹‹åï¼Œæœ¬èº«å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªIoCå®¹å™¨çš„é…ç½®ç±»ã€‚ å¯¹æ¯”ä¸€ä¸‹ä¼ ç»ŸXMLæ–¹å¼å’Œconfigé…ç½®æ–¹å¼çš„åŒºåˆ«ï¼š XMLå£°æ˜å’Œå®šä¹‰é…ç½®æ–¹å¼ï¼š &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot; xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-3.0.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.0.xsd &quot;&gt; &lt;bean id=&quot;app&quot; class=&quot;com...&quot; /&gt; ç”¨ä¸€ä¸ªè¿‡æ»¤å™¨ä¸¾ä¾‹ï¼ŒJavaConfigçš„é…ç½®æ–¹å¼æ˜¯è¿™æ ·ï¼š @Configuration public class DruidConfiguration { @Bean public FilterRegistrationBean statFilter(){ //åˆ›å»ºè¿‡æ»¤å™¨ FilterRegistrationBean filterRegistrationBean = new FilterRegistrationBean(new WebStatFilter()); //è®¾ç½®è¿‡æ»¤å™¨è¿‡æ»¤è·¯å¾„ filterRegistrationBean.addUrlPatterns(&quot;/*&quot;); //å¿½ç•¥è¿‡æ»¤çš„å½¢å¼ filterRegistrationBean.addInitParameter(&quot;exclusions&quot;,&quot;*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*&quot;); return filterRegistrationBean; } } ä»»ä½•ä¸€ä¸ªæ ‡æ³¨äº†@Configurationçš„Javaç±»å®šä¹‰éƒ½æ˜¯ä¸€ä¸ªJavaConfigé…ç½®ç±»ã€‚ ä»»ä½•ä¸€ä¸ªæ ‡æ³¨äº†@Beançš„æ–¹æ³•ï¼Œå…¶è¿”å›å€¼å°†ä½œä¸ºä¸€ä¸ªbeanå®šä¹‰æ³¨å†Œåˆ°Springçš„IoCå®¹å™¨ï¼Œæ–¹æ³•åå°†é»˜è®¤æˆè¯¥beanå®šä¹‰çš„idã€‚ @ComponentScan @ComponentScanå¯¹åº”XMLé…ç½®ä¸­çš„å…ƒç´ ï¼Œ@ComponentScançš„åŠŸèƒ½å…¶å®å°±æ˜¯è‡ªåŠ¨æ‰«æå¹¶åŠ è½½ç¬¦åˆæ¡ä»¶çš„ç»„ä»¶ï¼ˆæ¯”å¦‚@Componentå’Œ@Repositoryç­‰ï¼‰æˆ–è€…beanå®šä¹‰ï¼Œæœ€ç»ˆå°†è¿™äº›beanå®šä¹‰åŠ è½½åˆ°IoCå®¹å™¨ä¸­ã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡basePackagesç­‰å±æ€§æ¥ç»†ç²’åº¦çš„å®šåˆ¶@ComponentScanè‡ªåŠ¨æ‰«æçš„èŒƒå›´ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œåˆ™é»˜è®¤Springæ¡†æ¶å®ç°ä¼šä»å£°æ˜@ComponentScanæ‰€åœ¨ç±»çš„packageè¿›è¡Œæ‰«æã€‚ æ³¨ï¼šæ‰€ä»¥SpringBootçš„å¯åŠ¨ç±»æœ€å¥½æ˜¯æ”¾åœ¨root packageä¸‹ï¼Œå› ä¸ºé»˜è®¤ä¸æŒ‡å®šbasePackagesã€‚ @EnableAutoConfiguration ï¼ˆæ ¸å¿ƒå†…å®¹ï¼‰çœ‹è‹±æ–‡æ„æ€å°±æ˜¯è‡ªåŠ¨é…ç½®ï¼Œæ¦‚æ‹¬ä¸€ä¸‹å°±æ˜¯ï¼Œå€ŸåŠ©@Importçš„å¸®åŠ©ï¼Œå°†æ‰€æœ‰ç¬¦åˆè‡ªåŠ¨é…ç½®æ¡ä»¶çš„beanå®šä¹‰åŠ è½½åˆ°IoCå®¹å™¨ã€‚ @Target({ElementType.TYPE}) @Retention(RetentionPolicy.RUNTIME) @Documented @Inherited @AutoConfigurationPackage @Import({EnableAutoConfigurationImportSelector.class}) public @interface EnableAutoConfiguration { String ENABLED_OVERRIDE_PROPERTY = &quot;spring.boot.enableautoconfiguration&quot;; Class&lt;?&gt;[] exclude() default {}; String[] excludeName() default {}; } é‡Œé¢æœ€å…³é”®çš„æ˜¯@Import(EnableAutoConfigurationImportSelector.class)ï¼Œå€ŸåŠ©EnableAutoConfigurationImportSelectorï¼Œ@EnableAutoConfigurationå¯ä»¥å¸®åŠ©SpringBootåº”ç”¨å°†æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„@Configurationé…ç½®éƒ½åŠ è½½åˆ°å½“å‰SpringBootåˆ›å»ºå¹¶ä½¿ç”¨çš„IoCå®¹å™¨ã€‚è¯¥é…ç½®æ¨¡å—çš„ä¸»è¦ä½¿ç”¨åˆ°äº†SpringFactoriesLoaderã€‚ SpringFactoriesLoaderè¯¦è§£ SpringFactoriesLoaderä¸ºSpringå·¥å‚åŠ è½½å™¨ï¼Œè¯¥å¯¹è±¡æä¾›äº†loadFactoryNamesæ–¹æ³•ï¼Œå…¥å‚ä¸ºfactoryClasså’ŒclassLoaderå³éœ€è¦ä¼ å…¥å·¥å‚ç±»åç§°å’Œå¯¹åº”çš„ç±»åŠ è½½å™¨ï¼Œæ–¹æ³•ä¼šæ ¹æ®æŒ‡å®šçš„classLoaderï¼ŒåŠ è½½è¯¥ç±»åŠ å™¨æœç´¢è·¯å¾„ä¸‹çš„æŒ‡å®šæ–‡ä»¶ï¼Œå³spring.factoriesæ–‡ä»¶ï¼Œä¼ å…¥çš„å·¥å‚ç±»ä¸ºæ¥å£ï¼Œè€Œæ–‡ä»¶ä¸­å¯¹åº”çš„ç±»åˆ™æ˜¯æ¥å£çš„å®ç°ç±»ï¼Œæˆ–æœ€ç»ˆä½œä¸ºå®ç°ç±»ã€‚ public abstract class SpringFactoriesLoader { private static final Log logger = LogFactory.getLog(SpringFactoriesLoader.class); public static final String FACTORIES_RESOURCE_LOCATION = &quot;META-INF/spring.factories&quot;; public SpringFactoriesLoader() { } public static &lt;T&gt; List&lt;T&gt; loadFactories(Class&lt;T&gt; factoryClass, ClassLoader classLoader) { Assert.notNull(factoryClass, &quot;'factoryClass' must not be null&quot;); ClassLoader classLoaderToUse = classLoader; if (classLoader == null) { classLoaderToUse = SpringFactoriesLoader.class.getClassLoader(); } List&lt;String&gt; factoryNames = loadFactoryNames(factoryClass, classLoaderToUse); if (logger.isTraceEnabled()) { logger.trace(&quot;Loaded [&quot; + factoryClass.getName() + &quot;] names: &quot; + factoryNames); } List&lt;T&gt; result = new ArrayList(factoryNames.size()); Iterator var5 = factoryNames.iterator(); while(var5.hasNext()) { String factoryName = (String)var5.next(); result.add(instantiateFactory(factoryName, factoryClass, classLoaderToUse)); } AnnotationAwareOrderComparator.sort(result); return result; } public static List&lt;String&gt; loadFactoryNames(Class&lt;?&gt; factoryClass, ClassLoader classLoader) { String factoryClassName = factoryClass.getName(); try { Enumeration&lt;URL&gt; urls = classLoader != null ? classLoader.getResources(&quot;META-INF/spring.factories&quot;) : ClassLoader.getSystemResources(&quot;META-INF/spring.factories&quot;); ArrayList result = new ArrayList(); while(urls.hasMoreElements()) { URL url = (URL)urls.nextElement(); Properties properties = PropertiesLoaderUtils.loadProperties(new UrlResource(url)); String factoryClassNames = properties.getProperty(factoryClassName); result.addAll(Arrays.asList(StringUtils.commaDelimitedListToStringArray(factoryClassNames))); } return result; } catch (IOException var8) { throw new IllegalArgumentException(&quot;Unable to load [&quot; + factoryClass.getName() + &quot;] factories from location [&quot; + &quot;META-INF/spring.factories&quot; + &quot;]&quot;, var8); } } private static &lt;T&gt; T instantiateFactory(String instanceClassName, Class&lt;T&gt; factoryClass, ClassLoader classLoader) { try { Class&lt;?&gt; instanceClass = ClassUtils.forName(instanceClassName, classLoader); if (!factoryClass.isAssignableFrom(instanceClass)) { throw new IllegalArgumentException(&quot;Class [&quot; + instanceClassName + &quot;] is not assignable to [&quot; + factoryClass.getName() + &quot;]&quot;); } else { Constructor&lt;?&gt; constructor = instanceClass.getDeclaredConstructor(); ReflectionUtils.makeAccessible(constructor); return constructor.newInstance(); } } catch (Throwable var5) { throw new IllegalArgumentException(&quot;Unable to instantiate factory class: &quot; + factoryClass.getName(), var5); } } } æ‰€ä»¥æ–‡ä»¶ä¸­ä¸€èˆ¬ä¸ºå¦‚ä¸‹å›¾è¿™ç§ä¸€å¯¹å¤šçš„ç±»åé›†åˆï¼Œè·å–åˆ°è¿™äº›å®ç°ç±»çš„ç±»ååï¼ŒloadFactoryNamesæ–¹æ³•è¿”å›ç±»åé›†åˆï¼Œæ–¹æ³•è°ƒç”¨æ–¹å¾—åˆ°è¿™äº›é›†åˆåï¼Œå†é€šè¿‡åå°„è·å–è¿™äº›ç±»çš„ç±»å¯¹è±¡ã€æ„é€ æ–¹æ³•ï¼Œæœ€ç»ˆç”Ÿæˆå®ä¾‹ã€‚ ä¸‹å›¾æœ‰åŠ©äºæˆ‘ä»¬å½¢è±¡ç†è§£è‡ªåŠ¨é…ç½®æµç¨‹ï¼ˆç›—ä¸ªå›¾ï¼‰ AutoConfigurationImportSelector ç»§ç»­ä¸Šé¢è®²çš„AutoConfigurationImportSelector.classã€‚è¯¥ç±»ä¸»è¦å…³æ³¨selectImportsæ–¹æ³• public String[] selectImports(AnnotationMetadata annotationMetadata) { if (!this.isEnabled(annotationMetadata)) { return NO_IMPORTS; } else { try { AutoConfigurationMetadata autoConfigurationMetadata = AutoConfigurationMetadataLoader.loadMetadata(this.beanClassLoader); AnnotationAttributes attributes = this.getAttributes(annotationMetadata); List&lt;String&gt; configurations = this.getCandidateConfigurations(annotationMetadata, attributes); configurations = this.removeDuplicates(configurations); configurations = this.sort(configurations, autoConfigurationMetadata); Set&lt;String&gt; exclusions = this.getExclusions(annotationMetadata, attributes); this.checkExcludedClasses(configurations, exclusions); configurations.removeAll(exclusions); configurations = this.filter(configurations, autoConfigurationMetadata); this.fireAutoConfigurationImportEvents(configurations, exclusions); return (String[])configurations.toArray(new String[configurations.size()]); } catch (IOException var6) { throw new IllegalStateException(var6); } } } è¯¥æ–¹æ³•åœ¨springbootå¯åŠ¨æµç¨‹â€”â€”beanå®ä¾‹åŒ–å‰è¢«æ‰§è¡Œï¼Œè¿”å›è¦å®ä¾‹åŒ–çš„ç±»ä¿¡æ¯åˆ—è¡¨ã€‚å¦‚æœè·å–åˆ°ç±»ä¿¡æ¯ï¼Œspringå¯ä»¥é€šè¿‡ç±»åŠ è½½å™¨å°†ç±»åŠ è½½åˆ°jvmä¸­ï¼Œç°åœ¨æˆ‘ä»¬å·²ç»é€šè¿‡spring-bootçš„starterä¾èµ–æ–¹å¼ä¾èµ–äº†æˆ‘ä»¬éœ€è¦çš„ç»„ä»¶ï¼Œé‚£ä¹ˆè¿™äº›ç»„ä»¶çš„ç±»ä¿¡æ¯åœ¨selectæ–¹æ³•ä¸­å°±å¯ä»¥è¢«è·å–åˆ°ã€‚ protected List&lt;String&gt; getCandidateConfigurations(AnnotationMetadata metadata, AnnotationAttributes attributes) { List&lt;String&gt; configurations = SpringFactoriesLoader.loadFactoryNames(this.getSpringFactoriesLoaderFactoryClass(), this.getBeanClassLoader()); Assert.notEmpty(configurations, &quot;No auto configuration classes found in META-INF/spring.factories. If you are using a custom packaging, make sure that file is correct.&quot;); return configurations; } æ–¹æ³•ä¸­çš„getCandidateConfigurationsæ–¹æ³•ï¼Œå…¶è¿”å›ä¸€ä¸ªè‡ªåŠ¨é…ç½®ç±»çš„ç±»ååˆ—è¡¨ï¼Œæ–¹æ³•è°ƒç”¨äº†loadFactoryNamesæ–¹æ³•ï¼ŒæŸ¥çœ‹è¯¥æ–¹æ³• public static List&lt;String&gt; loadFactoryNames(Class&lt;?&gt; factoryClass, ClassLoader classLoader) { String factoryClassName = factoryClass.getName(); try { Enumeration&lt;URL&gt; urls = classLoader != null ? classLoader.getResources(&quot;META-INF/spring.factories&quot;) : ClassLoader.getSystemResources(&quot;META-INF/spring.factories&quot;); ArrayList result = new ArrayList(); while(urls.hasMoreElements()) { URL url = (URL)urls.nextElement(); Properties properties = PropertiesLoaderUtils.loadProperties(new UrlResource(url)); String factoryClassNames = properties.getProperty(factoryClassName); result.addAll(Arrays.asList(StringUtils.commaDelimitedListToStringArray(factoryClassNames))); } return result; } catch (IOException var8) { throw new IllegalArgumentException(&quot;Unable to load [&quot; + factoryClass.getName() + &quot;] factories from location [&quot; + &quot;META-INF/spring.factories&quot; + &quot;]&quot;, var8); } } è‡ªåŠ¨é…ç½®å™¨ä¼šè·Ÿæ ¹æ®ä¼ å…¥çš„factoryClass.getName()åˆ°é¡¹ç›®ç³»ç»Ÿè·¯å¾„ä¸‹æ‰€æœ‰çš„spring.factoriesæ–‡ä»¶ä¸­æ‰¾åˆ°ç›¸åº”çš„keyï¼Œä»è€ŒåŠ è½½é‡Œé¢çš„ç±»ã€‚æˆ‘ä»¬å°±é€‰å–è¿™ä¸ªmybatis-spring-boot-autoconfigureä¸‹çš„spring.factoriesæ–‡ä»¶ Auto Configure org.springframework.boot.autoconfigure.EnableAutoConfiguration= org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration è¿›å…¥org.mybatis.spring.boot.autoconfigure.MybatisAutoConfigurationä¸­ï¼Œåˆæ˜¯ä¸€å †æ³¨è§£ @org.springframework.context.annotation.Configuration @ConditionalOnClass({SqlSessionFactory.class, SqlSessionFactoryBean.class}) @ConditionalOnBean({DataSource.class}) @EnableConfigurationProperties({MybatisProperties.class}) @AutoConfigureAfter({DataSourceAutoConfiguration.class}) public class MybatisAutoConfiguration { private static final Logger logger = LoggerFactory.getLogger(MybatisAutoConfiguration.class); private final MybatisProperties properties; private final Interceptor[] interceptors; private final ResourceLoader resourceLoader; private final DatabaseIdProvider databaseIdProvider; private final List&lt;ConfigurationCustomizer&gt; configurationCustomizers; @Configurationæ˜¯ä¸€ä¸ªé€šè¿‡æ³¨è§£æ ‡æ³¨çš„springBeanï¼Œ @ConditionalOnClass({ SqlSessionFactory.class, SqlSessionFactoryBean.class})è¿™ä¸ªæ³¨è§£çš„æ„æ€æ˜¯ï¼šå½“å­˜åœ¨SqlSessionFactory.class, SqlSessionFactoryBean.classè¿™ä¸¤ä¸ªç±»æ—¶æ‰è§£æMybatisAutoConfigurationé…ç½®ç±»,å¦åˆ™ä¸è§£æè¿™ä¸€ä¸ªé…ç½®ç±»ã€‚æˆ‘ä»¬éœ€è¦mybatisä¸ºæˆ‘ä»¬è¿”å›ä¼šè¯å¯¹è±¡ï¼Œå°±å¿…é¡»æœ‰ä¼šè¯å·¥å‚ç›¸å…³ç±» @CondtionalOnBean(DataSource.class)åªå¤„ç†å·²ç»è¢«å£°æ˜ä¸ºbeançš„dataSource @ConditionalOnMissingBean(MapperFactoryBean.class)è¿™ä¸ªæ³¨è§£çš„æ„æ€æ˜¯å¦‚æœå®¹å™¨ä¸­ä¸å­˜åœ¨nameæŒ‡å®šçš„beanåˆ™åˆ›å»ºbeanæ³¨å…¥ï¼Œå¦åˆ™ä¸æ‰§è¡Œä»¥ä¸Šé…ç½®å¯ä»¥ä¿è¯sqlSessionFactoryã€sqlSessionTemplateã€dataSourceç­‰mybatisæ‰€éœ€çš„ç»„ä»¶å‡å¯è¢«è‡ªåŠ¨é…ç½®ï¼Œ@Configurationæ³¨è§£å·²ç»æä¾›äº†Springçš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œæ‰€ä»¥ä»¥ä¸Šç»„ä»¶çš„é…ç½®æ–¹å¼ä¸Springå¯åŠ¨æ—¶é€šè¿‡mybatis.xmlæ–‡ä»¶è¿›è¡Œé…ç½®èµ·åˆ°ä¸€ä¸ªæ•ˆæœã€‚ åªè¦ä¸€ä¸ªåŸºäºSpringBooté¡¹ç›®çš„ç±»è·¯å¾„ä¸‹å­˜åœ¨SqlSessionFactory.class, SqlSessionFactoryBean.classï¼Œå¹¶ä¸”å®¹å™¨ä¸­å·²ç»æ³¨å†Œäº†dataSourceBeanï¼Œå°±å¯ä»¥è§¦å‘è‡ªåŠ¨åŒ–é…ç½®ï¼Œæ„æ€è¯´æˆ‘ä»¬åªè¦åœ¨mavençš„é¡¹ç›®ä¸­åŠ å…¥äº†mybatisæ‰€éœ€è¦çš„è‹¥å¹²ä¾èµ–ï¼Œå°±å¯ä»¥è§¦å‘è‡ªåŠ¨é…ç½®ï¼Œä½†å¼•å…¥mybatisåŸç”Ÿä¾èµ–çš„è¯ï¼Œæ¯é›†æˆä¸€ä¸ªåŠŸèƒ½éƒ½è¦å»ä¿®æ”¹å…¶è‡ªåŠ¨åŒ–é…ç½®ç±»ï¼Œé‚£å°±å¾—ä¸åˆ°å¼€ç®±å³ç”¨çš„æ•ˆæœäº†ã€‚æ‰€ä»¥Spring-bootä¸ºæˆ‘ä»¬æä¾›äº†ç»Ÿä¸€çš„starterå¯ä»¥ç›´æ¥é…ç½®å¥½ç›¸å…³çš„ç±»ï¼Œè§¦å‘è‡ªåŠ¨é…ç½®æ‰€éœ€çš„ä¾èµ–(mybatis)å¦‚ä¸‹ï¼š &lt;dependency&gt; &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt; &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt; &lt;/dependency&gt; å› ä¸ºmavenä¾èµ–çš„ä¼ é€’æ€§ï¼Œæˆ‘ä»¬åªè¦ä¾èµ–starterå°±å¯ä»¥ä¾èµ–åˆ°æ‰€æœ‰éœ€è¦è‡ªåŠ¨é…ç½®çš„ç±»ï¼Œå®ç°å¼€ç®±å³ç”¨çš„åŠŸèƒ½ã€‚ä¹Ÿä½“ç°å‡ºSpringbootç®€åŒ–äº†Springæ¡†æ¶å¸¦æ¥çš„å¤§é‡XMLé…ç½®ä»¥åŠå¤æ‚çš„ä¾èµ–ç®¡ç†ï¼Œè®©å¼€å‘äººå‘˜å¯ä»¥æ›´åŠ å…³æ³¨ä¸šåŠ¡é€»è¾‘çš„å¼€å‘ã€‚ å†è´´ä¸ªç›—çš„å›¾SpringBootçš„å¯åŠ¨ç»“æ„å›¾ ","link":"https://tianxiawuhao.github.io/YkvDN4zR3/"},{"title":"mysqlæ¦‚è¿°å…­","content":"æ•°æ®åº“ä¼˜åŒ– ä¸ºä»€ä¹ˆè¦ä¼˜åŒ– ç³»ç»Ÿçš„ååé‡ç“¶é¢ˆå¾€å¾€å‡ºç°åœ¨æ•°æ®åº“çš„è®¿é—®é€Ÿåº¦ä¸Š éšç€åº”ç”¨ç¨‹åºçš„è¿è¡Œï¼Œæ•°æ®åº“çš„ä¸­çš„æ•°æ®ä¼šè¶Šæ¥è¶Šå¤šï¼Œå¤„ç†æ—¶é—´ä¼šç›¸åº”å˜æ…¢ æ•°æ®æ˜¯å­˜æ”¾åœ¨ç£ç›˜ä¸Šçš„ï¼Œè¯»å†™é€Ÿåº¦æ— æ³•å’Œå†…å­˜ç›¸æ¯” ä¼˜åŒ–åŸåˆ™ï¼šå‡å°‘ç³»ç»Ÿç“¶é¢ˆï¼Œå‡å°‘èµ„æºå ç”¨ï¼Œå¢åŠ ç³»ç»Ÿçš„ååº”é€Ÿåº¦ã€‚ æ•°æ®åº“ç»“æ„ä¼˜åŒ– ä¸€ä¸ªå¥½çš„æ•°æ®åº“è®¾è®¡æ–¹æ¡ˆå¯¹äºæ•°æ®åº“çš„æ€§èƒ½å¾€å¾€ä¼šèµ·åˆ°äº‹åŠåŠŸå€çš„æ•ˆæœã€‚éœ€è¦è€ƒè™‘æ•°æ®å†—ä½™ã€æŸ¥è¯¢å’Œæ›´æ–°çš„é€Ÿåº¦ã€å­—æ®µçš„æ•°æ®ç±»å‹æ˜¯å¦åˆç†ç­‰å¤šæ–¹é¢çš„å†…å®¹ã€‚ å°†å­—æ®µå¾ˆå¤šçš„è¡¨åˆ†è§£æˆå¤šä¸ªè¡¨ å¯¹äºå­—æ®µè¾ƒå¤šçš„è¡¨ï¼Œå¦‚æœæœ‰äº›å­—æ®µçš„ä½¿ç”¨é¢‘ç‡å¾ˆä½ï¼Œå¯ä»¥å°†è¿™äº›å­—æ®µåˆ†ç¦»å‡ºæ¥å½¢æˆæ–°è¡¨ã€‚å› ä¸ºå½“ä¸€ä¸ªè¡¨çš„æ•°æ®é‡å¾ˆå¤§æ—¶ï¼Œä¼šç”±äºä½¿ç”¨é¢‘ç‡ä½çš„å­—æ®µçš„å­˜åœ¨è€Œå˜æ…¢ã€‚ å¢åŠ ä¸­é—´è¡¨ å¯¹äºéœ€è¦ç»å¸¸è”åˆæŸ¥è¯¢çš„è¡¨ï¼Œå¯ä»¥å»ºç«‹ä¸­é—´è¡¨ä»¥æé«˜æŸ¥è¯¢æ•ˆç‡ã€‚é€šè¿‡å»ºç«‹ä¸­é—´è¡¨ï¼Œå°†éœ€è¦é€šè¿‡è”åˆæŸ¥è¯¢çš„æ•°æ®æ’å…¥åˆ°ä¸­é—´è¡¨ä¸­ï¼Œç„¶åå°†åŸæ¥çš„è”åˆæŸ¥è¯¢æ”¹ä¸ºå¯¹ä¸­é—´è¡¨çš„æŸ¥è¯¢ã€‚ å¢åŠ å†—ä½™å­—æ®µ è®¾è®¡æ•°æ®è¡¨æ—¶åº”å°½é‡éµå¾ªèŒƒå¼ç†è®ºçš„è§„çº¦ï¼Œå°½å¯èƒ½çš„å‡å°‘å†—ä½™å­—æ®µï¼Œè®©æ•°æ®åº“è®¾è®¡çœ‹èµ·æ¥ç²¾è‡´ã€ä¼˜é›…ã€‚ä½†æ˜¯ï¼Œåˆç†çš„åŠ å…¥å†—ä½™å­—æ®µå¯ä»¥æé«˜æŸ¥è¯¢é€Ÿåº¦ã€‚è¡¨çš„è§„èŒƒåŒ–ç¨‹åº¦è¶Šé«˜ï¼Œè¡¨å’Œè¡¨ä¹‹é—´çš„å…³ç³»è¶Šå¤šï¼Œéœ€è¦è¿æ¥æŸ¥è¯¢çš„æƒ…å†µä¹Ÿå°±è¶Šå¤šï¼Œæ€§èƒ½ä¹Ÿå°±è¶Šå·®ã€‚ æ³¨æ„ï¼šå†—ä½™å­—æ®µçš„å€¼åœ¨ä¸€ä¸ªè¡¨ä¸­ä¿®æ”¹äº†ï¼Œå°±è¦æƒ³åŠæ³•åœ¨å…¶ä»–è¡¨ä¸­æ›´æ–°ï¼Œå¦åˆ™å°±ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚ MySQLæ•°æ®åº“cpué£™æ»¡çš„è¯æ€ä¹ˆå¤„ç† å½“ cpu é£™æ»¡æ—¶ï¼Œå…ˆç”¨æ“ä½œç³»ç»Ÿå‘½ä»¤ top å‘½ä»¤è§‚å¯Ÿæ˜¯ä¸æ˜¯ mysqld å ç”¨å¯¼è‡´çš„ï¼Œå¦‚æœä¸æ˜¯ï¼Œæ‰¾å‡ºå ç”¨é«˜çš„è¿›ç¨‹ï¼Œå¹¶è¿›è¡Œç›¸å…³å¤„ç†ã€‚ å¦‚æœæ˜¯ mysqld é€ æˆçš„ï¼Œ show processlistï¼Œçœ‹çœ‹é‡Œé¢è·‘çš„ session æƒ…å†µï¼Œæ˜¯ä¸æ˜¯æœ‰æ¶ˆè€—èµ„æºçš„ sql åœ¨è¿è¡Œã€‚æ‰¾å‡ºæ¶ˆè€—é«˜çš„ sqlï¼Œçœ‹çœ‹æ‰§è¡Œè®¡åˆ’æ˜¯å¦å‡†ç¡®ï¼Œ index æ˜¯å¦ç¼ºå¤±ï¼Œæˆ–è€…å®åœ¨æ˜¯æ•°æ®é‡å¤ªå¤§é€ æˆã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œè‚¯å®šè¦ kill æ‰è¿™äº›çº¿ç¨‹(åŒæ—¶è§‚å¯Ÿ cpu ä½¿ç”¨ç‡æ˜¯å¦ä¸‹é™)ï¼Œç­‰è¿›è¡Œç›¸åº”çš„è°ƒæ•´(æ¯”å¦‚è¯´åŠ ç´¢å¼•ã€æ”¹ sqlã€æ”¹å†…å­˜å‚æ•°)ä¹‹åï¼Œå†é‡æ–°è·‘è¿™äº› SQLã€‚ ä¹Ÿæœ‰å¯èƒ½æ˜¯æ¯ä¸ª sql æ¶ˆè€—èµ„æºå¹¶ä¸å¤šï¼Œä½†æ˜¯çªç„¶ä¹‹é—´ï¼Œæœ‰å¤§é‡çš„ session è¿è¿›æ¥å¯¼è‡´ cpu é£™å‡ï¼Œè¿™ç§æƒ…å†µå°±éœ€è¦è·Ÿåº”ç”¨ä¸€èµ·æ¥åˆ†æä¸ºä½•è¿æ¥æ•°ä¼šæ¿€å¢ï¼Œå†åšå‡ºç›¸åº”çš„è°ƒæ•´ï¼Œæ¯”å¦‚è¯´é™åˆ¶è¿æ¥æ•°ç­‰ å¤§è¡¨ä¼˜åŒ– å½“MySQLå•è¡¨è®°å½•æ•°è¿‡å¤§æ—¶ï¼Œæ•°æ®åº“çš„CRUDæ€§èƒ½ä¼šæ˜æ˜¾ä¸‹é™ï¼Œä¸€äº›å¸¸è§çš„ä¼˜åŒ–æªæ–½å¦‚ä¸‹ï¼š é™å®šæ•°æ®çš„èŒƒå›´ï¼š åŠ¡å¿…ç¦æ­¢ä¸å¸¦ä»»ä½•é™åˆ¶æ•°æ®èŒƒå›´æ¡ä»¶çš„æŸ¥è¯¢è¯­å¥ã€‚æ¯”å¦‚ï¼šæˆ‘ä»¬å½“ç”¨æˆ·åœ¨æŸ¥è¯¢è®¢å•å†å²çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶åœ¨ä¸€ä¸ªæœˆçš„èŒƒå›´å†…ã€‚ï¼› è¯»/å†™åˆ†ç¦»ï¼š ç»å…¸çš„æ•°æ®åº“æ‹†åˆ†æ–¹æ¡ˆï¼Œä¸»åº“è´Ÿè´£å†™ï¼Œä»åº“è´Ÿè´£è¯»ï¼› ç¼“å­˜ï¼š ä½¿ç”¨MySQLçš„ç¼“å­˜ï¼Œå¦å¤–å¯¹é‡é‡çº§ã€æ›´æ–°å°‘çš„æ•°æ®å¯ä»¥è€ƒè™‘ä½¿ç”¨åº”ç”¨çº§åˆ«çš„ç¼“å­˜ï¼› è¿˜æœ‰å°±æ˜¯é€šè¿‡åˆ†åº“åˆ†è¡¨çš„æ–¹å¼è¿›è¡Œä¼˜åŒ–ï¼Œä¸»è¦æœ‰å‚ç›´åˆ†è¡¨å’Œæ°´å¹³åˆ†è¡¨ å‚ç›´åˆ†è¡¨ï¼š æ ¹æ®æ•°æ®åº“é‡Œé¢æ•°æ®è¡¨çš„ç›¸å…³æ€§è¿›è¡Œæ‹†åˆ†ã€‚ ä¾‹å¦‚ï¼Œç”¨æˆ·è¡¨ä¸­æ—¢æœ‰ç”¨æˆ·çš„ç™»å½•ä¿¡æ¯åˆæœ‰ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ï¼Œå¯ä»¥å°†ç”¨æˆ·è¡¨æ‹†åˆ†æˆä¸¤ä¸ªå•ç‹¬çš„è¡¨ï¼Œç”šè‡³æ”¾åˆ°å•ç‹¬çš„åº“åšåˆ†åº“ã€‚ ç®€å•æ¥è¯´å‚ç›´æ‹†åˆ†æ˜¯æŒ‡æ•°æ®è¡¨åˆ—çš„æ‹†åˆ†ï¼ŒæŠŠä¸€å¼ åˆ—æ¯”è¾ƒå¤šçš„è¡¨æ‹†åˆ†ä¸ºå¤šå¼ è¡¨ã€‚ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¿™æ ·æ¥è¯´å¤§å®¶åº”è¯¥å°±æ›´å®¹æ˜“ç†è§£äº†ã€‚ å‚ç›´æ‹†åˆ†çš„ä¼˜ç‚¹ï¼š å¯ä»¥ä½¿å¾—è¡Œæ•°æ®å˜å°ï¼Œåœ¨æŸ¥è¯¢æ—¶å‡å°‘è¯»å–çš„Blockæ•°ï¼Œå‡å°‘I/Oæ¬¡æ•°ã€‚æ­¤å¤–ï¼Œå‚ç›´åˆ†åŒºå¯ä»¥ç®€åŒ–è¡¨çš„ç»“æ„ï¼Œæ˜“äºç»´æŠ¤ã€‚ å‚ç›´æ‹†åˆ†çš„ç¼ºç‚¹ï¼š ä¸»é”®ä¼šå‡ºç°å†—ä½™ï¼Œéœ€è¦ç®¡ç†å†—ä½™åˆ—ï¼Œå¹¶ä¼šå¼•èµ·Joinæ“ä½œï¼Œå¯ä»¥é€šè¿‡åœ¨åº”ç”¨å±‚è¿›è¡ŒJoinæ¥è§£å†³ã€‚æ­¤å¤–ï¼Œå‚ç›´åˆ†åŒºä¼šè®©äº‹åŠ¡å˜å¾—æ›´åŠ å¤æ‚ï¼› é€‚ç”¨åœºæ™¯ 1ã€å¦‚æœä¸€ä¸ªè¡¨ä¸­æŸäº›åˆ—å¸¸ç”¨ï¼Œå¦å¤–ä¸€äº›åˆ—ä¸å¸¸ç”¨ 2ã€å¯ä»¥ä½¿æ•°æ®è¡Œå˜å°ï¼Œä¸€ä¸ªæ•°æ®é¡µèƒ½å­˜å‚¨æ›´å¤šæ•°æ®ï¼ŒæŸ¥è¯¢æ—¶å‡å°‘I/Oæ¬¡æ•° ç¼ºç‚¹ æœ‰äº›åˆ†è¡¨çš„ç­–ç•¥åŸºäºåº”ç”¨å±‚çš„é€»è¾‘ç®—æ³•ï¼Œä¸€æ—¦é€»è¾‘ç®—æ³•æ”¹å˜ï¼Œæ•´ä¸ªåˆ†è¡¨é€»è¾‘éƒ½ä¼šæ”¹å˜ï¼Œæ‰©å±•æ€§è¾ƒå·® å¯¹äºåº”ç”¨å±‚æ¥è¯´ï¼Œé€»è¾‘ç®—æ³•å¢åŠ å¼€å‘æˆæœ¬ ç®¡ç†å†—ä½™åˆ—ï¼ŒæŸ¥è¯¢æ‰€æœ‰æ•°æ®éœ€è¦joinæ“ä½œ æ°´å¹³åˆ†è¡¨ï¼š ä¿æŒæ•°æ®è¡¨ç»“æ„ä¸å˜ï¼Œé€šè¿‡æŸç§ç­–ç•¥å­˜å‚¨æ•°æ®åˆ†ç‰‡ã€‚è¿™æ ·æ¯ä¸€ç‰‡æ•°æ®åˆ†æ•£åˆ°ä¸åŒçš„è¡¨æˆ–è€…åº“ä¸­ï¼Œè¾¾åˆ°äº†åˆ†å¸ƒå¼çš„ç›®çš„ã€‚ æ°´å¹³æ‹†åˆ†å¯ä»¥æ”¯æ’‘éå¸¸å¤§çš„æ•°æ®é‡ã€‚ æ°´å¹³æ‹†åˆ†æ˜¯æŒ‡æ•°æ®è¡¨è¡Œçš„æ‹†åˆ†ï¼Œè¡¨çš„è¡Œæ•°è¶…è¿‡200ä¸‡è¡Œæ—¶ï¼Œå°±ä¼šå˜æ…¢ï¼Œè¿™æ—¶å¯ä»¥æŠŠä¸€å¼ çš„è¡¨çš„æ•°æ®æ‹†æˆå¤šå¼ è¡¨æ¥å­˜æ”¾ã€‚ä¸¾ä¸ªä¾‹å­ï¼šæˆ‘ä»¬å¯ä»¥å°†ç”¨æˆ·ä¿¡æ¯è¡¨æ‹†åˆ†æˆå¤šä¸ªç”¨æˆ·ä¿¡æ¯è¡¨ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…å•ä¸€è¡¨æ•°æ®é‡è¿‡å¤§å¯¹æ€§èƒ½é€ æˆå½±å“ã€‚ æ°´å“æ‹†åˆ†å¯ä»¥æ”¯æŒéå¸¸å¤§çš„æ•°æ®é‡ã€‚éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯:åˆ†è¡¨ä»…ä»…æ˜¯è§£å†³äº†å•ä¸€è¡¨æ•°æ®è¿‡å¤§çš„é—®é¢˜ï¼Œä½†ç”±äºè¡¨çš„æ•°æ®è¿˜æ˜¯åœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œå…¶å®å¯¹äºæå‡MySQLå¹¶å‘èƒ½åŠ›æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œæ‰€ä»¥ æ°´å¹³æ‹†åˆ†æœ€å¥½åˆ†åº“ ã€‚ æ°´å¹³æ‹†åˆ†èƒ½å¤Ÿ æ”¯æŒéå¸¸å¤§çš„æ•°æ®é‡å­˜å‚¨ï¼Œåº”ç”¨ç«¯æ”¹é€ ä¹Ÿå°‘ï¼Œä½† åˆ†ç‰‡äº‹åŠ¡éš¾ä»¥è§£å†³ ï¼Œè·¨ç•Œç‚¹Joinæ€§èƒ½è¾ƒå·®ï¼Œé€»è¾‘å¤æ‚ã€‚ ã€ŠJavaå·¥ç¨‹å¸ˆä¿®ç‚¼ä¹‹é“ã€‹çš„ä½œè€…æ¨è å°½é‡ä¸è¦å¯¹æ•°æ®è¿›è¡Œåˆ†ç‰‡ï¼Œå› ä¸ºæ‹†åˆ†ä¼šå¸¦æ¥é€»è¾‘ã€éƒ¨ç½²ã€è¿ç»´çš„å„ç§å¤æ‚åº¦ ï¼Œä¸€èˆ¬çš„æ•°æ®è¡¨åœ¨ä¼˜åŒ–å¾—å½“çš„æƒ…å†µä¸‹æ”¯æ’‘åƒä¸‡ä»¥ä¸‹çš„æ•°æ®é‡æ˜¯æ²¡æœ‰å¤ªå¤§é—®é¢˜çš„ã€‚å¦‚æœå®åœ¨è¦åˆ†ç‰‡ï¼Œå°½é‡é€‰æ‹©å®¢æˆ·ç«¯åˆ†ç‰‡æ¶æ„ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ä¸€æ¬¡å’Œä¸­é—´ä»¶çš„ç½‘ç»œI/Oã€‚ é€‚ç”¨åœºæ™¯ 1ã€è¡¨ä¸­çš„æ•°æ®æœ¬èº«å°±æœ‰ç‹¬ç«‹æ€§ï¼Œä¾‹å¦‚è¡¨ä¸­åˆ†è¡¨è®°å½•å„ä¸ªåœ°åŒºçš„æ•°æ®æˆ–è€…ä¸åŒæ—¶æœŸçš„æ•°æ®ï¼Œç‰¹åˆ«æ˜¯æœ‰äº›æ•°æ®å¸¸ç”¨ï¼Œæœ‰äº›ä¸å¸¸ç”¨ã€‚ 2ã€éœ€è¦æŠŠæ•°æ®å­˜æ”¾åœ¨å¤šä¸ªä»‹è´¨ä¸Šã€‚ æ°´å¹³åˆ‡åˆ†çš„ç¼ºç‚¹ 1ã€ç»™åº”ç”¨å¢åŠ å¤æ‚åº¦ï¼Œé€šå¸¸æŸ¥è¯¢æ—¶éœ€è¦å¤šä¸ªè¡¨åï¼ŒæŸ¥è¯¢æ‰€æœ‰æ•°æ®éƒ½éœ€UNIONæ“ä½œ 2ã€åœ¨è®¸å¤šæ•°æ®åº“åº”ç”¨ä¸­ï¼Œè¿™ç§å¤æ‚åº¦ä¼šè¶…è¿‡å®ƒå¸¦æ¥çš„ä¼˜ç‚¹ï¼ŒæŸ¥è¯¢æ—¶ä¼šå¢åŠ è¯»ä¸€ä¸ªç´¢å¼•å±‚çš„ç£ç›˜æ¬¡æ•° æ•°æ®åº“åˆ†ç‰‡ä¸¤ç§å¸¸è§æ–¹æ¡ˆ å®¢æˆ·ç«¯ä»£ç†ï¼š åˆ†ç‰‡é€»è¾‘åœ¨åº”ç”¨ç«¯ï¼Œå°è£…åœ¨jaråŒ…ä¸­ï¼Œé€šè¿‡ä¿®æ”¹æˆ–è€…å°è£…JDBCå±‚æ¥å®ç°ã€‚ å½“å½“ç½‘çš„ Sharding-JDBC ã€é˜¿é‡Œçš„TDDLæ˜¯ä¸¤ç§æ¯”è¾ƒå¸¸ç”¨çš„å®ç°ã€‚ ä¸­é—´ä»¶ä»£ç†ï¼š åœ¨åº”ç”¨å’Œæ•°æ®ä¸­é—´åŠ äº†ä¸€ä¸ªä»£ç†å±‚ã€‚åˆ†ç‰‡é€»è¾‘ç»Ÿä¸€ç»´æŠ¤åœ¨ä¸­é—´ä»¶æœåŠ¡ä¸­ã€‚ æˆ‘ä»¬ç°åœ¨è°ˆçš„ Mycat ã€360çš„Atlasã€ç½‘æ˜“çš„DDBç­‰ç­‰éƒ½æ˜¯è¿™ç§æ¶æ„çš„å®ç°ã€‚ åˆ†åº“åˆ†è¡¨åé¢ä¸´çš„é—®é¢˜ äº‹åŠ¡æ”¯æŒ åˆ†åº“åˆ†è¡¨åï¼Œå°±æˆäº†åˆ†å¸ƒå¼äº‹åŠ¡äº†ã€‚å¦‚æœä¾èµ–æ•°æ®åº“æœ¬èº«çš„åˆ†å¸ƒå¼äº‹åŠ¡ç®¡ç†åŠŸèƒ½å»æ‰§è¡Œäº‹åŠ¡ï¼Œå°†ä»˜å‡ºé«˜æ˜‚çš„æ€§èƒ½ä»£ä»·ï¼› å¦‚æœç”±åº”ç”¨ç¨‹åºå»ååŠ©æ§åˆ¶ï¼Œå½¢æˆç¨‹åºé€»è¾‘ä¸Šçš„äº‹åŠ¡ï¼Œåˆä¼šé€ æˆç¼–ç¨‹æ–¹é¢çš„è´Ÿæ‹…ã€‚ è·¨åº“join åªè¦æ˜¯è¿›è¡Œåˆ‡åˆ†ï¼Œè·¨èŠ‚ç‚¹Joinçš„é—®é¢˜æ˜¯ä¸å¯é¿å…çš„ã€‚ä½†æ˜¯è‰¯å¥½çš„è®¾è®¡å’Œåˆ‡åˆ†å´å¯ä»¥å‡å°‘æ­¤ç±»æƒ…å†µçš„å‘ç”Ÿã€‚è§£å†³è¿™ä¸€é—®é¢˜çš„æ™®éåšæ³•æ˜¯åˆ†ä¸¤æ¬¡æŸ¥è¯¢å®ç°ã€‚åœ¨ç¬¬ä¸€æ¬¡æŸ¥è¯¢çš„ç»“æœé›†ä¸­æ‰¾å‡ºå…³è”æ•°æ®çš„id,æ ¹æ®è¿™äº›idå‘èµ·ç¬¬äºŒæ¬¡è¯·æ±‚å¾—åˆ°å…³è”æ•°æ®ã€‚ åˆ†åº“åˆ†è¡¨æ–¹æ¡ˆäº§å“ è·¨èŠ‚ç‚¹çš„count,order by,group byä»¥åŠèšåˆå‡½æ•°é—®é¢˜ è¿™äº›æ˜¯ä¸€ç±»é—®é¢˜ï¼Œå› ä¸ºå®ƒä»¬éƒ½éœ€è¦åŸºäºå…¨éƒ¨æ•°æ®é›†åˆè¿›è¡Œè®¡ç®—ã€‚å¤šæ•°çš„ä»£ç†éƒ½ä¸ä¼šè‡ªåŠ¨å¤„ç†åˆå¹¶å·¥ä½œã€‚è§£å†³æ–¹æ¡ˆï¼šä¸è§£å†³è·¨èŠ‚ç‚¹joiné—®é¢˜çš„ç±»ä¼¼ï¼Œåˆ†åˆ«åœ¨å„ä¸ªèŠ‚ç‚¹ä¸Šå¾—åˆ°ç»“æœååœ¨åº”ç”¨ç¨‹åºç«¯è¿›è¡Œåˆå¹¶ã€‚å’Œjoinä¸åŒçš„æ˜¯æ¯ä¸ªç»“ç‚¹çš„æŸ¥è¯¢å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œå› æ­¤å¾ˆå¤šæ—¶å€™å®ƒçš„é€Ÿåº¦è¦æ¯”å•ä¸€å¤§è¡¨å¿«å¾ˆå¤šã€‚ä½†å¦‚æœç»“æœé›†å¾ˆå¤§ï¼Œå¯¹åº”ç”¨ç¨‹åºå†…å­˜çš„æ¶ˆè€—æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚ æ•°æ®è¿ç§»ï¼Œå®¹é‡è§„åˆ’ï¼Œæ‰©å®¹ç­‰é—®é¢˜ æ¥è‡ªæ·˜å®ç»¼åˆä¸šåŠ¡å¹³å°å›¢é˜Ÿï¼Œå®ƒåˆ©ç”¨å¯¹2çš„å€æ•°å–ä½™å…·æœ‰å‘å‰å…¼å®¹çš„ç‰¹æ€§ï¼ˆå¦‚å¯¹4å–ä½™å¾—1çš„æ•°å¯¹2å–ä½™ä¹Ÿæ˜¯1ï¼‰æ¥åˆ†é…æ•°æ®ï¼Œé¿å…äº†è¡Œçº§åˆ«çš„æ•°æ®è¿ç§»ï¼Œä½†æ˜¯ä¾ç„¶éœ€è¦è¿›è¡Œè¡¨çº§åˆ«çš„è¿ç§»ï¼ŒåŒæ—¶å¯¹æ‰©å®¹è§„æ¨¡å’Œåˆ†è¡¨æ•°é‡éƒ½æœ‰é™åˆ¶ã€‚æ€»å¾—æ¥è¯´ï¼Œè¿™äº›æ–¹æ¡ˆéƒ½ä¸æ˜¯ååˆ†çš„ç†æƒ³ï¼Œå¤šå¤šå°‘å°‘éƒ½å­˜åœ¨ä¸€äº›ç¼ºç‚¹ï¼Œè¿™ä¹Ÿä»ä¸€ä¸ªä¾§é¢åæ˜ å‡ºäº†Shardingæ‰©å®¹çš„éš¾åº¦ã€‚ IDé—®é¢˜ ä¸€æ—¦æ•°æ®åº“è¢«åˆ‡åˆ†åˆ°å¤šä¸ªç‰©ç†ç»“ç‚¹ä¸Šï¼Œæˆ‘ä»¬å°†ä¸èƒ½å†ä¾èµ–æ•°æ®åº“è‡ªèº«çš„ä¸»é”®ç”Ÿæˆæœºåˆ¶ã€‚ä¸€æ–¹é¢ï¼ŒæŸä¸ªåˆ†åŒºæ•°æ®åº“è‡ªç”Ÿæˆçš„IDæ— æ³•ä¿è¯åœ¨å…¨å±€ä¸Šæ˜¯å”¯ä¸€çš„ï¼›å¦ä¸€æ–¹é¢ï¼Œåº”ç”¨ç¨‹åºåœ¨æ’å…¥æ•°æ®ä¹‹å‰éœ€è¦å…ˆè·å¾—ID,ä»¥ä¾¿è¿›è¡ŒSQLè·¯ç”±. ä¸€äº›å¸¸è§çš„ä¸»é”®ç”Ÿæˆç­–ç•¥ UUID ä½¿ç”¨UUIDä½œä¸»é”®æ˜¯æœ€ç®€å•çš„æ–¹æ¡ˆï¼Œä½†æ˜¯ç¼ºç‚¹ä¹Ÿæ˜¯éå¸¸æ˜æ˜¾çš„ã€‚ç”±äºUUIDéå¸¸çš„é•¿ï¼Œé™¤å ç”¨å¤§é‡å­˜å‚¨ç©ºé—´å¤–ï¼Œæœ€ä¸»è¦çš„é—®é¢˜æ˜¯åœ¨ç´¢å¼•ä¸Šï¼Œåœ¨å»ºç«‹ç´¢å¼•å’ŒåŸºäºç´¢å¼•è¿›è¡ŒæŸ¥è¯¢æ—¶éƒ½å­˜åœ¨æ€§èƒ½é—®é¢˜ã€‚ Twitterçš„åˆ†å¸ƒå¼è‡ªå¢IDç®—æ³•Snowflake åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œéœ€è¦ç”Ÿæˆå…¨å±€UIDçš„åœºåˆè¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œtwitterçš„snowflakeè§£å†³äº†è¿™ç§éœ€æ±‚ï¼Œå®ç°ä¹Ÿè¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œé™¤å»é…ç½®ä¿¡æ¯ï¼Œæ ¸å¿ƒä»£ç å°±æ˜¯æ¯«ç§’çº§æ—¶é—´41ä½ æœºå™¨ID 10ä½ æ¯«ç§’å†…åºåˆ—12ä½ã€‚ è·¨åˆ†ç‰‡çš„æ’åºåˆ†é¡µ èˆ¬æ¥è®²ï¼Œåˆ†é¡µæ—¶éœ€è¦æŒ‰ç…§æŒ‡å®šå­—æ®µè¿›è¡Œæ’åºã€‚å½“æ’åºå­—æ®µå°±æ˜¯åˆ†ç‰‡å­—æ®µçš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šè¿‡åˆ†ç‰‡è§„åˆ™å¯ä»¥æ¯”è¾ƒå®¹æ˜“å®šä½åˆ°æŒ‡å®šçš„åˆ†ç‰‡ï¼Œè€Œå½“æ’åºå­—æ®µéåˆ†ç‰‡å­—æ®µçš„æ—¶å€™ï¼Œæƒ…å†µå°±ä¼šå˜å¾—æ¯”è¾ƒå¤æ‚äº†ã€‚ä¸ºäº†æœ€ç»ˆç»“æœçš„å‡†ç¡®æ€§ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸åŒçš„åˆ†ç‰‡èŠ‚ç‚¹ä¸­å°†æ•°æ®è¿›è¡Œæ’åºå¹¶è¿”å›ï¼Œå¹¶å°†ä¸åŒåˆ†ç‰‡è¿”å›çš„ç»“æœé›†è¿›è¡Œæ±‡æ€»å’Œå†æ¬¡æ’åºï¼Œæœ€åå†è¿”å›ç»™ç”¨æˆ·ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š MySQLå¤åˆ¶åŸç†ä»¥åŠæµç¨‹ ä¸»ä»å¤åˆ¶ï¼šå°†ä¸»æ•°æ®åº“ä¸­çš„DDLå’ŒDMLæ“ä½œé€šè¿‡äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆBINLOGï¼‰ä¼ è¾“åˆ°ä»æ•°æ®åº“ä¸Šï¼Œç„¶åå°†è¿™äº›æ—¥å¿—é‡æ–°æ‰§è¡Œï¼ˆé‡åšï¼‰ï¼›ä»è€Œä½¿å¾—ä»æ•°æ®åº“çš„æ•°æ®ä¸ä¸»æ•°æ®åº“ä¿æŒä¸€è‡´ã€‚ ä¸»ä»å¤åˆ¶çš„ä½œç”¨ ä¸»æ•°æ®åº“å‡ºç°é—®é¢˜ï¼Œå¯ä»¥åˆ‡æ¢åˆ°ä»æ•°æ®åº“ã€‚ å¯ä»¥è¿›è¡Œæ•°æ®åº“å±‚é¢çš„è¯»å†™åˆ†ç¦»ã€‚ å¯ä»¥åœ¨ä»æ•°æ®åº“ä¸Šè¿›è¡Œæ—¥å¸¸å¤‡ä»½ã€‚ MySQLä¸»ä»å¤åˆ¶è§£å†³çš„é—®é¢˜ æ•°æ®åˆ†å¸ƒï¼šéšæ„å¼€å§‹æˆ–åœæ­¢å¤åˆ¶ï¼Œå¹¶åœ¨ä¸åŒåœ°ç†ä½ç½®åˆ†å¸ƒæ•°æ®å¤‡ä»½ è´Ÿè½½å‡è¡¡ï¼šé™ä½å•ä¸ªæœåŠ¡å™¨çš„å‹åŠ› é«˜å¯ç”¨å’Œæ•…éšœåˆ‡æ¢ï¼šå¸®åŠ©åº”ç”¨ç¨‹åºé¿å…å•ç‚¹å¤±è´¥ å‡çº§æµ‹è¯•ï¼šå¯ä»¥ç”¨æ›´é«˜ç‰ˆæœ¬çš„MySQLä½œä¸ºä»åº“ MySQLä¸»ä»å¤åˆ¶å·¥ä½œåŸç† åœ¨ä¸»åº“ä¸ŠæŠŠæ•°æ®æ›´é«˜è®°å½•åˆ°äºŒè¿›åˆ¶æ—¥å¿— ä»åº“å°†ä¸»åº“çš„æ—¥å¿—å¤åˆ¶åˆ°è‡ªå·±çš„ä¸­ç»§æ—¥å¿— ä»åº“è¯»å–ä¸­ç»§æ—¥å¿—çš„äº‹ä»¶ï¼Œå°†å…¶é‡æ”¾åˆ°ä»åº“æ•°æ®ä¸­ åŸºæœ¬åŸç†æµç¨‹ï¼Œ3ä¸ªçº¿ç¨‹ä»¥åŠä¹‹é—´çš„å…³è” ä¸»ï¼šbinlogçº¿ç¨‹â€”â€”è®°å½•ä¸‹æ‰€æœ‰æ”¹å˜äº†æ•°æ®åº“æ•°æ®çš„è¯­å¥ï¼Œæ”¾è¿›masterä¸Šçš„binlogä¸­ï¼› ä»ï¼šioçº¿ç¨‹â€”â€”åœ¨ä½¿ç”¨start slave ä¹‹åï¼Œè´Ÿè´£ä»masterä¸Šæ‹‰å– binlog å†…å®¹ï¼Œæ”¾è¿›è‡ªå·±çš„relay logä¸­ï¼› ä»ï¼šsqlæ‰§è¡Œçº¿ç¨‹â€”â€”æ‰§è¡Œrelay logä¸­çš„è¯­å¥ï¼› å¤åˆ¶è¿‡ç¨‹ Binary logï¼šä¸»æ•°æ®åº“çš„äºŒè¿›åˆ¶æ—¥å¿— Relay logï¼šä»æœåŠ¡å™¨çš„ä¸­ç»§æ—¥å¿— ç¬¬ä¸€æ­¥ï¼šmasteråœ¨æ¯ä¸ªäº‹åŠ¡æ›´æ–°æ•°æ®å®Œæˆä¹‹å‰ï¼Œå°†è¯¥æ“ä½œè®°å½•ä¸²è¡Œåœ°å†™å…¥åˆ°binlogæ–‡ä»¶ä¸­ã€‚ ç¬¬äºŒæ­¥ï¼šsalveå¼€å¯ä¸€ä¸ªI/O Threadï¼Œè¯¥çº¿ç¨‹åœ¨masteræ‰“å¼€ä¸€ä¸ªæ™®é€šè¿æ¥ï¼Œä¸»è¦å·¥ä½œæ˜¯binlog dump processã€‚å¦‚æœè¯»å–çš„è¿›åº¦å·²ç»è·Ÿä¸Šäº†masterï¼Œå°±è¿›å…¥ç¡çœ çŠ¶æ€å¹¶ç­‰å¾…masteräº§ç”Ÿæ–°çš„äº‹ä»¶ã€‚I/Oçº¿ç¨‹æœ€ç»ˆçš„ç›®çš„æ˜¯å°†è¿™äº›äº‹ä»¶å†™å…¥åˆ°ä¸­ç»§æ—¥å¿—ä¸­ã€‚ ç¬¬ä¸‰æ­¥ï¼šSQL Threadä¼šè¯»å–ä¸­ç»§æ—¥å¿—ï¼Œå¹¶é¡ºåºæ‰§è¡Œè¯¥æ—¥å¿—ä¸­çš„SQLäº‹ä»¶ï¼Œä»è€Œä¸ä¸»æ•°æ®åº“ä¸­çš„æ•°æ®ä¿æŒä¸€è‡´ã€‚ è¯»å†™åˆ†ç¦»è§£å†³æ–¹æ¡ˆ è¯»å†™åˆ†ç¦»æ˜¯ä¾èµ–äºä¸»ä»å¤åˆ¶ï¼Œè€Œä¸»ä»å¤åˆ¶åˆæ˜¯ä¸ºè¯»å†™åˆ†ç¦»æœåŠ¡çš„ã€‚å› ä¸ºä¸»ä»å¤åˆ¶è¦æ±‚slaveä¸èƒ½å†™åªèƒ½è¯»ï¼ˆå¦‚æœå¯¹slaveæ‰§è¡Œå†™æ“ä½œï¼Œé‚£ä¹ˆshow slave statuså°†ä¼šå‘ˆç°Slave_SQL_Running=NOï¼Œæ­¤æ—¶ä½ éœ€è¦æŒ‰ç…§å‰é¢æåˆ°çš„æ‰‹åŠ¨åŒæ­¥ä¸€ä¸‹slaveï¼‰ã€‚ æ–¹æ¡ˆä¸€ ä½¿ç”¨mysql-proxyä»£ç† ä¼˜ç‚¹ï¼šç›´æ¥å®ç°è¯»å†™åˆ†ç¦»å’Œè´Ÿè½½å‡è¡¡ï¼Œä¸ç”¨ä¿®æ”¹ä»£ç ï¼Œmasterå’Œslaveç”¨ä¸€æ ·çš„å¸å·ï¼Œmysqlå®˜æ–¹ä¸å»ºè®®å®é™…ç”Ÿäº§ä¸­ä½¿ç”¨ ç¼ºç‚¹ï¼šé™ä½æ€§èƒ½ï¼Œ ä¸æ”¯æŒäº‹åŠ¡ æ–¹æ¡ˆäºŒ ä½¿ç”¨AbstractRoutingDataSource+aop+annotationåœ¨daoå±‚å†³å®šæ•°æ®æºã€‚ å¦‚æœé‡‡ç”¨äº†mybatisï¼Œ å¯ä»¥å°†è¯»å†™åˆ†ç¦»æ”¾åœ¨ORMå±‚ï¼Œæ¯”å¦‚mybatiså¯ä»¥é€šè¿‡mybatis pluginæ‹¦æˆªsqlè¯­å¥ï¼Œæ‰€æœ‰çš„insert/update/deleteéƒ½è®¿é—®masteråº“ï¼Œæ‰€æœ‰çš„select éƒ½è®¿é—®salveåº“ï¼Œè¿™æ ·å¯¹äºdaoå±‚éƒ½æ˜¯é€æ˜ã€‚ pluginå®ç°æ—¶å¯ä»¥é€šè¿‡æ³¨è§£æˆ–è€…åˆ†æè¯­å¥æ˜¯è¯»å†™æ–¹æ³•æ¥é€‰å®šä¸»ä»åº“ã€‚ä¸è¿‡è¿™æ ·ä¾ç„¶æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œ ä¹Ÿå°±æ˜¯ä¸æ”¯æŒäº‹åŠ¡ï¼Œ æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦é‡å†™ä¸€ä¸‹DataSourceTransactionManagerï¼Œ å°†read-onlyçš„äº‹åŠ¡æ‰”è¿›è¯»åº“ï¼Œ å…¶ä½™çš„æœ‰è¯»æœ‰å†™çš„æ‰”è¿›å†™åº“ã€‚ æ–¹æ¡ˆä¸‰ ä½¿ç”¨AbstractRoutingDataSource+aop+annotationåœ¨serviceå±‚å†³å®šæ•°æ®æºï¼Œå¯ä»¥æ”¯æŒäº‹åŠ¡. ç¼ºç‚¹ï¼šç±»å†…éƒ¨æ–¹æ³•é€šè¿‡this.xx()æ–¹å¼ç›¸äº’è°ƒç”¨æ—¶ï¼Œaopä¸ä¼šè¿›è¡Œæ‹¦æˆªï¼Œéœ€è¿›è¡Œç‰¹æ®Šå¤„ç†ã€‚ å¤‡ä»½è®¡åˆ’ï¼Œmysqldumpä»¥åŠxtranbackupçš„å®ç°åŸç† (1)å¤‡ä»½è®¡åˆ’ è§†åº“çš„å¤§å°æ¥å®šï¼Œä¸€èˆ¬æ¥è¯´ 100G å†…çš„åº“ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ mysqldump æ¥åšï¼Œå› ä¸º mysqldumpæ›´åŠ è½»å·§çµæ´»ï¼Œå¤‡ä»½æ—¶é—´é€‰åœ¨ä¸šåŠ¡ä½å³°æœŸï¼Œå¯ä»¥æ¯å¤©è¿›è¡Œéƒ½è¿›è¡Œå…¨é‡å¤‡ä»½(mysqldump å¤‡ä»½å‡ºæ¥çš„æ–‡ä»¶æ¯”è¾ƒå°ï¼Œå‹ç¼©ä¹‹åæ›´å°)ã€‚ 100G ä»¥ä¸Šçš„åº“ï¼Œå¯ä»¥è€ƒè™‘ç”¨ xtranbackup æ¥åšï¼Œå¤‡ä»½é€Ÿåº¦æ˜æ˜¾è¦æ¯” mysqldump è¦å¿«ã€‚ä¸€èˆ¬æ˜¯é€‰æ‹©ä¸€å‘¨ä¸€ä¸ªå…¨å¤‡ï¼Œå…¶ä½™æ¯å¤©è¿›è¡Œå¢é‡å¤‡ä»½ï¼Œå¤‡ä»½æ—¶é—´ä¸ºä¸šåŠ¡ä½å³°æœŸã€‚ (2)å¤‡ä»½æ¢å¤æ—¶é—´ ç‰©ç†å¤‡ä»½æ¢å¤å¿«ï¼Œé€»è¾‘å¤‡ä»½æ¢å¤æ…¢ è¿™é‡Œè·Ÿæœºå™¨ï¼Œå°¤å…¶æ˜¯ç¡¬ç›˜çš„é€Ÿç‡æœ‰å…³ç³»ï¼Œä»¥ä¸‹åˆ—ä¸¾å‡ ä¸ªä»…ä¾›å‚è€ƒ 20Gçš„2åˆ†é’Ÿï¼ˆmysqldumpï¼‰ 80Gçš„30åˆ†é’Ÿ(mysqldump) 111Gçš„30åˆ†é’Ÿï¼ˆmysqldump) 288Gçš„3å°æ—¶ï¼ˆxtra) 3Tçš„4å°æ—¶ï¼ˆxtra) é€»è¾‘å¯¼å…¥æ—¶é—´ä¸€èˆ¬æ˜¯å¤‡ä»½æ—¶é—´çš„5å€ä»¥ä¸Š (3)å¤‡ä»½æ¢å¤å¤±è´¥å¦‚ä½•å¤„ç† é¦–å…ˆåœ¨æ¢å¤ä¹‹å‰å°±åº”è¯¥åšè¶³å‡†å¤‡å·¥ä½œï¼Œé¿å…æ¢å¤çš„æ—¶å€™å‡ºé”™ã€‚æ¯”å¦‚è¯´å¤‡ä»½ä¹‹åçš„æœ‰æ•ˆæ€§æ£€æŸ¥ã€æƒé™æ£€æŸ¥ã€ç©ºé—´æ£€æŸ¥ç­‰ã€‚å¦‚æœä¸‡ä¸€æŠ¥é”™ï¼Œå†æ ¹æ®æŠ¥é”™çš„æç¤ºæ¥è¿›è¡Œç›¸åº”çš„è°ƒæ•´ã€‚ (4)mysqldumpå’Œxtrabackupå®ç°åŸç† mysqldump mysqldump å±äºé€»è¾‘å¤‡ä»½ã€‚åŠ å…¥â€“single-transaction é€‰é¡¹å¯ä»¥è¿›è¡Œä¸€è‡´æ€§å¤‡ä»½ã€‚åå°è¿›ç¨‹ä¼šå…ˆè®¾ç½® session çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸º RR(SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ)ï¼Œä¹‹åæ˜¾å¼å¼€å¯ä¸€ä¸ªäº‹åŠ¡(START TRANSACTION /*!40100 WITH CONSISTENTSNAPSHOT */)ï¼Œè¿™æ ·å°±ä¿è¯äº†è¯¥äº‹åŠ¡é‡Œè¯»åˆ°çš„æ•°æ®éƒ½æ˜¯äº‹åŠ¡äº‹åŠ¡æ—¶å€™çš„å¿«ç…§ã€‚ä¹‹åå†æŠŠè¡¨çš„æ•°æ®è¯»å–å‡ºæ¥ã€‚å¦‚æœåŠ ä¸Šâ€“master-data=1 çš„è¯ï¼Œåœ¨åˆšå¼€å§‹çš„æ—¶å€™è¿˜ä¼šåŠ ä¸€ä¸ªæ•°æ®åº“çš„è¯»é”(FLUSH TABLES WITH READ LOCK),ç­‰å¼€å¯äº‹åŠ¡åï¼Œå†è®°å½•ä¸‹æ•°æ®åº“æ­¤æ—¶ binlog çš„ä½ç½®(showmaster status)ï¼Œé©¬ä¸Šè§£é”ï¼Œå†è¯»å–è¡¨çš„æ•°æ®ã€‚ç­‰æ‰€æœ‰çš„æ•°æ®éƒ½å·²ç»å¯¼å®Œï¼Œå°±å¯ä»¥ç»“æŸäº‹åŠ¡ Xtrabackup xtrabackup å±äºç‰©ç†å¤‡ä»½ï¼Œç›´æ¥æ‹·è´è¡¨ç©ºé—´æ–‡ä»¶ï¼ŒåŒæ—¶ä¸æ–­æ‰«æäº§ç”Ÿçš„ redo æ—¥å¿—å¹¶ä¿å­˜ä¸‹æ¥ã€‚æœ€åå®Œæˆ innodb çš„å¤‡ä»½åï¼Œä¼šåšä¸€ä¸ª flush engine logs çš„æ“ä½œ(è€ç‰ˆæœ¬åœ¨æœ‰ bugï¼Œåœ¨5.6 ä¸Šä¸åšæ­¤æ“ä½œä¼šä¸¢æ•°æ®)ï¼Œç¡®ä¿æ‰€æœ‰çš„ redo log éƒ½å·²ç»è½ç›˜(æ¶‰åŠåˆ°äº‹åŠ¡çš„ä¸¤é˜¶æ®µæäº¤æ¦‚å¿µï¼Œå› ä¸º xtrabackup å¹¶ä¸æ‹·è´ binlogï¼Œæ‰€ä»¥å¿…é¡»ä¿è¯æ‰€æœ‰çš„ redo log éƒ½è½ç›˜ï¼Œå¦åˆ™å¯èƒ½ä¼šä¸¢æœ€åä¸€ç»„æäº¤äº‹åŠ¡çš„æ•°æ®)ã€‚è¿™ä¸ªæ—¶é—´ç‚¹å°±æ˜¯ innodb å®Œæˆå¤‡ä»½çš„æ—¶é—´ç‚¹ï¼Œæ•°æ®æ–‡ä»¶è™½ç„¶ä¸æ˜¯ä¸€è‡´æ€§çš„ï¼Œä½†æ˜¯æœ‰è¿™æ®µæ—¶é—´çš„ redo å°±å¯ä»¥è®©æ•°æ®æ–‡ä»¶è¾¾åˆ°ä¸€è‡´æ€§(æ¢å¤çš„æ—¶å€™åšçš„äº‹æƒ…)ã€‚ç„¶åè¿˜éœ€è¦flush tables with read lockï¼ŒæŠŠ myisam ç­‰å…¶ä»–å¼•æ“çš„è¡¨ç»™å¤‡ä»½å‡ºæ¥ï¼Œå¤‡ä»½å®Œåè§£é”ã€‚è¿™æ ·å°±åšåˆ°äº†å®Œç¾çš„çƒ­å¤‡ã€‚ æ•°æ®è¡¨æŸåçš„ä¿®å¤æ–¹å¼ ä½¿ç”¨ myisamchk æ¥ä¿®å¤ï¼Œå…·ä½“æ­¥éª¤ï¼š 1ï¼‰ä¿®å¤å‰å°†mysqlæœåŠ¡åœæ­¢ã€‚ 2ï¼‰æ‰“å¼€å‘½ä»¤è¡Œæ–¹å¼ï¼Œç„¶åè¿›å…¥åˆ°mysqlçš„/binç›®å½•ã€‚ 3ï¼‰æ‰§è¡Œmyisamchk â€“recover æ•°æ®åº“æ‰€åœ¨è·¯å¾„/*.MYI ä½¿ç”¨repair table æˆ–è€… OPTIMIZE tableå‘½ä»¤æ¥ä¿®å¤ï¼ŒREPAIR TABLE table_name ä¿®å¤è¡¨OPTIMIZE TABLE table_name ä¼˜åŒ–è¡¨ REPAIR TABLE ç”¨äºä¿®å¤è¢«ç ´åçš„è¡¨ã€‚ OPTIMIZE TABLE ç”¨äºå›æ”¶é—²ç½®çš„æ•°æ®åº“ç©ºé—´ï¼Œå½“è¡¨ä¸Šçš„æ•°æ®è¡Œè¢«åˆ é™¤æ—¶ï¼Œæ‰€å æ®çš„ç£ç›˜ç©ºé—´å¹¶æ²¡æœ‰ç«‹å³è¢«å›æ”¶ï¼Œä½¿ç”¨äº†OPTIMIZE TABLEå‘½ä»¤åè¿™äº›ç©ºé—´å°†è¢«å›æ”¶ï¼Œå¹¶ä¸”å¯¹ç£ç›˜ä¸Šçš„æ•°æ®è¡Œè¿›è¡Œé‡æ’ï¼ˆæ³¨æ„ï¼šæ˜¯ç£ç›˜ä¸Šï¼Œè€Œéæ•°æ®åº“ï¼‰ ","link":"https://tianxiawuhao.github.io/jytwMqgV3/"},{"title":"mysqlæ¦‚è¿°äº”","content":"SQLä¼˜åŒ– å¯¹äºä½æ€§èƒ½çš„SQLè¯­å¥çš„å®šä½ï¼Œæœ€é‡è¦ä¹Ÿæ˜¯æœ€æœ‰æ•ˆçš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨æ‰§è¡Œè®¡åˆ’ï¼ŒMySQLæä¾›äº†explainå‘½ä»¤æ¥æŸ¥çœ‹è¯­å¥çš„æ‰§è¡Œè®¡åˆ’ã€‚ æˆ‘ä»¬çŸ¥é“ï¼Œä¸ç®¡æ˜¯å“ªç§æ•°æ®åº“ï¼Œæˆ–è€…æ˜¯å“ªç§æ•°æ®åº“å¼•æ“ï¼Œåœ¨å¯¹ä¸€æ¡SQLè¯­å¥è¿›è¡Œæ‰§è¡Œçš„è¿‡ç¨‹ä¸­éƒ½ä¼šåšå¾ˆå¤šç›¸å…³çš„ä¼˜åŒ–ï¼Œå¯¹äºæŸ¥è¯¢è¯­å¥ï¼Œæœ€é‡è¦çš„ä¼˜åŒ–æ–¹å¼å°±æ˜¯ä½¿ç”¨ç´¢å¼•ã€‚ è€Œæ‰§è¡Œè®¡åˆ’ï¼Œå°±æ˜¯æ˜¾ç¤ºæ•°æ®åº“å¼•æ“å¯¹äºSQLè¯­å¥çš„æ‰§è¡Œçš„è¯¦ç»†æƒ…å†µï¼Œå…¶ä¸­åŒ…å«äº†æ˜¯å¦ä½¿ç”¨ç´¢å¼•ï¼Œä½¿ç”¨ä»€ä¹ˆç´¢å¼•ï¼Œä½¿ç”¨çš„ç´¢å¼•çš„ç›¸å…³ä¿¡æ¯ç­‰ã€‚ æ‰§è¡Œè®¡åˆ’åŒ…å«çš„ä¿¡æ¯ id æœ‰ä¸€ç»„æ•°å­—ç»„æˆã€‚è¡¨ç¤ºä¸€ä¸ªæŸ¥è¯¢ä¸­å„ä¸ªå­æŸ¥è¯¢çš„æ‰§è¡Œé¡ºåº; idç›¸åŒæ‰§è¡Œé¡ºåºç”±ä¸Šè‡³ä¸‹ã€‚ idä¸åŒï¼Œidå€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šå…ˆè¢«æ‰§è¡Œã€‚ idä¸ºnullæ—¶è¡¨ç¤ºä¸€ä¸ªç»“æœé›†ï¼Œä¸éœ€è¦ä½¿ç”¨å®ƒæŸ¥è¯¢ï¼Œå¸¸å‡ºç°åœ¨åŒ…å«unionç­‰æŸ¥è¯¢è¯­å¥ä¸­ã€‚ select_type æ¯ä¸ªå­æŸ¥è¯¢çš„æŸ¥è¯¢ç±»å‹ï¼Œä¸€äº›å¸¸è§çš„æŸ¥è¯¢ç±»å‹ã€‚ id select_type description 1 SIMPLE ä¸åŒ…å«ä»»ä½•å­æŸ¥è¯¢æˆ–unionç­‰æŸ¥è¯¢ 2 PRIMARY åŒ…å«å­æŸ¥è¯¢æœ€å¤–å±‚æŸ¥è¯¢å°±æ˜¾ç¤ºä¸º PRIMARY 3 SUBQUERY åœ¨selectæˆ– whereå­—å¥ä¸­åŒ…å«çš„æŸ¥è¯¢ 4 DERIVED fromå­—å¥ä¸­åŒ…å«çš„æŸ¥è¯¢ 5 UNION å‡ºç°åœ¨unionåçš„æŸ¥è¯¢è¯­å¥ä¸­ 6 UNION RESULT ä»UNIONä¸­è·å–ç»“æœé›†ï¼Œä¾‹å¦‚ä¸Šæ–‡çš„ç¬¬ä¸‰ä¸ªä¾‹å­ type(éå¸¸é‡è¦ï¼Œå¯ä»¥çœ‹åˆ°æœ‰æ²¡æœ‰èµ°ç´¢å¼•) è®¿é—®ç±»å‹ ALL æ‰«æå…¨è¡¨æ•°æ® index éå†ç´¢å¼• range ç´¢å¼•èŒƒå›´æŸ¥æ‰¾ index_subquery åœ¨å­æŸ¥è¯¢ä¸­ä½¿ç”¨ ref unique_subquery åœ¨å­æŸ¥è¯¢ä¸­ä½¿ç”¨ eq_ref ref_or_null å¯¹Nullè¿›è¡Œç´¢å¼•çš„ä¼˜åŒ–çš„ ref fulltext ä½¿ç”¨å…¨æ–‡ç´¢å¼• ref ä½¿ç”¨éå”¯ä¸€ç´¢å¼•æŸ¥æ‰¾æ•°æ® eq_ref åœ¨joinæŸ¥è¯¢ä¸­ä½¿ç”¨PRIMARY KEY or UNIQUE NOT NULLç´¢å¼•å…³è”ã€‚ possible_keys å¯èƒ½ä½¿ç”¨çš„ç´¢å¼•ï¼Œæ³¨æ„ä¸ä¸€å®šä¼šä½¿ç”¨ã€‚æŸ¥è¯¢æ¶‰åŠåˆ°çš„å­—æ®µä¸Šè‹¥å­˜åœ¨ç´¢å¼•ï¼Œåˆ™è¯¥ç´¢å¼•å°†è¢«åˆ—å‡ºæ¥ã€‚å½“è¯¥åˆ—ä¸º NULLæ—¶å°±è¦è€ƒè™‘å½“å‰çš„SQLæ˜¯å¦éœ€è¦ä¼˜åŒ–äº†ã€‚ key æ˜¾ç¤ºMySQLåœ¨æŸ¥è¯¢ä¸­å®é™…ä½¿ç”¨çš„ç´¢å¼•ï¼Œè‹¥æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ï¼Œæ˜¾ç¤ºä¸ºNULLã€‚ TIPS:æŸ¥è¯¢ä¸­è‹¥ä½¿ç”¨äº†è¦†ç›–ç´¢å¼•(è¦†ç›–ç´¢å¼•ï¼šç´¢å¼•çš„æ•°æ®è¦†ç›–äº†éœ€è¦æŸ¥è¯¢çš„æ‰€æœ‰æ•°æ®)ï¼Œåˆ™è¯¥ç´¢å¼•ä»…å‡ºç°åœ¨keyåˆ—è¡¨ä¸­ key_length ç´¢å¼•é•¿åº¦ ref è¡¨ç¤ºä¸Šè¿°è¡¨çš„è¿æ¥åŒ¹é…æ¡ä»¶ï¼Œå³å“ªäº›åˆ—æˆ–å¸¸é‡è¢«ç”¨äºæŸ¥æ‰¾ç´¢å¼•åˆ—ä¸Šçš„å€¼ rows è¿”å›ä¼°ç®—çš„ç»“æœé›†æ•°ç›®ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªå‡†ç¡®çš„å€¼ã€‚ extra çš„ä¿¡æ¯éå¸¸ä¸°å¯Œï¼Œå¸¸è§çš„æœ‰ï¼š Using index ä½¿ç”¨è¦†ç›–ç´¢å¼• Using where ä½¿ç”¨äº†ç”¨whereå­å¥æ¥è¿‡æ»¤ç»“æœé›† Using filesort ä½¿ç”¨æ–‡ä»¶æ’åºï¼Œä½¿ç”¨éç´¢å¼•åˆ—è¿›è¡Œæ’åºæ—¶å‡ºç°ï¼Œéå¸¸æ¶ˆè€—æ€§èƒ½ï¼Œå°½é‡ä¼˜åŒ–ã€‚ Using temporary ä½¿ç”¨äº†ä¸´æ—¶è¡¨ sqlä¼˜åŒ–çš„ç›®æ ‡å¯ä»¥å‚è€ƒé˜¿é‡Œå¼€å‘æ‰‹å†Œ ã€æ¨èã€‘SQLæ€§èƒ½ä¼˜åŒ–çš„ç›®æ ‡ï¼šè‡³å°‘è¦è¾¾åˆ° range çº§åˆ«ï¼Œè¦æ±‚æ˜¯refçº§åˆ«ï¼Œå¦‚æœå¯ä»¥æ˜¯constsæœ€å¥½ã€‚ è¯´æ˜ï¼š 1ï¼‰ consts å•è¡¨ä¸­æœ€å¤šåªæœ‰ä¸€ä¸ªåŒ¹é…è¡Œï¼ˆä¸»é”®æˆ–è€…å”¯ä¸€ç´¢å¼•ï¼‰ï¼Œåœ¨ä¼˜åŒ–é˜¶æ®µå³å¯è¯»å–åˆ°æ•°æ®ã€‚ 2ï¼‰ ref æŒ‡çš„æ˜¯ä½¿ç”¨æ™®é€šçš„ç´¢å¼•ï¼ˆnormal indexï¼‰ã€‚ 3ï¼‰ range å¯¹ç´¢å¼•è¿›è¡ŒèŒƒå›´æ£€ç´¢ã€‚ åä¾‹ï¼šexplainè¡¨çš„ç»“æœï¼Œtype=indexï¼Œç´¢å¼•ç‰©ç†æ–‡ä»¶å…¨æ‰«æï¼Œé€Ÿåº¦éå¸¸æ…¢ï¼Œè¿™ä¸ªindexçº§åˆ«æ¯”è¾ƒrangeè¿˜ä½ï¼Œä¸å…¨è¡¨æ‰«ææ˜¯å°å·«è§å¤§å·«ã€‚ SQLæ‰§è¡Œé¡ºåº mysqlæ‰§è¡Œsqlçš„é¡ºåºä» From å¼€å§‹ï¼Œä»¥ä¸‹æ˜¯æ‰§è¡Œçš„é¡ºåºæµç¨‹ FROM FROM table1 left join table2 on å°†table1å’Œtable2ä¸­çš„æ•°æ®äº§ç”Ÿç¬›å¡å°”ç§¯ï¼Œç”ŸæˆTemp1 JOIN JOIN table2 æ‰€ä»¥å…ˆæ˜¯ç¡®å®šè¡¨ï¼Œå†ç¡®å®šå…³è”æ¡ä»¶ ON ON table1.column = table2.columu ç¡®å®šè¡¨çš„ç»‘å®šæ¡ä»¶ ç”±Temp1äº§ç”Ÿä¸­é—´è¡¨Temp2 WHERE å¯¹ä¸­é—´è¡¨Temp2äº§ç”Ÿçš„ç»“æœè¿›è¡Œè¿‡æ»¤ äº§ç”Ÿä¸­é—´è¡¨Temp3 GROUP BY å¯¹ä¸­é—´è¡¨Temp3è¿›è¡Œåˆ†ç»„ï¼Œäº§ç”Ÿä¸­é—´è¡¨Temp4 HAVING å¯¹åˆ†ç»„åçš„è®°å½•è¿›è¡Œèšåˆ äº§ç”Ÿä¸­é—´è¡¨Temp5 SELECT å¯¹ä¸­é—´è¡¨Temp5è¿›è¡Œåˆ—ç­›é€‰ï¼Œäº§ç”Ÿä¸­é—´è¡¨ Temp6 DISTINCT å¯¹ä¸­é—´è¡¨ Temp6è¿›è¡Œå»é‡ï¼Œäº§ç”Ÿä¸­é—´è¡¨ Temp7 ORDER BY å¯¹Temp7ä¸­çš„æ•°æ®è¿›è¡Œæ’åºï¼Œäº§ç”Ÿä¸­é—´è¡¨Temp8 LIMIT å¯¹ä¸­é—´è¡¨Temp8è¿›è¡Œåˆ†é¡µï¼Œäº§ç”Ÿä¸­é—´è¡¨Temp9 SQLçš„ç”Ÿå‘½å‘¨æœŸ ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼Œå®¢æˆ·ç«¯å‘é€ä¸€æ¡æŸ¥è¯¢ç»™æœåŠ¡å™¨ æœåŠ¡å™¨å…ˆæ£€æŸ¥æŸ¥è¯¢ç¼“å­˜ï¼Œå¦‚æœå‘½ä¸­äº†ç¼“å­˜åˆ™ç«‹åˆ»è¿”å›å­˜å‚¨åœ¨ç¼“å­˜ä¸­çš„ç»“æœï¼Œå¦åˆ™æ‰§è¡Œä¸‹ä¸€æ­¥ æœåŠ¡ç«¯è¿›è¡Œsqlè§£æï¼Œé¢„å¤„ç†ï¼Œå†ç”±æŸ¥è¯¢ä¼˜åŒ–å™¨ç”Ÿæˆå¯¹åº”çš„æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’ mysqlæ ¹æ®ä¼˜åŒ–å™¨æä¾›çš„æ‰§è¡Œè®¡åˆ’ï¼Œè°ƒç”¨å­˜å‚¨å¼•æ“çš„apiæ¥æ‰§è¡ŒæŸ¥è¯¢ é€šè¿‡æ­¥éª¤ä¸€çš„è¿æ¥ï¼Œå‘é€ç»“æœåˆ°å®¢æˆ·ç«¯ å…³æ‰è¿æ¥ï¼Œé‡Šæ”¾èµ„æº ä¼˜åŒ–å¤§è¡¨æ•°æ®æŸ¥è¯¢ ä¼˜åŒ–shemaã€sqlè¯­å¥+ç´¢å¼•ï¼› åŠ ç¼“å­˜ï¼Œmemcached, redisï¼› ä¸»ä»å¤åˆ¶ï¼Œè¯»å†™åˆ†ç¦»ï¼› å‚ç›´æ‹†åˆ†ï¼Œæ ¹æ®ä½ æ¨¡å—çš„è€¦åˆåº¦ï¼Œå°†ä¸€ä¸ªå¤§çš„ç³»ç»Ÿåˆ†ä¸ºå¤šä¸ªå°çš„ç³»ç»Ÿï¼Œä¹Ÿå°±æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿï¼› æ°´å¹³åˆ‡åˆ†ï¼Œé’ˆå¯¹æ•°æ®é‡å¤§çš„è¡¨ï¼Œè¿™ä¸€æ­¥æœ€éº»çƒ¦ï¼Œæœ€èƒ½è€ƒéªŒæŠ€æœ¯æ°´å¹³ï¼Œè¦é€‰æ‹©ä¸€ä¸ªåˆç†çš„sharding key, ä¸ºäº†æœ‰å¥½çš„æŸ¥è¯¢æ•ˆç‡ï¼Œè¡¨ç»“æ„ä¹Ÿè¦æ”¹åŠ¨ï¼Œåšä¸€å®šçš„å†—ä½™ï¼Œåº”ç”¨ä¹Ÿè¦æ”¹ï¼Œsqlä¸­å°½é‡å¸¦sharding keyï¼Œå°†æ•°æ®å®šä½åˆ°é™å®šçš„è¡¨ä¸Šå»æŸ¥ï¼Œè€Œä¸æ˜¯æ‰«æå…¨éƒ¨çš„è¡¨ï¼› è¶…å¤§åˆ†é¡µæ€ä¹ˆå¤„ç† è¶…å¤§çš„åˆ†é¡µä¸€èˆ¬ä»ä¸¤ä¸ªæ–¹å‘ä¸Šæ¥è§£å†³. æ•°æ®åº“å±‚é¢,è¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¸»è¦é›†ä¸­å…³æ³¨çš„(è™½ç„¶æ”¶æ•ˆæ²¡é‚£ä¹ˆå¤§),ç±»ä¼¼äºselect * from table where age &gt; 20 limit 1000000,10è¿™ç§æŸ¥è¯¢å…¶å®ä¹Ÿæ˜¯æœ‰å¯ä»¥ä¼˜åŒ–çš„ä½™åœ°çš„. è¿™æ¡è¯­å¥éœ€è¦load1000000æ•°æ®ç„¶ååŸºæœ¬ä¸Šå…¨éƒ¨ä¸¢å¼ƒ,åªå–10æ¡å½“ç„¶æ¯”è¾ƒæ…¢. å½“æ—¶æˆ‘ä»¬å¯ä»¥ä¿®æ”¹ä¸ºselect * from table where id in (select id from table where age &gt; 20 limit 1000000,10).è¿™æ ·è™½ç„¶ä¹Ÿloadäº†ä¸€ç™¾ä¸‡çš„æ•°æ®,ä½†æ˜¯ç”±äºç´¢å¼•è¦†ç›–,è¦æŸ¥è¯¢çš„æ‰€æœ‰å­—æ®µéƒ½åœ¨ç´¢å¼•ä¸­,æ‰€ä»¥é€Ÿåº¦ä¼šå¾ˆå¿«. åŒæ—¶å¦‚æœIDè¿ç»­çš„å¥½,æˆ‘ä»¬è¿˜å¯ä»¥select * from table where id &gt; 1000000 limit 10,æ•ˆç‡ä¹Ÿæ˜¯ä¸é”™çš„,ä¼˜åŒ–çš„å¯èƒ½æ€§æœ‰è®¸å¤šç§,ä½†æ˜¯æ ¸å¿ƒæ€æƒ³éƒ½ä¸€æ ·,å°±æ˜¯å‡å°‘loadçš„æ•°æ®. ä»éœ€æ±‚çš„è§’åº¦å‡å°‘è¿™ç§è¯·æ±‚â€¦ä¸»è¦æ˜¯ä¸åšç±»ä¼¼çš„éœ€æ±‚(ç›´æ¥è·³è½¬åˆ°å‡ ç™¾ä¸‡é¡µä¹‹åçš„å…·ä½“æŸä¸€é¡µ.åªå…è®¸é€é¡µæŸ¥çœ‹æˆ–è€…æŒ‰ç…§ç»™å®šçš„è·¯çº¿èµ°,è¿™æ ·å¯é¢„æµ‹,å¯ç¼“å­˜)ä»¥åŠé˜²æ­¢IDæ³„æ¼ä¸”è¿ç»­è¢«äººæ¶æ„æ”»å‡». è§£å†³è¶…å¤§åˆ†é¡µ,å…¶å®ä¸»è¦æ˜¯é ç¼“å­˜,å¯é¢„æµ‹æ€§çš„æå‰æŸ¥åˆ°å†…å®¹,ç¼“å­˜è‡³redisç­‰k-Væ•°æ®åº“ä¸­,ç›´æ¥è¿”å›å³å¯. åœ¨é˜¿é‡Œå·´å·´ã€ŠJavaå¼€å‘æ‰‹å†Œã€‹ä¸­,å¯¹è¶…å¤§åˆ†é¡µçš„è§£å†³åŠæ³•æ˜¯ç±»ä¼¼äºä¸Šé¢æåˆ°çš„ç¬¬ä¸€ç§. ã€æ¨èã€‘åˆ©ç”¨å»¶è¿Ÿå…³è”æˆ–è€…å­æŸ¥è¯¢ä¼˜åŒ–è¶…å¤šåˆ†é¡µåœºæ™¯ã€‚ è¯´æ˜ï¼šMySQLå¹¶ä¸æ˜¯è·³è¿‡offsetè¡Œï¼Œè€Œæ˜¯å–offset+Nè¡Œï¼Œç„¶åè¿”å›æ”¾å¼ƒå‰offsetè¡Œï¼Œè¿”å›Nè¡Œï¼Œé‚£å½“offsetç‰¹åˆ«å¤§çš„æ—¶å€™ï¼Œæ•ˆç‡å°±éå¸¸çš„ä½ä¸‹ï¼Œè¦ä¹ˆæ§åˆ¶è¿”å›çš„æ€»é¡µæ•°ï¼Œè¦ä¹ˆå¯¹è¶…è¿‡ç‰¹å®šé˜ˆå€¼çš„é¡µæ•°è¿›è¡ŒSQLæ”¹å†™ã€‚ æ­£ä¾‹ï¼šå…ˆå¿«é€Ÿå®šä½éœ€è¦è·å–çš„idæ®µï¼Œç„¶åå†å…³è”ï¼š SELECT a.* FROM è¡¨1 a, (select id from è¡¨1 where æ¡ä»¶ LIMIT 100000,20 ) b where a.id=b.id mysql åˆ†é¡µ LIMIT å­å¥å¯ä»¥è¢«ç”¨äºå¼ºåˆ¶ SELECT è¯­å¥è¿”å›æŒ‡å®šçš„è®°å½•æ•°ã€‚LIMIT æ¥å—ä¸€ä¸ªæˆ–ä¸¤ä¸ªæ•°å­—å‚æ•°ã€‚å‚æ•°å¿…é¡»æ˜¯ä¸€ä¸ªæ•´æ•°å¸¸é‡ã€‚å¦‚æœç»™å®šä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šç¬¬ä¸€ä¸ªè¿”å›è®°å½•è¡Œçš„åç§»é‡ï¼Œç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šè¿”å›è®°å½•è¡Œçš„æœ€å¤§æ•°ç›®ã€‚åˆå§‹è®°å½•è¡Œçš„åç§»é‡æ˜¯ 0(è€Œä¸æ˜¯ 1) mysql&gt; SELECT * FROM table LIMIT 5,10; // æ£€ç´¢è®°å½•è¡Œ 6-15 ä¸ºäº†æ£€ç´¢ä»æŸä¸€ä¸ªåç§»é‡åˆ°è®°å½•é›†çš„ç»“æŸæ‰€æœ‰çš„è®°å½•è¡Œï¼Œå¯ä»¥æŒ‡å®šç¬¬äºŒä¸ªå‚æ•°ä¸º -1ï¼š mysql&gt; SELECT * FROM table LIMIT 95,-1; // æ£€ç´¢è®°å½•è¡Œ 96-last. å¦‚æœåªç»™å®šä¸€ä¸ªå‚æ•°ï¼Œå®ƒè¡¨ç¤ºè¿”å›æœ€å¤§çš„è®°å½•è¡Œæ•°ç›®ï¼š mysql&gt; SELECT * FROM table LIMIT 5; //æ£€ç´¢å‰ 5 ä¸ªè®°å½•è¡Œ æ¢å¥è¯è¯´ï¼ŒLIMIT n ç­‰ä»·äº LIMIT 0,nã€‚ æ…¢æŸ¥è¯¢æ—¥å¿— ç”¨äºè®°å½•æ‰§è¡Œæ—¶é—´è¶…è¿‡æŸä¸ªä¸´ç•Œå€¼çš„SQLæ—¥å¿—ï¼Œç”¨äºå¿«é€Ÿå®šä½æ…¢æŸ¥è¯¢ï¼Œä¸ºæˆ‘ä»¬çš„ä¼˜åŒ–åšå‚è€ƒã€‚ å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿— é…ç½®é¡¹ï¼šslow_query_log å¯ä»¥ä½¿ç”¨show variables like â€˜slov_query_logâ€™æŸ¥çœ‹æ˜¯å¦å¼€å¯ï¼Œå¦‚æœçŠ¶æ€å€¼ä¸ºOFFï¼Œå¯ä»¥ä½¿ç”¨set GLOBAL slow_query_log = onæ¥å¼€å¯ï¼Œå®ƒä¼šåœ¨datadirä¸‹äº§ç”Ÿä¸€ä¸ªxxx-slow.logçš„æ–‡ä»¶ã€‚ è®¾ç½®ä¸´ç•Œæ—¶é—´ é…ç½®é¡¹ï¼šlong_query_time æŸ¥çœ‹ï¼šshow VARIABLES like 'long_query_time'ï¼Œå•ä½ç§’ è®¾ç½®ï¼šset long_query_time=0.5 å®æ“æ—¶åº”è¯¥ä»é•¿æ—¶é—´è®¾ç½®åˆ°çŸ­çš„æ—¶é—´ï¼Œå³å°†æœ€æ…¢çš„SQLä¼˜åŒ–æ‰ æŸ¥çœ‹æ—¥å¿—ï¼Œä¸€æ—¦SQLè¶…è¿‡äº†æˆ‘ä»¬è®¾ç½®çš„ä¸´ç•Œæ—¶é—´å°±ä¼šè¢«è®°å½•åˆ°xxx-slow.logä¸­ æ…¢æŸ¥è¯¢å¤„ç† åœ¨ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œé™¤äº†ä½¿ç”¨ä¸»é”®è¿›è¡Œçš„æŸ¥è¯¢ï¼Œå…¶ä»–çš„ä¼šåœ¨æµ‹è¯•åº“ä¸Šæµ‹è¯•å…¶è€—æ—¶ï¼Œæ…¢æŸ¥è¯¢çš„ç»Ÿè®¡ä¸»è¦ç”±è¿ç»´åœ¨åšï¼Œä¼šå®šæœŸå°†ä¸šåŠ¡ä¸­çš„æ…¢æŸ¥è¯¢åé¦ˆç»™æˆ‘ä»¬ã€‚ æ…¢æŸ¥è¯¢çš„ä¼˜åŒ–é¦–å…ˆè¦ææ˜ç™½æ…¢çš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ æ˜¯æŸ¥è¯¢æ¡ä»¶æ²¡æœ‰å‘½ä¸­ç´¢å¼•ï¼Ÿæ˜¯loadäº†ä¸éœ€è¦çš„æ•°æ®åˆ—ï¼Ÿè¿˜æ˜¯æ•°æ®é‡å¤ªå¤§ï¼Ÿ æ‰€ä»¥ä¼˜åŒ–ä¹Ÿæ˜¯é’ˆå¯¹è¿™ä¸‰ä¸ªæ–¹å‘æ¥çš„ï¼Œ é¦–å…ˆåˆ†æè¯­å¥ï¼Œçœ‹çœ‹æ˜¯å¦loadäº†é¢å¤–çš„æ•°æ®ï¼Œå¯èƒ½æ˜¯æŸ¥è¯¢äº†å¤šä½™çš„è¡Œå¹¶ä¸”æŠ›å¼ƒæ‰äº†ï¼Œå¯èƒ½æ˜¯åŠ è½½äº†è®¸å¤šç»“æœä¸­å¹¶ä¸éœ€è¦çš„åˆ—ï¼Œå¯¹è¯­å¥è¿›è¡Œåˆ†æä»¥åŠé‡å†™ã€‚ åˆ†æè¯­å¥çš„æ‰§è¡Œè®¡åˆ’ï¼Œç„¶åè·å¾—å…¶ä½¿ç”¨ç´¢å¼•çš„æƒ…å†µï¼Œä¹‹åä¿®æ”¹è¯­å¥æˆ–è€…ä¿®æ”¹ç´¢å¼•ï¼Œä½¿å¾—è¯­å¥å¯ä»¥å°½å¯èƒ½çš„å‘½ä¸­ç´¢å¼•ã€‚ å¦‚æœå¯¹è¯­å¥çš„ä¼˜åŒ–å·²ç»æ— æ³•è¿›è¡Œï¼Œå¯ä»¥è€ƒè™‘è¡¨ä¸­çš„æ•°æ®é‡æ˜¯å¦å¤ªå¤§ï¼Œå¦‚æœæ˜¯çš„è¯å¯ä»¥è¿›è¡Œæ¨ªå‘æˆ–è€…çºµå‘çš„åˆ†è¡¨ã€‚ ä¸»é”®å¿…è¦æ€§ ä¸»é”®æ˜¯æ•°æ®åº“ç¡®ä¿æ•°æ®è¡Œåœ¨æ•´å¼ è¡¨å”¯ä¸€æ€§çš„ä¿éšœï¼Œå³ä½¿ä¸šåŠ¡ä¸Šæœ¬å¼ è¡¨æ²¡æœ‰ä¸»é”®ï¼Œä¹Ÿå»ºè®®æ·»åŠ ä¸€ä¸ªè‡ªå¢é•¿çš„IDåˆ—ä½œä¸ºä¸»é”®ã€‚è®¾å®šäº†ä¸»é”®ä¹‹åï¼Œåœ¨åç»­çš„åˆ æ”¹æŸ¥çš„æ—¶å€™å¯èƒ½æ›´åŠ å¿«é€Ÿä»¥åŠç¡®ä¿æ“ä½œæ•°æ®èŒƒå›´å®‰å…¨ã€‚ ä¸»é”®ä½¿ç”¨è‡ªå¢IDè¿˜æ˜¯UUID æ¨èä½¿ç”¨è‡ªå¢IDï¼Œä¸è¦ä½¿ç”¨UUIDã€‚ å› ä¸ºåœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼Œä¸»é”®ç´¢å¼•æ˜¯ä½œä¸ºèšç°‡ç´¢å¼•å­˜åœ¨çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸»é”®ç´¢å¼•çš„B+æ ‘å¶å­èŠ‚ç‚¹ä¸Šå­˜å‚¨äº†ä¸»é”®ç´¢å¼•ä»¥åŠå…¨éƒ¨çš„æ•°æ®(æŒ‰ç…§é¡ºåº)ï¼Œå¦‚æœä¸»é”®ç´¢å¼•æ˜¯è‡ªå¢IDï¼Œé‚£ä¹ˆåªéœ€è¦ä¸æ–­å‘åæ’åˆ—å³å¯ï¼Œå¦‚æœæ˜¯UUIDï¼Œç”±äºåˆ°æ¥çš„IDä¸åŸæ¥çš„å¤§å°ä¸ç¡®å®šï¼Œä¼šé€ æˆéå¸¸å¤šçš„æ•°æ®æ’å…¥ï¼Œæ•°æ®ç§»åŠ¨ï¼Œç„¶åå¯¼è‡´äº§ç”Ÿå¾ˆå¤šçš„å†…å­˜ç¢ç‰‡ï¼Œè¿›è€Œé€ æˆæ’å…¥æ€§èƒ½çš„ä¸‹é™ã€‚ æ€»ä¹‹ï¼Œåœ¨æ•°æ®é‡å¤§ä¸€äº›çš„æƒ…å†µä¸‹ï¼Œç”¨è‡ªå¢ä¸»é”®æ€§èƒ½ä¼šå¥½ä¸€äº›ã€‚ ç”±äºä¸»é”®æ˜¯èšç°‡ç´¢å¼•ï¼Œå¦‚æœæ²¡æœ‰ä¸»é”®ï¼ŒInnoDBä¼šé€‰æ‹©ä¸€ä¸ªå”¯ä¸€é”®æ¥ä½œä¸ºèšç°‡ç´¢å¼•ï¼Œå¦‚æœæ²¡æœ‰å”¯ä¸€é”®ï¼Œä¼šç”Ÿæˆä¸€ä¸ªéšå¼çš„ä¸»é”®ã€‚ å­—æ®µä¸ºä»€ä¹ˆè¦æ±‚å®šä¹‰ä¸ºnot null nullå€¼ä¼šå ç”¨æ›´å¤šçš„å­—èŠ‚ï¼Œä¸”ä¼šåœ¨ç¨‹åºä¸­é€ æˆå¾ˆå¤šä¸é¢„æœŸä¸ç¬¦çš„æƒ…å†µã€‚ å¦‚æœè¦å­˜å‚¨ç”¨æˆ·çš„å¯†ç æ•£åˆ—ï¼Œåº”è¯¥ä½¿ç”¨ä»€ä¹ˆå­—æ®µè¿›è¡Œå­˜å‚¨ï¼Ÿ å¯†ç æ•£åˆ—ï¼Œç›ï¼Œç”¨æˆ·èº«ä»½è¯å·ç­‰å›ºå®šé•¿åº¦çš„å­—ç¬¦ä¸²åº”è¯¥ä½¿ç”¨charè€Œä¸æ˜¯varcharæ¥å­˜å‚¨ï¼Œè¿™æ ·å¯ä»¥èŠ‚çœç©ºé—´ä¸”æé«˜æ£€ç´¢æ•ˆç‡ã€‚ ä¼˜åŒ–æŸ¥è¯¢è¿‡ç¨‹ä¸­çš„æ•°æ®è®¿é—® è®¿é—®æ•°æ®å¤ªå¤šå¯¼è‡´æŸ¥è¯¢æ€§èƒ½ä¸‹é™ ç¡®å®šåº”ç”¨ç¨‹åºæ˜¯å¦åœ¨æ£€ç´¢å¤§é‡è¶…è¿‡éœ€è¦çš„æ•°æ®ï¼Œå¯èƒ½æ˜¯å¤ªå¤šè¡Œæˆ–åˆ— ç¡®è®¤MySQLæœåŠ¡å™¨æ˜¯å¦åœ¨åˆ†æå¤§é‡ä¸å¿…è¦çš„æ•°æ®è¡Œ é¿å…çŠ¯å¦‚ä¸‹SQLè¯­å¥é”™è¯¯ æŸ¥è¯¢ä¸éœ€è¦çš„æ•°æ®ã€‚è§£å†³åŠæ³•ï¼šä½¿ç”¨limitè§£å†³ å¤šè¡¨å…³è”è¿”å›å…¨éƒ¨åˆ—ã€‚è§£å†³åŠæ³•ï¼šæŒ‡å®šåˆ—å æ€»æ˜¯è¿”å›å…¨éƒ¨åˆ—ã€‚è§£å†³åŠæ³•ï¼šé¿å…ä½¿ç”¨SELECT * é‡å¤æŸ¥è¯¢ç›¸åŒçš„æ•°æ®ã€‚è§£å†³åŠæ³•ï¼šå¯ä»¥ç¼“å­˜æ•°æ®ï¼Œä¸‹æ¬¡ç›´æ¥è¯»å–ç¼“å­˜ æ˜¯å¦åœ¨æ‰«æé¢å¤–çš„è®°å½•ã€‚è§£å†³åŠæ³•ï¼š ä½¿ç”¨explainè¿›è¡Œåˆ†æï¼Œå¦‚æœå‘ç°æŸ¥è¯¢éœ€è¦æ‰«æå¤§é‡çš„æ•°æ®ï¼Œä½†åªè¿”å›å°‘æ•°çš„è¡Œï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æŠ€å·§å»ä¼˜åŒ–ï¼š ä½¿ç”¨ç´¢å¼•è¦†ç›–æ‰«æï¼ŒæŠŠæ‰€æœ‰çš„åˆ—éƒ½æ”¾åˆ°ç´¢å¼•ä¸­ï¼Œè¿™æ ·å­˜å‚¨å¼•æ“ä¸éœ€è¦å›è¡¨è·å–å¯¹åº”è¡Œå°±å¯ä»¥è¿”å›ç»“æœã€‚ æ”¹å˜æ•°æ®åº“å’Œè¡¨çš„ç»“æ„ï¼Œä¿®æ”¹æ•°æ®è¡¨èŒƒå¼ é‡å†™SQLè¯­å¥ï¼Œè®©ä¼˜åŒ–å™¨å¯ä»¥ä»¥æ›´ä¼˜çš„æ–¹å¼æ‰§è¡ŒæŸ¥è¯¢ã€‚ ä¼˜åŒ–é•¿éš¾çš„æŸ¥è¯¢è¯­å¥ ä¸€ä¸ªå¤æ‚æŸ¥è¯¢è¿˜æ˜¯å¤šä¸ªç®€å•æŸ¥è¯¢ MySQLå†…éƒ¨æ¯ç§’èƒ½æ‰«æå†…å­˜ä¸­ä¸Šç™¾ä¸‡è¡Œæ•°æ®ï¼Œç›¸æ¯”ä¹‹ä¸‹ï¼Œå“åº”æ•°æ®ç»™å®¢æˆ·ç«¯å°±è¦æ…¢å¾—å¤š ä½¿ç”¨å°½å¯èƒ½å°çš„æŸ¥è¯¢æ˜¯å¥½çš„ï¼Œä½†æ˜¯æœ‰æ—¶å°†ä¸€ä¸ªå¤§çš„æŸ¥è¯¢åˆ†è§£ä¸ºå¤šä¸ªå°çš„æŸ¥è¯¢æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚ åˆ‡åˆ†æŸ¥è¯¢ å°†ä¸€ä¸ªå¤§çš„æŸ¥è¯¢åˆ†ä¸ºå¤šä¸ªå°çš„ç›¸åŒçš„æŸ¥è¯¢ ä¸€æ¬¡æ€§åˆ é™¤1000ä¸‡çš„æ•°æ®è¦æ¯”ä¸€æ¬¡åˆ é™¤1ä¸‡ï¼Œæš‚åœä¸€ä¼šçš„æ–¹æ¡ˆæ›´åŠ æŸè€—æœåŠ¡å™¨å¼€é”€ã€‚ åˆ†è§£å…³è”æŸ¥è¯¢ï¼Œè®©ç¼“å­˜çš„æ•ˆç‡æ›´é«˜ã€‚ æ‰§è¡Œå•ä¸ªæŸ¥è¯¢å¯ä»¥å‡å°‘é”çš„ç«äº‰ã€‚ åœ¨åº”ç”¨å±‚åšå…³è”æ›´å®¹æ˜“å¯¹æ•°æ®åº“è¿›è¡Œæ‹†åˆ†ã€‚ æŸ¥è¯¢æ•ˆç‡ä¼šæœ‰å¤§å¹…æå‡ã€‚ è¾ƒå°‘å†—ä½™è®°å½•çš„æŸ¥è¯¢ã€‚ ä¼˜åŒ–ç‰¹å®šç±»å‹çš„æŸ¥è¯¢è¯­å¥ count(*)ä¼šå¿½ç•¥æ‰€æœ‰çš„åˆ—ï¼Œç›´æ¥ç»Ÿè®¡æ‰€æœ‰åˆ—æ•°ï¼Œä¸è¦ä½¿ç”¨count(åˆ—å) MyISAMä¸­ï¼Œæ²¡æœ‰ä»»ä½•whereæ¡ä»¶çš„count(*)éå¸¸å¿«ã€‚ å½“æœ‰whereæ¡ä»¶æ—¶ï¼ŒMyISAMçš„countç»Ÿè®¡ä¸ä¸€å®šæ¯”å…¶å®ƒå¼•æ“å¿«ã€‚ å¯ä»¥ä½¿ç”¨explainæŸ¥è¯¢è¿‘ä¼¼å€¼ï¼Œç”¨è¿‘ä¼¼å€¼æ›¿ä»£count(*) å¢åŠ æ±‡æ€»è¡¨ ä½¿ç”¨ç¼“å­˜ ä¼˜åŒ–å…³è”æŸ¥è¯¢ ç¡®å®šONæˆ–è€…USINGå­å¥ä¸­æ˜¯å¦æœ‰ç´¢å¼•ã€‚ ç¡®ä¿GROUP BYå’ŒORDER BYåªæœ‰ä¸€ä¸ªè¡¨ä¸­çš„åˆ—ï¼Œè¿™æ ·MySQLæ‰æœ‰å¯èƒ½ä½¿ç”¨ç´¢å¼•ã€‚ ä¼˜åŒ–å­æŸ¥è¯¢ ç”¨å…³è”æŸ¥è¯¢æ›¿ä»£ ä¼˜åŒ–GROUP BYå’ŒDISTINCT è¿™ä¸¤ç§æŸ¥è¯¢å¯ä»¥ä½¿ç”¨ç´¢å¼•æ¥ä¼˜åŒ–ï¼Œæ˜¯æœ€æœ‰æ•ˆçš„ä¼˜åŒ–æ–¹æ³• å…³è”æŸ¥è¯¢ä¸­ï¼Œä½¿ç”¨æ ‡è¯†åˆ—åˆ†ç»„çš„æ•ˆç‡æ›´é«˜ å¦‚æœä¸éœ€è¦ORDER BYï¼Œè¿›è¡ŒGROUP BYæ—¶åŠ ORDER BY NULLï¼ŒMySQLä¸ä¼šå†è¿›è¡Œæ–‡ä»¶æ’åºã€‚ WITH ROLLUPè¶…çº§èšåˆï¼Œå¯ä»¥æŒªåˆ°åº”ç”¨ç¨‹åºå¤„ç† ä¼˜åŒ–LIMITåˆ†é¡µ LIMITåç§»é‡å¤§çš„æ—¶å€™ï¼ŒæŸ¥è¯¢æ•ˆç‡è¾ƒä½ å¯ä»¥è®°å½•ä¸Šæ¬¡æŸ¥è¯¢çš„æœ€å¤§IDï¼Œä¸‹æ¬¡æŸ¥è¯¢æ—¶ç›´æ¥æ ¹æ®è¯¥IDæ¥æŸ¥è¯¢ ä¼˜åŒ–UNIONæŸ¥è¯¢ UNION ALLçš„æ•ˆç‡é«˜äºUNION ä¼˜åŒ–WHEREå­å¥ å¯¹äºæ­¤ç±»é—®é¢˜ï¼Œå…ˆè¯´æ˜å¦‚ä½•å®šä½ä½æ•ˆSQLè¯­å¥ï¼Œç„¶åæ ¹æ®SQLè¯­å¥å¯èƒ½ä½æ•ˆçš„åŸå› åšæ’æŸ¥ï¼Œå…ˆä»ç´¢å¼•ç€æ‰‹ï¼Œå¦‚æœç´¢å¼•æ²¡æœ‰é—®é¢˜ï¼Œè€ƒè™‘ä»¥ä¸Šå‡ ä¸ªæ–¹é¢ï¼Œæ•°æ®è®¿é—®çš„é—®é¢˜ï¼Œé•¿éš¾æŸ¥è¯¢å¥çš„é—®é¢˜è¿˜æ˜¯ä¸€äº›ç‰¹å®šç±»å‹ä¼˜åŒ–çš„é—®é¢˜ï¼Œé€ä¸€å›ç­”ã€‚ SQLè¯­å¥ä¼˜åŒ–çš„ä¸€äº›æ–¹æ³•ï¼Ÿ 1.å¯¹æŸ¥è¯¢è¿›è¡Œä¼˜åŒ–ï¼Œåº”å°½é‡é¿å…å…¨è¡¨æ‰«æï¼Œé¦–å…ˆåº”è€ƒè™‘åœ¨ where åŠ order by æ¶‰åŠçš„åˆ—ä¸Šå»ºç«‹ç´¢å¼•ã€‚ 2.åº”å°½é‡é¿å…åœ¨ where å­å¥ä¸­å¯¹å­—æ®µè¿›è¡Œ null å€¼åˆ¤æ–­ï¼Œå¦åˆ™å°†å¯¼è‡´å¼•æ“æ”¾å¼ƒä½¿ç”¨ç´¢å¼•è€Œè¿›è¡Œå…¨è¡¨æ‰«æï¼Œå¦‚ï¼š select id from t where num is null -- å¯ä»¥åœ¨numä¸Šè®¾ç½®é»˜è®¤å€¼0ï¼Œç¡®ä¿è¡¨ä¸­numåˆ—æ²¡æœ‰nullå€¼ï¼Œç„¶åè¿™æ ·æŸ¥è¯¢ï¼š select id from t where num=0 3.åº”å°½é‡é¿å…åœ¨ where å­å¥ä¸­ä½¿ç”¨!=æˆ–&lt;&gt;æ“ä½œç¬¦ï¼Œå¦åˆ™å¼•æ“å°†æ”¾å¼ƒä½¿ç”¨ç´¢å¼•è€Œè¿›è¡Œå…¨è¡¨æ‰«æã€‚ 4.åº”å°½é‡é¿å…åœ¨ where å­å¥ä¸­ä½¿ç”¨or æ¥è¿æ¥æ¡ä»¶ï¼Œå¦åˆ™å°†å¯¼è‡´å¼•æ“æ”¾å¼ƒä½¿ç”¨ç´¢å¼•è€Œè¿›è¡Œå…¨è¡¨æ‰«æï¼Œå¦‚ï¼š select id from t where num=10 or num=20 -- å¯ä»¥è¿™æ ·æŸ¥è¯¢ï¼š select id from t where num=10 union all select id from t where num=20 5.in å’Œ not in ä¹Ÿè¦æ…ç”¨ï¼Œå¦åˆ™ä¼šå¯¼è‡´å…¨è¡¨æ‰«æï¼Œå¦‚ï¼š select id from t where num in(1,2,3) -- å¯¹äºè¿ç»­çš„æ•°å€¼ï¼Œèƒ½ç”¨ between å°±ä¸è¦ç”¨ in äº†ï¼š select id from t where num between 1 and 3 6.ä¸‹é¢çš„æŸ¥è¯¢ä¹Ÿå°†å¯¼è‡´å…¨è¡¨æ‰«æï¼š select id from t where name like â€˜%æ%â€™ -- è‹¥è¦æé«˜æ•ˆç‡ï¼Œå¯ä»¥è€ƒè™‘å…¨æ–‡æ£€ç´¢ã€‚ 7.å¦‚æœåœ¨ where å­å¥ä¸­ä½¿ç”¨å‚æ•°ï¼Œä¹Ÿä¼šå¯¼è‡´å…¨è¡¨æ‰«æã€‚å› ä¸ºSQLåªæœ‰åœ¨è¿è¡Œæ—¶æ‰ä¼šè§£æå±€éƒ¨å˜é‡ï¼Œä½†ä¼˜åŒ–ç¨‹åºä¸èƒ½å°†è®¿é—®è®¡åˆ’çš„é€‰æ‹©æ¨è¿Ÿåˆ°è¿è¡Œæ—¶ï¼›å®ƒå¿…é¡»åœ¨ç¼–è¯‘æ—¶è¿›è¡Œé€‰æ‹©ã€‚ç„¶ è€Œï¼Œå¦‚æœåœ¨ç¼–è¯‘æ—¶å»ºç«‹è®¿é—®è®¡åˆ’ï¼Œå˜é‡çš„å€¼è¿˜æ˜¯æœªçŸ¥çš„ï¼Œå› è€Œæ— æ³•ä½œä¸ºç´¢å¼•é€‰æ‹©çš„è¾“å…¥é¡¹ã€‚å¦‚ä¸‹é¢è¯­å¥å°†è¿›è¡Œå…¨è¡¨æ‰«æï¼š select id from t where num=@num -- å¯ä»¥æ”¹ä¸ºå¼ºåˆ¶æŸ¥è¯¢ä½¿ç”¨ç´¢å¼•ï¼š select id from t with(index(ç´¢å¼•å)) where num=@num 8.åº”å°½é‡é¿å…åœ¨ where å­å¥ä¸­å¯¹å­—æ®µè¿›è¡Œè¡¨è¾¾å¼æ“ä½œï¼Œè¿™å°†å¯¼è‡´å¼•æ“æ”¾å¼ƒä½¿ç”¨ç´¢å¼•è€Œè¿›è¡Œå…¨è¡¨æ‰«æã€‚å¦‚ï¼š select id from t where num/2=100 -- åº”æ”¹ä¸º: select id from t where num=100*2 9.åº”å°½é‡é¿å…åœ¨whereå­å¥ä¸­å¯¹å­—æ®µè¿›è¡Œå‡½æ•°æ“ä½œï¼Œè¿™å°†å¯¼è‡´å¼•æ“æ”¾å¼ƒä½¿ç”¨ç´¢å¼•è€Œè¿›è¡Œå…¨è¡¨æ‰«æã€‚å¦‚ï¼š select id from t where substring(name,1,3)=â€™abcâ€™ -- nameä»¥abcå¼€å¤´çš„idåº”æ”¹ä¸º: select id from t where name like â€˜abc%â€™ 10.ä¸è¦åœ¨ where å­å¥ä¸­çš„â€œ=â€å·¦è¾¹è¿›è¡Œå‡½æ•°ã€ç®—æœ¯è¿ç®—æˆ–å…¶ä»–è¡¨è¾¾å¼è¿ç®—ï¼Œå¦åˆ™ç³»ç»Ÿå°†å¯èƒ½æ— æ³•æ­£ç¡®ä½¿ç”¨ç´¢å¼•ã€‚ ","link":"https://tianxiawuhao.github.io/lbX34toJL/"},{"title":"mysqlæ¦‚è¿°å››","content":"è§†å›¾ ä¸ºäº†æé«˜å¤æ‚SQLè¯­å¥çš„å¤ç”¨æ€§å’Œè¡¨æ“ä½œçš„å®‰å…¨æ€§ï¼ŒMySQLæ•°æ®åº“ç®¡ç†ç³»ç»Ÿæä¾›äº†è§†å›¾ç‰¹æ€§ã€‚æ‰€è°“è§†å›¾ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ç§è™šæ‹Ÿè¡¨ï¼Œåœ¨ç‰©ç†ä¸Šæ˜¯ä¸å­˜åœ¨çš„ï¼Œå…¶å†…å®¹ä¸çœŸå®çš„è¡¨ç›¸ä¼¼ï¼ŒåŒ…å«ä¸€ç³»åˆ—å¸¦æœ‰åç§°çš„åˆ—å’Œè¡Œæ•°æ®ã€‚ä½†æ˜¯ï¼Œè§†å›¾å¹¶ä¸åœ¨æ•°æ®åº“ä¸­ä»¥å‚¨å­˜çš„æ•°æ®å€¼å½¢å¼å­˜åœ¨ã€‚è¡Œå’Œåˆ—æ•°æ®æ¥è‡ªå®šä¹‰è§†å›¾çš„æŸ¥è¯¢æ‰€å¼•ç”¨åŸºæœ¬è¡¨ï¼Œå¹¶ä¸”åœ¨å…·ä½“å¼•ç”¨è§†å›¾æ—¶åŠ¨æ€ç”Ÿæˆã€‚ è§†å›¾ä½¿å¼€å‘è€…åªå…³å¿ƒæ„Ÿå…´è¶£çš„æŸäº›ç‰¹å®šæ•°æ®å’Œæ‰€è´Ÿè´£çš„ç‰¹å®šä»»åŠ¡ï¼Œåªèƒ½çœ‹åˆ°è§†å›¾ä¸­æ‰€å®šä¹‰çš„æ•°æ®ï¼Œè€Œä¸æ˜¯è§†å›¾æ‰€å¼•ç”¨è¡¨ä¸­çš„æ•°æ®ï¼Œä»è€Œæé«˜äº†æ•°æ®åº“ä¸­æ•°æ®çš„å®‰å…¨æ€§ã€‚ ç‰¹ç‚¹ è§†å›¾çš„ç‰¹ç‚¹å¦‚ä¸‹: è§†å›¾çš„åˆ—å¯ä»¥æ¥è‡ªä¸åŒçš„è¡¨ï¼Œæ˜¯è¡¨çš„æŠ½è±¡å’Œåœ¨é€»è¾‘æ„ä¹‰ä¸Šå»ºç«‹çš„æ–°å…³ç³»ã€‚ è§†å›¾æ˜¯ç”±åŸºæœ¬è¡¨(å®è¡¨)äº§ç”Ÿçš„è¡¨(è™šè¡¨)ã€‚ è§†å›¾çš„å»ºç«‹å’Œåˆ é™¤ä¸å½±å“åŸºæœ¬è¡¨ã€‚ å¯¹è§†å›¾å†…å®¹çš„æ›´æ–°(æ·»åŠ ï¼Œåˆ é™¤å’Œä¿®æ”¹)ç›´æ¥å½±å“åŸºæœ¬è¡¨ã€‚ å½“è§†å›¾æ¥è‡ªå¤šä¸ªåŸºæœ¬è¡¨æ—¶ï¼Œä¸å…è®¸æ·»åŠ å’Œåˆ é™¤æ•°æ®ã€‚ è§†å›¾çš„æ“ä½œåŒ…æ‹¬åˆ›å»ºè§†å›¾ï¼ŒæŸ¥çœ‹è§†å›¾ï¼Œåˆ é™¤è§†å›¾å’Œä¿®æ”¹è§†å›¾ã€‚ ä½¿ç”¨åœºæ™¯ è§†å›¾æ ¹æœ¬ç”¨é€”ï¼šç®€åŒ–sqlæŸ¥è¯¢ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚å¦‚æœè¯´è¿˜æœ‰å¦å¤–ä¸€ä¸ªç”¨é€”é‚£å°±æ˜¯å…¼å®¹è€çš„è¡¨ç»“æ„ã€‚ ä¸‹é¢æ˜¯è§†å›¾çš„å¸¸è§ä½¿ç”¨åœºæ™¯ï¼š é‡ç”¨SQLè¯­å¥ï¼› ç®€åŒ–å¤æ‚çš„SQLæ“ä½œã€‚åœ¨ç¼–å†™æŸ¥è¯¢åï¼Œå¯ä»¥æ–¹ä¾¿çš„é‡ç”¨å®ƒè€Œä¸å¿…çŸ¥é“å®ƒçš„åŸºæœ¬æŸ¥è¯¢ç»†èŠ‚ï¼› ä½¿ç”¨è¡¨çš„ç»„æˆéƒ¨åˆ†è€Œä¸æ˜¯æ•´ä¸ªè¡¨ï¼› ä¿æŠ¤æ•°æ®ã€‚å¯ä»¥ç»™ç”¨æˆ·æˆäºˆè¡¨çš„ç‰¹å®šéƒ¨åˆ†çš„è®¿é—®æƒé™è€Œä¸æ˜¯æ•´ä¸ªè¡¨çš„è®¿é—®æƒé™ï¼› æ›´æ”¹æ•°æ®æ ¼å¼å’Œè¡¨ç¤ºã€‚è§†å›¾å¯è¿”å›ä¸åº•å±‚è¡¨çš„è¡¨ç¤ºå’Œæ ¼å¼ä¸åŒçš„æ•°æ®ã€‚ ä¼˜ç‚¹ æŸ¥è¯¢ç®€å•åŒ–ã€‚è§†å›¾èƒ½ç®€åŒ–ç”¨æˆ·çš„æ“ä½œ æ•°æ®å®‰å…¨æ€§ã€‚è§†å›¾ä½¿ç”¨æˆ·èƒ½ä»¥å¤šç§è§’åº¦çœ‹å¾…åŒä¸€æ•°æ®ï¼Œèƒ½å¤Ÿå¯¹æœºå¯†æ•°æ®æä¾›å®‰å…¨ä¿æŠ¤ é€»è¾‘æ•°æ®ç‹¬ç«‹æ€§ã€‚è§†å›¾å¯¹é‡æ„æ•°æ®åº“æä¾›äº†ä¸€å®šç¨‹åº¦çš„é€»è¾‘ç‹¬ç«‹æ€§ ç¼ºç‚¹ æ€§èƒ½ã€‚æ•°æ®åº“å¿…é¡»æŠŠè§†å›¾çš„æŸ¥è¯¢è½¬åŒ–æˆå¯¹åŸºæœ¬è¡¨çš„æŸ¥è¯¢ï¼Œå¦‚æœè¿™ä¸ªè§†å›¾æ˜¯ç”±ä¸€ä¸ªå¤æ‚çš„å¤šè¡¨æŸ¥è¯¢æ‰€å®šä¹‰ï¼Œé‚£ä¹ˆï¼Œå³ä½¿æ˜¯è§†å›¾çš„ä¸€ä¸ªç®€å•æŸ¥è¯¢ï¼Œæ•°æ®åº“ä¹ŸæŠŠå®ƒå˜æˆä¸€ä¸ªå¤æ‚çš„ç»“åˆä½“ï¼Œéœ€è¦èŠ±è´¹ä¸€å®šçš„æ—¶é—´ã€‚ ä¿®æ”¹é™åˆ¶ã€‚å½“ç”¨æˆ·è¯•å›¾ä¿®æ”¹è§†å›¾çš„æŸäº›è¡Œæ—¶ï¼Œæ•°æ®åº“å¿…é¡»æŠŠå®ƒè½¬åŒ–ä¸ºå¯¹åŸºæœ¬è¡¨çš„æŸäº›è¡Œçš„ä¿®æ”¹ã€‚äº‹å®ä¸Šï¼Œå½“ä»è§†å›¾ä¸­æ’å…¥æˆ–è€…åˆ é™¤æ—¶ï¼Œæƒ…å†µä¹Ÿæ˜¯è¿™æ ·ã€‚å¯¹äºç®€å•è§†å›¾æ¥è¯´ï¼Œè¿™æ˜¯å¾ˆæ–¹ä¾¿çš„ï¼Œä½†æ˜¯ï¼Œå¯¹äºæ¯”è¾ƒå¤æ‚çš„è§†å›¾ï¼Œå¯èƒ½æ˜¯ä¸å¯ä¿®æ”¹çš„ è¿™äº›è§†å›¾æœ‰å¦‚ä¸‹ç‰¹å¾ï¼š æœ‰UNIQUEç­‰é›†åˆæ“ä½œç¬¦çš„è§†å›¾ã€‚ æœ‰GROUP BYå­å¥çš„è§†å›¾ã€‚ æœ‰è¯¸å¦‚AVG\\SUM\\MAXç­‰èšåˆå‡½æ•°çš„è§†å›¾ã€‚ ä½¿ç”¨DISTINCTå…³é”®å­—çš„è§†å›¾ã€‚ è¿æ¥è¡¨çš„è§†å›¾ï¼ˆå…¶ä¸­æœ‰äº›ä¾‹å¤–ï¼‰ æ¸¸æ ‡ æ¸¸æ ‡æ˜¯ç³»ç»Ÿä¸ºç”¨æˆ·å¼€è®¾çš„ä¸€ä¸ªæ•°æ®ç¼“å†²åŒºï¼Œå­˜æ”¾SQLè¯­å¥çš„æ‰§è¡Œç»“æœï¼Œæ¯ä¸ªæ¸¸æ ‡åŒºéƒ½æœ‰ä¸€ä¸ªåå­—ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡æ¸¸æ ‡é€ä¸€è·å–è®°å½•å¹¶èµ‹ç»™ä¸»å˜é‡ï¼Œäº¤ç”±ä¸»è¯­è¨€è¿›ä¸€æ­¥å¤„ç†ã€‚ å­˜å‚¨è¿‡ç¨‹ä¸å‡½æ•° å­˜å‚¨è¿‡ç¨‹æ˜¯ä¸€ä¸ªé¢„ç¼–è¯‘çš„SQLè¯­å¥ï¼Œä¼˜ç‚¹æ˜¯å…è®¸æ¨¡å—åŒ–çš„è®¾è®¡ï¼Œå°±æ˜¯è¯´åªéœ€è¦åˆ›å»ºä¸€æ¬¡ï¼Œä»¥ååœ¨è¯¥ç¨‹åºä¸­å°±å¯ä»¥è°ƒç”¨å¤šæ¬¡ã€‚å¦‚æœæŸæ¬¡æ“ä½œéœ€è¦æ‰§è¡Œå¤šæ¬¡SQLï¼Œä½¿ç”¨å­˜å‚¨è¿‡ç¨‹æ¯”å•çº¯SQLè¯­å¥æ‰§è¡Œè¦å¿«ã€‚ ä¼˜ç‚¹ å­˜å‚¨è¿‡ç¨‹æ˜¯é¢„ç¼–è¯‘è¿‡çš„ï¼Œæ‰§è¡Œæ•ˆç‡é«˜ã€‚ å­˜å‚¨è¿‡ç¨‹çš„ä»£ç ç›´æ¥å­˜æ”¾äºæ•°æ®åº“ä¸­ï¼Œé€šè¿‡å­˜å‚¨è¿‡ç¨‹åç›´æ¥è°ƒç”¨ï¼Œå‡å°‘ç½‘ç»œé€šè®¯ã€‚ å®‰å…¨æ€§é«˜ï¼Œæ‰§è¡Œå­˜å‚¨è¿‡ç¨‹éœ€è¦æœ‰ä¸€å®šæƒé™çš„ç”¨æˆ·ã€‚ å­˜å‚¨è¿‡ç¨‹å¯ä»¥é‡å¤ä½¿ç”¨ï¼Œå‡å°‘æ•°æ®åº“å¼€å‘äººå‘˜çš„å·¥ä½œé‡ã€‚ ç¼ºç‚¹ 1ï¼‰è°ƒè¯•éº»çƒ¦ï¼Œä½†æ˜¯ç”¨ PL/SQL Developer è°ƒè¯•å¾ˆæ–¹ä¾¿ï¼å¼¥è¡¥è¿™ä¸ªç¼ºç‚¹ã€‚ 2ï¼‰ç§»æ¤é—®é¢˜ï¼Œæ•°æ®åº“ç«¯ä»£ç å½“ç„¶æ˜¯ä¸æ•°æ®åº“ç›¸å…³çš„ã€‚ä½†æ˜¯å¦‚æœæ˜¯åšå·¥ç¨‹å‹é¡¹ç›®ï¼ŒåŸºæœ¬ä¸å­˜åœ¨ç§»æ¤é—®é¢˜ã€‚ 3ï¼‰é‡æ–°ç¼–è¯‘é—®é¢˜ï¼Œå› ä¸ºåç«¯ä»£ç æ˜¯è¿è¡Œå‰ç¼–è¯‘çš„ï¼Œå¦‚æœå¸¦æœ‰å¼•ç”¨å…³ç³»çš„å¯¹è±¡å‘ç”Ÿæ”¹å˜æ—¶ï¼Œå—å½±å“çš„å­˜å‚¨è¿‡ç¨‹ã€åŒ…å°†éœ€è¦é‡æ–°ç¼–è¯‘ï¼ˆä¸è¿‡ä¹Ÿå¯ä»¥è®¾ç½®æˆè¿è¡Œæ—¶åˆ»è‡ªåŠ¨ç¼–è¯‘ï¼‰ã€‚ 4ï¼‰å¦‚æœåœ¨ä¸€ä¸ªç¨‹åºç³»ç»Ÿä¸­å¤§é‡çš„ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹ï¼Œåˆ°ç¨‹åºäº¤ä»˜ä½¿ç”¨çš„æ—¶å€™éšç€ç”¨æˆ·éœ€æ±‚çš„å¢åŠ ä¼šå¯¼è‡´æ•°æ®ç»“æ„çš„å˜åŒ–ï¼Œæ¥ç€å°±æ˜¯ç³»ç»Ÿçš„ç›¸å…³é—®é¢˜äº†ï¼Œæœ€åå¦‚æœç”¨æˆ·æƒ³ç»´æŠ¤è¯¥ç³»ç»Ÿå¯ä»¥è¯´æ˜¯å¾ˆéš¾å¾ˆéš¾ã€è€Œä¸”ä»£ä»·æ˜¯ç©ºå‰çš„ï¼Œç»´æŠ¤èµ·æ¥æ›´éº»çƒ¦ã€‚ è§¦å‘å™¨ è§¦å‘å™¨æ˜¯ç”¨æˆ·å®šä¹‰åœ¨å…³ç³»è¡¨ä¸Šçš„ä¸€ç±»ç”±äº‹ä»¶é©±åŠ¨çš„ç‰¹æ®Šçš„å­˜å‚¨è¿‡ç¨‹ã€‚è§¦å‘å™¨æ˜¯æŒ‡ä¸€æ®µä»£ç ï¼Œå½“è§¦å‘æŸä¸ªäº‹ä»¶æ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œè¿™äº›ä»£ç ã€‚ ä½¿ç”¨åœºæ™¯ å¯ä»¥é€šè¿‡æ•°æ®åº“ä¸­çš„ç›¸å…³è¡¨å®ç°çº§è”æ›´æ”¹ã€‚ å®æ—¶ç›‘æ§æŸå¼ è¡¨ä¸­çš„æŸä¸ªå­—æ®µçš„æ›´æ”¹è€Œéœ€è¦åšå‡ºç›¸åº”çš„å¤„ç†ã€‚ ä¾‹å¦‚å¯ä»¥ç”ŸæˆæŸäº›ä¸šåŠ¡çš„ç¼–å·ã€‚ æ³¨æ„ä¸è¦æ»¥ç”¨ï¼Œå¦åˆ™ä¼šé€ æˆæ•°æ®åº“åŠåº”ç”¨ç¨‹åºçš„ç»´æŠ¤å›°éš¾ã€‚ å¤§å®¶éœ€è¦ç‰¢è®°ä»¥ä¸ŠåŸºç¡€çŸ¥è¯†ç‚¹ï¼Œé‡ç‚¹æ˜¯ç†è§£æ•°æ®ç±»å‹CHARå’ŒVARCHARçš„å·®å¼‚ï¼Œè¡¨å­˜å‚¨å¼•æ“InnoDBå’ŒMyISAMçš„åŒºåˆ«ã€‚ MySQLä¸­éƒ½æœ‰å“ªäº›è§¦å‘å™¨ åœ¨MySQLæ•°æ®åº“ä¸­æœ‰å¦‚ä¸‹å…­ç§è§¦å‘å™¨ï¼š Before Insert After Insert Before Update After Update Before Delete After Delete SQLè¯­å¥ SQLè¯­å¥åˆ†ç±» æ•°æ®å®šä¹‰è¯­è¨€DDLï¼ˆData Ddefinition Languageï¼‰CREATEï¼ŒDROPï¼ŒALTER ä¸»è¦ä¸ºä»¥ä¸Šæ“ä½œ å³å¯¹é€»è¾‘ç»“æ„ç­‰æœ‰æ“ä½œçš„ï¼Œå…¶ä¸­åŒ…æ‹¬è¡¨ç»“æ„ï¼Œè§†å›¾å’Œç´¢å¼•ã€‚ æ•°æ®æŸ¥è¯¢è¯­è¨€DQLï¼ˆData Query Languageï¼‰SELECT è¿™ä¸ªè¾ƒä¸ºå¥½ç†è§£ å³æŸ¥è¯¢æ“ä½œï¼Œä»¥selectå…³é”®å­—ã€‚å„ç§ç®€å•æŸ¥è¯¢ï¼Œè¿æ¥æŸ¥è¯¢ç­‰ éƒ½å±äºDQLã€‚ æ•°æ®æ“çºµè¯­è¨€DMLï¼ˆData Manipulation Languageï¼‰INSERTï¼ŒUPDATEï¼ŒDELETE ä¸»è¦ä¸ºä»¥ä¸Šæ“ä½œ å³å¯¹æ•°æ®è¿›è¡Œæ“ä½œçš„ï¼Œå¯¹åº”ä¸Šé¢æ‰€è¯´çš„æŸ¥è¯¢æ“ä½œ DQLä¸DMLå…±åŒæ„å»ºäº†å¤šæ•°åˆçº§ç¨‹åºå‘˜å¸¸ç”¨çš„å¢åˆ æ”¹æŸ¥æ“ä½œã€‚è€ŒæŸ¥è¯¢æ˜¯è¾ƒä¸ºç‰¹æ®Šçš„ä¸€ç§ è¢«åˆ’åˆ†åˆ°DQLä¸­ã€‚ æ•°æ®æ§åˆ¶åŠŸèƒ½DCLï¼ˆData Control Languageï¼‰GRANTï¼ŒREVOKEï¼ŒCOMMITï¼ŒROLLBACK ä¸»è¦ä¸ºä»¥ä¸Šæ“ä½œ å³å¯¹æ•°æ®åº“å®‰å…¨æ€§å®Œæ•´æ€§ç­‰æœ‰æ“ä½œçš„ï¼Œå¯ä»¥ç®€å•çš„ç†è§£ä¸ºæƒé™æ§åˆ¶ç­‰ã€‚ è¶…é”®ã€å€™é€‰é”®ã€ä¸»é”®ã€å¤–é”® è¶…é”®ï¼šåœ¨å…³ç³»ä¸­èƒ½å”¯ä¸€æ ‡è¯†å…ƒç»„çš„å±æ€§é›†ç§°ä¸ºå…³ç³»æ¨¡å¼çš„è¶…é”®ã€‚ä¸€ä¸ªå±æ€§å¯ä»¥ä¸ºä½œä¸ºä¸€ä¸ªè¶…é”®ï¼Œå¤šä¸ªå±æ€§ç»„åˆåœ¨ä¸€èµ·ä¹Ÿå¯ä»¥ä½œä¸ºä¸€ä¸ªè¶…é”®ã€‚è¶…é”®åŒ…å«å€™é€‰é”®å’Œä¸»é”®ã€‚ å€™é€‰é”®ï¼šæ˜¯æœ€å°è¶…é”®ï¼Œå³æ²¡æœ‰å†—ä½™å…ƒç´ çš„è¶…é”®ã€‚ ä¸»é”®ï¼šæ•°æ®åº“è¡¨ä¸­å¯¹å‚¨å­˜æ•°æ®å¯¹è±¡äºˆä»¥å”¯ä¸€å’Œå®Œæ•´æ ‡è¯†çš„æ•°æ®åˆ—æˆ–å±æ€§çš„ç»„åˆã€‚ä¸€ä¸ªæ•°æ®åˆ—åªèƒ½æœ‰ä¸€ä¸ªä¸»é”®ï¼Œä¸”ä¸»é”®çš„å–å€¼ä¸èƒ½ç¼ºå¤±ï¼Œå³ä¸èƒ½ä¸ºç©ºå€¼ï¼ˆNullï¼‰ã€‚ å¤–é”®ï¼šåœ¨ä¸€ä¸ªè¡¨ä¸­å­˜åœ¨çš„å¦ä¸€ä¸ªè¡¨çš„ä¸»é”®ç§°æ­¤è¡¨çš„å¤–é”®ã€‚ SQL çº¦æŸ NOT NULL: ç”¨äºæ§åˆ¶å­—æ®µçš„å†…å®¹ä¸€å®šä¸èƒ½ä¸ºç©ºï¼ˆNULLï¼‰ã€‚ UNIQUE: æ§ä»¶å­—æ®µå†…å®¹ä¸èƒ½é‡å¤ï¼Œä¸€ä¸ªè¡¨å…è®¸æœ‰å¤šä¸ª Unique çº¦æŸã€‚ PRIMARY KEY: ä¹Ÿæ˜¯ç”¨äºæ§ä»¶å­—æ®µå†…å®¹ä¸èƒ½é‡å¤ï¼Œä½†å®ƒåœ¨ä¸€ä¸ªè¡¨åªå…è®¸å‡ºç°ä¸€ä¸ªã€‚ FOREIGN KEY: ç”¨äºé¢„é˜²ç ´åè¡¨ä¹‹é—´è¿æ¥çš„åŠ¨ä½œï¼Œä¹Ÿèƒ½é˜²æ­¢éæ³•æ•°æ®æ’å…¥å¤–é”®åˆ—ï¼Œå› ä¸ºå®ƒå¿…é¡»æ˜¯å®ƒæŒ‡å‘çš„é‚£ä¸ªè¡¨ä¸­çš„å€¼ä¹‹ä¸€ã€‚ CHECK: ç”¨äºæ§åˆ¶å­—æ®µçš„å€¼èŒƒå›´ã€‚ å…­ç§å…³è”æŸ¥è¯¢ äº¤å‰è¿æ¥ï¼ˆCROSS JOINï¼‰ å†…è¿æ¥ï¼ˆINNER JOINï¼‰ å¤–è¿æ¥ï¼ˆLEFT JOIN/RIGHT JOINï¼‰ è”åˆæŸ¥è¯¢ï¼ˆUNIONä¸UNION ALLï¼‰ å…¨è¿æ¥ï¼ˆFULL JOINï¼‰ äº¤å‰è¿æ¥ï¼ˆCROSS JOINï¼‰ SELECT * FROM A,B(,C)æˆ–è€…SELECT * FROM A CROSS JOIN B (CROSS JOIN C)#æ²¡æœ‰ä»»ä½•å…³è”æ¡ä»¶ï¼Œç»“æœæ˜¯ç¬›å¡å°”ç§¯ï¼Œç»“æœé›†ä¼šå¾ˆå¤§ï¼Œæ²¡æœ‰æ„ä¹‰ï¼Œå¾ˆå°‘ä½¿ç”¨å†…è¿æ¥ï¼ˆINNER JOINï¼‰SELECT * FROM A,B WHERE A.id=B.idæˆ–è€…SELECT * FROM A INNER JOIN B ON A.id=B.idå¤šè¡¨ä¸­åŒæ—¶ç¬¦åˆæŸç§æ¡ä»¶çš„æ•°æ®è®°å½•çš„é›†åˆï¼ŒINNER JOINå¯ä»¥ç¼©å†™ä¸ºJOIN å†…è¿æ¥åˆ†ä¸ºä¸‰ç±» ç­‰å€¼è¿æ¥ï¼šON A.id=B.id ä¸ç­‰å€¼è¿æ¥ï¼šON A.id &gt; B.id è‡ªè¿æ¥ï¼šSELECT * FROM A T1 INNER JOIN A T2 ON T1.id=T2.pid å¤–è¿æ¥ï¼ˆLEFT JOIN/RIGHT JOINï¼‰ å·¦å¤–è¿æ¥ï¼šLEFT OUTER JOIN, ä»¥å·¦è¡¨ä¸ºä¸»ï¼Œå…ˆæŸ¥è¯¢å‡ºå·¦è¡¨ï¼ŒæŒ‰ç…§ONåçš„å…³è”æ¡ä»¶åŒ¹é…å³è¡¨ï¼Œæ²¡æœ‰åŒ¹é…åˆ°çš„ç”¨NULLå¡«å……ï¼Œå¯ä»¥ç®€å†™æˆLEFT JOIN å³å¤–è¿æ¥ï¼šRIGHT OUTER JOIN, ä»¥å³è¡¨ä¸ºä¸»ï¼Œå…ˆæŸ¥è¯¢å‡ºå³è¡¨ï¼ŒæŒ‰ç…§ONåçš„å…³è”æ¡ä»¶åŒ¹é…å·¦è¡¨ï¼Œæ²¡æœ‰åŒ¹é…åˆ°çš„ç”¨NULLå¡«å……ï¼Œå¯ä»¥ç®€å†™æˆRIGHT JOIN è”åˆæŸ¥è¯¢ï¼ˆUNIONä¸UNION ALLï¼‰ SELECT * FROM A UNION SELECT * FROM B UNION ... å°±æ˜¯æŠŠå¤šä¸ªç»“æœé›†é›†ä¸­åœ¨ä¸€èµ·ï¼ŒUNIONå‰çš„ç»“æœä¸ºåŸºå‡†ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è”åˆæŸ¥è¯¢çš„åˆ—æ•°è¦ç›¸ç­‰ï¼Œç›¸åŒçš„è®°å½•è¡Œä¼šåˆå¹¶ å¦‚æœä½¿ç”¨UNION ALLï¼Œä¸ä¼šåˆå¹¶é‡å¤çš„è®°å½•è¡Œ æ•ˆç‡ UNION ALL é«˜äº UNION å…¨è¿æ¥ï¼ˆFULL JOINï¼‰ MySQLä¸æ”¯æŒå…¨è¿æ¥ å¯ä»¥ä½¿ç”¨LEFT JOIN å’ŒUNIONå’ŒRIGHT JOINè”åˆä½¿ç”¨ SELECT * FROM A LEFT JOIN B ON A.id=B.id UNIONSELECT * FROM A RIGHT JOIN B ON A.id=B.id è¡¨è¿æ¥å±•ç¤º æœ‰2å¼ è¡¨ï¼Œ1å¼ Rã€1å¼ Sï¼ŒRè¡¨æœ‰ABCä¸‰åˆ—ï¼ŒSè¡¨æœ‰CDä¸¤åˆ—ï¼Œè¡¨ä¸­å„æœ‰ä¸‰æ¡è®°å½•ã€‚ Rè¡¨ A B C a1 b1 c1 a2 b2 c2 a3 b3 c3 Sè¡¨ C D c1 d1 c2 d2 c4 d3 äº¤å‰è¿æ¥(ç¬›å¡å°”ç§¯): select r.*,s.* from r,s A B C C D a1 b1 c1 c1 d1 a2 b2 c2 c1 d1 a3 b3 c3 c1 d1 a1 b1 c1 c2 d2 a2 b2 c2 c2 d2 a3 b3 c3 c2 d2 a1 b1 c1 c4 d3 a2 b2 c2 c4 d3 a3 b3 c3 c4 d3 å†…è¿æ¥ç»“æœï¼š select r.*,s.* from r inner join s on r.c=s.c A B C C D a1 b1 c1 c1 d1 a2 b2 c2 c2 d2 å·¦è¿æ¥ç»“æœï¼š select r.*,s.* from r left join s on r.c=s.c A B C C D a1 b1 c1 c1 d1 a2 b2 c2 c2 d2 a3 b3 c3 å³è¿æ¥ç»“æœï¼š select r.*,s.* from r right join s on r.c=s.c A B C C D a1 b1 c1 c1 d1 a2 b2 c2 c2 d2 c4 d3 å…¨è¡¨è¿æ¥çš„ç»“æœï¼ˆMySqlä¸æ”¯æŒï¼ŒOracleæ”¯æŒï¼‰ï¼š select r.*,s.* from r full join s on r.c=s.c A B C C D a1 b1 c1 c1 d1 a2 b2 c2 c2 d2 a3 b3 c3 c4 d3 å­æŸ¥è¯¢ æ¡ä»¶ï¼šä¸€æ¡SQLè¯­å¥çš„æŸ¥è¯¢ç»“æœåšä¸ºå¦ä¸€æ¡æŸ¥è¯¢è¯­å¥çš„æ¡ä»¶æˆ–æŸ¥è¯¢ç»“æœ åµŒå¥—ï¼šå¤šæ¡SQLè¯­å¥åµŒå¥—ä½¿ç”¨ï¼Œå†…éƒ¨çš„SQLæŸ¥è¯¢è¯­å¥ç§°ä¸ºå­æŸ¥è¯¢ã€‚ å­æŸ¥è¯¢çš„ä¸‰ç§æƒ…å†µ å­æŸ¥è¯¢æ˜¯å•è¡Œå•åˆ—çš„æƒ…å†µï¼šç»“æœé›†æ˜¯ä¸€ä¸ªå€¼ï¼Œçˆ¶æŸ¥è¯¢ä½¿ç”¨ï¼š=ã€ &lt;ã€ &gt; ç­‰è¿ç®—ç¬¦ -- æŸ¥è¯¢å·¥èµ„æœ€é«˜çš„å‘˜å·¥æ˜¯è°ï¼Ÿ select * from employee where salary=(select max(salary) from employee); å­æŸ¥è¯¢æ˜¯å¤šè¡Œå•åˆ—çš„æƒ…å†µï¼šç»“æœé›†ç±»ä¼¼äºä¸€ä¸ªæ•°ç»„ï¼Œçˆ¶æŸ¥è¯¢ä½¿ç”¨ï¼šin è¿ç®—ç¬¦ -- æŸ¥è¯¢å·¥èµ„æœ€é«˜çš„å‘˜å·¥æ˜¯è°ï¼Ÿ select * from employee where salary=(select max(salary) from employee); å­æŸ¥è¯¢æ˜¯å¤šè¡Œå¤šåˆ—çš„æƒ…å†µï¼šç»“æœé›†ç±»ä¼¼äºä¸€å¼ è™šæ‹Ÿè¡¨ï¼Œä¸èƒ½ç”¨äºwhereæ¡ä»¶ï¼Œç”¨äºselectå­å¥ä¸­åšä¸ºå­è¡¨ -- 1) æŸ¥è¯¢å‡º2011å¹´ä»¥åå…¥èŒçš„å‘˜å·¥ä¿¡æ¯ -- 2) æŸ¥è¯¢æ‰€æœ‰çš„éƒ¨é—¨ä¿¡æ¯ï¼Œä¸ä¸Šé¢çš„è™šæ‹Ÿè¡¨ä¸­çš„ä¿¡æ¯æ¯”å¯¹ï¼Œæ‰¾å‡ºæ‰€æœ‰éƒ¨é—¨IDç›¸ç­‰çš„å‘˜å·¥ã€‚ SELECT * FROM dept d, ( SELECT * FROM employee WHERE join_date &gt; '2011-1-1' ) e WHERE e.dept_id = d.id; -- ä½¿ç”¨è¡¨è¿æ¥ï¼š SELECT d.*, e.* FROM dept d INNER JOIN employee e ON d.id = e.dept_id WHERE e.join_date &gt; '2011-1-1' mysqlä¸­ in å’Œ exists åŒºåˆ« mysqlä¸­çš„inè¯­å¥æ˜¯æŠŠå¤–è¡¨å’Œå†…è¡¨ä½œhash è¿æ¥ï¼Œè€Œexistsè¯­å¥æ˜¯å¯¹å¤–è¡¨ä½œloopå¾ªç¯ï¼Œæ¯æ¬¡loopå¾ªç¯å†å¯¹å†…è¡¨è¿›è¡ŒæŸ¥è¯¢ã€‚ä¸€ç›´å¤§å®¶éƒ½è®¤ä¸ºexistsæ¯”inè¯­å¥çš„æ•ˆç‡è¦é«˜ï¼Œè¿™ç§è¯´æ³•å…¶å®æ˜¯ä¸å‡†ç¡®çš„ã€‚è¿™ä¸ªæ˜¯è¦åŒºåˆ†ç¯å¢ƒçš„ã€‚ å¦‚æœæŸ¥è¯¢çš„ä¸¤ä¸ªè¡¨å¤§å°ç›¸å½“ï¼Œé‚£ä¹ˆç”¨inå’Œexistså·®åˆ«ä¸å¤§ã€‚ å¦‚æœä¸¤ä¸ªè¡¨ä¸­ä¸€ä¸ªè¾ƒå°ï¼Œä¸€ä¸ªæ˜¯å¤§è¡¨ï¼Œåˆ™å­æŸ¥è¯¢è¡¨å¤§çš„ç”¨existsï¼Œå­æŸ¥è¯¢è¡¨å°çš„ç”¨inã€‚ not in å’Œnot existsï¼šå¦‚æœæŸ¥è¯¢è¯­å¥ä½¿ç”¨äº†not inï¼Œé‚£ä¹ˆå†…å¤–è¡¨éƒ½è¿›è¡Œå…¨è¡¨æ‰«æï¼Œæ²¡æœ‰ç”¨åˆ°ç´¢å¼•ï¼›è€Œnot extstsçš„å­æŸ¥è¯¢ä¾ç„¶èƒ½ç”¨åˆ°è¡¨ä¸Šçš„ç´¢å¼•ã€‚æ‰€ä»¥æ— è®ºé‚£ä¸ªè¡¨å¤§ï¼Œç”¨not existséƒ½æ¯”not inè¦å¿«ã€‚ varcharä¸charçš„åŒºåˆ« charçš„ç‰¹ç‚¹ charè¡¨ç¤ºå®šé•¿å­—ç¬¦ä¸²ï¼Œé•¿åº¦æ˜¯å›ºå®šçš„ï¼› å¦‚æœæ’å…¥æ•°æ®çš„é•¿åº¦å°äºcharçš„å›ºå®šé•¿åº¦æ—¶ï¼Œåˆ™ç”¨ç©ºæ ¼å¡«å……ï¼› å› ä¸ºé•¿åº¦å›ºå®šï¼Œæ‰€ä»¥å­˜å–é€Ÿåº¦è¦æ¯”varcharå¿«å¾ˆå¤šï¼Œç”šè‡³èƒ½å¿«50%ï¼Œä½†æ­£å› ä¸ºå…¶é•¿åº¦å›ºå®šï¼Œæ‰€ä»¥ä¼šå æ®å¤šä½™çš„ç©ºé—´ï¼Œæ˜¯ç©ºé—´æ¢æ—¶é—´çš„åšæ³•ï¼› å¯¹äºcharæ¥è¯´ï¼Œæœ€å¤šèƒ½å­˜æ”¾çš„å­—ç¬¦ä¸ªæ•°ä¸º255ï¼Œå’Œç¼–ç æ— å…³ varcharçš„ç‰¹ç‚¹ varcharè¡¨ç¤ºå¯å˜é•¿å­—ç¬¦ä¸²ï¼Œé•¿åº¦æ˜¯å¯å˜çš„ï¼› æ’å…¥çš„æ•°æ®æ˜¯å¤šé•¿ï¼Œå°±æŒ‰ç…§å¤šé•¿æ¥å­˜å‚¨ï¼› varcharåœ¨å­˜å–æ–¹é¢ä¸charç›¸åï¼Œå®ƒå­˜å–æ…¢ï¼Œå› ä¸ºé•¿åº¦ä¸å›ºå®šï¼Œä½†æ­£å› å¦‚æ­¤ï¼Œä¸å æ®å¤šä½™çš„ç©ºé—´ï¼Œæ˜¯æ—¶é—´æ¢ç©ºé—´çš„åšæ³•ï¼› å¯¹äºvarcharæ¥è¯´ï¼Œæœ€å¤šèƒ½å­˜æ”¾çš„å­—ç¬¦ä¸ªæ•°ä¸º65532 æ€»ä¹‹ï¼Œç»“åˆæ€§èƒ½è§’åº¦ï¼ˆcharæ›´å¿«ï¼‰å’ŒèŠ‚çœç£ç›˜ç©ºé—´è§’åº¦ï¼ˆvarcharæ›´å°ï¼‰ï¼Œå…·ä½“æƒ…å†µè¿˜éœ€å…·ä½“æ¥è®¾è®¡æ•°æ®åº“æ‰æ˜¯å¦¥å½“çš„åšæ³•ã€‚ varchar(50)ä¸­50çš„æ¶µä¹‰ æœ€å¤šå­˜æ”¾50ä¸ªå­—ç¬¦ï¼Œvarchar(50)å’Œ(200)å­˜å‚¨helloæ‰€å ç©ºé—´ä¸€æ ·ï¼Œä½†åè€…åœ¨æ’åºæ—¶ä¼šæ¶ˆè€—æ›´å¤šå†…å­˜ï¼Œå› ä¸ºorder by colé‡‡ç”¨fixed_lengthè®¡ç®—colé•¿åº¦(memoryå¼•æ“ä¹Ÿä¸€æ ·)ã€‚åœ¨æ—©æœŸ MySQL ç‰ˆæœ¬ä¸­ï¼Œ 50 ä»£è¡¨å­—èŠ‚æ•°ï¼Œç°åœ¨ä»£è¡¨å­—ç¬¦æ•°ã€‚ int(20)ä¸­20çš„æ¶µä¹‰ æ˜¯æŒ‡æ˜¾ç¤ºå­—ç¬¦çš„é•¿åº¦ã€‚20è¡¨ç¤ºæœ€å¤§æ˜¾ç¤ºå®½åº¦ä¸º20ï¼Œä½†ä»å 4å­—èŠ‚å­˜å‚¨ï¼Œå­˜å‚¨èŒƒå›´ä¸å˜ï¼›ä¸å½±å“å†…éƒ¨å­˜å‚¨ï¼Œåªæ˜¯å½±å“å¸¦ zerofill å®šä¹‰çš„ int æ—¶ï¼Œå‰é¢è¡¥å¤šå°‘ä¸ª 0ï¼Œæ˜“äºæŠ¥è¡¨å±•ç¤º mysqlä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡å­—æ®µ å¯¹å¤§å¤šæ•°åº”ç”¨æ²¡æœ‰æ„ä¹‰ï¼Œåªæ˜¯è§„å®šä¸€äº›å·¥å…·ç”¨æ¥æ˜¾ç¤ºå­—ç¬¦çš„ä¸ªæ•°ï¼›int(1)å’Œint(20)å­˜å‚¨å’Œè®¡ç®—å‡ä¸€æ ·ï¼› mysqlä¸­int(10)å’Œchar(10)ä»¥åŠvarchar(10)çš„åŒºåˆ« int(10)çš„10è¡¨ç¤ºæ˜¾ç¤ºçš„æ•°æ®çš„é•¿åº¦ï¼Œä¸æ˜¯å­˜å‚¨æ•°æ®çš„å¤§å°ï¼›chart(10)å’Œvarchar(10)çš„10è¡¨ç¤ºå­˜å‚¨æ•°æ®çš„å¤§å°ï¼Œå³è¡¨ç¤ºå­˜å‚¨å¤šå°‘ä¸ªå­—ç¬¦ã€‚ int(10) 10ä½çš„æ•°æ®é•¿åº¦ 9999999999ï¼Œå 32ä¸ªå­—èŠ‚ï¼Œintå‹4ä½ char(10) 10ä½å›ºå®šå­—ç¬¦ä¸²ï¼Œä¸è¶³è¡¥ç©ºæ ¼ æœ€å¤š10ä¸ªå­—ç¬¦ varchar(10) 10ä½å¯å˜å­—ç¬¦ä¸²ï¼Œä¸è¶³è¡¥ç©ºæ ¼ æœ€å¤š10ä¸ªå­—ç¬¦ char(10)è¡¨ç¤ºå­˜å‚¨å®šé•¿çš„10ä¸ªå­—ç¬¦ï¼Œä¸è¶³10ä¸ªå°±ç”¨ç©ºæ ¼è¡¥é½ï¼Œå ç”¨æ›´å¤šçš„å­˜å‚¨ç©ºé—´ varchar(10)è¡¨ç¤ºå­˜å‚¨10ä¸ªå˜é•¿çš„å­—ç¬¦ï¼Œå­˜å‚¨å¤šå°‘ä¸ªå°±æ˜¯å¤šå°‘ä¸ªï¼Œç©ºæ ¼ä¹ŸæŒ‰ä¸€ä¸ªå­—ç¬¦å­˜å‚¨ï¼Œè¿™ä¸€ç‚¹æ˜¯å’Œchar(10)çš„ç©ºæ ¼ä¸åŒçš„ï¼Œchar(10)çš„ç©ºæ ¼è¡¨ç¤ºå ä½ä¸ç®—ä¸€ä¸ªå­—ç¬¦ FLOATå’ŒDOUBLEçš„åŒºåˆ« FLOATç±»å‹æ•°æ®å¯ä»¥å­˜å‚¨è‡³å¤š8ä½åè¿›åˆ¶æ•°ï¼Œå¹¶åœ¨å†…å­˜ä¸­å 4å­—èŠ‚ã€‚ DOUBLEç±»å‹æ•°æ®å¯ä»¥å­˜å‚¨è‡³å¤š18ä½åè¿›åˆ¶æ•°ï¼Œå¹¶åœ¨å†…å­˜ä¸­å 8å­—èŠ‚ã€‚ dropã€deleteä¸truncateçš„åŒºåˆ« ä¸‰è€…éƒ½è¡¨ç¤ºåˆ é™¤ï¼Œä½†æ˜¯ä¸‰è€…æœ‰ä¸€äº›å·®åˆ«ï¼š Delete Truncate Drop ç±»å‹ å±äºDML å±äºDDL å±äºDDL å›æ»š å¯å›æ»š ä¸å¯å›æ»š ä¸å¯å›æ»š åˆ é™¤å†…å®¹ è¡¨ç»“æ„è¿˜åœ¨ï¼Œåˆ é™¤è¡¨çš„å…¨éƒ¨æˆ–è€…ä¸€éƒ¨åˆ†æ•°æ®è¡Œ è¡¨ç»“æ„è¿˜åœ¨ï¼Œåˆ é™¤è¡¨ä¸­çš„æ‰€æœ‰æ•°æ® ä»æ•°æ®åº“ä¸­åˆ é™¤è¡¨ï¼Œæ‰€æœ‰çš„æ•°æ®è¡Œï¼Œç´¢å¼•å’Œæƒé™ä¹Ÿä¼šè¢«åˆ é™¤ åˆ é™¤é€Ÿåº¦ åˆ é™¤é€Ÿåº¦æ…¢ï¼Œéœ€è¦é€è¡Œåˆ é™¤ åˆ é™¤é€Ÿåº¦å¿« åˆ é™¤é€Ÿåº¦æœ€å¿« å› æ­¤ï¼Œåœ¨ä¸å†éœ€è¦ä¸€å¼ è¡¨çš„æ—¶å€™ï¼Œç”¨dropï¼›åœ¨æƒ³åˆ é™¤éƒ¨åˆ†æ•°æ®è¡Œæ—¶å€™ï¼Œç”¨deleteï¼›åœ¨ä¿ç•™è¡¨è€Œåˆ é™¤æ‰€æœ‰æ•°æ®çš„æ—¶å€™ç”¨truncateã€‚ UNIONä¸UNION ALLçš„åŒºåˆ« å¦‚æœä½¿ç”¨UNION ALLï¼Œä¸ä¼šåˆå¹¶é‡å¤çš„è®°å½•è¡Œ æ•ˆç‡ UNION é«˜äº UNION ALL ","link":"https://tianxiawuhao.github.io/QKdNIC7pG/"},{"title":"mysqlæ¦‚è¿°ä¸‰","content":"äº‹åŠ¡ äº‹åŠ¡æ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ•°æ®åº“æ“ä½œåºåˆ—ï¼Œä¹Ÿæ˜¯æ•°æ®åº“å¹¶å‘æ§åˆ¶çš„åŸºæœ¬å•ä½ï¼Œå…¶æ‰§è¡Œçš„ç»“æœå¿…é¡»ä½¿æ•°æ®åº“ä»ä¸€ç§ä¸€è‡´æ€§çŠ¶æ€å˜åˆ°å¦ä¸€ç§ä¸€è‡´æ€§çŠ¶æ€ã€‚äº‹åŠ¡æ˜¯é€»è¾‘ä¸Šçš„ä¸€ç»„æ“ä½œï¼Œè¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚ äº‹åŠ¡æœ€ç»å…¸ä¹Ÿç»å¸¸è¢«æ‹¿å‡ºæ¥è¯´ä¾‹å­å°±æ˜¯è½¬è´¦äº†ã€‚ å‡å¦‚å°æ˜è¦ç»™å°çº¢è½¬è´¦1000å…ƒï¼Œè¿™ä¸ªè½¬è´¦ä¼šæ¶‰åŠåˆ°ä¸¤ä¸ªå…³é”®æ“ä½œå°±æ˜¯ï¼šå°†å°æ˜çš„ä½™é¢å‡å°‘1000å…ƒï¼Œå°†å°çº¢çš„ä½™é¢å¢åŠ 1000å…ƒã€‚ä¸‡ä¸€åœ¨è¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´çªç„¶å‡ºç°é”™è¯¯æ¯”å¦‚é“¶è¡Œç³»ç»Ÿå´©æºƒï¼Œå¯¼è‡´å°æ˜ä½™é¢å‡å°‘è€Œå°çº¢çš„ä½™é¢æ²¡æœ‰å¢åŠ ï¼Œè¿™æ ·å°±ä¸å¯¹äº†ã€‚äº‹åŠ¡å°±æ˜¯ä¿è¯è¿™ä¸¤ä¸ªå…³é”®æ“ä½œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½è¦å¤±è´¥ã€‚ äº‹ç‰©çš„å››å¤§ç‰¹æ€§(ACID) å…³ç³»æ€§æ•°æ®åº“éœ€è¦éµå¾ªACIDè§„åˆ™ï¼Œå…·ä½“å†…å®¹å¦‚ä¸‹ï¼š åŸå­æ€§ï¼š äº‹åŠ¡æ˜¯æœ€å°çš„æ‰§è¡Œå•ä½ï¼Œä¸å…è®¸åˆ†å‰²ã€‚äº‹åŠ¡çš„åŸå­æ€§ç¡®ä¿åŠ¨ä½œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå®Œå…¨ä¸èµ·ä½œç”¨ï¼› ä¸€è‡´æ€§ï¼š æ‰§è¡Œäº‹åŠ¡å‰åï¼Œæ•°æ®ä¿æŒä¸€è‡´ï¼Œå¤šä¸ªäº‹åŠ¡å¯¹åŒä¸€ä¸ªæ•°æ®è¯»å–çš„ç»“æœæ˜¯ç›¸åŒçš„ï¼› éš”ç¦»æ€§ï¼š å¹¶å‘è®¿é—®æ•°æ®åº“æ—¶ï¼Œä¸€ä¸ªç”¨æˆ·çš„äº‹åŠ¡ä¸è¢«å…¶ä»–äº‹åŠ¡æ‰€å¹²æ‰°ï¼Œå„å¹¶å‘äº‹åŠ¡ä¹‹é—´æ•°æ®åº“æ˜¯ç‹¬ç«‹çš„ï¼› æŒä¹…æ€§ï¼š ä¸€ä¸ªäº‹åŠ¡è¢«æäº¤ä¹‹åã€‚å®ƒå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜æ˜¯æŒä¹…çš„ï¼Œå³ä½¿æ•°æ®åº“å‘ç”Ÿæ•…éšœä¹Ÿä¸åº”è¯¥å¯¹å…¶æœ‰ä»»ä½•å½±å“ã€‚ è„è¯»ï¼Ÿå¹»è¯»ï¼Ÿä¸å¯é‡å¤è¯»ï¼Ÿ è„è¯»(Drity Read)ï¼šæŸä¸ªäº‹åŠ¡å·²æ›´æ–°ä¸€ä»½æ•°æ®ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡åœ¨æ­¤æ—¶è¯»å–äº†åŒä¸€ä»½æ•°æ®ï¼Œç”±äºæŸäº›åŸå› ï¼Œå‰ä¸€ä¸ªRollBackäº†æ“ä½œï¼Œåˆ™åä¸€ä¸ªäº‹åŠ¡æ‰€è¯»å–çš„æ•°æ®å°±ä¼šæ˜¯ä¸æ­£ç¡®çš„ã€‚ ä¸å¯é‡å¤è¯»(Non-repeatable read):åœ¨ä¸€ä¸ªäº‹åŠ¡çš„ä¸¤æ¬¡æŸ¥è¯¢ä¹‹ä¸­æ•°æ®ä¸ä¸€è‡´ï¼Œè¿™å¯èƒ½æ˜¯ä¸¤æ¬¡æŸ¥è¯¢è¿‡ç¨‹ä¸­é—´æ’å…¥äº†ä¸€ä¸ªäº‹åŠ¡æ›´æ–°äº†åŸæœ‰çš„æ•°æ®ã€‚ å¹»è¯»(Phantom Read):åœ¨ä¸€ä¸ªäº‹åŠ¡çš„ä¸¤æ¬¡æŸ¥è¯¢ä¸­æ•°æ®ç¬”æ•°ä¸ä¸€è‡´ï¼Œä¾‹å¦‚æœ‰ä¸€ä¸ªäº‹åŠ¡æŸ¥è¯¢äº†å‡ åˆ—(Row)æ•°æ®ï¼Œè€Œå¦ä¸€ä¸ªäº‹åŠ¡å´åœ¨æ­¤æ—¶æ’å…¥äº†æ–°çš„å‡ åˆ—æ•°æ®ï¼Œå…ˆå‰çš„äº‹åŠ¡åœ¨æ¥ä¸‹æ¥çš„æŸ¥è¯¢ä¸­ï¼Œå°±ä¼šå‘ç°æœ‰å‡ åˆ—æ•°æ®æ˜¯å®ƒå…ˆå‰æ‰€æ²¡æœ‰çš„ã€‚ äº‹åŠ¡çš„éš”ç¦»çº§åˆ« ä¸ºäº†è¾¾åˆ°äº‹åŠ¡çš„å››å¤§ç‰¹æ€§ï¼Œæ•°æ®åº“å®šä¹‰äº†4ç§ä¸åŒçš„äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œç”±ä½åˆ°é«˜ä¾æ¬¡ä¸ºRead uncommittedã€Read committedã€Repeatable readã€Serializableï¼Œè¿™å››ä¸ªçº§åˆ«å¯ä»¥é€ä¸ªè§£å†³è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»è¿™å‡ ç±»é—®é¢˜ã€‚ éš”ç¦»çº§åˆ« è„è¯» ä¸å¯é‡å¤è¯» å¹»å½±è¯» READ-UNCOMMITTED âˆš âˆš âˆš READ-COMMITTED Ã— âˆš âˆš REPEATABLE-READ Ã— Ã— âˆš SERIALIZABLE Ã— Ã— Ã— SQL æ ‡å‡†å®šä¹‰äº†å››ä¸ªéš”ç¦»çº§åˆ«ï¼š READ-UNCOMMITTED(è¯»æœªæäº¤)ï¼š æœ€ä½çš„éš”ç¦»çº§åˆ«ï¼Œå…è®¸è¯»å–å°šæœªæäº¤çš„æ•°æ®å˜æ›´ï¼Œå¯èƒ½ä¼šå¯¼è‡´è„è¯»ã€å¹»è¯»æˆ–ä¸å¯é‡å¤è¯»ã€‚ READ-COMMITTED(è¯»å·²æäº¤)ï¼š å…è®¸è¯»å–å¹¶å‘äº‹åŠ¡å·²ç»æäº¤çš„æ•°æ®ï¼Œå¯ä»¥é˜»æ­¢è„è¯»ï¼Œä½†æ˜¯å¹»è¯»æˆ–ä¸å¯é‡å¤è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿã€‚ REPEATABLE-READ(å¯é‡å¤è¯»)ï¼š å¯¹åŒä¸€å­—æ®µçš„å¤šæ¬¡è¯»å–ç»“æœéƒ½æ˜¯ä¸€è‡´çš„ï¼Œé™¤éæ•°æ®æ˜¯è¢«æœ¬èº«äº‹åŠ¡è‡ªå·±æ‰€ä¿®æ”¹ï¼Œå¯ä»¥é˜»æ­¢è„è¯»å’Œä¸å¯é‡å¤è¯»ï¼Œä½†å¹»è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿã€‚ SERIALIZABLE(ä¸²è¡ŒåŒ–)ï¼š æœ€é«˜çš„éš”ç¦»çº§åˆ«ï¼Œå®Œå…¨æœä»ACIDçš„éš”ç¦»çº§åˆ«ã€‚æ‰€æœ‰çš„äº‹åŠ¡ä¾æ¬¡é€ä¸ªæ‰§è¡Œï¼Œè¿™æ ·äº‹åŠ¡ä¹‹é—´å°±å®Œå…¨ä¸å¯èƒ½äº§ç”Ÿå¹²æ‰°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥çº§åˆ«å¯ä»¥é˜²æ­¢è„è¯»ã€ä¸å¯é‡å¤è¯»ä»¥åŠå¹»è¯»ã€‚ è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼šMysql é»˜è®¤é‡‡ç”¨çš„ REPEATABLE_READ(å¯é‡å¤è¯»)éš”ç¦»çº§åˆ« Oracle é»˜è®¤é‡‡ç”¨çš„ READ_COMMITTED(è¯»å·²æäº¤)éš”ç¦»çº§åˆ« äº‹åŠ¡éš”ç¦»æœºåˆ¶çš„å®ç°åŸºäºé”æœºåˆ¶å’Œå¹¶å‘è°ƒåº¦ã€‚å…¶ä¸­å¹¶å‘è°ƒåº¦ä½¿ç”¨çš„æ˜¯MVVCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰ï¼Œé€šè¿‡ä¿å­˜ä¿®æ”¹çš„æ—§ç‰ˆæœ¬ä¿¡æ¯æ¥æ”¯æŒå¹¶å‘ä¸€è‡´æ€§è¯»å’Œå›æ»šç­‰ç‰¹æ€§ã€‚ å› ä¸ºéš”ç¦»çº§åˆ«è¶Šä½ï¼Œäº‹åŠ¡è¯·æ±‚çš„é”è¶Šå°‘ï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†æ•°æ®åº“ç³»ç»Ÿçš„éš”ç¦»çº§åˆ«éƒ½æ˜¯READ-COMMITTED(è¯»å·²æäº¤):ï¼Œä½†æ˜¯ä½ è¦çŸ¥é“çš„æ˜¯InnoDB å­˜å‚¨å¼•æ“é»˜è®¤ä½¿ç”¨ REPEATABLE-READ(å¯é‡è¯»)å¹¶ä¸ä¼šæœ‰ä»»ä½•æ€§èƒ½æŸå¤±ã€‚ InnoDB å­˜å‚¨å¼•æ“åœ¨ åˆ†å¸ƒå¼äº‹åŠ¡ çš„æƒ…å†µä¸‹ä¸€èˆ¬ä¼šç”¨åˆ°SERIALIZABLE(å¯ä¸²è¡ŒåŒ–)éš”ç¦»çº§åˆ«ã€‚ é” å½“æ•°æ®åº“æœ‰å¹¶å‘äº‹åŠ¡çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šäº§ç”Ÿæ•°æ®çš„ä¸ä¸€è‡´ï¼Œè¿™æ—¶å€™éœ€è¦ä¸€äº›æœºåˆ¶æ¥ä¿è¯è®¿é—®çš„æ¬¡åºï¼Œé”æœºåˆ¶å°±æ˜¯è¿™æ ·çš„ä¸€ä¸ªæœºåˆ¶ã€‚ å°±åƒé…’åº—çš„æˆ¿é—´ï¼Œå¦‚æœå¤§å®¶éšæ„è¿›å‡ºï¼Œå°±ä¼šå‡ºç°å¤šäººæŠ¢å¤ºåŒä¸€ä¸ªæˆ¿é—´çš„æƒ…å†µï¼Œè€Œåœ¨æˆ¿é—´ä¸Šè£…ä¸Šé”ï¼Œç”³è¯·åˆ°é’¥åŒ™çš„äººæ‰å¯ä»¥å…¥ä½å¹¶ä¸”å°†æˆ¿é—´é”èµ·æ¥ï¼Œå…¶ä»–äººåªæœ‰ç­‰ä»–ä½¿ç”¨å®Œæ¯•æ‰å¯ä»¥å†æ¬¡ä½¿ç”¨ã€‚ éš”ç¦»çº§åˆ«ä¸é”çš„å…³ç³» åœ¨Read Uncommittedçº§åˆ«ä¸‹ï¼Œè¯»å–æ•°æ®ä¸éœ€è¦åŠ å…±äº«é”ï¼Œè¿™æ ·å°±ä¸ä¼šè·Ÿè¢«ä¿®æ”¹çš„æ•°æ®ä¸Šçš„æ’ä»–é”å†²çª åœ¨Read Committedçº§åˆ«ä¸‹ï¼Œè¯»æ“ä½œéœ€è¦åŠ å…±äº«é”ï¼Œä½†æ˜¯åœ¨è¯­å¥æ‰§è¡Œå®Œä»¥åé‡Šæ”¾å…±äº«é”ï¼› åœ¨Repeatable Readçº§åˆ«ä¸‹ï¼Œè¯»æ“ä½œéœ€è¦åŠ å…±äº«é”ï¼Œä½†æ˜¯åœ¨äº‹åŠ¡æäº¤ä¹‹å‰å¹¶ä¸é‡Šæ”¾å…±äº«é”ï¼Œä¹Ÿå°±æ˜¯å¿…é¡»ç­‰å¾…äº‹åŠ¡æ‰§è¡Œå®Œæ¯•ä»¥åæ‰é‡Šæ”¾å…±äº«é”ã€‚ SERIALIZABLE æ˜¯é™åˆ¶æ€§æœ€å¼ºçš„éš”ç¦»çº§åˆ«ï¼Œå› ä¸ºè¯¥çº§åˆ«é”å®šæ•´ä¸ªèŒƒå›´çš„é”®ï¼Œå¹¶ä¸€ç›´æŒæœ‰é”ï¼Œç›´åˆ°äº‹åŠ¡å®Œæˆã€‚ æŒ‰ç…§é”çš„ç²’åº¦åˆ†æ•°æ®åº“é” åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œå¯ä»¥æŒ‰ç…§é”çš„ç²’åº¦æŠŠæ•°æ®åº“é”åˆ†ä¸ºè¡Œçº§é”(INNODBå¼•æ“)ã€è¡¨çº§é”(MYISAMå¼•æ“)å’Œé¡µçº§é”(BDBå¼•æ“ )ã€‚ MyISAMå’ŒInnoDBå­˜å‚¨å¼•æ“ä½¿ç”¨çš„é” MyISAMé‡‡ç”¨è¡¨çº§é”(table-level locking)ã€‚ InnoDBæ”¯æŒè¡Œçº§é”(row-level locking)å’Œè¡¨çº§é”ï¼Œé»˜è®¤ä¸ºè¡Œçº§é” è¡Œçº§é”ï¼Œè¡¨çº§é”å’Œé¡µçº§é”å¯¹æ¯” è¡Œçº§é” è¡Œçº§é”æ˜¯Mysqlä¸­é”å®šç²’åº¦æœ€ç»†çš„ä¸€ç§é”ï¼Œè¡¨ç¤ºåªé’ˆå¯¹å½“å‰æ“ä½œçš„è¡Œè¿›è¡ŒåŠ é”ã€‚è¡Œçº§é”èƒ½å¤§å¤§å‡å°‘æ•°æ®åº“æ“ä½œçš„å†²çªã€‚å…¶åŠ é”ç²’åº¦æœ€å°ï¼Œä½†åŠ é”çš„å¼€é”€ä¹Ÿæœ€å¤§ã€‚è¡Œçº§é”åˆ†ä¸ºå…±äº«é” å’Œ æ’ä»–é”ã€‚ ç‰¹ç‚¹ï¼šå¼€é”€å¤§ï¼ŒåŠ é”æ…¢ï¼›ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦æœ€å°ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€ä½ï¼Œå¹¶å‘åº¦ä¹Ÿæœ€é«˜ã€‚ è¡¨çº§é” è¡¨çº§é”æ˜¯MySQLä¸­é”å®šç²’åº¦æœ€å¤§çš„ä¸€ç§é”ï¼Œè¡¨ç¤ºå¯¹å½“å‰æ“ä½œçš„æ•´å¼ è¡¨åŠ é”ï¼Œå®ƒå®ç°ç®€å•ï¼Œèµ„æºæ¶ˆè€—è¾ƒå°‘ï¼Œè¢«å¤§éƒ¨åˆ†MySQLå¼•æ“æ”¯æŒã€‚æœ€å¸¸ä½¿ç”¨çš„MYISAMä¸INNODBéƒ½æ”¯æŒè¡¨çº§é”å®šã€‚è¡¨çº§é”å®šåˆ†ä¸ºè¡¨å…±äº«è¯»é”ï¼ˆå…±äº«é”ï¼‰ä¸è¡¨ç‹¬å å†™é”ï¼ˆæ’ä»–é”ï¼‰ã€‚ ç‰¹ç‚¹ï¼šå¼€é”€å°ï¼ŒåŠ é”å¿«ï¼›ä¸ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦å¤§ï¼Œå‘å‡ºé”å†²çªçš„æ¦‚ç‡æœ€é«˜ï¼Œå¹¶å‘åº¦æœ€ä½ã€‚ é¡µçº§é” é¡µçº§é”æ˜¯MySQLä¸­é”å®šç²’åº¦ä»‹äºè¡Œçº§é”å’Œè¡¨çº§é”ä¸­é—´çš„ä¸€ç§é”ã€‚è¡¨çº§é”é€Ÿåº¦å¿«ï¼Œä½†å†²çªå¤šï¼Œè¡Œçº§å†²çªå°‘ï¼Œä½†é€Ÿåº¦æ…¢ã€‚æ‰€ä»¥å–äº†æŠ˜ä¸­çš„é¡µçº§ï¼Œä¸€æ¬¡é”å®šç›¸é‚»çš„ä¸€ç»„è®°å½•ã€‚ ç‰¹ç‚¹ï¼šå¼€é”€å’ŒåŠ é”æ—¶é—´ä»‹äºè¡¨é”å’Œè¡Œé”ä¹‹é—´ï¼›ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦ç•Œäºè¡¨é”å’Œè¡Œé”ä¹‹é—´ï¼Œå¹¶å‘åº¦ä¸€èˆ¬ æŒ‰ç…§é”çš„ç±»åˆ«åˆ†æ•°æ®åº“é” ä»é”çš„ç±»åˆ«ä¸Šæ¥è®²ï¼Œæœ‰å…±äº«é”å’Œæ’ä»–é”ã€‚ å…±äº«é”: åˆå«åšè¯»é”ã€‚ å½“ç”¨æˆ·è¦è¿›è¡Œæ•°æ®çš„è¯»å–æ—¶ï¼Œå¯¹æ•°æ®åŠ ä¸Šå…±äº«é”ã€‚å…±äº«é”å¯ä»¥åŒæ—¶åŠ ä¸Šå¤šä¸ªã€‚ æ’ä»–é”: åˆå«åšå†™é”ã€‚ å½“ç”¨æˆ·è¦è¿›è¡Œæ•°æ®çš„å†™å…¥æ—¶ï¼Œå¯¹æ•°æ®åŠ ä¸Šæ’ä»–é”ã€‚æ’ä»–é”åªå¯ä»¥åŠ ä¸€ä¸ªï¼Œä»–å’Œå…¶ä»–çš„æ’ä»–é”ï¼Œå…±äº«é”éƒ½ç›¸æ–¥ã€‚ ç”¨ä¸Šé¢çš„ä¾‹å­æ¥è¯´å°±æ˜¯ç”¨æˆ·çš„è¡Œä¸ºæœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯æ¥çœ‹æˆ¿ï¼Œå¤šä¸ªç”¨æˆ·ä¸€èµ·çœ‹æˆ¿æ˜¯å¯ä»¥æ¥å—çš„ã€‚ ä¸€ç§æ˜¯çœŸæ­£çš„å…¥ä½ä¸€æ™šï¼Œåœ¨è¿™æœŸé—´ï¼Œæ— è®ºæ˜¯æƒ³å…¥ä½çš„è¿˜æ˜¯æƒ³çœ‹æˆ¿çš„éƒ½ä¸å¯ä»¥ã€‚ é”çš„ç²’åº¦å–å†³äºå…·ä½“çš„å­˜å‚¨å¼•æ“ï¼ŒInnoDBå®ç°äº†è¡Œçº§é”ï¼Œé¡µçº§é”ï¼Œè¡¨çº§é”ã€‚ ä»–ä»¬çš„åŠ é”å¼€é”€ä»å¤§åˆ°å°ï¼Œå¹¶å‘èƒ½åŠ›ä¹Ÿæ˜¯ä»å¤§åˆ°å°ã€‚ MySQLä¸­InnoDBå¼•æ“çš„è¡Œé”å®ç° ç­”ï¼šInnoDBæ˜¯åŸºäºç´¢å¼•æ¥å®Œæˆè¡Œé” ä¾‹: select * from tab_with_index where id = 1 for update; for update å¯ä»¥æ ¹æ®æ¡ä»¶æ¥å®Œæˆè¡Œé”é”å®šï¼Œå¹¶ä¸” id æ˜¯æœ‰ç´¢å¼•é”®çš„åˆ—ï¼Œå¦‚æœ id ä¸æ˜¯ç´¢å¼•é”®é‚£ä¹ˆInnoDBå°†å®Œæˆè¡¨é”ï¼Œå¹¶å‘å°†æ— ä»è°ˆèµ· InnoDBå­˜å‚¨å¼•æ“çš„é”çš„ç®—æ³•æœ‰ä¸‰ç§ Record lockï¼šå•ä¸ªè¡Œè®°å½•ä¸Šçš„é” Gap lockï¼šé—´éš™é”ï¼Œé”å®šä¸€ä¸ªèŒƒå›´ï¼Œä¸åŒ…æ‹¬è®°å½•æœ¬èº« Next-key lockï¼šrecord+gap é”å®šä¸€ä¸ªèŒƒå›´ï¼ŒåŒ…å«è®°å½•æœ¬èº« ç›¸å…³çŸ¥è¯†ç‚¹ï¼š innodbå¯¹äºè¡Œçš„æŸ¥è¯¢ä½¿ç”¨next-key lock Next-locking keyingä¸ºäº†è§£å†³Phantom Problemå¹»è¯»é—®é¢˜ å½“æŸ¥è¯¢çš„ç´¢å¼•å«æœ‰å”¯ä¸€å±æ€§æ—¶ï¼Œå°†next-key locké™çº§ä¸ºrecord key Gapé”è®¾è®¡çš„ç›®çš„æ˜¯ä¸ºäº†é˜»æ­¢å¤šä¸ªäº‹åŠ¡å°†è®°å½•æ’å…¥åˆ°åŒä¸€èŒƒå›´å†…ï¼Œè€Œè¿™ä¼šå¯¼è‡´å¹»è¯»é—®é¢˜çš„äº§ç”Ÿ æœ‰ä¸¤ç§æ–¹å¼æ˜¾å¼å…³é—­gapé”ï¼šï¼ˆé™¤äº†å¤–é”®çº¦æŸå’Œå”¯ä¸€æ€§æ£€æŸ¥å¤–ï¼Œå…¶ä½™æƒ…å†µä»…ä½¿ç”¨record lockï¼‰ A. å°†äº‹åŠ¡éš”ç¦»çº§åˆ«è®¾ç½®ä¸ºRC B. å°†å‚æ•°innodb_locks_unsafe_for_binlogè®¾ç½®ä¸º1 æ­»é” æ­»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–å¤šä¸ªäº‹åŠ¡åœ¨åŒä¸€èµ„æºä¸Šç›¸äº’å ç”¨ï¼Œå¹¶è¯·æ±‚é”å®šå¯¹æ–¹çš„èµ„æºï¼Œä»è€Œå¯¼è‡´æ¶æ€§å¾ªç¯çš„ç°è±¡ã€‚ å¸¸è§çš„è§£å†³æ­»é”çš„æ–¹æ³• å¦‚æœä¸åŒç¨‹åºä¼šå¹¶å‘å­˜å–å¤šä¸ªè¡¨ï¼Œå°½é‡çº¦å®šä»¥ç›¸åŒçš„é¡ºåºè®¿é—®è¡¨ï¼Œå¯ä»¥å¤§å¤§é™ä½æ­»é”æœºä¼šã€‚ åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå°½å¯èƒ½åšåˆ°ä¸€æ¬¡é”å®šæ‰€éœ€è¦çš„æ‰€æœ‰èµ„æºï¼Œå‡å°‘æ­»é”äº§ç”Ÿæ¦‚ç‡ï¼› å¯¹äºéå¸¸å®¹æ˜“äº§ç”Ÿæ­»é”çš„ä¸šåŠ¡éƒ¨åˆ†ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨å‡çº§é”å®šé¢—ç²’åº¦ï¼Œé€šè¿‡è¡¨çº§é”å®šæ¥å‡å°‘æ­»é”äº§ç”Ÿçš„æ¦‚ç‡ï¼› å¦‚æœä¸šåŠ¡å¤„ç†ä¸å¥½å¯ä»¥ç”¨åˆ†å¸ƒå¼äº‹åŠ¡é”æˆ–è€…ä½¿ç”¨ä¹è§‚é” æ•°æ®åº“çš„ä¹è§‚é”å’Œæ‚²è§‚é” æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼ˆDBMSï¼‰ä¸­çš„å¹¶å‘æ§åˆ¶çš„ä»»åŠ¡æ˜¯ç¡®ä¿åœ¨å¤šä¸ªäº‹åŠ¡åŒæ—¶å­˜å–æ•°æ®åº“ä¸­åŒä¸€æ•°æ®æ—¶ä¸ç ´åäº‹åŠ¡çš„éš”ç¦»æ€§å’Œç»Ÿä¸€æ€§ä»¥åŠæ•°æ®åº“çš„ç»Ÿä¸€æ€§ã€‚ä¹è§‚å¹¶å‘æ§åˆ¶ï¼ˆä¹è§‚é”ï¼‰å’Œæ‚²è§‚å¹¶å‘æ§åˆ¶ï¼ˆæ‚²è§‚é”ï¼‰æ˜¯å¹¶å‘æ§åˆ¶ä¸»è¦é‡‡ç”¨çš„æŠ€æœ¯æ‰‹æ®µã€‚ æ‚²è§‚é”ï¼šå‡å®šä¼šå‘ç”Ÿå¹¶å‘å†²çªï¼Œå±è”½ä¸€åˆ‡å¯èƒ½è¿åæ•°æ®å®Œæ•´æ€§çš„æ“ä½œã€‚åœ¨æŸ¥è¯¢å®Œæ•°æ®çš„æ—¶å€™å°±æŠŠäº‹åŠ¡é”èµ·æ¥ï¼Œç›´åˆ°æäº¤äº‹åŠ¡ã€‚å®ç°æ–¹å¼ï¼šä½¿ç”¨æ•°æ®åº“ä¸­çš„é”æœºåˆ¶ ä¹è§‚é”ï¼šå‡è®¾ä¸ä¼šå‘ç”Ÿå¹¶å‘å†²çªï¼Œåªåœ¨æäº¤æ“ä½œæ—¶æ£€æŸ¥æ˜¯å¦è¿åæ•°æ®å®Œæ•´æ€§ã€‚åœ¨ä¿®æ”¹æ•°æ®çš„æ—¶å€™æŠŠäº‹åŠ¡é”èµ·æ¥ï¼Œé€šè¿‡versionçš„æ–¹å¼æ¥è¿›è¡Œé”å®šã€‚å®ç°æ–¹å¼ï¼šä¹ä¸€èˆ¬ä¼šä½¿ç”¨ç‰ˆæœ¬å·æœºåˆ¶æˆ–CASç®—æ³•å®ç°ã€‚ ä¸¤ç§é”çš„ä½¿ç”¨åœºæ™¯ ä»ä¸Šé¢å¯¹ä¸¤ç§é”çš„ä»‹ç»ï¼Œæˆ‘ä»¬çŸ¥é“ä¸¤ç§é”å„æœ‰ä¼˜ç¼ºç‚¹ï¼Œä¸å¯è®¤ä¸ºä¸€ç§å¥½äºå¦ä¸€ç§ï¼Œåƒä¹è§‚é”é€‚ç”¨äºå†™æ¯”è¾ƒå°‘çš„æƒ…å†µä¸‹ï¼ˆå¤šè¯»åœºæ™¯ï¼‰ï¼Œå³å†²çªçœŸçš„å¾ˆå°‘å‘ç”Ÿçš„æ—¶å€™ï¼Œè¿™æ ·å¯ä»¥çœå»äº†é”çš„å¼€é”€ï¼ŒåŠ å¤§äº†ç³»ç»Ÿçš„æ•´ä¸ªååé‡ã€‚ ä½†å¦‚æœæ˜¯å¤šå†™çš„æƒ…å†µï¼Œä¸€èˆ¬ä¼šç»å¸¸äº§ç”Ÿå†²çªï¼Œè¿™å°±ä¼šå¯¼è‡´ä¸Šå±‚åº”ç”¨ä¼šä¸æ–­çš„è¿›è¡Œretryï¼Œè¿™æ ·åå€’æ˜¯é™ä½äº†æ€§èƒ½ï¼Œæ‰€ä»¥ä¸€èˆ¬å¤šå†™çš„åœºæ™¯ä¸‹ç”¨æ‚²è§‚é”å°±æ¯”è¾ƒåˆé€‚ã€‚ ","link":"https://tianxiawuhao.github.io/5ppmKteEb/"},{"title":"mysqlæ¦‚è¿°äºŒ","content":"ç´¢å¼• ç´¢å¼•æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ–‡ä»¶(InnoDBæ•°æ®è¡¨ä¸Šçš„ç´¢å¼•æ˜¯è¡¨ç©ºé—´çš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†)ï¼Œå®ƒä»¬åŒ…å«ç€å¯¹æ•°æ®è¡¨é‡Œæ‰€æœ‰è®°å½•çš„å¼•ç”¨æŒ‡é’ˆã€‚ ç´¢å¼•æ˜¯ä¸€ç§æ•°æ®ç»“æ„ã€‚æ•°æ®åº“ç´¢å¼•ï¼Œæ˜¯æ•°æ®åº“ç®¡ç†ç³»ç»Ÿä¸­ä¸€ä¸ªæ’åºçš„æ•°æ®ç»“æ„ï¼Œä»¥ååŠ©å¿«é€ŸæŸ¥è¯¢ã€æ›´æ–°æ•°æ®åº“è¡¨ä¸­æ•°æ®ã€‚ç´¢å¼•çš„å®ç°é€šå¸¸ä½¿ç”¨Bæ ‘åŠå…¶å˜ç§B+æ ‘ã€‚ æ›´é€šä¿—çš„è¯´ï¼Œç´¢å¼•å°±ç›¸å½“äºç›®å½•ã€‚ä¸ºäº†æ–¹ä¾¿æŸ¥æ‰¾ä¹¦ä¸­çš„å†…å®¹ï¼Œé€šè¿‡å¯¹å†…å®¹å»ºç«‹ç´¢å¼•å½¢æˆç›®å½•ã€‚ç´¢å¼•æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œå®ƒæ˜¯è¦å æ®ç‰©ç†ç©ºé—´çš„ã€‚ ç´¢å¼•çš„åŸºæœ¬åŸç† ç´¢å¼•ç”¨æ¥å¿«é€Ÿåœ°å¯»æ‰¾é‚£äº›å…·æœ‰ç‰¹å®šå€¼çš„è®°å½•ã€‚å¦‚æœæ²¡æœ‰ç´¢å¼•ï¼Œä¸€èˆ¬æ¥è¯´æ‰§è¡ŒæŸ¥è¯¢æ—¶éå†æ•´å¼ è¡¨ã€‚ ç´¢å¼•çš„åŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠæ— åºçš„æ•°æ®å˜æˆæœ‰åºçš„æŸ¥è¯¢ æŠŠåˆ›å»ºäº†ç´¢å¼•çš„åˆ—çš„å†…å®¹è¿›è¡Œæ’åº å¯¹æ’åºç»“æœç”Ÿæˆå€’æ’è¡¨ åœ¨å€’æ’è¡¨å†…å®¹ä¸Šæ‹¼ä¸Šæ•°æ®åœ°å€é“¾ åœ¨æŸ¥è¯¢çš„æ—¶å€™ï¼Œå…ˆæ‹¿åˆ°å€’æ’è¡¨å†…å®¹ï¼Œå†å–å‡ºæ•°æ®åœ°å€é“¾ï¼Œä»è€Œæ‹¿åˆ°å…·ä½“æ•°æ® ç´¢å¼•ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ å¯ä»¥å¤§å¤§åŠ å¿«æ•°æ®çš„æ£€ç´¢é€Ÿåº¦ï¼Œè¿™ä¹Ÿæ˜¯åˆ›å»ºç´¢å¼•çš„æœ€ä¸»è¦çš„åŸå› ã€‚ é€šè¿‡ä½¿ç”¨ç´¢å¼•ï¼Œå¯ä»¥åœ¨æŸ¥è¯¢çš„è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨ä¼˜åŒ–éšè—å™¨ï¼Œæé«˜ç³»ç»Ÿçš„æ€§èƒ½ã€‚ ç¼ºç‚¹ æ—¶é—´æ–¹é¢ï¼šåˆ›å»ºç´¢å¼•å’Œç»´æŠ¤ç´¢å¼•è¦è€—è´¹æ—¶é—´ï¼Œå…·ä½“åœ°ï¼Œå½“å¯¹è¡¨ä¸­çš„æ•°æ®è¿›è¡Œå¢åŠ ã€åˆ é™¤å’Œä¿®æ”¹çš„æ—¶å€™ï¼Œç´¢å¼•ä¹Ÿè¦åŠ¨æ€çš„ç»´æŠ¤ï¼Œä¼šé™ä½å¢/æ”¹/åˆ çš„æ‰§è¡Œæ•ˆç‡ï¼› ç©ºé—´æ–¹é¢ï¼šç´¢å¼•éœ€è¦å ç‰©ç†ç©ºé—´ã€‚ ä½¿ç”¨åœºæ™¯ï¼ˆé‡ç‚¹ï¼‰ where ä¸Šå›¾ä¸­ï¼Œæ ¹æ®idæŸ¥è¯¢è®°å½•ï¼Œå› ä¸ºidå­—æ®µä»…å»ºç«‹äº†ä¸»é”®ç´¢å¼•ï¼Œå› æ­¤æ­¤SQLæ‰§è¡Œå¯é€‰çš„ç´¢å¼•åªæœ‰ä¸»é”®ç´¢å¼•ï¼Œå¦‚æœæœ‰å¤šä¸ªï¼Œæœ€ç»ˆä¼šé€‰ä¸€ä¸ªè¾ƒä¼˜çš„ä½œä¸ºæ£€ç´¢çš„ä¾æ®ã€‚ -- å¢åŠ ä¸€ä¸ªæ²¡æœ‰å»ºç«‹ç´¢å¼•çš„å­—æ®µ alter table innodb1 add sex char(1); -- æŒ‰sexæ£€ç´¢æ—¶å¯é€‰çš„ç´¢å¼•ä¸ºnull EXPLAIN SELECT * from innodb1 where sex='ç”·'; å¯ä»¥å°è¯•åœ¨ä¸€ä¸ªå­—æ®µæœªå»ºç«‹ç´¢å¼•æ—¶ï¼Œæ ¹æ®è¯¥å­—æ®µæŸ¥è¯¢çš„æ•ˆç‡ï¼Œç„¶åå¯¹è¯¥å­—æ®µå»ºç«‹ç´¢å¼•alter table è¡¨å add index(å­—æ®µå)ï¼ŒåŒæ ·çš„SQLæ‰§è¡Œçš„æ•ˆç‡ï¼Œä½ ä¼šå‘ç°æŸ¥è¯¢æ•ˆç‡ä¼šæœ‰æ˜æ˜¾çš„æå‡ï¼ˆæ•°æ®é‡è¶Šå¤§è¶Šæ˜æ˜¾ï¼‰ã€‚ order by å½“æˆ‘ä»¬ä½¿ç”¨order byå°†æŸ¥è¯¢ç»“æœæŒ‰ç…§æŸä¸ªå­—æ®µæ’åºæ—¶ï¼Œå¦‚æœè¯¥å­—æ®µæ²¡æœ‰å»ºç«‹ç´¢å¼•ï¼Œé‚£ä¹ˆæ‰§è¡Œè®¡åˆ’ä¼šå°†æŸ¥è¯¢å‡ºçš„æ‰€æœ‰æ•°æ®ä½¿ç”¨å¤–éƒ¨æ’åºï¼ˆå°†æ•°æ®ä»ç¡¬ç›˜åˆ†æ‰¹è¯»å–åˆ°å†…å­˜ä½¿ç”¨å†…éƒ¨æ’åºï¼Œæœ€ååˆå¹¶æ’åºç»“æœï¼‰ï¼Œè¿™ä¸ªæ“ä½œæ˜¯å¾ˆå½±å“æ€§èƒ½çš„ï¼Œå› ä¸ºéœ€è¦å°†æŸ¥è¯¢æ¶‰åŠåˆ°çš„æ‰€æœ‰æ•°æ®ä»ç£ç›˜ä¸­è¯»åˆ°å†…å­˜ï¼ˆå¦‚æœå•æ¡æ•°æ®è¿‡å¤§æˆ–è€…æ•°æ®é‡è¿‡å¤šéƒ½ä¼šé™ä½æ•ˆç‡ï¼‰ï¼Œæ›´æ— è®ºè¯»åˆ°å†…å­˜ä¹‹åçš„æ’åºäº†ã€‚ ä½†æ˜¯å¦‚æœæˆ‘ä»¬å¯¹è¯¥å­—æ®µå»ºç«‹ç´¢å¼•alter table è¡¨å add index(å­—æ®µå)ï¼Œé‚£ä¹ˆç”±äºç´¢å¼•æœ¬èº«æ˜¯æœ‰åºçš„ï¼Œå› æ­¤ç›´æ¥æŒ‰ç…§ç´¢å¼•çš„é¡ºåºå’Œæ˜ å°„å…³ç³»é€æ¡å–å‡ºæ•°æ®å³å¯ã€‚è€Œä¸”å¦‚æœåˆ†é¡µçš„ï¼Œé‚£ä¹ˆåªç”¨å–å‡ºç´¢å¼•è¡¨æŸä¸ªèŒƒå›´å†…çš„ç´¢å¼•å¯¹åº”çš„æ•°æ®ï¼Œè€Œä¸ç”¨åƒä¸Šè¿°é‚£å–å‡ºæ‰€æœ‰æ•°æ®è¿›è¡Œæ’åºå†è¿”å›æŸä¸ªèŒƒå›´å†…çš„æ•°æ®ã€‚ï¼ˆä»ç£ç›˜å–æ•°æ®æ˜¯æœ€å½±å“æ€§èƒ½çš„ï¼‰ join å¯¹joinè¯­å¥åŒ¹é…å…³ç³»ï¼ˆonï¼‰æ¶‰åŠçš„å­—æ®µå»ºç«‹ç´¢å¼•èƒ½å¤Ÿæé«˜æ•ˆç‡ ç´¢å¼•è¦†ç›– å¦‚æœè¦æŸ¥è¯¢çš„å­—æ®µéƒ½å»ºç«‹è¿‡ç´¢å¼•ï¼Œé‚£ä¹ˆå¼•æ“ä¼šç›´æ¥åœ¨ç´¢å¼•è¡¨ä¸­æŸ¥è¯¢è€Œä¸ä¼šè®¿é—®åŸå§‹æ•°æ®ï¼ˆå¦åˆ™åªè¦æœ‰ä¸€ä¸ªå­—æ®µæ²¡æœ‰å»ºç«‹ç´¢å¼•å°±ä¼šåšå…¨è¡¨æ‰«æï¼‰ï¼Œè¿™å«ç´¢å¼•è¦†ç›–ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦å°½å¯èƒ½çš„åœ¨selectååªå†™å¿…è¦çš„æŸ¥è¯¢å­—æ®µï¼Œä»¥å¢åŠ ç´¢å¼•è¦†ç›–çš„å‡ ç‡ã€‚ è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ä¸è¦æƒ³ç€ä¸ºæ¯ä¸ªå­—æ®µå»ºç«‹ç´¢å¼•ï¼Œå› ä¸ºä¼˜å…ˆä½¿ç”¨ç´¢å¼•çš„ä¼˜åŠ¿å°±åœ¨äºå…¶ä½“ç§¯å°ã€‚ ç´¢å¼•ç±»å‹ ä¸»é”®ç´¢å¼•: æ•°æ®åˆ—ä¸å…è®¸é‡å¤ï¼Œä¸å…è®¸ä¸ºNULLï¼Œä¸€ä¸ªè¡¨åªèƒ½æœ‰ä¸€ä¸ªä¸»é”®ã€‚ å”¯ä¸€ç´¢å¼•: æ•°æ®åˆ—ä¸å…è®¸é‡å¤ï¼Œå…è®¸ä¸ºNULLå€¼ï¼Œä¸€ä¸ªè¡¨å…è®¸å¤šä¸ªåˆ—åˆ›å»ºå”¯ä¸€ç´¢å¼•ã€‚ å¯ä»¥é€šè¿‡ ALTER TABLE table_name ADD UNIQUE (column); åˆ›å»ºå”¯ä¸€ç´¢å¼• å¯ä»¥é€šè¿‡ ALTER TABLE table_name ADD UNIQUE (column1,column2); åˆ›å»ºå”¯ä¸€ç»„åˆç´¢å¼• æ™®é€šç´¢å¼•: åŸºæœ¬çš„ç´¢å¼•ç±»å‹ï¼Œæ²¡æœ‰å”¯ä¸€æ€§çš„é™åˆ¶ï¼Œå…è®¸ä¸ºNULLå€¼ã€‚ å¯ä»¥é€šè¿‡ALTER TABLE table_name ADD INDEX index_name (column);åˆ›å»ºæ™®é€šç´¢å¼• å¯ä»¥é€šè¿‡ALTER TABLE table_name ADD INDEX index_name(column1, column2, column3);åˆ›å»ºç»„åˆç´¢å¼• å…¨æ–‡ç´¢å¼•ï¼š æ˜¯ç›®å‰æœç´¢å¼•æ“ä½¿ç”¨çš„ä¸€ç§å…³é”®æŠ€æœ¯ã€‚ å¯ä»¥é€šè¿‡ALTER TABLE table_name ADD FULLTEXT (column);åˆ›å»ºå…¨æ–‡ç´¢å¼• ç´¢å¼•è®¾è®¡çš„åŸåˆ™ é€‚åˆç´¢å¼•çš„åˆ—æ˜¯å‡ºç°åœ¨whereå­å¥ä¸­çš„åˆ—ï¼Œæˆ–è€…è¿æ¥å­å¥ä¸­æŒ‡å®šçš„åˆ— åŸºæ•°è¾ƒå°çš„ç±»ï¼Œç´¢å¼•æ•ˆæœè¾ƒå·®ï¼Œæ²¡æœ‰å¿…è¦åœ¨æ­¤åˆ—å»ºç«‹ç´¢å¼• ä½¿ç”¨çŸ­ç´¢å¼•ï¼Œå¦‚æœå¯¹é•¿å­—ç¬¦ä¸²åˆ—è¿›è¡Œç´¢å¼•ï¼Œåº”è¯¥æŒ‡å®šä¸€ä¸ªå‰ç¼€é•¿åº¦ï¼Œè¿™æ ·èƒ½å¤ŸèŠ‚çœå¤§é‡ç´¢å¼•ç©ºé—´ ä¸è¦è¿‡åº¦ç´¢å¼•ã€‚ç´¢å¼•éœ€è¦é¢å¤–çš„ç£ç›˜ç©ºé—´ï¼Œå¹¶é™ä½å†™æ“ä½œçš„æ€§èƒ½ã€‚åœ¨ä¿®æ”¹è¡¨å†…å®¹çš„æ—¶å€™ï¼Œç´¢å¼•ä¼šè¿›è¡Œæ›´æ–°ç”šè‡³é‡æ„ï¼Œç´¢å¼•åˆ—è¶Šå¤šï¼Œè¿™ä¸ªæ—¶é—´å°±ä¼šè¶Šé•¿ã€‚æ‰€ä»¥åªä¿æŒéœ€è¦çš„ç´¢å¼•æœ‰åˆ©äºæŸ¥è¯¢å³å¯ã€‚ åˆ›å»ºç´¢å¼•çš„åŸåˆ™ï¼ˆé‡ä¸­ä¹‹é‡ï¼‰ ç´¢å¼•è™½å¥½ï¼Œä½†ä¹Ÿä¸æ˜¯æ— é™åˆ¶çš„ä½¿ç”¨ï¼Œæœ€å¥½ç¬¦åˆä¸€ä¸‹å‡ ä¸ªåŸåˆ™ 1ï¼‰ æœ€å·¦å‰ç¼€åŒ¹é…åŸåˆ™ï¼Œç»„åˆç´¢å¼•éå¸¸é‡è¦çš„åŸåˆ™ï¼Œmysqlä¼šä¸€ç›´å‘å³åŒ¹é…ç›´åˆ°é‡åˆ°èŒƒå›´æŸ¥è¯¢(&gt;ã€&lt;ã€betweenã€like)å°±åœæ­¢åŒ¹é…ï¼Œæ¯”å¦‚a = 1 and b = 2 and c &gt; 3 and d = 4 å¦‚æœå»ºç«‹(a,b,c,d)é¡ºåºçš„ç´¢å¼•ï¼Œdæ˜¯ç”¨ä¸åˆ°ç´¢å¼•çš„ï¼Œå¦‚æœå»ºç«‹(a,b,d,c)çš„ç´¢å¼•åˆ™éƒ½å¯ä»¥ç”¨åˆ°ï¼Œa,b,dçš„é¡ºåºå¯ä»¥ä»»æ„è°ƒæ•´ã€‚ 2ï¼‰è¾ƒé¢‘ç¹ä½œä¸ºæŸ¥è¯¢æ¡ä»¶çš„å­—æ®µæ‰å»åˆ›å»ºç´¢å¼• 3ï¼‰æ›´æ–°é¢‘ç¹å­—æ®µä¸é€‚åˆåˆ›å»ºç´¢å¼• 4ï¼‰è‹¥æ˜¯ä¸èƒ½æœ‰æ•ˆåŒºåˆ†æ•°æ®çš„åˆ—ä¸é€‚åˆåšç´¢å¼•åˆ—(å¦‚æ€§åˆ«ï¼Œç”·å¥³æœªçŸ¥ï¼Œæœ€å¤šä¹Ÿå°±ä¸‰ç§ï¼ŒåŒºåˆ†åº¦å®åœ¨å¤ªä½) 5ï¼‰å°½é‡çš„æ‰©å±•ç´¢å¼•ï¼Œä¸è¦æ–°å»ºç´¢å¼•ã€‚æ¯”å¦‚è¡¨ä¸­å·²ç»æœ‰açš„ç´¢å¼•ï¼Œç°åœ¨è¦åŠ (a,b)çš„ç´¢å¼•ï¼Œé‚£ä¹ˆåªéœ€è¦ä¿®æ”¹åŸæ¥çš„ç´¢å¼•å³å¯ã€‚ 6ï¼‰å®šä¹‰æœ‰å¤–é”®çš„æ•°æ®åˆ—ä¸€å®šè¦å»ºç«‹ç´¢å¼•ã€‚ 7ï¼‰å¯¹äºé‚£äº›æŸ¥è¯¢ä¸­å¾ˆå°‘æ¶‰åŠçš„åˆ—ï¼Œé‡å¤å€¼æ¯”è¾ƒå¤šçš„åˆ—ä¸è¦å»ºç«‹ç´¢å¼•ã€‚ 8ï¼‰å¯¹äºå®šä¹‰ä¸ºtextã€imageå’Œbitçš„æ•°æ®ç±»å‹çš„åˆ—ä¸è¦å»ºç«‹ç´¢å¼•ã€‚ åˆ›å»ºç´¢å¼•çš„ä¸‰ç§æ–¹å¼ ç¬¬ä¸€ç§æ–¹å¼ï¼šåœ¨æ‰§è¡ŒCREATE TABLEæ—¶åˆ›å»ºç´¢å¼• CREATE TABLE user_index2 ( id INT auto_increment PRIMARY KEY, first_name VARCHAR ( 16 ), last_name VARCHAR ( 16 ), id_card VARCHAR ( 18 ), information text, KEY NAME ( first_name, last_name ), FULLTEXT KEY ( information ), UNIQUE KEY ( id_card ) ); ç¬¬äºŒç§æ–¹å¼ï¼šä½¿ç”¨ALTER TABLEå‘½ä»¤å»å¢åŠ ç´¢å¼• //ALTER TABLEç”¨æ¥åˆ›å»ºæ™®é€šç´¢å¼•ã€UNIQUEç´¢å¼•æˆ–PRIMARY KEYç´¢å¼•ã€‚ ALTER TABLE table_name ADD INDEX index_name (column_list); å…¶ä¸­table_nameæ˜¯è¦å¢åŠ ç´¢å¼•çš„è¡¨åï¼Œcolumn_listæŒ‡å‡ºå¯¹å“ªäº›åˆ—è¿›è¡Œç´¢å¼•ï¼Œå¤šåˆ—æ—¶å„åˆ—ä¹‹é—´ç”¨é€—å·åˆ†éš”ã€‚ ç´¢å¼•åindex_nameå¯è‡ªå·±å‘½åï¼Œç¼ºçœæ—¶ï¼ŒMySQLå°†æ ¹æ®ç¬¬ä¸€ä¸ªç´¢å¼•åˆ—èµ‹ä¸€ä¸ªåç§°ã€‚å¦å¤–ï¼ŒALTER TABLEå…è®¸åœ¨å•ä¸ªè¯­å¥ä¸­æ›´æ”¹å¤šä¸ªè¡¨ï¼Œå› æ­¤å¯ä»¥åœ¨åŒæ—¶åˆ›å»ºå¤šä¸ªç´¢å¼•ã€‚ ç¬¬ä¸‰ç§æ–¹å¼ï¼šä½¿ç”¨CREATE INDEXå‘½ä»¤åˆ›å»º //CREATE INDEXå¯å¯¹è¡¨å¢åŠ æ™®é€šç´¢å¼•æˆ–UNIQUEç´¢å¼•ã€‚ï¼ˆä½†æ˜¯ï¼Œä¸èƒ½åˆ›å»ºPRIMARY KEYç´¢å¼•ï¼‰ CREATE INDEX index_name ON table_name (column_list); åˆ é™¤ç´¢å¼• æ ¹æ®ç´¢å¼•ååˆ é™¤æ™®é€šç´¢å¼•ã€å”¯ä¸€ç´¢å¼•ã€å…¨æ–‡ç´¢å¼•ï¼šalter table è¡¨å drop KEY ç´¢å¼•å ALTER TABLE user_index DROP KEY NAME; ALTER TABLE user_index DROP KEY id_card; ALTER TABLE user_index DROP KEY information; åˆ é™¤ä¸»é”®ç´¢å¼•ï¼šalter table è¡¨å drop primary keyï¼ˆå› ä¸ºä¸»é”®åªæœ‰ä¸€ä¸ªï¼‰ã€‚è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä¸»é”®è‡ªå¢é•¿ï¼Œé‚£ä¹ˆä¸èƒ½ç›´æ¥æ‰§è¡Œæ­¤æ“ä½œï¼ˆè‡ªå¢é•¿ä¾èµ–äºä¸»é”®ç´¢å¼•ï¼‰ï¼š éœ€è¦å–æ¶ˆè‡ªå¢é•¿å†è¡Œåˆ é™¤ï¼š alter table user_index -- é‡æ–°å®šä¹‰å­—æ®µ MODIFY id int, drop PRIMARY KEY ä½†é€šå¸¸ä¸ä¼šåˆ é™¤ä¸»é”®ï¼Œå› ä¸ºè®¾è®¡ä¸»é”®ä¸€å®šä¸ä¸šåŠ¡é€»è¾‘æ— å…³ã€‚ åˆ›å»ºç´¢å¼•æ—¶éœ€è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ éç©ºå­—æ®µï¼šåº”è¯¥æŒ‡å®šåˆ—ä¸ºNOT NULLï¼Œé™¤éä½ æƒ³å­˜å‚¨NULLã€‚åœ¨mysqlä¸­ï¼Œå«æœ‰ç©ºå€¼çš„åˆ—å¾ˆéš¾è¿›è¡ŒæŸ¥è¯¢ä¼˜åŒ–ï¼Œå› ä¸ºå®ƒä»¬ä½¿å¾—ç´¢å¼•ã€ç´¢å¼•çš„ç»Ÿè®¡ä¿¡æ¯ä»¥åŠæ¯”è¾ƒè¿ç®—æ›´åŠ å¤æ‚ã€‚ä½ åº”è¯¥ç”¨0ã€ä¸€ä¸ªç‰¹æ®Šçš„å€¼æˆ–è€…ä¸€ä¸ªç©ºä¸²ä»£æ›¿ç©ºå€¼ï¼› å–å€¼ç¦»æ•£å¤§çš„å­—æ®µï¼šï¼ˆå˜é‡å„ä¸ªå–å€¼ä¹‹é—´çš„å·®å¼‚ç¨‹åº¦ï¼‰çš„åˆ—æ”¾åˆ°è”åˆç´¢å¼•çš„å‰é¢ï¼Œå¯ä»¥é€šè¿‡count()å‡½æ•°æŸ¥çœ‹å­—æ®µçš„å·®å¼‚å€¼ï¼Œè¿”å›å€¼è¶Šå¤§è¯´æ˜å­—æ®µçš„å”¯ä¸€å€¼è¶Šå¤šå­—æ®µçš„ç¦»æ•£ç¨‹åº¦é«˜ï¼› ç´¢å¼•å­—æ®µè¶Šå°è¶Šå¥½ï¼šæ•°æ®åº“çš„æ•°æ®å­˜å‚¨ä»¥é¡µä¸ºå•ä½ä¸€é¡µå­˜å‚¨çš„æ•°æ®è¶Šå¤šä¸€æ¬¡IOæ“ä½œè·å–çš„æ•°æ®è¶Šå¤§æ•ˆç‡è¶Šé«˜ã€‚ ä½¿ç”¨ç´¢å¼•æŸ¥è¯¢ä¸€å®šèƒ½æé«˜æŸ¥è¯¢çš„æ€§èƒ½å—ï¼Ÿä¸ºä»€ä¹ˆ é€šå¸¸ï¼Œé€šè¿‡ç´¢å¼•æŸ¥è¯¢æ•°æ®æ¯”å…¨è¡¨æ‰«æè¦å¿«ã€‚ä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¿…é¡»æ³¨æ„åˆ°å®ƒçš„ä»£ä»·ã€‚ ç´¢å¼•éœ€è¦ç©ºé—´æ¥å­˜å‚¨ï¼Œä¹Ÿéœ€è¦å®šæœŸç»´æŠ¤ï¼Œ æ¯å½“æœ‰è®°å½•åœ¨è¡¨ä¸­å¢å‡æˆ–ç´¢å¼•åˆ—è¢«ä¿®æ”¹æ—¶ï¼Œç´¢å¼•æœ¬èº«ä¹Ÿä¼šè¢«ä¿®æ”¹ã€‚ è¿™æ„å‘³ç€æ¯æ¡è®°å½•çš„INSERTï¼ŒDELETEï¼ŒUPDATEå°†ä¸ºæ­¤å¤šä»˜å‡º4ï¼Œ5 æ¬¡çš„ç£ç›˜I/Oã€‚ å› ä¸ºç´¢å¼•éœ€è¦é¢å¤–çš„å­˜å‚¨ç©ºé—´å’Œå¤„ç†ï¼Œé‚£äº›ä¸å¿…è¦çš„ç´¢å¼•åè€Œä¼šä½¿æŸ¥è¯¢ååº”æ—¶é—´å˜æ…¢ã€‚ä½¿ç”¨ç´¢å¼•æŸ¥è¯¢ä¸ä¸€å®šèƒ½æé«˜æŸ¥è¯¢æ€§èƒ½ï¼Œç´¢å¼•èŒƒå›´æŸ¥è¯¢(INDEX RANGE SCAN)é€‚ç”¨äºä¸¤ç§æƒ…å†µ: åŸºäºä¸€ä¸ªèŒƒå›´çš„æ£€ç´¢ï¼Œä¸€èˆ¬æŸ¥è¯¢è¿”å›ç»“æœé›†å°äºè¡¨ä¸­è®°å½•æ•°çš„30% åŸºäºéå”¯ä¸€æ€§ç´¢å¼•çš„æ£€ç´¢ ç™¾ä¸‡çº§åˆ«æˆ–ä»¥ä¸Šçš„æ•°æ®å¦‚ä½•åˆ é™¤ å…³äºç´¢å¼•ï¼šç”±äºç´¢å¼•éœ€è¦é¢å¤–çš„ç»´æŠ¤æˆæœ¬ï¼Œå› ä¸ºç´¢å¼•æ–‡ä»¶æ˜¯å•ç‹¬å­˜åœ¨çš„æ–‡ä»¶,æ‰€ä»¥å½“æˆ‘ä»¬å¯¹æ•°æ®çš„å¢åŠ ,ä¿®æ”¹,åˆ é™¤,éƒ½ä¼šäº§ç”Ÿé¢å¤–çš„å¯¹ç´¢å¼•æ–‡ä»¶çš„æ“ä½œ,è¿™äº›æ“ä½œéœ€è¦æ¶ˆè€—é¢å¤–çš„IO,ä¼šé™ä½å¢/æ”¹/åˆ çš„æ‰§è¡Œæ•ˆç‡ã€‚æ‰€ä»¥ï¼Œåœ¨æˆ‘ä»¬åˆ é™¤æ•°æ®åº“ç™¾ä¸‡çº§åˆ«æ•°æ®çš„æ—¶å€™ï¼ŒæŸ¥è¯¢MySQLå®˜æ–¹æ‰‹å†Œå¾—çŸ¥åˆ é™¤æ•°æ®çš„é€Ÿåº¦å’Œåˆ›å»ºçš„ç´¢å¼•æ•°é‡æ˜¯æˆæ­£æ¯”çš„ã€‚ æ‰€ä»¥æˆ‘ä»¬æƒ³è¦åˆ é™¤ç™¾ä¸‡æ•°æ®çš„æ—¶å€™å¯ä»¥å…ˆåˆ é™¤ç´¢å¼•ï¼ˆæ­¤æ—¶å¤§æ¦‚è€—æ—¶ä¸‰åˆ†å¤šé’Ÿï¼‰ ç„¶ååˆ é™¤å…¶ä¸­æ— ç”¨æ•°æ®ï¼ˆæ­¤è¿‡ç¨‹éœ€è¦ä¸åˆ°ä¸¤åˆ†é’Ÿï¼‰ åˆ é™¤å®Œæˆåé‡æ–°åˆ›å»ºç´¢å¼•(æ­¤æ—¶æ•°æ®è¾ƒå°‘äº†)åˆ›å»ºç´¢å¼•ä¹Ÿéå¸¸å¿«ï¼Œçº¦ååˆ†é’Ÿå·¦å³ã€‚ ä¸ä¹‹å‰çš„ç›´æ¥åˆ é™¤ç»å¯¹æ˜¯è¦å¿«é€Ÿå¾ˆå¤šï¼Œæ›´åˆ«è¯´ä¸‡ä¸€åˆ é™¤ä¸­æ–­,ä¸€åˆ‡åˆ é™¤ä¼šå›æ»šã€‚é‚£æ›´æ˜¯å‘äº†ã€‚ å‰ç¼€ç´¢å¼• è¯­æ³•ï¼šindex(field(10))ï¼Œä½¿ç”¨å­—æ®µå€¼çš„å‰10ä¸ªå­—ç¬¦å»ºç«‹ç´¢å¼•ï¼Œé»˜è®¤æ˜¯ä½¿ç”¨å­—æ®µçš„å…¨éƒ¨å†…å®¹å»ºç«‹ç´¢å¼•ã€‚ å‰æï¼šå‰ç¼€çš„æ ‡è¯†åº¦é«˜ã€‚æ¯”å¦‚å¯†ç å°±é€‚åˆå»ºç«‹å‰ç¼€ç´¢å¼•ï¼Œå› ä¸ºå¯†ç å‡ ä¹å„ä¸ç›¸åŒã€‚ å®æ“çš„éš¾åº¦ï¼šåœ¨äºå‰ç¼€æˆªå–çš„é•¿åº¦ã€‚ æˆ‘ä»¬å¯ä»¥åˆ©ç”¨select count(*)/count(distinct left(password,prefixLen));ï¼Œé€šè¿‡ä»è°ƒæ•´prefixLençš„å€¼ï¼ˆä»1è‡ªå¢ï¼‰æŸ¥çœ‹ä¸åŒå‰ç¼€é•¿åº¦çš„ä¸€ä¸ªå¹³å‡åŒ¹é…åº¦ï¼Œæ¥è¿‘1æ—¶å°±å¯ä»¥äº†ï¼ˆè¡¨ç¤ºä¸€ä¸ªå¯†ç çš„å‰prefixLenä¸ªå­—ç¬¦å‡ ä¹èƒ½ç¡®å®šå”¯ä¸€ä¸€æ¡è®°å½•ï¼‰ ä»€ä¹ˆæ˜¯æœ€å·¦å‰ç¼€åŸåˆ™ï¼Ÿä»€ä¹ˆæ˜¯æœ€å·¦åŒ¹é…åŸåˆ™ é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯æœ€å·¦ä¼˜å…ˆï¼Œåœ¨åˆ›å»ºå¤šåˆ—ç´¢å¼•æ—¶ï¼Œè¦æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œwhereå­å¥ä¸­ä½¿ç”¨æœ€é¢‘ç¹çš„ä¸€åˆ—æ”¾åœ¨æœ€å·¦è¾¹ã€‚ æœ€å·¦å‰ç¼€åŒ¹é…åŸåˆ™ï¼Œéå¸¸é‡è¦çš„åŸåˆ™ï¼Œmysqlä¼šä¸€ç›´å‘å³åŒ¹é…ç›´åˆ°é‡åˆ°èŒƒå›´æŸ¥è¯¢(&gt;ã€&lt;ã€betweenã€like)å°±åœæ­¢åŒ¹é…ï¼Œæ¯”å¦‚a = 1 and b = 2 and c &gt; 3 and d = 4 å¦‚æœå»ºç«‹(a,b,c,d)é¡ºåºçš„ç´¢å¼•ï¼Œdæ˜¯ç”¨ä¸åˆ°ç´¢å¼•çš„ï¼Œå¦‚æœå»ºç«‹(a,b,d,c)çš„ç´¢å¼•åˆ™éƒ½å¯ä»¥ç”¨åˆ°ï¼Œa,b,dçš„é¡ºåºå¯ä»¥ä»»æ„è°ƒæ•´ã€‚ =å’Œinå¯ä»¥ä¹±åºï¼Œæ¯”å¦‚a = 1 and b = 2 and c = 3 å»ºç«‹(a,b,c)ç´¢å¼•å¯ä»¥ä»»æ„é¡ºåºï¼Œmysqlçš„æŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šå¸®ä½ ä¼˜åŒ–æˆç´¢å¼•å¯ä»¥è¯†åˆ«çš„å½¢å¼ ç´¢å¼•ç®—æ³• ç´¢å¼•ç®—æ³•æœ‰ BTreeç®—æ³•å’ŒHashç®—æ³• BTreeç®—æ³• BTreeæ˜¯æœ€å¸¸ç”¨çš„mysqlæ•°æ®åº“ç´¢å¼•ç®—æ³•ï¼Œä¹Ÿæ˜¯mysqlé»˜è®¤çš„ç®—æ³•ã€‚å› ä¸ºå®ƒä¸ä»…å¯ä»¥è¢«ç”¨åœ¨=,&gt;,&gt;=,&lt;,&lt;=å’Œbetweenè¿™äº›æ¯”è¾ƒæ“ä½œç¬¦ä¸Šï¼Œè€Œä¸”è¿˜å¯ä»¥ç”¨äºlikeæ“ä½œç¬¦ï¼Œåªè¦å®ƒçš„æŸ¥è¯¢æ¡ä»¶æ˜¯ä¸€ä¸ªä¸ä»¥é€šé…ç¬¦å¼€å¤´çš„å¸¸é‡ï¼Œ ä¾‹å¦‚ï¼š -- åªè¦å®ƒçš„æŸ¥è¯¢æ¡ä»¶æ˜¯ä¸€ä¸ªä¸ä»¥é€šé…ç¬¦å¼€å¤´çš„å¸¸é‡ select * from user where name like 'jack%'; -- å¦‚æœä¸€é€šé…ç¬¦å¼€å¤´ï¼Œæˆ–è€…æ²¡æœ‰ä½¿ç”¨å¸¸é‡ï¼Œåˆ™ä¸ä¼šä½¿ç”¨ç´¢å¼•ï¼Œä¾‹å¦‚ï¼š select * from user where name like '%jack'; Hashç®—æ³• Hash Hashç´¢å¼•åªèƒ½ç”¨äºå¯¹ç­‰æ¯”è¾ƒï¼Œä¾‹å¦‚=,&lt;=&gt;ï¼ˆç›¸å½“äº=ï¼‰æ“ä½œç¬¦ã€‚ç”±äºæ˜¯ä¸€æ¬¡å®šä½æ•°æ®ï¼Œä¸åƒBTreeç´¢å¼•éœ€è¦ä»æ ¹èŠ‚ç‚¹åˆ°æèŠ‚ç‚¹ï¼Œæœ€åæ‰èƒ½è®¿é—®åˆ°é¡µèŠ‚ç‚¹è¿™æ ·å¤šæ¬¡IOè®¿é—®ï¼Œæ‰€ä»¥æ£€ç´¢æ•ˆç‡è¿œé«˜äºBTreeç´¢å¼•ã€‚ ç´¢å¼•çš„æ•°æ®ç»“æ„ï¼ˆbæ ‘ï¼Œhashï¼‰ ç´¢å¼•çš„æ•°æ®ç»“æ„å’Œå…·ä½“å­˜å‚¨å¼•æ“çš„å®ç°æœ‰å…³ï¼Œåœ¨MySQLä¸­ä½¿ç”¨è¾ƒå¤šçš„ç´¢å¼•æœ‰Hashç´¢å¼•ï¼ŒB+æ ‘ç´¢å¼•ç­‰ï¼Œè€Œæˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„InnoDBå­˜å‚¨å¼•æ“çš„é»˜è®¤ç´¢å¼•å®ç°ä¸ºï¼šB+æ ‘ç´¢å¼•ã€‚å¯¹äºå“ˆå¸Œç´¢å¼•æ¥è¯´ï¼Œåº•å±‚çš„æ•°æ®ç»“æ„å°±æ˜¯å“ˆå¸Œè¡¨ï¼Œå› æ­¤åœ¨ç»å¤§å¤šæ•°éœ€æ±‚ä¸ºå•æ¡è®°å½•æŸ¥è¯¢çš„æ—¶å€™ï¼Œå¯ä»¥é€‰æ‹©å“ˆå¸Œç´¢å¼•ï¼ŒæŸ¥è¯¢æ€§èƒ½æœ€å¿«ï¼›å…¶ä½™å¤§éƒ¨åˆ†åœºæ™¯ï¼Œå»ºè®®é€‰æ‹©BTreeç´¢å¼•ã€‚ Bæ ‘ç´¢å¼• mysqlé€šè¿‡å­˜å‚¨å¼•æ“å–æ•°æ®ï¼ŒåŸºæœ¬ä¸Š90%çš„äººç”¨çš„å°±æ˜¯InnoDBäº†ï¼ŒæŒ‰ç…§å®ç°æ–¹å¼åˆ†ï¼ŒInnoDBçš„ç´¢å¼•ç±»å‹ç›®å‰åªæœ‰ä¸¤ç§ï¼šBTREEï¼ˆBæ ‘ï¼‰ç´¢å¼•å’ŒHASHç´¢å¼•ã€‚Bæ ‘ç´¢å¼•æ˜¯Mysqlæ•°æ®åº“ä¸­ä½¿ç”¨æœ€é¢‘ç¹çš„ç´¢å¼•ç±»å‹ï¼ŒåŸºæœ¬æ‰€æœ‰å­˜å‚¨å¼•æ“éƒ½æ”¯æŒBTreeç´¢å¼•ã€‚é€šå¸¸æˆ‘ä»¬è¯´çš„ç´¢å¼•ä¸å‡ºæ„å¤–æŒ‡çš„å°±æ˜¯ï¼ˆBæ ‘ï¼‰ç´¢å¼•ï¼ˆå®é™…æ˜¯ç”¨B+æ ‘å®ç°çš„ï¼Œå› ä¸ºåœ¨æŸ¥çœ‹è¡¨ç´¢å¼•æ—¶SHOW INDEX FROM &lt;è¡¨å&gt; [ FROM &lt;æ•°æ®åº“å&gt;]ï¼Œmysqlä¸€å¾‹æ‰“å°BTREEï¼Œæ‰€ä»¥ç®€ç§°ä¸ºBæ ‘ç´¢å¼•ï¼‰ æŸ¥è¯¢æ–¹å¼ï¼š ä¸»é”®ç´¢å¼•åŒº:PI(å…³è”ä¿å­˜çš„æ•°æ®çš„åœ°å€)æŒ‰ä¸»é”®æŸ¥è¯¢, æ™®é€šç´¢å¼•åŒº:si(å…³è”çš„idçš„åœ°å€,ç„¶åå†åˆ°è¾¾ä¸Šé¢çš„åœ°å€)ã€‚æ‰€ä»¥æŒ‰ä¸»é”®æŸ¥è¯¢,é€Ÿåº¦æœ€å¿« B+treeæ€§è´¨ï¼š 1.ï¼‰næ£µå­treeçš„èŠ‚ç‚¹åŒ…å«nä¸ªå…³é”®å­—ï¼Œä¸ç”¨æ¥ä¿å­˜æ•°æ®è€Œæ˜¯ä¿å­˜æ•°æ®çš„ç´¢å¼•ã€‚ 2.ï¼‰æ‰€æœ‰çš„å¶å­ç»“ç‚¹ä¸­åŒ…å«äº†å…¨éƒ¨å…³é”®å­—çš„ä¿¡æ¯ï¼ŒåŠæŒ‡å‘å«è¿™äº›å…³é”®å­—è®°å½•çš„æŒ‡é’ˆï¼Œä¸”å¶å­ç»“ç‚¹æœ¬èº«ä¾å…³é”®å­—çš„å¤§å°è‡ªå°è€Œå¤§é¡ºåºé“¾æ¥ã€‚ 3.ï¼‰æ‰€æœ‰çš„éç»ˆç«¯ç»“ç‚¹å¯ä»¥çœ‹æˆæ˜¯ç´¢å¼•éƒ¨åˆ†ï¼Œç»“ç‚¹ä¸­ä»…å«å…¶å­æ ‘ä¸­çš„æœ€å¤§ï¼ˆæˆ–æœ€å°ï¼‰å…³é”®å­—ã€‚ 4.ï¼‰B+ æ ‘ä¸­ï¼Œæ•°æ®å¯¹è±¡çš„æ’å…¥å’Œåˆ é™¤ä»…åœ¨å¶èŠ‚ç‚¹ä¸Šè¿›è¡Œã€‚ 5.ï¼‰B+æ ‘æœ‰2ä¸ªå¤´æŒ‡é’ˆï¼Œä¸€ä¸ªæ˜¯æ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œä¸€ä¸ªæ˜¯æœ€å°å…³é”®ç çš„å¶èŠ‚ç‚¹ã€‚ å“ˆå¸Œç´¢å¼• ç®€è¦è¯´ä¸‹ï¼Œç±»ä¼¼äºæ•°æ®ç»“æ„ä¸­ç®€å•å®ç°çš„HASHè¡¨ï¼ˆæ•£åˆ—è¡¨ï¼‰ä¸€æ ·ï¼Œå½“æˆ‘ä»¬åœ¨mysqlä¸­ç”¨å“ˆå¸Œç´¢å¼•æ—¶ï¼Œä¸»è¦å°±æ˜¯é€šè¿‡Hashç®—æ³•ï¼ˆå¸¸è§çš„Hashç®—æ³•æœ‰ç›´æ¥å®šå€æ³•ã€å¹³æ–¹å–ä¸­æ³•ã€æŠ˜å æ³•ã€é™¤æ•°å–ä½™æ³•ã€éšæœºæ•°æ³•ï¼‰ï¼Œå°†æ•°æ®åº“å­—æ®µæ•°æ®è½¬æ¢æˆå®šé•¿çš„Hashå€¼ï¼Œä¸è¿™æ¡æ•°æ®çš„è¡ŒæŒ‡é’ˆä¸€å¹¶å­˜å…¥Hashè¡¨çš„å¯¹åº”ä½ç½®ï¼›å¦‚æœå‘ç”ŸHashç¢°æ’ï¼ˆä¸¤ä¸ªä¸åŒå…³é”®å­—çš„Hashå€¼ç›¸åŒï¼‰ï¼Œåˆ™åœ¨å¯¹åº”Hashé”®ä¸‹ä»¥é“¾è¡¨å½¢å¼å­˜å‚¨ã€‚å½“ç„¶è¿™åªæ˜¯ç®€ç•¥æ¨¡æ‹Ÿå›¾ã€‚ Bæ ‘å’ŒB+æ ‘çš„åŒºåˆ« åœ¨Bæ ‘ä¸­ï¼Œä½ å¯ä»¥å°†é”®å’Œå€¼å­˜æ”¾åœ¨å†…éƒ¨èŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹ï¼›ä½†åœ¨B+æ ‘ä¸­ï¼Œå†…éƒ¨èŠ‚ç‚¹éƒ½æ˜¯é”®ï¼Œæ²¡æœ‰å€¼ï¼Œå¶å­èŠ‚ç‚¹åŒæ—¶å­˜æ”¾é”®å’Œå€¼ã€‚ B+æ ‘çš„å¶å­èŠ‚ç‚¹æœ‰ä¸€æ¡é“¾ç›¸è¿ï¼Œè€ŒBæ ‘çš„å¶å­èŠ‚ç‚¹å„è‡ªç‹¬ç«‹ã€‚ ä½¿ç”¨Bæ ‘çš„å¥½å¤„ Bæ ‘å¯ä»¥åœ¨å†…éƒ¨èŠ‚ç‚¹åŒæ—¶å­˜å‚¨é”®å’Œå€¼ï¼Œå› æ­¤ï¼ŒæŠŠé¢‘ç¹è®¿é—®çš„æ•°æ®æ”¾åœ¨é è¿‘æ ¹èŠ‚ç‚¹çš„åœ°æ–¹å°†ä¼šå¤§å¤§æé«˜çƒ­ç‚¹æ•°æ®çš„æŸ¥è¯¢æ•ˆç‡ã€‚è¿™ç§ç‰¹æ€§ä½¿å¾—Bæ ‘åœ¨ç‰¹å®šæ•°æ®é‡å¤å¤šæ¬¡æŸ¥è¯¢çš„åœºæ™¯ä¸­æ›´åŠ é«˜æ•ˆã€‚ ä½¿ç”¨B+æ ‘çš„å¥½å¤„ ç”±äºB+æ ‘çš„å†…éƒ¨èŠ‚ç‚¹åªå­˜æ”¾é”®ï¼Œä¸å­˜æ”¾å€¼ï¼Œå› æ­¤ï¼Œä¸€æ¬¡è¯»å–ï¼Œå¯ä»¥åœ¨å†…å­˜é¡µä¸­è·å–æ›´å¤šçš„é”®ï¼Œæœ‰åˆ©äºæ›´å¿«åœ°ç¼©å°æŸ¥æ‰¾èŒƒå›´ã€‚ B+æ ‘çš„å¶èŠ‚ç‚¹ç”±ä¸€æ¡é“¾ç›¸è¿ï¼Œå› æ­¤ï¼Œå½“éœ€è¦è¿›è¡Œä¸€æ¬¡å…¨æ•°æ®éå†çš„æ—¶å€™ï¼ŒB+æ ‘åªéœ€è¦ä½¿ç”¨O(logN)æ—¶é—´æ‰¾åˆ°æœ€å°çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç„¶åé€šè¿‡é“¾è¿›è¡ŒO(N)çš„é¡ºåºéå†å³å¯ã€‚è€ŒBæ ‘åˆ™éœ€è¦å¯¹æ ‘çš„æ¯ä¸€å±‚è¿›è¡Œéå†ï¼Œè¿™ä¼šéœ€è¦æ›´å¤šçš„å†…å­˜ç½®æ¢æ¬¡æ•°ï¼Œå› æ­¤ä¹Ÿå°±éœ€è¦èŠ±è´¹æ›´å¤šçš„æ—¶é—´ Hashç´¢å¼•å’ŒB+æ ‘å¯¹æ¯” é¦–å…ˆè¦çŸ¥é“Hashç´¢å¼•å’ŒB+æ ‘ç´¢å¼•çš„åº•å±‚å®ç°åŸç†ï¼š hashç´¢å¼•åº•å±‚å°±æ˜¯hashè¡¨ï¼Œè¿›è¡ŒæŸ¥æ‰¾æ—¶ï¼Œè°ƒç”¨ä¸€æ¬¡hashå‡½æ•°å°±å¯ä»¥è·å–åˆ°ç›¸åº”çš„é”®å€¼ï¼Œä¹‹åè¿›è¡Œå›è¡¨æŸ¥è¯¢è·å¾—å®é™…æ•°æ®ã€‚B+æ ‘åº•å±‚å®ç°æ˜¯å¤šè·¯å¹³è¡¡æŸ¥æ‰¾æ ‘ã€‚å¯¹äºæ¯ä¸€æ¬¡çš„æŸ¥è¯¢éƒ½æ˜¯ä»æ ¹èŠ‚ç‚¹å‡ºå‘ï¼ŒæŸ¥æ‰¾åˆ°å¶å­èŠ‚ç‚¹æ–¹å¯ä»¥è·å¾—æ‰€æŸ¥é”®å€¼ï¼Œç„¶åæ ¹æ®æŸ¥è¯¢åˆ¤æ–­æ˜¯å¦éœ€è¦å›è¡¨æŸ¥è¯¢æ•°æ®ã€‚ é‚£ä¹ˆå¯ä»¥çœ‹å‡ºä»–ä»¬æœ‰ä»¥ä¸‹çš„ä¸åŒï¼š hashç´¢å¼•è¿›è¡Œç­‰å€¼æŸ¥è¯¢æ›´å¿«(ä¸€èˆ¬æƒ…å†µä¸‹)ï¼Œä½†æ˜¯å´æ— æ³•è¿›è¡ŒèŒƒå›´æŸ¥è¯¢ã€‚ å› ä¸ºåœ¨hashç´¢å¼•ä¸­ç»è¿‡hashå‡½æ•°å»ºç«‹ç´¢å¼•ä¹‹åï¼Œç´¢å¼•çš„é¡ºåºä¸åŸé¡ºåºæ— æ³•ä¿æŒä¸€è‡´ï¼Œä¸èƒ½æ”¯æŒèŒƒå›´æŸ¥è¯¢ã€‚è€ŒB+æ ‘çš„çš„æ‰€æœ‰èŠ‚ç‚¹çš†éµå¾ª(å·¦èŠ‚ç‚¹å°äºçˆ¶èŠ‚ç‚¹ï¼Œå³èŠ‚ç‚¹å¤§äºçˆ¶èŠ‚ç‚¹ï¼Œå¤šå‰æ ‘ä¹Ÿç±»ä¼¼)ï¼Œå¤©ç„¶æ”¯æŒèŒƒå›´ã€‚ hashç´¢å¼•ä¸æ”¯æŒä½¿ç”¨ç´¢å¼•è¿›è¡Œæ’åºï¼ŒåŸç†åŒä¸Šã€‚ hashç´¢å¼•ä¸æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢ä»¥åŠå¤šåˆ—ç´¢å¼•çš„æœ€å·¦å‰ç¼€åŒ¹é…ã€‚åŸç†ä¹Ÿæ˜¯å› ä¸ºhashå‡½æ•°çš„ä¸å¯é¢„æµ‹ã€‚AAAAå’ŒAAAABçš„ç´¢å¼•æ²¡æœ‰ç›¸å…³æ€§ã€‚ hashç´¢å¼•ä»»ä½•æ—¶å€™éƒ½é¿å…ä¸äº†å›è¡¨æŸ¥è¯¢æ•°æ®ï¼Œè€ŒB+æ ‘åœ¨ç¬¦åˆæŸäº›æ¡ä»¶(èšç°‡ç´¢å¼•ï¼Œè¦†ç›–ç´¢å¼•ç­‰)çš„æ—¶å€™å¯ä»¥åªé€šè¿‡ç´¢å¼•å®ŒæˆæŸ¥è¯¢ã€‚ hashç´¢å¼•è™½ç„¶åœ¨ç­‰å€¼æŸ¥è¯¢ä¸Šè¾ƒå¿«ï¼Œä½†æ˜¯ä¸ç¨³å®šã€‚æ€§èƒ½ä¸å¯é¢„æµ‹ï¼Œå½“æŸä¸ªé”®å€¼å­˜åœ¨å¤§é‡é‡å¤çš„æ—¶å€™ï¼Œå‘ç”Ÿhashç¢°æ’ï¼Œæ­¤æ—¶æ•ˆç‡å¯èƒ½æå·®ã€‚è€ŒB+æ ‘çš„æŸ¥è¯¢æ•ˆç‡æ¯”è¾ƒç¨³å®šï¼Œå¯¹äºæ‰€æœ‰çš„æŸ¥è¯¢éƒ½æ˜¯ä»æ ¹èŠ‚ç‚¹åˆ°å¶å­èŠ‚ç‚¹ï¼Œä¸”æ ‘çš„é«˜åº¦è¾ƒä½ã€‚ å› æ­¤ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç›´æ¥é€‰æ‹©B+æ ‘ç´¢å¼•å¯ä»¥è·å¾—ç¨³å®šä¸”è¾ƒå¥½çš„æŸ¥è¯¢é€Ÿåº¦ã€‚è€Œä¸éœ€è¦ä½¿ç”¨hashç´¢å¼•ã€‚ æ•°æ®åº“ä¸ºä»€ä¹ˆä½¿ç”¨B+æ ‘è€Œä¸æ˜¯Bæ ‘ Bæ ‘åªé€‚åˆéšæœºæ£€ç´¢ï¼Œè€ŒB+æ ‘åŒæ—¶æ”¯æŒéšæœºæ£€ç´¢å’Œé¡ºåºæ£€ç´¢ï¼› B+æ ‘ç©ºé—´åˆ©ç”¨ç‡æ›´é«˜ï¼Œå¯å‡å°‘I/Oæ¬¡æ•°ï¼Œç£ç›˜è¯»å†™ä»£ä»·æ›´ä½ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œç´¢å¼•æœ¬èº«ä¹Ÿå¾ˆå¤§ï¼Œä¸å¯èƒ½å…¨éƒ¨å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå› æ­¤ç´¢å¼•å¾€å¾€ä»¥ç´¢å¼•æ–‡ä»¶çš„å½¢å¼å­˜å‚¨çš„ç£ç›˜ä¸Šã€‚è¿™æ ·çš„è¯ï¼Œç´¢å¼•æŸ¥æ‰¾è¿‡ç¨‹ä¸­å°±è¦äº§ç”Ÿç£ç›˜I/Oæ¶ˆè€—ã€‚B+æ ‘çš„å†…éƒ¨ç»“ç‚¹å¹¶æ²¡æœ‰æŒ‡å‘å…³é”®å­—å…·ä½“ä¿¡æ¯çš„æŒ‡é’ˆï¼Œåªæ˜¯ä½œä¸ºç´¢å¼•ä½¿ç”¨ï¼Œå…¶å†…éƒ¨ç»“ç‚¹æ¯”Bæ ‘å°ï¼Œç›˜å—èƒ½å®¹çº³çš„ç»“ç‚¹ä¸­å…³é”®å­—æ•°é‡æ›´å¤šï¼Œä¸€æ¬¡æ€§è¯»å…¥å†…å­˜ä¸­å¯ä»¥æŸ¥æ‰¾çš„å…³é”®å­—ä¹Ÿå°±è¶Šå¤šï¼Œç›¸å¯¹çš„ï¼ŒIOè¯»å†™æ¬¡æ•°ä¹Ÿå°±é™ä½äº†ã€‚è€ŒIOè¯»å†™æ¬¡æ•°æ˜¯å½±å“ç´¢å¼•æ£€ç´¢æ•ˆç‡çš„æœ€å¤§å› ç´ ï¼› B+æ ‘çš„æŸ¥è¯¢æ•ˆç‡æ›´åŠ ç¨³å®šã€‚Bæ ‘æœç´¢æœ‰å¯èƒ½ä¼šåœ¨éå¶å­ç»“ç‚¹ç»“æŸï¼Œè¶Šé è¿‘æ ¹èŠ‚ç‚¹çš„è®°å½•æŸ¥æ‰¾æ—¶é—´è¶ŠçŸ­ï¼Œåªè¦æ‰¾åˆ°å…³é”®å­—å³å¯ç¡®å®šè®°å½•çš„å­˜åœ¨ï¼Œå…¶æ€§èƒ½ç­‰ä»·äºåœ¨å…³é”®å­—å…¨é›†å†…åšä¸€æ¬¡äºŒåˆ†æŸ¥æ‰¾ã€‚è€Œåœ¨B+æ ‘ä¸­ï¼Œé¡ºåºæ£€ç´¢æ¯”è¾ƒæ˜æ˜¾ï¼Œéšæœºæ£€ç´¢æ—¶ï¼Œä»»ä½•å…³é”®å­—çš„æŸ¥æ‰¾éƒ½å¿…é¡»èµ°ä¸€æ¡ä»æ ¹èŠ‚ç‚¹åˆ°å¶èŠ‚ç‚¹çš„è·¯ï¼Œæ‰€æœ‰å…³é”®å­—çš„æŸ¥æ‰¾è·¯å¾„é•¿åº¦ç›¸åŒï¼Œå¯¼è‡´æ¯ä¸€ä¸ªå…³é”®å­—çš„æŸ¥è¯¢æ•ˆç‡ç›¸å½“ã€‚ B-æ ‘åœ¨æé«˜äº†ç£ç›˜IOæ€§èƒ½çš„åŒæ—¶å¹¶æ²¡æœ‰è§£å†³å…ƒç´ éå†çš„æ•ˆç‡ä½ä¸‹çš„é—®é¢˜ã€‚B+æ ‘çš„å¶å­èŠ‚ç‚¹ä½¿ç”¨æŒ‡é’ˆé¡ºåºè¿æ¥åœ¨ä¸€èµ·ï¼Œåªè¦éå†å¶å­èŠ‚ç‚¹å°±å¯ä»¥å®ç°æ•´æ£µæ ‘çš„éå†ã€‚è€Œä¸”åœ¨æ•°æ®åº“ä¸­åŸºäºèŒƒå›´çš„æŸ¥è¯¢æ˜¯éå¸¸é¢‘ç¹çš„ï¼Œè€ŒBæ ‘ä¸æ”¯æŒè¿™æ ·çš„æ“ä½œã€‚ å¢åˆ æ–‡ä»¶ï¼ˆèŠ‚ç‚¹ï¼‰æ—¶ï¼Œæ•ˆç‡æ›´é«˜ã€‚å› ä¸ºB+æ ‘çš„å¶å­èŠ‚ç‚¹åŒ…å«æ‰€æœ‰å…³é”®å­—ï¼Œå¹¶ä»¥æœ‰åºçš„é“¾è¡¨ç»“æ„å­˜å‚¨ï¼Œè¿™æ ·å¯å¾ˆå¥½æé«˜å¢åˆ æ•ˆç‡ã€‚ B+æ ‘åœ¨æ»¡è¶³èšç°‡ç´¢å¼•å’Œè¦†ç›–ç´¢å¼•çš„æ—¶å€™ä¸éœ€è¦å›è¡¨æŸ¥è¯¢æ•°æ® åœ¨B+æ ‘çš„ç´¢å¼•ä¸­ï¼Œå¶å­èŠ‚ç‚¹å¯èƒ½å­˜å‚¨äº†å½“å‰çš„keyå€¼ï¼Œä¹Ÿå¯èƒ½å­˜å‚¨äº†å½“å‰çš„keyå€¼ä»¥åŠæ•´è¡Œçš„æ•°æ®ï¼Œè¿™å°±æ˜¯èšç°‡ç´¢å¼•å’Œéèšç°‡ç´¢å¼•ã€‚ åœ¨InnoDBä¸­ï¼Œåªæœ‰ä¸»é”®ç´¢å¼•æ˜¯èšç°‡ç´¢å¼•ï¼Œå¦‚æœæ²¡æœ‰ä¸»é”®ï¼Œåˆ™æŒ‘é€‰ä¸€ä¸ªå”¯ä¸€é”®å»ºç«‹èšç°‡ç´¢å¼•ã€‚å¦‚æœæ²¡æœ‰å”¯ä¸€é”®ï¼Œåˆ™éšå¼çš„ç”Ÿæˆä¸€ä¸ªé”®æ¥å»ºç«‹èšç°‡ç´¢å¼•ã€‚ å½“æŸ¥è¯¢ä½¿ç”¨èšç°‡ç´¢å¼•æ—¶ï¼Œåœ¨å¯¹åº”çš„å¶å­èŠ‚ç‚¹ï¼Œå¯ä»¥è·å–åˆ°æ•´è¡Œæ•°æ®ï¼Œå› æ­¤ä¸ç”¨å†æ¬¡è¿›è¡Œå›è¡¨æŸ¥è¯¢ã€‚ ä»€ä¹ˆæ˜¯èšç°‡ç´¢å¼•ï¼Ÿä½•æ—¶ä½¿ç”¨èšç°‡ç´¢å¼•ä¸éèšç°‡ç´¢å¼• èšç°‡ç´¢å¼•ï¼šå°†æ•°æ®å­˜å‚¨ä¸ç´¢å¼•æ”¾åˆ°äº†ä¸€å—ï¼Œæ‰¾åˆ°ç´¢å¼•ä¹Ÿå°±æ‰¾åˆ°äº†æ•°æ® éèšç°‡ç´¢å¼•ï¼šå°†æ•°æ®å­˜å‚¨äºç´¢å¼•åˆ†å¼€ç»“æ„ï¼Œç´¢å¼•ç»“æ„çš„å¶å­èŠ‚ç‚¹æŒ‡å‘äº†æ•°æ®çš„å¯¹åº”è¡Œï¼Œmyisamé€šè¿‡key_bufferæŠŠç´¢å¼•å…ˆç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œå½“éœ€è¦è®¿é—®æ•°æ®æ—¶ï¼ˆé€šè¿‡ç´¢å¼•è®¿é—®æ•°æ®ï¼‰ï¼Œåœ¨å†…å­˜ä¸­ç›´æ¥æœç´¢ç´¢å¼•ï¼Œç„¶åé€šè¿‡ç´¢å¼•æ‰¾åˆ°ç£ç›˜ç›¸åº”æ•°æ®ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆç´¢å¼•ä¸åœ¨key bufferå‘½ä¸­æ—¶ï¼Œé€Ÿåº¦æ…¢çš„åŸå›  æ¾„æ¸…ä¸€ä¸ªæ¦‚å¿µï¼šinnodbä¸­ï¼Œåœ¨èšç°‡ç´¢å¼•ä¹‹ä¸Šåˆ›å»ºçš„ç´¢å¼•ç§°ä¹‹ä¸ºè¾…åŠ©ç´¢å¼•ï¼Œè¾…åŠ©ç´¢å¼•è®¿é—®æ•°æ®æ€»æ˜¯éœ€è¦äºŒæ¬¡æŸ¥æ‰¾ï¼Œéèšç°‡ç´¢å¼•éƒ½æ˜¯è¾…åŠ©ç´¢å¼•ï¼Œåƒå¤åˆç´¢å¼•ã€å‰ç¼€ç´¢å¼•ã€å”¯ä¸€ç´¢å¼•ï¼Œè¾…åŠ©ç´¢å¼•å¶å­èŠ‚ç‚¹å­˜å‚¨çš„ä¸å†æ˜¯è¡Œçš„ç‰©ç†ä½ç½®ï¼Œè€Œæ˜¯ä¸»é”®å€¼ ä½•æ—¶ä½¿ç”¨èšç°‡ç´¢å¼•ä¸éèšç°‡ç´¢å¼• éèšç°‡ç´¢å¼•ä¸€å®šä¼šå›è¡¨æŸ¥è¯¢å—ï¼Ÿ ä¸ä¸€å®šï¼Œè¿™æ¶‰åŠåˆ°æŸ¥è¯¢è¯­å¥æ‰€è¦æ±‚çš„å­—æ®µæ˜¯å¦å…¨éƒ¨å‘½ä¸­äº†ç´¢å¼•ï¼Œå¦‚æœå…¨éƒ¨å‘½ä¸­äº†ç´¢å¼•ï¼Œé‚£ä¹ˆå°±ä¸å¿…å†è¿›è¡Œå›è¡¨æŸ¥è¯¢ã€‚ ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬åœ¨å‘˜å·¥è¡¨çš„å¹´é¾„ä¸Šå»ºç«‹äº†ç´¢å¼•ï¼Œé‚£ä¹ˆå½“è¿›è¡Œselect age from employee where age &lt; 20çš„æŸ¥è¯¢æ—¶ï¼Œåœ¨ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¸Šï¼Œå·²ç»åŒ…å«äº†ageä¿¡æ¯ï¼Œä¸ä¼šå†æ¬¡è¿›è¡Œå›è¡¨æŸ¥è¯¢ã€‚ è”åˆç´¢å¼• MySQLå¯ä»¥ä½¿ç”¨å¤šä¸ªå­—æ®µåŒæ—¶å»ºç«‹ä¸€ä¸ªç´¢å¼•ï¼Œå«åšè”åˆç´¢å¼•ã€‚ åœ¨è”åˆç´¢å¼•ä¸­ï¼Œå¦‚æœæƒ³è¦å‘½ä¸­ç´¢å¼•ï¼Œéœ€è¦æŒ‰ç…§å»ºç«‹ç´¢å¼•æ—¶çš„å­—æ®µé¡ºåºæŒ¨ä¸ªä½¿ç”¨ï¼Œå¦åˆ™æ— æ³•å‘½ä¸­ç´¢å¼•ã€‚ å…·ä½“åŸå› ä¸º: MySQLä½¿ç”¨ç´¢å¼•æ—¶éœ€è¦ç´¢å¼•æœ‰åºï¼Œå‡è®¾ç°åœ¨å»ºç«‹äº†&quot;nameï¼Œageï¼Œschool&quot;çš„è”åˆç´¢å¼•ï¼Œé‚£ä¹ˆç´¢å¼•çš„æ’åºä¸º: å…ˆæŒ‰ç…§nameæ’åºï¼Œå¦‚æœnameç›¸åŒï¼Œåˆ™æŒ‰ç…§ageæ’åºï¼Œå¦‚æœageçš„å€¼ä¹Ÿç›¸ç­‰ï¼Œåˆ™æŒ‰ç…§schoolè¿›è¡Œæ’åºã€‚ å½“è¿›è¡ŒæŸ¥è¯¢æ—¶ï¼Œæ­¤æ—¶ç´¢å¼•ä»…ä»…æŒ‰ç…§nameä¸¥æ ¼æœ‰åºï¼Œå› æ­¤å¿…é¡»é¦–å…ˆä½¿ç”¨nameå­—æ®µè¿›è¡Œç­‰å€¼æŸ¥è¯¢ï¼Œä¹‹åå¯¹äºåŒ¹é…åˆ°çš„åˆ—è€Œè¨€ï¼Œå…¶æŒ‰ç…§ageå­—æ®µä¸¥æ ¼æœ‰åºï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨ageå­—æ®µç”¨åšç´¢å¼•æŸ¥æ‰¾ï¼Œä»¥æ­¤ç±»æ¨ã€‚å› æ­¤åœ¨å»ºç«‹è”åˆç´¢å¼•çš„æ—¶å€™åº”è¯¥æ³¨æ„ç´¢å¼•åˆ—çš„é¡ºåºï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå°†æŸ¥è¯¢éœ€æ±‚é¢‘ç¹æˆ–è€…å­—æ®µé€‰æ‹©æ€§é«˜çš„åˆ—æ”¾åœ¨å‰é¢ã€‚æ­¤å¤–å¯ä»¥æ ¹æ®ç‰¹ä¾‹çš„æŸ¥è¯¢æˆ–è€…è¡¨ç»“æ„è¿›è¡Œå•ç‹¬çš„è°ƒæ•´ã€‚ æ¼«ç”»ï¼šä»€ä¹ˆæ˜¯B-æ ‘ï¼Ÿhttps://tinaxiawuhao.github.io/post/LhRxiTagh/ æ¼«ç”»ï¼šä»€ä¹ˆæ˜¯B+æ ‘ï¼Ÿhttps://tinaxiawuhao.github.io/post/jVTlR3ljT/ ","link":"https://tianxiawuhao.github.io/QzFPAEzVT/"},{"title":"mysqlæ¦‚è¿°ä¸€","content":"ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æ•°æ®åº“ æ•°æ®ä¿å­˜åœ¨å†…å­˜ ä¼˜ç‚¹ï¼š å­˜å–é€Ÿåº¦å¿« ç¼ºç‚¹ï¼š æ•°æ®ä¸èƒ½æ°¸ä¹…ä¿å­˜ æ•°æ®ä¿å­˜åœ¨æ–‡ä»¶ ä¼˜ç‚¹ï¼š æ•°æ®æ°¸ä¹…ä¿å­˜ ç¼ºç‚¹ï¼š1ï¼‰é€Ÿåº¦æ¯”å†…å­˜æ“ä½œæ…¢ï¼Œé¢‘ç¹çš„IOæ“ä½œã€‚ â€‹ 2ï¼‰æŸ¥è¯¢æ•°æ®ä¸æ–¹ä¾¿ æ•°æ®ä¿å­˜åœ¨æ•°æ®åº“ 1ï¼‰æ•°æ®æ°¸ä¹…ä¿å­˜ 2ï¼‰ä½¿ç”¨SQLè¯­å¥ï¼ŒæŸ¥è¯¢æ–¹ä¾¿æ•ˆç‡é«˜ã€‚ 3ï¼‰ç®¡ç†æ•°æ®æ–¹ä¾¿ SQL ç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€(Structured Query Language)ç®€ç§°SQLï¼Œæ˜¯ä¸€ç§æ•°æ®åº“æŸ¥è¯¢è¯­è¨€ã€‚ ä½œç”¨ï¼šç”¨äºå­˜å–æ•°æ®ã€æŸ¥è¯¢ã€æ›´æ–°å’Œç®¡ç†å…³ç³»æ•°æ®åº“ç³»ç»Ÿã€‚ MySQL MySQLæ˜¯ä¸€ä¸ªå…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼Œç”±ç‘å…¸MySQL AB å…¬å¸å¼€å‘ï¼Œå±äº Oracle æ——ä¸‹äº§å“ã€‚MySQL æ˜¯æœ€æµè¡Œçš„å…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿä¹‹ä¸€ï¼Œåœ¨ WEB åº”ç”¨æ–¹é¢ï¼ŒMySQLæ˜¯æœ€å¥½çš„ RDBMS (Relational Database Management Systemï¼Œå…³ç³»æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ) åº”ç”¨è½¯ä»¶ä¹‹ä¸€ã€‚åœ¨Javaä¼ä¸šçº§å¼€å‘ä¸­éå¸¸å¸¸ç”¨ï¼Œå› ä¸º MySQL æ˜¯å¼€æºå…è´¹çš„ï¼Œå¹¶ä¸”æ–¹ä¾¿æ‰©å±•ã€‚ æ•°æ®åº“ä¸‰å¤§èŒƒå¼æ˜¯ä»€ä¹ˆ ç¬¬ä¸€èŒƒå¼ï¼šæ¯ä¸ªåˆ—éƒ½ä¸å¯ä»¥å†æ‹†åˆ†ã€‚ ç¬¬äºŒèŒƒå¼ï¼šåœ¨ç¬¬ä¸€èŒƒå¼çš„åŸºç¡€ä¸Šï¼Œéä¸»é”®åˆ—å®Œå…¨ä¾èµ–äºä¸»é”®ï¼Œè€Œä¸èƒ½æ˜¯ä¾èµ–äºä¸»é”®çš„ä¸€éƒ¨åˆ†ã€‚ ç¬¬ä¸‰èŒƒå¼ï¼šåœ¨ç¬¬äºŒèŒƒå¼çš„åŸºç¡€ä¸Šï¼Œéä¸»é”®åˆ—åªä¾èµ–äºä¸»é”®ï¼Œä¸ä¾èµ–äºå…¶ä»–éä¸»é”®ã€‚ åœ¨è®¾è®¡æ•°æ®åº“ç»“æ„çš„æ—¶å€™ï¼Œè¦å°½é‡éµå®ˆä¸‰èŒƒå¼ï¼Œå¦‚æœä¸éµå®ˆï¼Œå¿…é¡»æœ‰è¶³å¤Ÿçš„ç†ç”±ã€‚æ¯”å¦‚æ€§èƒ½ã€‚äº‹å®ä¸Šæˆ‘ä»¬ç»å¸¸ä¼šä¸ºäº†æ€§èƒ½è€Œå¦¥åæ•°æ®åº“çš„è®¾è®¡ã€‚ mysqlæœ‰å…³æƒé™çš„è¡¨ MySQLæœåŠ¡å™¨é€šè¿‡æƒé™è¡¨æ¥æ§åˆ¶ç”¨æˆ·å¯¹æ•°æ®åº“çš„è®¿é—®ï¼Œæƒé™è¡¨å­˜æ”¾åœ¨mysqlæ•°æ®åº“é‡Œï¼Œç”±mysql_install_dbè„šæœ¬åˆå§‹åŒ–ã€‚è¿™äº›æƒé™è¡¨åˆ†åˆ«userï¼Œdbï¼Œtable_privï¼Œcolumns_privå’Œhostã€‚ä¸‹é¢åˆ†åˆ«ä»‹ç»ä¸€ä¸‹è¿™äº›è¡¨çš„ç»“æ„å’Œå†…å®¹ï¼š useræƒé™è¡¨ï¼šè®°å½•å…è®¸è¿æ¥åˆ°æœåŠ¡å™¨çš„ç”¨æˆ·å¸å·ä¿¡æ¯ï¼Œé‡Œé¢çš„æƒé™æ˜¯å…¨å±€çº§çš„ã€‚ dbæƒé™è¡¨ï¼šè®°å½•å„ä¸ªå¸å·åœ¨å„ä¸ªæ•°æ®åº“ä¸Šçš„æ“ä½œæƒé™ã€‚ table_privæƒé™è¡¨ï¼šè®°å½•æ•°æ®è¡¨çº§çš„æ“ä½œæƒé™ã€‚ columns_privæƒé™è¡¨ï¼šè®°å½•æ•°æ®åˆ—çº§çš„æ“ä½œæƒé™ã€‚ hostæƒé™è¡¨ï¼šé…åˆdbæƒé™è¡¨å¯¹ç»™å®šä¸»æœºä¸Šæ•°æ®åº“çº§æ“ä½œæƒé™ä½œæ›´ç»†è‡´çš„æ§åˆ¶ã€‚è¿™ä¸ªæƒé™è¡¨ä¸å—GRANTå’ŒREVOKEè¯­å¥çš„å½±å“ã€‚ MySQLçš„binlogæœ‰å‡ ç§å½•å…¥æ ¼å¼ï¼Ÿåˆ†åˆ«æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ æœ‰ä¸‰ç§æ ¼å¼ï¼Œstatementï¼Œrowå’Œmixedã€‚ statementæ¨¡å¼ä¸‹ï¼Œæ¯ä¸€æ¡ä¼šä¿®æ”¹æ•°æ®çš„sqléƒ½ä¼šè®°å½•åœ¨binlogä¸­ã€‚ä¸éœ€è¦è®°å½•æ¯ä¸€è¡Œçš„å˜åŒ–ï¼Œå‡å°‘äº†binlogæ—¥å¿—é‡ï¼ŒèŠ‚çº¦äº†IOï¼Œæé«˜æ€§èƒ½ã€‚ç”±äºsqlçš„æ‰§è¡Œæ˜¯æœ‰ä¸Šä¸‹æ–‡çš„ï¼Œå› æ­¤åœ¨ä¿å­˜çš„æ—¶å€™éœ€è¦ä¿å­˜ç›¸å…³çš„ä¿¡æ¯ï¼ŒåŒæ—¶è¿˜æœ‰ä¸€äº›ä½¿ç”¨äº†å‡½æ•°ä¹‹ç±»çš„è¯­å¥æ— æ³•è¢«è®°å½•å¤åˆ¶ã€‚ rowçº§åˆ«ä¸‹ï¼Œä¸è®°å½•sqlè¯­å¥ä¸Šä¸‹æ–‡ç›¸å…³ä¿¡æ¯ï¼Œä»…ä¿å­˜å“ªæ¡è®°å½•è¢«ä¿®æ”¹ã€‚è®°å½•å•å…ƒä¸ºæ¯ä¸€è¡Œçš„æ”¹åŠ¨ï¼ŒåŸºæœ¬æ˜¯å¯ä»¥å…¨éƒ¨è®°ä¸‹æ¥ä½†æ˜¯ç”±äºå¾ˆå¤šæ“ä½œï¼Œä¼šå¯¼è‡´å¤§é‡è¡Œçš„æ”¹åŠ¨(æ¯”å¦‚alter table)ï¼Œå› æ­¤è¿™ç§æ¨¡å¼çš„æ–‡ä»¶ä¿å­˜çš„ä¿¡æ¯å¤ªå¤šï¼Œæ—¥å¿—é‡å¤ªå¤§ã€‚ mixedï¼Œä¸€ç§æŠ˜ä¸­çš„æ–¹æ¡ˆï¼Œæ™®é€šæ“ä½œä½¿ç”¨statementè®°å½•ï¼Œå½“æ— æ³•ä½¿ç”¨statementçš„æ—¶å€™ä½¿ç”¨rowã€‚ æ­¤å¤–ï¼Œæ–°ç‰ˆçš„MySQLä¸­å¯¹rowçº§åˆ«ä¹Ÿåšäº†ä¸€äº›ä¼˜åŒ–ï¼Œå½“è¡¨ç»“æ„å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œä¼šè®°å½•è¯­å¥è€Œä¸æ˜¯é€è¡Œè®°å½•ã€‚ æ•°æ®ç±»å‹ åˆ†ç±» ç±»å‹åç§° è¯´æ˜ æ•´æ•°ç±»å‹ tinyInt å¾ˆå°çš„æ•´æ•°(8ä½äºŒè¿›åˆ¶) smallint å°çš„æ•´æ•°(16ä½äºŒè¿›åˆ¶) mediumint ä¸­ç­‰å¤§å°çš„æ•´æ•°(24ä½äºŒè¿›åˆ¶) int(integer) æ™®é€šå¤§å°çš„æ•´æ•°(32ä½äºŒè¿›åˆ¶) å°æ•°ç±»å‹ float å•ç²¾åº¦æµ®ç‚¹æ•° double åŒç²¾åº¦æµ®ç‚¹æ•° decimal(m,d) å‹ç¼©ä¸¥æ ¼çš„å®šç‚¹æ•° æ—¥æœŸç±»å‹ year YYYY 1901~2155 time HH:MM:SS -838:59:59~838:59:59 date YYYY-MM-DD 1000-01-01~9999-12-3 datetime YYYY-MM-DD HH:MM:SS 1000-01-01 00:00:00~ 9999-12-31 23:59:59 timestamp YYYY-MM-DD HH:MM:SS 19700101 00:00:01 UTC~2038-01-19 03:14:07UTC æ–‡æœ¬ã€äºŒè¿›åˆ¶ç±»å‹ CHAR(M) Mä¸º0~255ä¹‹é—´çš„æ•´æ•° VARCHAR(M) Mä¸º0~65535ä¹‹é—´çš„æ•´æ•° TINYBLOB å…è®¸é•¿åº¦0~255å­—èŠ‚ BLOB å…è®¸é•¿åº¦0~65535å­—èŠ‚ MEDIUMBLOB å…è®¸é•¿åº¦0~167772150å­—èŠ‚ LONGBLOB å…è®¸é•¿åº¦0~4294967295å­—èŠ‚ TINYTEXT å…è®¸é•¿åº¦0~255å­—èŠ‚ TEXT å…è®¸é•¿åº¦0~65535å­—èŠ‚ MEDIUMTEXT å…è®¸é•¿åº¦0~167772150å­—èŠ‚ LONGTEXT å…è®¸é•¿åº¦0~4294967295å­—èŠ‚ VARBINARY(M) å…è®¸é•¿åº¦0~Mä¸ªå­—èŠ‚çš„å˜é•¿å­—èŠ‚å­—ç¬¦ä¸² BINARY(M) å…è®¸é•¿åº¦0~Mä¸ªå­—èŠ‚çš„å®šé•¿å­—èŠ‚å­—ç¬¦ä¸² 1ã€æ•´æ•°ç±»å‹ï¼ŒåŒ…æ‹¬TINYINTã€SMALLINTã€MEDIUMINTã€INTã€BIGINTï¼Œåˆ†åˆ«è¡¨ç¤º1å­—èŠ‚ã€2å­—èŠ‚ã€3å­—èŠ‚ã€4å­—èŠ‚ã€8å­—èŠ‚æ•´æ•°ã€‚ä»»ä½•æ•´æ•°ç±»å‹éƒ½å¯ä»¥åŠ ä¸ŠUNSIGNEDå±æ€§ï¼Œè¡¨ç¤ºæ•°æ®æ˜¯æ— ç¬¦å·çš„ï¼Œå³éè´Ÿæ•´æ•°ã€‚ é•¿åº¦ï¼šæ•´æ•°ç±»å‹å¯ä»¥è¢«æŒ‡å®šé•¿åº¦ï¼Œä¾‹å¦‚ï¼šINT(11)è¡¨ç¤ºé•¿åº¦ä¸º11çš„INTç±»å‹ã€‚é•¿åº¦åœ¨å¤§å¤šæ•°åœºæ™¯æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œå®ƒä¸ä¼šé™åˆ¶å€¼çš„åˆæ³•èŒƒå›´ï¼Œåªä¼šå½±å“æ˜¾ç¤ºå­—ç¬¦çš„ä¸ªæ•°ï¼Œè€Œä¸”éœ€è¦å’ŒUNSIGNED ZEROFILLå±æ€§é…åˆä½¿ç”¨æ‰æœ‰æ„ä¹‰ã€‚ ä¾‹å­ï¼Œå‡å®šç±»å‹è®¾å®šä¸ºINT(5)ï¼Œå±æ€§ä¸ºUNSIGNED ZEROFILLï¼Œå¦‚æœç”¨æˆ·æ’å…¥çš„æ•°æ®ä¸º12çš„è¯ï¼Œé‚£ä¹ˆæ•°æ®åº“å®é™…å­˜å‚¨æ•°æ®ä¸º00012ã€‚ 2ã€å®æ•°ç±»å‹ï¼ŒåŒ…æ‹¬FLOATã€DOUBLEã€DECIMALã€‚ DECIMALå¯ä»¥ç”¨äºå­˜å‚¨æ¯”BIGINTè¿˜å¤§çš„æ•´å‹ï¼Œèƒ½å­˜å‚¨ç²¾ç¡®çš„å°æ•°ã€‚ è€ŒFLOATå’ŒDOUBLEæ˜¯æœ‰å–å€¼èŒƒå›´çš„ï¼Œå¹¶æ”¯æŒä½¿ç”¨æ ‡å‡†çš„æµ®ç‚¹è¿›è¡Œè¿‘ä¼¼è®¡ç®—ã€‚ è®¡ç®—æ—¶FLOATå’ŒDOUBLEç›¸æ¯”DECIMALæ•ˆç‡æ›´é«˜ä¸€äº›ï¼ŒDECIMALä½ å¯ä»¥ç†è§£æˆæ˜¯ç”¨å­—ç¬¦ä¸²è¿›è¡Œå¤„ç†ã€‚ 3ã€å­—ç¬¦ä¸²ç±»å‹ï¼ŒåŒ…æ‹¬VARCHARã€CHARã€TEXTã€BLOB VARCHARç”¨äºå­˜å‚¨å¯å˜é•¿å­—ç¬¦ä¸²ï¼Œå®ƒæ¯”å®šé•¿ç±»å‹æ›´èŠ‚çœç©ºé—´ã€‚ VARCHARä½¿ç”¨é¢å¤–1æˆ–2ä¸ªå­—èŠ‚å­˜å‚¨å­—ç¬¦ä¸²é•¿åº¦ã€‚åˆ—é•¿åº¦å°äº255å­—èŠ‚æ—¶ï¼Œä½¿ç”¨1å­—èŠ‚è¡¨ç¤ºï¼Œå¦åˆ™ä½¿ç”¨2å­—èŠ‚è¡¨ç¤ºã€‚ VARCHARå­˜å‚¨çš„å†…å®¹è¶…å‡ºè®¾ç½®çš„é•¿åº¦æ—¶ï¼Œå†…å®¹ä¼šè¢«æˆªæ–­ã€‚ CHARæ˜¯å®šé•¿çš„ï¼Œæ ¹æ®å®šä¹‰çš„å­—ç¬¦ä¸²é•¿åº¦åˆ†é…è¶³å¤Ÿçš„ç©ºé—´ã€‚ CHARä¼šæ ¹æ®éœ€è¦ä½¿ç”¨ç©ºæ ¼è¿›è¡Œå¡«å……æ–¹ä¾¿æ¯”è¾ƒã€‚ CHARé€‚åˆå­˜å‚¨å¾ˆçŸ­çš„å­—ç¬¦ä¸²ï¼Œæˆ–è€…æ‰€æœ‰å€¼éƒ½æ¥è¿‘åŒä¸€ä¸ªé•¿åº¦ã€‚ CHARå­˜å‚¨çš„å†…å®¹è¶…å‡ºè®¾ç½®çš„é•¿åº¦æ—¶ï¼Œå†…å®¹åŒæ ·ä¼šè¢«æˆªæ–­ã€‚ ä½¿ç”¨ç­–ç•¥ï¼š å¯¹äºç»å¸¸å˜æ›´çš„æ•°æ®æ¥è¯´ï¼ŒCHARæ¯”VARCHARæ›´å¥½ï¼Œå› ä¸ºCHARä¸å®¹æ˜“äº§ç”Ÿç¢ç‰‡ã€‚ å¯¹äºéå¸¸çŸ­çš„åˆ—ï¼ŒCHARæ¯”VARCHARåœ¨å­˜å‚¨ç©ºé—´ä¸Šæ›´æœ‰æ•ˆç‡ã€‚ ä½¿ç”¨æ—¶è¦æ³¨æ„åªåˆ†é…éœ€è¦çš„ç©ºé—´ï¼Œæ›´é•¿çš„åˆ—æ’åºæ—¶ä¼šæ¶ˆè€—æ›´å¤šå†…å­˜ã€‚ å°½é‡é¿å…ä½¿ç”¨TEXT/BLOBç±»å‹ï¼ŒæŸ¥è¯¢æ—¶ä¼šä½¿ç”¨ä¸´æ—¶è¡¨ï¼Œå¯¼è‡´ä¸¥é‡çš„æ€§èƒ½å¼€é”€ã€‚ 4ã€æšä¸¾ç±»å‹ï¼ˆENUMï¼‰ï¼ŒæŠŠä¸é‡å¤çš„æ•°æ®å­˜å‚¨ä¸ºä¸€ä¸ªé¢„å®šä¹‰çš„é›†åˆã€‚ æœ‰æ—¶å¯ä»¥ä½¿ç”¨ENUMä»£æ›¿å¸¸ç”¨çš„å­—ç¬¦ä¸²ç±»å‹ã€‚ ENUMå­˜å‚¨éå¸¸ç´§å‡‘ï¼Œä¼šæŠŠåˆ—è¡¨å€¼å‹ç¼©åˆ°ä¸€ä¸ªæˆ–ä¸¤ä¸ªå­—èŠ‚ã€‚ ENUMåœ¨å†…éƒ¨å­˜å‚¨æ—¶ï¼Œå…¶å®å­˜çš„æ˜¯æ•´æ•°ã€‚ å°½é‡é¿å…ä½¿ç”¨æ•°å­—ä½œä¸ºENUMæšä¸¾çš„å¸¸é‡ï¼Œå› ä¸ºå®¹æ˜“æ··ä¹±ã€‚ æ’åºæ˜¯æŒ‰ç…§å†…éƒ¨å­˜å‚¨çš„æ•´æ•° 5ã€æ—¥æœŸå’Œæ—¶é—´ç±»å‹ï¼Œå°½é‡ä½¿ç”¨timestampï¼Œç©ºé—´æ•ˆç‡é«˜äºdatetimeï¼Œ ç”¨æ•´æ•°ä¿å­˜æ—¶é—´æˆ³é€šå¸¸ä¸æ–¹ä¾¿å¤„ç†ã€‚ å¦‚æœéœ€è¦å­˜å‚¨å¾®å¦™ï¼Œå¯ä»¥ä½¿ç”¨bigintå­˜å‚¨ã€‚ MySQLå­˜å‚¨å¼•æ“ å­˜å‚¨å¼•æ“Storage engineï¼šMySQLä¸­çš„æ•°æ®ã€ç´¢å¼•ä»¥åŠå…¶ä»–å¯¹è±¡æ˜¯å¦‚ä½•å­˜å‚¨çš„ï¼Œæ˜¯ä¸€å¥—æ–‡ä»¶ç³»ç»Ÿçš„å®ç°ã€‚ å¸¸ç”¨çš„å­˜å‚¨å¼•æ“æœ‰ä»¥ä¸‹ï¼š Innodbå¼•æ“ï¼šInnodbå¼•æ“æä¾›äº†å¯¹æ•°æ®åº“ACIDäº‹åŠ¡çš„æ”¯æŒã€‚å¹¶ä¸”è¿˜æä¾›äº†è¡Œçº§é”å’Œå¤–é”®çš„çº¦æŸã€‚å®ƒçš„è®¾è®¡çš„ç›®æ ‡å°±æ˜¯å¤„ç†å¤§æ•°æ®å®¹é‡çš„æ•°æ®åº“ç³»ç»Ÿã€‚ MyIASMå¼•æ“(åŸæœ¬Mysqlçš„é»˜è®¤å¼•æ“)ï¼šä¸æä¾›äº‹åŠ¡çš„æ”¯æŒï¼Œä¹Ÿä¸æ”¯æŒè¡Œçº§é”å’Œå¤–é”®ã€‚ MEMORYå¼•æ“ï¼šæ‰€æœ‰çš„æ•°æ®éƒ½åœ¨å†…å­˜ä¸­ï¼Œæ•°æ®çš„å¤„ç†é€Ÿåº¦å¿«ï¼Œä½†æ˜¯å®‰å…¨æ€§ä¸é«˜ã€‚ MyISAMä¸InnoDBåŒºåˆ« MyISAM Innodb å­˜å‚¨ç»“æ„ æ¯å¼ è¡¨è¢«å­˜æ”¾åœ¨ä¸‰ä¸ªæ–‡ä»¶ï¼šfrm-è¡¨æ ¼å®šä¹‰ã€MYD(MYData)-æ•°æ®æ–‡ä»¶ã€MYI(MYIndex)-ç´¢å¼•æ–‡ä»¶ æ‰€æœ‰çš„è¡¨éƒ½ä¿å­˜åœ¨åŒä¸€ä¸ªæ•°æ®æ–‡ä»¶ä¸­ï¼ˆä¹Ÿå¯èƒ½æ˜¯å¤šä¸ªæ–‡ä»¶ï¼Œæˆ–è€…æ˜¯ç‹¬ç«‹çš„è¡¨ç©ºé—´æ–‡ä»¶ï¼‰ï¼ŒInnoDBè¡¨çš„å¤§å°åªå—é™äºæ“ä½œç³»ç»Ÿæ–‡ä»¶çš„å¤§å°ï¼Œä¸€èˆ¬ä¸º2GB å­˜å‚¨ç©ºé—´ MyISAMå¯è¢«å‹ç¼©ï¼Œå­˜å‚¨ç©ºé—´è¾ƒå° InnoDBçš„è¡¨éœ€è¦æ›´å¤šçš„å†…å­˜å’Œå­˜å‚¨ï¼Œå®ƒä¼šåœ¨ä¸»å†…å­˜ä¸­å»ºç«‹å…¶ä¸“ç”¨çš„ç¼“å†²æ± ç”¨äºé«˜é€Ÿç¼“å†²æ•°æ®å’Œç´¢å¼• å¯ç§»æ¤æ€§ã€å¤‡ä»½åŠæ¢å¤ ç”±äºMyISAMçš„æ•°æ®æ˜¯ä»¥æ–‡ä»¶çš„å½¢å¼å­˜å‚¨ï¼Œæ‰€ä»¥åœ¨è·¨å¹³å°çš„æ•°æ®è½¬ç§»ä¸­ä¼šå¾ˆæ–¹ä¾¿ã€‚åœ¨å¤‡ä»½å’Œæ¢å¤æ—¶å¯å•ç‹¬é’ˆå¯¹æŸä¸ªè¡¨è¿›è¡Œæ“ä½œ å…è´¹çš„æ–¹æ¡ˆå¯ä»¥æ˜¯æ‹·è´æ•°æ®æ–‡ä»¶ã€å¤‡ä»½ binlogï¼Œæˆ–è€…ç”¨ mysqldumpï¼Œåœ¨æ•°æ®é‡è¾¾åˆ°å‡ åGçš„æ—¶å€™å°±ç›¸å¯¹ç—›è‹¦äº† æ–‡ä»¶æ ¼å¼ æ•°æ®å’Œç´¢å¼•æ˜¯åˆ†åˆ«å­˜å‚¨çš„ï¼Œæ•°æ®.MYDï¼Œç´¢å¼•.MYI æ•°æ®å’Œç´¢å¼•æ˜¯é›†ä¸­å­˜å‚¨çš„ï¼Œ.ibd è®°å½•å­˜å‚¨é¡ºåº æŒ‰è®°å½•æ’å…¥é¡ºåºä¿å­˜ æŒ‰ä¸»é”®å¤§å°æœ‰åºæ’å…¥ å¤–é”® ä¸æ”¯æŒ æ”¯æŒ äº‹åŠ¡ ä¸æ”¯æŒ æ”¯æŒ é”æ”¯æŒï¼ˆé”æ˜¯é¿å…èµ„æºäº‰ç”¨çš„ä¸€ä¸ªæœºåˆ¶ï¼ŒMySQLé”å¯¹ç”¨æˆ·å‡ ä¹æ˜¯é€æ˜çš„ï¼‰ è¡¨çº§é”å®š è¡Œçº§é”å®šã€è¡¨çº§é”å®šï¼Œé”å®šåŠ›åº¦å°å¹¶å‘èƒ½åŠ›é«˜ SELECT MyISAMæ›´ä¼˜ INSERTã€UPDATEã€DELETE InnoDBæ›´ä¼˜ select count(*) myisamæ›´å¿«ï¼Œå› ä¸ºmyisamå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå¯ä»¥ç›´æ¥è°ƒå–ã€‚ ç´¢å¼•çš„å®ç°æ–¹å¼ B+æ ‘ç´¢å¼•ï¼Œmyisam æ˜¯å †è¡¨ B+æ ‘ç´¢å¼•ï¼ŒInnodb æ˜¯ç´¢å¼•ç»„ç»‡è¡¨ å“ˆå¸Œç´¢å¼• ä¸æ”¯æŒ æ”¯æŒ å…¨æ–‡ç´¢å¼• æ”¯æŒ ä¸æ”¯æŒ MyISAMç´¢å¼•ä¸InnoDBç´¢å¼•çš„åŒºåˆ«ï¼Ÿ InnoDBç´¢å¼•æ˜¯èšç°‡ç´¢å¼•ï¼ŒMyISAMç´¢å¼•æ˜¯éèšç°‡ç´¢å¼•ã€‚ InnoDBçš„ä¸»é”®ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜å‚¨ç€è¡Œæ•°æ®ï¼Œå› æ­¤ä¸»é”®ç´¢å¼•éå¸¸é«˜æ•ˆã€‚ MyISAMç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯è¡Œæ•°æ®åœ°å€ï¼Œéœ€è¦å†å¯»å€ä¸€æ¬¡æ‰èƒ½å¾—åˆ°æ•°æ®ã€‚ InnoDBéä¸»é”®ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯ä¸»é”®å’Œå…¶ä»–å¸¦ç´¢å¼•çš„åˆ—æ•°æ®ï¼Œå› æ­¤æŸ¥è¯¢æ—¶åšåˆ°è¦†ç›–ç´¢å¼•ä¼šéå¸¸é«˜æ•ˆã€‚ InnoDBå¼•æ“çš„4å¤§ç‰¹æ€§ æ’å…¥ç¼“å†²ï¼ˆInsert Buffer/Change Buffer) æå‡æ’å…¥æ€§èƒ½ï¼Œchange bufferingæ˜¯insert bufferçš„åŠ å¼ºï¼Œinsert bufferåªé’ˆå¯¹insertæœ‰æ•ˆï¼Œchange bufferingå¯¹insertã€deleteã€update(delete+insert)ã€purgeéƒ½æœ‰æ•ˆ åªå¯¹äºéèšé›†ç´¢å¼•ï¼ˆéå”¯ä¸€ï¼‰çš„æ’å…¥å’Œæ›´æ–°æœ‰æ•ˆï¼Œå¯¹äºæ¯ä¸€æ¬¡çš„æ’å…¥ä¸æ˜¯å†™åˆ°ç´¢å¼•é¡µä¸­ï¼Œè€Œæ˜¯å…ˆåˆ¤æ–­æ’å…¥çš„éèšé›†ç´¢å¼•é¡µæ˜¯å¦åœ¨ç¼“å†²æ± ä¸­ï¼Œå¦‚æœåœ¨åˆ™ç›´æ¥æ’å…¥ï¼›è‹¥ä¸åœ¨ï¼Œåˆ™å…ˆæ”¾åˆ°Insert Buffer ä¸­ï¼Œå†æŒ‰ç…§ä¸€å®šçš„é¢‘ç‡è¿›è¡Œåˆå¹¶æ“ä½œï¼Œå†å†™å›diskã€‚è¿™æ ·é€šå¸¸èƒ½å°†å¤šä¸ªæ’å…¥åˆå¹¶åˆ°ä¸€ä¸ªæ“ä½œä¸­ï¼Œç›®çš„è¿˜æ˜¯ä¸ºäº†å‡å°‘éšæœºIOå¸¦æ¥æ€§èƒ½æŸè€—ã€‚ ä½¿ç”¨æ’å…¥ç¼“å†²çš„æ¡ä»¶ï¼š * éèšé›†ç´¢å¼• * éå”¯ä¸€ç´¢å¼• Change bufferæ˜¯ä½œä¸ºbuffer poolä¸­çš„ä¸€éƒ¨åˆ†å­˜åœ¨ã€‚Innodb_change_bufferingå‚æ•°ç¼“å­˜æ‰€å¯¹åº”çš„æ“ä½œï¼š(updateä¼šè¢«è®¤ä¸ºæ˜¯delete+insert) innodb_change_bufferingï¼Œè®¾ç½®çš„å€¼æœ‰ï¼šinsertsã€deletesã€purgesã€changesï¼ˆinsertså’Œdeletesï¼‰ã€allï¼ˆé»˜è®¤ï¼‰ã€noneã€‚ all: é»˜è®¤å€¼ï¼Œç¼“å­˜insert, delete, purgesæ“ä½œ none: ä¸ç¼“å­˜ inserts: ç¼“å­˜insertæ“ä½œ deletes: ç¼“å­˜deleteæ“ä½œ changes: ç¼“å­˜insertå’Œdeleteæ“ä½œ purges: ç¼“å­˜åå°æ‰§è¡Œçš„ç‰©ç†åˆ é™¤æ“ä½œ å¯ä»¥é€šè¿‡å‚æ•°æ§åˆ¶å…¶ä½¿ç”¨çš„å¤§å°ï¼š innodb_change_buffer_max_sizeï¼Œé»˜è®¤æ˜¯25%ï¼Œå³ç¼“å†²æ± çš„1/4ã€‚æœ€å¤§å¯è®¾ç½®ä¸º50%ã€‚å½“MySQLå®ä¾‹ä¸­æœ‰å¤§é‡çš„ä¿®æ”¹æ“ä½œæ—¶ï¼Œè¦è€ƒè™‘å¢å¤§innodb_change_buffer_max_size ä¸Šé¢æè¿‡åœ¨ä¸€å®šé¢‘ç‡ä¸‹è¿›è¡Œåˆå¹¶ï¼Œé‚£æ‰€è°“çš„é¢‘ç‡æ˜¯ä»€ä¹ˆæ¡ä»¶ï¼Ÿ 1ï¼‰è¾…åŠ©ç´¢å¼•é¡µè¢«è¯»å–åˆ°ç¼“å†²æ± ä¸­ã€‚æ­£å¸¸çš„selectå…ˆæ£€æŸ¥Insert Bufferæ˜¯å¦æœ‰è¯¥éèšé›†ç´¢å¼•é¡µå­˜åœ¨ï¼Œè‹¥æœ‰åˆ™åˆå¹¶æ’å…¥ã€‚ 2ï¼‰è¾…åŠ©ç´¢å¼•é¡µæ²¡æœ‰å¯ç”¨ç©ºé—´ã€‚ç©ºé—´å°äº1/32é¡µçš„å¤§å°ï¼Œåˆ™ä¼šå¼ºåˆ¶åˆå¹¶æ“ä½œã€‚ 3ï¼‰Master Thread æ¯ç§’å’Œæ¯10ç§’çš„åˆå¹¶æ“ä½œã€‚ äºŒæ¬¡å†™(double write) Doublewriteç¼“å­˜æ˜¯ä½äºç³»ç»Ÿè¡¨ç©ºé—´çš„å­˜å‚¨åŒºåŸŸï¼Œç”¨æ¥ç¼“å­˜InnoDBçš„æ•°æ®é¡µä»innodb buffer poolä¸­flushä¹‹åå¹¶å†™å…¥åˆ°æ•°æ®æ–‡ä»¶ä¹‹å‰ï¼Œæ‰€ä»¥å½“æ“ä½œç³»ç»Ÿæˆ–è€…æ•°æ®åº“è¿›ç¨‹åœ¨æ•°æ®é¡µå†™ç£ç›˜çš„è¿‡ç¨‹ä¸­å´©æºƒï¼ŒInnodbå¯ä»¥åœ¨doublewriteç¼“å­˜ä¸­æ‰¾åˆ°æ•°æ®é¡µçš„å¤‡ä»½è€Œç”¨æ¥æ‰§è¡Œcrashæ¢å¤ã€‚æ•°æ®é¡µå†™å…¥åˆ°doublewriteç¼“å­˜çš„åŠ¨ä½œæ‰€éœ€è¦çš„IOæ¶ˆè€—è¦å°äºå†™å…¥åˆ°æ•°æ®æ–‡ä»¶çš„æ¶ˆè€—ï¼Œå› ä¸ºæ­¤å†™å…¥æ“ä½œä¼šä»¥ä¸€æ¬¡å¤§çš„è¿ç»­å—çš„æ–¹å¼å†™å…¥ åœ¨åº”ç”¨ï¼ˆapplyï¼‰é‡åšæ—¥å¿—å‰ï¼Œç”¨æˆ·éœ€è¦ä¸€ä¸ªé¡µçš„å‰¯æœ¬ï¼Œå½“å†™å…¥å¤±æ•ˆå‘ç”Ÿæ—¶ï¼Œå…ˆé€šè¿‡é¡µçš„å‰¯æœ¬æ¥è¿˜åŸè¯¥é¡µï¼Œå†è¿›è¡Œé‡åšï¼Œè¿™å°±æ˜¯double write doublewriteç»„æˆï¼š å†…å­˜ä¸­çš„doublewrite buffer,å¤§å°2Mã€‚ ç‰©ç†ç£ç›˜ä¸Šå…±äº«è¡¨ç©ºé—´ä¸­è¿ç»­çš„128ä¸ªé¡µï¼Œå³2ä¸ªåŒºï¼ˆextendï¼‰ï¼Œå¤§å°åŒæ ·ä¸º2Mã€‚ å¯¹ç¼“å†²æ± çš„è„é¡µè¿›è¡Œåˆ·æ–°æ—¶ï¼Œä¸æ˜¯ç›´æ¥å†™ç£ç›˜ï¼Œè€Œæ˜¯ä¼šé€šè¿‡memcpy()å‡½æ•°å°†è„é¡µå…ˆå¤åˆ¶åˆ°å†…å­˜ä¸­çš„doublewrite bufferï¼Œä¹‹åé€šè¿‡doublewrite å†åˆ†ä¸¤æ¬¡ï¼Œæ¯æ¬¡1Mé¡ºåºåœ°å†™å…¥å…±äº«è¡¨ç©ºé—´çš„ç‰©ç†ç£ç›˜ä¸Šï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå› ä¸ºdoublewriteé¡µæ˜¯è¿ç»­çš„ï¼Œå› æ­¤è¿™ä¸ªè¿‡ç¨‹æ˜¯é¡ºåºå†™çš„ï¼Œå¼€é”€å¹¶ä¸æ˜¯å¾ˆå¤§ã€‚åœ¨å®Œæˆdoublewriteé¡µçš„å†™å…¥åï¼Œå†å°†doublewrite buffer ä¸­çš„é¡µå†™å…¥å„ä¸ª è¡¨ç©ºé—´æ–‡ä»¶ä¸­ï¼Œæ­¤æ—¶çš„å†™å…¥åˆ™æ˜¯ç¦»æ•£çš„ã€‚å¦‚æœæ“ä½œç³»ç»Ÿåœ¨å°†é¡µå†™å…¥ç£ç›˜çš„è¿‡ç¨‹ä¸­å‘ç”Ÿäº†å´©æºƒï¼Œåœ¨æ¢å¤è¿‡ç¨‹ä¸­ï¼Œinnodbå¯ä»¥ä»å…±äº«è¡¨ç©ºé—´ä¸­çš„doublewriteä¸­æ‰¾åˆ°è¯¥é¡µçš„ä¸€ä¸ªå‰¯æœ¬ï¼Œå°†å…¶å¤åˆ¶åˆ°è¡¨ç©ºé—´æ–‡ä»¶ï¼Œå†åº”ç”¨é‡åšæ—¥å¿—ã€‚ è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•(ahi) Adaptive Hash indexå±æ€§ä½¿å¾—InnoDBæ›´åƒæ˜¯å†…å­˜æ•°æ®åº“ã€‚è¯¥å±æ€§é€šè¿‡innodb_adapitve_hash_indexå¼€å¯ï¼Œä¹Ÿå¯ä»¥é€šè¿‡â€”skip-innodb_adaptive_hash_indexå‚æ•° Innodbå­˜å‚¨å¼•æ“ä¼šç›‘æ§å¯¹è¡¨ä¸ŠäºŒçº§ç´¢å¼•çš„æŸ¥æ‰¾ï¼Œå¦‚æœå‘ç°æŸäºŒçº§ç´¢å¼•è¢«é¢‘ç¹è®¿é—®ï¼ŒäºŒçº§ç´¢å¼•æˆä¸ºçƒ­æ•°æ®ï¼Œå»ºç«‹å“ˆå¸Œç´¢å¼•å¯ä»¥å¸¦æ¥é€Ÿåº¦çš„æå‡ ç»å¸¸è®¿é—®çš„äºŒçº§ç´¢å¼•æ•°æ®ä¼šè‡ªåŠ¨è¢«ç”Ÿæˆåˆ°hashç´¢å¼•é‡Œé¢å»(æœ€è¿‘è¿ç»­è¢«è®¿é—®ä¸‰æ¬¡çš„æ•°æ®)ï¼Œè‡ªé€‚åº”å“ˆå¸Œç´¢å¼•é€šè¿‡ç¼“å†²æ± çš„B+æ ‘æ„é€ è€Œæ¥ï¼Œå› æ­¤å»ºç«‹çš„é€Ÿåº¦å¾ˆå¿«ã€‚ å“ˆå¸Œï¼ˆhashï¼‰æ˜¯ä¸€ç§éå¸¸å¿«çš„ç­‰å€¼æŸ¥æ‰¾æ–¹æ³•ï¼Œåœ¨ä¸€èˆ¬æƒ…å†µä¸‹è¿™ç§æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(1),å³ä¸€èˆ¬ä»…éœ€è¦ä¸€æ¬¡æŸ¥æ‰¾å°±èƒ½å®šä½æ•°æ®ã€‚è€ŒB+æ ‘çš„æŸ¥æ‰¾æ¬¡æ•°ï¼Œå–å†³äºB+æ ‘çš„é«˜åº¦ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒB+æ ‘çš„é«˜åº¦ä¸€èˆ¬3-4å±‚ï¼Œæ•…éœ€è¦3-4æ¬¡çš„æŸ¥è¯¢ã€‚ innodbä¼šç›‘æ§å¯¹è¡¨ä¸Šä¸ªç´¢å¼•é¡µçš„æŸ¥è¯¢ã€‚å¦‚æœè§‚å¯Ÿåˆ°å»ºç«‹å“ˆå¸Œç´¢å¼•å¯ä»¥å¸¦æ¥é€Ÿåº¦æå‡ï¼Œåˆ™è‡ªåŠ¨å»ºç«‹å“ˆå¸Œç´¢å¼•ï¼Œç§°ä¹‹ä¸ºè‡ªé€‚åº”å“ˆå¸Œç´¢å¼•ï¼ˆAdaptive Hash Indexï¼ŒAHIï¼‰ã€‚ AHIæœ‰ä¸€ä¸ªè¦æ±‚ï¼Œå°±æ˜¯å¯¹è¿™ä¸ªé¡µçš„è¿ç»­è®¿é—®æ¨¡å¼å¿…é¡»æ˜¯ä¸€æ ·çš„ã€‚ ä¾‹å¦‚å¯¹äºï¼ˆa,bï¼‰è®¿é—®æ¨¡å¼æƒ…å†µï¼š where a = xxx where a = xxx and b = xxx ç‰¹ç‚¹ 1ã€æ— åºï¼Œæ²¡æœ‰æ ‘é«˜ 2ã€é™ä½å¯¹äºŒçº§ç´¢å¼•æ ‘çš„é¢‘ç¹è®¿é—®èµ„æºï¼Œç´¢å¼•æ ‘é«˜&lt;=4ï¼Œè®¿é—®ç´¢å¼•ï¼šè®¿é—®æ ‘ã€æ ¹èŠ‚ç‚¹ã€å¶å­èŠ‚ç‚¹ 3ã€è‡ªé€‚åº” ç¼ºé™· 1ã€hashè‡ªé€‚åº”ç´¢å¼•ä¼šå ç”¨innodb buffer poolï¼› 2ã€è‡ªé€‚åº”hashç´¢å¼•åªé€‚åˆæœç´¢ç­‰å€¼çš„æŸ¥è¯¢ï¼Œå¦‚select * from table where index_col='xxx'ï¼Œè€Œå¯¹äºå…¶ä»–æŸ¥æ‰¾ç±»å‹ï¼Œå¦‚èŒƒå›´æŸ¥æ‰¾ï¼Œæ˜¯ä¸èƒ½ä½¿ç”¨çš„ï¼› 3ã€æç«¯æƒ…å†µä¸‹ï¼Œè‡ªé€‚åº”hashç´¢å¼•æ‰æœ‰æ¯”è¾ƒå¤§çš„æ„ä¹‰ï¼Œå¯ä»¥é™ä½é€»è¾‘è¯»ã€‚ é¢„è¯»(read ahead) InnoDBä½¿ç”¨ä¸¤ç§é¢„è¯»ç®—æ³•æ¥æé«˜I/Oæ€§èƒ½ï¼šçº¿æ€§é¢„è¯»ï¼ˆlinear read-aheadï¼‰å’Œéšæœºé¢„è¯»ï¼ˆrandomread-aheadï¼‰ ä¸ºäº†åŒºåˆ†è¿™ä¸¤ç§é¢„è¯»çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠçº¿æ€§é¢„è¯»æ”¾åˆ°ä»¥extentä¸ºå•ä½ï¼Œè€Œéšæœºé¢„è¯»æ”¾åˆ°ä»¥extentä¸­çš„pageä¸ºå•ä½ã€‚çº¿æ€§é¢„è¯»ç€çœ¼äºå°†ä¸‹ä¸€ä¸ªextentæå‰è¯»å–åˆ°buffer poolä¸­ï¼Œè€Œéšæœºé¢„è¯»ç€çœ¼äºå°†å½“å‰extentä¸­çš„å‰©ä½™çš„pageæå‰è¯»å–åˆ°buffer poolä¸­ã€‚ çº¿æ€§é¢„è¯»ï¼ˆlinear read-aheadï¼‰ çº¿æ€§é¢„è¯»æ–¹å¼æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„å˜é‡æ§åˆ¶æ˜¯å¦å°†ä¸‹ä¸€ä¸ªextenté¢„è¯»åˆ°buffer poolä¸­ï¼Œé€šè¿‡ä½¿ç”¨é…ç½®å‚æ•°innodb_read_ahead_thresholdï¼Œå¯ä»¥æ§åˆ¶Innodbæ‰§è¡Œé¢„è¯»æ“ä½œçš„æ—¶é—´ã€‚å¦‚æœä¸€ä¸ªextentä¸­çš„è¢«é¡ºåºè¯»å–çš„pageè¶…è¿‡æˆ–è€…ç­‰äºè¯¥å‚æ•°å˜é‡æ—¶ï¼ŒInnodbå°†ä¼šå¼‚æ­¥çš„å°†ä¸‹ä¸€ä¸ªextentè¯»å–åˆ°buffer poolä¸­ï¼Œinnodb_read_ahead_thresholdå¯ä»¥è®¾ç½®ä¸º0-64çš„ä»»ä½•å€¼ï¼Œé»˜è®¤å€¼ä¸º56ï¼Œå€¼è¶Šé«˜ï¼Œè®¿é—®æ¨¡å¼æ£€æŸ¥è¶Šä¸¥æ ¼ ä¾‹å¦‚ï¼Œå¦‚æœå°†å€¼è®¾ç½®ä¸º48ï¼Œåˆ™InnoDBåªæœ‰åœ¨é¡ºåºè®¿é—®å½“å‰extentä¸­çš„48ä¸ªpagesæ—¶æ‰è§¦å‘çº¿æ€§é¢„è¯»è¯·æ±‚ï¼Œå°†ä¸‹ä¸€ä¸ªextentè¯»åˆ°å†…å­˜ä¸­ã€‚å¦‚æœå€¼ä¸º8ï¼ŒInnoDBè§¦å‘å¼‚æ­¥é¢„è¯»ï¼Œå³ä½¿ç¨‹åºæ®µä¸­åªæœ‰8é¡µè¢«é¡ºåºè®¿é—®ã€‚ä½ å¯ä»¥åœ¨MySQLé…ç½®æ–‡ä»¶ä¸­è®¾ç½®æ­¤å‚æ•°çš„å€¼ï¼Œæˆ–è€…ä½¿ç”¨SET GLOBALéœ€è¦è¯¥SUPERæƒé™çš„å‘½ä»¤åŠ¨æ€æ›´æ”¹è¯¥å‚æ•°ã€‚ åœ¨æ²¡æœ‰è¯¥å˜é‡ä¹‹å‰ï¼Œå½“è®¿é—®åˆ°extentçš„æœ€åä¸€ä¸ªpageçš„æ—¶å€™ï¼ŒInnodbä¼šå†³å®šæ˜¯å¦å°†ä¸‹ä¸€ä¸ªextentæ”¾å…¥åˆ°buffer poolä¸­ã€‚ éšæœºé¢„è¯»ï¼ˆrandomread-aheadï¼‰ éšæœºé¢„è¯»æ–¹å¼åˆ™æ˜¯è¡¨ç¤ºå½“åŒä¸€ä¸ªextentä¸­çš„ä¸€äº›pageåœ¨buffer poolä¸­å‘ç°æ—¶ï¼ŒInnodbä¼šå°†è¯¥extentä¸­çš„å‰©ä½™pageä¸€å¹¶è¯»åˆ°buffer poolä¸­ï¼Œç”±äºéšæœºé¢„è¯»æ–¹å¼ç»™Innodb codeå¸¦æ¥äº†ä¸€äº›ä¸å¿…è¦çš„å¤æ‚æ€§ï¼ŒåŒæ—¶åœ¨æ€§èƒ½ä¹Ÿå­˜åœ¨ä¸ç¨³å®šæ€§ï¼Œåœ¨5.5ä¸­å·²ç»å°†è¿™ç§é¢„è¯»æ–¹å¼åºŸå¼ƒã€‚è¦å¯ç”¨æ­¤åŠŸèƒ½ï¼Œè¯·å°†é…ç½®å˜é‡è®¾ç½®innodb_random_read_aheadä¸ºONã€‚ å­˜å‚¨å¼•æ“é€‰æ‹© å¦‚æœæ²¡æœ‰ç‰¹åˆ«çš„éœ€æ±‚ï¼Œä½¿ç”¨é»˜è®¤çš„Innodbå³å¯ã€‚ MyISAMï¼šä»¥è¯»å†™æ’å…¥ä¸ºä¸»çš„åº”ç”¨ç¨‹åºï¼Œæ¯”å¦‚åšå®¢ç³»ç»Ÿã€æ–°é—»é—¨æˆ·ç½‘ç«™ã€‚ Innodbï¼šæ›´æ–°ï¼ˆåˆ é™¤ï¼‰æ“ä½œé¢‘ç‡ä¹Ÿé«˜ï¼Œæˆ–è€…è¦ä¿è¯æ•°æ®çš„å®Œæ•´æ€§ï¼›å¹¶å‘é‡é«˜ï¼Œæ”¯æŒäº‹åŠ¡å’Œå¤–é”®ã€‚æ¯”å¦‚OAè‡ªåŠ¨åŒ–åŠå…¬ç³»ç»Ÿã€‚ MySQLæŸ¥è¯¢è¿‡ç¨‹ â€‹ MySQLæŸ¥è¯¢ä¼˜åŒ–å®è´¨è¯´ç™½äº†å°±æ˜¯éµå¾ªä¸€äº›åŸåˆ™è®©MySQLçš„ä¼˜åŒ–å™¨èƒ½å¤ŸæŒ‰ç…§é¢„æƒ³çš„åˆç†æ–¹å¼è¿è¡Œï¼Œä»è€Œè¾¾åˆ°ä¸åŒçš„ä¸šåŠ¡ç›®æ ‡éœ€è¦å®ç°çš„æ•ˆæœã€‚ä¸‹å›¾å±•ç¤ºäº†MySQLçš„æŸ¥è¯¢è¿‡ç¨‹ã€‚ å®¢æˆ·ç«¯/æœåŠ¡ç«¯é€šä¿¡åè®® MySQLå®¢æˆ·ç«¯/æœåŠ¡ç«¯é€šä¿¡åè®®æ˜¯&quot;åŠåŒå·¥&quot;çš„ï¼šåœ¨ä»»æ„æ—¶åˆ»ï¼Œè¦ä¹ˆæ˜¯æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€æ•°æ®ï¼Œè¦ä¹ˆæ˜¯å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€æ•°æ®ï¼Œè¿™ä¸¤ä¸ªåŠ¨ä½œä¸èƒ½åŒæ—¶å‘ç”Ÿã€‚ä¸€æ—¦ä¸€ç«¯å¼€å§‹å‘é€æ¶ˆæ¯ï¼Œå¦ä¸€ç«¯è¦æ¥æ”¶å®Œæ•´ä¸ªæ¶ˆæ¯æ‰èƒ½å“åº”å®ƒï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•ä¹Ÿæ— é¡»å°†ä¸€ä¸ªæ¶ˆæ¯åˆ‡æˆå°å—ç‹¬ç«‹å‘é€ï¼Œä¹Ÿæ²¡æœ‰åŠæ³•è¿›è¡Œæµé‡æ§åˆ¶ã€‚ å®¢æˆ·ç«¯ç”¨ä¸€ä¸ªå•ç‹¬çš„æ•°æ®åŒ…å°†æŸ¥è¯¢è¯·æ±‚å‘é€ç»™æœåŠ¡å™¨ï¼Œæ‰€ä»¥å½“æŸ¥è¯¢è¯­å¥å¾ˆé•¿çš„æ—¶å€™ï¼Œéœ€è¦è®¾ç½®max_allowed_packetå‚æ•°ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæŸ¥è¯¢å®åœ¨æ˜¯å¤ªå¤§ï¼ŒæœåŠ¡ç«¯ä¼šæ‹’ç»æ¥æ”¶æ›´å¤šæ•°æ®å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚ ä¸ä¹‹ç›¸åçš„æ˜¯ï¼ŒæœåŠ¡å™¨å“åº”ç»™ç”¨æˆ·çš„æ•°æ®é€šå¸¸ä¼šå¾ˆå¤šï¼Œç”±å¤šä¸ªæ•°æ®åŒ…ç»„æˆã€‚ä½†æ˜¯å½“æœåŠ¡å™¨å“åº”å®¢æˆ·ç«¯è¯·æ±‚æ—¶ï¼Œå®¢æˆ·ç«¯å¿…é¡»å®Œæ•´çš„æ¥æ”¶æ•´ä¸ªè¿”å›ç»“æœï¼Œè€Œä¸èƒ½ç®€å•çš„åªå–å‰é¢å‡ æ¡ç»“æœï¼Œç„¶åè®©æœåŠ¡å™¨åœæ­¢å‘é€ã€‚å› è€Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œå°½é‡ä¿æŒæŸ¥è¯¢ç®€å•ä¸”åªè¿”å›å¿…éœ€çš„æ•°æ®ï¼Œå‡å°é€šä¿¡é—´æ•°æ®åŒ…çš„å¤§å°å’Œæ•°é‡æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¹ æƒ¯ï¼Œè¿™ä¹Ÿæ˜¯æŸ¥è¯¢ä¸­å°½é‡é¿å…ä½¿ç”¨SELECT *ä»¥åŠåŠ ä¸ŠLIMITé™åˆ¶çš„åŸå› ä¹‹ä¸€ã€‚ æŸ¥è¯¢ç¼“å­˜ åœ¨è§£æä¸€ä¸ªæŸ¥è¯¢è¯­å¥å‰ï¼Œå¦‚æœæŸ¥è¯¢ç¼“å­˜æ˜¯æ‰“å¼€çš„ï¼Œé‚£ä¹ˆMySQLä¼šæ£€æŸ¥è¿™ä¸ªæŸ¥è¯¢è¯­å¥æ˜¯å¦å‘½ä¸­æŸ¥è¯¢ç¼“å­˜ä¸­çš„æ•°æ®ã€‚å¦‚æœå½“å‰æŸ¥è¯¢æ°å¥½å‘½ä¸­æŸ¥è¯¢ç¼“å­˜ï¼Œåœ¨æ£€æŸ¥ä¸€æ¬¡ç”¨æˆ·æƒé™åç›´æ¥è¿”å›ç¼“å­˜ä¸­çš„ç»“æœã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒæŸ¥è¯¢ä¸ä¼šè¢«è§£æï¼Œä¹Ÿä¸ä¼šç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼Œæ›´ä¸ä¼šæ‰§è¡Œã€‚ MySQLå°†ç¼“å­˜å­˜æ”¾åœ¨ä¸€ä¸ªå¼•ç”¨è¡¨ï¼ˆç±»ä¼¼äºHashMapçš„æ•°æ®ç»“æ„ï¼‰ä¸­ï¼Œé€šè¿‡å“ˆå¸Œå€¼ç´¢å¼•ï¼Œè¿™ä¸ªå“ˆå¸Œå€¼é€šè¿‡æŸ¥è¯¢æœ¬èº«ã€å½“å‰è¦æŸ¥è¯¢çš„æ•°æ®åº“ã€å®¢æˆ·ç«¯åè®®ç‰ˆæœ¬å·ç­‰ä¸€äº›å¯èƒ½å½±å“ç»“æœçš„ä¿¡æ¯è®¡ç®—å¾—æ¥ã€‚æ‰€ä»¥ä¸¤ä¸ªæŸ¥è¯¢åœ¨ä»»ä½•å­—ç¬¦ä¸Šçš„ä¸åŒï¼ˆä¾‹å¦‚ï¼šç©ºæ ¼ã€æ³¨é‡Šï¼‰ï¼Œéƒ½ä¼šå¯¼è‡´ç¼“å­˜ä¸ä¼šå‘½ä¸­ã€‚ å¦‚æœæŸ¥è¯¢ä¸­åŒ…å«ä»»ä½•ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°ã€å­˜å‚¨å‡½æ•°ã€ç”¨æˆ·å˜é‡ã€ä¸´æ—¶è¡¨ã€mysqlåº“ä¸­çš„ç³»ç»Ÿè¡¨ï¼Œå…¶æŸ¥è¯¢ç»“æœéƒ½ä¸ä¼šè¢«ç¼“å­˜ã€‚æ¯”å¦‚å‡½æ•°NOW()æˆ–è€…CURRENT_DATE()ä¼šå› ä¸ºä¸åŒçš„æŸ¥è¯¢æ—¶é—´ï¼Œè¿”å›ä¸åŒçš„æŸ¥è¯¢ç»“æœï¼Œå†æ¯”å¦‚åŒ…å«CURRENT_USERæˆ–è€…CONNECION_ID()çš„æŸ¥è¯¢è¯­å¥ä¼šå› ä¸ºä¸åŒçš„ç”¨æˆ·è€Œè¿”å›ä¸åŒçš„ç»“æœï¼Œå°†è¿™æ ·çš„æŸ¥è¯¢ç»“æœç¼“å­˜èµ·æ¥æ²¡æœ‰ä»»ä½•çš„æ„ä¹‰ã€‚ MySQLçš„æŸ¥è¯¢ç¼“å­˜ç³»ç»Ÿä¼šè·Ÿè¸ªæŸ¥è¯¢ä¸­æ¶‰åŠçš„æ¯ä¸ªè¡¨ï¼Œå¦‚æœè¿™äº›è¡¨ï¼ˆæ•°æ®æˆ–ç»“æ„ï¼‰å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆå’Œè¿™å¼ è¡¨ç›¸å…³çš„æ‰€æœ‰ç¼“å­˜æ•°æ®éƒ½å°†å¤±æ•ˆã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼Œåœ¨ä»»ä½•çš„å†™æ“ä½œæ—¶ï¼ŒMySQLå¿…é¡»å°†å¯¹åº”è¡¨çš„æ‰€æœ‰ç¼“å­˜éƒ½è®¾ç½®ä¸ºå¤±æ•ˆã€‚å¦‚æœæŸ¥è¯¢ç¼“å­˜éå¸¸å¤§æˆ–è€…ç¢ç‰‡å¾ˆå¤šï¼Œè¿™ä¸ªæ“ä½œå°±å¯èƒ½å¸¦æ¥å¾ˆå¤§çš„ç³»ç»Ÿæ¶ˆè€—ï¼Œç”šè‡³å¯¼è‡´ç³»ç»Ÿåƒµæ­»ä¸€ä¼šå„¿ã€‚è€Œä¸”æŸ¥è¯¢ç¼“å­˜å¯¹ç³»ç»Ÿçš„é¢å¤–æ¶ˆè€—ä¹Ÿä¸ä»…ä»…åœ¨å†™æ“ä½œï¼Œè¯»æ“ä½œä¹Ÿä¸ä¾‹å¤–ã€‚å¦‚æœæŸ¥è¯¢ç»“æœè¢«ç¼“å­˜ï¼Œé‚£ä¹ˆæ‰§è¡Œå®Œæˆåï¼Œä¼šå°†ç»“æœå­˜å…¥ç¼“å­˜ï¼Œä¹Ÿä¼šå¸¦æ¥é¢å¤–çš„ç³»ç»Ÿæ¶ˆè€—ã€‚åŸºäºæ­¤ï¼Œæˆ‘ä»¬çŸ¥é“å¹¶ä¸æ˜¯ä»€ä¹ˆæƒ…å†µä¸‹æŸ¥è¯¢ç¼“å­˜éƒ½ä¼šæé«˜ç³»ç»Ÿæ€§èƒ½ï¼Œç¼“å­˜å’Œå¤±æ•ˆéƒ½ä¼šå¸¦æ¥é¢å¤–æ¶ˆè€—ï¼Œåªæœ‰å½“ç¼“å­˜å¸¦æ¥çš„èµ„æºèŠ‚çº¦å¤§äºå…¶æœ¬èº«æ¶ˆè€—çš„èµ„æºæ—¶ï¼Œæ‰ä¼šç»™ç³»ç»Ÿå¸¦æ¥æ€§èƒ½æå‡ã€‚å¦‚æœç³»ç»Ÿç¡®å®å­˜åœ¨ä¸€äº›æ€§èƒ½é—®é¢˜ï¼Œå¯ä»¥å°è¯•æ‰“å¼€æŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶åœ¨æ•°æ®åº“è®¾è®¡ä¸Šåšä¸€äº›ä¼˜åŒ–ï¼Œæ¯”å¦‚ï¼š 1ï¼‰å¤šä¸ªå°è¡¨ä»£æ›¿ä¸€ä¸ªå¤§è¡¨ï¼ˆæ³¨æ„ä¸è¦è¿‡åº¦è®¾è®¡ï¼‰ 2ï¼‰æ‰¹é‡æ’å…¥ä»£æ›¿å¾ªç¯å•æ¡æ’å…¥ï¼Œé™ä½ç£ç›˜IOæ¬¡æ•° 3ï¼‰åˆç†æ§åˆ¶ç¼“å­˜ç©ºé—´å¤§å°ï¼Œä¸€èˆ¬æ¥è¯´å…¶å¤§å°è®¾ç½®ä¸ºå‡ åå…†æ¯”è¾ƒåˆé€‚ 4ï¼‰å¯ä»¥é€šè¿‡SQL_CACHEå’ŒSQL_NO_CACHEæ¥æ§åˆ¶æŸä¸ªæŸ¥è¯¢è¯­å¥æ˜¯å¦éœ€è¦è¿›è¡Œç¼“å­˜ è¯­æ³•è§£æå’Œé¢„å¤„ç† MySQLé€šè¿‡å…³é”®å­—å°†SQLè¯­å¥è¿›è¡Œè§£æå¹¶ç”Ÿæˆä¸€é¢—å¯¹åº”çš„è§£ææ ‘ã€‚è¿™ä¸ªè¿‡ç¨‹è§£æå™¨ä¸»è¦é€šè¿‡è¯­æ³•è§„åˆ™æ¥éªŒè¯å’Œè§£æï¼Œæ¯”å¦‚SQLä¸­æ˜¯å¦ä½¿ç”¨äº†é”™è¯¯çš„å…³é”®å­—æˆ–è€…å…³é”®å­—çš„é¡ºåºæ˜¯å¦æ­£ç¡®ç­‰ç­‰ã€‚é¢„å¤„ç†åˆ™ä¼šæ ¹æ®MySQLè§„åˆ™è¿›ä¸€æ­¥æ£€æŸ¥è§£ææ ‘æ˜¯å¦åˆæ³•ï¼Œæ¯”å¦‚æ£€æŸ¥è¦æŸ¥è¯¢çš„æ•°æ®è¡¨å’Œæ•°æ®åˆ—æ˜¯å¦å­˜åœ¨ç­‰ç­‰ã€‚ æŸ¥è¯¢ä¼˜åŒ– ç»è¿‡å‰é¢çš„æ­¥éª¤ç”Ÿæˆçš„è¯­æ³•æ ‘è¢«è®¤ä¸ºæ˜¯åˆæ³•çš„äº†ï¼Œå¹¶ä¸”ç”±ä¼˜åŒ–å™¨å°†å…¶è½¬åŒ–æˆæŸ¥è¯¢è®¡åˆ’ã€‚å¤šæ•°æƒ…å†µä¸‹ä¸€æ¡æŸ¥è¯¢å¯ä»¥æœ‰å¾ˆå¤šç§æ‰§è¡Œæ–¹å¼ï¼Œæœ€åéƒ½è¿”å›ç›¸åº”çš„ç»“æœã€‚ä¼˜åŒ–å™¨çš„ä½œç”¨å°±æ˜¯æ‰¾åˆ°è¿™å…¶ä¸­æœ€å¥½çš„æ‰§è¡Œè®¡åˆ’ã€‚MySQLä½¿ç”¨åŸºäºæˆæœ¬çš„ä¼˜åŒ–å™¨ï¼Œå®ƒå°è¯•é¢„æµ‹ä¸€ä¸ªæŸ¥è¯¢ä½¿ç”¨æŸç§æ‰§è¡Œè®¡åˆ’æ—¶çš„æˆæœ¬ï¼Œå¹¶é€‰æ‹©å…¶ä¸­æˆæœ¬æœ€å°çš„ä¸€ä¸ªã€‚åœ¨MySQLå¯ä»¥é€šè¿‡æŸ¥è¯¢å½“å‰ä¼šè¯çš„last_query_costçš„å€¼æ¥å¾—åˆ°å…¶è®¡ç®—å½“å‰æŸ¥è¯¢çš„æˆæœ¬ã€‚ æœ‰éå¸¸å¤šçš„åŸå› ä¼šå¯¼è‡´MySQLé€‰æ‹©é”™è¯¯çš„æ‰§è¡Œè®¡åˆ’ï¼Œæ¯”å¦‚ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®ã€ä¸ä¼šè€ƒè™‘ä¸å—å…¶æ§åˆ¶çš„æ“ä½œæˆæœ¬ï¼ˆç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°ã€å­˜å‚¨è¿‡ç¨‹ï¼‰ã€MySQLè®¤ä¸ºçš„æœ€ä¼˜è·Ÿæˆ‘ä»¬æƒ³çš„ä¸ä¸€æ ·ï¼Œæˆ‘ä»¬å¸Œæœ›æ‰§è¡Œæ—¶é—´å°½å¯èƒ½çŸ­ï¼Œä½†MySQLåªé€‰æ‹©å®ƒè®¤ä¸ºæˆæœ¬å°çš„ï¼Œä½†æˆæœ¬å°æœ‰çš„æ—¶å€™å¹¶ä¸æ˜¯æˆ‘ä»¬çš„é¢„æœŸã€‚ æŸ¥è¯¢æ‰§è¡Œå¼•æ“ åœ¨å®Œæˆè§£æå’Œä¼˜åŒ–é˜¶æ®µä»¥åï¼ŒMySQLä¼šç”Ÿæˆå¯¹åº”çš„æ‰§è¡Œè®¡åˆ’ï¼ŒæŸ¥è¯¢æ‰§è¡Œå¼•æ“æ ¹æ®æ‰§è¡Œè®¡åˆ’ç»™å‡ºçš„æŒ‡ä»¤é€æ­¥æ‰§è¡Œå¾—å‡ºç»“æœã€‚æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹çš„å¤§éƒ¨åˆ†æ“ä½œå‡æ˜¯é€šè¿‡è°ƒç”¨å­˜å‚¨å¼•æ“å®ç°çš„æ¥å£æ¥å®Œæˆï¼Œè¿™äº›æ¥å£è¢«ç§°ä¸ºhandler APIã€‚æŸ¥è¯¢è¿‡ç¨‹ä¸­çš„æ¯ä¸€å¼ è¡¨ç”±ä¸€ä¸ªhandlerå®ä¾‹è¡¨ç¤ºã€‚å®é™…ä¸Šï¼ŒMySQLåœ¨æŸ¥è¯¢ä¼˜åŒ–é˜¶æ®µå°±ä¸ºæ¯ä¸€å¼ è¡¨åˆ›å»ºäº†ä¸€ä¸ªhandlerå®ä¾‹ï¼Œä¼˜åŒ–å™¨å¯ä»¥æ ¹æ®è¿™äº›å®ä¾‹çš„æ¥å£æ¥è·å–è¡¨çš„ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¡¨çš„æ‰€æœ‰åˆ—åã€ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯ç­‰ã€‚å­˜å‚¨å¼•æ“æ¥å£æä¾›äº†éå¸¸ä¸°å¯Œçš„åŠŸèƒ½ï¼Œä½†å…¶åº•å±‚ä»…æœ‰å‡ åä¸ªæ¥å£ï¼Œè¿™äº›æ¥å£åƒæ­ç§¯æœ¨ä¸€æ ·å®Œæˆäº†ä¸€æ¬¡æŸ¥è¯¢çš„å¤§éƒ¨åˆ†æ“ä½œã€‚ è¿”å›ç»“æœç»™å®¢æˆ·ç«¯ æŸ¥è¯¢æ‰§è¡Œçš„æœ€åä¸€ä¸ªé˜¶æ®µå°±æ˜¯å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚å³ä½¿æŸ¥è¯¢ä¸åˆ°æ•°æ®ï¼ŒMySQLä»ç„¶ä¼šè¿”å›è¿™ä¸ªæŸ¥è¯¢çš„ç›¸å…³ä¿¡æ¯ï¼Œæ¯”å¦‚è¯¥æŸ¥è¯¢å½±å“åˆ°çš„è¡Œæ•°ä»¥åŠæ‰§è¡Œæ—¶é—´ç­‰ç­‰ã€‚å¦‚æœæŸ¥è¯¢ç¼“å­˜è¢«æ‰“å¼€ä¸”è¿™ä¸ªæŸ¥è¯¢å¯ä»¥è¢«ç¼“å­˜ï¼ŒMySQLä¹Ÿä¼šå°†ç»“æœå­˜æ”¾åˆ°ç¼“å­˜ä¸­ã€‚ç»“æœé›†è¿”å›å®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªå¢é‡ä¸”é€æ­¥è¿”å›çš„è¿‡ç¨‹ã€‚æœ‰å¯èƒ½MySQLåœ¨ç”Ÿæˆç¬¬ä¸€æ¡ç»“æœæ—¶ï¼Œå°±å¼€å§‹å‘å®¢æˆ·ç«¯é€æ­¥è¿”å›ç»“æœé›†äº†ã€‚è¿™æ ·æœåŠ¡ç«¯å°±æ— é¡»å­˜å‚¨å¤ªå¤šç»“æœè€Œæ¶ˆè€—è¿‡å¤šå†…å­˜ï¼Œä¹Ÿå¯ä»¥è®©å®¢æˆ·ç«¯ç¬¬ä¸€æ—¶é—´è·å¾—è¿”å›ç»“æœã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç»“æœé›†ä¸­çš„æ¯ä¸€è¡Œéƒ½ä¼šä»¥ä¸€ä¸ªæ»¡è¶³å®¢æˆ·ç«¯/æœåŠ¡å™¨é€šä¿¡åè®®çš„æ•°æ®åŒ…å‘é€ï¼Œå†é€šè¿‡TCPåè®®è¿›è¡Œä¼ è¾“ï¼Œåœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å¯¹MySQLçš„æ•°æ®åŒ…è¿›è¡Œç¼“å­˜ç„¶åæ‰¹é‡å‘é€ã€‚ ","link":"https://tianxiawuhao.github.io/Nq-4WaiGL/"},{"title":"redisæ¦‚è¿°äº”","content":"åˆ†å¸ƒå¼é—®é¢˜ Rediså®ç°åˆ†å¸ƒå¼é” Redisä¸ºå•è¿›ç¨‹å•çº¿ç¨‹æ¨¡å¼ï¼Œé‡‡ç”¨é˜Ÿåˆ—æ¨¡å¼å°†å¹¶å‘è®¿é—®å˜æˆä¸²è¡Œè®¿é—®ï¼Œä¸”å¤šå®¢æˆ·ç«¯å¯¹Redisçš„è¿æ¥å¹¶ä¸å­˜åœ¨ç«äº‰å…³ç³»Redisä¸­å¯ä»¥ä½¿ç”¨SETNXå‘½ä»¤å®ç°åˆ†å¸ƒå¼é”ã€‚ å½“ä¸”ä»…å½“ key ä¸å­˜åœ¨ï¼Œå°† key çš„å€¼è®¾ä¸º valueã€‚ è‹¥ç»™å®šçš„ key å·²ç»å­˜åœ¨ï¼Œåˆ™ SETNX ä¸åšä»»ä½•åŠ¨ä½œ SETNX æ˜¯ã€SET if Not eXistsã€(å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ SET)çš„ç®€å†™ã€‚ è¿”å›å€¼ï¼šè®¾ç½®æˆåŠŸï¼Œè¿”å› 1 ã€‚è®¾ç½®å¤±è´¥ï¼Œè¿”å› 0 ã€‚ ä½¿ç”¨SETNXå®ŒæˆåŒæ­¥é”çš„æµç¨‹åŠäº‹é¡¹å¦‚ä¸‹ï¼š ä½¿ç”¨SETNXå‘½ä»¤è·å–é”ï¼Œè‹¥è¿”å›0ï¼ˆkeyå·²å­˜åœ¨ï¼Œé”å·²å­˜åœ¨ï¼‰åˆ™è·å–å¤±è´¥ï¼Œåä¹‹è·å–æˆåŠŸ ä¸ºäº†é˜²æ­¢è·å–é”åç¨‹åºå‡ºç°å¼‚å¸¸ï¼Œå¯¼è‡´å…¶ä»–çº¿ç¨‹/è¿›ç¨‹è°ƒç”¨SETNXå‘½ä»¤æ€»æ˜¯è¿”å›0è€Œè¿›å…¥æ­»é”çŠ¶æ€ï¼Œéœ€è¦ä¸ºè¯¥keyè®¾ç½®ä¸€ä¸ªâ€œåˆç†â€çš„è¿‡æœŸæ—¶é—´ é‡Šæ”¾é”ï¼Œä½¿ç”¨DELå‘½ä»¤å°†é”æ•°æ®åˆ é™¤ package com.example.redisstudy.template; import org.apache.commons.lang3.StringUtils; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.data.redis.core.StringRedisTemplate; import org.springframework.stereotype.Component; import java.util.concurrent.TimeUnit; /** * @Description //ç›´æ¥ä½¿ç”¨Redisè¿›è¡Œåˆ†å¸ƒå¼é” * è¿™æ˜¯ç®€æ˜“ç‰ˆæœ¬ å¦‚æœè¦ä½¿ç”¨RedisåŸç”Ÿé”è®°å¾—åŠ è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢æ­»é” æœ€å¥½ä½¿ç”¨Redissonæ“ä½œç®€å•æ›´åŠ æ–¹ä¾¿ * @Date * @Author wuhao **/ @Component public class RedisLockCommon { @Autowired private StringRedisTemplate stringRedisTemplate; private Integer EXPIRE_TIME=3000; /** * RedisåŠ é”çš„æ“ä½œ * * @param key * @param value * @return */ public Boolean tryLock(String key, String value) { if (stringRedisTemplate.opsForValue().setIfAbsent(key, value, EXPIRE_TIME, TimeUnit.SECONDS)) { return true; } return false; } /** * Redisè§£é”çš„æ“ä½œ * * @param key * @param value */ public void unlock(String key, String value) { String currentValue = stringRedisTemplate.opsForValue().get(key); try { if (StringUtils.isNotEmpty(currentValue) &amp;&amp; currentValue.equals(value)) { stringRedisTemplate.opsForValue().getOperations().delete(key); } } catch (Exception e) { } } } å¦‚ä½•è§£å†³ Redis çš„å¹¶å‘ç«äº‰ Key é—®é¢˜ æ‰€è°“ Redis çš„å¹¶å‘ç«äº‰ Key çš„é—®é¢˜ä¹Ÿå°±æ˜¯å¤šä¸ªç³»ç»ŸåŒæ—¶å¯¹ä¸€ä¸ª key è¿›è¡Œæ“ä½œï¼Œä½†æ˜¯æœ€åæ‰§è¡Œçš„é¡ºåºå’Œæˆ‘ä»¬æœŸæœ›çš„é¡ºåºä¸åŒï¼Œè¿™æ ·ä¹Ÿå°±å¯¼è‡´äº†ç»“æœçš„ä¸åŒï¼ æ¨èä¸€ç§æ–¹æ¡ˆï¼šåˆ†å¸ƒå¼é”ï¼ˆzookeeper å’Œ redis éƒ½å¯ä»¥å®ç°åˆ†å¸ƒå¼é”ï¼‰ã€‚ï¼ˆå¦‚æœä¸å­˜åœ¨ Redis çš„å¹¶å‘ç«äº‰ Key é—®é¢˜ï¼Œä¸è¦ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼Œè¿™æ ·ä¼šå½±å“æ€§èƒ½ï¼‰ åŸºäºzookeeperä¸´æ—¶æœ‰åºèŠ‚ç‚¹å¯ä»¥å®ç°çš„åˆ†å¸ƒå¼é”ã€‚å¤§è‡´æ€æƒ³ä¸ºï¼šæ¯ä¸ªå®¢æˆ·ç«¯å¯¹æŸä¸ªæ–¹æ³•åŠ é”æ—¶ï¼Œåœ¨zookeeperä¸Šçš„ä¸è¯¥æ–¹æ³•å¯¹åº”çš„æŒ‡å®šèŠ‚ç‚¹çš„ç›®å½•ä¸‹ï¼Œç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ç¬æ—¶æœ‰åºèŠ‚ç‚¹ã€‚ åˆ¤æ–­æ˜¯å¦è·å–é”çš„æ–¹å¼å¾ˆç®€å•ï¼Œåªéœ€è¦åˆ¤æ–­æœ‰åºèŠ‚ç‚¹ä¸­åºå·æœ€å°çš„ä¸€ä¸ªã€‚ å½“é‡Šæ”¾é”çš„æ—¶å€™ï¼Œåªéœ€å°†è¿™ä¸ªç¬æ—¶èŠ‚ç‚¹åˆ é™¤å³å¯ã€‚åŒæ—¶ï¼Œå…¶å¯ä»¥é¿å…æœåŠ¡å®•æœºå¯¼è‡´çš„é”æ— æ³•é‡Šæ”¾ï¼Œè€Œäº§ç”Ÿçš„æ­»é”é—®é¢˜ã€‚å®Œæˆä¸šåŠ¡æµç¨‹åï¼Œåˆ é™¤å¯¹åº”çš„å­èŠ‚ç‚¹é‡Šæ”¾é”ã€‚ åœ¨å®è·µä¸­ï¼Œå½“ç„¶æ˜¯ä»ä»¥å¯é æ€§ä¸ºä¸»ã€‚æ‰€ä»¥é¦–æ¨Zookeeperã€‚ å‚è€ƒï¼šhttps://www.jianshu.com/p/8bddd381de06 åˆ†å¸ƒå¼Redisæ˜¯å‰æœŸåšè¿˜æ˜¯åæœŸè§„æ¨¡ä¸Šæ¥äº†å†åšå¥½ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ æ—¢ç„¶Redisæ˜¯å¦‚æ­¤çš„è½»é‡ï¼ˆå•å®ä¾‹åªä½¿ç”¨1Må†…å­˜ï¼‰ï¼Œä¸ºé˜²æ­¢ä»¥åçš„æ‰©å®¹ï¼Œæœ€å¥½çš„åŠæ³•å°±æ˜¯ä¸€å¼€å§‹å°±å¯åŠ¨è¾ƒå¤šå®ä¾‹ã€‚å³ä¾¿ä½ åªæœ‰ä¸€å°æœåŠ¡å™¨ï¼Œä½ ä¹Ÿå¯ä»¥ä¸€å¼€å§‹å°±è®©Redisä»¥åˆ†å¸ƒå¼çš„æ–¹å¼è¿è¡Œï¼Œä½¿ç”¨åˆ†åŒºï¼Œåœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šå¯åŠ¨å¤šä¸ªå®ä¾‹ã€‚ ä¸€å¼€å§‹å°±å¤šè®¾ç½®å‡ ä¸ªRediså®ä¾‹ï¼Œä¾‹å¦‚32æˆ–è€…64ä¸ªå®ä¾‹ï¼Œå¯¹å¤§å¤šæ•°ç”¨æˆ·æ¥è¯´è¿™æ“ä½œèµ·æ¥å¯èƒ½æ¯”è¾ƒéº»çƒ¦ï¼Œä½†æ˜¯ä»é•¿ä¹…æ¥çœ‹åšè¿™ç‚¹ç‰ºç‰²æ˜¯å€¼å¾—çš„ã€‚ è¿™æ ·çš„è¯ï¼Œå½“ä½ çš„æ•°æ®ä¸æ–­å¢é•¿ï¼Œéœ€è¦æ›´å¤šçš„RedisæœåŠ¡å™¨æ—¶ï¼Œä½ éœ€è¦åšçš„å°±æ˜¯ä»…ä»…å°†Rediså®ä¾‹ä»ä¸€å°æœåŠ¡è¿ç§»åˆ°å¦å¤–ä¸€å°æœåŠ¡å™¨è€Œå·²ï¼ˆè€Œä¸ç”¨è€ƒè™‘é‡æ–°åˆ†åŒºçš„é—®é¢˜ï¼‰ã€‚ä¸€æ—¦ä½ æ·»åŠ äº†å¦ä¸€å°æœåŠ¡å™¨ï¼Œä½ éœ€è¦å°†ä½ ä¸€åŠçš„Rediså®ä¾‹ä»ç¬¬ä¸€å°æœºå™¨è¿ç§»åˆ°ç¬¬äºŒå°æœºå™¨ã€‚ ä»€ä¹ˆæ˜¯ RedLock Redis å®˜æ–¹ç«™æå‡ºäº†ä¸€ç§æƒå¨çš„åŸºäº Redis å®ç°åˆ†å¸ƒå¼é”çš„æ–¹å¼åå« Redlockï¼Œæ­¤ç§æ–¹å¼æ¯”åŸå…ˆçš„å•èŠ‚ç‚¹çš„æ–¹æ³•æ›´å®‰å…¨ã€‚å®ƒå¯ä»¥ä¿è¯ä»¥ä¸‹ç‰¹æ€§ï¼š å®‰å…¨ç‰¹æ€§ï¼šäº’æ–¥è®¿é—®ï¼Œå³æ°¸è¿œåªæœ‰ä¸€ä¸ª client èƒ½æ‹¿åˆ°é” é¿å…æ­»é”ï¼šæœ€ç»ˆ client éƒ½å¯èƒ½æ‹¿åˆ°é”ï¼Œä¸ä¼šå‡ºç°æ­»é”çš„æƒ…å†µï¼Œå³ä½¿åŸæœ¬é”ä½æŸèµ„æºçš„ client crash äº†æˆ–è€…å‡ºç°äº†ç½‘ç»œåˆ†åŒº å®¹é”™æ€§ï¼šåªè¦å¤§éƒ¨åˆ† Redis èŠ‚ç‚¹å­˜æ´»å°±å¯ä»¥æ­£å¸¸æä¾›æœåŠ¡ package com.example.redisstudy.template; import org.springframework.data.redis.connection.RedisConnection; import org.springframework.data.redis.connection.RedisConnectionFactory; import org.springframework.data.redis.connection.ReturnType; import org.springframework.data.redis.core.RedisConnectionUtils; import org.springframework.data.redis.core.StringRedisTemplate; import org.springframework.stereotype.Repository; import java.nio.charset.Charset; import java.util.UUID; import java.util.concurrent.TimeUnit; @Repository public class RedisLock { /** * è§£é”è„šæœ¬ï¼ŒåŸå­æ“ä½œ */ private static final String unlockScript = &quot;if redis.call(\\&quot;get\\&quot;,KEYS[1]) == ARGV[1]\\n&quot; + &quot;then\\n&quot; + &quot; return redis.call(\\&quot;del\\&quot;,KEYS[1])\\n&quot; + &quot;else\\n&quot; + &quot; return 0\\n&quot; + &quot;end&quot;; private StringRedisTemplate redisTemplate; public RedisLock(StringRedisTemplate redisTemplate) { this.redisTemplate = redisTemplate; } /** * åŠ é”ï¼Œæœ‰é˜»å¡ * @param name * @param expire * @param timeout * @return */ public String lock(String name, long expire, long timeout){ long startTime = System.currentTimeMillis(); String token; do{ token = tryLock(name, expire); if(token == null) { if((System.currentTimeMillis()-startTime) &gt; (timeout-50)) break; try { Thread.sleep(50); //try 50 per sec } catch (InterruptedException e) { e.printStackTrace(); return null; } } }while(token==null); return token; } /** * åŠ é”ï¼Œæ— é˜»å¡ * @param name * @param expire * @return */ public String tryLock(String name, long expire) { String token = UUID.randomUUID().toString(); if (redisTemplate.opsForValue().setIfAbsent(name, token, expire, TimeUnit.SECONDS)) { return token; } return null; } /** * è§£é” * @param name * @param token * @return */ public boolean unlock(String name, String token) { byte[][] keysAndArgs = new byte[2][]; keysAndArgs[0] = name.getBytes(Charset.forName(&quot;UTF-8&quot;)); keysAndArgs[1] = token.getBytes(Charset.forName(&quot;UTF-8&quot;)); RedisConnectionFactory factory = redisTemplate.getConnectionFactory(); RedisConnection conn = factory.getConnection(); try { Long result = (Long)conn.scriptingCommands().eval(unlockScript.getBytes(Charset.forName(&quot;UTF-8&quot;)), ReturnType.INTEGER, 1, keysAndArgs); if(result!=null &amp;&amp; result&gt;0) return true; }finally { RedisConnectionUtils.releaseConnection(conn, factory); } return false; } } ç¼“å­˜é›ªå´© ç¼“å­˜é›ªå´©æ˜¯æŒ‡ç¼“å­˜åŒä¸€æ—¶é—´å¤§é¢ç§¯çš„å¤±æ•ˆï¼Œæ‰€ä»¥ï¼Œåé¢çš„è¯·æ±‚éƒ½ä¼šè½åˆ°æ•°æ®åº“ä¸Šï¼Œé€ æˆæ•°æ®åº“çŸ­æ—¶é—´å†…æ‰¿å—å¤§é‡è¯·æ±‚è€Œå´©æ‰ã€‚ è§£å†³æ–¹æ¡ˆ ç¼“å­˜æ•°æ®çš„è¿‡æœŸæ—¶é—´è®¾ç½®éšæœºï¼Œé˜²æ­¢åŒä¸€æ—¶é—´å¤§é‡æ•°æ®è¿‡æœŸç°è±¡å‘ç”Ÿã€‚ ä¸€èˆ¬å¹¶å‘é‡ä¸æ˜¯ç‰¹åˆ«å¤šçš„æ—¶å€™ï¼Œä½¿ç”¨æœ€å¤šçš„è§£å†³æ–¹æ¡ˆæ˜¯åŠ é”æ’é˜Ÿã€‚ ç»™æ¯ä¸€ä¸ªç¼“å­˜æ•°æ®å¢åŠ ç›¸åº”çš„ç¼“å­˜æ ‡è®°ï¼Œè®°å½•ç¼“å­˜çš„æ˜¯å¦å¤±æ•ˆï¼Œå¦‚æœç¼“å­˜æ ‡è®°å¤±æ•ˆï¼Œåˆ™æ›´æ–°æ•°æ®ç¼“å­˜ã€‚ ç¼“å­˜ç©¿é€ ç¼“å­˜ç©¿é€æ˜¯æŒ‡ç¼“å­˜å’Œæ•°æ®åº“ä¸­éƒ½æ²¡æœ‰çš„æ•°æ®ï¼Œå¯¼è‡´æ‰€æœ‰çš„è¯·æ±‚éƒ½è½åˆ°æ•°æ®åº“ä¸Šï¼Œé€ æˆæ•°æ®åº“çŸ­æ—¶é—´å†…æ‰¿å—å¤§é‡è¯·æ±‚è€Œå´©æ‰ã€‚ è§£å†³æ–¹æ¡ˆ æ¥å£å±‚å¢åŠ æ ¡éªŒï¼Œå¦‚ç”¨æˆ·é‰´æƒæ ¡éªŒï¼ŒidåšåŸºç¡€æ ¡éªŒï¼Œid&lt;=0çš„ç›´æ¥æ‹¦æˆªï¼› ä»ç¼“å­˜å–ä¸åˆ°çš„æ•°æ®ï¼Œåœ¨æ•°æ®åº“ä¸­ä¹Ÿæ²¡æœ‰å–åˆ°ï¼Œè¿™æ—¶ä¹Ÿå¯ä»¥å°†key-valueå¯¹å†™ä¸ºkey-nullï¼Œç¼“å­˜æœ‰æ•ˆæ—¶é—´å¯ä»¥è®¾ç½®çŸ­ç‚¹ï¼Œå¦‚30ç§’ï¼ˆè®¾ç½®å¤ªé•¿ä¼šå¯¼è‡´æ­£å¸¸æƒ…å†µä¹Ÿæ²¡æ³•ä½¿ç”¨ï¼‰ã€‚è¿™æ ·å¯ä»¥é˜²æ­¢æ”»å‡»ç”¨æˆ·åå¤ç”¨åŒä¸€ä¸ªidæš´åŠ›æ”»å‡» é‡‡ç”¨å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå°†æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„æ•°æ®å“ˆå¸Œåˆ°ä¸€ä¸ªè¶³å¤Ÿå¤§çš„ bitmap ä¸­ï¼Œä¸€ä¸ªä¸€å®šä¸å­˜åœ¨çš„æ•°æ®ä¼šè¢«è¿™ä¸ª bitmap æ‹¦æˆªæ‰ï¼Œä»è€Œé¿å…äº†å¯¹åº•å±‚å­˜å‚¨ç³»ç»Ÿçš„æŸ¥è¯¢å‹åŠ› é™„åŠ  å¯¹äºç©ºé—´çš„åˆ©ç”¨åˆ°è¾¾äº†ä¸€ç§æè‡´ï¼Œé‚£å°±æ˜¯Bitmapå’Œå¸ƒéš†è¿‡æ»¤å™¨(Bloom Filter)ã€‚ Bitmapï¼š å…¸å‹çš„å°±æ˜¯å“ˆå¸Œè¡¨ ç¼ºç‚¹æ˜¯ï¼ŒBitmapå¯¹äºæ¯ä¸ªå…ƒç´ åªèƒ½è®°å½•1bitä¿¡æ¯ï¼Œå¦‚æœè¿˜æƒ³å®Œæˆé¢å¤–çš„åŠŸèƒ½ï¼Œææ€•åªèƒ½é ç‰ºç‰²æ›´å¤šçš„ç©ºé—´ã€æ—¶é—´æ¥å®Œæˆäº†ã€‚ å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆæ¨èï¼‰ å°±æ˜¯å¼•å…¥äº†k(k&gt;1)ä¸ªç›¸äº’ç‹¬ç«‹çš„å“ˆå¸Œå‡½æ•°ï¼Œä¿è¯åœ¨ç»™å®šçš„ç©ºé—´ã€è¯¯åˆ¤ç‡ä¸‹ï¼Œå®Œæˆå…ƒç´ åˆ¤é‡çš„è¿‡ç¨‹ã€‚ å®ƒçš„ä¼˜ç‚¹æ˜¯ç©ºé—´æ•ˆç‡å’ŒæŸ¥è¯¢æ—¶é—´éƒ½è¿œè¿œè¶…è¿‡ä¸€èˆ¬çš„ç®—æ³•ï¼Œç¼ºç‚¹æ˜¯æœ‰ä¸€å®šçš„è¯¯è¯†åˆ«ç‡å’Œåˆ é™¤å›°éš¾ã€‚ Bloom-Filterç®—æ³•çš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯åˆ©ç”¨å¤šä¸ªä¸åŒçš„Hashå‡½æ•°æ¥è§£å†³â€œå†²çªâ€ã€‚ Hashå­˜åœ¨ä¸€ä¸ªå†²çªï¼ˆç¢°æ’ï¼‰çš„é—®é¢˜ï¼Œç”¨åŒä¸€ä¸ªHashå¾—åˆ°çš„ä¸¤ä¸ªURLçš„å€¼æœ‰å¯èƒ½ç›¸åŒã€‚ä¸ºäº†å‡å°‘å†²çªï¼Œæˆ‘ä»¬å¯ä»¥å¤šå¼•å…¥å‡ ä¸ªHashï¼Œå¦‚æœé€šè¿‡å…¶ä¸­çš„ä¸€ä¸ªHashå€¼æˆ‘ä»¬å¾—å‡ºæŸå…ƒç´ ä¸åœ¨é›†åˆä¸­ï¼Œé‚£ä¹ˆè¯¥å…ƒç´ è‚¯å®šä¸åœ¨é›†åˆä¸­ã€‚åªæœ‰åœ¨æ‰€æœ‰çš„Hashå‡½æ•°å‘Šè¯‰æˆ‘ä»¬è¯¥å…ƒç´ åœ¨é›†åˆä¸­æ—¶ï¼Œæ‰èƒ½ç¡®å®šè¯¥å…ƒç´ å­˜åœ¨äºé›†åˆä¸­ã€‚è¿™ä¾¿æ˜¯Bloom-Filterçš„åŸºæœ¬æ€æƒ³ã€‚ Bloom-Filterä¸€èˆ¬ç”¨äºåœ¨å¤§æ•°æ®é‡çš„é›†åˆä¸­åˆ¤å®šæŸå…ƒç´ æ˜¯å¦å­˜åœ¨ã€‚ ç¼“å­˜å‡»ç©¿ ç¼“å­˜å‡»ç©¿æ˜¯æŒ‡ç¼“å­˜ä¸­æ²¡æœ‰ä½†æ•°æ®åº“ä¸­æœ‰çš„æ•°æ®ï¼ˆä¸€èˆ¬æ˜¯ç¼“å­˜æ—¶é—´åˆ°æœŸï¼‰ï¼Œè¿™æ—¶ç”±äºå¹¶å‘ç”¨æˆ·ç‰¹åˆ«å¤šï¼ŒåŒæ—¶è¯»ç¼“å­˜æ²¡è¯»åˆ°æ•°æ®ï¼ŒåˆåŒæ—¶å»æ•°æ®åº“å»å–æ•°æ®ï¼Œå¼•èµ·æ•°æ®åº“å‹åŠ›ç¬é—´å¢å¤§ï¼Œé€ æˆè¿‡å¤§å‹åŠ›ã€‚å’Œç¼“å­˜é›ªå´©ä¸åŒçš„æ˜¯ï¼Œç¼“å­˜å‡»ç©¿æŒ‡å¹¶å‘æŸ¥åŒä¸€æ¡æ•°æ®ï¼Œç¼“å­˜é›ªå´©æ˜¯ä¸åŒæ•°æ®éƒ½è¿‡æœŸäº†ï¼Œå¾ˆå¤šæ•°æ®éƒ½æŸ¥ä¸åˆ°ä»è€ŒæŸ¥æ•°æ®åº“ã€‚ è§£å†³æ–¹æ¡ˆ è®¾ç½®çƒ­ç‚¹æ•°æ®æ°¸è¿œä¸è¿‡æœŸã€‚ åŠ äº’æ–¥é”ï¼Œäº’æ–¥é” ç¼“å­˜é¢„çƒ­ ç¼“å­˜é¢„çƒ­å°±æ˜¯ç³»ç»Ÿä¸Šçº¿åï¼Œå°†ç›¸å…³çš„ç¼“å­˜æ•°æ®ç›´æ¥åŠ è½½åˆ°ç¼“å­˜ç³»ç»Ÿã€‚è¿™æ ·å°±å¯ä»¥é¿å…åœ¨ç”¨æˆ·è¯·æ±‚çš„æ—¶å€™ï¼Œå…ˆæŸ¥è¯¢æ•°æ®åº“ï¼Œç„¶åå†å°†æ•°æ®ç¼“å­˜çš„é—®é¢˜ï¼ç”¨æˆ·ç›´æ¥æŸ¥è¯¢äº‹å…ˆè¢«é¢„çƒ­çš„ç¼“å­˜æ•°æ®ï¼ è§£å†³æ–¹æ¡ˆ ç›´æ¥å†™ä¸ªç¼“å­˜åˆ·æ–°é¡µé¢ï¼Œä¸Šçº¿æ—¶æ‰‹å·¥æ“ä½œä¸€ä¸‹ï¼› æ•°æ®é‡ä¸å¤§ï¼Œå¯ä»¥åœ¨é¡¹ç›®å¯åŠ¨çš„æ—¶å€™è‡ªåŠ¨è¿›è¡ŒåŠ è½½ï¼› å®šæ—¶åˆ·æ–°ç¼“å­˜ï¼› ç¼“å­˜é™çº§ å½“è®¿é—®é‡å‰§å¢ã€æœåŠ¡å‡ºç°é—®é¢˜ï¼ˆå¦‚å“åº”æ—¶é—´æ…¢æˆ–ä¸å“åº”ï¼‰æˆ–éæ ¸å¿ƒæœåŠ¡å½±å“åˆ°æ ¸å¿ƒæµç¨‹çš„æ€§èƒ½æ—¶ï¼Œä»ç„¶éœ€è¦ä¿è¯æœåŠ¡è¿˜æ˜¯å¯ç”¨çš„ï¼Œå³ä½¿æ˜¯æœ‰æŸæœåŠ¡ã€‚ç³»ç»Ÿå¯ä»¥æ ¹æ®ä¸€äº›å…³é”®æ•°æ®è¿›è¡Œè‡ªåŠ¨é™çº§ï¼Œä¹Ÿå¯ä»¥é…ç½®å¼€å…³å®ç°äººå·¥é™çº§ã€‚ ç¼“å­˜é™çº§çš„æœ€ç»ˆç›®çš„æ˜¯ä¿è¯æ ¸å¿ƒæœåŠ¡å¯ç”¨ï¼Œå³ä½¿æ˜¯æœ‰æŸçš„ã€‚è€Œä¸”æœ‰äº›æœåŠ¡æ˜¯æ— æ³•é™çº§çš„ï¼ˆå¦‚åŠ å…¥è´­ç‰©è½¦ã€ç»“ç®—ï¼‰ã€‚ åœ¨è¿›è¡Œé™çº§ä¹‹å‰è¦å¯¹ç³»ç»Ÿè¿›è¡Œæ¢³ç†ï¼Œçœ‹çœ‹ç³»ç»Ÿæ˜¯ä¸æ˜¯å¯ä»¥ä¸¢å’ä¿å¸…ï¼›ä»è€Œæ¢³ç†å‡ºå“ªäº›å¿…é¡»èª“æ­»ä¿æŠ¤ï¼Œå“ªäº›å¯é™çº§ï¼›æ¯”å¦‚å¯ä»¥å‚è€ƒæ—¥å¿—çº§åˆ«è®¾ç½®é¢„æ¡ˆï¼š ä¸€èˆ¬ï¼šæ¯”å¦‚æœ‰äº›æœåŠ¡å¶å°”å› ä¸ºç½‘ç»œæŠ–åŠ¨æˆ–è€…æœåŠ¡æ­£åœ¨ä¸Šçº¿è€Œè¶…æ—¶ï¼Œå¯ä»¥è‡ªåŠ¨é™çº§ï¼› è­¦å‘Šï¼šæœ‰äº›æœåŠ¡åœ¨ä¸€æ®µæ—¶é—´å†…æˆåŠŸç‡æœ‰æ³¢åŠ¨ï¼ˆå¦‚åœ¨95~100%ä¹‹é—´ï¼‰ï¼Œå¯ä»¥è‡ªåŠ¨é™çº§æˆ–äººå·¥é™çº§ï¼Œå¹¶å‘é€å‘Šè­¦ï¼› é”™è¯¯ï¼šæ¯”å¦‚å¯ç”¨ç‡ä½äº90%ï¼Œæˆ–è€…æ•°æ®åº“è¿æ¥æ± è¢«æ‰“çˆ†äº†ï¼Œæˆ–è€…è®¿é—®é‡çªç„¶çŒ›å¢åˆ°ç³»ç»Ÿèƒ½æ‰¿å—çš„æœ€å¤§é˜€å€¼ï¼Œæ­¤æ—¶å¯ä»¥æ ¹æ®æƒ…å†µè‡ªåŠ¨é™çº§æˆ–è€…äººå·¥é™çº§ï¼› ä¸¥é‡é”™è¯¯ï¼šæ¯”å¦‚å› ä¸ºç‰¹æ®ŠåŸå› æ•°æ®é”™è¯¯äº†ï¼Œæ­¤æ—¶éœ€è¦ç´§æ€¥äººå·¥é™çº§ã€‚ æœåŠ¡é™çº§çš„ç›®çš„ï¼Œæ˜¯ä¸ºäº†é˜²æ­¢RedisæœåŠ¡æ•…éšœï¼Œå¯¼è‡´æ•°æ®åº“è·Ÿç€ä¸€èµ·å‘ç”Ÿé›ªå´©é—®é¢˜ã€‚å› æ­¤ï¼Œå¯¹äºä¸é‡è¦çš„ç¼“å­˜æ•°æ®ï¼Œå¯ä»¥é‡‡å–æœåŠ¡é™çº§ç­–ç•¥ï¼Œä¾‹å¦‚ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„åšæ³•å°±æ˜¯ï¼ŒRediså‡ºç°é—®é¢˜ï¼Œä¸å»æ•°æ®åº“æŸ¥è¯¢ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›é»˜è®¤å€¼ç»™ç”¨æˆ·ã€‚ çƒ­ç‚¹æ•°æ®å’Œå†·æ•°æ® çƒ­ç‚¹æ•°æ®ï¼Œç¼“å­˜æ‰æœ‰ä»·å€¼ å¯¹äºå†·æ•°æ®è€Œè¨€ï¼Œå¤§éƒ¨åˆ†æ•°æ®å¯èƒ½è¿˜æ²¡æœ‰å†æ¬¡è®¿é—®åˆ°å°±å·²ç»è¢«æŒ¤å‡ºå†…å­˜ï¼Œä¸ä»…å ç”¨å†…å­˜ï¼Œè€Œä¸”ä»·å€¼ä¸å¤§ã€‚é¢‘ç¹ä¿®æ”¹çš„æ•°æ®ï¼Œçœ‹æƒ…å†µè€ƒè™‘ä½¿ç”¨ç¼“å­˜ å¯¹äºçƒ­ç‚¹æ•°æ®ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„æŸIMäº§å“ï¼Œç”Ÿæ—¥ç¥ç¦æ¨¡å—ï¼Œå½“å¤©çš„å¯¿æ˜Ÿåˆ—è¡¨ï¼Œç¼“å­˜ä»¥åå¯èƒ½è¯»å–æ•°åä¸‡æ¬¡ã€‚å†ä¸¾ä¸ªä¾‹å­ï¼ŒæŸå¯¼èˆªäº§å“ï¼Œæˆ‘ä»¬å°†å¯¼èˆªä¿¡æ¯ï¼Œç¼“å­˜ä»¥åå¯èƒ½è¯»å–æ•°ç™¾ä¸‡æ¬¡ã€‚ æ•°æ®æ›´æ–°å‰è‡³å°‘è¯»å–ä¸¤æ¬¡ï¼Œç¼“å­˜æ‰æœ‰æ„ä¹‰ã€‚è¿™ä¸ªæ˜¯æœ€åŸºæœ¬çš„ç­–ç•¥ï¼Œå¦‚æœç¼“å­˜è¿˜æ²¡æœ‰èµ·ä½œç”¨å°±å¤±æ•ˆäº†ï¼Œé‚£å°±æ²¡æœ‰å¤ªå¤§ä»·å€¼äº†ã€‚ é‚£å­˜ä¸å­˜åœ¨ï¼Œä¿®æ”¹é¢‘ç‡å¾ˆé«˜ï¼Œä½†æ˜¯åˆä¸å¾—ä¸è€ƒè™‘ç¼“å­˜çš„åœºæ™¯å‘¢ï¼Ÿæœ‰ï¼æ¯”å¦‚ï¼Œè¿™ä¸ªè¯»å–æ¥å£å¯¹æ•°æ®åº“çš„å‹åŠ›å¾ˆå¤§ï¼Œä½†æ˜¯åˆæ˜¯çƒ­ç‚¹æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦è€ƒè™‘é€šè¿‡ç¼“å­˜æ‰‹æ®µï¼Œå‡å°‘æ•°æ®åº“çš„å‹åŠ›ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„æŸåŠ©æ‰‹äº§å“çš„ï¼Œç‚¹èµæ•°ï¼Œæ”¶è—æ•°ï¼Œåˆ†äº«æ•°ç­‰æ˜¯éå¸¸å…¸å‹çš„çƒ­ç‚¹æ•°æ®ï¼Œä½†æ˜¯åˆä¸æ–­å˜åŒ–ï¼Œæ­¤æ—¶å°±éœ€è¦å°†æ•°æ®åŒæ­¥ä¿å­˜åˆ°Redisç¼“å­˜ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›ã€‚ ç¼“å­˜çƒ­ç‚¹key ç¼“å­˜ä¸­çš„ä¸€ä¸ªKey(æ¯”å¦‚ä¸€ä¸ªä¿ƒé”€å•†å“)ï¼Œåœ¨æŸä¸ªæ—¶é—´ç‚¹è¿‡æœŸçš„æ—¶å€™ï¼Œæ°å¥½åœ¨è¿™ä¸ªæ—¶é—´ç‚¹å¯¹è¿™ä¸ªKeyæœ‰å¤§é‡çš„å¹¶å‘è¯·æ±‚è¿‡æ¥ï¼Œè¿™äº›è¯·æ±‚å‘ç°ç¼“å­˜è¿‡æœŸä¸€èˆ¬éƒ½ä¼šä»åç«¯DBåŠ è½½æ•°æ®å¹¶å›è®¾åˆ°ç¼“å­˜ï¼Œè¿™ä¸ªæ—¶å€™å¤§å¹¶å‘çš„è¯·æ±‚å¯èƒ½ä¼šç¬é—´æŠŠåç«¯DBå‹å®ã€‚ è§£å†³æ–¹æ¡ˆ å¯¹ç¼“å­˜æŸ¥è¯¢åŠ é”ï¼Œå¦‚æœKEYä¸å­˜åœ¨ï¼Œå°±åŠ é”ï¼Œç„¶åæŸ¥DBå…¥ç¼“å­˜ï¼Œç„¶åè§£é”ï¼›å…¶ä»–è¿›ç¨‹å¦‚æœå‘ç°æœ‰é”å°±ç­‰å¾…ï¼Œç„¶åç­‰è§£é”åè¿”å›æ•°æ®æˆ–è€…è¿›å…¥DBæŸ¥è¯¢ å¸¸ç”¨å·¥å…· Redisæ”¯æŒçš„Javaå®¢æˆ·ç«¯éƒ½æœ‰å“ªäº›ï¼Ÿå®˜æ–¹æ¨èç”¨å“ªä¸ªï¼Ÿ Redissonã€Jedisã€lettuceç­‰ç­‰ï¼Œå®˜æ–¹æ¨èä½¿ç”¨Redissonã€‚ Rediså’ŒRedissonæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ Redissonæ˜¯ä¸€ä¸ªé«˜çº§çš„åˆ†å¸ƒå¼åè°ƒRediså®¢æœç«¯ï¼Œèƒ½å¸®åŠ©ç”¨æˆ·åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­è½»æ¾å®ç°ä¸€äº›Javaçš„å¯¹è±¡ (Bloom filter, BitSet, Set, SetMultimap, ScoredSortedSet, SortedSet, Map, ConcurrentMap, List, ListMultimap, Queue, BlockingQueue, Deque, BlockingDeque, Semaphore, Lock, ReadWriteLock, AtomicLong, CountDownLatch, Publish / Subscribe, HyperLogLog)ã€‚ Jedisä¸Redissonå¯¹æ¯”æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ Jedisæ˜¯Redisçš„Javaå®ç°çš„å®¢æˆ·ç«¯ï¼Œå…¶APIæä¾›äº†æ¯”è¾ƒå…¨é¢çš„Rediså‘½ä»¤çš„æ”¯æŒï¼›Redissonå®ç°äº†åˆ†å¸ƒå¼å’Œå¯æ‰©å±•çš„Javaæ•°æ®ç»“æ„ï¼Œå’ŒJedisç›¸æ¯”ï¼ŒåŠŸèƒ½è¾ƒä¸ºç®€å•ï¼Œä¸æ”¯æŒå­—ç¬¦ä¸²æ“ä½œï¼Œä¸æ”¯æŒæ’åºã€äº‹åŠ¡ã€ç®¡é“ã€åˆ†åŒºç­‰Redisç‰¹æ€§ã€‚Redissonçš„å®—æ—¨æ˜¯ä¿ƒè¿›ä½¿ç”¨è€…å¯¹Redisçš„å…³æ³¨åˆ†ç¦»ï¼Œä»è€Œè®©ä½¿ç”¨è€…èƒ½å¤Ÿå°†ç²¾åŠ›æ›´é›†ä¸­åœ°æ”¾åœ¨å¤„ç†ä¸šåŠ¡é€»è¾‘ä¸Šã€‚ Redissonå®ç°åˆ†å¸ƒå¼é” package com.example.redisstudy.template; import org.redisson.Redisson; import org.redisson.api.RLock; import org.redisson.api.RedissonClient; import org.redisson.config.Config; import org.springframework.beans.factory.annotation.Value; import org.springframework.stereotype.Component; /** * @author wuhao * @desc ... * @date 2020-12-09 14:57:30 */ @Component public class RedissonLock { @Value(&quot;${spring.redis.address}&quot;) public String address; public RLock lock(){ Config config = new Config(); config.useSingleServer().setAddress(address); // config.useSingleServer().setPassword(&quot;redis1234&quot;); final RedissonClient client = Redisson.create(config); RLock lock = client.getLock(&quot;redis:lock&quot;); return lock; } } å¦‚ä½•ä¿è¯ç¼“å­˜ä¸æ•°æ®åº“åŒå†™æ—¶çš„æ•°æ®ä¸€è‡´æ€§ï¼Ÿ ä½ åªè¦ç”¨ç¼“å­˜ï¼Œå°±å¯èƒ½ä¼šæ¶‰åŠåˆ°ç¼“å­˜ä¸æ•°æ®åº“åŒå­˜å‚¨åŒå†™ï¼Œä½ åªè¦æ˜¯åŒå†™ï¼Œå°±ä¸€å®šä¼šæœ‰æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œé‚£ä¹ˆä½ å¦‚ä½•è§£å†³ä¸€è‡´æ€§é—®é¢˜ï¼Ÿ ä¸€èˆ¬æ¥è¯´ï¼Œå°±æ˜¯å¦‚æœä½ çš„ç³»ç»Ÿä¸æ˜¯ä¸¥æ ¼è¦æ±‚ç¼“å­˜+æ•°æ®åº“å¿…é¡»ä¸€è‡´æ€§çš„è¯ï¼Œç¼“å­˜å¯ä»¥ç¨å¾®çš„è·Ÿæ•°æ®åº“å¶å°”æœ‰ä¸ä¸€è‡´çš„æƒ…å†µï¼Œæœ€å¥½ä¸è¦åšè¿™ä¸ªæ–¹æ¡ˆï¼Œè¯»è¯·æ±‚å’Œå†™è¯·æ±‚ä¸²è¡ŒåŒ–ï¼Œä¸²åˆ°ä¸€ä¸ªå†…å­˜é˜Ÿåˆ—é‡Œå»ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯ä¸€å®šä¸ä¼šå‡ºç°ä¸ä¸€è‡´çš„æƒ…å†µ ä¸²è¡ŒåŒ–ä¹‹åï¼Œå°±ä¼šå¯¼è‡´ç³»ç»Ÿçš„ååé‡ä¼šå¤§å¹…åº¦çš„é™ä½ï¼Œç”¨æ¯”æ­£å¸¸æƒ…å†µä¸‹å¤šå‡ å€çš„æœºå™¨å»æ”¯æ’‘çº¿ä¸Šçš„ä¸€ä¸ªè¯·æ±‚ã€‚ è¿˜æœ‰ä¸€ç§æ–¹å¼å°±æ˜¯å¯èƒ½ä¼šæš‚æ—¶äº§ç”Ÿä¸ä¸€è‡´çš„æƒ…å†µï¼Œä½†æ˜¯å‘ç”Ÿçš„å‡ ç‡ç‰¹åˆ«å°ï¼Œå°±æ˜¯å…ˆæ›´æ–°æ•°æ®åº“ï¼Œç„¶åå†åˆ é™¤ç¼“å­˜ã€‚ é—®é¢˜åœºæ™¯ æè¿° è§£å†³ å…ˆå†™ç¼“å­˜ï¼Œå†å†™æ•°æ®åº“ï¼Œç¼“å­˜å†™æˆåŠŸï¼Œæ•°æ®åº“å†™å¤±è´¥ ç¼“å­˜å†™æˆåŠŸï¼Œä½†å†™æ•°æ®åº“å¤±è´¥æˆ–è€…å“åº”å»¶è¿Ÿï¼Œåˆ™ä¸‹æ¬¡è¯»å–ï¼ˆå¹¶å‘è¯»ï¼‰ç¼“å­˜æ—¶ï¼Œå°±å‡ºç°è„è¯» è¿™ä¸ªå†™ç¼“å­˜çš„æ–¹å¼ï¼Œæœ¬èº«å°±æ˜¯é”™è¯¯çš„ï¼Œéœ€è¦æ”¹ä¸ºå…ˆå†™æ•°æ®åº“ï¼ŒæŠŠæ—§ç¼“å­˜ç½®ä¸ºå¤±æ•ˆï¼›è¯»å–æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœç¼“å­˜ä¸å­˜åœ¨ï¼Œåˆ™è¯»å–æ•°æ®åº“å†å†™ç¼“å­˜ å…ˆå†™æ•°æ®åº“ï¼Œå†å†™ç¼“å­˜ï¼Œæ•°æ®åº“å†™æˆåŠŸï¼Œç¼“å­˜å†™å¤±è´¥ å†™æ•°æ®åº“æˆåŠŸï¼Œä½†å†™ç¼“å­˜å¤±è´¥ï¼Œåˆ™ä¸‹æ¬¡è¯»å–ï¼ˆå¹¶å‘è¯»ï¼‰ç¼“å­˜æ—¶ï¼Œåˆ™è¯»ä¸åˆ°æ•°æ® ç¼“å­˜ä½¿ç”¨æ—¶ï¼Œå‡å¦‚è¯»ç¼“å­˜å¤±è´¥ï¼Œå…ˆè¯»æ•°æ®åº“ï¼Œå†å›å†™ç¼“å­˜çš„æ–¹å¼å®ç° éœ€è¦ç¼“å­˜å¼‚æ­¥åˆ·æ–° æŒ‡æ•°æ®åº“æ“ä½œå’Œå†™ç¼“å­˜ä¸åœ¨ä¸€ä¸ªæ“ä½œæ­¥éª¤ä¸­ï¼Œæ¯”å¦‚åœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹ï¼Œæ— æ³•åšåˆ°åŒæ—¶å†™ç¼“å­˜æˆ–éœ€è¦å¼‚æ­¥åˆ·æ–°ï¼ˆè¡¥æ•‘æªæ–½ï¼‰æ—¶å€™ ç¡®å®šå“ªäº›æ•°æ®é€‚åˆæ­¤ç±»åœºæ™¯ï¼Œæ ¹æ®ç»éªŒå€¼ç¡®å®šåˆç†çš„æ•°æ®ä¸ä¸€è‡´æ—¶é—´ï¼Œç”¨æˆ·æ•°æ®åˆ·æ–°çš„æ—¶é—´é—´éš” Rediså¸¸è§æ€§èƒ½é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆï¼Ÿ Masteræœ€å¥½ä¸è¦åšä»»ä½•æŒä¹…åŒ–å·¥ä½œï¼ŒåŒ…æ‹¬å†…å­˜å¿«ç…§å’ŒAOFæ—¥å¿—æ–‡ä»¶ï¼Œç‰¹åˆ«æ˜¯ä¸è¦å¯ç”¨å†…å­˜å¿«ç…§åšæŒä¹…åŒ–ã€‚å¦‚æœé‡‡ç”¨äº†ä¸»ä»æ¶æ„ï¼Œé‚£ä¹ˆå»ºè®®å¿…é¡»å¼€å¯ master node çš„æŒä¹…åŒ–ï¼Œä¸å»ºè®®ç”¨ slave node ä½œä¸º master node çš„æ•°æ®çƒ­å¤‡ï¼Œå› ä¸ºé‚£æ ·çš„è¯ï¼Œå¦‚æœä½ å…³æ‰ master çš„æŒä¹…åŒ–ï¼Œå¯èƒ½åœ¨ master å®•æœºé‡å¯çš„æ—¶å€™æ•°æ®æ˜¯ç©ºçš„ï¼Œç„¶åå¯èƒ½ä¸€ç»è¿‡å¤åˆ¶ï¼Œ slave node çš„æ•°æ®ä¹Ÿä¸¢äº†ã€‚å¦å¤–ï¼Œmaster çš„å„ç§å¤‡ä»½æ–¹æ¡ˆï¼Œä¹Ÿéœ€è¦åšã€‚ä¸‡ä¸€æœ¬åœ°çš„æ‰€æœ‰æ–‡ä»¶ä¸¢å¤±äº†ï¼Œä»å¤‡ä»½ä¸­æŒ‘é€‰ä¸€ä»½ rdb å»æ¢å¤ masterï¼Œè¿™æ ·æ‰èƒ½ç¡®ä¿å¯åŠ¨çš„æ—¶å€™ï¼Œæ˜¯æœ‰æ•°æ®çš„ï¼Œå³ä½¿é‡‡ç”¨äº†åç»­è®²è§£çš„é«˜å¯ç”¨æœºåˆ¶ï¼Œslave node å¯ä»¥è‡ªåŠ¨æ¥ç®¡ master nodeï¼Œä½†ä¹Ÿå¯èƒ½ sentinel è¿˜æ²¡æ£€æµ‹åˆ° master failureï¼Œmaster node å°±è‡ªåŠ¨é‡å¯äº†ï¼Œè¿˜æ˜¯å¯èƒ½å¯¼è‡´ä¸Šé¢æ‰€æœ‰çš„ slave node æ•°æ®è¢«æ¸…ç©ºã€‚ å¦‚æœæ•°æ®æ¯”è¾ƒå…³é”®ï¼ŒæŸä¸ªSlaveå¼€å¯AOFå¤‡ä»½æ•°æ®ï¼Œç­–ç•¥ä¸ºæ¯ç§’åŒæ­¥ä¸€æ¬¡ã€‚ ä¸ºäº†ä¸»ä»å¤åˆ¶çš„é€Ÿåº¦å’Œè¿æ¥çš„ç¨³å®šæ€§ï¼ŒSlaveå’ŒMasteræœ€å¥½åœ¨åŒä¸€ä¸ªå±€åŸŸç½‘å†…ã€‚ å°½é‡é¿å…åœ¨å‹åŠ›è¾ƒå¤§çš„ä¸»åº“ä¸Šå¢åŠ ä»åº“ Masterè°ƒç”¨BGREWRITEAOFé‡å†™AOFæ–‡ä»¶ï¼ŒAOFåœ¨é‡å†™çš„æ—¶å€™ä¼šå å¤§é‡çš„CPUå’Œå†…å­˜èµ„æºï¼Œå¯¼è‡´æœåŠ¡loadè¿‡é«˜ï¼Œå‡ºç°çŸ­æš‚æœåŠ¡æš‚åœç°è±¡ã€‚ ä¸ºäº†Masterçš„ç¨³å®šæ€§ï¼Œä¸»ä»å¤åˆ¶ä¸è¦ç”¨å›¾çŠ¶ç»“æ„ï¼Œç”¨å•å‘é“¾è¡¨ç»“æ„æ›´ç¨³å®šï¼Œå³ä¸»ä»å…³ç³»ä¸ºï¼šMaster&lt;â€“Slave1&lt;â€“Slave2&lt;â€“Slave3â€¦ï¼Œè¿™æ ·çš„ç»“æ„ä¹Ÿæ–¹ä¾¿è§£å†³å•ç‚¹æ•…éšœé—®é¢˜ï¼Œå®ç°Slaveå¯¹Masterçš„æ›¿æ¢ï¼Œä¹Ÿå³ï¼Œå¦‚æœMasteræŒ‚äº†ï¼Œå¯ä»¥ç«‹é©¬å¯ç”¨Slave1åšMasterï¼Œå…¶ä»–ä¸å˜ã€‚ ","link":"https://tianxiawuhao.github.io/Sjb64Uy0k/"},{"title":"redisæ¦‚è¿°å››","content":"é›†ç¾¤æ–¹æ¡ˆ 1ï¼ŒRedis ä¸»ä»æ¶æ„ å•æœºçš„ redisï¼Œèƒ½å¤Ÿæ‰¿è½½çš„ QPS å¤§æ¦‚å°±åœ¨ä¸Šä¸‡åˆ°å‡ ä¸‡ä¸ç­‰ã€‚å¯¹äºç¼“å­˜æ¥è¯´ï¼Œä¸€èˆ¬éƒ½æ˜¯ç”¨æ¥æ”¯æ’‘è¯»é«˜å¹¶å‘çš„ã€‚å› æ­¤æ¶æ„åšæˆä¸»ä»(master-slave)æ¶æ„ï¼Œä¸€ä¸»å¤šä»ï¼Œä¸»è´Ÿè´£å†™ï¼Œå¹¶ä¸”å°†æ•°æ®å¤åˆ¶åˆ°å…¶å®ƒçš„ slave èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹è´Ÿè´£è¯»ã€‚æ‰€æœ‰çš„è¯»è¯·æ±‚å…¨éƒ¨èµ°ä»èŠ‚ç‚¹ã€‚è¿™æ ·ä¹Ÿå¯ä»¥å¾ˆè½»æ¾å®ç°æ°´å¹³æ‰©å®¹ï¼Œæ”¯æ’‘è¯»é«˜å¹¶å‘ã€‚ redis replication -&gt; ä¸»ä»æ¶æ„ -&gt; è¯»å†™åˆ†ç¦» -&gt; æ°´å¹³æ‰©å®¹æ”¯æ’‘è¯»é«˜å¹¶å‘ redis replication çš„æ ¸å¿ƒæœºåˆ¶ redis é‡‡ç”¨å¼‚æ­¥æ–¹å¼å¤åˆ¶æ•°æ®åˆ° slave èŠ‚ç‚¹ï¼Œä¸è¿‡ redis2.8 å¼€å§‹ï¼Œslave node ä¼šå‘¨æœŸæ€§åœ°ç¡®è®¤è‡ªå·±æ¯æ¬¡å¤åˆ¶çš„æ•°æ®é‡ï¼› ä¸€ä¸ª master node æ˜¯å¯ä»¥é…ç½®å¤šä¸ª slave node çš„ï¼› slave node ä¹Ÿå¯ä»¥è¿æ¥å…¶ä»–çš„ slave nodeï¼› slave node åšå¤åˆ¶çš„æ—¶å€™ï¼Œä¸ä¼š block master node çš„æ­£å¸¸å·¥ä½œï¼› slave node åœ¨åšå¤åˆ¶çš„æ—¶å€™ï¼Œä¹Ÿä¸ä¼š block å¯¹è‡ªå·±çš„æŸ¥è¯¢æ“ä½œï¼Œå®ƒä¼šç”¨æ—§çš„æ•°æ®é›†æ¥æä¾›æœåŠ¡ï¼›ä½†æ˜¯å¤åˆ¶å®Œæˆçš„æ—¶å€™ï¼Œéœ€è¦åˆ é™¤æ—§æ•°æ®é›†ï¼ŒåŠ è½½æ–°æ•°æ®é›†ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šæš‚åœå¯¹å¤–æœåŠ¡äº†ï¼› slave node ä¸»è¦ç”¨æ¥è¿›è¡Œæ¨ªå‘æ‰©å®¹ï¼Œåšè¯»å†™åˆ†ç¦»ï¼Œæ‰©å®¹çš„ slave node å¯ä»¥æé«˜è¯»çš„ååé‡ã€‚ æ³¨æ„ï¼Œå¦‚æœé‡‡ç”¨äº†ä¸»ä»æ¶æ„ï¼Œé‚£ä¹ˆå»ºè®®å¿…é¡»å¼€å¯ master node çš„æŒä¹…åŒ–ï¼Œä¸å»ºè®®ç”¨ slave node ä½œä¸º master node çš„æ•°æ®çƒ­å¤‡ï¼Œå› ä¸ºé‚£æ ·çš„è¯ï¼Œå¦‚æœä½ å…³æ‰ master çš„æŒä¹…åŒ–ï¼Œå¯èƒ½åœ¨ master å®•æœºé‡å¯çš„æ—¶å€™æ•°æ®æ˜¯ç©ºçš„ï¼Œç„¶åå¯èƒ½ä¸€ç»è¿‡å¤åˆ¶ï¼Œ slave node çš„æ•°æ®ä¹Ÿä¸¢äº†ã€‚ å¦å¤–ï¼Œmaster çš„å„ç§å¤‡ä»½æ–¹æ¡ˆï¼Œä¹Ÿéœ€è¦åšã€‚ä¸‡ä¸€æœ¬åœ°çš„æ‰€æœ‰æ–‡ä»¶ä¸¢å¤±äº†ï¼Œä»å¤‡ä»½ä¸­æŒ‘é€‰ä¸€ä»½ rdb å»æ¢å¤ masterï¼Œè¿™æ ·æ‰èƒ½ç¡®ä¿å¯åŠ¨çš„æ—¶å€™ï¼Œæ˜¯æœ‰æ•°æ®çš„ï¼Œå³ä½¿é‡‡ç”¨äº†åç»­è®²è§£çš„é«˜å¯ç”¨æœºåˆ¶ï¼Œslave node å¯ä»¥è‡ªåŠ¨æ¥ç®¡ master nodeï¼Œä½†ä¹Ÿå¯èƒ½ sentinel è¿˜æ²¡æ£€æµ‹åˆ° master failureï¼Œmaster node å°±è‡ªåŠ¨é‡å¯äº†ï¼Œè¿˜æ˜¯å¯èƒ½å¯¼è‡´ä¸Šé¢æ‰€æœ‰çš„ slave node æ•°æ®è¢«æ¸…ç©ºã€‚ redis ä¸»ä»å¤åˆ¶çš„æ ¸å¿ƒåŸç† å½“å¯åŠ¨ä¸€ä¸ª slave node çš„æ—¶å€™ï¼Œå®ƒä¼šå‘é€ä¸€ä¸ª PSYNC å‘½ä»¤ç»™ master nodeã€‚ å¦‚æœè¿™æ˜¯ slave node åˆæ¬¡è¿æ¥åˆ° master nodeï¼Œé‚£ä¹ˆä¼šè§¦å‘ä¸€æ¬¡ full resynchronization å…¨é‡å¤åˆ¶ã€‚æ­¤æ—¶ master ä¼šå¯åŠ¨ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œå¼€å§‹ç”Ÿæˆä¸€ä»½ RDB å¿«ç…§æ–‡ä»¶ï¼Œ åŒæ—¶è¿˜ä¼šå°†ä»å®¢æˆ·ç«¯ client æ–°æ”¶åˆ°çš„æ‰€æœ‰å†™å‘½ä»¤ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚RDB æ–‡ä»¶ç”Ÿæˆå®Œæ¯•åï¼Œ master ä¼šå°†è¿™ä¸ª RDB å‘é€ç»™ slaveï¼Œslave ä¼šå…ˆå†™å…¥æœ¬åœ°ç£ç›˜ï¼Œç„¶åå†ä»æœ¬åœ°ç£ç›˜åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œ æ¥ç€ master ä¼šå°†å†…å­˜ä¸­ç¼“å­˜çš„å†™å‘½ä»¤å‘é€åˆ° slaveï¼Œslave ä¹Ÿä¼šåŒæ­¥è¿™äº›æ•°æ®ã€‚ slave node å¦‚æœè·Ÿ master node æœ‰ç½‘ç»œæ•…éšœï¼Œæ–­å¼€äº†è¿æ¥ï¼Œä¼šè‡ªåŠ¨é‡è¿ï¼Œè¿æ¥ä¹‹å master node ä»…ä¼šå¤åˆ¶ç»™ slave éƒ¨åˆ†ç¼ºå°‘çš„æ•°æ®ã€‚ è¿‡ç¨‹åŸç† å½“ä»åº“å’Œä¸»åº“å»ºç«‹MSå…³ç³»åï¼Œä¼šå‘ä¸»æ•°æ®åº“å‘é€SYNCå‘½ä»¤ ä¸»åº“æ¥æ”¶åˆ°SYNCå‘½ä»¤åä¼šå¼€å§‹åœ¨åå°ä¿å­˜å¿«ç…§(RDBæŒä¹…åŒ–è¿‡ç¨‹)ï¼Œå¹¶å°†æœŸé—´æ¥æ”¶åˆ°çš„å†™å‘½ä»¤ç¼“å­˜èµ·æ¥ å½“å¿«ç…§å®Œæˆåï¼Œä¸»Redisä¼šå°†å¿«ç…§æ–‡ä»¶å’Œæ‰€æœ‰ç¼“å­˜çš„å†™å‘½ä»¤å‘é€ç»™ä»Redis ä»Redisæ¥æ”¶åˆ°åï¼Œä¼šè½½å…¥å¿«ç…§æ–‡ä»¶å¹¶ä¸”æ‰§è¡Œæ”¶åˆ°çš„ç¼“å­˜çš„å‘½ä»¤ ä¹‹åï¼Œä¸»Redisæ¯å½“æ¥æ”¶åˆ°å†™å‘½ä»¤æ—¶å°±ä¼šå°†å‘½ä»¤å‘é€ä»Redisï¼Œä»è€Œä¿è¯æ•°æ®çš„ä¸€è‡´ ç¼ºç‚¹ æ‰€æœ‰çš„slaveèŠ‚ç‚¹æ•°æ®çš„å¤åˆ¶å’ŒåŒæ­¥éƒ½ç”±masterèŠ‚ç‚¹æ¥å¤„ç†ï¼Œä¼šç…§æˆmasterèŠ‚ç‚¹å‹åŠ›å¤ªå¤§ï¼Œä½¿ç”¨ä¸»ä»ä»ç»“æ„æ¥è§£å†³ 2ï¼Œå“¨å…µæ¨¡å¼ å“¨å…µçš„ä»‹ç» sentinelï¼Œä¸­æ–‡åæ˜¯å“¨å…µã€‚å“¨å…µæ˜¯ redis é›†ç¾¤æœºæ„ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªç»„ä»¶ï¼Œä¸»è¦æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š é›†ç¾¤ç›‘æ§ï¼šè´Ÿè´£ç›‘æ§ redis master å’Œ slave è¿›ç¨‹æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚ æ¶ˆæ¯é€šçŸ¥ï¼šå¦‚æœæŸä¸ª redis å®ä¾‹æœ‰æ•…éšœï¼Œé‚£ä¹ˆå“¨å…µè´Ÿè´£å‘é€æ¶ˆæ¯ä½œä¸ºæŠ¥è­¦é€šçŸ¥ç»™ç®¡ç†å‘˜ã€‚ æ•…éšœè½¬ç§»ï¼šå¦‚æœ master node æŒ‚æ‰äº†ï¼Œä¼šè‡ªåŠ¨è½¬ç§»åˆ° slave node ä¸Šã€‚ é…ç½®ä¸­å¿ƒï¼šå¦‚æœæ•…éšœè½¬ç§»å‘ç”Ÿäº†ï¼Œé€šçŸ¥ client å®¢æˆ·ç«¯æ–°çš„ master åœ°å€ã€‚ å“¨å…µç”¨äºå®ç° redis é›†ç¾¤çš„é«˜å¯ç”¨ï¼Œæœ¬èº«ä¹Ÿæ˜¯åˆ†å¸ƒå¼çš„ï¼Œä½œä¸ºä¸€ä¸ªå“¨å…µé›†ç¾¤å»è¿è¡Œï¼Œäº’ç›¸ååŒå·¥ä½œã€‚ æ•…éšœè½¬ç§»æ—¶ï¼Œåˆ¤æ–­ä¸€ä¸ª master node æ˜¯å¦å®•æœºäº†ï¼Œéœ€è¦å¤§éƒ¨åˆ†çš„å“¨å…µéƒ½åŒæ„æ‰è¡Œï¼Œæ¶‰åŠåˆ°äº†åˆ†å¸ƒå¼é€‰ä¸¾çš„é—®é¢˜ã€‚ å³ä½¿éƒ¨åˆ†å“¨å…µèŠ‚ç‚¹æŒ‚æ‰äº†ï¼Œå“¨å…µé›†ç¾¤è¿˜æ˜¯èƒ½æ­£å¸¸å·¥ä½œçš„ï¼Œå› ä¸ºå¦‚æœä¸€ä¸ªä½œä¸ºé«˜å¯ç”¨æœºåˆ¶é‡è¦ç»„æˆéƒ¨åˆ†çš„æ•…éšœè½¬ç§»ç³»ç»Ÿæœ¬èº«æ˜¯å•ç‚¹çš„ï¼Œé‚£å°±å¾ˆå‘çˆ¹äº†ã€‚ å“¨å…µçš„æ ¸å¿ƒçŸ¥è¯† å“¨å…µè‡³å°‘éœ€è¦ 3 ä¸ªå®ä¾‹ï¼Œæ¥ä¿è¯è‡ªå·±çš„å¥å£®æ€§ã€‚ å“¨å…µ + redis ä¸»ä»çš„éƒ¨ç½²æ¶æ„ï¼Œæ˜¯ä¸ä¿è¯æ•°æ®é›¶ä¸¢å¤±çš„ï¼Œåªèƒ½ä¿è¯ redis é›†ç¾¤çš„é«˜å¯ç”¨æ€§ã€‚ å¯¹äºå“¨å…µ + redis ä¸»ä»è¿™ç§å¤æ‚çš„éƒ¨ç½²æ¶æ„ï¼Œå°½é‡åœ¨æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒï¼Œéƒ½è¿›è¡Œå……è¶³çš„æµ‹è¯•å’Œæ¼”ç»ƒã€‚ åˆ†å¸ƒå¼å’Œå“¨å…µ Redisä¸»ä»å¤åˆ¶æ¨¡å¼ä¸‹ï¼Œ ä¸€æ—¦ä¸»èŠ‚ç‚¹å‡ºç°äº†æ•…éšœä¸å¯è¾¾ï¼Œ éœ€è¦äººå·¥å¹²é¢„è¿›è¡Œæ•…éšœè½¬ç§»ï¼Œ æ— è®ºå¯¹äºRedisçš„åº”ç”¨æ–¹è¿˜æ˜¯è¿ç»´æ–¹éƒ½å¸¦æ¥äº†å¾ˆå¤§çš„ä¸ä¾¿ã€‚å¯¹äºåº”ç”¨æ–¹æ¥è¯´æ— æ³•åŠæ—¶æ„ŸçŸ¥åˆ°ä¸»èŠ‚ç‚¹çš„å˜åŒ–ï¼Œ å¿…ç„¶ä¼šé€ æˆä¸€å®šçš„å†™æ•°æ®ä¸¢å¤±å’Œè¯»æ•°æ®é”™è¯¯ï¼Œ ç”šè‡³å¯èƒ½é€ æˆåº”ç”¨æ–¹æœåŠ¡ä¸å¯ç”¨ã€‚ å¯¹äºRedisçš„è¿ç»´æ–¹æ¥è¯´ï¼Œ æ•´ä¸ªæ•…éšœè½¬ç§»çš„è¿‡ç¨‹æ˜¯éœ€è¦äººå·¥æ¥ä»‹å…¥çš„ï¼Œ æ•…éšœè½¬ç§»å®æ—¶æ€§å’Œå‡†ç¡®æ€§ä¸Šéƒ½æ— æ³•å¾—åˆ°ä¿éšœã€‚è€ƒè™‘åˆ°è¿™ç‚¹ï¼Œ æœ‰äº›å…¬å¸æŠŠä¸Šè¿°æµç¨‹è‡ªåŠ¨åŒ–äº†ï¼Œ ä½†æ˜¯ä»ç„¶å­˜åœ¨å¦‚ä¸‹é—®é¢˜ï¼š ç¬¬ä¸€ï¼Œ åˆ¤æ–­èŠ‚ç‚¹ä¸å¯è¾¾çš„æœºåˆ¶æ˜¯å¦å¥å…¨å’Œæ ‡å‡†ã€‚ ç¬¬äºŒï¼Œ å¦‚æœæœ‰å¤šä¸ªä»èŠ‚ç‚¹ï¼Œ æ€æ ·ä¿è¯åªæœ‰ä¸€ä¸ªè¢«æ™‹å‡ä¸ºä¸»èŠ‚ç‚¹ã€‚ ç¬¬ä¸‰ï¼Œé€šçŸ¥å®¢æˆ·ç«¯æ–°çš„ä¸»èŠ‚ç‚¹æœºåˆ¶æ˜¯å¦è¶³å¤Ÿå¥å£®ã€‚ Redis Sentinelæ­£æ˜¯ç”¨äºè§£å†³è¿™äº›é—®é¢˜ Redis Sentinelæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ¶æ„ï¼Œ å…¶ä¸­åŒ…å«è‹¥å¹²ä¸ªSentinelèŠ‚ç‚¹å’ŒRedisæ•°æ®èŠ‚ç‚¹ï¼Œ æ¯ä¸ªSentinelèŠ‚ç‚¹ä¼šå¯¹æ•°æ®èŠ‚ç‚¹å’Œå…¶ä½™SentinelèŠ‚ç‚¹è¿›è¡Œç›‘æ§ï¼Œ å½“å®ƒå‘ç°èŠ‚ç‚¹ä¸å¯è¾¾æ—¶ï¼Œ ä¼šå¯¹èŠ‚ç‚¹åšä¸‹çº¿æ ‡è¯†ã€‚ å¦‚æœè¢«æ ‡è¯†çš„æ˜¯ä¸»èŠ‚ç‚¹ï¼Œ å®ƒè¿˜ä¼šå’Œå…¶ä»–SentinelèŠ‚ç‚¹è¿›è¡Œâ€œåå•†â€ï¼Œ å½“å¤§å¤šæ•°SentinelèŠ‚ç‚¹éƒ½è®¤ä¸ºä¸»èŠ‚ç‚¹ä¸å¯è¾¾æ—¶ï¼Œ å®ƒä»¬ä¼šé€‰ä¸¾å‡ºä¸€ä¸ªSentinelèŠ‚ç‚¹æ¥å®Œæˆè‡ªåŠ¨æ•…éšœè½¬ç§»çš„å·¥ä½œï¼Œ åŒæ—¶ä¼šå°†è¿™ä¸ªå˜åŒ–å®æ—¶é€šçŸ¥ç»™Redisåº”ç”¨æ–¹ã€‚ æ•´ä¸ªè¿‡ç¨‹å®Œå…¨æ˜¯è‡ªåŠ¨çš„ï¼Œ ä¸éœ€è¦äººå·¥æ¥ä»‹å…¥ï¼Œ æ‰€ä»¥è¿™å¥—æ–¹æ¡ˆå¾ˆæœ‰æ•ˆåœ°è§£å†³äº†Redisçš„é«˜å¯ç”¨é—®é¢˜ å“¨å…µçš„ç›‘æ§ä¸é€‰ä¸¾ å“¨å…µçš„å®šæ—¶ç›‘æ§ ä»»åŠ¡1ï¼šæ¯ä¸ªå“¨å…µèŠ‚ç‚¹æ¯10ç§’ä¼šå‘ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹å‘é€infoå‘½ä»¤è·å–æœ€æ‹“æ‰‘ç»“æ„å›¾ï¼Œå“¨å…µé…ç½®æ—¶åªè¦é…ç½®å¯¹ä¸»èŠ‚ç‚¹çš„ç›‘æ§å³å¯ï¼Œé€šè¿‡å‘ä¸»èŠ‚ç‚¹å‘é€infoï¼Œè·å–ä»èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œå¹¶å½“æœ‰æ–°çš„ä»èŠ‚ç‚¹åŠ å…¥æ—¶å¯ä»¥é©¬ä¸Šæ„ŸçŸ¥åˆ° ä»»åŠ¡2ï¼šæ¯ä¸ªå“¨å…µèŠ‚ç‚¹æ¯éš”2ç§’ä¼šå‘redisæ•°æ®èŠ‚ç‚¹çš„æŒ‡å®šé¢‘é“ä¸Šå‘é€è¯¥å“¨å…µèŠ‚ç‚¹å¯¹äºä¸»èŠ‚ç‚¹çš„åˆ¤æ–­ä»¥åŠå½“å‰å“¨å…µèŠ‚ç‚¹çš„ä¿¡æ¯ï¼ŒåŒæ—¶æ¯ä¸ªå“¨å…µèŠ‚ç‚¹ä¹Ÿä¼šè®¢é˜…è¯¥é¢‘é“ï¼Œæ¥äº†è§£å…¶å®ƒå“¨å…µèŠ‚ç‚¹çš„ä¿¡æ¯åŠå¯¹ä¸»èŠ‚ç‚¹çš„åˆ¤æ–­ï¼Œå…¶å®å°±æ˜¯é€šè¿‡æ¶ˆæ¯publishå’Œsubscribeæ¥å®Œæˆçš„ ä»»åŠ¡3ï¼šæ¯éš”1ç§’æ¯ä¸ªå“¨å…µä¼šå‘ä¸»èŠ‚ç‚¹ã€ä»èŠ‚ç‚¹åŠå…¶ä½™å“¨å…µèŠ‚ç‚¹å‘é€ä¸€æ¬¡pingå‘½ä»¤åšä¸€æ¬¡å¿ƒè·³æ£€æµ‹ï¼Œè¿™ä¸ªä¹Ÿæ˜¯å“¨å…µç”¨æ¥åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦æ­£å¸¸çš„é‡è¦ä¾æ® ä¸»è§‚ä¸‹çº¿ï¼šæ‰€è°“ä¸»è§‚ä¸‹çº¿ï¼Œå°±æ˜¯å•ä¸ªsentinelè®¤ä¸ºæŸä¸ªæœåŠ¡ä¸‹çº¿ï¼ˆæœ‰å¯èƒ½æ˜¯æ¥æ”¶ä¸åˆ°è®¢é˜…ï¼Œä¹‹é—´çš„ç½‘ç»œä¸é€šç­‰ç­‰åŸå› ï¼‰ã€‚ sentinelä¼šä»¥æ¯ç§’ä¸€æ¬¡çš„é¢‘ç‡å‘æ‰€æœ‰ä¸å…¶å»ºç«‹äº†å‘½ä»¤è¿æ¥çš„å®ä¾‹ï¼ˆmasterï¼Œä»æœåŠ¡ï¼Œå…¶ä»–sentinelï¼‰å‘pingå‘½ä»¤ï¼Œé€šè¿‡åˆ¤æ–­pingå›å¤æ˜¯æœ‰æ•ˆå›å¤ï¼Œè¿˜æ˜¯æ— æ•ˆå›å¤æ¥åˆ¤æ–­å®ä¾‹æ—¶å€™åœ¨çº¿ï¼ˆå¯¹è¯¥sentinelæ¥è¯´æ˜¯â€œä¸»è§‚åœ¨çº¿â€ï¼‰ã€‚ sentinelé…ç½®æ–‡ä»¶ä¸­çš„down-after-millisecondsè®¾ç½®äº†åˆ¤æ–­ä¸»è§‚ä¸‹çº¿çš„æ—¶é—´é•¿åº¦ï¼Œå¦‚æœå®ä¾‹åœ¨down-after-millisecondsæ¯«ç§’å†…ï¼Œè¿”å›çš„éƒ½æ˜¯æ— æ•ˆå›å¤ï¼Œé‚£ä¹ˆsentinelå›è®¤ä¸ºè¯¥å®ä¾‹å·²ï¼ˆä¸»è§‚ï¼‰ä¸‹çº¿ï¼Œä¿®æ”¹å…¶flagsçŠ¶æ€ä¸ºSRI_S_DOWNã€‚å¦‚æœå¤šä¸ªsentinelç›‘è§†ä¸€ä¸ªæœåŠ¡ï¼Œæœ‰å¯èƒ½å­˜åœ¨å¤šä¸ªsentinelçš„down-after-millisecondsé…ç½®ä¸åŒï¼Œè¿™ä¸ªåœ¨å®é™…ç”Ÿäº§ä¸­è¦æ³¨æ„ã€‚ å®¢è§‚ä¸‹çº¿ï¼šå½“ä¸»è§‚ä¸‹çº¿çš„èŠ‚ç‚¹æ˜¯ä¸»èŠ‚ç‚¹æ—¶ï¼Œæ­¤æ—¶è¯¥å“¨å…µ3èŠ‚ç‚¹ä¼šé€šè¿‡æŒ‡ä»¤sentinel is-masterdown-by-addrå¯»æ±‚å…¶å®ƒå“¨å…µèŠ‚ç‚¹å¯¹ä¸»èŠ‚ç‚¹çš„åˆ¤æ–­ï¼Œå¦‚æœå…¶ä»–çš„å“¨å…µä¹Ÿè®¤ä¸ºä¸»èŠ‚ç‚¹ä¸»è§‚çº¿ä¸‹äº†ï¼Œåˆ™å½“è®¤ä¸ºä¸»è§‚ä¸‹çº¿çš„ç¥¨æ•°è¶…è¿‡äº†quorumï¼ˆé€‰ä¸¾ï¼‰ä¸ªæ•°ï¼Œæ­¤æ—¶å“¨å…µèŠ‚ç‚¹åˆ™è®¤ä¸ºè¯¥ä¸»èŠ‚ç‚¹ç¡®å®æœ‰é—®é¢˜ï¼Œè¿™æ ·å°±å®¢è§‚ä¸‹çº¿äº†ï¼Œå¤§éƒ¨åˆ†å“¨å…µèŠ‚ç‚¹éƒ½åŒæ„ä¸‹çº¿æ“ä½œï¼Œä¹Ÿå°±è¯´æ˜¯å®¢è§‚ä¸‹çº¿ å“¨å…µlerderé€‰ä¸¾æµç¨‹ å¦‚æœä¸»èŠ‚ç‚¹è¢«åˆ¤å®šä¸ºå®¢è§‚ä¸‹çº¿ä¹‹åï¼Œå°±è¦é€‰å–ä¸€ä¸ªå“¨å…µèŠ‚ç‚¹æ¥å®Œæˆåé¢çš„æ•…éšœè½¬ç§»å·¥ä½œï¼Œé€‰ä¸¾å‡ºä¸€ä¸ªleaderçš„æµç¨‹å¦‚ä¸‹: a)æ¯ä¸ªåœ¨çº¿çš„å“¨å…µèŠ‚ç‚¹éƒ½å¯ä»¥æˆä¸ºé¢†å¯¼è€…ï¼Œå½“å®ƒç¡®è®¤ï¼ˆæ¯”å¦‚å“¨å…µ3ï¼‰ä¸»èŠ‚ç‚¹ä¸‹çº¿æ—¶ï¼Œä¼šå‘å…¶å®ƒå“¨å…µå‘is-master-down-by-addrå‘½ä»¤ï¼Œå¾æ±‚åˆ¤æ–­å¹¶è¦æ±‚å°†è‡ªå·±è®¾ç½®ä¸ºé¢†å¯¼è€…ï¼Œç”±é¢†å¯¼è€…å¤„ç†æ•…éšœè½¬ç§»ï¼› b)å½“å…¶å®ƒå“¨å…µæ”¶åˆ°æ­¤å‘½ä»¤æ—¶ï¼Œå¯ä»¥åŒæ„æˆ–è€…æ‹’ç»å®ƒæˆä¸ºé¢†å¯¼è€…ï¼› c)å¦‚æœå“¨å…µ3å‘ç°è‡ªå·±åœ¨é€‰ä¸¾çš„ç¥¨æ•°å¤§äºç­‰äºnum(sentinels)/2+1æ—¶ï¼Œå°†æˆä¸ºé¢†å¯¼è€…ï¼Œå¦‚æœæ²¡æœ‰è¶…è¿‡ï¼Œç»§ç»­é€‰ä¸¾â€¦â€¦â€¦â€¦ è‡ªåŠ¨æ•…éšœè½¬ç§»æœºåˆ¶ åœ¨ä»èŠ‚ç‚¹ä¸­é€‰æ‹©æ–°çš„ä¸»èŠ‚ç‚¹ sentinelçŠ¶æ€æ•°æ®ç»“æ„ä¸­ä¿å­˜äº†ä¸»æœåŠ¡çš„æ‰€æœ‰ä»æœåŠ¡ä¿¡æ¯ï¼Œé¢†å¤´sentinelæŒ‰ç…§å¦‚ä¸‹çš„è§„åˆ™ä»ä»æœåŠ¡åˆ—è¡¨ä¸­æŒ‘é€‰å‡ºæ–°çš„ä¸»æœåŠ¡ è¿‡æ»¤æ‰ä¸»è§‚ä¸‹çº¿çš„èŠ‚ç‚¹ é€‰æ‹©slave-priorityæœ€é«˜çš„èŠ‚ç‚¹ï¼Œå¦‚æœç”±åˆ™è¿”å›æ²¡æœ‰å°±ç»§ç»­é€‰æ‹© é€‰æ‹©å‡ºå¤åˆ¶åç§»é‡æœ€å¤§çš„ç³»èŠ‚ç‚¹ï¼Œå› ä¸ºå¤åˆ¶ä¾¿å®œé‡è¶Šå¤§åˆ™æ•°æ®å¤åˆ¶çš„è¶Šå®Œæ•´ï¼Œå¦‚æœç”±å°±è¿”å›äº†ï¼Œæ²¡æœ‰å°±ç»§ç»­ é€‰æ‹©run_idæœ€å°çš„èŠ‚ç‚¹ æ›´æ–°ä¸»ä»çŠ¶æ€ é€šè¿‡slaveof no oneå‘½ä»¤ï¼Œè®©é€‰å‡ºæ¥çš„ä»èŠ‚ç‚¹æˆä¸ºä¸»èŠ‚ç‚¹ï¼›å¹¶é€šè¿‡slaveofå‘½ä»¤è®©å…¶ä»–èŠ‚ç‚¹æˆä¸ºå…¶ä»èŠ‚ç‚¹ã€‚ å°†å·²ä¸‹çº¿çš„ä¸»èŠ‚ç‚¹è®¾ç½®æˆæ–°çš„ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ï¼Œå½“å…¶å›å¤æ­£å¸¸æ—¶ï¼Œå¤åˆ¶æ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå˜æˆæ–°çš„ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ åŒç†ï¼Œå½“å·²ä¸‹çº¿çš„æœåŠ¡é‡æ–°ä¸Šçº¿æ—¶ï¼Œsentinelä¼šå‘å…¶å‘é€slaveofå‘½ä»¤ï¼Œè®©å…¶æˆä¸ºæ–°ä¸»çš„ä» 3ï¼Œå®˜æ–¹Redis Cluster æ–¹æ¡ˆ(æœåŠ¡ç«¯è·¯ç”±æŸ¥è¯¢) ç®€ä»‹ Redis Clusteræ˜¯ä¸€ç§æœåŠ¡ç«¯ShardingæŠ€æœ¯ï¼Œ3.0ç‰ˆæœ¬å¼€å§‹æ­£å¼æä¾›ã€‚Redis Clusterå¹¶æ²¡æœ‰ä½¿ç”¨ä¸€è‡´æ€§hashï¼Œè€Œæ˜¯é‡‡ç”¨slot(æ§½)çš„æ¦‚å¿µï¼Œä¸€å…±åˆ†æˆ16384ä¸ªæ§½ã€‚å°†è¯·æ±‚å‘é€åˆ°ä»»æ„èŠ‚ç‚¹ï¼Œæ¥æ”¶åˆ°è¯·æ±‚çš„èŠ‚ç‚¹ä¼šå°†æŸ¥è¯¢è¯·æ±‚å‘é€åˆ°æ­£ç¡®çš„èŠ‚ç‚¹ä¸Šæ‰§è¡Œ æ–¹æ¡ˆè¯´æ˜ é€šè¿‡å“ˆå¸Œçš„æ–¹å¼ï¼Œå°†æ•°æ®åˆ†ç‰‡ï¼Œæ¯ä¸ªèŠ‚ç‚¹å‡åˆ†å­˜å‚¨ä¸€å®šå“ˆå¸Œæ§½(å“ˆå¸Œå€¼)åŒºé—´çš„æ•°æ®ï¼Œé»˜è®¤åˆ†é…äº†16384 ä¸ªæ§½ä½ æ¯ä»½æ•°æ®åˆ†ç‰‡ä¼šå­˜å‚¨åœ¨å¤šä¸ªäº’ä¸ºä¸»ä»çš„å¤šèŠ‚ç‚¹ä¸Š æ•°æ®å†™å…¥å…ˆå†™ä¸»èŠ‚ç‚¹ï¼Œå†åŒæ­¥åˆ°ä»èŠ‚ç‚¹(æ”¯æŒé…ç½®ä¸ºé˜»å¡åŒæ­¥) åŒä¸€åˆ†ç‰‡å¤šä¸ªèŠ‚ç‚¹é—´çš„æ•°æ®ä¸ä¿æŒä¸€è‡´æ€§ è¯»å–æ•°æ®æ—¶ï¼Œå½“å®¢æˆ·ç«¯æ“ä½œçš„keyæ²¡æœ‰åˆ†é…åœ¨è¯¥èŠ‚ç‚¹ä¸Šæ—¶ï¼Œredisä¼šè¿”å›è½¬å‘æŒ‡ä»¤ï¼ŒæŒ‡å‘æ­£ç¡®çš„èŠ‚ç‚¹ æ‰©å®¹æ—¶æ—¶éœ€è¦éœ€è¦æŠŠæ—§èŠ‚ç‚¹çš„æ•°æ®è¿ç§»ä¸€éƒ¨åˆ†åˆ°æ–°èŠ‚ç‚¹ åœ¨ redis cluster æ¶æ„ä¸‹ï¼Œæ¯ä¸ª redis è¦æ”¾å¼€ä¸¤ä¸ªç«¯å£å·ï¼Œæ¯”å¦‚ä¸€ä¸ªæ˜¯ 6379ï¼Œå¦å¤–ä¸€ä¸ªå°±æ˜¯ åŠ 1w çš„ç«¯å£å·ï¼Œæ¯”å¦‚ 16379ã€‚ 16379 ç«¯å£å·æ˜¯ç”¨æ¥è¿›è¡ŒèŠ‚ç‚¹é—´é€šä¿¡çš„ï¼Œä¹Ÿå°±æ˜¯ cluster bus çš„ä¸œè¥¿ï¼Œcluster bus çš„é€šä¿¡ï¼Œç”¨æ¥è¿›è¡Œæ•…éšœæ£€æµ‹ã€é…ç½®æ›´æ–°ã€æ•…éšœè½¬ç§»æˆæƒã€‚cluster bus ç”¨äº†å¦å¤–ä¸€ç§äºŒè¿›åˆ¶çš„åè®®ï¼Œgossip åè®®ï¼Œç”¨äºèŠ‚ç‚¹é—´è¿›è¡Œé«˜æ•ˆçš„æ•°æ®äº¤æ¢ï¼Œå ç”¨æ›´å°‘çš„ç½‘ç»œå¸¦å®½å’Œå¤„ç†æ—¶é—´ã€‚ èŠ‚ç‚¹é—´çš„å†…éƒ¨é€šä¿¡æœºåˆ¶ åŸºæœ¬é€šä¿¡åŸç† é›†ç¾¤å…ƒæ•°æ®çš„ç»´æŠ¤æœ‰ä¸¤ç§æ–¹å¼ï¼šé›†ä¸­å¼ã€Gossip åè®®ã€‚redis cluster èŠ‚ç‚¹é—´é‡‡ç”¨ gossip åè®®è¿›è¡Œé€šä¿¡ã€‚ åˆ†å¸ƒå¼å¯»å€ç®—æ³• hash ç®—æ³•ï¼ˆå¤§é‡ç¼“å­˜é‡å»ºï¼‰ ä½¿ç”¨ç‰¹å®šçš„æ•°æ®ï¼Œ å¦‚Redisçš„é”®æˆ–ç”¨æˆ·IDï¼Œ å†æ ¹æ®èŠ‚ç‚¹æ•°é‡Nä½¿ç”¨å…¬å¼ï¼šhashï¼ˆkeyï¼‰ %Nè®¡ç®—å‡ºå“ˆå¸Œå€¼ï¼Œ ç”¨æ¥å†³å®šæ•°æ®æ˜ å°„åˆ°å“ªä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚ è¿™ç§æ–¹æ¡ˆå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼š å½“èŠ‚ç‚¹æ•°é‡å˜åŒ–æ—¶ï¼Œ å¦‚æ‰©å®¹æˆ–æ”¶ç¼©èŠ‚ç‚¹ï¼Œ æ•°æ®èŠ‚ç‚¹æ˜ å°„å…³ç³»éœ€è¦é‡æ–°è®¡ç®—ï¼Œ ä¼šå¯¼è‡´æ•°æ®çš„é‡æ–°è¿ç§»ã€‚ è¿™ç§æ–¹å¼çš„çªå‡ºä¼˜ç‚¹æ˜¯ç®€å•æ€§ï¼Œ å¸¸ç”¨äºæ•°æ®åº“çš„åˆ†åº“åˆ†è¡¨è§„åˆ™ï¼Œ ä¸€èˆ¬é‡‡ç”¨é¢„åˆ†åŒºçš„æ–¹å¼ï¼Œ æå‰æ ¹æ®æ•°æ®é‡è§„åˆ’å¥½åˆ†åŒºæ•°ï¼Œ æ¯”å¦‚åˆ’åˆ†ä¸º512æˆ–1024å¼ è¡¨ï¼Œ ä¿è¯å¯æ”¯æ’‘æœªæ¥ä¸€æ®µæ—¶é—´çš„æ•°æ®é‡ï¼Œ å†æ ¹æ®è´Ÿè½½æƒ…å†µå°†è¡¨è¿ç§»åˆ°å…¶ä»–æ•°æ®åº“ä¸­ã€‚ æ‰©å®¹æ—¶é€šå¸¸é‡‡ç”¨ç¿»å€æ‰©å®¹ï¼Œ é¿å…æ•°æ®æ˜ å°„å…¨éƒ¨è¢«æ‰“ä¹±å¯¼è‡´å…¨é‡è¿ç§»çš„æƒ…å†µï¼Œ å¦‚å›¾æ‰€ç¤ºã€‚ ä¸€è‡´æ€§ hash ç®—æ³•ï¼ˆè‡ªåŠ¨ç¼“å­˜è¿ç§»ï¼‰+ è™šæ‹ŸèŠ‚ç‚¹ï¼ˆè‡ªåŠ¨è´Ÿè½½å‡è¡¡ï¼‰ ä¸€è‡´æ€§å“ˆå¸Œåˆ†åŒºï¼ˆDistributed Hash Tableï¼‰ å®ç°æ€è·¯æ˜¯ä¸ºç³»ç»Ÿä¸­æ¯ä¸ªèŠ‚ç‚¹åˆ†é…ä¸€ä¸ªtokenï¼Œ èŒƒå›´ä¸€èˆ¬åœ¨0~2^32ï¼Œ è¿™äº›tokenæ„æˆä¸€ä¸ªå“ˆå¸Œç¯ã€‚ æ•°æ®è¯»å†™æ‰§è¡ŒèŠ‚ç‚¹æŸ¥æ‰¾æ“ä½œæ—¶ï¼Œ å…ˆæ ¹æ®keyè®¡ç®—hashå€¼ï¼Œ ç„¶åé¡ºæ—¶é’ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§äºç­‰äºè¯¥å“ˆå¸Œå€¼çš„tokenèŠ‚ç‚¹ï¼Œ å¦‚å›¾æ‰€ç¤ºã€‚ è¿™ç§æ–¹å¼ç›¸æ¯”èŠ‚ç‚¹å–ä½™æœ€å¤§çš„å¥½å¤„åœ¨äºåŠ å…¥å’Œåˆ é™¤èŠ‚ç‚¹åªå½±å“å“ˆå¸Œç¯ä¸­ç›¸é‚»çš„èŠ‚ç‚¹ï¼Œ å¯¹å…¶ä»–èŠ‚ç‚¹æ— å½±å“ã€‚ ä½†ä¸€è‡´æ€§å“ˆå¸Œåˆ†åŒºå­˜åœ¨å‡ ä¸ªé—®é¢˜ï¼š åŠ å‡èŠ‚ç‚¹ä¼šé€ æˆå“ˆå¸Œç¯ä¸­éƒ¨åˆ†æ•°æ®æ— æ³•å‘½ä¸­ï¼Œ éœ€è¦æ‰‹åŠ¨å¤„ç†æˆ–è€…å¿½ç•¥è¿™éƒ¨åˆ†æ•°æ®ï¼Œ å› æ­¤ä¸€è‡´æ€§å“ˆå¸Œå¸¸ç”¨äºç¼“å­˜åœºæ™¯ã€‚ å½“ä½¿ç”¨å°‘é‡èŠ‚ç‚¹æ—¶ï¼Œ èŠ‚ç‚¹å˜åŒ–å°†å¤§èŒƒå›´å½±å“å“ˆå¸Œç¯ä¸­æ•°æ®æ˜ å°„ï¼Œ å› æ­¤è¿™ç§æ–¹å¼ä¸é€‚åˆå°‘é‡æ•°æ®èŠ‚ç‚¹çš„åˆ†å¸ƒå¼æ–¹æ¡ˆã€‚ æ™®é€šçš„ä¸€è‡´æ€§å“ˆå¸Œåˆ†åŒºåœ¨å¢å‡èŠ‚ç‚¹æ—¶éœ€è¦å¢åŠ ä¸€å€æˆ–å‡å»ä¸€åŠèŠ‚ç‚¹æ‰èƒ½ä¿è¯æ•°æ®å’Œè´Ÿè½½çš„å‡è¡¡ã€‚ redis cluster çš„ hash slot ç®—æ³• è™šæ‹Ÿæ§½åˆ†åŒºå·§å¦™åœ°ä½¿ç”¨äº†å“ˆå¸Œç©ºé—´ï¼Œ ä½¿ç”¨åˆ†æ•£åº¦è‰¯å¥½çš„å“ˆå¸Œå‡½æ•°æŠŠæ‰€æœ‰æ•°æ®æ˜ å°„åˆ°ä¸€ä¸ªå›ºå®šèŒƒå›´çš„æ•´æ•°é›†åˆä¸­ï¼Œ æ•´æ•°å®šä¹‰ä¸ºæ§½ï¼ˆslotï¼‰ã€‚ è¿™ä¸ªèŒƒå›´ä¸€èˆ¬è¿œè¿œå¤§äºèŠ‚ç‚¹æ•°ï¼Œ æ¯”å¦‚Redis Clusteræ§½èŒƒå›´æ˜¯0~16383ã€‚ æ§½æ˜¯é›†ç¾¤å†…æ•°æ®ç®¡ç†å’Œè¿ç§»çš„åŸºæœ¬å•ä½ã€‚ é‡‡ç”¨å¤§èŒƒå›´æ§½çš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†æ–¹ä¾¿æ•°æ®æ‹†åˆ†å’Œé›†ç¾¤æ‰©å±•ã€‚ æ¯ä¸ªèŠ‚ç‚¹ä¼šè´Ÿè´£ä¸€å®šæ•°é‡çš„æ§½ï¼Œ å¦‚å›¾æ‰€ç¤ºã€‚ Redis Cluseré‡‡ç”¨è™šæ‹Ÿæ§½åˆ†åŒºï¼Œ æ‰€æœ‰çš„é”®æ ¹æ®å“ˆå¸Œå‡½æ•°æ˜ å°„åˆ°0~16383æ•´æ•°æ§½å†…ï¼Œ è®¡ç®—å…¬å¼ï¼š slot=CRC16ï¼ˆkeyï¼‰ &amp;16383ã€‚ æ¯ä¸€ä¸ªèŠ‚ç‚¹è´Ÿè´£ç»´æŠ¤ä¸€éƒ¨åˆ†æ§½ä»¥åŠæ§½æ‰€æ˜ å°„çš„é”®å€¼æ•°æ®ï¼Œ å¦‚å›¾æ‰€ç¤º Redisè™šæ‹Ÿæ§½åˆ†åŒºçš„ç‰¹ç‚¹ï¼š è§£è€¦æ•°æ®å’ŒèŠ‚ç‚¹ä¹‹é—´çš„å…³ç³»ï¼Œ ç®€åŒ–äº†èŠ‚ç‚¹æ‰©å®¹å’Œæ”¶ç¼©éš¾åº¦ã€‚ èŠ‚ç‚¹è‡ªèº«ç»´æŠ¤æ§½çš„æ˜ å°„å…³ç³»ï¼Œ ä¸éœ€è¦å®¢æˆ·ç«¯æˆ–è€…ä»£ç†æœåŠ¡ç»´æŠ¤æ§½åˆ†åŒºå…ƒæ•°æ®ã€‚ æ”¯æŒèŠ‚ç‚¹ã€ æ§½ã€ é”®ä¹‹é—´çš„æ˜ å°„æŸ¥è¯¢ï¼Œ ç”¨äºæ•°æ®è·¯ç”±ã€ åœ¨çº¿ä¼¸ç¼©ç­‰åœºæ™¯ ä¼˜ç‚¹ æ— ä¸­å¿ƒæ¶æ„ï¼Œæ”¯æŒåŠ¨æ€æ‰©å®¹ï¼Œå¯¹ä¸šåŠ¡é€æ˜ å…·å¤‡Sentinelçš„ç›‘æ§å’Œè‡ªåŠ¨Failover(æ•…éšœè½¬ç§»)èƒ½åŠ› å®¢æˆ·ç«¯ä¸éœ€è¦è¿æ¥é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹ï¼Œè¿æ¥é›†ç¾¤ä¸­ä»»ä½•ä¸€ä¸ªå¯ç”¨èŠ‚ç‚¹å³å¯ é«˜æ€§èƒ½ï¼Œå®¢æˆ·ç«¯ç›´è¿redisæœåŠ¡ï¼Œå…å»äº†proxyä»£ç†çš„æŸè€— ç¼ºç‚¹ è¿ç»´ä¹Ÿå¾ˆå¤æ‚ï¼Œæ•°æ®è¿ç§»éœ€è¦äººå·¥å¹²é¢„ åªèƒ½ä½¿ç”¨0å·æ•°æ®åº“ ä¸æ”¯æŒæ‰¹é‡æ“ä½œ(pipelineç®¡é“æ“ä½œ) åˆ†å¸ƒå¼é€»è¾‘å’Œå­˜å‚¨æ¨¡å—è€¦åˆç­‰ é›†ç¾¤ç›¸å…³æé—® Redisé›†ç¾¤çš„ä¸»ä»å¤åˆ¶æ¨¡å‹æ˜¯æ€æ ·çš„ï¼Ÿ ä¸ºäº†ä½¿åœ¨éƒ¨åˆ†èŠ‚ç‚¹å¤±è´¥æˆ–è€…å¤§éƒ¨åˆ†èŠ‚ç‚¹æ— æ³•é€šä¿¡çš„æƒ…å†µä¸‹é›†ç¾¤ä»ç„¶å¯ç”¨ï¼Œæ‰€ä»¥é›†ç¾¤ä½¿ç”¨äº†ä¸»ä»å¤åˆ¶æ¨¡å‹ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šæœ‰N-1ä¸ªå¤åˆ¶å“ ç”Ÿäº§ç¯å¢ƒä¸­çš„ redis æ˜¯æ€ä¹ˆéƒ¨ç½²çš„ï¼Ÿ redis clusterï¼Œ10 å°æœºå™¨ï¼Œ5 å°æœºå™¨éƒ¨ç½²äº† redis ä¸»å®ä¾‹ï¼Œå¦å¤– 5 å°æœºå™¨éƒ¨ç½²äº† redis çš„ä»å®ä¾‹ï¼Œæ¯ä¸ªä¸»å®ä¾‹æŒ‚äº†ä¸€ä¸ªä»å®ä¾‹ï¼Œ5 ä¸ªèŠ‚ç‚¹å¯¹å¤–æä¾›è¯»å†™æœåŠ¡ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„è¯»å†™é«˜å³°qpså¯èƒ½å¯ä»¥è¾¾åˆ°æ¯ç§’ 5 ä¸‡ï¼Œ5 å°æœºå™¨æœ€å¤šæ˜¯ 25 ä¸‡è¯»å†™è¯·æ±‚/sã€‚ æœºå™¨æ˜¯ä»€ä¹ˆé…ç½®ï¼Ÿ32G å†…å­˜+ 8 æ ¸ CPU + 1T ç£ç›˜ï¼Œä½†æ˜¯åˆ†é…ç»™ redis è¿›ç¨‹çš„æ˜¯10gå†…å­˜ï¼Œä¸€èˆ¬çº¿ä¸Šç”Ÿäº§ç¯å¢ƒï¼Œredis çš„å†…å­˜å°½é‡ä¸è¦è¶…è¿‡ 10gï¼Œè¶…è¿‡ 10g å¯èƒ½ä¼šæœ‰é—®é¢˜ã€‚ 5 å°æœºå™¨å¯¹å¤–æä¾›è¯»å†™ï¼Œä¸€å…±æœ‰ 50g å†…å­˜ã€‚ å› ä¸ºæ¯ä¸ªä¸»å®ä¾‹éƒ½æŒ‚äº†ä¸€ä¸ªä»å®ä¾‹ï¼Œæ‰€ä»¥æ˜¯é«˜å¯ç”¨çš„ï¼Œä»»ä½•ä¸€ä¸ªä¸»å®ä¾‹å®•æœºï¼Œéƒ½ä¼šè‡ªåŠ¨æ•…éšœè¿ç§»ï¼Œredis ä»å®ä¾‹ä¼šè‡ªåŠ¨å˜æˆä¸»å®ä¾‹ç»§ç»­æä¾›è¯»å†™æœåŠ¡ã€‚ ä½ å¾€å†…å­˜é‡Œå†™çš„æ˜¯ä»€ä¹ˆæ•°æ®ï¼Ÿæ¯æ¡æ•°æ®çš„å¤§å°æ˜¯å¤šå°‘ï¼Ÿå•†å“æ•°æ®ï¼Œæ¯æ¡æ•°æ®æ˜¯ 10kbã€‚100 æ¡æ•°æ®æ˜¯ 1mbï¼Œ10 ä¸‡æ¡æ•°æ®æ˜¯ 1gã€‚å¸¸é©»å†…å­˜çš„æ˜¯ 200 ä¸‡æ¡å•†å“æ•°æ®ï¼Œå ç”¨å†…å­˜æ˜¯ 20gï¼Œä»…ä»…ä¸åˆ°æ€»å†…å­˜çš„ 50%ã€‚ç›®å‰é«˜å³°æœŸæ¯ç§’å°±æ˜¯ 3500 å·¦å³çš„è¯·æ±‚é‡ã€‚ å…¶å®å¤§å‹çš„å…¬å¸ï¼Œä¼šæœ‰åŸºç¡€æ¶æ„çš„ team è´Ÿè´£ç¼“å­˜é›†ç¾¤çš„è¿ç»´ã€‚ è¯´è¯´Rediså“ˆå¸Œæ§½çš„æ¦‚å¿µï¼Ÿ Redisé›†ç¾¤æ²¡æœ‰ä½¿ç”¨ä¸€è‡´æ€§hash,è€Œæ˜¯å¼•å…¥äº†å“ˆå¸Œæ§½çš„æ¦‚å¿µï¼ŒRedisé›†ç¾¤æœ‰16384ä¸ªå“ˆå¸Œæ§½ï¼Œæ¯ä¸ªkeyé€šè¿‡CRC16æ ¡éªŒåå¯¹16384å–æ¨¡æ¥å†³å®šæ”¾ç½®å“ªä¸ªæ§½ï¼Œslot=CRC16ï¼ˆkeyï¼‰ &amp;16383ï¼Œé›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ä¸€éƒ¨åˆ†hashæ§½ã€‚ Redisé›†ç¾¤ä¼šæœ‰å†™æ“ä½œä¸¢å¤±å—ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ Rediså¹¶ä¸èƒ½ä¿è¯æ•°æ®çš„å¼ºä¸€è‡´æ€§ï¼Œè¿™æ„å‘³è¿™åœ¨å®é™…ä¸­é›†ç¾¤åœ¨ç‰¹å®šçš„æ¡ä»¶ä¸‹å¯èƒ½ä¼šä¸¢å¤±å†™æ“ä½œã€‚ ä»¥ä¸‹æƒ…å†µå¯èƒ½å¯¼è‡´å†™æ“ä½œä¸¢å¤±ï¼š è¿‡æœŸ key è¢«æ¸…ç† æœ€å¤§å†…å­˜ä¸è¶³ï¼Œå¯¼è‡´ Redis è‡ªåŠ¨æ¸…ç†éƒ¨åˆ† key ä»¥èŠ‚çœç©ºé—´ ä¸»åº“æ•…éšœåè‡ªåŠ¨é‡å¯ï¼Œä»åº“è‡ªåŠ¨åŒæ­¥ å•ç‹¬çš„ä¸»å¤‡æ–¹æ¡ˆï¼Œç½‘ç»œä¸ç¨³å®šè§¦å‘å“¨å…µçš„è‡ªåŠ¨åˆ‡æ¢ä¸»ä»èŠ‚ç‚¹ï¼Œåˆ‡æ¢æœŸé—´ä¼šæœ‰æ•°æ®ä¸¢å¤± Redisé›†ç¾¤ä¹‹é—´æ˜¯å¦‚ä½•å¤åˆ¶çš„ï¼Ÿ åœ¨ä»èŠ‚ç‚¹æ‰§è¡Œslaveofå‘½ä»¤åï¼Œ å¤åˆ¶è¿‡ç¨‹ä¾¿å¼€å§‹è¿ä½œï¼Œ ä¸‹é¢è¯¦ç»†ä»‹ç»å»ºç«‹å¤åˆ¶çš„å®Œæ•´æµç¨‹ï¼Œ å¦‚å›¾æ‰€ç¤ºã€‚ ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºå¤åˆ¶è¿‡ç¨‹å¤§è‡´åˆ†ä¸º6ä¸ªè¿‡ç¨‹ï¼š ä¿å­˜ä¸»èŠ‚ç‚¹ï¼ˆmasterï¼‰ ä¿¡æ¯ã€‚æ‰§è¡Œslaveofåä»èŠ‚ç‚¹åªä¿å­˜ä¸»èŠ‚ç‚¹çš„åœ°å€ä¿¡æ¯ä¾¿ç›´æ¥è¿”å›ï¼Œ è¿™æ—¶å»ºç«‹å¤åˆ¶æµç¨‹è¿˜æ²¡æœ‰å¼€å§‹ï¼Œ åœ¨ä»èŠ‚ç‚¹6380æ‰§è¡Œinfo replicationå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š master_host:127.0.0.1 master_port:6379 master_link_status:down ä»ç»Ÿè®¡ä¿¡æ¯å¯ä»¥çœ‹å‡ºï¼Œ ä¸»èŠ‚ç‚¹çš„ipå’Œportè¢«ä¿å­˜ä¸‹æ¥ï¼Œ ä½†æ˜¯ä¸»èŠ‚ç‚¹çš„è¿æ¥çŠ¶æ€ï¼ˆmaster_link_statusï¼‰ æ˜¯ä¸‹çº¿çŠ¶æ€ã€‚ æ‰§è¡ŒslaveofåRedisä¼šæ‰“å°å¦‚ä¸‹æ—¥å¿—ï¼š SLAVE OF 127.0.0.1:6379 enabled (user request from 'id=65 addr=127.0.0.1:58090 fd=5 name= age=11 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 obl=0 oll=0 omem=0 events=r cmd=slaveof') é€šè¿‡è¯¥æ—¥å¿—å¯ä»¥å¸®åŠ©è¿ç»´äººå‘˜å®šä½å‘é€slaveofå‘½ä»¤çš„å®¢æˆ·ç«¯ï¼Œ æ–¹ä¾¿è¿½è¸ªå’Œå‘ç°é—®é¢˜ã€‚ ä»èŠ‚ç‚¹ï¼ˆslaveï¼‰ å†…éƒ¨é€šè¿‡æ¯ç§’è¿è¡Œçš„å®šæ—¶ä»»åŠ¡ç»´æŠ¤å¤åˆ¶ç›¸å…³é€»è¾‘ï¼Œå½“å®šæ—¶ä»»åŠ¡å‘ç°å­˜åœ¨æ–°çš„ä¸»èŠ‚ç‚¹åï¼Œ ä¼šå°è¯•ä¸è¯¥èŠ‚ç‚¹å»ºç«‹ç½‘ç»œè¿æ¥ï¼Œ å¦‚å›¾æ‰€ç¤ºã€‚ ä»èŠ‚ç‚¹ä¼šå»ºç«‹ä¸€ä¸ªsocketå¥—æ¥å­—ï¼Œ ä¾‹å¦‚å›¾6-8ä¸­ä»èŠ‚ç‚¹å»ºç«‹äº†ä¸€ä¸ªç«¯å£ä¸º24555çš„å¥—æ¥å­—ï¼Œ ä¸“é—¨ç”¨äºæ¥å—ä¸»èŠ‚ç‚¹å‘é€çš„å¤åˆ¶å‘½ä»¤ã€‚ ä»èŠ‚ç‚¹è¿æ¥æˆåŠŸå æ‰“å°å¦‚ä¸‹æ—¥å¿—ï¼š \\* Connecting to MASTER 127.0.0.1:6379 \\* MASTER &lt;-&gt; SLAVE sync started å¦‚æœä»èŠ‚ç‚¹æ— æ³•å»ºç«‹è¿æ¥ï¼Œ å®šæ—¶ä»»åŠ¡ä¼šæ— é™é‡è¯•ç›´åˆ°è¿æ¥æˆåŠŸæˆ–è€…æ‰§è¡Œslaveof no oneå–æ¶ˆå¤åˆ¶ï¼Œ å¦‚å›¾æ‰€ç¤ºã€‚ å…³äºè¿æ¥å¤±è´¥ï¼Œ å¯ä»¥åœ¨ä»èŠ‚ç‚¹æ‰§è¡Œinfo replicationæŸ¥çœ‹master_link_down_since_secondsæŒ‡æ ‡ï¼Œ å®ƒä¼šè®°å½•ä¸ä¸»èŠ‚ç‚¹è¿æ¥å¤±è´¥çš„ç³»ç»Ÿæ—¶ é—´ã€‚ ä»èŠ‚ç‚¹è¿æ¥ä¸»èŠ‚ç‚¹å¤±è´¥æ—¶ä¹Ÿä¼šæ¯ç§’æ‰“å°å¦‚ä¸‹æ—¥å¿—ï¼Œ æ–¹ä¾¿è¿ç»´äººå‘˜å‘ç°é—®é¢˜ï¼š \\# Error condition on socket for SYNC: {socket_error_reason} å‘é€pingå‘½ä»¤ã€‚ è¿æ¥å»ºç«‹æˆåŠŸåä»èŠ‚ç‚¹å‘é€pingè¯·æ±‚è¿›è¡Œé¦–æ¬¡é€šä¿¡ï¼Œ pingè¯·æ±‚ä¸»è¦ç›®çš„å¦‚ä¸‹ï¼š Â·æ£€æµ‹ä¸»ä»ä¹‹é—´ç½‘ç»œå¥—æ¥å­—æ˜¯å¦å¯ç”¨ã€‚ Â·æ£€æµ‹ä¸»èŠ‚ç‚¹å½“å‰æ˜¯å¦å¯æ¥å—å¤„ç†å‘½ä»¤ã€‚ å¦‚æœå‘é€pingå‘½ä»¤åï¼Œ ä»èŠ‚ç‚¹æ²¡æœ‰æ”¶åˆ°ä¸»èŠ‚ç‚¹çš„pongå›å¤æˆ–è€…è¶…æ—¶ï¼Œ æ¯”å¦‚ç½‘ç»œè¶…æ—¶æˆ–è€…ä¸»èŠ‚ç‚¹æ­£åœ¨é˜»å¡æ— æ³•å“åº”å‘½ä»¤ï¼Œ ä»èŠ‚ç‚¹ä¼šæ–­å¼€å¤åˆ¶è¿æ¥ï¼Œ ä¸‹ æ¬¡å®šæ—¶ä»»åŠ¡ä¼šå‘èµ·é‡è¿ï¼Œ å¦‚å›¾æ‰€ç¤ºã€‚ ä»èŠ‚ç‚¹å‘é€çš„pingå‘½ä»¤æˆåŠŸè¿”å›ï¼Œ Redisæ‰“å°å¦‚ä¸‹æ—¥å¿—ï¼Œ å¹¶ç»§ç»­åç»­å¤åˆ¶æµç¨‹ï¼š Master replied to PING, replication can continue... æƒé™éªŒè¯ã€‚ å¦‚æœä¸»èŠ‚ç‚¹è®¾ç½®äº†requirepasså‚æ•°ï¼Œ åˆ™éœ€è¦å¯†ç éªŒè¯ï¼Œä»èŠ‚ç‚¹å¿…é¡»é…ç½®masterauthå‚æ•°ä¿è¯ä¸ä¸»èŠ‚ç‚¹ç›¸åŒçš„å¯†ç æ‰èƒ½é€šè¿‡éªŒè¯ï¼› å¦‚æœéªŒè¯å¤±è´¥å¤åˆ¶å°†ç»ˆæ­¢ï¼Œ ä»èŠ‚ç‚¹é‡æ–°å‘èµ·å¤åˆ¶æµç¨‹ã€‚ åŒæ­¥æ•°æ®é›†ã€‚ ä¸»ä»å¤åˆ¶è¿æ¥æ­£å¸¸é€šä¿¡åï¼Œ å¯¹äºé¦–æ¬¡å»ºç«‹å¤åˆ¶çš„åœºæ™¯ï¼Œ ä¸»èŠ‚ç‚¹ä¼šæŠŠæŒæœ‰çš„æ•°æ®å…¨éƒ¨å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œ è¿™éƒ¨åˆ†æ“ä½œæ˜¯è€—æ—¶æœ€é•¿çš„æ­¥éª¤ã€‚ Redisåœ¨2.8ç‰ˆæœ¬ä»¥åé‡‡ç”¨æ–°å¤åˆ¶å‘½ä»¤psyncè¿›è¡Œæ•°æ®åŒæ­¥ï¼Œ åŸæ¥çš„syncå‘½ä»¤ä¾ç„¶æ”¯æŒï¼Œ ä¿è¯æ–°æ—§ç‰ˆæœ¬çš„å…¼å®¹æ€§ã€‚ æ–°ç‰ˆåŒæ­¥åˆ’åˆ†ä¸¤ç§æƒ…å†µï¼š å…¨é‡åŒæ­¥å’Œéƒ¨åˆ†åŒæ­¥. å‘½ä»¤æŒç»­å¤åˆ¶ã€‚ å½“ä¸»èŠ‚ç‚¹æŠŠå½“å‰çš„æ•°æ®åŒæ­¥ç»™ä»èŠ‚ç‚¹åï¼Œ ä¾¿å®Œæˆäº†å¤åˆ¶çš„å»ºç«‹æµç¨‹ã€‚ æ¥ä¸‹æ¥ä¸»èŠ‚ç‚¹ä¼šæŒç»­åœ°æŠŠå†™å‘½ä»¤å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œ ä¿è¯ä¸»ä»æ•°æ®ä¸€è‡´æ€§ã€‚ Redisé›†ç¾¤æœ€å¤§èŠ‚ç‚¹ä¸ªæ•°æ˜¯å¤šå°‘ï¼Ÿ 16384ä¸ª Redisé›†ç¾¤å¦‚ä½•é€‰æ‹©æ•°æ®åº“ï¼Ÿ Redisé›†ç¾¤ç›®å‰æ— æ³•åšæ•°æ®åº“é€‰æ‹©ï¼Œé»˜è®¤åœ¨0æ•°æ®åº“ã€‚ ","link":"https://tianxiawuhao.github.io/FWuQD6Kxu/"},{"title":"redisæ¦‚è¿°ä¸‰","content":"RedisæŒä¹…åŒ– æŒä¹…åŒ–å°±æ˜¯æŠŠå†…å­˜çš„æ•°æ®å†™åˆ°ç£ç›˜ä¸­å»ï¼Œé˜²æ­¢æœåŠ¡å®•æœºäº†å†…å­˜æ•°æ®ä¸¢å¤±ã€‚ Redis çš„æŒä¹…åŒ–æœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿå„è‡ªçš„ä¼˜ç¼ºç‚¹ï¼Ÿ Redis æä¾›ä¸¤ç§æŒä¹…åŒ–æœºåˆ¶ RDBï¼ˆé»˜è®¤ï¼‰ å’Œ AOF æœºåˆ¶: RDBï¼š RDBæ˜¯Redis DataBaseç¼©å†™å¿«ç…§ RDBæ˜¯Redisé»˜è®¤çš„æŒä¹…åŒ–æ–¹å¼ã€‚æŒ‰ç…§ä¸€å®šçš„æ—¶é—´å°†å†…å­˜çš„æ•°æ®ä»¥å¿«ç…§çš„å½¢å¼ä¿å­˜åˆ°ç¡¬ç›˜ä¸­ï¼Œå¯¹åº”äº§ç”Ÿçš„æ•°æ®æ–‡ä»¶ä¸ºdump.rdbã€‚é€šè¿‡é…ç½®æ–‡ä»¶ä¸­çš„saveå‚æ•°æ¥å®šä¹‰å¿«ç…§çš„å‘¨æœŸã€‚ bgsaveæ˜¯ä¸»æµçš„è§¦å‘RDBæŒä¹…åŒ–æ–¹å¼ï¼Œ æ ¹æ®ä¸‹å›¾äº†è§£å®ƒçš„è¿ä½œæµç¨‹ æ‰§è¡Œbgsaveå‘½ä»¤ï¼Œ Redisçˆ¶è¿›ç¨‹åˆ¤æ–­å½“å‰æ˜¯å¦å­˜åœ¨æ­£åœ¨æ‰§è¡Œçš„å­è¿›ç¨‹ï¼Œ å¦‚RDB/AOFå­è¿›ç¨‹ï¼Œ å¦‚æœå­˜åœ¨bgsaveå‘½ä»¤ç›´æ¥è¿”å›ã€‚ çˆ¶è¿›ç¨‹æ‰§è¡Œforkæ“ä½œåˆ›å»ºå­è¿›ç¨‹ï¼Œ forkæ“ä½œè¿‡ç¨‹ä¸­çˆ¶è¿›ç¨‹ä¼šé˜»å¡ï¼Œ é€šè¿‡info statså‘½ä»¤æŸ¥çœ‹latest_fork_usecé€‰é¡¹ï¼Œ å¯ä»¥è·å–æœ€è¿‘ä¸€ä¸ªforkæ“ä½œçš„è€—æ—¶ï¼Œ å•ä½ä¸ºå¾®ç§’ã€‚ çˆ¶è¿›ç¨‹forkå®Œæˆåï¼Œ bgsaveå‘½ä»¤è¿”å›â€œBackground saving startedâ€ä¿¡æ¯å¹¶ä¸å†é˜»å¡çˆ¶è¿›ç¨‹ï¼Œ å¯ä»¥ç»§ç»­å“åº”å…¶ä»–å‘½ä»¤ã€‚ å­è¿›ç¨‹åˆ›å»ºRDBæ–‡ä»¶ï¼Œ æ ¹æ®çˆ¶è¿›ç¨‹å†…å­˜ç”Ÿæˆä¸´æ—¶å¿«ç…§æ–‡ä»¶ï¼Œ å®Œæˆåå¯¹åŸæœ‰æ–‡ä»¶è¿›è¡ŒåŸå­æ›¿æ¢ã€‚ æ‰§è¡Œlastsaveå‘½ä»¤å¯ä»¥è·å–æœ€åä¸€æ¬¡ç”ŸæˆRDBçš„æ—¶é—´ï¼Œ å¯¹åº”infoç»Ÿè®¡çš„rdb_last_save_timeé€‰é¡¹ã€‚ è¿›ç¨‹å‘é€ä¿¡å·ç»™çˆ¶è¿›ç¨‹è¡¨ç¤ºå®Œæˆï¼Œ çˆ¶è¿›ç¨‹æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼Œ å…·ä½“è§info Persistenceä¸‹çš„rdb_*ç›¸å…³é€‰ ä¼˜ç‚¹ï¼š 1ã€åªæœ‰ä¸€ä¸ªæ–‡ä»¶ dump.rdbï¼Œæ–¹ä¾¿æŒä¹…åŒ–ã€‚ 2ã€å®¹ç¾æ€§å¥½ï¼Œä¸€ä¸ªæ–‡ä»¶å¯ä»¥ä¿å­˜åˆ°å®‰å…¨çš„ç£ç›˜ã€‚ 3ã€æ€§èƒ½æœ€å¤§åŒ–ï¼Œfork å­è¿›ç¨‹æ¥å®Œæˆå†™æ“ä½œï¼Œè®©ä¸»è¿›ç¨‹ç»§ç»­å¤„ç†å‘½ä»¤ï¼Œæ‰€ä»¥æ˜¯ IO æœ€å¤§åŒ–ã€‚ä½¿ç”¨å•ç‹¬å­è¿›ç¨‹æ¥è¿›è¡ŒæŒä¹…åŒ–ï¼Œä¸»è¿›ç¨‹ä¸ä¼šè¿›è¡Œä»»ä½• IO æ“ä½œï¼Œä¿è¯äº† redis çš„é«˜æ€§èƒ½ 4.ç›¸å¯¹äºæ•°æ®é›†å¤§æ—¶ï¼Œæ¯” AOF çš„å¯åŠ¨æ•ˆç‡æ›´é«˜ã€‚ ç¼ºç‚¹ï¼š 1ã€æ•°æ®å®‰å…¨æ€§ä½ã€‚RDB æ˜¯é—´éš”ä¸€æ®µæ—¶é—´è¿›è¡ŒæŒä¹…åŒ–ï¼Œå¦‚æœæŒä¹…åŒ–ä¹‹é—´ redis å‘ç”Ÿæ•…éšœï¼Œä¼šå‘ç”Ÿæ•°æ®ä¸¢å¤±ã€‚æ‰€ä»¥è¿™ç§æ–¹å¼æ›´é€‚åˆæ•°æ®è¦æ±‚ä¸ä¸¥è°¨çš„æ—¶å€™ 2ã€AOFï¼ˆAppend-only file)æŒä¹…åŒ–æ–¹å¼ï¼š æ˜¯æŒ‡æ‰€æœ‰çš„å‘½ä»¤è¡Œè®°å½•ä»¥ redis å‘½ä»¤è¯· æ±‚åè®®çš„æ ¼å¼å®Œå…¨æŒä¹…åŒ–å­˜å‚¨)ä¿å­˜ä¸º aof æ–‡ä»¶ã€‚ AOFï¼š AOFæŒä¹…åŒ–(å³Append Only FileæŒä¹…åŒ–)ï¼Œåˆ™æ˜¯å°†Redisæ‰§è¡Œçš„æ¯æ¬¡å†™å‘½ä»¤è®°å½•åˆ°å•ç‹¬çš„æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œå½“é‡å¯Redisä¼šé‡æ–°å°†æŒä¹…åŒ–çš„æ—¥å¿—ä¸­æ–‡ä»¶æ¢å¤æ•°æ®ã€‚ å½“ä¸¤ç§æ–¹å¼åŒæ—¶å¼€å¯æ—¶ï¼Œæ•°æ®æ¢å¤Redisä¼šä¼˜å…ˆé€‰æ‹©AOFæ¢å¤ã€‚ å¼€å¯AOFåŠŸèƒ½éœ€è¦è®¾ç½®é…ç½®ï¼š appendonly yesï¼Œ é»˜è®¤ä¸å¼€å¯ã€‚ AOFæ–‡ä»¶åé€šè¿‡appendfilenameé…ç½®è®¾ç½®ï¼Œ é»˜è®¤æ–‡ä»¶åæ˜¯appendonly.aofã€‚ ä¿å­˜è·¯å¾„åŒRDBæŒä¹…åŒ–æ–¹å¼ä¸€è‡´ï¼Œ é€šè¿‡diré…ç½®æŒ‡å®šã€‚ AOFçš„å·¥ä½œæµç¨‹æ“ä½œï¼š å‘½ä»¤å†™å…¥ï¼ˆappendï¼‰ ã€ æ–‡ä»¶åŒæ­¥ï¼ˆsyncï¼‰ ã€ æ–‡ä»¶é‡å†™ï¼ˆrewriteï¼‰ ã€ é‡å¯åŠ è½½ ï¼ˆloadï¼‰ ï¼Œ å¦‚å›¾æ‰€ç¤º æµç¨‹å¦‚ä¸‹ï¼š æ‰€æœ‰çš„å†™å…¥å‘½ä»¤ä¼šè¿½åŠ åˆ°aof_bufï¼ˆ ç¼“å†²åŒºï¼‰ ä¸­ã€‚ AOFç¼“å†²åŒºæ ¹æ®å¯¹åº”çš„ç­–ç•¥å‘ç¡¬ç›˜åšåŒæ­¥æ“ä½œã€‚ éšç€AOFæ–‡ä»¶è¶Šæ¥è¶Šå¤§ï¼Œ éœ€è¦å®šæœŸå¯¹AOFæ–‡ä»¶è¿›è¡Œé‡å†™ï¼Œ è¾¾åˆ°å‹ç¼©çš„ç›®çš„ã€‚ å½“RedisæœåŠ¡å™¨é‡å¯æ—¶ï¼Œ å¯ä»¥åŠ è½½AOFæ–‡ä»¶è¿›è¡Œæ•°æ®æ¢å¤ã€‚ aofé‡å†™ AOFé‡æ–°è¿ä½œæµç¨‹ æµç¨‹è¯´æ˜ï¼š æ‰§è¡ŒAOFé‡å†™è¯·æ±‚ã€‚ å¦‚æœå½“å‰è¿›ç¨‹æ­£åœ¨æ‰§è¡ŒAOFé‡å†™ï¼Œ è¯·æ±‚ä¸æ‰§è¡Œå¹¶è¿”å›å¦‚ä¸‹å“åº”ï¼šERR Background append only file rewriting already in progress å¦‚æœå½“å‰è¿›ç¨‹æ­£åœ¨æ‰§è¡Œbgsaveæ“ä½œï¼Œ é‡å†™å‘½ä»¤å»¶è¿Ÿåˆ°bgsaveå®Œæˆä¹‹åå†æ‰§è¡Œï¼Œ è¿”å›å¦‚ä¸‹å“åº”ï¼šBackground append only file rewriting scheduled çˆ¶è¿›ç¨‹æ‰§è¡Œforkåˆ›å»ºå­è¿›ç¨‹ï¼Œ å¼€é”€ç­‰åŒäºbgsaveè¿‡ç¨‹ã€‚ 3.1. ä¸»è¿›ç¨‹forkæ“ä½œå®Œæˆåï¼Œ ç»§ç»­å“åº”å…¶ä»–å‘½ä»¤ã€‚ æ‰€æœ‰ä¿®æ”¹å‘½ä»¤ä¾ç„¶å†™å…¥AOFç¼“å†²åŒºå¹¶æ ¹æ®appendfsyncç­–ç•¥åŒæ­¥åˆ°ç¡¬ç›˜ï¼Œ ä¿è¯åŸæœ‰AOFæœºåˆ¶æ­£ç¡®æ€§ã€‚ 3.2. ç”±äºforkæ“ä½œè¿ç”¨å†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼Œ å­è¿›ç¨‹åªèƒ½å…±äº«forkæ“ä½œæ—¶çš„å†…å­˜æ•°æ®ã€‚ ç”±äºçˆ¶è¿›ç¨‹ä¾ç„¶å“åº”å‘½ä»¤ï¼Œ Redisä½¿ç”¨â€œAOFé‡å†™ç¼“å†²åŒºâ€ä¿å­˜è¿™éƒ¨åˆ†æ–°æ•°æ®ï¼Œ é˜²æ­¢æ–°AOFæ–‡ä»¶ç”ŸæˆæœŸé—´ä¸¢å¤±è¿™éƒ¨åˆ†æ•°æ®ã€‚ å­è¿›ç¨‹æ ¹æ®å†…å­˜å¿«ç…§ï¼Œ æŒ‰ç…§å‘½ä»¤åˆå¹¶è§„åˆ™å†™å…¥åˆ°æ–°çš„AOFæ–‡ä»¶ã€‚ æ¯æ¬¡æ‰¹é‡å†™å…¥ç¡¬ç›˜æ•°æ®é‡ç”±é…ç½®aof-rewrite-incremental-fsyncæ§åˆ¶ï¼Œ é»˜è®¤ä¸º32MBï¼Œ é˜²æ­¢å•æ¬¡åˆ·ç›˜æ•°æ®è¿‡å¤šé€ æˆç¡¬ç›˜é˜»å¡ã€‚ 5.1. æ–°AOFæ–‡ä»¶å†™å…¥å®Œæˆåï¼Œ å­è¿›ç¨‹å‘é€ä¿¡å·ç»™çˆ¶è¿›ç¨‹ï¼Œ çˆ¶è¿›ç¨‹æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼Œ å…·ä½“è§info persistenceä¸‹çš„aof_*ç›¸å…³ç»Ÿè®¡ã€‚ 5.2. çˆ¶è¿›ç¨‹æŠŠAOFé‡å†™ç¼“å†²åŒºçš„æ•°æ®å†™å…¥åˆ°æ–°çš„AOFæ–‡ä»¶ã€‚ 5.3. ä½¿ç”¨æ–°AOFæ–‡ä»¶æ›¿æ¢è€æ–‡ä»¶ï¼Œ å®ŒæˆAOFé‡å†™ã€‚ AOFè¿½åŠ é˜»å¡ å½“å¼€å¯AOFæŒä¹…åŒ–æ—¶ï¼Œ å¸¸ç”¨çš„åŒæ­¥ç¡¬ç›˜çš„ç­–ç•¥æ˜¯everysecï¼Œ ç”¨äºå¹³è¡¡æ€§èƒ½å’Œæ•°æ®å®‰å…¨æ€§ã€‚ å¯¹äºè¿™ç§æ–¹å¼ï¼Œ Redisä½¿ç”¨å¦ä¸€æ¡çº¿ç¨‹æ¯ç§’æ‰§è¡ŒfsyncåŒæ­¥ç¡¬ç›˜ã€‚ å½“ç³»ç»Ÿç¡¬ç›˜èµ„æºç¹å¿™æ—¶ï¼Œ ä¼šé€ æˆRedisä¸»çº¿ç¨‹é˜»å¡ï¼Œ å¦‚å›¾æ‰€ç¤ºã€‚ ä½¿ç”¨everysecåšåˆ·ç›˜ç­–ç•¥çš„æµç¨‹ é˜»å¡æµç¨‹åˆ†æï¼š 1ï¼‰ ä¸»çº¿ç¨‹è´Ÿè´£å†™å…¥AOFç¼“å†²åŒºã€‚ 2ï¼‰ AOFçº¿ç¨‹è´Ÿè´£æ¯ç§’æ‰§è¡Œä¸€æ¬¡åŒæ­¥ç£ç›˜æ“ä½œï¼Œ å¹¶è®°å½•æœ€è¿‘ä¸€æ¬¡åŒæ­¥æ—¶é—´ã€‚ 3ï¼‰ ä¸»çº¿ç¨‹è´Ÿè´£å¯¹æ¯”ä¸Šæ¬¡AOFåŒæ­¥æ—¶é—´ï¼š Â·å¦‚æœè·ä¸Šæ¬¡åŒæ­¥æˆåŠŸæ—¶é—´åœ¨2ç§’å†…ï¼Œ ä¸»çº¿ç¨‹ç›´æ¥è¿”å›ã€‚ Â·å¦‚æœè·ä¸Šæ¬¡åŒæ­¥æˆåŠŸæ—¶é—´è¶…è¿‡2ç§’ï¼Œ ä¸»çº¿ç¨‹å°†ä¼šé˜»å¡ï¼Œ ç›´åˆ°åŒæ­¥æ“ä½œå®Œæˆã€‚ é€šè¿‡å¯¹AOFé˜»å¡æµç¨‹å¯ä»¥å‘ç°ä¸¤ä¸ªé—®é¢˜ï¼š 1ï¼‰ everysecé…ç½®æœ€å¤šå¯èƒ½ä¸¢å¤±2ç§’æ•°æ®ï¼Œ ä¸æ˜¯1ç§’ã€‚ 2ï¼‰ å¦‚æœç³»ç»Ÿfsyncç¼“æ…¢ï¼Œ å°†ä¼šå¯¼è‡´Redisä¸»çº¿ç¨‹é˜»å¡å½±å“æ•ˆç‡ã€‚ AOFé˜»å¡é—®é¢˜å®šä½ï¼š 1ï¼‰ å‘ç”ŸAOFé˜»å¡æ—¶ï¼Œ Redisè¾“å‡ºå¦‚ä¸‹æ—¥å¿—ï¼Œ ç”¨äºè®°å½•AOF fsyncé˜»å¡å¯¼è‡´æ‹–æ…¢RedisæœåŠ¡çš„è¡Œä¸ºï¼š Asynchronous AOF fsync is taking too long (disk is busy). Writing the AOF buffer without waiting for fsync to complete, this may slow down Redis 2ï¼‰ æ¯å½“å‘ç”ŸAOFè¿½åŠ é˜»å¡äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œ åœ¨info Persistenceç»Ÿè®¡ä¸­ï¼Œaof_delayed_fsyncæŒ‡æ ‡ä¼šç´¯åŠ ï¼Œ æŸ¥çœ‹è¿™ä¸ªæŒ‡æ ‡æ–¹ä¾¿å®šä½AOFé˜»å¡é—®é¢˜ã€‚ 3ï¼‰ AOFåŒæ­¥æœ€å¤šå…è®¸2ç§’çš„å»¶è¿Ÿï¼Œ å½“å»¶è¿Ÿå‘ç”Ÿæ—¶è¯´æ˜ç¡¬ç›˜å­˜åœ¨é«˜è´Ÿè½½é—®é¢˜ï¼Œ å¯ä»¥é€šè¿‡ç›‘æ§å·¥å…·å¦‚iotopï¼Œ å®šä½æ¶ˆè€—ç¡¬ç›˜IOèµ„æºçš„è¿›ç¨‹ã€‚ä¼˜åŒ–AOFè¿½åŠ é˜»å¡é—®é¢˜ä¸»è¦æ˜¯ä¼˜åŒ–ç³»ç»Ÿç¡¬ç›˜è´Ÿè½½ ä¼˜ç‚¹ï¼š 1ã€æ•°æ®å®‰å…¨ï¼Œaof æŒä¹…åŒ–å¯ä»¥é…ç½® appendfsync å±æ€§ã€‚ é…ç½®ä¸ºalwaysæ—¶ï¼Œ æ¯æ¬¡å†™å…¥éƒ½è¦åŒæ­¥AOFæ–‡ä»¶ï¼Œ åœ¨ä¸€èˆ¬çš„SATAç¡¬ç›˜ä¸Šï¼Œ Redisåªèƒ½æ”¯æŒå¤§çº¦å‡ ç™¾TPSå†™å…¥ï¼Œ æ˜¾ç„¶è·ŸRedisé«˜æ€§èƒ½ç‰¹æ€§èƒŒé“è€Œé©°ï¼Œä¸å»ºè®®é…ç½®ã€‚ é…ç½®ä¸ºnoï¼Œ ç”±äºæ“ä½œç³»ç»Ÿæ¯æ¬¡åŒæ­¥AOFæ–‡ä»¶çš„å‘¨æœŸä¸å¯æ§ï¼Œ è€Œä¸”ä¼šåŠ å¤§æ¯æ¬¡åŒæ­¥ç¡¬ç›˜çš„æ•°æ®é‡ï¼Œ è™½ç„¶æå‡äº†æ€§èƒ½ï¼Œ ä½†æ•°æ®å®‰å…¨æ€§æ— æ³•ä¿è¯ã€‚ é…ç½®ä¸ºeverysecï¼Œ æ˜¯å»ºè®®çš„åŒæ­¥ç­–ç•¥ï¼Œ ä¹Ÿæ˜¯é»˜è®¤é…ç½®ï¼Œ åšåˆ°å…¼é¡¾æ€§èƒ½å’Œæ•°æ®å®‰å…¨æ€§ã€‚ ç†è®ºä¸Šåªæœ‰åœ¨ç³»ç»Ÿçªç„¶å®•æœºçš„æƒ…å†µä¸‹ä¸¢å¤±1ç§’çš„æ•°æ® 2ã€é€šè¿‡ append æ¨¡å¼å†™æ–‡ä»¶ï¼Œå³ä½¿ä¸­é€”æœåŠ¡å™¨å®•æœºï¼Œå¯ä»¥é€šè¿‡ redis-check-aof å·¥å…·è§£å†³æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚ 3ã€AOF æœºåˆ¶çš„ rewrite æ¨¡å¼ã€‚AOF æ–‡ä»¶æ²¡è¢« rewrite ä¹‹å‰ï¼ˆæ–‡ä»¶è¿‡å¤§æ—¶ä¼šå¯¹å‘½ä»¤ è¿›è¡Œåˆå¹¶é‡å†™ï¼‰ï¼Œå¯ä»¥åˆ é™¤å…¶ä¸­çš„æŸäº›å‘½ä»¤ï¼ˆæ¯”å¦‚è¯¯æ“ä½œçš„ flushallï¼‰) ç¼ºç‚¹ï¼š 1ã€AOF æ–‡ä»¶æ¯” RDB æ–‡ä»¶å¤§ï¼Œä¸”æ¢å¤é€Ÿåº¦æ…¢ã€‚ 2ã€æ•°æ®é›†å¤§çš„æ—¶å€™ï¼Œæ¯” rdb å¯åŠ¨æ•ˆç‡ä½ã€‚ æ¯”è¾ƒ AOFæ–‡ä»¶æ¯”RDBæ›´æ–°é¢‘ç‡é«˜ï¼Œä¼˜å…ˆä½¿ç”¨AOFè¿˜åŸæ•°æ®ã€‚ AOFæ¯”RDBæ›´å®‰å…¨ä¹Ÿæ›´å¤§ RDBæ€§èƒ½æ¯”AOFå¥½ å¦‚æœä¸¤ä¸ªéƒ½é…äº†ä¼˜å…ˆåŠ è½½AOF å¦‚ä½•é€‰æ‹©åˆé€‚çš„æŒä¹…åŒ–æ–¹å¼ ä¸€èˆ¬æ¥è¯´ï¼Œ å¦‚æœæƒ³è¾¾åˆ°è¶³ä»¥åª²ç¾PostgreSQLçš„æ•°æ®å®‰å…¨æ€§ï¼Œä½ åº”è¯¥åŒæ—¶ä½¿ç”¨ä¸¤ç§æŒä¹…åŒ–åŠŸèƒ½ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“ Redis é‡å¯çš„æ—¶å€™ä¼šä¼˜å…ˆè½½å…¥AOFæ–‡ä»¶æ¥æ¢å¤åŸå§‹çš„æ•°æ®ï¼Œå› ä¸ºåœ¨é€šå¸¸æƒ…å†µä¸‹AOFæ–‡ä»¶ä¿å­˜çš„æ•°æ®é›†è¦æ¯”RDBæ–‡ä»¶ä¿å­˜çš„æ•°æ®é›†è¦å®Œæ•´ã€‚ å¦‚æœä½ éå¸¸å…³å¿ƒä½ çš„æ•°æ®ï¼Œ ä½†ä»ç„¶å¯ä»¥æ‰¿å—æ•°åˆ†é’Ÿä»¥å†…çš„æ•°æ®ä¸¢å¤±ï¼Œé‚£ä¹ˆä½ å¯ä»¥åªä½¿ç”¨RDBæŒä¹…åŒ–ã€‚ æœ‰å¾ˆå¤šç”¨æˆ·éƒ½åªä½¿ç”¨AOFæŒä¹…åŒ–ï¼Œä½†å¹¶ä¸æ¨èè¿™ç§æ–¹å¼ï¼Œå› ä¸ºå®šæ—¶ç”ŸæˆRDBå¿«ç…§ï¼ˆsnapshotï¼‰éå¸¸ä¾¿äºè¿›è¡Œæ•°æ®åº“å¤‡ä»½ï¼Œ å¹¶ä¸” RDB æ¢å¤æ•°æ®é›†çš„é€Ÿåº¦ä¹Ÿè¦æ¯”AOFæ¢å¤çš„é€Ÿåº¦è¦å¿«ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œä½¿ç”¨RDBè¿˜å¯ä»¥é¿å…AOFç¨‹åºçš„bugã€‚ å¦‚æœä½ åªå¸Œæœ›ä½ çš„æ•°æ®åœ¨æœåŠ¡å™¨è¿è¡Œçš„æ—¶å€™å­˜åœ¨ï¼Œä½ ä¹Ÿå¯ä»¥ä¸ä½¿ç”¨ä»»ä½•æŒä¹…åŒ–æ–¹å¼ã€‚ RedisæŒä¹…åŒ–æ•°æ®å’Œç¼“å­˜æ€ä¹ˆåšæ‰©å®¹ï¼Ÿ å¦‚æœRedisè¢«å½“åšç¼“å­˜ä½¿ç”¨ï¼Œä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œå®ç°åŠ¨æ€æ‰©å®¹ç¼©å®¹ã€‚ å¦‚æœRedisè¢«å½“åšä¸€ä¸ªæŒä¹…åŒ–å­˜å‚¨ä½¿ç”¨ï¼Œå¿…é¡»ä½¿ç”¨å›ºå®šçš„keys-to-nodesæ˜ å°„å…³ç³»ï¼ŒèŠ‚ç‚¹çš„æ•°é‡ä¸€æ—¦ç¡®å®šä¸èƒ½å˜åŒ–ã€‚å¦åˆ™çš„è¯(å³RedisèŠ‚ç‚¹éœ€è¦åŠ¨æ€å˜åŒ–çš„æƒ…å†µï¼‰ï¼Œå¿…é¡»ä½¿ç”¨å¯ä»¥åœ¨è¿è¡Œæ—¶è¿›è¡Œæ•°æ®å†å¹³è¡¡çš„ä¸€å¥—ç³»ç»Ÿï¼Œè€Œå½“å‰åªæœ‰Redisé›†ç¾¤å¯ä»¥åšåˆ°è¿™æ ·ã€‚ Redisçš„è¿‡æœŸé”®çš„åˆ é™¤ç­–ç•¥ æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒRedisæ˜¯key-valueæ•°æ®åº“ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®Redisä¸­ç¼“å­˜çš„keyçš„è¿‡æœŸæ—¶é—´ã€‚Redisçš„è¿‡æœŸç­–ç•¥å°±æ˜¯æŒ‡å½“Redisä¸­ç¼“å­˜çš„keyè¿‡æœŸäº†ï¼ŒRediså¦‚ä½•å¤„ç†ã€‚ è¿‡æœŸç­–ç•¥é€šå¸¸æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š å®šæ—¶è¿‡æœŸï¼šæ¯ä¸ªè®¾ç½®è¿‡æœŸæ—¶é—´çš„keyéƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼Œåˆ°è¿‡æœŸæ—¶é—´å°±ä¼šç«‹å³æ¸…é™¤ã€‚è¯¥ç­–ç•¥å¯ä»¥ç«‹å³æ¸…é™¤è¿‡æœŸçš„æ•°æ®ï¼Œå¯¹å†…å­˜å¾ˆå‹å¥½ï¼›ä½†æ˜¯ä¼šå ç”¨å¤§é‡çš„CPUèµ„æºå»å¤„ç†è¿‡æœŸçš„æ•°æ®ï¼Œä»è€Œå½±å“ç¼“å­˜çš„å“åº”æ—¶é—´å’Œååé‡ã€‚ æƒ°æ€§è¿‡æœŸï¼šåªæœ‰å½“è®¿é—®ä¸€ä¸ªkeyæ—¶ï¼Œæ‰ä¼šåˆ¤æ–­è¯¥keyæ˜¯å¦å·²è¿‡æœŸï¼Œè¿‡æœŸåˆ™æ¸…é™¤ã€‚è¯¥ç­–ç•¥å¯ä»¥æœ€å¤§åŒ–åœ°èŠ‚çœCPUèµ„æºï¼Œå´å¯¹å†…å­˜éå¸¸ä¸å‹å¥½ã€‚æç«¯æƒ…å†µå¯èƒ½å‡ºç°å¤§é‡çš„è¿‡æœŸkeyæ²¡æœ‰å†æ¬¡è¢«è®¿é—®ï¼Œä»è€Œä¸ä¼šè¢«æ¸…é™¤ï¼Œå ç”¨å¤§é‡å†…å­˜ã€‚ å®šæœŸè¿‡æœŸï¼šæ¯éš”ä¸€å®šçš„æ—¶é—´ï¼Œä¼šæ‰«æä¸€å®šæ•°é‡çš„æ•°æ®åº“çš„expireså­—å…¸ä¸­ä¸€å®šæ•°é‡çš„keyï¼Œå¹¶æ¸…é™¤å…¶ä¸­å·²è¿‡æœŸçš„keyã€‚è¯¥ç­–ç•¥æ˜¯å‰ä¸¤è€…çš„ä¸€ä¸ªæŠ˜ä¸­æ–¹æ¡ˆã€‚é€šè¿‡è°ƒæ•´å®šæ—¶æ‰«æçš„æ—¶é—´é—´éš”å’Œæ¯æ¬¡æ‰«æçš„é™å®šè€—æ—¶ï¼Œå¯ä»¥åœ¨ä¸åŒæƒ…å†µä¸‹ä½¿å¾—CPUå’Œå†…å­˜èµ„æºè¾¾åˆ°æœ€ä¼˜çš„å¹³è¡¡æ•ˆæœã€‚ (expireså­—å…¸ä¼šä¿å­˜æ‰€æœ‰è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyçš„è¿‡æœŸæ—¶é—´æ•°æ®ï¼Œå…¶ä¸­ï¼Œkeyæ˜¯æŒ‡å‘é”®ç©ºé—´ä¸­çš„æŸä¸ªé”®çš„æŒ‡é’ˆï¼Œvalueæ˜¯è¯¥é”®çš„æ¯«ç§’ç²¾åº¦çš„UNIXæ—¶é—´æˆ³è¡¨ç¤ºçš„è¿‡æœŸæ—¶é—´ã€‚é”®ç©ºé—´æ˜¯æŒ‡è¯¥Redisé›†ç¾¤ä¸­ä¿å­˜çš„æ‰€æœ‰é”®ã€‚) Redisä¸­åŒæ—¶ä½¿ç”¨äº†æƒ°æ€§è¿‡æœŸå’Œå®šæœŸè¿‡æœŸä¸¤ç§è¿‡æœŸç­–ç•¥ã€‚ rediså†…å­˜ rediså†…å­˜æ•°æ®é›†å¤§å°ä¸Šå‡åˆ°ä¸€å®šå¤§å°çš„æ—¶å€™ï¼Œå°±ä¼šæ–½è¡Œæ•°æ®æ·˜æ±°ç­–ç•¥ã€‚ Redisçš„å†…å­˜æ·˜æ±°ç­–ç•¥æœ‰å“ªäº› Redisçš„å†…å­˜æ·˜æ±°ç­–ç•¥æ˜¯æŒ‡åœ¨Redisçš„ç”¨äºç¼“å­˜çš„å†…å­˜ä¸è¶³æ—¶ï¼Œæ€ä¹ˆå¤„ç†éœ€è¦æ–°å†™å…¥ä¸”éœ€è¦ç”³è¯·é¢å¤–ç©ºé—´çš„æ•°æ®ã€‚ å…¨å±€çš„é”®ç©ºé—´é€‰æ‹©æ€§ç§»é™¤ noevictionï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œæ–°å†™å…¥æ“ä½œä¼šæŠ¥é”™ã€‚ allkeys-lruï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨é”®ç©ºé—´ä¸­ï¼Œç§»é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„keyã€‚ï¼ˆè¿™ä¸ªæ˜¯æœ€å¸¸ç”¨çš„ï¼‰ allkeys-randomï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨é”®ç©ºé—´ä¸­ï¼Œéšæœºç§»é™¤æŸä¸ªkeyã€‚ allkeys-lfuï¼šä»æ‰€æœ‰é”®ä¸­é©±é€ä½¿ç”¨é¢‘ç‡æœ€å°‘çš„é”® è®¾ç½®è¿‡æœŸæ—¶é—´çš„é”®ç©ºé—´é€‰æ‹©æ€§ç§»é™¤ volatile-lruï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ç©ºé—´ä¸­ï¼Œç§»é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„keyã€‚ volatile-randomï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ç©ºé—´ä¸­ï¼Œéšæœºç§»é™¤æŸä¸ªkeyã€‚ volatile-ttlï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ç©ºé—´ä¸­ï¼Œæœ‰æ›´æ—©è¿‡æœŸæ—¶é—´çš„keyä¼˜å…ˆç§»é™¤ã€‚ volatile-lfuï¼šä»æ‰€æœ‰é…ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ä¸­é©±é€ä½¿ç”¨é¢‘ç‡æœ€å°‘çš„é”® æ€»ç»“ Redisçš„å†…å­˜æ·˜æ±°ç­–ç•¥çš„é€‰å–å¹¶ä¸ä¼šå½±å“è¿‡æœŸçš„keyçš„å¤„ç†ã€‚å†…å­˜æ·˜æ±°ç­–ç•¥ç”¨äºå¤„ç†å†…å­˜ä¸è¶³æ—¶çš„éœ€è¦ç”³è¯·é¢å¤–ç©ºé—´çš„æ•°æ®ï¼›è¿‡æœŸç­–ç•¥ç”¨äºå¤„ç†è¿‡æœŸçš„ç¼“å­˜æ•°æ®ã€‚ Redisä¸»è¦æ¶ˆè€—ä»€ä¹ˆç‰©ç†èµ„æºï¼Ÿ å†…å­˜ã€‚ Redisçš„å†…å­˜ç”¨å®Œäº†ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ å¦‚æœè¾¾åˆ°è®¾ç½®çš„ä¸Šé™ï¼ŒRedisçš„å†™å‘½ä»¤ä¼šè¿”å›é”™è¯¯ä¿¡æ¯ï¼ˆä½†æ˜¯è¯»å‘½ä»¤è¿˜å¯ä»¥æ­£å¸¸è¿”å›ã€‚ï¼‰æˆ–è€…ä½ å¯ä»¥é…ç½®å†…å­˜æ·˜æ±°æœºåˆ¶ï¼Œå½“Redisè¾¾åˆ°å†…å­˜ä¸Šé™æ—¶ä¼šå†²åˆ·æ‰æ—§çš„å†…å®¹ã€‚ Rediså¦‚ä½•åšå†…å­˜ä¼˜åŒ–ï¼Ÿ å¯ä»¥å¥½å¥½åˆ©ç”¨Hash,list,sorted set,setç­‰é›†åˆç±»å‹æ•°æ®ï¼Œå› ä¸ºé€šå¸¸æƒ…å†µä¸‹å¾ˆå¤šå°çš„Key-Valueå¯ä»¥ç”¨æ›´ç´§å‡‘çš„æ–¹å¼å­˜æ”¾åˆ°ä¸€èµ·ã€‚å°½å¯èƒ½ä½¿ç”¨æ•£åˆ—è¡¨ï¼ˆhashesï¼‰ï¼Œæ•£åˆ—è¡¨ï¼ˆæ˜¯è¯´æ•£åˆ—è¡¨é‡Œé¢å­˜å‚¨çš„æ•°å°‘ï¼‰ä½¿ç”¨çš„å†…å­˜éå¸¸å°ï¼Œæ‰€ä»¥ä½ åº”è¯¥å°½å¯èƒ½çš„å°†ä½ çš„æ•°æ®æ¨¡å‹æŠ½è±¡åˆ°ä¸€ä¸ªæ•£åˆ—è¡¨é‡Œé¢ã€‚æ¯”å¦‚ä½ çš„webç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªç”¨æˆ·å¯¹è±¡ï¼Œä¸è¦ä¸ºè¿™ä¸ªç”¨æˆ·çš„åç§°ï¼Œå§“æ°ï¼Œé‚®ç®±ï¼Œå¯†ç è®¾ç½®å•ç‹¬çš„keyï¼Œè€Œæ˜¯åº”è¯¥æŠŠè¿™ä¸ªç”¨æˆ·çš„æ‰€æœ‰ä¿¡æ¯å­˜å‚¨åˆ°ä¸€å¼ æ•£åˆ—è¡¨é‡Œé¢ Redisçº¿ç¨‹æ¨¡å‹ RedisåŸºäºReactoræ¨¡å¼å¼€å‘äº†ç½‘ç»œäº‹ä»¶å¤„ç†å™¨ï¼Œè¿™ä¸ªå¤„ç†å™¨è¢«ç§°ä¸ºæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆfile event handlerï¼‰ã€‚å®ƒçš„ç»„æˆç»“æ„ä¸º4éƒ¨åˆ†ï¼šå¤šä¸ªå¥—æ¥å­—ã€IOå¤šè·¯å¤ç”¨ç¨‹åºã€æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ã€äº‹ä»¶å¤„ç†å™¨ã€‚å› ä¸ºæ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨é˜Ÿåˆ—çš„æ¶ˆè´¹æ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥Redisæ‰å«å•çº¿ç¨‹æ¨¡å‹ã€‚ æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä½¿ç”¨ I/O å¤šè·¯å¤ç”¨ï¼ˆmultiplexingï¼‰ç¨‹åºæ¥åŒæ—¶ç›‘å¬å¤šä¸ªå¥—æ¥å­—ï¼Œ å¹¶æ ¹æ®å¥—æ¥å­—ç›®å‰æ‰§è¡Œçš„ä»»åŠ¡æ¥ä¸ºå¥—æ¥å­—å…³è”ä¸åŒçš„äº‹ä»¶å¤„ç†å™¨ã€‚ å½“è¢«ç›‘å¬çš„å¥—æ¥å­—å‡†å¤‡å¥½æ‰§è¡Œè¿æ¥åº”ç­”ï¼ˆacceptï¼‰ã€è¯»å–ï¼ˆreadï¼‰ã€å†™å…¥ï¼ˆwriteï¼‰ã€å…³é—­ï¼ˆcloseï¼‰ç­‰æ“ä½œæ—¶ï¼Œ ä¸æ“ä½œç›¸å¯¹åº”çš„æ–‡ä»¶äº‹ä»¶å°±ä¼šäº§ç”Ÿï¼Œ è¿™æ—¶æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨å°±ä¼šè°ƒç”¨å¥—æ¥å­—ä¹‹å‰å…³è”å¥½çš„äº‹ä»¶å¤„ç†å™¨æ¥å¤„ç†è¿™äº›äº‹ä»¶ã€‚ è™½ç„¶æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä»¥å•çº¿ç¨‹æ–¹å¼è¿è¡Œï¼Œ ä½†é€šè¿‡ä½¿ç”¨ I/O å¤šè·¯å¤ç”¨ç¨‹åºæ¥ç›‘å¬å¤šä¸ªå¥—æ¥å­—ï¼Œ æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨æ—¢å®ç°äº†é«˜æ€§èƒ½çš„ç½‘ç»œé€šä¿¡æ¨¡å‹ï¼Œ åˆå¯ä»¥å¾ˆå¥½åœ°ä¸ redis æœåŠ¡å™¨ä¸­å…¶ä»–åŒæ ·ä»¥å•çº¿ç¨‹æ–¹å¼è¿è¡Œçš„æ¨¡å—è¿›è¡Œå¯¹æ¥ï¼Œ è¿™ä¿æŒäº† Redis å†…éƒ¨å•çº¿ç¨‹è®¾è®¡çš„ç®€å•æ€§ã€‚ å‚è€ƒï¼šhttps://www.cnblogs.com/barrywxx/p/8570821.html äº‹åŠ¡ äº‹åŠ¡æ˜¯ä¸€ä¸ªå•ç‹¬çš„éš”ç¦»æ“ä½œï¼šäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½ä¼šåºåˆ—åŒ–ã€æŒ‰é¡ºåºåœ°æ‰§è¡Œã€‚äº‹åŠ¡åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šè¢«å…¶ä»–å®¢æˆ·ç«¯å‘é€æ¥çš„å‘½ä»¤è¯·æ±‚æ‰€æ‰“æ–­.äº‹åŠ¡æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼šäº‹åŠ¡ä¸­çš„å‘½ä»¤è¦ä¹ˆå…¨éƒ¨è¢«æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨éƒ½ä¸æ‰§è¡Œã€‚ Redisäº‹åŠ¡çš„æ¦‚å¿µ Redis äº‹åŠ¡çš„æœ¬è´¨æ˜¯é€šè¿‡MULTIã€EXECã€DISCARDã€WATCHç­‰ä¸€ç»„å‘½ä»¤çš„é›†åˆã€‚äº‹åŠ¡æ”¯æŒä¸€æ¬¡æ‰§è¡Œå¤šä¸ªå‘½ä»¤ï¼Œä¸€ä¸ªäº‹åŠ¡ä¸­æ‰€æœ‰å‘½ä»¤éƒ½ä¼šè¢«åºåˆ—åŒ–ã€‚åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ï¼Œä¼šæŒ‰ç…§é¡ºåºä¸²è¡ŒåŒ–æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„å‘½ä»¤ï¼Œå…¶ä»–å®¢æˆ·ç«¯æäº¤çš„å‘½ä»¤è¯·æ±‚ä¸ä¼šæ’å…¥åˆ°äº‹åŠ¡æ‰§è¡Œå‘½ä»¤åºåˆ—ä¸­ã€‚ æ€»ç»“è¯´ï¼šredisäº‹åŠ¡å°±æ˜¯ä¸€æ¬¡æ€§ã€é¡ºåºæ€§ã€æ’ä»–æ€§çš„æ‰§è¡Œä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„ä¸€ç³»åˆ—å‘½ä»¤ã€‚ Redisäº‹åŠ¡çš„ä¸‰ä¸ªé˜¶æ®µ äº‹åŠ¡å¼€å§‹ MULTI å‘½ä»¤å…¥é˜Ÿ äº‹åŠ¡æ‰§è¡Œ EXEC äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœåŠ¡ç«¯æ”¶åˆ°æœ‰EXECã€DISCARDã€WATCHã€MULTIä¹‹å¤–çš„è¯·æ±‚ï¼Œå°†ä¼šæŠŠè¯·æ±‚æ”¾å…¥é˜Ÿåˆ—ä¸­æ’é˜Ÿ Redisäº‹åŠ¡ç›¸å…³å‘½ä»¤ Redisäº‹åŠ¡åŠŸèƒ½æ˜¯é€šè¿‡MULTIã€EXECã€DISCARDå’ŒWATCH å››ä¸ªåŸè¯­å®ç°çš„ Redisä¼šå°†ä¸€ä¸ªäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤åºåˆ—åŒ–ï¼Œç„¶åæŒ‰é¡ºåºæ‰§è¡Œã€‚ redis ä¸æ”¯æŒå›æ»šï¼Œâ€œRedis åœ¨äº‹åŠ¡å¤±è´¥æ—¶ä¸è¿›è¡Œå›æ»šï¼Œè€Œæ˜¯ç»§ç»­æ‰§è¡Œä½™ä¸‹çš„å‘½ä»¤â€ï¼Œ æ‰€ä»¥ Redis çš„å†…éƒ¨å¯ä»¥ä¿æŒç®€å•ä¸”å¿«é€Ÿã€‚ å¦‚æœåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­çš„å‘½ä»¤å‡ºç°é”™è¯¯ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„å‘½ä»¤éƒ½ä¸ä¼šæ‰§è¡Œï¼› å¦‚æœåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­å‡ºç°è¿è¡Œé”™è¯¯ï¼Œé‚£ä¹ˆæ­£ç¡®çš„å‘½ä»¤ä¼šè¢«æ‰§è¡Œã€‚ WATCH å‘½ä»¤æ˜¯ä¸€ä¸ªä¹è§‚é”ï¼Œå¯ä»¥ä¸º Redis äº‹åŠ¡æä¾› check-and-set ï¼ˆCASï¼‰è¡Œä¸ºã€‚ å¯ä»¥ç›‘æ§ä¸€ä¸ªæˆ–å¤šä¸ªé”®ï¼Œä¸€æ—¦å…¶ä¸­æœ‰ä¸€ä¸ªé”®è¢«ä¿®æ”¹ï¼ˆæˆ–åˆ é™¤ï¼‰ï¼Œä¹‹åçš„äº‹åŠ¡å°±ä¸ä¼šæ‰§è¡Œï¼Œç›‘æ§ä¸€ç›´æŒç»­åˆ°EXECå‘½ä»¤ã€‚ MULTIå‘½ä»¤ç”¨äºå¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œå®ƒæ€»æ˜¯è¿”å›OKã€‚ MULTIæ‰§è¡Œä¹‹åï¼Œå®¢æˆ·ç«¯å¯ä»¥ç»§ç»­å‘æœåŠ¡å™¨å‘é€ä»»æ„å¤šæ¡å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤ä¸ä¼šç«‹å³è¢«æ‰§è¡Œï¼Œè€Œæ˜¯è¢«æ”¾åˆ°ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œå½“EXECå‘½ä»¤è¢«è°ƒç”¨æ—¶ï¼Œæ‰€æœ‰é˜Ÿåˆ—ä¸­çš„å‘½ä»¤æ‰ä¼šè¢«æ‰§è¡Œã€‚ EXECï¼šæ‰§è¡Œæ‰€æœ‰äº‹åŠ¡å—å†…çš„å‘½ä»¤ã€‚è¿”å›äº‹åŠ¡å—å†…æ‰€æœ‰å‘½ä»¤çš„è¿”å›å€¼ï¼ŒæŒ‰å‘½ä»¤æ‰§è¡Œçš„å…ˆåé¡ºåºæ’åˆ—ã€‚ å½“æ“ä½œè¢«æ‰“æ–­æ—¶ï¼Œè¿”å›ç©ºå€¼ nil ã€‚ é€šè¿‡è°ƒç”¨DISCARDï¼Œå®¢æˆ·ç«¯å¯ä»¥æ¸…ç©ºäº‹åŠ¡é˜Ÿåˆ—ï¼Œå¹¶æ”¾å¼ƒæ‰§è¡Œäº‹åŠ¡ï¼Œ å¹¶ä¸”å®¢æˆ·ç«¯ä¼šä»äº‹åŠ¡çŠ¶æ€ä¸­é€€å‡ºã€‚ UNWATCHå‘½ä»¤å¯ä»¥å–æ¶ˆwatchå¯¹æ‰€æœ‰keyçš„ç›‘æ§ã€‚ äº‹åŠ¡ç®¡ç†ï¼ˆACIDï¼‰æ¦‚è¿° åŸå­æ€§ï¼ˆAtomicityï¼‰ åŸå­æ€§æ˜¯æŒ‡äº‹åŠ¡æ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ï¼Œäº‹åŠ¡ä¸­çš„æ“ä½œè¦ä¹ˆéƒ½å‘ç”Ÿï¼Œè¦ä¹ˆéƒ½ä¸å‘ç”Ÿã€‚ ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ äº‹åŠ¡å‰åæ•°æ®çš„å®Œæ•´æ€§å¿…é¡»ä¿æŒä¸€è‡´ã€‚ éš”ç¦»æ€§ï¼ˆIsolationï¼‰ å¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶ï¼Œä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸åº”å½±å“å…¶ä»–äº‹åŠ¡çš„æ‰§è¡Œ æŒä¹…æ€§ï¼ˆDurabilityï¼‰ æŒä¹…æ€§æ˜¯æŒ‡ä¸€ä¸ªäº‹åŠ¡ä¸€æ—¦è¢«æäº¤ï¼Œå®ƒå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜å°±æ˜¯æ°¸ä¹…æ€§çš„ï¼Œæ¥ä¸‹æ¥å³ä½¿æ•°æ®åº“å‘ç”Ÿæ•…éšœä¹Ÿä¸åº”è¯¥å¯¹å…¶æœ‰ä»»ä½•å½±å“ Redisçš„äº‹åŠ¡æ€»æ˜¯å…·æœ‰ACIDä¸­çš„éš”ç¦»æ€§ï¼Œä¸å…·æœ‰éš”ç¦»çº§åˆ«ï¼Œå…¶ä»–ç‰¹æ€§æ˜¯ä¸æ”¯æŒçš„ã€‚å½“æœåŠ¡å™¨è¿è¡Œåœ¨AOFæŒä¹…åŒ–æ¨¡å¼ä¸‹ï¼Œå¹¶ä¸”appendfsyncé€‰é¡¹çš„å€¼ä¸ºalwaysæ—¶ï¼Œäº‹åŠ¡ä¹Ÿå…·æœ‰æŒä¹…æ€§ã€‚ Redisäº‹åŠ¡æ”¯æŒéš”ç¦»æ€§å— Redis æ˜¯å•è¿›ç¨‹ç¨‹åºï¼Œå¹¶ä¸”å®ƒä¿è¯åœ¨æ‰§è¡Œäº‹åŠ¡æ—¶ï¼Œä¸ä¼šå¯¹äº‹åŠ¡è¿›è¡Œä¸­æ–­ï¼Œäº‹åŠ¡å¯ä»¥è¿è¡Œç›´åˆ°æ‰§è¡Œå®Œæ‰€æœ‰äº‹åŠ¡é˜Ÿåˆ—ä¸­çš„å‘½ä»¤ä¸ºæ­¢ã€‚å› æ­¤ï¼ŒRedis çš„äº‹åŠ¡æ˜¯æ€»æ˜¯å¸¦æœ‰éš”ç¦»æ€§çš„ï¼Œå› ä¸ºæ˜¯å•çº¿ç¨‹ä¸å…·æœ‰éš”ç¦»çº§åˆ«ã€‚ Redisäº‹åŠ¡ä¿è¯åŸå­æ€§å—ï¼Œæ”¯æŒå›æ»šå— Redisä¸­ï¼Œå•æ¡å‘½ä»¤æ˜¯åŸå­æ€§æ‰§è¡Œçš„ï¼Œä½†äº‹åŠ¡ä¸ä¿è¯åŸå­æ€§ï¼Œä¸”æ²¡æœ‰å›æ»šã€‚äº‹åŠ¡ä¸­ä»»æ„å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå…¶ä½™çš„å‘½ä»¤ä»ä¼šè¢«æ‰§è¡Œã€‚ Redisäº‹åŠ¡å…¶ä»–å®ç° åŸºäºLuaè„šæœ¬ï¼ŒRediså¯ä»¥ä¿è¯è„šæœ¬å†…çš„å‘½ä»¤ä¸€æ¬¡æ€§ã€æŒ‰é¡ºåºåœ°æ‰§è¡Œï¼Œ å…¶åŒæ—¶ä¹Ÿä¸æä¾›äº‹åŠ¡è¿è¡Œé”™è¯¯çš„å›æ»šï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­å¦‚æœéƒ¨åˆ†å‘½ä»¤è¿è¡Œé”™è¯¯ï¼Œå‰©ä¸‹çš„å‘½ä»¤è¿˜æ˜¯ä¼šç»§ç»­è¿è¡Œå®Œ åŸºäºä¸­é—´æ ‡è®°å˜é‡ï¼Œé€šè¿‡å¦å¤–çš„æ ‡è®°å˜é‡æ¥æ ‡è¯†äº‹åŠ¡æ˜¯å¦æ‰§è¡Œå®Œæˆï¼Œè¯»å–æ•°æ®æ—¶å…ˆè¯»å–è¯¥æ ‡è®°å˜é‡åˆ¤æ–­æ˜¯å¦äº‹åŠ¡æ‰§è¡Œå®Œæˆã€‚ä½†è¿™æ ·ä¼šéœ€è¦é¢å¤–å†™ä»£ç å®ç°ï¼Œæ¯”è¾ƒç¹ç ","link":"https://tianxiawuhao.github.io/WAG-fYk_l/"},{"title":"redisæ¦‚è¿°äºŒ","content":"Redisæœ‰å“ªäº›æ•°æ®ç±»å‹ Redisä¸»è¦æœ‰5ç§æ•°æ®ç±»å‹ï¼ŒåŒ…æ‹¬Stringï¼ŒListï¼ŒSetï¼ŒZsetï¼ŒHashï¼Œæ»¡è¶³å¤§éƒ¨åˆ†çš„ä½¿ç”¨è¦æ±‚ æ•°æ®ç±»å‹ å¯ä»¥å­˜å‚¨çš„å€¼ æ“ä½œ åº”ç”¨åœºæ™¯ STRING å­—ç¬¦ä¸²ã€æ•´æ•°æˆ–è€…æµ®ç‚¹æ•° å¯¹æ•´ä¸ªå­—ç¬¦ä¸²æˆ–è€…å­—ç¬¦ä¸²çš„å…¶ä¸­ä¸€éƒ¨åˆ†æ‰§è¡Œæ“ä½œå¯¹æ•´æ•°å’Œæµ®ç‚¹æ•°æ‰§è¡Œè‡ªå¢æˆ–è€…è‡ªå‡æ“ä½œ åšç®€å•çš„é”®å€¼å¯¹ç¼“å­˜ LIST åˆ—è¡¨ ä»ä¸¤ç«¯å‹å…¥æˆ–è€…å¼¹å‡ºå…ƒç´ å¯¹å•ä¸ªæˆ–è€…å¤šä¸ªå…ƒç´ è¿›è¡Œä¿®å‰ªï¼Œåªä¿ç•™ä¸€ä¸ªèŒƒå›´å†…çš„å…ƒç´  å­˜å‚¨ä¸€äº›åˆ—è¡¨å‹çš„æ•°æ®ç»“æ„ï¼Œç±»ä¼¼ç²‰ä¸åˆ—è¡¨ã€æ–‡ç« çš„è¯„è®ºåˆ—è¡¨ä¹‹ç±»çš„æ•°æ® SET æ— åºé›†åˆ æ·»åŠ ã€è·å–ã€ç§»é™¤å•ä¸ªå…ƒç´ æ£€æŸ¥ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äºé›†åˆä¸­è®¡ç®—äº¤é›†ã€å¹¶é›†ã€å·®é›†ä»é›†åˆé‡Œé¢éšæœºè·å–å…ƒç´  äº¤é›†ã€å¹¶é›†ã€å·®é›†çš„æ“ä½œï¼Œæ¯”å¦‚äº¤é›†ï¼Œå¯ä»¥æŠŠä¸¤ä¸ªäººçš„ç²‰ä¸åˆ—è¡¨æ•´ä¸€ä¸ªäº¤é›† HASH åŒ…å«é”®å€¼å¯¹çš„æ— åºæ•£åˆ—è¡¨ æ·»åŠ ã€è·å–ã€ç§»é™¤å•ä¸ªé”®å€¼å¯¹è·å–æ‰€æœ‰é”®å€¼å¯¹æ£€æŸ¥æŸä¸ªé”®æ˜¯å¦å­˜åœ¨ ç»“æ„åŒ–çš„æ•°æ®ï¼Œæ¯”å¦‚ä¸€ä¸ªå¯¹è±¡ ZSET æœ‰åºé›†åˆ æ·»åŠ ã€è·å–ã€åˆ é™¤å…ƒç´ æ ¹æ®åˆ†å€¼èŒƒå›´æˆ–è€…æˆå‘˜æ¥è·å–å…ƒç´ è®¡ç®—ä¸€ä¸ªé”®çš„æ’å å»é‡ä½†å¯ä»¥æ’åºï¼Œå¦‚è·å–æ’åå‰å‡ åçš„ç”¨æˆ· Redisæ•°æ®è¯¦è§£ String è®¾ç½®å€¼ //è®¾ç½®å€¼ set key value [ex seconds] [px milliseconds] [nx|xx] 127.0.0.1:6379&gt; set hello world setå‘½ä»¤æœ‰å‡ ä¸ªé€‰é¡¹ï¼š Â·ex secondsï¼š ä¸ºé”®è®¾ç½®ç§’çº§è¿‡æœŸæ—¶é—´ã€‚ Â·px millisecondsï¼š ä¸ºé”®è®¾ç½®æ¯«ç§’çº§è¿‡æœŸæ—¶é—´ã€‚ Â·nxï¼š é”®å¿…é¡»ä¸å­˜åœ¨ï¼Œ æ‰å¯ä»¥è®¾ç½®æˆåŠŸï¼Œ ç”¨äºæ·»åŠ ã€‚ Â·xxï¼š ä¸nxç›¸åï¼Œ é”®å¿…é¡»å­˜åœ¨ï¼Œ æ‰å¯ä»¥è®¾ç½®æˆåŠŸï¼Œ ç”¨äºæ›´æ–°ã€‚ // å› ä¸ºé”®helloå·²å­˜åœ¨ï¼Œ æ‰€ä»¥setnxå¤±è´¥ï¼Œ è¿”å›ç»“æœä¸º0 127.0.0.1:6379&gt; setnx hello redis (integer) 0 //å› ä¸ºé”®helloå·²å­˜åœ¨ï¼Œ æ‰€ä»¥set xxæˆåŠŸï¼Œ è¿”å›ç»“æœä¸ºOKï¼š 127.0.0.1:6379&gt; set hello jedis xx OK setnxå’Œsetxxåœ¨å®é™…ä½¿ç”¨ä¸­æœ‰ä»€ä¹ˆåº”ç”¨åœºæ™¯å—ï¼Ÿ ä»¥setnxå‘½ä»¤ä¸ºä¾‹å­ï¼Œ ç”±äºRedisçš„å•çº¿ç¨‹å‘½ä»¤å¤„ç†æœºåˆ¶ï¼Œ å¦‚æœæœ‰å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶æ‰§è¡Œsetnx key valueï¼Œæ ¹æ®setnxçš„ç‰¹æ€§åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½è®¾ç½®æˆåŠŸï¼Œ setnxå¯ä»¥ä½œä¸ºåˆ†å¸ƒå¼é”çš„ä¸€ç§å®ç°æ–¹æ¡ˆï¼Œ Rediså®˜æ–¹ç»™å‡ºäº†ä½¿ç”¨setnxå®ç°åˆ†å¸ƒå¼é”çš„æ–¹æ³•ï¼š http://redis.io/topics/distlockã€‚ è·å–å€¼ get key //ä¸‹é¢æ“ä½œè·å–é”®helloçš„å€¼ï¼š 127.0.0.1:6379&gt; get hello &quot;world&quot; //å¦‚æœè¦è·å–çš„é”®ä¸å­˜åœ¨ï¼Œ åˆ™è¿”å›nilï¼ˆç©ºï¼‰ ï¼š 127.0.0.1:6379&gt; get not_exist_key (nil) æ‰¹é‡è®¾ç½®å€¼ mset key value [key value ...] //ä¸‹é¢æ“ä½œé€šè¿‡msetå‘½ä»¤ä¸€æ¬¡æ€§è®¾ç½®4ä¸ªé”®å€¼å¯¹ï¼š 127.0.0.1:6379&gt; mset a 1 b 2 c 3 d 4 OK æ‰¹é‡è·å–å€¼ mget key [key ...] //ä¸‹é¢æ“ä½œæ‰¹é‡è·å–äº†é”®aã€ bã€ cã€ dçš„å€¼ï¼š 127.0.0.1:6379&gt; mget a b c d 1) &quot;1&quot; 2) &quot;2&quot; 3) &quot;3&quot; 4) &quot;4&quot; å¦‚æœæœ‰äº›é”®ä¸å­˜åœ¨ï¼Œ é‚£ä¹ˆå®ƒçš„å€¼ä¸ºnilï¼ˆç©ºï¼‰ ï¼Œ ç»“æœæ˜¯æŒ‰ç…§ä¼ å…¥é”®çš„é¡ºåºè¿”å›ï¼š 127.0.0.1:6379&gt; mget a b c f 1) &quot;1&quot; 2) &quot;2&quot; 3) &quot;3&quot; 4) (nil) è®¡æ•° incr key //incrå‘½ä»¤ç”¨äºå¯¹å€¼åšè‡ªå¢æ“ä½œï¼Œ è¿”å›ç»“æœåˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š //Â·å€¼ä¸æ˜¯æ•´æ•°ï¼Œ è¿”å›é”™è¯¯ã€‚ //Â·å€¼æ˜¯æ•´æ•°ï¼Œ è¿”å›è‡ªå¢åçš„ç»“æœã€‚ //Â·é”®ä¸å­˜åœ¨ï¼Œ æŒ‰ç…§å€¼ä¸º0è‡ªå¢ï¼Œ è¿”å›ç»“æœä¸º1ã€‚ //ä¾‹å¦‚å¯¹ä¸€ä¸ªä¸å­˜åœ¨çš„é”®æ‰§è¡Œincræ“ä½œåï¼Œ è¿”å›ç»“æœæ˜¯1ï¼š 127.0.0.1:6379&gt; exists key (integer) 0 127.0.0.1:6379&gt; incr key (integer) 1 //å†æ¬¡å¯¹é”®æ‰§è¡Œincrå‘½ä»¤ï¼Œ è¿”å›ç»“æœæ˜¯2ï¼š 127.0.0.1:6379&gt; incr key (integer) 2 //å¦‚æœå€¼ä¸æ˜¯æ•´æ•°ï¼Œ é‚£ä¹ˆä¼šè¿”å›é”™è¯¯ï¼š 127.0.0.1:6379&gt; set hello world OK 127.0.0.1:6379&gt; incr hello (error) ERR value is not an integer or out of range //é™¤äº†incrå‘½ä»¤ï¼Œ Redisæä¾›äº†decr(è‡ªå‡)ã€incrby(è‡ªå¢æŒ‡å®šæ•°å­—)ã€decrby(è‡ªå‡æŒ‡å®šæ•°å­—)ã€incrbyfloat(è‡ªå¢æµ®ç‚¹æ•°)ï¼š decr key incrby key increment decrby key decrement incrbyfloat key increment //å¾ˆå¤šå­˜å‚¨ç³»ç»Ÿå’Œç¼–ç¨‹è¯­è¨€å†…éƒ¨ä½¿ç”¨CASæœºåˆ¶å®ç°è®¡æ•°åŠŸèƒ½ï¼Œ ä¼šæœ‰ä¸€å®šçš„CPUå¼€é”€ï¼Œ ä½†åœ¨Redisä¸­å®Œå…¨ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œ å› ä¸ºRedisæ˜¯å•çº¿ç¨‹æ¶æ„ï¼Œ ä»»ä½•å‘½ä»¤åˆ°äº†RedisæœåŠ¡ç«¯éƒ½è¦é¡ºåºæ‰§è¡Œ Stringä½¿ç”¨åœºæ™¯ ç¼“å­˜åŠŸèƒ½ è®¡æ•° å…±äº«Session é™é€Ÿ List æ·»åŠ  //ä»å³è¾¹æ’å…¥å…ƒç´  rpush key value [value ...] //ä¸‹é¢ä»£ç ä»å³å‘å·¦æ’å…¥å…ƒç´ cã€ bã€ aï¼š 127.0.0. 1:6379&gt; rpush listkey c b a (integer) 3 //lrange0-1å‘½ä»¤å¯ä»¥ä»å·¦åˆ°å³è·å–åˆ—è¡¨çš„æ‰€æœ‰å…ƒç´ ï¼š 127.0.0.1:6379&gt; lrange listkey 0 -1 1) &quot;c&quot; 2) &quot;b&quot; 3) &quot;a&quot; //ä»å·¦è¾¹æ’å…¥å…ƒç´  lpush key value [value ...] ä½¿ç”¨æ–¹æ³•å’Œrpushç›¸åŒï¼Œ åªä¸è¿‡ä»å·¦ä¾§æ’å…¥ã€‚ //å‘æŸä¸ªå…ƒç´ å‰æˆ–è€…åæ’å…¥å…ƒç´  linsert key before|after pivot value //linsertå‘½ä»¤ä¼šä»åˆ—è¡¨ä¸­æ‰¾åˆ°ç­‰äºpivotçš„å…ƒç´ ï¼Œ åœ¨å…¶å‰(before)æˆ–è€…å(after)æ’å…¥ä¸€ä¸ªæ–°çš„å…ƒç´ valueï¼Œ ä¾‹å¦‚ä¸‹é¢æ“ä½œä¼šåœ¨åˆ—è¡¨çš„å…ƒç´ bå‰æ’å…¥javaï¼š 127.0.0.1:6379&gt; linsert listkey before b java (integer) 4 //è¿”å›ç»“æœä¸º4ï¼Œ ä»£è¡¨å½“å‰å‘½ä»¤çš„é•¿åº¦ï¼Œ å½“å‰åˆ—è¡¨å˜ä¸ºï¼š 127.0.0.1:6379&gt; lrange listkey 0 -1 1) &quot;c&quot; 2) &quot;java&quot; 3) &quot;b&quot; 4) &quot;a&quot; æŸ¥æ‰¾ //è·å–æŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ åˆ—è¡¨ lrange key start end //lrangeæ“ä½œä¼šè·å–åˆ—è¡¨æŒ‡å®šç´¢å¼•èŒƒå›´æ‰€æœ‰çš„å…ƒç´ ã€‚ ç´¢å¼•ä¸‹æ ‡æœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼š ç¬¬ä¸€ï¼Œ ç´¢å¼•ä¸‹æ ‡ä»å·¦åˆ°å³åˆ†åˆ«æ˜¯0åˆ°N-1ï¼Œ ä½†æ˜¯ä»å³åˆ°å·¦åˆ†åˆ«æ˜¯-1åˆ°-Nã€‚ //ç¬¬äºŒï¼Œ lrangeä¸­çš„endé€‰é¡¹åŒ…å«äº†è‡ªèº«ï¼Œ è¿™ä¸ªå’Œå¾ˆå¤šç¼–ç¨‹è¯­è¨€ä¸åŒ…å«endä¸å¤ªç›¸åŒï¼Œ ä¾‹å¦‚æƒ³è·å–åˆ—è¡¨çš„ç¬¬2åˆ°ç¬¬4ä¸ªå…ƒç´ ï¼Œ å¯ä»¥æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š 127.0.0.1:6379&gt; lrange listkey 1 3 1) &quot;java&quot; 2) &quot;b&quot; 3) &quot;a&quot; //è·å–åˆ—è¡¨æŒ‡å®šç´¢å¼•ä¸‹æ ‡çš„å…ƒç´  lindex key index //ä¾‹å¦‚å½“å‰åˆ—è¡¨æœ€åä¸€ä¸ªå…ƒç´ ä¸ºaï¼š 127.0.0.1:6379&gt; lindex listkey -1 &quot;a&quot; // è·å–åˆ—è¡¨é•¿åº¦ llen key //ä¾‹å¦‚ï¼Œ ä¸‹é¢ç¤ºä¾‹å½“å‰åˆ—è¡¨é•¿åº¦ä¸º4ï¼š 127.0.0.1:6379&gt; llen listkey (integer) 4 åˆ é™¤ //ä»åˆ—è¡¨å·¦ä¾§å¼¹å‡ºå…ƒç´  lpop key //å¦‚ä¸‹æ“ä½œå°†åˆ—è¡¨æœ€å·¦ä¾§çš„å…ƒç´ cä¼šè¢«å¼¹å‡ºï¼Œ å¼¹å‡ºååˆ—è¡¨å˜ä¸ºjavaã€ bã€aï¼š 127.0.0.1:6379&gt;t lpop listkey &quot;c&quot; 127.0.0.1:6379&gt; lrange listkey 0 -1 1) &quot;java&quot; 2) &quot;b&quot; 3) &quot;a&quot; //ä»åˆ—è¡¨å³ä¾§å¼¹å‡º rpop key å®ƒçš„ä½¿ç”¨æ–¹æ³•å’Œlpopæ˜¯ä¸€æ ·çš„ï¼Œ åªä¸è¿‡ä»åˆ—è¡¨å³ä¾§å¼¹å‡º //åˆ é™¤æŒ‡å®šå…ƒç´  lrem key count value //lremå‘½ä»¤ä¼šä»åˆ—è¡¨ä¸­æ‰¾åˆ°ç­‰äºvalueçš„å…ƒç´ è¿›è¡Œåˆ é™¤ï¼Œ æ ¹æ®countçš„ä¸åŒåˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š //Â·count&gt;0ï¼Œ ä»å·¦åˆ°å³ï¼Œ åˆ é™¤æœ€å¤šcountä¸ªå…ƒç´ ã€‚ //Â·count&lt;0ï¼Œ ä»å³åˆ°å·¦ï¼Œ åˆ é™¤æœ€å¤šcountç»å¯¹å€¼ä¸ªå…ƒç´ ã€‚ //Â·count=0ï¼Œ åˆ é™¤æ‰€æœ‰ã€‚ //ä¾‹å¦‚å‘åˆ—è¡¨ä»å·¦å‘å³æ’å…¥5ä¸ªaï¼Œ é‚£ä¹ˆå½“å‰åˆ—è¡¨å˜ä¸ºâ€œa a a a a java b aâ€ï¼Œ //ä¸‹é¢æ“ä½œå°†ä»åˆ—è¡¨å·¦è¾¹å¼€å§‹åˆ é™¤4ä¸ªä¸ºaçš„å…ƒç´ ï¼š 127.0.0.1:6379&gt; lrem listkey 4 a (integer) 4 127.0.0.1:6379&gt; lrange listkey 0 -1 1) &quot;a&quot; 2) &quot;java&quot; 3) &quot;b&quot; 4) &quot;a&quot; //æŒ‰ç…§ç´¢å¼•èŒƒå›´ä¿®å‰ªåˆ—è¡¨ ltrim key start end //ä¾‹å¦‚ï¼Œ ä¸‹é¢æ“ä½œä¼šåªä¿ç•™åˆ—è¡¨listkeyç¬¬2ä¸ªåˆ°ç¬¬4ä¸ªå…ƒç´ ï¼š 127.0.0.1:6379&gt; ltrim listkey 1 3 OK 127.0.0.1:6379&gt; lrange listkey 0 -1 1) &quot;java&quot; 2) &quot;b&quot; 3) &quot;a&quot; ä¿®æ”¹ //ä¿®æ”¹æŒ‡å®šç´¢å¼•ä¸‹æ ‡çš„å…ƒç´ ï¼š lset key index newValue //ä¸‹é¢æ“ä½œä¼šå°†åˆ—è¡¨listkeyä¸­çš„ç¬¬3ä¸ªå…ƒç´ è®¾ç½®ä¸ºpythonï¼š 127.0.0.1:6379&gt; lset listkey 2 python OK 127.0.0.1:6379&gt; lrange listkey 0 -1 1) &quot;java&quot; 2) &quot;b&quot; 3) &quot;python&quot; é˜»å¡æ“ä½œ //é˜»å¡å¼å¼¹å‡ºå¦‚ä¸‹ï¼š blpop key [key ...] timeout brpop key [key ...] timeout //blpopå’Œbrpopæ˜¯lpopå’Œrpopçš„é˜»å¡ç‰ˆæœ¬ï¼Œ å®ƒä»¬é™¤äº†å¼¹å‡ºæ–¹å‘ä¸åŒï¼Œ ä½¿ç”¨æ–¹æ³•åŸºæœ¬ç›¸åŒï¼Œ æ‰€ä»¥ä¸‹é¢ä»¥brpopå‘½ä»¤è¿›è¡Œè¯´æ˜ï¼Œ brpopå‘½ä»¤åŒ…å«ä¸¤ä¸ªå‚æ•°ï¼š //Â·key[key...]ï¼š å¤šä¸ªåˆ—è¡¨çš„é”®ã€‚ //Â·timeoutï¼š é˜»å¡æ—¶é—´ï¼ˆå•ä½ï¼š ç§’ï¼‰ ã€‚ //åˆ—è¡¨ä¸ºç©ºï¼š å¦‚æœtimeout=3ï¼Œ é‚£ä¹ˆå®¢æˆ·ç«¯è¦ç­‰åˆ°3ç§’åè¿”å›ï¼Œ å¦‚æœtimeout=0ï¼Œ é‚£ä¹ˆå®¢æˆ·ç«¯ä¸€ç›´é˜»å¡ç­‰ä¸‹å»ï¼š 127.0.0.1:6379&gt; brpop list:test 3 (nil) (3.10s) 127.0.0.1:6379&gt; brpop list:test 0 //...é˜»å¡... //å¦‚æœæ­¤æœŸé—´æ·»åŠ äº†æ•°æ®element1ï¼Œ å®¢æˆ·ç«¯ç«‹å³è¿”å›ï¼š 127.0.0.1:6379&gt; brpop list:test 3 1) &quot;list:test&quot; 2) &quot;element1&quot; (2.06s) //åˆ—è¡¨ä¸ä¸ºç©ºï¼š å®¢æˆ·ç«¯ä¼šç«‹å³è¿”å›ã€‚ 127.0.0.1:6379&gt; brpop list:test 0 1) &quot;list:test&quot; 2) &quot;element1&quot; //åœ¨ä½¿ç”¨brpopæ—¶ï¼Œ æœ‰ä¸¤ç‚¹éœ€è¦æ³¨æ„ã€‚ //ç¬¬ä¸€ç‚¹ï¼Œ å¦‚æœæ˜¯å¤šä¸ªé”®ï¼Œ é‚£ä¹ˆbrpopä¼šä»å·¦è‡³å³éå†é”®ï¼Œ ä¸€æ—¦æœ‰ä¸€ä¸ªé”®èƒ½å¼¹å‡ºå…ƒç´ ï¼Œ å®¢æˆ·ç«¯ç«‹å³è¿”å›ï¼š 127.0.0.1:6379&gt; brpop list:1 list:2 list:3 0 //..é˜»å¡.. //æ­¤æ—¶å¦ä¸€ä¸ªå®¢æˆ·ç«¯åˆ†åˆ«å‘listï¼š 2å’Œlistï¼š 3æ’å…¥å…ƒç´ ï¼š client-lpush&gt; lpush list:2 element2 (integer) 1 client-lpush&gt; lpush list:3 element3 (integer) 1 //å®¢æˆ·ç«¯ä¼šç«‹å³è¿”å›listï¼š 2ä¸­çš„element2ï¼Œ å› ä¸ºlistï¼š 2æœ€å…ˆæœ‰å¯ä»¥å¼¹å‡ºçš„å…ƒç´ ï¼š 127.0.0.1:6379&gt; brpop list:1 list:2 list:3 0 1) &quot;list:2&quot; 2) &quot;element2_1&quot; //ç¬¬äºŒç‚¹ï¼Œ å¦‚æœå¤šä¸ªå®¢æˆ·ç«¯å¯¹åŒä¸€ä¸ªé”®æ‰§è¡Œbrpopï¼Œ é‚£ä¹ˆæœ€å…ˆæ‰§è¡Œbrpopå‘½ä»¤çš„å®¢æˆ·ç«¯å¯ä»¥è·å–åˆ°å¼¹å‡ºçš„å€¼ã€‚ //å®¢æˆ·ç«¯1ï¼š client-1&gt; brpop list:test 0 //...é˜»å¡... //å®¢æˆ·ç«¯2ï¼š client-2&gt; brpop list:test 0 //...é˜»å¡... //å®¢æˆ·ç«¯3ï¼š client-3&gt; brpop list:test 0 //...é˜»å¡... //æ­¤æ—¶å¦ä¸€ä¸ªå®¢æˆ·ç«¯lpushä¸€ä¸ªå…ƒç´ åˆ°listï¼š teståˆ—è¡¨ä¸­ï¼š client-lpush&gt; lpush list:test element (integer) 1 //é‚£ä¹ˆå®¢æˆ·ç«¯1æœ€ä¼šè·å–åˆ°å…ƒç´ ï¼Œ å› ä¸ºå®¢æˆ·ç«¯1æœ€å…ˆæ‰§è¡Œbrpopï¼Œ è€Œå®¢æˆ·ç«¯2å’Œå®¢æˆ·ç«¯3ç»§ç»­é˜»å¡ï¼š client&gt; brpop list:test 0 1) &quot;list:test&quot; 2) &quot;element&quot; Listä½¿ç”¨åœºæ™¯ lpush+lpop=Stackï¼ˆ æ ˆï¼‰ lpush+rpop=Queueï¼ˆ é˜Ÿåˆ—ï¼‰ lpush+ltrim=Capped Collectionï¼ˆ æœ‰é™é›†åˆï¼‰ lpush+brpop=Message Queueï¼ˆ æ¶ˆæ¯é˜Ÿåˆ—ï¼‰ Set é›†åˆå†…æ“ä½œ æ·»åŠ å…ƒç´  //sadd key element [element ...] //è¿”å›ç»“æœä¸ºæ·»åŠ æˆåŠŸçš„å…ƒç´ ä¸ªæ•°ï¼Œ ä¾‹å¦‚ï¼š 127.0.0.1:6379&gt; exists myset (integer) 0 127.0.0.1:6379&gt; sadd myset a b c (integer) 3 127.0.0.1:6379&gt; sadd myset a b (integer) 0 åˆ é™¤å…ƒç´  //srem key element [element ...] //è¿”å›ç»“æœä¸ºæˆåŠŸåˆ é™¤å…ƒç´ ä¸ªæ•°ï¼Œ ä¾‹å¦‚ï¼š 127.0.0.1:6379&gt; srem myset a b (integer) 2 127.0.0.1:6379&gt; srem myset hello (integer) 0 è®¡ç®—å…ƒç´ ä¸ªæ•° //scard key //scardçš„æ—¶é—´å¤æ‚åº¦ä¸ºOï¼ˆ1ï¼‰ ï¼Œ å®ƒä¸ä¼šéå†é›†åˆæ‰€æœ‰å…ƒç´ ï¼Œ è€Œæ˜¯ç›´æ¥ç”¨Rediså†…éƒ¨çš„å˜é‡ï¼Œ ä¾‹å¦‚ï¼š 127.0.0.1:6379&gt; scard myset (integer) 1 åˆ¤æ–­å…ƒç´ æ˜¯å¦åœ¨é›†åˆä¸­ //sismember key element //å¦‚æœç»™å®šå…ƒç´ elementåœ¨é›†åˆå†…è¿”å›1ï¼Œ åä¹‹è¿”å›0ï¼Œ ä¾‹å¦‚ï¼š 127.0.0.1:6379&gt; sismember myset c (integer) 1 éšæœºä»é›†åˆè¿”å›æŒ‡å®šä¸ªæ•°å…ƒç´  //srandmember key [count] //[count]æ˜¯å¯é€‰å‚æ•°ï¼Œ å¦‚æœä¸å†™é»˜è®¤ä¸º1ï¼Œ ä¾‹å¦‚ï¼š 127.0.0.1:6379&gt; srandmember myset 2 1) &quot;a&quot; 2) &quot;c&quot; 127.0.0.1:6379&gt; srandmember myset &quot;d&quot; ä»é›†åˆéšæœºå¼¹å‡ºå…ƒç´  //spop key //spopæ“ä½œå¯ä»¥ä»é›†åˆä¸­éšæœºå¼¹å‡ºä¸€ä¸ªå…ƒç´ ï¼Œ ä¾‹å¦‚ä¸‹é¢ä»£ç æ˜¯ä¸€æ¬¡spopåï¼Œ é›†åˆå…ƒç´ å˜ä¸º&quot;d b a&quot;ï¼š 123 127.0.0.1:6379&gt; spop myset &quot;c&quot; 127.0.0.1:6379&gt; smembers myset 1) &quot;d&quot; 2) &quot;b&quot; 3) &quot;a&quot; //éœ€è¦æ³¨æ„çš„æ˜¯Redisä»3.2ç‰ˆæœ¬å¼€å§‹ï¼Œ spopä¹Ÿæ”¯æŒ[count]å‚æ•°ã€‚ //srandmemberå’Œspopéƒ½æ˜¯éšæœºä»é›†åˆé€‰å‡ºå…ƒç´ ï¼Œ ä¸¤è€…ä¸åŒçš„æ˜¯spopå‘½ä»¤æ‰§è¡Œåï¼Œ å…ƒç´ ä¼šä»é›†åˆä¸­åˆ é™¤ï¼Œ è€Œsrandmemberä¸ä¼šã€‚ è·å–æ‰€æœ‰å…ƒç´  //smembers key //ä¸‹é¢ä»£ç è·å–é›†åˆmysetæ‰€æœ‰å…ƒç´ ï¼Œ å¹¶ä¸”è¿”å›ç»“æœæ˜¯æ— åºçš„ï¼š 127.0.0.1:6379&gt; smembers myset 1) &quot;d&quot; 2) &quot;b&quot; 3) &quot;a&quot; //smemberså’Œlrangeã€ hgetalléƒ½å±äºæ¯”è¾ƒé‡çš„å‘½ä»¤ï¼Œ å¦‚æœå…ƒç´ è¿‡å¤šå­˜åœ¨é˜»å¡Redisçš„å¯èƒ½æ€§ï¼Œ è¿™æ—¶å€™å¯ä»¥ä½¿ç”¨sscanæ¥å®Œæˆï¼Œ æœ‰å…³sscanå‘½ä»¤2.7èŠ‚ä¼šä»‹ç»ã€‚ é›†åˆé—´æ“ä½œ //ç°åœ¨æœ‰ä¸¤ä¸ªé›†åˆï¼Œ å®ƒä»¬åˆ†åˆ«æ˜¯userï¼š 1ï¼š followå’Œuserï¼š 2ï¼š followï¼š 127.0.0.1:6379&gt; sadd user:1:follow it music his sports (integer) 4 127.0.0.1:6379&gt; sadd user:2:follow it news ent sports (integer) 4 124 æ±‚å¤šä¸ªé›†åˆçš„äº¤é›† //sinter key [key ...] //ä¾‹å¦‚ä¸‹é¢ä»£ç æ˜¯æ±‚userï¼š 1ï¼š followå’Œuserï¼š 2ï¼š followä¸¤ä¸ªé›†åˆçš„äº¤é›†ï¼Œè¿”å›ç»“æœæ˜¯sportsã€ itï¼š 127.0.0.1:6379&gt; sinter user:1:follow user:2:follow 1) &quot;sports&quot; 2) &quot;it&quot; æ±‚å¤šä¸ªé›†åˆçš„å¹¶é›† //suinon key [key ...] //ä¾‹å¦‚ä¸‹é¢ä»£ç æ˜¯æ±‚userï¼š 1ï¼š followå’Œuserï¼š 2ï¼š followä¸¤ä¸ªé›†åˆçš„å¹¶é›†ï¼Œè¿”å›ç»“æœæ˜¯sportsã€ itã€ hisã€ newsã€ musicã€ entï¼š 127.0.0.1:6379&gt; sunion user:1:follow user:2:follow 1) &quot;sports&quot; 2) &quot;it&quot; 3) &quot;his&quot; 4) &quot;news&quot; 5) &quot;music&quot; 6) &quot;ent&quot; æ±‚å¤šä¸ªé›†åˆçš„å·®é›† //sdiff key [key ...] //ä¾‹å¦‚ä¸‹é¢ä»£ç æ˜¯æ±‚userï¼š 1ï¼š followå’Œuserï¼š 2ï¼š followä¸¤ä¸ªé›†åˆçš„å·®é›†ï¼Œè¿”å›ç»“æœæ˜¯musicå’Œhisï¼š 127.0.0.1:6379&gt; sdiff user:1:follow user:2:follow 1) &quot;music&quot; 2) &quot;his&quot; å‰é¢ä¸‰ä¸ªå‘½ä»¤å¦‚å›¾æ‰€ç¤º å°†äº¤é›†ã€ å¹¶é›†ã€ å·®é›†çš„ç»“æœä¿å­˜ sinterstore destination key [key ...] suionstore destination key [key ...] sdiffstore destination key [key ...] é›†åˆé—´çš„è¿ç®—åœ¨å…ƒç´ è¾ƒå¤šçš„æƒ…å†µä¸‹ä¼šæ¯”è¾ƒè€—æ—¶ï¼Œ æ‰€ä»¥Redisæä¾›äº†ä¸Šé¢ä¸‰ä¸ªå‘½ä»¤ï¼ˆåŸå‘½ä»¤+storeï¼‰ å°†é›†åˆé—´äº¤é›†ã€ å¹¶é›†ã€ å·®é›†çš„ç»“æœä¿å­˜åœ¨destination keyä¸­ï¼Œ ä¾‹å¦‚ä¸‹é¢æ“ä½œå°†userï¼š 1ï¼š followå’Œuserï¼š 2ï¼š followä¸¤ä¸ªé›†åˆçš„äº¤é›†ç»“æœä¿å­˜åœ¨userï¼š 1_2ï¼š interä¸­ï¼Œ userï¼š 1_2ï¼š interæœ¬èº«ä¹Ÿæ˜¯é›†åˆç±» å‹ï¼š 127.0.0.1:6379&gt; sinterstore user:1_2:inter user:1:follow user:2:follow (integer) 2 127.0.0.1:6379&gt; type user:1_2:inter set 127.0.0.1:6379&gt; smembers user:1_2:inter 1) &quot;it&quot; 2) &quot;sports&quot; Setä½¿ç”¨åœºæ™¯ sadd=Taggingï¼ˆæ ‡ç­¾ï¼‰ spop/srandmember=Random itemï¼ˆç”Ÿæˆéšæœºæ•°ï¼Œ æ¯”å¦‚æŠ½å¥–ï¼‰ sadd+sinter=Social Graphï¼ˆç¤¾äº¤éœ€æ±‚ï¼‰ Zset é›†åˆå†…æ“ä½œ æ·»åŠ æˆå‘˜ //zadd key score member [score member ...] //ä¸‹é¢æ“ä½œå‘æœ‰åºé›†åˆuserï¼š rankingæ·»åŠ ç”¨æˆ·tomå’Œä»–çš„åˆ†æ•°251ï¼š 127.0.0.1:6379&gt; zadd user:ranking 251 tom (integer) 1 //è¿”å›ç»“æœä»£è¡¨æˆåŠŸæ·»åŠ æˆå‘˜çš„ä¸ªæ•°ï¼š 127.0.0.1:6379&gt; zadd user:ranking 1 kris 91 mike 200 frank 220 tim 250 martin (integer) 5 æœ‰å…³zaddå‘½ä»¤æœ‰ä¸¤ç‚¹éœ€è¦æ³¨æ„ï¼š Redis3.2ä¸ºzaddå‘½ä»¤æ·»åŠ äº†nxã€ xxã€ chã€ incrå››ä¸ªé€‰é¡¹ï¼š nxï¼š memberå¿…é¡»ä¸å­˜åœ¨ï¼Œ æ‰å¯ä»¥è®¾ç½®æˆåŠŸï¼Œ ç”¨äºæ·»åŠ ã€‚ xxï¼š memberå¿…é¡»å­˜åœ¨ï¼Œ æ‰å¯ä»¥è®¾ç½®æˆåŠŸï¼Œ ç”¨äºæ›´æ–°ã€‚ chï¼š è¿”å›æ­¤æ¬¡æ“ä½œåï¼Œ æœ‰åºé›†åˆå…ƒç´ å’Œåˆ†æ•°å‘ç”Ÿå˜åŒ–çš„ä¸ªæ•° incrï¼š å¯¹scoreåšå¢åŠ ï¼Œ ç›¸å½“äºåé¢ä»‹ç»çš„zincrbyã€‚ æœ‰åºé›†åˆç›¸æ¯”é›†åˆæä¾›äº†æ’åºå­—æ®µï¼Œ ä½†æ˜¯ä¹Ÿäº§ç”Ÿäº†ä»£ä»·ï¼Œ zaddçš„æ—¶é—´å¤æ‚åº¦ä¸ºOï¼ˆlogï¼ˆnï¼‰ ï¼‰ ï¼Œ saddçš„æ—¶é—´å¤æ‚åº¦ä¸ºOï¼ˆ1ï¼‰ ã€‚ è®¡ç®—æˆå‘˜ä¸ªæ•° //zcard key //ä¾‹å¦‚ä¸‹é¢æ“ä½œè¿”å›æœ‰åºé›†åˆuserï¼š rankingçš„æˆå‘˜æ•°ä¸º5ï¼Œ å’Œé›†åˆç±»å‹çš„scardå‘½ä»¤ä¸€æ ·ï¼Œ zcardçš„æ—¶é—´å¤æ‚åº¦ä¸ºOï¼ˆ1ï¼‰ ã€‚ 127.0.0.1:6379&gt; zcard user:ranking (integer) 5 è®¡ç®—æŸä¸ªæˆå‘˜çš„åˆ†æ•° //zscore key member //tomçš„åˆ†æ•°ä¸º251ï¼Œ å¦‚æœæˆå‘˜ä¸å­˜åœ¨åˆ™è¿”å›nilï¼š 127.0.0.1:6379&gt; zscore user:ranking tom &quot;251&quot; 127.0.0.1:6379&gt; zscore user:ranking test (nil) è®¡ç®—æˆå‘˜çš„æ’å //zrank key member //zrevrank key member //zrankæ˜¯ä»åˆ†æ•°ä»ä½åˆ°é«˜è¿”å›æ’åï¼Œ zrevrankåä¹‹ã€‚ ä¾‹å¦‚ä¸‹é¢æ“ä½œä¸­ï¼Œ tomåœ¨zrankå’Œzrevrankåˆ†åˆ«æ’åç¬¬5å’Œç¬¬0ï¼ˆæ’åä»0å¼€å§‹è®¡ç®—ï¼‰ ã€‚ 127.0.0.1:6379&gt; zrank user:ranking tom (integer) 5 127.0.0.1:6379&gt; zrevrank user:ranking tom (integer) 0 åˆ é™¤æˆå‘˜ //zrem key member [member ...] //ä¸‹é¢æ“ä½œå°†æˆå‘˜mikeä»æœ‰åºé›†åˆuserï¼š rankingä¸­åˆ é™¤ã€‚ 127.0.0.1:6379&gt; zrem user:ranking mike (integer) 1 //è¿”å›ç»“æœä¸ºæˆåŠŸåˆ é™¤çš„ä¸ªæ•°ã€‚ å¢åŠ æˆå‘˜çš„åˆ†æ•° //zincrby key increment member //ä¸‹é¢æ“ä½œç»™tomå¢åŠ äº†9åˆ†ï¼Œ åˆ†æ•°å˜ä¸ºäº†260åˆ†ï¼š 127.0.0.1:6379&gt; zincrby user:ranking 9 tom &quot;260&quot; è¿”å›æŒ‡å®šæ’åèŒƒå›´çš„æˆå‘˜ //zrange key start end [withscores] //zrevrange key start end [withscores] //æœ‰åºé›†åˆæ˜¯æŒ‰ç…§åˆ†å€¼æ’åçš„ï¼Œ zrangeæ˜¯ä»ä½åˆ°é«˜è¿”å›ï¼Œ zrevrangeåä¹‹ã€‚ //ä¸‹é¢ä»£ç è¿”å›æ’åæœ€ä½çš„æ˜¯ä¸‰ä¸ªæˆå‘˜ï¼Œ å¦‚æœåŠ ä¸Šwithscoresé€‰é¡¹ï¼Œ åŒæ—¶ä¼šè¿”å›æˆå‘˜çš„åˆ†æ•°ï¼š 127.0.0.1:6379&gt; zrange user:ranking 0 2 withscores 1) &quot;kris&quot; 2) &quot;1&quot; 3) &quot;frank&quot; 4) &quot;200&quot; 5) &quot;tim&quot; 6) &quot;220&quot; 127.0.0.1:6379&gt; zrevrange user:ranking 0 2 withscores 1) &quot;tom&quot; 2) &quot;260&quot; 3) &quot;martin&quot; 4) &quot;250&quot; 5) &quot;tim&quot; 6) &quot;220&quot; è¿”å›æŒ‡å®šåˆ†æ•°èŒƒå›´çš„æˆå‘˜ //zrangebyscore key min max [withscores] [limit offset count] //zrevrangebyscore key max min [withscores] [limit offset count] //å…¶ä¸­zrangebyscoreæŒ‰ç…§åˆ†æ•°ä»ä½åˆ°é«˜è¿”å›ï¼Œ zrevrangebyscoreåä¹‹ã€‚ ä¾‹å¦‚ä¸‹é¢æ“ä½œä»ä½åˆ°é«˜è¿”å›200åˆ°221åˆ†çš„æˆå‘˜ï¼Œ withscoresé€‰é¡¹ä¼šåŒæ—¶è¿”å›æ¯ä¸ªæˆå‘˜çš„åˆ†æ•°ã€‚ [limit offset count]é€‰é¡¹å¯ä»¥é™åˆ¶è¾“å‡ºçš„èµ·å§‹ä½ç½®å’Œä¸ªæ•°ï¼š 127.0.0.1:6379&gt; zrangebyscore user:ranking 200 tinf withscores 1) &quot;frank&quot; 2) &quot;200&quot; 3) &quot;tim&quot; 4) &quot;220&quot; 127.0.0.1:6379&gt; zrevrangebyscore user:ranking 221 200 withscores 1) &quot;tim&quot; 2) &quot;220&quot; 3) &quot;frank&quot; 4) &quot;200&quot; //åŒæ—¶minå’Œmaxè¿˜æ”¯æŒå¼€åŒºé—´ï¼ˆ å°æ‹¬å·ï¼‰ å’Œé—­åŒºé—´ï¼ˆ ä¸­æ‹¬å·ï¼‰ ï¼Œ -infå’Œ+infåˆ†åˆ«ä»£è¡¨æ— é™å°å’Œæ— é™å¤§ï¼š 127.0.0.1:6379&gt; zrangebyscore user:ranking (200 +inf withscores 1) &quot;tim&quot; 2) &quot;220&quot; 3) &quot;martin&quot; 4) &quot;250&quot; 5) &quot;tom&quot; 6) &quot;260&quot; è¿”å›æŒ‡å®šåˆ†æ•°èŒƒå›´æˆå‘˜ä¸ªæ•° //zcount key min max //ä¸‹é¢æ“ä½œè¿”å›200åˆ°221åˆ†çš„æˆå‘˜çš„ä¸ªæ•°ï¼š 127.0.0.1:6379&gt; zcount user:ranking 200 221 (integer) 2 åˆ é™¤æŒ‡å®šæ’åå†…çš„å‡åºå…ƒç´  //zremrangebyrank key start end //ä¸‹é¢æ“ä½œåˆ é™¤ç¬¬startåˆ°ç¬¬endåçš„æˆå‘˜ï¼š 127.0.0.1:6379&gt; zremrangebyrank user:ranking 0 2 (integer) 3 åˆ é™¤æŒ‡å®šåˆ†æ•°èŒƒå›´çš„æˆå‘˜ //zremrangebyscore key min max //ä¸‹é¢æ“ä½œå°†250åˆ†ä»¥ä¸Šçš„æˆå‘˜å…¨éƒ¨åˆ é™¤ï¼Œ è¿”å›ç»“æœä¸ºæˆåŠŸåˆ é™¤çš„ä¸ªæ•°ï¼š 127.0.0.1:6379&gt; zremrangebyscore user:ranking (250 +inf (integer) 2 é›†åˆé—´æ“ä½œ å°†å›¾ä¸­çš„ä¸¤ä¸ªæœ‰åºé›†åˆå¯¼å…¥åˆ°Redisä¸­ã€‚ 127.0.0.1:6379&gt; zadd user:ranking:1 1 kris 91 mike 200 frank 220 tim 250 martin 251 tom (integer) 6 127.0.0.1:6379&gt; zadd user:ranking:2 8 james 77 mike 625 martin 888 tom (integer) 4 äº¤é›† //zinterstore destination numkeys key [key ...] [weights weight [weight ...]][aggregate sum|min|max] //è¿™ä¸ªå‘½ä»¤å‚æ•°è¾ƒå¤šï¼Œ ä¸‹é¢åˆ†åˆ«è¿›è¡Œè¯´æ˜ï¼š //Â·destinationï¼š äº¤é›†è®¡ç®—ç»“æœä¿å­˜åˆ°è¿™ä¸ªé”®ã€‚ //Â·numkeysï¼š éœ€è¦åšäº¤é›†è®¡ç®—é”®çš„ä¸ªæ•°ã€‚ //Â·key[key...]ï¼š éœ€è¦åšäº¤é›†è®¡ç®—çš„é”®ã€‚ //Â·weights weight[weight...]ï¼š æ¯ä¸ªé”®çš„æƒé‡ï¼Œ åœ¨åšäº¤é›†è®¡ç®—æ—¶ï¼Œ æ¯ä¸ªé”®ä¸­çš„æ¯ä¸ªmemberä¼šå°†è‡ªå·±åˆ†æ•°ä¹˜ä»¥è¿™ä¸ªæƒé‡ï¼Œ æ¯ä¸ªé”®çš„æƒé‡é»˜è®¤æ˜¯1ã€‚ //Â·aggregate sum|min|maxï¼š è®¡ç®—æˆå‘˜äº¤é›†åï¼Œ åˆ†å€¼å¯ä»¥æŒ‰ç…§sumï¼ˆ å’Œï¼‰ ã€minï¼ˆ æœ€å°å€¼ï¼‰ ã€ maxï¼ˆ æœ€å¤§å€¼ï¼‰ åšæ±‡æ€»ï¼Œ é»˜è®¤å€¼æ˜¯sumã€‚ //ä¸‹é¢æ“ä½œå¯¹userï¼š rankingï¼š 1å’Œuserï¼š rankingï¼š 2åšäº¤é›†ï¼Œ weightså’Œaggregateä½¿ç”¨äº†é»˜è®¤é…ç½®ï¼Œ å¯ä»¥çœ‹åˆ°ç›®æ ‡é”®userï¼š rankingï¼š 1_inter_2å¯¹åˆ†å€¼åšäº†sumæ“ä½œï¼š 127.0.0.1:6379&gt; zinterstore user:ranking:1_inter_2 2 user:ranking:1 user:ranking:2 (integer) 3 127.0.0.1:6379&gt; zrange user:ranking:1_inter_2 0 -1 withscores 1) &quot;mike&quot; 2) &quot;168&quot; 3) &quot;martin&quot; 4) &quot;875&quot; 5) &quot;tom&quot; 6) &quot;1139&quot; //å¦‚æœæƒ³è®©userï¼š rankingï¼š 2çš„æƒé‡å˜ä¸º0.5ï¼Œ å¹¶ä¸”èšåˆæ•ˆæœä½¿ç”¨maxï¼Œ å¯ä»¥æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š 127.0.0.1:6379&gt; zinterstore user:ranking:1_inter_2 2 user:ranking:1 user:ranking:2 weights 1 0.5 aggregate max (integer) 3 127.0.0.1:6379&gt; zrange user:ranking:1_inter_2 0 -1 withscores 1) &quot;mike&quot; 2) &quot;91&quot; 3) &quot;martin&quot; 4) &quot;312.5&quot; 5) &quot;tom&quot; 6) &quot;444&quot; å¹¶é›† //zunionstore destination numkeys key [key ...] [weights weight [weight ...]][aggregate sum|min|max] //è¯¥å‘½ä»¤çš„æ‰€æœ‰å‚æ•°å’Œzinterstoreæ˜¯ä¸€è‡´çš„ï¼Œ åªä¸è¿‡æ˜¯åšå¹¶é›†è®¡ç®—ï¼Œ ä¾‹å¦‚ä¸‹é¢æ“ä½œæ˜¯è®¡ç®—userï¼š rankingï¼š 1å’Œuserï¼š rankingï¼š 2çš„å¹¶é›†ï¼Œ weightså’Œ //aggregateä½¿ç”¨äº†é»˜è®¤é…ç½®ï¼Œ å¯ä»¥çœ‹åˆ°ç›®æ ‡é”®userï¼š rankingï¼š 1_union_2å¯¹åˆ†å€¼åšäº†sumæ“ä½œï¼š 127.0.0.1:6379&gt; zunionstore user:ranking:1_union_2 2 user:ranking:1 user:ranking:2 (integer) 7 127.0.0.1:6379&gt; zrange user:ranking:1_union_2 0 -1 withscores 1) &quot;kris&quot; 2) &quot;1&quot; 3) &quot;james&quot; 4) &quot;8&quot; 5) &quot;mike&quot; 6) &quot;168&quot; 7) &quot;frank&quot; 8) &quot;200&quot; 9) &quot;tim&quot; 10) &quot;220&quot; 11) &quot;martin&quot; 12) &quot;875&quot; 13) &quot;tom&quot; 14) &quot;1139&quot; Zsetä½¿ç”¨åœºæ™¯ æœ‰åºé›†åˆæ¯”è¾ƒå…¸å‹çš„ä½¿ç”¨åœºæ™¯å°±æ˜¯æ’è¡Œæ¦œç³»ç»Ÿã€‚ ä¾‹å¦‚è§†é¢‘ç½‘ç«™éœ€è¦å¯¹ç”¨æˆ·ä¸Šä¼ çš„è§†é¢‘åšæ’è¡Œæ¦œï¼Œ æ¦œå•çš„ç»´åº¦å¯èƒ½æ˜¯å¤šä¸ªæ–¹é¢çš„ï¼š æŒ‰ç…§æ—¶é—´ã€ æŒ‰ç…§æ’­ æ”¾æ•°é‡ã€ æŒ‰ç…§è·å¾—çš„èµæ•°ã€‚ æœ¬èŠ‚ä½¿ç”¨èµæ•°è¿™ä¸ªç»´åº¦ï¼Œ è®°å½•æ¯å¤©ç”¨æˆ·ä¸Šä¼ è§†é¢‘çš„æ’è¡Œæ¦œã€‚ ä¸»è¦éœ€è¦å®ç°ä»¥ä¸‹4ä¸ªåŠŸèƒ½ã€‚ æ·»åŠ ç”¨æˆ·èµæ•° ä¾‹å¦‚ç”¨æˆ·mikeä¸Šä¼ äº†ä¸€ä¸ªè§†é¢‘ï¼Œ å¹¶è·å¾—äº†3ä¸ªèµï¼Œ å¯ä»¥ä½¿ç”¨æœ‰åºé›†åˆçš„zaddå’ŒzincrbyåŠŸèƒ½ï¼š zadd user:ranking:2016_03_15 mike 3 å¦‚æœä¹‹åå†è·å¾—ä¸€ä¸ªèµï¼Œ å¯ä»¥ä½¿ç”¨zincrbyï¼š zincrby user:ranking:2016_03_15 mike 1 å–æ¶ˆç”¨æˆ·èµæ•° ç”±äºå„ç§åŸå› ï¼ˆä¾‹å¦‚ç”¨æˆ·æ³¨é”€ã€ ç”¨æˆ·ä½œå¼Šï¼‰ éœ€è¦å°†ç”¨æˆ·åˆ é™¤ï¼Œ æ­¤æ—¶éœ€è¦å°†ç”¨æˆ·ä»æ¦œå•ä¸­åˆ é™¤æ‰ï¼Œ å¯ä»¥ä½¿ç”¨zremã€‚ ä¾‹å¦‚åˆ é™¤æˆå‘˜tomï¼š zrem user:ranking:2016_03_15 mike å±•ç¤ºè·å–èµæ•°æœ€å¤šçš„åä¸ªç”¨æˆ· æ­¤åŠŸèƒ½ä½¿ç”¨zrevrangeå‘½ä»¤å®ç°ï¼š zrevrangebyrank user:ranking:2016_03_15 0 9 å±•ç¤ºç”¨æˆ·ä¿¡æ¯ä»¥åŠç”¨æˆ·åˆ†æ•° æ­¤åŠŸèƒ½å°†ç”¨æˆ·åä½œä¸ºé”®åç¼€ï¼Œ å°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åœ¨å“ˆå¸Œç±»å‹ä¸­ï¼Œ è‡³äºç”¨æˆ·çš„åˆ†æ•°å’Œæ’åå¯ä»¥ä½¿ç”¨zscoreå’Œzrankä¸¤ä¸ªåŠŸèƒ½ï¼š hgetall user:info:tom zscore user:ranking:2016_03_15 mike zrank user:ranking:2016_03_15 mik Hash è®¾ç½®å€¼ //hset key field value //ä¸‹é¢ä¸ºuserï¼š 1æ·»åŠ ä¸€å¯¹field-valueï¼š 127.0.0.1:6379&gt; hset user:1 name tom (integer) 1 //å¦‚æœè®¾ç½®æˆåŠŸä¼šè¿”å›1ï¼Œ åä¹‹ä¼šè¿”å›0ã€‚ æ­¤å¤–Redisæä¾›äº†hsetnxå‘½ä»¤ï¼Œ å®ƒä»¬çš„å…³ç³»å°±åƒsetå’Œsetnxå‘½ä»¤ä¸€æ ·ï¼Œ åªä¸è¿‡ä½œç”¨åŸŸç”±é”®å˜ä¸ºfieldã€‚ è·å–å€¼ //hget key field //ä¾‹å¦‚ï¼Œ ä¸‹é¢æ“ä½œè·å–userï¼š 1çš„nameåŸŸï¼ˆå±æ€§ï¼‰ å¯¹åº”çš„å€¼ï¼š 127.0.0.1:6379&gt; hget user:1 name &quot;tom&quot; //å¦‚æœé”®æˆ–fieldä¸å­˜åœ¨ï¼Œ ä¼šè¿”å›nilï¼š 127.0.0.1:6379&gt; hget user:2 name (nil) 127.0.0.1:6379&gt; hget user:1 age (nil) åˆ é™¤field //hdel key field [field ...] //hdelä¼šåˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªfieldï¼Œ è¿”å›ç»“æœä¸ºæˆåŠŸåˆ é™¤fieldçš„ä¸ªæ•°ï¼Œ ä¾‹å¦‚ï¼š 127.0.0.1:6379&gt; hdel user:1 name (integer) 1 127.0.0.1:6379&gt; hdel user:1 age (integer) 0 è®¡ç®—fieldä¸ªæ•° //hlen key //ä¾‹å¦‚userï¼š 1æœ‰3ä¸ªfieldï¼š 127.0.0.1:6379&gt; hset user:1 name tom (integer) 1 127.0.0.1:6379&gt; hset user:1 age 23 (integer) 1 127.0.0.1:6379&gt; hset user:1 city tianjin (integer) 1 127.0.0.1:6379&gt; hlen user:1 (integer) 3 æ‰¹é‡è®¾ç½®æˆ–è·å–field-value //hmget key field [field ...] //hmset key field value [field value ...] //hmsetå’Œhmgetåˆ†åˆ«æ˜¯æ‰¹é‡è®¾ç½®å’Œè·å–field-valueï¼Œ hmsetéœ€è¦çš„å‚æ•°æ˜¯keyå’Œå¤šå¯¹field-valueï¼Œ hmgetéœ€è¦çš„å‚æ•°æ˜¯keyå’Œå¤šä¸ªfieldã€‚ ä¾‹å¦‚ï¼š 127.0.0.1:6379&gt; hmset user:1 name mike age 12 city tianjin OK 127.0.0.1:6379&gt; hmget user:1 name city 1) &quot;mike&quot; 2) &quot;tianjin&quot; åˆ¤æ–­fieldæ˜¯å¦å­˜åœ¨ //hexists key field //ä¾‹å¦‚ï¼Œ userï¼š 1åŒ…å«nameåŸŸï¼Œ æ‰€ä»¥è¿”å›ç»“æœä¸º1ï¼Œ ä¸åŒ…å«æ—¶è¿”å›0ï¼š 127.0.0.1:6379&gt; hexists user:1 name (integer) 1 è·å–æ‰€æœ‰field //hkeys key //hkeyså‘½ä»¤åº”è¯¥å«hfieldsæ›´ä¸ºæ°å½“ï¼Œ å®ƒè¿”å›æŒ‡å®šå“ˆå¸Œé”®æ‰€æœ‰çš„fieldï¼Œ ä¾‹å¦‚ï¼š 127.0.0.1:6379&gt; hkeys user:1 1) &quot;name&quot; 2) &quot;age&quot; 3) &quot;city&quot; è·å–æ‰€æœ‰value //hvals key ä¸‹é¢æ“ä½œè·å–userï¼š 1å…¨éƒ¨valueï¼š 127.0.0.1:6379&gt; hvals user:1 1) &quot;mike&quot; 2) &quot;12&quot; 3) &quot;tianjin&quot; è·å–æ‰€æœ‰çš„field-value //hgetall key //ä¸‹é¢æ“ä½œè·å–userï¼š 1æ‰€æœ‰çš„field-valueï¼š 127.0.0.1:6379&gt; hgetall user:1 1) &quot;name&quot; 2) &quot;mike&quot; 3) &quot;age&quot; 4) &quot;12&quot; 5) &quot;city&quot; 6) &quot;tianjin&quot; åœ¨ä½¿ç”¨hgetallæ—¶ï¼Œ å¦‚æœå“ˆå¸Œå…ƒç´ ä¸ªæ•°æ¯”è¾ƒå¤šï¼Œ ä¼šå­˜åœ¨é˜»å¡Redisçš„å¯èƒ½ã€‚ å¦‚æœå¼€å‘äººå‘˜åªéœ€è¦è·å–éƒ¨åˆ†fieldï¼Œ å¯ä»¥ä½¿ç”¨hmgetï¼Œ å¦‚æœä¸€å®šè¦è·å–å…¨éƒ¨field-valueï¼Œ å¯ä»¥ä½¿ç”¨hscanå‘½ä»¤ï¼Œ è¯¥å‘½ä»¤ä¼šæ¸è¿›å¼éå†å“ˆå¸Œç±»å‹. hincrby hincrbyfloat //hincrby key field //hincrbyfloat key field //hincrbyå’Œhincrbyfloatï¼Œ å°±åƒincrbyå’Œincrbyfloatå‘½ä»¤ä¸€æ ·ï¼Œ ä½†æ˜¯å®ƒä»¬çš„ä½œç”¨åŸŸæ˜¯filedã€‚ è®¡ç®—valueçš„å­—ç¬¦ä¸²é•¿åº¦ï¼ˆéœ€è¦Redis3.2ä»¥ä¸Šï¼‰ //hstrlen key field //ä¾‹å¦‚hget userï¼š 1nameçš„valueæ˜¯tomï¼Œ é‚£ä¹ˆhstrlençš„è¿”å›ç»“æœæ˜¯3ï¼š 127.0.0.1:6379&gt; hstrlen user:1 name (integer) 3 Hashä½¿ç”¨åœºæ™¯ ä¿å­˜å¯¹è±¡ä¿¡æ¯ Redis å‘å¸ƒè®¢é˜… Redis å‘å¸ƒè®¢é˜… (pub/sub) æ˜¯ä¸€ç§æ¶ˆæ¯é€šä¿¡æ¨¡å¼ï¼šå‘é€è€… (pub) å‘é€æ¶ˆæ¯ï¼Œè®¢é˜…è€… (sub) æ¥æ”¶æ¶ˆæ¯ã€‚ Redis å®¢æˆ·ç«¯å¯ä»¥è®¢é˜…ä»»æ„æ•°é‡çš„é¢‘é“ã€‚ ä¸‹å›¾å±•ç¤ºäº†é¢‘é“ channel1 ï¼Œ ä»¥åŠè®¢é˜…è¿™ä¸ªé¢‘é“çš„ä¸‰ä¸ªå®¢æˆ·ç«¯ â€”â€” client2 ã€ client5 å’Œ client1 ä¹‹é—´çš„å…³ç³»ï¼š å½“æœ‰æ–°æ¶ˆæ¯é€šè¿‡ PUBLISH å‘½ä»¤å‘é€ç»™é¢‘é“ channel1 æ—¶ï¼Œ è¿™ä¸ªæ¶ˆæ¯å°±ä¼šè¢«å‘é€ç»™è®¢é˜…å®ƒçš„ä¸‰ä¸ªå®¢æˆ·ç«¯ï¼š å®ä¾‹ ä»¥ä¸‹å®ä¾‹æ¼”ç¤ºäº†å‘å¸ƒè®¢é˜…æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œéœ€è¦å¼€å¯ä¸¤ä¸ª redis-cli å®¢æˆ·ç«¯ã€‚ åœ¨æˆ‘ä»¬å®ä¾‹ä¸­æˆ‘ä»¬åˆ›å»ºäº†è®¢é˜…é¢‘é“åä¸º runoobChat: ç¬¬ä¸€ä¸ª redis-cli å®¢æˆ·ç«¯ redis 127.0.0.1:6379&gt; SUBSCRIBE runoobChat Reading messages... (press Ctrl-C to quit) &quot;subscribe&quot; &quot;redisChat&quot; (integer) 1 ç°åœ¨ï¼Œæˆ‘ä»¬å…ˆé‡æ–°å¼€å¯ä¸ª redis å®¢æˆ·ç«¯ï¼Œç„¶ååœ¨åŒä¸€ä¸ªé¢‘é“ runoobChat å‘å¸ƒä¸¤æ¬¡æ¶ˆæ¯ï¼Œè®¢é˜…è€…å°±èƒ½æ¥æ”¶åˆ°æ¶ˆæ¯ã€‚ ç¬¬äºŒä¸ª redis-cli å®¢æˆ·ç«¯ redis 127.0.0.1:6379&gt; PUBLISH runoobChat &quot;Redis PUBLISH test&quot; (integer) 1 redis 127.0.0.1:6379&gt; PUBLISH runoobChat &quot;Learn redis by runoob.com&quot; (integer) 1 # è®¢é˜…è€…çš„å®¢æˆ·ç«¯ä¼šæ˜¾ç¤ºå¦‚ä¸‹æ¶ˆæ¯ &quot;message&quot; &quot;runoobChat&quot; &quot;Redis PUBLISH test&quot; &quot;message&quot; &quot;runoobChat&quot; &quot;Learn redis by runoob.com&quot; springbootä¸­å®ç° ä¸€.é…ç½®æ–‡ä»¶ spring: redis: host: 192.168.0.200 port: 6379 password: database: 1 pool.max-active: 8 pool.max-wait: -1 pool.max-idle: 8 pool.min-idle: 0 timeout: 5000 äºŒ.mavenåæ ‡ &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; ä¸‰.redisæ¶ˆæ¯ç›‘å¬å™¨å®¹å™¨ä»¥åŠredisç›‘å¬å™¨æ³¨å…¥IOCå®¹å™¨ package com.example.demo; import org.springframework.cache.annotation.EnableCaching; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import org.springframework.context.annotation.Scope; import org.springframework.data.redis.connection.RedisConnectionFactory; import org.springframework.data.redis.listener.PatternTopic; import org.springframework.data.redis.listener.RedisMessageListenerContainer; import org.springframework.data.redis.listener.adapter.MessageListenerAdapter; @Configuration @EnableCaching public class RedisConfig{ /** * Redisæ¶ˆæ¯ç›‘å¬å™¨å®¹å™¨ * @param connectionFactory * @return **/ @Bean RedisMessageListenerContainer container(RedisConnectionFactory connectionFactory) { RedisMessageListenerContainer container = new RedisMessageListenerContainer(); container.setConnectionFactory(connectionFactory); //è®¢é˜…äº†ä¸€ä¸ªå«pmpå’Œchannel çš„é€šé“ï¼Œå¤šé€šé“ container.addMessageListener(listenerAdapter(new RedisPmpSub()),new PatternTopic(&quot;pmp&quot;)); container.addMessageListener(listenerAdapter(new RedisChannelSub()),new PatternTopic(&quot;channel&quot;)); //è¿™ä¸ªcontainer å¯ä»¥æ·»åŠ å¤šä¸ª messageListener return container; } /** * é…ç½®æ¶ˆæ¯æ¥æ”¶å¤„ç†ç±» * @param redisMsg è‡ªå®šä¹‰æ¶ˆæ¯æ¥æ”¶ç±» * @return */ @Bean() @Scope(&quot;prototype&quot;) MessageListenerAdapter listenerAdapter(RedisMsg redisMsg) { //è¿™ä¸ªåœ°æ–¹ æ˜¯ç»™messageListenerAdapter ä¼ å…¥ä¸€ä¸ªæ¶ˆæ¯æ¥å—çš„å¤„ç†å™¨ï¼Œåˆ©ç”¨åå°„çš„æ–¹æ³•è°ƒç”¨â€œreceiveMessageâ€ //ä¹Ÿæœ‰å¥½å‡ ä¸ªé‡è½½æ–¹æ³•ï¼Œè¿™è¾¹é»˜è®¤è°ƒç”¨å¤„ç†å™¨çš„æ–¹æ³• å«handleMessage å¯ä»¥è‡ªå·±åˆ°æºç é‡Œé¢çœ‹ return new MessageListenerAdapter(redisMsg, &quot;receiveMessage&quot;);//æ³¨æ„2ä¸ªé€šé“è°ƒç”¨çš„æ–¹æ³•éƒ½è¦ä¸ºreceiveMessage } } å››.æ™®é€šçš„æ¶ˆæ¯å¤„ç†å™¨æ¥å£ package com.example.demo; import org.springframework.stereotype.Component; @Component public interface RedisMsg { public void receiveMessage(String message); } äº”.æ™®é€šçš„æ¶ˆæ¯å¤„ç†å™¨POJO package com.example.demo; /** * @Auther: Administrator * @Date: 2018/7/9 11:01 * @Description: */ public class RedisChannelSub implements RedisMsg { @Override public void receiveMessage(String message) { //æ³¨æ„é€šé“è°ƒç”¨çš„æ–¹æ³•åè¦å’ŒRedisConfigçš„listenerAdapterçš„MessageListenerAdapterå‚æ•°2ç›¸åŒ System.out.println(&quot;è¿™æ˜¯RedisChannelSub&quot;+&quot;-----&quot;+message); } } package com.example.demo; public class RedisPmpSub implements RedisMsg{ /** * æ¥æ”¶æ¶ˆæ¯çš„æ–¹æ³• * @param message è®¢é˜…æ¶ˆæ¯ */ public void receiveMessage(String message){ //æ³¨æ„é€šé“è°ƒç”¨çš„æ–¹æ³•åè¦å’ŒRedisConfigçš„listenerAdapterçš„MessageListenerAdapterå‚æ•°2ç›¸åŒ System.out.println(message); } } å…­.æ¶ˆæ¯å‘å¸ƒè€… package com.example.demo; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.data.redis.core.StringRedisTemplate; import org.springframework.scheduling.annotation.EnableScheduling; import org.springframework.scheduling.annotation.Scheduled; import org.springframework.stereotype.Component; //å®šæ—¶å™¨ @EnableScheduling @Component public class TestSenderController { @Autowired private StringRedisTemplate stringRedisTemplate; //å‘redisæ¶ˆæ¯é˜Ÿåˆ—indexé€šé“å‘å¸ƒæ¶ˆæ¯ @Scheduled(fixedRate = 2000) public void sendMessage(){ stringRedisTemplate.convertAndSend(&quot;pmp&quot;,String.valueOf(Math.random())); stringRedisTemplate.convertAndSend(&quot;channel&quot;,String.valueOf(Math.random())); } } ä¸ƒ.å¯åŠ¨ç±» package com.example.demo; import org.springframework.boot.SpringApplication; import org.springframework.boot.autoconfigure.SpringBootApplication; @SpringBootApplication public class DemoApplication { public static void main(String[] args) { SpringApplication.run(DemoApplication.class, args); } } 3ç§é«˜çº§æ•°æ®ç»“æ„ BitMap BitMapï¼Œå³ä½å›¾ï¼Œå…¶å®ä¹Ÿå°±æ˜¯ byte æ•°ç»„ï¼Œç”¨äºŒè¿›åˆ¶è¡¨ç¤ºï¼Œåªæœ‰ 0 å’Œ 1 ä¸¤ä¸ªæ•°å­—ã€‚ å¦‚å›¾æ‰€ç¤ºï¼š é‡è¦ API å‘½ä»¤ å«ä¹‰ getbit key offset å¯¹keyæ‰€å­˜å‚¨çš„å­—ç¬¦ä¸²å€¼ï¼Œè·å–æŒ‡å®šåç§»é‡ä¸Šçš„ä½ï¼ˆbitï¼‰ setbit key offset value å¯¹keyæ‰€å­˜å‚¨çš„å­—ç¬¦ä¸²å€¼ï¼Œè®¾ç½®æˆ–æ¸…é™¤æŒ‡å®šåç§»é‡ä¸Šçš„ä½ï¼ˆbitï¼‰ 1. è¿”å›å€¼ä¸ºè¯¥ä½åœ¨setbitä¹‹å‰çš„å€¼ 2. valueåªèƒ½å–0æˆ–1 3. offsetä»0å¼€å§‹ï¼Œå³ä½¿åŸä½å›¾åªèƒ½10ä½ï¼Œoffsetå¯ä»¥å–1000 bitcount key [start end] è·å–ä½å›¾æŒ‡å®šèŒƒå›´ä¸­ä½å€¼ä¸º1çš„ä¸ªæ•° å¦‚æœä¸æŒ‡å®šstartä¸endï¼Œåˆ™å–æ‰€æœ‰ bitop op destKey key1 [key2...] åšå¤šä¸ªBitMapçš„andï¼ˆäº¤é›†ï¼‰ã€orï¼ˆå¹¶é›†ï¼‰ã€notï¼ˆéï¼‰ã€xorï¼ˆå¼‚æˆ–ï¼‰æ“ä½œå¹¶å°†ç»“æœä¿å­˜åœ¨destKeyä¸­ bitpos key tartgetBit [start end] è®¡ç®—ä½å›¾æŒ‡å®šèŒƒå›´ç¬¬ä¸€ä¸ªåç§»é‡å¯¹åº”çš„çš„å€¼ç­‰äºtargetBitçš„ä½ç½® 1. æ‰¾ä¸åˆ°è¿”å›-1 2. startä¸endæ²¡æœ‰è®¾ç½®ï¼Œåˆ™å–å…¨éƒ¨ 3. targetBitåªèƒ½å–0æˆ–è€…1 æ¼”ç¤º åº”ç”¨åœºæ™¯ ç»Ÿè®¡æ¯æ—¥ç”¨æˆ·çš„ç™»å½•æ•°ã€‚æ¯ä¸€ä½æ ‡è¯†ä¸€ä¸ªç”¨æˆ·IDï¼Œå½“æŸä¸ªç”¨æˆ·è®¿é—®æˆ‘ä»¬çš„ç½‘é¡µæˆ–æ‰§è¡Œäº†æŸä¸ªæ“ä½œï¼Œå°±åœ¨bitmapä¸­æŠŠæ ‡è¯†æ­¤ç”¨æˆ·çš„ä½è®¾ç½®ä¸º1ã€‚ è¿™é‡Œåšäº†ä¸€ä¸ª ä½¿ç”¨ set å’Œ BitMap å­˜å‚¨çš„å¯¹æ¯”ã€‚ åœºæ™¯1ï¼š1 äº¿ç”¨æˆ·ï¼Œ5åƒä¸‡ç‹¬ç«‹ æ•°æ®ç±»å‹ æ¯ä¸ª userid å ç”¨ç©ºé—´ éœ€è¦å­˜å‚¨çš„ç”¨æˆ·é‡ å…¨éƒ¨å†…å­˜é‡ set 32ä½ï¼ˆå‡è®¾useridç”¨çš„æ˜¯æ•´å‹ï¼Œå®é™…å¾ˆå¤šç½‘ç«™ç”¨çš„æ˜¯é•¿æ•´å‹ï¼‰ 50,000,000 32ä½ * 50,000,000 = 200 MB BitMap 1 ä½ 100,000,000 1 ä½ * 100,000,000 = 12.5 MB ä¸€å¤© ä¸€ä¸ªæœˆ ä¸€å¹´ set 200M 6G 72G BitMap 12.5M 375M 4.5G åœºæ™¯2ï¼šåªæœ‰ 10 ä¸‡ç‹¬ç«‹ç”¨æˆ· æ•°æ®ç±»å‹ æ¯ä¸ª userid å ç”¨ç©ºé—´ éœ€è¦å­˜å‚¨çš„ç”¨æˆ·é‡ å…¨éƒ¨å†…å­˜é‡ set 32ä½ï¼ˆå‡è®¾useridç”¨çš„æ˜¯æ•´å‹ï¼Œå®é™…å¾ˆå¤šç½‘ç«™ç”¨çš„æ˜¯é•¿æ•´å‹ï¼‰ 1,000,000 32ä½ * 1,000,000 = 4 MB BitMap 1 ä½ 100,000,000 1 ä½ * 100,000,000 = 12.5 MB é€šè¿‡ä¸Šé¢çš„å¯¹æ¯”ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœç‹¬ç«‹ç”¨æˆ·æ•°é‡å¾ˆå¤šï¼Œä½¿ç”¨ BitMap æ˜æ˜¾æ›´æœ‰ä¼˜åŠ¿ï¼Œèƒ½èŠ‚çœå¤§é‡çš„å†…å­˜ã€‚ä½†å¦‚æœç‹¬ç«‹ç”¨æˆ·æ•°é‡è¾ƒå°‘ï¼Œè¿˜æ˜¯å»ºè®®ä½¿ç”¨ set å­˜å‚¨ï¼ŒBitMap ä¼šäº§ç”Ÿå¤šä½™çš„å­˜å‚¨å¼€é”€ã€‚ ä½¿ç”¨ç»éªŒ type = stringï¼ŒBitMap æ˜¯ sting ç±»å‹ï¼Œæœ€å¤§ 512 MBã€‚ æ³¨æ„ setbit æ—¶çš„åç§»é‡ï¼Œå¯èƒ½æœ‰è¾ƒå¤§è€—æ—¶ ä½å›¾ä¸æ˜¯ç»å¯¹å¥½ã€‚ HyperLogLog HyperLogLog æ˜¯åŸºäº HyperLogLog ç®—æ³•çš„ä¸€ç§æ•°æ®ç»“æ„ï¼Œè¯¥ç®—æ³•å¯ä»¥åœ¨æå°ç©ºé—´å®Œæˆç‹¬ç«‹æ•°é‡ç»Ÿè®¡ã€‚ åœ¨æœ¬è´¨ä¸Šè¿˜æ˜¯å­—ç¬¦ä¸²ç±»å‹ã€‚ é‡è¦ API å‘½ä»¤ å«ä¹‰ pfadd key element1 [element2...] å‘HyperLogLogä¸­æ·»åŠ å…ƒç´  pfcount key1 [key2...] è®¡ç®—HyperLogLogçš„ç‹¬ç«‹æ€»æ•° pfmerge destKey key1 [key2...] åˆå¹¶å¤šä¸ªhyperLogLogåˆ°destKeyä¸­ æ¼”ç¤º å†…å­˜æ¶ˆè€— ä»¥ç™¾ä¸‡ç‹¬ç«‹ç”¨æˆ·ä¸ºä¾‹ å†…å­˜æ¶ˆè€— 1 å¤© 15 KB 1 ä¸ªæœˆ 450 KB 1 å¹´ 15KB * 365 = 5 MB å¯ä»¥çœ‹åˆ°å†…å­˜æ¶ˆè€—æ˜¯éå¸¸ä½çš„ï¼Œæ¯”æˆ‘ä»¬ä¹‹å‰å­¦è¿‡çš„ BitMap è¿˜è¦ä½å¾—å¤šã€‚ ä½¿ç”¨ç»éªŒ Qï¼šæ—¢ç„¶ HyperLogLog é‚£ä¹ˆå¥½ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯ä»¥åç”¨è¿™ä¸ªæ¥å­˜å‚¨æ•°æ®å°±è¡Œäº†å‘¢ï¼Ÿ Aï¼šè¿™é‡Œè¦è€ƒè™‘ä¸¤ä¸ªå› ç´ ï¼š hyperloglog çš„é”™è¯¯ç‡ä¸ºï¼š0.81%ï¼Œå­˜å‚¨çš„æ•°æ®ä¸èƒ½ç™¾åˆ†ç™¾å‡†ç¡®ã€‚ hyperloglog ä¸èƒ½å–å‡ºå•æ¡æ•°æ®ã€‚api ä¸­ä¹Ÿæ²¡æœ‰ç›¸å…³æ“ä½œã€‚ å¦‚æœä½ æ²¡æœ‰è¿™ä¸¤ä¸ªæ–¹é¢çš„é¡¾è™‘ï¼Œé‚£ä¹ˆç”¨ HyperLogLog æ¥å­˜å‚¨å¤§è§„æ¨¡æ•°æ®ï¼Œè¿˜æ˜¯éå¸¸ä¸é”™çš„ã€‚ GEO Redis 3.2æ·»åŠ æ–°ç‰¹æ€§ åŠŸèƒ½ï¼šå­˜å‚¨ç»çº¬åº¦ã€è®¡ç®—ä¸¤åœ°è·ç¦»ã€èŒƒå›´è®¡ç®—ç­‰ åŸºäºZSetå®ç° åˆ é™¤æ“ä½œä½¿ç”¨ zrem key member GEO ç›¸å…³å‘½ä»¤ 1. geoadd key longitude latitude member [lon lat member...] å«ä¹‰ï¼šå¢åŠ åœ°ç†ä½ç½®ä¿¡æ¯ longitude ï¼šç»åº¦ latitude : çº¬åº¦ member : æ ‡è¯†ä¿¡æ¯ 2. geopos key member1 [member2...] å«ä¹‰ï¼šè·å–åœ°ç†ä½ç½®ä¿¡æ¯ 3. geodist key member1 member2 [unit] å«ä¹‰ï¼šè·å–ä¸¤ä¸ªåœ°ç†ä½ç½®çš„è·ç¦» unitå–å€¼èŒƒå›´ mï¼ˆç±³ï¼Œé»˜è®¤ï¼‰ kmï¼ˆåƒç±³ï¼‰ miï¼ˆè‹±é‡Œï¼‰ ftï¼ˆè‹±å°ºï¼‰ 4. georadius key longitude latitude unit [withcoord] [withdist] [withhash] [COUNT count] [sort] [store key] [storedist key] å«ä¹‰ï¼šä»¥ç»™å®šçš„ç»çº¬åº¦ä¸ºä¸­å¿ƒï¼Œè¿”å›åŒ…å«çš„ä½ç½®å…ƒç´ å½“ä¸­ï¼Œä¸ä¸­å¿ƒè·ç¦»ä¸è¶…è¿‡ç»™å®šæœ€å¤§è·ç¦»çš„æ‰€æœ‰ä½ç½®å…ƒç´ ã€‚ unitå–å€¼èŒƒå›´ mï¼ˆç±³ï¼‰ kmï¼ˆåƒç±³ï¼‰ miï¼ˆè‹±é‡Œï¼‰ ftï¼ˆè‹±å°ºï¼‰ withcoordï¼šå°†ä½ç½®å…ƒç´ çš„ç»åº¦ä¸çº¬åº¦ä¹Ÿä¸€å¹¶è¿”å› withdistï¼šåœ¨è¿”å›ä½ç½®å…ƒç´ çš„åŒæ—¶ï¼Œå°†è·ç¦»ä¹Ÿä¸€å¹¶è¿”å›ã€‚è·ç¦»çš„å•ä½å’Œç”¨æˆ·ç»™å®šçš„èŒƒå›´å•ä½ä¿æŒä¸€è‡´ withhashï¼šä»¥52ä½çš„ç¬¦å·æ•´æ•°å½¢å¼ï¼Œè¿”å›ä½ç½®å…ƒç´ ç»è¿‡geohashç¼–ç çš„æœ‰åºé›†åˆåˆ†å€¼ã€‚ç”¨äºåº•å±‚åº”ç”¨æˆ–è°ƒè¯•ï¼Œå®é™…ä½œç”¨ä¸å¤§ã€‚ sortå–å€¼èŒƒå›´ ascï¼šæ ¹æ®ä¸­å¿ƒä½ç½®ï¼ŒæŒ‰ç…§ä»è¿‘åˆ°è¿œçš„æ–¹å¼è¿”å›ä½ç½®å…ƒç´  descï¼šæ ¹æ®ä¸­å¿ƒä½ç½®ï¼ŒæŒ‰ç…§ä»è¿œåˆ°è¿‘çš„æ–¹å¼è¿”å›ä½ç½®å…ƒç´  store keyï¼šå°†è¿”å›ç»“æœè€Œçš„åœ°ç†ä½ç½®ä¿¡æ¯ä¿å­˜åˆ°æŒ‡å®šé”® storedist keyï¼šå°†è¿”å›ç»“æœè·ç¦»ä¸­å¿ƒèŠ‚ç‚¹çš„è·ç¦»ä¿å­˜åˆ°æŒ‡å®šé”® 5. georadiusbymember key member radius unit [withcoord][withdist][withhash][COUNT count][sort][store key][storedist key] å«ä¹‰ï¼šä»¥ç»™å®šçš„å…ƒç´ ä¸ºä¸­å¿ƒï¼Œè¿”å›åŒ…å«çš„ä½ç½®å…ƒç´ å½“ä¸­ï¼Œä¸ä¸­å¿ƒè·ç¦»ä¸è¶…è¿‡ç»™å®šæœ€å¤§è·ç¦»çš„æ‰€æœ‰ä½ç½®å…ƒç´ ã€‚ unitå–å€¼èŒƒå›´ mï¼ˆç±³ï¼‰ kmï¼ˆåƒç±³ï¼‰ miï¼ˆè‹±é‡Œï¼‰ ftï¼ˆè‹±å°ºï¼‰ withcoordï¼šå°†ä½ç½®å…ƒç´ çš„ç»åº¦ä¸çº¬åº¦ä¹Ÿä¸€å¹¶è¿”å› withdistï¼šåœ¨è¿”å›ä½ç½®å…ƒç´ çš„åŒæ—¶ï¼Œå°†è·ç¦»ä¹Ÿä¸€å¹¶è¿”å›ã€‚è·ç¦»çš„å•ä½å’Œç”¨æˆ·ç»™å®šçš„èŒƒå›´å•ä½ä¿æŒä¸€è‡´ withhashï¼šä»¥52ä½çš„ç¬¦å·æ•´æ•°å½¢å¼ï¼Œè¿”å›ä½ç½®å…ƒç´ ç»è¿‡geohashç¼–ç çš„æœ‰åºé›†åˆåˆ†å€¼ã€‚ç”¨äºåº•å±‚åº”ç”¨æˆ–è°ƒè¯•ï¼Œå®é™…ä½œç”¨ä¸å¤§ã€‚ sortå–å€¼èŒƒå›´ ascï¼šæ ¹æ®ä¸­å¿ƒä½ç½®ï¼ŒæŒ‰ç…§ä»è¿‘åˆ°è¿œçš„æ–¹å¼è¿”å›ä½ç½®å…ƒç´  descï¼šæ ¹æ®ä¸­å¿ƒä½ç½®ï¼ŒæŒ‰ç…§ä»è¿œåˆ°è¿‘çš„æ–¹å¼è¿”å›ä½ç½®å…ƒç´  store keyï¼šå°†è¿”å›ç»“æœè€Œçš„åœ°ç†ä½ç½®ä¿¡æ¯ä¿å­˜åˆ°æŒ‡å®šé”® storedist keyï¼šå°†è¿”å›ç»“æœè·ç¦»ä¸­å¿ƒèŠ‚ç‚¹çš„è·ç¦»ä¿å­˜åˆ°æŒ‡å®šé”® æ¼”ç¤º geo åŠŸèƒ½æ˜¯åœ¨ redis-3.2 åå¼•å…¥çš„ 127.0.0.1:6381&gt; geoadd cities:locations 116.28 39.55 beijing (integer) 1 127.0.0.1:6381&gt; geoadd cities:locations 117.12 39.08 tianjin 114.29 38.02 shijiazhuang 118.01 39.38 tangshan 115.29 38.51 baoding (integer) 4 127.0.0.1:6381&gt; geopos cities:locations tianjin 1) 1) &quot;117.12000042200088501&quot; 2) &quot;39.0800000535766543&quot; 127.0.0.1:6381&gt; geodist cities:locations tianjin beijing km &quot;89.2061&quot; 127.0.0.1:6379&gt; georadiusbymember cities:locations beijing 150 km 1) &quot;beijing&quot; 2) &quot;tianjin&quot; 3) &quot;tangshan&quot; 4) &quot;baoding&quot;ã€‚ ","link":"https://tianxiawuhao.github.io/YNIBE7Yaj/"},{"title":"redisæ¦‚è¿°ä¸€","content":"ä»€ä¹ˆæ˜¯Redis Redis(Remote Dictionary Server) æ˜¯ä¸€ä¸ªä½¿ç”¨ C è¯­è¨€ç¼–å†™çš„ï¼Œå¼€æºçš„ï¼ˆBSDè®¸å¯ï¼‰é«˜æ€§èƒ½éå…³ç³»å‹ï¼ˆNoSQLï¼‰çš„é”®å€¼å¯¹æ•°æ®åº“ã€‚ Redis å¯ä»¥å­˜å‚¨é”®å’Œäº”ç§ä¸åŒç±»å‹çš„å€¼ä¹‹é—´çš„æ˜ å°„ã€‚é”®çš„ç±»å‹åªèƒ½ä¸ºå­—ç¬¦ä¸²ï¼Œå€¼æ”¯æŒäº”ç§æ•°æ®ç±»å‹ï¼šå­—ç¬¦ä¸²ã€åˆ—è¡¨ã€é›†åˆã€æ•£åˆ—è¡¨ã€æœ‰åºé›†åˆã€‚ ä¸ä¼ ç»Ÿæ•°æ®åº“ä¸åŒçš„æ˜¯ Redis çš„æ•°æ®æ˜¯å­˜åœ¨å†…å­˜ä¸­çš„ï¼Œæ‰€ä»¥è¯»å†™é€Ÿåº¦éå¸¸å¿«ï¼Œå› æ­¤ redis è¢«å¹¿æ³›åº”ç”¨äºç¼“å­˜æ–¹å‘ï¼Œæ¯ç§’å¯ä»¥å¤„ç†è¶…è¿‡ 10ä¸‡æ¬¡è¯»å†™æ“ä½œï¼Œæ˜¯å·²çŸ¥æ€§èƒ½æœ€å¿«çš„Key-Value DBã€‚å¦å¤–ï¼ŒRedis ä¹Ÿç»å¸¸ç”¨æ¥åšåˆ†å¸ƒå¼é”ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒRedis æ”¯æŒäº‹åŠ¡ ã€æŒä¹…åŒ–ã€LUAè„šæœ¬ã€LRUé©±åŠ¨äº‹ä»¶ã€å¤šç§é›†ç¾¤æ–¹æ¡ˆã€‚ Redisæœ‰å“ªäº›ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ è¯»å†™æ€§èƒ½ä¼˜å¼‚ï¼Œ Redisèƒ½è¯»çš„é€Ÿåº¦æ˜¯110000æ¬¡/sï¼Œå†™çš„é€Ÿåº¦æ˜¯81000æ¬¡/sã€‚ æ”¯æŒæ•°æ®æŒä¹…åŒ–ï¼Œæ”¯æŒAOFå’ŒRDBä¸¤ç§æŒä¹…åŒ–æ–¹å¼ã€‚ æ”¯æŒäº‹åŠ¡ï¼ŒRedisçš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ï¼ŒåŒæ—¶Redisè¿˜æ”¯æŒå¯¹å‡ ä¸ªæ“ä½œåˆå¹¶åçš„åŸå­æ€§æ‰§è¡Œã€‚ æ•°æ®ç»“æ„ä¸°å¯Œï¼Œé™¤äº†æ”¯æŒstringç±»å‹çš„valueå¤–è¿˜æ”¯æŒhashã€setã€zsetã€listç­‰æ•°æ®ç»“æ„ã€‚ æ”¯æŒä¸»ä»å¤åˆ¶ï¼Œä¸»æœºä¼šè‡ªåŠ¨å°†æ•°æ®åŒæ­¥åˆ°ä»æœºï¼Œå¯ä»¥è¿›è¡Œè¯»å†™åˆ†ç¦»ã€‚ ç¼ºç‚¹ æ•°æ®åº“å®¹é‡å—åˆ°ç‰©ç†å†…å­˜çš„é™åˆ¶ï¼Œä¸èƒ½ç”¨ä½œæµ·é‡æ•°æ®çš„é«˜æ€§èƒ½è¯»å†™ï¼Œå› æ­¤Redisé€‚åˆçš„åœºæ™¯ä¸»è¦å±€é™åœ¨è¾ƒå°æ•°æ®é‡çš„é«˜æ€§èƒ½æ“ä½œå’Œè¿ç®—ä¸Šã€‚ Redis ä¸å…·å¤‡è‡ªåŠ¨å®¹é”™å’Œæ¢å¤åŠŸèƒ½ï¼Œä¸»æœºä»æœºçš„å®•æœºéƒ½ä¼šå¯¼è‡´å‰ç«¯éƒ¨åˆ†è¯»å†™è¯·æ±‚å¤±è´¥ï¼Œéœ€è¦ç­‰å¾…æœºå™¨é‡å¯æˆ–è€…æ‰‹åŠ¨åˆ‡æ¢å‰ç«¯çš„IPæ‰èƒ½æ¢å¤ã€‚ ä¸»æœºå®•æœºï¼Œå®•æœºå‰æœ‰éƒ¨åˆ†æ•°æ®æœªèƒ½åŠæ—¶åŒæ­¥åˆ°ä»æœºï¼Œåˆ‡æ¢IPåè¿˜ä¼šå¼•å…¥æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œé™ä½äº†ç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚ Redis è¾ƒéš¾æ”¯æŒåœ¨çº¿æ‰©å®¹ï¼Œåœ¨é›†ç¾¤å®¹é‡è¾¾åˆ°ä¸Šé™æ—¶åœ¨çº¿æ‰©å®¹ä¼šå˜å¾—å¾ˆå¤æ‚ã€‚ä¸ºé¿å…è¿™ä¸€é—®é¢˜ï¼Œè¿ç»´äººå‘˜åœ¨ç³»ç»Ÿä¸Šçº¿æ—¶å¿…é¡»ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œè¿™å¯¹èµ„æºé€ æˆäº†å¾ˆå¤§çš„æµªè´¹ã€‚ ä¸ºä»€ä¹ˆè¦ç”¨ Redis /ä¸ºä»€ä¹ˆè¦ç”¨ç¼“å­˜ ä¸»è¦ä»â€œé«˜æ€§èƒ½â€å’Œâ€œé«˜å¹¶å‘â€è¿™ä¸¤ç‚¹æ¥çœ‹å¾…è¿™ä¸ªé—®é¢˜ã€‚ é«˜æ€§èƒ½ï¼š å‡å¦‚ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®æ•°æ®åº“ä¸­çš„æŸäº›æ•°æ®ã€‚è¿™ä¸ªè¿‡ç¨‹ä¼šæ¯”è¾ƒæ…¢ï¼Œå› ä¸ºæ˜¯ä»ç¡¬ç›˜ä¸Šè¯»å–çš„ã€‚å°†è¯¥ç”¨æˆ·è®¿é—®çš„æ•°æ®å­˜åœ¨ç¼“å­˜ä¸­ï¼Œè¿™æ ·ä¸‹ä¸€æ¬¡å†è®¿é—®è¿™äº›æ•°æ®çš„æ—¶å€™å°±å¯ä»¥ç›´æ¥ä»ç¼“å­˜ä¸­è·å–äº†ã€‚æ“ä½œç¼“å­˜å°±æ˜¯ç›´æ¥æ“ä½œå†…å­˜ï¼Œæ‰€ä»¥é€Ÿåº¦ç›¸å½“å¿«ã€‚å¦‚æœæ•°æ®åº“ä¸­çš„å¯¹åº”æ•°æ®æ”¹å˜çš„ä¹‹åï¼ŒåŒæ­¥æ”¹å˜ç¼“å­˜ä¸­ç›¸åº”çš„æ•°æ®å³å¯ï¼ é«˜å¹¶å‘ï¼š ç›´æ¥æ“ä½œç¼“å­˜èƒ½å¤Ÿæ‰¿å—çš„è¯·æ±‚æ˜¯è¿œè¿œå¤§äºç›´æ¥è®¿é—®æ•°æ®åº“çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è€ƒè™‘æŠŠæ•°æ®åº“ä¸­çš„éƒ¨åˆ†æ•°æ®è½¬ç§»åˆ°ç¼“å­˜ä¸­å»ï¼Œè¿™æ ·ç”¨æˆ·çš„ä¸€éƒ¨åˆ†è¯·æ±‚ä¼šç›´æ¥åˆ°ç¼“å­˜è¿™é‡Œè€Œä¸ç”¨ç»è¿‡æ•°æ®åº“ã€‚ ä¸ºä»€ä¹ˆè¦ç”¨ Redis è€Œä¸ç”¨ map/guava åšç¼“å­˜? ç¼“å­˜åˆ†ä¸ºæœ¬åœ°ç¼“å­˜å’Œåˆ†å¸ƒå¼ç¼“å­˜ã€‚ä»¥ Java ä¸ºä¾‹ï¼Œä½¿ç”¨è‡ªå¸¦çš„ map æˆ–è€… guava å®ç°çš„æ˜¯æœ¬åœ°ç¼“å­˜ï¼Œæœ€ä¸»è¦çš„ç‰¹ç‚¹æ˜¯è½»é‡ä»¥åŠå¿«é€Ÿï¼Œç”Ÿå‘½å‘¨æœŸéšç€ jvm çš„é”€æ¯è€Œç»“æŸï¼Œå¹¶ä¸”åœ¨å¤šå®ä¾‹çš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªå®ä¾‹éƒ½éœ€è¦å„è‡ªä¿å­˜ä¸€ä»½ç¼“å­˜ï¼Œç¼“å­˜ä¸å…·æœ‰ä¸€è‡´æ€§ã€‚ ä½¿ç”¨ redis æˆ– memcached ä¹‹ç±»çš„ç§°ä¸ºåˆ†å¸ƒå¼ç¼“å­˜ï¼Œåœ¨å¤šå®ä¾‹çš„æƒ…å†µä¸‹ï¼Œå„å®ä¾‹å…±ç”¨ä¸€ä»½ç¼“å­˜æ•°æ®ï¼Œç¼“å­˜å…·æœ‰ä¸€è‡´æ€§ã€‚ç¼ºç‚¹æ˜¯éœ€è¦ä¿æŒ redis æˆ– memcachedæœåŠ¡çš„é«˜å¯ç”¨ï¼Œæ•´ä¸ªç¨‹åºæ¶æ„ä¸Šè¾ƒä¸ºå¤æ‚ã€‚ Redisä¸ºä»€ä¹ˆè¿™ä¹ˆå¿« 1ã€å®Œå…¨åŸºäºå†…å­˜ï¼Œç»å¤§éƒ¨åˆ†è¯·æ±‚æ˜¯çº¯ç²¹çš„å†…å­˜æ“ä½œï¼Œéå¸¸å¿«é€Ÿã€‚æ•°æ®å­˜åœ¨å†…å­˜ä¸­ï¼Œç±»ä¼¼äº HashMapï¼ŒHashMap çš„ä¼˜åŠ¿å°±æ˜¯æŸ¥æ‰¾å’Œæ“ä½œçš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯O(1)ï¼› 2ã€æ•°æ®ç»“æ„ç®€å•ï¼Œå¯¹æ•°æ®æ“ä½œä¹Ÿç®€å•ï¼ŒRedis ä¸­çš„æ•°æ®ç»“æ„æ˜¯ä¸“é—¨è¿›è¡Œè®¾è®¡çš„ï¼› 3ã€é‡‡ç”¨å•çº¿ç¨‹ï¼Œé¿å…äº†ä¸å¿…è¦çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œç«äº‰æ¡ä»¶ï¼Œä¹Ÿä¸å­˜åœ¨å¤šè¿›ç¨‹æˆ–è€…å¤šçº¿ç¨‹å¯¼è‡´çš„åˆ‡æ¢è€Œæ¶ˆè€— CPUï¼Œä¸ç”¨å»è€ƒè™‘å„ç§é”çš„é—®é¢˜ï¼Œä¸å­˜åœ¨åŠ é”é‡Šæ”¾é”æ“ä½œï¼Œæ²¡æœ‰å› ä¸ºå¯èƒ½å‡ºç°æ­»é”è€Œå¯¼è‡´çš„æ€§èƒ½æ¶ˆè€—ï¼› 4ã€ä½¿ç”¨å¤šè·¯ I/O å¤ç”¨æ¨¡å‹ï¼Œéé˜»å¡ IOï¼› 5ã€ä½¿ç”¨åº•å±‚æ¨¡å‹ä¸åŒï¼Œå®ƒä»¬ä¹‹é—´åº•å±‚å®ç°æ–¹å¼ä»¥åŠä¸å®¢æˆ·ç«¯ä¹‹é—´é€šä¿¡çš„åº”ç”¨åè®®ä¸ä¸€æ ·ï¼ŒRedis ç›´æ¥è‡ªå·±æ„å»ºäº† VM æœºåˆ¶ ï¼Œå› ä¸ºä¸€èˆ¬çš„ç³»ç»Ÿè°ƒç”¨ç³»ç»Ÿå‡½æ•°çš„è¯ï¼Œä¼šæµªè´¹ä¸€å®šçš„æ—¶é—´å»ç§»åŠ¨å’Œè¯·æ±‚ï¼› ","link":"https://tianxiawuhao.github.io/7i0HRwy0e/"},{"title":"å¤šçº¿ç¨‹åŸºç¡€æ¦‚å¿µå››","content":"Lock æ¥å£(Lock interface)ç®€ä»‹ Lock æ¥å£æ¯”åŒæ­¥æ–¹æ³•å’ŒåŒæ­¥å—æä¾›äº†æ›´å…·æ‰©å±•æ€§çš„é”æ“ä½œã€‚ä»–ä»¬å…è®¸æ›´çµæ´»çš„ç»“æ„ï¼Œå¯ä»¥å…·æœ‰å®Œå…¨ä¸åŒçš„æ€§è´¨ï¼Œå¹¶ä¸”å¯ä»¥æ”¯æŒå¤šä¸ªç›¸å…³ç±»çš„æ¡ä»¶å¯¹è±¡ã€‚ ä¼˜åŠ¿ å®ƒçš„ä¼˜åŠ¿æœ‰ï¼š ï¼ˆ1ï¼‰å¯ä»¥ä½¿é”æ›´å…¬å¹³ ï¼ˆ2ï¼‰å¯ä»¥ä½¿çº¿ç¨‹åœ¨ç­‰å¾…é”çš„æ—¶å€™å“åº”ä¸­æ–­ ï¼ˆ3ï¼‰å¯ä»¥è®©çº¿ç¨‹å°è¯•è·å–é”ï¼Œå¹¶åœ¨æ— æ³•è·å–é”çš„æ—¶å€™ç«‹å³è¿”å›æˆ–è€…ç­‰å¾…ä¸€æ®µæ—¶é—´ ï¼ˆ4ï¼‰å¯ä»¥åœ¨ä¸åŒçš„èŒƒå›´ï¼Œä»¥ä¸åŒçš„é¡ºåºè·å–å’Œé‡Šæ”¾é” æ•´ä½“ä¸Šæ¥è¯´ Lock æ˜¯ synchronized çš„æ‰©å±•ç‰ˆï¼ŒLock æä¾›äº†æ— æ¡ä»¶çš„ã€å¯è½®è¯¢çš„(tryLock æ–¹æ³•)ã€å®šæ—¶çš„(tryLock å¸¦å‚æ–¹æ³•)ã€å¯ä¸­æ–­çš„(lockInterruptibly)ã€å¯å¤šæ¡ä»¶é˜Ÿåˆ—çš„(newCondition æ–¹æ³•)é”æ“ä½œã€‚å¦å¤– Lock çš„å®ç°ç±»åŸºæœ¬éƒ½æ”¯æŒéå…¬å¹³é”(é»˜è®¤)å’Œå…¬å¹³é”ï¼Œsynchronized åªæ”¯æŒéå…¬å¹³é”ï¼Œå½“ç„¶ï¼Œåœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œéå…¬å¹³é”æ˜¯é«˜æ•ˆçš„é€‰æ‹©ã€‚ ä¹è§‚é”å’Œæ‚²è§‚é” æ‚²è§‚é”ï¼šæ€»æ˜¯å‡è®¾æœ€åçš„æƒ…å†µï¼Œæ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¼šä¿®æ”¹ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨æ‹¿æ•°æ®çš„æ—¶å€™éƒ½ä¼šä¸Šé”ï¼Œè¿™æ ·åˆ«äººæƒ³æ‹¿è¿™ä¸ªæ•°æ®å°±ä¼šé˜»å¡ç›´åˆ°å®ƒæ‹¿åˆ°é”ã€‚ä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“é‡Œè¾¹å°±ç”¨åˆ°äº†å¾ˆå¤šè¿™ç§é”æœºåˆ¶ï¼Œæ¯”å¦‚è¡Œé”ï¼Œè¡¨é”ç­‰ï¼Œè¯»é”ï¼Œå†™é”ç­‰ï¼Œéƒ½æ˜¯åœ¨åšæ“ä½œä¹‹å‰å…ˆä¸Šé”ã€‚å†æ¯”å¦‚ Java é‡Œé¢çš„åŒæ­¥åŸè¯­ synchronized å…³é”®å­—çš„å®ç°ä¹Ÿæ˜¯æ‚²è§‚é”ã€‚ ä¹è§‚é”ï¼šé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å¾ˆä¹è§‚ï¼Œæ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¸ä¼šä¿®æ”¹ï¼Œæ‰€ä»¥ä¸ä¼šä¸Šé”ï¼Œä½†æ˜¯åœ¨æ›´æ–°çš„æ—¶å€™ä¼šåˆ¤æ–­ä¸€ä¸‹åœ¨æ­¤æœŸé—´åˆ«äººæœ‰æ²¡æœ‰å»æ›´æ–°è¿™ä¸ªæ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ç‰ˆæœ¬å·ç­‰æœºåˆ¶ã€‚ä¹è§‚é”é€‚ç”¨äºå¤šè¯»çš„åº”ç”¨ç±»å‹ï¼Œè¿™æ ·å¯ä»¥æé«˜ååé‡ï¼Œåƒæ•°æ®åº“æä¾›çš„ç±»ä¼¼äº write_condition æœºåˆ¶ï¼Œå…¶å®éƒ½æ˜¯æä¾›çš„ä¹è§‚é”ã€‚åœ¨ Javaä¸­ java.util.concurrent.atomic åŒ…ä¸‹é¢çš„åŸå­å˜é‡ç±»å°±æ˜¯ä½¿ç”¨äº†ä¹è§‚é”çš„ä¸€ç§å®ç°æ–¹å¼ CAS å®ç°çš„ã€‚ ä¹è§‚é”çš„å®ç°æ–¹å¼ï¼š 1ã€ä½¿ç”¨ç‰ˆæœ¬æ ‡è¯†æ¥ç¡®å®šè¯»åˆ°çš„æ•°æ®ä¸æäº¤æ—¶çš„æ•°æ®æ˜¯å¦ä¸€è‡´ã€‚æäº¤åä¿®æ”¹ç‰ˆæœ¬æ ‡è¯†ï¼Œä¸ä¸€è‡´æ—¶å¯ä»¥é‡‡å–ä¸¢å¼ƒå’Œå†æ¬¡å°è¯•çš„ç­–ç•¥ã€‚ 2ã€java ä¸­çš„ Compare and Swap å³ CAS ï¼Œå½“å¤šä¸ªçº¿ç¨‹å°è¯•ä½¿ç”¨ CAS åŒæ—¶æ›´æ–°åŒä¸€ä¸ªå˜é‡æ—¶ï¼Œåªæœ‰å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹èƒ½æ›´æ–°å˜é‡çš„å€¼ï¼Œè€Œå…¶å®ƒçº¿ç¨‹éƒ½å¤±è´¥ï¼Œå¤±è´¥çš„çº¿ç¨‹å¹¶ä¸ä¼šè¢«æŒ‚èµ·ï¼Œè€Œæ˜¯è¢«å‘ŠçŸ¥è¿™æ¬¡ç«äº‰ä¸­å¤±è´¥ï¼Œå¹¶å¯ä»¥å†æ¬¡å°è¯•ã€‚ CAS æ“ä½œä¸­åŒ…å«ä¸‰ä¸ªæ“ä½œæ•° â€”â€” éœ€è¦è¯»å†™çš„å†…å­˜ä½ç½®ï¼ˆVï¼‰ï¼Œè¿›è¡Œæ¯”è¾ƒçš„é¢„æœŸåŸå€¼ï¼ˆAï¼‰å’Œæ‹Ÿå†™å…¥çš„æ–°å€¼(B)ã€‚å¦‚æœå†…å­˜ä½ç½® V çš„å€¼ä¸é¢„æœŸåŸå€¼ A ç›¸åŒ¹é…ï¼Œé‚£ä¹ˆå¤„ç†å™¨ä¼šè‡ªåŠ¨å°†è¯¥ä½ç½®å€¼æ›´æ–°ä¸ºæ–°å€¼ Bã€‚å¦åˆ™å¤„ç†å™¨ä¸åšä»»ä½•æ“ä½œã€‚ CAS CAS æ˜¯ compare and swap çš„ç¼©å†™ï¼Œå³æˆ‘ä»¬æ‰€è¯´çš„æ¯”è¾ƒäº¤æ¢ã€‚ CAS æ˜¯ä¸€ç§åŸºäºé”çš„æ“ä½œï¼Œè€Œä¸”æ˜¯ä¹è§‚é”ã€‚åœ¨ java ä¸­é”åˆ†ä¸ºä¹è§‚é”å’Œæ‚²è§‚é”ã€‚æ‚²è§‚é”æ˜¯å°†èµ„æºé”ä½ï¼Œç­‰ä¸€ä¸ªä¹‹å‰è·å¾—é”çš„çº¿ç¨‹é‡Šæ”¾é”ä¹‹åï¼Œä¸‹ä¸€ä¸ªçº¿ç¨‹æ‰å¯ä»¥è®¿é—®ã€‚è€Œä¹è§‚é”é‡‡å–äº†ä¸€ç§å®½æ³›çš„æ€åº¦ï¼Œé€šè¿‡æŸç§æ–¹å¼ä¸åŠ é”æ¥å¤„ç†èµ„æºï¼Œæ¯”å¦‚é€šè¿‡ç»™è®°å½•åŠ  version æ¥è·å–æ•°æ®ï¼Œæ€§èƒ½è¾ƒæ‚²è§‚é”æœ‰å¾ˆå¤§çš„æé«˜ã€‚ CAS æ“ä½œåŒ…å«ä¸‰ä¸ªæ“ä½œæ•° â€”â€” å†…å­˜ä½ç½®ï¼ˆVï¼‰ã€é¢„æœŸåŸå€¼ï¼ˆAï¼‰å’Œæ–°å€¼(B)ã€‚å¦‚æœå†…å­˜åœ°å€é‡Œé¢çš„å€¼å’Œ A çš„å€¼æ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆå°±å°†å†…å­˜é‡Œé¢çš„å€¼æ›´æ–°æˆ Bã€‚CASæ˜¯é€šè¿‡æ— é™å¾ªç¯æ¥è·å–æ•°æ®çš„ï¼Œè‹¥æœåœ¨ç¬¬ä¸€è½®å¾ªç¯ä¸­ï¼Œa çº¿ç¨‹è·å–åœ°å€é‡Œé¢çš„å€¼è¢«b çº¿ç¨‹ä¿®æ”¹äº†ï¼Œé‚£ä¹ˆ a çº¿ç¨‹éœ€è¦è‡ªæ—‹ï¼Œåˆ°ä¸‹æ¬¡å¾ªç¯æ‰æœ‰å¯èƒ½æœºä¼šæ‰§è¡Œã€‚ java.util.concurrent.atomic åŒ…ä¸‹çš„ç±»å¤§å¤šæ˜¯ä½¿ç”¨ CAS æ“ä½œæ¥å®ç°çš„(AtomicInteger,AtomicBoolean,AtomicLong)ã€‚ CASäº§ç”Ÿçš„é—®é¢˜ ABA é—®é¢˜ï¼š æ¯”å¦‚è¯´ä¸€ä¸ªçº¿ç¨‹ one ä»å†…å­˜ä½ç½® V ä¸­å–å‡º Aï¼Œè¿™æ—¶å€™å¦ä¸€ä¸ªçº¿ç¨‹ two ä¹Ÿä»å†…å­˜ä¸­å–å‡º Aï¼Œå¹¶ä¸” two è¿›è¡Œäº†ä¸€äº›æ“ä½œå˜æˆäº† Bï¼Œç„¶å two åˆå°† V ä½ç½®çš„æ•°æ®å˜æˆ Aï¼Œè¿™æ—¶å€™çº¿ç¨‹ one è¿›è¡Œ CAS æ“ä½œå‘ç°å†…å­˜ä¸­ä»ç„¶æ˜¯ Aï¼Œç„¶å one æ“ä½œæˆåŠŸã€‚å°½ç®¡çº¿ç¨‹ one çš„ CAS æ“ä½œæˆåŠŸï¼Œä½†å¯èƒ½å­˜åœ¨æ½œè—çš„é—®é¢˜ã€‚ä» Java1.5 å¼€å§‹ JDK çš„ atomicåŒ…é‡Œæä¾›äº†ä¸€ä¸ªç±» AtomicStampedReference æ¥è§£å†³ ABA é—®é¢˜ã€‚ å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§ï¼š å¯¹äºèµ„æºç«äº‰ä¸¥é‡ï¼ˆçº¿ç¨‹å†²çªä¸¥é‡ï¼‰çš„æƒ…å†µï¼ŒCAS è‡ªæ—‹çš„æ¦‚ç‡ä¼šæ¯”è¾ƒå¤§ï¼Œä»è€Œæµªè´¹æ›´å¤šçš„ CPU èµ„æºï¼Œæ•ˆç‡ä½äº synchronizedã€‚ åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œï¼š å½“å¯¹ä¸€ä¸ªå…±äº«å˜é‡æ‰§è¡Œæ“ä½œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¾ªç¯ CAS çš„æ–¹å¼æ¥ä¿è¯åŸå­æ“ä½œï¼Œä½†æ˜¯å¯¹å¤šä¸ªå…±äº«å˜é‡æ“ä½œæ—¶ï¼Œå¾ªç¯ CAS å°±æ— æ³•ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç”¨é”ã€‚ å…¬å¹³é”é”å’Œéå…¬å¹³é” å…¬å¹³é”ï¼šå¤šä¸ªçº¿ç¨‹æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºå»è·å¾—é”ï¼Œçº¿ç¨‹ä¼šç›´æ¥è¿›å…¥é˜Ÿåˆ—å»æ’é˜Ÿï¼Œæ°¸è¿œéƒ½æ˜¯é˜Ÿåˆ—çš„ç¬¬ä¸€ä½æ‰èƒ½å¾—åˆ°é”ã€‚ ä¼˜ç‚¹ï¼šæ‰€æœ‰çš„çº¿ç¨‹éƒ½èƒ½å¾—åˆ°èµ„æºï¼Œä¸ä¼šé¥¿æ­»åœ¨é˜Ÿåˆ—ä¸­ã€‚ ç¼ºç‚¹ï¼šååé‡ä¼šä¸‹é™å¾ˆå¤šï¼Œé˜Ÿåˆ—é‡Œé¢é™¤äº†ç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼Œå…¶ä»–çš„çº¿ç¨‹éƒ½ä¼šé˜»å¡ï¼Œcpuå”¤é†’é˜»å¡çº¿ç¨‹çš„å¼€é”€ä¼šå¾ˆå¤§ã€‚ éå…¬å¹³é”ï¼šå¤šä¸ªçº¿ç¨‹å»è·å–é”çš„æ—¶å€™ï¼Œä¼šç›´æ¥å»å°è¯•è·å–ï¼Œè·å–ä¸åˆ°ï¼Œå†å»è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œå¦‚æœèƒ½è·å–åˆ°ï¼Œå°±ç›´æ¥è·å–åˆ°é”ã€‚ ä¼˜ç‚¹ï¼šå¯ä»¥å‡å°‘CPUå”¤é†’çº¿ç¨‹çš„å¼€é”€ï¼Œæ•´ä½“çš„ååæ•ˆç‡ä¼šé«˜ç‚¹ï¼ŒCPUä¹Ÿä¸å¿…å–å”¤é†’æ‰€æœ‰çº¿ç¨‹ï¼Œä¼šå‡å°‘å”¤èµ·çº¿ç¨‹çš„æ•°é‡ã€‚ ç¼ºç‚¹ï¼šä½ ä»¬å¯èƒ½ä¹Ÿå‘ç°äº†ï¼Œè¿™æ ·å¯èƒ½å¯¼è‡´é˜Ÿåˆ—ä¸­é—´çš„çº¿ç¨‹ä¸€ç›´è·å–ä¸åˆ°é”æˆ–è€…é•¿æ—¶é—´è·å–ä¸åˆ°é”ï¼Œå¯¼è‡´é¥¿æ­»ã€‚ ä¼ªå…±äº« ä¸€ã€ä¼ªå…±äº«çš„å®šä¹‰ï¼š ç¼“å­˜ç³»ç»Ÿä¸­æ˜¯ä»¥ç¼“å­˜è¡Œï¼ˆcache lineï¼‰ä¸ºå•ä½å­˜å‚¨çš„ï¼Œå½“å¤šçº¿ç¨‹ä¿®æ”¹äº’ç›¸ç‹¬ç«‹çš„å˜é‡æ—¶ï¼Œå¦‚æœè¿™äº›å˜é‡å…±äº«åŒä¸€ä¸ªç¼“å­˜è¡Œï¼Œå°±ä¼šæ— æ„ä¸­å½±å“å½¼æ­¤çš„æ€§èƒ½ï¼Œè¿™å°±æ˜¯ä¼ªå…±äº«ã€‚ äºŒã€CPUç¼“å­˜æœºåˆ¶ CPU ç¼“å­˜ï¼ˆCache Memoryï¼‰æ˜¯ä½äº CPU ä¸å†…å­˜ä¹‹é—´çš„ä¸´æ—¶å­˜å‚¨å™¨ï¼Œå®ƒçš„å®¹é‡æ¯”å†…å­˜å°çš„å¤šä½†æ˜¯äº¤æ¢é€Ÿåº¦å´æ¯”å†…å­˜è¦å¿«å¾—å¤šã€‚ é«˜é€Ÿç¼“å­˜çš„å‡ºç°ä¸»è¦æ˜¯ä¸ºäº†è§£å†³ CPU è¿ç®—é€Ÿåº¦ä¸å†…å­˜è¯»å†™é€Ÿåº¦ä¸åŒ¹é…çš„çŸ›ç›¾ï¼Œå› ä¸º CPU è¿ç®—é€Ÿåº¦è¦æ¯”å†…å­˜è¯»å†™é€Ÿåº¦å¿«å¾ˆå¤šï¼Œè¿™æ ·ä¼šä½¿ CPU èŠ±è´¹å¾ˆé•¿æ—¶é—´ç­‰å¾…æ•°æ®åˆ°æ¥æˆ–æŠŠæ•°æ®å†™å…¥å†…å­˜ã€‚ åœ¨ç¼“å­˜ä¸­çš„æ•°æ®æ˜¯å†…å­˜ä¸­çš„ä¸€å°éƒ¨åˆ†ï¼Œä½†è¿™ä¸€å°éƒ¨åˆ†æ˜¯çŸ­æ—¶é—´å†… CPU å³å°†è®¿é—®çš„ï¼Œå½“ CPU è°ƒç”¨å¤§é‡æ•°æ®æ—¶ï¼Œå°±å¯é¿å¼€å†…å­˜ç›´æ¥ä»ç¼“å­˜ä¸­è°ƒç”¨ï¼Œä»è€ŒåŠ å¿«è¯»å–é€Ÿåº¦ã€‚ CPU å’Œä¸»å†…å­˜ä¹‹é—´æœ‰å¥½å‡ å±‚ç¼“å­˜ï¼Œå› ä¸ºå³ä½¿ç›´æ¥è®¿é—®ä¸»å†…å­˜ä¹Ÿæ˜¯éå¸¸æ…¢çš„ã€‚å¦‚æœä½ æ­£åœ¨å¤šæ¬¡å¯¹ä¸€å—æ•°æ®åšç›¸åŒçš„è¿ç®—ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œè¿ç®—çš„æ—¶å€™æŠŠå®ƒåŠ è½½åˆ°ç¦» CPU å¾ˆè¿‘çš„åœ°æ–¹å°±æœ‰æ„ä¹‰äº†ã€‚ æŒ‰ç…§æ•°æ®è¯»å–é¡ºåºå’Œä¸ CPU ç»“åˆçš„ç´§å¯†ç¨‹åº¦ï¼ŒCPU ç¼“å­˜å¯ä»¥åˆ†ä¸ºä¸€çº§ç¼“å­˜ï¼ŒäºŒçº§ç¼“å­˜ï¼Œéƒ¨åˆ†é«˜ç«¯ CPU è¿˜å…·æœ‰ä¸‰çº§ç¼“å­˜ã€‚æ¯ä¸€çº§ç¼“å­˜ä¸­æ‰€å‚¨å­˜çš„å…¨éƒ¨æ•°æ®éƒ½æ˜¯ä¸‹ä¸€çº§ç¼“å­˜çš„ä¸€éƒ¨åˆ†ï¼Œè¶Šé è¿‘ CPU çš„ç¼“å­˜è¶Šå¿«ä¹Ÿè¶Šå°ã€‚æ‰€ä»¥ L1 ç¼“å­˜å¾ˆå°ä½†å¾ˆå¿«(è¯‘æ³¨ï¼šL1 è¡¨ç¤ºä¸€çº§ç¼“å­˜)ï¼Œå¹¶ä¸”ç´§é ç€åœ¨ä½¿ç”¨å®ƒçš„ CPU å†…æ ¸ã€‚L2 å¤§ä¸€äº›ï¼Œä¹Ÿæ…¢ä¸€äº›ï¼Œå¹¶ä¸”ä»ç„¶åªèƒ½è¢«ä¸€ä¸ªå•ç‹¬çš„ CPU æ ¸ä½¿ç”¨ã€‚L3 åœ¨ç°ä»£å¤šæ ¸æœºå™¨ä¸­æ›´æ™®éï¼Œä»ç„¶æ›´å¤§ï¼Œæ›´æ…¢ï¼Œå¹¶ä¸”è¢«å•ä¸ªæ’æ§½ä¸Šçš„æ‰€æœ‰ CPU æ ¸å…±äº«ã€‚æœ€åï¼Œä½ æ‹¥æœ‰ä¸€å—ä¸»å­˜ï¼Œç”±å…¨éƒ¨æ’æ§½ä¸Šçš„æ‰€æœ‰ CPU æ ¸å…±äº«ã€‚æ‹¥æœ‰ä¸‰çº§ç¼“å­˜çš„çš„ CPUï¼Œåˆ°ä¸‰çº§ç¼“å­˜æ—¶èƒ½å¤Ÿè¾¾åˆ° 95% çš„å‘½ä¸­ç‡ï¼Œåªæœ‰ä¸åˆ° 5% çš„æ•°æ®éœ€è¦ä»å†…å­˜ä¸­æŸ¥è¯¢ã€‚ å¤šæ ¸æœºå™¨çš„å­˜å‚¨ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å½“ CPU æ‰§è¡Œè¿ç®—çš„æ—¶å€™ï¼Œå®ƒå…ˆå» L1 æŸ¥æ‰¾æ‰€éœ€çš„æ•°æ®ï¼Œå†å» L2ï¼Œç„¶åæ˜¯ L3ï¼Œæœ€åå¦‚æœè¿™äº›ç¼“å­˜ä¸­éƒ½æ²¡æœ‰ï¼Œæ‰€éœ€çš„æ•°æ®å°±è¦å»ä¸»å†…å­˜æ‹¿ã€‚èµ°å¾—è¶Šè¿œï¼Œè¿ç®—è€—è´¹çš„æ—¶é—´å°±è¶Šé•¿ã€‚æ‰€ä»¥å¦‚æœä½ åœ¨åšä¸€äº›å¾ˆé¢‘ç¹çš„äº‹ï¼Œä½ è¦ç¡®ä¿æ•°æ®åœ¨ L1 ç¼“å­˜ä¸­ã€‚ Martin Thompson ç»™å‡ºäº†ä¸€äº›ç¼“å­˜æœªå‘½ä¸­çš„æ¶ˆè€—æ•°æ®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š ä¸‰ã€ç¼“å­˜è¡Œ ç¼“å­˜ç³»ç»Ÿä¸­æ˜¯ä»¥ç¼“å­˜è¡Œï¼ˆcache lineï¼‰ä¸ºå•ä½å­˜å‚¨çš„ã€‚ç¼“å­˜è¡Œé€šå¸¸æ˜¯ 64 å­—èŠ‚ï¼ˆè¯‘æ³¨ï¼šæœ¬æ–‡åŸºäº 64 å­—èŠ‚ï¼Œå…¶ä»–é•¿åº¦çš„å¦‚ 32 å­—èŠ‚ç­‰ä¸é€‚æœ¬æ–‡è®¨è®ºçš„é‡ç‚¹ï¼‰ï¼Œå¹¶ä¸”å®ƒæœ‰æ•ˆåœ°å¼•ç”¨ä¸»å†…å­˜ä¸­çš„ä¸€å—åœ°å€ã€‚ä¾‹å¦‚ä¸€ä¸ª çš„ long ç±»å‹æ˜¯ 8 å­—èŠ‚ï¼Œå› æ­¤åœ¨ä¸€ä¸ªç¼“å­˜è¡Œä¸­å¯ä»¥å­˜ 8 ä¸ª long ç±»å‹çš„å˜é‡ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ è®¿é—®ä¸€ä¸ª long æ•°ç»„ï¼Œå½“æ•°ç»„ä¸­çš„ä¸€ä¸ªå€¼è¢«åŠ è½½åˆ°ç¼“å­˜ä¸­ï¼Œå®ƒä¼šé¢å¤–åŠ è½½å¦å¤– 7 ä¸ªï¼Œä»¥è‡´ä½ èƒ½éå¸¸å¿«åœ°éå†è¿™ä¸ªæ•°ç»„ã€‚äº‹å®ä¸Šï¼Œä½ å¯ä»¥éå¸¸å¿«é€Ÿçš„éå†åœ¨è¿ç»­çš„å†…å­˜å—ä¸­åˆ†é…çš„ä»»æ„æ•°æ®ç»“æ„ã€‚è€Œå¦‚æœä½ åœ¨æ•°æ®ç»“æ„ä¸­çš„é¡¹åœ¨å†…å­˜ä¸­ä¸æ˜¯å½¼æ­¤ç›¸é‚»çš„ï¼ˆå¦‚é“¾è¡¨ï¼‰ï¼Œä½ å°†å¾—ä¸åˆ°å…è´¹ç¼“å­˜åŠ è½½æ‰€å¸¦æ¥çš„ä¼˜åŠ¿ï¼Œå¹¶ä¸”åœ¨è¿™äº›æ•°æ®ç»“æ„ä¸­çš„æ¯ä¸€ä¸ªé¡¹éƒ½å¯èƒ½ä¼šå‡ºç°ç¼“å­˜æœªå‘½ä¸­ã€‚ å¦‚æœå­˜åœ¨è¿™æ ·çš„åœºæ™¯ï¼Œæœ‰å¤šä¸ªçº¿ç¨‹æ“ä½œä¸åŒçš„æˆå‘˜å˜é‡ï¼Œä½†æ˜¯ç›¸åŒçš„ç¼“å­˜è¡Œï¼Œè¿™ä¸ªæ—¶å€™ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿã€‚æ²¡é”™ï¼Œä¼ªå…±äº«ï¼ˆFalse Sharingï¼‰é—®é¢˜å°±å‘ç”Ÿäº†ï¼æœ‰å¼  Disruptor é¡¹ç›®çš„ç»å…¸ç¤ºä¾‹å›¾ï¼Œå¦‚ä¸‹ï¼š ä¸Šå›¾ä¸­ï¼Œä¸€ä¸ªè¿è¡Œåœ¨å¤„ç†å™¨ core1ä¸Šçš„çº¿ç¨‹æƒ³è¦æ›´æ–°å˜é‡ X çš„å€¼ï¼ŒåŒæ—¶å¦å¤–ä¸€ä¸ªè¿è¡Œåœ¨å¤„ç†å™¨ core2 ä¸Šçš„çº¿ç¨‹æƒ³è¦æ›´æ–°å˜é‡ Y çš„å€¼ã€‚ä½†æ˜¯ï¼Œè¿™ä¸¤ä¸ªé¢‘ç¹æ”¹åŠ¨çš„å˜é‡éƒ½å¤„äºåŒä¸€æ¡ç¼“å­˜è¡Œã€‚ä¸¤ä¸ªçº¿ç¨‹å°±ä¼šè½®ç•ªå‘é€ RFO æ¶ˆæ¯ï¼Œå å¾—æ­¤ç¼“å­˜è¡Œçš„æ‹¥æœ‰æƒã€‚å½“ core1 å–å¾—äº†æ‹¥æœ‰æƒå¼€å§‹æ›´æ–° Xï¼Œåˆ™ core2 å¯¹åº”çš„ç¼“å­˜è¡Œéœ€è¦è®¾ä¸º I çŠ¶æ€ã€‚å½“ core2 å–å¾—äº†æ‹¥æœ‰æƒå¼€å§‹æ›´æ–° Yï¼Œåˆ™ core1 å¯¹åº”çš„ç¼“å­˜è¡Œéœ€è¦è®¾ä¸º I çŠ¶æ€(å¤±æ•ˆæ€)ã€‚è½®ç•ªå¤ºå–æ‹¥æœ‰æƒä¸ä½†å¸¦æ¥å¤§é‡çš„ RFO æ¶ˆæ¯ï¼Œè€Œä¸”å¦‚æœæŸä¸ªçº¿ç¨‹éœ€è¦è¯»æ­¤è¡Œæ•°æ®æ—¶ï¼ŒL1 å’Œ L2 ç¼“å­˜ä¸Šéƒ½æ˜¯å¤±æ•ˆæ•°æ®ï¼Œåªæœ‰ L3 ç¼“å­˜ä¸Šæ˜¯åŒæ­¥å¥½çš„æ•°æ®ã€‚ä»å‰ä¸€ç¯‡æˆ‘ä»¬çŸ¥é“ï¼Œè¯» L3 çš„æ•°æ®éå¸¸å½±å“æ€§èƒ½ã€‚æ›´åçš„æƒ…å†µæ˜¯è·¨æ§½è¯»å–ï¼ŒL3 éƒ½è¦ missï¼Œåªèƒ½ä»å†…å­˜ä¸ŠåŠ è½½ã€‚ è¡¨é¢ä¸Š X å’Œ Y éƒ½æ˜¯è¢«ç‹¬ç«‹çº¿ç¨‹æ“ä½œçš„ï¼Œè€Œä¸”ä¸¤æ“ä½œä¹‹é—´ä¹Ÿæ²¡æœ‰ä»»ä½•å…³ç³»ã€‚åªä¸è¿‡å®ƒä»¬å…±äº«äº†ä¸€ä¸ªç¼“å­˜è¡Œï¼Œä½†æ‰€æœ‰ç«äº‰å†²çªéƒ½æ˜¯æ¥æºäºå…±äº«ã€‚ å› æ­¤ï¼Œå½“ä¸¤ä¸ªä»¥ä¸ŠCPUéƒ½è¦è®¿é—®åŒä¸€ä¸ªç¼“å­˜è¡Œå¤§å°çš„å†…å­˜åŒºåŸŸæ—¶ï¼Œå°±ä¼šå¼•èµ·å†²çªï¼Œè¿™ç§æƒ…å†µå°±å«â€œå…±äº«â€ã€‚ä½†æ˜¯ï¼Œè¿™ç§æƒ…å†µé‡Œé¢åˆåŒ…å«äº†â€œå…¶å®ä¸æ˜¯å…±äº«â€çš„â€œä¼ªå…±äº«â€æƒ…å†µã€‚æ¯”å¦‚ï¼Œä¸¤ä¸ªå¤„ç†å™¨å„è¦è®¿é—®ä¸€ä¸ªwordï¼Œè¿™ä¸¤ä¸ªwordå´å­˜åœ¨äºåŒä¸€ä¸ªcache lineå¤§å°çš„åŒºåŸŸé‡Œï¼Œè¿™æ—¶ï¼Œä»åº”ç”¨é€»è¾‘å±‚é¢è¯´ï¼Œè¿™ä¸¤ä¸ªå¤„ç†å™¨å¹¶æ²¡æœ‰å…±äº«å†…å­˜ï¼Œå› ä¸ºä»–ä»¬è®¿é—®çš„æ˜¯ä¸åŒçš„å†…å®¹ï¼ˆä¸åŒçš„wordï¼‰ã€‚ä½†æ˜¯å› ä¸ºcache lineçš„å­˜åœ¨å’Œé™åˆ¶ï¼Œè¿™ä¸¤ä¸ªCPUè¦è®¿é—®è¿™ä¸¤ä¸ªä¸åŒçš„wordæ—¶ï¼Œå´ä¸€å®šè¦è®¿é—®åŒä¸€ä¸ªcache lineå—ï¼Œäº§ç”Ÿäº†äº‹å®ä¸Šçš„â€œå…±äº«â€ã€‚æ˜¾ç„¶ï¼Œç”±äºcache lineå¤§å°é™åˆ¶å¸¦æ¥çš„è¿™ç§â€œä¼ªå…±äº«â€æ˜¯æˆ‘ä»¬ä¸æƒ³è¦çš„ï¼Œä¼šæµªè´¹ç³»ç»Ÿèµ„æºã€‚ å››ã€å¦‚ä½•é¿å…ä¼ªå…±äº«ï¼Ÿ 1ï¼‰è®©ä¸åŒçº¿ç¨‹æ“ä½œçš„å¯¹è±¡å¤„äºä¸åŒçš„ç¼“å­˜è¡Œã€‚ å¯ä»¥è¿›è¡Œç¼“å­˜è¡Œå¡«å……ï¼ˆPaddingï¼‰ ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€æ¡ç¼“å­˜è¡Œæœ‰ 64 å­—èŠ‚ï¼Œè€Œ Java ç¨‹åºçš„å¯¹è±¡å¤´å›ºå®šå  8 å­—èŠ‚(32ä½ç³»ç»Ÿ)æˆ– 12 å­—èŠ‚( 64 ä½ç³»ç»Ÿé»˜è®¤å¼€å¯å‹ç¼©, ä¸å¼€å‹ç¼©ä¸º 16 å­—èŠ‚)ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å¡« 6 ä¸ªæ— ç”¨çš„é•¿æ•´å‹è¡¥ä¸Š6*8=48å­—èŠ‚ï¼Œè®©ä¸åŒçš„ VolatileLong å¯¹è±¡å¤„äºä¸åŒçš„ç¼“å­˜è¡Œï¼Œå°±é¿å…äº†ä¼ªå…±äº«( 64 ä½ç³»ç»Ÿè¶…è¿‡ç¼“å­˜è¡Œçš„ 64 å­—èŠ‚ä¹Ÿæ— æ‰€è°“ï¼Œåªè¦ä¿è¯ä¸åŒçº¿ç¨‹ä¸æ“ä½œåŒä¸€ç¼“å­˜è¡Œå°±å¯ä»¥)ã€‚ 2ï¼‰ä½¿ç”¨ç¼–è¯‘æŒ‡ç¤ºï¼Œå¼ºåˆ¶ä½¿æ¯ä¸€ä¸ªå˜é‡å¯¹é½ã€‚ å¼ºåˆ¶ä½¿å¯¹è±¡æŒ‰ç…§ç¼“å­˜è¡Œçš„è¾¹ç•Œå¯¹é½ã€‚ä¾‹å¦‚å¯ä»¥ä½¿æ•°æ®æŒ‰64ä½å¯¹é½ï¼Œé‚£ä¹ˆä¸€ä¸ªç¼“å­˜è¡Œåªæœ‰ä¸€ä¸ªå¯æ“ä½œå¯¹è±¡ï¼Œè¿™æ ·å‘ç”Ÿä¼ªå…±äº«ä¹‹åï¼Œä¹Ÿåªæ˜¯å¯¹åº”ç¼“å­˜è¡Œçš„æ•°æ®å˜åŒ–ï¼Œå¹¶ä¸å½±å“å…¶ä»–çš„å¯¹è±¡ã€‚ æ— é”é˜Ÿåˆ— import java.util.concurrent.atomic.AtomicInteger; import java.util.concurrent.atomic.AtomicReferenceArray; /** * ç”¨æ•°ç»„å®ç°æ— é”æœ‰ç•Œé˜Ÿåˆ— */ public class LockFreeQueue { private AtomicReferenceArray atomicReferenceArray; //ä»£è¡¨ä¸ºç©ºï¼Œæ²¡æœ‰å…ƒç´  private static final Integer EMPTY = null; //å¤´æŒ‡é’ˆ,å°¾æŒ‡é’ˆ AtomicInteger head,tail; public LockFreeQueue(int size){ atomicReferenceArray = new AtomicReferenceArray(new Integer[size + 1]); head = new AtomicInteger(0); tail = new AtomicInteger(0); } /** * å…¥é˜Ÿ * @param element * @return */ public boolean add(Integer element){ int index = (tail.get() + 1) % atomicReferenceArray.length(); if( index == head.get() % atomicReferenceArray.length()){ System.out.println(&quot;å½“å‰é˜Ÿåˆ—å·²æ»¡,&quot;+ element+&quot;æ— æ³•å…¥é˜Ÿ!&quot;); return false; } while(!atomicReferenceArray.compareAndSet(index,EMPTY,element)){ return add(element); } tail.incrementAndGet(); //ç§»åŠ¨å°¾æŒ‡é’ˆ System.out.println(&quot;å…¥é˜ŸæˆåŠŸ!&quot; + element); return true; } /** * å‡ºé˜Ÿ * @return */ public Integer poll(){ if(head.get() == tail.get()){ System.out.println(&quot;å½“å‰é˜Ÿåˆ—ä¸ºç©º&quot;); return null; } int index = (head.get() + 1) % atomicReferenceArray.length(); Integer ele = (Integer) atomicReferenceArray.get(index); if(ele == null){ //æœ‰å¯èƒ½å…¶å®ƒçº¿ç¨‹ä¹Ÿåœ¨å‡ºé˜Ÿ return poll(); } while(!atomicReferenceArray.compareAndSet(index,ele,EMPTY)){ return poll(); } head.incrementAndGet(); System.out.println(&quot;å‡ºé˜ŸæˆåŠŸ!&quot; + ele); return ele; } public void print(){ StringBuffer buffer = new StringBuffer(&quot;[&quot;); for(int i = 0; i &lt; atomicReferenceArray.length() ; i++){ if(i == head.get() || atomicReferenceArray.get(i) == null){ continue; } buffer.append(atomicReferenceArray.get(i) + &quot;,&quot;); } buffer.deleteCharAt(buffer.length() - 1); buffer.append(&quot;]&quot;); System.out.println(&quot;é˜Ÿåˆ—å†…å®¹:&quot; +buffer.toString()); } } æ­»é” å½“çº¿ç¨‹ A æŒæœ‰ç‹¬å é”aï¼Œå¹¶å°è¯•å»è·å–ç‹¬å é” b çš„åŒæ—¶ï¼Œçº¿ç¨‹ B æŒæœ‰ç‹¬å é” bï¼Œå¹¶å°è¯•è·å–ç‹¬å é” a çš„æƒ…å†µä¸‹ï¼Œå°±ä¼šå‘ç”Ÿ AB ä¸¤ä¸ªçº¿ç¨‹ç”±äºäº’ç›¸æŒæœ‰å¯¹æ–¹éœ€è¦çš„é”ï¼Œè€Œå‘ç”Ÿçš„é˜»å¡ç°è±¡ï¼Œæˆ‘ä»¬ç§°ä¸ºæ­»é”ã€‚ 1. äº§ç”Ÿæ­»é”çš„æ¡ä»¶å’Œé˜²æ­¢æ­»é” äº’æ–¥ è¯·æ±‚ä¸ä¿æŒ ä¸å¯å‰¥å¤º å¾ªç¯ç­‰å¾… äº§ç”Ÿæ­»é”çš„å¿…è¦æ¡ä»¶ï¼š äº’æ–¥æ¡ä»¶ï¼šæ‰€è°“äº’æ–¥å°±æ˜¯è¿›ç¨‹åœ¨æŸä¸€æ—¶é—´å†…ç‹¬å èµ„æºã€‚ è¯·æ±‚ä¸ä¿æŒæ¡ä»¶ï¼šä¸€ä¸ªè¿›ç¨‹å› è¯·æ±‚èµ„æºè€Œé˜»å¡æ—¶ï¼Œå¯¹å·²è·å¾—çš„èµ„æºä¿æŒä¸æ”¾ã€‚ ä¸å¯å‰¥å¤ºæ¡ä»¶ï¼šè¿›ç¨‹å·²è·å¾—èµ„æºï¼Œåœ¨æœ«ä½¿ç”¨å®Œä¹‹å‰ï¼Œä¸èƒ½å¼ºè¡Œå‰¥å¤ºã€‚ å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼šè‹¥å¹²è¿›ç¨‹ä¹‹é—´å½¢æˆä¸€ç§å¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºå…³ç³»ã€‚ è¿™å››ä¸ªæ¡ä»¶æ˜¯æ­»é”çš„å¿…è¦æ¡ä»¶ï¼Œåªè¦ç³»ç»Ÿå‘ç”Ÿæ­»é”ï¼Œè¿™äº›æ¡ä»¶å¿…ç„¶æˆç«‹ï¼Œè€Œåªè¦ä¸Šè¿°æ¡ä»¶ä¹‹ ä¸€ä¸æ»¡è¶³ï¼Œå°±ä¸ä¼šå‘ç”Ÿæ­»é”ã€‚ ç†è§£äº†æ­»é”çš„åŸå› ï¼Œå°¤å…¶æ˜¯äº§ç”Ÿæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼Œå°±å¯ä»¥æœ€å¤§å¯èƒ½åœ°é¿å…ã€é¢„é˜²å’Œ è§£é™¤æ­»é”ã€‚ é˜²æ­¢æ­»é”å¯ä»¥é‡‡ç”¨ä»¥ä¸‹çš„æ–¹æ³•ï¼š å°½é‡ä½¿ç”¨ tryLock(long timeout, TimeUnit unit)çš„æ–¹æ³•(ReentrantLockã€ReentrantReadWriteLock)ï¼Œè®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶å¯ä»¥é€€å‡ºé˜²æ­¢æ­»é”ã€‚ å°½é‡ä½¿ç”¨ Java. util. concurrent å¹¶å‘ç±»ä»£æ›¿è‡ªå·±æ‰‹å†™é”ã€‚ å°½é‡é™ä½é”çš„ä½¿ç”¨ç²’åº¦ï¼Œå°½é‡ä¸è¦å‡ ä¸ªåŠŸèƒ½ç”¨åŒä¸€æŠŠé”ã€‚ å°½é‡å‡å°‘åŒæ­¥çš„ä»£ç å—ã€‚ import lombok.SneakyThrows; import java.util.concurrent.TimeUnit; class HoldLockThread implements Runnable{ private String lockOne; private String lockTwo; public HoldLockThread(String lockOne, String lockTwo) { this.lockOne = lockOne; this.lockTwo = lockTwo; } @Override @SneakyThrows public void run(){ synchronized (lockOne){ System.out.println(Thread.currentThread().getName()+&quot;è‡ªå·±è·å–&quot;+lockOne+&quot;å°è¯•è·å–&quot;+lockTwo); TimeUnit.SECONDS.sleep(2L); synchronized (lockTwo){ System.out.println(Thread.currentThread().getName()+&quot;è‡ªå·±è·å–&quot;+lockTwo+&quot;å°è¯•è·å–&quot;+lockOne); } } } } public class DeadLockDemo { public static void main(String[] args) { String lockA=&quot;lockA&quot;; String lockB=&quot;lockB&quot;; new Thread(new HoldLockThread(lockA,lockB),&quot;ThreadAAA&quot;).start(); new Thread(new HoldLockThread(lockB,lockA),&quot;ThreadBBB&quot;).start(); } } 2. æ­»é”ä¸æ´»é”ä¸é¥¥é¥¿çš„åŒºåˆ« æ­»é”ï¼šæ˜¯æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹ï¼ˆæˆ–çº¿ç¨‹ï¼‰åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå› äº‰å¤ºèµ„æºè€Œé€ æˆçš„ä¸€ç§äº’ç›¸ç­‰å¾…çš„ç°è±¡ï¼Œè‹¥æ— å¤–åŠ›ä½œç”¨ï¼Œå®ƒä»¬éƒ½å°†æ— æ³•æ¨è¿›ä¸‹å»ã€‚ æ´»é”ï¼šä»»åŠ¡æˆ–è€…æ‰§è¡Œè€…æ²¡æœ‰è¢«é˜»å¡ï¼Œç”±äºæŸäº›æ¡ä»¶æ²¡æœ‰æ»¡è¶³ï¼Œå¯¼è‡´ä¸€ç›´é‡å¤å°è¯•ï¼Œå¤±è´¥ï¼Œå°è¯•ï¼Œå¤±è´¥ã€‚ æ´»é”å’Œæ­»é”çš„åŒºåˆ«åœ¨äºï¼Œå¤„äºæ´»é”çš„å®ä½“æ˜¯åœ¨ä¸æ–­çš„æ”¹å˜çŠ¶æ€ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„â€œæ´»â€ï¼Œ è€Œå¤„äºæ­»é”çš„å®ä½“è¡¨ç°ä¸ºç­‰å¾…ï¼›æ´»é”æœ‰å¯èƒ½è‡ªè¡Œè§£å¼€ï¼Œæ­»é”åˆ™ä¸èƒ½ã€‚ é¥¥é¥¿ï¼šä¸€ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹å› ä¸ºç§ç§åŸå› æ— æ³•è·å¾—æ‰€éœ€è¦çš„èµ„æºï¼Œå¯¼è‡´ä¸€ç›´æ— æ³•æ‰§è¡Œçš„çŠ¶æ€ã€‚ Java ä¸­å¯¼è‡´é¥¥é¥¿çš„åŸå› ï¼š 1ã€é«˜ä¼˜å…ˆçº§çº¿ç¨‹åå™¬æ‰€æœ‰çš„ä½ä¼˜å…ˆçº§çº¿ç¨‹çš„ CPU æ—¶é—´ã€‚ 2ã€çº¿ç¨‹è¢«æ°¸ä¹…å µå¡åœ¨ä¸€ä¸ªç­‰å¾…è¿›å…¥åŒæ­¥å—çš„çŠ¶æ€ï¼Œå› ä¸ºå…¶ä»–çº¿ç¨‹æ€»æ˜¯èƒ½åœ¨å®ƒä¹‹å‰æŒç»­åœ°å¯¹è¯¥åŒæ­¥å—è¿›è¡Œè®¿é—®ã€‚ 3ã€çº¿ç¨‹åœ¨ç­‰å¾…ä¸€ä¸ªæœ¬èº«ä¹Ÿå¤„äºæ°¸ä¹…ç­‰å¾…å®Œæˆçš„å¯¹è±¡(æ¯”å¦‚è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„ wait æ–¹æ³•)ï¼Œå› ä¸ºå…¶ä»–çº¿ç¨‹æ€»æ˜¯è¢«æŒç»­åœ°è·å¾—å”¤é†’ã€‚ ReentrantLock(é‡å…¥é”) ReentrantLocké‡å…¥é”ï¼Œæ˜¯å®ç°Lockæ¥å£çš„ä¸€ä¸ªç±»ï¼Œä¹Ÿæ˜¯åœ¨å®é™…ç¼–ç¨‹ä¸­ä½¿ç”¨é¢‘ç‡å¾ˆé«˜çš„ä¸€ä¸ªé”ï¼Œæ”¯æŒé‡å…¥æ€§ï¼Œè¡¨ç¤ºèƒ½å¤Ÿå¯¹å…±äº«èµ„æºèƒ½å¤Ÿé‡å¤åŠ é”ï¼Œå³å½“å‰çº¿ç¨‹è·å–è¯¥é”å†æ¬¡è·å–ä¸ä¼šè¢«é˜»å¡ã€‚ åœ¨javaå…³é”®å­—synchronizedéšå¼æ”¯æŒé‡å…¥æ€§ï¼Œsynchronizedé€šè¿‡è·å–è‡ªå¢ï¼Œé‡Šæ”¾è‡ªå‡çš„æ–¹å¼å®ç°é‡å…¥ã€‚ä¸æ­¤åŒæ—¶ï¼ŒReentrantLockè¿˜æ”¯æŒå…¬å¹³é”å’Œéå…¬å¹³é”ä¸¤ç§æ–¹å¼ã€‚é‚£ä¹ˆï¼Œè¦æƒ³å®Œå®Œå…¨å…¨çš„å¼„æ‡‚ReentrantLockçš„è¯ï¼Œä¸»è¦ä¹Ÿå°±æ˜¯ReentrantLockåŒæ­¥è¯­ä¹‰çš„å­¦ä¹ ï¼š é‡å…¥æ€§çš„å®ç°åŸç†ï¼› å…¬å¹³é”å’Œéå…¬å¹³é” 1. é‡å…¥æ€§çš„å®ç°åŸç† è¦æƒ³æ”¯æŒé‡å…¥æ€§ï¼Œå°±è¦è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š 1. åœ¨çº¿ç¨‹è·å–é”çš„æ—¶å€™ï¼Œå¦‚æœå·²ç»è·å–é”çš„çº¿ç¨‹æ˜¯å½“å‰çº¿ç¨‹çš„è¯åˆ™ç›´æ¥å†æ¬¡è·å–æˆåŠŸï¼› 2. ç”±äºé”ä¼šè¢«è·å–næ¬¡ï¼Œé‚£ä¹ˆåªæœ‰é”åœ¨è¢«é‡Šæ”¾åŒæ ·çš„næ¬¡ä¹‹åï¼Œè¯¥é”æ‰ç®—æ˜¯å®Œå…¨é‡Šæ”¾æˆåŠŸã€‚ ReentrantLockæ”¯æŒä¸¤ç§é”ï¼šå…¬å¹³é”å’Œéå…¬å¹³é”ã€‚ä½•è°“å…¬å¹³æ€§ï¼Œæ˜¯é’ˆå¯¹è·å–é”è€Œè¨€çš„ï¼Œå¦‚æœä¸€ä¸ªé”æ˜¯å…¬å¹³çš„ï¼Œé‚£ä¹ˆé”çš„è·å–é¡ºåºå°±åº”è¯¥ç¬¦åˆè¯·æ±‚ä¸Šçš„ç»å¯¹æ—¶é—´é¡ºåºï¼Œæ»¡è¶³FIFOã€‚ 2. ReentrantLockä½¿ç”¨ class Bank{ /** * volatileå®ç° */ private int count=0; /** * ä½¿ç”¨å¯é‡å…¥é” */ private Lock lock=new ReentrantLock(); public void getCount(){ System.out.println(&quot;è´¦æˆ·ä½™é¢ä¸ºï¼š&quot;+count); } /** * åŒæ­¥æ–¹æ³•å®ç°å­˜é’± * @param money */ public void save(int money){ lock.lock(); try { count+=money; System.out.println(System.currentTimeMillis()+&quot;å­˜è¿›ï¼š&quot;+money); } catch (Exception e) { // TODO Auto-generated catch block e.printStackTrace(); }finally { lock.unlock();//é‡Šæ”¾é” } } /** * åŒæ­¥ä»£ç å—å®ç°å–é’± * @param money */ public void remove(int money){ if (count-money&lt;0) { System.err.println(&quot;ä½™é¢ä¸è¶³ã€‚&quot;); return; } lock.lock(); try { count-=money; System.err.println(System.currentTimeMillis()+&quot;å–å‡ºï¼š&quot;+money); } catch (Exception e) { // TODO Auto-generated catch block e.printStackTrace(); }finally { lock.unlock(); } } } è¯»å†™é”ReentrantReadWriteLock é¦–å…ˆæ˜ç¡®ä¸€ä¸‹ï¼Œä¸æ˜¯è¯´ ReentrantLock ä¸å¥½ï¼Œåªæ˜¯ ReentrantLock æŸäº›æ—¶å€™æœ‰å±€é™ã€‚å¦‚æœä½¿ç”¨ ReentrantLockï¼Œå¯èƒ½æœ¬èº«æ˜¯ä¸ºäº†é˜²æ­¢çº¿ç¨‹ A åœ¨å†™æ•°æ®ã€çº¿ç¨‹ B åœ¨è¯»æ•°æ®é€ æˆçš„æ•°æ®ä¸ä¸€è‡´ï¼Œä½†è¿™æ ·ï¼Œå¦‚æœçº¿ç¨‹ C åœ¨è¯»æ•°æ®ã€çº¿ç¨‹ D ä¹Ÿåœ¨è¯»æ•°æ®ï¼Œè¯»æ•°æ®æ˜¯ä¸ä¼šæ”¹å˜æ•°æ®çš„ï¼Œæ²¡æœ‰å¿…è¦åŠ é”ï¼Œä½†æ˜¯è¿˜æ˜¯åŠ é”äº†ï¼Œé™ä½äº†ç¨‹åºçš„æ€§èƒ½ã€‚å› ä¸ºè¿™ä¸ªï¼Œæ‰è¯ç”Ÿäº†è¯»å†™é” ReadWriteLockã€‚ ReadWriteLock æ˜¯ä¸€ä¸ªè¯»å†™é”æ¥å£ï¼Œè¯»å†™é”æ˜¯ç”¨æ¥æå‡å¹¶å‘ç¨‹åºæ€§èƒ½çš„é”åˆ†ç¦»æŠ€æœ¯ï¼ŒReentrantReadWriteLock æ˜¯ ReadWriteLock æ¥å£çš„ä¸€ä¸ªå…·ä½“å®ç°ï¼Œå®ç°äº†è¯»å†™çš„åˆ†ç¦»ï¼Œè¯»é”æ˜¯å…±äº«çš„ï¼Œå†™é”æ˜¯ç‹¬å çš„ï¼Œè¯»å’Œè¯»ä¹‹é—´ä¸ä¼šäº’æ–¥ï¼Œè¯»å’Œå†™ã€å†™å’Œè¯»ã€å†™å’Œå†™ä¹‹é—´æ‰ä¼šäº’æ–¥ï¼Œæå‡äº†è¯»å†™çš„æ€§èƒ½ã€‚ è€Œè¯»å†™é”æœ‰ä»¥ä¸‹ä¸‰ä¸ªé‡è¦çš„ç‰¹æ€§ï¼š ï¼ˆ1ï¼‰å…¬å¹³é€‰æ‹©æ€§ï¼šæ”¯æŒéå…¬å¹³ï¼ˆé»˜è®¤ï¼‰å’Œå…¬å¹³çš„é”è·å–æ–¹å¼ï¼Œååé‡è¿˜æ˜¯éå…¬å¹³ä¼˜äºå…¬å¹³ã€‚ ï¼ˆ2ï¼‰é‡è¿›å…¥ï¼šè¯»é”å’Œå†™é”éƒ½æ”¯æŒçº¿ç¨‹é‡è¿›å…¥ã€‚ å¹¶å‘å®¹å™¨ 1. ConcurrentHashMap ConcurrentHashMapæ˜¯Javaä¸­çš„ä¸€ä¸ªçº¿ç¨‹å®‰å…¨ä¸”é«˜æ•ˆçš„HashMapå®ç°ã€‚å¹³æ—¶æ¶‰åŠé«˜å¹¶å‘å¦‚æœè¦ç”¨mapç»“æ„ï¼Œé‚£ç¬¬ä¸€æ—¶é—´æƒ³åˆ°çš„å°±æ˜¯å®ƒã€‚ç›¸å¯¹äºhashmapæ¥è¯´ï¼ŒConcurrentHashMapå°±æ˜¯çº¿ç¨‹å®‰å…¨çš„mapï¼Œå…¶ä¸­åˆ©ç”¨äº†é”åˆ†æ®µçš„æ€æƒ³æé«˜äº†å¹¶å‘åº¦ã€‚ é‚£ä¹ˆå®ƒåˆ°åº•æ˜¯å¦‚ä½•å®ç°çº¿ç¨‹å®‰å…¨çš„ï¼Ÿ JDK 1.6ç‰ˆæœ¬å…³é”®è¦ç´ ï¼š segmentç»§æ‰¿äº†ReentrantLockå……å½“é”çš„è§’è‰²ï¼Œä¸ºæ¯ä¸€ä¸ªsegmentæä¾›äº†çº¿ç¨‹å®‰å…¨çš„ä¿éšœï¼› segmentç»´æŠ¤äº†å“ˆå¸Œæ•£åˆ—è¡¨çš„è‹¥å¹²ä¸ªæ¡¶ï¼Œæ¯ä¸ªæ¡¶ç”±HashEntryæ„æˆçš„é“¾è¡¨ã€‚ JDK1.8åï¼ŒConcurrentHashMapæŠ›å¼ƒäº†åŸæœ‰çš„Segment åˆ†æ®µé”ï¼Œè€Œé‡‡ç”¨äº† CAS + synchronized æ¥ä¿è¯å¹¶å‘å®‰å…¨æ€§ã€‚ 1.1 ConcurrentHashMap çš„å¹¶å‘åº¦ ConcurrentHashMap æŠŠå®é™… map åˆ’åˆ†æˆè‹¥å¹²éƒ¨åˆ†æ¥å®ç°å®ƒçš„å¯æ‰©å±•æ€§å’Œçº¿ç¨‹å®‰å…¨ã€‚è¿™ç§åˆ’åˆ†æ˜¯ä½¿ç”¨å¹¶å‘åº¦è·å¾—çš„ï¼Œå®ƒæ˜¯ ConcurrentHashMap ç±»æ„é€ å‡½æ•°çš„ä¸€ä¸ªå¯é€‰å‚æ•°ï¼Œé»˜è®¤å€¼ä¸º 16ï¼Œè¿™æ ·åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹å°±èƒ½é¿å…äº‰ç”¨ã€‚ åœ¨ JDK8 åï¼Œå®ƒæ‘’å¼ƒäº† Segmentï¼ˆé”æ®µï¼‰çš„æ¦‚å¿µï¼Œè€Œæ˜¯å¯ç”¨äº†ä¸€ç§å…¨æ–°çš„æ–¹å¼å®ç°,åˆ©ç”¨ CAS ç®—æ³•ã€‚åŒæ—¶åŠ å…¥äº†æ›´å¤šçš„è¾…åŠ©å˜é‡æ¥æé«˜å¹¶å‘åº¦ï¼Œ 1.2 å¹¶å‘å®¹å™¨çš„å®ç° ä½•ä¸ºåŒæ­¥å®¹å™¨ï¼šå¯ä»¥ç®€å•åœ°ç†è§£ä¸ºé€šè¿‡ synchronized æ¥å®ç°åŒæ­¥çš„å®¹å™¨ï¼Œå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹è°ƒç”¨åŒæ­¥å®¹å™¨çš„æ–¹æ³•ï¼Œå®ƒä»¬å°†ä¼šä¸²è¡Œæ‰§è¡Œã€‚æ¯”å¦‚ Vectorï¼ŒHashtableï¼Œä»¥åŠ Collections.synchronizedSetï¼ŒsynchronizedList ç­‰æ–¹æ³•è¿”å›çš„å®¹å™¨ã€‚å¯ä»¥é€šè¿‡æŸ¥çœ‹ Vectorï¼ŒHashtable ç­‰è¿™äº›åŒæ­¥å®¹å™¨çš„å®ç°ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°è¿™äº›å®¹å™¨å®ç°çº¿ç¨‹å®‰å…¨çš„æ–¹å¼å°±æ˜¯å°†å®ƒä»¬çš„çŠ¶æ€å°è£…èµ·æ¥ï¼Œå¹¶åœ¨éœ€è¦åŒæ­¥çš„æ–¹æ³•ä¸ŠåŠ ä¸Šå…³é”®å­— synchronizedã€‚ å¹¶å‘å®¹å™¨ä½¿ç”¨äº†ä¸åŒæ­¥å®¹å™¨å®Œå…¨ä¸åŒçš„åŠ é”ç­–ç•¥æ¥æä¾›æ›´é«˜çš„å¹¶å‘æ€§å’Œä¼¸ç¼©æ€§ï¼Œä¾‹å¦‚åœ¨ ConcurrentHashMap ä¸­é‡‡ç”¨äº†ä¸€ç§ç²’åº¦æ›´ç»†çš„åŠ é”æœºåˆ¶ï¼Œå¯ä»¥ç§°ä¸ºåˆ†æ®µé”ï¼Œåœ¨è¿™ç§é”æœºåˆ¶ä¸‹ï¼Œå…è®¸ä»»æ„æ•°é‡çš„è¯»çº¿ç¨‹å¹¶å‘åœ°è®¿é—® mapï¼Œå¹¶ä¸”æ‰§è¡Œè¯»æ“ä½œçš„çº¿ç¨‹å’Œå†™æ“ä½œçš„çº¿ç¨‹ä¹Ÿå¯ä»¥å¹¶å‘çš„è®¿é—® mapï¼ŒåŒæ—¶å…è®¸ä¸€å®šæ•°é‡çš„å†™æ“ä½œçº¿ç¨‹å¹¶å‘åœ°ä¿®æ”¹ mapï¼Œæ‰€ä»¥å®ƒå¯ä»¥åœ¨å¹¶å‘ç¯å¢ƒä¸‹å®ç°æ›´é«˜çš„ååé‡ã€‚ 1.3 åŒæ­¥é›†åˆä¸å¹¶å‘é›†åˆåŒºåˆ« åŒæ­¥é›†åˆä¸å¹¶å‘é›†åˆéƒ½ä¸ºå¤šçº¿ç¨‹å’Œå¹¶å‘æä¾›äº†åˆé€‚çš„çº¿ç¨‹å®‰å…¨çš„é›†åˆï¼Œä¸è¿‡å¹¶å‘é›†åˆçš„å¯æ‰©å±•æ€§æ›´é«˜ã€‚åœ¨ Java1.5 ä¹‹å‰ç¨‹åºå‘˜ä»¬åªæœ‰åŒæ­¥é›†åˆæ¥ç”¨ä¸”åœ¨å¤šçº¿ç¨‹å¹¶å‘çš„æ—¶å€™ä¼šå¯¼è‡´äº‰ç”¨ï¼Œé˜»ç¢äº†ç³»ç»Ÿçš„æ‰©å±•æ€§ã€‚Java5 ä»‹ç»äº†å¹¶å‘é›†åˆåƒConcurrentHashMapï¼Œä¸ä»…æä¾›çº¿ç¨‹å®‰å…¨è¿˜ç”¨é”åˆ†ç¦»å’Œå†…éƒ¨åˆ†åŒºç­‰ç°ä»£æŠ€æœ¯æé«˜äº†å¯æ‰©å±•æ€§ã€‚ 1.4 SynchronizedMap å’Œ ConcurrentHashMap æ¯”è¾ƒ SynchronizedMap ä¸€æ¬¡é”ä½æ•´å¼ è¡¨æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œæ‰€ä»¥æ¯æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ¥è®¿ä¸º mapã€‚ ConcurrentHashMap ä½¿ç”¨åˆ†æ®µé”æ¥ä¿è¯åœ¨å¤šçº¿ç¨‹ä¸‹çš„æ€§èƒ½ã€‚ ConcurrentHashMap ä¸­åˆ™æ˜¯ä¸€æ¬¡é”ä½ä¸€ä¸ªæ¡¶ã€‚ConcurrentHashMap é»˜è®¤å°†hash è¡¨åˆ†ä¸º 16 ä¸ªæ¡¶ï¼Œè¯¸å¦‚ getï¼Œputï¼Œremove ç­‰å¸¸ç”¨æ“ä½œåªé”å½“å‰éœ€è¦ç”¨åˆ°çš„æ¡¶ã€‚ è¿™æ ·ï¼ŒåŸæ¥åªèƒ½ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ï¼Œç°åœ¨å´èƒ½åŒæ—¶æœ‰ 16 ä¸ªå†™çº¿ç¨‹æ‰§è¡Œï¼Œå¹¶å‘æ€§èƒ½çš„æå‡æ˜¯æ˜¾è€Œæ˜“è§çš„ã€‚ å¦å¤– ConcurrentHashMap ä½¿ç”¨äº†ä¸€ç§ä¸åŒçš„è¿­ä»£æ–¹å¼ã€‚åœ¨è¿™ç§è¿­ä»£æ–¹å¼ä¸­ï¼Œå½“iterator è¢«åˆ›å»ºåé›†åˆå†å‘ç”Ÿæ”¹å˜å°±ä¸å†æ˜¯æŠ›å‡ºConcurrentModificationExceptionï¼Œå–è€Œä»£ä¹‹çš„æ˜¯åœ¨æ”¹å˜æ—¶ new æ–°çš„æ•°æ®ä»è€Œä¸å½±å“åŸæœ‰çš„æ•°æ®ï¼Œiterator å®Œæˆåå†å°†å¤´æŒ‡é’ˆæ›¿æ¢ä¸ºæ–°çš„æ•°æ® ï¼Œè¿™æ · iteratorçº¿ç¨‹å¯ä»¥ä½¿ç”¨åŸæ¥è€çš„æ•°æ®ï¼Œè€Œå†™çº¿ç¨‹ä¹Ÿå¯ä»¥å¹¶å‘çš„å®Œæˆæ”¹å˜ã€‚ 2. CopyOnWriteArrayList CopyOnWriteArrayList æ˜¯ä¸€ä¸ªå¹¶å‘å®¹å™¨ã€‚æœ‰å¾ˆå¤šäººç§°å®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæˆ‘è®¤ä¸ºè¿™å¥è¯ä¸ä¸¥è°¨ï¼Œç¼ºå°‘ä¸€ä¸ªå‰ææ¡ä»¶ï¼Œé‚£å°±æ˜¯éå¤åˆåœºæ™¯ä¸‹æ“ä½œå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ CopyOnWriteArrayList(å…é”å®¹å™¨)çš„å¥½å¤„ä¹‹ä¸€æ˜¯å½“å¤šä¸ªè¿­ä»£å™¨åŒæ—¶éå†å’Œä¿®æ”¹è¿™ä¸ªåˆ—è¡¨æ—¶ï¼Œä¸ä¼šæŠ›å‡º ConcurrentModificationExceptionã€‚åœ¨CopyOnWriteArrayList ä¸­ï¼Œå†™å…¥å°†å¯¼è‡´åˆ›å»ºæ•´ä¸ªåº•å±‚æ•°ç»„çš„å‰¯æœ¬ï¼Œè€Œæºæ•°ç»„å°†ä¿ç•™åœ¨åŸåœ°ï¼Œä½¿å¾—å¤åˆ¶çš„æ•°ç»„åœ¨è¢«ä¿®æ”¹æ—¶ï¼Œè¯»å–æ“ä½œå¯ä»¥å®‰å…¨åœ°æ‰§è¡Œã€‚ CopyOnWriteArrayList çš„ä½¿ç”¨åœºæ™¯ é€šè¿‡æºç åˆ†æï¼Œæˆ‘ä»¬çœ‹å‡ºå®ƒçš„ä¼˜ç¼ºç‚¹æ¯”è¾ƒæ˜æ˜¾ï¼Œæ‰€ä»¥ä½¿ç”¨åœºæ™¯ä¹Ÿå°±æ¯”è¾ƒæ˜æ˜¾ã€‚å°±æ˜¯åˆé€‚è¯»å¤šå†™å°‘çš„åœºæ™¯ã€‚ CopyOnWriteArrayList çš„ç¼ºç‚¹ ç”±äºå†™æ“ä½œçš„æ—¶å€™ï¼Œéœ€è¦æ‹·è´æ•°ç»„ï¼Œä¼šæ¶ˆè€—å†…å­˜ï¼Œå¦‚æœåŸæ•°ç»„çš„å†…å®¹æ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œå¯èƒ½å¯¼è‡´ young gc æˆ–è€… full gcã€‚ ä¸èƒ½ç”¨äºå®æ—¶è¯»çš„åœºæ™¯ï¼Œåƒæ‹·è´æ•°ç»„ã€æ–°å¢å…ƒç´ éƒ½éœ€è¦æ—¶é—´ï¼Œæ‰€ä»¥è°ƒç”¨ä¸€ä¸ª set æ“ä½œåï¼Œè¯»å–åˆ°æ•°æ®å¯èƒ½è¿˜æ˜¯æ—§çš„ï¼Œè™½ç„¶CopyOnWriteArrayList èƒ½åšåˆ°æœ€ç»ˆä¸€è‡´æ€§,ä½†æ˜¯è¿˜æ˜¯æ²¡æ³•æ»¡è¶³å®æ—¶æ€§è¦æ±‚ã€‚ ç”±äºå®é™…ä½¿ç”¨ä¸­å¯èƒ½æ²¡æ³•ä¿è¯ CopyOnWriteArrayList åˆ°åº•è¦æ”¾ç½®å¤šå°‘æ•°æ®ï¼Œä¸‡ä¸€æ•°æ®ç¨å¾®æœ‰ç‚¹å¤šï¼Œæ¯æ¬¡ add/set éƒ½è¦é‡æ–°å¤åˆ¶æ•°ç»„ï¼Œè¿™ä¸ªä»£ä»·å®åœ¨å¤ªé«˜æ˜‚äº†ã€‚åœ¨é«˜æ€§èƒ½çš„äº’è”ç½‘åº”ç”¨ä¸­ï¼Œè¿™ç§æ“ä½œåˆ†åˆ†é’Ÿå¼•èµ·æ•…éšœã€‚ CopyOnWriteArrayList çš„è®¾è®¡æ€æƒ³ è¯»å†™åˆ†ç¦»ï¼Œè¯»å’Œå†™åˆ†å¼€ æœ€ç»ˆä¸€è‡´æ€§ ä½¿ç”¨å¦å¤–å¼€è¾Ÿç©ºé—´çš„æ€è·¯ï¼Œæ¥è§£å†³å¹¶å‘å†²çª 3. ThreadLocal ThreadLocal æ˜¯ä¸€ä¸ªæœ¬åœ°çº¿ç¨‹å‰¯æœ¬å˜é‡å·¥å…·ç±»ï¼Œåœ¨æ¯ä¸ªçº¿ç¨‹ä¸­éƒ½åˆ›å»ºäº†ä¸€ä¸ª ThreadLocalMap å¯¹è±¡ï¼Œç®€å•è¯´ ThreadLocal å°±æ˜¯ä¸€ç§ä»¥ç©ºé—´æ¢æ—¶é—´çš„åšæ³•ï¼Œæ¯ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®è‡ªå·±å†…éƒ¨ ThreadLocalMap å¯¹è±¡å†…çš„ valueã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œé¿å…èµ„æºåœ¨å¤šçº¿ç¨‹é—´å…±äº«ã€‚ åŸç†ï¼šçº¿ç¨‹å±€éƒ¨å˜é‡æ˜¯å±€é™äºçº¿ç¨‹å†…éƒ¨çš„å˜é‡ï¼Œå±äºçº¿ç¨‹è‡ªèº«æ‰€æœ‰ï¼Œä¸åœ¨å¤šä¸ªçº¿ç¨‹é—´å…±äº«ã€‚Javaæä¾›ThreadLocalç±»æ¥æ”¯æŒçº¿ç¨‹å±€éƒ¨å˜é‡ï¼Œæ˜¯ä¸€ç§å®ç°çº¿ç¨‹å®‰å…¨çš„æ–¹å¼ã€‚ä½†æ˜¯åœ¨ç®¡ç†ç¯å¢ƒä¸‹ï¼ˆå¦‚ web æœåŠ¡å™¨ï¼‰ä½¿ç”¨çº¿ç¨‹å±€éƒ¨å˜é‡çš„æ—¶å€™è¦ç‰¹åˆ«å°å¿ƒï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå·¥ä½œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸæ¯”ä»»ä½•åº”ç”¨å˜é‡çš„ç”Ÿå‘½å‘¨æœŸéƒ½è¦é•¿ã€‚ä»»ä½•çº¿ç¨‹å±€éƒ¨å˜é‡ä¸€æ—¦åœ¨å·¥ä½œå®Œæˆåæ²¡æœ‰é‡Šæ”¾ï¼ŒJava åº”ç”¨å°±å­˜åœ¨å†…å­˜æ³„éœ²çš„é£é™©ã€‚ ç»å…¸çš„ä½¿ç”¨åœºæ™¯æ˜¯ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ª JDBC è¿æ¥ Connectionã€‚è¿™æ ·å°±å¯ä»¥ä¿è¯æ¯ä¸ªçº¿ç¨‹çš„éƒ½åœ¨å„è‡ªçš„ Connection ä¸Šè¿›è¡Œæ•°æ®åº“çš„æ“ä½œï¼Œä¸ä¼šå‡ºç° A çº¿ç¨‹å…³äº† Bçº¿ç¨‹æ­£åœ¨ä½¿ç”¨çš„ Connectionï¼› è¿˜æœ‰ Session ç®¡ç† ç­‰é—®é¢˜ã€‚ ThreadLocal ä½¿ç”¨ä¾‹å­ï¼š public class TestThreadLocal { //çº¿ç¨‹æœ¬åœ°å­˜å‚¨å˜é‡ private static final ThreadLocal&lt;Integer&gt; THREAD_LOCAL_NUM = new ThreadLocal&lt;Integer&gt;() { @Override protected Integer initialValue() { return 0; } }; public static void main(String[] args) { for (int i = 0; i &lt;3; i++) {//å¯åŠ¨ä¸‰ä¸ªçº¿ç¨‹ Thread t = new Thread() { @Override public void run() { add10ByThreadLocal(); } }; t.start(); } } /** * çº¿ç¨‹æœ¬åœ°å­˜å‚¨å˜é‡åŠ  5 */ private static void add10ByThreadLocal() { for (int i = 0; i &lt;5; i++) { Integer n = THREAD_LOCAL_NUM.get(); n += 1; THREAD_LOCAL_NUM.set(n); System.out.println(Thread.currentThread().getName() + &quot; : ThreadLocal num=&quot; + n); } } } æ‰“å°ç»“æœï¼šå¯åŠ¨äº† 3 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹æœ€åéƒ½æ‰“å°åˆ° â€œThreadLocal num=5â€ï¼Œè€Œä¸æ˜¯ num ä¸€ç›´åœ¨ç´¯åŠ ç›´åˆ°å€¼ç­‰äº 15 3.1ä»€ä¹ˆæ˜¯çº¿ç¨‹å±€éƒ¨å˜é‡ï¼Ÿ çº¿ç¨‹å±€éƒ¨å˜é‡æ˜¯å±€é™äºçº¿ç¨‹å†…éƒ¨çš„å˜é‡ï¼Œå±äºçº¿ç¨‹è‡ªèº«æ‰€æœ‰ï¼Œä¸åœ¨å¤šä¸ªçº¿ç¨‹é—´å…±äº«ã€‚Java æä¾› ThreadLocal ç±»æ¥æ”¯æŒçº¿ç¨‹å±€éƒ¨å˜é‡ï¼Œæ˜¯ä¸€ç§å®ç°çº¿ç¨‹å®‰å…¨çš„æ–¹å¼ã€‚ä½†æ˜¯åœ¨ç®¡ç†ç¯å¢ƒä¸‹ï¼ˆå¦‚ web æœåŠ¡å™¨ï¼‰ä½¿ç”¨çº¿ç¨‹å±€éƒ¨å˜é‡çš„æ—¶å€™è¦ç‰¹åˆ«å°å¿ƒï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå·¥ä½œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸæ¯”ä»»ä½•åº”ç”¨å˜é‡çš„ç”Ÿå‘½å‘¨æœŸéƒ½è¦é•¿ã€‚ä»»ä½•çº¿ç¨‹å±€éƒ¨å˜é‡ä¸€æ—¦åœ¨å·¥ä½œå®Œæˆåæ²¡æœ‰é‡Šæ”¾ï¼ŒJava åº”ç”¨å°±å­˜åœ¨å†…å­˜æ³„éœ²çš„é£é™©ã€‚ 3.2 ThreadLocalå†…å­˜æ³„æ¼åˆ†æä¸è§£å†³æ–¹æ¡ˆ ThreadLocalé€ æˆå†…å­˜æ³„æ¼çš„åŸå› ï¼Ÿ ThreadLocalMap ä¸­ä½¿ç”¨çš„ key ä¸º ThreadLocal çš„å¼±å¼•ç”¨,è€Œ value æ˜¯å¼ºå¼•ç”¨ã€‚æ‰€ä»¥ï¼Œå¦‚æœ ThreadLocal æ²¡æœ‰è¢«å¤–éƒ¨å¼ºå¼•ç”¨çš„æƒ…å†µä¸‹ï¼Œåœ¨åƒåœ¾å›æ”¶çš„æ—¶å€™ï¼Œkey ä¼šè¢«æ¸…ç†æ‰ï¼Œè€Œ value ä¸ä¼šè¢«æ¸…ç†æ‰ã€‚è¿™æ ·ä¸€æ¥ï¼ŒThreadLocalMap ä¸­å°±ä¼šå‡ºç°keyä¸ºnullçš„Entryã€‚å‡å¦‚æˆ‘ä»¬ä¸åšä»»ä½•æªæ–½çš„è¯ï¼Œvalue æ°¸è¿œæ— æ³•è¢«GC å›æ”¶ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯èƒ½ä¼šäº§ç”Ÿå†…å­˜æ³„éœ²ã€‚ThreadLocalMapå®ç°ä¸­å·²ç»è€ƒè™‘äº†è¿™ç§æƒ…å†µï¼Œåœ¨è°ƒç”¨ set()ã€get()ã€remove() æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šæ¸…ç†æ‰ key ä¸º null çš„è®°å½•ã€‚ä½¿ç”¨å®Œ ThreadLocalæ–¹æ³•å æœ€å¥½æ‰‹åŠ¨è°ƒç”¨remove()æ–¹æ³• ThreadLocalå†…å­˜æ³„æ¼è§£å†³æ–¹æ¡ˆï¼Ÿ æ¯æ¬¡ä½¿ç”¨å®ŒThreadLocalï¼Œéƒ½è°ƒç”¨å®ƒçš„remove()æ–¹æ³•ï¼Œæ¸…é™¤æ•°æ®ã€‚ åœ¨ä½¿ç”¨çº¿ç¨‹æ± çš„æƒ…å†µä¸‹ï¼Œæ²¡æœ‰åŠæ—¶æ¸…ç†ThreadLocalï¼Œä¸ä»…æ˜¯å†…å­˜æ³„æ¼çš„é—®é¢˜ï¼Œæ›´ä¸¥é‡çš„æ˜¯å¯èƒ½å¯¼è‡´ä¸šåŠ¡é€»è¾‘å‡ºç°é—®é¢˜ã€‚æ‰€ä»¥ï¼Œä½¿ç”¨ThreadLocalå°±è·ŸåŠ é”å®Œè¦è§£é”ä¸€æ ·ï¼Œç”¨å®Œå°±æ¸…ç†ã€‚ 4. BlockingQueue é˜»å¡é˜Ÿåˆ—ï¼ˆBlockingQueueï¼‰æ˜¯ä¸€ä¸ªæ”¯æŒä¸¤ä¸ªé™„åŠ æ“ä½œçš„é˜Ÿåˆ—ã€‚ è¿™ä¸¤ä¸ªé™„åŠ çš„æ“ä½œæ˜¯ï¼šåœ¨é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œè·å–å…ƒç´ çš„çº¿ç¨‹ä¼šç­‰å¾…é˜Ÿåˆ—å˜ä¸ºéç©ºã€‚å½“é˜Ÿåˆ—æ»¡æ—¶ï¼Œå­˜å‚¨å…ƒç´ çš„çº¿ç¨‹ä¼šç­‰å¾…é˜Ÿåˆ—å¯ç”¨ã€‚ é˜»å¡é˜Ÿåˆ—å¸¸ç”¨äºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„åœºæ™¯ï¼Œç”Ÿäº§è€…æ˜¯å¾€é˜Ÿåˆ—é‡Œæ·»åŠ å…ƒç´ çš„çº¿ç¨‹ï¼Œæ¶ˆè´¹è€…æ˜¯ä»é˜Ÿåˆ—é‡Œæ‹¿å…ƒç´ çš„çº¿ç¨‹ã€‚é˜»å¡é˜Ÿåˆ—å°±æ˜¯ç”Ÿäº§è€…å­˜æ”¾å…ƒç´ çš„å®¹å™¨ï¼Œè€Œæ¶ˆè´¹è€…ä¹Ÿåªä»å®¹å™¨é‡Œæ‹¿å…ƒç´ ã€‚ JDK7 æä¾›äº† 7 ä¸ªé˜»å¡é˜Ÿåˆ—ã€‚åˆ†åˆ«æ˜¯ï¼š ArrayBlockingQueue ï¼šä¸€ä¸ªç”±æ•°ç»„ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚ LinkedBlockingQueue ï¼šä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚ PriorityBlockingQueue ï¼šä¸€ä¸ªæ”¯æŒä¼˜å…ˆçº§æ’åºçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚ DelayQueueï¼šä¸€ä¸ªä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚ SynchronousQueueï¼šä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ã€‚ LinkedTransferQueueï¼šä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚ LinkedBlockingDequeï¼šä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„åŒå‘é˜»å¡é˜Ÿåˆ—ã€‚ Java 5 ä¹‹å‰å®ç°åŒæ­¥å­˜å–æ—¶ï¼Œå¯ä»¥ä½¿ç”¨æ™®é€šçš„ä¸€ä¸ªé›†åˆï¼Œç„¶ååœ¨ä½¿ç”¨çº¿ç¨‹çš„åä½œå’Œçº¿ç¨‹åŒæ­¥å¯ä»¥å®ç°ç”Ÿäº§è€…ï¼Œæ¶ˆè´¹è€…æ¨¡å¼ï¼Œä¸»è¦çš„æŠ€æœ¯å°±æ˜¯ç”¨å¥½ï¼Œwait,notify,notifyAll,sychronized è¿™äº›å…³é”®å­—ã€‚è€Œåœ¨ java 5 ä¹‹åï¼Œå¯ä»¥ä½¿ç”¨é˜»å¡é˜Ÿåˆ—æ¥å®ç°ï¼Œæ­¤æ–¹å¼å¤§å¤§ç®€å°‘äº†ä»£ç é‡ï¼Œä½¿å¾—å¤šçº¿ç¨‹ç¼–ç¨‹æ›´åŠ å®¹æ˜“ï¼Œå®‰å…¨æ–¹é¢ä¹Ÿæœ‰ä¿éšœã€‚ BlockingQueue æ¥å£æ˜¯ Queue çš„å­æ¥å£ï¼Œå®ƒçš„ä¸»è¦ç”¨é€”å¹¶ä¸æ˜¯ä½œä¸ºå®¹å™¨ï¼Œè€Œæ˜¯ä½œä¸ºçº¿ç¨‹åŒæ­¥çš„çš„å·¥å…·ï¼Œå› æ­¤ä»–å…·æœ‰ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„ç‰¹æ€§ï¼Œå½“ç”Ÿäº§è€…çº¿ç¨‹è¯•å›¾å‘ BlockingQueue æ”¾å…¥å…ƒç´ æ—¶ï¼Œå¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™çº¿ç¨‹è¢«é˜»å¡ï¼Œå½“æ¶ˆè´¹è€…çº¿ç¨‹è¯•å›¾ä»ä¸­å–å‡ºä¸€ä¸ªå…ƒç´ æ—¶ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¯¥çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œæ­£æ˜¯å› ä¸ºå®ƒæ‰€å…·æœ‰è¿™ä¸ªç‰¹æ€§ï¼Œæ‰€ä»¥åœ¨ç¨‹åºä¸­å¤šä¸ªçº¿ç¨‹äº¤æ›¿å‘ BlockingQueue ä¸­æ”¾å…¥å…ƒç´ ï¼Œå–å‡ºå…ƒç´ ï¼Œå®ƒå¯ä»¥å¾ˆå¥½çš„æ§åˆ¶çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚ é˜»å¡é˜Ÿåˆ—ä½¿ç”¨æœ€ç»å…¸çš„åœºæ™¯å°±æ˜¯ socket å®¢æˆ·ç«¯æ•°æ®çš„è¯»å–å’Œè§£æï¼Œè¯»å–æ•°æ®çš„çº¿ç¨‹ä¸æ–­å°†æ•°æ®æ”¾å…¥é˜Ÿåˆ—ï¼Œç„¶åè§£æçº¿ç¨‹ä¸æ–­ä»é˜Ÿåˆ—å–æ•°æ®è§£æã€‚ ","link":"https://tianxiawuhao.github.io/b7Jq-wpXZ/"},{"title":"å¤šçº¿ç¨‹åŸºç¡€æ¦‚å¿µä¸‰","content":"Javaå†…å­˜æ¨¡å‹å’Œçº¿ç¨‹ç›¸å…³ Javaä¸­åƒåœ¾å›æ”¶æœ‰ä»€ä¹ˆç›®çš„ï¼Ÿä»€ä¹ˆæ—¶å€™è¿›è¡Œåƒåœ¾å›æ”¶ï¼Ÿ åƒåœ¾å›æ”¶çš„ç›®çš„æ˜¯è¯†åˆ«å¹¶ä¸”ä¸¢å¼ƒåº”ç”¨ä¸å†ä½¿ç”¨çš„å¯¹è±¡æ¥é‡Šæ”¾å’Œé‡ç”¨èµ„æºã€‚ å¦‚æœå¯¹è±¡çš„å¼•ç”¨è¢«ç½®ä¸ºnullï¼Œåƒåœ¾æ”¶é›†å™¨æ˜¯å¦ä¼šç«‹å³é‡Šæ”¾å¯¹è±¡å ç”¨çš„å†…å­˜ï¼Ÿ ä¸ä¼šï¼Œåœ¨æœ¬æ¬¡åƒåœ¾å›æ”¶å‘¨æœŸä¸­ï¼Œè¿™ä¸ªå¯¹è±¡å°†è¢«æ ‡è®°ä¸ºå¯å›æ”¶çš„ã€‚ä¹Ÿå°±æ˜¯è¯´å¹¶ä¸ä¼šç«‹å³è¢«åƒåœ¾æ”¶é›†å™¨ç«‹åˆ»å›æ”¶ï¼Œè€Œæ˜¯åœ¨ä¸‹ä¸€æ¬¡åƒåœ¾å›æ”¶æ—¶å¯¹è±¡ä¾æ—§ä¸å¯è¾¾æ‰ä¼šé‡Šæ”¾å…¶å ç”¨çš„å†…å­˜ã€‚ finalize()æ–¹æ³•ä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨ï¼Ÿææ„å‡½æ•°(finalization)çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿ 1ï¼‰åƒåœ¾å›æ”¶å™¨ï¼ˆgarbage colectorï¼‰å†³å®šå›æ”¶æŸå¯¹è±¡æ—¶ï¼Œå°±ä¼šè¿è¡Œè¯¥å¯¹è±¡çš„finalize()æ–¹æ³•ï¼› finalizeæ˜¯Objectç±»çš„ä¸€ä¸ªæ–¹æ³•ï¼Œè¯¥æ–¹æ³•åœ¨Objectç±»ä¸­çš„å£°æ˜protected void finalize() throws Throwable { } åœ¨åƒåœ¾å›æ”¶å™¨æ‰§è¡Œæ—¶ä¼šè°ƒç”¨è¢«å›æ”¶å¯¹è±¡çš„finalize()æ–¹æ³•ï¼Œå¯ä»¥è¦†ç›–æ­¤æ–¹æ³•æ¥å®ç°å¯¹å…¶èµ„æºçš„å›æ”¶ã€‚æ³¨æ„ï¼šä¸€æ—¦åƒåœ¾å›æ”¶å™¨å‡†å¤‡é‡Šæ”¾å¯¹è±¡å ç”¨çš„å†…å­˜ï¼Œå°†é¦–å…ˆè°ƒç”¨è¯¥å¯¹è±¡çš„finalize()æ–¹æ³•ï¼Œå¹¶ä¸”ä¸‹ä¸€æ¬¡åƒåœ¾å›æ”¶åŠ¨ä½œå‘ç”Ÿæ—¶ï¼Œæ‰çœŸæ­£å›æ”¶å¯¹è±¡å ç”¨çš„å†…å­˜ç©ºé—´ 2ï¼‰GCæœ¬æ¥å°±æ˜¯å†…å­˜å›æ”¶äº†ï¼Œåº”ç”¨è¿˜éœ€è¦åœ¨finalizationåšä»€ä¹ˆå‘¢ï¼Ÿ ç­”æ¡ˆæ˜¯å¤§éƒ¨åˆ†æ—¶å€™ï¼Œä»€ä¹ˆéƒ½ä¸ç”¨åš(ä¹Ÿå°±æ˜¯ä¸éœ€è¦é‡è½½)ã€‚åªæœ‰åœ¨æŸäº›å¾ˆç‰¹æ®Šçš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚ä½ è°ƒç”¨äº†ä¸€äº›nativeçš„æ–¹æ³•(ä¸€èˆ¬æ˜¯Cå†™çš„)ï¼Œå¯ä»¥è¦åœ¨finaliztioné‡Œå»è°ƒç”¨Cçš„é‡Šæ”¾å‡½æ•°ã€‚ é‡æ’åºä¸æ•°æ®ä¾èµ–æ€§ ä¸ºä»€ä¹ˆä»£ç ä¼šé‡æ’åºï¼Ÿ åœ¨æ‰§è¡Œç¨‹åºæ—¶ï¼Œä¸ºäº†æä¾›æ€§èƒ½ï¼Œå¤„ç†å™¨å’Œç¼–è¯‘å™¨å¸¸å¸¸ä¼šå¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºï¼Œä½†æ˜¯ä¸èƒ½éšæ„é‡æ’åºï¼Œä¸æ˜¯ä½ æƒ³æ€ä¹ˆæ’åºå°±æ€ä¹ˆæ’åºï¼Œå®ƒéœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹ä¸èƒ½æ”¹å˜ç¨‹åºè¿è¡Œçš„ç»“æœï¼› å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»çš„ä¸å…è®¸é‡æ’åº éœ€è¦æ³¨æ„çš„æ˜¯ï¼šé‡æ’åºä¸ä¼šå½±å“å•çº¿ç¨‹ç¯å¢ƒçš„æ‰§è¡Œç»“æœï¼Œä½†æ˜¯ä¼šç ´åå¤šçº¿ç¨‹çš„æ‰§è¡Œè¯­ä¹‰ã€‚ as-if-serialè§„åˆ™å’Œhappens-beforeè§„åˆ™çš„åŒºåˆ« as-if-serialè¯­ä¹‰ä¿è¯å•çº¿ç¨‹å†…ç¨‹åºçš„æ‰§è¡Œç»“æœä¸è¢«æ”¹å˜ï¼Œhappens-beforeå…³ç³»ä¿è¯æ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œç»“æœä¸è¢«æ”¹å˜ã€‚ as-if-serialè¯­ä¹‰ç»™ç¼–å†™å•çº¿ç¨‹ç¨‹åºçš„ç¨‹åºå‘˜åˆ›é€ äº†ä¸€ä¸ªå¹»å¢ƒï¼šå•çº¿ç¨‹ç¨‹åºæ˜¯æŒ‰ç¨‹åºçš„é¡ºåºæ¥æ‰§è¡Œçš„ã€‚happens-beforeå…³ç³»ç»™ç¼–å†™æ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºçš„ç¨‹åºå‘˜åˆ›é€ äº†ä¸€ä¸ªå¹»å¢ƒï¼šæ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºæ˜¯æŒ‰happens-beforeæŒ‡å®šçš„é¡ºåºæ¥æ‰§è¡Œçš„ã€‚ as-if-serialè¯­ä¹‰å’Œhappens-beforeè¿™ä¹ˆåšçš„ç›®çš„ï¼Œéƒ½æ˜¯ä¸ºäº†åœ¨ä¸æ”¹å˜ç¨‹åºæ‰§è¡Œç»“æœçš„å‰æä¸‹ï¼Œå°½å¯èƒ½åœ°æé«˜ç¨‹åºæ‰§è¡Œçš„å¹¶è¡Œåº¦ã€‚ synchronized åœ¨ Java ä¸­,synchronized å…³é”®å­—æ˜¯ç”¨æ¥æ§åˆ¶çº¿ç¨‹åŒæ­¥çš„,å°±æ˜¯åœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸‹,æ§åˆ¶synchronized ä»£ç æ®µä¸è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œã€‚synchronized å¯ä»¥ä¿®é¥°ç±»ã€æ–¹æ³•ã€å˜é‡ã€‚ å¦å¤–ï¼Œåœ¨ Java æ—©æœŸç‰ˆæœ¬ä¸­ï¼Œsynchronizedå±äºé‡é‡çº§é”ï¼Œæ•ˆç‡ä½ä¸‹ï¼Œå› ä¸ºç›‘è§†å™¨é”ï¼ˆmonitorï¼‰æ˜¯ä¾èµ–äºåº•å±‚çš„æ“ä½œç³»ç»Ÿçš„ Mutex Lock æ¥å®ç°çš„ï¼ŒJava çš„çº¿ç¨‹æ˜¯æ˜ å°„åˆ°æ“ä½œç³»ç»Ÿçš„åŸç”Ÿçº¿ç¨‹ä¹‹ä¸Šçš„ã€‚å¦‚æœè¦æŒ‚èµ·æˆ–è€…å”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œéƒ½éœ€è¦æ“ä½œç³»ç»Ÿå¸®å¿™å®Œæˆï¼Œè€Œæ“ä½œç³»ç»Ÿå®ç°çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢æ—¶éœ€è¦ä»ç”¨æˆ·æ€è½¬æ¢åˆ°å†…æ ¸æ€ï¼Œè¿™ä¸ªçŠ¶æ€ä¹‹é—´çš„è½¬æ¢éœ€è¦ç›¸å¯¹æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œæ—¶é—´æˆæœ¬ç›¸å¯¹è¾ƒé«˜ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ—©æœŸçš„ synchronized æ•ˆç‡ä½çš„åŸå› ã€‚åº†å¹¸çš„æ˜¯åœ¨ Java 6 ä¹‹å Java å®˜æ–¹å¯¹ä» JVM å±‚é¢å¯¹synchronized è¾ƒå¤§ä¼˜åŒ–ï¼Œæ‰€ä»¥ç°åœ¨çš„ synchronized é”æ•ˆç‡ä¹Ÿä¼˜åŒ–å¾—å¾ˆä¸é”™äº†ã€‚JDK1.6å¯¹é”çš„å®ç°å¼•å…¥äº†å¤§é‡çš„ä¼˜åŒ–ï¼Œå¦‚è‡ªæ—‹é”ã€é€‚åº”æ€§è‡ªæ—‹é”ã€é”æ¶ˆé™¤ã€é”ç²—åŒ–ã€åå‘é”ã€è½»é‡çº§é”ç­‰æŠ€æœ¯æ¥å‡å°‘é”æ“ä½œçš„å¼€é”€ã€‚ synchronizedå…³é”®å­—æœ€ä¸»è¦çš„ä¸‰ç§ä½¿ç”¨æ–¹å¼ï¼š ä¿®é¥°å®ä¾‹æ–¹æ³•: ä½œç”¨äºå½“å‰å¯¹è±¡å®ä¾‹åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾—å½“å‰å¯¹è±¡å®ä¾‹çš„é” ä¿®é¥°é™æ€æ–¹æ³•: ä¹Ÿå°±æ˜¯ç»™å½“å‰ç±»åŠ é”ï¼Œä¼šä½œç”¨äºç±»çš„æ‰€æœ‰å¯¹è±¡å®ä¾‹ï¼Œå› ä¸ºé™æ€æˆå‘˜ä¸å±äºä»»ä½•ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œæ˜¯ç±»æˆå‘˜ï¼ˆ static è¡¨æ˜è¿™æ˜¯è¯¥ç±»çš„ä¸€ä¸ªé™æ€èµ„æºï¼Œä¸ç®¡newäº†å¤šå°‘ä¸ªå¯¹è±¡ï¼Œåªæœ‰ä¸€ä»½ï¼‰ã€‚æ‰€ä»¥å¦‚æœä¸€ä¸ªçº¿ç¨‹Aè°ƒç”¨ä¸€ä¸ªå®ä¾‹å¯¹è±¡çš„éé™æ€ synchronized æ–¹æ³•ï¼Œè€Œçº¿ç¨‹Béœ€è¦è°ƒç”¨è¿™ä¸ªå®ä¾‹å¯¹è±¡æ‰€å±ç±»çš„é™æ€ synchronized æ–¹æ³•ï¼Œæ˜¯å…è®¸çš„ï¼Œä¸ä¼šå‘ç”Ÿäº’æ–¥ç°è±¡ï¼Œå› ä¸ºè®¿é—®é™æ€ synchronized æ–¹æ³•å ç”¨çš„é”æ˜¯å½“å‰ç±»çš„é”ï¼Œè€Œè®¿é—®éé™æ€ synchronized æ–¹æ³•å ç”¨çš„é”æ˜¯å½“å‰å®ä¾‹å¯¹è±¡é”ã€‚ ä¿®é¥°ä»£ç å—: æŒ‡å®šåŠ é”å¯¹è±¡ï¼Œå¯¹ç»™å®šå¯¹è±¡åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç åº“å‰è¦è·å¾—ç»™å®šå¯¹è±¡çš„é”ã€‚ æ€»ç»“ï¼š synchronized å…³é”®å­—åŠ åˆ° static é™æ€æ–¹æ³•å’Œ synchronized(class)ä»£ç å—ä¸Šéƒ½æ˜¯æ˜¯ç»™ Class ç±»ä¸Šé”ã€‚synchronized å…³é”®å­—åŠ åˆ°å®ä¾‹æ–¹æ³•ä¸Šæ˜¯ç»™å¯¹è±¡å®ä¾‹ä¸Šé”ã€‚å°½é‡ä¸è¦ä½¿ç”¨ synchronized(String a) å› ä¸ºJVMä¸­ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± å…·æœ‰ç¼“å­˜åŠŸèƒ½ï¼ ä¸‹é¢æˆ‘ä»¥ä¸€ä¸ªå¸¸è§çš„é¢è¯•é¢˜ä¸ºä¾‹è®²è§£ä¸€ä¸‹ synchronized å…³é”®å­—çš„å…·ä½“ä½¿ç”¨ã€‚ é¢è¯•ä¸­é¢è¯•å®˜ç»å¸¸ä¼šè¯´ï¼šâ€œå•ä¾‹æ¨¡å¼äº†è§£å—ï¼Ÿæ¥ç»™æˆ‘æ‰‹å†™ä¸€ä¸‹ï¼ç»™æˆ‘è§£é‡Šä¸€ä¸‹åŒé‡æ£€éªŒé”æ–¹å¼å®ç°å•ä¾‹æ¨¡å¼çš„åŸç†å‘—ï¼â€ åŒé‡æ ¡éªŒé”å®ç°å¯¹è±¡å•ä¾‹ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰ public class Singleton { private volatile static Singleton uniqueInstance; private Singleton() { } public static Singleton getUniqueInstance() { //å…ˆåˆ¤æ–­å¯¹è±¡æ˜¯å¦å·²ç»å®ä¾‹è¿‡ï¼Œæ²¡æœ‰å®ä¾‹åŒ–è¿‡æ‰è¿›å…¥åŠ é”ä»£ç  if (uniqueInstance == null) { //ç±»å¯¹è±¡åŠ é” synchronized (Singleton.class) { if (uniqueInstance == null) { uniqueInstance = new Singleton(); } } } return uniqueInstance; } } å¦å¤–ï¼Œéœ€è¦æ³¨æ„ uniqueInstance é‡‡ç”¨ volatile å…³é”®å­—ä¿®é¥°ä¹Ÿæ˜¯å¾ˆæœ‰å¿…è¦ã€‚ uniqueInstance é‡‡ç”¨ volatile å…³é”®å­—ä¿®é¥°ä¹Ÿæ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œ uniqueInstance = new Singleton(); è¿™æ®µä»£ç å…¶å®æ˜¯åˆ†ä¸ºä¸‰æ­¥æ‰§è¡Œï¼š ä¸º uniqueInstance åˆ†é…å†…å­˜ç©ºé—´ åˆå§‹åŒ– uniqueInstance å°† uniqueInstance æŒ‡å‘åˆ†é…çš„å†…å­˜åœ°å€ ä½¿ç”¨ volatile å¯ä»¥ç¦æ­¢ JVM çš„æŒ‡ä»¤é‡æ’ï¼Œä¿è¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œã€‚ è¯´ä¸€ä¸‹ synchronized åº•å±‚å®ç°åŸç†ï¼Ÿ synchronizedæ˜¯Javaä¸­çš„ä¸€ä¸ªå…³é”®å­—ï¼Œåœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰çœ‹åˆ°æ˜¾ç¤ºçš„åŠ é”å’Œè§£é”è¿‡ç¨‹ã€‚å› æ­¤æœ‰å¿…è¦é€šè¿‡javapå‘½ä»¤ï¼ŒæŸ¥çœ‹ç›¸åº”çš„å­—èŠ‚ç æ–‡ä»¶ã€‚ synchronized åŒæ­¥è¯­å¥å—çš„æƒ…å†µ public class SynchronizedDemo { public void method() { synchronized (this) { System.out.println(&quot;synchronized ä»£ç å—&quot;); } } } é€šè¿‡JDK åæ±‡ç¼–æŒ‡ä»¤ javap -c -v SynchronizedDemo å¯ä»¥çœ‹å‡ºåœ¨æ‰§è¡ŒåŒæ­¥ä»£ç å—ä¹‹å‰ä¹‹åéƒ½æœ‰ä¸€ä¸ªmonitorå­—æ ·ï¼Œå…¶ä¸­å‰é¢çš„æ˜¯monitorenterï¼Œåé¢çš„æ˜¯ç¦»å¼€monitorexitï¼Œä¸éš¾æƒ³è±¡ä¸€ä¸ªçº¿ç¨‹ä¹Ÿæ‰§è¡ŒåŒæ­¥ä»£ç å—ï¼Œé¦–å…ˆè¦è·å–é”ï¼Œè€Œè·å–é”çš„è¿‡ç¨‹å°±æ˜¯monitorenter ï¼Œåœ¨æ‰§è¡Œå®Œä»£ç å—ä¹‹åï¼Œè¦é‡Šæ”¾é”ï¼Œé‡Šæ”¾é”å°±æ˜¯æ‰§è¡ŒmonitorexitæŒ‡ä»¤ã€‚ ä¸ºä»€ä¹ˆä¼šæœ‰ä¸¤ä¸ªmonitorexitå‘¢ï¼Ÿ è¿™ä¸ªä¸»è¦æ˜¯é˜²æ­¢åœ¨åŒæ­¥ä»£ç å—ä¸­çº¿ç¨‹å› å¼‚å¸¸é€€å‡ºï¼Œè€Œé”æ²¡æœ‰å¾—åˆ°é‡Šæ”¾ï¼Œè¿™å¿…ç„¶ä¼šé€ æˆæ­»é”ï¼ˆç­‰å¾…çš„çº¿ç¨‹æ°¸è¿œè·å–ä¸åˆ°é”ï¼‰ã€‚å› æ­¤æœ€åä¸€ä¸ªmonitorexitæ˜¯ä¿è¯åœ¨å¼‚å¸¸æƒ…å†µä¸‹ï¼Œé”ä¹Ÿå¯ä»¥å¾—åˆ°é‡Šæ”¾ï¼Œé¿å…æ­»é”ã€‚ ä»…æœ‰ACC_SYNCHRONIZEDè¿™ä¹ˆä¸€ä¸ªæ ‡å¿—ï¼Œè¯¥æ ‡è®°è¡¨æ˜çº¿ç¨‹è¿›å…¥è¯¥æ–¹æ³•æ—¶ï¼Œéœ€è¦monitorenterï¼Œé€€å‡ºè¯¥æ–¹æ³•æ—¶éœ€è¦monitorexitã€‚ synchronizedå¯é‡å…¥çš„åŸç† é‡å…¥é”æ˜¯æŒ‡ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°è¯¥é”ä¹‹åï¼Œè¯¥çº¿ç¨‹å¯ä»¥ç»§ç»­è·å¾—è¯¥é”ã€‚åº•å±‚åŸç†ç»´æŠ¤ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå½“çº¿ç¨‹è·å–è¯¥é”æ—¶ï¼Œè®¡æ•°å™¨åŠ ä¸€ï¼Œå†æ¬¡è·å¾—è¯¥é”æ—¶ç»§ç»­åŠ ä¸€ï¼Œé‡Šæ”¾é”æ—¶ï¼Œè®¡æ•°å™¨å‡ä¸€ï¼Œå½“è®¡æ•°å™¨å€¼ä¸º0æ—¶ï¼Œè¡¨æ˜è¯¥é”æœªè¢«ä»»ä½•çº¿ç¨‹æ‰€æŒæœ‰ï¼Œå…¶å®ƒçº¿ç¨‹å¯ä»¥ç«äº‰è·å–é”ã€‚ ä»€ä¹ˆæ˜¯è‡ªæ—‹ å¾ˆå¤š synchronized é‡Œé¢çš„ä»£ç åªæ˜¯ä¸€äº›å¾ˆç®€å•çš„ä»£ç ï¼Œæ‰§è¡Œæ—¶é—´éå¸¸å¿«ï¼Œæ­¤æ—¶ç­‰å¾…çš„çº¿ç¨‹éƒ½åŠ é”å¯èƒ½æ˜¯ä¸€ç§ä¸å¤ªå€¼å¾—çš„æ“ä½œï¼Œå› ä¸ºçº¿ç¨‹é˜»å¡æ¶‰åŠåˆ°ç”¨æˆ·æ€å’Œå†…æ ¸æ€åˆ‡æ¢çš„é—®é¢˜ã€‚æ—¢ç„¶ synchronized é‡Œé¢çš„ä»£ç æ‰§è¡Œå¾—éå¸¸å¿«ï¼Œä¸å¦¨è®©ç­‰å¾…é”çš„çº¿ç¨‹ä¸è¦è¢«é˜»å¡ï¼Œè€Œæ˜¯åœ¨ synchronized çš„è¾¹ç•Œåšå¿™å¾ªç¯ï¼Œè¿™å°±æ˜¯è‡ªæ—‹ã€‚å¦‚æœåšäº†å¤šæ¬¡å¾ªç¯å‘ç°è¿˜æ²¡æœ‰è·å¾—é”ï¼Œå†é˜»å¡ï¼Œè¿™æ ·å¯èƒ½æ˜¯ä¸€ç§æ›´å¥½çš„ç­–ç•¥ã€‚ é”çŠ¶æ€ é”çš„çŠ¶æ€æ€»å…±æœ‰å››ç§ï¼šæ— é”çŠ¶æ€ã€åå‘é”ã€è½»é‡çº§é”å’Œé‡é‡çº§é”ã€‚éšç€é”çš„ç«äº‰ï¼Œé”å¯ä»¥ä»åå‘é”å‡çº§åˆ°è½»é‡çº§é”ï¼Œå†å‡çº§çš„é‡é‡çº§é”ï¼ˆä½†æ˜¯é”çš„å‡çº§æ˜¯å•å‘çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½ä»ä½åˆ°é«˜å‡çº§ï¼Œä¸ä¼šå‡ºç°é”çš„é™çº§ï¼‰ã€‚JDK 1.6ä¸­é»˜è®¤æ˜¯å¼€å¯åå‘é”å’Œè½»é‡çº§é”çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡-XX:-UseBiasedLockingæ¥ç¦ç”¨åå‘é”ã€‚é”çš„çŠ¶æ€ä¿å­˜åœ¨å¯¹è±¡çš„å¤´æ–‡ä»¶ä¸­ï¼Œä»¥32ä½çš„JDKä¸ºä¾‹ï¼š â€œè½»é‡çº§â€æ˜¯ç›¸å¯¹äºä½¿ç”¨æ“ä½œç³»ç»Ÿäº’æ–¥é‡æ¥å®ç°çš„ä¼ ç»Ÿé”è€Œè¨€çš„ã€‚ä½†æ˜¯ï¼Œé¦–å…ˆéœ€è¦å¼ºè°ƒä¸€ç‚¹çš„æ˜¯ï¼Œè½»é‡çº§é”å¹¶ä¸æ˜¯ç”¨æ¥ä»£æ›¿é‡é‡çº§é”çš„ï¼Œå®ƒçš„æœ¬æ„æ˜¯åœ¨æ²¡æœ‰å¤šçº¿ç¨‹ç«äº‰çš„å‰æä¸‹ï¼Œå‡å°‘ä¼ ç»Ÿçš„é‡é‡çº§é”ä½¿ç”¨äº§ç”Ÿçš„æ€§èƒ½æ¶ˆè€—ã€‚åœ¨è§£é‡Šè½»é‡çº§é”çš„æ‰§è¡Œè¿‡ç¨‹ä¹‹å‰ï¼Œå…ˆæ˜ç™½ä¸€ç‚¹ï¼Œè½»é‡çº§é”æ‰€é€‚åº”çš„åœºæ™¯æ˜¯çº¿ç¨‹äº¤æ›¿æ‰§è¡ŒåŒæ­¥å—çš„æƒ…å†µï¼Œå¦‚æœå­˜åœ¨åŒä¸€æ—¶é—´è®¿é—®åŒä¸€é”çš„æƒ…å†µï¼Œå°±ä¼šå¯¼è‡´è½»é‡çº§é”è†¨èƒ€ä¸ºé‡é‡çº§é”ã€‚ å¤šçº¿ç¨‹ä¸­ synchronized é”å‡çº§çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ synchronized é”å‡çº§åŸç†ï¼šåœ¨é”å¯¹è±¡çš„å¯¹è±¡å¤´é‡Œé¢æœ‰ä¸€ä¸ª threadid å­—æ®µï¼Œåœ¨ç¬¬ä¸€æ¬¡è®¿é—®çš„æ—¶å€™ threadid ä¸ºç©ºï¼Œjvm è®©å…¶æŒæœ‰åå‘é”ï¼Œå¹¶å°† threadid è®¾ç½®ä¸ºå…¶çº¿ç¨‹ idï¼Œå†æ¬¡è¿›å…¥çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­ threadid æ˜¯å¦ä¸å…¶çº¿ç¨‹ id ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´åˆ™å¯ä»¥ç›´æ¥ä½¿ç”¨æ­¤å¯¹è±¡ï¼Œå¦‚æœä¸ä¸€è‡´ï¼Œåˆ™å‡çº§åå‘é”ä¸ºè½»é‡çº§é”ï¼Œé€šè¿‡è‡ªæ—‹å¾ªç¯ä¸€å®šæ¬¡æ•°æ¥è·å–é”ï¼Œæ‰§è¡Œä¸€å®šæ¬¡æ•°ä¹‹åï¼Œå¦‚æœè¿˜æ²¡æœ‰æ­£å¸¸è·å–åˆ°è¦ä½¿ç”¨çš„å¯¹è±¡ï¼Œæ­¤æ—¶å°±ä¼šæŠŠé”ä»è½»é‡çº§å‡çº§ä¸ºé‡é‡çº§é”ï¼Œæ­¤è¿‡ç¨‹å°±æ„æˆäº† synchronized é”çš„å‡çº§ã€‚ é”çš„å‡çº§çš„ç›®çš„ï¼šé”å‡çº§æ˜¯ä¸ºäº†å‡ä½äº†é”å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—ã€‚åœ¨ Java 6 ä¹‹åä¼˜åŒ– synchronized çš„å®ç°æ–¹å¼ï¼Œä½¿ç”¨äº†åå‘é”å‡çº§ä¸ºè½»é‡çº§é”å†å‡çº§åˆ°é‡é‡çº§é”çš„æ–¹å¼ï¼Œä»è€Œå‡ä½äº†é”å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—ã€‚ é‡é‡çº§é”ã€è½»é‡çº§é”å’Œåå‘é”ä¹‹é—´è½¬æ¢å›¾ çº¿ç¨‹ B æ€ä¹ˆçŸ¥é“çº¿ç¨‹ A ä¿®æ”¹äº†å˜é‡ ï¼ˆ1ï¼‰volatile ä¿®é¥°å˜é‡ ï¼ˆ2ï¼‰synchronized ä¿®é¥°ä¿®æ”¹å˜é‡çš„æ–¹æ³• ï¼ˆ3ï¼‰wait/notify ï¼ˆ4ï¼‰while è½®è¯¢ å½“ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ä¸€ä¸ªå¯¹è±¡çš„ synchronized æ–¹æ³• A ä¹‹åï¼Œå…¶å®ƒçº¿ç¨‹æ˜¯å¦å¯è¿›å…¥æ­¤å¯¹è±¡çš„ synchronized æ–¹æ³• Bï¼Ÿ ä¸èƒ½ã€‚å…¶å®ƒçº¿ç¨‹åªèƒ½è®¿é—®è¯¥å¯¹è±¡çš„éåŒæ­¥æ–¹æ³•ï¼ŒåŒæ­¥æ–¹æ³•åˆ™ä¸èƒ½è¿›å…¥ã€‚å› ä¸ºéé™æ€æ–¹æ³•ä¸Šçš„ synchronized ä¿®é¥°ç¬¦è¦æ±‚æ‰§è¡Œæ–¹æ³•æ—¶è¦è·å¾—å¯¹è±¡çš„é”ï¼Œå¦‚æœå·²ç»è¿›å…¥A æ–¹æ³•è¯´æ˜å¯¹è±¡é”å·²ç»è¢«å–èµ°ï¼Œé‚£ä¹ˆè¯•å›¾è¿›å…¥ B æ–¹æ³•çš„çº¿ç¨‹å°±åªèƒ½åœ¨ç­‰é”æ± ï¼ˆæ³¨æ„ä¸æ˜¯ç­‰å¾…æ± å“¦ï¼‰ä¸­ç­‰å¾…å¯¹è±¡çš„é”ã€‚ synchronizedã€volatileã€CAS æ¯”è¾ƒ ï¼ˆ1ï¼‰synchronized æ˜¯æ‚²è§‚é”ï¼Œå±äºæŠ¢å å¼ï¼Œä¼šå¼•èµ·å…¶ä»–çº¿ç¨‹é˜»å¡ã€‚ ï¼ˆ2ï¼‰volatile æä¾›å¤šçº¿ç¨‹å…±äº«å˜é‡å¯è§æ€§å’Œç¦æ­¢æŒ‡ä»¤é‡æ’åºä¼˜åŒ–ã€‚ ï¼ˆ3ï¼‰CAS æ˜¯åŸºäºå†²çªæ£€æµ‹çš„ä¹è§‚é”ï¼ˆéé˜»å¡ï¼‰ synchronized å’Œ Lock æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ é¦–å…ˆsynchronizedæ˜¯Javaå†…ç½®å…³é”®å­—ï¼Œåœ¨JVMå±‚é¢ï¼ŒLockæ˜¯ä¸ªJavaç±»ï¼› synchronized å¯ä»¥ç»™ç±»ã€æ–¹æ³•ã€ä»£ç å—åŠ é”ï¼›è€Œ lock åªèƒ½ç»™ä»£ç å—åŠ é”ã€‚ synchronized ä¸éœ€è¦æ‰‹åŠ¨è·å–é”å’Œé‡Šæ”¾é”ï¼Œä½¿ç”¨ç®€å•ï¼Œå‘ç”Ÿå¼‚å¸¸ä¼šè‡ªåŠ¨é‡Šæ”¾é”ï¼Œä¸ä¼šé€ æˆæ­»é”ï¼›è€Œ lock éœ€è¦è‡ªå·±åŠ é”å’Œé‡Šæ”¾é”ï¼Œå¦‚æœä½¿ç”¨ä¸å½“æ²¡æœ‰ unLock()å»é‡Šæ”¾é”å°±ä¼šé€ æˆæ­»é”ã€‚ é€šè¿‡ Lock å¯ä»¥çŸ¥é“æœ‰æ²¡æœ‰æˆåŠŸè·å–é”ï¼Œè€Œ synchronized å´æ— æ³•åŠåˆ°ã€‚ synchronized å’Œ ReentrantLock åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ synchronized æ˜¯å’Œ ifã€elseã€forã€while ä¸€æ ·çš„å…³é”®å­—ï¼ŒReentrantLock æ˜¯ç±»ï¼Œè¿™æ˜¯äºŒè€…çš„æœ¬è´¨åŒºåˆ«ã€‚æ—¢ç„¶ ReentrantLock æ˜¯ç±»ï¼Œé‚£ä¹ˆå®ƒå°±æä¾›äº†æ¯”synchronized æ›´å¤šæ›´çµæ´»çš„ç‰¹æ€§ï¼Œå¯ä»¥è¢«ç»§æ‰¿ã€å¯ä»¥æœ‰æ–¹æ³•ã€å¯ä»¥æœ‰å„ç§å„æ ·çš„ç±»å˜é‡ synchronized æ—©æœŸçš„å®ç°æ¯”è¾ƒä½æ•ˆï¼Œå¯¹æ¯” ReentrantLockï¼Œå¤§å¤šæ•°åœºæ™¯æ€§èƒ½éƒ½ç›¸å·®è¾ƒå¤§ï¼Œä½†æ˜¯åœ¨ Java 6 ä¸­å¯¹ synchronized è¿›è¡Œäº†éå¸¸å¤šçš„æ”¹è¿›ã€‚ ç›¸åŒç‚¹ï¼šä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é” ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”ã€‚â€œå¯é‡å…¥é”â€æ¦‚å¿µæ˜¯ï¼šè‡ªå·±å¯ä»¥å†æ¬¡è·å–è‡ªå·±çš„å†…éƒ¨é”ã€‚æ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹è·å¾—äº†æŸä¸ªå¯¹è±¡çš„é”ï¼Œæ­¤æ—¶è¿™ä¸ªå¯¹è±¡é”è¿˜æ²¡æœ‰é‡Šæ”¾ï¼Œå½“å…¶å†æ¬¡æƒ³è¦è·å–è¿™ä¸ªå¯¹è±¡çš„é”çš„æ—¶å€™è¿˜æ˜¯å¯ä»¥è·å–çš„ï¼Œå¦‚æœä¸å¯é”é‡å…¥çš„è¯ï¼Œå°±ä¼šé€ æˆæ­»é”ã€‚åŒä¸€ä¸ªçº¿ç¨‹æ¯æ¬¡è·å–é”ï¼Œé”çš„è®¡æ•°å™¨éƒ½è‡ªå¢1ï¼Œæ‰€ä»¥è¦ç­‰åˆ°é”çš„è®¡æ•°å™¨ä¸‹é™ä¸º0æ—¶æ‰èƒ½é‡Šæ”¾é”ã€‚ ä¸»è¦åŒºåˆ«å¦‚ä¸‹ï¼š ReentrantLock ä½¿ç”¨èµ·æ¥æ¯”è¾ƒçµæ´»ï¼Œä½†æ˜¯å¿…é¡»æœ‰é‡Šæ”¾é”çš„é…åˆåŠ¨ä½œï¼› ReentrantLock å¿…é¡»æ‰‹åŠ¨è·å–ä¸é‡Šæ”¾é”ï¼Œè€Œ synchronized ä¸éœ€è¦æ‰‹åŠ¨é‡Šæ”¾å’Œå¼€å¯é”ï¼› ReentrantLock åªé€‚ç”¨äºä»£ç å—é”ï¼Œè€Œ synchronized å¯ä»¥ä¿®é¥°ç±»ã€æ–¹æ³•ã€å˜é‡ç­‰ã€‚ äºŒè€…çš„é”æœºåˆ¶å…¶å®ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ã€‚ReentrantLock åº•å±‚è°ƒç”¨çš„æ˜¯ Unsafe çš„park æ–¹æ³•åŠ é”ï¼Œsynchronized æ“ä½œçš„åº”è¯¥æ˜¯å¯¹è±¡å¤´ä¸­ mark word Javaä¸­æ¯ä¸€ä¸ªå¯¹è±¡éƒ½å¯ä»¥ä½œä¸ºé”ï¼Œè¿™æ˜¯synchronizedå®ç°åŒæ­¥çš„åŸºç¡€ï¼š æ™®é€šåŒæ­¥æ–¹æ³•ï¼Œé”æ˜¯å½“å‰å®ä¾‹å¯¹è±¡ é™æ€åŒæ­¥æ–¹æ³•ï¼Œé”æ˜¯å½“å‰ç±»çš„classå¯¹è±¡ åŒæ­¥æ–¹æ³•å—ï¼Œé”æ˜¯æ‹¬å·é‡Œé¢çš„å¯¹è±¡ å°½å¯èƒ½å»ä½¿ç”¨synchronizedè€Œä¸è¦å»ä½¿ç”¨LOCK ä»€ä¹ˆæ¦‚å¿µå‘¢ï¼Ÿæˆ‘å’Œå¤§å®¶æ‰“ä¸ªæ¯”æ–¹ï¼šä½ å«jdkï¼Œä½ ç”Ÿäº†ä¸€ä¸ªå­©å­å«synchronizedï¼Œåæ¥å‘¢ï¼Œä½ é¢†å…»äº†ä¸€ä¸ªå­©å­å«LOCKã€‚èµ·åˆï¼ŒLOCKåˆšæ¥åˆ°æ–°å®¶çš„æ—¶å€™ï¼Œå®ƒå¾ˆä¹–ï¼Œå¾ˆæ‡‚äº‹ï¼Œå„ä¸ªæ–¹é¢éƒ½è¡¨ç°çš„æ¯”synchronizedå¥½ã€‚ä½ å¾ˆå¼€å¿ƒï¼Œä½†æ˜¯ä½ å†…å¿ƒæ·±å¤„åˆæœ‰ä¸€ç‚¹æ·¡æ·¡çš„å¿§ä¼¤ï¼Œä½ ä¸å¸Œæœ›ä½ è‡ªå·±äº²ç”Ÿçš„å­©å­ç«Ÿç„¶è¿˜ä¸å¦‚ä¸€ä¸ªé¢†å…»çš„å­©å­ä¹–å·§ã€‚è¿™ä¸ªæ—¶å€™ï¼Œä½ å¯¹äº²ç”Ÿçš„å­©å­æ•™è‚²æ›´åŠ æ·±åˆ»äº†ï¼Œä½ æƒ³è¯æ˜ï¼Œä½ çš„äº²ç”Ÿå­©å­synchronizedå¹¶ä¸ä¼šæ¯”é¢†å…»çš„å­©å­LOCKå·®ã€‚ é‚£å¦‚ä½•æ•™è‚²å‘¢ï¼Ÿ åœ¨jdk1.6~jdk1.7çš„æ—¶å€™ï¼Œä½ ä½œä¸ºçˆ¸çˆ¸ï¼Œä½ ç»™ä»–ä¼˜åŒ–äº†ï¼Œå…·ä½“ä¼˜åŒ–åœ¨å“ªé‡Œå‘¢ï¼š çº¿ç¨‹è‡ªæ—‹å’Œé€‚åº”æ€§è‡ªæ—‹ æˆ‘ä»¬çŸ¥é“ï¼Œjavaâ€™çº¿ç¨‹å…¶å®æ˜¯æ˜ å°„åœ¨å†…æ ¸ä¹‹ä¸Šçš„ï¼Œçº¿ç¨‹çš„æŒ‚èµ·å’Œæ¢å¤ä¼šæå¤§çš„å½±å“å¼€é”€ã€‚å¹¶ä¸”jdkå®˜æ–¹äººå‘˜å‘ç°ï¼Œå¾ˆå¤šçº¿ç¨‹åœ¨ç­‰å¾…é”çš„æ—¶å€™ï¼Œåœ¨å¾ˆçŸ­çš„ä¸€æ®µæ—¶é—´å°±è·å¾—äº†é”ï¼Œæ‰€ä»¥å®ƒä»¬åœ¨çº¿ç¨‹ç­‰å¾…çš„æ—¶å€™ï¼Œå¹¶ä¸éœ€è¦æŠŠçº¿ç¨‹æŒ‚èµ·ï¼Œè€Œæ˜¯è®©ä»–æ— ç›®çš„çš„å¾ªç¯ï¼Œä¸€èˆ¬è®¾ç½®10æ¬¡ã€‚è¿™æ ·å°±é¿å…äº†çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ï¼Œæå¤§çš„æå‡äº†æ€§èƒ½ã€‚ è€Œé€‚åº”æ€§è‡ªæ—‹ï¼Œæ˜¯èµ‹äºˆäº†è‡ªæ—‹ä¸€ç§å­¦ä¹ èƒ½åŠ›ï¼Œå®ƒå¹¶ä¸å›ºå®šè‡ªæ—‹10æ¬¡ä¸€ä¸‹ã€‚ä»–å¯ä»¥æ ¹æ®å®ƒå‰é¢çº¿ç¨‹çš„è‡ªæ—‹æƒ…å†µï¼Œä»è€Œè°ƒæ•´å®ƒçš„è‡ªæ—‹ï¼Œç”šè‡³æ˜¯ä¸ç»è¿‡è‡ªæ—‹è€Œç›´æ¥æŒ‚èµ·ã€‚ é”æ¶ˆé™¤ ä»€ä¹ˆå«é”æ¶ˆé™¤å‘¢ï¼Ÿå°±æ˜¯æŠŠä¸å¿…è¦çš„åŒæ­¥åœ¨ç¼–è¯‘é˜¶æ®µè¿›è¡Œç§»é™¤ã€‚ é‚£ä¹ˆæœ‰çš„å°ä¼™ä¼´åˆè¿·ç³Šäº†ï¼Œæˆ‘è‡ªå·±å†™çš„ä»£ç æˆ‘ä¼šä¸çŸ¥é“è¿™é‡Œè¦ä¸è¦åŠ é”ï¼Ÿæˆ‘åŠ äº†é”å°±æ˜¯è¡¨ç¤ºè¿™è¾¹ä¼šæœ‰åŒæ­¥å‘€ï¼Ÿ å¹¶ä¸æ˜¯è¿™æ ·ï¼Œè¿™é‡Œæ‰€è¯´çš„é”æ¶ˆé™¤å¹¶ä¸ä¸€å®šæŒ‡ä»£æ˜¯ä½ å†™çš„ä»£ç çš„é”æ¶ˆé™¤ï¼Œæˆ‘æ‰“ä¸€ä¸ªæ¯”æ–¹ï¼š åœ¨jdk1.5ä»¥å‰ï¼Œæˆ‘ä»¬çš„Stringå­—ç¬¦ä¸²æ‹¼æ¥æ“ä½œå…¶å®åº•å±‚æ˜¯StringBufferæ¥å®ç°çš„ï¼ˆå†™ä¸€ä¸ªç®€å•çš„demoï¼Œç„¶åæŸ¥çœ‹classæ–‡ä»¶ä¸­çš„å­—èŠ‚ç æŒ‡ä»¤å°±æ¸…æ¥šäº†ï¼‰ï¼Œè€Œåœ¨jdk1.5ä¹‹åï¼Œé‚£ä¹ˆæ˜¯ç”¨StringBuilderæ¥æ‹¼æ¥çš„ã€‚æˆ‘ä»¬è€ƒè™‘å‰é¢çš„æƒ…å†µï¼Œæ¯”å¦‚å¦‚ä¸‹ä»£ç ï¼š String str1=&quot;qwe&quot;; String str2=&quot;asd&quot;; String str3=str1+str2; åº•å±‚å®ç°ä¼šå˜æˆè¿™æ ·ï¼š StringBuffer sb = new StringBuffer(); sb.append(&quot;qwe&quot;); sb.append(&quot;asd&quot;); æˆ‘ä»¬çŸ¥é“ï¼ŒStringBufferæ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ç±»ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸¤ä¸ªappendæ–¹æ³•éƒ½ä¼šåŒæ­¥ï¼Œé€šè¿‡æŒ‡é’ˆé€ƒé€¸åˆ†æï¼ˆå°±æ˜¯å˜é‡ä¸ä¼šå¤–æ³„ï¼‰ï¼Œæˆ‘ä»¬å‘ç°åœ¨è¿™æ®µä»£ç å¹¶ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šæŠŠè¿™ä¸ªåŒæ­¥é”æ¶ˆé™¤ã€‚ é”ç²—åŒ– åœ¨ç”¨synchronizedçš„æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½è®²ç©¶ä¸ºäº†é¿å…å¤§å¼€é”€ï¼Œå°½é‡åŒæ­¥ä»£ç å—è¦å°ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆè¿˜è¦åŠ ç²—å‘¢ï¼Ÿ æˆ‘ä»¬ç»§ç»­ä»¥ä¸Šé¢çš„å­—ç¬¦ä¸²æ‹¼æ¥ä¸ºä¾‹ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨è¿™ä¸€æ®µä»£ç ä¸­ï¼Œæ¯ä¸€ä¸ªappendéƒ½éœ€è¦åŒæ­¥ä¸€æ¬¡ï¼Œé‚£ä¹ˆæˆ‘å¯ä»¥æŠŠé”ç²—åŒ–åˆ°ç¬¬ä¸€ä¸ªappendå’Œæœ€åä¸€ä¸ªappendï¼ˆè¿™é‡Œä¸è¦å»çº ç»“å‰é¢çš„é”æ¶ˆé™¤ï¼Œæˆ‘åªæ˜¯æ‰“ä¸ªæ¯”æ–¹ï¼‰ è½»é‡çº§é” è½»é‡çº§é”çš„åŠ é”è¿‡ç¨‹ ï¼ˆ1ï¼‰åœ¨ä»£ç è¿›å…¥åŒæ­¥å—çš„æ—¶å€™ï¼Œå¦‚æœåŒæ­¥å¯¹è±¡é”çŠ¶æ€ä¸ºæ— é”çŠ¶æ€ï¼ˆé”æ ‡å¿—ä½ä¸ºâ€œ01â€çŠ¶æ€ï¼Œæ˜¯å¦ä¸ºåå‘é”ä¸ºâ€œ0â€ï¼‰ï¼Œè™šæ‹Ÿæœºé¦–å…ˆå°†åœ¨å½“å‰çº¿ç¨‹çš„æ ˆå¸§ä¸­å»ºç«‹ä¸€ä¸ªåä¸ºé”è®°å½•ï¼ˆLock Recordï¼‰çš„ç©ºé—´ï¼Œç”¨äºå­˜å‚¨é”å¯¹è±¡ç›®å‰çš„Mark Wordçš„æ‹·è´ï¼Œå®˜æ–¹ç§°ä¹‹ä¸º Displaced Mark Wordã€‚è¿™æ—¶å€™çº¿ç¨‹å †æ ˆä¸å¯¹è±¡å¤´çš„çŠ¶æ€å¦‚å›¾2.1æ‰€ç¤ºã€‚ ï¼ˆ2ï¼‰æ‹·è´å¯¹è±¡å¤´ä¸­çš„Mark Wordå¤åˆ¶åˆ°é”è®°å½•ä¸­ã€‚ ï¼ˆ3ï¼‰æ‹·è´æˆåŠŸåï¼Œè™šæ‹Ÿæœºå°†ä½¿ç”¨CASæ“ä½œå°è¯•å°†å¯¹è±¡çš„Mark Wordæ›´æ–°ä¸ºæŒ‡å‘Lock Recordçš„æŒ‡é’ˆï¼Œå¹¶å°†Lock recordé‡Œçš„owneræŒ‡é’ˆæŒ‡å‘object mark wordã€‚å¦‚æœæ›´æ–°æˆåŠŸï¼Œåˆ™æ‰§è¡Œæ­¥éª¤ï¼ˆ3ï¼‰ï¼Œå¦åˆ™æ‰§è¡Œæ­¥éª¤ï¼ˆ4ï¼‰ã€‚ ï¼ˆ4ï¼‰å¦‚æœè¿™ä¸ªæ›´æ–°åŠ¨ä½œæˆåŠŸäº†ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±æ‹¥æœ‰äº†è¯¥å¯¹è±¡çš„é”ï¼Œå¹¶ä¸”å¯¹è±¡Mark Wordçš„é”æ ‡å¿—ä½è®¾ç½®ä¸ºâ€œ00â€ï¼Œå³è¡¨ç¤ºæ­¤å¯¹è±¡å¤„äºè½»é‡çº§é”å®šçŠ¶æ€ï¼Œè¿™æ—¶å€™çº¿ç¨‹å †æ ˆä¸å¯¹è±¡å¤´çš„çŠ¶æ€å¦‚å›¾2.2æ‰€ç¤ºã€‚ ï¼ˆ5ï¼‰å¦‚æœè¿™ä¸ªæ›´æ–°æ“ä½œå¤±è´¥äº†ï¼Œè™šæ‹Ÿæœºé¦–å…ˆä¼šæ£€æŸ¥å¯¹è±¡çš„Mark Wordæ˜¯å¦æŒ‡å‘å½“å‰çº¿ç¨‹çš„æ ˆå¸§ï¼Œå¦‚æœæ˜¯å°±è¯´æ˜å½“å‰çº¿ç¨‹å·²ç»æ‹¥æœ‰äº†è¿™ä¸ªå¯¹è±¡çš„é”ï¼Œé‚£å°±å¯ä»¥ç›´æ¥è¿›å…¥åŒæ­¥å—ç»§ç»­æ‰§è¡Œã€‚å¦åˆ™è¯´æ˜å¤šä¸ªçº¿ç¨‹ç«äº‰é”ï¼Œè½»é‡çº§é”å°±è¦è†¨èƒ€ä¸ºé‡é‡çº§é”ï¼Œé”æ ‡å¿—çš„çŠ¶æ€å€¼å˜ä¸ºâ€œ10â€ï¼ŒMark Wordä¸­å­˜å‚¨çš„å°±æ˜¯æŒ‡å‘é‡é‡çº§é”ï¼ˆäº’æ–¥é‡ï¼‰çš„æŒ‡é’ˆï¼Œåé¢ç­‰å¾…é”çš„çº¿ç¨‹ä¹Ÿè¦è¿›å…¥é˜»å¡çŠ¶æ€ã€‚ è€Œå½“å‰çº¿ç¨‹ä¾¿å°è¯•ä½¿ç”¨è‡ªæ—‹æ¥è·å–é”ï¼Œè‡ªæ—‹å°±æ˜¯ä¸ºäº†ä¸è®©çº¿ç¨‹é˜»å¡ï¼Œè€Œé‡‡ç”¨å¾ªç¯å»è·å–é”çš„è¿‡ç¨‹ã€‚ â€‹ å›¾2.1 è½»é‡çº§é”CASæ“ä½œä¹‹å‰å †æ ˆä¸å¯¹è±¡çš„çŠ¶æ€ â€‹ å›¾2.2 è½»é‡çº§é”CASæ“ä½œä¹‹åå †æ ˆä¸å¯¹è±¡çš„çŠ¶æ€ è½»é‡çº§é”çš„è§£é”è¿‡ç¨‹ï¼š ï¼ˆ1ï¼‰é€šè¿‡CASæ“ä½œå°è¯•æŠŠçº¿ç¨‹ä¸­å¤åˆ¶çš„Displaced Mark Wordå¯¹è±¡æ›¿æ¢å½“å‰çš„Mark Wordã€‚ ï¼ˆ2ï¼‰å¦‚æœæ›¿æ¢æˆåŠŸï¼Œæ•´ä¸ªåŒæ­¥è¿‡ç¨‹å°±å®Œæˆäº†ã€‚ ï¼ˆ3ï¼‰å¦‚æœæ›¿æ¢å¤±è´¥ï¼Œè¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹å°è¯•è¿‡è·å–è¯¥é”ï¼ˆæ­¤æ—¶é”å·²è†¨èƒ€ï¼‰ï¼Œé‚£å°±è¦åœ¨é‡Šæ”¾é”çš„åŒæ—¶ï¼Œå”¤é†’è¢«æŒ‚èµ·çš„çº¿ç¨‹ã€‚ åå‘é” å¼•å…¥åå‘é”æ˜¯ä¸ºäº†åœ¨æ— å¤šçº¿ç¨‹ç«äº‰çš„æƒ…å†µä¸‹å°½é‡å‡å°‘ä¸å¿…è¦çš„è½»é‡çº§é”æ‰§è¡Œè·¯å¾„ï¼Œå› ä¸ºè½»é‡çº§é”çš„è·å–åŠé‡Šæ”¾ä¾èµ–å¤šæ¬¡CASåŸå­æŒ‡ä»¤ï¼Œè€Œåå‘é”åªéœ€è¦åœ¨ç½®æ¢ThreadIDçš„æ—¶å€™ä¾èµ–ä¸€æ¬¡CASåŸå­æŒ‡ä»¤ï¼ˆç”±äºä¸€æ—¦å‡ºç°å¤šçº¿ç¨‹ç«äº‰çš„æƒ…å†µå°±å¿…é¡»æ’¤é”€åå‘é”ï¼Œæ‰€ä»¥åå‘é”çš„æ’¤é”€æ“ä½œçš„æ€§èƒ½æŸè€—å¿…é¡»å°äºèŠ‚çœä¸‹æ¥çš„CASåŸå­æŒ‡ä»¤çš„æ€§èƒ½æ¶ˆè€—ï¼‰ã€‚ä¸Šé¢è¯´è¿‡ï¼Œè½»é‡çº§é”æ˜¯ä¸ºäº†åœ¨çº¿ç¨‹äº¤æ›¿æ‰§è¡ŒåŒæ­¥å—æ—¶æé«˜æ€§èƒ½ï¼Œè€Œåå‘é”åˆ™æ˜¯åœ¨åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒåŒæ­¥å—æ—¶è¿›ä¸€æ­¥æé«˜æ€§èƒ½ã€‚ 1ã€åå‘é”è·å–è¿‡ç¨‹ï¼š ï¼ˆ1ï¼‰è®¿é—®Mark Wordä¸­åå‘é”çš„æ ‡è¯†æ˜¯å¦è®¾ç½®æˆ1ï¼Œé”æ ‡å¿—ä½æ˜¯å¦ä¸º01â€”â€”ç¡®è®¤ä¸ºå¯åå‘çŠ¶æ€ã€‚ ï¼ˆ2ï¼‰å¦‚æœä¸ºå¯åå‘çŠ¶æ€ï¼Œåˆ™æµ‹è¯•çº¿ç¨‹IDæ˜¯å¦æŒ‡å‘å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯ï¼Œè¿›å…¥æ­¥éª¤ï¼ˆ5ï¼‰ï¼Œå¦åˆ™è¿›å…¥æ­¥éª¤ï¼ˆ3ï¼‰ã€‚ ï¼ˆ3ï¼‰å¦‚æœçº¿ç¨‹IDå¹¶æœªæŒ‡å‘å½“å‰çº¿ç¨‹ï¼Œåˆ™é€šè¿‡CASæ“ä½œç«äº‰é”ã€‚å¦‚æœç«äº‰æˆåŠŸï¼Œåˆ™å°†Mark Wordä¸­çº¿ç¨‹IDè®¾ç½®ä¸ºå½“å‰çº¿ç¨‹IDï¼Œç„¶åæ‰§è¡Œï¼ˆ5ï¼‰ï¼›å¦‚æœç«äº‰å¤±è´¥ï¼Œæ‰§è¡Œï¼ˆ4ï¼‰ã€‚ ï¼ˆ4ï¼‰å¦‚æœCASè·å–åå‘é”å¤±è´¥ï¼Œåˆ™è¡¨ç¤ºæœ‰ç«äº‰ã€‚å½“åˆ°è¾¾å…¨å±€å®‰å…¨ç‚¹ï¼ˆsafepointï¼‰æ—¶è·å¾—åå‘é”çš„çº¿ç¨‹è¢«æŒ‚èµ·ï¼Œåå‘é”å‡çº§ä¸ºè½»é‡çº§é”ï¼Œç„¶åè¢«é˜»å¡åœ¨å®‰å…¨ç‚¹çš„çº¿ç¨‹ç»§ç»­å¾€ä¸‹æ‰§è¡ŒåŒæ­¥ä»£ç ã€‚ ï¼ˆ5ï¼‰æ‰§è¡ŒåŒæ­¥ä»£ç ã€‚ 2ã€åå‘é”çš„é‡Šæ”¾ï¼š åå‘é”çš„æ’¤é”€åœ¨ä¸Šè¿°ç¬¬å››æ­¥éª¤ä¸­æœ‰æåˆ°**ã€‚**åå‘é”åªæœ‰é‡åˆ°å…¶ä»–çº¿ç¨‹å°è¯•ç«äº‰åå‘é”æ—¶ï¼ŒæŒæœ‰åå‘é”çš„çº¿ç¨‹æ‰ä¼šé‡Šæ”¾é”ï¼Œçº¿ç¨‹ä¸ä¼šä¸»åŠ¨å»é‡Šæ”¾åå‘é”ã€‚åå‘é”çš„æ’¤é”€ï¼Œéœ€è¦ç­‰å¾…å…¨å±€å®‰å…¨ç‚¹ï¼ˆåœ¨è¿™ä¸ªæ—¶é—´ç‚¹ä¸Šæ²¡æœ‰å­—èŠ‚ç æ­£åœ¨æ‰§è¡Œï¼‰ï¼Œå®ƒä¼šé¦–å…ˆæš‚åœæ‹¥æœ‰åå‘é”çš„çº¿ç¨‹ï¼Œåˆ¤æ–­é”å¯¹è±¡æ˜¯å¦å¤„äºè¢«é”å®šçŠ¶æ€ï¼Œæ’¤é”€åå‘é”åæ¢å¤åˆ°æœªé”å®šï¼ˆæ ‡å¿—ä½ä¸ºâ€œ01â€ï¼‰æˆ–è½»é‡çº§é”ï¼ˆæ ‡å¿—ä½ä¸ºâ€œ00â€ï¼‰çš„çŠ¶æ€ã€‚ volatile å¯¹äºå¯è§æ€§ï¼ŒJava æä¾›äº† volatile å…³é”®å­—æ¥ä¿è¯å¯è§æ€§å’Œç¦æ­¢æŒ‡ä»¤é‡æ’ã€‚ volatile æä¾› happens-before çš„ä¿è¯ï¼Œç¡®ä¿ä¸€ä¸ªçº¿ç¨‹çš„ä¿®æ”¹èƒ½å¯¹å…¶ä»–çº¿ç¨‹æ˜¯å¯è§çš„ã€‚å½“ä¸€ä¸ªå…±äº«å˜é‡è¢« volatile ä¿®é¥°æ—¶ï¼Œå®ƒä¼šä¿è¯ä¿®æ”¹çš„å€¼ä¼šç«‹å³è¢«æ›´æ–°åˆ°ä¸»å­˜ï¼Œå½“æœ‰å…¶ä»–çº¿ç¨‹éœ€è¦è¯»å–æ—¶ï¼Œå®ƒä¼šå»å†…å­˜ä¸­è¯»å–æ–°å€¼ã€‚ ä»å®è·µè§’åº¦è€Œè¨€ï¼Œvolatile çš„ä¸€ä¸ªé‡è¦ä½œç”¨å°±æ˜¯å’Œ CAS ç»“åˆï¼Œä¿è¯äº†åŸå­æ€§ï¼Œè¯¦ç»†çš„å¯ä»¥å‚è§ java.util.concurrent.atomic åŒ…ä¸‹çš„ç±»ï¼Œæ¯”å¦‚ AtomicIntegerã€‚ volatile å¸¸ç”¨äºå¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„å•æ¬¡æ“ä½œ(å•æ¬¡è¯»æˆ–è€…å•æ¬¡å†™)ã€‚ Java ä¸­èƒ½åˆ›å»º volatile æ•°ç»„å—ï¼Ÿ èƒ½ï¼ŒJava ä¸­å¯ä»¥åˆ›å»º volatile ç±»å‹æ•°ç»„ï¼Œä¸è¿‡åªæ˜¯ä¸€ä¸ªæŒ‡å‘æ•°ç»„çš„å¼•ç”¨ï¼Œè€Œä¸æ˜¯æ•´ä¸ªæ•°ç»„ã€‚æ„æ€æ˜¯ï¼Œå¦‚æœæ”¹å˜å¼•ç”¨æŒ‡å‘çš„æ•°ç»„ï¼Œå°†ä¼šå—åˆ° volatile çš„ä¿æŠ¤ï¼Œä½†æ˜¯å¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶æ”¹å˜æ•°ç»„çš„å…ƒç´ ï¼Œvolatile æ ‡ç¤ºç¬¦å°±ä¸èƒ½èµ·åˆ°ä¹‹å‰çš„ä¿æŠ¤ä½œç”¨äº†ã€‚ volatile å˜é‡å’Œ atomic å˜é‡æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ volatile å˜é‡å¯ä»¥ç¡®ä¿å…ˆè¡Œå…³ç³»ï¼Œå³å†™æ“ä½œä¼šå‘ç”Ÿåœ¨åç»­çš„è¯»æ“ä½œä¹‹å‰, ä½†å®ƒå¹¶ä¸èƒ½ä¿è¯åŸå­æ€§ã€‚ä¾‹å¦‚ç”¨ volatile ä¿®é¥° count å˜é‡ï¼Œé‚£ä¹ˆ count++ æ“ä½œå°±ä¸æ˜¯åŸå­æ€§çš„ã€‚ è€Œ AtomicInteger ç±»æä¾›çš„ atomic æ–¹æ³•å¯ä»¥è®©è¿™ç§æ“ä½œå…·æœ‰åŸå­æ€§å¦‚getAndIncrement()æ–¹æ³•ä¼šåŸå­æ€§çš„è¿›è¡Œå¢é‡æ“ä½œæŠŠå½“å‰å€¼åŠ ä¸€ï¼Œå…¶å®ƒæ•°æ®ç±»å‹å’Œå¼•ç”¨å˜é‡ä¹Ÿå¯ä»¥è¿›è¡Œç›¸ä¼¼æ“ä½œã€‚ volatile èƒ½ä½¿å¾—ä¸€ä¸ªéåŸå­æ“ä½œå˜æˆåŸå­æ“ä½œå—ï¼Ÿ å…³é”®å­—volatileçš„ä¸»è¦ä½œç”¨æ˜¯ä½¿å˜é‡åœ¨å¤šä¸ªçº¿ç¨‹é—´å¯è§ï¼Œä½†æ— æ³•ä¿è¯åŸå­æ€§ï¼Œå¯¹äºå¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå®ä¾‹å˜é‡éœ€è¦åŠ é”è¿›è¡ŒåŒæ­¥ã€‚ è™½ç„¶volatileåªèƒ½ä¿è¯å¯è§æ€§ä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œä½†ç”¨volatileä¿®é¥°longå’Œdoubleå¯ä»¥ä¿è¯å…¶æ“ä½œåŸå­æ€§ã€‚ æ‰€ä»¥ä»Oracle Java Specé‡Œé¢å¯ä»¥çœ‹åˆ°ï¼š å¯¹äº64ä½çš„longå’Œdoubleï¼Œå¦‚æœæ²¡æœ‰è¢«volatileä¿®é¥°ï¼Œé‚£ä¹ˆå¯¹å…¶æ“ä½œå¯ä»¥ä¸æ˜¯åŸå­çš„ã€‚åœ¨æ“ä½œçš„æ—¶å€™ï¼Œå¯ä»¥åˆ†æˆä¸¤æ­¥ï¼Œæ¯æ¬¡å¯¹32ä½æ“ä½œã€‚ å¦‚æœä½¿ç”¨volatileä¿®é¥°longå’Œdoubleï¼Œé‚£ä¹ˆå…¶è¯»å†™éƒ½æ˜¯åŸå­æ“ä½œ å¯¹äº64ä½çš„å¼•ç”¨åœ°å€çš„è¯»å†™ï¼Œéƒ½æ˜¯åŸå­æ“ä½œ åœ¨å®ç°JVMæ—¶ï¼Œå¯ä»¥è‡ªç”±é€‰æ‹©æ˜¯å¦æŠŠè¯»å†™longå’Œdoubleä½œä¸ºåŸå­æ“ä½œ æ¨èJVMå®ç°ä¸ºåŸå­æ“ä½œ volatile ä¿®é¥°ç¬¦çš„æœ‰è¿‡ä»€ä¹ˆå®è·µï¼Ÿ å•ä¾‹æ¨¡å¼ æ˜¯å¦ Lazy åˆå§‹åŒ–ï¼šæ˜¯ æ˜¯å¦å¤šçº¿ç¨‹å®‰å…¨ï¼šæ˜¯ å®ç°éš¾åº¦ï¼šè¾ƒå¤æ‚ æè¿°ï¼šå¯¹äºDouble-Checkè¿™ç§å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼ˆå½“ç„¶è¿™ç§æ¦‚ç‡å·²ç»éå¸¸å°äº†ï¼Œä½†æ¯•ç«Ÿè¿˜æ˜¯æœ‰çš„å˜›~ï¼‰ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯ï¼šåªéœ€è¦ç»™instanceçš„å£°æ˜åŠ ä¸Švolatileå…³é”®å­—å³å¯volatileå…³é”®å­—çš„ä¸€ä¸ªä½œç”¨æ˜¯ç¦æ­¢æŒ‡ä»¤é‡æ’ï¼ŒæŠŠinstanceå£°æ˜ä¸ºvolatileä¹‹åï¼Œå¯¹å®ƒçš„å†™æ“ä½œå°±ä¼šæœ‰ä¸€ä¸ªå†…å­˜å±éšœï¼ˆä»€ä¹ˆæ˜¯å†…å­˜å±éšœï¼Ÿï¼‰ï¼Œè¿™æ ·ï¼Œåœ¨å®ƒçš„èµ‹å€¼å®Œæˆä¹‹å‰ï¼Œå°±ä¸ç”¨ä¼šè°ƒç”¨è¯»æ“ä½œã€‚æ³¨æ„ï¼švolatileé˜»æ­¢çš„ä¸æ˜¯singleton = newSingleton()è¿™å¥è¯å†…éƒ¨[1-2-3]çš„æŒ‡ä»¤é‡æ’ï¼Œè€Œæ˜¯ä¿è¯äº†åœ¨ä¸€ä¸ªå†™æ“ä½œï¼ˆ[1-2-3]ï¼‰å®Œæˆä¹‹å‰ï¼Œä¸ä¼šè°ƒç”¨è¯»æ“ä½œï¼ˆif (instance == null)ï¼‰ã€‚ public class Singleton7 { private static volatile Singleton7 instance = null; private Singleton7() {} public static Singleton7 getInstance() { if (instance == null) { synchronized (Singleton7.class) { if (instance == null) { instance = new Singleton7(); } } } return instance; } } synchronized å’Œ volatile çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ synchronized è¡¨ç¤ºåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å–ä½œç”¨å¯¹è±¡çš„é”ï¼Œæ‰§è¡Œä»£ç ï¼Œé˜»å¡å…¶ä»–çº¿ç¨‹ã€‚ volatile è¡¨ç¤ºå˜é‡åœ¨ CPU çš„å¯„å­˜å™¨ä¸­æ˜¯ä¸ç¡®å®šçš„ï¼Œå¿…é¡»ä»ä¸»å­˜ä¸­è¯»å–ã€‚ä¿è¯å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å˜é‡çš„å¯è§æ€§ï¼›ç¦æ­¢æŒ‡ä»¤é‡æ’åºã€‚ åŒºåˆ« volatile æ˜¯å˜é‡ä¿®é¥°ç¬¦ï¼›synchronized å¯ä»¥ä¿®é¥°ç±»ã€æ–¹æ³•ã€å˜é‡ã€‚ volatile ä»…èƒ½å®ç°å˜é‡çš„ä¿®æ”¹å¯è§æ€§ï¼Œä¸èƒ½ä¿è¯åŸå­æ€§ï¼›è€Œ synchronized åˆ™å¯ä»¥ä¿è¯å˜é‡çš„ä¿®æ”¹å¯è§æ€§å’ŒåŸå­æ€§ã€‚ volatile ä¸ä¼šé€ æˆçº¿ç¨‹çš„é˜»å¡ï¼›synchronized å¯èƒ½ä¼šé€ æˆçº¿ç¨‹çš„é˜»å¡ã€‚ volatileæ ‡è®°çš„å˜é‡ä¸ä¼šè¢«ç¼–è¯‘å™¨ä¼˜åŒ–ï¼›synchronizedæ ‡è®°çš„å˜é‡å¯ä»¥è¢«ç¼–è¯‘å™¨ä¼˜åŒ–ã€‚ volatileå…³é”®å­—æ˜¯çº¿ç¨‹åŒæ­¥çš„è½»é‡çº§å®ç°ï¼Œæ‰€ä»¥volatileæ€§èƒ½è‚¯å®šæ¯”synchronizedå…³é”®å­—è¦å¥½ã€‚ä½†æ˜¯volatileå…³é”®å­—åªèƒ½ç”¨äºå˜é‡è€Œsynchronizedå…³é”®å­—å¯ä»¥ä¿®é¥°æ–¹æ³•ä»¥åŠä»£ç å—ã€‚synchronizedå…³é”®å­—åœ¨JavaSE1.6ä¹‹åè¿›è¡Œäº†ä¸»è¦åŒ…æ‹¬ä¸ºäº†å‡å°‘è·å¾—é”å’Œé‡Šæ”¾é”å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—è€Œå¼•å…¥çš„åå‘é”å’Œè½»é‡çº§é”ä»¥åŠå…¶å®ƒå„ç§ä¼˜åŒ–ä¹‹åæ‰§è¡Œæ•ˆç‡æœ‰äº†æ˜¾è‘—æå‡ï¼Œå®é™…å¼€å‘ä¸­ä½¿ç”¨ synchronized å…³é”®å­—çš„åœºæ™¯è¿˜æ˜¯æ›´å¤šä¸€äº›ã€‚ ç±»åˆ« synchronized Lock å­˜åœ¨å±‚æ¬¡ Javaçš„å…³é”®å­—ï¼Œåœ¨jvmå±‚é¢ä¸Š æ˜¯ä¸€ä¸ªç±» é”çš„é‡Šæ”¾ 1ã€å·²è·å–é”çš„çº¿ç¨‹æ‰§è¡Œå®ŒåŒæ­¥ä»£ç ï¼Œé‡Šæ”¾é” 2ã€çº¿ç¨‹æ‰§è¡Œå‘ç”Ÿå¼‚å¸¸ï¼Œjvmä¼šè®©çº¿ç¨‹é‡Šæ”¾é” åœ¨finallyä¸­å¿…é¡»é‡Šæ”¾é”ï¼Œä¸ç„¶å®¹æ˜“é€ æˆçº¿ç¨‹æ­»é” é”çš„è·å– å‡è®¾Açº¿ç¨‹è·å¾—é”ï¼ŒBçº¿ç¨‹ç­‰å¾…ã€‚å¦‚æœAçº¿ç¨‹é˜»å¡ï¼ŒBçº¿ç¨‹ä¼šä¸€ç›´ç­‰å¾… åˆ†æƒ…å†µè€Œå®šï¼ŒLockæœ‰å¤šä¸ªé”è·å–çš„æ–¹å¼ï¼Œå…·ä½“ä¸‹é¢ä¼šè¯´é“ï¼Œå¤§è‡´å°±æ˜¯å¯ä»¥å°è¯•è·å¾—é”ï¼Œçº¿ç¨‹å¯ä»¥ä¸ç”¨ä¸€ç›´ç­‰å¾… é”çŠ¶æ€ æ— æ³•åˆ¤æ–­ å¯ä»¥åˆ¤æ–­ é”ç±»å‹ å¯é‡å…¥ ä¸å¯ä¸­æ–­ éå…¬å¹³ å¯é‡å…¥ å¯åˆ¤æ–­ å¯å…¬å¹³ï¼ˆä¸¤è€…çš†å¯ï¼‰ æ€§èƒ½ å°‘é‡åŒæ­¥ å¤§é‡åŒæ­¥ final ä¸å¯å˜å¯¹è±¡(Immutable Objects)å³å¯¹è±¡ä¸€æ—¦è¢«åˆ›å»ºå®ƒçš„çŠ¶æ€ï¼ˆå¯¹è±¡çš„æ•°æ®ï¼Œä¹Ÿå³å¯¹è±¡å±æ€§å€¼ï¼‰å°±ä¸èƒ½æ”¹å˜ï¼Œåä¹‹å³ä¸ºå¯å˜å¯¹è±¡(Mutable Objects)ã€‚ ä¸å¯å˜å¯¹è±¡çš„ç±»å³ä¸ºä¸å¯å˜ç±»(Immutable Class)ã€‚Java å¹³å°ç±»åº“ä¸­åŒ…å«è®¸å¤šä¸å¯å˜ç±»ï¼Œå¦‚ Stringã€åŸºæœ¬ç±»å‹çš„åŒ…è£…ç±»ã€BigInteger å’Œ BigDecimal ç­‰ã€‚ åªæœ‰æ»¡è¶³å¦‚ä¸‹çŠ¶æ€ï¼Œä¸€ä¸ªå¯¹è±¡æ‰æ˜¯ä¸å¯å˜çš„ï¼› å®ƒçš„çŠ¶æ€ä¸èƒ½åœ¨åˆ›å»ºåå†è¢«ä¿®æ”¹ï¼› æ‰€æœ‰åŸŸéƒ½æ˜¯ final ç±»å‹ï¼›å¹¶ä¸”ï¼Œå®ƒè¢«æ­£ç¡®åˆ›å»ºï¼ˆåˆ›å»ºæœŸé—´æ²¡æœ‰å‘ç”Ÿ this å¼•ç”¨çš„é€¸å‡ºï¼‰ã€‚ ä¸å¯å˜å¯¹è±¡ä¿è¯äº†å¯¹è±¡çš„å†…å­˜å¯è§æ€§ï¼Œå¯¹ä¸å¯å˜å¯¹è±¡çš„è¯»å–ä¸éœ€è¦è¿›è¡Œé¢å¤–çš„åŒæ­¥æ‰‹æ®µï¼Œæå‡äº†ä»£ç æ‰§è¡Œæ•ˆç‡ã€‚ ","link":"https://tianxiawuhao.github.io/c-lkdzfwM/"},{"title":"å¤šçº¿ç¨‹åŸºç¡€æ¦‚å¿µäºŒ","content":"çº¿ç¨‹çš„çŠ¶æ€å’ŒåŸºæœ¬æ“ä½œ çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸåŠäº”ç§åŸºæœ¬çŠ¶æ€ æ–°å»º(new)ï¼šæ–°åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ã€‚ å¯è¿è¡Œ(runnable)ï¼šçº¿ç¨‹å¯¹è±¡åˆ›å»ºåï¼Œå½“è°ƒç”¨çº¿ç¨‹å¯¹è±¡çš„ start()æ–¹æ³•ï¼Œè¯¥çº¿ç¨‹å¤„äºå°±ç»ªçŠ¶æ€ï¼Œç­‰å¾…è¢«çº¿ç¨‹è°ƒåº¦é€‰ä¸­ï¼Œè·å–cpuçš„ä½¿ç”¨æƒã€‚ è¿è¡Œ(running)ï¼šå¯è¿è¡ŒçŠ¶æ€(runnable)çš„çº¿ç¨‹è·å¾—äº†cpuæ—¶é—´ç‰‡ï¼ˆtimesliceï¼‰ï¼Œæ‰§è¡Œç¨‹åºä»£ç ã€‚æ³¨ï¼šå°±ç»ªçŠ¶æ€æ˜¯è¿›å…¥åˆ°è¿è¡ŒçŠ¶æ€çš„å”¯ä¸€å…¥å£ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œçº¿ç¨‹è¦æƒ³è¿›å…¥è¿è¡ŒçŠ¶æ€æ‰§è¡Œï¼Œé¦–å…ˆå¿…é¡»å¤„äºå°±ç»ªçŠ¶æ€ä¸­ï¼› é˜»å¡(block)ï¼šå¤„äºè¿è¡ŒçŠ¶æ€ä¸­çš„çº¿ç¨‹ç”±äºæŸç§åŸå› ï¼Œæš‚æ—¶æ”¾å¼ƒå¯¹ CPUçš„ä½¿ç”¨æƒï¼Œåœæ­¢æ‰§è¡Œï¼Œæ­¤æ—¶è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç›´åˆ°å…¶è¿›å…¥åˆ°å°±ç»ªçŠ¶æ€ï¼Œæ‰ æœ‰æœºä¼šå†æ¬¡è¢« CPU è°ƒç”¨ä»¥è¿›å…¥åˆ°è¿è¡ŒçŠ¶æ€ã€‚ é˜»å¡çš„æƒ…å†µåˆ†ä¸‰ç§ï¼š (ä¸€). ç­‰å¾…é˜»å¡ï¼šè¿è¡ŒçŠ¶æ€ä¸­çš„çº¿ç¨‹æ‰§è¡Œ wait()æ–¹æ³•ï¼ŒJVMä¼šæŠŠè¯¥çº¿ç¨‹æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—(waitting queue)ä¸­ï¼Œä½¿æœ¬çº¿ç¨‹è¿›å…¥åˆ°ç­‰å¾…é˜»å¡çŠ¶æ€ï¼› (äºŒ). åŒæ­¥é˜»å¡ï¼šçº¿ç¨‹åœ¨è·å– synchronized åŒæ­¥é”å¤±è´¥(å› ä¸ºé”è¢«å…¶å®ƒçº¿ç¨‹æ‰€å ç”¨)ï¼Œï¼Œåˆ™JVMä¼šæŠŠè¯¥çº¿ç¨‹æ”¾å…¥é”æ± (lock pool)ä¸­ï¼Œçº¿ç¨‹ä¼šè¿›å…¥åŒæ­¥é˜»å¡çŠ¶æ€ï¼› (ä¸‰). å…¶ä»–é˜»å¡: é€šè¿‡è°ƒç”¨çº¿ç¨‹çš„ sleep()æˆ– join()æˆ–å‘å‡ºäº† I/O è¯·æ±‚æ—¶ï¼Œçº¿ç¨‹ä¼šè¿›å…¥åˆ°é˜»å¡çŠ¶æ€ã€‚å½“ sleep()çŠ¶æ€è¶…æ—¶ã€join()ç­‰å¾…çº¿ç¨‹ç»ˆæ­¢æˆ–è€…è¶…æ—¶ã€æˆ–è€… I/O å¤„ç†å®Œæ¯•æ—¶ï¼Œçº¿ç¨‹é‡æ–°è½¬å…¥å°±ç»ªçŠ¶æ€ã€‚ æ­»äº¡(dead)ï¼šçº¿ç¨‹run()ã€main()æ–¹æ³•æ‰§è¡Œç»“æŸï¼Œæˆ–è€…å› å¼‚å¸¸é€€å‡ºäº†run()æ–¹æ³•ï¼Œåˆ™è¯¥çº¿ç¨‹ç»“æŸç”Ÿå‘½å‘¨æœŸã€‚æ­»äº¡çš„çº¿ç¨‹ä¸å¯å†æ¬¡å¤ç”Ÿã€‚ Java ä¸­ç”¨åˆ°çš„çº¿ç¨‹è°ƒåº¦ç®—æ³•æ˜¯ä»€ä¹ˆï¼Ÿ è®¡ç®—æœºé€šå¸¸åªæœ‰ä¸€ä¸ª CPUï¼Œåœ¨ä»»æ„æ—¶åˆ»åªèƒ½æ‰§è¡Œä¸€æ¡æœºå™¨æŒ‡ä»¤ï¼Œæ¯ä¸ªçº¿ç¨‹åªæœ‰è·å¾—CPU çš„ä½¿ç”¨æƒæ‰èƒ½æ‰§è¡ŒæŒ‡ä»¤ã€‚æ‰€è°“å¤šçº¿ç¨‹çš„å¹¶å‘è¿è¡Œï¼Œå…¶å®æ˜¯æŒ‡ä»å®è§‚ä¸Šçœ‹ï¼Œå„ä¸ªçº¿ç¨‹è½®æµè·å¾— CPU çš„ä½¿ç”¨æƒï¼Œåˆ†åˆ«æ‰§è¡Œå„è‡ªçš„ä»»åŠ¡ã€‚åœ¨è¿è¡Œæ± ä¸­ï¼Œä¼šæœ‰å¤šä¸ªå¤„äºå°±ç»ªçŠ¶æ€çš„çº¿ç¨‹åœ¨ç­‰å¾… CPUï¼ŒJAVA è™šæ‹Ÿæœºçš„ä¸€é¡¹ä»»åŠ¡å°±æ˜¯è´Ÿè´£çº¿ç¨‹çš„è°ƒåº¦ï¼Œçº¿ç¨‹è°ƒåº¦æ˜¯æŒ‡æŒ‰ç…§ç‰¹å®šæœºåˆ¶ä¸ºå¤šä¸ªçº¿ç¨‹åˆ†é… CPU çš„ä½¿ç”¨æƒã€‚ æœ‰ä¸¤ç§è°ƒåº¦æ¨¡å‹ï¼šåˆ†æ—¶è°ƒåº¦æ¨¡å‹å’ŒæŠ¢å å¼è°ƒåº¦æ¨¡å‹ã€‚ åˆ†æ—¶è°ƒåº¦æ¨¡å‹æ˜¯æŒ‡è®©æ‰€æœ‰çš„çº¿ç¨‹è½®æµè·å¾— cpu çš„ä½¿ç”¨æƒï¼Œå¹¶ä¸”å¹³å‡åˆ†é…æ¯ä¸ªçº¿ç¨‹å ç”¨çš„ CPU çš„æ—¶é—´ç‰‡è¿™ä¸ªä¹Ÿæ¯”è¾ƒå¥½ç†è§£ã€‚ Javaè™šæ‹Ÿæœºé‡‡ç”¨æŠ¢å å¼è°ƒåº¦æ¨¡å‹ï¼Œæ˜¯æŒ‡ä¼˜å…ˆè®©å¯è¿è¡Œæ± ä¸­ä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹å ç”¨CPUï¼Œå¦‚æœå¯è¿è¡Œæ± ä¸­çš„çº¿ç¨‹ä¼˜å…ˆçº§ç›¸åŒï¼Œé‚£ä¹ˆå°±éšæœºé€‰æ‹©ä¸€ä¸ªçº¿ç¨‹ï¼Œä½¿å…¶å ç”¨CPUã€‚å¤„äºè¿è¡ŒçŠ¶æ€çš„çº¿ç¨‹ä¼šä¸€ç›´è¿è¡Œï¼Œç›´è‡³å®ƒä¸å¾—ä¸æ”¾å¼ƒ CPUã€‚ çº¿ç¨‹çš„è°ƒåº¦ç­–ç•¥ çº¿ç¨‹è°ƒåº¦å™¨é€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„çº¿ç¨‹è¿è¡Œï¼Œä½†æ˜¯ï¼Œå¦‚æœå‘ç”Ÿä»¥ä¸‹æƒ…å†µï¼Œå°±ä¼šç»ˆæ­¢çº¿ç¨‹çš„è¿è¡Œï¼š ï¼ˆ1ï¼‰çº¿ç¨‹ä½“ä¸­è°ƒç”¨äº† yield æ–¹æ³•è®©å‡ºäº†å¯¹ cpu çš„å ç”¨æƒåˆ© ï¼ˆ2ï¼‰çº¿ç¨‹ä½“ä¸­è°ƒç”¨äº† sleep æ–¹æ³•ä½¿çº¿ç¨‹è¿›å…¥ç¡çœ çŠ¶æ€ ï¼ˆ3ï¼‰çº¿ç¨‹ç”±äº IO æ“ä½œå—åˆ°é˜»å¡ ï¼ˆ4ï¼‰å¦å¤–ä¸€ä¸ªæ›´é«˜ä¼˜å…ˆçº§çº¿ç¨‹å‡ºç° ï¼ˆ5ï¼‰åœ¨æ”¯æŒæ—¶é—´ç‰‡çš„ç³»ç»Ÿä¸­ï¼Œè¯¥çº¿ç¨‹çš„æ—¶é—´ç‰‡ç”¨å®Œ ä»€ä¹ˆæ˜¯çº¿ç¨‹è°ƒåº¦å™¨(Thread Scheduler)å’Œæ—¶é—´åˆ†ç‰‡(Time Slicing )ï¼Ÿ çº¿ç¨‹è°ƒåº¦å™¨æ˜¯ä¸€ä¸ªæ“ä½œç³»ç»ŸæœåŠ¡ï¼Œå®ƒè´Ÿè´£ä¸º Runnable çŠ¶æ€çš„çº¿ç¨‹åˆ†é… CPU æ—¶é—´ã€‚ä¸€æ—¦æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¹¶å¯åŠ¨å®ƒï¼Œå®ƒçš„æ‰§è¡Œä¾¿ä¾èµ–äºçº¿ç¨‹è°ƒåº¦å™¨çš„å®ç°ã€‚ æ—¶é—´åˆ†ç‰‡æ˜¯æŒ‡å°†å¯ç”¨çš„ CPU æ—¶é—´åˆ†é…ç»™å¯ç”¨çš„ Runnable çº¿ç¨‹çš„è¿‡ç¨‹ã€‚åˆ†é… CPU æ—¶é—´å¯ä»¥åŸºäºçº¿ç¨‹ä¼˜å…ˆçº§æˆ–è€…çº¿ç¨‹ç­‰å¾…çš„æ—¶é—´ã€‚ çº¿ç¨‹è°ƒåº¦å¹¶ä¸å—åˆ° Java è™šæ‹Ÿæœºæ§åˆ¶ï¼Œæ‰€ä»¥ç”±åº”ç”¨ç¨‹åºæ¥æ§åˆ¶å®ƒæ˜¯æ›´å¥½çš„é€‰æ‹©ï¼ˆä¹Ÿå°±æ˜¯è¯´ä¸è¦è®©ä½ çš„ç¨‹åºä¾èµ–äºçº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼‰ã€‚ è¯·è¯´å‡ºä¸çº¿ç¨‹åŒæ­¥ä»¥åŠçº¿ç¨‹è°ƒåº¦ç›¸å…³çš„æ–¹æ³•ã€‚ ï¼ˆ1ï¼‰ wait()ï¼šä½¿ä¸€ä¸ªçº¿ç¨‹å¤„äºç­‰å¾…ï¼ˆé˜»å¡ï¼‰çŠ¶æ€ï¼Œå¹¶ä¸”é‡Šæ”¾æ‰€æŒæœ‰çš„å¯¹è±¡çš„é”ï¼› ï¼ˆ2ï¼‰sleep()ï¼šä½¿ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹å¤„äºç¡çœ çŠ¶æ€ï¼Œæ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œè°ƒç”¨æ­¤æ–¹æ³•è¦å¤„ç† InterruptedException å¼‚å¸¸ï¼› ï¼ˆ3ï¼‰notify()ï¼šå”¤é†’ä¸€ä¸ªå¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹ï¼Œå½“ç„¶åœ¨è°ƒç”¨æ­¤æ–¹æ³•çš„æ—¶å€™ï¼Œå¹¶ä¸èƒ½ç¡®åˆ‡çš„å”¤é†’æŸä¸€ä¸ªç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹ï¼Œè€Œæ˜¯ç”± JVM ç¡®å®šå”¤é†’å“ªä¸ªçº¿ç¨‹ï¼Œè€Œä¸”ä¸ä¼˜å…ˆçº§æ— å…³ï¼› ï¼ˆ4ï¼‰notityAll()ï¼šå”¤é†’æ‰€æœ‰å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹ï¼Œè¯¥æ–¹æ³•å¹¶ä¸æ˜¯å°†å¯¹è±¡çš„é”ç»™æ‰€æœ‰çº¿ç¨‹ï¼Œè€Œæ˜¯è®©å®ƒä»¬ç«äº‰ï¼Œåªæœ‰è·å¾—é”çš„çº¿ç¨‹æ‰èƒ½è¿›å…¥å°±ç»ªçŠ¶æ€ï¼› sleep() å’Œ wait() æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ ä¸¤è€…éƒ½å¯ä»¥æš‚åœçº¿ç¨‹çš„æ‰§è¡Œ ç±»çš„ä¸åŒï¼šsleep() æ˜¯ Threadçº¿ç¨‹ç±»çš„é™æ€æ–¹æ³•ï¼Œwait() æ˜¯ Objectç±»çš„æ–¹æ³•ã€‚ æ˜¯å¦é‡Šæ”¾é”ï¼šsleep() ä¸é‡Šæ”¾é”ï¼›wait() é‡Šæ”¾é”ã€‚ ç”¨é€”ä¸åŒï¼šWait é€šå¸¸è¢«ç”¨äºçº¿ç¨‹é—´äº¤äº’/é€šä¿¡ï¼Œsleep é€šå¸¸è¢«ç”¨äºæš‚åœæ‰§è¡Œã€‚ ç”¨æ³•ä¸åŒï¼šwait() æ–¹æ³•è¢«è°ƒç”¨åï¼Œçº¿ç¨‹ä¸ä¼šè‡ªåŠ¨è‹é†’ï¼Œéœ€è¦åˆ«çš„çº¿ç¨‹è°ƒç”¨åŒä¸€ä¸ªå¯¹è±¡ä¸Šçš„ notify() æˆ–è€… notifyAll() æ–¹æ³•ã€‚sleep() æ–¹æ³•æ‰§è¡Œå®Œæˆåï¼Œçº¿ç¨‹ä¼šè‡ªåŠ¨è‹é†’ã€‚æˆ–è€…å¯ä»¥ä½¿ç”¨wait(long timeout)è¶…æ—¶åçº¿ç¨‹ä¼šè‡ªåŠ¨è‹é†’ã€‚ ä½ æ˜¯å¦‚ä½•è°ƒç”¨ wait() æ–¹æ³•çš„ï¼Ÿä½¿ç”¨ if å—è¿˜æ˜¯å¾ªç¯ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹å¯èƒ½ä¼šæ”¶åˆ°é”™è¯¯è­¦æŠ¥å’Œä¼ªå”¤é†’ï¼Œå¦‚æœä¸åœ¨å¾ªç¯ä¸­æ£€æŸ¥ç­‰å¾…æ¡ä»¶ï¼Œç¨‹åºå°±ä¼šåœ¨æ²¡æœ‰æ»¡è¶³ç»“æŸæ¡ä»¶çš„æƒ…å†µä¸‹é€€å‡ºã€‚ wait() æ–¹æ³•åº”è¯¥åœ¨å¾ªç¯è°ƒç”¨ï¼Œå› ä¸ºå½“çº¿ç¨‹è·å–åˆ° CPU å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œå…¶ä»–æ¡ä»¶å¯èƒ½è¿˜æ²¡æœ‰æ»¡è¶³ï¼Œæ‰€ä»¥åœ¨å¤„ç†å‰ï¼Œå¾ªç¯æ£€æµ‹æ¡ä»¶æ˜¯å¦æ»¡è¶³ä¼šæ›´å¥½ã€‚ä¸‹é¢æ˜¯ä¸€æ®µæ ‡å‡†çš„ä½¿ç”¨ wait å’Œ notify æ–¹æ³•çš„ä»£ç ï¼š synchronized (monitor) { // åˆ¤æ–­æ¡ä»¶è°“è¯æ˜¯å¦å¾—åˆ°æ»¡è¶³ while(!locked) { // ç­‰å¾…å”¤é†’ monitor.wait(); } // å¤„ç†å…¶ä»–çš„ä¸šåŠ¡é€»è¾‘ } ä¸ºä»€ä¹ˆçº¿ç¨‹é€šä¿¡çš„æ–¹æ³• wait(), notify()å’Œ notifyAll()è¢«å®šä¹‰åœ¨ Object ç±»é‡Œï¼Ÿ Javaä¸­ï¼Œä»»ä½•å¯¹è±¡éƒ½å¯ä»¥ä½œä¸ºé”ï¼Œå¹¶ä¸” wait()ï¼Œnotify()ç­‰æ–¹æ³•ç”¨äºç­‰å¾…å¯¹è±¡çš„é”æˆ–è€…å”¤é†’çº¿ç¨‹ï¼Œåœ¨ Java çš„çº¿ç¨‹ä¸­å¹¶æ²¡æœ‰å¯ä¾›ä»»ä½•å¯¹è±¡ä½¿ç”¨çš„é”ï¼Œæ‰€ä»¥ä»»æ„å¯¹è±¡è°ƒç”¨æ–¹æ³•ä¸€å®šè¦å®šä¹‰åœ¨Objectç±»ä¸­ã€‚ wait(), notify()å’Œ notifyAll()è¿™äº›æ–¹æ³•åœ¨åŒæ­¥ä»£ç å—ä¸­è°ƒç”¨ æœ‰çš„äººä¼šè¯´ï¼Œæ—¢ç„¶æ˜¯çº¿ç¨‹æ”¾å¼ƒå¯¹è±¡é”ï¼Œé‚£ä¹Ÿå¯ä»¥æŠŠwait()å®šä¹‰åœ¨Threadç±»é‡Œé¢å•Šï¼Œæ–°å®šä¹‰çš„çº¿ç¨‹ç»§æ‰¿äºThreadç±»ï¼Œä¹Ÿä¸éœ€è¦é‡æ–°å®šä¹‰wait()æ–¹æ³•çš„å®ç°ã€‚ç„¶è€Œï¼Œè¿™æ ·åšæœ‰ä¸€ä¸ªéå¸¸å¤§çš„é—®é¢˜ï¼Œä¸€ä¸ªçº¿ç¨‹å®Œå…¨å¯ä»¥æŒæœ‰å¾ˆå¤šé”ï¼Œä½ ä¸€ä¸ªçº¿ç¨‹æ”¾å¼ƒé”çš„æ—¶å€™ï¼Œåˆ°åº•è¦æ”¾å¼ƒå“ªä¸ªé”ï¼Ÿå½“ç„¶äº†ï¼Œè¿™ç§è®¾è®¡å¹¶ä¸æ˜¯ä¸èƒ½å®ç°ï¼Œåªæ˜¯ç®¡ç†èµ·æ¥æ›´åŠ å¤æ‚ã€‚ ç»¼ä¸Šæ‰€è¿°ï¼Œwait()ã€notify()å’ŒnotifyAll()æ–¹æ³•è¦å®šä¹‰åœ¨Objectç±»ä¸­ã€‚ ä¸ºä»€ä¹ˆ wait(), notify()å’Œ notifyAll()å¿…é¡»åœ¨åŒæ­¥æ–¹æ³•æˆ–è€…åŒæ­¥å—ä¸­è¢«è°ƒç”¨ï¼Ÿ å½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦è°ƒç”¨å¯¹è±¡çš„ wait()æ–¹æ³•çš„æ—¶å€™ï¼Œè¿™ä¸ªçº¿ç¨‹å¿…é¡»æ‹¥æœ‰è¯¥å¯¹è±¡çš„é”ï¼Œæ¥ç€å®ƒå°±ä¼šé‡Šæ”¾è¿™ä¸ªå¯¹è±¡é”å¹¶è¿›å…¥ç­‰å¾…çŠ¶æ€ç›´åˆ°å…¶ä»–çº¿ç¨‹è°ƒç”¨è¿™ä¸ªå¯¹è±¡ä¸Šçš„ notify()æ–¹æ³•ã€‚åŒæ ·çš„ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦è°ƒç”¨å¯¹è±¡çš„ notify()æ–¹æ³•æ—¶ï¼Œå®ƒä¼šé‡Šæ”¾è¿™ä¸ªå¯¹è±¡çš„é”ï¼Œä»¥ä¾¿å…¶ä»–åœ¨ç­‰å¾…çš„çº¿ç¨‹å°±å¯ä»¥å¾—åˆ°è¿™ä¸ªå¯¹è±¡é”ã€‚ç”±äºæ‰€æœ‰çš„è¿™äº›æ–¹æ³•éƒ½éœ€è¦çº¿ç¨‹æŒæœ‰å¯¹è±¡çš„é”ï¼Œè¿™æ ·å°±åªèƒ½é€šè¿‡åŒæ­¥æ¥å®ç°ï¼Œæ‰€ä»¥ä»–ä»¬åªèƒ½åœ¨åŒæ­¥æ–¹æ³•æˆ–è€…åŒæ­¥å—ä¸­è¢«è°ƒç”¨ã€‚ Thread ç±»ä¸­çš„ yield æ–¹æ³•æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ ä½¿å½“å‰çº¿ç¨‹ä»æ‰§è¡ŒçŠ¶æ€ï¼ˆè¿è¡ŒçŠ¶æ€ï¼‰å˜ä¸ºå¯æ‰§è¡Œæ€ï¼ˆå°±ç»ªçŠ¶æ€ï¼‰ã€‚ å½“å‰çº¿ç¨‹åˆ°äº†å°±ç»ªçŠ¶æ€ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å“ªä¸ªçº¿ç¨‹ä¼šä»å°±ç»ªçŠ¶æ€å˜æˆæ‰§è¡ŒçŠ¶æ€å‘¢ï¼Ÿå¯èƒ½æ˜¯å½“å‰çº¿ç¨‹ï¼Œä¹Ÿå¯èƒ½æ˜¯å…¶ä»–çº¿ç¨‹ï¼Œçœ‹ç³»ç»Ÿçš„åˆ†é…äº†ã€‚ ä¸ºä»€ä¹ˆ Thread ç±»çš„ sleep()å’Œ yield ()æ–¹æ³•æ˜¯é™æ€çš„ï¼Ÿ Thread ç±»çš„ sleep()å’Œ yield()æ–¹æ³•å°†åœ¨å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ä¸Šè¿è¡Œã€‚æ‰€ä»¥åœ¨å…¶ä»–å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹ä¸Šè°ƒç”¨è¿™äº›æ–¹æ³•æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¿™äº›æ–¹æ³•æ˜¯é™æ€çš„ã€‚å®ƒä»¬å¯ä»¥åœ¨å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ä¸­å·¥ä½œï¼Œå¹¶é¿å…ç¨‹åºå‘˜é”™è¯¯çš„è®¤ä¸ºå¯ä»¥åœ¨å…¶ä»–éè¿è¡Œçº¿ç¨‹è°ƒç”¨è¿™äº›æ–¹æ³•ã€‚ çº¿ç¨‹çš„ sleep()æ–¹æ³•å’Œ yield()æ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ ï¼ˆ1ï¼‰ sleep()æ–¹æ³•ç»™å…¶ä»–çº¿ç¨‹è¿è¡Œæœºä¼šæ—¶ä¸è€ƒè™‘çº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼Œå› æ­¤ä¼šç»™ä½ä¼˜å…ˆçº§çš„çº¿ç¨‹ä»¥è¿è¡Œçš„æœºä¼šï¼›yield()æ–¹æ³•åªä¼šç»™ç›¸åŒä¼˜å…ˆçº§æˆ–æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹ä»¥è¿è¡Œçš„æœºä¼šï¼› ï¼ˆ2ï¼‰ çº¿ç¨‹æ‰§è¡Œ sleep()æ–¹æ³•åè½¬å…¥é˜»å¡ï¼ˆblockedï¼‰çŠ¶æ€ï¼Œè€Œæ‰§è¡Œ yield()æ–¹æ³•åè½¬å…¥å°±ç»ªï¼ˆreadyï¼‰çŠ¶æ€ï¼› ï¼ˆ3ï¼‰sleep()æ–¹æ³•å£°æ˜æŠ›å‡º InterruptedExceptionï¼Œè€Œ yield()æ–¹æ³•æ²¡æœ‰å£°æ˜ä»»ä½•å¼‚å¸¸ï¼› ï¼ˆ4ï¼‰sleep()æ–¹æ³•æ¯” yield()æ–¹æ³•ï¼ˆè·Ÿæ“ä½œç³»ç»Ÿ CPU è°ƒåº¦ç›¸å…³ï¼‰å…·æœ‰æ›´å¥½çš„å¯ç§»æ¤æ€§ï¼Œé€šå¸¸ä¸å»ºè®®ä½¿ç”¨yield()æ–¹æ³•æ¥æ§åˆ¶å¹¶å‘çº¿ç¨‹çš„æ‰§è¡Œã€‚ å¦‚ä½•åœæ­¢ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Ÿ åœ¨javaä¸­æœ‰ä»¥ä¸‹3ç§æ–¹æ³•å¯ä»¥ç»ˆæ­¢æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼š ä½¿ç”¨é€€å‡ºæ ‡å¿—ï¼Œä½¿çº¿ç¨‹æ­£å¸¸é€€å‡ºï¼Œä¹Ÿå°±æ˜¯å½“runæ–¹æ³•å®Œæˆåçº¿ç¨‹ç»ˆæ­¢ã€‚ ä½¿ç”¨stopæ–¹æ³•å¼ºè¡Œç»ˆæ­¢ï¼Œä½†æ˜¯ä¸æ¨èè¿™ä¸ªæ–¹æ³•ï¼Œå› ä¸ºstopå’ŒsuspendåŠresumeä¸€æ ·éƒ½æ˜¯è¿‡æœŸä½œåºŸçš„æ–¹æ³•ã€‚ ä½¿ç”¨interruptæ–¹æ³•ä¸­æ–­çº¿ç¨‹ã€‚ Java ä¸­ interrupted å’Œ isInterrupted æ–¹æ³•çš„åŒºåˆ«ï¼Ÿ interruptï¼šç”¨äºä¸­æ–­çº¿ç¨‹ã€‚è°ƒç”¨è¯¥æ–¹æ³•çš„çº¿ç¨‹çš„çŠ¶æ€ä¸ºå°†è¢«ç½®ä¸ºâ€ä¸­æ–­â€çŠ¶æ€ã€‚ æ³¨æ„ï¼šçº¿ç¨‹ä¸­æ–­ä»…ä»…æ˜¯ç½®çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ä½ï¼Œä¸ä¼šåœæ­¢çº¿ç¨‹ã€‚éœ€è¦ç”¨æˆ·è‡ªå·±å»ç›‘è§†çº¿ç¨‹çš„çŠ¶æ€ä¸ºå¹¶åšå¤„ç†ã€‚æ”¯æŒçº¿ç¨‹ä¸­æ–­çš„æ–¹æ³•ï¼ˆä¹Ÿå°±æ˜¯çº¿ç¨‹ä¸­æ–­åä¼šæŠ›å‡ºinterruptedException çš„æ–¹æ³•ï¼‰å°±æ˜¯åœ¨ç›‘è§†çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ï¼Œä¸€æ—¦çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€è¢«ç½®ä¸ºâ€œä¸­æ–­çŠ¶æ€â€ï¼Œå°±ä¼šæŠ›å‡ºä¸­æ–­å¼‚å¸¸ã€‚ interruptedï¼šæ˜¯é™æ€æ–¹æ³•ï¼ŒæŸ¥çœ‹å½“å‰ä¸­æ–­ä¿¡å·æ˜¯trueè¿˜æ˜¯falseå¹¶ä¸”æ¸…é™¤ä¸­æ–­ä¿¡å·ã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹è¢«ä¸­æ–­äº†ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨ interrupted åˆ™è¿”å› trueï¼Œç¬¬äºŒæ¬¡å’Œåé¢çš„å°±è¿”å› false äº†ã€‚ isInterruptedï¼šæŸ¥çœ‹å½“å‰ä¸­æ–­ä¿¡å·æ˜¯trueè¿˜æ˜¯false ä»€ä¹ˆæ˜¯é˜»å¡å¼æ–¹æ³•ï¼Ÿ é˜»å¡å¼æ–¹æ³•æ˜¯æŒ‡ç¨‹åºä¼šä¸€ç›´ç­‰å¾…è¯¥æ–¹æ³•å®ŒæˆæœŸé—´ä¸åšå…¶ä»–äº‹æƒ…ï¼ŒServerSocket çš„accept()æ–¹æ³•å°±æ˜¯ä¸€ç›´ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ã€‚è¿™é‡Œçš„é˜»å¡æ˜¯æŒ‡è°ƒç”¨ç»“æœè¿”å›ä¹‹å‰ï¼Œå½“å‰çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œç›´åˆ°å¾—åˆ°ç»“æœä¹‹åæ‰ä¼šè¿”å›ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰å¼‚æ­¥å’Œéé˜»å¡å¼æ–¹æ³•åœ¨ä»»åŠ¡å®Œæˆå‰å°±è¿”å›ã€‚ Java ä¸­ä½ æ€æ ·å”¤é†’ä¸€ä¸ªé˜»å¡çš„çº¿ç¨‹ï¼Ÿ é¦–å…ˆ ï¼Œwait()ã€notify() æ–¹æ³•æ˜¯é’ˆå¯¹å¯¹è±¡çš„ï¼Œè°ƒç”¨ä»»æ„å¯¹è±¡çš„ wait()æ–¹æ³•éƒ½å°†å¯¼è‡´çº¿ç¨‹é˜»å¡ï¼Œé˜»å¡çš„åŒæ—¶ä¹Ÿå°†é‡Šæ”¾è¯¥å¯¹è±¡çš„é”ï¼Œç›¸åº”åœ°ï¼Œè°ƒç”¨ä»»æ„å¯¹è±¡çš„ notify()æ–¹æ³•åˆ™å°†éšæœºè§£é™¤è¯¥å¯¹è±¡é˜»å¡çš„çº¿ç¨‹ï¼Œä½†å®ƒéœ€è¦é‡æ–°è·å–è¯¥å¯¹è±¡çš„é”ï¼Œç›´åˆ°è·å–æˆåŠŸæ‰èƒ½å¾€ä¸‹æ‰§è¡Œï¼› å…¶æ¬¡ï¼Œwaitã€notify æ–¹æ³•å¿…é¡»åœ¨ synchronized å—æˆ–æ–¹æ³•ä¸­è¢«è°ƒç”¨ï¼Œå¹¶ä¸”è¦ä¿è¯åŒæ­¥å—æˆ–æ–¹æ³•çš„é”å¯¹è±¡ä¸è°ƒç”¨ waitã€notify æ–¹æ³•çš„å¯¹è±¡æ˜¯åŒä¸€ä¸ªï¼Œå¦‚æ­¤ä¸€æ¥åœ¨è°ƒç”¨ wait ä¹‹å‰å½“å‰çº¿ç¨‹å°±å·²ç»æˆåŠŸè·å–æŸå¯¹è±¡çš„é”ï¼Œæ‰§è¡Œ wait é˜»å¡åå½“å‰çº¿ç¨‹å°±å°†ä¹‹å‰è·å–çš„å¯¹è±¡é”é‡Šæ”¾ã€‚ notify() å’Œ notifyAll() æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ å¦‚æœçº¿ç¨‹è°ƒç”¨äº†å¯¹è±¡çš„ wait()æ–¹æ³•ï¼Œé‚£ä¹ˆçº¿ç¨‹ä¾¿ä¼šå¤„äºè¯¥å¯¹è±¡çš„ç­‰å¾…æ± ä¸­ï¼Œç­‰å¾…æ± ä¸­çš„çº¿ç¨‹ä¸ä¼šå»ç«äº‰è¯¥å¯¹è±¡çš„é”ã€‚ notifyAll() ä¼šå”¤é†’æ‰€æœ‰çš„çº¿ç¨‹ï¼Œnotify() åªä¼šå”¤é†’ä¸€ä¸ªçº¿ç¨‹ã€‚ notifyAll() è°ƒç”¨åï¼Œä¼šå°†å…¨éƒ¨çº¿ç¨‹ç”±ç­‰å¾…æ± ç§»åˆ°é”æ± ï¼Œç„¶åå‚ä¸é”çš„ç«äº‰ï¼Œç«äº‰æˆåŠŸåˆ™ç»§ç»­æ‰§è¡Œï¼Œå¦‚æœä¸æˆåŠŸåˆ™ç•™åœ¨é”æ± ç­‰å¾…é”è¢«é‡Šæ”¾åå†æ¬¡å‚ä¸ç«äº‰ã€‚è€Œ notify()åªä¼šå”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œå…·ä½“å”¤é†’å“ªä¸€ä¸ªçº¿ç¨‹ç”±è™šæ‹Ÿæœºæ§åˆ¶ã€‚ å¦‚ä½•åœ¨ä¸¤ä¸ªçº¿ç¨‹é—´å…±äº«æ•°æ®ï¼Ÿ åœ¨ä¸¤ä¸ªçº¿ç¨‹é—´å…±äº«å˜é‡å³å¯å®ç°å…±äº«ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œå…±äº«å˜é‡è¦æ±‚å˜é‡æœ¬èº«æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œç„¶ååœ¨çº¿ç¨‹å†…ä½¿ç”¨çš„æ—¶å€™ï¼Œå¦‚æœæœ‰å¯¹å…±äº«å˜é‡çš„å¤åˆæ“ä½œï¼Œé‚£ä¹ˆä¹Ÿå¾—ä¿è¯å¤åˆæ“ä½œçš„çº¿ç¨‹å®‰å…¨æ€§ã€‚ å¯ä»¥é€šè¿‡ä¸­æ–­ å’Œ å…±äº«å˜é‡çš„æ–¹å¼å®ç°çº¿ç¨‹é—´çš„é€šè®¯å’Œåä½œ æ¯”å¦‚è¯´æœ€ç»å…¸çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ï¼šå½“é˜Ÿåˆ—æ»¡æ—¶ï¼Œç”Ÿäº§è€…éœ€è¦ç­‰å¾…é˜Ÿåˆ—æœ‰ç©ºé—´æ‰èƒ½ç»§ç»­å¾€é‡Œé¢æ”¾å…¥å•†å“ï¼Œè€Œåœ¨ç­‰å¾…çš„æœŸé—´å†…ï¼Œç”Ÿäº§è€…å¿…é¡»é‡Šæ”¾å¯¹ä¸´ç•Œèµ„æºï¼ˆå³é˜Ÿåˆ—ï¼‰çš„å ç”¨æƒã€‚å› ä¸ºç”Ÿäº§è€…å¦‚æœä¸é‡Šæ”¾å¯¹ä¸´ç•Œèµ„æºçš„å ç”¨æƒï¼Œé‚£ä¹ˆæ¶ˆè´¹è€…å°±æ— æ³•æ¶ˆè´¹é˜Ÿåˆ—ä¸­çš„å•†å“ï¼Œå°±ä¸ä¼šè®©é˜Ÿåˆ—æœ‰ç©ºé—´ï¼Œé‚£ä¹ˆç”Ÿäº§è€…å°±ä¼šä¸€ç›´æ— é™ç­‰å¾…ä¸‹å»ã€‚å› æ­¤ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå½“é˜Ÿåˆ—æ»¡æ—¶ï¼Œä¼šè®©ç”Ÿäº§è€…äº¤å‡ºå¯¹ä¸´ç•Œèµ„æºçš„å ç”¨æƒï¼Œå¹¶è¿›å…¥æŒ‚èµ·çŠ¶æ€ã€‚ç„¶åç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹äº†å•†å“ï¼Œç„¶åæ¶ˆè´¹è€…é€šçŸ¥ç”Ÿäº§è€…é˜Ÿåˆ—æœ‰ç©ºé—´äº†ã€‚åŒæ ·åœ°ï¼Œå½“é˜Ÿåˆ—ç©ºæ—¶ï¼Œæ¶ˆè´¹è€…ä¹Ÿå¿…é¡»ç­‰å¾…ï¼Œç­‰å¾…ç”Ÿäº§è€…é€šçŸ¥å®ƒé˜Ÿåˆ—ä¸­æœ‰å•†å“äº†ã€‚è¿™ç§äº’ç›¸é€šä¿¡çš„è¿‡ç¨‹å°±æ˜¯çº¿ç¨‹é—´çš„åä½œã€‚ Javaä¸­çº¿ç¨‹é€šä¿¡åä½œçš„æœ€å¸¸è§çš„ä¸¤ç§æ–¹å¼ï¼š syncrhoizedåŠ é”çš„çº¿ç¨‹çš„Objectç±»çš„wait()/notify()/notifyAll() ReentrantLockç±»åŠ é”çš„çº¿ç¨‹çš„Conditionç±»çš„await()/signal()/signalAll() çº¿ç¨‹é—´ç›´æ¥çš„æ•°æ®äº¤æ¢ï¼š é€šè¿‡ç®¡é“è¿›è¡Œçº¿ç¨‹é—´é€šä¿¡ï¼š1ï¼‰å­—èŠ‚æµï¼›2ï¼‰å­—ç¬¦æµ åŒæ­¥æ–¹æ³•å’ŒåŒæ­¥å—ï¼Œå“ªä¸ªæ˜¯æ›´å¥½çš„é€‰æ‹©ï¼Ÿ Lock lock = new ReentrantLock(); lock. lock(); try { System. out. println(&quot;è·å¾—é”&quot;); } catch (Exception e) { // TODO: handle exception } finally { System. out. println(&quot;é‡Šæ”¾é”&quot;); lock. unlock(); } åŒæ­¥å—æ›´è¦ç¬¦åˆå¼€æ”¾è°ƒç”¨çš„åŸåˆ™ï¼Œåªåœ¨éœ€è¦é”ä½çš„ä»£ç å—é”ä½ç›¸åº”çš„å¯¹è±¡ï¼Œè¿™æ ·ä»ä¾§é¢æ¥è¯´ä¹Ÿå¯ä»¥é¿å…æ­»é”ã€‚ è¯·çŸ¥é“ä¸€æ¡åŸåˆ™ï¼šåŒæ­¥çš„èŒƒå›´è¶Šå°è¶Šå¥½ã€‚ ä»€ä¹ˆæ˜¯çº¿ç¨‹åŒæ­¥å’Œçº¿ç¨‹äº’æ–¥ï¼Œæœ‰å“ªå‡ ç§å®ç°æ–¹å¼ï¼Ÿ å½“ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«çš„æ•°æ®è¿›è¡Œæ“ä½œæ—¶ï¼Œåº”ä½¿ä¹‹æˆä¸ºä¸€ä¸ª&quot;åŸå­æ“ä½œ&quot;ï¼Œå³åœ¨æ²¡æœ‰å®Œæˆç›¸å…³æ“ä½œä¹‹å‰ï¼Œä¸å…è®¸å…¶ä»–çº¿ç¨‹æ‰“æ–­å®ƒï¼Œå¦åˆ™ï¼Œå°±ä¼šç ´åæ•°æ®çš„å®Œæ•´æ€§ï¼Œå¿…ç„¶ä¼šå¾—åˆ°é”™è¯¯çš„å¤„ç†ç»“æœï¼Œè¿™å°±æ˜¯çº¿ç¨‹çš„åŒæ­¥ã€‚ åœ¨å¤šçº¿ç¨‹åº”ç”¨ä¸­ï¼Œè€ƒè™‘ä¸åŒçº¿ç¨‹ä¹‹é—´çš„æ•°æ®åŒæ­¥å’Œé˜²æ­¢æ­»é”ã€‚å½“ä¸¤ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ä¹‹é—´åŒæ—¶ç­‰å¾…å¯¹æ–¹é‡Šæ”¾èµ„æºçš„æ—¶å€™å°±ä¼šå½¢æˆçº¿ç¨‹ä¹‹é—´çš„æ­»é”ã€‚ä¸ºäº†é˜²æ­¢æ­»é”çš„å‘ç”Ÿï¼Œéœ€è¦é€šè¿‡åŒæ­¥æ¥å®ç°çº¿ç¨‹å®‰å…¨ã€‚ çº¿ç¨‹äº’æ–¥æ˜¯æŒ‡å¯¹äºå…±äº«çš„è¿›ç¨‹ç³»ç»Ÿèµ„æºï¼Œåœ¨å„å•ä¸ªçº¿ç¨‹è®¿é—®æ—¶çš„æ’å®ƒæ€§ã€‚å½“æœ‰è‹¥å¹²ä¸ªçº¿ç¨‹éƒ½è¦ä½¿ç”¨æŸä¸€å…±äº«èµ„æºæ—¶ï¼Œä»»ä½•æ—¶åˆ»æœ€å¤šåªå…è®¸ä¸€ä¸ªçº¿ç¨‹å»ä½¿ç”¨ï¼Œå…¶å®ƒè¦ä½¿ç”¨è¯¥èµ„æºçš„çº¿ç¨‹å¿…é¡»ç­‰å¾…ï¼Œç›´åˆ°å ç”¨èµ„æºè€…é‡Šæ”¾è¯¥èµ„æºã€‚çº¿ç¨‹äº’æ–¥å¯ä»¥çœ‹æˆæ˜¯ä¸€ç§ç‰¹æ®Šçš„çº¿ç¨‹åŒæ­¥ã€‚ çº¿ç¨‹é—´çš„åŒæ­¥æ–¹æ³•å¤§ä½“å¯åˆ†ä¸ºä¸¤ç±»ï¼šç”¨æˆ·æ¨¡å¼å’Œå†…æ ¸æ¨¡å¼ã€‚é¡¾åæ€ä¹‰ï¼Œå†…æ ¸æ¨¡å¼å°±æ˜¯æŒ‡åˆ©ç”¨ç³»ç»Ÿå†…æ ¸å¯¹è±¡çš„å•ä¸€æ€§æ¥è¿›è¡ŒåŒæ­¥ï¼Œä½¿ç”¨æ—¶éœ€è¦åˆ‡æ¢å†…æ ¸æ€ä¸ç”¨æˆ·æ€ï¼Œè€Œç”¨æˆ·æ¨¡å¼å°±æ˜¯ä¸éœ€è¦åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œåªåœ¨ç”¨æˆ·æ€å®Œæˆæ“ä½œã€‚ ç”¨æˆ·æ¨¡å¼ä¸‹çš„æ–¹æ³•æœ‰ï¼šåŸå­æ“ä½œï¼ˆä¾‹å¦‚ä¸€ä¸ªå•ä¸€çš„å…¨å±€å˜é‡ï¼‰ï¼Œä¸´ç•ŒåŒºã€‚ å†…æ ¸æ¨¡å¼ä¸‹çš„æ–¹æ³•æœ‰ï¼šäº‹ä»¶ï¼Œä¿¡å·é‡ï¼Œäº’æ–¥é‡ã€‚ å®ç°çº¿ç¨‹åŒæ­¥çš„æ–¹æ³• åŒæ­¥ä»£ç æ–¹æ³•ï¼šsychronized å…³é”®å­—ä¿®é¥°çš„æ–¹æ³• åŒæ­¥ä»£ç å—ï¼šsychronized å…³é”®å­—ä¿®é¥°çš„ä»£ç å— ä½¿ç”¨ç‰¹æ®Šå˜é‡åŸŸvolatileå®ç°çº¿ç¨‹åŒæ­¥ï¼švolatileå…³é”®å­—ä¸ºåŸŸå˜é‡çš„è®¿é—®æä¾›äº†ä¸€ç§å…é”æœºåˆ¶ ä½¿ç”¨é‡å…¥é”å®ç°çº¿ç¨‹åŒæ­¥ï¼šreentrantlockç±»æ˜¯å¯é‡å…¥ã€äº’æ–¥ã€å®ç°äº†lockæ¥å£çš„é”ï¼Œå®ƒä¸sychronizedæ–¹æ³•å…·æœ‰ç›¸åŒçš„åŸºæœ¬è¡Œä¸ºå’Œè¯­ä¹‰ åœ¨ç›‘è§†å™¨(Monitor)å†…éƒ¨ï¼Œæ˜¯å¦‚ä½•åšçº¿ç¨‹åŒæ­¥çš„ï¼Ÿç¨‹åºåº”è¯¥åšå“ªç§çº§åˆ«çš„åŒæ­¥ï¼Ÿ åœ¨ java è™šæ‹Ÿæœºä¸­ï¼Œæ¯ä¸ªå¯¹è±¡( Object å’Œ class )é€šè¿‡æŸç§é€»è¾‘å…³è”ç›‘è§†å™¨,æ¯ä¸ªç›‘è§†å™¨å’Œä¸€ä¸ªå¯¹è±¡å¼•ç”¨ç›¸å…³è”ï¼Œä¸ºäº†å®ç°ç›‘è§†å™¨çš„äº’æ–¥åŠŸèƒ½ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½å…³è”ç€ä¸€æŠŠé”ã€‚ ä¸€æ—¦æ–¹æ³•æˆ–è€…ä»£ç å—è¢« synchronized ä¿®é¥°ï¼Œé‚£ä¹ˆè¿™ä¸ªéƒ¨åˆ†å°±æ”¾å…¥äº†ç›‘è§†å™¨çš„ç›‘è§†åŒºåŸŸï¼Œç¡®ä¿ä¸€æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¯¥éƒ¨åˆ†çš„ä»£ç ï¼Œçº¿ç¨‹åœ¨è·å–é”ä¹‹å‰ä¸å…è®¸æ‰§è¡Œè¯¥éƒ¨åˆ†çš„ä»£ç  å¦å¤– java è¿˜æä¾›äº†æ˜¾å¼ç›‘è§†å™¨( Lock )å’Œéšå¼ç›‘è§†å™¨( synchronized )ä¸¤ç§é”æ–¹æ¡ˆ å¦‚æœä½ æäº¤ä»»åŠ¡æ—¶ï¼Œçº¿ç¨‹æ± é˜Ÿåˆ—å·²æ»¡ï¼Œè¿™æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆ è¿™é‡ŒåŒºåˆ†ä¸€ä¸‹ï¼š ï¼ˆ1ï¼‰å¦‚æœä½¿ç”¨çš„æ˜¯æ— ç•Œé˜Ÿåˆ— LinkedBlockingQueueï¼Œä¹Ÿå°±æ˜¯æ— ç•Œé˜Ÿåˆ—çš„è¯ï¼Œæ²¡å…³ç³»ï¼Œç»§ç»­æ·»åŠ ä»»åŠ¡åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œï¼Œå› ä¸º LinkedBlockingQueue å¯ä»¥è¿‘ä¹è®¤ä¸ºæ˜¯ä¸€ä¸ªæ— ç©·å¤§çš„é˜Ÿåˆ—ï¼Œå¯ä»¥æ— é™å­˜æ”¾ä»»åŠ¡ ï¼ˆ2ï¼‰å¦‚æœä½¿ç”¨çš„æ˜¯æœ‰ç•Œé˜Ÿåˆ—æ¯”å¦‚ ArrayBlockingQueueï¼Œä»»åŠ¡é¦–å…ˆä¼šè¢«æ·»åŠ åˆ°ArrayBlockingQueue ä¸­ï¼ŒArrayBlockingQueue æ»¡äº†ï¼Œä¼šæ ¹æ®maximumPoolSize çš„å€¼å¢åŠ çº¿ç¨‹æ•°é‡ï¼Œå¦‚æœå¢åŠ äº†çº¿ç¨‹æ•°é‡è¿˜æ˜¯å¤„ç†ä¸è¿‡æ¥ï¼ŒArrayBlockingQueue ç»§ç»­æ»¡ï¼Œé‚£ä¹ˆåˆ™ä¼šä½¿ç”¨æ‹’ç»ç­–ç•¥RejectedExecutionHandler å¤„ç†æ»¡äº†çš„ä»»åŠ¡ï¼Œé»˜è®¤æ˜¯ AbortPolicy ä»€ä¹ˆå«çº¿ç¨‹å®‰å…¨ï¼Ÿservlet æ˜¯çº¿ç¨‹å®‰å…¨å—? çº¿ç¨‹å®‰å…¨æ˜¯ç¼–ç¨‹ä¸­çš„æœ¯è¯­ï¼ŒæŒ‡æŸä¸ªæ–¹æ³•åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­è¢«è°ƒç”¨æ—¶ï¼Œèƒ½å¤Ÿæ­£ç¡®åœ°å¤„ç†å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„å…±äº«å˜é‡ï¼Œä½¿ç¨‹åºåŠŸèƒ½æ­£ç¡®å®Œæˆã€‚ Servlet ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œservlet æ˜¯å•å®ä¾‹å¤šçº¿ç¨‹çš„ï¼Œå½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€ä¸ªæ–¹æ³•ï¼Œæ˜¯ä¸èƒ½ä¿è¯å…±äº«å˜é‡çš„çº¿ç¨‹å®‰å…¨æ€§çš„ã€‚ Struts2 çš„ action æ˜¯å¤šå®ä¾‹å¤šçº¿ç¨‹çš„ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ¯ä¸ªè¯·æ±‚è¿‡æ¥éƒ½ä¼š new ä¸€ä¸ªæ–°çš„ action åˆ†é…ç»™è¿™ä¸ªè¯·æ±‚ï¼Œè¯·æ±‚å®Œæˆåé”€æ¯ã€‚ SpringMVC çš„ Controller æ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿä¸æ˜¯çš„ï¼Œå’Œ Servlet ç±»ä¼¼çš„å¤„ç†æµç¨‹ã€‚ Struts2 å¥½å¤„æ˜¯ä¸ç”¨è€ƒè™‘çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼›Servlet å’Œ SpringMVC éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯æ€§èƒ½å¯ä»¥æå‡ä¸ç”¨å¤„ç†å¤ªå¤šçš„ gcï¼Œå¯ä»¥ä½¿ç”¨ ThreadLocal æ¥å¤„ç†å¤šçº¿ç¨‹çš„é—®é¢˜ã€‚ åœ¨ Java ç¨‹åºä¸­æ€ä¹ˆä¿è¯å¤šçº¿ç¨‹çš„è¿è¡Œå®‰å…¨ï¼Ÿ æ–¹æ³•ä¸€ï¼šä½¿ç”¨å®‰å…¨ç±»ï¼Œæ¯”å¦‚ java.util.concurrent ä¸‹çš„ç±»ï¼Œä½¿ç”¨åŸå­ç±»AtomicInteger æ–¹æ³•äºŒï¼šä½¿ç”¨è‡ªåŠ¨é” synchronizedã€‚ æ–¹æ³•ä¸‰ï¼šä½¿ç”¨æ‰‹åŠ¨é” Lockã€‚ æ‰‹åŠ¨é” Java ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š Lock lock = new ReentrantLock(); lock. lock(); try { System. out. println(&quot;è·å¾—é”&quot;); } catch (Exception e) { // TODO: handle exception } finally { System. out. println(&quot;é‡Šæ”¾é”&quot;); lock. unlock(); } ä½ å¯¹çº¿ç¨‹ä¼˜å…ˆçº§çš„ç†è§£æ˜¯ä»€ä¹ˆï¼Ÿ æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æ˜¯æœ‰ä¼˜å…ˆçº§çš„ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œé«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹åœ¨è¿è¡Œæ—¶ä¼šå…·æœ‰ä¼˜å…ˆæƒï¼Œä½†è¿™ä¾èµ–äºçº¿ç¨‹è°ƒåº¦çš„å®ç°ï¼Œè¿™ä¸ªå®ç°æ˜¯å’Œæ“ä½œç³»ç»Ÿç›¸å…³çš„(OS dependent)ã€‚æˆ‘ä»¬å¯ä»¥å®šä¹‰çº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼Œä½†æ˜¯è¿™å¹¶ä¸èƒ½ä¿è¯é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹ä¼šåœ¨ä½ä¼˜å…ˆçº§çš„çº¿ç¨‹å‰æ‰§è¡Œã€‚çº¿ç¨‹ä¼˜å…ˆçº§æ˜¯ä¸€ä¸ª int å˜é‡(ä» 1-10)ï¼Œ1 ä»£è¡¨æœ€ä½ä¼˜å…ˆçº§ï¼Œ10 ä»£è¡¨æœ€é«˜ä¼˜å…ˆçº§ã€‚ Java çš„çº¿ç¨‹ä¼˜å…ˆçº§è°ƒåº¦ä¼šå§”æ‰˜ç»™æ“ä½œç³»ç»Ÿå»å¤„ç†ï¼Œæ‰€ä»¥ä¸å…·ä½“çš„æ“ä½œç³»ç»Ÿä¼˜å…ˆçº§æœ‰å…³ï¼Œå¦‚éç‰¹åˆ«éœ€è¦ï¼Œä¸€èˆ¬æ— éœ€è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§ã€‚ çº¿ç¨‹ç±»çš„æ„é€ æ–¹æ³•ã€é™æ€å—æ˜¯è¢«å“ªä¸ªçº¿ç¨‹è°ƒç”¨çš„ è¿™æ˜¯ä¸€ä¸ªéå¸¸åˆé’»å’Œç‹¡çŒ¾çš„é—®é¢˜ã€‚è¯·è®°ä½ï¼šçº¿ç¨‹ç±»çš„æ„é€ æ–¹æ³•ã€é™æ€å—æ˜¯è¢« newè¿™ä¸ªçº¿ç¨‹ç±»æ‰€åœ¨çš„çº¿ç¨‹æ‰€è°ƒç”¨çš„ï¼Œè€Œ run æ–¹æ³•é‡Œé¢çš„ä»£ç æ‰æ˜¯è¢«çº¿ç¨‹è‡ªèº«æ‰€è°ƒç”¨çš„ã€‚ å¦‚æœè¯´ä¸Šé¢çš„è¯´æ³•è®©ä½ æ„Ÿåˆ°å›°æƒ‘ï¼Œé‚£ä¹ˆæˆ‘ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ Thread2 ä¸­ new äº†Thread1ï¼Œmain å‡½æ•°ä¸­ new äº† Thread2ï¼Œé‚£ä¹ˆï¼š ï¼ˆ1ï¼‰Thread2 çš„æ„é€ æ–¹æ³•ã€é™æ€å—æ˜¯ main çº¿ç¨‹è°ƒç”¨çš„ï¼ŒThread2 çš„ run()æ–¹æ³•æ˜¯Thread2 è‡ªå·±è°ƒç”¨çš„ ï¼ˆ2ï¼‰Thread1 çš„æ„é€ æ–¹æ³•ã€é™æ€å—æ˜¯ Thread2 è°ƒç”¨çš„ï¼ŒThread1 çš„ run()æ–¹æ³•æ˜¯Thread1 è‡ªå·±è°ƒç”¨çš„ ä¸€ä¸ªçº¿ç¨‹è¿è¡Œæ—¶å‘ç”Ÿå¼‚å¸¸ä¼šæ€æ ·ï¼Ÿ å¦‚æœå¼‚å¸¸æ²¡æœ‰è¢«æ•è·è¯¥çº¿ç¨‹å°†ä¼šåœæ­¢æ‰§è¡Œã€‚Thread.UncaughtExceptionHandleræ˜¯ç”¨äºå¤„ç†æœªæ•è·å¼‚å¸¸é€ æˆçº¿ç¨‹çªç„¶ä¸­æ–­æƒ…å†µçš„ä¸€ä¸ªå†…åµŒæ¥å£ã€‚å½“ä¸€ä¸ªæœªæ•è·å¼‚å¸¸å°†é€ æˆçº¿ç¨‹ä¸­æ–­çš„æ—¶å€™ï¼ŒJVM ä¼šä½¿ç”¨ Thread.getUncaughtExceptionHandler()æ¥æŸ¥è¯¢çº¿ç¨‹çš„ UncaughtExceptionHandler å¹¶å°†çº¿ç¨‹å’Œå¼‚å¸¸ä½œä¸ºå‚æ•°ä¼ é€’ç»™ handler çš„ uncaughtException()æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚ Java çº¿ç¨‹æ•°è¿‡å¤šä¼šé€ æˆä»€ä¹ˆå¼‚å¸¸ï¼Ÿ çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸå¼€é”€éå¸¸é«˜ æ¶ˆè€—è¿‡å¤šçš„ CPU èµ„æºå¦‚æœå¯è¿è¡Œçš„çº¿ç¨‹æ•°é‡å¤šäºå¯ç”¨å¤„ç†å™¨çš„æ•°é‡ï¼Œé‚£ä¹ˆæœ‰çº¿ç¨‹å°†ä¼šè¢«é—²ç½®ã€‚å¤§é‡ç©ºé—²çš„çº¿ç¨‹ä¼šå ç”¨è®¸å¤šå†…å­˜ï¼Œç»™åƒåœ¾å›æ”¶å™¨å¸¦æ¥å‹åŠ›ï¼Œè€Œä¸”å¤§é‡çš„çº¿ç¨‹åœ¨ç«äº‰ CPUèµ„æºæ—¶è¿˜å°†äº§ç”Ÿå…¶ä»–æ€§èƒ½çš„å¼€é”€ã€‚ é™ä½JVMç¨³å®šæ€§ åœ¨å¯åˆ›å»ºçº¿ç¨‹çš„æ•°é‡ä¸Šå­˜åœ¨ä¸€ä¸ªé™åˆ¶ï¼Œè¿™ä¸ªé™åˆ¶å€¼å°†éšç€å¹³å°çš„ä¸åŒè€Œä¸åŒï¼Œå¹¶ä¸”æ‰¿å—ç€å¤šä¸ªå› ç´ åˆ¶çº¦ï¼ŒåŒ…æ‹¬ JVM çš„å¯åŠ¨å‚æ•°ã€Thread æ„é€ å‡½æ•°ä¸­è¯·æ±‚æ ˆçš„å¤§å°ï¼Œä»¥åŠåº•å±‚æ“ä½œç³»ç»Ÿå¯¹çº¿ç¨‹çš„é™åˆ¶ç­‰ã€‚å¦‚æœç ´åäº†è¿™äº›é™åˆ¶ï¼Œé‚£ä¹ˆå¯èƒ½æŠ›å‡ºOutOfMemoryError å¼‚å¸¸ã€‚ ","link":"https://tianxiawuhao.github.io/h9DSVN_A0/"},{"title":" å¤šçº¿ç¨‹åŸºç¡€æ¦‚å¿µ","content":"ä»€ä¹ˆæ˜¯çº¿ç¨‹ æ˜¯æ“ä½œç³»ç»Ÿèƒ½å¤Ÿè¿›è¡Œè¿ç®—è°ƒåº¦çš„æœ€å°å•ä½ã€‚å®ƒè¢«åŒ…å«åœ¨è¿›ç¨‹ä¹‹ä¸­ï¼Œæ˜¯è¿›ç¨‹ä¸­çš„å®é™…è¿ä½œå•ä½ã€‚ çº¿ç¨‹å®‰å…¨çš„é—®é¢˜ å¹¶å‘ç¼–ç¨‹ä¸‰è¦ç´ æ˜¯ä»€ä¹ˆï¼Ÿåœ¨ Java ç¨‹åºä¸­æ€ä¹ˆä¿è¯å¤šçº¿ç¨‹çš„è¿è¡Œå®‰å…¨ï¼Ÿ å¹¶å‘ç¼–ç¨‹ä¸‰è¦ç´ ï¼ˆçº¿ç¨‹çš„å®‰å…¨æ€§é—®é¢˜ä½“ç°åœ¨ï¼‰ï¼š åŸå­æ€§ï¼šåŸå­ï¼Œå³ä¸€ä¸ªä¸å¯å†è¢«åˆ†å‰²çš„é¢—ç²’ã€‚åŸå­æ€§æŒ‡çš„æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªæ“ä½œè¦ä¹ˆå…¨éƒ¨æ‰§è¡ŒæˆåŠŸè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œå¤±è´¥ã€‚(synchronized,lock,unlock) å¯è§æ€§ï¼šä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹,å¦ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿç«‹åˆ»çœ‹åˆ°ã€‚ï¼ˆsynchronized,volatile,finalï¼‰ æœ‰åºæ€§ï¼šç¨‹åºæ‰§è¡Œçš„é¡ºåºæŒ‰ç…§ä»£ç çš„å…ˆåé¡ºåºæ‰§è¡Œã€‚ï¼ˆå¤„ç†å™¨å¯èƒ½ä¼šå¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºï¼‰ï¼ˆsynchronized,volatileï¼‰ å‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜çš„åŸå› ï¼š çº¿ç¨‹åˆ‡æ¢å¸¦æ¥çš„åŸå­æ€§é—®é¢˜ ç¼“å­˜å¯¼è‡´çš„å¯è§æ€§é—®é¢˜ ç¼–è¯‘ä¼˜åŒ–å¸¦æ¥çš„æœ‰åºæ€§é—®é¢˜ è§£å†³åŠæ³•ï¼š JDK Atomicå¼€å¤´çš„åŸå­ç±»ã€synchronizedã€LOCKï¼Œå¯ä»¥è§£å†³åŸå­æ€§é—®é¢˜ synchronizedã€volatileã€LOCKï¼Œå¯ä»¥è§£å†³å¯è§æ€§é—®é¢˜ Happens-Before è§„åˆ™å¯ä»¥è§£å†³æœ‰åºæ€§é—®é¢˜ å¹¶å‘ä¸å¹¶è¡Œ å¹¶å‘ï¼šå¤šä¸ªä»»åŠ¡åœ¨åŒä¸€ä¸ª CPU æ ¸ä¸Šï¼ŒæŒ‰ç»†åˆ†çš„æ—¶é—´ç‰‡è½®æµ(äº¤æ›¿)æ‰§è¡Œï¼Œä»é€»è¾‘ä¸Šæ¥çœ‹é‚£äº›ä»»åŠ¡æ˜¯åŒæ—¶æ‰§è¡Œã€‚ å¹¶è¡Œï¼šå•ä½æ—¶é—´å†…ï¼Œå¤šä¸ªå¤„ç†å™¨æˆ–å¤šæ ¸å¤„ç†å™¨åŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡ï¼Œæ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„â€œåŒæ—¶è¿›è¡Œâ€ã€‚ ä¸²è¡Œï¼šæœ‰nä¸ªä»»åŠ¡ï¼Œç”±ä¸€ä¸ªçº¿ç¨‹æŒ‰é¡ºåºæ‰§è¡Œã€‚ç”±äºä»»åŠ¡ã€æ–¹æ³•éƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œæ‰€ä»¥ä¸å­˜åœ¨çº¿ç¨‹ä¸å®‰å…¨æƒ…å†µï¼Œä¹Ÿå°±ä¸å­˜åœ¨ä¸´ç•ŒåŒºçš„é—®é¢˜ã€‚ å¹¶å‘ç¼–ç¨‹ï¼ˆå¤šçº¿ç¨‹ï¼‰çš„ä¼˜ç‚¹ æ—©æœŸçš„CPUæ˜¯å•æ ¸çš„ï¼Œä¸ºäº†æå‡è®¡ç®—èƒ½åŠ›ï¼Œå°†å¤šä¸ªè®¡ç®—å•å…ƒæ•´åˆåˆ°ä¸€èµ·ã€‚å½¢æˆäº†å¤šæ ¸CPUã€‚å¤šçº¿ç¨‹å°±æ˜¯ä¸ºäº†å°†å¤šæ ¸CPUå‘æŒ¥åˆ°æè‡´ï¼Œä¸€è¾¹æé«˜æ€§èƒ½ã€‚ æ–¹ä¾¿è¿›è¡Œä¸šåŠ¡æ‹†åˆ†ï¼Œæå‡ç³»ç»Ÿå¹¶å‘èƒ½åŠ›å’Œæ€§èƒ½ï¼šåœ¨ç‰¹æ®Šçš„ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œå…ˆå¤©çš„å°±é€‚åˆäºå¹¶å‘ç¼–ç¨‹ã€‚ç°åœ¨çš„ç³»ç»ŸåŠ¨ä¸åŠ¨å°±è¦æ±‚ç™¾ä¸‡çº§ç”šè‡³åƒä¸‡çº§çš„å¹¶å‘é‡ï¼Œè€Œå¤šçº¿ç¨‹å¹¶å‘ç¼–ç¨‹æ­£æ˜¯å¼€å‘é«˜å¹¶å‘ç³»ç»Ÿçš„åŸºç¡€ï¼Œåˆ©ç”¨å¥½å¤šçº¿ç¨‹æœºåˆ¶å¯ä»¥å¤§å¤§æé«˜ç³»ç»Ÿæ•´ä½“çš„å¹¶å‘èƒ½åŠ›ä»¥åŠæ€§èƒ½ã€‚é¢å¯¹å¤æ‚ä¸šåŠ¡æ¨¡å‹ï¼Œå¹¶è¡Œç¨‹åºä¼šæ¯”ä¸²è¡Œç¨‹åºæ›´é€‚åº”ä¸šåŠ¡éœ€æ±‚ï¼Œè€Œå¹¶å‘ç¼–ç¨‹æ›´èƒ½å»åˆè¿™ç§ä¸šåŠ¡æ‹†åˆ† å¹¶å‘ç¼–ç¨‹ï¼ˆå¤šçº¿ç¨‹ï¼‰çš„ç¼ºç‚¹ ä¸Šé¢è¯´äº†å¤šçº¿ç¨‹çš„ä¼˜ç‚¹æ˜¯ï¼šä¸ºäº†æé«˜è®¡ç®—æ€§èƒ½ã€‚é‚£ä¹ˆä¸€å®šä¼šæé«˜ï¼Ÿç­”æ¡ˆæ˜¯ä¸ä¸€å®šçš„ã€‚æœ‰æ—¶å€™å¤šçº¿ç¨‹ä¸ä¸€å®šæ¯”å•çº¿ç¨‹è®¡ç®—å¿« å¤šçº¿ç¨‹ä¼šå¸¦æ¥é¢å¤–çš„å¼€é”€å’Œå¤æ‚çš„é—®é¢˜ ä¸Šä¸‹æ–‡åˆ‡æ¢ æ­»é” å†…å­˜æ³„æ¼ ä¸Šä¸‹æ–‡åˆ‡æ¢ æ—¶é—´ç‰‡æ˜¯CPUåˆ†é…ç»™å„ä¸ªçº¿ç¨‹çš„æ—¶é—´ï¼Œå› ä¸ºæ—¶é—´éå¸¸çŸ­ï¼Œæ‰€ä»¥CPUä¸æ–­é€šè¿‡åˆ‡æ¢çº¿ç¨‹ï¼Œè®©æˆ‘ä»¬è§‰å¾—å¤šä¸ªçº¿ç¨‹æ˜¯åŒæ—¶æ‰§è¡Œçš„ï¼Œæ—¶é—´ç‰‡ä¸€èˆ¬æ˜¯å‡ åæ¯«ç§’ã€‚è€Œæ¯æ¬¡åˆ‡æ¢æ—¶ï¼Œéœ€è¦ä¿å­˜å½“å‰çš„çŠ¶æ€èµ·æ¥ï¼Œä»¥ä¾¿èƒ½å¤Ÿè¿›è¡Œæ¢å¤å…ˆå‰çŠ¶æ€ï¼Œè€Œè¿™ä¸ªåˆ‡æ¢æ—¶éå¸¸æŸè€—æ€§èƒ½ï¼Œè¿‡äºé¢‘ç¹åè€Œæ— æ³•å‘æŒ¥å‡ºå¤šçº¿ç¨‹ç¼–ç¨‹çš„ä¼˜åŠ¿ã€‚ å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢å¯ä»¥é‡‡ç”¨æ— é”å¹¶å‘ç¼–ç¨‹ï¼ŒCASç®—æ³•ï¼Œä½¿ç”¨æœ€å°‘çš„çº¿ç¨‹å’Œä½¿ç”¨åç¨‹ã€‚ æ— é”å¹¶å‘ç¼–ç¨‹ï¼šå¯ä»¥å‚ç…§concurrentHashMapé”åˆ†æ®µçš„æ€æƒ³ï¼Œä¸åŒçš„çº¿ç¨‹å¤„ç†ä¸åŒæ®µçš„æ•°æ®ï¼Œè¿™æ ·åœ¨å¤šçº¿ç¨‹ç«äº‰çš„æ¡ä»¶ä¸‹ï¼Œå¯ä»¥å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶é—´ã€‚ CASç®—æ³•ï¼Œåˆ©ç”¨Atomicä¸‹ä½¿ç”¨CASç®—æ³•æ¥æ›´æ–°æ•°æ®ï¼Œä½¿ç”¨äº†ä¹è§‚é”ï¼Œå¯ä»¥æœ‰æ•ˆçš„å‡å°‘ä¸€éƒ¨åˆ†ä¸å¿…è¦çš„é”ç«äº‰å¸¦æ¥çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ ä½¿ç”¨æœ€å°‘çº¿ç¨‹ï¼šé¿å…åˆ›å»ºä¸éœ€è¦çš„çº¿ç¨‹ï¼Œæ¯”å¦‚ä»»åŠ¡å¾ˆå°‘ï¼Œä½†æ˜¯åˆ›å»ºäº†å¾ˆå¤šçš„çº¿ç¨‹ï¼Œè¿™æ ·ä¼šé€ æˆå¤§é‡çš„çº¿ç¨‹éƒ½å¤„äºç­‰å¾…çŠ¶æ€ åç¨‹ï¼šåœ¨å•çº¿ç¨‹é‡Œå®ç°å¤šä»»åŠ¡çš„è°ƒåº¦ï¼Œå¹¶åœ¨å•çº¿ç¨‹é‡Œç»´æŒå¤šä¸ªä»»åŠ¡é—´çš„åˆ‡æ¢ çº¿ç¨‹æ­»é” æ­»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç”±äºç«äº‰èµ„æºæˆ–è€…ç”±äºå½¼æ­¤é€šä¿¡è€Œé€ æˆçš„ä¸€ç§é˜»å¡çš„ç°è±¡ï¼Œè‹¥æ— å¤–åŠ›ä½œç”¨ï¼Œå®ƒä»¬éƒ½å°†æ— æ³•æ¨è¿›ä¸‹å»ã€‚æ­¤æ—¶ç§°ç³»ç»Ÿå¤„äºæ­»é”çŠ¶æ€æˆ–ç³»ç»Ÿäº§ç”Ÿäº†æ­»é”ï¼Œè¿™äº›æ°¸è¿œåœ¨äº’ç›¸ç­‰å¾…çš„è¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰ç§°ä¸ºæ­»é”è¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰ã€‚ å¤šä¸ªçº¿ç¨‹åŒæ—¶è¢«é˜»å¡ï¼Œå®ƒä»¬ä¸­çš„ä¸€ä¸ªæˆ–è€…å…¨éƒ¨éƒ½åœ¨ç­‰å¾…æŸä¸ªèµ„æºè¢«é‡Šæ”¾ã€‚ç”±äºçº¿ç¨‹è¢«æ— é™æœŸåœ°é˜»å¡ï¼Œå› æ­¤ç¨‹åºä¸å¯èƒ½æ­£å¸¸ç»ˆæ­¢ã€‚ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œçº¿ç¨‹ A æŒæœ‰èµ„æº 2ï¼Œçº¿ç¨‹ B æŒæœ‰èµ„æº 1ï¼Œä»–ä»¬åŒæ—¶éƒ½æƒ³ç”³è¯·å¯¹æ–¹çš„èµ„æºï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªçº¿ç¨‹å°±ä¼šäº’ç›¸ç­‰å¾…è€Œè¿›å…¥æ­»é”çŠ¶æ€ã€‚ ä¸‹é¢é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜çº¿ç¨‹æ­»é”ï¼š public class DeadLockDemo { private static Object resource1 = new Object();//èµ„æº 1 private static Object resource2 = new Object();//èµ„æº 2 public static void main(String[] args) { new Thread(() -&gt; { synchronized (resource1) { System.out.println(Thread.currentThread() + &quot;get resource1&quot;); try { Thread.sleep(1000); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(Thread.currentThread() + &quot;waiting get resource2&quot;); synchronized (resource2) { System.out.println(Thread.currentThread() + &quot;get resource2&quot;); } } }, &quot;çº¿ç¨‹ 1&quot;).start(); new Thread(() -&gt; { synchronized (resource2) { System.out.println(Thread.currentThread() + &quot;get resource2&quot;); try { Thread.sleep(1000); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(Thread.currentThread() + &quot;waiting get resource1&quot;); synchronized (resource1) { System.out.println(Thread.currentThread() + &quot;get resource1&quot;); } } }, &quot;çº¿ç¨‹ 2&quot;).start(); } } è¾“å‡ºç»“æœ Thread[çº¿ç¨‹ 1,5,main]get resource1 Thread[çº¿ç¨‹ 2,5,main]get resource2 Thread[çº¿ç¨‹ 1,5,main]waiting get resource2 Thread[çº¿ç¨‹ 2,5,main]waiting get resource1 çº¿ç¨‹ A é€šè¿‡ synchronized (resource1) è·å¾— resource1 çš„ç›‘è§†å™¨é”ï¼Œç„¶åé€šè¿‡Thread.sleep(1000)ï¼›è®©çº¿ç¨‹ A ä¼‘çœ  1s ä¸ºçš„æ˜¯è®©çº¿ç¨‹ B å¾—åˆ°CPUæ‰§è¡Œæƒï¼Œç„¶åè·å–åˆ° resource2 çš„ç›‘è§†å™¨é”ã€‚çº¿ç¨‹ A å’Œçº¿ç¨‹ B ä¼‘çœ ç»“æŸäº†éƒ½å¼€å§‹ä¼å›¾è¯·æ±‚è·å–å¯¹æ–¹çš„èµ„æºï¼Œç„¶åè¿™ä¸¤ä¸ªçº¿ç¨‹å°±ä¼šé™·å…¥äº’ç›¸ç­‰å¾…çš„çŠ¶æ€ï¼Œè¿™ä¹Ÿå°±äº§ç”Ÿäº†æ­»é”ã€‚ä¸Šé¢çš„ä¾‹å­ç¬¦åˆäº§ç”Ÿæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ã€‚ å½¢æˆæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶æ˜¯ä»€ä¹ˆ äº’æ–¥æ¡ä»¶ï¼šçº¿ç¨‹(è¿›ç¨‹)å¯¹äºæ‰€åˆ†é…åˆ°çš„èµ„æºå…·æœ‰æ’å®ƒæ€§ï¼Œå³ä¸€ä¸ªèµ„æºåªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹(è¿›ç¨‹)å ç”¨ï¼Œç›´åˆ°è¢«è¯¥çº¿ç¨‹(è¿›ç¨‹)é‡Šæ”¾ è¯·æ±‚ä¸ä¿æŒæ¡ä»¶ï¼šä¸€ä¸ªçº¿ç¨‹(è¿›ç¨‹)å› è¯·æ±‚è¢«å ç”¨èµ„æºè€Œå‘ç”Ÿé˜»å¡æ—¶ï¼Œå¯¹å·²è·å¾—çš„èµ„æºä¿æŒä¸æ”¾ã€‚ ä¸å‰¥å¤ºæ¡ä»¶ï¼šçº¿ç¨‹(è¿›ç¨‹)å·²è·å¾—çš„èµ„æºåœ¨æœ«ä½¿ç”¨å®Œä¹‹å‰ä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹å¼ºè¡Œå‰¥å¤ºï¼Œåªæœ‰è‡ªå·±ä½¿ç”¨å®Œæ¯•åæ‰é‡Šæ”¾èµ„æºã€‚ å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼šå½“å‘ç”Ÿæ­»é”æ—¶ï¼Œæ‰€ç­‰å¾…çš„çº¿ç¨‹(è¿›ç¨‹)å¿…å®šä¼šå½¢æˆä¸€ä¸ªç¯è·¯ï¼ˆç±»ä¼¼äºæ­»å¾ªç¯ï¼‰ï¼Œé€ æˆæ°¸ä¹…é˜»å¡ å¦‚ä½•é¿å…çº¿ç¨‹æ­»é” æˆ‘ä»¬åªè¦ç ´åäº§ç”Ÿæ­»é”çš„å››ä¸ªæ¡ä»¶ä¸­çš„å…¶ä¸­ä¸€ä¸ªå°±å¯ä»¥äº†ã€‚ ç ´åäº’æ–¥æ¡ä»¶ è¿™ä¸ªæ¡ä»¶æˆ‘ä»¬æ²¡æœ‰åŠæ³•ç ´åï¼Œå› ä¸ºæˆ‘ä»¬ç”¨é”æœ¬æ¥å°±æ˜¯æƒ³è®©ä»–ä»¬äº’æ–¥çš„ï¼ˆä¸´ç•Œèµ„æºéœ€è¦äº’æ–¥è®¿é—®ï¼‰ã€‚ ç ´åè¯·æ±‚ä¸ä¿æŒæ¡ä»¶ ä¸€æ¬¡æ€§ç”³è¯·æ‰€æœ‰çš„èµ„æºã€‚ ç ´åä¸å‰¥å¤ºæ¡ä»¶ å ç”¨éƒ¨åˆ†èµ„æºçš„çº¿ç¨‹è¿›ä¸€æ­¥ç”³è¯·å…¶ä»–èµ„æºæ—¶ï¼Œå¦‚æœç”³è¯·ä¸åˆ°ï¼Œå¯ä»¥ä¸»åŠ¨é‡Šæ”¾å®ƒå æœ‰çš„èµ„æºã€‚ ç ´åå¾ªç¯ç­‰å¾…æ¡ä»¶ é æŒ‰åºç”³è¯·èµ„æºæ¥é¢„é˜²ã€‚æŒ‰æŸä¸€é¡ºåºç”³è¯·èµ„æºï¼Œé‡Šæ”¾èµ„æºåˆ™ååºé‡Šæ”¾ã€‚ç ´åå¾ªç¯ç­‰å¾…æ¡ä»¶ã€‚ åˆ›å»ºçº¿ç¨‹çš„å››ç§æ–¹å¼ åˆ›å»ºçº¿ç¨‹æœ‰å››ç§æ–¹å¼ï¼š ç»§æ‰¿ Thread ç±»ï¼› å®ç° Runnable æ¥å£ï¼› å®ç° Callable æ¥å£ï¼› ä½¿ç”¨ Executors å·¥å…·ç±»åˆ›å»ºçº¿ç¨‹æ±  ç»§æ‰¿ Thread ç±» æ­¥éª¤ å®šä¹‰Thread ç±»çš„å­ç±»ï¼Œå¹¶é‡å†™è¯¥ç±»çš„run() æ–¹æ³•ï¼Œè¯¥run() æ–¹æ³•çš„æ–¹æ³•ä½“å°±ä»£è¡¨ç±»çº¿ç¨‹éœ€è¦å®Œæˆçš„ä»»åŠ¡ã€‚å› æ­¤æŠŠrun() æ–¹æ³•ç§°ä¸ºçº¿ç¨‹æ‰§è¡Œä½“ã€‚ åˆ›å»º Thread å­ç±»çš„å®ä¾‹ï¼Œå³åˆ›å»ºçº¿ç¨‹å¯¹è±¡ è°ƒç”¨å­ç±»å®ä¾‹çš„star()æ–¹æ³•æ¥å¯åŠ¨çº¿ç¨‹ /** * ç»§æ‰¿ thread çš„å†…éƒ¨ç±»ï¼Œä»¥ä¹°ç¥¨ä¾‹å­ */ public class FirstThread extends Thread{ private int i; private int ticket = 10; @Override public void run() { for (;i&lt;20;i++) { //å½“ç»§æ‰¿thread æ—¶ï¼Œç›´æ¥ä½¿ç”¨this å¯ä»¥è·å–å½“å‰çš„çº¿ç¨‹,getName()è·å–å½“å‰çº¿ç¨‹çš„åå­— if(this.ticket&gt;0){ Log.e(TAG, getName() + &quot;, å–ç¥¨ï¼šticket=&quot; + ticket--); } } } } private void starTicketThread(){ Log.d(TAG,&quot;starTicketThread, &quot;+Thread.currentThread().getName()); FirstThread thread1 = new FirstThread(); FirstThread thread2 = new FirstThread(); FirstThread thread3 = new FirstThread(); thread1.start(); thread2.start(); thread3.start(); //å¼€å¯3ä¸ªçº¿ç¨‹è¿›è¡Œä¹°ç¥¨ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å–äº†10å¼ ï¼Œæ€»å…±å°±30å¼ ç¥¨ } è¿è¡Œç»“æœ æ³¨æ„ ï¼šå¯ä»¥çœ‹åˆ° 3 ä¸ªçº¿ç¨‹è¾“å…¥çš„ ç¥¨æ•°å˜é‡ä¸è¿ç»­ï¼Œæ³¨æ„ï¼šticket æ˜¯ FirstThread çš„å®ä¾‹å±æ€§ï¼Œè€Œä¸æ˜¯å±€éƒ¨å˜é‡ï¼Œä½†æ˜¯å› ä¸ºç¨‹åºæ¯æ¬¡åˆ›å»ºçº¿ç¨‹å¯¹è±¡éƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªFirstThread çš„å¯¹è±¡ï¼Œæ‰€æœ‰å¤šä¸ªçº¿ç¨‹ä¸å…±äº«è¯¥å®ä¾‹çš„å±æ€§ã€‚ //ä½¿ç”¨Lambdaè¡¨è¾¾å¼ï¼Œå®ç°å¤šçº¿ç¨‹ new Thread(() -&gt; { System.out.println(Thread.currentThread().getName() + &quot;æ–°çº¿ç¨‹åˆ›å»ºäº†ï¼&quot;); } ).start(); å®ç° Runnable æ¥å£ æ­¥éª¤ å®šä¹‰Runnableæ¥å£å®ç°ç±»SecondThreadï¼Œå¹¶é‡å†™run()æ–¹æ³• åˆ›å»ºSecondThreadå®ä¾‹secondThreadï¼Œä»¥secondThreadä½œä¸ºtargetåˆ›å»ºTheadå¯¹è±¡ï¼Œè¯¥Threadå¯¹è±¡æ‰æ˜¯çœŸæ­£çš„çº¿ç¨‹å¯¹è±¡ è°ƒç”¨çº¿ç¨‹å¯¹è±¡çš„start()æ–¹æ³• /** * å®ç° runnable æ¥å£ï¼Œåˆ›å»ºçº¿ç¨‹ç±» */ public class SecondThread implements Runnable{ private int i; private int ticket = 100; @Override public void run() { for (;i&lt;20;i++) { //å¦‚æœçº¿ç¨‹ç±»å®ç° runnable æ¥å£ //è·å–å½“å‰çš„çº¿ç¨‹ï¼Œåªèƒ½ç”¨ Thread.currentThread() è·å–å½“å‰çš„çº¿ç¨‹å Log.d(TAG,Thread.currentThread().getName()+&quot; &quot;+i); if(this.ticket&gt;0){ Log.e(TAG, Thread.currentThread().getName() + &quot;, å–ç¥¨ï¼šticket=&quot; + ticket--); } } } } private void starTicketThread2(){ Log.d(TAG,&quot;starTicketThread2, &quot;+Thread.currentThread().getName()); SecondThread secondThread = new SecondThread(); //é€šè¿‡new Thread(target,name)åˆ›å»ºæ–°çš„çº¿ç¨‹ new Thread(secondThread,&quot;ä¹°ç¥¨äºº1&quot;).start(); new Thread(secondThread,&quot;ä¹°ç¥¨äºº2&quot;).start(); new Thread(secondThread,&quot;ä¹°ç¥¨äºº3&quot;).start(); //è™½ç„¶æ˜¯å¼€å¯äº†3ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯ä¸€å…±åªä¹°äº†100å¼ ç¥¨ } æ‰§è¡Œç»“æœ æ³¨æ„ï¼šå¯ä»¥çœ‹åˆ° 3 ä¸ªçº¿ç¨‹è¾“å…¥çš„ ç¥¨æ•°å˜é‡æ˜¯è¿ç»­çš„ï¼Œé‡‡ç”¨ Runnable æ¥å£çš„æ–¹å¼åˆ›å»ºå¤šä¸ªçº¿ç¨‹å¯ä»¥å…±äº«çº¿ç¨‹ç±»çš„å®ä¾‹çš„å±æ€§ã€‚è¿™æ˜¯å› ä¸ºåœ¨è¿™ç§æ–¹å¼ä¸‹ï¼Œç¨‹åºæ‰€åˆ›å»ºçš„Runnable å¯¹è±¡åªæ˜¯çº¿ç¨‹çš„ target ,è€Œå¤šä¸ªçº¿ç¨‹å¯ä»¥å…±äº«åŒä¸€ä¸ª target,æ‰€ä»¥å¤šä¸ªçº¿ç¨‹å¯ä»¥å…±äº«åŒä¸€ä¸ªçº¿ç¨‹ç±»ï¼ˆå®é™…ä¸Šåº”è¯¥æ˜¯è¯¥çº¿ç¨‹çš„target ç±»ï¼‰çš„å®ä¾‹å±æ€§ã€‚ //ä½¿ç”¨åŒ¿åå†…éƒ¨ç±»çš„æ–¹å¼ï¼Œå®ç°å¤šçº¿ç¨‹ new Thread(new Runnable() { @Override public void run() { System.out.println(Thread.currentThread().getName() + &quot;æ–°çº¿ç¨‹åˆ›å»ºäº†ï¼&quot;); } }).start(); å®ç° Callable æ¥å£ æ­¥éª¤ åˆ›å»ºcallableæ¥å£çš„å®ç°ç±»ï¼Œå¹¶å®ç°call() æ–¹æ³•ï¼Œè¯¥call() æ–¹æ³•å°†ä½œä¸ºçº¿ç¨‹çš„æ‰§è¡Œä½“ï¼Œä¸”è¯¥call() æ–¹æ³•æ˜¯æœ‰è¿”å›å€¼çš„ã€‚ åˆ›å»º callableå®ç°ç±»çš„å®ä¾‹ï¼Œä½¿ç”¨ FutureTask ç±»æ¥åŒ…è£…Callableå¯¹è±¡ï¼Œè¯¥FutureTask å¯¹è±¡å°è£… call() æ–¹æ³•çš„è¿”å›å€¼ã€‚ ä½¿ç”¨FutureTask å¯¹è±¡ä½œä¸ºThreadå¯¹è±¡çš„targetåˆ›å»ºå¹¶å¯åŠ¨æ–°çº¿ç¨‹ã€‚ è°ƒç”¨FutureTaskå¯¹è±¡çš„get()æ–¹æ³•æ¥è·å–å­çº¿ç¨‹æ‰§è¡Œç»“æŸåçš„è¿”å›å€¼ã€‚ /** * ä½¿ç”¨callable æ¥å®ç°çº¿ç¨‹ç±» */ public class ThirdThread implements Callable&lt;Integer&gt;{ private int ticket = 20; @Override public Integer call(){ for ( int i = 0;i&lt;10;i++) { //è·å–å½“å‰çš„çº¿ç¨‹ï¼Œåªèƒ½ç”¨ Thread.currentThread() è·å–å½“å‰çš„çº¿ç¨‹å // Log.d(TAG,Thread.currentThread().getName()+&quot; &quot;+i); if(this.ticket&gt;0){ Log.e(TAG, Thread.currentThread().getName() + &quot;, å–ç¥¨ï¼šticket=&quot; + ticket--); } } return ticket; } } private void starCallableThread(){ ThirdThread thirdThread = new ThirdThread(); FutureTask&lt;Integer&gt; task = new FutureTask&lt;Integer&gt;(thirdThread); new Thread(task,&quot;æœ‰è¿”å›å€¼çš„çº¿ç¨‹&quot;).start(); try { Integer integer = task.get(); Log.d(TAG,&quot;starCallableThread, å­çº¿ç¨‹çš„è¿”å›å€¼=&quot;+integer); } catch (InterruptedException e) { e.printStackTrace(); } catch (ExecutionException e) { e.printStackTrace(); } } æ‰§è¡Œç»“æœ æ³¨æ„ï¼šæ³¨æ„ï¼šCallableçš„call() æ–¹æ³•å…è®¸å£°æ˜æŠ›å‡ºå¼‚å¸¸ï¼Œå¹¶ä¸”å…è®¸å¸¦æœ‰è¿”å›å€¼ã€‚ ç¨‹åºæœ€åè°ƒç”¨FutureTask å¯¹è±¡çš„get()æ–¹æ³•æ¥è¿”å›Call(ï¼‰æ–¹æ³•çš„è¿”å›å€¼ï¼Œå¯¼è‡´ä¸»çº¿ç¨‹è¢«é˜»å¡ï¼Œç›´åˆ°call()æ–¹æ³•ç»“æŸå¹¶è¿”å›ä¸ºæ­¢ã€‚ ä½¿ç”¨ Executors å·¥å…·ç±»åˆ›å»ºçº¿ç¨‹æ±  Executorsæä¾›äº†ä¸€ç³»åˆ—å·¥å‚æ–¹æ³•ç”¨äºåˆ›å…ˆçº¿ç¨‹æ± ï¼Œè¿”å›çš„çº¿ç¨‹æ± éƒ½å®ç°äº†ExecutorServiceæ¥å£ã€‚ ä¸»è¦æœ‰newFixedThreadPoolï¼ŒnewCachedThreadPoolï¼ŒnewSingleThreadExecutorï¼ŒnewScheduledThreadPoolï¼Œåç»­è¯¦ç»†ä»‹ç»è¿™å››ç§çº¿ç¨‹æ±  public class MyRunnable implements Runnable { @Override public void run() { System.out.println(Thread.currentThread().getName() + &quot; run()æ–¹æ³•æ‰§è¡Œä¸­...&quot;); } } public class SingleThreadExecutorTest { public static void main(String[] args) { ExecutorService executorService = Executors.newSingleThreadExecutor(); MyRunnable runnableTest = new MyRunnable(); for (int i = 0; i &lt; 5; i++) { executorService.execute(runnableTest); } System.out.println(&quot;çº¿ç¨‹ä»»åŠ¡å¼€å§‹æ‰§è¡Œ&quot;); executorService.shutdown(); } } æ‰§è¡Œç»“æœ è¯´ä¸€ä¸‹ runnable å’Œ callable æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ ç›¸åŒç‚¹ éƒ½æ˜¯æ¥å£ éƒ½å¯ä»¥ç¼–å†™å¤šçº¿ç¨‹ç¨‹åº éƒ½é‡‡ç”¨Thread.start()å¯åŠ¨çº¿ç¨‹ ä¸»è¦åŒºåˆ« Runnable æ¥å£ run æ–¹æ³•æ— è¿”å›å€¼ï¼›Callable æ¥å£ call æ–¹æ³•æœ‰è¿”å›å€¼ï¼Œæ˜¯ä¸ªæ³›å‹ï¼Œå’ŒFutureã€FutureTaské…åˆå¯ä»¥ç”¨æ¥è·å–å¼‚æ­¥æ‰§è¡Œçš„ç»“æœ Runnable æ¥å£ run æ–¹æ³•åªèƒ½æŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸ï¼Œä¸”æ— æ³•æ•è·å¤„ç†ï¼›Callable æ¥å£ call æ–¹æ³•å…è®¸æŠ›å‡ºå¼‚å¸¸ï¼Œå¯ä»¥è·å–å¼‚å¸¸ä¿¡æ¯ æ³¨ï¼šCallalbeæ¥å£æ”¯æŒè¿”å›æ‰§è¡Œç»“æœï¼Œéœ€è¦è°ƒç”¨FutureTask.get()å¾—åˆ°ï¼Œæ­¤æ–¹æ³•ä¼šé˜»å¡ä¸»è¿›ç¨‹çš„ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œå¦‚æœä¸è°ƒç”¨ä¸ä¼šé˜»å¡ã€‚ çº¿ç¨‹çš„ run()å’Œ start()æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ æ¯ä¸ªçº¿ç¨‹éƒ½æ˜¯é€šè¿‡æŸä¸ªç‰¹å®šThreadå¯¹è±¡æ‰€å¯¹åº”çš„æ–¹æ³•run()æ¥å®Œæˆå…¶æ“ä½œçš„ï¼Œrun()æ–¹æ³•ç§°ä¸ºçº¿ç¨‹ä½“ã€‚é€šè¿‡è°ƒç”¨Threadç±»çš„start()æ–¹æ³•æ¥å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ã€‚ start() æ–¹æ³•ç”¨äºå¯åŠ¨çº¿ç¨‹ï¼Œrun() æ–¹æ³•ç”¨äºæ‰§è¡Œçº¿ç¨‹çš„è¿è¡Œæ—¶ä»£ç ã€‚run() å¯ä»¥é‡å¤è°ƒç”¨ï¼Œè€Œ start() åªèƒ½è°ƒç”¨ä¸€æ¬¡ã€‚ ä¸ºä»€ä¹ˆæˆ‘ä»¬è°ƒç”¨ start() æ–¹æ³•æ—¶ä¼šæ‰§è¡Œ run() æ–¹æ³•ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½ç›´æ¥è°ƒç”¨ run() æ–¹æ³•ï¼Ÿ new ä¸€ä¸ª Threadï¼Œçº¿ç¨‹è¿›å…¥äº†æ–°å»ºçŠ¶æ€ã€‚è°ƒç”¨ start() æ–¹æ³•ï¼Œä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å¹¶ä½¿çº¿ç¨‹è¿›å…¥äº†å°±ç»ªçŠ¶æ€ï¼Œå½“åˆ†é…åˆ°æ—¶é—´ç‰‡åå°±å¯ä»¥å¼€å§‹è¿è¡Œäº†ã€‚ start() ä¼šæ‰§è¡Œçº¿ç¨‹çš„ç›¸åº”å‡†å¤‡å·¥ä½œï¼Œç„¶åè‡ªåŠ¨æ‰§è¡Œ run() æ–¹æ³•çš„å†…å®¹ï¼Œè¿™æ˜¯çœŸæ­£çš„å¤šçº¿ç¨‹å·¥ä½œã€‚ è€Œç›´æ¥æ‰§è¡Œ run() æ–¹æ³•ï¼Œä¼šæŠŠ run æ–¹æ³•å½“æˆä¸€ä¸ª main çº¿ç¨‹ä¸‹çš„æ™®é€šæ–¹æ³•å»æ‰§è¡Œï¼Œå¹¶ä¸ä¼šåœ¨æŸä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œå®ƒï¼Œæ‰€ä»¥è¿™å¹¶ä¸æ˜¯å¤šçº¿ç¨‹å·¥ä½œã€‚ æ€»ç»“ï¼š è°ƒç”¨ start æ–¹æ³•æ–¹å¯å¯åŠ¨çº¿ç¨‹å¹¶ä½¿çº¿ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œè€Œ run æ–¹æ³•åªæ˜¯ thread çš„ä¸€ä¸ªæ™®é€šæ–¹æ³•è°ƒç”¨ï¼Œè¿˜æ˜¯åœ¨ä¸»çº¿ç¨‹é‡Œæ‰§è¡Œã€‚ ä»€ä¹ˆæ˜¯ Callable å’Œ Future? Callable æ¥å£ç±»ä¼¼äº Runnableï¼Œä»åå­—å°±å¯ä»¥çœ‹å‡ºæ¥äº†ï¼Œä½†æ˜¯ Runnable ä¸ä¼šè¿”å›ç»“æœï¼Œå¹¶ä¸”æ— æ³•æŠ›å‡ºè¿”å›ç»“æœçš„å¼‚å¸¸ï¼Œè€Œ Callable åŠŸèƒ½æ›´å¼ºå¤§ä¸€äº›ï¼Œè¢«çº¿ç¨‹æ‰§è¡Œåï¼Œå¯ä»¥è¿”å›å€¼ï¼Œè¿™ä¸ªè¿”å›å€¼å¯ä»¥è¢« Future æ‹¿åˆ°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒFuture å¯ä»¥æ‹¿åˆ°å¼‚æ­¥æ‰§è¡Œä»»åŠ¡çš„è¿”å›å€¼ã€‚ Future æ¥å£è¡¨ç¤ºå¼‚æ­¥ä»»åŠ¡ï¼Œæ˜¯ä¸€ä¸ªå¯èƒ½è¿˜æ²¡æœ‰å®Œæˆçš„å¼‚æ­¥ä»»åŠ¡çš„ç»“æœã€‚æ‰€ä»¥è¯´ Callableç”¨äºäº§ç”Ÿç»“æœï¼ŒFuture ç”¨äºè·å–ç»“æœã€‚ ä»€ä¹ˆæ˜¯ FutureTask FutureTask è¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥è¿ç®—çš„ä»»åŠ¡ã€‚FutureTask é‡Œé¢å¯ä»¥ä¼ å…¥ä¸€ä¸ª Callable çš„å…·ä½“å®ç°ç±»ï¼Œå¯ä»¥å¯¹è¿™ä¸ªå¼‚æ­¥è¿ç®—çš„ä»»åŠ¡çš„ç»“æœè¿›è¡Œç­‰å¾…è·å–ã€åˆ¤æ–­æ˜¯å¦å·²ç»å®Œæˆã€å–æ¶ˆä»»åŠ¡ç­‰æ“ä½œã€‚åªæœ‰å½“è¿ç®—å®Œæˆçš„æ—¶å€™ç»“æœæ‰èƒ½å–å›ï¼Œå¦‚æœè¿ç®—å°šæœªå®Œæˆ get æ–¹æ³•å°†ä¼šé˜»å¡ã€‚ä¸€ä¸ª FutureTask å¯¹è±¡å¯ä»¥å¯¹è°ƒç”¨äº† Callable å’Œ Runnable çš„å¯¹è±¡è¿›è¡ŒåŒ…è£…ï¼Œç”±äº FutureTask ä¹Ÿæ˜¯Runnable æ¥å£çš„å®ç°ç±»ï¼Œæ‰€ä»¥ FutureTask ä¹Ÿå¯ä»¥æ”¾å…¥çº¿ç¨‹æ± ä¸­ã€‚ ","link":"https://tianxiawuhao.github.io/ddmZREDcW/"},{"title":"javaåŸºç¡€ä¹‹ä¸€æ–‡ä»¶æ“ä½œ","content":" ä¸€ã€æŠ½è±¡ç±»ï¼š å­—èŠ‚æµï¼š InputStreamï¼ˆè¯»å…¥æµï¼‰ OutputStream(å†™å‡ºæµï¼‰ å­—ç¬¦æµï¼š Readerï¼ˆå­—ç¬¦ è¯»å…¥æµï¼‰ Writer ï¼ˆå­—ç¬¦å†™å‡ºæµï¼‰ å­—èŠ‚æµè¯»å–å­—ç¬¦æ•°æ®çš„é—®é¢˜ : æ±‰å­—ç­‰å­—ç¬¦,å¾€å¾€æœ‰å¤šä¸ªå­—èŠ‚ç»„æˆ,é‚£ä¹ˆåˆ°åº•å“ªå‡ ä¸ªå­—èŠ‚åº”è¯¥ç»„æˆä¸€ä¸ªæ±‰å­—å‘¢? å­—èŠ‚æµä¸çŸ¥é“.å¦‚æœæˆ‘ä»¬è‡ªå·±ç”¨å­—èŠ‚æµè¯»å–å­—èŠ‚æ•°æ®,ç„¶åæ‰‹åŠ¨è‡ªå·±è½¬å­—ç¬¦,å°±æœ‰å¯èƒ½å¯¹è§„åˆ™ä¸äº†è§£.ä»è€Œé€ æˆé”™è¯¯. Javaä¸­çš„å­—ç¬¦æµæ°å¥½å°±å¯ä»¥å¸®åŠ©æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜. Javaæä¾›çš„å­—ç¬¦æµçš„åº•å±‚ï¼Œå®ƒè‡ªå·±ä¼šæ ¹æ®è¯»å–åˆ°çš„å­—èŠ‚æ•°æ®çš„ç‰¹ç‚¹ï¼Œç„¶åè‡ªåŠ¨çš„å¸®åŠ©æˆ‘ä»¬æŠŠå­—èŠ‚è½¬æˆå­—ç¬¦ï¼Œæœ€åæˆ‘ä»¬å°±ä¼šè‡ªç„¶çš„å¾—åˆ°æƒ³è¦çš„å­—ç¬¦æ•°æ®ã€‚ å­—ç¬¦æµæ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢? â€‹ å­—ç¬¦æµ = å­—èŠ‚æµ + ç¼–ç è¡¨ ç¼–ç è¡¨å…¶å®é‡Œé¢å®šä¹‰äº†å­—èŠ‚ä¸å­—ç¬¦çš„è½¬æ¢è§„åˆ™. å­—ç¬¦æµåœ¨è¯»å–æ•°æ®çš„æ—¶å€™,åº•å±‚è¿˜æ˜¯å­—èŠ‚æµåœ¨è¯»å–æ•°æ®,å­—ç¬¦æµä¼šè‡ªåŠ¨æ ¹æ®ç¼–ç è§„åˆ™æŠŠå­—èŠ‚æ•°æ®è½¬ä¸ºå­—ç¬¦æ•°æ®,å°±ä¸ä¼šé€ æˆé”™è¯¯! ç¼–ç è¡¨çš„ä»‹ç» : è¯´æ˜ : è®¡ç®—æœºä¸­ä¿å­˜çš„æ•°æ®éƒ½æ˜¯äºŒè¿›åˆ¶ï¼ˆ1010100101001ï¼‰ï¼Œæˆ‘ä»¬è¦æŠŠç”Ÿæ´»ä¸­çš„æ•°æ®ä¿å­˜åˆ°è®¡ç®—æœºä¸­ï¼Œéœ€è¦æŠŠç”Ÿæ´»ä¸­çš„æ•°æ®è½¬æˆäºŒè¿›åˆ¶æ•°æ®ï¼Œç„¶åæ‰èƒ½è®©è®¡ç®—æœºæ¥è¯†åˆ«ç”Ÿæ´»ä¸­çš„æ•°æ®ï¼Œè¿›è€Œå¯¹è¿™äº›æ•°æ®è¿›è¡Œå¤„ç†ã€‚ &quot;è¡¥å…… :&quot; è¦æŠŠç”Ÿæ´»ä¸­çš„æ•°æ®è½¬æˆè®¡ç®—æœºèƒ½å¤Ÿè¯†åˆ«çš„æ•°æ®ï¼Œå°±éœ€è¦å®šä¹‰ä¸€ä¸ªå›ºå®šçš„è½¬æ¢å…³ç³»ï¼š è€ç¾ä»–ä»¬ä¸ºäº†æŠŠè‡ªå·±çš„ç”Ÿæ´»ä¸­çš„æ•°æ®ä¿å­˜åˆ°è®¡ç®—æœºä¸­ï¼Œä»–ä»¬å‘æ˜äº†ä¸€å¼ è¡¨ï¼Œç„¶ååœ¨è¿™å¼ è¡¨ä¸­è§„å®šäº†ç”Ÿæ´»ä¸­æ‰€æœ‰çš„å­—ç¬¦å’ŒäºŒè¿›åˆ¶ä¹‹é—´çš„å¯¹åº”å…³ç³»ï¼šè€ç¾çš„æ–‡å­—å’Œè®¡ç®—æœºä¸­çš„äºŒè¿›åˆ¶çš„å¯¹åº”å…³ç³»è¡¨ï¼šASCIIã€‚ ASCIIç è¡¨ï¼š å®ƒé‡‡ç”¨çš„æ˜¯ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºæ‰€æœ‰çš„æ–‡å­—ï¼ˆæ ‡ç‚¹ç¬¦å·ï¼Œè‹±æ–‡å­—æ¯ï¼Œå…¶ä»–çš„ç‰¹æ®Šç¬¦å·ï¼Œæ•°å­—ç­‰ï¼‰ã€‚ ç”Ÿæ´»ä¸­çš„å­—ç¬¦ åè¿›åˆ¶ äºŒè¿›åˆ¶ A 65 01000001 B 66 01000010 æ¬§æ´²ä¹Ÿå®šä¹‰ä¸€å¼ æ‹‰ä¸ç è¡¨ï¼šISO-8859-1 è¿™ä¸ªè¡¨ç è¡¨å…¼å®¹ASCIIç è¡¨ã€‚ä¹Ÿé‡‡ç”¨çš„ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºå­—ç¬¦æ•°æ®ã€‚ ASCIIï¼š ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼š 0xxx xxxx è§„å®šäºŒè¿›åˆ¶çš„æœ€é«˜ä½æ˜¯0ï¼Œå…¶ä»–çš„7ä½è¡¨ç¤ºæŸä¸ªå­—ç¬¦çš„ç¼–ç å€¼ã€‚ ISO-8859-1ï¼š ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼šæŠŠæ•´ä¸ªå­—èŠ‚è¡¨ç¤ºå­—ç¬¦ï¼Œxxxx xxxx å…¨éƒ¨ç”¨æ¥è¡¨ç¤ºå­—ç¬¦æ•°æ® ä¸­å›½çš„ç¼–ç è¡¨ï¼š GBKç¼–ç è¡¨é‡‡ç”¨2ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªæ±‰å­—ã€‚ GB2312 ï¼š å®ƒè¯†åˆ«å…­ä¸ƒåƒçš„æ–‡å­—ã€‚å…¼å®¹ASCIIç¼–ç è¡¨ã€‚ GBKï¼š è¯†åˆ«ä¸¤ä¸‡å¤šå­—ç¬¦ã€‚ç›®å‰ä¸»æµçš„ç¼–ç è¡¨. GB18030ï¼š è¯†åˆ«æ›´å¤šã€‚ ä¸–ç•Œè®¡ç®—æœºåä¼šä¹Ÿåˆ¶å®šäº†ä¸€ä¸ªå¼ å›½é™…é€šç”¨çš„ç¼–ç è¡¨ï¼š â€‹ Unicodeç¼–ç è¡¨ï¼š å®ƒä¹Ÿé‡‡ç”¨2ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ã€‚ Unicodeç¼–ç è¡¨å‡çº§ï¼šUTF-8ã€‚ â€‹ UTF-8ï¼š å®ƒå¯¹å­—ç¬¦çš„ç¼–ç è§„å¾‹å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºçš„å­—ç¬¦å°±ä½¿ç”¨ä¸€ä¸ªå­—èŠ‚ã€‚ å¯ä»¥ä½¿ç”¨ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºçš„å­—ç¬¦å°±ä½¿ç”¨ä¸¤ä¸ªå­—èŠ‚ã€‚ å¯ä»¥ä½¿ç”¨ä¸‰ä¸ªå­—èŠ‚è¡¨ç¤ºçš„å­—ç¬¦å°±ä½¿ç”¨ä¸‰ä¸ªå­—èŠ‚ï¼ˆåŸºæœ¬æ±‰å­—éƒ½ä½¿ç”¨ä¸‰ä¸ªå­—èŠ‚ï¼‰ã€‚ å¯ä»¥è¯†åˆ«æ±‰å­—çš„ç¼–ç è¡¨ï¼š GB2312ã€GBKã€Unicodeã€UTF-8 äºŒã€æ–‡ä»¶æ“ä½œæµ å­—èŠ‚æµï¼š FileInputStream ï¼ŒFileOutputStream å­—ç¬¦æµï¼š FileReader, FileWriter File file = new File(&quot;D:/test/testIO.java&quot;); InputStream in = new FileInputStream(file); InputStream in = new FileInputStream(&quot;D:/test/testIO.java&quot;); OutputStream out = new FileOutputStream(file); OutputStream out = new FileOutputStream(&quot;D:/test/testIO.java&quot;); Reader reader = new FileReader(&quot;demo01.txt&quot;); FileWriter writer = new FileWriter(&quot;demo02.txt&quot;); Writer writer = new OutputStreamWriter(new FileOutputStream(&quot;demo03_utf8.txt&quot;), &quot;UTF-8&quot;); Reader reader = new InputStreamReader(new FileInputStream(&quot;demo03_utf8.txt&quot;), &quot;UTF-8&quot;); //1.æŒ‡å®šè¦è¯» çš„æ–‡ä»¶ç›®å½•åŠåç§° File file =new File(&quot;æ–‡ä»¶è·¯å¾„&quot;); //2.åˆ›å»ºæ–‡ä»¶è¯»å…¥æµå¯¹è±¡ FileInputStream fis =new FileInputStream(file); //3.å®šä¹‰ç»“æŸæ ‡å¿—,å¯ç”¨å­—èŠ‚æ•°ç»„è¯»å– int i =0 ; while((i = fis.read())!=-1){ //i å°±æ˜¯ä»æ–‡ä»¶ä¸­è¯»å–çš„å­—èŠ‚ï¼Œè¯»å®Œåè¿”å›-1 } //4.å…³é—­æµ fis.close(); //5.å¤„ç†å¼‚å¸¸ //1.æŒ‡å®šè¦å†™åˆ°çš„æ–‡ä»¶ç›®å½•åŠåç§° File file =new File(&quot;æ–‡ä»¶è·¯å¾„&quot;); //2.åˆ›å»ºæ–‡ä»¶è¯»å…¥æµå¯¹è±¡ FileOutputStream fos =new FileOutputStream(file); //3.å®šä¹‰ç»“æŸæ ‡å¿— fos.write(è¦å†™å‡ºçš„å­—èŠ‚æˆ–è€…å­—èŠ‚æ•°ç»„); //4.åˆ·æ–°å’Œå…³é—­æµ fos.flush(); fos.close(); //5.å¤„ç†å¼‚å¸¸ ä¸‰ã€ç¼“å†²æµï¼š â€‹ å­—èŠ‚ç¼“å†²æµï¼š BufferedInputStream,BufferedOutputStream â€‹ å­—ç¬¦ç¼“å†²æµï¼šBufferedReader ,BufferedWriter â€‹ ç¼“å†²æµæ˜¯å¯¹æµçš„æ“ä½œçš„åŠŸèƒ½çš„åŠ å¼ºï¼Œæé«˜äº†æ•°æ®çš„è¯»å†™æ•ˆç‡ã€‚æ—¢ç„¶ç¼“å†²æµæ˜¯å¯¹æµçš„åŠŸèƒ½å’Œè¯»å†™æ•ˆç‡çš„åŠ å¼ºå’Œæé«˜ï¼Œæ‰€ä»¥åœ¨åˆ›å»ºç¼“å†²æµçš„å¯¹è±¡æ—¶åº”è¯¥è¦ä¼ å…¥è¦åŠ å¼ºçš„æµå¯¹è±¡ã€‚ //ä¿å­˜å…¶å‚æ•°ï¼Œå³è¾“å…¥æµ inï¼Œä»¥ä¾¿å°†æ¥ä½¿ç”¨ã€‚åˆ›å»ºä¸€ä¸ªå†…éƒ¨ç¼“å†²åŒºæ•°ç»„å¹¶å°† //å…¶å­˜å‚¨åœ¨ buf ä¸­,è¯¥bufçš„å¤§å°é»˜è®¤ä¸º8192ã€‚ public BufferedInputStream(InputStream in); //åˆ›å»ºå…·æœ‰æŒ‡å®šç¼“å†²åŒºå¤§å°çš„ BufferedInputStream å¹¶ä¿å­˜å…¶å‚æ•°ï¼Œ //å³è¾“å…¥æµ inï¼Œä»¥ä¾¿å°†æ¥ä½¿ç”¨ã€‚åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º size çš„å†…éƒ¨ç¼“å†²åŒºæ•°ç»„å¹¶ //å°†å…¶å­˜å‚¨åœ¨ buf ä¸­ã€‚ public BufferedInputStream(InputStream in,int size); //åˆ›å»ºä¸€ä¸ªæ–°çš„ç¼“å†²è¾“å‡ºæµï¼Œä»¥å°†æ•°æ®å†™å…¥æŒ‡å®šçš„åº•å±‚è¾“å‡ºæµã€‚ public BufferedOutputStream(OutputStream out); //åˆ›å»ºä¸€ä¸ªæ–°çš„ç¼“å†²è¾“å‡ºæµï¼Œä»¥å°†å…·æœ‰æŒ‡å®šç¼“å†²åŒºå¤§å°çš„æ•°æ®å†™å…¥æŒ‡å®šçš„åº•å±‚è¾“å‡ºæµã€‚ public BufferedOutputStream(OutputStream out,int size); BufferedWriter bw = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(&quot;demo08_utf8.txt&quot;), &quot;UTF-8&quot;)); BufferedReader br = new BufferedReader(new InputStreamReader(new FileInputStream(&quot;demo08_utf8.txt&quot;), &quot;UTF-8&quot;)); //1.æŒ‡å®šè¦è¯» çš„æ–‡ä»¶ç›®å½•åŠåç§° File file =new File(&quot;æ–‡ä»¶è·¯å¾„&quot;); //2.åˆ›å»ºæ–‡ä»¶è¯»å…¥æµå¯¹è±¡ FileInputStream fis =new FileInputStream(file); //3.åˆ›å»ºç¼“å†²æµå¯¹è±¡åŠ å¼ºfisåŠŸèƒ½ BufferedInputStream bis =new BufferedInputStream(fis); //4.å®šä¹‰ç»“æŸæ ‡å¿—,å¯ç”¨å­—èŠ‚æ•°ç»„è¯»å– int i =0 ; while((i = bis.read())!=-1){ //i å°±æ˜¯ä»æ–‡ä»¶ä¸­è¯»å–çš„å­—èŠ‚ï¼Œè¯»å®Œåè¿”å›-1 } //5.å…³é—­æµ bis.close(); //6.å¤„ç†å¼‚å¸¸ //1.æŒ‡å®šè¦å†™åˆ°çš„æ–‡ä»¶ç›®å½•åŠåç§° File file =new File(&quot;æ–‡ä»¶è·¯å¾„&quot;); //2.åˆ›å»ºæ–‡ä»¶è¯»å…¥æµå¯¹è±¡ FileOutputStream fos =new FileOutputStream(file); //3.åˆ›å»ºç¼“å†²æµå¯¹è±¡åŠ å¼ºfosåŠŸèƒ½ BufferedOutputStream bos=new BufferedOutputStream(fos); //4.å‘æµä¸­å†™å…¥æ•°æ® bos.write(è¦å†™å‡ºçš„å­—èŠ‚æˆ–è€…å­—èŠ‚æ•°ç»„); //5.åˆ·æ–°å’Œå…³é—­æµ bos.flush(); bos.close(); //6.å¤„ç†å¼‚å¸¸ ç”±ä»¥ä¸Šçœ‹å‡ºæµçš„æ“ä½œåŸºæœ¬ç›¸åŒï¼Œæ­¤æµä¸æ–‡ä»¶æµæ“ä½œæ˜¯å‡ ä¹ä¸€æ ·çš„åªæ˜¯å°†æ–‡ä»¶æµä½œä¸ºå‚æ•°ä¼ å…¥ç¼“å†²æµçš„æ„é€ æ–¹æ³•ä¸­å †æ–‡ä»¶æµè¯»å†™æ–‡ä»¶çš„åŠŸèƒ½è¿›è¡ŒåŠ å¼º æ³¨1ï¼šåœ¨å­—ç¬¦è¯»å…¥ç¼“å†²æµBufferedReader ä¸­è¿˜æä¾›äº†è¯»ä¸€è¡Œçš„æ–¹æ³• readLine() å¯ä»¥è¯»å–ä¸€è¡Œæ–‡æœ¬ åœ¨å­—ç¬¦å†™å‡ºç¼“å†²æµBufferedWriter ä¸­è¿˜æä¾›äº†å†™å…¥ä¸€ä¸ªè¡Œåˆ†éš”ç¬¦çš„æ–¹æ³•writeLine(),ç”¨äºå†™å‡ºæ—¶æ¢è¡Œ æ³¨2ï¼šæ­¤å¤„ç”¨åˆ°çš„æ˜¯è®¾è®¡æ¨¡å¼ä¸­çš„è£…é¥°æ¨¡å¼ //è£…é¥°çš„å¯¹è±¡åªè¦æ˜¯æŠ½è±¡ç±»çš„å­ç±»å³å¯ BufferedInputStream bis =new BufferedInputStream(new FileInputStream(new File(&quot;æ–‡ä»¶è·¯å¾„&quot;))); å››ã€è½¬æ¢æµï¼š è¿™ç±»æµæ˜¯ç”¨äºå°†å­—ç¬¦è½¬æ¢ä¸ºå­—èŠ‚è¾“å…¥è¾“å‡ºï¼Œç”¨äºæ“ä½œå­—ç¬¦æ–‡ä»¶ï¼Œå±äºå­—ç¬¦æµçš„å­ç±»ï¼Œæ‰€ä»¥åç¼€ä¸ºreaderï¼Œwriterï¼›å‰ç¼€inputstreamï¼Œoutputstreamï¼› æ³¨ ï¼šè¦ä¼ å…¥å­—èŠ‚æµä½œä¸ºå‚èµ› InputStreamReader: å­—ç¬¦è½¬æ¢è¾“å‡ºæµ OutputStreamWriterï¼šå­—ç¬¦è½¬æ¢è¾“å…¥æµ éœ€æ±‚ï¼šè¯»å–é”®ç›˜è¾“å…¥çš„ä¸€è¡Œæ–‡æœ¬,å†å°†è¾“å…¥çš„å†™åˆ°æœ¬åœ°ç£ç›˜ä¸Š //1.è·å–é”®ç›˜è¾“å…¥çš„å­—èŠ‚æµå¯¹è±¡in InputStream in =Stream.in; /*2.ç”¨è½¬æ¢æµå°†å­—èŠ‚æµå¯¹è±¡è½¬æ¢ä¸ºå­—ç¬¦æµå¯¹è±¡ï¼Œæ–¹ä¾¿è°ƒç”¨å­—ç¬¦ç¼“å†²æµçš„readeLine()æ–¹æ³•*/ InputStreamReader isr =new InputStreamReader(in); /*5.åˆ›å»ºå­—ç¬¦è½¬æ¢è¾“å‡ºæµå¯¹è±¡oswï¼Œæ–¹ä¾¿æŠŠè¾“å…¥çš„å­—ç¬¦æµè½¬æ¢ä¸ºå­—èŠ‚è¾“å‡ºåˆ°æœ¬åœ°æ–‡ä»¶ã€‚*/ OutputStreamWriter osw =new OutputStreamWriter(new FileOutputStream(new File(&quot;æ–‡ä»¶å&quot;))); /*3.ç°åœ¨isræ˜¯å­—ç¬¦æµï¼Œå¯ä»¥ä½œä¸ºå‚æ•°ä¼ å…¥å­—ç¬¦ç¼“å†²æµä¸­*/ BufferedReader br =new BufferedReader(isr); /*4.å¯ä»¥è°ƒç”¨å­—ç¬¦ç¼“å†²æµbrçš„readLine()æ–¹æ³•åº¦ä¸€è¡Œè¾“å…¥æ–‡æœ¬*/ String line =null; while((line =br.readLine()){ osw.write(line);//oswæ˜¯å­—ç¬¦æµå¯¹è±¡ï¼Œå¯ä»¥ç›´æ¥æ“ä½œå­—ç¬¦ä¸² } //åˆ·æ–°æ­¤ç¼“å†²çš„è¾“å‡ºæµï¼Œä¿è¯æ•°æ®å…¨éƒ¨éƒ½èƒ½å†™å‡º osw.flush(); br.close(); osw.close(); è¯»å–æ•°æ® //è¯»å–æ–¹å¼ä¸€ : æ•ˆç‡ä½! int content = -1; while ((content = reader.read()) != -1) { System.out.print((char)content); } //è¯»å–æ–¹å¼äºŒ : æ•°ç»„ä¹‹åçš„æ— ç”¨æ•°æ®éƒ½ä¼šè¢«è¯»å–! int len = -1; char[] cbuf = new char[1024]; while ((len = reader.read(cbuf)) != -1) { System.out.println(cbuf); } // è¯»å–æ–¹å¼ä¸‰ : å°†è¯»å–çš„æ•°æ®å†…å®¹è½¬æ¢ä¸º `å­—ç¬¦ä¸²` int len = -1; char[] cbuf = new char[1024]; while ((len = reader.read(cbuf)) != -1) { String str = new String(cbuf, 0, len); System.out.println(str); } &quot;è½¬æ¢æµ å’Œ æ“ä½œæµ ä¹‹é—´çš„å…³ç³» :&quot; &quot;è½¬æ¢æµ :&quot; 1. OutputStreamWriter = OutputStream + ä»»æ„ç¼–ç è¡¨ 2. InputStreamReader = InputStream + ä»»æ„ç¼–ç è¡¨ &quot;æ“ä½œæµ :&quot; 1. FileWriter = OutputStreamWriter + é»˜è®¤ç¼–ç è¡¨ (GBK) 2. FileReader = InputStreamReader + é»˜è®¤ç¼–ç è¡¨(GBK) &quot;æ€»ç»“ : ä¸€èˆ¬æˆ‘ä»¬éƒ½ä½¿ç”¨æ“ä½œæµ,å½“éœ€è¦æŒ‡å®šç¼–ç è¡¨çš„æ—¶å€™,æ‰ä¼šä½¿ç”¨è½¬æ¢æµ&quot; æ‹†åˆ†æ–‡ä»¶åŠè¿˜åŸ public class Test { public static void main(String[] args) throws IOException { int count = judge(); System.out.println(count); BufferedInputStream bis = new BufferedInputStream(new FileInputStream( &quot;somethings\\\\test.flv&quot;)); incision(count, bis, 6); BufferedOutputStream bos = new BufferedOutputStream( new FileOutputStream(&quot;somethings\\\\jzc.flv&quot;)); joint(bos,6); bos.close(); bis.close(); } public static void joint( BufferedOutputStream bos,int n) throws FileNotFoundException, IOException { for (int i = 1; i &lt;= n; i++) { BufferedInputStream bis = new BufferedInputStream( new FileInputStream(&quot;somethings\\\\jzc&quot; + i + &quot;.flv&quot;)); byte[] bys = new byte[1024]; int len = -1; while ((len = bis.read(bys)) != -1) { bos.write(bys, 0, len); } bis.close(); } bos.close(); System.out.println(&quot;æ‹¼æ¥å®Œäº†&quot;); } public static void incision(int count, BufferedInputStream bis, int n) throws FileNotFoundException, IOException { byte[] bys = new byte[1024]; int len = -1; for (int i = 1; i &lt;= n; i++) { int count2 = 0; BufferedOutputStream bos = new BufferedOutputStream( new FileOutputStream(&quot;somethings\\\\jzc&quot; + i + &quot;.flv&quot;)); while ((len = bis.read(bys)) != -1) { count2 += 1024; System.out.println(count2); if (count2 &lt; (count / n)+1024&amp;&amp;count2 &gt; (count / n)-1024) { break; } else { bos.write(bys, 0, len); } } bos.close(); } System.out.println(&quot;åˆ‡å‰²å®Œäº†&quot;); } public static int judge() throws FileNotFoundException, IOException { BufferedInputStream bis = new BufferedInputStream(new FileInputStream( &quot;somethings\\\\test.flv&quot;)); byte[] bys = new byte[1024]; int len = -1; int count = 0; while ((len = bis.read(bys)) != -1) { count += 1024; } bis.close(); return count; } } ","link":"https://tianxiawuhao.github.io/FNm9kw7nn/"},{"title":"javaåŸºç¡€ä¹‹ä¸€lambda","content":"ä¸€ã€å¼•è¨€ java8æœ€å¤§çš„ç‰¹æ€§å°±æ˜¯å¼•å…¥Lambdaè¡¨è¾¾å¼ï¼Œå³å‡½æ•°å¼ç¼–ç¨‹ï¼Œå¯ä»¥å°†è¡Œä¸ºè¿›è¡Œä¼ é€’ã€‚æ€»ç»“å°±æ˜¯ï¼šä½¿ç”¨ä¸å¯å˜å€¼ä¸å‡½æ•°ï¼Œå‡½æ•°å¯¹ä¸å¯å˜å€¼è¿›è¡Œå¤„ç†ï¼Œæ˜ å°„æˆå¦ä¸€ä¸ªå€¼ã€‚ äºŒã€javaé‡è¦çš„å‡½æ•°å¼æ¥å£ 1ã€ä»€ä¹ˆæ˜¯å‡½æ•°å¼æ¥å£ å‡½æ•°æ¥å£æ˜¯åªæœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•çš„æ¥å£ï¼Œç”¨ä½œ Lambda è¡¨è¾¾å¼çš„ç±»å‹ã€‚ä½¿ç”¨@FunctionalInterfaceæ³¨è§£ä¿®é¥°çš„ç±»ï¼Œç¼–è¯‘å™¨ä¼šæ£€æµ‹è¯¥ç±»æ˜¯å¦åªæœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•æˆ–æ¥å£ï¼Œå¦åˆ™ï¼Œä¼šæŠ¥é”™ã€‚å¯ä»¥æœ‰å¤šä¸ªé»˜è®¤æ–¹æ³•ï¼Œé™æ€æ–¹æ³•ã€‚ 1.1 java8è‡ªå¸¦çš„å¸¸ç”¨å‡½æ•°å¼æ¥å£ã€‚ å‡½æ•°æ¥å£ æŠ½è±¡æ–¹æ³• åŠŸèƒ½ å‚æ•° è¿”å›ç±»å‹ ç¤ºä¾‹ Predicate test(T t) åˆ¤æ–­çœŸå‡ T boolean é‡‘åˆšçš„èº«é«˜å¤§äº185cmå—ï¼Ÿ Consumer accept(T t) æ¶ˆè´¹æ¶ˆæ¯ T void è¾“å‡ºä¸€ä¸ªå€¼ Function R apply(T t) å°†Tæ˜ å°„ä¸ºRï¼ˆè½¬æ¢åŠŸèƒ½ï¼‰ T R è·å¾—studentå¯¹è±¡çš„åå­— Supplier T get() ç”Ÿäº§æ¶ˆæ¯ None T å·¥å‚æ–¹æ³• UnaryOperator T apply(T t) ä¸€å…ƒæ“ä½œ T T é€»è¾‘éï¼ˆ!ï¼‰ BinaryOperator apply(T t, U u) äºŒå…ƒæ“ä½œ (Tï¼ŒT) (T) æ±‚ä¸¤ä¸ªæ•°çš„ä¹˜ç§¯ï¼ˆ*ï¼‰ public class Test { public static void main(String[] args) { Predicate&lt;Integer&gt; predicate = x -&gt; x &gt; 185; Student student = new Student(&quot;é‡‘åˆš&quot;, 23, 175); System.out.println(&quot;é‡‘åˆšçš„èº«é«˜é«˜äº185å—ï¼Ÿï¼š&quot; + predicate.test(student.getStature())); Consumer&lt;String&gt; consumer = System.out::println; consumer.accept(&quot;æ¶ˆè´¹æ¶ˆæ¯ï¼Œè¾“å‡ºä¸€ä¸ªå€¼&quot;); Function&lt;Student, String&gt; function = Student::getName; String name = function.apply(student); System.out.println(name); Supplier&lt;Integer&gt; supplier = () -&gt; Integer.valueOf(BigDecimal.TEN.toString()); System.out.println(supplier.get()); UnaryOperator&lt;Boolean&gt; unaryOperator = uglily -&gt; !uglily; Boolean apply2 = unaryOperator.apply(true); System.out.println(apply2); BinaryOperator&lt;Integer&gt; operator = (x, y) -&gt; x * y; Integer integer = operator.apply(2, 3); System.out.println(integer); test(() -&gt; &quot;æˆ‘æ˜¯ä¸€ä¸ªæ¼”ç¤ºçš„å‡½æ•°å¼æ¥å£&quot;); } /** * æ¼”ç¤ºè‡ªå®šä¹‰å‡½æ•°å¼æ¥å£ä½¿ç”¨ * * @param worker */ public static void test(Worker worker) { String work = worker.work(); System.out.println(work); } public interface Worker { String work(); } } //é‡‘åˆšçš„èº«é«˜é«˜äº185å—ï¼Ÿï¼šfalse //æ¶ˆè´¹æ¶ˆæ¯ï¼Œè¾“å‡ºä¸€ä¸ªå€¼ //é‡‘åˆš //10 //false //6 //æˆ‘æ˜¯ä¸€ä¸ªæ¼”ç¤ºçš„å‡½æ•°å¼æ¥å£ ä»¥ä¸Šæ¼”ç¤ºäº†lambdaæ¥å£çš„ä½¿ç”¨åŠè‡ªå®šä¹‰ä¸€ä¸ªå‡½æ•°å¼æ¥å£å¹¶ä½¿ç”¨ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬çœ‹çœ‹java8å°†å‡½æ•°å¼æ¥å£å°è£…åˆ°æµä¸­å¦‚ä½•é«˜æ•ˆçš„å¸®åŠ©æˆ‘ä»¬å¤„ç†é›†åˆã€‚ æ³¨æ„ï¼šStudent::getNameä¾‹å­ä¸­è¿™ç§ç¼–å†™lambdaè¡¨è¾¾å¼çš„æ–¹å¼ç§°ä¸ºæ–¹æ³•å¼•ç”¨ã€‚æ ¼å¼ä¸ºClassName::methodNameã€‚ ç¤ºä¾‹ï¼šæœ¬ç¯‡æ‰€æœ‰ç¤ºä¾‹éƒ½åŸºäºä»¥ä¸‹ä¸‰ä¸ªç±»ã€‚OutstandingClassï¼šç­çº§ï¼›Studentï¼šå­¦ç”Ÿï¼›SpecialityEnumï¼šç‰¹é•¿ã€‚ 1.2 æƒ°æ€§æ±‚å€¼ä¸åŠæ—©æ±‚å€¼ æƒ°æ€§æ±‚å€¼ï¼šåªæè¿°Streamï¼Œæ“ä½œçš„ç»“æœä¹Ÿæ˜¯Streamï¼Œè¿™æ ·çš„æ“ä½œç§°ä¸ºæƒ°æ€§æ±‚å€¼ã€‚ æƒ°æ€§æ±‚å€¼å¯ä»¥åƒå»ºé€ è€…æ¨¡å¼ä¸€æ ·é“¾å¼ä½¿ç”¨ï¼Œæœ€åå†ä½¿ç”¨åŠæ—©æ±‚å€¼å¾—åˆ°æœ€ç»ˆç»“æœã€‚ åŠæ—©æ±‚å€¼ï¼šå¾—åˆ°æœ€ç»ˆçš„ç»“æœè€Œä¸æ˜¯Streamï¼Œè¿™æ ·çš„æ“ä½œç§°ä¸ºåŠæ—©æ±‚å€¼ã€‚ 2ã€å¸¸ç”¨çš„æµ 2.1 collect(Collectors.toList()) å°†æµè½¬æ¢ä¸ºlistã€‚è¿˜æœ‰toSet()ï¼ŒtoMap()ç­‰ã€‚åŠæ—©æ±‚å€¼ã€‚ public class TestCase { public static void main(String[] args) { List&lt;Student&gt; studentList = Stream.of(new Student(&quot;è·¯é£&quot;, 22, 175), new Student(&quot;çº¢å‘&quot;, 40, 180), new Student(&quot;ç™½èƒ¡å­&quot;, 50, 185)).collect(Collectors.toList()); System.out.println(studentList); } } //è¾“å‡ºç»“æœ //[Student{name='è·¯é£', age=22, stature=175, specialities=null}, //Student{name='çº¢å‘', age=40, stature=180, specialities=null}, //Student{name='ç™½èƒ¡å­', age=50, stature=185, specialities=null}] //è½¬æˆmap public Map&lt;Long, String&gt; getIdNameMap(List&lt;Account&gt; accounts) { return accounts.stream().collect(Collectors.toMap(Account::getId, Account::getUsername)); } //æ”¶é›†æˆå®ä½“æœ¬èº«map public Map&lt;Long, Account&gt; getIdAccountMap(List&lt;Account&gt; accounts) { return accounts.stream().collect(Collectors.toMap(Account::getId, account -&gt; account)); } //account -&gt; accountæ˜¯ä¸€ä¸ªè¿”å›æœ¬èº«çš„lambdaè¡¨è¾¾å¼ï¼Œå…¶å®è¿˜å¯ä»¥ä½¿ç”¨Functionæ¥å£ä¸­çš„ä¸€ä¸ªé»˜è®¤æ–¹æ³•ä»£æ›¿ï¼Œä½¿æ•´ä¸ªæ–¹æ³•æ›´ç®€æ´ä¼˜é›…ï¼š public Map&lt;Long, Account&gt; getIdAccountMap(List&lt;Account&gt; accounts) { return accounts.stream().collect(Collectors.toMap(Account::getId, Function.identity())); } //é‡å¤keyçš„æƒ…å†µï¼Œä¸‹é¢nameå¯èƒ½é‡å¤ public Map&lt;String, Account&gt; getNameAccountMap(List&lt;Account&gt; accounts) { return accounts.stream().collect(Collectors.toMap(Account::getUsername, Function.identity())); } //toMapæœ‰ä¸ªé‡è½½æ–¹æ³•ï¼Œå¯ä»¥ä¼ å…¥ä¸€ä¸ªåˆå¹¶çš„å‡½æ•°æ¥è§£å†³keyå†²çªé—®é¢˜ public Map&lt;String, Account&gt; getNameAccountMap(List&lt;Account&gt; accounts) { return accounts.stream().collect(Collectors.toMap(Account::getUsername, Function.identity(), (key1, key2) -&gt; key2)); } //æŒ‰idåˆ†ç»„ Map&lt;Long, List&lt;Account&gt;&gt; map = accounts.stream().collect(Collectors.groupingBy(Account::getId)); //æŒ‡å®šå…·ä½“æ”¶é›†çš„map public Map&lt;String, Account&gt; getNameAccountMap(List&lt;Account&gt; accounts) { return accounts.stream().collect(Collectors.toMap(Account::getUsername, Function.identity(), (key1, key2) -&gt; key2, LinkedHashMap::new)); } 2.2 filter é¡¾åæ€ä¹‰ï¼Œèµ·è¿‡æ»¤ç­›é€‰çš„ä½œç”¨ã€‚å†…éƒ¨å°±æ˜¯Predicateæ¥å£ã€‚æƒ°æ€§æ±‚å€¼ã€‚ æ¯”å¦‚æˆ‘ä»¬ç­›é€‰å‡ºå‡ºèº«é«˜å°äº180çš„åŒå­¦ã€‚ public class TestCase { public static void main(String[] args) { List&lt;Student&gt; students = new ArrayList&lt;&gt;(3); students.add(new Student(&quot;è·¯é£&quot;, 22, 175)); students.add(new Student(&quot;çº¢å‘&quot;, 40, 180)); students.add(new Student(&quot;ç™½èƒ¡å­&quot;, 50, 185)); List&lt;Student&gt; list = students.stream() .filter(stu -&gt; stu.getStature() &lt; 180) .collect(Collectors.toList()); System.out.println(list); } } //è¾“å‡ºç»“æœ //[Student{name='è·¯é£', age=22, stature=175, specialities=null}] 2.3 map è½¬æ¢åŠŸèƒ½ï¼Œå†…éƒ¨å°±æ˜¯Functionæ¥å£ã€‚æƒ°æ€§æ±‚å€¼ public class TestCase { public static void main(String[] args) { List&lt;Student&gt; students = new ArrayList&lt;&gt;(3); students.add(new Student(&quot;è·¯é£&quot;, 22, 175)); students.add(new Student(&quot;çº¢å‘&quot;, 40, 180)); students.add(new Student(&quot;ç™½èƒ¡å­&quot;, 50, 185)); List&lt;String&gt; names = students.stream().map(student -&gt; student.getName()) .collect(Collectors.toList()); System.out.println(names); } } //è¾“å‡ºç»“æœ //[è·¯é£, çº¢å‘, ç™½èƒ¡å­] ä¾‹å­ä¸­å°†studentå¯¹è±¡è½¬æ¢ä¸ºStringå¯¹è±¡ï¼Œè·å–studentçš„åå­—ã€‚ 2.4 flatMap å°†å¤šä¸ªStreamåˆå¹¶ä¸ºä¸€ä¸ªStreamã€‚æƒ°æ€§æ±‚å€¼ public class TestCase { public static void main(String[] args) { List&lt;Student&gt; students = new ArrayList&lt;&gt;(3); students.add(new Student(&quot;è·¯é£&quot;, 22, 175)); students.add(new Student(&quot;çº¢å‘&quot;, 40, 180)); students.add(new Student(&quot;ç™½èƒ¡å­&quot;, 50, 185)); List&lt;Student&gt; studentList = Stream.of(students, asList(new Student(&quot;è‰¾æ–¯&quot;, 25, 183), new Student(&quot;é›·åˆ©&quot;, 48, 176))) .flatMap(students1 -&gt; students1.stream()).collect(Collectors.toList()); System.out.println(studentList); } } //è¾“å‡ºç»“æœ //[Student{name='è·¯é£', age=22, stature=175, specialities=null}, //Student{name='çº¢å‘', age=40, stature=180, specialities=null}, //Student{name='ç™½èƒ¡å­', age=50, stature=185, specialities=null}, //Student{name='è‰¾æ–¯', age=25, stature=183, specialities=null}, //Student{name='é›·åˆ©', age=48, stature=176, specialities=null}] è°ƒç”¨Stream.ofçš„é™æ€æ–¹æ³•å°†ä¸¤ä¸ªlistè½¬æ¢ä¸ºStreamï¼Œå†é€šè¿‡flatMapå°†ä¸¤ä¸ªæµåˆå¹¶ä¸ºä¸€ä¸ªã€‚ 2.5 maxå’Œmin æˆ‘ä»¬ç»å¸¸ä¼šåœ¨é›†åˆä¸­æ±‚æœ€å¤§æˆ–æœ€å°å€¼ï¼Œä½¿ç”¨æµå°±å¾ˆæ–¹ä¾¿ã€‚åŠæ—©æ±‚å€¼ã€‚ public class TestCase { public static void main(String[] args) { List&lt;Student&gt; students = new ArrayList&lt;&gt;(3); students.add(new Student(&quot;è·¯é£&quot;, 22, 175)); students.add(new Student(&quot;çº¢å‘&quot;, 40, 180)); students.add(new Student(&quot;ç™½èƒ¡å­&quot;, 50, 185)); Optional&lt;Student&gt; max = students.stream() .max(Comparator.comparing(stu -&gt; stu.getAge())); Optional&lt;Student&gt; min = students.stream() .min(Comparator.comparing(stu -&gt; stu.getAge())); //åˆ¤æ–­æ˜¯å¦æœ‰å€¼ if (max.isPresent()) { System.out.println(max.get()); } if (min.isPresent()) { System.out.println(min.get()); } } } //è¾“å‡ºç»“æœ //Student{name='ç™½èƒ¡å­', age=50, stature=185, specialities=null} //Student{name='è·¯é£', age=22, stature=175, specialities=null} maxã€minæ¥æ”¶ä¸€ä¸ªComparatorï¼ˆä¾‹å­ä¸­ä½¿ç”¨java8è‡ªå¸¦çš„é™æ€å‡½æ•°ï¼Œåªéœ€è¦ä¼ è¿›éœ€è¦æ¯”è¾ƒå€¼å³å¯ã€‚ï¼‰å¹¶ä¸”è¿”å›ä¸€ä¸ªOptionalå¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ˜¯java8æ–°å¢çš„ç±»ï¼Œä¸“é—¨ä¸ºäº†é˜²æ­¢nullå¼•å‘çš„ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚å¯ä»¥ä½¿ç”¨max.isPresent()åˆ¤æ–­æ˜¯å¦æœ‰å€¼ï¼›å¯ä»¥ä½¿ç”¨max.orElse(new Student())ï¼Œå½“å€¼ä¸ºnullæ—¶å°±ä½¿ç”¨ç»™å®šå€¼ï¼›ä¹Ÿå¯ä»¥ä½¿ç”¨max.orElseGet(() -&gt; new Student());è¿™éœ€è¦ä¼ å…¥ä¸€ä¸ªSupplierçš„lambdaè¡¨è¾¾å¼ã€‚ 2.6 count ç»Ÿè®¡åŠŸèƒ½ï¼Œä¸€èˆ¬éƒ½æ˜¯ç»“åˆfilterä½¿ç”¨ï¼Œå› ä¸ºå…ˆç­›é€‰å‡ºæˆ‘ä»¬éœ€è¦çš„å†ç»Ÿè®¡å³å¯ã€‚åŠæ—©æ±‚å€¼ public class TestCase { public static void main(String[] args) { List&lt;Student&gt; students = new ArrayList&lt;&gt;(3); students.add(new Student(&quot;è·¯é£&quot;, 22, 175)); students.add(new Student(&quot;çº¢å‘&quot;, 40, 180)); students.add(new Student(&quot;ç™½èƒ¡å­&quot;, 50, 185)); long count = students.stream().filter(s1 -&gt; s1.getAge() &lt; 45).count(); System.out.println(&quot;å¹´é¾„å°äº45å²çš„äººæ•°æ˜¯ï¼š&quot; + count); } } //è¾“å‡ºç»“æœ //å¹´é¾„å°äº45å²çš„äººæ•°æ˜¯ï¼š2 2.7 reduce reduce æ“ä½œå¯ä»¥å®ç°ä»ä¸€ç»„å€¼ä¸­ç”Ÿæˆä¸€ä¸ªå€¼ã€‚åœ¨ä¸Šè¿°ä¾‹å­ä¸­ç”¨åˆ°çš„ count ã€ min å’Œ max æ–¹ æ³•ï¼Œå› ä¸ºå¸¸ç”¨è€Œè¢«çº³å…¥æ ‡å‡†åº“ä¸­ã€‚äº‹å®ä¸Šï¼Œè¿™äº›æ–¹æ³•éƒ½æ˜¯ reduce æ“ä½œã€‚åŠæ—©æ±‚å€¼ã€‚ public class TestCase { public static void main(String[] args) { Integer reduce = Stream.of(1, 2, 3, 4).reduce(0, (acc, x) -&gt; acc+ x); System.out.println(reduce); } } //è¾“å‡ºç»“æœ //10 æˆ‘ä»¬çœ‹å¾—reduceæ¥æ”¶äº†ä¸€ä¸ªåˆå§‹å€¼ä¸º0çš„ç´¯åŠ å™¨ï¼Œä¾æ¬¡å–å‡ºå€¼ä¸ç´¯åŠ å™¨ç›¸åŠ ï¼Œæœ€åç´¯åŠ å™¨çš„å€¼å°±æ˜¯æœ€ç»ˆçš„ç»“æœã€‚ ä¸‰ã€é«˜çº§é›†åˆç±»åŠæ”¶é›†å™¨ 3.1 è½¬æ¢æˆå€¼ **æ”¶é›†å™¨ï¼Œä¸€ç§é€šç”¨çš„ã€ä»æµç”Ÿæˆå¤æ‚å€¼çš„ç»“æ„ã€‚**åªè¦å°†å®ƒä¼ ç»™ collect æ–¹æ³•ï¼Œæ‰€æœ‰ çš„æµå°±éƒ½å¯ä»¥ä½¿ç”¨å®ƒäº†ã€‚æ ‡å‡†ç±»åº“å·²ç»æä¾›äº†ä¸€äº›æœ‰ç”¨çš„æ”¶é›†å™¨ï¼Œä»¥ä¸‹ç¤ºä¾‹ä»£ç ä¸­çš„æ”¶é›†å™¨éƒ½æ˜¯ä» java.util.stream.Collectors ç±»ä¸­é™æ€å¯¼å…¥çš„ã€‚ public class CollectorsTest { public static void main(String[] args) { List&lt;Student&gt; students1 = new ArrayList&lt;&gt;(3); students1.add(new Student(&quot;è·¯é£&quot;, 23, 175)); students1.add(new Student(&quot;çº¢å‘&quot;, 40, 180)); students1.add(new Student(&quot;ç™½èƒ¡å­&quot;, 50, 185)); OutstandingClass ostClass1 = new OutstandingClass(&quot;ä¸€ç­&quot;, students1); //å¤åˆ¶students1ï¼Œå¹¶ç§»é™¤ä¸€ä¸ªå­¦ç”Ÿ List&lt;Student&gt; students2 = new ArrayList&lt;&gt;(students1); students2.remove(1); OutstandingClass ostClass2 = new OutstandingClass(&quot;äºŒç­&quot;, students2); //å°†ostClass1ã€ostClass2è½¬æ¢ä¸ºStream Stream&lt;OutstandingClass&gt; classStream = Stream.of(ostClass1, ostClass2); OutstandingClass outstandingClass = biggestGroup(classStream); System.out.println(&quot;äººæ•°æœ€å¤šçš„ç­çº§æ˜¯ï¼š&quot; + outstandingClass.getName()); System.out.println(&quot;ä¸€ç­å¹³å‡å¹´é¾„æ˜¯ï¼š&quot; + averageNumberOfStudent(students1)); } /** * è·å–äººæ•°æœ€å¤šçš„ç­çº§ */ private static OutstandingClass biggestGroup(Stream&lt;OutstandingClass&gt; outstandingClasses) { return outstandingClasses.collect( maxBy(comparing(ostClass -&gt; ostClass.getStudents().size()))) .orElseGet(OutstandingClass::new); } /** * è®¡ç®—å¹³å‡å¹´é¾„ */ private static double averageNumberOfStudent(List&lt;Student&gt; students) { return students.stream().collect(averagingInt(Student::getAge)); } } //è¾“å‡ºç»“æœ //äººæ•°æœ€å¤šçš„ç­çº§æ˜¯ï¼šä¸€ç­ //ä¸€ç­å¹³å‡å¹´é¾„æ˜¯ï¼š37.666666666666664 maxByæˆ–è€…minByå°±æ˜¯æ±‚æœ€å¤§å€¼ä¸æœ€å°å€¼ã€‚ 3.2 è½¬æ¢æˆå— å¸¸ç”¨çš„æµæ“ä½œæ˜¯å°†å…¶åˆ†è§£æˆä¸¤ä¸ªé›†åˆï¼ŒCollectors.partitioningByå¸®æˆ‘ä»¬å®ç°äº†ï¼Œæ¥æ”¶ä¸€ä¸ªPredicateå‡½æ•°å¼æ¥å£ã€‚ å°†ç¤ºä¾‹å­¦ç”Ÿåˆ†ä¸ºä¼šå”±æ­Œä¸ä¸ä¼šå”±æ­Œçš„ä¸¤ä¸ªé›†åˆã€‚ public class PartitioningByTest { public static void main(String[] args) { //çœç•¥List&lt;student&gt; studentsçš„åˆå§‹åŒ– Map&lt;Boolean, List&lt;Student&gt;&gt; listMap = students.stream().collect( Collectors.partitioningBy(student -&gt; student.getSpecialities(). contains(SpecialityEnum.SING))); } } 3.3 æ•°æ®åˆ†ç»„ æ•°æ®åˆ†ç»„æ˜¯ä¸€ç§æ›´è‡ªç„¶çš„åˆ†å‰²æ•°æ®æ“ä½œï¼Œä¸å°†æ•°æ®åˆ†æˆ ture å’Œ false ä¸¤éƒ¨åˆ†ä¸åŒï¼Œå¯ä»¥ä½¿ ç”¨ä»»æ„å€¼å¯¹æ•°æ®åˆ†ç»„ã€‚Collectors.groupingByæ¥æ”¶ä¸€ä¸ªFunctionåšè½¬æ¢ã€‚ å¦‚å›¾ï¼Œæˆ‘ä»¬ä½¿ç”¨groupingByå°†æ ¹æ®è¿›è¡Œåˆ†ç»„ä¸ºåœ†å½¢ä¸€ç»„ï¼Œä¸‰è§’å½¢ä¸€ç»„ï¼Œæ­£æ–¹å½¢ä¸€ç»„ã€‚ ä¾‹å­ï¼šæ ¹æ®å­¦ç”Ÿç¬¬ä¸€ä¸ªç‰¹é•¿è¿›è¡Œåˆ†ç»„ public class GroupingByTest { public static void main(String[] args) { //çœç•¥List&lt;student&gt; studentsçš„åˆå§‹åŒ– Map&lt;SpecialityEnum, List&lt;Student&gt;&gt; listMap = students.stream().collect( Collectors.groupingBy(student -&gt; student.getSpecialities().get(0))); } } Collectors.groupingByä¸SQL ä¸­çš„ group by æ“ä½œæ˜¯ä¸€æ ·çš„ã€‚ 3.4 å­—ç¬¦ä¸²æ‹¼æ¥ å¦‚æœå°†æ‰€æœ‰å­¦ç”Ÿçš„åå­—æ‹¼æ¥èµ·æ¥ï¼Œæ€ä¹ˆåšå‘¢ï¼Ÿé€šå¸¸åªèƒ½åˆ›å»ºä¸€ä¸ªStringBuilderï¼Œå¾ªç¯æ‹¼æ¥ã€‚ä½¿ç”¨Streamï¼Œä½¿ç”¨Collectors.joining()ç®€å•å®¹æ˜“ã€‚ public class JoiningTest { public static void main(String[] args) { List&lt;Student&gt; students = new ArrayList&lt;&gt;(3); students.add(new Student(&quot;è·¯é£&quot;, 22, 175)); students.add(new Student(&quot;çº¢å‘&quot;, 40, 180)); students.add(new Student(&quot;ç™½èƒ¡å­&quot;, 50, 185)); String names = students.stream() .map(Student::getName).collect(Collectors.joining(&quot;,&quot;,&quot;[&quot;,&quot;]&quot;)); System.out.println(names); } } //è¾“å‡ºç»“æœ //[è·¯é£,çº¢å‘,ç™½èƒ¡å­] joiningæ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯åˆ†ç•Œç¬¦ï¼Œç¬¬äºŒä¸ªæ˜¯å‰ç¼€ç¬¦ï¼Œç¬¬ä¸‰ä¸ªæ˜¯ç»“æŸç¬¦ã€‚ä¹Ÿå¯ä»¥ä¸ä¼ å…¥å‚æ•°Collectors.joining()ï¼Œè¿™æ ·å°±æ˜¯ç›´æ¥æ‹¼æ¥ã€‚ åŸæ–‡åœ°å€ï¼šhttps://juejin.cn/post/6844903849753329678#hjava ","link":"https://tianxiawuhao.github.io/7BfPpY68W/"},{"title":"JavaåŸºç¡€ä¹‹â€”åå°„","content":"åå°„æ˜¯æ¡†æ¶è®¾è®¡çš„çµé­‚ï¼ˆä½¿ç”¨çš„å‰ææ¡ä»¶ï¼šå¿…é¡»å…ˆå¾—åˆ°ä»£è¡¨çš„å­—èŠ‚ç çš„Classï¼ŒClassç±»ç”¨äºè¡¨ç¤º.classæ–‡ä»¶ï¼ˆå­—èŠ‚ç ï¼‰ï¼‰ åå°„çš„æ¦‚è¿° JAVAåå°„æœºåˆ¶æ˜¯åœ¨è¿è¡ŒçŠ¶æ€ä¸­ï¼Œå¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œéƒ½èƒ½å¤ŸçŸ¥é“è¿™ä¸ªç±»çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ï¼›å¯¹äºä»»æ„ä¸€ä¸ªå¯¹è±¡ï¼Œéƒ½èƒ½å¤Ÿè°ƒç”¨å®ƒçš„ä»»æ„ä¸€ä¸ªæ–¹æ³•å’Œå±æ€§ï¼›è¿™ç§åŠ¨æ€è·å–çš„ä¿¡æ¯ä»¥åŠåŠ¨æ€è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•çš„åŠŸèƒ½ç§°ä¸ºjavaè¯­è¨€çš„åå°„æœºåˆ¶ã€‚ è¦æƒ³è§£å‰–ä¸€ä¸ªç±»,å¿…é¡»å…ˆè¦è·å–åˆ°è¯¥ç±»çš„å­—èŠ‚ç æ–‡ä»¶å¯¹è±¡ã€‚è€Œè§£å‰–ä½¿ç”¨çš„å°±æ˜¯Classç±»ä¸­çš„æ–¹æ³•.æ‰€ä»¥å…ˆè¦è·å–åˆ°æ¯ä¸€ä¸ªå­—èŠ‚ç æ–‡ä»¶å¯¹åº”çš„Classç±»å‹çš„å¯¹è±¡. åå°„å°±æ˜¯æŠŠjavaç±»ä¸­çš„å„ç§æˆåˆ†æ˜ å°„æˆä¸€ä¸ªä¸ªçš„Javaå¯¹è±¡ ä¾‹å¦‚ï¼šä¸€ä¸ªç±»æœ‰ï¼šæˆå‘˜å˜é‡ã€æ–¹æ³•ã€æ„é€ æ–¹æ³•ã€åŒ…ç­‰ç­‰ä¿¡æ¯ï¼Œåˆ©ç”¨åå°„æŠ€æœ¯å¯ä»¥å¯¹ä¸€ä¸ªç±»è¿›è¡Œè§£å‰–ï¼ŒæŠŠä¸ªä¸ªç»„æˆéƒ¨åˆ†æ˜ å°„æˆä¸€ä¸ªä¸ªå¯¹è±¡ã€‚ï¼ˆå…¶å®ï¼šä¸€ä¸ªç±»ä¸­è¿™äº›æˆå‘˜æ–¹æ³•ã€æ„é€ æ–¹æ³•ã€åœ¨åŠ å…¥ç±»ä¸­éƒ½æœ‰ä¸€ä¸ªç±»æ¥æè¿°ï¼‰ å¦‚å›¾æ˜¯ç±»çš„æ­£å¸¸åŠ è½½è¿‡ç¨‹ï¼šClasså¯¹è±¡çš„ç”±æ¥æ˜¯å°†classæ–‡ä»¶è¯»å…¥å†…å­˜ï¼Œå¹¶ä¸ºä¹‹åˆ›å»ºä¸€ä¸ªClasså¯¹è±¡ã€‚ å…¶ä¸­è¿™ä¸ªClasså¯¹è±¡å¾ˆç‰¹æ®Šã€‚æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹è¿™ä¸ªClassç±» æŸ¥çœ‹Classç±»åœ¨javaä¸­çš„apiè¯¦è§£ Class ç±»çš„å®ä¾‹è¡¨ç¤ºæ­£åœ¨è¿è¡Œçš„ Java åº”ç”¨ç¨‹åºä¸­çš„ç±»å’Œæ¥å£ã€‚ä¹Ÿå°±æ˜¯jvmä¸­æœ‰Nå¤šçš„å®ä¾‹æ¯ä¸ªç±»éƒ½æœ‰è¯¥Classå¯¹è±¡ã€‚ï¼ˆåŒ…æ‹¬åŸºæœ¬æ•°æ®ç±»å‹ï¼‰ Class æ²¡æœ‰å…¬å…±æ„é€ æ–¹æ³•ã€‚Class å¯¹è±¡æ˜¯åœ¨åŠ è½½ç±»æ—¶ç”± Java è™šæ‹Ÿæœºä»¥åŠé€šè¿‡è°ƒç”¨ç±»åŠ è½½å™¨ä¸­çš„defineClass æ–¹æ³•è‡ªåŠ¨æ„é€ çš„ã€‚ä¹Ÿå°±æ˜¯è¿™ä¸éœ€è¦æˆ‘ä»¬è‡ªå·±å»å¤„ç†åˆ›å»ºï¼ŒJVMå·²ç»å¸®æˆ‘ä»¬åˆ›å»ºå¥½äº†ã€‚ æ²¡æœ‰å…¬å…±çš„æ„é€ æ–¹æ³•ï¼Œæ–¹æ³•å…±æœ‰64ä¸ªã€‚ åå°„çš„ä½¿ç”¨ è·å–Classå¯¹è±¡çš„ä¸‰ç§æ–¹å¼ 1.1 Object â€”â€”&gt; getClass(); 1.2 ä»»ä½•æ•°æ®ç±»å‹ï¼ˆåŒ…æ‹¬åŸºæœ¬æ•°æ®ç±»å‹ï¼‰éƒ½æœ‰ä¸€ä¸ªâ€œé™æ€â€çš„classå±æ€§ 1.3 é€šè¿‡Classç±»çš„é™æ€æ–¹æ³•ï¼šforNameï¼ˆString classNameï¼‰(å¸¸ç”¨) å…¶ä¸­1.1æ˜¯å› ä¸ºObjectç±»ä¸­çš„getClassæ–¹æ³•ã€å› ä¸ºæ‰€æœ‰ç±»éƒ½ç»§æ‰¿Objectç±»ã€‚ä»è€Œè°ƒç”¨Objectç±»æ¥è·å– package fanshe; /** * è·å–Classå¯¹è±¡çš„ä¸‰ç§æ–¹å¼ * 1 Object â€”â€”&gt; getClass(); * 2 ä»»ä½•æ•°æ®ç±»å‹ï¼ˆåŒ…æ‹¬åŸºæœ¬æ•°æ®ç±»å‹ï¼‰éƒ½æœ‰ä¸€ä¸ªâ€œé™æ€â€çš„classå±æ€§ * 3 é€šè¿‡Classç±»çš„é™æ€æ–¹æ³•ï¼šforNameï¼ˆString classNameï¼‰(å¸¸ç”¨) * */ public class Fanshe { public static void main(String[] args) { //ç¬¬ä¸€ç§æ–¹å¼è·å–Classå¯¹è±¡ Student stu1 = new Student();//è¿™ä¸€new äº§ç”Ÿä¸€ä¸ªStudentå¯¹è±¡ï¼Œä¸€ä¸ªClasså¯¹è±¡ã€‚ Class stuClass = stu1.getClass();//è·å–Classå¯¹è±¡ System.out.println(stuClass.getName()); //ç¬¬äºŒç§æ–¹å¼è·å–Classå¯¹è±¡ Class stuClass2 = Student.class; System.out.println(stuClass == stuClass2);//åˆ¤æ–­ç¬¬ä¸€ç§æ–¹å¼è·å–çš„Classå¯¹è±¡å’Œç¬¬äºŒç§æ–¹å¼è·å–çš„æ˜¯å¦æ˜¯åŒä¸€ä¸ª //ç¬¬ä¸‰ç§æ–¹å¼è·å–Classå¯¹è±¡ try { Class stuClass3 = Class.forName(&quot;fanshe.Student&quot;);//æ³¨æ„æ­¤å­—ç¬¦ä¸²å¿…é¡»æ˜¯çœŸå®è·¯å¾„ï¼Œå°±æ˜¯å¸¦åŒ…åçš„ç±»è·¯å¾„ï¼ŒåŒ…å.ç±»å System.out.println(stuClass3 == stuClass2);//åˆ¤æ–­ä¸‰ç§æ–¹å¼æ˜¯å¦è·å–çš„æ˜¯åŒä¸€ä¸ªClasså¯¹è±¡ } catch (ClassNotFoundException e) { e.printStackTrace(); } } } æ³¨æ„ï¼šåœ¨è¿è¡ŒæœŸé—´ï¼Œä¸€ä¸ªç±»ï¼Œåªæœ‰ä¸€ä¸ªClasså¯¹è±¡äº§ç”Ÿã€‚ ä¸‰ç§æ–¹å¼å¸¸ç”¨ç¬¬ä¸‰ç§ï¼Œç¬¬ä¸€ç§å¯¹è±¡éƒ½æœ‰äº†è¿˜è¦åå°„å¹²ä»€ä¹ˆã€‚ç¬¬äºŒç§éœ€è¦å¯¼å…¥ç±»çš„åŒ…ï¼Œä¾èµ–å¤ªå¼ºï¼Œä¸å¯¼åŒ…å°±æŠ›ç¼–è¯‘é”™è¯¯ã€‚ä¸€èˆ¬éƒ½ç¬¬ä¸‰ç§ï¼Œä¸€ä¸ªå­—ç¬¦ä¸²å¯ä»¥ä¼ å…¥ä¹Ÿå¯å†™åœ¨é…ç½®æ–‡ä»¶ä¸­ç­‰å¤šç§æ–¹æ³•ã€‚ é€šè¿‡åå°„è·å–æ„é€ æ–¹æ³•å¹¶ä½¿ç”¨ï¼š package fanshe; public class Student { //---------------æ„é€ æ–¹æ³•------------------- //ï¼ˆé»˜è®¤çš„æ„é€ æ–¹æ³•ï¼‰ Student(String str){ System.out.println(&quot;(é»˜è®¤)çš„æ„é€ æ–¹æ³• s = &quot; + str); } //æ— å‚æ„é€ æ–¹æ³• public Student(){ System.out.println(&quot;è°ƒç”¨äº†å…¬æœ‰ã€æ— å‚æ„é€ æ–¹æ³•æ‰§è¡Œäº†ã€‚ã€‚ã€‚&quot;); } //æœ‰ä¸€ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³• public Student(char name){ System.out.println(&quot;å§“åï¼š&quot; + name); } //æœ‰å¤šä¸ªå‚æ•°çš„æ„é€ æ–¹æ³• public Student(String name ,int age){ System.out.println(&quot;å§“åï¼š&quot;+name+&quot;å¹´é¾„ï¼š&quot;+ age);//è¿™çš„æ‰§è¡Œæ•ˆç‡æœ‰é—®é¢˜ï¼Œä»¥åè§£å†³ã€‚ } //å—ä¿æŠ¤çš„æ„é€ æ–¹æ³• protected Student(boolean n){ System.out.println(&quot;å—ä¿æŠ¤çš„æ„é€ æ–¹æ³• n = &quot; + n); } //ç§æœ‰æ„é€ æ–¹æ³• private Student(int age){ System.out.println(&quot;ç§æœ‰çš„æ„é€ æ–¹æ³• å¹´é¾„ï¼š&quot;+ age); } } å…±æœ‰6ä¸ªæ„é€ æ–¹æ³•ï¼› /* * é€šè¿‡Classå¯¹è±¡å¯ä»¥è·å–æŸä¸ªç±»ä¸­çš„ï¼šæ„é€ æ–¹æ³•ã€æˆå‘˜å˜é‡ã€æˆå‘˜æ–¹æ³•ï¼›å¹¶è®¿é—®æˆå‘˜ï¼› * * 1.è·å–æ„é€ æ–¹æ³•ï¼š * 1).æ‰¹é‡çš„æ–¹æ³•ï¼š * public Constructor[] getConstructors()ï¼šæ‰€æœ‰&quot;å…¬æœ‰çš„&quot;æ„é€ æ–¹æ³• * public Constructor[] getDeclaredConstructors()ï¼šè·å–æ‰€æœ‰çš„æ„é€ æ–¹æ³•(åŒ…æ‹¬ç§æœ‰ã€å—ä¿æŠ¤ã€é»˜è®¤ã€å…¬æœ‰) * * 2).è·å–å•ä¸ªçš„æ–¹æ³•ï¼Œå¹¶è°ƒç”¨ï¼š * public Constructor getConstructor(Class... parameterTypes):è·å–å•ä¸ªçš„&quot;å…¬æœ‰çš„&quot;æ„é€ æ–¹æ³•ï¼š * public Constructor getDeclaredConstructor(Class... parameterTypes):è·å–&quot;æŸä¸ªæ„é€ æ–¹æ³•&quot;å¯ä»¥æ˜¯ç§æœ‰çš„ï¼Œæˆ–å—ä¿æŠ¤ã€é»˜è®¤ã€å…¬æœ‰ï¼› * *è°ƒç”¨æ„é€ æ–¹æ³•ï¼š * Constructor--&gt;newInstance(Object... initargs) * ä½¿ç”¨æ­¤ Constructor å¯¹è±¡è¡¨ç¤ºçš„æ„é€ æ–¹æ³•æ¥åˆ›å»ºè¯¥æ„é€ æ–¹æ³•çš„å£°æ˜ç±»çš„æ–°å®ä¾‹ï¼Œå¹¶ç”¨æŒ‡å®šçš„åˆå§‹åŒ–å‚æ•°åˆå§‹åŒ–è¯¥å®ä¾‹ã€‚ * å®ƒçš„è¿”å›å€¼æ˜¯Tç±»å‹ï¼Œæ‰€ä»¥newInstanceæ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ„é€ æ–¹æ³•çš„å£°æ˜ç±»çš„æ–°å®ä¾‹å¯¹è±¡ã€‚å¹¶ä¸ºä¹‹è°ƒç”¨ */ package fanshe; import java.lang.reflect.Constructor; public class Constructors { public static void main(String[] args) throws Exception { //1.åŠ è½½Classå¯¹è±¡ Class clazz = Class.forName(&quot;fanshe.Student&quot;); //2.è·å–æ‰€æœ‰å…¬æœ‰æ„é€ æ–¹æ³• System.out.println(&quot;**********************æ‰€æœ‰å…¬æœ‰æ„é€ æ–¹æ³•*********************************&quot;); Constructor[] conArray = clazz.getConstructors(); for(Constructor c : conArray){ System.out.println(c); } System.out.println(&quot;************æ‰€æœ‰çš„æ„é€ æ–¹æ³•(åŒ…æ‹¬ï¼šç§æœ‰ã€å—ä¿æŠ¤ã€é»˜è®¤ã€å…¬æœ‰)***************&quot;); conArray = clazz.getDeclaredConstructors(); for(Constructor c : conArray){ System.out.println(c); } System.out.println(&quot;*****************è·å–å…¬æœ‰ã€æ— å‚çš„æ„é€ æ–¹æ³•*******************************&quot;); Constructor con = clazz.getConstructor(null); //1&gt;ã€å› ä¸ºæ˜¯æ— å‚çš„æ„é€ æ–¹æ³•æ‰€ä»¥ç±»å‹æ˜¯ä¸€ä¸ªnull,ä¸å†™ä¹Ÿå¯ä»¥ï¼šè¿™é‡Œéœ€è¦çš„æ˜¯ä¸€ä¸ªå‚æ•°çš„ç±»å‹ï¼Œåˆ‡è®°æ˜¯ç±»å‹ //2&gt;ã€è¿”å›çš„æ˜¯æè¿°è¿™ä¸ªæ— å‚æ„é€ å‡½æ•°çš„ç±»å¯¹è±¡ã€‚ System.out.println(&quot;con = &quot; + con); //è°ƒç”¨æ„é€ æ–¹æ³• Object obj = con.newInstance(); // System.out.println(&quot;obj = &quot; + obj); // Student stu = (Student)obj; System.out.println(&quot;******************è·å–ç§æœ‰æ„é€ æ–¹æ³•ï¼Œå¹¶è°ƒç”¨*******************************&quot;); con = clazz.getDeclaredConstructor(char.class); System.out.println(con); //è°ƒç”¨æ„é€ æ–¹æ³• con.setAccessible(true);//æš´åŠ›è®¿é—®(å¿½ç•¥æ‰è®¿é—®ä¿®é¥°ç¬¦) obj = con.newInstance('ç”·'); } } åå°è¾“å‡ºï¼š **********************æ‰€æœ‰å…¬æœ‰æ„é€ æ–¹æ³•********************************* public fanshe.Student(java.lang.String,int) public fanshe.Student(char) public fanshe.Student() ************æ‰€æœ‰çš„æ„é€ æ–¹æ³•(åŒ…æ‹¬ï¼šç§æœ‰ã€å—ä¿æŠ¤ã€é»˜è®¤ã€å…¬æœ‰)*************** private fanshe.Student(int) protected fanshe.Student(boolean) public fanshe.Student(java.lang.String,int) public fanshe.Student(char) public fanshe.Student() fanshe.Student(java.lang.String) *****************è·å–å…¬æœ‰ã€æ— å‚çš„æ„é€ æ–¹æ³•******************************* con = public fanshe.Student() è°ƒç”¨äº†å…¬æœ‰ã€æ— å‚æ„é€ æ–¹æ³•æ‰§è¡Œäº†ã€‚ã€‚ã€‚ ******************è·å–ç§æœ‰æ„é€ æ–¹æ³•ï¼Œå¹¶è°ƒç”¨******************************* public fanshe.Student(char) å§“åï¼šç”· è·å–æˆå‘˜å˜é‡å¹¶è°ƒç”¨ï¼š package fanshe.field; public class Student { public Student(){ } //**********å­—æ®µ*************// public String name; protected int age; char sex; private String phoneNum; @Override public String toString() { return &quot;Student [name=&quot; + name + &quot;, age=&quot; + age + &quot;, sex=&quot; + sex + &quot;, phoneNum=&quot; + phoneNum + &quot;]&quot;; } } æµ‹è¯•ç±»ï¼š /* * è·å–æˆå‘˜å˜é‡å¹¶è°ƒç”¨ï¼š * * 1.æ‰¹é‡çš„ * 1).Field[] getFields():è·å–æ‰€æœ‰çš„&quot;å…¬æœ‰å­—æ®µ&quot; * 2).Field[] getDeclaredFields():è·å–æ‰€æœ‰å­—æ®µï¼ŒåŒ…æ‹¬ï¼šç§æœ‰ã€å—ä¿æŠ¤ã€é»˜è®¤ã€å…¬æœ‰ï¼› * 2.è·å–å•ä¸ªçš„ï¼š * 1).public Field getField(String fieldName):è·å–æŸä¸ª&quot;å…¬æœ‰çš„&quot;å­—æ®µï¼› * 2).public Field getDeclaredField(String fieldName):è·å–æŸä¸ªå­—æ®µ(å¯ä»¥æ˜¯ç§æœ‰çš„) * * è®¾ç½®å­—æ®µçš„å€¼ï¼š * Field --&gt; public void set(Object obj,Object value): * å‚æ•°è¯´æ˜ï¼š * 1.obj:è¦è®¾ç½®çš„å­—æ®µæ‰€åœ¨çš„å¯¹è±¡ï¼› * 2.value:è¦ä¸ºå­—æ®µè®¾ç½®çš„å€¼ï¼› * */ package fanshe.field; import java.lang.reflect.Field; public class Fields { public static void main(String[] args) throws Exception { //1.è·å–Classå¯¹è±¡ Class stuClass = Class.forName(&quot;fanshe.field.Student&quot;); //2.è·å–å­—æ®µ System.out.println(&quot;************è·å–æ‰€æœ‰å…¬æœ‰çš„å­—æ®µ********************&quot;); Field[] fieldArray = stuClass.getFields(); for(Field f : fieldArray){ System.out.println(f); } System.out.println(&quot;************è·å–æ‰€æœ‰çš„å­—æ®µ(åŒ…æ‹¬ç§æœ‰ã€å—ä¿æŠ¤ã€é»˜è®¤çš„)********************&quot;); fieldArray = stuClass.getDeclaredFields(); for(Field f : fieldArray){ System.out.println(f); } System.out.println(&quot;*************è·å–å…¬æœ‰å­—æ®µ**å¹¶è°ƒç”¨***********************************&quot;); Field f = stuClass.getField(&quot;name&quot;); System.out.println(f); //è·å–ä¸€ä¸ªå¯¹è±¡ Object obj = stuClass.getConstructor().newInstance();//äº§ç”ŸStudentå¯¹è±¡--ã€‹Student stu = new Student(); //ä¸ºå­—æ®µè®¾ç½®å€¼ f.set(obj, &quot;åˆ˜å¾·å&quot;);//ä¸ºStudentå¯¹è±¡ä¸­çš„nameå±æ€§èµ‹å€¼--ã€‹stu.name = &quot;åˆ˜å¾·å&quot; //éªŒè¯ Student stu = (Student)obj; System.out.println(&quot;éªŒè¯å§“åï¼š&quot; + stu.name); System.out.println(&quot;**************è·å–ç§æœ‰å­—æ®µ****å¹¶è°ƒç”¨********************************&quot;); f = stuClass.getDeclaredField(&quot;phoneNum&quot;); System.out.println(f); f.setAccessible(true);//æš´åŠ›åå°„ï¼Œè§£é™¤ç§æœ‰é™å®š f.set(obj, &quot;18888889999&quot;); System.out.println(&quot;éªŒè¯ç”µè¯ï¼š&quot; + stu); } } åå°è¾“å‡ºï¼š ************è·å–æ‰€æœ‰å…¬æœ‰çš„å­—æ®µ******************** public java.lang.String fanshe.field.Student.name ************è·å–æ‰€æœ‰çš„å­—æ®µ(åŒ…æ‹¬ç§æœ‰ã€å—ä¿æŠ¤ã€é»˜è®¤çš„)******************** public java.lang.String fanshe.field.Student.name protected int fanshe.field.Student.age char fanshe.field.Student.sex private java.lang.String fanshe.field.Student.phoneNum *************è·å–å…¬æœ‰å­—æ®µ**å¹¶è°ƒç”¨*********************************** public java.lang.String fanshe.field.Student.name éªŒè¯å§“åï¼šåˆ˜å¾·å **************è·å–ç§æœ‰å­—æ®µ****å¹¶è°ƒç”¨******************************** private java.lang.String fanshe.field.Student.phoneNum éªŒè¯ç”µè¯ï¼šStudent [name=åˆ˜å¾·å, age=0, sex=ï¼ŒphoneNum=18888889999] è·å–æˆå‘˜æ–¹æ³•å¹¶è°ƒç”¨ package fanshe.method; public class Student { //**************æˆå‘˜æ–¹æ³•***************// public void show1(String s){ System.out.println(&quot;è°ƒç”¨äº†ï¼šå…¬æœ‰çš„ï¼ŒStringå‚æ•°çš„show1(): s = &quot; + s); } protected void show2(){ System.out.println(&quot;è°ƒç”¨äº†ï¼šå—ä¿æŠ¤çš„ï¼Œæ— å‚çš„show2()&quot;); } void show3(){ System.out.println(&quot;è°ƒç”¨äº†ï¼šé»˜è®¤çš„ï¼Œæ— å‚çš„show3()&quot;); } private String show4(int age){ System.out.println(&quot;è°ƒç”¨äº†ï¼Œç§æœ‰çš„ï¼Œå¹¶ä¸”æœ‰è¿”å›å€¼çš„ï¼Œintå‚æ•°çš„show4(): age = &quot; + age); return &quot;abcd&quot;; } } æµ‹è¯•ç±»ï¼š /* * è·å–æˆå‘˜æ–¹æ³•å¹¶è°ƒç”¨ï¼š * * 1.æ‰¹é‡çš„ï¼š * public Method[] getMethods():è·å–æ‰€æœ‰&quot;å…¬æœ‰æ–¹æ³•&quot;ï¼›ï¼ˆåŒ…å«äº†çˆ¶ç±»çš„æ–¹æ³•ä¹ŸåŒ…å«Objectç±»ï¼‰ * public Method[] getDeclaredMethods():è·å–æ‰€æœ‰çš„æˆå‘˜æ–¹æ³•ï¼ŒåŒ…æ‹¬ç§æœ‰çš„(ä¸åŒ…æ‹¬ç»§æ‰¿çš„) * 2.è·å–å•ä¸ªçš„ï¼š * public Method getMethod(String name,Class&lt;?&gt;... parameterTypes): * å‚æ•°ï¼š * name : æ–¹æ³•åï¼› * Class ... : å½¢å‚çš„Classç±»å‹å¯¹è±¡ * public Method getDeclaredMethod(String name,Class&lt;?&gt;... parameterTypes) * * è°ƒç”¨æ–¹æ³•ï¼š * Method --&gt; public Object invoke(Object obj,Object... args): * å‚æ•°è¯´æ˜ï¼š * obj : è¦è°ƒç”¨æ–¹æ³•çš„å¯¹è±¡ï¼› * args:è°ƒç”¨æ–¹å¼æ—¶æ‰€ä¼ é€’çš„å®å‚ï¼› ): */ package fanshe.method; import java.lang.reflect.Method; public class MethodClass { public static void main(String[] args) throws Exception { //1.è·å–Classå¯¹è±¡ Class stuClass = Class.forName(&quot;fanshe.method.Student&quot;); //2.è·å–æ‰€æœ‰å…¬æœ‰æ–¹æ³• System.out.println(&quot;***************è·å–æ‰€æœ‰çš„â€å…¬æœ‰â€œæ–¹æ³•*******************&quot;); stuClass.getMethods(); Method[] methodArray = stuClass.getMethods(); for(Method m : methodArray){ System.out.println(m); } System.out.println(&quot;***************è·å–æ‰€æœ‰çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬ç§æœ‰çš„*******************&quot;); methodArray = stuClass.getDeclaredMethods(); for(Method m : methodArray){ System.out.println(m); } System.out.println(&quot;***************è·å–å…¬æœ‰çš„show1()æ–¹æ³•*******************&quot;); Method m = stuClass.getMethod(&quot;show1&quot;, String.class); System.out.println(m); //å®ä¾‹åŒ–ä¸€ä¸ªStudentå¯¹è±¡ Object obj = stuClass.getConstructor().newInstance(); m.invoke(obj, &quot;åˆ˜å¾·å&quot;); System.out.println(&quot;***************è·å–ç§æœ‰çš„show4()æ–¹æ³•******************&quot;); m = stuClass.getDeclaredMethod(&quot;show4&quot;, int.class); System.out.println(m); m.setAccessible(true);//è§£é™¤ç§æœ‰é™å®š Object result = m.invoke(obj, 20);//éœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯è¦è°ƒç”¨çš„å¯¹è±¡ï¼ˆè·å–æœ‰åå°„ï¼‰ï¼Œä¸€ä¸ªæ˜¯å®å‚ System.out.println(&quot;è¿”å›å€¼ï¼š&quot; + result); } } æ§åˆ¶å°è¾“å‡ºï¼š ***************è·å–æ‰€æœ‰çš„â€å…¬æœ‰â€œæ–¹æ³•******************* public void fanshe.method.Student.show1(java.lang.String) public final void java.lang.Object.wait(long,int) throws java.lang.InterruptedException public final native void java.lang.Object.wait(long) throws java.lang.InterruptedException public final void java.lang.Object.wait() throws java.lang.InterruptedException public boolean java.lang.Object.equals(java.lang.Object) public java.lang.String java.lang.Object.toString() public native int java.lang.Object.hashCode() public final native java.lang.Class java.lang.Object.getClass() public final native void java.lang.Object.notify() public final native void java.lang.Object.notifyAll() ***************è·å–æ‰€æœ‰çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬ç§æœ‰çš„******************* public void fanshe.method.Student.show1(java.lang.String) private java.lang.String fanshe.method.Student.show4(int) protected void fanshe.method.Student.show2() void fanshe.method.Student.show3() ***************è·å–å…¬æœ‰çš„show1()æ–¹æ³•******************* public void fanshe.method.Student.show1(java.lang.String) è°ƒç”¨äº†ï¼šå…¬æœ‰çš„ï¼ŒStringå‚æ•°çš„show1(): s = åˆ˜å¾·å ***************è·å–ç§æœ‰çš„show4()æ–¹æ³•****************** private java.lang.String fanshe.method.Student.show4(int) è°ƒç”¨äº†ï¼Œç§æœ‰çš„ï¼Œå¹¶ä¸”æœ‰è¿”å›å€¼çš„ï¼Œintå‚æ•°çš„show4(): age = 20 è¿”å›å€¼ï¼šabcd åå°„mainæ–¹æ³• package fanshe.main; public class Student { public static void main(String[] args) { System.out.println(&quot;mainæ–¹æ³•æ‰§è¡Œäº†ã€‚ã€‚ã€‚&quot;); } } æµ‹è¯•ç±»ï¼š package fanshe.main; import java.lang.reflect.Method; /** * è·å–Studentç±»çš„mainæ–¹æ³•ã€ä¸è¦ä¸å½“å‰çš„mainæ–¹æ³•ææ··äº† */ public class Main { public static void main(String[] args) { try { //1ã€è·å–Studentå¯¹è±¡çš„å­—èŠ‚ç  Class clazz = Class.forName(&quot;fanshe.main.Student&quot;); //2ã€è·å–mainæ–¹æ³• Method methodMain = clazz.getMethod(&quot;main&quot;, String[].class);//ç¬¬ä¸€ä¸ªå‚æ•°ï¼šæ–¹æ³•åç§°ï¼Œç¬¬äºŒä¸ªå‚æ•°ï¼šæ–¹æ³•å½¢å‚çš„ç±»å‹ï¼Œ //3ã€è°ƒç”¨mainæ–¹æ³• // methodMain.invoke(null, new String[]{&quot;a&quot;,&quot;b&quot;,&quot;c&quot;}); //ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå¯¹è±¡ç±»å‹ï¼Œå› ä¸ºæ–¹æ³•æ˜¯staticé™æ€çš„ï¼Œæ‰€ä»¥ä¸ºnullå¯ä»¥ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯Stringæ•°ç»„ï¼Œè¿™é‡Œè¦æ³¨æ„åœ¨jdk1.4æ—¶æ˜¯æ•°ç»„ï¼Œjdk1.5ä¹‹åæ˜¯å¯å˜å‚æ•° //è¿™é‡Œæ‹†çš„æ—¶å€™å°† new String[]{&quot;a&quot;,&quot;b&quot;,&quot;c&quot;} æ‹†æˆ3ä¸ªå¯¹è±¡ã€‚ã€‚ã€‚æ‰€ä»¥éœ€è¦å°†å®ƒå¼ºè½¬ã€‚ methodMain.invoke(null, (Object)new String[]{&quot;a&quot;,&quot;b&quot;,&quot;c&quot;});//æ–¹å¼ä¸€ // methodMain.invoke(null, new Object[]{new String[]{&quot;a&quot;,&quot;b&quot;,&quot;c&quot;}});//æ–¹å¼äºŒ } catch (Exception e) { e.printStackTrace(); } } } æ§åˆ¶å°è¾“å‡ºï¼š mainæ–¹æ³•æ‰§è¡Œäº†ã€‚ã€‚ã€‚ åå°„æ–¹æ³•çš„å…¶å®ƒä½¿ç”¨ä¹‹---é€šè¿‡åå°„è¿è¡Œé…ç½®æ–‡ä»¶å†…å®¹ public class Student { public void show(){ System.out.println(&quot;is show()&quot;); } } é…ç½®æ–‡ä»¶ä»¥txtæ–‡ä»¶ä¸ºä¾‹å­ï¼ˆpro.txtï¼‰ï¼š className = cn.fanshe.Student methodName = show æµ‹è¯•ç±»ï¼š import java.io.FileNotFoundException; import java.io.FileReader; import java.io.IOException; import java.lang.reflect.Method; import java.util.Properties; /* * æˆ‘ä»¬åˆ©ç”¨åå°„å’Œé…ç½®æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ï¼šåº”ç”¨ç¨‹åºæ›´æ–°æ—¶ï¼Œå¯¹æºç æ— éœ€è¿›è¡Œä»»ä½•ä¿®æ”¹ * æˆ‘ä»¬åªéœ€è¦å°†æ–°ç±»å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå¹¶ä¿®æ”¹é…ç½®æ–‡ä»¶å³å¯ */ public class Demo { public static void main(String[] args) throws Exception { //é€šè¿‡åå°„è·å–Classå¯¹è±¡ Class stuClass = Class.forName(getValue(&quot;className&quot;));//&quot;cn.fanshe.Student&quot; //2è·å–show()æ–¹æ³• Method m = stuClass.getMethod(getValue(&quot;methodName&quot;));//show //3.è°ƒç”¨show()æ–¹æ³• m.invoke(stuClass.getConstructor().newInstance()); } //æ­¤æ–¹æ³•æ¥æ”¶ä¸€ä¸ªkeyï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­è·å–ç›¸åº”çš„value public static String getValue(String key) throws IOException{ Properties pro = new Properties();//è·å–é…ç½®æ–‡ä»¶çš„å¯¹è±¡ FileReader in = new FileReader(&quot;pro.txt&quot;);//è·å–è¾“å…¥æµ pro.load(in);//å°†æµåŠ è½½åˆ°é…ç½®æ–‡ä»¶å¯¹è±¡ä¸­ in.close(); return pro.getProperty(key);//è¿”å›æ ¹æ®keyè·å–çš„valueå€¼ } } æ§åˆ¶å°è¾“å‡ºï¼š is show() éœ€æ±‚ï¼š å½“æˆ‘ä»¬å‡çº§è¿™ä¸ªç³»ç»Ÿæ—¶ï¼Œä¸è¦Studentç±»ï¼Œè€Œéœ€è¦æ–°å†™ä¸€ä¸ªStudent2çš„ç±»æ—¶ï¼Œè¿™æ—¶åªéœ€è¦æ›´æ”¹pro.txtçš„æ–‡ä»¶å†…å®¹å°±å¯ä»¥äº†ã€‚ä»£ç å°±ä¸€ç‚¹ä¸ç”¨æ”¹åŠ¨ è¦æ›¿æ¢çš„student2ç±»ï¼š public class Student2 { public void show2(){ System.out.println(&quot;is show2()&quot;); } } é…ç½®æ–‡ä»¶æ›´æ”¹ä¸ºï¼š className = cn.fanshe.Student2 methodName = show2 æ§åˆ¶å°è¾“å‡ºï¼š is show2(); åå°„æ–¹æ³•çš„å…¶å®ƒä½¿ç”¨ä¹‹---é€šè¿‡åå°„è¶Šè¿‡æ³›å‹æ£€æŸ¥ æ³›å‹ç”¨åœ¨ç¼–è¯‘æœŸï¼Œç¼–è¯‘è¿‡åæ³›å‹æ“¦é™¤ï¼ˆæ¶ˆå¤±æ‰ï¼‰ã€‚æ‰€ä»¥æ˜¯å¯ä»¥é€šè¿‡åå°„è¶Šè¿‡æ³›å‹æ£€æŸ¥çš„ import java.lang.reflect.Method; import java.util.ArrayList; /* * é€šè¿‡åå°„è¶Šè¿‡æ³›å‹æ£€æŸ¥ * * ä¾‹å¦‚ï¼šæœ‰ä¸€ä¸ªStringæ³›å‹çš„é›†åˆï¼Œæ€æ ·èƒ½å‘è¿™ä¸ªé›†åˆä¸­æ·»åŠ ä¸€ä¸ªIntegerç±»å‹çš„å€¼ï¼Ÿ */ public class Demo { public static void main(String[] args) throws Exception{ ArrayList&lt;String&gt; strList = new ArrayList&lt;&gt;(); strList.add(&quot;aaa&quot;); strList.add(&quot;bbb&quot;); // strList.add(100); //è·å–ArrayListçš„Classå¯¹è±¡ï¼Œåå‘çš„è°ƒç”¨add()æ–¹æ³•ï¼Œæ·»åŠ æ•°æ® Class listClass = strList.getClass(); //å¾—åˆ° strList å¯¹è±¡çš„å­—èŠ‚ç  å¯¹è±¡ //è·å–add()æ–¹æ³• Method m = listClass.getMethod(&quot;add&quot;, Object.class); //è°ƒç”¨add()æ–¹æ³• m.invoke(listClass , 100); //éå†é›†åˆ for(Object obj : strList){ System.out.println(obj); } } } æ§åˆ¶å°è¾“å‡ºï¼š aaa bbb 100 ","link":"https://tianxiawuhao.github.io/NjXzyw7sR/"},{"title":"javaåŸºç¡€ä¹‹ä¸€é›†åˆ","content":"åŸºç¡€æ•°æ®ç»“æ„è¯´æ˜ â€‹ æ•°ç»„ï¼šé‡‡ç”¨ä¸€æ®µè¿ç»­çš„å­˜å‚¨å•å…ƒæ¥å­˜å‚¨æ•°æ®ã€‚å¯¹äºæŒ‡å®šä¸‹æ ‡çš„æŸ¥æ‰¾ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(1)ï¼›é€šè¿‡ç»™å®šå€¼è¿›è¡ŒæŸ¥æ‰¾ï¼Œéœ€è¦éå†æ•°ç»„ï¼Œé€ä¸€æ¯”å¯¹ç»™å®šå…³é”®å­—å’Œæ•°ç»„å…ƒç´ ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(n)ï¼Œå½“ç„¶ï¼Œå¯¹äºæœ‰åºæ•°ç»„ï¼Œåˆ™å¯é‡‡ç”¨äºŒåˆ†æŸ¥æ‰¾ï¼Œæ’å€¼æŸ¥æ‰¾ï¼Œæ–æ³¢é‚£å¥‘æŸ¥æ‰¾ç­‰æ–¹å¼ï¼Œå¯å°†æŸ¥æ‰¾å¤æ‚åº¦æé«˜ä¸ºO(logn)ï¼›å¯¹äºä¸€èˆ¬çš„æ’å…¥åˆ é™¤æ“ä½œï¼Œæ¶‰åŠåˆ°æ•°ç»„å…ƒç´ çš„ç§»åŠ¨ï¼Œå…¶å¹³å‡å¤æ‚åº¦ä¹Ÿä¸ºO(n) çº¿æ€§é“¾è¡¨ï¼šå¯¹äºé“¾è¡¨çš„æ–°å¢ï¼Œåˆ é™¤ç­‰æ“ä½œï¼ˆåœ¨æ‰¾åˆ°æŒ‡å®šæ“ä½œä½ç½®åï¼‰ï¼Œä»…éœ€å¤„ç†ç»“ç‚¹é—´çš„å¼•ç”¨å³å¯ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(1)ï¼Œè€ŒæŸ¥æ‰¾æ“ä½œéœ€è¦éå†é“¾è¡¨é€ä¸€è¿›è¡Œæ¯”å¯¹ï¼Œå¤æ‚åº¦ä¸ºO(n) äºŒå‰æ ‘ï¼šå¯¹ä¸€æ£µç›¸å¯¹å¹³è¡¡çš„æœ‰åºäºŒå‰æ ‘ï¼Œå¯¹å…¶è¿›è¡Œæ’å…¥ï¼ŒæŸ¥æ‰¾ï¼Œåˆ é™¤ç­‰æ“ä½œï¼Œå¹³å‡å¤æ‚åº¦å‡ä¸ºO(logn)ã€‚ å“ˆå¸Œè¡¨ï¼šç›¸æ¯”ä¸Šè¿°å‡ ç§æ•°æ®ç»“æ„ï¼Œåœ¨å“ˆå¸Œè¡¨ä¸­è¿›è¡Œæ·»åŠ ï¼Œåˆ é™¤ï¼ŒæŸ¥æ‰¾ç­‰æ“ä½œï¼Œæ€§èƒ½ååˆ†ä¹‹é«˜ï¼Œä¸è€ƒè™‘å“ˆå¸Œå†²çªçš„æƒ…å†µä¸‹ï¼Œä»…éœ€ä¸€æ¬¡å®šä½å³å¯å®Œæˆï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(1)ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥çœ‹çœ‹å“ˆå¸Œè¡¨æ˜¯å¦‚ä½•å®ç°è¾¾åˆ°æƒŠè‰³çš„å¸¸æ•°é˜¶O(1)çš„ã€‚ å“ˆå¸Œè¡¨å…·ä½“è¯´æ˜ æˆ‘ä»¬çŸ¥é“ï¼Œæ•°æ®ç»“æ„çš„ç‰©ç†å­˜å‚¨ç»“æ„åªæœ‰ä¸¤ç§ï¼šé¡ºåºå­˜å‚¨ç»“æ„å’Œé“¾å¼å­˜å‚¨ç»“æ„ï¼ˆåƒæ ˆï¼Œé˜Ÿåˆ—ï¼Œæ ‘ï¼Œå›¾ç­‰æ˜¯ä»é€»è¾‘ç»“æ„å»æŠ½è±¡çš„ï¼Œæ˜ å°„åˆ°å†…å­˜ä¸­ï¼Œä¹Ÿæ˜¯è¿™ä¸¤ç§ç‰©ç†ç»„ç»‡å½¢å¼ï¼‰ï¼Œè€Œåœ¨ä¸Šé¢æˆ‘ä»¬æåˆ°è¿‡ï¼Œåœ¨æ•°ç»„ä¸­æ ¹æ®ä¸‹æ ‡æŸ¥æ‰¾æŸä¸ªå…ƒç´ ï¼Œä¸€æ¬¡å®šä½å°±å¯ä»¥è¾¾åˆ°ï¼Œå“ˆå¸Œè¡¨åˆ©ç”¨äº†è¿™ç§ç‰¹æ€§ï¼Œå“ˆå¸Œè¡¨çš„ä¸»å¹²å°±æ˜¯æ•°ç»„ã€‚ æ¯”å¦‚æˆ‘ä»¬è¦æ–°å¢æˆ–æŸ¥æ‰¾æŸä¸ªå…ƒç´ ï¼Œæˆ‘ä»¬é€šè¿‡æŠŠå½“å‰å…ƒç´ çš„å…³é”®å­— é€šè¿‡æŸä¸ªå‡½æ•°æ˜ å°„åˆ°æ•°ç»„ä¸­çš„æŸä¸ªä½ç½®ï¼Œé€šè¿‡æ•°ç»„ä¸‹æ ‡ä¸€æ¬¡å®šä½å°±å¯å®Œæˆæ“ä½œã€‚ å­˜å‚¨ä½ç½® = f(å…³é”®å­—) å…¶ä¸­ï¼Œè¿™ä¸ªå‡½æ•°fä¸€èˆ¬ç§°ä¸ºå“ˆå¸Œå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„è®¾è®¡å¥½åä¼šç›´æ¥å½±å“åˆ°å“ˆå¸Œè¡¨çš„ä¼˜åŠ£ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦åœ¨å“ˆå¸Œè¡¨ä¸­æ‰§è¡Œæ’å…¥æ“ä½œï¼š æŸ¥æ‰¾æ“ä½œåŒç†ï¼Œå…ˆé€šè¿‡å“ˆå¸Œå‡½æ•°è®¡ç®—å‡ºå®é™…å­˜å‚¨åœ°å€ï¼Œç„¶åä»æ•°ç»„ä¸­å¯¹åº”åœ°å€å–å‡ºå³å¯ã€‚ å“ˆå¸Œå†²çª ç„¶è€Œä¸‡äº‹æ— å®Œç¾ï¼Œå¦‚æœä¸¤ä¸ªä¸åŒçš„å…ƒç´ ï¼Œé€šè¿‡å“ˆå¸Œå‡½æ•°å¾—å‡ºçš„å®é™…å­˜å‚¨åœ°å€ç›¸åŒæ€ä¹ˆåŠï¼Ÿä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬å¯¹æŸä¸ªå…ƒç´ è¿›è¡Œå“ˆå¸Œè¿ç®—ï¼Œå¾—åˆ°ä¸€ä¸ªå­˜å‚¨åœ°å€ï¼Œç„¶åè¦è¿›è¡Œæ’å…¥çš„æ—¶å€™ï¼Œå‘ç°å·²ç»è¢«å…¶ä»–å…ƒç´ å ç”¨äº†ï¼Œå…¶å®è¿™å°±æ˜¯æ‰€è°“çš„å“ˆå¸Œå†²çªï¼Œä¹Ÿå«å“ˆå¸Œç¢°æ’ã€‚å‰é¢æˆ‘ä»¬æåˆ°è¿‡ï¼Œå“ˆå¸Œå‡½æ•°çš„è®¾è®¡è‡³å…³é‡è¦ï¼Œå¥½çš„å“ˆå¸Œå‡½æ•°ä¼šå°½å¯èƒ½åœ°ä¿è¯ è®¡ç®—ç®€å•å’Œæ•£åˆ—åœ°å€åˆ†å¸ƒå‡åŒ€ä½†æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦æ¸…æ¥šçš„æ˜¯ï¼Œæ•°ç»„æ˜¯ä¸€å—è¿ç»­çš„å›ºå®šé•¿åº¦çš„å†…å­˜ç©ºé—´ï¼Œå†å¥½çš„å“ˆå¸Œå‡½æ•°ä¹Ÿä¸èƒ½ä¿è¯å¾—åˆ°çš„å­˜å‚¨åœ°å€ç»å¯¹ä¸å‘ç”Ÿå†²çªã€‚é‚£ä¹ˆå“ˆå¸Œå†²çªå¦‚ä½•è§£å†³å‘¢ï¼Ÿå“ˆå¸Œå†²çªçš„è§£å†³æ–¹æ¡ˆæœ‰å¤šç§:å¼€æ”¾å®šå€æ³•ï¼ˆçº¿æ€§æ¢æµ‹ï¼‰ï¼ˆå‘ç”Ÿå†²çªï¼Œç»§ç»­å¯»æ‰¾ä¸‹ä¸€å—æœªè¢«å ç”¨çš„å­˜å‚¨åœ°å€ï¼‰ï¼Œå†æ•£åˆ—å‡½æ•°æ³•ï¼Œé“¾åœ°å€æ³•ã€‚ R-B Treeç®€ä»‹ R-B Treeï¼Œå…¨ç§°æ˜¯Red-Black Treeï¼Œåˆç§°ä¸ºâ€œçº¢é»‘æ ‘â€ï¼Œå®ƒä¸€ç§ç‰¹æ®Šçš„äºŒå‰æŸ¥æ‰¾æ ‘ã€‚çº¢é»‘æ ‘çš„æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½æœ‰å­˜å‚¨ä½è¡¨ç¤ºèŠ‚ç‚¹çš„é¢œè‰²ï¼Œå¯ä»¥æ˜¯çº¢(Red)æˆ–é»‘(Black)ã€‚ çº¢é»‘æ ‘çš„ç‰¹æ€§: ï¼ˆ1ï¼‰æ¯ä¸ªèŠ‚ç‚¹æˆ–è€…æ˜¯é»‘è‰²ï¼Œæˆ–è€…æ˜¯çº¢è‰²ã€‚ ï¼ˆ2ï¼‰æ ¹èŠ‚ç‚¹æ˜¯é»‘è‰²ã€‚ ï¼ˆ3ï¼‰æ¯ä¸ªå¶å­èŠ‚ç‚¹ï¼ˆNILï¼‰æ˜¯é»‘è‰²ã€‚ [æ³¨æ„ï¼šè¿™é‡Œå¶å­èŠ‚ç‚¹ï¼Œæ˜¯æŒ‡ä¸ºç©º(NILæˆ–NULL)çš„å¶å­èŠ‚ç‚¹ï¼] ï¼ˆ4ï¼‰å¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ˜¯çº¢è‰²çš„ï¼Œåˆ™å®ƒçš„å­èŠ‚ç‚¹å¿…é¡»æ˜¯é»‘è‰²çš„ã€‚ ï¼ˆ5ï¼‰ä»ä¸€ä¸ªèŠ‚ç‚¹åˆ°è¯¥èŠ‚ç‚¹çš„å­å­™èŠ‚ç‚¹çš„æ‰€æœ‰è·¯å¾„ä¸ŠåŒ…å«ç›¸åŒæ•°ç›®çš„é»‘èŠ‚ç‚¹ã€‚ æ³¨æ„ï¼š (01) ç‰¹æ€§(3)ä¸­çš„å¶å­èŠ‚ç‚¹ï¼Œæ˜¯åªä¸ºç©º(NILæˆ–null)çš„èŠ‚ç‚¹ã€‚ (02) ç‰¹æ€§(5)ï¼Œç¡®ä¿æ²¡æœ‰ä¸€æ¡è·¯å¾„ä¼šæ¯”å…¶ä»–è·¯å¾„é•¿å‡ºä¿©å€ã€‚å› è€Œï¼Œçº¢é»‘æ ‘æ˜¯ç›¸å¯¹æ˜¯æ¥è¿‘å¹³è¡¡çš„äºŒå‰æ ‘ã€‚ çº¢é»‘æ ‘ç¤ºæ„å›¾å¦‚ä¸‹ï¼š æ€§è´¨ çº¢é»‘æ ‘æ˜¯æ¯ä¸ªèŠ‚ç‚¹éƒ½å¸¦æœ‰é¢œè‰²å±æ€§çš„äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œé¢œè‰²æˆ–çº¢è‰²æˆ–é»‘è‰²ã€‚åœ¨äºŒå‰æŸ¥æ‰¾æ ‘å¼ºåˆ¶ä¸€èˆ¬è¦æ±‚ä»¥å¤–ï¼Œå¯¹äºä»»ä½•æœ‰æ•ˆçš„çº¢é»‘æ ‘æˆ‘ä»¬å¢åŠ äº†å¦‚ä¸‹çš„é¢å¤–è¦æ±‚ï¼š ã€1ã€‘æ€§è´¨1. èŠ‚ç‚¹æ˜¯çº¢è‰²æˆ–é»‘è‰²ã€‚ ã€2ã€‘æ€§è´¨2. æ ¹èŠ‚ç‚¹æ˜¯é»‘è‰²ã€‚ ã€3ã€‘æ€§è´¨3 æ¯ä¸ªå¶èŠ‚ç‚¹æ˜¯é»‘è‰²çš„ã€‚ ã€4ã€‘æ€§è´¨4 æ¯ä¸ªçº¢è‰²èŠ‚ç‚¹çš„ä¸¤ä¸ªå­èŠ‚ç‚¹éƒ½æ˜¯é»‘è‰²ã€‚(ä»æ¯ä¸ªå¶å­åˆ°æ ¹çš„æ‰€æœ‰è·¯å¾„ä¸Šä¸èƒ½æœ‰ä¸¤ä¸ªè¿ç»­çš„çº¢è‰²èŠ‚ç‚¹) ã€5ã€‘æ€§è´¨5. ä»ä»»ä¸€èŠ‚ç‚¹åˆ°å…¶æ¯ä¸ªå¶å­çš„æ‰€æœ‰è·¯å¾„éƒ½åŒ…å«ç›¸åŒæ•°ç›®çš„é»‘è‰²èŠ‚ç‚¹ã€‚ ç”¨é€”å’Œå¥½å¤„ çº¢é»‘æ ‘å’ŒAVLæ ‘ä¸€æ ·éƒ½å¯¹æ’å…¥æ—¶é—´ã€åˆ é™¤æ—¶é—´å’ŒæŸ¥æ‰¾æ—¶é—´æä¾›äº†æœ€å¥½å¯èƒ½çš„æœ€åæƒ…å†µæ‹…ä¿ã€‚è¿™ä¸åªæ˜¯ä½¿å®ƒä»¬åœ¨æ—¶é—´æ•æ„Ÿçš„åº”ç”¨å¦‚å³æ—¶åº”ç”¨(real time application)ä¸­æœ‰ä»·å€¼ï¼Œè€Œä¸”ä½¿å®ƒä»¬æœ‰åœ¨æä¾›æœ€åæƒ…å†µæ‹…ä¿çš„å…¶ä»–æ•°æ®ç»“æ„ä¸­ä½œä¸ºå»ºé€ æ¿å—çš„ä»·å€¼ï¼›ä¾‹å¦‚ï¼Œåœ¨è®¡ç®—å‡ ä½•ä¸­ä½¿ç”¨çš„å¾ˆå¤šæ•°æ®ç»“æ„éƒ½å¯ä»¥åŸºäºçº¢é»‘æ ‘ã€‚ â€‹ çº¢é»‘æ ‘åœ¨å‡½æ•°å¼ç¼–ç¨‹ä¸­ä¹Ÿç‰¹åˆ«æœ‰ç”¨ï¼Œåœ¨è¿™é‡Œå®ƒä»¬æ˜¯æœ€å¸¸ç”¨çš„æŒä¹…æ•°æ®ç»“æ„ä¹‹ä¸€ï¼Œå®ƒä»¬ç”¨æ¥æ„é€ å…³è”æ•°ç»„å’Œé›†åˆï¼Œåœ¨çªå˜ä¹‹åå®ƒä»¬èƒ½ä¿æŒä¸ºä»¥å‰çš„ç‰ˆæœ¬ã€‚é™¤äº†O(log n)çš„æ—¶é—´ä¹‹å¤–ï¼Œçº¢é»‘æ ‘çš„æŒä¹…ç‰ˆæœ¬å¯¹æ¯æ¬¡æ’å…¥æˆ–åˆ é™¤éœ€è¦O(log n)çš„ç©ºé—´ã€‚ â€‹ çº¢é»‘æ ‘æ˜¯ 2-3-4æ ‘çš„ä¸€ç§ç­‰åŒã€‚æ¢å¥è¯è¯´ï¼Œå¯¹äºæ¯ä¸ª 2-3-4 æ ‘ï¼Œéƒ½å­˜åœ¨è‡³å°‘ä¸€ä¸ªæ•°æ®å…ƒç´ æ˜¯åŒæ ·æ¬¡åºçš„çº¢é»‘æ ‘ã€‚åœ¨ 2-3-4 æ ‘ä¸Šçš„æ’å…¥å’Œåˆ é™¤æ“ä½œä¹Ÿç­‰åŒäºåœ¨çº¢é»‘æ ‘ä¸­é¢œè‰²ç¿»è½¬å’Œæ—‹è½¬ã€‚è¿™ä½¿å¾— 2-3-4 æ ‘æˆä¸ºç†è§£çº¢é»‘æ ‘èƒŒåçš„é€»è¾‘çš„é‡è¦å·¥å…·ï¼Œè¿™ä¹Ÿæ˜¯å¾ˆå¤šä»‹ç»ç®—æ³•çš„æ•™ç§‘ä¹¦åœ¨çº¢é»‘æ ‘ä¹‹å‰ä»‹ç» 2-3-4 æ ‘çš„åŸå› ï¼Œå°½ç®¡ 2-3-4 æ ‘åœ¨å®è·µä¸­ä¸ç»å¸¸ä½¿ç”¨ã€‚ çº¢é»‘æ ‘çš„æ•°æ®ç»“æ„ public class RBTree&lt;T extends Comparable&lt;T&gt;&gt; { private RBTNode&lt;T&gt; mRoot; // æ ¹ç»“ç‚¹ private static final boolean RED = false; private static final boolean BLACK = true; public class RBTNode&lt;T extends Comparable&lt;T&gt;&gt; { boolean color; // é¢œè‰² T key; // å…³é”®å­—(é”®å€¼) RBTNode&lt;T&gt; left; // å·¦å­©å­ RBTNode&lt;T&gt; right; // å³å­©å­ RBTNode&lt;T&gt; parent; // çˆ¶ç»“ç‚¹ public RBTNode(T key, boolean color, RBTNode&lt;T&gt; parent, RBTNode&lt;T&gt; left, RBTNode&lt;T&gt; right) { this.key = key; this.color = color; this.parent = parent; this.left = left; this.right = right; } } ... } é›†åˆè¯´æ˜ ArrayListå®ç°åŸç†è¦ç‚¹æ¦‚æ‹¬ ArrayListæ˜¯Listæ¥å£çš„å¯å˜æ•°ç»„éåŒæ­¥å®ç°ï¼Œå¹¶å…è®¸åŒ…æ‹¬nullåœ¨å†…çš„æ‰€æœ‰å…ƒç´ ã€‚ ArrayListçš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š è¯´æ˜ï¼šåº•å±‚çš„æ•°æ®ç»“æ„å°±æ˜¯æ•°ç»„ï¼Œæ•°ç»„å…ƒç´ ç±»å‹ä¸ºObjectç±»å‹ï¼Œå³å¯ä»¥å­˜æ”¾æ‰€æœ‰ç±»å‹æ•°æ®ã€‚æˆ‘ä»¬å¯¹ArrayListç±»çš„å®ä¾‹çš„æ‰€æœ‰çš„æ“ä½œåº•å±‚éƒ½æ˜¯åŸºäºæ•°ç»„çš„ã€‚ è¯¥é›†åˆæ˜¯å¯å˜é•¿åº¦æ•°ç»„ï¼Œæ•°ç»„æ‰©å®¹æ—¶ï¼Œä¼šå°†è€æ•°ç»„ä¸­çš„å…ƒç´ é‡æ–°æ‹·è´ä¸€ä»½åˆ°æ–°çš„æ•°ç»„ä¸­ï¼Œæ¯æ¬¡æ•°ç»„å®¹é‡å¢é•¿å¤§çº¦æ˜¯å…¶å®¹é‡çš„1.5å€ï¼Œè¿™ç§æ“ä½œçš„ä»£ä»·å¾ˆé«˜ã€‚ newCapacity = oldCapacity + (oldCapacity &gt;&gt; 1) é‡‡ç”¨äº†Fail-Fastæœºåˆ¶ï¼Œé¢å¯¹å¹¶å‘çš„ä¿®æ”¹æ—¶ï¼Œè¿­ä»£å™¨å¾ˆå¿«å°±ä¼šå®Œå…¨å¤±è´¥ï¼Œè€Œä¸æ˜¯å†’ç€åœ¨å°†æ¥æŸä¸ªä¸ç¡®å®šæ—¶é—´å‘ç”Ÿä»»æ„ä¸ç¡®å®šè¡Œä¸ºçš„é£é™© removeæ–¹æ³•ä¼šè®©ä¸‹æ ‡åˆ°æ•°ç»„æœ«å°¾çš„å…ƒç´ å‘å‰ç§»åŠ¨ä¸€ä¸ªå•ä½ï¼Œå¹¶æŠŠæœ€åä¸€ä½çš„å€¼ç½®ç©ºï¼Œæ–¹ä¾¿GC LinkedListå®ç°åŸç†è¦ç‚¹æ¦‚æ‹¬ LinkedListæ˜¯Listæ¥å£çš„åŒå‘é“¾è¡¨éåŒæ­¥å®ç°ï¼Œå¹¶å…è®¸åŒ…æ‹¬nullåœ¨å†…çš„æ‰€æœ‰å…ƒç´ ã€‚ä»JDK1.7å¼€å§‹ï¼ŒLinkedList ç”±åŒå‘å¾ªç¯é“¾è¡¨æ”¹ä¸ºåŒå‘é“¾è¡¨ LinkedListæ•°æ®ç»“æ„å¦‚ä¸‹ è¯´æ˜ï¼šå¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒLinkedListåº•å±‚ä½¿ç”¨çš„åŒå‘é“¾è¡¨ç»“æ„ï¼Œæœ‰ä¸€ä¸ªå¤´ç»“ç‚¹å’Œä¸€ä¸ªå°¾ç»“ç‚¹ï¼ŒåŒå‘é“¾è¡¨æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä»å¤´å¼€å§‹æ­£å‘éå†ï¼Œæˆ–è€…æ˜¯ä»å°¾å¼€å§‹é€†å‘éå†ï¼Œå¹¶ä¸”å¯ä»¥é’ˆå¯¹å¤´éƒ¨å’Œå°¾éƒ¨è¿›è¡Œç›¸åº”çš„æ“ä½œã€‚ åŒå‘é“¾è¡¨èŠ‚ç‚¹å¯¹åº”çš„ç±»Nodeçš„å®ä¾‹ï¼ŒNodeä¸­åŒ…å«æˆå‘˜å˜é‡ï¼šprevï¼Œnextï¼Œitemã€‚å…¶ä¸­ï¼Œprevæ˜¯è¯¥èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹ï¼Œnextæ˜¯è¯¥èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œitemæ˜¯è¯¥èŠ‚ç‚¹æ‰€åŒ…å«çš„å€¼ã€‚ public class LinkedList&lt;E&gt; extends AbstractSequentialList&lt;E&gt; implements List&lt;E&gt;, Deque&lt;E&gt;, Cloneable, java.io.Serializable { transient int size = 0; /** * Pointer to first node. * Invariant: (first == null &amp;&amp; last == null) || * (first.prev == null &amp;&amp; first.item != null) */ transient Node&lt;E&gt; first; /** * Pointer to last node. * Invariant: (first == null &amp;&amp; last == null) || * (last.next == null &amp;&amp; last.item != null) */ transient Node&lt;E&gt; last; /** * èŠ‚ç‚¹ç»“æ„ */ private static class Node&lt;E&gt; { E item; Node&lt;E&gt; next; Node&lt;E&gt; prev; Node(Node&lt;E&gt; prev, E element, Node&lt;E&gt; next) { this.item = element; this.next = next; this.prev = prev; } } } è¯´æ˜ï¼šLinkedListçš„å±æ€§éå¸¸ç®€å•ï¼Œä¸€ä¸ªå¤´ç»“ç‚¹ã€ä¸€ä¸ªå°¾ç»“ç‚¹ã€ä¸€ä¸ªè¡¨ç¤ºé“¾è¡¨ä¸­å®é™…å…ƒç´ ä¸ªæ•°çš„å˜é‡ã€‚æ³¨æ„ï¼Œå¤´ç»“ç‚¹ã€å°¾ç»“ç‚¹éƒ½æœ‰transientå…³é”®å­—ä¿®é¥°ï¼Œè¿™ä¹Ÿæ„å‘³ç€åœ¨åºåˆ—åŒ–æ—¶è¯¥åŸŸæ˜¯ä¸ä¼šåºåˆ—åŒ–çš„ã€‚ å®ƒçš„æŸ¥æ‰¾æ˜¯åˆ†ä¸¤åŠæŸ¥æ‰¾ï¼Œå…ˆåˆ¤æ–­indexæ˜¯åœ¨é“¾è¡¨çš„å“ªä¸€åŠï¼Œç„¶åå†å»å¯¹åº”åŒºåŸŸæŸ¥æ‰¾ï¼Œè¿™æ ·æœ€å¤šåªè¦éå†é“¾è¡¨çš„ä¸€åŠèŠ‚ç‚¹å³å¯æ‰¾åˆ° HashMapå®ç°åŸç†è¦ç‚¹æ¦‚æ‹¬ HashMapæ˜¯åŸºäºå“ˆå¸Œè¡¨çš„Mapæ¥å£çš„éåŒæ­¥å®ç°ï¼Œå…è®¸ä½¿ç”¨nullå€¼å’Œnullé”®ï¼Œä½†ä¸ä¿è¯æ˜ å°„çš„é¡ºåºã€‚ åº•å±‚ä½¿ç”¨æ•°ç»„å®ç°ï¼Œæ•°ç»„ä¸­æ¯ä¸€é¡¹æ˜¯ä¸ªå•å‘é“¾è¡¨ï¼Œå³æ•°ç»„å’Œé“¾è¡¨çš„ç»“åˆä½“ï¼›å½“é“¾è¡¨é•¿åº¦å¤§äº8æ—¶ï¼Œé“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼Œè¿™æ ·å‡å°‘é“¾è¡¨æŸ¥è¯¢æ—¶é—´ã€‚ HashMapåœ¨åº•å±‚å°†key-valueå½“æˆä¸€ä¸ªæ•´ä½“è¿›è¡Œå¤„ç†ï¼Œè¿™ä¸ªæ•´ä½“å°±æ˜¯ä¸€ä¸ªNodeå¯¹è±¡ã€‚HashMapåº•å±‚é‡‡ç”¨ä¸€ä¸ªNode[]æ•°ç»„æ¥ä¿å­˜æ‰€æœ‰çš„key-valueå¯¹ï¼Œå½“éœ€è¦å­˜å‚¨ä¸€ä¸ªNodeå¯¹è±¡æ—¶ï¼Œä¼šæ ¹æ®keyçš„hashç®—æ³•æ¥å†³å®šå…¶åœ¨æ•°ç»„ä¸­çš„å­˜å‚¨ä½ç½®ï¼Œå†æ ¹æ®equalsæ–¹æ³•å†³å®šå…¶åœ¨è¯¥æ•°ç»„ä½ç½®ä¸Šçš„é“¾è¡¨ä¸­çš„å­˜å‚¨ä½ç½®ï¼›å½“éœ€è¦å–å‡ºä¸€ä¸ªNodeæ—¶ï¼Œä¹Ÿä¼šæ ¹æ®keyçš„hashç®—æ³•æ‰¾åˆ°å…¶åœ¨æ•°ç»„ä¸­çš„å­˜å‚¨ä½ç½®ï¼Œå†æ ¹æ®equalsæ–¹æ³•ä»è¯¥ä½ç½®ä¸Šçš„é“¾è¡¨ä¸­å–å‡ºè¯¥Nodeã€‚ HashMapè§£å†³hashå†²çªæ˜¯é‡‡ç”¨äº†é“¾åœ°å€æ³•ï¼Œä¹Ÿå°±æ˜¯æ•°ç»„+é“¾è¡¨çš„æ–¹å¼ï¼Œ HashMapè¿›è¡Œæ•°ç»„æ‰©å®¹éœ€è¦é‡æ–°è®¡ç®—æ‰©å®¹åæ¯ä¸ªå…ƒç´ åœ¨æ•°ç»„ä¸­çš„ä½ç½®ï¼Œå¾ˆè€—æ€§èƒ½ é‡‡ç”¨äº†Fail-Fastæœºåˆ¶ï¼Œé€šè¿‡ä¸€ä¸ªmodCountå€¼è®°å½•ä¿®æ”¹æ¬¡æ•°ï¼Œå¯¹HashMapå†…å®¹çš„ä¿®æ”¹éƒ½å°†å¢åŠ è¿™ä¸ªå€¼ã€‚è¿­ä»£å™¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­ä¼šå°†è¿™ä¸ªå€¼èµ‹ç»™è¿­ä»£å™¨çš„expectedModCountï¼Œåœ¨è¿­ä»£è¿‡ç¨‹ä¸­ï¼Œåˆ¤æ–­modCountè·ŸexpectedModCountæ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœä¸ç›¸ç­‰å°±è¡¨ç¤ºå·²ç»æœ‰å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†Mapï¼Œé©¬ä¸ŠæŠ›å‡ºå¼‚å¸¸ é‡å†™equalsæ–¹æ³•éœ€åŒæ—¶é‡å†™hashCodeæ–¹æ³• public static void main(String []args){ HashMap&lt;Person,String&gt; map = new HashMap&lt;Person, String&gt;(); Person person = new Person(1234,&quot;ä¹”å³°&quot;); //putåˆ°hashmapä¸­å» map.put(person,&quot;å¤©é¾™å…«éƒ¨&quot;); //getå–å‡ºï¼Œä»é€»è¾‘ä¸Šè®²åº”è¯¥èƒ½è¾“å‡ºâ€œå¤©é¾™å…«éƒ¨â€ System.out.println(&quot;ç»“æœ:&quot;+map.get(new Person(1234,&quot;ä¹”å³°&quot;))); } â€‹ å¦‚æœæˆ‘ä»¬å·²ç»å¯¹HashMapçš„åŸç†æœ‰äº†ä¸€å®šäº†è§£ï¼Œè¿™ä¸ªç»“æœå°±ä¸éš¾ç†è§£äº†ã€‚å°½ç®¡æˆ‘ä»¬åœ¨è¿›è¡Œgetå’Œputæ“ä½œçš„æ—¶å€™ï¼Œä½¿ç”¨çš„keyä»é€»è¾‘ä¸Šè®²æ˜¯ç­‰å€¼çš„ï¼ˆé€šè¿‡equalsæ¯”è¾ƒæ˜¯ç›¸ç­‰çš„ï¼‰ï¼Œä½†ç”±äºæ²¡æœ‰é‡å†™hashCodeæ–¹æ³•ï¼Œæ‰€ä»¥putæ“ä½œæ—¶ï¼Œkey(hashcode1)--&gt;hash--&gt;indexFor--&gt;æœ€ç»ˆç´¢å¼•ä½ç½® ï¼Œè€Œé€šè¿‡keyå–å‡ºvalueçš„æ—¶å€™ key(hashcode2)--&gt;hash--&gt;indexFor--&gt;æœ€ç»ˆç´¢å¼•ä½ç½®ï¼Œç”±äºhashcode1ä¸ç­‰äºhashcode2ï¼Œå¯¼è‡´æ²¡æœ‰å®šä½åˆ°ä¸€ä¸ªæ•°ç»„ä½ç½®è€Œè¿”å›é€»è¾‘ä¸Šé”™è¯¯çš„å€¼nullï¼ˆä¹Ÿæœ‰å¯èƒ½ç¢°å·§å®šä½åˆ°ä¸€ä¸ªæ•°ç»„ä½ç½®ï¼Œä½†æ˜¯ä¹Ÿä¼šåˆ¤æ–­å…¶entryçš„hashå€¼æ˜¯å¦ç›¸ç­‰ã€‚ï¼‰ æ‰€ä»¥ï¼Œåœ¨é‡å†™equalsçš„æ–¹æ³•çš„æ—¶å€™ï¼Œå¿…é¡»æ³¨æ„é‡å†™hashCodeæ–¹æ³•ï¼ŒåŒæ—¶è¿˜è¦ä¿è¯é€šè¿‡equalsåˆ¤æ–­ç›¸ç­‰çš„ä¸¤ä¸ªå¯¹è±¡ï¼Œè°ƒç”¨hashCodeæ–¹æ³•è¦è¿”å›åŒæ ·çš„æ•´æ•°å€¼ã€‚è€Œå¦‚æœequalsåˆ¤æ–­ä¸ç›¸ç­‰çš„ä¸¤ä¸ªå¯¹è±¡ï¼Œå…¶hashCodeå¯ä»¥ç›¸åŒï¼ˆåªä¸è¿‡ä¼šå‘ç”Ÿå“ˆå¸Œå†²çªï¼Œåº”å°½é‡é¿å…ï¼‰ã€‚ Hashtableå®ç°åŸç†è¦ç‚¹æ¦‚æ‹¬ Hashtableæ˜¯åŸºäºå“ˆå¸Œè¡¨çš„Mapæ¥å£çš„åŒæ­¥å®ç°ï¼Œä¸å…è®¸ä½¿ç”¨nullå€¼å’Œnullé”®ï¼ŒHashtableä¸­çš„æ˜ å°„ä¸æ˜¯æœ‰åºçš„ åº•å±‚ä½¿ç”¨æ•°ç»„å®ç°ï¼Œæ•°ç»„ä¸­æ¯ä¸€é¡¹æ˜¯ä¸ªå•é“¾è¡¨ï¼Œå³æ•°ç»„å’Œé“¾è¡¨çš„ç»“åˆä½“ Hashtableåœ¨åº•å±‚å°†key-valueå½“æˆä¸€ä¸ªæ•´ä½“è¿›è¡Œå¤„ç†ï¼Œè¿™ä¸ªæ•´ä½“å°±æ˜¯ä¸€ä¸ªEntryå¯¹è±¡ã€‚Hashtableåº•å±‚é‡‡ç”¨ä¸€ä¸ªEntry[]æ•°ç»„æ¥ä¿å­˜æ‰€æœ‰çš„key-valueå¯¹ï¼Œå½“éœ€è¦å­˜å‚¨ä¸€ä¸ªEntryå¯¹è±¡æ—¶ï¼Œä¼šæ ¹æ®keyçš„hashç®—æ³•æ¥å†³å®šå…¶åœ¨æ•°ç»„ä¸­çš„å­˜å‚¨ä½ç½®ï¼Œåœ¨æ ¹æ®equalsæ–¹æ³•å†³å®šå…¶åœ¨è¯¥æ•°ç»„ä½ç½®ä¸Šçš„é“¾è¡¨ä¸­çš„å­˜å‚¨ä½ç½®ï¼›å½“éœ€è¦å–å‡ºä¸€ä¸ªEntryæ—¶ï¼Œä¹Ÿä¼šæ ¹æ®keyçš„hashç®—æ³•æ‰¾åˆ°å…¶åœ¨æ•°ç»„ä¸­çš„å­˜å‚¨ä½ç½®ï¼Œå†æ ¹æ®equalsæ–¹æ³•ä»è¯¥ä½ç½®ä¸Šçš„é“¾è¡¨ä¸­å–å‡ºè¯¥Entryã€‚ synchronizedæ˜¯é’ˆå¯¹æ•´å¼ Hashè¡¨çš„ï¼Œå³æ¯æ¬¡é”ä½æ•´å¼ è¡¨è®©çº¿ç¨‹ç‹¬å  ConcurrentHashMapå®ç°åŸç†è¦ç‚¹æ¦‚æ‹¬ ConcurrentHashMapå…è®¸å¤šä¸ªä¿®æ”¹æ“ä½œå¹¶å‘è¿›è¡Œï¼Œå…¶å…³é”®åœ¨äºä½¿ç”¨äº†é”åˆ†ç¦»æŠ€æœ¯ã€‚ å®ƒä½¿ç”¨äº†å¤šä¸ªé”æ¥æ§åˆ¶å¯¹hashè¡¨çš„ä¸åŒæ®µè¿›è¡Œçš„ä¿®æ”¹ï¼Œæ¯ä¸ªæ®µå…¶å®å°±æ˜¯ä¸€ä¸ªå°çš„hashtableï¼Œå®ƒä»¬æœ‰è‡ªå·±çš„é”ã€‚åªè¦å¤šä¸ªå¹¶å‘å‘ç”Ÿåœ¨ä¸åŒçš„æ®µä¸Šï¼Œå®ƒä»¬å°±å¯ä»¥å¹¶å‘è¿›è¡Œã€‚ ConcurrentHashMapåœ¨åº•å±‚å°†key-valueå½“æˆä¸€ä¸ªæ•´ä½“è¿›è¡Œå¤„ç†ï¼Œè¿™ä¸ªæ•´ä½“å°±æ˜¯ä¸€ä¸ªEntryå¯¹è±¡ã€‚Hashtableåº•å±‚é‡‡ç”¨ä¸€ä¸ªEntry[]æ•°ç»„æ¥ä¿å­˜æ‰€æœ‰çš„key-valueå¯¹ï¼Œå½“éœ€è¦å­˜å‚¨ä¸€ä¸ªEntryå¯¹è±¡æ—¶ï¼Œä¼šæ ¹æ®keyçš„hashç®—æ³•æ¥å†³å®šå…¶åœ¨æ•°ç»„ä¸­çš„å­˜å‚¨ä½ç½®ï¼Œåœ¨æ ¹æ®equalsæ–¹æ³•å†³å®šå…¶åœ¨è¯¥æ•°ç»„ä½ç½®ä¸Šçš„é“¾è¡¨ä¸­çš„å­˜å‚¨ä½ç½®ï¼›å½“éœ€è¦å–å‡ºä¸€ä¸ªEntryæ—¶ï¼Œä¹Ÿä¼šæ ¹æ®keyçš„hashç®—æ³•æ‰¾åˆ°å…¶åœ¨æ•°ç»„ä¸­çš„å­˜å‚¨ä½ç½®ï¼Œå†æ ¹æ®equalsæ–¹æ³•ä»è¯¥ä½ç½®ä¸Šçš„é“¾è¡¨ä¸­å–å‡ºè¯¥Entryã€‚ ä¸HashMapä¸åŒçš„æ˜¯ï¼ŒConcurrentHashMapä½¿ç”¨å¤šä¸ªå­Hashè¡¨ï¼Œä¹Ÿå°±æ˜¯æ®µ(Segment) ConcurrentHashMapå®Œå…¨å…è®¸å¤šä¸ªè¯»æ“ä½œå¹¶å‘è¿›è¡Œï¼Œè¯»æ“ä½œå¹¶ä¸éœ€è¦åŠ é”ã€‚å¦‚æœä½¿ç”¨ä¼ ç»Ÿçš„æŠ€æœ¯ï¼Œå¦‚HashMapä¸­çš„å®ç°ï¼Œå¦‚æœå…è®¸å¯ä»¥åœ¨hashé“¾çš„ä¸­é—´æ·»åŠ æˆ–åˆ é™¤å…ƒç´ ï¼Œè¯»æ“ä½œä¸åŠ é”å°†å¾—åˆ°ä¸ä¸€è‡´çš„æ•°æ®ã€‚ ConcurrentHashMap 1.8ä¸ºä»€ä¹ˆè¦ä½¿ç”¨CAS+Synchronizedå–ä»£Segment+ReentrantLock â€‹ å¤§å®¶åº”è¯¥éƒ½çŸ¥é“ConcurrentHashMapåœ¨1.8çš„æ—¶å€™æœ‰äº†å¾ˆå¤§çš„æ”¹åŠ¨,å½“ç„¶,æˆ‘è¿™é‡Œè¦è¯´çš„æ”¹åŠ¨ä¸æ˜¯æŒ‡é“¾è¡¨é•¿åº¦å¤§äº8å°±è½¬ä¸ºçº¢é»‘æ ‘è¿™ç§å¸¸è¯†,æˆ‘è¦è¯´çš„æ˜¯ConcurrentHashMapåœ¨1.8ä¸ºä»€ä¹ˆç”¨CAS+Synchronizedå–ä»£Segment+ReentrantLockäº† â€‹ é¦–å…ˆ,æˆ‘å‡è®¾ä½ å¯¹CAS,Synchronized,ReentrantLockè¿™äº›çŸ¥è¯†å¾ˆäº†è§£,å¹¶ä¸”çŸ¥é“AQS,è‡ªæ—‹é”,åå‘é”,è½»é‡çº§é”,é‡é‡çº§é”è¿™äº›çŸ¥è¯†,ä¹ŸçŸ¥é“Synchronizedå’ŒReentrantLockåœ¨å”¤é†’è¢«æŒ‚èµ·çº¿ç¨‹ç«äº‰çš„æ—¶å€™æœ‰ä»€ä¹ˆåŒºåˆ« â€‹ é¦–å…ˆæˆ‘ä»¬è¯´ä¸‹1.8ä»¥å‰çš„ConcurrentHashMapæ˜¯æ€ä¹ˆä¿è¯çº¿ç¨‹å¹¶å‘çš„,é¦–å…ˆåœ¨åˆå§‹åŒ–ConcurrentHashMapçš„æ—¶å€™,ä¼šåˆå§‹åŒ–ä¸€ä¸ªSegmentæ•°ç»„,å®¹é‡ä¸º16,è€Œæ¯ä¸ªSegmentå‘¢,éƒ½ç»§æ‰¿äº†ReentrantLockç±»,ä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªSegmentç±»æœ¬èº«å°±æ˜¯ä¸€ä¸ªé”,ä¹‹åSegmentå†…éƒ¨åˆæœ‰ä¸€ä¸ªtableæ•°ç»„,è€Œæ¯ä¸ªtableæ•°ç»„é‡Œçš„ç´¢å¼•æ•°æ®å‘¢,åˆå¯¹åº”ç€ä¸€ä¸ªNodeé“¾è¡¨. â€‹ é‚£ä¹ˆè¿™æ ·çš„å¥½å¤„æ˜¯ä»€ä¹ˆå‘¢?æˆ‘å…ˆä»è€ç‰ˆæœ¬çš„æ·»åŠ æµç¨‹è¯´èµ·å§,ç”±äºç”µè„‘é‡Œæ²¡æœ‰JDK1.7åŠä»¥ä¸‹çš„ç‰ˆæœ¬æˆ‘æ²¡æ³•ç»™ä½ çœ‹ä»£ç ,æ‰€ä»¥ä½¿ç”¨æ–‡å­—æè¿°çš„æ–¹å¼,é¦–å…ˆ,å½“æˆ‘ä»¬ä½¿ç”¨putæ–¹æ³•çš„æ—¶å€™,æ˜¯å¯¹æˆ‘ä»¬çš„keyè¿›è¡Œhashæ‹¿åˆ°ä¸€ä¸ªæ•´å‹,ç„¶åå°†æ•´å‹å¯¹16å–æ¨¡,æ‹¿åˆ°å¯¹åº”çš„Segment,ä¹‹åè°ƒç”¨Segmentçš„putæ–¹æ³•,ç„¶åä¸Šé”,è¯·æ³¨æ„,è¿™é‡Œlock()çš„æ—¶å€™å…¶å®æ˜¯this.lock(),ä¹Ÿå°±æ˜¯è¯´,æ¯ä¸ªSegmentçš„é”æ˜¯åˆ†å¼€çš„ â€‹ å…¶ä¸­ä¸€ä¸ªä¸Šé”ä¸ä¼šå½±å“å¦ä¸€ä¸ª,æ­¤æ—¶ä¹Ÿå°±ä»£è¡¨äº†æˆ‘å¯ä»¥æœ‰åå…­ä¸ªçº¿ç¨‹è¿›æ¥,è€ŒReentrantLockä¸Šé”çš„æ—¶å€™å¦‚æœåªæœ‰ä¸€ä¸ªçº¿ç¨‹è¿›æ¥,æ˜¯ä¸ä¼šæœ‰çº¿ç¨‹æŒ‚èµ·çš„æ“ä½œçš„,ä¹Ÿå°±æ˜¯è¯´åªéœ€è¦åœ¨AQSé‡Œä½¿ç”¨CASæ”¹å˜ä¸€ä¸ªstateçš„å€¼ä¸º1,æ­¤æ—¶å°±èƒ½å¯¹ä»£ç è¿›è¡Œæ“ä½œ,è¿™æ ·ä¸€æ¥,æˆ‘ä»¬ç­‰äºå°†å¹¶å‘é‡/16äº†. å¥½,è¯´å®Œäº†è€ç‰ˆæœ¬çš„ConcurrentHashMap,æˆ‘ä»¬å†è¯´è¯´æ–°ç‰ˆæœ¬çš„,è¯·çœ‹ä¸‹é¢çš„å›¾: â€‹ è¯·æ³¨æ„Synchronizedä¸Šé”çš„å¯¹è±¡,è¯·è®°ä½,Synchronizedæ˜¯é å¯¹è±¡çš„å¯¹è±¡å¤´å’Œæ­¤å¯¹è±¡å¯¹åº”çš„monitoræ¥ä¿è¯ä¸Šé”çš„,ä¹Ÿå°±æ˜¯å¯¹è±¡å¤´é‡Œçš„é‡é‡çº§é”æ ‡å¿—æŒ‡å‘äº†monitor,è€Œmonitorå‘¢,å†…éƒ¨åˆ™ä¿å­˜äº†ä¸€ä¸ªå½“å‰çº¿ç¨‹,ä¹Ÿå°±æ˜¯æŠ¢åˆ°äº†é”çš„çº¿ç¨‹. â€‹ é‚£ä¹ˆè¿™é‡Œçš„è¿™ä¸ªfæ˜¯ä»€ä¹ˆå‘¢?å®ƒæ˜¯Nodeé“¾è¡¨é‡Œçš„æ¯ä¸€ä¸ªNode,ä¹Ÿå°±æ˜¯è¯´,Synchronizedæ˜¯å°†æ¯ä¸€ä¸ªNodeå¯¹è±¡ä½œä¸ºäº†ä¸€ä¸ªé”,è¿™æ ·åšçš„å¥½å¤„æ˜¯ä»€ä¹ˆå‘¢?å°†é”ç»†åŒ–äº†,ä¹Ÿå°±æ˜¯è¯´,é™¤éä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œä¸€ä¸ªNode,æ³¨æ„,æ˜¯ä¸€ä¸ªNodeè€Œä¸æ˜¯ä¸€ä¸ªNodeé“¾è¡¨å“¦,é‚£ä¹ˆæ‰ä¼šäº‰æŠ¢åŒä¸€æŠŠé”. â€‹ å¦‚æœä½¿ç”¨ReentrantLockå…¶å®ä¹Ÿå¯ä»¥å°†é”ç»†åŒ–æˆè¿™æ ·çš„,åªè¦è®©Nodeç±»ç»§æ‰¿ReentrantLockå°±è¡Œäº†,è¿™æ ·çš„è¯è°ƒç”¨f.lock()å°±èƒ½åšåˆ°å’ŒSynchronized(f)åŒæ ·çš„æ•ˆæœ,ä½†ä¸ºä»€ä¹ˆä¸è¿™æ ·åšå‘¢? â€‹ è¯·å¤§å®¶è¯•æƒ³ä¸€ä¸‹,é”å·²ç»è¢«ç»†åŒ–åˆ°è¿™ç§ç¨‹åº¦äº†,é‚£ä¹ˆå‡ºç°å¹¶å‘äº‰æŠ¢çš„å¯èƒ½æ€§è¿˜é«˜å—?è¿˜æœ‰å°±æ˜¯,å“ªæ€•å‡ºç°äº‰æŠ¢äº†,åªè¦çº¿ç¨‹å¯ä»¥åœ¨30åˆ°50æ¬¡è‡ªæ—‹é‡Œæ‹¿åˆ°é”,é‚£ä¹ˆSynchronizedå°±ä¸ä¼šå‡çº§ä¸ºé‡é‡çº§é”,è€Œç­‰å¾…çš„çº¿ç¨‹ä¹Ÿå°±ä¸ç”¨è¢«æŒ‚èµ·,æˆ‘ä»¬ä¹Ÿå°±å°‘äº†æŒ‚èµ·å’Œå”¤é†’è¿™ä¸ªä¸Šä¸‹æ–‡åˆ‡æ¢çš„è¿‡ç¨‹å¼€é”€. â€‹ ä½†å¦‚æœæ˜¯ReentrantLockå‘¢?å®ƒåˆ™åªæœ‰åœ¨çº¿ç¨‹æ²¡æœ‰æŠ¢åˆ°é”,ç„¶åæ–°å»ºNodeèŠ‚ç‚¹åå†å°è¯•ä¸€æ¬¡è€Œå·²,ä¸ä¼šè‡ªæ—‹,è€Œæ˜¯ç›´æ¥è¢«æŒ‚èµ·,è¿™æ ·ä¸€æ¥,æˆ‘ä»¬å°±å¾ˆå®¹æ˜“ä¼šå¤šå‡ºçº¿ç¨‹ä¸Šä¸‹æ–‡å¼€é”€çš„ä»£ä»·.å½“ç„¶,ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨tryLock(),ä½†æ˜¯è¿™æ ·åˆå‡ºç°äº†ä¸€ä¸ªé—®é¢˜,ä½ æ€ä¹ˆçŸ¥é“tryLockçš„æ—¶é—´å‘¢?åœ¨æ—¶é—´èŒƒå›´é‡Œè¿˜å¥½,å‡å¦‚è¶…è¿‡äº†å‘¢? â€‹ æ‰€ä»¥,åœ¨é”è¢«ç»†åŒ–åˆ°å¦‚æ­¤ç¨‹åº¦ä¸Š,ä½¿ç”¨Synchronizedæ˜¯æœ€å¥½çš„é€‰æ‹©äº†.è¿™é‡Œå†è¡¥å……ä¸€å¥,Synchronizedå’ŒReentrantLockä»–ä»¬çš„å¼€é”€å·®è·æ˜¯åœ¨é‡Šæ”¾é”æ—¶å”¤é†’çº¿ç¨‹çš„æ•°é‡,Synchronizedæ˜¯å”¤é†’é”æ± é‡Œæ‰€æœ‰çš„çº¿ç¨‹+åˆšå¥½æ¥è®¿é—®çš„çº¿ç¨‹,è€ŒReentrantLockåˆ™æ˜¯å½“å‰çº¿ç¨‹åè¿›æ¥çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹+åˆšå¥½æ¥è®¿é—®çš„çº¿ç¨‹. â€‹ å¦‚æœæ˜¯çº¿ç¨‹å¹¶å‘é‡ä¸å¤§çš„æƒ…å†µä¸‹,é‚£ä¹ˆSynchronizedå› ä¸ºè‡ªæ—‹é”,åå‘é”,è½»é‡çº§é”çš„åŸå› ,ä¸ç”¨å°†ç­‰å¾…çº¿ç¨‹æŒ‚èµ·,åå‘é”ç”šè‡³ä¸ç”¨è‡ªæ—‹,æ‰€ä»¥åœ¨è¿™ç§æƒ…å†µä¸‹è¦æ¯”ReentrantLocké«˜æ•ˆ 1.8å¼ƒç”¨åˆ†æ®µé”çš„åŸå› ç”±ä»¥ä¸‹å‡ ç‚¹ï¼š 1. åŠ å…¥å¤šä¸ªåˆ†æ®µé”æµªè´¹å†…å­˜ç©ºé—´ã€‚ 2. ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œ map åœ¨æ”¾å…¥æ—¶ç«äº‰åŒä¸€ä¸ªé”çš„æ¦‚ç‡éå¸¸å°ï¼Œåˆ†æ®µé”åè€Œä¼šé€ æˆæ›´æ–°ç­‰æ“ä½œçš„é•¿æ—¶é—´ç­‰å¾…ã€‚ 3. ä¸ºäº†æé«˜ GC çš„æ•ˆç‡ HashSetå®ç°åŸç†è¦ç‚¹æ¦‚æ‹¬ HashSetç”±å“ˆå¸Œè¡¨(å®é™…ä¸Šæ˜¯ä¸€ä¸ªHashMapå®ä¾‹)æ”¯æŒï¼Œä¸ä¿è¯setçš„è¿­ä»£é¡ºåºï¼Œå¹¶å…è®¸ä½¿ç”¨nullå…ƒç´ ã€‚ å¯¹äºHashSetè€Œè¨€ï¼Œå®ƒæ˜¯åŸºäºHashMapå®ç°çš„ï¼ŒHashSetåº•å±‚ä½¿ç”¨HashMapæ¥ä¿å­˜æ‰€æœ‰å…ƒç´ ï¼Œå› æ­¤HashSet çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œç›¸å…³HashSetçš„æ“ä½œï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯ç›´æ¥è°ƒç”¨åº•å±‚HashMapçš„ç›¸å…³æ–¹æ³•æ¥å®Œæˆï¼ŒAPIä¹Ÿæ˜¯å¯¹HashMapçš„è¡Œä¸ºè¿›è¡Œäº†å°è£…ï¼Œå¯å‚è€ƒHashMap LinkedHashMapå®ç°åŸç†è¦ç‚¹æ¦‚æ‹¬ LinkedHashMapç»§æ‰¿äºHashMapï¼Œåº•å±‚ä½¿ç”¨å“ˆå¸Œè¡¨å’ŒåŒå‘é“¾è¡¨æ¥ä¿å­˜æ‰€æœ‰å…ƒç´ ï¼Œå¹¶ä¸”å®ƒæ˜¯éåŒæ­¥ï¼Œå…è®¸ä½¿ç”¨nullå€¼å’Œnullé”®ã€‚ åŸºæœ¬æ“ä½œä¸çˆ¶ç±»HashMapç›¸ä¼¼ï¼Œé€šè¿‡é‡å†™HashMapç›¸å…³æ–¹æ³•ï¼Œé‡æ–°å®šä¹‰äº†æ•°ç»„ä¸­ä¿å­˜çš„å…ƒç´ Entryï¼Œæ¥å®ç°è‡ªå·±çš„é“¾æ¥åˆ—è¡¨ç‰¹æ€§ã€‚è¯¥Entryé™¤äº†ä¿å­˜å½“å‰å¯¹è±¡çš„å¼•ç”¨å¤–ï¼Œè¿˜ä¿å­˜äº†å…¶ä¸Šä¸€ä¸ªå…ƒç´ beforeå’Œä¸‹ä¸€ä¸ªå…ƒç´ afterçš„å¼•ç”¨ï¼Œä»è€Œæ„æˆäº†åŒå‘é“¾æ¥åˆ—è¡¨ã€‚ LinkedHashSetå®ç°åŸç†è¦ç‚¹æ¦‚æ‹¬ å¯¹äºLinkedHashSetè€Œè¨€ï¼Œå®ƒç»§æ‰¿ä¸HashSetã€åˆåŸºäºLinkedHashMapæ¥å®ç°çš„ã€‚LinkedHashSetåº•å±‚ä½¿ç”¨LinkedHashMapæ¥ä¿å­˜æ‰€æœ‰å…ƒç´ ï¼Œå®ƒç»§æ‰¿ä¸HashSetï¼Œå…¶æ‰€æœ‰çš„æ–¹æ³•æ“ä½œä¸Šåˆä¸HashSetç›¸åŒã€‚ javaé›†åˆéå†çš„å‡ ç§æ–¹å¼æ€»ç»“åŠæ¯”è¾ƒ é›†åˆç±»çš„é€šç”¨éå†æ–¹å¼, ç”¨è¿­ä»£å™¨è¿­ä»£: Iterator it = list.iterator(); while(it.hasNext()) { Object obj = it.next(); } Mapéå†æ–¹å¼ï¼š 1ã€é€šè¿‡è·å–æ‰€æœ‰çš„keyæŒ‰ç…§keyæ¥éå† //Set&lt;Integer&gt; set = map.keySet(); //å¾—åˆ°æ‰€æœ‰keyçš„é›†åˆ for (Integer in : map.keySet()) { String str = map.get(in);//å¾—åˆ°æ¯ä¸ªkeyå¤šå¯¹ç”¨valueçš„å€¼ } 2ã€é€šè¿‡Map.entrySetä½¿ç”¨iteratoréå†keyå’Œvalue Iterator&lt;Map.Entry&lt;Integer, String&gt;&gt; it = map.entrySet().iterator(); while (it.hasNext()) { Map.Entry&lt;Integer, String&gt; entry = it.next(); System.out.println(&quot;key= &quot; + entry.getKey() + &quot; and value= &quot; + entry.getValue()); } 3ã€é€šè¿‡Map.entrySetéå†keyå’Œvalueï¼Œæ¨èï¼Œå°¤å…¶æ˜¯å®¹é‡å¤§æ—¶ for (Map.Entry&lt;Integer, String&gt; entry : map.entrySet()) { //Map.entry&lt;Integer,String&gt; æ˜ å°„é¡¹ï¼ˆé”®-å€¼å¯¹ï¼‰ æœ‰å‡ ä¸ªæ–¹æ³•ï¼šç”¨ä¸Šé¢çš„åå­—entry //entry.getKey() ;entry.getValue(); entry.setValue(); //map.entrySet() è¿”å›æ­¤æ˜ å°„ä¸­åŒ…å«çš„æ˜ å°„å…³ç³»çš„ Setè§†å›¾ã€‚ System.out.println(&quot;key= &quot; + entry.getKey() + &quot; and value= &quot; + entry.getValue()); } 4ã€é€šè¿‡Map.values()éå†æ‰€æœ‰çš„valueï¼Œä½†ä¸èƒ½éå†key for (String v : map.values()) { System.out.println(&quot;value= &quot; + v); } Listéå†æ–¹å¼ï¼š ç¬¬ä¸€ç§ï¼š Iterator iterator = list.iterator(); while(iterator.hasNext()){ int i = (Integer) iterator.next(); System.out.println(i); } ç¬¬äºŒç§ï¼š for (Object object : list) { System.out.println(object); } ç¬¬ä¸‰ç§ï¼š for(int i = 0 ;i&lt;list.size();i++) { int j= (Integer) list.get(i); System.out.println(j); } æ¯ä¸ªéå†æ–¹æ³•çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ ä¼ ç»Ÿçš„forå¾ªç¯éå†ï¼ŒåŸºäºè®¡æ•°å™¨çš„ï¼š â€‹ éå†è€…è‡ªå·±åœ¨é›†åˆå¤–éƒ¨ç»´æŠ¤ä¸€ä¸ªè®¡æ•°å™¨ï¼Œç„¶åä¾æ¬¡è¯»å–æ¯ä¸€ä¸ªä½ç½®çš„å…ƒç´ ï¼Œå½“è¯»å–åˆ°æœ€åä¸€ä¸ªå…ƒç´ åï¼Œåœæ­¢ã€‚ä¸»è¦å°±æ˜¯éœ€è¦æŒ‰å…ƒç´ çš„ä½ç½®æ¥è¯»å–å…ƒç´ ã€‚ è¿­ä»£å™¨éå†ï¼ŒIteratorï¼š â€‹ æ¯ä¸€ä¸ªå…·ä½“å®ç°çš„æ•°æ®é›†åˆï¼Œä¸€èˆ¬éƒ½éœ€è¦æä¾›ç›¸åº”çš„Iteratorã€‚ç›¸æ¯”äºä¼ ç»Ÿforå¾ªç¯ï¼ŒIteratorå–ç¼”äº†æ˜¾å¼çš„éå†è®¡æ•°å™¨ã€‚æ‰€ä»¥åŸºäºé¡ºåºå­˜å‚¨é›†åˆçš„Iteratorå¯ä»¥ç›´æ¥æŒ‰ä½ç½®è®¿é—®æ•°æ®ã€‚è€ŒåŸºäºé“¾å¼å­˜å‚¨é›†åˆçš„Iteratorï¼Œæ­£å¸¸çš„å®ç°ï¼Œéƒ½æ˜¯éœ€è¦ä¿å­˜å½“å‰éå†çš„ä½ç½®ã€‚ç„¶åæ ¹æ®å½“å‰ä½ç½®æ¥å‘å‰æˆ–è€…å‘åç§»åŠ¨æŒ‡é’ˆã€‚ foreachå¾ªç¯éå†ï¼š â€‹ æ ¹æ®åç¼–è¯‘çš„å­—èŠ‚ç å¯ä»¥å‘ç°ï¼Œforeachå†…éƒ¨ä¹Ÿæ˜¯é‡‡ç”¨äº†Iteratorçš„æ–¹å¼å®ç°ï¼Œåªä¸è¿‡Javaç¼–è¯‘å™¨å¸®æˆ‘ä»¬ç”Ÿæˆäº†è¿™äº›ä»£ç ã€‚ å„éå†æ–¹å¼å¯¹äºä¸åŒçš„å­˜å‚¨æ–¹å¼ï¼Œæ€§èƒ½å¦‚ä½•ï¼Ÿ 1ã€ä¼ ç»Ÿçš„forå¾ªç¯éå†ï¼ŒåŸºäºè®¡æ•°å™¨çš„ï¼š â€‹ å› ä¸ºæ˜¯åŸºäºå…ƒç´ çš„ä½ç½®ï¼ŒæŒ‰ä½ç½®è¯»å–ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå¯¹äºé¡ºåºå­˜å‚¨ï¼Œå› ä¸ºè¯»å–ç‰¹å®šä½ç½®å…ƒç´ çš„å¹³å‡æ—¶é—´å¤æ‚åº¦æ˜¯O(1)ï¼Œæ‰€ä»¥éå†æ•´ä¸ªé›†åˆçš„å¹³å‡æ—¶é—´å¤æ‚åº¦ä¸ºO(n)ã€‚è€Œå¯¹äºé“¾å¼å­˜å‚¨ï¼Œå› ä¸ºè¯»å–ç‰¹å®šä½ç½®å…ƒç´ çš„å¹³å‡æ—¶é—´å¤æ‚åº¦æ˜¯O(n)ï¼Œæ‰€ä»¥éå†æ•´ä¸ªé›†åˆçš„å¹³å‡æ—¶é—´å¤æ‚åº¦ä¸ºO(n2)ï¼ˆnçš„å¹³æ–¹ï¼‰ã€‚ ArrayListæŒ‰ä½ç½®è¯»å–çš„ä»£ç ï¼šç›´æ¥æŒ‰å…ƒç´ ä½ç½®è¯»å–ã€‚ transient Object[] elementData; public E get(int index) { rangeCheck(index); return elementData(index); } E elementData(int index) { return (E) elementData[index]; } LinkedListæŒ‰ä½ç½®è¯»å–çš„ä»£ç ï¼šæ¯æ¬¡éƒ½éœ€è¦ä»ç¬¬0ä¸ªå…ƒç´ å¼€å§‹å‘åè¯»å–ã€‚å…¶å®å®ƒå†…éƒ¨ä¹Ÿåšäº†å°å°çš„ä¼˜åŒ–ã€‚ transient int size = 0; transient Node&lt;E&gt; first; transient Node&lt;E&gt; last; public E get(int index) { checkElementIndex(index); return node(index).item; } Node&lt;E&gt; node(int index) { if (index &lt; (size &gt;&gt; 1)) { //æŸ¥è¯¢ä½ç½®åœ¨é“¾è¡¨å‰åŠéƒ¨åˆ†ï¼Œä»é“¾è¡¨å¤´å¼€å§‹æŸ¥æ‰¾ Node&lt;E&gt; x = first; for (int i = 0; i &lt; index; i++) x = x.next; return x; } else { //æŸ¥è¯¢ä½ç½®åœ¨é“¾è¡¨ååŠéƒ¨åˆ†ï¼Œä»é“¾è¡¨å°¾å¼€å§‹æŸ¥æ‰¾ Node&lt;E&gt; x = last; for (int i = size - 1; i &gt; index; i--) x = x.prev; return x; } } 2ã€è¿­ä»£å™¨éå†ï¼ŒIteratorï¼š â€‹ é‚£ä¹ˆå¯¹äºRandomAccessç±»å‹çš„é›†åˆæ¥è¯´ï¼Œæ²¡æœ‰å¤ªå¤šæ„ä¹‰ï¼Œåè€Œå› ä¸ºä¸€äº›é¢å¤–çš„æ“ä½œï¼Œè¿˜ä¼šå¢åŠ é¢å¤–çš„è¿è¡Œæ—¶é—´ã€‚ä½†æ˜¯å¯¹äºSequential Accessçš„é›†åˆæ¥è¯´ï¼Œå°±æœ‰å¾ˆé‡å¤§çš„æ„ä¹‰äº†ï¼Œå› ä¸ºIteratorå†…éƒ¨ç»´æŠ¤äº†å½“å‰éå†çš„ä½ç½®ï¼Œæ‰€ä»¥æ¯æ¬¡éå†ï¼Œè¯»å–ä¸‹ä¸€ä¸ªä½ç½®å¹¶ä¸éœ€è¦ä»é›†åˆçš„ç¬¬ä¸€ä¸ªå…ƒç´ å¼€å§‹æŸ¥æ‰¾ï¼Œåªè¦æŠŠæŒ‡é’ˆå‘åç§»ä¸€ä½å°±è¡Œäº†ï¼Œè¿™æ ·ä¸€æ¥ï¼Œéå†æ•´ä¸ªé›†åˆçš„æ—¶é—´å¤æ‚åº¦å°±é™ä½ä¸ºO(n)ï¼› ï¼ˆè¿™é‡Œåªç”¨LinkedListåšä¾‹å­ï¼‰LinkedListçš„è¿­ä»£å™¨ï¼Œå†…éƒ¨å®ç°ï¼Œå°±æ˜¯ç»´æŠ¤å½“å‰éå†çš„ä½ç½®ï¼Œç„¶åæ“ä½œæŒ‡é’ˆç§»åŠ¨å°±å¯ä»¥äº†ï¼š public E next() { checkForComodification(); if (!hasNext()) throw new NoSuchElementException(); lastReturned = next; next = next.next; nextIndex++; return lastReturned.item; } public E previous() { checkForComodification(); if (!hasPrevious()) throw new NoSuchElementException(); lastReturned = next = (next == null) ? last : next.prev; nextIndex--; return lastReturned.item; } 3ã€foreachå¾ªç¯éå†ï¼š â€‹ åˆ†æJavaå­—èŠ‚ç å¯çŸ¥ï¼Œforeachå†…éƒ¨å®ç°åŸç†ï¼Œä¹Ÿæ˜¯é€šè¿‡Iteratorå®ç°çš„ï¼Œåªä¸è¿‡è¿™ä¸ªIteratoræ˜¯Javaç¼–è¯‘å™¨å¸®æˆ‘ä»¬ç”Ÿæˆçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦å†æ‰‹åŠ¨å»ç¼–å†™ã€‚ä½†æ˜¯å› ä¸ºæ¯æ¬¡éƒ½è¦åšç±»å‹è½¬æ¢æ£€æŸ¥ï¼Œæ‰€ä»¥èŠ±è´¹çš„æ—¶é—´æ¯”Iteratorç•¥é•¿ã€‚æ—¶é—´å¤æ‚åº¦å’ŒIteratorä¸€æ ·ã€‚ Iteratorå’Œforeachå­—èŠ‚ç å¦‚ä¸‹ï¼š //ä½¿ç”¨Iteratorçš„å­—èŠ‚ç ï¼š Code: 0: new #16 // class java/util/ArrayList 3: dup 4: invokespecial #18 // Method java/util/ArrayList.&quot;&lt;init&gt;&quot;:()V 7: astore_1 8: aload_1 9: invokeinterface #19, 1 // InterfaceMethod java/util/List.iterator:()Ljava/util/Iterator; 14: astore_2 15: goto 25 18: aload_2 19: invokeinterface #25, 1 // InterfaceMethod java/util/Iterator.next:()Ljava/lang/Object; 24: pop 25: aload_2 26: invokeinterface #31, 1 // InterfaceMethod java/util/Iterator.hasNext:()Z 31: ifne 18 34: return //ä½¿ç”¨foreachçš„å­—èŠ‚ç ï¼š Code: 0: new #16 // class java/util/ArrayList 3: dup 4: invokespecial #18 // Method java/util/ArrayList.&quot;&lt;init&gt;&quot;:()V 7: astore_1 8: aload_1 9: invokeinterface #19, 1 // InterfaceMethod java/util/List.iterator:()Ljava/util/Iterator; 14: astore_3 15: goto 28 18: aload_3 19: invokeinterface #25, 1 // InterfaceMethod java/util/Iterator.next:()Ljava/lang/Object; 24: checkcast #31 // class loop/Model 27: astore_2 28: aload_3 29: invokeinterface #33, 1 // InterfaceMethod java/util/Iterator.hasNext:()Z 34: ifne 18 37: return å„éå†æ–¹å¼çš„é€‚ç”¨äºä»€ä¹ˆåœºåˆï¼Ÿ ä¼ ç»Ÿçš„forå¾ªç¯éå†ï¼ŒåŸºäºè®¡æ•°å™¨çš„ï¼š â€‹ é¡ºåºå­˜å‚¨ï¼šè¯»å–æ€§èƒ½æ¯”è¾ƒé«˜ã€‚é€‚ç”¨äºéå†é¡ºåºå­˜å‚¨é›†åˆã€‚ â€‹ é“¾å¼å­˜å‚¨ï¼šæ—¶é—´å¤æ‚åº¦å¤ªå¤§ï¼Œä¸é€‚ç”¨äºéå†é“¾å¼å­˜å‚¨çš„é›†åˆã€‚ è¿­ä»£å™¨éå†ï¼ŒIteratorï¼š â€‹ é¡ºåºå­˜å‚¨ï¼šå¦‚æœä¸æ˜¯å¤ªåœ¨æ„æ—¶é—´ï¼Œæ¨èé€‰æ‹©æ­¤æ–¹å¼ï¼Œæ¯•ç«Ÿä»£ç æ›´åŠ ç®€æ´ï¼Œä¹Ÿé˜²æ­¢äº†Off-By-Oneçš„é—®é¢˜ã€‚ â€‹ é“¾å¼å­˜å‚¨ï¼šæ„ä¹‰å°±é‡å¤§äº†ï¼Œå¹³å‡æ—¶é—´å¤æ‚åº¦é™ä¸ºO(n)ï¼Œè¿˜æ˜¯æŒºè¯±äººçš„ï¼Œæ‰€ä»¥æ¨èæ­¤ç§éå†æ–¹å¼ã€‚ foreachå¾ªç¯éå†ï¼š â€‹ foreachåªæ˜¯è®©ä»£ç æ›´åŠ ç®€æ´äº†ï¼Œä½†æ˜¯ä»–æœ‰ä¸€äº›ç¼ºç‚¹ï¼Œå°±æ˜¯éå†è¿‡ç¨‹ä¸­ä¸èƒ½æ“ä½œæ•°æ®é›†åˆï¼ˆåˆ é™¤ç­‰ï¼‰ï¼Œæ‰€ä»¥æœ‰äº›åœºåˆä¸ä½¿ç”¨ã€‚è€Œä¸”å®ƒæœ¬èº«å°±æ˜¯åŸºäºIteratorå®ç°çš„ï¼Œä½†æ˜¯ç”±äºç±»å‹è½¬æ¢çš„é—®é¢˜ï¼Œæ‰€ä»¥ä¼šæ¯”ç›´æ¥ä½¿ç”¨Iteratoræ…¢ä¸€ç‚¹ï¼Œä½†æ˜¯è¿˜å¥½ï¼Œæ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ä¸€æ ·çš„ã€‚æ‰€ä»¥æ€ä¹ˆé€‰æ‹©ï¼Œå‚è€ƒä¸Šé¢ä¸¤ç§æ–¹å¼ï¼Œåšä¸€ä¸ªæŠ˜ä¸­çš„é€‰æ‹©ã€‚ RandomAccessæ¥å£æ ‡è®° Javaæ•°æ®é›†åˆæ¡†æ¶ä¸­ï¼Œæä¾›äº†ä¸€ä¸ªRandomAccessæ¥å£ï¼Œè¯¥æ¥å£æ²¡æœ‰æ–¹æ³•ï¼Œåªæ˜¯ä¸€ä¸ªæ ‡è®°ã€‚é€šå¸¸è¢«Listæ¥å£çš„å®ç°ä½¿ç”¨ï¼Œç”¨æ¥æ ‡è®°è¯¥Listçš„å®ç°æ˜¯å¦æ”¯æŒRandom Accessã€‚ ä¸€ä¸ªæ•°æ®é›†åˆå®ç°äº†è¯¥æ¥å£ï¼Œå°±æ„å‘³ç€å®ƒæ”¯æŒRandom Accessï¼ŒæŒ‰ä½ç½®è¯»å–å…ƒç´ çš„å¹³å‡æ—¶é—´å¤æ‚åº¦ä¸ºO(1)ã€‚æ¯”å¦‚ArrayListã€‚ è€Œæ²¡æœ‰å®ç°è¯¥æ¥å£çš„ï¼Œå°±è¡¨ç¤ºä¸æ”¯æŒRandom Accessã€‚æ¯”å¦‚LinkedListã€‚ æ‰€ä»¥çœ‹æ¥JDKå¼€å‘è€…ä¹Ÿæ˜¯æ³¨æ„åˆ°è¿™ä¸ªé—®é¢˜çš„ï¼Œé‚£ä¹ˆæ¨èçš„åšæ³•å°±æ˜¯ï¼Œå¦‚æœæƒ³è¦éå†ä¸€ä¸ªListï¼Œé‚£ä¹ˆå…ˆåˆ¤æ–­æ˜¯å¦æ”¯æŒRandom Accessï¼Œä¹Ÿå°±æ˜¯ list instanceof RandomAccessã€‚ æ¯”å¦‚ï¼š if (list instanceof RandomAccess) { //ä½¿ç”¨ä¼ ç»Ÿçš„forå¾ªç¯éå†ã€‚ } else { //ä½¿ç”¨Iteratoræˆ–è€…foreachã€‚ } Arrayã€Listã€Setäº’è½¬ Arrayã€Listäº’è½¬ Array è½¬List String[] s = new String[]{&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;,&quot;E&quot;}; List&lt;String&gt; list = Arrays.asList(s); # æ³¨æ„è¿™é‡Œlisté‡Œé¢çš„å…ƒç´ ç›´æ¥æ˜¯sé‡Œé¢çš„å…ƒç´ ( list backed by the specified array)ï¼Œæ¢å¥è¯å°±æ˜¯è¯´ï¼šå¯¹sçš„ä¿®æ”¹ï¼Œç›´æ¥å½±å“listã€‚ s[0] =&quot;AA&quot;; System.out.println(&quot;list: &quot; + list); # è¾“å‡ºç»“æœ list: [AA, B, C, D, E] Listè½¬Array String[] dest = list.toArray(new String[0]);//new String[0]æ˜¯æŒ‡å®šè¿”å›æ•°ç»„çš„ç±»å‹ System.out.println(&quot;dest: &quot; + Arrays.toString(dest)); # è¾“å‡ºç»“æœ dest: [AA, B, C, D, E] # æ³¨æ„è¿™é‡Œçš„desté‡Œé¢çš„å…ƒç´ ä¸æ˜¯listé‡Œé¢çš„å…ƒç´ ï¼Œæ¢å¥è¯å°±æ˜¯è¯´ï¼šå¯¹listä¸­å…³äºå…ƒç´ çš„ä¿®æ”¹ï¼Œä¸ä¼šå½±å“destã€‚ list.set(0, &quot;Z&quot;); System.out.println(&quot;modified list: &quot; + list); System.out.println(&quot;dest: &quot; + Arrays.toString(dest)); # è¾“å‡ºç»“æœ modified list: [Z, B, C, D, E] dest: [AA, B, C, D, E] # å¯ä»¥çœ‹åˆ°listè™½ç„¶è¢«ä¿®æ”¹äº†ï¼Œä½†æ˜¯destæ•°ç»„æ²¡æœ‰æ²¡ä¿®æ”¹ã€‚ Listã€Setäº’è½¬ å› ä¸ºListå’ŒSetéƒ½å®ç°äº†Collectionæ¥å£ï¼Œä¸”addAll(Collection&lt;? extends E&gt; c);æ–¹æ³•ï¼Œå› æ­¤å¯ä»¥é‡‡ç”¨addAll()æ–¹æ³•å°†Listå’ŒSetäº’ç›¸è½¬æ¢ï¼›å¦å¤–ï¼ŒListå’ŒSetä¹Ÿæä¾›äº†Collection&lt;? extends E&gt; cä½œä¸ºå‚æ•°çš„æ„é€ å‡½æ•°ï¼Œå› æ­¤é€šå¸¸é‡‡ç”¨æ„é€ å‡½æ•°çš„å½¢å¼å®Œæˆäº’ç›¸è½¬åŒ–ã€‚ //Listè½¬Set Set&lt;String&gt; set = new HashSet&lt;&gt;(list); System.out.println(&quot;set: &quot; + set); //Setè½¬List List&lt;String&gt; list_1 = new ArrayList&lt;&gt;(set); System.out.println(&quot;list_1: &quot; + list_1); # å’ŒtoArray()ä¸€æ ·ï¼Œè¢«è½¬æ¢çš„List(Set)çš„ä¿®æ”¹ä¸ä¼šå¯¹è¢«è½¬åŒ–åçš„Setï¼ˆListï¼‰é€ æˆå½±å“ã€‚ Arrayã€Setäº’è½¬ //arrayè½¬set s = new String[]{&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;,&quot;E&quot;}; set = new HashSet&lt;&gt;(Arrays.asList(s)); System.out.println(&quot;set: &quot; + set); //setè½¬array dest = set.toArray(new String[0]); System.out.println(&quot;dest: &quot; + Arrays.toString(dest)); Java ä¸­åˆå§‹åŒ– List é›†åˆçš„ 6 ç§æ–¹å¼! å¸¸è§„æ–¹å¼ # åé¢ç¼ºå¤±çš„æ³›å‹ç±»å‹åœ¨ JDK 7 ä¹‹åå°±å¯ä»¥ä¸ç”¨å†™å…·ä½“çš„ç±»å‹äº†ï¼Œæ”¹è¿›åä¼šè‡ªåŠ¨æ¨æ–­ç±»å‹ List&lt;String&gt; list = new ArrayList&lt;&gt;(); list.add(&quot;1&quot;); list.add(&quot;2&quot;); list.add(&quot;3&quot;); Arrays å·¥å…·ç±» import static java.util.Arrays.asList; List&lt;String&gt; list = asList(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;); # æ³¨æ„ï¼Œä¸Šé¢çš„ asList æ˜¯ Arrays çš„é™æ€æ–¹æ³•ï¼Œè¿™é‡Œä½¿ç”¨äº†é™æ€å¯¼å…¥ã€‚è¿™ç§æ–¹å¼æ·»åŠ çš„æ˜¯ä¸å¯å˜çš„ List, å³ä¸èƒ½æ·»åŠ ã€åˆ é™¤ç­‰æ“ä½œï¼Œéœ€è¦è­¦æƒ•ã€‚ã€‚ # å¦‚æœè¦å¯å˜ï¼Œé‚£å°±ä½¿ç”¨ ArrayList å†åŒ…è£…ä¸€ä¸‹ï¼Œå¦‚ä¸‹é¢æ‰€ç¤ºã€‚ List&lt;String&gt; numbers = new ArrayList&lt;&gt;(Arrays.asList(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;)); numbers.add(&quot;4&quot;); Collections å·¥å…·ç±» List&lt;String&gt; list = Collections.nCopies(3, &quot;list&quot;); # è¿™ç§æ–¹å¼æ·»åŠ çš„æ˜¯ä¸å¯å˜çš„ã€å¤åˆ¶æŸä¸ªå…ƒç´ Néçš„å·¥å…·ç±»ï¼Œä»¥ä¸Šç¨‹åºè¾“å‡ºï¼š # [list, list, list] # è€è§„åˆ™ï¼Œå¦‚æœè¦å¯å˜ï¼Œä½¿ç”¨ ArrayList åŒ…è£…ä¸€éã€‚ List&lt;String&gt; list = new ArrayList&lt;&gt;(Collections.nCopies(3, &quot;list&quot;)); list.add(&quot;list&quot;); # è¿˜æœ‰åˆå§‹åŒ–å•ä¸ªå¯¹è±¡çš„ List å·¥å…·ç±»ï¼Œè¿™ç§æ–¹å¼ä¹Ÿæ˜¯ä¸å¯å˜çš„ï¼Œé›†åˆå†…åªèƒ½æœ‰ä¸€ä¸ªå…ƒç´ ï¼Œè¿™ç§ä¹Ÿç”¨å¾—å¾ˆå°‘å•Šã€‚ List&lt;String&gt; list = Collections.singletonList(&quot;list&quot;); # è¿˜æœ‰ä¸€ä¸ªåˆ›å»ºç©º List çš„å·¥å…·ç±»ï¼Œæ²¡æœ‰é»˜è®¤å®¹é‡ï¼ŒèŠ‚çœç©ºé—´ï¼Œä½†ä¸çŸ¥é“å®é™…å·¥ä½œä¸­æ²¡æœ‰ç”¨ã€‚ List&lt;String&gt; list = Collections.emptyList(&quot;list&quot;); åŒ¿åå†…éƒ¨ç±» List&lt;String&gt; list = new ArrayList&lt;&gt;() {{ add(&quot;1&quot;); add(&quot;2&quot;); add(&quot;3&quot;); }}; è¿™ç§å…¶å®æœ‰æ•ˆç‡å’Œå†…å­˜æ³„æ¼çš„é—®é¢˜ï¼Œå‚è€ƒï¼š https://blog.csdn.net/xukun5137/article/details/78275201 https://www.cnblogs.com/wenbronk/p/7000643.html JDK8 Stream import static java.util.stream.Collectors.toList; List&lt;String&gt; list = Stream.of(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;).collect(toList()); JDK 9 List.of List&lt;String&gt; list = List.of(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;); è¿™æ˜¯ JDK 9 é‡Œé¢æ–°å¢çš„ List æ¥å£é‡Œé¢çš„é™æ€æ–¹æ³•ï¼ŒåŒæ ·ä¹Ÿæ˜¯ä¸å¯å˜çš„ã€‚ ","link":"https://tianxiawuhao.github.io/FRRzAbqMV/"},{"title":"Javaçº¿ç¨‹åŒæ­¥äº”ç§æ–¹æ³•","content":"çº¿ç¨‹åŒæ­¥ å³å½“æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å¯¹å†…å­˜è¿›è¡Œæ“ä½œæ—¶ï¼Œå…¶ä»–çº¿ç¨‹éƒ½ä¸å¯ä»¥å¯¹è¿™ä¸ªå†…å­˜åœ°å€è¿›è¡Œæ“ä½œï¼Œç›´åˆ°è¯¥çº¿ç¨‹å®Œæˆæ“ä½œï¼Œ å…¶ä»–çº¿ç¨‹æ‰èƒ½å¯¹è¯¥å†…å­˜åœ°å€è¿›è¡Œæ“ä½œï¼Œè€Œå…¶ä»–çº¿ç¨‹åˆå¤„äºç­‰å¾…çŠ¶æ€ï¼Œå®ç°çº¿ç¨‹åŒæ­¥çš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œä¸‹é¢ä»‹ç»javaçº¿ç¨‹åŒæ­¥çš„äº”ç§æ–¹æ³•ã€‚ åŒæ­¥æ–¹æ³• ä½¿ç”¨synchronizedå…³é”®å­—ä¿®é¥°çš„æ–¹æ³•ã€‚ç”±äºjavaçš„æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå†…ç½®é”ï¼Œå½“ç”¨å…³é”®å­—ä¿®é¥°æ­¤æ–¹æ³•æ—¶ï¼Œå†…ç½®é”ä¼šä¿æŠ¤æ•´ä¸ªæ–¹æ³•ã€‚åœ¨è°ƒç”¨è¯¥æ–¹æ³•å‰ï¼Œéœ€è¦è·å¾—å†…ç½®é”ï¼Œå¦åˆ™è¯¥çº¿ç¨‹å°±å¤„äºé˜»å¡çŠ¶æ€ã€‚ public synchronized void method(){} # synchronizedå…³é”®å­—ä¹Ÿå¯ä»¥ä¿®é¥°é™æ€æ–¹æ³•ï¼Œæ­¤æ—¶å¦‚æœè°ƒç”¨è¯¥é™æ€æ–¹æ³•ï¼Œå°†ä¼šé”ä½æ•´ä¸ªç±»ã€‚ public static synchronized void method(){} åŒæ­¥ä»£ç å— å³æœ‰synchronizedå…³é”®å­—ä¿®é¥°çš„è¯­å¥å—ã€‚è¢«å…³é”®å­—ä¿®é¥°çš„çš„è¯­å¥å—ä¼šè‡ªåŠ¨åŠ ä¸Šå†…ç½®é”ï¼Œä»è€Œå®ç°åŒæ­¥ã€‚ synchronized(object){ # ä»£ç  } æ³¨ï¼šåŒæ­¥æ˜¯ä¸€ç§é«˜å¼€é”€çš„æ“ä½œï¼Œå› æ­¤åº”è¯¥å°½é‡å‡å°‘åŒæ­¥çš„å†…å®¹ã€‚é€šå¸¸æ²¡æœ‰å¿…è¦å»åŒæ­¥æ•´ä¸ªæ–¹æ³•ï¼Œä½¿ç”¨å…³é”®å­—synchronizedä¿®é¥°å…³é”®ä»£ç å³å¯ã€‚ ä½¿ç”¨ç‰¹æ®ŠåŸŸå˜é‡ä¿®é¥°ç¬¦volatileå®ç°çº¿ç¨‹åŒæ­¥ ï¼ˆ1ï¼‰volatileå…³é”®å­—æ˜¯éé”ï¼Œæ¯”synchronizedç¨å¼±çš„åŒæ­¥æœºåˆ¶ ï¼ˆ2ï¼‰ä¿è¯æ­¤å˜é‡å¯¹æ‰€æœ‰çš„çº¿ç¨‹çš„å¯è§æ€§ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å€¼ï¼Œvolatile ä¿è¯äº†æ–°å€¼èƒ½ç«‹å³åŒæ­¥åˆ°ä¸»å†…å­˜ï¼Œä»¥åŠæ¯æ¬¡ä½¿ç”¨å‰ç«‹å³ä»ä¸»å†…å­˜åˆ·æ–°ã€‚ ï¼ˆ3ï¼‰volatileä¸ä¼šæä¾›åŸå­æ“ä½œï¼Œå¹¶ä¸èƒ½ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä¹Ÿä¸èƒ½ç”¨æ¥ä¿®é¥°finalç±»å‹çš„å˜é‡ã€‚ ï¼ˆ4ï¼‰ç¦æ­¢æŒ‡ä»¤é‡æ’åºä¼˜åŒ–ã€‚æœ‰volatileä¿®é¥°çš„å˜é‡ï¼Œèµ‹å€¼åå¤šæ‰§è¡Œäº†ä¸€ä¸ªæ·»åŠ å†…å­˜å±éšœæ“ä½œï¼ˆæŒ‡ä»¤é‡æ’åºæ—¶ä¸èƒ½æŠŠåé¢çš„æŒ‡ä»¤é‡æ’åºåˆ°å†…å­˜å±éšœä¹‹å‰çš„ä½ç½®ï¼‰ public class Test extends Thread { volatile int x = 0; //æ­¤å¤„å¯ä»¥å°†volatileå»é™¤ æˆ–è€… æ›¿æ¢ä¸º staticï¼Œç»è¿‡å¯¹æ¯”å¯çœ‹å‡ºvolatileçš„ä½œç”¨ private void write() { x = 5; } private void read() { while (x != 5) {} if(x == 5){ System.out.println(&quot;------stoped&quot;); } } public static void main(String[] args) throws Exception { Test example = new Test(); Thread writeThread = new Thread(new Runnable() { public void run() { example.write(); } }); Thread readThread = new Thread(new Runnable() { public void run() { example.read(); } }); readThread.start(); TimeUnit.SECONDS.sleep(5); //è®°ä½æ­¤å¤„ä¸€å®šè¦æš‚åœ5ç§’ï¼Œä»¥ä¿è¯writeThreadä¸€å®šä¼šåœ¨readThreadä¸­æ‰§è¡Œ System.out.println(&quot;------&quot;); writeThread.start(); } } æ³¨ï¼šå¤šçº¿ç¨‹ä¸­çš„éåŒæ­¥é—®é¢˜ä¸»è¦å‡ºç°åœ¨å¯¹åŸŸçš„è¯»å†™ä¸Šï¼Œå¦‚æœåŸŸè‡ªèº«é¿å…è¿™ä¸ªé—®é¢˜ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦ä¿®æ”¹æ“ä½œè¯¥åŸŸçš„æ–¹æ³•ã€‚ç”¨finalåŸŸï¼Œæœ‰é”ä¿æŠ¤çš„åŸŸå¯ä»¥é¿å…éåŒæ­¥çš„é—®é¢˜ã€‚ ä½¿ç”¨é‡å…¥é”ReentrantLockå®ç°çº¿ç¨‹åŒæ­¥ jdk1.5ä¸­java.util.concurrentåŒ…ä¸‹ReentrantLockç±»æ˜¯å¯é‡å…¥ã€äº’æ–¥ã€å®ç°äº†Lockæ¥å£çš„é”ã€‚å®ƒä¸synchronizedä¿®é¥°çš„æ–¹æ³•å…·æœ‰ç›¸åŒçš„åŸºæœ¬è¡Œä¸ºä¸è¯­ä¹‰ï¼Œå¹¶ä¸”æ‰©å±•äº†å…¶èƒ½åŠ›ã€‚ ReentrantLockç±»çš„å¸¸ç”¨æ–¹æ³•æœ‰ï¼š ï¼ˆ1ï¼‰ReentrantLock()ï¼šåˆ›å»ºä¸€ä¸ªReentrantLockå®ä¾‹ã€‚ ï¼ˆ2ï¼‰lock():è·å¾—é” ï¼ˆ3ï¼‰unlock()ï¼šé‡Šæ”¾é” ä¸Šè¿°ä»£ç å¯ä»¥ä¿®æ”¹ä¸ºï¼š public class Test extends Thread { private int x = 0; /** * ä½¿ç”¨å¯é‡å…¥é” */ private Lock lock=new ReentrantLock(); private void write() { lock.lock(); try { x = 5; } catch (Exception e) { // TODO Auto-generated catch block e.printStackTrace(); }finally { lock.unlock();//é‡Šæ”¾é” } } private void read() { lock.lock(); try { while (x != 5) {} if(x == 5){ System.out.println(&quot;------stoped&quot;); } } catch (Exception e) { // TODO Auto-generated catch block e.printStackTrace(); }finally { lock.unlock();//é‡Šæ”¾é” } } public static void main(String[] args) throws Exception { Test example = new Test(); Thread writeThread = new Thread(new Runnable() { public void run() { example.write(); } }); Thread readThread = new Thread(new Runnable() { public void run() { example.read(); } }); readThread.start(); TimeUnit.SECONDS.sleep(5); //è®°ä½æ­¤å¤„ä¸€å®šè¦æš‚åœ5ç§’ï¼Œä»¥ä¿è¯writeThreadä¸€å®šä¼šåœ¨readThreadä¸­æ‰§è¡Œ System.out.println(&quot;------&quot;); writeThread.start(); } } æ³¨ï¼š ReentrantLock()è¿˜å¯ä»¥é€šè¿‡public ReentrantLock(boolean fair)æ„é€ æ–¹æ³•åˆ›å»ºå…¬å¹³é”ï¼Œå³ï¼Œä¼˜å…ˆè¿è¡Œç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹ï¼Œè¿™æ ·å¤§å¹…åº¦é™ä½ç¨‹åºè¿è¡Œæ•ˆç‡ã€‚ å…³äºLockå¯¹è±¡å’Œsynchronizedå…³é”®å­—çš„é€‰æ‹©ï¼š ï¼ˆ1ï¼‰æœ€å¥½ä¸¤ä¸ªéƒ½ä¸ç”¨ï¼Œä½¿ç”¨ä¸€ç§java.util.concurrentåŒ…æä¾›çš„æœºåˆ¶ï¼Œèƒ½å¤Ÿå¸®åŠ©ç”¨æˆ·å¤„ç†æ‰€æœ‰ä¸é”ç›¸å…³çš„ä»£ç ã€‚ ï¼ˆ2ï¼‰å¦‚æœsynchronizedå…³é”®å­—èƒ½å¤Ÿæ»¡è¶³ç”¨æˆ·çš„éœ€æ±‚ï¼Œå°±ç”¨synchronizedï¼Œä»–èƒ½ç®€åŒ–ä»£ç ã€‚ ï¼ˆ3ï¼‰å¦‚æœéœ€è¦ä½¿ç”¨æ›´é«˜çº§çš„åŠŸèƒ½ï¼Œå°±ç”¨ReentrantLockç±»ï¼Œæ­¤æ—¶è¦æ³¨æ„åŠæ—¶é‡Šæ”¾é”ï¼Œå¦åˆ™ä¼šå‡ºç°æ­»é”ï¼Œé€šå¸¸åœ¨finallyä¸­é‡Šæ”¾é”ã€‚ ä½¿ç”¨ThreadLocalç®¡ç†å±€éƒ¨å˜é‡å®ç°çº¿ç¨‹åŒæ­¥ ThreadLocalç®¡ç†å˜é‡ï¼Œåˆ™æ¯ä¸€ä¸ªä½¿ç”¨è¯¥å˜é‡çš„çº¿ç¨‹éƒ½è·å¾—ä¸€ä¸ªè¯¥å˜é‡çš„å‰¯æœ¬ï¼Œå‰¯æœ¬ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œè¿™æ ·æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½å¯ä»¥éšæ„ä¿®æ”¹è‡ªå·±çš„å‰¯æœ¬ï¼Œè€Œä¸ä¼šå¯¹å…¶ä»–çº¿ç¨‹äº§ç”Ÿå½±å“ã€‚ ThreadLocalç±»å¸¸ç”¨çš„æ–¹æ³•ï¼š get()ï¼šè¿”å›è¯¥çº¿ç¨‹å±€éƒ¨å˜é‡çš„å½“å‰çº¿ç¨‹å‰¯æœ¬ä¸­çš„å€¼ã€‚ initialValue()ï¼šè¿”å›æ­¤çº¿ç¨‹å±€éƒ¨å˜é‡çš„å½“å‰çº¿ç¨‹çš„â€åˆå§‹å€¼â€œã€‚ remove()ï¼šç§»é™¤æ­¤çº¿ç¨‹å±€éƒ¨å˜é‡å½“å‰çº¿ç¨‹çš„å€¼ã€‚ set(T value)ï¼šå°†æ­¤çº¿ç¨‹å±€éƒ¨å˜é‡çš„å½“å‰çº¿ç¨‹å‰¯æœ¬ä¸­çš„å€¼è®¾ç½®ä¸ºæŒ‡å®šå€¼valueã€‚ ä¸Šè¿°ä»£ç ä¿®æ”¹ä¸ºï¼š public class Test extends Thread { private static ThreadLocal&lt;Integer&gt; count=new ThreadLocal&lt;Integer&gt;(){ @Override protected Integer initialValue() { // TODO Auto-generated method stub return 0; } }; private void write() { count.set(count.get()+5); } private void read() { while (count.get() != 5) {} if(count.get() == 5){ System.out.println(&quot;------stoped&quot;); } } public static void main(String[] args) throws Exception { Test example = new Test(); Thread writeThread = new Thread(new Runnable() { public void run() { example.write(); } }); Thread readThread = new Thread(new Runnable() { public void run() { example.read(); } }); readThread.start(); TimeUnit.SECONDS.sleep(5); //è®°ä½æ­¤å¤„ä¸€å®šè¦æš‚åœ5ç§’ï¼Œä»¥ä¿è¯writeThreadä¸€å®šä¼šåœ¨readThreadä¸­æ‰§è¡Œ System.out.println(&quot;------&quot;); writeThread.start(); } } ","link":"https://tianxiawuhao.github.io/fE1AHZqDl/"},{"title":"ThreadLocalæ˜¯ä»€ä¹ˆ","content":" ThreadLocalæ˜¯ä¸€ä¸ªæœ¬åœ°çº¿ç¨‹å‰¯æœ¬å˜é‡å·¥å…·ç±»ã€‚ä¸»è¦ç”¨äºå°†ç§æœ‰çº¿ç¨‹å’Œè¯¥çº¿ç¨‹å­˜æ”¾çš„å‰¯æœ¬å¯¹è±¡åšä¸€ä¸ªæ˜ å°„ï¼Œå„ä¸ªçº¿ç¨‹ä¹‹é—´çš„å˜é‡äº’ä¸å¹²æ‰°ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¯ä»¥å®ç°æ— çŠ¶æ€çš„è°ƒç”¨ï¼Œç‰¹åˆ«é€‚ç”¨äºå„ä¸ªçº¿ç¨‹ä¾èµ–ä¸é€šçš„å˜é‡å€¼å®Œæˆæ“ä½œçš„åœºæ™¯ã€‚ æ•°æ®ç»“æ„ ä¸‹å›¾ä¸ºThreadLocalçš„å†…éƒ¨ç»“æ„å›¾ ThreadLocalç»“æ„å†…éƒ¨æ ¸å¿ƒæœºåˆ¶: æ¯ä¸ªThreadçº¿ç¨‹å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªMapã€‚ Mapé‡Œé¢å­˜å‚¨çº¿ç¨‹æœ¬åœ°å¯¹è±¡ï¼ˆkeyï¼‰å’Œçº¿ç¨‹çš„å˜é‡å‰¯æœ¬ï¼ˆvalueï¼‰ Threadå†…éƒ¨çš„Mapæ˜¯ç”±ThreadLocalç»´æŠ¤çš„ï¼Œç”±ThreadLocalè´Ÿè´£å‘mapè·å–å’Œè®¾ç½®çº¿ç¨‹çš„å˜é‡å€¼ã€‚ æ‰€ä»¥å¯¹äºä¸åŒçš„çº¿ç¨‹ï¼Œæ¯æ¬¡è·å–å‰¯æœ¬å€¼æ—¶ï¼Œåˆ«çš„çº¿ç¨‹å¹¶ä¸èƒ½è·å–åˆ°å½“å‰çº¿ç¨‹çš„å‰¯æœ¬å€¼ï¼Œå½¢æˆäº†å‰¯æœ¬çš„éš”ç¦»ï¼Œäº’ä¸å¹²æ‰°ã€‚ Threadçº¿ç¨‹å†…éƒ¨çš„Mapåœ¨ç±»ä¸­æè¿°å¦‚ä¸‹ï¼š public class Thread implements Runnable { /* ThreadLocal values pertaining to this thread. This map is maintained * by the ThreadLocal class. */ ThreadLocal.ThreadLocalMap threadLocals = null; } æ·±å…¥è§£æThreadLocal ThreadLocalç±»æä¾›å¦‚ä¸‹å‡ ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼š public T get() public void set(T value) public void remove() # get()æ–¹æ³•ç”¨äºè·å–å½“å‰çº¿ç¨‹çš„å‰¯æœ¬å˜é‡å€¼ã€‚ # set()æ–¹æ³•ç”¨äºä¿å­˜å½“å‰çº¿ç¨‹çš„å‰¯æœ¬å˜é‡å€¼ã€‚ # initialValue()ä¸ºå½“å‰çº¿ç¨‹åˆå§‹å‰¯æœ¬å˜é‡å€¼ã€‚ # remove()æ–¹æ³•ç§»é™¤å½“å‰å‰ç¨‹çš„å‰¯æœ¬å˜é‡å€¼ã€‚ get()æ–¹æ³• /** * Returns the value in the current thread's copy of this * thread-local variable. If the variable has no value for the * current thread, it is first initialized to the value returned * by an invocation of the {@link #initialValue} method. * * @return the current thread's value of this thread-local */ public T get() { Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) { ThreadLocalMap.Entry e = map.getEntry(this); if (e != null) return (T)e.value; } return setInitialValue(); } ThreadLocalMap getMap(Thread t) { return t.threadLocals; } private T setInitialValue() { T value = initialValue(); Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) map.set(this, value); else createMap(t, value); return value; } protected T initialValue() { return null; } æ­¥éª¤ï¼š è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMapå¯¹è±¡threadLocals ä»mapä¸­è·å–çº¿ç¨‹å­˜å‚¨çš„K-V EntryèŠ‚ç‚¹ã€‚ ä»EntryèŠ‚ç‚¹è·å–å­˜å‚¨çš„Valueå‰¯æœ¬å€¼è¿”å›ã€‚ mapä¸ºç©ºçš„è¯è¿”å›åˆå§‹å€¼nullï¼Œå³çº¿ç¨‹å˜é‡å‰¯æœ¬ä¸ºnullï¼Œåœ¨ä½¿ç”¨æ—¶éœ€è¦æ³¨æ„åˆ¤æ–­NullPointerExceptionã€‚ set()æ–¹æ³• /** * Sets the current thread's copy of this thread-local variable * to the specified value. Most subclasses will have no need to * override this method, relying solely on the {@link #initialValue} * method to set the values of thread-locals. * * @param value the value to be stored in the current thread's copy of * this thread-local. */ public void set(T value) { Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) map.set(this, value); else createMap(t, value); } ThreadLocalMap getMap(Thread t) { return t.threadLocals; } void createMap(Thread t, T firstValue) { t.threadLocals = new ThreadLocalMap(this, firstValue); } æ­¥éª¤ï¼š è·å–å½“å‰çº¿ç¨‹çš„æˆå‘˜å˜é‡map mapéç©ºï¼Œåˆ™é‡æ–°å°†ThreadLocalå’Œæ–°çš„valueå‰¯æœ¬æ”¾å…¥åˆ°mapä¸­ã€‚ mapç©ºï¼Œåˆ™å¯¹çº¿ç¨‹çš„æˆå‘˜å˜é‡ThreadLocalMapè¿›è¡Œåˆå§‹åŒ–åˆ›å»ºï¼Œå¹¶å°†ThreadLocalå’Œvalueå‰¯æœ¬æ”¾å…¥mapä¸­ã€‚ remove()æ–¹æ³• removeæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œä¸åšèµ˜è¿°ã€‚ ThreadLocalMap ThreadLocalMapæ˜¯ThreadLocalçš„å†…éƒ¨ç±»ï¼Œæ²¡æœ‰å®ç°Mapæ¥å£ï¼Œç”¨ç‹¬ç«‹çš„æ–¹å¼å®ç°äº†Mapçš„åŠŸèƒ½ï¼Œå…¶å†…éƒ¨çš„Entryä¹Ÿç‹¬ç«‹å®ç°ã€‚ ThreadLocalMapç±»å›¾ åœ¨ThreadLocalMapä¸­ï¼Œä¹Ÿæ˜¯ç”¨Entryæ¥ä¿å­˜K-Vç»“æ„æ•°æ®çš„ã€‚ä½†æ˜¯Entryä¸­keyåªèƒ½æ˜¯ThreadLocalå¯¹è±¡ï¼Œè¿™ç‚¹è¢«Entryçš„æ„é€ æ–¹æ³•å·²ç»é™å®šæ­»äº†ã€‚ static class Entry extends WeakReference&lt;ThreadLocal&gt; { /** The value associated with this ThreadLocal. */ Object value; Entry(ThreadLocal k, Object v) { super(k); value = v; } } Entryç»§æ‰¿è‡ªWeakReferenceï¼ˆå¼±å¼•ç”¨ï¼Œç”Ÿå‘½å‘¨æœŸåªèƒ½å­˜æ´»åˆ°ä¸‹æ¬¡GCå‰ï¼‰ï¼Œä½†åªæœ‰Keyæ˜¯å¼±å¼•ç”¨ç±»å‹çš„ï¼ŒValueå¹¶éå¼±å¼•ç”¨ã€‚ ThreadLocalMapçš„æˆå‘˜å˜é‡ï¼š static class ThreadLocalMap { /** * The initial capacity -- MUST be a power of two. */ private static final int INITIAL_CAPACITY = 16; /** * The table, resized as necessary. * table.length MUST always be a power of two. */ private Entry[] table; /** * The number of entries in the table. */ private int size = 0; /** * The next size value at which to resize. */ private int threshold; // Default to 0 } Hashå†²çªæ€ä¹ˆè§£å†³ å’ŒHashMapçš„æœ€å¤§çš„ä¸åŒåœ¨äºï¼ŒThreadLocalMapç»“æ„éå¸¸ç®€å•ï¼Œæ²¡æœ‰nextå¼•ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´ThreadLocalMapä¸­è§£å†³Hashå†²çªçš„æ–¹å¼å¹¶éé“¾è¡¨çš„æ–¹å¼ï¼Œè€Œæ˜¯é‡‡ç”¨çº¿æ€§æ¢æµ‹çš„æ–¹å¼ï¼Œæ‰€è°“çº¿æ€§æ¢æµ‹ï¼Œå°±æ˜¯æ ¹æ®åˆå§‹keyçš„hashcodeå€¼ç¡®å®šå…ƒç´ åœ¨tableæ•°ç»„ä¸­çš„ä½ç½®ï¼Œå¦‚æœå‘ç°è¿™ä¸ªä½ç½®ä¸Šå·²ç»æœ‰å…¶ä»–keyå€¼çš„å…ƒç´ è¢«å ç”¨ï¼Œåˆ™åˆ©ç”¨å›ºå®šçš„ç®—æ³•å¯»æ‰¾ä¸€å®šæ­¥é•¿çš„ä¸‹ä¸ªä½ç½®ï¼Œä¾æ¬¡åˆ¤æ–­ï¼Œç›´è‡³æ‰¾åˆ°èƒ½å¤Ÿå­˜æ”¾çš„ä½ç½®ã€‚ ThreadLocalMapè§£å†³Hashå†²çªçš„æ–¹å¼å°±æ˜¯ç®€å•çš„æ­¥é•¿åŠ 1æˆ–å‡1ï¼Œå¯»æ‰¾ä¸‹ä¸€ä¸ªç›¸é‚»çš„ä½ç½®ã€‚ /** * Increment i modulo len. */ private static int nextIndex(int i, int len) { return ((i + 1 &lt; len) ? i + 1 : 0); } /** * Decrement i modulo len. */ private static int prevIndex(int i, int len) { return ((i - 1 &gt;= 0) ? i - 1 : len - 1); } æ˜¾ç„¶ThreadLocalMapé‡‡ç”¨çº¿æ€§æ¢æµ‹çš„æ–¹å¼è§£å†³Hashå†²çªçš„æ•ˆç‡å¾ˆä½ï¼Œå¦‚æœæœ‰å¤§é‡ä¸åŒçš„ThreadLocalå¯¹è±¡æ”¾å…¥mapä¸­æ—¶å‘é€å†²çªï¼Œæˆ–è€…å‘ç”ŸäºŒæ¬¡å†²çªï¼Œåˆ™æ•ˆç‡å¾ˆä½ã€‚ æ‰€ä»¥è¿™é‡Œå¼•å‡ºçš„è‰¯å¥½å»ºè®®æ˜¯ï¼šæ¯ä¸ªçº¿ç¨‹åªå­˜ä¸€ä¸ªå˜é‡ï¼Œè¿™æ ·çš„è¯æ‰€æœ‰çš„çº¿ç¨‹å­˜æ”¾åˆ°mapä¸­çš„Keyéƒ½æ˜¯ç›¸åŒçš„ThreadLocalï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹è¦ä¿å­˜å¤šä¸ªå˜é‡ï¼Œå°±éœ€è¦åˆ›å»ºå¤šä¸ªThreadLocalï¼Œå¤šä¸ªThreadLocalæ”¾å…¥Mapä¸­æ—¶ä¼šæå¤§çš„å¢åŠ Hashå†²çªçš„å¯èƒ½ã€‚ ThreadLocalMapçš„é—®é¢˜ ç”±äºThreadLocalMapçš„keyæ˜¯å¼±å¼•ç”¨ï¼Œè€ŒValueæ˜¯å¼ºå¼•ç”¨ã€‚è¿™å°±å¯¼è‡´äº†ä¸€ä¸ªé—®é¢˜ï¼ŒThreadLocalåœ¨æ²¡æœ‰å¤–éƒ¨å¯¹è±¡å¼ºå¼•ç”¨æ—¶ï¼Œå‘ç”ŸGCæ—¶å¼±å¼•ç”¨Keyä¼šè¢«å›æ”¶ï¼Œè€ŒValueä¸ä¼šå›æ”¶ï¼Œå¦‚æœåˆ›å»ºThreadLocalçš„çº¿ç¨‹ä¸€ç›´æŒç»­è¿è¡Œï¼Œé‚£ä¹ˆè¿™ä¸ªEntryå¯¹è±¡ä¸­çš„valueå°±æœ‰å¯èƒ½ä¸€ç›´å¾—ä¸åˆ°å›æ”¶ï¼Œå‘ç”Ÿå†…å­˜æ³„éœ²ã€‚ å¦‚ä½•é¿å…æ³„æ¼ æ—¢ç„¶Keyæ˜¯å¼±å¼•ç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦åšçš„äº‹ï¼Œå°±æ˜¯åœ¨è°ƒç”¨ThreadLocalçš„get()ã€set()æ–¹æ³•æ—¶å®Œæˆåå†è°ƒç”¨removeæ–¹æ³•ï¼Œå°†EntryèŠ‚ç‚¹å’ŒMapçš„å¼•ç”¨å…³ç³»ç§»é™¤ï¼Œè¿™æ ·æ•´ä¸ªEntryå¯¹è±¡åœ¨GC Rootsåˆ†æåå°±å˜æˆä¸å¯è¾¾äº†ï¼Œä¸‹æ¬¡GCçš„æ—¶å€™å°±å¯ä»¥è¢«å›æ”¶ã€‚ å¦‚æœä½¿ç”¨ThreadLocalçš„setæ–¹æ³•ä¹‹åï¼Œæ²¡æœ‰æ˜¾ç¤ºçš„è°ƒç”¨removeæ–¹æ³•ï¼Œå°±æœ‰å¯èƒ½å‘ç”Ÿå†…å­˜æ³„éœ²ï¼Œæ‰€ä»¥å…»æˆè‰¯å¥½çš„ç¼–ç¨‹ä¹ æƒ¯ååˆ†é‡è¦ï¼Œä½¿ç”¨å®ŒThreadLocalä¹‹åï¼Œè®°å¾—è°ƒç”¨removeæ–¹æ³•ã€‚ ThreadLocal&lt;Session&gt; threadLocal = new ThreadLocal&lt;Session&gt;(); try { threadLocal.set(new Session(1, &quot;Misoutçš„åšå®¢&quot;)); // å…¶å®ƒä¸šåŠ¡é€»è¾‘ } finally { threadLocal.remove(); } åº”ç”¨åœºæ™¯ è¿˜è®°å¾—Hibernateçš„sessionè·å–åœºæ™¯å—ï¼Ÿ private static final ThreadLocal&lt;Session&gt; threadLocal = new ThreadLocal&lt;Session&gt;(); //è·å–Session public static Session getCurrentSession(){ Session session = threadLocal.get(); //åˆ¤æ–­Sessionæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œå°†åˆ›å»ºä¸€ä¸ªsessionï¼Œå¹¶è®¾ç½®åˆ°æœ¬åœ°çº¿ç¨‹å˜é‡ä¸­ try { if(session ==null&amp;&amp;!session.isOpen()){ if(sessionFactory==null){ rbuildSessionFactory();// åˆ›å»ºHibernateçš„SessionFactory }else{ session = sessionFactory.openSession(); } } threadLocal.set(session); } catch (Exception e) { // TODO: handle exception } return session; } ä¸ºä»€ä¹ˆï¼Ÿæ¯ä¸ªçº¿ç¨‹è®¿é—®æ•°æ®åº“éƒ½åº”å½“æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„Sessionä¼šè¯ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹å…±äº«åŒä¸€ä¸ªSessionä¼šè¯ï¼Œæœ‰å¯èƒ½å…¶ä»–çº¿ç¨‹å…³é—­è¿æ¥äº†ï¼Œå½“å‰çº¿ç¨‹å†æ‰§è¡Œæäº¤æ—¶å°±ä¼šå‡ºç°ä¼šè¯å·²å…³é—­çš„å¼‚å¸¸ï¼Œå¯¼è‡´ç³»ç»Ÿå¼‚å¸¸ã€‚æ­¤æ–¹å¼èƒ½é¿å…çº¿ç¨‹äº‰æŠ¢Sessionï¼Œæé«˜å¹¶å‘ä¸‹çš„å®‰å…¨æ€§ã€‚ ä½¿ç”¨ThreadLocalçš„å…¸å‹åœºæ™¯æ­£å¦‚ä¸Šé¢çš„æ•°æ®åº“è¿æ¥ç®¡ç†ï¼Œçº¿ç¨‹ä¼šè¯ç®¡ç†ç­‰åœºæ™¯ï¼Œåªé€‚ç”¨äºç‹¬ç«‹å˜é‡å‰¯æœ¬çš„æƒ…å†µï¼Œå¦‚æœå˜é‡ä¸ºå…¨å±€å…±äº«çš„ï¼Œåˆ™ä¸é€‚ç”¨åœ¨é«˜å¹¶å‘ä¸‹ä½¿ç”¨ã€‚ æ€»ç»“ æ¯ä¸ªThreadLocalåªèƒ½ä¿å­˜ä¸€ä¸ªå˜é‡å‰¯æœ¬ï¼Œå¦‚æœæƒ³è¦ä¸Šçº¿ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿä¿å­˜å¤šä¸ªå‰¯æœ¬ä»¥ä¸Šï¼Œå°±éœ€è¦åˆ›å»ºå¤šä¸ªThreadLocalã€‚ ThreadLocalå†…éƒ¨çš„ThreadLocalMapé”®ä¸ºå¼±å¼•ç”¨ï¼Œä¼šæœ‰å†…å­˜æ³„æ¼çš„é£é™©ã€‚ é€‚ç”¨äºæ— çŠ¶æ€ï¼Œå‰¯æœ¬å˜é‡ç‹¬ç«‹åä¸å½±å“ä¸šåŠ¡é€»è¾‘çš„é«˜å¹¶å‘åœºæ™¯ã€‚å¦‚æœå¦‚æœä¸šåŠ¡é€»è¾‘å¼ºä¾èµ–äºå‰¯æœ¬å˜é‡ï¼Œåˆ™ä¸é€‚åˆç”¨ThreadLocalè§£å†³ï¼Œéœ€è¦å¦å¯»è§£å†³æ–¹æ¡ˆã€‚ ","link":"https://tianxiawuhao.github.io/cQAJ3QFSZ/"},{"title":"HashMapè´Ÿè½½å› å­ä¸ºä»€ä¹ˆæ˜¯0.75ï¼Œé“¾è¡¨è½¬çº¢é»‘æ ‘é˜ˆå€¼ä¸ºä»€ä¹ˆæ˜¯8","content":"1.HashMapè´Ÿè½½å› å­ä¸ºä»€ä¹ˆæ˜¯0.75 è¿™æ˜¯æ—¶é—´ä¸ç©ºé—´æˆæœ¬ä¸Šçš„æŠ˜ä¸­ã€‚ 1.1æ—¶é—´æˆæœ¬ å‡è®¾è´Ÿè½½å› å­æ˜¯1æ—¶ï¼Œè™½ç„¶ç©ºé—´åˆ©ç”¨ç‡é«˜äº†ï¼Œä½†æ˜¯éšä¹‹æé«˜çš„æ˜¯å“ˆå¸Œç¢°æ’çš„æ¦‚ç‡ã€‚ è€ŒHashmapä¸­å“ˆå¸Œç¢°æ’çš„è§£å†³æ–¹æ³•é‡‡ç”¨çš„æ‹‰é“¾æ³•ï¼Œå“ˆå¸Œå†²çªé«˜äº†ä¼šå¯¼è‡´é“¾è¡¨è¶Šæ¥è¶Šé•¿ï¼ˆè™½ç„¶åé¢ä¼šè½¬æ¢æˆçº¢é»‘æ ‘ï¼‰ï¼Œæˆ‘ä»¬çŸ¥é“é“¾è¡¨çš„æŸ¥è¯¢æ•ˆç‡æ˜¯æ¯”è¾ƒä½çš„ï¼Œæ‰€ä»¥è´Ÿè½½å› å­å¤ªé«˜ä¼šå¯¼è‡´æ—¶é—´æˆæœ¬ä¸Šå‡ã€‚ 1.2ç©ºé—´æˆæœ¬ é‚£ä¹ˆä¸ºäº†å‡å°‘å“ˆå¸Œå†²çªï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ï¼Œè´Ÿè½½å› å­æ˜¯ä¸æ˜¯è¶Šä½è¶Šå¥½å‘¢ï¼Ÿç­”æ¡ˆæ˜¾ç„¶æ˜¯å¦å®šçš„ã€‚ å‡è®¾è´Ÿè½½å› å­ä¸º0.5æ—¶ï¼Œé‚£ä¹ˆç©ºé—´åˆ©ç”¨ç‡åªæœ‰50%ã€‚ä¾‹å¦‚å¤§å°ä¸º64æ—¶ï¼Œè‡³å°‘æœ‰32æ²¡æœ‰è¢«åˆ©ç”¨ï¼Œå¤§å°ä¸º1024æ—¶ï¼Œå°±æœ‰512æ²¡æœ‰è¢«åˆ©ç”¨ã€‚æ‰©å®¹åçš„ç©ºé—´è¶Šå¤§ï¼Œç©ºå‡ºçš„ç©ºé—´ä¹Ÿå°±è¶Šå¤§ã€‚ æ‰€ä»¥Javaå¼€å‘äººå‘˜ç»è¿‡æƒè¡¡ï¼Œè´Ÿè½½å› å­ä¸èƒ½å¤ªå¤§ä¹Ÿä¸èƒ½å¤ªå°ï¼ŒæŠ˜ä¸­é€‰æ‹©ä¸º0.75ã€‚ 2.é“¾è¡¨è½¬çº¢é»‘æ ‘é˜ˆå€¼ä¸ºä»€ä¹ˆæ˜¯8 å½“è´Ÿè½½å› å­æ˜¯0.75çš„æƒ…å†µä¸‹ï¼Œå“ˆå¸Œç¢°æ’çš„æ¦‚ç‡éµå¾ªå‚æ•°çº¦ä¸º0.5çš„æ³Šæ¾åˆ†å¸ƒ è¿™æ˜¯æ¦‚ç‡è®ºçš„èŒƒç•´ï¼Œä¸çŸ¥é“çš„åŒå­¦åªéœ€è¦è®°ä½å½“è´Ÿè½½å› å­æ˜¯0.75çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬èƒ½å¤Ÿè®¡ç®—å‡ºå“ˆå¸Œç¢°æ’çš„æ¦‚ç‡ Because TreeNodes are about twice the size of regular nodes, we use them only when bins contain enough nodes to warrant use (see TREEIFY_THRESHOLD). And when they become too small (due to removal or resizing) they are converted back to plain bins. In usages with well-distributed user hashCodes, tree bins are rarely used. Ideally, under random hashCodes, the frequency of nodes in bins follows a Poisson distribution (http://en.wikipedia.org/wiki/Poisson_distribution) with a parameter of about 0.5 on average for the default resizing threshold of 0.75, although with a large variance because of resizing granularity. Ignoring variance, the expected occurrences of list size k are (exp(-0.5)*pow(0.5, k)/factorial(k)). The first values are: 0: 0.60653066 1: 0.30326533 2: 0.07581633 3: 0.01263606 4: 0.00157952 5: 0.00015795 6: 0.00001316 7: 0.00000094 8: 0.00000006 more: less than 1 in ten million åœ¨HashMapæºç ä¸­ï¼Œç»™å‡ºäº†è®¡ç®—å‡ºçš„å“ˆå¸Œç¢°æ’çš„æ¦‚ç‡ã€‚ æˆ‘ä»¬çœ‹åˆ°ç¢°æ’8æ¬¡(é“¾è¡¨é•¿åº¦è¾¾åˆ°8)çš„æ¦‚ç‡ä¸º0.00000006,å‡ ä¹æ˜¯ä¸€ä¸ªä¸å¯èƒ½äº‹ä»¶ã€‚ æ‰€ä»¥Javaå¼€å‘äººå‘˜å°†é“¾è¡¨è½¬çº¢é»‘æ ‘é˜ˆå€¼é»˜è®¤è®¾ä¸º8ï¼Œæ˜¯ä¸ºäº†é¿å…é“¾è¡¨è½¬çº¢é»‘æ ‘è¿™ç§è€—æ—¶æ“ä½œçš„äº‹ä»¶å‘ç”Ÿã€‚ ","link":"https://tianxiawuhao.github.io/mdZO-HjSu/"},{"title":"javaä¸­é™æ€ä»£ç å—ï¼Œéé™æ€ä»£ç å—ï¼Œæ„é€ å‡½æ•°ä¹‹é—´çš„æ‰§è¡Œé¡ºåº","content":"å®ƒä»¬ä¹‹é—´çš„æ‰§è¡Œé¡ºåºä¸ºï¼šé™æ€ä»£ç å—â€”&gt;éé™æ€ä»£ç å—â€”&gt;æ„é€ æ–¹æ³•ã€‚ é™æ€ä»£ç å—åªåœ¨ç¬¬ä¸€æ¬¡åŠ è½½ç±»çš„æ—¶å€™æ‰§è¡Œä¸€æ¬¡ï¼Œä¹‹åä¸å†æ‰§è¡Œï¼›è€Œéé™æ€ä»£ç å—å’Œæ„é€ å‡½æ•°éƒ½æ˜¯åœ¨æ¯newä¸€æ¬¡å°±æ‰§è¡Œä¸€æ¬¡ï¼Œåªä¸è¿‡éé™æ€ä»£ç å—åœ¨æ„é€ å‡½æ•°ä¹‹å‰æ‰§è¡Œè€Œå·²ã€‚ å¦‚æœå­˜åœ¨å­ç±»ï¼Œåˆ™åŠ è½½é¡ºåºä¸ºå…ˆçˆ¶ç±»åå­ç±»ã€‚ çœ‹å¦‚ä¸‹çš„ä»£ç ï¼š package com.ykp.test; class ClassA { public ClassA() { System.out.println(&quot;çˆ¶ç±»æ„é€ å‡½æ•°&quot;); } { System.out.println(&quot;çˆ¶ç±»éé™æ€ä»£ç å—1&quot;); } { System.out.println(&quot;çˆ¶ç±»éé™æ€ä»£ç å—2&quot;); } static { System.out.println(&quot;çˆ¶ç±»é™æ€ä»£ç å— 1&quot;); } static { System.out.println(&quot;çˆ¶ç±»é™æ€ä»£ç å— 2&quot;); } } public class ClassB extends ClassA { public ClassB() { System.out.println(&quot;å­ç±»æ„é€ å‡½æ•°&quot;); } { System.out.println(&quot;å­ç±»éé™æ€ä»£ç å—2&quot;); } { System.out.println(&quot;å­ç±»éé™æ€ä»£ç å—1&quot;); } static { System.out.println(&quot;å­ç±»é™æ€ä»£ç å— 2&quot;); } static { System.out.println(&quot;å­ç±»é™æ€ä»£ç å— 1&quot;); } public static void main(String[] args) { System.out.println(&quot;....ä¸»æ–¹æ³•å¼€å§‹....&quot;); new ClassB(); System.out.println(&quot;************&quot;); new ClassB(); System.out.println(&quot;....ä¸»æ–¹æ³•ç»“æŸ....&quot;); } } æ‰§è¡Œç»“æœï¼š çˆ¶ç±»é™æ€ä»£ç å— 1 çˆ¶ç±»é™æ€ä»£ç å— 2 å­ç±»é™æ€ä»£ç å— 2 å­ç±»é™æ€ä»£ç å— 1 ....ä¸»æ–¹æ³•å¼€å§‹.... çˆ¶ç±»éé™æ€ä»£ç å—1 çˆ¶ç±»éé™æ€ä»£ç å—2 çˆ¶ç±»æ„é€ å‡½æ•° å­ç±»éé™æ€ä»£ç å—2 å­ç±»éé™æ€ä»£ç å—1 å­ç±»æ„é€ å‡½æ•° ************ çˆ¶ç±»éé™æ€ä»£ç å—1 çˆ¶ç±»éé™æ€ä»£ç å—2 çˆ¶ç±»æ„é€ å‡½æ•° å­ç±»éé™æ€ä»£ç å—2 å­ç±»éé™æ€ä»£ç å—1 å­ç±»æ„é€ å‡½æ•° ....ä¸»æ–¹æ³•ç»“æŸ.... ä»ç»“æœå¯ä»¥çœ‹å‡ºï¼Œé¦–å…ˆåŠ è½½ç±»ï¼ŒåŠ è½½çš„æ—¶å€™å…ˆåŠ è½½çˆ¶ç±»ï¼Œç„¶åå­ç±»ï¼Œç±»åŠ è½½çš„æ—¶å€™å°±æ‰§è¡Œé™æ€ä»£ç å¿«ï¼Œä¹Ÿå°±æ˜¯è¯´é™æ€ä»£ç å—æ˜¯åœ¨ç±»åŠ è½½çš„æ—¶å€™å°±åŠ è½½çš„ï¼Œè€Œä¸”åªåŠ è½½ä¸€æ¬¡ã€‚å¦‚æœå­˜åœ¨å¤šä¸ªæ‰§è¡Œé¡ºåºæŒ‰ç…§ä»£ç çš„å…ˆåæ¥ã€‚ å¯¹äºéé™æ€ä»£ç å—ï¼Œæ˜¯åœ¨newçš„æ—¶å€™åŠ è½½çš„ï¼Œåªæ˜¯åœ¨æ„é€ å‡½æ•°ä¹‹å‰åŠ è½½è€Œå·²ã€‚å¦‚æœå­˜åœ¨å¤šä¸ªæ‰§è¡Œé¡ºåºæŒ‰ç…§ä»£ç çš„å…ˆåæ¥ã€‚ ","link":"https://tianxiawuhao.github.io/8H8sHTUTf/"},{"title":"æŒ‡ä»¤é‡æ’åº","content":"æ•°æ®ä¾èµ–æ€§ å¦‚æœä¸¤ä¸ªæ“ä½œè®¿é—®åŒä¸€ä¸ªå˜é‡ï¼Œä¸”è¿™ä¸¤ä¸ªæ“ä½œä¸­æœ‰ä¸€ä¸ªä¸ºå†™æ“ä½œï¼Œæ­¤æ—¶è¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´å°±å­˜åœ¨æ•°æ®ä¾èµ–æ€§ã€‚æ•°æ®ä¾èµ–åˆ†ä¸‹åˆ—ä¸‰ç§ç±»å‹ï¼š åç§° ä»£ç ç¤ºä¾‹ è¯´æ˜ å†™åè¯» a = 1;b = a; å†™ä¸€ä¸ªå˜é‡ä¹‹åï¼Œå†è¯»è¿™ä¸ªä½ç½®ã€‚ å†™åå†™ a = 1;a = 2; å†™ä¸€ä¸ªå˜é‡ä¹‹åï¼Œå†å†™è¿™ä¸ªå˜é‡ã€‚ è¯»åå†™ a = b;b = 1; è¯»ä¸€ä¸ªå˜é‡ä¹‹åï¼Œå†å†™è¿™ä¸ªå˜é‡ã€‚ ä¸Šé¢ä¸‰ç§æƒ…å†µï¼Œåªè¦é‡æ’åºä¸¤ä¸ªæ“ä½œçš„æ‰§è¡Œé¡ºåºï¼Œç¨‹åºçš„æ‰§è¡Œç»“æœå°†ä¼šè¢«æ”¹å˜ã€‚ å‰é¢æåˆ°è¿‡ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¯èƒ½ä¼šå¯¹æ“ä½œåšé‡æ’åºã€‚ç¼–è¯‘å™¨å’Œå¤„ç†å™¨åœ¨é‡æ’åºæ—¶ï¼Œä¼šéµå®ˆæ•°æ®ä¾èµ–æ€§ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ä¼šæ”¹å˜å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»çš„ä¸¤ä¸ªæ“ä½œçš„æ‰§è¡Œé¡ºåºã€‚ æ³¨æ„ï¼Œè¿™é‡Œæ‰€è¯´çš„æ•°æ®ä¾èµ–æ€§ä»…é’ˆå¯¹å•ä¸ªå¤„ç†å™¨ä¸­æ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—å’Œå•ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œçš„æ“ä½œï¼Œä¸åŒå¤„ç†å™¨ä¹‹é—´å’Œä¸åŒçº¿ç¨‹ä¹‹é—´çš„æ•°æ®ä¾èµ–æ€§ä¸è¢«ç¼–è¯‘å™¨å’Œå¤„ç†å™¨è€ƒè™‘ã€‚ as-if-serial è¯­ä¹‰ as-if-serial è¯­ä¹‰çš„æ„æ€æŒ‡ï¼šä¸ç®¡æ€ä¹ˆé‡æ’åºï¼ˆç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ºäº†æé«˜å¹¶è¡Œåº¦ï¼‰ï¼Œï¼ˆå•çº¿ç¨‹ï¼‰ç¨‹åºçš„æ‰§è¡Œç»“æœä¸èƒ½è¢«æ”¹å˜ã€‚ç¼–è¯‘å™¨ï¼Œruntime å’Œå¤„ç†å™¨éƒ½å¿…é¡»éµå®ˆ as-if-serial è¯­ä¹‰ã€‚ ä¸ºäº†éµå®ˆ as-if-serial è¯­ä¹‰ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ä¼šå¯¹å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»çš„æ“ä½œåšé‡æ’åºï¼Œå› ä¸ºè¿™ç§é‡æ’åºä¼šæ”¹å˜æ‰§è¡Œç»“æœã€‚ä½†æ˜¯ï¼Œå¦‚æœæ“ä½œä¹‹é—´ä¸å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»ï¼Œè¿™äº›æ“ä½œå¯èƒ½è¢«ç¼–è¯‘å™¨å’Œå¤„ç†å™¨é‡æ’åºã€‚ä¸ºäº†å…·ä½“è¯´æ˜ï¼Œè¯·çœ‹ä¸‹é¢è®¡ç®—åœ†é¢ç§¯çš„ä»£ç ç¤ºä¾‹ï¼š double pi = 3.14; //A double r = 1.0; //B double area = pi * r * r; //C ä¸Šé¢ä¸‰ä¸ªæ“ä½œçš„æ•°æ®ä¾èµ–å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒA å’Œ C ä¹‹é—´å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»ï¼ŒåŒæ—¶ B å’Œ C ä¹‹é—´ä¹Ÿå­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»ã€‚å› æ­¤åœ¨æœ€ç»ˆæ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—ä¸­ï¼ŒC ä¸èƒ½è¢«é‡æ’åºåˆ° A å’Œ B çš„å‰é¢ï¼ˆC æ’åˆ° A å’Œ B çš„å‰é¢ï¼Œç¨‹åºçš„ç»“æœå°†ä¼šè¢«æ”¹å˜ï¼‰ã€‚ä½† A å’Œ B ä¹‹é—´æ²¡æœ‰æ•°æ®ä¾èµ–å…³ç³»ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¯ä»¥é‡æ’åº A å’Œ B ä¹‹é—´çš„æ‰§è¡Œé¡ºåºã€‚ä¸‹å›¾æ˜¯è¯¥ç¨‹åºçš„ä¸¤ç§æ‰§è¡Œé¡ºåºï¼š as-if-serial è¯­ä¹‰æŠŠå•çº¿ç¨‹ç¨‹åºä¿æŠ¤äº†èµ·æ¥ï¼Œéµå®ˆ as-if-serial è¯­ä¹‰çš„ç¼–è¯‘å™¨ï¼Œruntime å’Œå¤„ç†å™¨å…±åŒä¸ºç¼–å†™å•çº¿ç¨‹ç¨‹åºçš„ç¨‹åºå‘˜åˆ›å»ºäº†ä¸€ä¸ªå¹»è§‰ï¼šå•çº¿ç¨‹ç¨‹åºæ˜¯æŒ‰ç¨‹åºçš„é¡ºåºæ¥æ‰§è¡Œçš„ã€‚as-if-serial è¯­ä¹‰ä½¿å•çº¿ç¨‹ç¨‹åºå‘˜æ— éœ€æ‹…å¿ƒé‡æ’åºä¼šå¹²æ‰°ä»–ä»¬ï¼Œä¹Ÿæ— éœ€æ‹…å¿ƒå†…å­˜å¯è§æ€§é—®é¢˜ã€‚ ç¨‹åºé¡ºåºè§„åˆ™ æ ¹æ® happens- before çš„ç¨‹åºé¡ºåºè§„åˆ™ï¼Œä¸Šé¢è®¡ç®—åœ†çš„é¢ç§¯çš„ç¤ºä¾‹ä»£ç å­˜åœ¨ä¸‰ä¸ª happens- before å…³ç³»ï¼š A happens- before Bï¼› B happens- before Cï¼› A happens- before Cï¼› è¿™é‡Œçš„ç¬¬3ä¸ª happens- before å…³ç³»ï¼Œæ˜¯æ ¹æ® happens- before çš„ä¼ é€’æ€§æ¨å¯¼å‡ºæ¥çš„ã€‚ è¿™é‡Œ A happens- before Bï¼Œä½†å®é™…æ‰§è¡Œæ—¶ B å´å¯ä»¥æ’åœ¨ A ä¹‹å‰æ‰§è¡Œï¼ˆçœ‹ä¸Šé¢çš„é‡æ’åºåçš„æ‰§è¡Œé¡ºåºï¼‰ã€‚åœ¨ç¬¬ä¸€ç« æåˆ°è¿‡ï¼Œå¦‚æœ A happens- before Bï¼ŒJMM å¹¶ä¸è¦æ±‚ A ä¸€å®šè¦åœ¨ B ä¹‹å‰æ‰§è¡Œã€‚JMM ä»…ä»…è¦æ±‚å‰ä¸€ä¸ªæ“ä½œï¼ˆæ‰§è¡Œçš„ç»“æœï¼‰å¯¹åä¸€ä¸ªæ“ä½œå¯è§ï¼Œä¸”å‰ä¸€ä¸ªæ“ä½œæŒ‰é¡ºåºæ’åœ¨ç¬¬äºŒä¸ªæ“ä½œä¹‹å‰ã€‚è¿™é‡Œæ“ä½œ A çš„æ‰§è¡Œç»“æœä¸éœ€è¦å¯¹æ“ä½œ B å¯è§ï¼›è€Œä¸”é‡æ’åºæ“ä½œ A å’Œæ“ä½œ B åçš„æ‰§è¡Œç»“æœï¼Œä¸æ“ä½œ A å’Œæ“ä½œ B æŒ‰ happens- before é¡ºåºæ‰§è¡Œçš„ç»“æœä¸€è‡´ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒJMM ä¼šè®¤ä¸ºè¿™ç§é‡æ’åºå¹¶ä¸éæ³•ï¼ˆnot illegalï¼‰ï¼ŒJMM å…è®¸è¿™ç§é‡æ’åºã€‚ åœ¨è®¡ç®—æœºä¸­ï¼Œè½¯ä»¶æŠ€æœ¯å’Œç¡¬ä»¶æŠ€æœ¯æœ‰ä¸€ä¸ªå…±åŒçš„ç›®æ ‡ï¼šåœ¨ä¸æ”¹å˜ç¨‹åºæ‰§è¡Œç»“æœçš„å‰æä¸‹ï¼Œå°½å¯èƒ½çš„å¼€å‘å¹¶è¡Œåº¦ã€‚ç¼–è¯‘å™¨å’Œå¤„ç†å™¨éµä»è¿™ä¸€ç›®æ ‡ï¼Œä» happens- before çš„å®šä¹‰æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒJMM åŒæ ·éµä»è¿™ä¸€ç›®æ ‡ã€‚ é‡æ’åºå¯¹å¤šçº¿ç¨‹çš„å½±å“ ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œé‡æ’åºæ˜¯å¦ä¼šæ”¹å˜å¤šçº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œç»“æœã€‚è¯·çœ‹ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼š class ReorderExample { int a = 0; boolean flag = false; public void writer() { a = 1; //1 flag = true; //2 } Public void reader() { if (flag) { //3 int i = a * a; //4 â€¦â€¦ } } } flag å˜é‡æ˜¯ä¸ªæ ‡è®°ï¼Œç”¨æ¥æ ‡è¯†å˜é‡ a æ˜¯å¦å·²è¢«å†™å…¥ã€‚è¿™é‡Œå‡è®¾æœ‰ä¸¤ä¸ªçº¿ç¨‹ A å’Œ Bï¼ŒA é¦–å…ˆæ‰§è¡Œwriter() æ–¹æ³•ï¼Œéšå B çº¿ç¨‹æ¥ç€æ‰§è¡Œ reader() æ–¹æ³•ã€‚çº¿ç¨‹Båœ¨æ‰§è¡Œæ“ä½œ4æ—¶ï¼Œèƒ½å¦çœ‹åˆ°çº¿ç¨‹ A åœ¨æ“ä½œ1å¯¹å…±äº«å˜é‡ a çš„å†™å…¥ï¼Ÿ ç­”æ¡ˆæ˜¯ï¼šä¸ä¸€å®šèƒ½çœ‹åˆ°ã€‚ ç”±äºæ“ä½œ1å’Œæ“ä½œ2æ²¡æœ‰æ•°æ®ä¾èµ–å…³ç³»ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¯ä»¥å¯¹è¿™ä¸¤ä¸ªæ“ä½œé‡æ’åºï¼›åŒæ ·ï¼Œæ“ä½œ3å’Œæ“ä½œ4æ²¡æœ‰æ•°æ®ä¾èµ–å…³ç³»ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¹Ÿå¯ä»¥å¯¹è¿™ä¸¤ä¸ªæ“ä½œé‡æ’åºã€‚è®©æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ï¼Œå½“æ“ä½œ1å’Œæ“ä½œ2é‡æ’åºæ—¶ï¼Œå¯èƒ½ä¼šäº§ç”Ÿä»€ä¹ˆæ•ˆæœï¼Ÿè¯·çœ‹ä¸‹é¢çš„ç¨‹åºæ‰§è¡Œæ—¶åºå›¾ï¼š å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ“ä½œ1å’Œæ“ä½œ2åšäº†é‡æ’åºã€‚ç¨‹åºæ‰§è¡Œæ—¶ï¼Œçº¿ç¨‹Aé¦–å…ˆå†™æ ‡è®°å˜é‡ flagï¼Œéšåçº¿ç¨‹ B è¯»è¿™ä¸ªå˜é‡ã€‚ç”±äºæ¡ä»¶åˆ¤æ–­ä¸ºçœŸï¼Œçº¿ç¨‹ B å°†è¯»å–å˜é‡aã€‚æ­¤æ—¶ï¼Œå˜é‡ a è¿˜æ ¹æœ¬æ²¡æœ‰è¢«çº¿ç¨‹ A å†™å…¥ï¼Œåœ¨è¿™é‡Œå¤šçº¿ç¨‹ç¨‹åºçš„è¯­ä¹‰è¢«é‡æ’åºç ´åäº†ï¼ â€»æ³¨ï¼šæœ¬æ–‡ç»Ÿä¸€ç”¨çº¢è‰²çš„è™šç®­çº¿è¡¨ç¤ºé”™è¯¯çš„è¯»æ“ä½œï¼Œç”¨ç»¿è‰²çš„è™šç®­çº¿è¡¨ç¤ºæ­£ç¡®çš„è¯»æ“ä½œã€‚ ä¸‹é¢å†è®©æˆ‘ä»¬çœ‹çœ‹ï¼Œå½“æ“ä½œ3å’Œæ“ä½œ4é‡æ’åºæ—¶ä¼šäº§ç”Ÿä»€ä¹ˆæ•ˆæœï¼ˆå€ŸåŠ©è¿™ä¸ªé‡æ’åºï¼Œå¯ä»¥é¡ºä¾¿è¯´æ˜æ§åˆ¶ä¾èµ–æ€§ï¼‰ã€‚ä¸‹é¢æ˜¯æ“ä½œ3å’Œæ“ä½œ4é‡æ’åºåï¼Œç¨‹åºçš„æ‰§è¡Œæ—¶åºå›¾ï¼š åœ¨ç¨‹åºä¸­ï¼Œæ“ä½œ3å’Œæ“ä½œ4å­˜åœ¨æ§åˆ¶ä¾èµ–å…³ç³»ã€‚å½“ä»£ç ä¸­å­˜åœ¨æ§åˆ¶ä¾èµ–æ€§æ—¶ï¼Œä¼šå½±å“æŒ‡ä»¤åºåˆ—æ‰§è¡Œçš„å¹¶è¡Œåº¦ã€‚ä¸ºæ­¤ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¼šé‡‡ç”¨çŒœæµ‹ï¼ˆSpeculationï¼‰æ‰§è¡Œæ¥å…‹æœæ§åˆ¶ç›¸å…³æ€§å¯¹å¹¶è¡Œåº¦çš„å½±å“ã€‚ä»¥å¤„ç†å™¨çš„çŒœæµ‹æ‰§è¡Œä¸ºä¾‹ï¼Œæ‰§è¡Œçº¿ç¨‹ B çš„å¤„ç†å™¨å¯ä»¥æå‰è¯»å–å¹¶è®¡ç®— a*aï¼Œç„¶åæŠŠè®¡ç®—ç»“æœä¸´æ—¶ä¿å­˜åˆ°ä¸€ä¸ªåä¸ºé‡æ’åºç¼“å†²ï¼ˆreorder buffer ROBï¼‰çš„ç¡¬ä»¶ç¼“å­˜ä¸­ã€‚å½“æ¥ä¸‹æ¥æ“ä½œ3çš„æ¡ä»¶åˆ¤æ–­ä¸ºçœŸæ—¶ï¼Œå°±æŠŠè¯¥è®¡ç®—ç»“æœå†™å…¥å˜é‡iä¸­ã€‚ ä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒçŒœæµ‹æ‰§è¡Œå®è´¨ä¸Šå¯¹æ“ä½œ3å’Œ4åšäº†é‡æ’åºã€‚é‡æ’åºåœ¨è¿™é‡Œç ´åäº†å¤šçº¿ç¨‹ç¨‹åºçš„è¯­ä¹‰ï¼ åœ¨å•çº¿ç¨‹ç¨‹åºä¸­ï¼Œå¯¹å­˜åœ¨æ§åˆ¶ä¾èµ–çš„æ“ä½œé‡æ’åºï¼Œä¸ä¼šæ”¹å˜æ‰§è¡Œç»“æœï¼ˆè¿™ä¹Ÿæ˜¯ as-if-serial è¯­ä¹‰å…è®¸å¯¹å­˜åœ¨æ§åˆ¶ä¾èµ–çš„æ“ä½œåšé‡æ’åºçš„åŸå› ï¼‰ï¼›ä½†åœ¨å¤šçº¿ç¨‹ç¨‹åºä¸­ï¼Œå¯¹å­˜åœ¨æ§åˆ¶ä¾èµ–çš„æ“ä½œé‡æ’åºï¼Œå¯èƒ½ä¼šæ”¹å˜ç¨‹åºçš„æ‰§è¡Œç»“æœã€‚ ç¼–è¯‘å™¨æŒ‡ä»¤é‡æ’ ä¸‹é¢æˆ‘ä»¬ç®€å•çœ‹ä¸€ä¸ªç¼–è¯‘å™¨é‡æ’çš„ä¾‹å­ï¼š çº¿ç¨‹ 1 çº¿ç¨‹ 2 1ï¼šx2 = a ; 3: x1 = b ; 2: b = 1; 4: a = 2 ; ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œï¼Œåˆ†åˆ«æœ‰1ã€2ã€3ã€4å››æ®µæ‰§è¡Œä»£ç ï¼Œå…¶ä¸­1ã€2å±äºçº¿ç¨‹1 ï¼Œ 3ã€4å±äºçº¿ç¨‹2 ï¼Œä»ç¨‹åºçš„æ‰§è¡Œé¡ºåºä¸Šçœ‹ï¼Œä¼¼ä¹ä¸å¤ªå¯èƒ½å‡ºç°x1 = 1 å’Œx2 = 2 çš„æƒ…å†µï¼Œä½†å®é™…ä¸Šè¿™ç§æƒ…å†µæ˜¯æœ‰å¯èƒ½å‘ç°çš„ï¼Œå› ä¸ºå¦‚æœç¼–è¯‘å™¨å¯¹è¿™æ®µç¨‹åºä»£ç æ‰§è¡Œé‡æ’ä¼˜åŒ–åï¼Œå¯èƒ½å‡ºç°ä¸‹åˆ—æƒ…å†µ çº¿ç¨‹ 1 çº¿ç¨‹ 2 2: b = 1; 4: a = 2 ; 1ï¼šx2 = a ; 3: x1 = b ; è¿™ç§æ‰§è¡Œé¡ºåºä¸‹å°±æœ‰å¯èƒ½å‡ºç°x1 = 1 å’Œx2 = 2 çš„æƒ…å†µï¼Œè¿™ä¹Ÿå°±è¯´æ˜åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œç”±äºç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’çš„å­˜åœ¨ï¼Œä¸¤ä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨çš„å˜é‡èƒ½å¦ä¿è¯ä¸€è‡´æ€§æ˜¯æ— æ³•ç¡®å®šçš„ã€‚ æºä»£ç å’ŒRuntimeæ—¶æ‰§è¡Œçš„ä»£ç å¾ˆå¯èƒ½ä¸ä¸€æ ·ï¼Œè¿™æ˜¯å› ä¸ºç¼–è¯‘å™¨ã€å¤„ç†å™¨å¸¸å¸¸ä¼šä¸ºäº†è¿½æ±‚æ€§èƒ½å¯¹æ”¹å˜æ‰§è¡Œé¡ºåºã€‚ç„¶è€Œæ”¹å˜é¡ºåºæ‰§è¡Œå¾ˆå±é™©ï¼Œå¾ˆæœ‰å¯èƒ½ä½¿å¾—è¿è¡Œç»“æœå’Œé¢„æƒ³çš„ä¸ä¸€æ ·ï¼Œç‰¹åˆ«æ˜¯å½“é‡æ’åºå…±äº«å˜é‡æ—¶ã€‚ ä»æºä»£ç åˆ°Runtimeéœ€è¦ç»è¿‡ä¸‰æ­¥çš„é‡æ’åºï¼š ç¼–è¯‘å™¨é‡æ’åº ä¸ºäº†æé«˜æ€§èƒ½ï¼Œåœ¨ä¸æ”¹å˜å•çº¿ç¨‹çš„æ‰§è¡Œç»“æœä¸‹ï¼Œå¯ä»¥æ”¹å˜è¯­å¥æ‰§è¡Œé¡ºåºã€‚ æ¯”å¦‚å°½å¯èƒ½çš„å‡å°‘å¯„å­˜å™¨çš„è¯»å†™æ¬¡æ•°ï¼Œå……åˆ†åˆ©ç”¨å±€éƒ¨æ€§ã€‚åƒä¸‹é¢è¿™æ®µä»£ç è¿™æ ·ï¼Œäº¤æ›¿çš„è¯»xã€yï¼Œä¼šå¯¼è‡´å¯„å­˜å™¨é¢‘ç¹çš„äº¤æ›¿å­˜å‚¨xå’Œyï¼Œæœ€ç³Ÿçš„æƒ…å†µä¸‹å¯„å­˜å™¨è¦å­˜å‚¨3æ¬¡xå’Œ3æ¬¡yã€‚å¦‚æœèƒ½è®©xçš„ä¸€ç³»åˆ—æ“ä½œä¸€å—åšå®Œï¼Œyçš„ä¸€å—åšå®Œï¼Œç†æƒ³æƒ…å†µä¸‹å¯„å­˜å™¨åªéœ€è¦å­˜å‚¨1æ¬¡xå’Œ1æ¬¡yã€‚ //ä¼˜åŒ–å‰ int x = 1; int y = 2; int a1 = x * 1; int b1 = y * 1; int a2 = x * 2; int b2 = y * 2; int a3 = x * 3; int b3 = y * 3; //ä¼˜åŒ–å int x = 1; int y = 2; int a1 = x * 1; int a2 = x * 2; int a3 = x * 3; int b1 = y * 1; int b2 = y * 2; int b3 = y * 3; æŒ‡ä»¤é‡æ’åº æŒ‡ä»¤é‡æ’åºæ˜¯å¤„ç†å™¨å±‚é¢åšçš„ä¼˜åŒ–ã€‚å¤„ç†å™¨åœ¨æ‰§è¡Œæ—¶å¾€å¾€ä¼šå› ä¸ºä¸€äº›é™åˆ¶è€Œç­‰å¾…ï¼Œå¦‚è®¿å­˜çš„åœ°å€ä¸åœ¨cacheä¸­å‘ç”Ÿmissï¼Œè¿™æ—¶å°±éœ€è¦åˆ°å†…å­˜ç”šè‡³å¤–å­˜å»å–ï¼Œç„¶è€Œå†…å­˜å’Œå¤–åŒºçš„è¯»å–é€Ÿåº¦æ¯”CPUæ‰§è¡Œé€Ÿåº¦æ…¢å¾—å¤šã€‚ æ—©æœŸå¤„ç†å™¨æ˜¯é¡ºåºæ‰§è¡Œ(in-order execution)çš„ï¼Œåœ¨å†…å­˜ã€å¤–å­˜è¯»å–æ•°æ®è¿™æ®µæ—¶é—´ï¼Œå¤„ç†å™¨å°±ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ã€‚ç°åœ¨å¤„ç†å™¨ä¸€èˆ¬éƒ½æ˜¯ä¹±åºæ‰§è¡Œ(out-of-order execution)ï¼Œå¤„ç†å™¨ä¼šåœ¨ç­‰å¾…æ•°æ®çš„æ—¶å€™å»æ‰§è¡Œå…¶ä»–å·²å‡†å¤‡å¥½çš„æ“ä½œï¼Œä¸ä¼šè®©å¤„ç†å™¨ä¸€ç›´ç­‰å¾…ã€‚ æ»¡è¶³ä¹±åºæ‰§è¡Œçš„æ¡ä»¶ï¼š è¯¥ç¼“å­˜çš„æ“ä½œæ•°ç¼“å­˜å¥½ æœ‰ç©ºé—²çš„æ‰§è¡Œå•å…ƒ å¯¹äºä¸‹é¢è¿™æ®µæ±‡ç¼–ä»£ç ï¼Œæ“ä½œ1å¦‚æœå‘ç”Ÿcache missï¼Œåˆ™éœ€è¦ç­‰å¾…è¯»å–å†…å­˜å¤–å­˜ã€‚çœ‹çœ‹æœ‰æ²¡æœ‰èƒ½ä¼˜å…ˆæ‰§è¡Œçš„æŒ‡ä»¤ï¼Œæ“ä½œ2ä¾èµ–äºæ“ä½œ1ï¼Œä¸èƒ½è¢«ä¼˜å…ˆæ‰§è¡Œï¼Œæ“ä½œ3ä¸ä¾èµ–1å’Œ2ï¼Œæ‰€ä»¥èƒ½ä¼˜å…ˆæ‰§è¡Œæ“ä½œ3ã€‚ æ‰€ä»¥å®é™…æ‰§è¡Œé¡ºåºæ˜¯3&gt;1&gt;2 LDR R1, [R0];//æ“ä½œ1 ADD R2, R1, R1;//æ“ä½œ2 ADD R3, R4, R4;//æ“ä½œ3 å†…å­˜ç³»ç»Ÿé‡æ’åº ç”±äºå¤„ç†å™¨æœ‰è¯»ã€å†™ç¼“å­˜åŒºï¼Œå†™ç¼“å­˜åŒºæ²¡æœ‰åŠæ—¶åˆ·æ–°åˆ°å†…å­˜ï¼Œé€ æˆå…¶ä»–å¤„ç†å™¨è¯»åˆ°çš„å€¼ä¸æ˜¯æœ€æ–°çš„ï¼Œä½¿å¾—å¤„ç†å™¨æ‰§è¡Œçš„è¯»å†™æ“ä½œä¸å†…å­˜ä¸Šååº”å‡ºçš„é¡ºåºä¸ä¸€è‡´ã€‚ å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œå¯èƒ½é€ æˆå¤„ç†å™¨Aè¯»åˆ°çš„b=0ï¼Œå¤„ç†å™¨Bè¯»åˆ°çš„a=0ã€‚A1å†™a=1å…ˆå†™åˆ°å¤„ç†å™¨Açš„å†™ç¼“å­˜åŒºä¸­ï¼Œæ­¤æ—¶å†…å­˜ä¸­a=0ã€‚å¦‚æœè¿™æ—¶å¤„ç†å™¨Bä»å†…å­˜ä¸­è¯»aï¼Œè¯»åˆ°çš„å°†æ˜¯0ã€‚ ä»¥å¤„ç†å™¨Aæ¥è¯´ï¼Œå¤„ç†å™¨Aæ‰§è¡Œçš„é¡ºåºæ˜¯A1&gt;A2&gt;A3ï¼Œä½†æ˜¯ç”±äºå†™ç¼“å­˜åŒºæ²¡æœ‰åŠæ—¶åˆ·æ–°åˆ°å†…å­˜ï¼Œæ‰€ä»¥å®é™…é¡ºåºä¸ºA2&gt;A1&gt;A3ã€‚ åˆå§‹åŒ–ï¼š a = 0; b = 0; å¤„ç†å™¨Aæ‰§è¡Œ a = 1; //A1 read(b); //A2 å¤„ç†å™¨Bæ‰§è¡Œ b = 2; //B1 read(a); //B2 é˜»æ­¢é‡æ’åº ä¸è®ºå“ªç§é‡æ’åºéƒ½å¯èƒ½é€ æˆå…±äº«å˜é‡ä¸­çº¿ç¨‹é—´ä¸å¯è§ï¼Œè¿™ä¼šæ”¹å˜ç¨‹åºè¿è¡Œç»“æœã€‚æ‰€ä»¥éœ€è¦ç¦æ­¢å¯¹é‚£äº›è¦æ±‚å¯è§çš„å…±äº«å˜é‡é‡æ’åºã€‚ é˜»æ­¢ç¼–è¯‘é‡æ’åºï¼šç¦æ­¢ç¼–è¯‘å™¨åœ¨æŸäº›æ—¶å€™é‡æ’åºã€‚ é˜»æ­¢æŒ‡ä»¤é‡æ’åºå’Œå†…å­˜ç³»ç»Ÿé‡æ’åºï¼šä½¿ç”¨å†…å­˜å±éšœæˆ–Lockå‰ç¼€æŒ‡ä»¤ ","link":"https://tianxiawuhao.github.io/J4bdQ7uDb/"},{"title":"happens-beforeåŸåˆ™å’Œvolatile","content":"åŸºæœ¬æ¦‚å¿µ å…ˆè¡¥å……ä¸€ä¸‹æ¦‚å¿µï¼šJava å†…å­˜æ¨¡å‹ä¸­çš„å¯è§æ€§ã€åŸå­æ€§å’Œæœ‰åºæ€§ã€‚ å¯è§æ€§ï¼š å¯è§æ€§æ˜¯ä¸€ç§å¤æ‚çš„å±æ€§ï¼Œå› ä¸ºå¯è§æ€§ä¸­çš„é”™è¯¯æ€»æ˜¯ä¼šè¿èƒŒæˆ‘ä»¬çš„ç›´è§‰ã€‚é€šå¸¸ï¼Œæˆ‘ä»¬æ— æ³•ç¡®ä¿æ‰§è¡Œè¯»æ“ä½œçš„çº¿ç¨‹èƒ½é€‚æ—¶åœ°çœ‹åˆ°å…¶ä»–çº¿ç¨‹å†™å…¥çš„å€¼ï¼Œæœ‰æ—¶ç”šè‡³æ˜¯æ ¹æœ¬ä¸å¯èƒ½çš„äº‹æƒ…ã€‚ä¸ºäº†ç¡®ä¿å¤šä¸ªçº¿ç¨‹ä¹‹é—´å¯¹å†…å­˜å†™å…¥æ“ä½œçš„å¯è§æ€§ï¼Œå¿…é¡»ä½¿ç”¨åŒæ­¥æœºåˆ¶ã€‚ å¯è§æ€§ï¼Œæ˜¯æŒ‡çº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§ï¼Œä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹çš„çŠ¶æ€å¯¹å¦ä¸€ä¸ªçº¿ç¨‹æ˜¯å¯è§çš„ä¹Ÿå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹çš„ç»“æœã€‚å¦ä¸€ä¸ªçº¿ç¨‹é©¬ä¸Šå°±èƒ½çœ‹åˆ°ã€‚æ¯”å¦‚ï¼šç”¨volatileä¿®é¥°çš„å˜é‡ï¼Œå°±ä¼šå…·æœ‰å¯è§æ€§ã€‚volatileä¿®é¥°çš„å˜é‡ä¸å…è®¸çº¿ç¨‹å†…éƒ¨ç¼“å­˜å’Œé‡æ’åºï¼Œå³ç›´æ¥ä¿®æ”¹å†…å­˜ã€‚æ‰€ä»¥å¯¹å…¶ä»–çº¿ç¨‹æ˜¯å¯è§çš„ã€‚ä½†æ˜¯è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸ªé—®é¢˜ï¼Œvolatileåªèƒ½è®©è¢«ä»–ä¿®é¥°å†…å®¹å…·æœ‰å¯è§æ€§ï¼Œä½†ä¸èƒ½ä¿è¯å®ƒå…·æœ‰åŸå­æ€§ã€‚æ¯”å¦‚ volatile int a = 0ï¼›ä¹‹åæœ‰ä¸€ä¸ªæ“ä½œ a++ï¼›è¿™ä¸ªå˜é‡aå…·æœ‰å¯è§æ€§ï¼Œä½†æ˜¯a++ ä¾ç„¶æ˜¯ä¸€ä¸ªéåŸå­æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªæ“ä½œåŒæ ·å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ åœ¨ Java ä¸­ volatileã€synchronized å’Œ final å®ç°å¯è§æ€§ã€‚ åŸå­æ€§ï¼š åŸå­æ˜¯ä¸–ç•Œä¸Šçš„æœ€å°å•ä½ï¼Œå…·æœ‰ä¸å¯åˆ†å‰²æ€§ï¼Œæ¯”å¦‚ a=0ï¼›ï¼ˆaélongå’Œdoubleç±»å‹ï¼‰ è¿™ä¸ªæ“ä½œæ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯´è¿™ä¸ªæ“ä½œæ˜¯åŸå­æ“ä½œã€‚å†æ¯”å¦‚ï¼ša++ï¼› è¿™ä¸ªæ“ä½œå®é™…æ˜¯a = a + 1ï¼›æ˜¯å¯åˆ†å‰²çš„ï¼Œæ‰€ä»¥ä»–ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œã€‚éåŸå­æ“ä½œéƒ½ä¼šå­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œéœ€è¦æˆ‘ä»¬ä½¿ç”¨åŒæ­¥æŠ€æœ¯ï¼ˆsychronizedï¼‰æ¥è®©å®ƒå˜æˆä¸€ä¸ªåŸå­æ“ä½œã€‚ä¸€ä¸ªæ“ä½œæ˜¯åŸå­æ“ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬ç§°å®ƒå…·æœ‰åŸå­æ€§ã€‚javaçš„concurrentåŒ…ä¸‹æä¾›äº†ä¸€äº›åŸå­ç±»ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é˜…è¯»APIæ¥äº†è§£è¿™äº›åŸå­ç±»çš„ç”¨æ³•ã€‚æ¯”å¦‚ï¼šAtomicIntegerã€AtomicLongã€AtomicReferenceç­‰ã€‚ åœ¨ Java ä¸­ synchronized å’Œåœ¨ lockã€unlock ä¸­æ“ä½œä¿è¯åŸå­æ€§ã€‚ æœ‰åºæ€§ï¼š Java è¯­è¨€æä¾›äº† volatile å’Œ synchronized ä¸¤ä¸ªå…³é”®å­—æ¥ä¿è¯çº¿ç¨‹ä¹‹é—´æ“ä½œçš„æœ‰åºæ€§ï¼Œvolatile æ˜¯å› ä¸ºå…¶æœ¬èº«åŒ…å«â€œç¦æ­¢æŒ‡ä»¤é‡æ’åºâ€çš„è¯­ä¹‰ï¼Œsynchronized æ˜¯ç”±â€œä¸€ä¸ªå˜é‡åœ¨åŒä¸€ä¸ªæ—¶åˆ»åªå…è®¸ä¸€æ¡çº¿ç¨‹å¯¹å…¶è¿›è¡Œ lock æ“ä½œâ€è¿™æ¡è§„åˆ™è·å¾—çš„ï¼Œæ­¤è§„åˆ™å†³å®šäº†æŒæœ‰åŒä¸€ä¸ªå¯¹è±¡é”çš„ä¸¤ä¸ªåŒæ­¥å—åªèƒ½ä¸²è¡Œæ‰§è¡Œã€‚ happens-before åœ¨å­¦ä¹ Javaå†…å­˜æ¨¡å‹(JMM, Java Memory Model)æ—¶ï¼Œå…³äºçº¿ç¨‹ã€ä¸»å­˜(main memory)ã€å·¥ä½œå†…å­˜(working memory)ï¼Œè¿™äº›æ¦‚å¿µéƒ½æœ‰ç€å®ä½“çš„ç›¸äº’å¯¹åº”ï¼Œçº¿ç¨‹å¯èƒ½å¯¹åº”ç€ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ï¼Œä¸»å­˜å¯¹åº”ç€å†…å­˜ï¼Œè€Œå·¥ä½œå†…å­˜åˆ™æ¶µç›–äº†å†™ç¼“å†²åŒºã€ç¼“å­˜(cache)ã€å¯„å­˜å™¨ç­‰ä¸€ç³»åˆ—ä¸ºäº†æé«˜æ•°æ®å­˜å–æ•ˆç‡çš„æš‚å­˜åŒºåŸŸã€‚ä½†æ˜¯ï¼Œä¸€æåˆ°happens-beforeåŸåˆ™ï¼Œå°±è®©äººæœ‰ç‚¹â€œä¸ˆäºŒå’Œå°šæ‘¸ä¸ç€å¤´è„‘â€ã€‚è¿™ä¸ªæ¶µç›–äº†æ•´ä¸ªJMMä¸­å¯è§æ€§åŸåˆ™çš„è§„åˆ™ï¼Œç©¶ç«Ÿå¦‚ä½•ç†è§£ï¼Ÿ ä¸¤ä¸ªæ“ä½œé—´å…·æœ‰happens-beforeå…³ç³»ï¼Œå¹¶ä¸æ„å‘³ç€å‰ä¸€ä¸ªæ“ä½œå¿…é¡»è¦åœ¨åä¸€ä¸ªæ“ä½œä¹‹å‰æ‰§è¡Œã€‚happens-beforeä»…ä»…è¦æ±‚å‰ä¸€ä¸ªæ“ä½œå¯¹åä¸€ä¸ªæ“ä½œå¯è§ã€‚happens-beforeåŸåˆ™å’Œä¸€èˆ¬æ„ä¹‰ä¸Šçš„æ—¶é—´å…ˆåæ˜¯ä¸åŒçš„ æœ‰å“ªäº›happens-beforeè§„åˆ™ ç¨‹åºæ¬¡åºè§„åˆ™ï¼šåœ¨ä¸€ä¸ªçº¿ç¨‹å†…ä¸€æ®µä»£ç çš„æ‰§è¡Œç»“æœæ˜¯æœ‰åºçš„ã€‚å°±æ˜¯è¿˜ä¼šæŒ‡ä»¤é‡æ’ï¼Œä½†æ˜¯éšä¾¿å®ƒæ€ä¹ˆæ’ï¼Œç»“æœæ˜¯æŒ‰ç…§æˆ‘ä»¬ä»£ç çš„é¡ºåºç”Ÿæˆçš„ä¸ä¼šå˜ã€‚ ç®¡ç¨‹é”å®šè§„åˆ™ï¼šå°±æ˜¯æ— è®ºæ˜¯åœ¨å•çº¿ç¨‹ç¯å¢ƒè¿˜æ˜¯å¤šçº¿ç¨‹ç¯å¢ƒï¼Œå¯¹äºåŒä¸€ä¸ªé”æ¥è¯´ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹è¿™ä¸ªé”è§£é”ä¹‹åï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è·å–äº†è¿™ä¸ªé”éƒ½èƒ½çœ‹åˆ°å‰ä¸€ä¸ªçº¿ç¨‹çš„æ“ä½œç»“æœï¼(ç®¡ç¨‹æ˜¯ä¸€ç§é€šç”¨çš„åŒæ­¥åŸè¯­ï¼Œsynchronizedå°±æ˜¯ç®¡ç¨‹çš„å®ç°ï¼‰ volatileå˜é‡è§„åˆ™ï¼šå°±æ˜¯å¦‚æœä¸€ä¸ªçº¿ç¨‹å…ˆå»å†™ä¸€ä¸ªvolatileå˜é‡ï¼Œç„¶åä¸€ä¸ªçº¿ç¨‹å»è¯»è¿™ä¸ªå˜é‡ï¼Œé‚£ä¹ˆè¿™ä¸ªå†™æ“ä½œçš„ç»“æœä¸€å®šå¯¹è¯»çš„è¿™ä¸ªçº¿ç¨‹å¯è§ã€‚ çº¿ç¨‹å¯åŠ¨è§„åˆ™ï¼šåœ¨ä¸»çº¿ç¨‹Aæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯åŠ¨å­çº¿ç¨‹Bï¼Œé‚£ä¹ˆçº¿ç¨‹Aåœ¨å¯åŠ¨å­çº¿ç¨‹Bä¹‹å‰å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹ç»“æœå¯¹çº¿ç¨‹Bå¯è§ã€‚ çº¿ç¨‹ç»ˆæ­¢è§„åˆ™ï¼šåœ¨ä¸»çº¿ç¨‹Aæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå­çº¿ç¨‹Bç»ˆæ­¢ï¼Œé‚£ä¹ˆçº¿ç¨‹Båœ¨ç»ˆæ­¢ä¹‹å‰å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹ç»“æœåœ¨çº¿ç¨‹Aä¸­å¯è§ã€‚ä¹Ÿç§°çº¿ç¨‹join()è§„åˆ™ã€‚ çº¿ç¨‹ä¸­æ–­è§„åˆ™ï¼šå¯¹çº¿ç¨‹interrupt()æ–¹æ³•çš„è°ƒç”¨å…ˆè¡Œå‘ç”Ÿäºè¢«ä¸­æ–­çº¿ç¨‹ä»£ç æ£€æµ‹åˆ°ä¸­æ–­äº‹ä»¶çš„å‘ç”Ÿï¼Œå¯ä»¥é€šè¿‡Thread.interrupted()æ£€æµ‹åˆ°æ˜¯å¦å‘ç”Ÿä¸­æ–­ã€‚ ä¼ é€’æ€§è§„åˆ™ï¼šè¿™ä¸ªç®€å•çš„ï¼Œå°±æ˜¯happens-beforeåŸåˆ™å…·æœ‰ä¼ é€’æ€§ï¼Œå³hb(A, B) ï¼Œ hb(B, C)ï¼Œé‚£ä¹ˆhb(A, C)ã€‚ å¯¹è±¡ç»ˆç»“è§„åˆ™ï¼šè¿™ä¸ªä¹Ÿç®€å•çš„ï¼Œå°±æ˜¯ä¸€ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–çš„å®Œæˆï¼Œä¹Ÿå°±æ˜¯æ„é€ å‡½æ•°æ‰§è¡Œçš„ç»“æŸä¸€å®š happens-beforeå®ƒçš„finalize()æ–¹æ³•ã€‚ é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹ é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹æ˜¯ä¸€ä¸ªè¢«è®¡ç®—æœºç§‘å­¦å®¶ç†æƒ³åŒ–äº†çš„ç†è®ºå‚è€ƒæ¨¡å‹ï¼Œå®ƒä¸ºç¨‹åºå‘˜æä¾›äº†æå¼ºçš„å†…å­˜å¯è§æ€§ä¿è¯ã€‚é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹æœ‰ä¸¤å¤§ç‰¹æ€§ï¼š ä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ‰€æœ‰æ“ä½œå¿…é¡»æŒ‰ç…§ç¨‹åºçš„é¡ºåºæ¥æ‰§è¡Œã€‚ ï¼ˆä¸ç®¡ç¨‹åºæ˜¯å¦åŒæ­¥ï¼‰æ‰€æœ‰çº¿ç¨‹éƒ½åªèƒ½çœ‹åˆ°ä¸€ä¸ªå•ä¸€çš„æ“ä½œæ‰§è¡Œé¡ºåºã€‚åœ¨é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹ä¸­ï¼Œæ¯ä¸ªæ“ä½œéƒ½å¿…é¡»åŸå­æ‰§è¡Œä¸”ç«‹åˆ»å¯¹æ‰€æœ‰çº¿ç¨‹å¯è§ã€‚ åœ¨æ¦‚å¿µä¸Šï¼Œé¡ºåºä¸€è‡´æ€§æ¨¡å‹æœ‰ä¸€ä¸ªå•ä¸€çš„å…¨å±€å†…å­˜ï¼Œè¿™ä¸ªå†…å­˜é€šè¿‡ä¸€ä¸ªå¼€å…³å¯ä»¥è¿æ¥åˆ°ä»»æ„ä¸€ä¸ªçº¿ç¨‹ã€‚åŒæ—¶ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹å¿…é¡»æŒ‰ç¨‹åºçš„é¡ºåºæ¥æ‰§è¡Œå†…å­˜è¯»/å†™æ“ä½œã€‚åœ¨ä»»æ„æ—¶é—´ç‚¹æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è¿æ¥åˆ°å†…å­˜ã€‚å½“å¤šä¸ªçº¿ç¨‹å¹¶å‘æ‰§è¡Œæ—¶ï¼Œå¼€å…³è£…ç½®èƒ½æŠŠæ‰€æœ‰çº¿ç¨‹çš„æ‰€æœ‰å†…å­˜è¯»/å†™æ“ä½œä¸²è¡ŒåŒ–ã€‚ ä¸ºäº†æ›´å¥½çš„ç†è§£ï¼Œä¸‹é¢æˆ‘ä»¬æ¥å¯¹é¡ºåºä¸€è‡´æ€§æ¨¡å‹çš„ç‰¹æ€§åšè¿›ä¸€æ­¥çš„è¯´æ˜ã€‚ å‡è®¾æœ‰ä¸¤ä¸ªçº¿ç¨‹Aå’ŒBå¹¶å‘æ‰§è¡Œã€‚å…¶ä¸­Açº¿ç¨‹æœ‰ä¸‰ä¸ªæ“ä½œï¼Œå®ƒä»¬åœ¨ç¨‹åºä¸­çš„é¡ºåºæ˜¯ï¼šA1-&gt;A2-&gt;A3ã€‚Bçº¿ç¨‹ä¹Ÿæœ‰ä¸‰ä¸ªæ“ä½œï¼Œå®ƒä»¬åœ¨ç¨‹åºä¸­çš„é¡ºåºæ˜¯ï¼šB1-&gt;B2-&gt;B3ã€‚ å‡è®¾è¿™ä¸¤ä¸ªçº¿ç¨‹ä½¿ç”¨ç›‘è§†å™¨æ¥æ­£ç¡®åŒæ­¥ï¼šAçº¿ç¨‹çš„ä¸‰ä¸ªæ“ä½œæ‰§è¡Œåé‡Šæ”¾ç›‘è§†å™¨ï¼ŒéšåBçº¿ç¨‹è·å–åŒä¸€ä¸ªç›‘è§†å™¨ã€‚ ç°åœ¨æˆ‘ä»¬å†å‡è®¾è¿™ä¸¤ä¸ªçº¿ç¨‹æ²¡æœ‰åšåŒæ­¥ï¼ŒæœªåŒæ­¥ç¨‹åºåœ¨é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¸­è™½ç„¶æ•´ä½“æ‰§è¡Œé¡ºåºæ˜¯æ— åºçš„ï¼Œä½†æ‰€æœ‰çº¿ç¨‹éƒ½åªèƒ½çœ‹åˆ°ä¸€ä¸ªä¸€è‡´çš„æ•´ä½“æ‰§è¡Œé¡ºåºã€‚å‡è®¾ï¼Œçº¿ç¨‹Aå’ŒBçœ‹åˆ°çš„æ‰§è¡Œé¡ºåºéƒ½æ˜¯ï¼šB1-&gt;A1-&gt;A2-&gt;B2-&gt;A3-&gt;B3ã€‚ä¹‹æ‰€ä»¥èƒ½å¾—åˆ°è¿™ä¸ªä¿è¯æ˜¯å› ä¸ºé¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹ä¸­çš„æ¯ä¸ªæ“ä½œå¿…é¡»ç«‹å³å¯¹ä»»æ„çº¿ç¨‹å¯è§ã€‚ ä½†æ˜¯ï¼Œåœ¨JMMä¸­å°±æ²¡æœ‰è¿™ä¸ªä¿è¯ã€‚æœªåŒæ­¥ç¨‹åºåœ¨JMMä¸­ä¸ä½†æ•´ä½“çš„æ‰§è¡Œé¡ºåºæ˜¯æ— åºçš„ï¼Œè€Œä¸”æ‰€æœ‰çº¿ç¨‹çœ‹åˆ°çš„æ“ä½œæ‰§è¡Œé¡ºåºä¹Ÿå¯èƒ½ä¸ä¸€è‡´ã€‚æ¯”å¦‚ï¼Œåœ¨å½“å‰çº¿ç¨‹æŠŠå†™è¿‡çš„æ•°æ®ç¼“å­˜åœ¨æœ¬åœ°å†…å­˜ä¸­ï¼Œä¸”è¿˜æ²¡æœ‰åˆ·æ–°åˆ°ä¸»å†…å­˜ä¹‹å‰ï¼Œè¿™ä¸ªå†™æ“ä½œä»…å¯¹å½“å‰çº¿ç¨‹å¯è§ï¼›ä»å…¶ä»–çº¿ç¨‹çš„è§’åº¦æ¥è§‚å¯Ÿï¼Œä¼šè®¤ä¸ºè¿™ä¸ªå†™æ“ä½œæ ¹æœ¬è¿˜æ²¡æœ‰è¢«å½“å‰çº¿ç¨‹æ‰§è¡Œã€‚åªæœ‰å½“å‰çº¿ç¨‹æŠŠæœ¬åœ°å†…å­˜ä¸­å†™è¿‡çš„æ•°æ®åˆ·æ–°åˆ°ä¸»å†…å­˜ä¹‹åï¼Œè¿™ä¸ªå†™æ“ä½œæ‰èƒ½å¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“å‰çº¿ç¨‹å’Œå…¶å®ƒçº¿ç¨‹çœ‹åˆ°çš„æ“ä½œæ‰§è¡Œé¡ºåºå°†ä¸ä¸€è‡´ã€‚ Javaå†…å­˜æ¨¡å‹ å…³äºJavaå†…å­˜æ¨¡å‹çš„ä¹¦ç±æ–‡ç« ï¼Œæ±—ç‰›å……æ ‹ï¼Œæƒ³å¿…å¤§å®¶ä¹Ÿéƒ½æœ‰è‡ªå·±çš„ç†è§£ã€‚é‚£å°±ä»…ä»…ç”±ä¸Šé¢çš„é¡ºåºä¸€è‡´æ€§æ¨¡å‹æ¥å¼•å‡ºJMMï¼Œçœ‹çœ‹å…·ä½“åŒºåˆ«åœ¨å“ªã€‚ å¯ä»¥çœ‹å‡ºï¼Œæœ¬åœ°å†…å­˜æ˜¯ä¸€ä¸ªæ˜æ˜¾åŒºåˆ«äºé¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹çš„åœ°æ–¹ã€‚äº‹å®ä¸Šï¼Œé€ æˆå¯è§æ€§é—®é¢˜çš„æ ¹æºä¹‹ä¸€ï¼Œå°±åœ¨äºè¿™ä¸ªæœ¬åœ°å†…å­˜ï¼ˆå¼ºè°ƒä¸€ä¸‹ï¼ŒåŒ…æ‹¬ç¼“å­˜ã€å†™ç¼“å†²å’Œå¯„å­˜å™¨ç­‰ç­‰ï¼‰ã€‚æœ¬åœ°å†…å­˜ä½¿å¾—æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰äº†è‡ªå·±çš„ç§æœ‰å­˜å‚¨ï¼Œå¤§éƒ¨åˆ†æ—¶é—´å¯¹æ•°æ®çš„å­˜å–å·¥ä½œéƒ½åœ¨è¿™ä¸ªåŒºåŸŸå®Œæˆã€‚ä½†æ˜¯æˆ‘ä»¬å†™ä¸€ä¸ªæ•°æ®ï¼Œæ˜¯ç›´åˆ°æ•°æ®å†™åˆ°ä¸»å­˜ä¸­æ‰ç®—çœŸæ­£å®Œæˆã€‚å®é™…ä¸Šæ¯ä¸ªçº¿ç¨‹ç»´æŠ¤äº†ä¸€ä¸ªå‰¯æœ¬ï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½åœ¨è‡ªå·±çš„æœ¬åœ°å†…å­˜ä¸­ä¸æ–­åœ°è¯»/å†™ä¸€ä¸ªå…±äº«å†…å­˜ä¸­çš„æ•°æ®çš„å‰¯æœ¬ã€‚å•çº¿ç¨‹æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå‰¯æœ¬ä¸ä¼šé€ æˆä»»ä½•é—®é¢˜ï¼›ä½†ä¸€æ—¦åˆ°å¤šçº¿ç¨‹ï¼Œæœ‰ä¸€ä¸ªçº¿ç¨‹å°†å˜é‡å†™åˆ°ä¸»å­˜ï¼Œå…¶ä»–çº¿ç¨‹å´ä¸çŸ¥é“ï¼Œå…¶ä»–çº¿ç¨‹çš„å‰¯æœ¬å°±éƒ½è¿‡æœŸã€‚æ¯”å¦‚ï¼Œç”±äºæœ¬åœ°å†…å­˜çš„å­˜åœ¨ï¼Œç¨‹åºå‘˜å†™çš„ä¸€æ®µä»£ç ï¼Œå†™ä¸€ä¸ªæ™®é€šçš„å…±äº«å˜é‡ï¼Œå…¶å¯èƒ½å…ˆè¢«å†™åˆ°ç¼“å†²åŒºï¼Œé‚£æŒ‡ä»¤å®Œæˆçš„æ—¶é—´å°±è¢«æ¨è¿Ÿäº†ï¼Œå®é™…è¡¨ç°ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„â€œæŒ‡ä»¤é‡æ’åºâ€ï¼ˆè¿™å®é™…ä¸Šæ˜¯å†…å­˜æ¨¡å‹å±‚é¢çš„é‡æ’åºï¼Œé‡æ’åºè¿˜å¯èƒ½æ˜¯ç¼–è¯‘å™¨ã€æœºå™¨æŒ‡ä»¤å±‚çº§ä¸Šçš„ä¹±åºï¼‰ã€‚ å› æ­¤ï¼Œåœ¨Javaå†…å­˜æ¨¡å‹ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹ä¸å†åƒé¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¸­é‚£æ ·æœ‰ç¡®å®šçš„æŒ‡ä»¤æ‰§è¡Œè§†å›¾ï¼Œä¸€ä¸ªæŒ‡ä»¤å¯èƒ½è¢«é‡æ’äº†ã€‚ä»ä¸€ä¸ªçº¿ç¨‹çš„è§’åº¦çœ‹ï¼Œå…¶ä»–çº¿ç¨‹ï¼ˆç”šè‡³æ˜¯è¿™ä¸ªçº¿ç¨‹æœ¬èº«ï¼‰æ‰§è¡Œçš„æŒ‡ä»¤é¡ºåºæœ‰å¤šç§å¯èƒ½æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœå¯¹å…¶ä»–çº¿ç¨‹çš„å¯è§æ€§æ— æ³•ä¿è¯ã€‚ æ€»ç»“ä¸€ä¸‹å¯¼è‡´å¯è§æ€§é—®é¢˜çš„åŸå› ï¼š æ•°æ®çš„å†™æ— æ³•åŠæ—¶é€šçŸ¥åˆ°åˆ«çš„çº¿ç¨‹ï¼Œå¦‚å†™ç¼“å†²åŒºçš„å¼•å…¥ çº¿ç¨‹ä¸èƒ½åŠæ—¶è¯»åˆ°å…¶ä»–çº¿ç¨‹å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹ï¼Œå¦‚ç¼“å­˜çš„ä½¿ç”¨ å„ç§å±‚çº§ä¸Šå¯¹æŒ‡ä»¤çš„é‡æ’åºï¼Œå¯¼è‡´æŒ‡ä»¤æ‰§è¡Œçš„é¡ºåºæ— æ³•ç¡®å®š æ‰€ä»¥è¦è§£å†³å¯è§æ€§é—®é¢˜ï¼Œæœ¬è´¨æ˜¯è¦è®©çº¿ç¨‹å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹ï¼ŒåŠæ—¶åŒæ­¥åˆ°å…¶ä»–çº¿ç¨‹ã€‚æˆ‘ä»¬æ‰€ä½¿ç”¨çš„ç¡¬ä»¶æ¶æ„ä¸‹ï¼Œä¸å…·å¤‡é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹çš„å…¨å±€ä¸€è‡´çš„æŒ‡ä»¤æ‰§è¡Œé¡ºåºï¼Œè®¨è®ºæŒ‡ä»¤æ‰§è¡Œçš„æ—¶é—´å…ˆåå¹¶ä¸å­˜åœ¨æ„ä¹‰æˆ–è€…è¯´æ ¹æœ¬æ²¡åŠæ³•ç¡®å®šæ—¶é—´ä¸Šçš„å…ˆåã€‚å¯ä»¥çœ‹çœ‹ä¸‹é¢ç¨‹åºï¼Œæ¯ä¸ªçº¿ç¨‹ä¸­çš„flagå‰¯æœ¬ä¼šåœ¨å¤šä¹…åè¢«æ›´æ–°å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼šæ— æ³•ç¡®å®šï¼Œçœ‹çº¿ç¨‹ä½•æ—¶åˆ·æ–°è‡ªå·±çš„æœ¬åœ°å†…å­˜ã€‚ public class testVisibility { public static boolean flag = false; public static void main(String[] args) { List&lt;Thread&gt; thdList = new ArrayList&lt;Thread&gt;(); for(int i = 0; i &lt; 10; i++) { Thread t = new Thread(new Runnable(){ public void run() { while (true) { if (flag) { // å¤šè¿è¡Œå‡ æ¬¡ï¼Œå¯èƒ½å¹¶ä¸ä¼šæ‰“å°å‡ºæ¥ä¹Ÿå¯èƒ½ä¼šæ‰“å°å‡ºæ¥ // å¦‚æœä¸æ‰“å°ï¼Œåˆ™è¡¨ç¤ºThreadçœ‹åˆ°çš„ä»ç„¶æ˜¯æœ¬åœ°å†…å­˜ä¸­çš„flag // å¯ä»¥å°è¯•å°†flagå˜æˆvolatileå†è¿è¡Œå‡ æ¬¡çœ‹çœ‹ System.out.println(Thread.currentThread().getId() + &quot; is true now&quot;); } } } }); t.start(); thdList.add(t); } flag = true; System.out.println(&quot;set flag true&quot;); // ç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œæ¯• try { for (Thread t : thdList) { t.join(); } } catch (Exception e) { } } } é‚£ä¹ˆæ—¢ç„¶æˆ‘ä»¬æ— æ³•è®¨è®ºæŒ‡ä»¤æ‰§è¡Œçš„å…ˆåï¼Œä¹Ÿä¸éœ€è¦è®¨è®ºï¼Œæˆ‘ä»¬å®é™…åªæƒ³çŸ¥é“æŸçº¿ç¨‹çš„æ“ä½œå¯¹å¦ä¸€ä¸ªçº¿ç¨‹æ˜¯å¦å¯è§ï¼Œäºæ˜¯å°±è§„å®šäº†happens-beforeè¿™ä¸ªå¯è§æ€§åŸåˆ™ï¼Œç¨‹åºå‘˜å¯ä»¥åŸºäºè¿™ä¸ªåŸåˆ™è¿›è¡Œå¯è§æ€§çš„åˆ¤æ–­ã€‚ VolatileåŸç† Javaè¯­è¨€æä¾›äº†ä¸€ç§ç¨å¼±çš„åŒæ­¥æœºåˆ¶ï¼Œå³volatileå˜é‡ï¼Œç”¨æ¥ç¡®ä¿å°†å˜é‡çš„æ›´æ–°æ“ä½œé€šçŸ¥åˆ°å…¶ä»–çº¿ç¨‹ã€‚å½“æŠŠå˜é‡å£°æ˜ä¸ºvolatileç±»å‹åï¼Œç¼–è¯‘å™¨ä¸è¿è¡Œæ—¶éƒ½ä¼šæ³¨æ„åˆ°è¿™ä¸ªå˜é‡æ˜¯å…±äº«çš„ï¼Œå› æ­¤ä¸ä¼šå°†è¯¥å˜é‡ä¸Šçš„æ“ä½œä¸å…¶ä»–å†…å­˜æ“ä½œä¸€èµ·é‡æ’åºã€‚volatileå˜é‡ä¸ä¼šè¢«ç¼“å­˜åœ¨å¯„å­˜å™¨æˆ–è€…å¯¹å…¶ä»–å¤„ç†å™¨ä¸å¯è§çš„åœ°æ–¹ï¼Œå› æ­¤åœ¨è¯»å–volatileç±»å‹çš„å˜é‡æ—¶æ€»ä¼šè¿”å›æœ€æ–°å†™å…¥çš„å€¼ã€‚ åœ¨è®¿é—®volatileå˜é‡æ—¶ä¸ä¼šæ‰§è¡ŒåŠ é”æ“ä½œï¼Œå› æ­¤ä¹Ÿå°±ä¸ä¼šä½¿æ‰§è¡Œçº¿ç¨‹é˜»å¡ï¼Œå› æ­¤volatileå˜é‡æ˜¯ä¸€ç§æ¯”sychronizedå…³é”®å­—æ›´è½»é‡çº§çš„åŒæ­¥æœºåˆ¶ã€‚ å½“å¯¹é volatile å˜é‡è¿›è¡Œè¯»å†™çš„æ—¶å€™ï¼Œæ¯ä¸ªçº¿ç¨‹å…ˆä»å†…å­˜æ‹·è´å˜é‡åˆ°CPUç¼“å­˜ä¸­ã€‚å¦‚æœè®¡ç®—æœºæœ‰å¤šä¸ªCPUï¼Œæ¯ä¸ªçº¿ç¨‹å¯èƒ½åœ¨ä¸åŒçš„CPUä¸Šè¢«å¤„ç†ï¼Œè¿™æ„å‘³ç€æ¯ä¸ªçº¿ç¨‹å¯ä»¥æ‹·è´åˆ°ä¸åŒçš„ CPU cache ä¸­ã€‚ è€Œå£°æ˜å˜é‡æ˜¯ volatile çš„ï¼ŒJVM ä¿è¯äº†æ¯æ¬¡è¯»å˜é‡éƒ½ä»å†…å­˜ä¸­è¯»ï¼Œè·³è¿‡ CPU cache è¿™ä¸€æ­¥ã€‚ å½“ä¸€ä¸ªå˜é‡å®šä¹‰ä¸º volatile ä¹‹åï¼Œå°†å…·å¤‡ä¸¤ç§ç‰¹æ€§ï¼š 1. ä¿è¯æ­¤å˜é‡å¯¹æ‰€æœ‰çš„çº¿ç¨‹çš„å¯è§æ€§ï¼Œè¿™é‡Œçš„â€œå¯è§æ€§â€ï¼Œå¦‚æœ¬æ–‡å¼€å¤´æ‰€è¿°ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å€¼ï¼Œvolatile ä¿è¯äº†æ–°å€¼èƒ½ç«‹å³åŒæ­¥åˆ°ä¸»å†…å­˜ï¼Œä»¥åŠæ¯æ¬¡ä½¿ç”¨å‰ç«‹å³ä»ä¸»å†…å­˜åˆ·æ–°ã€‚ä½†æ™®é€šå˜é‡åšä¸åˆ°è¿™ç‚¹ï¼Œæ™®é€šå˜é‡çš„å€¼åœ¨çº¿ç¨‹é—´ä¼ é€’å‡éœ€è¦é€šè¿‡ä¸»å†…å­˜æ¥å®Œæˆã€‚ 2. ç¦æ­¢æŒ‡ä»¤é‡æ’åºä¼˜åŒ–ã€‚æœ‰volatileä¿®é¥°çš„å˜é‡ï¼Œèµ‹å€¼åå¤šæ‰§è¡Œäº†ä¸€ä¸ªæ·»åŠ å†…å­˜å±éšœæ“ä½œï¼ˆæŒ‡ä»¤é‡æ’åºæ—¶ä¸èƒ½æŠŠåé¢çš„æŒ‡ä»¤é‡æ’åºåˆ°å†…å­˜å±éšœä¹‹å‰çš„ä½ç½®ï¼‰ï¼Œåªæœ‰ä¸€ä¸ªCPUè®¿é—®å†…å­˜æ—¶ï¼Œå¹¶ä¸éœ€è¦å†…å­˜å±éšœï¼›ï¼ˆä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’åºï¼šæ˜¯æŒ‡CPUé‡‡ç”¨äº†å…è®¸å°†å¤šæ¡æŒ‡ä»¤ä¸æŒ‰ç¨‹åºè§„å®šçš„é¡ºåºåˆ†å¼€å‘é€ç»™å„ç›¸åº”ç”µè·¯å•å…ƒå¤„ç†ï¼‰ã€‚ volatile æ€§èƒ½ï¼š volatile çš„è¯»æ€§èƒ½æ¶ˆè€—ä¸æ™®é€šå˜é‡å‡ ä¹ç›¸åŒï¼Œä½†æ˜¯å†™æ“ä½œç¨æ…¢ï¼Œå› ä¸ºå®ƒéœ€è¦åœ¨æœ¬åœ°ä»£ç ä¸­æ’å…¥è®¸å¤šå†…å­˜å±éšœæŒ‡ä»¤æ¥ä¿è¯å¤„ç†å™¨ä¸å‘ç”Ÿä¹±åºæ‰§è¡Œã€‚ volatileå˜é‡ volatileå°±æ˜¯ä¸€ä¸ªè·µè¡Œhappens-beforeçš„å…³é”®å­—ã€‚çœ‹ä»¥ä¸‹å¯¹volatileçš„æè¿°ï¼Œå°±ä¸éš¾çŸ¥é“ï¼Œhappens-beforeæŒ‡çš„æ˜¯çº¿ç¨‹æ¥æ”¶å…¶ä»–çº¿ç¨‹ä¿®æ”¹å…±äº«å˜é‡çš„æ¶ˆæ¯ä¸è¯¥çº¿ç¨‹è¯»å–å…±äº«å˜é‡çš„å…ˆåå…³ç³»ã€‚å¤§å®¶å¯ä»¥å†ç»†æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæ²¡æœ‰happens-beforeåŸåˆ™ï¼Œå²‚ä¸æ˜¯ç›¸å½“äºä¸€ä¸ªçº¿ç¨‹è¯»å–è‡ªå·±çš„å…±äº«å˜é‡å‰¯æœ¬æ—¶ï¼Œå…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿™ä¸ªå˜é‡çš„æ¶ˆæ¯è¿˜æ²¡æœ‰åŒæ­¥è¿‡æ¥ï¼Ÿè¿™å°±æ˜¯å¯è§æ€§é—®é¢˜ã€‚ volatileå˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ªvolatileçš„å†™ï¼Œhappens-beforeäºä»»æ„åç»­å¯¹è¿™ä¸ªvolatileå˜é‡çš„è¯»ã€‚ çº¿ç¨‹Aå†™ä¸€ä¸ªvolatileå˜é‡ï¼Œå®è´¨ä¸Šæ˜¯çº¿ç¨‹Aå‘æ¥ä¸‹æ¥è¦è·å–è¿™ä¸ªé”çš„æŸä¸ªçº¿ç¨‹å‘å‡ºäº†ï¼ˆçº¿ç¨‹Aå¯¹å…±äº«å˜é‡ä¿®æ”¹çš„ï¼‰æ¶ˆæ¯ã€‚ çº¿ç¨‹Bè¯»ä¸€ä¸ªvolatileå˜é‡ï¼Œå®è´¨ä¸Šæ˜¯çº¿ç¨‹Bæ¥æ”¶äº†ä¹‹å‰æŸä¸ªçº¿ç¨‹å‘å‡ºçš„ï¼ˆå¯¹å…±äº«å˜é‡æ‰€åšä¿®æ”¹çš„ï¼‰æ¶ˆæ¯ã€‚ çº¿ç¨‹Aå†™ä¸€ä¸ªvolatileå˜é‡ï¼Œéšåçº¿ç¨‹Bè¯»è¿™ä¸ªå˜é‡ï¼Œè¿™ä¸ªè¿‡ç¨‹å®è´¨ä¸Šæ˜¯çº¿ç¨‹Aé€šè¿‡ä¸»å†…å­˜å‘çº¿ç¨‹Bå‘é€æ¶ˆæ¯ã€‚ å…¶å®ä»”ç»†çœ‹çœ‹volatileçš„å®ç°æ–¹å¼ï¼Œå®é™…ä¸Šå°±æ˜¯é™åˆ¶äº†é‡æ’åºçš„èŒƒå›´â€”â€”åŠ å…¥å†…å­˜å±éšœ(Memory Barrier or Memory Fence)ã€‚ä¹Ÿå³æ˜¯è¯´ï¼Œå…è®¸æŒ‡ä»¤æ‰§è¡Œçš„æ—¶é—´å…ˆåé¡ºåºåœ¨ä¸€å®šèŒƒå›´å†…å‘ç”Ÿå˜åŒ–ï¼Œè€Œè¿™ä¸ªèŒƒå›´å°±æ˜¯æ ¹æ®happens-beforeåŸåˆ™æ¥è§„å®šã€‚å†…å­˜å±éšœæ¦‚æ‹¬èµ·æ¥æœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼š ä½¿å†™ç¼“å†²åŒºçš„å†…å®¹åˆ·æ–°åˆ°å†…å­˜ï¼Œä¿è¯å¯¹å…¶ä»–çº¿ç¨‹/CPUå¯è§ ç¦æ­¢è¯»å†™æ“ä½œçš„è¶Šè¿‡å†…å­˜å±éšœè¿›è¡Œé‡æ’åº æ¯ä¸ªvolatileå†™æ“ä½œçš„å‰é¢æ’å…¥ä¸€ä¸ªStoreStoreå±éšœ æ¯ä¸ªvolatileå†™æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ªStoreLoadå±éšœ æ¯ä¸ªvolatileè¯»æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ªLoadLoadå±éšœ æ¯ä¸ªvolatileè¯»æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ªLoadStoreå±éšœ å…³äºå†…å­˜å±éšœçš„ç§ç±»ï¼Œè¿™é‡Œä¸æ˜¯ç ”ç©¶çš„é‡ç‚¹ã€‚ä¸€ç›´å›°æ‰°æˆ‘çš„æ˜¯ï¼Œåœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸‹ï¼Œè¿™ä¸ªå±éšœå¦‚ä½•èƒ½è·¨è¶Šå¤„ç†å™¨æ¥é˜»æ­¢æ“ä½œæ‰§è¡Œçš„é¡ºåºå‘¢ï¼Ÿæ¯”å¦‚ä¸‹é¢çš„è¯»å†™æ“ä½œï¼š public static volatile int race = 0; // Thread A public static void save(int src) { race = src; } // Thread B public static int load() { return race; } è¿™å°±è¦æåˆ°ä»æ“ä½œç³»ç»Ÿåˆ°ç¡¬ä»¶å±‚é¢çš„è§‚å¿µè½¬æ¢ï¼Œå¯ä»¥å‚çœ‹æ€»çº¿äº‹åŠ¡ï¼ˆBus transactionï¼‰çš„æ¦‚å¿µã€‚å½“CPUè¦ä¸å†…å­˜è¿›è¡Œæ•°æ®äº¤æ¢çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ€»çº¿ä¼šåŒæ­¥æ•°æ®äº¤æ¢æ“ä½œï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªCPUè¿›è¡Œè¯»/å†™å†…å­˜ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰€çœ‹åˆ°çš„å¤šå¤„ç†å™¨å¹¶è¡Œï¼Œå¹¶è¡Œçš„æ˜¯CPUçš„è®¡ç®—èµ„æºã€‚åœ¨æ€»çº¿çœ‹æ¥ï¼Œå¯¹äºå­˜å‚¨çš„è¯»å†™æ“ä½œå°±æ˜¯ä¸²è¡Œçš„ï¼Œæ˜¯æŒ‰ç…§ä¸€å®šé¡ºåºçš„ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆä¸€ä¸ªå†…å­˜å±éšœèƒ½å¤Ÿè·¨è¶Šå¤„ç†å™¨å»é™åˆ¶è¯»å†™ã€å»å®Œæˆé€šä¿¡ã€‚ ","link":"https://tianxiawuhao.github.io/67CnuNlVA/"},{"title":"Javaå†…å­˜æ¨¡å‹JMM","content":"ä¸ºä»€ä¹ˆè¦æœ‰å†…å­˜æ¨¡å‹ åœ¨ä»‹ç»Javaå†…å­˜æ¨¡å‹ä¹‹å‰ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹åˆ°åº•ä»€ä¹ˆæ˜¯è®¡ç®—æœºå†…å­˜æ¨¡å‹ï¼Œç„¶åå†æ¥çœ‹Javaå†…å­˜æ¨¡å‹åœ¨è®¡ç®—æœºå†…å­˜æ¨¡å‹çš„åŸºç¡€ä¸Šåšäº†å“ªäº›äº‹æƒ…ã€‚è¦è¯´è®¡ç®—æœºçš„å†…å­˜æ¨¡å‹ï¼Œå°±è¦è¯´ä¸€ä¸‹ä¸€æ®µå¤è€çš„å†å²ï¼Œçœ‹ä¸€ä¸‹ä¸ºä»€ä¹ˆè¦æœ‰å†…å­˜æ¨¡å‹ã€‚ å†…å­˜æ¨¡å‹ï¼Œè‹±æ–‡åMemory Modelï¼Œä»–æ˜¯ä¸€ä¸ªå¾ˆè€çš„è€å¤è‘£äº†ã€‚ä»–æ˜¯ä¸è®¡ç®—æœºç¡¬ä»¶æœ‰å…³çš„ä¸€ä¸ªæ¦‚å¿µã€‚é‚£ä¹ˆæˆ‘å…ˆç»™ä½ ä»‹ç»ä¸‹ä»–å’Œç¡¬ä»¶åˆ°åº•æœ‰å•¥å…³ç³»ã€‚ CPUå’Œç¼“å­˜ä¸€è‡´æ€§ æˆ‘ä»¬åº”è¯¥éƒ½çŸ¥é“ï¼Œè®¡ç®—æœºåœ¨æ‰§è¡Œç¨‹åºçš„æ—¶å€™ï¼Œæ¯æ¡æŒ‡ä»¤éƒ½æ˜¯åœ¨CPUä¸­æ‰§è¡Œçš„ï¼Œè€Œæ‰§è¡Œçš„æ—¶å€™ï¼Œåˆå…ä¸äº†è¦å’Œæ•°æ®æ‰“äº¤é“ã€‚è€Œè®¡ç®—æœºä¸Šé¢çš„æ•°æ®ï¼Œæ˜¯å­˜æ”¾åœ¨ä¸»å­˜å½“ä¸­çš„ï¼Œä¹Ÿå°±æ˜¯è®¡ç®—æœºçš„ç‰©ç†å†…å­˜å•¦ã€‚ åˆšå¼€å§‹ï¼Œè¿˜ç›¸å®‰æ— äº‹çš„ï¼Œä½†æ˜¯éšç€CPUæŠ€æœ¯çš„å‘å±•ï¼ŒCPUçš„æ‰§è¡Œé€Ÿåº¦è¶Šæ¥è¶Šå¿«ã€‚è€Œç”±äºå†…å­˜çš„æŠ€æœ¯å¹¶æ²¡æœ‰å¤ªå¤§çš„å˜åŒ–ï¼Œæ‰€ä»¥ä»å†…å­˜ä¸­è¯»å–å’Œå†™å…¥æ•°æ®çš„è¿‡ç¨‹å’ŒCPUçš„æ‰§è¡Œé€Ÿåº¦æ¯”èµ·æ¥å·®è·å°±ä¼šè¶Šæ¥è¶Šå¤§,è¿™å°±å¯¼è‡´CPUæ¯æ¬¡æ“ä½œå†…å­˜éƒ½è¦è€—è´¹å¾ˆå¤šç­‰å¾…æ—¶é—´ã€‚ è¿™å°±åƒä¸€å®¶åˆ›ä¸šå…¬å¸ï¼Œåˆšå¼€å§‹ï¼Œåˆ›å§‹äººå’Œå‘˜å·¥ä¹‹é—´å·¥ä½œå…³ç³»å…¶ä¹èèï¼Œä½†æ˜¯éšç€åˆ›å§‹äººçš„èƒ½åŠ›å’Œé‡å¿ƒè¶Šæ¥è¶Šå¤§ï¼Œé€æ¸å’Œå‘˜å·¥ä¹‹é—´å‡ºç°äº†å·®è·ï¼Œæ™®é€šå‘˜å·¥åŸæ¥è¶Šè·Ÿä¸ä¸ŠCEOçš„è„šæ­¥ã€‚è€æ¿çš„æ¯ä¸€ä¸ªå‘½ä»¤ï¼Œä¼ åˆ°åˆ°åŸºå±‚å‘˜å·¥ä¹‹åï¼Œç”±äºåŸºå±‚å‘˜å·¥çš„ç†è§£èƒ½åŠ›ã€æ‰§è¡Œèƒ½åŠ›çš„æ¬ ç¼ºï¼Œå°±ä¼šè€—è´¹å¾ˆå¤šæ—¶é—´ã€‚è¿™ä¹Ÿå°±æ— å½¢ä¸­æ‹–æ…¢äº†æ•´å®¶å…¬å¸çš„å·¥ä½œæ•ˆç‡ã€‚ å¯æ˜¯ï¼Œä¸èƒ½å› ä¸ºå†…å­˜çš„è¯»å†™é€Ÿåº¦æ…¢ï¼Œå°±ä¸å‘å±•CPUæŠ€æœ¯äº†å§ï¼Œæ€»ä¸èƒ½è®©å†…å­˜æˆä¸ºè®¡ç®—æœºå¤„ç†çš„ç“¶é¢ˆå§ã€‚ æ‰€ä»¥ï¼Œäººä»¬æƒ³å‡ºæ¥äº†ä¸€ä¸ªå¥½çš„åŠæ³•ï¼Œå°±æ˜¯åœ¨CPUå’Œå†…å­˜ä¹‹é—´å¢åŠ é«˜é€Ÿç¼“å­˜ã€‚ç¼“å­˜çš„æ¦‚å¿µå¤§å®¶éƒ½çŸ¥é“ï¼Œå°±æ˜¯ä¿å­˜ä¸€ä»½æ•°æ®æ‹·è´ã€‚ä»–çš„ç‰¹ç‚¹æ˜¯é€Ÿåº¦å¿«ï¼Œå†…å­˜å°ï¼Œå¹¶ä¸”æ˜‚è´µã€‚ é‚£ä¹ˆï¼Œç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹å°±å˜æˆäº†ï¼š å½“ç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šå°†è¿ç®—éœ€è¦çš„æ•°æ®ä»ä¸»å­˜å¤åˆ¶ä¸€ä»½åˆ°CPUçš„é«˜é€Ÿç¼“å­˜å½“ä¸­ï¼Œé‚£ä¹ˆCPUè¿›è¡Œè®¡ç®—æ—¶å°±å¯ä»¥ç›´æ¥ä»å®ƒçš„é«˜é€Ÿç¼“å­˜è¯»å–æ•°æ®å’Œå‘å…¶ä¸­å†™å…¥æ•°æ®ï¼Œå½“è¿ç®—ç»“æŸä¹‹åï¼Œå†å°†é«˜é€Ÿç¼“å­˜ä¸­çš„æ•°æ®åˆ·æ–°åˆ°ä¸»å­˜å½“ä¸­ã€‚ ä¹‹åï¼Œè¿™å®¶å…¬å¸å¼€å§‹è®¾ç«‹ä¸­å±‚ç®¡ç†äººå‘˜ï¼Œç®¡ç†äººå‘˜ç›´æ¥å½’CEOé¢†å¯¼ï¼Œé¢†å¯¼æœ‰ä»€ä¹ˆæŒ‡ç¤ºï¼Œç›´æ¥å‘Šè¯‰ç®¡ç†äººå‘˜ï¼Œç„¶åå°±å¯ä»¥å»åšè‡ªå·±çš„äº‹æƒ…äº†ã€‚ç®¡ç†äººå‘˜è´Ÿè´£å»åè°ƒåº•å±‚å‘˜å·¥çš„å·¥ä½œã€‚å› ä¸ºç®¡ç†äººå‘˜æ˜¯äº†è§£æ‰‹ä¸‹çš„äººå‘˜ä»¥åŠè‡ªå·±è´Ÿè´£çš„äº‹æƒ…çš„ã€‚æ‰€ä»¥ï¼Œå¤§å¤šæ•°æ—¶å€™ï¼Œå…¬å¸çš„å„ç§å†³ç­–ï¼Œé€šçŸ¥ç­‰ï¼ŒCEOåªè¦å’Œç®¡ç†äººå‘˜ä¹‹é—´æ²Ÿé€šå°±å¤Ÿäº†ã€‚ è€Œéšç€CPUèƒ½åŠ›çš„ä¸æ–­æå‡ï¼Œä¸€å±‚ç¼“å­˜å°±æ…¢æ…¢çš„æ— æ³•æ»¡è¶³è¦æ±‚äº†ï¼Œå°±é€æ¸çš„è¡ç”Ÿå‡ºå¤šçº§ç¼“å­˜ã€‚ æŒ‰ç…§æ•°æ®è¯»å–é¡ºåºå’Œä¸CPUç»“åˆçš„ç´§å¯†ç¨‹åº¦ï¼ŒCPUç¼“å­˜å¯ä»¥åˆ†ä¸ºä¸€çº§ç¼“å­˜ï¼ˆL1ï¼‰ï¼ŒäºŒçº§ç¼“å­˜ï¼ˆL2ï¼‰ï¼Œéƒ¨åˆ†é«˜ç«¯CPUè¿˜å…·æœ‰ä¸‰çº§ç¼“å­˜ï¼ˆL3ï¼‰ï¼Œæ¯ä¸€çº§ç¼“å­˜ä¸­æ‰€å‚¨å­˜çš„å…¨éƒ¨æ•°æ®éƒ½æ˜¯ä¸‹ä¸€çº§ç¼“å­˜çš„ä¸€éƒ¨åˆ†ã€‚ è¿™ä¸‰ç§ç¼“å­˜çš„æŠ€æœ¯éš¾åº¦å’Œåˆ¶é€ æˆæœ¬æ˜¯ç›¸å¯¹é€’å‡çš„ï¼Œæ‰€ä»¥å…¶å®¹é‡ä¹Ÿæ˜¯ç›¸å¯¹é€’å¢çš„ã€‚ é‚£ä¹ˆï¼Œåœ¨æœ‰äº†å¤šçº§ç¼“å­˜ä¹‹åï¼Œç¨‹åºçš„æ‰§è¡Œå°±å˜æˆäº†ï¼š å½“CPUè¦è¯»å–ä¸€ä¸ªæ•°æ®æ—¶ï¼Œé¦–å…ˆä»ä¸€çº§ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°å†ä»äºŒçº§ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœè¿˜æ˜¯æ²¡æœ‰å°±ä»ä¸‰çº§ç¼“å­˜æˆ–å†…å­˜ä¸­æŸ¥æ‰¾ã€‚ éšç€å…¬å¸è¶Šæ¥è¶Šå¤§ï¼Œè€æ¿è¦ç®¡çš„äº‹æƒ…è¶Šæ¥è¶Šå¤šï¼Œå…¬å¸çš„ç®¡ç†éƒ¨é—¨å¼€å§‹æ”¹é©ï¼Œå¼€å§‹å‡ºç°é«˜å±‚ï¼Œä¸­å±‚ï¼Œåº•å±‚ç­‰ç®¡ç†è€…ã€‚ä¸€çº§ä¸€çº§ä¹‹é—´é€å±‚ç®¡ç†ã€‚ å•æ ¸CPUåªå«æœ‰ä¸€å¥—L1ï¼ŒL2ï¼ŒL3ç¼“å­˜ï¼› å¦‚æœCPUå«æœ‰å¤šä¸ªæ ¸å¿ƒï¼Œå³å¤šæ ¸CPUï¼Œåˆ™æ¯ä¸ªæ ¸å¿ƒéƒ½å«æœ‰ä¸€å¥—L1ï¼ˆç”šè‡³å’ŒL2ï¼‰ç¼“å­˜ï¼Œè€Œå…±äº«L3ï¼ˆæˆ–è€…å’ŒL2ï¼‰ç¼“å­˜ã€‚ å…¬å¸ä¹Ÿåˆ†å¾ˆå¤šç§ï¼Œæœ‰äº›å…¬å¸åªæœ‰ä¸€ä¸ªå¤§Bossï¼Œä»–ä¸€ä¸ªäººè¯´äº†ç®—ã€‚ä½†æ˜¯æœ‰äº›å…¬å¸æœ‰æ¯”å¦‚è”å¸­æ€»ç»ç†ã€åˆä¼™äººç­‰æœºåˆ¶ã€‚ å•æ ¸CPUå°±åƒä¸€å®¶å…¬å¸åªæœ‰ä¸€ä¸ªè€æ¿ï¼Œæ‰€æœ‰å‘½ä»¤éƒ½æ¥è‡ªäºä»–ï¼Œé‚£ä¹ˆå°±åªéœ€è¦ä¸€å¥—ç®¡ç†ç­åº•å°±å¤Ÿäº†ã€‚ å¤šæ ¸CPUå°±åƒä¸€å®¶å…¬å¸æ˜¯ç”±å¤šä¸ªåˆä¼™äººå…±åŒåˆ›åŠçš„ï¼Œé‚£ä¹ˆï¼Œå°±éœ€è¦ç»™æ¯ä¸ªåˆä¼™äººéƒ½è®¾ç«‹ä¸€å¥—ä¾›è‡ªå·±ç›´æ¥é¢†å¯¼çš„é«˜å±‚ç®¡ç†äººå‘˜ï¼Œå¤šä¸ªåˆä¼™äººå…±äº«ä½¿ç”¨çš„æ˜¯å…¬å¸çš„åº•å±‚å‘˜å·¥ã€‚ è¿˜æœ‰çš„å…¬å¸ï¼Œä¸æ–­å£®å¤§ï¼Œå¼€å§‹å·®åˆ†å‡ºå„ä¸ªå­å…¬å¸ã€‚å„ä¸ªå­å…¬å¸å°±æ˜¯å¤šä¸ªCPUäº†ï¼Œäº’ç›¸ä¹‹å‰æ²¡æœ‰å…±ç”¨çš„èµ„æºã€‚äº’ä¸å½±å“ã€‚ ä¸‹å›¾ä¸ºä¸€ä¸ªå•CPUåŒæ ¸çš„ç¼“å­˜ç»“æ„ã€‚ éšç€è®¡ç®—æœºèƒ½åŠ›ä¸æ–­æå‡ï¼Œå¼€å§‹æ”¯æŒå¤šçº¿ç¨‹ã€‚é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ã€‚æˆ‘ä»¬åˆ†åˆ«æ¥åˆ†æä¸‹å•çº¿ç¨‹ã€å¤šçº¿ç¨‹åœ¨å•æ ¸CPUã€å¤šæ ¸CPUä¸­çš„å½±å“ã€‚ å•çº¿ç¨‹ã€‚cpuæ ¸å¿ƒçš„ç¼“å­˜åªè¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®ã€‚ç¼“å­˜ç‹¬å ï¼Œä¸ä¼šå‡ºç°è®¿é—®å†²çªç­‰é—®é¢˜ã€‚ å•æ ¸CPUï¼Œå¤šçº¿ç¨‹è¿›ç¨‹ä¸­çš„å¤šä¸ªçº¿ç¨‹ä¼šåŒæ—¶è®¿é—®è¿›ç¨‹ä¸­çš„å…±äº«æ•°æ®ï¼ŒCPUå°†æŸå—å†…å­˜åŠ è½½åˆ°ç¼“å­˜åï¼Œä¸åŒçº¿ç¨‹åœ¨è®¿é—®ç›¸åŒçš„ç‰©ç†åœ°å€çš„æ—¶å€™ï¼Œéƒ½ä¼šæ˜ å°„åˆ°ç›¸åŒçš„ç¼“å­˜ä½ç½®ï¼Œè¿™æ ·å³ä½¿å‘ç”Ÿçº¿ç¨‹çš„åˆ‡æ¢ï¼Œç¼“å­˜ä»ç„¶ä¸ä¼šå¤±æ•ˆã€‚ä½†ç”±äºä»»ä½•æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œï¼Œå› æ­¤ä¸ä¼šå‡ºç°ç¼“å­˜è®¿é—®å†²çªã€‚ å¤šæ ¸CPUï¼Œå¤šçº¿ç¨‹æ¯ä¸ªæ ¸éƒ½è‡³å°‘æœ‰ä¸€ä¸ªL1 ç¼“å­˜ã€‚å¤šä¸ªçº¿ç¨‹è®¿é—®è¿›ç¨‹ä¸­çš„æŸä¸ªå…±äº«å†…å­˜ï¼Œä¸”è¿™å¤šä¸ªçº¿ç¨‹åˆ†åˆ«åœ¨ä¸åŒçš„æ ¸å¿ƒä¸Šæ‰§è¡Œï¼Œåˆ™æ¯ä¸ªæ ¸å¿ƒéƒ½ä¼šåœ¨å„è‡ªçš„caeheä¸­ä¿ç•™ä¸€ä»½å…±äº«å†…å­˜çš„ç¼“å†²ã€‚ç”±äºå¤šæ ¸æ˜¯å¯ä»¥å¹¶è¡Œçš„ï¼Œå¯èƒ½ä¼šå‡ºç°å¤šä¸ªçº¿ç¨‹åŒæ—¶å†™å„è‡ªçš„ç¼“å­˜çš„æƒ…å†µï¼Œè€Œå„è‡ªçš„cacheä¹‹é—´çš„æ•°æ®å°±æœ‰å¯èƒ½ä¸åŒã€‚ åœ¨CPUå’Œä¸»å­˜ä¹‹é—´å¢åŠ ç¼“å­˜ï¼Œåœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹å°±å¯èƒ½å­˜åœ¨ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨å¤šæ ¸CPUä¸­ï¼Œæ¯ä¸ªæ ¸çš„è‡ªå·±çš„ç¼“å­˜ä¸­ï¼Œå…³äºåŒä¸€ä¸ªæ•°æ®çš„ç¼“å­˜å†…å®¹å¯èƒ½ä¸ä¸€è‡´ã€‚ å¦‚æœè¿™å®¶å…¬å¸çš„å‘½ä»¤éƒ½æ˜¯ä¸²è¡Œä¸‹å‘çš„è¯ï¼Œé‚£ä¹ˆå°±æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚ å¦‚æœè¿™å®¶å…¬å¸çš„å‘½ä»¤éƒ½æ˜¯å¹¶è¡Œä¸‹å‘çš„è¯ï¼Œå¹¶ä¸”è¿™äº›å‘½ä»¤éƒ½æ˜¯ç”±åŒä¸€ä¸ªCEOä¸‹å‘çš„ï¼Œè¿™ç§æœºåˆ¶æ˜¯ä¹Ÿæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚å› ä¸ºä»–çš„å‘½ä»¤æ‰§è¡Œè€…åªæœ‰ä¸€å¥—ç®¡ç†ä½“ç³»ã€‚ å¦‚æœè¿™å®¶å…¬å¸çš„å‘½ä»¤éƒ½æ˜¯å¹¶è¡Œä¸‹å‘çš„è¯ï¼Œå¹¶ä¸”è¿™äº›å‘½ä»¤æ˜¯ç”±å¤šä¸ªåˆä¼™äººä¸‹å‘çš„ï¼Œè¿™å°±æœ‰é—®é¢˜äº†ã€‚å› ä¸ºæ¯ä¸ªåˆä¼™äººåªä¼šæŠŠå‘½ä»¤ä¸‹è¾¾ç»™è‡ªå·±ç›´å±çš„ç®¡ç†äººå‘˜ï¼Œè€Œå¤šä¸ªç®¡ç†äººå‘˜ç®¡ç†çš„åº•å±‚å‘˜å·¥å¯èƒ½æ˜¯å…¬ç”¨çš„ã€‚ æ¯”å¦‚ï¼Œåˆä¼™äºº1è¦è¾é€€å‘˜å·¥aï¼Œåˆä¼™äºº2è¦ç»™å‘˜å·¥aå‡èŒï¼Œå‡èŒåçš„è¯ä»–å†è¢«è¾é€€éœ€è¦å¤šä¸ªåˆä¼™äººå¼€ä¼šå†³è®®ã€‚ä¸¤ä¸ªåˆä¼™äººåˆ†åˆ«æŠŠå‘½ä»¤ä¸‹å‘ç»™äº†è‡ªå·±çš„ç®¡ç†äººå‘˜ã€‚åˆä¼™äºº1å‘½ä»¤ä¸‹è¾¾åï¼Œç®¡ç†äººå‘˜aåœ¨è¾é€€äº†å‘˜å·¥åï¼Œä»–å°±çŸ¥é“è¿™ä¸ªå‘˜å·¥è¢«å¼€é™¤äº†ã€‚è€Œåˆä¼™äºº2çš„ç®¡ç†äººå‘˜2è¿™æ—¶å€™åœ¨æ²¡å¾—åˆ°æ¶ˆæ¯ä¹‹å‰ï¼Œè¿˜è®¤ä¸ºå‘˜å·¥aæ˜¯åœ¨èŒçš„ï¼Œä»–å°±æ¬£ç„¶çš„æ¥æ”¶äº†åˆä¼™äººç»™ä»–çš„å‡èŒaçš„å‘½ä»¤ã€‚ å¤„ç†å™¨ä¼˜åŒ–å’ŒæŒ‡ä»¤é‡æ’ ä¸Šé¢æåˆ°åœ¨åœ¨CPUå’Œä¸»å­˜ä¹‹é—´å¢åŠ ç¼“å­˜ï¼Œåœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹ä¼šå­˜åœ¨ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ã€‚é™¤äº†è¿™ç§æƒ…å†µï¼Œè¿˜æœ‰ä¸€ç§ç¡¬ä»¶é—®é¢˜ä¹Ÿæ¯”è¾ƒé‡è¦ã€‚é‚£å°±æ˜¯ä¸ºäº†ä½¿å¤„ç†å™¨å†…éƒ¨çš„è¿ç®—å•å…ƒèƒ½å¤Ÿå°½é‡çš„è¢«å……åˆ†åˆ©ç”¨ï¼Œå¤„ç†å™¨å¯èƒ½ä¼šå¯¹è¾“å…¥ä»£ç è¿›è¡Œä¹±åºæ‰§è¡Œå¤„ç†ã€‚è¿™å°±æ˜¯å¤„ç†å™¨ä¼˜åŒ–ã€‚ é™¤äº†ç°åœ¨å¾ˆå¤šæµè¡Œçš„å¤„ç†å™¨ä¼šå¯¹ä»£ç è¿›è¡Œä¼˜åŒ–ä¹±åºå¤„ç†ï¼Œå¾ˆå¤šç¼–ç¨‹è¯­è¨€çš„ç¼–è¯‘å™¨ä¹Ÿä¼šæœ‰ç±»ä¼¼çš„ä¼˜åŒ–ï¼Œæ¯”å¦‚Javaè™šæ‹Ÿæœºçš„å³æ—¶ç¼–è¯‘å™¨ï¼ˆJITï¼‰ä¹Ÿä¼šåšæŒ‡ä»¤é‡æ’ã€‚ å¯æƒ³è€ŒçŸ¥ï¼Œå¦‚æœä»»ç”±å¤„ç†å™¨ä¼˜åŒ–å’Œç¼–è¯‘å™¨å¯¹æŒ‡ä»¤é‡æ’çš„è¯ï¼Œå°±å¯èƒ½å¯¼è‡´å„ç§å„æ ·çš„é—®é¢˜ã€‚ å…³äºå‘˜å·¥ç»„ç»‡è°ƒæ•´çš„æƒ…å†µï¼Œå¦‚æœå…è®¸äººäº‹éƒ¨åœ¨æ¥åˆ°å¤šä¸ªå‘½ä»¤åè¿›è¡Œéšæ„æ‹†åˆ†ä¹±åºæ‰§è¡Œæˆ–è€…é‡æ’çš„è¯ï¼Œé‚£ä¹ˆå¯¹äºè¿™ä¸ªå‘˜å·¥ä»¥åŠè¿™å®¶å…¬å¸çš„å½±å“æ˜¯éå¸¸å¤§çš„ã€‚ å¹¶å‘ç¼–ç¨‹çš„é—®é¢˜ å‰é¢è¯´çš„å’Œç¡¬ä»¶æœ‰å…³çš„æ¦‚å¿µä½ å¯èƒ½å¬å¾—æœ‰ç‚¹è’™ï¼Œè¿˜ä¸çŸ¥é“ä»–åˆ°åº•å’Œè½¯ä»¶æœ‰å•¥å…³ç³»ã€‚ä½†æ˜¯å…³äºå¹¶å‘ç¼–ç¨‹çš„é—®é¢˜ä½ åº”è¯¥æœ‰æ‰€äº†è§£ï¼Œæ¯”å¦‚åŸå­æ€§é—®é¢˜ï¼Œå¯è§æ€§é—®é¢˜å’Œæœ‰åºæ€§é—®é¢˜ã€‚ å…¶å®ï¼ŒåŸå­æ€§é—®é¢˜ï¼Œå¯è§æ€§é—®é¢˜å’Œæœ‰åºæ€§é—®é¢˜ã€‚æ˜¯äººä»¬æŠ½è±¡å®šä¹‰å‡ºæ¥çš„ã€‚è€Œè¿™ä¸ªæŠ½è±¡çš„åº•å±‚é—®é¢˜å°±æ˜¯å‰é¢æåˆ°çš„ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ã€å¤„ç†å™¨ä¼˜åŒ–é—®é¢˜å’ŒæŒ‡ä»¤é‡æ’é—®é¢˜ç­‰ã€‚ è¿™é‡Œç®€å•å›é¡¾ä¸‹è¿™ä¸‰ä¸ªé—®é¢˜ï¼Œå¹¶ä¸å‡†å¤‡æ·±å…¥å±•å¼€ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œå­¦ä¹ ã€‚æˆ‘ä»¬è¯´ï¼Œå¹¶å‘ç¼–ç¨‹ï¼Œä¸ºäº†ä¿è¯æ•°æ®çš„å®‰å…¨ï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªç‰¹æ€§ï¼š åŸå­æ€§æ˜¯æŒ‡åœ¨ä¸€ä¸ªæ“ä½œä¸­å°±æ˜¯cpuä¸å¯ä»¥åœ¨ä¸­é€”æš‚åœç„¶åå†è°ƒåº¦ï¼Œæ—¢ä¸è¢«ä¸­æ–­æ“ä½œï¼Œè¦ä¸æ‰§è¡Œå®Œæˆï¼Œè¦ä¸å°±ä¸æ‰§è¡Œã€‚ å¯è§æ€§æ˜¯æŒ‡å½“å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå˜é‡æ—¶ï¼Œä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³çœ‹å¾—åˆ°ä¿®æ”¹çš„å€¼ã€‚ æœ‰åºæ€§å³ç¨‹åºæ‰§è¡Œçš„é¡ºåºæŒ‰ç…§ä»£ç çš„å…ˆåé¡ºåºæ‰§è¡Œã€‚ æœ‰æ²¡æœ‰å‘ç°ï¼Œç¼“å­˜ä¸€è‡´æ€§é—®é¢˜å…¶å®å°±æ˜¯å¯è§æ€§é—®é¢˜ã€‚è€Œå¤„ç†å™¨ä¼˜åŒ–æ˜¯å¯ä»¥å¯¼è‡´åŸå­æ€§é—®é¢˜çš„ã€‚æŒ‡ä»¤é‡æ’å³ä¼šå¯¼è‡´æœ‰åºæ€§é—®é¢˜ã€‚æ‰€ä»¥ï¼Œåæ–‡å°†ä¸å†æèµ·ç¡¬ä»¶å±‚é¢çš„é‚£äº›æ¦‚å¿µï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨å¤§å®¶ç†Ÿæ‚‰çš„åŸå­æ€§ã€å¯è§æ€§å’Œæœ‰åºæ€§ã€‚ ä»€ä¹ˆæ˜¯å†…å­˜æ¨¡å‹ å‰é¢æåˆ°çš„ï¼Œç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ã€å¤„ç†å™¨å™¨ä¼˜åŒ–çš„æŒ‡ä»¤é‡æ’é—®é¢˜æ˜¯ç¡¬ä»¶çš„ä¸æ–­å‡çº§å¯¼è‡´çš„ã€‚é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆæœºåˆ¶å¯ä»¥å¾ˆå¥½çš„è§£å†³ä¸Šé¢çš„è¿™äº›é—®é¢˜å‘¢ï¼Ÿ æœ€ç®€å•ç›´æ¥çš„åšæ³•å°±æ˜¯åºŸé™¤å¤„ç†å™¨å’Œå¤„ç†å™¨çš„ä¼˜åŒ–æŠ€æœ¯ã€åºŸé™¤CPUç¼“å­˜ï¼Œè®©CPUç›´æ¥å’Œä¸»å­˜äº¤äº’ã€‚ä½†æ˜¯ï¼Œè¿™ä¹ˆåšè™½ç„¶å¯ä»¥ä¿è¯å¤šçº¿ç¨‹ä¸‹çš„å¹¶å‘é—®é¢˜ã€‚ä½†æ˜¯ï¼Œè¿™å°±æœ‰ç‚¹å› å™åºŸé£Ÿäº†ã€‚ æ‰€ä»¥ï¼Œä¸ºäº†ä¿è¯å¹¶å‘ç¼–ç¨‹ä¸­å¯ä»¥æ»¡è¶³åŸå­æ€§ã€å¯è§æ€§åŠæœ‰åºæ€§ã€‚æœ‰ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µï¼Œé‚£å°±æ˜¯â€”â€”å†…å­˜æ¨¡å‹ã€‚ ä¸ºäº†ä¿è¯å…±äº«å†…å­˜çš„æ­£ç¡®æ€§ï¼ˆå¯è§æ€§ã€æœ‰åºæ€§ã€åŸå­æ€§ï¼‰ï¼Œå†…å­˜æ¨¡å‹å®šä¹‰äº†å…±äº«å†…å­˜ç³»ç»Ÿä¸­å¤šçº¿ç¨‹ç¨‹åºè¯»å†™æ“ä½œè¡Œä¸ºçš„è§„èŒƒé€šè¿‡è¿™äº›è§„åˆ™æ¥è§„èŒƒå¯¹å†…å­˜çš„è¯»å†™æ“ä½œï¼Œä»è€Œä¿è¯æŒ‡ä»¤æ‰§è¡Œçš„æ­£ç¡®æ€§ã€‚å®ƒä¸å¤„ç†å™¨æœ‰å…³ã€ä¸ç¼“å­˜æœ‰å…³ã€ä¸å¹¶å‘æœ‰å…³ã€ä¸ç¼–è¯‘å™¨ä¹Ÿæœ‰å…³ã€‚ä»–è§£å†³äº†CPUå¤šçº§ç¼“å­˜ã€å¤„ç†å™¨ä¼˜åŒ–ã€æŒ‡ä»¤é‡æ’ç­‰å¯¼è‡´çš„å†…å­˜è®¿é—®é—®é¢˜ï¼Œä¿è¯äº†å¹¶å‘åœºæ™¯ä¸‹çš„ä¸€è‡´æ€§ã€åŸå­æ€§å’Œæœ‰åºæ€§ã€‚ å†…å­˜æ¨¡å‹è§£å†³å¹¶å‘é—®é¢˜ä¸»è¦é‡‡ç”¨ä¸¤ç§æ–¹å¼ï¼šé™åˆ¶å¤„ç†å™¨ä¼˜åŒ–å’Œä½¿ç”¨å†…å­˜å±éšœã€‚æœ¬æ–‡å°±ä¸æ·±å…¥åº•å±‚åŸç†æ¥å±•å¼€ä»‹ç»äº†ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥è‡ªè¡Œå­¦ä¹ ã€‚ ä»€ä¹ˆæ˜¯Javaå†…å­˜æ¨¡å‹ å‰é¢ä»‹ç»è¿‡äº†è®¡ç®—æœºå†…å­˜æ¨¡å‹ï¼Œè¿™æ˜¯è§£å†³å¤šçº¿ç¨‹åœºæ™¯ä¸‹å¹¶å‘é—®é¢˜çš„ä¸€ä¸ªé‡è¦è§„èŒƒã€‚é‚£ä¹ˆå…·ä½“çš„å®ç°æ˜¯å¦‚ä½•çš„å‘¢ï¼Œä¸åŒçš„ç¼–ç¨‹è¯­è¨€ï¼Œåœ¨å®ç°ä¸Šå¯èƒ½æœ‰æ‰€ä¸åŒã€‚ æˆ‘ä»¬çŸ¥é“ï¼ŒJavaç¨‹åºæ˜¯éœ€è¦è¿è¡Œåœ¨Javaè™šæ‹Ÿæœºä¸Šé¢çš„ï¼ŒJavaå†…å­˜æ¨¡å‹ï¼ˆJava Memory Model ,JMMï¼‰å°±æ˜¯ä¸€ç§ç¬¦åˆå†…å­˜æ¨¡å‹è§„èŒƒçš„ï¼Œå±è”½äº†å„ç§ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿçš„è®¿é—®å·®å¼‚çš„ï¼Œä¿è¯äº†Javaç¨‹åºåœ¨å„ç§å¹³å°ä¸‹å¯¹å†…å­˜çš„è®¿é—®éƒ½èƒ½ä¿è¯æ•ˆæœä¸€è‡´çš„æœºåˆ¶åŠè§„èŒƒã€‚ æåˆ°Javaå†…å­˜æ¨¡å‹ï¼Œä¸€èˆ¬æŒ‡çš„æ˜¯JDK 5 å¼€å§‹ä½¿ç”¨çš„æ–°çš„å†…å­˜æ¨¡å‹ï¼Œä¸»è¦ç”±JSR-133: JavaTM Memory Model and Thread Specification æè¿°ã€‚æ„Ÿå…´è¶£çš„å¯ä»¥å‚çœ‹ä¸‹è¿™ä»½PDFæ–‡æ¡£ï¼ˆhttp://www.cs.umd.edu/~pugh/java/memoryModel/jsr133.pdfï¼‰ Javaå†…å­˜æ¨¡å‹è§„å®šäº†æ‰€æœ‰çš„å˜é‡éƒ½å­˜å‚¨åœ¨ä¸»å†…å­˜ä¸­ï¼Œæ¯æ¡çº¿ç¨‹è¿˜æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œçº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ä¿å­˜äº†è¯¥çº¿ç¨‹ä¸­æ˜¯ç”¨åˆ°çš„å˜é‡çš„ä¸»å†…å­˜å‰¯æœ¬æ‹·è´ï¼Œçº¿ç¨‹å¯¹å˜é‡çš„æ‰€æœ‰æ“ä½œéƒ½å¿…é¡»åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œï¼Œè€Œä¸èƒ½ç›´æ¥è¯»å†™ä¸»å†…å­˜ã€‚ä¸åŒçš„çº¿ç¨‹ä¹‹é—´ä¹Ÿæ— æ³•ç›´æ¥è®¿é—®å¯¹æ–¹å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼Œçº¿ç¨‹é—´å˜é‡çš„ä¼ é€’å‡éœ€è¦è‡ªå·±çš„å·¥ä½œå†…å­˜å’Œä¸»å­˜ä¹‹é—´è¿›è¡Œæ•°æ®åŒæ­¥è¿›è¡Œã€‚ è€ŒJMMå°±ä½œç”¨äºå·¥ä½œå†…å­˜å’Œä¸»å­˜ä¹‹é—´æ•°æ®åŒæ­¥è¿‡ç¨‹ã€‚ä»–è§„å®šäº†å¦‚ä½•åšæ•°æ®åŒæ­¥ä»¥åŠä»€ä¹ˆæ—¶å€™åšæ•°æ®åŒæ­¥ã€‚ è¿™é‡Œé¢æåˆ°çš„ä¸»å†…å­˜å’Œå·¥ä½œå†…å­˜ï¼Œè¯»è€…å¯ä»¥ç®€å•çš„ç±»æ¯”æˆè®¡ç®—æœºå†…å­˜æ¨¡å‹ä¸­çš„ä¸»å­˜å’Œç¼“å­˜çš„æ¦‚å¿µã€‚ç‰¹åˆ«éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸»å†…å­˜å’Œå·¥ä½œå†…å­˜ä¸JVMå†…å­˜ç»“æ„ä¸­çš„Javaå †ã€æ ˆã€æ–¹æ³•åŒºç­‰å¹¶ä¸æ˜¯åŒä¸€ä¸ªå±‚æ¬¡çš„å†…å­˜åˆ’åˆ†ï¼Œæ— æ³•ç›´æ¥ç±»æ¯”ã€‚ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ä¸­è®¤ä¸ºï¼Œå¦‚æœä¸€å®šè¦å‹‰å¼ºå¯¹åº”èµ·æ¥çš„è¯ï¼Œä»å˜é‡ã€ä¸»å†…å­˜ã€å·¥ä½œå†…å­˜çš„å®šä¹‰æ¥çœ‹ï¼Œä¸»å†…å­˜ä¸»è¦å¯¹åº”äºJavaå †ä¸­çš„å¯¹è±¡å®ä¾‹æ•°æ®éƒ¨åˆ†ã€‚å·¥ä½œå†…å­˜åˆ™å¯¹åº”äºè™šæ‹Ÿæœºæ ˆä¸­çš„éƒ¨åˆ†åŒºåŸŸã€‚ æ‰€ä»¥ï¼Œå†æ¥æ€»ç»“ä¸‹ï¼ŒJMMæ˜¯ä¸€ç§è§„èŒƒï¼Œç›®çš„æ˜¯è§£å†³ç”±äºå¤šçº¿ç¨‹é€šè¿‡å…±äº«å†…å­˜è¿›è¡Œé€šä¿¡æ—¶ï¼Œå­˜åœ¨çš„æœ¬åœ°å†…å­˜æ•°æ®ä¸ä¸€è‡´ã€ç¼–è¯‘å™¨ä¼šå¯¹ä»£ç æŒ‡ä»¤é‡æ’åºã€å¤„ç†å™¨ä¼šå¯¹ä»£ç ä¹±åºæ‰§è¡Œç­‰å¸¦æ¥çš„é—®é¢˜ã€‚ç›®çš„æ˜¯ä¿è¯å¹¶å‘ç¼–ç¨‹åœºæ™¯ä¸­çš„åŸå­æ€§ã€å¯è§æ€§å’Œæœ‰åºæ€§ã€‚ Javaå†…å­˜æ¨¡å‹çš„å®ç° äº†è§£Javaå¤šçº¿ç¨‹çš„æœ‹å‹éƒ½çŸ¥é“ï¼Œåœ¨Javaä¸­æä¾›äº†ä¸€ç³»åˆ—å’Œå¹¶å‘å¤„ç†ç›¸å…³çš„å…³é”®å­—ï¼Œæ¯”å¦‚volatileã€synchronizedã€finalã€concurrentåŒ…ç­‰ã€‚å…¶å®è¿™äº›å°±æ˜¯Javaå†…å­˜æ¨¡å‹å°è£…äº†åº•å±‚çš„å®ç°åæä¾›ç»™ç¨‹åºå‘˜ä½¿ç”¨çš„ä¸€äº›å…³é”®å­—ã€‚ åœ¨å¼€å‘å¤šçº¿ç¨‹çš„ä»£ç çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨synchronizedç­‰å…³é”®å­—æ¥æ§åˆ¶å¹¶å‘ï¼Œä»æ¥å°±ä¸éœ€è¦å…³å¿ƒåº•å±‚çš„ç¼–è¯‘å™¨ä¼˜åŒ–ã€ç¼“å­˜ä¸€è‡´æ€§ç­‰é—®é¢˜ã€‚æ‰€ä»¥ï¼ŒJavaå†…å­˜æ¨¡å‹ï¼Œé™¤äº†å®šä¹‰äº†ä¸€å¥—è§„èŒƒï¼Œè¿˜æä¾›äº†ä¸€ç³»åˆ—åŸè¯­ï¼Œå°è£…äº†åº•å±‚å®ç°åï¼Œä¾›å¼€å‘è€…ç›´æ¥ä½¿ç”¨ã€‚ æœ¬æ–‡å¹¶ä¸å‡†å¤‡æŠŠæ‰€æœ‰çš„å…³é”®å­—é€ä¸€ä»‹ç»å…¶ç”¨æ³•ï¼Œå› ä¸ºå…³äºå„ä¸ªå…³é”®å­—çš„ç”¨æ³•ï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šèµ„æ–™ã€‚è¯»è€…å¯ä»¥è‡ªè¡Œå­¦ä¹ ã€‚æœ¬æ–‡è¿˜æœ‰ä¸€ä¸ªé‡ç‚¹è¦ä»‹ç»çš„å°±æ˜¯ï¼Œæˆ‘ä»¬å‰é¢æåˆ°ï¼Œå¹¶å‘ç¼–ç¨‹è¦è§£å†³åŸå­æ€§ã€æœ‰åºæ€§å’Œä¸€è‡´æ€§çš„é—®é¢˜ï¼Œæˆ‘ä»¬å°±å†æ¥çœ‹ä¸‹ï¼Œåœ¨Javaä¸­ï¼Œåˆ†åˆ«ä½¿ç”¨ä»€ä¹ˆæ–¹å¼æ¥ä¿è¯ã€‚ åŸå­æ€§ åœ¨Javaä¸­ï¼Œä¸ºäº†ä¿è¯åŸå­æ€§ï¼Œæä¾›äº†ä¸¤ä¸ªé«˜çº§çš„å­—èŠ‚ç æŒ‡ä»¤monitorenterå’Œmonitorexitã€‚åœ¨synchronizedçš„å®ç°åŸç†æ–‡ç« ä¸­ï¼Œä»‹ç»è¿‡ï¼Œè¿™ä¸¤ä¸ªå­—èŠ‚ç ï¼Œåœ¨Javaä¸­å¯¹åº”çš„å…³é”®å­—å°±æ˜¯synchronizedã€‚ å› æ­¤ï¼Œåœ¨Javaä¸­å¯ä»¥ä½¿ç”¨synchronizedæ¥ä¿è¯æ–¹æ³•å’Œä»£ç å—å†…çš„æ“ä½œæ˜¯åŸå­æ€§çš„ã€‚ å¯è§æ€§ Javaå†…å­˜æ¨¡å‹æ˜¯é€šè¿‡åœ¨å˜é‡ä¿®æ”¹åå°†æ–°å€¼åŒæ­¥å›ä¸»å†…å­˜ï¼Œåœ¨å˜é‡è¯»å–å‰ä»ä¸»å†…å­˜åˆ·æ–°å˜é‡å€¼çš„è¿™ç§ä¾èµ–ä¸»å†…å­˜ä½œä¸ºä¼ é€’åª’ä»‹çš„æ–¹å¼æ¥å®ç°çš„ã€‚ Javaä¸­çš„volatileå…³é”®å­—æä¾›äº†ä¸€ä¸ªåŠŸèƒ½ï¼Œé‚£å°±æ˜¯è¢«å…¶ä¿®é¥°çš„å˜é‡åœ¨è¢«ä¿®æ”¹åå¯ä»¥ç«‹å³åŒæ­¥åˆ°ä¸»å†…å­˜ï¼Œè¢«å…¶ä¿®é¥°çš„å˜é‡åœ¨æ¯æ¬¡æ˜¯ç”¨ä¹‹å‰éƒ½ä»ä¸»å†…å­˜åˆ·æ–°ã€‚å› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨volatileæ¥ä¿è¯å¤šçº¿ç¨‹æ“ä½œæ—¶å˜é‡çš„å¯è§æ€§ã€‚ é™¤äº†volatileï¼ŒJavaä¸­çš„synchronizedå’Œfinalä¸¤ä¸ªå…³é”®å­—ä¹Ÿå¯ä»¥å®ç°å¯è§æ€§ã€‚åªä¸è¿‡å®ç°æ–¹å¼ä¸åŒï¼Œè¢«synchronizedä¿®é¥°çš„ä»£ç ï¼Œåœ¨å¼€å§‹æ‰§è¡Œæ—¶ä¼šåŠ é”ï¼Œæ‰§è¡Œå®Œæˆåä¼šè¿›è¡Œè§£é”ï¼Œä½†åœ¨ä¸€ä¸ªå˜é‡è§£é”ä¹‹å‰ï¼Œå¿…é¡»å…ˆæŠŠæ­¤å˜é‡åŒæ­¥å›ä¸»å­˜ä¸­ï¼Œè¿™æ ·è§£é”åï¼Œåç»­å…¶å®ƒçº¿ç¨‹å°±å¯ä»¥è®¿é—®åˆ°è¢«ä¿®æ”¹åçš„å€¼ï¼Œä»è€Œä¿è¯å¯è§æ€§ã€‚ æœ‰åºæ€§ åœ¨Javaä¸­ï¼Œå¯ä»¥ä½¿ç”¨synchronizedå’Œvolatileæ¥ä¿è¯å¤šçº¿ç¨‹ä¹‹é—´æ“ä½œçš„æœ‰åºæ€§ã€‚å®ç°æ–¹å¼æœ‰æ‰€åŒºåˆ«ï¼š volatileå…³é”®å­—ä¼šç¦æ­¢æŒ‡ä»¤é‡æ’ã€‚synchronizedå…³é”®å­—ä¿è¯åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€æ¡çº¿ç¨‹æ“ä½œã€‚ å¥½äº†ï¼Œè¿™é‡Œç®€å•çš„ä»‹ç»å®Œäº†Javaå¹¶å‘ç¼–ç¨‹ä¸­è§£å†³åŸå­æ€§ã€å¯è§æ€§ä»¥åŠæœ‰åºæ€§å¯ä»¥ä½¿ç”¨çš„å…³é”®å­—ã€‚è¯»è€…å¯èƒ½å‘ç°äº†ï¼Œå¥½åƒsynchronizedå…³é”®å­—æ˜¯ä¸‡èƒ½çš„ï¼Œä»–å¯ä»¥åŒæ—¶æ»¡è¶³ä»¥ä¸Šä¸‰ç§ç‰¹æ€§ï¼Œè¿™å…¶å®ä¹Ÿæ˜¯å¾ˆå¤šäººæ»¥ç”¨synchronizedçš„åŸå› ã€‚ ä½†æ˜¯synchronizedæ˜¯æ¯”è¾ƒå½±å“æ€§èƒ½çš„ï¼Œè™½ç„¶ç¼–è¯‘å™¨æä¾›äº†å¾ˆå¤šé”ä¼˜åŒ–æŠ€æœ¯ï¼Œä½†æ˜¯ä¹Ÿä¸å»ºè®®è¿‡åº¦ä½¿ç”¨ã€‚ æ€»ç»“ åœ¨è¯»å®Œæœ¬æ–‡ä¹‹åï¼Œç›¸ä¿¡ä½ åº”è¯¥äº†è§£äº†ä»€ä¹ˆæ˜¯Javaå†…å­˜æ¨¡å‹ã€Javaå†…å­˜æ¨¡å‹çš„ä½œç”¨ä»¥åŠJavaä¸­å†…å­˜æ¨¡å‹åšäº†ä»€ä¹ˆäº‹æƒ…ç­‰ã€‚ å…³äºJavaä¸­è¿™äº›å’Œå†…å­˜æ¨¡å‹æœ‰å…³çš„å…³é”®å­—ï¼Œå¸Œæœ›è¯»è€…è¿˜å¯ä»¥ç»§ç»­æ·±å…¥å­¦ä¹ ï¼Œå¹¶ä¸”è‡ªå·±å†™å‡ ä¸ªä¾‹å­äº²è‡ªä½“ä¼šä¸€ä¸‹ã€‚å¯ä»¥å‚è€ƒã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹å’Œã€ŠJavaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹ä¸¤æœ¬ä¹¦ã€‚ é¢è¯•å¦‚ä½•å›ç­” å‰é¢æˆ‘ä»‹ç»å®Œäº†ä¸€äº›å’ŒJavaå†…å­˜æ¨¡å‹æœ‰å…³çš„åŸºç¡€çŸ¥è¯†ï¼Œåªæ˜¯åŸºç¡€ï¼Œå¹¶ä¸æ˜¯å…¨éƒ¨ï¼Œå› ä¸ºéšä¾¿ä¸€ä¸ªçŸ¥è¯†ç‚¹è¿˜æ˜¯éƒ½å¯ä»¥å±•å¼€çš„ï¼Œå¦‚volatileæ˜¯å¦‚ä½•å®ç°å¯è§æ€§çš„ï¼Ÿsynchronizedæ˜¯å¦‚ä½•å®ç°æœ‰åºæ€§çš„ï¼Ÿ ä½†æ˜¯ï¼Œå½“é¢è¯•å®˜é—®ä½ ï¼šèƒ½ç®€å•ä»‹ç»ä¸‹ä½ ç†è§£çš„å†…å­˜æ¨¡å‹å—ï¼Ÿ é¦–å…ˆï¼Œå…ˆå’Œé¢è¯•å®˜ç¡®è®¤ä¸€ä¸‹ï¼šæ‚¨è¯´çš„å†…å­˜æ¨¡å‹æŒ‡çš„æ˜¯JMMï¼Œä¹Ÿå°±æ˜¯å’Œå¹¶å‘ç¼–ç¨‹æœ‰å…³çš„é‚£ä¸€ä¸ªå§ï¼Ÿ åœ¨å¾—åˆ°è‚¯å®šç­”å¤åï¼Œå†å¼€å§‹ä»‹ç»ï¼ˆå¦‚æœä¸æ˜¯ï¼Œé‚£å¯èƒ½å°±è¦å›ç­”å †ã€æ ˆã€æ–¹æ³•åŒºå“ªäº›äº†â€¦.å›§â€¦ï¼‰ï¼š Javaå†…å­˜æ¨¡å‹ï¼Œå…¶å®æ˜¯ä¿è¯äº†Javaç¨‹åºåœ¨å„ç§å¹³å°ä¸‹å¯¹å†…å­˜çš„è®¿é—®éƒ½èƒ½å¤Ÿå¾—åˆ°ä¸€è‡´æ•ˆæœçš„æœºåˆ¶åŠè§„èŒƒã€‚ç›®çš„æ˜¯è§£å†³ç”±äºå¤šçº¿ç¨‹é€šè¿‡å…±äº«å†…å­˜è¿›è¡Œé€šä¿¡æ—¶ï¼Œå­˜åœ¨çš„åŸå­æ€§ã€å¯è§æ€§ï¼ˆç¼“å­˜ä¸€è‡´æ€§ï¼‰ä»¥åŠæœ‰åºæ€§é—®é¢˜ã€‚ é™¤æ­¤ä¹‹å¤–ï¼ŒJavaå†…å­˜æ¨¡å‹è¿˜æä¾›äº†ä¸€ç³»åˆ—åŸè¯­ï¼Œå°è£…äº†åº•å±‚å®ç°åï¼Œä¾›å¼€å‘è€…ç›´æ¥ä½¿ç”¨ã€‚å¦‚æˆ‘ä»¬å¸¸ç”¨çš„ä¸€äº›å…³é”®å­—ï¼šsynchronizedã€volatileä»¥åŠå¹¶å‘åŒ…ç­‰ã€‚ å›ç­”åˆ°è¿™é‡Œå°±å¯ä»¥äº†ï¼Œç„¶åé¢è¯•å®˜å¯èƒ½ä¼šç»§ç»­è¿½é—®ï¼Œç„¶åæ ¹æ®ä»–çš„è¿½é—®å†ç»§ç»­å¾€ä¸‹å›ç­”å³å¯ã€‚ æ‰€ä»¥ï¼Œå½“æœ‰äººå†é—®ä½ Javaå†…å­˜æ¨¡å‹çš„æ—¶å€™ï¼Œä¸è¦ä¸€å¼ å˜´å°±ç›´æ¥å›ç­”å †æ ˆã€æ–¹æ³•åŒºç”šè‡³GCäº†ï¼Œé‚£æ ·æ˜¾å¾—å¾ˆä¸ä¸“ä¸šï¼ ä½œè€…ï¼š Hollis åŸæ–‡åœ°å€ï¼šJavaå†…å­˜æ¨¡å‹ ","link":"https://tianxiawuhao.github.io/rNVfAh0Yb/"},{"title":" JVM çš„æ ¸å¿ƒçŸ¥è¯†æ¢³ç†","content":"å‰è¨€ è¿è¡Œæ—¶æ•°æ®åŒºåŸŸ javaè™šæ‹Ÿæœºè¿è¡Œæ—¶æœ‰å“ªäº›æ•°æ®åŒºåŸŸï¼Œä»–ä»¬éƒ½æœ‰ä»€ä¹ˆç”¨é€”ï¼Ÿ æœ‰ç¨‹åºè®¡æ•°å™¨ã€javaè™šæ‹Ÿæœºæ ˆã€æœ¬åœ°æ–¹æ³•æ ˆã€å †å’Œæ–¹æ³•åŒºäº”å¤§æ¨¡å—ã€‚è¯·çœ‹ä¸‹å›¾ï¼š ç¨‹åºè®¡æ•°å™¨ ç¨‹åºè®¡æ•°å™¨æ˜¯ä¸€å—è¾ƒå°çš„å†…å­˜ç©ºé—´ï¼Œä»–å¯ä»¥çœ‹åšæ˜¯å½“æœŸçº¿ç¨‹æ‰€æ‰§è¡Œçš„å­—èŠ‚ç çš„è¡Œå·æŒ‡ä»¤å™¨ã€‚å­—èŠ‚ç è§£é‡Šå™¨å·¥ä½œæ—¶å°±æ˜¯é€šè¿‡æ”¹å˜è¿™ä¸ªè®¡æ•°å™¨çš„å€¼æ¥é€‰å–ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ã€‚åœ¨ä»»ä½•ä¸€ä¸ªç¡®å®šçš„æ—¶åˆ»ï¼Œä¸€ä¸ªå¤„ç†å™¨éƒ½åªä¼šæ‰§è¡Œä¸€æ¡çº¿ç¨‹ä¸­çš„æŒ‡ä»¤ã€‚å› æ­¤ï¼Œä¸ºäº†çº¿ç¨‹åˆ‡æ¢åèƒ½æ¢å¤åˆ°æ­£ç¡®çš„æ‰§è¡Œä½ç½®ï¼Œæ¯æ¡çº¿ç¨‹éƒ½éœ€è¦æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç¨‹åºè®¡æ•°å™¨ï¼Œå„ä¸ªçº¿ç¨‹ä¹‹é—´äº’ä¸å½±å“ï¼Œç‹¬ç«‹å­˜å‚¨ï¼Œæ‰€ä»¥ç¨‹åºè®¡æ•°å™¨æ˜¯â€œçº¿ç¨‹ç§æœ‰çš„â€ã€‚å¦å¤–ï¼Œç¨‹åºè®¡æ•°å™¨æ˜¯å”¯ä¸€ä¸€ä¸ªåœ¨javaè™šæ‹Ÿæœºè§„èŒƒä¸­æ²¡æœ‰è§„å®šOOMçš„åŒºåŸŸã€‚ Javaè™šæ‹Ÿæœºæ ˆ Javaè™šæ‹Ÿæœºæ ˆä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹ç›¸åŒï¼Œè™šæ‹Ÿæœºæ ˆæè¿°çš„æ˜¯Javaæ–¹æ³•æ‰§è¡Œçš„å†…å­˜æ¨¡å‹ï¼Œæ¯ä¸ªæ–¹æ³•åœ¨æ‰§è¡Œçš„åŒæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ç”¨äºå­˜å‚¨å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£ç­‰ä¿¡æ¯ã€‚æ¯ä¸ªæ–¹æ³•ä»è°ƒç”¨ç›´è‡³æ‰§è¡Œå®Œæˆçš„è¿‡ç¨‹ï¼Œå¯¹åº”ç€ä¸€ä¸ªæ ˆå¸§åœ¨è™šæ‹Ÿæœºæ ˆä¸­å…¥æ ˆåˆ°å‡ºæ ˆçš„è¿‡ç¨‹ã€‚ï¼ˆç¨‹åºå‘˜ç»å¸¸ä¼šæŠŠJavaå†…å­˜åˆ’åˆ†ä¸ºå †å†…å­˜å’Œæ ˆå†…å­˜ï¼Œè¿™ç§è¯´æ³•æ¯”è¾ƒç²—ç³™ï¼Œå…¶ä¸­çš„æ ˆå†…å­˜å°±æ˜¯æŒ‡è™šæ‹Ÿæœºæ ˆï¼Œæˆ–è€…è¯´æ˜¯è™šæ‹Ÿæœºæ ˆä¸­çš„å±€éƒ¨å˜é‡è¡¨çš„éƒ¨åˆ†ï¼‰ åœ¨Javaè™šæ‹Ÿæœºè§„èŒƒä¸­ï¼Œå¯¹è¿™ä¸ªåŒºåŸŸè§„å®šäº†ä¸¤ç§å¼‚å¸¸ï¼šå¦‚æœçº¿ç¨‹è¯·æ±‚çš„æ ˆæ·±åº¦å¤§äºè™šæ‹Ÿæœºæ‰€å…è®¸çš„æ·±åº¦ï¼Œå°†æŠ›å‡ºStackOverFlowErrorå¼‚å¸¸ã€‚å¦‚æœè™šæ‹Ÿæœºæ ˆå¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œå¦‚æœæ‰©å±•æ—¶æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼Œå°±ä¼šæŠ›å‡ºOOMå¼‚å¸¸ã€‚ æœ¬åœ°æ–¹æ³•æ ˆ æœ¬åœ°æ–¹æ³•æ ˆä¸è™šæ‹Ÿæœºæ ˆä½œç”¨ç±»ä¼¼ï¼Œä»–ä»¬ä¹‹é—´çš„åŒºåˆ«ä¸è¿‡æ˜¯è™šæ‹Ÿæœºæ ˆæ˜¯ä¸ºè™šæ‹Ÿæœºæ‰§è¡ŒJavaæ–¹æ³•ï¼ˆä¹Ÿå°±æ˜¯å­—èŠ‚ç ï¼‰æœåŠ¡ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆåˆ™ä¸ºè™šæ‹Ÿæœºä½¿ç”¨åˆ°çš„Nativeæ–¹æ³•æœåŠ¡ã€‚ä¸è™šæ‹Ÿæœºæ ˆä¸€æ ·ï¼Œæœ¬åœ°æ–¹æ³•æ ˆä¹Ÿä¼šæŠ›å‡ºStackOverFlowErrorå¼‚å¸¸å’ŒOOMå¼‚å¸¸ã€‚ å † Javaå †æ˜¯Javaè™šæ‹Ÿæœºç®¡ç†çš„æœ€å¤§çš„ä¸€å—å†…å­˜ï¼Œæ˜¯æ‰€æœ‰çº¿ç¨‹å…±äº«çš„åŒºåŸŸï¼Œåœ¨è™šæ‹Ÿæœºå¯åŠ¨æ—¶å°±åˆ›å»ºã€‚å †ç”¨æ¥å­˜æ”¾å¯¹è±¡å®ä¾‹ï¼Œå‡ ä¹æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½åœ¨è¿™é‡Œåˆ†é…å†…å­˜ï¼ˆæ³¨æ„æ˜¯å‡ ä¹æ‰€æœ‰ï¼‰ã€‚è¿™ä¸€ç‚¹åœ¨Javaè™šæ‹Ÿæœºè§„èŒƒä¸­æè¿°ä¸ºï¼šæ‰€æœ‰çš„å¯¹è±¡å®ä¾‹ä»¥åŠæ•°ç»„éƒ½è¦åœ¨å †ä¸Šåˆ†é…ï¼Œä½†éšç€JITç¼–è¯‘å™¨çš„å‘å±•å’Œé€ƒé€¸åˆ†ææŠ€æœ¯çš„æˆç†Ÿï¼Œæ ˆä¸Šåˆ†é…ã€æ ‡é‡æ›¿æ¢æŠ€æœ¯å°†ä¼šå¯¼è‡´ä¸€äº›å¾®å¦™çš„å˜åŒ–å‘ç”Ÿï¼Œæ‰€æœ‰å¯¹è±¡éƒ½åˆ†é…åœ¨å †ä¸Šä¹Ÿä¸æ˜¯é‚£ä¹ˆç»å¯¹äº†ã€‚ å¦‚æœåœ¨å †ä¸­æ²¡æœ‰å†…å­˜å®Œæˆå®ä¾‹åˆ†é…ï¼Œå¹¶ä¸”å †ä¹Ÿæ— æ³•å†æ‰©å±•æ—¶ï¼Œå°†ä¼šæŠ›å‡ºOOMå¼‚å¸¸ã€‚ æ–¹æ³•åŒº æ–¹æ³•åŒºä¸Javaå †ä¸€æ ·ï¼Œæ˜¯å„ä¸ªçº¿ç¨‹å…±äº«çš„åŒºåŸŸï¼Œå®ƒç”¨æ¥å­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ã€‚æ ¹æ®Javaè™šæ‹Ÿæœºè§„èŒƒï¼Œå½“æ–¹æ³•åŒºæ— æ³•æ»¡è¶³å†…å­˜åˆ†é…çš„ éœ€æ±‚æ—¶ï¼Œå°†æŠ›å‡ºOOMå¼‚å¸¸ã€‚ è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºå­˜æ”¾ç¼–è¯‘å™¨ç”Ÿæˆçš„å„ç§å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ã€‚è¿è¡Œæ—¶å¸¸é‡æ± ç›¸å¯¹äºClassæ–‡ä»¶å¸¸é‡æ± çš„å¦å¤–ä¸€ä¸ªé‡è¦ç‰¹å¾å°±æ˜¯å…·å¤‡åŠ¨æ€æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´è¿è¡ŒæœŸé—´ä¹Ÿå¯èƒ½å°†æ–°çš„å¸¸é‡ æ”¾å…¥æ± ä¸­ï¼Œè¿™ç§ç‰¹æ€§è¢«åˆ©ç”¨çš„æ¯”è¾ƒå¤šçš„å°±æ˜¯Stringç±»çš„intern()æ–¹æ³•ã€‚ ç›´æ¥å†…å­˜ ç›´æ¥å†…å­˜å¹¶ä¸æ˜¯è¿è¡Œæ—¶æ•°æ®åŒºçš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿä¸æ˜¯Javaè™šæ‹Ÿæœºå®šä¹‰çš„å†…å­˜åŒºåŸŸã€‚æœ¬æœºç›´æ¥å†…å­˜çš„åˆ†é…ä¸å—Javaå †å¤§å°çš„é™åˆ¶ï¼Œä½†æ˜¯å—æœ¬æœºæ€»å†…å­˜å¤§å°ä»¥åŠå¤„ç†å™¨å¯»å€ç©ºé—´çš„é™åˆ¶ã€‚ å†…å­˜æº¢å‡º å †å†…å­˜æº¢å‡º Javaå †ç”¨äºå­˜å‚¨å¯¹è±¡å®ä¾‹ï¼Œåªè¦ä¸æ–­åˆ›å»ºå¯¹è±¡ï¼Œå¹¶ä¸”ä¿è¯GC Rootsåˆ°å¯¹è±¡ä¹‹é—´æœ‰å¯è¾¾è·¯å¾„æ¥é¿å…åƒåœ¾å›æ”¶æœºåˆ¶æ¸…é™¤è¿™äº›å¯¹è±¡ï¼Œé‚£ä¹ˆåœ¨å¯¹è±¡æ•°é‡è¾¾åˆ°æœ€å¤§å †å®¹é‡é™åˆ¶åå°±ä¼šOOMã€‚ï¼ˆè½»æ˜“ä¸è¦è¿è¡Œï¼‰ public class HeapOOMTest { static class OOMObject { } public static void main(String [] args) { List&lt;OOMObject&gt; list = new ArrayList&lt;&gt;(); while (true) { list.add(new OOMObject()); } } } Javaå †å†…å­˜çš„OOMå¼‚å¸¸æ˜¯å®é™…åº”ç”¨ä¸­æœ€å¸¸è§çš„å†…å­˜æº¢å‡ºï¼Œå½“å‡ºç°äº†å’‹åŠï¼Ÿä¸€èˆ¬çš„æ‰‹æ®µæ˜¯å…ˆé€šè¿‡å†…å­˜æ˜ åƒåˆ†æå·¥å…·å¯¹Dumpå‡ºæ¥çš„å †è½¬å‚¨å¿«ç…§è¿›è¡Œåˆ†æï¼Œé‡ç‚¹æ˜¯ç¡®è®¤å†…å­˜ä¸­çš„å¯¹è±¡æ˜¯å¦æ˜¯å¿…è¦çš„ï¼Œä¹Ÿå°±æ˜¯ç¡®è®¤æ˜¯å†…å­˜æ³„éœ²è¿˜æ˜¯å†…å­˜æº¢å‡ºã€‚ å¦‚æœæ˜¯å†…å­˜æ³„éœ²ï¼Œå¯è¿›ä¸€æ­¥é€šè¿‡å·¥å…·æŸ¥çœ‹æ³„éœ²å¯¹è±¡åˆ°GCRootsçš„å¼•ç”¨é“¾ï¼Œæ‰¾åˆ°ä¸ºä»€ä¹ˆåƒåœ¾æ”¶é›†å™¨æ— æ³•å›æ”¶å®ƒä»¬ã€‚å¦‚æœä¸å­˜åœ¨æ³„éœ²ï¼Œå°±æ˜¯å†…å­˜ä¸­çš„å¯¹è±¡å¿…é¡»éƒ½å­˜æ´»ï¼Œé‚£å°±è¦æ£€æŸ¥è™šæ‹Ÿæœºçš„å †å†…å­˜æ˜¯å¦å¯ä»¥è°ƒå¤§ï¼Œä»ä»£ç ä¸Šæ£€æŸ¥æ˜¯å¦æŸäº›å¯¹è±¡ç”Ÿå‘½å‘¨æœŸè¿‡é•¿ï¼Œå‡å°‘å†…å­˜æ¶ˆè€—ï¼Œä¼˜åŒ–ä»£ç ã€‚ è™šæ‹Ÿæœºæ ˆæº¢å‡º å…³äºè™šæ‹Ÿæœºæ ˆï¼Œåœ¨javaè™šæ‹Ÿæœºè§„èŒƒä¸­æè¿°äº†ä¸¤ç§å¼‚å¸¸ï¼š ï¼ˆ1ï¼‰å¦‚æœçº¿ç¨‹è¯·æ±‚çš„æ ˆæ·±åº¦å¤§äºè™šæ‹Ÿæœºæ‰€å…è®¸çš„æœ€å¤§æ·±åº¦ï¼Œå°†æŠ›å‡ºStackOverFlowErrorå¼‚å¸¸ã€‚ ï¼ˆ2ï¼‰å¦‚æœè™šæ‹Ÿæœºåœ¨æ‰©å±•æ ˆæ—¶æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ç©ºé—´ï¼Œåˆ™æŠ›å‡ºOutOdMemoryErrorå¼‚å¸¸ã€‚ è¿™é‡Œæè¿°çš„ä¸¤ç§æƒ…å†µå®é™…ä¸Šæœ‰äº›é‡å ï¼šå½“æ ˆç©ºé—´æ— æ³•ç»§ç»­åˆ†é…çš„æ—¶å€™ï¼Œåˆ°åº•æ˜¯å†…å­˜å¤ªå°å¯¼è‡´çš„ï¼Œè¿˜æ˜¯å·²ä½¿ç”¨çš„æ ˆç©ºé—´å¤ªå¤§ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„ã€‚ public class StackSOFTest { private int stackLength = -1; public void stackLeak() { stackLength++; stackLeak(); } public static void main(String [] args) throws Throwable { StackSOFTest oom = new StackSOFTest(); try { oom.stackLeak(); } catch (Throwable e) { System.out.println(&quot;stack length:&quot;+oom.stackLength); throw e; } } } è¿è¡Œç»“æœï¼š tack length:13980 Exception in thread &quot;main&quot; java.lang.StackOverflowError at oom.StackSOFTest.stackLeak(StackSOFTest.java:14) at oom.StackSOFTest.stackLeak(StackSOFTest.java:14) at oom.StackSOFTest.stackLeak(StackSOFTest.java:14) ...åç»­çœç•¥ å®éªŒç»“æœè¡¨æ˜ï¼šåœ¨å•ä¸ªçº¿ç¨‹ä¸‹ï¼Œæ— è®ºæ˜¯ç”±äºæ ˆå¸§å¤ªå¤§è¿˜æ˜¯è™šæ‹Ÿæœºæ ˆå®¹é‡å¤ªå°ï¼Œå½“å†…å­˜æ— æ³•åˆ†é…æ—¶ï¼Œè™šæ‹ŸæœºæŠ›å‡ºçš„éƒ½æ˜¯StackOverflowErrorå¼‚å¸¸ã€‚ å“ªäº›å†…å­˜éœ€è¦å›æ”¶ï¼Ÿ çŒ¿ä»¬éƒ½çŸ¥é“JVMçš„å†…å­˜ç»“æ„åŒ…æ‹¬äº”å¤§åŒºåŸŸï¼šç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆã€æœ¬åœ°æ–¹æ³•æ ˆã€å †åŒºã€æ–¹æ³•åŒºã€‚å…¶ä¸­ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆã€æœ¬åœ°æ–¹æ³•æ ˆ3ä¸ªåŒºåŸŸéšçº¿ç¨‹è€Œç”Ÿã€éšçº¿ç¨‹è€Œç­ï¼Œå› æ­¤è¿™å‡ ä¸ªåŒºåŸŸçš„å†…å­˜åˆ†é…å’Œå›æ”¶éƒ½å…·å¤‡ç¡®å®šæ€§ï¼Œå°±ä¸éœ€è¦è¿‡å¤šè€ƒè™‘å›æ”¶çš„é—®é¢˜ï¼Œå› ä¸ºæ–¹æ³•ç»“æŸæˆ–è€…çº¿ç¨‹ç»“æŸæ—¶ï¼Œå†…å­˜è‡ªç„¶å°±è·Ÿéšç€å›æ”¶äº†ã€‚è€ŒJavaå †åŒºå’Œæ–¹æ³•åŒºåˆ™ä¸ä¸€æ ·ã€ä¸ä¸€æ ·!(æ€ä¹ˆä¸ä¸€æ ·è¯´çš„æœ—æœ—ä¸Šå£)ï¼Œè¿™éƒ¨åˆ†å†…å­˜çš„åˆ†é…å’Œå›æ”¶æ˜¯åŠ¨æ€çš„ï¼Œæ­£æ˜¯åƒåœ¾æ”¶é›†å™¨æ‰€éœ€å…³æ³¨çš„éƒ¨åˆ†ã€‚ åƒåœ¾æ”¶é›†å™¨åœ¨å¯¹å †åŒºå’Œæ–¹æ³•åŒºè¿›è¡Œå›æ”¶å‰ï¼Œé¦–å…ˆè¦ç¡®å®šè¿™äº›åŒºåŸŸçš„å¯¹è±¡å“ªäº›å¯ä»¥è¢«å›æ”¶ï¼Œå“ªäº›æš‚æ—¶è¿˜ä¸èƒ½å›æ”¶ï¼Œè¿™å°±è¦ç”¨åˆ°åˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜æ´»çš„ç®—æ³•ï¼ï¼ˆé¢è¯•å®˜è‚¯å®šæ²¡å°‘é—®ä½ å§ï¼‰ 2.1 å¼•ç”¨è®¡æ•°ç®—æ³• 2.1.1 ç®—æ³•åˆ†æ å¼•ç”¨è®¡æ•°æ˜¯åƒåœ¾æ”¶é›†å™¨ä¸­çš„æ—©æœŸç­–ç•¥ã€‚åœ¨è¿™ç§æ–¹æ³•ä¸­ï¼Œå †ä¸­æ¯ä¸ªå¯¹è±¡å®ä¾‹éƒ½æœ‰ä¸€ä¸ªå¼•ç”¨è®¡æ•°ã€‚å½“ä¸€ä¸ªå¯¹è±¡è¢«åˆ›å»ºæ—¶ï¼Œå°±å°†è¯¥å¯¹è±¡å®ä¾‹åˆ†é…ç»™ä¸€ä¸ªå˜é‡ï¼Œè¯¥å˜é‡è®¡æ•°è®¾ç½®ä¸º1ã€‚å½“ä»»ä½•å…¶å®ƒå˜é‡è¢«èµ‹å€¼ä¸ºè¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨æ—¶ï¼Œè®¡æ•°åŠ 1ï¼ˆa = b,åˆ™bå¼•ç”¨çš„å¯¹è±¡å®ä¾‹çš„è®¡æ•°å™¨+1ï¼‰ï¼Œä½†å½“ä¸€ä¸ªå¯¹è±¡å®ä¾‹çš„æŸä¸ªå¼•ç”¨è¶…è¿‡äº†ç”Ÿå‘½å‘¨æœŸæˆ–è€…è¢«è®¾ç½®ä¸ºä¸€ä¸ªæ–°å€¼æ—¶ï¼Œå¯¹è±¡å®ä¾‹çš„å¼•ç”¨è®¡æ•°å™¨å‡1ã€‚ä»»ä½•å¼•ç”¨è®¡æ•°å™¨ä¸º0çš„å¯¹è±¡å®ä¾‹å¯ä»¥è¢«å½“ä½œåƒåœ¾æ”¶é›†ã€‚å½“ä¸€ä¸ªå¯¹è±¡å®ä¾‹è¢«åƒåœ¾æ”¶é›†æ—¶ï¼Œå®ƒå¼•ç”¨çš„ä»»ä½•å¯¹è±¡å®ä¾‹çš„å¼•ç”¨è®¡æ•°å™¨å‡1ã€‚ 2.1.2 ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ï¼šå¼•ç”¨è®¡æ•°æ”¶é›†å™¨å¯ä»¥å¾ˆå¿«çš„æ‰§è¡Œï¼Œäº¤ç»‡åœ¨ç¨‹åºè¿è¡Œä¸­ã€‚å¯¹ç¨‹åºéœ€è¦ä¸è¢«é•¿æ—¶é—´æ‰“æ–­çš„å®æ—¶ç¯å¢ƒæ¯”è¾ƒæœ‰åˆ©ã€‚ ç¼ºç‚¹ï¼šæ— æ³•æ£€æµ‹å‡ºå¾ªç¯å¼•ç”¨ã€‚å¦‚çˆ¶å¯¹è±¡æœ‰ä¸€ä¸ªå¯¹å­å¯¹è±¡çš„å¼•ç”¨ï¼Œå­å¯¹è±¡åè¿‡æ¥å¼•ç”¨çˆ¶å¯¹è±¡ã€‚è¿™æ ·ï¼Œä»–ä»¬çš„å¼•ç”¨è®¡æ•°æ°¸è¿œä¸å¯èƒ½ä¸º0ã€‚ 2.1.3 æ˜¯ä¸æ˜¯å¾ˆæ— è¶£ï¼Œæ¥æ®µä»£ç å‹å‹æƒŠ public class ReferenceFindTest { public static void main(String[] args) { MyObject object1 = new MyObject(); MyObject object2 = new MyObject(); object1.object = object2; object2.object = object1; object1 = null; object2 = null; } } è¿™æ®µä»£ç æ˜¯ç”¨æ¥éªŒè¯å¼•ç”¨è®¡æ•°ç®—æ³•ä¸èƒ½æ£€æµ‹å‡ºå¾ªç¯å¼•ç”¨ã€‚æœ€åé¢ä¸¤å¥å°†object1å’Œobject2èµ‹å€¼ä¸ºnullï¼Œä¹Ÿå°±æ˜¯è¯´object1å’Œobject2æŒ‡å‘çš„å¯¹è±¡å·²ç»ä¸å¯èƒ½å†è¢«è®¿é—®ï¼Œä½†æ˜¯ç”±äºå®ƒä»¬äº’ç›¸å¼•ç”¨å¯¹æ–¹ï¼Œå¯¼è‡´å®ƒä»¬çš„å¼•ç”¨è®¡æ•°å™¨éƒ½ä¸ä¸º0ï¼Œé‚£ä¹ˆåƒåœ¾æ”¶é›†å™¨å°±æ°¸è¿œä¸ä¼šå›æ”¶å®ƒä»¬ã€‚ 2.2 å¯è¾¾æ€§åˆ†æç®—æ³• å¯è¾¾æ€§åˆ†æç®—æ³•æ˜¯ä»ç¦»æ•£æ•°å­¦ä¸­çš„å›¾è®ºå¼•å…¥çš„ï¼Œç¨‹åºæŠŠæ‰€æœ‰çš„å¼•ç”¨å…³ç³»çœ‹ä½œä¸€å¼ å›¾ï¼Œä»ä¸€ä¸ªèŠ‚ç‚¹GC ROOTå¼€å§‹ï¼Œå¯»æ‰¾å¯¹åº”çš„å¼•ç”¨èŠ‚ç‚¹ï¼Œæ‰¾åˆ°è¿™ä¸ªèŠ‚ç‚¹ä»¥åï¼Œç»§ç»­å¯»æ‰¾è¿™ä¸ªèŠ‚ç‚¹çš„å¼•ç”¨èŠ‚ç‚¹ï¼Œå½“æ‰€æœ‰çš„å¼•ç”¨èŠ‚ç‚¹å¯»æ‰¾å®Œæ¯•ä¹‹åï¼Œå‰©ä½™çš„èŠ‚ç‚¹åˆ™è¢«è®¤ä¸ºæ˜¯æ²¡æœ‰è¢«å¼•ç”¨åˆ°çš„èŠ‚ç‚¹ï¼Œå³æ— ç”¨çš„èŠ‚ç‚¹ï¼Œæ— ç”¨çš„èŠ‚ç‚¹å°†ä¼šè¢«åˆ¤å®šä¸ºæ˜¯å¯å›æ”¶çš„å¯¹è±¡ã€‚ åœ¨Javaè¯­è¨€ä¸­ï¼Œå¯ä½œä¸ºGC Rootsçš„å¯¹è±¡åŒ…æ‹¬ä¸‹é¢å‡ ç§ï¼š a) è™šæ‹Ÿæœºæ ˆä¸­å¼•ç”¨çš„å¯¹è±¡ï¼ˆæ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡è¡¨ï¼‰ï¼› b) æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡ï¼› c) æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡ï¼› d) æœ¬åœ°æ–¹æ³•æ ˆä¸­JNIï¼ˆNativeæ–¹æ³•ï¼‰å¼•ç”¨çš„å¯¹è±¡ã€‚ å¯¹è±¡æ˜¯â€œç”Ÿâ€æ˜¯â€œæ­» å¯¹è±¡çš„å››ç§å¼•ç”¨ å¼•ç”¨åˆ†ä¸ºå¼ºå¼•ç”¨ï¼Œè½¯å¼•ç”¨ï¼Œå¼±å¼•ç”¨å’Œè™šå¼•ç”¨å››ç§ï¼Œè¿™å››ç§å¼•ç”¨å¼ºåº¦ä¾æ¬¡é€æ¸å‡å¼±ã€‚ å¼ºå¼•ç”¨ å¼ºå¼•ç”¨å°±æ˜¯æŒ‡åœ¨ç¨‹åºä»£ç ä¸­æ™®éå­˜åœ¨çš„ï¼Œæ˜¯æŒ‡åˆ›å»ºä¸€ä¸ªå¯¹è±¡å¹¶æŠŠè¿™ä¸ªå¯¹è±¡èµ‹ç»™ä¸€ä¸ªå¼•ç”¨å˜é‡ï¼Œç±»ä¼¼Object obj = new Object()è¿™ç±»çš„å¼•ç”¨ï¼Œåªè¦å¼ºå¼•ç”¨è¿˜å­˜åœ¨ï¼Œåƒåœ¾æ”¶é›†å™¨å°±æ°¸è¿œä¸ä¼šå›æ”¶è¢«å¼•ç”¨çš„å¯¹è±¡ã€‚å¦‚æœæƒ³ä¸­æ–­å¼ºå¼•ç”¨å’ŒæŸä¸ªå¯¹è±¡ä¹‹é—´çš„å…³è”ï¼Œå¯ä»¥æ˜¾ç¤ºçš„å°†å¼•ç”¨èµ‹å€¼ä¸ºnullï¼Œè¿™æ ·jvmåœ¨åˆé€‚çš„æ—¶é—´å°±ä¼šå›æ”¶è¯¥å¯¹è±¡ã€‚ è½¯å¼•ç”¨ è½¯å¼•ç”¨æ˜¯ç”¨æ¥æè¿°ä¸€äº›è¿˜æœ‰ç”¨ä½†å¹¶éå¿…éœ€çš„å¯¹è±¡ã€‚å¯¹äºè½¯å¼•ç”¨å…³è”ç€çš„å¯¹è±¡ï¼Œåœ¨ç³»ç»Ÿå°†ä¼šå‘ç”Ÿå†…å­˜æº¢å‡ºå¼‚å¸¸ä¹‹å‰ï¼Œå°†ä¼šæŠŠè¿™äº›å¯¹è±¡åˆ—è¿›å›æ”¶èŒƒå›´ä¹‹ä¸­è¿›è¡Œç¬¬äºŒæ¬¡å›æ”¶ã€‚SoftReferenceçš„ç‰¹ç‚¹æ˜¯å®ƒçš„ä¸€ä¸ªå®ä¾‹ä¿å­˜å¯¹ä¸€ä¸ªJavaå¯¹è±¡çš„è½¯å¼•ç”¨ï¼Œè¯¥è½¯å¼•ç”¨çš„å­˜åœ¨ä¸å¦¨ç¢åƒåœ¾æ”¶é›†å™¨çº¿ç¨‹å¯¹è¯¥Javaå¯¹è±¡çš„å›æ”¶ã€‚ å¼±å¼•ç”¨ å¼±å¼•ç”¨ä¹Ÿæ˜¯ç”¨æ¥æè¿°éå¿…éœ€å¯¹è±¡çš„ã€‚å½“JVMè¿›è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œæ— è®ºå†…å­˜æ˜¯å¦å……è¶³ï¼Œéƒ½ä¼šå›æ”¶è¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡ã€‚åœ¨javaä¸­ï¼Œç”¨java.lang.ref.WeakReferenceç±»æ¥è¡¨ç¤ºã€‚ è™šå¼•ç”¨ è™šå¼•ç”¨å’Œå‰é¢çš„è½¯å¼•ç”¨å’Œå¼±å¼•ç”¨ä¸åŒï¼Œå®ƒå¹¶ä¸å½±å“å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚åœ¨javaä¸­ä½¿ç”¨PhantomReferenceç±»æ¥è¡¨ç¤ºã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡ä¸è™šå¼•ç”¨å…³è”ï¼Œè·Ÿæ²¡æœ‰å¼•ç”¨ä¸ä¹‹å…³è”ä¸€æ ·ï¼Œä»»ä½•æ—¶å€™éƒ½å¯èƒ½è¢«å›æ”¶ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œè™šå¼•ç”¨å¿…é¡»å’Œå¼•ç”¨é˜Ÿåˆ—å…³è”ä½¿ç”¨ã€‚å½“åƒåœ¾æ”¶é›†å™¨å‡†å¤‡å›æ”¶ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå¦‚æœå‘ç°å®ƒè¿˜æœ‰è™šå¼•ç”¨ï¼Œå°±ä¼šæŠŠè¿™ä¸ªè™šå¼•ç”¨åŠ å…¥åˆ°ä¸ä¹‹å…³è”çš„å¼•ç”¨é˜Ÿåˆ—ä¸­ã€‚ä¸ºå¯¹è±¡è®¾ç½®è™šå¼•ç”¨çš„å”¯ä¸€ç›®çš„å°±æ˜¯èƒ½åœ¨è¿™ä¸ªå¯¹è±¡è¢«åƒåœ¾æ”¶é›†å™¨å›æ”¶æ—¶æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥ã€‚ å¼•ç”¨è®¡æ•°æ³•çš„ç¼ºé™· å¼•ç”¨è®¡æ•°æ³•å°±æ˜¯ç»™å¯¹è±¡æ·»åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œæ¯å½“æœ‰ä¸€ä¸ªåœ°æ–¹å¼•ç”¨å®ƒæ—¶ï¼Œè®¡æ•°å™¨å€¼å°±åŠ 1.å½“å¼•ç”¨å¤±æ•ˆæ—¶ï¼Œè®¡æ•°å™¨çš„å€¼å°±å‡ä¸€ã€‚ä»»ä½•æ—¶åˆ»è®¡æ•°å™¨å€¼ä¸º0çš„å¯¹è±¡å°±æ˜¯ä¸å¯èƒ½å†è¢«ä½¿ç”¨çš„ã€‚ ä¼˜ç¼ºç‚¹ï¼šå®ç°ç®€å•ï¼Œåˆ¤æ–­æ•ˆç‡é«˜ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹æ˜¯ä¸ªå¾ˆä¸é”™çš„ç®—æ³•ã€‚ä½†æ˜¯è‡´å‘½é—®é¢˜æ˜¯æ²¡åŠæ³•è§£å†³å¯¹è±¡ä¹‹é—´ç›¸äº’å¾ªç¯å¼•ç”¨çš„é—®é¢˜ã€‚ public class ReferenceCountingGC { private Object instance = null; private static final int _1MB = 1024*1024; private byte[] bigSize = new byte[2*_1MB]; public static void main(String [] args) { ReferenceCountingGC objA = new ReferenceCountingGC(); ReferenceCountingGC objB = new ReferenceCountingGC(); objA.instance = objB; objB.instance = objA; objA = null; objB = null; //å‡è®¾åœ¨è¿™è¡Œå‘ç”ŸGCï¼ŒObjAå’ŒObjBæ˜¯å¦èƒ½è¢«å›æ”¶ System.gc(); } } è§‚å¯ŸGCæ—¥å¿—å¯ä»¥çœ‹å‡ºGCå‘ç”Ÿäº†å†…å­˜å›æ”¶ï¼Œæ„å‘³ç€è™šæ‹Ÿæœºå¹¶æ²¡æœ‰å› ä¸ºè¿™ä¸¤ä¸ªå¯¹è±¡ç›¸äº’å¼•ç”¨å°±ä¸å›æ”¶å®ƒä»¬ï¼Œè¿™ä¹Ÿä»ä¾§é¢è¯´æ˜è™šæ‹Ÿæœºå¹¶æ²¡æœ‰é‡‡ç”¨å¼•ç”¨è®¡æ•°æ³•æ¥åˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜æ´»ã€‚ å¯è¾¾æ€§åˆ†æ è¿™ä¸ªç®—æ³•çš„åŸºæœ¬æ€æƒ³æ˜¯é€šè¿‡ä¸€ç³»åˆ—è¢«ç§°ä¸ºâ€œGC Rootsâ€çš„å¯¹è±¡ä½œä¸ºèµ·å§‹ç‚¹ï¼Œä»è¿™äº›èŠ‚ç‚¹å¼€å§‹å‘ä¸‹æœç´¢ï¼Œæœç´¢èµ°è¿‡çš„è·¯å¾„å«åšå¼•ç”¨é“¾ï¼Œå½“ä¸€ä¸ªå¯¹è±¡åˆ°GC Rootsæ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿ ï¼ˆç”¨å›¾è®ºçš„è¯æ¥è¯´å°±æ˜¯ä»GC Rootsåˆ°è¿™ä¸ªå¯¹è±¡ä¸å¯è¾¾ï¼‰ï¼Œåˆ™è¯æ˜æ­¤å¯¹è±¡æ˜¯ä¸å¯ç”¨çš„ã€‚ åœ¨ Javaè¯­è¨€ä¸­ï¼Œå¯ä½œä¸ºGC Rootsçš„å¯¹è±¡åŒ…æ‹¬ä»¥ä¸‹å‡ ç§ ï¼ˆ1ï¼‰è™šæ‹Ÿæœºæ ˆï¼ˆæ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡è¡¨ï¼‰ä¸­å¼•ç”¨çš„å¯¹è±¡ã€‚ ï¼ˆ2ï¼‰æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡ã€‚ ï¼ˆ3ï¼‰æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡ã€‚ ï¼ˆ4ï¼‰æœ¬åœ°æ–¹æ³•æ ˆä¸­JNIï¼ˆå³ä¸€èˆ¬è¯´çš„Nativeæ–¹æ³•ï¼‰å¼•ç”¨çš„å¯¹è±¡ã€‚ å¯¹è±¡æ˜¯ç”Ÿå­˜è¿˜æ˜¯æ­»äº¡ï¼Ÿ å³ä½¿åœ¨å¯è¾¾æ€§åˆ†ææ³•ä¸­ä¸å¯è¾¾çš„å¯¹è±¡ï¼Œä¹Ÿå¹¶éâ€œéæ­»ä¸å¯â€ï¼Œä»–ä»¬è¿˜æœ‰æ‹¯æ•‘è‡ªå·±çš„æœºä¼šã€‚è¦å®£å‘Šä¸€ä¸ªå¯¹è±¡æ­»äº¡ï¼Œè‡³å°‘è¦ç»å†ä¸¤æ¬¡æ ‡è®°è¿‡ç¨‹ï¼šå¦‚æœå¯¹è±¡åœ¨è¿›è¡Œå¯è¾¾æ€§åˆ†æåæ²¡æœ‰ä¸GC Rootsçš„å¼•ç”¨é“¾ï¼Œé‚£ä¹ˆå®ƒå°†ä¼šè¢«ç¬¬ä¸€æ¬¡æ ‡è®°ï¼Œå¹¶ä¸”æ­¤æ—¶éœ€è¦åˆ¤æ–­æ˜¯å¦æœ‰å¿…è¦æ‰§è¡Œfinalize()æ–¹æ³•ã€‚æ²¡æœ‰å¿…è¦çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°±å®£å‘Šæ­»äº¡ï¼Œå¯ä»¥å›æ”¶äº†ã€‚ å¦‚æœæœ‰å¿…è¦æ‰§è¡Œï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡ä¼šè¢«æ”¾ç½®åœ¨ä¸€ä¸ªå«åšF-Queueçš„é˜Ÿåˆ—ä¸­ï¼Œå¹¶åœ¨ç¨åç”±è™šæ‹Ÿæœºè‡ªåŠ¨å»ºç«‹çš„ä½ä¼˜å…ˆçº§çš„Finalizerçº¿ç¨‹å»æ‰§è¡Œå®ƒã€‚finalize()æ˜¯å¯¹è±¡æ‹¯æ•‘è‡ªå·±çš„æœ€åä¸€æ¬¡æœºä¼š-åªè¦é‡æ–°ä¸å¼•ç”¨é“¾ä¸Šçš„ ä»»ä½•ä¸€ä¸ªå¯¹è±¡å»ºç«‹å…³è”å³å¯ï¼ˆè­¬å¦‚æŠŠè‡ªå·±èµ‹å€¼ç»™æŸä¸ªç±»å˜é‡æˆ–è€…å¯¹è±¡çš„æˆå‘˜å˜é‡ï¼‰ï¼Œé‚£ä¹ˆåœ¨ç¬¬äºŒæ¬¡æ ‡è®°æ—¶å®ƒå°†è¢«ç§»é™¤â€œå¯å›æ”¶â€çš„é›†åˆï¼Œå¦‚æœå¯¹è±¡è¿˜æ²¡æœ‰é€ƒè„±ï¼ŒåŸºæœ¬ä¸Šå°±çœŸçš„è¢«å›æ”¶äº†ã€‚ å…·ä½“çš„è¿‡ç¨‹è§ä¸‹å›¾ï¼š åƒåœ¾æ”¶é›†ç®—æ³• æ ‡è®°æ¸…é™¤ç®—æ³• æ ‡è®°-æ¸…é™¤ç®—æ³•æ˜¯æœ€åŸºç¡€çš„ç®—æ³•ï¼Œåˆ†ä¸ºâ€œæ ‡è®°â€å’Œâ€œæ¸…é™¤â€ä¸¤ä¸ªé˜¶æ®µï¼šé¦–å…ˆæ ‡è®°å‡ºæ‰€æœ‰éœ€è¦å›æ”¶çš„å¯¹è±¡ï¼Œåœ¨æ ‡è®°å®Œæˆåç»Ÿä¸€å›æ”¶ã€‚ å®ƒçš„ä¸»è¦ä¸è¶³æœ‰ä¸¤ä¸ªï¼šä¸€æ˜¯æ•ˆç‡é—®é¢˜ï¼Œæ ‡è®°å’Œæ¸…é™¤ä¸¤ä¸ªè¿‡ç¨‹çš„æ•ˆç‡éƒ½ä¸é«˜ï¼›å¦ä¸€ä¸ªæ˜¯ç©ºé—´é—®é¢˜ï¼Œæ ‡è®°æ¸…æ¥šä¹‹åä¼šäº§ç”Ÿå¤§é‡ä¸è¿ç»­çš„å†…å­˜ç¢ç‰‡ã€‚ æ ‡è®°-æ¸…é™¤ç®—æ³•çš„æ‰§è¡Œè¿‡ç¨‹è§ä¸‹å›¾ï¼š å¤åˆ¶ç®—æ³• ä¸ºäº†è§£å†³æ•ˆç‡é—®é¢˜ï¼Œâ€œå¤åˆ¶â€ç®—æ³•å‡ºç°äº†ã€‚å®ƒå°†å†…å­˜ç©ºé—´åˆ’åˆ†ä¸ºå¤§å°ç›¸ç­‰çš„ä¸¤å—ï¼Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­çš„ä¸€å—ï¼Œå½“è¿™ä¸€å—çš„å†…å­˜ç”¨å®Œäº†ï¼Œå°±å°†è¿˜å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¦å¤–ä¸€å—ä¸Šï¼Œç„¶åå†æŠŠå·²ä½¿ç”¨çš„çš„å†…å­˜ç©ºé—´ä¸€æ¬¡æ€§æ¸…ç†æ‰ã€‚ è¿™æ ·æ¯æ¬¡éƒ½æ˜¯å¯¹æ•´ä¸ªåŠåŒºè¿›è¡Œå†…å­˜å›æ”¶ï¼Œå†…å­˜åˆ†é…æ—¶ä¹Ÿå°±ä¸ç”¨è€ƒè™‘å†…å­˜ç¢ç‰‡ç­‰å¤æ‚æƒ…å†µï¼Œåªè¦ç§»åŠ¨å †é¡¶æŒ‡é’ˆï¼ŒæŒ‰é¡ºåºåˆ†é…å†…å­˜å³å¯ï¼Œå®ç°ç®€å•ï¼Œè¿è¡Œé«˜æ•ˆã€‚ä½†æ˜¯è¿™ç§ç®—æ³•çš„ä»£ç æ˜¯å°†å†…å­˜ç©ºé—´ç¼©å°ä¸ºåŸæ¥çš„ä¸€åŠã€‚ å¤åˆ¶ç®—æ³•çš„æ‰§è¡Œè¿‡ç¨‹è§ä¸‹å›¾ï¼š æ ‡è®°-æ•´ç†ç®—æ³• æ ‡è®°è¿‡ç¨‹ä»ç„¶ä¸æ ‡è®°-æ¸…é™¤ç®—æ³•ä¸€æ ·ï¼Œä½†åç»­æ­¥éª¤ä¸æ˜¯ç›´æ¥å¯¹å¯å›æ”¶å¯¹è±¡è¿›è¡Œæ¸…ç†ï¼Œè€Œæ˜¯è®©æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡éƒ½å‘ä¸€ç«¯ç§»åŠ¨ï¼Œç„¶åç›´æ¥æ¸…ç†æ‰è¾¹ç•Œä»¥å¤–çš„å†…å­˜ã€‚ æ ‡è®°-æ•´ç†ç®—æ³•çš„æ‰§è¡Œè¿‡ç¨‹è§ä¸‹å›¾ï¼š åˆ†ä»£æ”¶é›†ç®—æ³• åˆ†ä»£æ”¶é›†ç®—æ³•æ˜¯ç›®å‰å¤§éƒ¨åˆ†JVMçš„åƒåœ¾æ”¶é›†å™¨é‡‡ç”¨çš„ç®—æ³•ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯æ ¹æ®å¯¹è±¡å­˜æ´»çš„ç”Ÿå‘½å‘¨æœŸå°†å†…å­˜åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªä¸åŒçš„åŒºåŸŸã€‚ä¸€èˆ¬æƒ…å†µä¸‹å°†å †åŒºåˆ’åˆ†ä¸ºè€å¹´ä»£ï¼ˆTenured Generationï¼‰å’Œæ–°ç”Ÿä»£ï¼ˆYoung Generationï¼‰ï¼Œåœ¨å †åŒºä¹‹å¤–è¿˜æœ‰ä¸€ä¸ªä»£å°±æ˜¯æ°¸ä¹…ä»£ï¼ˆPermanet Generationï¼‰ã€‚è€å¹´ä»£çš„ç‰¹ç‚¹æ˜¯æ¯æ¬¡åƒåœ¾æ”¶é›†æ—¶åªæœ‰å°‘é‡å¯¹è±¡éœ€è¦è¢«å›æ”¶ï¼Œè€Œæ–°ç”Ÿä»£çš„ç‰¹ç‚¹æ˜¯æ¯æ¬¡åƒåœ¾å›æ”¶æ—¶éƒ½æœ‰å¤§é‡çš„å¯¹è±¡éœ€è¦è¢«å›æ”¶ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ ¹æ®ä¸åŒä»£çš„ç‰¹ç‚¹é‡‡å–æœ€é€‚åˆçš„æ”¶é›†ç®—æ³•ã€‚ 3.4.1 å¹´è½»ä»£ï¼ˆYoung Generationï¼‰çš„å›æ”¶ç®—æ³• a) æ‰€æœ‰æ–°ç”Ÿæˆçš„å¯¹è±¡é¦–å…ˆéƒ½æ˜¯æ”¾åœ¨å¹´è½»ä»£çš„ã€‚å¹´è½»ä»£çš„ç›®æ ‡å°±æ˜¯å°½å¯èƒ½å¿«é€Ÿçš„æ”¶é›†æ‰é‚£äº›ç”Ÿå‘½å‘¨æœŸçŸ­çš„å¯¹è±¡ã€‚ b) æ–°ç”Ÿä»£å†…å­˜æŒ‰ç…§8:1:1çš„æ¯”ä¾‹åˆ†ä¸ºä¸€ä¸ªedenåŒºå’Œä¸¤ä¸ªsurvivor(survivor0,survivor1)åŒºã€‚ä¸€ä¸ªEdenåŒºï¼Œä¸¤ä¸ª SurvivoråŒº(ä¸€èˆ¬è€Œè¨€)ã€‚å¤§éƒ¨åˆ†å¯¹è±¡åœ¨EdenåŒºä¸­ç”Ÿæˆã€‚å›æ”¶æ—¶å…ˆå°†edenåŒºå­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°ä¸€ä¸ªsurvivor0åŒºï¼Œç„¶åæ¸…ç©ºedenåŒºï¼Œå½“è¿™ä¸ªsurvivor0åŒºä¹Ÿå­˜æ”¾æ»¡äº†æ—¶ï¼Œåˆ™å°†edenåŒºå’Œsurvivor0åŒºå­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€ä¸ªsurvivor1åŒºï¼Œç„¶åæ¸…ç©ºedenå’Œè¿™ä¸ªsurvivor0åŒºï¼Œæ­¤æ—¶survivor0åŒºæ˜¯ç©ºçš„ï¼Œç„¶åå°†survivor0åŒºå’Œsurvivor1åŒºäº¤æ¢ï¼Œå³ä¿æŒsurvivor1åŒºä¸ºç©ºï¼Œ å¦‚æ­¤å¾€å¤ã€‚ c) å½“survivor1åŒºä¸è¶³ä»¥å­˜æ”¾ edenå’Œsurvivor0çš„å­˜æ´»å¯¹è±¡æ—¶ï¼Œå°±å°†å­˜æ´»å¯¹è±¡ç›´æ¥å­˜æ”¾åˆ°è€å¹´ä»£ã€‚è‹¥æ˜¯è€å¹´ä»£ä¹Ÿæ»¡äº†å°±ä¼šè§¦å‘ä¸€æ¬¡Full GCï¼Œä¹Ÿå°±æ˜¯æ–°ç”Ÿä»£ã€è€å¹´ä»£éƒ½è¿›è¡Œå›æ”¶ã€‚ d) æ–°ç”Ÿä»£å‘ç”Ÿçš„GCä¹Ÿå«åšMinor GCï¼ŒMinorGCå‘ç”Ÿé¢‘ç‡æ¯”è¾ƒé«˜(ä¸ä¸€å®šç­‰EdenåŒºæ»¡äº†æ‰è§¦å‘)ã€‚ 3.4.2 å¹´è€ä»£ï¼ˆOld Generationï¼‰çš„å›æ”¶ç®—æ³• a) åœ¨å¹´è½»ä»£ä¸­ç»å†äº†Næ¬¡åƒåœ¾å›æ”¶åä»ç„¶å­˜æ´»çš„å¯¹è±¡ï¼Œå°±ä¼šè¢«æ”¾åˆ°å¹´è€ä»£ä¸­ã€‚å› æ­¤ï¼Œå¯ä»¥è®¤ä¸ºå¹´è€ä»£ä¸­å­˜æ”¾çš„éƒ½æ˜¯ä¸€äº›ç”Ÿå‘½å‘¨æœŸè¾ƒé•¿çš„å¯¹è±¡ã€‚ b) å†…å­˜æ¯”æ–°ç”Ÿä»£ä¹Ÿå¤§å¾ˆå¤š(å¤§æ¦‚æ¯”ä¾‹æ˜¯1:2)ï¼Œå½“è€å¹´ä»£å†…å­˜æ»¡æ—¶è§¦å‘Major GCå³Full GCï¼ŒFull GCå‘ç”Ÿé¢‘ç‡æ¯”è¾ƒä½ï¼Œè€å¹´ä»£å¯¹è±¡å­˜æ´»æ—¶é—´æ¯”è¾ƒé•¿ï¼Œå­˜æ´»ç‡æ ‡è®°é«˜ã€‚ 3.4.3 æŒä¹…ä»£ï¼ˆPermanent Generationï¼‰çš„å›æ”¶ç®—æ³• ç”¨äºå­˜æ”¾é™æ€æ–‡ä»¶ï¼Œå¦‚Javaç±»ã€æ–¹æ³•ç­‰ã€‚æŒä¹…ä»£å¯¹åƒåœ¾å›æ”¶æ²¡æœ‰æ˜¾è‘—å½±å“ï¼Œä½†æ˜¯æœ‰äº›åº”ç”¨å¯èƒ½åŠ¨æ€ç”Ÿæˆæˆ–è€…è°ƒç”¨ä¸€äº›classï¼Œä¾‹å¦‚Hibernate ç­‰ï¼Œåœ¨è¿™ç§æ—¶å€™éœ€è¦è®¾ç½®ä¸€ä¸ªæ¯”è¾ƒå¤§çš„æŒä¹…ä»£ç©ºé—´æ¥å­˜æ”¾è¿™äº›è¿è¡Œè¿‡ç¨‹ä¸­æ–°å¢çš„ç±»ã€‚æŒä¹…ä»£ä¹Ÿç§°æ–¹æ³•åŒºï¼Œ åƒåœ¾æ”¶é›†å™¨ å †å†…å­˜æ˜¯åƒåœ¾æ”¶é›†å™¨ä¸»è¦å›æ”¶åƒåœ¾å¯¹è±¡çš„åœ°æ–¹ï¼Œå †å†…å­˜å¯ä»¥æ ¹æ®å¯¹è±¡ç”Ÿå‘½å‘¨æœŸçš„ä¸åŒåˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œåˆ†ä»£æ”¶é›†ï¼Œæ–°ç”Ÿä»£ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£ä½¿ç”¨æ ‡è®°æ¸…é™¤æˆ–è€…æ ‡è®°æ•´ç†ç®—æ³•ã€‚ HotSpotè™šæ‹Ÿæœºæä¾›äº†7ç§åƒåœ¾æ”¶é›†å™¨ï¼Œå…¶ä¸­æ–°ç”Ÿä»£ä¸‰ç§ï¼šSerial/ParNew/Parallel Scavengeæ”¶é›†å™¨ï¼Œè€å¹´ä»£ä¸‰ç§ï¼šSerial Old/Parallel Old/CMSï¼Œéƒ½é€‚ç”¨çš„æ˜¯G1æ”¶é›†å™¨ã€‚æ‰€æœ‰åƒåœ¾æ”¶é›†å™¨ç»„åˆ æƒ…å†µå¦‚ä¸‹å›¾ï¼š Serialæ”¶é›†å™¨ æœ€åŸºæœ¬ä¹Ÿæ˜¯å‘å±•å†å²æœ€é•¿çš„åƒåœ¾æ”¶é›†å™¨ï¼Œåœ¨è¿›è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼Œå¿…é¡»Stop The World(æš‚åœå…¶ä»–å·¥ä½œçº¿ç¨‹)ï¼Œç›´åˆ°æ”¶é›†ç»“æŸã€‚åªä½¿ç”¨ä¸€æ¡çº¿ç¨‹å®Œæˆåƒåœ¾æ”¶é›†ï¼Œä½†æ˜¯æ•ˆç‡é«˜ï¼Œå› ä¸ºæ²¡æœ‰çº¿ç¨‹äº¤äº’çš„å¼€é”€ï¼Œæ‹¥æœ‰æ›´é«˜çš„å•çº¿ç¨‹æ”¶é›†æ•ˆç‡ã€‚å‘ç”Ÿåœ¨æ–°ç”Ÿä»£åŒºåŸŸï¼Œä½¿ç”¨å¤åˆ¶ç®—æ³•ã€‚ ParNewæ”¶é›†å™¨ Serialæ”¶é›†å™¨çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ã€‚åœ¨è¿›è¡Œåƒåœ¾æ”¶é›†æ—¶åŒæ ·éœ€è¦Stop The Worldï¼ˆæš‚åœå…¶ä»–å·¥ä½œçº¿ç¨‹ï¼‰ï¼Œç›´åˆ°æ”¶é›†ç»“æŸã€‚ä½¿ç”¨å¤šæ¡çº¿ç¨‹è¿›è¡Œåƒåœ¾æ”¶é›†ï¼ˆç”±äºå­˜åœ¨çº¿ç¨‹äº¤äº’çš„å¼€é”€ï¼Œæ‰€ä»¥åœ¨å•CPUçš„ç¯å¢ƒä¸‹ï¼Œæ€§èƒ½å·®äºSerialæ”¶é›†å™¨ï¼‰ã€‚ç›®å‰ï¼Œåªæœ‰Parnewæ”¶é›†å™¨èƒ½ä¸CMSæ”¶é›†å™¨é…åˆå·¥ä½œã€‚å‘ç”Ÿåœ¨æ–°ç”Ÿä»£åŒºåŸŸï¼Œä½¿ç”¨å¤åˆ¶ç®—æ³•ã€‚ Parallel Scavengeæ”¶é›†å™¨ ParNewæ”¶é›†å™¨çš„å‡çº§ç‰ˆï¼Œå…·å¤‡ParNewæ”¶é›†å™¨å¹¶å‘å¤šçº¿ç¨‹æ”¶é›†çš„ç‰¹ç‚¹ï¼Œä»¥è¾¾åˆ°å¯æ§åˆ¶ååé‡ä¸ºç›®æ ‡ã€‚ï¼ˆååé‡ï¼šCPUç”¨äºè¿è¡Œç”¨æˆ·ä»£ç çš„æ—¶é—´ä¸CPUæ€»æ¶ˆè€—æ—¶é—´ï¼ˆè¿è¡Œç”¨æˆ·ä»£ç æ—¶é—´+åƒåœ¾æ”¶é›†æ—¶é—´ï¼‰çš„æ¯”å€¼ï¼‰ã€‚è¯¥åƒåœ¾æ”¶é›†å™¨èƒ½æ ¹æ®å½“å‰ç³»ç»Ÿè¿è¡Œæƒ…å†µï¼ŒåŠ¨æ€è°ƒæ•´è‡ªèº«å‚æ•°ï¼Œä»è€Œè¾¾åˆ°æœ€å¤§ååé‡çš„ç›®æ ‡ã€‚ï¼ˆè¯¥ç‰¹æ€§æˆä¸ºGCè‡ªé€‚åº”çš„è°ƒèŠ‚ç­–ç•¥ï¼‰ã€‚å‘ç”Ÿåœ¨æ–°ç”Ÿä»£ï¼Œä½¿ç”¨å¤åˆ¶ç®—æ³•ã€‚ Serial Oldæ”¶é›†å™¨ Serial æ”¶é›†å™¨åº”ç”¨åœ¨è€å¹´ä»£çš„ç‰ˆæœ¬ã€‚å¹¶å‘ã€å•çº¿ç¨‹ã€æ•ˆç‡é«˜ã€‚ä½¿ç”¨æ ‡è®°æ•´ç†ç®—æ³•ã€‚ Parallel Oldæ”¶é›†å™¨ æ˜¯Parallel Scavengeåº”ç”¨åœ¨è€å¹´ä»£çš„ç‰ˆæœ¬ï¼Œä»¥è¾¾åˆ°å¯æ§åˆ¶ååé‡ã€è‡ªé€‚åº”è°ƒèŠ‚å’Œå¤šçº¿ç¨‹æ”¶é›†ä¸ºç›®æ ‡ï¼Œä½¿ç”¨æ ‡è®°æ•´ç†ç®—æ³•ã€‚ CMSæ”¶é›†å™¨ CMSï¼ˆConcurrent Mark Sweepï¼‰æ”¶é›†å™¨æ˜¯ä¸€ç§ä»¥è·å–æœ€çŸ­å›æ”¶åœé¡¿æ—¶é—´ä¸ºç›®æ ‡çš„æ”¶é›†å™¨ã€‚ä½¿ç”¨è¿™ç±»æ”¶é›†å™¨çš„åº”ç”¨é‡è§†æœåŠ¡çš„å“åº”é€Ÿåº¦ï¼Œå¸Œæœ›ç³»ç»Ÿåœé¡¿æ—¶é—´æœ€çŸ­ï¼Œä»¥å¸¦æ¥æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚ ä½¿ç”¨æ ‡è®°æ¸…é™¤ç®—æ³•ï¼Œä¸€å…±å››ä¸ªæ­¥éª¤ï¼šåˆå§‹æ ‡è®°ã€å¹¶å‘æ ‡è®°ã€é‡æ–°æ ‡è®°å’Œå¹¶å‘æ¸…é™¤ã€‚è¯¦æƒ…è§ä¸‹è¡¨ï¼š ä¸‹é¢è¯´ä¸‹CMSçš„ä¼˜ç¼ºç‚¹ï¼š ä¼˜ç‚¹ï¼š ï¼ˆ1ï¼‰å¹¶è¡Œï¼šç”¨æˆ·çº¿ç¨‹å’Œåƒåœ¾æ”¶é›†çº¿ç¨‹åŒæ—¶è¿›è¡Œã€‚ ï¼ˆ2ï¼‰å•çº¿ç¨‹æ”¶é›†ï¼šåªä½¿ç”¨ä¸€æ¡çº¿ç¨‹å®Œæˆåƒåœ¾æ”¶é›†ã€‚ ï¼ˆ3ï¼‰åƒåœ¾æ”¶é›†åœé¡¿æ—¶é—´çŸ­ï¼šè·å–æœ€çŸ­çš„å›æ”¶åœé¡¿æ—¶é—´ï¼Œå³å¸Œæœ›ç³»ç»Ÿåœé¡¿çš„æ—¶é—´æœ€çŸ­ï¼Œæé«˜å“åº”é€Ÿåº¦ã€‚ ç¼ºç‚¹ï¼š ï¼ˆ1ï¼‰æ€»ååé‡ä¼šé™ä½ï¼šå› ä¸ºè¯¥æ”¶é›†å™¨å¯¹CPUèµ„æºéå¸¸æ•æ„Ÿï¼Œåœ¨å¹¶å‘é˜¶æ®µä¸ä¼šå¯¼è‡´åœé¡¿ç”¨æˆ·çº¿ç¨‹ï¼Œä½†ä¼šå› ä¸ºå ç”¨éƒ¨åˆ†çº¿ç¨‹ï¼ˆCPUèµ„æºï¼‰å¯¼è‡´åº”ç”¨ç¨‹åºå˜æ…¢ï¼Œæ€»ååé‡ä¼šé™ä½ã€‚ ï¼ˆ2ï¼‰æ— æ³•å¤„ç†æµ®åŠ¨åƒåœ¾ï¼šç”±äºå¹¶å‘æ¸…ç†æ—¶ç”¨æˆ·çº¿ç¨‹è¿˜åœ¨è¿è¡Œï¼Œæ‰€ä»¥ä¼šæœ‰æ–°çš„åƒåœ¾ä¸æ–­äº§ç”Ÿï¼Œåªèƒ½ç­‰åˆ°ä¸‹ä¸€æ¬¡GCæ—¶å†æ¸…ç†ã€‚ï¼ˆå› ä¸ºè¿™ä¸€éƒ¨åˆ†åƒåœ¾å‡ºç°åœ¨æ ‡è®°è¿‡ç¨‹ä¹‹åï¼Œæ‰€ä»¥CMS æ— æ³•åœ¨å½“æ¬¡GCä¸­å¤„ç†ä»–ä»¬ï¼Œå› æ­¤CMSæ— æ³•ç­‰åˆ°è€å¹´ä»£å¡«æ»¡å†è¿›è¡ŒFull GCï¼ŒCMSéœ€è¦é¢„ç•™ä¸€éƒ¨åˆ†ç©ºé—´ï¼‰ã€‚ ï¼ˆ3ï¼‰åƒåœ¾æ”¶é›†åä¼šäº§ç”Ÿå¤§é‡çš„å†…å­˜ç¢ç‰‡ï¼šå› ä¸ºCMSæ”¶é›†å™¨æ˜¯ä½¿ç”¨æ ‡è®°-æ¸…é™¤ç®—æ³•çš„ã€‚ ä¸‹é¢ä¸€å¼ å›¾äº†è§£ä¸‹CMSçš„å·¥ä½œè¿‡ç¨‹ï¼š G1æ”¶é›†å™¨ G1æ”¶é›†å™¨æ˜¯æœ€æ–°æœ€å‰æ²¿çš„åƒåœ¾æ”¶é›†å™¨ã€‚ç‰¹ç‚¹å¦‚ä¸‹ï¼š ï¼ˆ1ï¼‰å¹¶è¡Œï¼šç”¨æˆ·çº¿ç¨‹å’Œåƒåœ¾æ”¶é›†çº¿ç¨‹åŒæ—¶è¿›è¡Œã€‚ ï¼ˆ2ï¼‰å¤šçº¿ç¨‹ï¼šå³ä½¿ç”¨å¤šæ¡åƒåœ¾æ”¶é›†çº¿ç¨‹è¿›è¡Œåƒåœ¾å›æ”¶ã€‚ï¼ˆå¹¶å‘å’Œå¹¶è¡Œå……åˆ†åˆ©ç”¨å¤šCPUå’Œå¤šæ ¸ç¯å¢ƒçš„ç¡¬ä»¶ä¼˜åŠ¿æ¥ç¼©çŸ­åƒåœ¾æ”¶é›†çš„åœé¡¿æ—¶é—´ï¼‰ ï¼ˆ3ï¼‰åƒåœ¾æ”¶é›†æ•ˆç‡é«˜ï¼šG1æ”¶é›†å™¨æ˜¯é’ˆå¯¹æ€§å¯¹Javaå †å†…å­˜åŒºåŸŸè¿›è¡Œåƒåœ¾æ”¶é›†ï¼Œè€Œéæ¯æ¬¡éƒ½å¯¹æ•´ä¸ªåŒºåŸŸè¿›è¡Œæ”¶é›†ã€‚å³G1é™¤äº†å°†Javaå †å†…å­˜åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ä¹‹å¤–ï¼Œè¿˜ä¼šç»†åˆ†ä¸ºè®¸å¤šä¸ª å¤§å°ç›¸ç­‰çš„ç‹¬ç«‹åŒºåŸŸï¼ˆRegionï¼‰ï¼Œç„¶åG1æ”¶é›†å™¨ä¼šè·Ÿè¸ªæ¯ä¸ªRegioné‡Œçš„åƒåœ¾ä»£ä»·å€¼å¤§å°ï¼Œå¹¶åœ¨åå°ç»´æŠ¤ä¸€ä¸ªåˆ—è¡¨ã€‚æ¯æ¬¡å›æ”¶æ—¶ï¼Œä¼šæ ¹æ®å…è®¸çš„åƒåœ¾æ”¶é›†æ—¶é—´ä¼˜å…ˆå›æ”¶ä»·å€¼æœ€å¤§çš„ Regionï¼Œä»è€Œé¿å…äº†å¯¹æ•´ä¸ªJavaå †å†…å­˜åŒºåŸŸçš„å›æ”¶ï¼Œæé«˜äº†æ•ˆç‡ã€‚å› ä¸ºä¸Šè¿°æœºåˆ¶ï¼ŒG1æ”¶é›†å™¨è¿˜èƒ½å»ºç«‹å¯é¢„æµ‹çš„æ—¶é—´æ¨¡å‹ï¼šå³è®©ä½¿ç”¨è€…æ˜ç¡®æ‰§è¡Œä¸€ä¸ªé•¿åº¦ä¸ºMæ¯«ç§’çš„æ—¶é—´ç‰‡æ®µï¼Œæ¶ˆè€—åœ¨ åƒåœ¾æ”¶é›†ä¸Šçš„æ—¶é—´ä¸å¾—è¶…å‡ºNæ¯«ç§’ã€‚å³å…·å¤‡å®æ—¶æ€§ã€‚ ï¼ˆ4ï¼‰ä¸ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚ä»æ•´ç†ä¸Šçœ‹ï¼ŒG1æ”¶é›†å™¨æ˜¯åŸºäºæ ‡è®°-æ•´ç†ç®—æ³•çš„ï¼Œä»å±€éƒ¨çœ‹æ˜¯åŸºäºå¤åˆ¶ç®—æ³•çš„ã€‚åœ¨æ–°ç”Ÿä»£ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œåœ¨è€å¹´ä»£ä½¿ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ã€‚ ä¸‹é¢äº†è§£ä¸‹å·¥ä½œæµç¨‹ï¼Œè·ŸCMSæœ‰ç‚¹åƒã€‚ ä¸‹é¢æ˜¯G1çš„å·¥ä½œè¿‡ç¨‹ï¼š æ€»ç»“ æœ¬æ–‡è®²è§£äº†è¿è¡Œæ—¶æ•°æ®åŒºåŸŸï¼Œå†…å­˜æº¢å‡ºï¼Œå¦‚ä½•åˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜æ´»ï¼Œåƒåœ¾å›æ”¶ç®—æ³•å’Œåƒåœ¾æ”¶é›†å™¨å‡ ä¸ªæ–¹é¢ï¼Œæ¶µç›–jvmçš„æ ¸å¿ƒè€ƒç‚¹ï¼Œå¸Œæœ›ä½ æœ‰æ‰€æ”¶è·ã€‚ ","link":"https://tianxiawuhao.github.io/8iu5aa5DN/"},{"title":"Javaå†…å­˜ç»“æ„JVM","content":"JVMå†…å­˜æ¨¡å‹ å†…å­˜ç©ºé—´(Runtime Data Area)ä¸­å¯ä»¥æŒ‰ç…§æ˜¯å¦çº¿ç¨‹å…±äº«åˆ†ä¸ºä¸¤å—ï¼Œçº¿ç¨‹å…±äº«çš„æ˜¯æ–¹æ³•åŒº(Method Area)å’Œå †(Heap)ï¼Œçº¿ç¨‹ç‹¬äº«çš„æ˜¯Javaè™šæ‹Ÿæœºæ ˆ(Java Stack)ï¼Œæœ¬åœ°æ–¹æ³•æ ˆ(Native Method Stack)å’ŒPCå¯„å­˜å™¨(Program Counter Register)ã€‚å…·ä½“å‚è§ä¸‹å›¾ï¼š è™šæ‹Ÿæœºæ ˆï¼š è™šæ‹Ÿæœºæ ˆæ˜¯Javaæ–¹æ³•æ‰§è¡Œçš„å†…å­˜æ¨¡å‹ï¼Œæ ˆä¸­å­˜æ”¾ç€æ ˆå¸§ï¼Œæ¯ä¸ªæ ˆå¸§åˆ†åˆ«å¯¹åº”ä¸€ä¸ªè¢«è°ƒç”¨çš„æ–¹æ³•ï¼Œæ–¹æ³•çš„è°ƒç”¨è¿‡ç¨‹å¯¹åº”æ ˆå¸§åœ¨è™šæ‹Ÿæœºä¸­å…¥æ ˆåˆ°å‡ºæ ˆçš„è¿‡ç¨‹ã€‚ æ ˆæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹ä¹‹é—´çš„æ ˆæ˜¯éš”ç¦»çš„ï¼›å½“ç¨‹åºä¸­æŸä¸ªçº¿ç¨‹å¼€å§‹æ‰§è¡Œä¸€ä¸ªæ–¹æ³•æ—¶å°±ä¼šç›¸åº”çš„åˆ›å»ºä¸€ä¸ªæ ˆå¸§å¹¶ä¸”å…¥æ ˆï¼ˆä½äºæ ˆé¡¶ï¼‰ï¼Œåœ¨æ–¹æ³•ç»“æŸåï¼Œæ ˆå¸§å‡ºæ ˆã€‚ ä¸‹å›¾è¡¨ç¤ºäº†ä¸€ä¸ªJavaæ ˆçš„æ¨¡å‹ä»¥åŠæ ˆå¸§çš„ç»„æˆï¼š æ ˆå¸§:æ˜¯ç”¨äºæ”¯æŒè™šæ‹Ÿæœºè¿›è¡Œæ–¹æ³•è°ƒç”¨å’Œæ–¹æ³•æ‰§è¡Œçš„æ•°æ®ç»“æ„ï¼Œå®ƒæ˜¯è™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºä¸­çš„è™šæ‹Ÿæœºæ ˆçš„æ ˆå…ƒç´ ã€‚ æ¯ä¸ªæ ˆå¸§ä¸­åŒ…æ‹¬ï¼š å±€éƒ¨å˜é‡è¡¨:ç”¨æ¥å­˜å‚¨æ–¹æ³•ä¸­çš„å±€éƒ¨å˜é‡ï¼ˆéé™æ€å˜é‡ã€å‡½æ•°å½¢å‚ï¼‰ã€‚å½“å˜é‡ä¸ºåŸºæœ¬æ•°æ®ç±»å‹æ—¶ï¼Œç›´æ¥å­˜å‚¨å€¼ï¼Œå½“å˜é‡ä¸ºå¼•ç”¨ç±»å‹æ—¶ï¼Œå­˜å‚¨çš„æ˜¯æŒ‡å‘å…·ä½“å¯¹è±¡çš„å¼•ç”¨ã€‚ æ“ä½œæ•°æ ˆ:Javaè™šæ‹Ÿæœºçš„è§£é‡Šæ‰§è¡Œå¼•æ“è¢«ç§°ä¸º&quot;åŸºäºæ ˆçš„æ‰§è¡Œå¼•æ“&quot;ï¼Œå…¶ä¸­æ‰€æŒ‡çš„æ ˆå°±æ˜¯æŒ‡æ“ä½œæ•°æ ˆã€‚ æŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± çš„å¼•ç”¨:å­˜å‚¨ç¨‹åºæ‰§è¡Œæ—¶å¯èƒ½ç”¨åˆ°å¸¸é‡çš„å¼•ç”¨ã€‚ æ–¹æ³•è¿”å›åœ°å€:å­˜å‚¨æ–¹æ³•æ‰§è¡Œå®Œæˆåçš„è¿”å›åœ°å€ã€‚ æ¯ä¸ªçº¿ç¨‹æœ‰ä¸€ä¸ªç§æœ‰çš„æ ˆï¼Œéšç€çº¿ç¨‹çš„åˆ›å»ºè€Œåˆ›å»ºã€‚æ ˆé‡Œé¢å­˜æ”¾ç€ä¸€ç§å«åšâ€œæ ˆå¸§â€çš„ä¸œè¥¿ï¼Œæ¯ä¸ªæ–¹æ³•ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œæ ˆå¸§ä¸­å­˜æ”¾äº†å±€éƒ¨å˜é‡è¡¨(åŸºæœ¬æ•°æ®ç±»å‹å’Œå¯¹è±¡å¼•ç”¨)ã€æ“ä½œæ•°æ ˆã€æ–¹æ³•å‡ºå£ç­‰ä¿¡æ¯ã€‚æ ˆçš„å¤§å°å¯ä»¥å›ºå®šä¹Ÿå¯ä»¥åŠ¨æ€æ‰©å±•ã€‚å½“æ ˆè°ƒç”¨æ·±åº¦å¤§äºJVMæ‰€å…è®¸çš„èŒƒå›´ï¼Œä¼šæŠ›å‡ºStackOverflowErrorçš„é”™è¯¯ï¼Œä¸è¿‡è¿™ä¸ªæ·±åº¦èŒƒå›´ä¸æ˜¯ä¸€ä¸ªæ’å®šçš„å€¼ï¼Œæˆ‘ä»¬é€šè¿‡ä¸‹é¢è¿™æ®µç¨‹åºå¯ä»¥æµ‹è¯•ä¸€ä¸‹è¿™ä¸ªç»“æœï¼š // æ ˆæº¢å‡ºæµ‹è¯•æºç  ackage com.paddx.test.memory; /** * Created by root on 2/28/17. */ public class StackErrorMock { private static int index = 1; public void call() { index++; call(); } public static void main(String[] args) { StackErrorMock mock = new StackErrorMock(); try { mock.call(); } catch(Throwable e) { System.out.println(&quot;Stack deep: &quot; + index); e.printStackTrace(); } } } è¿è¡Œä¸‰æ¬¡ï¼Œå¯ä»¥çœ‹å‡ºæ¯æ¬¡æ ˆçš„æ·±åº¦éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š æŸ¥çœ‹ä¸‰å¼ ç»“æœå›¾ï¼Œå¯ä»¥çœ‹å‡ºæ¯æ¬¡çš„Stack deepå€¼éƒ½æœ‰æ‰€ä¸åŒã€‚ç©¶å…¶åŸå› ï¼Œå°±éœ€è¦æ·±å…¥åˆ°JVMçš„æºç ä¸­æ‰èƒ½æ¢è®¨ï¼Œè¿™é‡Œä¸ä½œèµ˜è¿°ã€‚ è™šæ‹Ÿæœºæ ˆé™¤äº†ä¸Šè¿°é”™è¯¯å¤–ï¼Œè¿˜æœ‰å¦ä¸€ç§é”™è¯¯ï¼Œé‚£å°±æ˜¯å½“ç”³è¯·ä¸åˆ°ç©ºé—´æ—¶ï¼Œä¼šæŠ›å‡ºOutOfMemoryErrorã€‚è¿™é‡Œæœ‰ä¸€ä¸ªå°ç»†èŠ‚éœ€è¦æ³¨æ„ï¼Œcatchæ•è·çš„æ˜¯Throwableï¼Œè€Œä¸æ˜¯Exceptionï¼Œè¿™æ˜¯å› ä¸ºStackOverflowErrorå’ŒOutOfMemoryErroréƒ½ä¸å±äºExceptionçš„å­ç±»ã€‚ æœ¬åœ°æ–¹æ³•æ ˆï¼š è¿™éƒ¨åˆ†ä¸»è¦ä¸è™šæ‹Ÿæœºç”¨åˆ°çš„Nativeæ–¹æ³•ç›¸å…³ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒJavaåº”ç”¨ç¨‹åºå‘˜å¹¶ä¸éœ€è¦å…³ç³»è¿™éƒ¨åˆ†å†…å®¹ã€‚ PCå¯„å­˜å™¨ï¼š PCå¯„å­˜å™¨ï¼Œä¹Ÿå«ç¨‹åºè®¡æ•°å™¨ã€‚JVMæ”¯æŒå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ç¨‹åºè®¡æ•°å™¨ã€‚å€˜è‹¥å½“å‰æ‰§è¡Œçš„æ˜¯JVMæ–¹æ³•ï¼Œåˆ™è¯¥å¯„å­˜å™¨ä¸­ä¿å­˜å½“å‰æ‰§è¡ŒæŒ‡ä»¤çš„åœ°å€ï¼›å€˜è‹¥æ‰§è¡Œçš„æ˜¯nativeæ–¹æ³•ï¼Œåˆ™PCå¯„å­˜å™¨ä¸ºç©ºã€‚ å † ï¼š å †å†…å­˜æ˜¯JVMæ‰€æœ‰çº¿ç¨‹å…±äº«çš„éƒ¨åˆ†ï¼Œåœ¨è™šæ‹Ÿæœºå¯åŠ¨çš„æ—¶å€™å°±å·²ç»åˆ›å»ºã€‚æ‰€æœ‰çš„å¯¹è±¡å’Œæ•°ç»„éƒ½åœ¨å †ä¸Šè¿›è¡Œåˆ†é…ã€‚è¿™éƒ¨åˆ†ç©ºé—´å¯é€šè¿‡GCè¿›è¡Œå›æ”¶ã€‚å½“ç”³è¯·ä¸åˆ°ç©ºé—´æ—¶ï¼Œä¼šæŠ›å‡ºOutOfMemoryErrorã€‚ä¸‹é¢æˆ‘ä»¬ç®€å•çš„æ¨¡æ‹Ÿä¸€ä¸ªå †å†…å­˜æº¢å‡ºçš„æƒ…å†µï¼š package com.paddx.test.memory; import java.util.ArrayList; import java.util.List; /** * Created by root on 2/28/17. */ public class HeapOomMock { public static void main(String[] args) { List&lt;byte[]&gt; list = new ArrayList&lt;byte[]&gt;(); int i = 0; boolean flag = true; while(flag) { try { i++; list.add(new byte[1024 * 1024]); // æ¯æ¬¡å¢åŠ 1Må¤§å°çš„æ•°ç»„å¯¹è±¡ }catch(Throwable e) { e.printStackTrace(); flag = false; System.out.println(&quot;Count = &quot; + i); // è®°å½•è¿è¡Œçš„æ¬¡æ•° } } } } é¦–å…ˆé…ç½®è¿è¡Œæ—¶è™šæ‹Ÿæœºçš„å¯åŠ¨å‚æ•°ï¼š ç„¶åè¿è¡Œä»£ç ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä»¬æŒ‡å®šäº†å †å†…å­˜çš„å¤§å°ä¸º16Mï¼Œæ‰€ä»¥è¿™ä¸ªåœ°æ–¹æ˜¾ç¤ºçš„Count=13(è¿™ä¸ªæ•°å­—ä¸æ˜¯å›ºå®šçš„)ï¼Œè‡³äºä¸ºä»€ä¹ˆä¼šæ˜¯13æˆ–å…¶ä»–æ•°å­—ï¼Œéœ€è¦æ ¹æ®GCæ—¥å¿—æ¥åˆ¤æ–­ã€‚ æ–¹æ³•åŒºï¼š æ–¹æ³•åŒºæ˜¯ä¸€å—æ‰€æœ‰çº¿ç¨‹å…±äº«çš„å†…å­˜é€»è¾‘åŒºåŸŸï¼Œåœ¨JVMä¸­åªæœ‰ä¸€ä¸ªæ–¹æ³•åŒºï¼Œç”¨æ¥å­˜å‚¨ä¸€äº›çº¿ç¨‹å¯å…±äº«çš„å†…å®¹ï¼Œå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®æ–¹æ³•åŒºä¸­åŒä¸€ä¸ªå†…å®¹æ—¶ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è£…è½½è¯¥æ•°æ®ï¼Œå…¶å®ƒçº¿ç¨‹åªèƒ½ç­‰å¾…ã€‚ æ–¹æ³•åŒºå¯å­˜å‚¨çš„å†…å®¹æœ‰ï¼šç±»çš„å…¨è·¯å¾„åã€ç±»çš„ç›´æ¥è¶…ç±»çš„æƒå…¨é™å®šåã€ç±»çš„è®¿é—®ä¿®é¥°ç¬¦ã€ç±»çš„ç±»å‹ï¼ˆç±»æˆ–æ¥å£ï¼‰ã€ç±»çš„ç›´æ¥æ¥å£å…¨é™å®šåçš„æœ‰åºåˆ—è¡¨ã€å¸¸é‡æ± ï¼ˆå­—æ®µï¼Œæ–¹æ³•ä¿¡æ¯ï¼Œé™æ€å˜é‡ï¼Œç±»å‹å¼•ç”¨ï¼ˆclassï¼‰ï¼‰ç­‰ã€‚ å…³äºæ–¹æ³•åŒºçš„å†…å­˜æº¢å‡ºé—®é¢˜ä¼šåœ¨ä¸‹æ–‡ä¸­è¯¦ç»†è®¨è®ºã€‚ æ–¹æ³•åŒºå’Œå…ƒç©ºé—´ Java1.7åŠä¹‹å‰çš„è™šæ‹Ÿæœºåœ¨è¿è¡Œä¸­ä¼šæŠŠå®ƒæ‰€ç®¡ç†çš„å†…å­˜åˆ†ä¸ºå¦‚ä¸Šå›¾çš„è‹¥å¹²æ•°æ®åŒºåŸŸã€‚ æ–¹æ³•åŒºç”¨äºå­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€åŠ¨æ€ç”Ÿæˆçš„ç±»ç­‰æ•°æ®ã€‚å®é™…ä¸Šåœ¨Javaè™šæ‹Ÿæœºçš„è§„èŒƒä¸­æ–¹æ³•åŒºæ˜¯å †ä¸­çš„ä¸€ä¸ªé€»è¾‘éƒ¨åˆ†ï¼Œä½†æ˜¯å®ƒå´æ‹¥æœ‰ä¸€ä¸ªå«åšéå †(Non-Heap)çš„åˆ«åã€‚ å¯¹äºæ–¹æ³•åŒºçš„å®ç°ï¼Œä¸åŒè™šæ‹Ÿæœºä¸­ç­–ç•¥ä¹Ÿä¸åŒã€‚ä»¥æˆ‘ä»¬å¸¸ç”¨çš„HotSpotè™šæ‹Ÿæœºä¸ºä¾‹ï¼Œå…¶è®¾è®¡å›¢é˜Ÿä½¿ç”¨æ°¸ä¹…å¸¦æ¥å®ç°æ–¹æ³•åŒºï¼Œå¹¶æŠŠGCçš„åˆ†ä»£æ”¶é›†æ‰©å±•è‡³æ°¸ä¹…å¸¦ã€‚è¿™æ ·è®¾è®¡çš„å¥½å¤„å°±æ˜¯èƒ½å¤Ÿçœå»ä¸“é—¨ä¸ºæ–¹æ³•åŒºç¼–å†™å†…å­˜ç®¡ç†çš„ä»£ç ã€‚ä½†æ˜¯åœ¨å®é™…çš„åœºæ™¯ä¸­ï¼Œè¿™æ ·çš„å®ç°å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„æ–¹å¼ï¼Œå› ä¸ºæ°¸ä¹…å¸¦æœ‰MAXä¸Šé™ï¼Œæ‰€ä»¥è¿™æ ·åšä¼šæ›´å®¹æ˜“é‡åˆ°å†…å­˜æº¢å‡ºé—®é¢˜ã€‚ å…³äºæ–¹æ³•åŒºçš„GCå›æ”¶ï¼ŒJavaè™šæ‹Ÿæœºè§„èŒƒå¹¶æ²¡æœ‰ä¸¥æ ¼çš„é™åˆ¶ã€‚è™šæ‹Ÿæœºåœ¨å®ç°ä¸­å¯ä»¥è‡ªç”±é€‰æ‹©æ˜¯å¦å®ç°åƒåœ¾å›æ”¶ã€‚ä¸»è¦åŸå› è¿˜æ˜¯æ–¹æ³•åŒºå†…å­˜å›æ”¶çš„æ•ˆæœæ¯”è¾ƒéš¾ä»¥ä»¤äººæ»¡æ„ï¼Œæ–¹æ³•åŒºçš„å†…å­˜å›æ”¶ä¸»è¦æ˜¯é’ˆå¯¹å¸¸é‡æ± (1.7å·²ç»å°†å¸¸é‡æ± é€æ­¥ç§»é™¤æ–¹æ³•åŒº)ä»¥åŠç±»å‹çš„å¸è½½ï¼Œä½†æ˜¯ç±»å‹å¸è½½åœ¨å®é™…åœºæ™¯ä¸­çš„æ¡ä»¶ç›¸å½“è‹›åˆ»ã€‚ å¦å¤–è¿˜éœ€è¦æ³¨æ„çš„æ˜¯åœ¨HotSpotè™šæ‹Ÿæœºä¸­æ°¸ä¹…å¸¦å’Œå †è™½ç„¶ç›¸äº’éš”ç¦»ï¼Œä½†æ˜¯ä»–ä»¬çš„ç‰©ç†å†…å­˜æ˜¯è¿ç»­çš„ã€‚è€Œä¸”è€å¹´ä»£å’Œæ°¸ä¹…å¸¦çš„åƒåœ¾æ”¶é›†å™¨è¿›è¡Œäº†æ†ç»‘ï¼Œå› æ­¤æ— è®ºè°æ»¡äº†éƒ½ä¼šè§¦å‘æ°¸ä¹…å¸¦å’Œè€å¹´çš„GCã€‚ å› æ­¤åœ¨Java1.8ä¸­ï¼ŒHotSpotè™šæ‹Ÿæœºå·²ç»å°†æ–¹æ³•åŒº(æ°¸ä¹…å¸¦)ç§»é™¤ï¼Œå–è€Œä»£ä¹‹çš„å°±æ˜¯å…ƒç©ºé—´ã€‚ Java1.8çš„è¿è¡Œæ—¶æ•°æ®åŒºåŸŸå¦‚å›¾æ‰€ç¤ºã€‚æ–¹æ³•åŒºå·²ç»ä¸è§äº†è¸ªå½±ï¼Œå¤šå‡ºæ¥çš„æ˜¯å«åšå…ƒæ•°æ®åŒºçš„åŒºåŸŸã€‚ å…ƒç©ºé—´åœ¨1.8ä¸­ä¸åœ¨ä¸å †æ˜¯è¿ç»­çš„ç‰©ç†å†…å­˜ï¼Œè€Œæ˜¯æ”¹ä¸ºä½¿ç”¨æœ¬åœ°å†…å­˜(Native memory)ã€‚å…ƒç©ºé—´ä½¿ç”¨æœ¬åœ°å†…å­˜ä¹Ÿå°±æ„å‘³ç€åªè¦æœ¬åœ°å†…å­˜è¶³å¤Ÿï¼Œå°±ä¸ä¼šå‡ºç°OOMçš„é”™è¯¯ã€‚ PermGen(æ°¸ä¹…ä»£) ç»å¤§éƒ¨åˆ†Javaç¨‹åºå‘˜åº”è¯¥éƒ½è§è¿‡â€œjava.lang.OutOfMemoryError: PremGen spaceâ€å¼‚å¸¸ã€‚è¿™é‡Œçš„â€œPermGen spaceâ€å…¶å®æŒ‡çš„å°±æ˜¯æ–¹æ³•åŒºã€‚ä¸è¿‡æ–¹æ³•åŒºå’Œâ€œPermGen spaceâ€åˆæœ‰ç€æœ¬è´¨çš„åŒºåˆ«ã€‚å‰è€…æ˜¯JVMçš„è§„èŒƒï¼Œè€Œåè€…åˆ™æ˜¯JVMè§„èŒƒçš„ä¸€ç§å®ç°ï¼Œå¹¶ä¸”åªæœ‰HotSpotæ‰æœ‰â€œPermGen spaceâ€ï¼Œè€Œå¯¹äºå…¶ä»–ç±»å‹çš„è™šæ‹Ÿæœºï¼Œå¦‚JRockit(Oracle)ã€J9(IBM)å¹¶æ²¡æœ‰â€œPermGen spaceâ€ã€‚ç”±äºæ–¹æ³•åŒºä¸»è¦å­˜å‚¨ç±»çš„ç›¸å…³ä¿¡æ¯ï¼Œæ‰€ä»¥å¯¹äºåŠ¨æ€ç”Ÿæˆç±»çš„æƒ…å†µæ¯”è¾ƒå®¹æ˜“å‡ºç°æ°¸ä¹…ä»£çš„å†…å­˜æº¢å‡ºã€‚æœ€å…¸å‹çš„åœºæ™¯å°±æ˜¯ï¼Œåœ¨JSPé¡µé¢æ¯”è¾ƒå¤šçš„æƒ…å†µï¼Œå®¹æ˜“å‡ºç°æ°¸ä¹…ä»£å†…å­˜æº¢å‡ºã€‚æˆ‘ä»¬ç°åœ¨é€šè¿‡åŠ¨æ€ç”Ÿæˆç±»æ¥æ¨¡æ‹Ÿâ€œPermGen spaceâ€çš„å†…å­˜æº¢å‡ºï¼š package com.paddx.test.memory; import java.io.File; import java.net.URL; import java.net.URLClassLoader; import java.util.ArrayList; import java.util.List; public class PermGenOomMock { public static void main(String[] args) { URL url = null; List&lt;ClassLoader&gt; classLoaderList = new ArrayList&lt;ClassLoader&gt;(); try { url = new File(&quot;/tmp&quot;).toURI().toURL(); URL[] urls = {url}; while(true) { ClassLoader loader = new URLClassLoader(urls); classLoaderList.add(loader); loader.loadClass(&quot;com.paddx.test.memory.Test&quot;); } }catch(Exception e) { e.printStackTrace(); } } } package com.paddx.test.memory; public class Test {} è¿è¡Œç»“æœå¦‚ä¸‹ï¼š æœ¬ä¾‹ä¸­ä½¿ç”¨çš„JDKç‰ˆæœ¬æ˜¯1.7ï¼ŒæŒ‡å®šçš„PermGenåŒºçš„å¤§å°ä¸º8Mã€‚é€šè¿‡æ¯æ¬¡ç”Ÿæˆä¸åŒURLClassLoaderå¯¹è±¡åŠ è½½Testç±»ï¼Œä»è€Œç”Ÿæˆä¸åŒçš„ç±»å¯¹è±¡ï¼Œè¿™æ ·å°±èƒ½çœ‹åˆ°æˆ‘ä»¬ç†Ÿæ‚‰çš„â€œjava.lang.OutOfMemoryError: PermGen spaceâ€å¼‚å¸¸äº†ã€‚è¿™é‡Œä¹‹æ‰€ä»¥é‡‡ç”¨JDK 1.7ï¼Œæ˜¯å› ä¸ºåœ¨JDK 1.8ä¸­ï¼ŒHotSpotå·²ç»æ²¡æœ‰â€œPermGen spaceâ€è¿™ä¸ªåŒºé—´äº†ï¼Œå–è€Œä»£ä¹‹æ˜¯ä¸€ä¸ªå«åšMetaspace(å…ƒç©ºé—´)çš„ä¸œè¥¿ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹Metaspaceä¸PermGen spaceçš„åŒºåˆ«ã€‚ Metaspace(å…ƒç©ºé—´) å…¶å®ï¼Œç§»é™¤æ°¸ä¹…ä»£çš„å·¥ä½œä»JDK 1.7å°±å¼€å§‹äº†ã€‚JDK 1.7ä¸­ï¼Œå­˜å‚¨åœ¨æ°¸ä¹…ä»£çš„éƒ¨åˆ†æ•°æ®å°±å·²ç»è½¬ç§»åˆ°Java Heapæˆ–è€…Native Heapã€‚ä½†æ°¸ä¹…ä»£ä»å­˜åœ¨äºJDK 1.7ä¸­ï¼Œå¹¶æ²¡æœ‰å®Œå…¨ç§»é™¤ï¼Œè­¬å¦‚ç¬¦å·å¼•ç”¨(Symbols)è½¬ç§»åˆ°äº†native heapï¼›å­—é¢é‡(interned strings)è½¬ç§»åˆ°äº†Java heapï¼›ç±»çš„é™æ€å˜é‡(class statics)è½¬ç§»åˆ°äº†Java heapã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€æ®µç¨‹åºæ¥æ¯”è¾ƒJDK 1.6ã€JDK 1.7ä¸JDK 1.8çš„åŒºåˆ«ï¼Œä»¥å­—ç¬¦ä¸²å¸¸é‡ä¸ºä¾‹ï¼š package com.paddx.test.memory; import java.util.ArrayList; import java.util.List; public class StringOomMock { static String base = &quot;string&quot;; public static void main(String[] args) { List&lt;String&gt; list = new ArrayList&lt;String&gt;(); for (int i = 0; i &lt; Integer.MAX_VALUE; i++) { String str = base + base; base = str; list.add(str.intern()); } } } è¿™æ®µç¨‹åºä»¥2çš„æŒ‡æ•°çº§ä¸æ–­çš„ç”Ÿæˆæ–°çš„å­—ç¬¦ä¸²ï¼Œè¿™æ ·å¯ä»¥æ¯”è¾ƒå¿«é€Ÿçš„æ¶ˆè€—å†…å­˜ã€‚æˆ‘ä»¬é€šè¿‡JDK 1.6ã€JDK 1.7å’ŒJDK 1.8åˆ†åˆ«è¿è¡Œï¼š JDK 1.6çš„è¿è¡Œç»“æœï¼š JDK 1.7çš„è¿è¡Œç»“æœï¼š JDK 1.8çš„è¿è¡Œç»“æœï¼š ä»ä¸Šè¿°ç»“æœå¯ä»¥çœ‹å‡ºï¼ŒJDK 1.6ä¸‹ï¼Œä¼šå‡ºç°â€œPermGen spaceâ€çš„å†…å­˜æº¢å‡ºï¼Œè€Œåœ¨JDK 1.7å’ŒJDK 1.8ä¸­ï¼Œä¼šå‡ºç°å †å†…å­˜æº¢å‡ºï¼Œå¹¶ä¸”JDK 1.8ä¸­å‚æ•°PermSizeå’ŒMaxPermSizeå·²ç»å¤±æ•ˆã€‚å› æ­¤ï¼Œå¯ä»¥å¤§è‡´éªŒè¯JDK 1.7å’ŒJDK 1.8ä¸­å°†å­—ç¬¦ä¸²å¸¸é‡ç”±æ°¸ä¹…ä»£è½¬ç§»åˆ°å †ä¸­ï¼Œå¹¶ä¸”JDK 1.8ä¸­å·²ç»ä¸å­˜åœ¨æ°¸ä¹…ä»£çš„ç»“è®ºã€‚ç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€çœ‹å…ƒç©ºé—´åˆ°åº•æ˜¯ä¸€ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Ÿ JDK1.8å¯¹JVMæ¶æ„çš„æ”¹é€ å°†ç±»å…ƒæ•°æ®æ”¾åˆ°æœ¬åœ°å†…å­˜ä¸­ï¼Œå¦å¤–ï¼Œå°†å¸¸é‡æ± å’Œé™æ€å˜é‡æ”¾åˆ°Javaå †é‡Œã€‚HotSpot VMå°†ä¼šä¸ºç±»çš„å…ƒæ•°æ®æ˜ç¡®åˆ†é…å’Œé‡Šæ”¾æœ¬åœ°å†…å­˜ã€‚åœ¨è¿™ç§æ¶æ„ä¸‹ï¼Œç±»å…ƒä¿¡æ¯å°±çªç ´äº†åŸæ¥-XX:MaxPermSizeçš„é™åˆ¶ï¼Œç°åœ¨å¯ä»¥ä½¿ç”¨æ›´å¤šçš„æœ¬åœ°å†…å­˜ã€‚è¿™æ ·å°±ä»ä¸€å®šç¨‹åº¦ä¸Šè§£å†³äº†åŸæ¥åœ¨è¿è¡Œæ—¶ç”Ÿæˆå¤§é‡ç±»é€ æˆç»å¸¸Full GCé—®é¢˜ï¼Œå¦‚è¿è¡Œæ—¶ä½¿ç”¨åå°„ã€ä»£ç†ç­‰ã€‚æ‰€ä»¥å‡çº§ä»¥åJavaå †ç©ºé—´å¯èƒ½ä¼šå¢åŠ ã€‚ å…ƒç©ºé—´çš„æœ¬è´¨å’Œæ°¸ä¹…ä»£ç±»ä¼¼ï¼Œéƒ½æ˜¯å¯¹JVMè§„èŒƒä¸­æ–¹æ³•åŒºçš„å®ç°ã€‚ä¸è¿‡å…ƒç©ºé—´ä¸æ°¸ä¹…ä»£ä¹‹é—´çš„æœ€å¤§åŒºåˆ«åœ¨äºï¼šå…ƒç©ºé—´å¹¶ä¸åœ¨è™šæ‹Ÿæœºä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜ã€‚å› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå…ƒç©ºé—´çš„å¤§å°ä»…å—æœ¬åœ°å†…å­˜é™åˆ¶ï¼Œä½†å¯ä»¥é€šè¿‡ä»¥ä¸‹å‚æ•°æŒ‡å®šå…ƒç©ºé—´çš„å¤§å°ï¼š -XX:MetaspaceSizeï¼Œåˆå§‹ç©ºé—´å¤§å°ï¼Œè¾¾åˆ°è¯¥å€¼å°±ä¼šè§¦å‘åƒåœ¾æ”¶é›†è¿›è¡Œç±»å‹å¸è½½ï¼ŒåŒæ—¶GCä¼šå¯¹æ”¹å€¼è¿›è¡Œè°ƒæ•´ï¼šå¦‚æœé‡Šæ”¾äº†å¤§é‡çš„ç©ºé—´ï¼Œå°±é€‚å½“é™ä½è¯¥å€¼ï¼›å¦‚æœé‡Šæ”¾äº†å¾ˆå°‘çš„ç©ºé—´ï¼Œé‚£ä¹ˆåœ¨ä¸è¶…è¿‡MaxMetaspaceSizeæ—¶ï¼Œé€‚å½“æé«˜è¯¥å€¼ã€‚ -XX:MaxMetaspaceSizeï¼Œæœ€å¤§ç©ºé—´ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰é™åˆ¶çš„ã€‚ é™¤äº†ä¸Šé¢çš„ä¸¤ä¸ªæŒ‡å®šå¤§å°çš„é€‰é¡¹å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªä¸GCç›¸å…³çš„å±æ€§ï¼š -XX:MinMetaspaceFreeRatioï¼Œåœ¨GCä¹‹åï¼Œæœ€å°çš„Metaspaceå‰©ä½™ç©ºé—´å®¹é‡çš„ç™¾åˆ†æ¯”ï¼Œå‡å°‘ä¸ºåˆ†é…ç©ºé—´æ‰€å¯¼è‡´çš„åƒåœ¾æ”¶é›†ã€‚ -XX:MaxMetaspaceFreeRatioï¼Œåœ¨GCä¹‹åï¼Œæœ€å¤§çš„Metaspaceå‰©ä½™ç©ºé—´å®¹é‡çš„ç™¾åˆ†æ¯”ï¼Œå‡å°‘ä¸ºé‡Šæ”¾ç©ºé—´æ‰€å¯¼è‡´çš„åƒåœ¾æ”¶é›†ã€‚ ç°åœ¨æˆ‘ä»¬åœ¨JDK 1.8é‡æ–°è¿è¡Œä¸€ä¸‹ä¸Šé¢ç¬¬äºŒéƒ¨åˆ†(PermGen(æ°¸ä¹…ä»£))çš„ä»£ç ï¼Œä¸è¿‡è¿™æ¬¡ä¸å†æŒ‡å®šPermSizeå’ŒMaxPermSizeã€‚è€Œæ˜¯åˆ¶å®šMetaspaceSizeå’ŒMaxMetaspaceSizeçš„å¤§å°ã€‚è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š ä»è¾“å‡ºç»“æœï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œè¿™æ¬¡ä¸å†å‡ºç°æ°¸ä¹…ä»£æº¢å‡ºï¼Œè€Œæ˜¯å‡ºç°å…ƒç©ºé—´çš„æº¢å‡ºã€‚ å››ã€æ€»ç»“ é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œå¤§å®¶åº”è¯¥å¤§è‡´äº†è§£äº†JVMçš„å†…å­˜åˆ’åˆ†ï¼Œä¹Ÿæ¸…æ¥šäº†JDK 1.8ä¸­æ°¸ä¹…ä»£å‘å…ƒç©ºé—´çš„è½¬æ¢ã€‚ä¸è¿‡å¤§å®¶åº”è¯¥æœ‰ä¸€ä¸ªç–‘é—®ï¼Œå°±æ˜¯ä¸ºä»€ä¹ˆè¦åšè¿™ä¸ªè½¬æ¢ï¼Ÿä»¥ä¸‹ä¸ºå¤§å®¶æ€»ç»“å‡ ç‚¹åŸå› ï¼š å­—ç¬¦ä¸²åœ¨æ°¸ä¹…ä»£ä¸­ï¼Œå®¹æ˜“å‡ºç°æ€§èƒ½é—®é¢˜å’Œå†…å­˜æº¢å‡ºã€‚ ç±»åŠæ–¹æ³•çš„ä¿¡æ¯ç­‰æ¯”è¾ƒéš¾ç¡®å®šå¤§å°ï¼Œå› æ­¤å¯¹äºæ°¸ä¹…ä»£çš„å¤§å°æŒ‡å®šæ¯”è¾ƒå›°éš¾ï¼Œå¤ªå°å®¹æ˜“å‡ºç°æ°¸ä¹…ä»£æº¢å‡ºï¼Œå¤ªå¤§åˆ™å®¹æ˜“å‡ºç°è€å¹´ä»£æº¢å‡ºã€‚ æ°¸ä¹…ä»£ä¼šä¸ºGCå¸¦æ¥ä¸å¿…è¦çš„å¤æ‚åº¦ï¼Œå¹¶ä¸”å›æ”¶æ•ˆç‡åä½ã€‚ Oracleå¯èƒ½ä¼šå°†HotSpotä¸JRockitåˆäºŒä¸ºä¸€ã€‚ ","link":"https://tianxiawuhao.github.io/nxmi3zjCk/"},{"title":" æ¼«ç”»ï¼šä»€ä¹ˆæ˜¯B+æ ‘ï¼Ÿ","content":"åŸåˆ› [ç¨‹åºå‘˜å°ç°(å…¬ä¼—å·ï¼Œå¼ºçƒˆæ¨è)] åœ¨ä¸Šä¸€ç¯‡æ¼«ç”»ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†B-æ ‘çš„åŸç†å’Œåº”ç”¨ï¼Œæ²¡çœ‹è¿‡çš„å°ä¼™ä¼´ä»¬å¯ä»¥ç‚¹å‡»ä¸‹é¢çš„é“¾æ¥ï¼š æ¼«ç”»ï¼šä»€ä¹ˆæ˜¯B-æ ‘ï¼Ÿ è¿™ä¸€æ¬¡æˆ‘ä»¬æ¥ä»‹ç»B+æ ‘ã€‚ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” ä¸€ä¸ªmé˜¶çš„Bæ ‘å…·æœ‰å¦‚ä¸‹å‡ ä¸ªç‰¹å¾ï¼š 1.æ ¹ç»“ç‚¹è‡³å°‘æœ‰ä¸¤ä¸ªå­å¥³ã€‚ 2.æ¯ä¸ªä¸­é—´èŠ‚ç‚¹éƒ½åŒ…å«k-1ä¸ªå…ƒç´ å’Œkä¸ªå­©å­ï¼Œå…¶ä¸­ m/2 &lt;= k &lt;= m 3.æ¯ä¸€ä¸ªå¶å­èŠ‚ç‚¹éƒ½åŒ…å«k-1ä¸ªå…ƒç´ ï¼Œå…¶ä¸­ m/2 &lt;= k &lt;= m 4.æ‰€æœ‰çš„å¶å­ç»“ç‚¹éƒ½ä½äºåŒä¸€å±‚ã€‚ 5.æ¯ä¸ªèŠ‚ç‚¹ä¸­çš„å…ƒç´ ä»å°åˆ°å¤§æ’åˆ—ï¼ŒèŠ‚ç‚¹å½“ä¸­k-1ä¸ªå…ƒç´ æ­£å¥½æ˜¯kä¸ªå­©å­åŒ…å«çš„å…ƒç´ çš„å€¼åŸŸåˆ†åˆ’ã€‚ ä¸€ä¸ªmé˜¶çš„B+æ ‘å…·æœ‰å¦‚ä¸‹å‡ ä¸ªç‰¹å¾ï¼š 1.æœ‰kä¸ªå­æ ‘çš„ä¸­é—´èŠ‚ç‚¹åŒ…å«æœ‰kä¸ªå…ƒç´ ï¼ˆBæ ‘ä¸­æ˜¯k-1ä¸ªå…ƒç´ ï¼‰ï¼Œæ¯ä¸ªå…ƒç´ ä¸ä¿å­˜æ•°æ®ï¼Œåªç”¨æ¥ç´¢å¼•ï¼Œæ‰€æœ‰æ•°æ®éƒ½ä¿å­˜åœ¨å¶å­èŠ‚ç‚¹ã€‚ 2.æ‰€æœ‰çš„å¶å­ç»“ç‚¹ä¸­åŒ…å«äº†å…¨éƒ¨å…ƒç´ çš„ä¿¡æ¯ï¼ŒåŠæŒ‡å‘å«è¿™äº›å…ƒç´ è®°å½•çš„æŒ‡é’ˆï¼Œä¸”å¶å­ç»“ç‚¹æœ¬èº«ä¾å…³é”®å­—çš„å¤§å°è‡ªå°è€Œå¤§é¡ºåºé“¾æ¥ã€‚ 3.æ‰€æœ‰çš„ä¸­é—´èŠ‚ç‚¹å…ƒç´ éƒ½åŒæ—¶å­˜åœ¨äºå­èŠ‚ç‚¹ï¼Œåœ¨å­èŠ‚ç‚¹å…ƒç´ ä¸­æ˜¯æœ€å¤§ï¼ˆæˆ–æœ€å°ï¼‰å…ƒç´ ã€‚ B-æ ‘ä¸­çš„å«æ˜Ÿæ•°æ®ï¼ˆSatellite Informationï¼‰ï¼š B+æ ‘ä¸­çš„å«æ˜Ÿæ•°æ®ï¼ˆSatellite Informationï¼‰ï¼š éœ€è¦è¡¥å……çš„æ˜¯ï¼Œåœ¨æ•°æ®åº“çš„èšé›†ç´¢å¼•ï¼ˆClustered Indexï¼‰ä¸­ï¼Œå¶å­èŠ‚ç‚¹ç›´æ¥åŒ…å«å«æ˜Ÿæ•°æ®ã€‚åœ¨éèšé›†ç´¢å¼•ï¼ˆNonClustered Indexï¼‰ä¸­ï¼Œå¶å­èŠ‚ç‚¹å¸¦æœ‰æŒ‡å‘å«æ˜Ÿæ•°æ®çš„æŒ‡é’ˆã€‚ ç¬¬ä¸€æ¬¡ç£ç›˜IOï¼š ç¬¬äºŒæ¬¡ç£ç›˜IOï¼š ç¬¬ä¸‰æ¬¡ç£ç›˜IOï¼š B-æ ‘çš„èŒƒå›´æŸ¥æ‰¾è¿‡ç¨‹ ** ** è‡ªé¡¶å‘ä¸‹ï¼ŒæŸ¥æ‰¾åˆ°èŒƒå›´çš„ä¸‹é™ï¼ˆ3ï¼‰ï¼š ä¸­åºéå†åˆ°å…ƒç´ 6ï¼š ä¸­åºéå†åˆ°å…ƒç´ 8ï¼š ä¸­åºéå†åˆ°å…ƒç´ 9ï¼š ä¸­åºéå†åˆ°å…ƒç´ 11ï¼Œéå†ç»“æŸï¼š B+æ ‘çš„èŒƒå›´æŸ¥æ‰¾è¿‡ç¨‹ ** ** è‡ªé¡¶å‘ä¸‹ï¼ŒæŸ¥æ‰¾åˆ°èŒƒå›´çš„ä¸‹é™ï¼ˆ3ï¼‰ï¼š é€šè¿‡é“¾è¡¨æŒ‡é’ˆï¼Œéå†åˆ°å…ƒç´ 6, 8ï¼š é€šè¿‡é“¾è¡¨æŒ‡é’ˆï¼Œéå†åˆ°å…ƒç´ 9, 11ï¼Œéå†ç»“æŸï¼š B+æ ‘çš„ç‰¹å¾ï¼š 1.æœ‰kä¸ªå­æ ‘çš„ä¸­é—´èŠ‚ç‚¹åŒ…å«æœ‰kä¸ªå…ƒç´ ï¼ˆBæ ‘ä¸­æ˜¯k-1ä¸ªå…ƒç´ ï¼‰ï¼Œæ¯ä¸ªå…ƒç´ ä¸ä¿å­˜æ•°æ®ï¼Œåªç”¨æ¥ç´¢å¼•ï¼Œæ‰€æœ‰æ•°æ®éƒ½ä¿å­˜åœ¨å¶å­èŠ‚ç‚¹ã€‚ 2.æ‰€æœ‰çš„å¶å­ç»“ç‚¹ä¸­åŒ…å«äº†å…¨éƒ¨å…ƒç´ çš„ä¿¡æ¯ï¼ŒåŠæŒ‡å‘å«è¿™äº›å…ƒç´ è®°å½•çš„æŒ‡é’ˆï¼Œä¸”å¶å­ç»“ç‚¹æœ¬èº«ä¾å…³é”®å­—çš„å¤§å°è‡ªå°è€Œå¤§é¡ºåºé“¾æ¥ã€‚ 3.æ‰€æœ‰çš„ä¸­é—´èŠ‚ç‚¹å…ƒç´ éƒ½åŒæ—¶å­˜åœ¨äºå­èŠ‚ç‚¹ï¼Œåœ¨å­èŠ‚ç‚¹å…ƒç´ ä¸­æ˜¯æœ€å¤§ï¼ˆæˆ–æœ€å°ï¼‰å…ƒç´ ã€‚ B+æ ‘çš„ä¼˜åŠ¿ï¼š 1.å•ä¸€èŠ‚ç‚¹å­˜å‚¨æ›´å¤šçš„å…ƒç´ ï¼Œä½¿å¾—æŸ¥è¯¢çš„IOæ¬¡æ•°æ›´å°‘ã€‚ 2.æ‰€æœ‰æŸ¥è¯¢éƒ½è¦æŸ¥æ‰¾åˆ°å¶å­èŠ‚ç‚¹ï¼ŒæŸ¥è¯¢æ€§èƒ½ç¨³å®šã€‚ 3.æ‰€æœ‰å¶å­èŠ‚ç‚¹å½¢æˆæœ‰åºé“¾è¡¨ï¼Œä¾¿äºèŒƒå›´æŸ¥è¯¢ã€‚ â€”â€”â€”â€”â€”ENDâ€”â€”â€”â€”â€” ","link":"https://tianxiawuhao.github.io/jVTlR3ljT/"},{"title":"æ¼«ç”»ï¼šä»€ä¹ˆæ˜¯B-æ ‘ï¼Ÿ","content":"åŸåˆ› [ç¨‹åºå‘˜å°ç°(å…¬ä¼—å·ï¼Œå¼ºçƒˆæ¨è)] â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” äºŒå‰æŸ¥æ‰¾æ ‘çš„ç»“æ„ï¼š ç¬¬1æ¬¡ç£ç›˜IOï¼š ç¬¬2æ¬¡ç£ç›˜IOï¼š ç¬¬3æ¬¡ç£ç›˜IOï¼š ç¬¬4æ¬¡ç£ç›˜IOï¼š ä¸‹é¢æ¥å…·ä½“ä»‹ç»ä¸€ä¸‹B-æ ‘ï¼ˆBalance Treeï¼‰ï¼Œä¸€ä¸ªmé˜¶çš„Bæ ‘å…·æœ‰å¦‚ä¸‹å‡ ä¸ªç‰¹å¾ï¼š 1.æ ¹ç»“ç‚¹è‡³å°‘æœ‰ä¸¤ä¸ªå­å¥³ã€‚ 2.æ¯ä¸ªä¸­é—´èŠ‚ç‚¹éƒ½åŒ…å«k-1ä¸ªå…ƒç´ å’Œkä¸ªå­©å­ï¼Œå…¶ä¸­ m/2 &lt;= k &lt;= m 3.æ¯ä¸€ä¸ªå¶å­èŠ‚ç‚¹éƒ½åŒ…å«k-1ä¸ªå…ƒç´ ï¼Œå…¶ä¸­ m/2 &lt;= k &lt;= m 4.æ‰€æœ‰çš„å¶å­ç»“ç‚¹éƒ½ä½äºåŒä¸€å±‚ã€‚ 5.æ¯ä¸ªèŠ‚ç‚¹ä¸­çš„å…ƒç´ ä»å°åˆ°å¤§æ’åˆ—ï¼ŒèŠ‚ç‚¹å½“ä¸­k-1ä¸ªå…ƒç´ æ­£å¥½æ˜¯kä¸ªå­©å­åŒ…å«çš„å…ƒç´ çš„å€¼åŸŸåˆ†åˆ’ã€‚ ç¬¬1æ¬¡ç£ç›˜IOï¼š åœ¨å†…å­˜ä¸­å®šä½ï¼ˆå’Œ9æ¯”è¾ƒï¼‰ï¼š ç¬¬2æ¬¡ç£ç›˜IOï¼š åœ¨å†…å­˜ä¸­å®šä½ï¼ˆå’Œ2ï¼Œ6æ¯”è¾ƒï¼‰ï¼š ç¬¬3æ¬¡ç£ç›˜IOï¼š åœ¨å†…å­˜ä¸­å®šä½ï¼ˆå’Œ3ï¼Œ5æ¯”è¾ƒï¼‰ï¼š è‡ªé¡¶å‘ä¸‹æŸ¥æ‰¾4çš„èŠ‚ç‚¹ä½ç½®ï¼Œå‘ç°4åº”å½“æ’å…¥åˆ°èŠ‚ç‚¹å…ƒç´ 3ï¼Œ5ä¹‹é—´ã€‚ èŠ‚ç‚¹3ï¼Œ5å·²ç»æ˜¯ä¸¤å…ƒç´ èŠ‚ç‚¹ï¼Œæ— æ³•å†å¢åŠ ã€‚çˆ¶äº²èŠ‚ç‚¹ 2ï¼Œ 6 ä¹Ÿæ˜¯ä¸¤å…ƒç´ èŠ‚ç‚¹ï¼Œä¹Ÿæ— æ³•å†å¢åŠ ã€‚æ ¹èŠ‚ç‚¹9æ˜¯å•å…ƒç´ èŠ‚ç‚¹ï¼Œå¯ä»¥å‡çº§ä¸ºä¸¤å…ƒç´ èŠ‚ç‚¹ã€‚äºæ˜¯æ‹†åˆ†èŠ‚ç‚¹3ï¼Œ5ä¸èŠ‚ç‚¹2ï¼Œ6ï¼Œè®©æ ¹èŠ‚ç‚¹9å‡çº§ä¸ºä¸¤å…ƒç´ èŠ‚ç‚¹4ï¼Œ9ã€‚èŠ‚ç‚¹6ç‹¬ç«‹ä¸ºæ ¹èŠ‚ç‚¹çš„ç¬¬äºŒä¸ªå­©å­ã€‚ è‡ªé¡¶å‘ä¸‹æŸ¥æ‰¾å…ƒç´ 11çš„èŠ‚ç‚¹ä½ç½®ã€‚ åˆ é™¤11åï¼ŒèŠ‚ç‚¹12åªæœ‰ä¸€ä¸ªå­©å­ï¼Œä¸ç¬¦åˆBæ ‘è§„èŒƒã€‚å› æ­¤æ‰¾å‡º12,13,15ä¸‰ä¸ªèŠ‚ç‚¹çš„ä¸­ä½æ•°13ï¼Œå–ä»£èŠ‚ç‚¹12ï¼Œè€ŒèŠ‚ç‚¹12è‡ªèº«ä¸‹ç§»æˆä¸ºç¬¬ä¸€ä¸ªå­©å­ã€‚ï¼ˆè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºå·¦æ—‹ï¼‰ â€”â€”â€”â€”â€”ENDâ€”â€”â€”â€”â€” ","link":"https://tianxiawuhao.github.io/LhRxiTagh/"},{"title":"æ•°æ®ç»“æ„å¸¸è§çš„å…«å¤§æ’åºç®—æ³•","content":"å…«å¤§æ’åºï¼Œä¸‰å¤§æŸ¥æ‰¾æ˜¯ã€Šæ•°æ®ç»“æ„ã€‹å½“ä¸­éå¸¸åŸºç¡€çš„çŸ¥è¯†ç‚¹ï¼Œåœ¨è¿™é‡Œä¸ºäº†å¤ä¹ é¡ºå¸¦æ€»ç»“äº†ä¸€ä¸‹å¸¸è§çš„å…«ç§æ’åºç®—æ³•ã€‚ å¸¸è§çš„å…«å¤§æ’åºç®—æ³•ï¼Œä»–ä»¬ä¹‹é—´å…³ç³»å¦‚ä¸‹ï¼š ä»–ä»¬çš„æ€§èƒ½æ¯”è¾ƒï¼š ä¸‹é¢ï¼Œåˆ©ç”¨javaåˆ†åˆ«å°†ä»–ä»¬è¿›è¡Œå®ç°ã€‚ ç›´æ¥æ’å…¥æ’åº ç®—æ³•æ€æƒ³ï¼š ç›´æ¥æ’å…¥æ’åºçš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯ï¼šå°†æ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ ä¾æ¬¡è·Ÿå‰é¢å·²ç»æ’å¥½çš„å…ƒç´ ç›¸æ¯”è¾ƒï¼Œå¦‚æœé€‰æ‹©çš„å…ƒç´ æ¯”å·²æ’åºçš„å…ƒç´ å°ï¼Œåˆ™äº¤æ¢ï¼Œç›´åˆ°å…¨éƒ¨å…ƒç´ éƒ½æ¯”è¾ƒè¿‡ã€‚ å› æ­¤ï¼Œä»ä¸Šé¢çš„æè¿°ä¸­æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œç›´æ¥æ’å…¥æ’åºå¯ä»¥ç”¨ä¸¤ä¸ªå¾ªç¯å®Œæˆï¼š ç¬¬ä¸€å±‚å¾ªç¯ï¼šéå†å¾…æ¯”è¾ƒçš„æ‰€æœ‰æ•°ç»„å…ƒç´  ç¬¬äºŒå±‚å¾ªç¯ï¼šå°†æœ¬è½®é€‰æ‹©çš„å…ƒç´ (selected)ä¸å·²ç»æ’å¥½åºçš„å…ƒç´ (ordered)ç›¸æ¯”è¾ƒã€‚ å¦‚æœï¼šselected &lt; orderedï¼Œé‚£ä¹ˆå°†äºŒè€…äº¤æ¢ ä»£ç å®ç° package sort; import java.util.Arrays; /** * @author wuhao * @desc ç›´æ¥æ’å…¥æ’åº * @date 2020-12-02 15:04:57 * ç›´æ¥æ’å…¥æ’åºçš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯ï¼šå°†æ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ ä¾æ¬¡è·Ÿå‰é¢å·²ç»æ’å¥½çš„å…ƒç´ ç›¸æ¯”è¾ƒï¼Œå¦‚æœé€‰æ‹©çš„å…ƒç´ æ¯”å·²æ’åºçš„å…ƒç´ å°ï¼Œåˆ™äº¤æ¢ï¼Œç›´åˆ°å…¨éƒ¨å…ƒç´ éƒ½æ¯”è¾ƒè¿‡ã€‚ * å› æ­¤ï¼Œä»ä¸Šé¢çš„æè¿°ä¸­æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œç›´æ¥æ’å…¥æ’åºå¯ä»¥ç”¨ä¸¤ä¸ªå¾ªç¯å®Œæˆï¼š * ç¬¬ä¸€å±‚å¾ªç¯ï¼šéå†å¾…æ¯”è¾ƒçš„æ‰€æœ‰æ•°ç»„å…ƒç´  * ç¬¬äºŒå±‚å¾ªç¯ï¼šå°†æœ¬è½®é€‰æ‹©çš„å…ƒç´ (selected)ä¸å·²ç»æ’å¥½åºçš„å…ƒç´ (ordered)ç›¸æ¯”è¾ƒã€‚ * å¦‚æœï¼šselected &lt; orderedï¼Œé‚£ä¹ˆå°†äºŒè€…äº¤æ¢ */ public class DirectInsertionSort { public static void main(String[] args) { int[] arr = {12, 32, 22, 7, 48}; insertSort(arr); } private static void insertSort(int[] arr) { for (int i = 1; i &lt; arr.length; i++) { int temp = arr[i]; int j; for (j = i - 1; j &gt;= 0; j--) { if (temp &lt; arr[j]) { arr[j + 1] = arr[j]; } else { break; } } arr[j + 1] = temp; } System.out.println(Arrays.toString(arr)); } } å¸Œå°”æ’åº ç®—æ³•æ€æƒ³ï¼š å¸Œå°”æ’åºçš„ç®—æ³•æ€æƒ³ï¼šå°†å¾…æ’åºæ•°ç»„æŒ‰ç…§æ­¥é•¿gapè¿›è¡Œåˆ†ç»„ï¼Œç„¶åå°†æ¯ç»„çš„å…ƒç´ åˆ©ç”¨ç›´æ¥æ’å…¥æ’åºçš„æ–¹æ³•è¿›è¡Œæ’åºï¼›æ¯æ¬¡å°†gapæŠ˜åŠå‡å°ï¼Œå¾ªç¯ä¸Šè¿°æ“ä½œï¼›å½“gap=1æ—¶ï¼Œåˆ©ç”¨ç›´æ¥æ’å…¥ï¼Œå®Œæˆæ’åºã€‚ åŒæ ·çš„ï¼šä»ä¸Šé¢çš„æè¿°ä¸­æˆ‘ä»¬å¯ä»¥å‘ç°ï¼šå¸Œå°”æ’åºçš„æ€»ä½“å®ç°åº”è¯¥ç”±ä¸‰ä¸ªå¾ªç¯å®Œæˆï¼š ç¬¬ä¸€å±‚å¾ªç¯ï¼šå°†gapä¾æ¬¡æŠ˜åŠï¼Œå¯¹åºåˆ—è¿›è¡Œåˆ†ç»„ï¼Œç›´åˆ°gap=1 ç¬¬äºŒã€ä¸‰å±‚å¾ªç¯ï¼šä¹Ÿå³ç›´æ¥æ’å…¥æ’åºæ‰€éœ€è¦çš„ä¸¤æ¬¡å¾ªç¯ã€‚å…·ä½“æè¿°è§ä¸Šã€‚ ä»£ç å®ç° package sort; import java.util.Arrays; /** * @author wuhao * @desc å¸Œå°”æ’åº * @date 2020-12-02 15:20:43 * å¸Œå°”æ’åºçš„ç®—æ³•æ€æƒ³ï¼šå°†å¾…æ’åºæ•°ç»„æŒ‰ç…§æ­¥é•¿gapè¿›è¡Œåˆ†ç»„ï¼Œç„¶åå°†æ¯ç»„çš„å…ƒç´ åˆ©ç”¨ç›´æ¥æ’å…¥æ’åºçš„æ–¹æ³•è¿›è¡Œæ’åºï¼›æ¯æ¬¡å°†gapæŠ˜åŠå‡å°ï¼Œå¾ªç¯ä¸Šè¿°æ“ä½œï¼›å½“gap=1æ—¶ï¼Œåˆ©ç”¨ç›´æ¥æ’å…¥ï¼Œå®Œæˆæ’åºã€‚ * åŒæ ·çš„ï¼šä»ä¸Šé¢çš„æè¿°ä¸­æˆ‘ä»¬å¯ä»¥å‘ç°ï¼šå¸Œå°”æ’åºçš„æ€»ä½“å®ç°åº”è¯¥ç”±ä¸‰ä¸ªå¾ªç¯å®Œæˆï¼š * ç¬¬ä¸€å±‚å¾ªç¯ï¼šå°†gapä¾æ¬¡æŠ˜åŠï¼Œå¯¹åºåˆ—è¿›è¡Œåˆ†ç»„ï¼Œç›´åˆ°gap=1 * ç¬¬äºŒã€ä¸‰å±‚å¾ªç¯ï¼šä¹Ÿå³ç›´æ¥æ’å…¥æ’åºæ‰€éœ€è¦çš„ä¸¤æ¬¡å¾ªç¯ã€‚å…·ä½“æè¿°è§ä¸Šã€‚ */ public class HillSort { public static void main(String[] args) { int[] arr = {12, 32, 22, 7, 48, 3, 5, 6, 8, 24}; shellSort(arr); } private static void shellSort(int[] arr) { for (int step = arr.length / 2; step &gt; 0; step /= 2) { // for (int i = step; i &lt; arr.length; i++) { // int temp = arr[i]; // int j; // for (j = i - step; j &gt;= 0 &amp;&amp; arr[j] &gt; temp; j -= step) { // arr[j + step] = arr[j]; // } // arr[j + step] = temp; // } for (int i = step; i &lt; arr.length; i++) { int k=i; for (int j = i-step; j &gt;=0 &amp;&amp; arr[j] &gt; arr[k]; j -= step,k -=step) { int temp = arr[j]; arr[j]= arr[k]; arr[k]=temp; } } } System.out.println(Arrays.toString(arr)); } } ç®€å•é€‰æ‹©æ’åº ç®—æ³•æ€æƒ³ ç®€å•é€‰æ‹©æ’åºçš„åŸºæœ¬æ€æƒ³ï¼šæ¯”è¾ƒ+äº¤æ¢ã€‚ ä»å¾…æ’åºåºåˆ—ä¸­ï¼Œæ‰¾åˆ°å…³é”®å­—æœ€å°çš„å…ƒç´ ï¼› å¦‚æœæœ€å°å…ƒç´ ä¸æ˜¯å¾…æ’åºåºåˆ—çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå°†å…¶å’Œç¬¬ä¸€ä¸ªå…ƒç´ äº’æ¢ï¼› ä»ä½™ä¸‹çš„ N - 1 ä¸ªå…ƒç´ ä¸­ï¼Œæ‰¾å‡ºå…³é”®å­—æœ€å°çš„å…ƒç´ ï¼Œé‡å¤(1)ã€(2)æ­¥ï¼Œç›´åˆ°æ’åºç»“æŸã€‚ å› æ­¤æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œç®€å•é€‰æ‹©æ’åºä¹Ÿæ˜¯é€šè¿‡ä¸¤å±‚å¾ªç¯å®ç°ã€‚ ç¬¬ä¸€å±‚å¾ªç¯ï¼šä¾æ¬¡éå†åºåˆ—å½“ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´  ç¬¬äºŒå±‚å¾ªç¯ï¼šå°†éå†å¾—åˆ°çš„å½“å‰å…ƒç´ ä¾æ¬¡ä¸ä½™ä¸‹çš„å…ƒç´ è¿›è¡Œæ¯”è¾ƒï¼Œç¬¦åˆæœ€å°å…ƒç´ çš„æ¡ä»¶ï¼Œåˆ™äº¤æ¢ã€‚ ä»£ç å®ç° package sort; import java.util.Arrays; /** * @author wuhao * @desc ç®€å•é€‰æ‹©æ’åº * @date 2020-12-02 16:21:47 * ç®€å•é€‰æ‹©æ’åºçš„åŸºæœ¬æ€æƒ³ï¼šæ¯”è¾ƒ+äº¤æ¢ã€‚ * ä»å¾…æ’åºåºåˆ—ä¸­ï¼Œæ‰¾åˆ°å…³é”®å­—æœ€å°çš„å…ƒç´ ï¼› * å¦‚æœæœ€å°å…ƒç´ ä¸æ˜¯å¾…æ’åºåºåˆ—çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå°†å…¶å’Œç¬¬ä¸€ä¸ªå…ƒç´ äº’æ¢ï¼› * ä»ä½™ä¸‹çš„ N - 1 ä¸ªå…ƒç´ ä¸­ï¼Œæ‰¾å‡ºå…³é”®å­—æœ€å°çš„å…ƒç´ ï¼Œé‡å¤(1)ã€(2)æ­¥ï¼Œç›´åˆ°æ’åºç»“æŸã€‚ * å› æ­¤æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œç®€å•é€‰æ‹©æ’åºä¹Ÿæ˜¯é€šè¿‡ä¸¤å±‚å¾ªç¯å®ç°ã€‚ * ç¬¬ä¸€å±‚å¾ªç¯ï¼šä¾æ¬¡éå†åºåˆ—å½“ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´  * ç¬¬äºŒå±‚å¾ªç¯ï¼šå°†éå†å¾—åˆ°çš„å½“å‰å…ƒç´ ä¾æ¬¡ä¸ä½™ä¸‹çš„å…ƒç´ è¿›è¡Œæ¯”è¾ƒï¼Œç¬¦åˆæœ€å°å…ƒç´ çš„æ¡ä»¶ï¼Œåˆ™äº¤æ¢ã€‚ */ public class SimpleSelectionSort { public static void main(String[] args) { int[] arr = {12, 32, 22, 7, 48, 3, 5, 6, 8, 24}; selectionSort(arr); } private static void selectionSort(int[] arr) { for (int i = 0; i &lt; arr.length; i++) { int k = i; for (int j = i + 1; j &lt; arr.length; j++) { if (arr[j] &lt; arr[k]) { k = j; } } if (k != i) { int temp = arr[i]; arr[i] = arr[k]; arr[k] = temp; } } System.out.println(Arrays.toString(arr)); } } å †æ’åº å †çš„æ¦‚å¿µ å †ï¼šæœ¬è´¨æ˜¯ä¸€ç§æ•°ç»„å¯¹è±¡ã€‚ç‰¹åˆ«é‡è¦çš„ä¸€ç‚¹æ€§è´¨ï¼šä»»æ„çš„å¶å­èŠ‚ç‚¹å°äºï¼ˆæˆ–å¤§äºï¼‰å®ƒæ‰€æœ‰çš„çˆ¶èŠ‚ç‚¹ã€‚å¯¹æ­¤ï¼Œåˆåˆ†ä¸ºå¤§é¡¶å †å’Œå°é¡¶å †ï¼Œå¤§é¡¶å †è¦æ±‚èŠ‚ç‚¹çš„å…ƒç´ éƒ½è¦å¤§äºå…¶å­©å­ï¼Œå°é¡¶å †è¦æ±‚èŠ‚ç‚¹å…ƒç´ éƒ½å°äºå…¶å·¦å³å­©å­ï¼Œä¸¤è€…å¯¹å·¦å³å­©å­çš„å¤§å°å…³ç³»ä¸åšä»»ä½•è¦æ±‚ã€‚ åˆ©ç”¨å †æ’åºï¼Œå°±æ˜¯åŸºäºå¤§é¡¶å †æˆ–è€…å°é¡¶å †çš„ä¸€ç§æ’åºæ–¹æ³•ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬é€šè¿‡å¤§é¡¶å †æ¥å®ç°ã€‚ åŸºæœ¬æ€æƒ³ï¼š å †æ’åºå¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ¥å®Œæˆï¼š æ„å»ºå¤§é¡¶å †.png Paste_Image.png æ„å»ºåˆå§‹å †ï¼Œå°†å¾…æ’åºåˆ—æ„æˆä¸€ä¸ªå¤§é¡¶å †(æˆ–è€…å°é¡¶å †)ï¼Œå‡åºå¤§é¡¶å †ï¼Œé™åºå°é¡¶å †ï¼› å°†å †é¡¶å…ƒç´ ä¸å †å°¾å…ƒç´ äº¤æ¢ï¼Œå¹¶æ–­å¼€(ä»å¾…æ’åºåˆ—ä¸­ç§»é™¤)å †å°¾å…ƒç´ ã€‚ é‡æ–°æ„å»ºå †ã€‚ é‡å¤2~3ï¼Œç›´åˆ°å¾…æ’åºåˆ—ä¸­åªå‰©ä¸‹ä¸€ä¸ªå…ƒç´ (å †é¡¶å…ƒç´ )ã€‚ ä»£ç å®ç°ï¼š package sort; import java.util.Arrays; /** * @author wuhao * @desc å †æ’åº * @date 2020-12-04 09:13:58 * å †æ’åºå¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ¥å®Œæˆï¼š * é¦–å…ˆå°†åºåˆ—æ„å»ºç§°ä¸ºå¤§é¡¶å †ï¼› * ï¼ˆè¿™æ ·æ»¡è¶³äº†å¤§é¡¶å †é‚£æ¡æ€§è´¨ï¼šä½äºæ ¹èŠ‚ç‚¹çš„å…ƒç´ ä¸€å®šæ˜¯å½“å‰åºåˆ—çš„æœ€å¤§å€¼ï¼‰ * å–å‡ºå½“å‰å¤§é¡¶å †çš„æ ¹èŠ‚ç‚¹ï¼Œå°†å…¶ä¸åºåˆ—æœ«å°¾å…ƒç´ è¿›è¡Œäº¤æ¢ï¼› * ï¼ˆæ­¤æ—¶ï¼šåºåˆ—æœ«å°¾çš„å…ƒç´ ä¸ºå·²æ’åºçš„æœ€å¤§å€¼ï¼›ç”±äºäº¤æ¢äº†å…ƒç´ ï¼Œå½“å‰ä½äºæ ¹èŠ‚ç‚¹çš„å †å¹¶ä¸ä¸€å®šæ»¡è¶³å¤§é¡¶å †çš„æ€§è´¨ï¼‰ * å¯¹äº¤æ¢åçš„n-1ä¸ªåºåˆ—å…ƒç´ è¿›è¡Œè°ƒæ•´ï¼Œä½¿å…¶æ»¡è¶³å¤§é¡¶å †çš„æ€§è´¨ï¼› * é‡å¤2.3æ­¥éª¤ï¼Œç›´è‡³å †ä¸­åªæœ‰1ä¸ªå…ƒç´ ä¸ºæ­¢ */ public class HeapSort { public static void main(String[] args) { int[] arr = {11, 44, 23, 67, 88, 65, 34, 48, 9, 12}; heapSort(arr); System.out.println(Arrays.toString(arr)); } private static void heapSort(int[] a) { // é¦–å…ˆéœ€è¦åˆ›å»ºæ ¹å † for (int i = a.length / 2; i &gt;= 0; i--) { // ä»æœ€åä¸€ä¸ªéç»ˆç«¯ç»“ç‚¹å¼€å§‹ï¼Œç„¶åä¸€æ¬¡-- HeapAdjust(a, i, a.length); } for (int i = a.length - 1; i &gt; 0; --i) {// è¿™ä¸ªå¾ªç¯æ˜¯æŠŠæœ€å¤§å€¼a[0]æ”¾åˆ°æœ«å°¾ ï¼Œ int temp = a[0]; a[0] = a[i]; // æ­¤æ—¶iä»£è¡¨æœ€åä¸€ä¸ªå…ƒç´  a[i] = temp; HeapAdjust(a, 0, i ); } } // è°ƒæ•´å † private static void HeapAdjust(int[] a, int parent, int m) {// parentä»£è¡¨å½“å‰ mä»£è¡¨æœ€å int temp = a[parent]; // å…ˆæŠŠa[parent]çš„å€¼èµ‹ç»™tempä¿å­˜èµ·æ¥ for (int j = 2 * parent; j &lt; m; j *= 2) { if (j+1 &lt; m &amp;&amp; a[j] &lt; a[j + 1]) { // åˆ¤æ–­æ˜¯a[parent]å¤§è¿˜æ˜¯a[j + 1]å¤§ï¼Œå¦‚æœa[j + 1]å¤§ å°±++jï¼ŒæŠŠjæ¢æˆå½“å‰æœ€å¤§ j++; } if (temp &gt;= a[j]) { // å¦‚æœtempä¸­æ¯”æœ€å¤§å€¼è¿˜å¤§ï¼Œä»£è¡¨æœ¬èº«å°±æ˜¯ä¸€ä¸ªæ ¹å †ï¼Œbreak break;// å¦‚æœå¤§äºï¼Œå°±ä»£è¡¨å½“å‰ä¸ºå¤§è·Ÿå¯¹ï¼Œé€€å‡º } a[parent] = a[j];// å¦åˆ™å°±æŠŠæœ€å¤§ç»™[parent] parent = j;// ç„¶åæŠŠæœ€å¤§ä¸‹æ ‡ç»™parentï¼Œç»§ç»­å¾ªç¯,æ£€æŸ¥æ˜¯å¦å› ä¸ºè°ƒæ•´æ ¹å †è€Œç ´åäº†å­æ ‘ } a[parent] = temp; } /** * åˆ›å»ºå †ï¼Œ * @param arr å¾…æ’åºåˆ— */ // private static void heapSort(int[] arr) { // //åˆ›å»ºå † // for (int i = (arr.length - 1) / 2; i &gt;= 0; i--) { // //ä»ç¬¬ä¸€ä¸ªéå¶å­ç»“ç‚¹ä»ä¸‹è‡³ä¸Šï¼Œä»å³è‡³å·¦è°ƒæ•´ç»“æ„ // adjustHeap(arr, i, arr.length); // } // // //è°ƒæ•´å †ç»“æ„+äº¤æ¢å †é¡¶å…ƒç´ ä¸æœ«å°¾å…ƒç´  // for (int i = arr.length - 1; i &gt; 0; i--) { // //å°†å †é¡¶å…ƒç´ ä¸æœ«å°¾å…ƒç´ è¿›è¡Œäº¤æ¢ // int temp = arr[i]; // arr[i] = arr[0]; // arr[0] = temp; // // //é‡æ–°å¯¹å †è¿›è¡Œè°ƒæ•´ // adjustHeap(arr, 0, i); // } // } /** * è°ƒæ•´å † * @param arr å¾…æ’åºåˆ— * @param parent çˆ¶èŠ‚ç‚¹ * @param length å¾…æ’åºåˆ—å°¾å…ƒç´ ç´¢å¼• */ // private static void adjustHeap(int[] arr, int parent, int length) { // //å°†tempä½œä¸ºçˆ¶èŠ‚ç‚¹ // int temp = arr[parent]; // //å·¦å­©å­ // int lChild = 2 * parent + 1; // // while (lChild &lt; length) { // //å³å­©å­ // int rChild = lChild + 1; // // å¦‚æœæœ‰å³å­©å­ç»“ç‚¹ï¼Œå¹¶ä¸”å³å­©å­ç»“ç‚¹çš„å€¼å¤§äºå·¦å­©å­ç»“ç‚¹ï¼Œåˆ™é€‰å–å³å­©å­ç»“ç‚¹ // if (rChild &lt; length &amp;&amp; arr[lChild] &lt; arr[rChild]) { // lChild++; // } // // // å¦‚æœçˆ¶ç»“ç‚¹çš„å€¼å·²ç»å¤§äºå­©å­ç»“ç‚¹çš„å€¼ï¼Œåˆ™ç›´æ¥ç»“æŸ // if (temp &gt;= arr[lChild]) { // break; // } // // // æŠŠå­©å­ç»“ç‚¹çš„å€¼èµ‹ç»™çˆ¶ç»“ç‚¹ // arr[parent] = arr[lChild]; // // //é€‰å–å­©å­ç»“ç‚¹çš„å·¦å­©å­ç»“ç‚¹,ç»§ç»­å‘ä¸‹ç­›é€‰ // parent = lChild; // lChild = 2 * lChild + 1; // } // arr[parent] = temp; // } } å†’æ³¡æ’åº åŸºæœ¬æ€æƒ³ å†’æ³¡æ’åºæ€è·¯æ¯”è¾ƒç®€å•ï¼š å°†åºåˆ—å½“ä¸­çš„å·¦å³å…ƒç´ ï¼Œä¾æ¬¡æ¯”è¾ƒï¼Œä¿è¯å³è¾¹çš„å…ƒç´ å§‹ç»ˆå¤§äºå·¦è¾¹çš„å…ƒç´ ï¼› ï¼ˆ ç¬¬ä¸€è½®ç»“æŸåï¼Œåºåˆ—æœ€åä¸€ä¸ªå…ƒç´ ä¸€å®šæ˜¯å½“å‰åºåˆ—çš„æœ€å¤§å€¼ï¼›ï¼‰ å¯¹åºåˆ—å½“ä¸­å‰©ä¸‹çš„n-1ä¸ªå…ƒç´ å†æ¬¡æ‰§è¡Œæ­¥éª¤1ã€‚ å¯¹äºé•¿åº¦ä¸ºnçš„åºåˆ—ï¼Œä¸€å…±éœ€è¦æ‰§è¡Œn-1è½®æ¯”è¾ƒ ï¼ˆåˆ©ç”¨whileå¾ªç¯å¯ä»¥å‡å°‘æ‰§è¡Œæ¬¡æ•°ï¼‰ ä»£ç å®ç° package sort; import java.util.Arrays; /** * @author wuhao * @desc å†’æ³¡æ’åº * @date 2020-12-02 16:34:57 * å†’æ³¡æ’åºæ€è·¯æ¯”è¾ƒç®€å•ï¼š * å°†åºåˆ—å½“ä¸­çš„å·¦å³å…ƒç´ ï¼Œä¾æ¬¡æ¯”è¾ƒï¼Œä¿è¯å³è¾¹çš„å…ƒç´ å§‹ç»ˆå¤§äºå·¦è¾¹çš„å…ƒç´ ï¼› * ï¼ˆ ç¬¬ä¸€è½®ç»“æŸåï¼Œåºåˆ—æœ€åä¸€ä¸ªå…ƒç´ ä¸€å®šæ˜¯å½“å‰åºåˆ—çš„æœ€å¤§å€¼ï¼›ï¼‰ * å¯¹åºåˆ—å½“ä¸­å‰©ä¸‹çš„n-1ä¸ªå…ƒç´ å†æ¬¡æ‰§è¡Œæ­¥éª¤1ã€‚ * å¯¹äºé•¿åº¦ä¸ºnçš„åºåˆ—ï¼Œä¸€å…±éœ€è¦æ‰§è¡Œn-1è½®æ¯”è¾ƒ * ï¼ˆåˆ©ç”¨whileå¾ªç¯å¯ä»¥å‡å°‘æ‰§è¡Œæ¬¡æ•°ï¼‰ */ public class BubbleSort { public static void main(String[] args) { int[] arr = {12, 32, 22, 7, 48}; bubbleSort(arr); } private static void bubbleSort(int[] arr) { for (int i = 0; i &lt; arr.length; i++) { for (int j = 0; j &lt; i; j++) { if (arr[i] &lt; arr[j]) { int temp=arr[j]; arr[j]=arr[i]; arr[i]=temp; } } } System.out.println(Arrays.toString(arr)); } } å¿«é€Ÿæ’åº ç®—æ³•æ€æƒ³ï¼š å¿«é€Ÿæ’åºçš„åŸºæœ¬æ€æƒ³ï¼šæŒ–å‘å¡«æ•°+åˆ†æ²»æ³• ä»åºåˆ—å½“ä¸­é€‰æ‹©ä¸€ä¸ªåŸºå‡†æ•°(pivot) åœ¨è¿™é‡Œæˆ‘ä»¬é€‰æ‹©åºåˆ—å½“ä¸­ç¬¬ä¸€ä¸ªæ•°ä¸ºåŸºå‡†æ•° å°†åºåˆ—å½“ä¸­çš„æ‰€æœ‰æ•°ä¾æ¬¡éå†ï¼Œæ¯”åŸºå‡†æ•°å¤§çš„ä½äºå…¶å³ä¾§ï¼Œæ¯”åŸºå‡†æ•°å°çš„ä½äºå…¶å·¦ä¾§ é‡å¤æ­¥éª¤a.bï¼Œç›´åˆ°æ‰€æœ‰å­é›†å½“ä¸­åªæœ‰ä¸€ä¸ªå…ƒç´ ä¸ºæ­¢ã€‚ ç”¨ä¼ªä»£ç æè¿°å¦‚ä¸‹ï¼š 1ï¼i =L; j = R; å°†åŸºå‡†æ•°æŒ–å‡ºå½¢æˆç¬¬ä¸€ä¸ªå‘a[i]ã€‚ 2ï¼j--ç”±åå‘å‰æ‰¾æ¯”å®ƒå°çš„æ•°ï¼Œæ‰¾åˆ°åæŒ–å‡ºæ­¤æ•°å¡«å‰ä¸€ä¸ªå‘a[i]ä¸­ã€‚ 3ï¼i++ç”±å‰å‘åæ‰¾æ¯”å®ƒå¤§çš„æ•°ï¼Œæ‰¾åˆ°åä¹ŸæŒ–å‡ºæ­¤æ•°å¡«åˆ°å‰ä¸€ä¸ªå‘a[j]ä¸­ã€‚ 4ï¼å†é‡å¤æ‰§è¡Œ2ï¼Œ3äºŒæ­¥ï¼Œç›´åˆ°i==jï¼Œå°†åŸºå‡†æ•°å¡«å…¥a[i]ä¸­ ä»£ç å®ç°ï¼š package sort; import java.util.Arrays; import java.util.Stack; /** * @author wuhao * @desc å¿«é€Ÿæ’åº * @date 2020-12-02 17:08:57 * å¿«é€Ÿæ’åºçš„åŸºæœ¬æ€æƒ³ï¼šæŒ–å‘å¡«æ•°+åˆ†æ²»æ³• * ä»åºåˆ—å½“ä¸­é€‰æ‹©ä¸€ä¸ªåŸºå‡†æ•°(pivot) * åœ¨è¿™é‡Œæˆ‘ä»¬é€‰æ‹©åºåˆ—å½“ä¸­ç¬¬ä¸€ä¸ªæ•°ä¸ºåŸºå‡†æ•° * å°†åºåˆ—å½“ä¸­çš„æ‰€æœ‰æ•°ä¾æ¬¡éå†ï¼Œæ¯”åŸºå‡†æ•°å¤§çš„ä½äºå…¶å³ä¾§ï¼Œæ¯”åŸºå‡†æ•°å°çš„ä½äºå…¶å·¦ä¾§ * é‡å¤æ­¥éª¤a.bï¼Œç›´åˆ°æ‰€æœ‰å­é›†å½“ä¸­åªæœ‰ä¸€ä¸ªå…ƒç´ ä¸ºæ­¢ã€‚ * ç”¨ä¼ªä»£ç æè¿°å¦‚ä¸‹ï¼š * 1ï¼i =L; j = R; å°†åŸºå‡†æ•°æŒ–å‡ºå½¢æˆç¬¬ä¸€ä¸ªå‘a[i]ã€‚ * 2ï¼j--ç”±åå‘å‰æ‰¾æ¯”å®ƒå°çš„æ•°ï¼Œæ‰¾åˆ°åæŒ–å‡ºæ­¤æ•°å¡«å‰ä¸€ä¸ªå‘a[i]ä¸­ã€‚ * 3ï¼i++ç”±å‰å‘åæ‰¾æ¯”å®ƒå¤§çš„æ•°ï¼Œæ‰¾åˆ°åä¹ŸæŒ–å‡ºæ­¤æ•°å¡«åˆ°å‰ä¸€ä¸ªå‘a[j]ä¸­ã€‚ * 4ï¼å†é‡å¤æ‰§è¡Œ2ï¼Œ3äºŒæ­¥ï¼Œç›´åˆ°i==jï¼Œå°†åŸºå‡†æ•°å¡«å…¥a[i]ä¸­ */ public class QuickSort { public static void main(String[] args) { int[] arr = {12, 32, 22, 7, 48, 3, 35, 6, 8, 42}; // quickSort(arr, 0, arr.length - 1); System.out.println(Arrays.toString(arr)); /*-----------éé€’å½’å®ç°----------*/ sort(arr, 0, arr.length - 1); System.out.println(Arrays.toString(arr)); } private static void quickSort(int[] arr, int left, int right) { if (left &gt; right) { return; } // baseä¸­å­˜æ”¾åŸºå‡†æ•° int base = arr[left]; int i = left, j = right; while (i != j) { // é¡ºåºå¾ˆé‡è¦ï¼Œå…ˆä»å³è¾¹å¼€å§‹å¾€å·¦æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°æ¯”baseå€¼å°çš„æ•° while (arr[j] &gt;= base &amp;&amp; i &lt; j) { j--; } // å†ä»å·¦å¾€å³è¾¹æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°æ¯”baseå€¼å¤§çš„æ•° while (arr[i] &lt;= base &amp;&amp; i &lt; j) { i++; } // ä¸Šé¢çš„å¾ªç¯ç»“æŸè¡¨ç¤ºæ‰¾åˆ°äº†ä½ç½®æˆ–è€…(i&gt;=j)äº†ï¼Œäº¤æ¢ä¸¤ä¸ªæ•°åœ¨æ•°ç»„ä¸­çš„ä½ç½® if (i &lt; j) { int tmp = arr[i]; arr[i] = arr[j]; arr[j] = tmp; } } // å°†åŸºå‡†æ•°æ”¾åˆ°ä¸­é—´çš„ä½ç½®ï¼ˆåŸºå‡†æ•°å½’ä½ï¼‰ arr[left] = arr[i]; arr[i] = base; // é€’å½’ï¼Œç»§ç»­å‘åŸºå‡†çš„å·¦å³ä¸¤è¾¹æ‰§è¡Œå’Œä¸Šé¢åŒæ ·çš„æ“ä½œ // içš„ç´¢å¼•å¤„ä¸ºä¸Šé¢å·²ç¡®å®šå¥½çš„åŸºå‡†å€¼çš„ä½ç½®ï¼Œæ— éœ€å†å¤„ç† quickSort(arr, left, i - 1); quickSort(arr, i + 1, right); } /*-----------------------------éé€’å½’å®ç°------------------------------*/ public static void sort(int[] arr, int left, int right) { int privot, top, last; Stack&lt;Integer&gt; s = new Stack&lt;&gt;(); privot = QuickSort(arr, left, right); if (privot &gt; left + 1) { s.push(left); s.push(privot - 1); } if (privot &lt; right - 1) { s.push(privot + 1); s.push(right); } while (!s.empty()) { top = s.pop(); last = s.pop(); privot = QuickSort(arr, last, top); if (privot &gt; last + 1) { s.push(last); s.push(privot - 1); } if (privot &lt; top - 1) { //System.out.println(top); s.push(privot + 1); s.push(top); } } } public static int QuickSort(int[] arr, int left, int right) { int privot = left; while (left &lt; right) { while ((arr[privot] &lt; arr[right]) &amp; left &lt; right) { right--; } int temp = arr[privot]; arr[privot] = arr[right]; arr[right] = temp; privot = right; while ((arr[privot] &gt; arr[left]) &amp; left &lt; right) { left++; } temp = arr[privot]; arr[privot] = arr[left]; arr[left] = temp; privot = left; } return privot; } } å½’å¹¶æ’åº ç®—æ³•æ€æƒ³ï¼š å½’å¹¶æ’åºæ˜¯å»ºç«‹åœ¨å½’å¹¶æ“ä½œä¸Šçš„ä¸€ç§æœ‰æ•ˆçš„æ’åºç®—æ³•ï¼Œè¯¥ç®—æ³•æ˜¯é‡‡ç”¨0çš„ä¸€ä¸ªå…¸å‹çš„åº”ç”¨ã€‚å®ƒçš„åŸºæœ¬æ“ä½œæ˜¯ï¼šå°†å·²æœ‰çš„å­åºåˆ—åˆå¹¶ï¼Œè¾¾åˆ°å®Œå…¨æœ‰åºçš„åºåˆ—ï¼›å³å…ˆä½¿æ¯ä¸ªå­åºåˆ—æœ‰åºï¼Œå†ä½¿å­åºåˆ—æ®µé—´æœ‰åºã€‚ å½’å¹¶æ’åºå…¶å®è¦åšä¸¤ä»¶äº‹ï¼š åˆ†è§£----å°†åºåˆ—æ¯æ¬¡æŠ˜åŠæ‹†åˆ† åˆå¹¶----å°†åˆ’åˆ†åçš„åºåˆ—æ®µä¸¤ä¸¤æ’åºåˆå¹¶ å› æ­¤ï¼Œå½’å¹¶æ’åºå®é™…ä¸Šå°±æ˜¯ä¸¤ä¸ªæ“ä½œï¼Œæ‹†åˆ†+åˆå¹¶ å¦‚ä½•åˆå¹¶ï¼Ÿ L[first...mid]ä¸ºç¬¬ä¸€æ®µï¼ŒL[mid+1...last]ä¸ºç¬¬äºŒæ®µï¼Œå¹¶ä¸”ä¸¤ç«¯å·²ç»æœ‰åºï¼Œç°åœ¨æˆ‘ä»¬è¦å°†ä¸¤ç«¯åˆæˆè¾¾åˆ°L[first...last]å¹¶ä¸”ä¹Ÿæœ‰åºã€‚ é¦–å…ˆä¾æ¬¡ä»ç¬¬ä¸€æ®µä¸ç¬¬äºŒæ®µä¸­å–å‡ºå…ƒç´ æ¯”è¾ƒï¼Œå°†è¾ƒå°çš„å…ƒç´ èµ‹å€¼ç»™temp[] é‡å¤æ‰§è¡Œä¸Šä¸€æ­¥ï¼Œå½“æŸä¸€æ®µèµ‹å€¼ç»“æŸï¼Œåˆ™å°†å¦ä¸€æ®µå‰©ä¸‹çš„å…ƒç´ èµ‹å€¼ç»™temp[] æ­¤æ—¶å°†temp[]ä¸­çš„å…ƒç´ å¤åˆ¶ç»™L[]ï¼Œåˆ™å¾—åˆ°çš„L[first...last]æœ‰åº å¦‚ä½•åˆ†è§£ï¼Ÿ åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬é‡‡ç”¨é€’å½’çš„æ–¹æ³•ï¼Œé¦–å…ˆå°†å¾…æ’åºåˆ—åˆ†æˆA,Bä¸¤ç»„ï¼›ç„¶åé‡å¤å¯¹Aã€Båºåˆ— åˆ†ç»„ï¼›ç›´åˆ°åˆ†ç»„åç»„å†…åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œæ­¤æ—¶æˆ‘ä»¬è®¤ä¸ºç»„å†…æ‰€æœ‰å…ƒç´ æœ‰åºï¼Œåˆ™åˆ†ç»„ç»“æŸã€‚ ä»£ç å®ç° package sort; import java.util.Arrays; /** * @author wuhao * @desc å½’å¹¶æ’åº * @date 2020-12-03 09:35:00 * å½’å¹¶æ’åºæ˜¯å»ºç«‹åœ¨å½’å¹¶æ“ä½œä¸Šçš„ä¸€ç§æœ‰æ•ˆçš„æ’åºç®—æ³•ï¼Œè¯¥ç®—æ³•æ˜¯é‡‡ç”¨0çš„ä¸€ä¸ªå…¸å‹çš„åº”ç”¨ã€‚å®ƒçš„åŸºæœ¬æ“ä½œæ˜¯ï¼šå°†å·²æœ‰çš„å­åºåˆ—åˆå¹¶ï¼Œè¾¾åˆ°å®Œå…¨æœ‰åºçš„åºåˆ—ï¼›å³å…ˆä½¿æ¯ä¸ªå­åºåˆ—æœ‰åºï¼Œå†ä½¿å­åºåˆ—æ®µé—´æœ‰åºã€‚ * å½’å¹¶æ’åºå…¶å®è¦åšä¸¤ä»¶äº‹ï¼š * åˆ†è§£----å°†åºåˆ—æ¯æ¬¡æŠ˜åŠæ‹†åˆ† * åˆå¹¶----å°†åˆ’åˆ†åçš„åºåˆ—æ®µä¸¤ä¸¤æ’åºåˆå¹¶ * å› æ­¤ï¼Œå½’å¹¶æ’åºå®é™…ä¸Šå°±æ˜¯ä¸¤ä¸ªæ“ä½œï¼Œæ‹†åˆ†+åˆå¹¶ * å¦‚ä½•åˆå¹¶ï¼Ÿ * L[first...mid]ä¸ºç¬¬ä¸€æ®µï¼ŒL[mid+1...last]ä¸ºç¬¬äºŒæ®µï¼Œå¹¶ä¸”ä¸¤ç«¯å·²ç»æœ‰åºï¼Œç°åœ¨æˆ‘ä»¬è¦å°†ä¸¤ç«¯åˆæˆè¾¾åˆ°L[first...last]å¹¶ä¸”ä¹Ÿæœ‰åºã€‚ * é¦–å…ˆä¾æ¬¡ä»ç¬¬ä¸€æ®µä¸ç¬¬äºŒæ®µä¸­å–å‡ºå…ƒç´ æ¯”è¾ƒï¼Œå°†è¾ƒå°çš„å…ƒç´ èµ‹å€¼ç»™temp[] * é‡å¤æ‰§è¡Œä¸Šä¸€æ­¥ï¼Œå½“æŸä¸€æ®µèµ‹å€¼ç»“æŸï¼Œåˆ™å°†å¦ä¸€æ®µå‰©ä¸‹çš„å…ƒç´ èµ‹å€¼ç»™temp[] * æ­¤æ—¶å°†temp[]ä¸­çš„å…ƒç´ å¤åˆ¶ç»™L[]ï¼Œåˆ™å¾—åˆ°çš„L[first...last]æœ‰åº * å¦‚ä½•åˆ†è§£ï¼Ÿ * åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬é‡‡ç”¨é€’å½’çš„æ–¹æ³•ï¼Œé¦–å…ˆå°†å¾…æ’åºåˆ—åˆ†æˆA,Bä¸¤ç»„ï¼›ç„¶åé‡å¤å¯¹Aã€Båºåˆ— * åˆ†ç»„ï¼›ç›´åˆ°åˆ†ç»„åç»„å†…åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œæ­¤æ—¶æˆ‘ä»¬è®¤ä¸ºç»„å†…æ‰€æœ‰å…ƒç´ æœ‰åºï¼Œåˆ™åˆ†ç»„ç»“æŸã€‚ */ public class MergeSort { public static void main(String[] args) { int[] arr = {11, 44, 23, 67, 88, 65, 34, 48, 9, 12}; int[] tmp = new int[arr.length]; //æ–°å»ºä¸€ä¸ªä¸´æ—¶æ•°ç»„å­˜æ”¾ mergeSort(arr, 0, arr.length - 1, tmp); System.out.println(Arrays.toString(arr)); } private static void mergeSort(int[] arr, int low, int high, int[] tmp) { if (low &lt; high) { int mid = (low + high) / 2; mergeSort(arr, low, mid, tmp); mergeSort(arr, mid + 1, high, tmp); merge(arr, low, mid, high, tmp); } } private static void merge(int[] arr, int low, int mid, int high, int[] tmp) { int i = 0; int j = low, k = mid + 1; while (j &lt;= mid &amp;&amp; k &lt;= high) { if (arr[j] &lt; arr[k]) { tmp[i++] = arr[j++]; } else { tmp[i++] = arr[k++]; } } while (j &lt;= mid) { tmp[i++] = arr[j++]; } while (k &lt;= high) { tmp[i++] = arr[k++]; } for (int l = 0; l &lt; i; l++) { arr[low+l] = tmp[l]; } } } åŸºæ•°æ’åº ç®—æ³•æ€æƒ³ åŸºæ•°æ’åºï¼šé€šè¿‡åºåˆ—ä¸­å„ä¸ªå…ƒç´ çš„å€¼ï¼Œå¯¹æ’åºçš„Nä¸ªå…ƒç´ è¿›è¡Œè‹¥å¹²è¶Ÿçš„â€œåˆ†é…â€ä¸â€œæ”¶é›†â€æ¥å®ç°æ’åºã€‚ åˆ†é…ï¼šæˆ‘ä»¬å°†L[i]ä¸­çš„å…ƒç´ å–å‡ºï¼Œé¦–å…ˆç¡®å®šå…¶ä¸ªä½ä¸Šçš„æ•°å­—ï¼Œæ ¹æ®è¯¥æ•°å­—åˆ†é…åˆ°ä¸ä¹‹åºå·ç›¸åŒçš„æ¡¶ä¸­ æ”¶é›†ï¼šå½“åºåˆ—ä¸­æ‰€æœ‰çš„å…ƒç´ éƒ½åˆ†é…åˆ°å¯¹åº”çš„æ¡¶ä¸­ï¼Œå†æŒ‰ç…§é¡ºåºä¾æ¬¡å°†æ¡¶ä¸­çš„å…ƒç´ æ”¶é›†å½¢æˆæ–°çš„ä¸€ä¸ªå¾…æ’åºåˆ—L[ ] å¯¹æ–°å½¢æˆçš„åºåˆ—L[]é‡å¤æ‰§è¡Œåˆ†é…å’Œæ”¶é›†å…ƒç´ ä¸­çš„åä½ã€ç™¾ä½...ç›´åˆ°åˆ†é…å®Œè¯¥åºåˆ—ä¸­çš„æœ€é«˜ä½ï¼Œåˆ™æ’åºç»“æŸ ä»£ç å®ç° package sort; import java.util.Arrays; /** * @author wuhao * @desc åŸºæ•°æ’åº * @date 2020-12-03 09:58:32 * åŸºæ•°æ’åºï¼šé€šè¿‡åºåˆ—ä¸­å„ä¸ªå…ƒç´ çš„å€¼ï¼Œå¯¹æ’åºçš„Nä¸ªå…ƒç´ è¿›è¡Œè‹¥å¹²è¶Ÿçš„â€œåˆ†é…â€ä¸â€œæ”¶é›†â€æ¥å®ç°æ’åºã€‚ * åˆ†é…ï¼šæˆ‘ä»¬å°†L[i]ä¸­çš„å…ƒç´ å–å‡ºï¼Œé¦–å…ˆç¡®å®šå…¶ä¸ªä½ä¸Šçš„æ•°å­—ï¼Œæ ¹æ®è¯¥æ•°å­—åˆ†é…åˆ°ä¸ä¹‹åºå·ç›¸åŒçš„æ¡¶ä¸­ * æ”¶é›†ï¼šå½“åºåˆ—ä¸­æ‰€æœ‰çš„å…ƒç´ éƒ½åˆ†é…åˆ°å¯¹åº”çš„æ¡¶ä¸­ï¼Œå†æŒ‰ç…§é¡ºåºä¾æ¬¡å°†æ¡¶ä¸­çš„å…ƒç´ æ”¶é›†å½¢æˆæ–°çš„ä¸€ä¸ªå¾…æ’åºåˆ—L[ ] * å¯¹æ–°å½¢æˆçš„åºåˆ—L[]é‡å¤æ‰§è¡Œåˆ†é…å’Œæ”¶é›†å…ƒç´ ä¸­çš„åä½ã€ç™¾ä½...ç›´åˆ°åˆ†é…å®Œè¯¥åºåˆ—ä¸­çš„æœ€é«˜ä½ï¼Œåˆ™æ’åºç»“æŸ * æ ¹æ®ä¸Šè¿°â€œåŸºæ•°æ’åºâ€çš„å±•ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°æ•´ä¸ªå®ç°çš„è¿‡ç¨‹ */ public class BaseSort { public static void main(String[] args) { int[] arr = {63, 157, 189, 51, 101, 47, 141, 121, 157, 156, 194, 117, 98, 139, 67, 133, 181, 12, 28, 0, 109}; radixSort(arr); System.out.println(Arrays.toString(arr)); } private static void radixSort(int[] arr) { //å¾…æ’åºåˆ—æœ€å¤§å€¼ int max = arr[0]; int exp;//æŒ‡æ•° //è®¡ç®—æœ€å¤§å€¼ for (int anArr : arr) { if (anArr &gt; max) { max = anArr; } } //ä»ä¸ªä½å¼€å§‹ï¼Œå¯¹æ•°ç»„è¿›è¡Œæ’åº for (exp = 1; max / exp &gt; 0; exp *= 10) { //å­˜å‚¨å¾…æ’å…ƒç´ çš„ä¸´æ—¶æ•°ç»„ int[] temp = new int[arr.length]; //åˆ†æ¡¶ä¸ªæ•° int[] buckets = new int[10]; //å°†æ•°æ®å‡ºç°çš„æ¬¡æ•°å­˜å‚¨åœ¨bucketsä¸­ for (int value : arr) { //(value / exp) % 10 :valueçš„æœ€åº•ä½(ä¸ªä½) buckets[(value / exp) % 10]++; } //æ›´æ”¹buckets[i]ï¼Œ for (int i = 1; i &lt; 10; i++) { buckets[i] += buckets[i - 1]; } //å°†æ•°æ®å­˜å‚¨åˆ°ä¸´æ—¶æ•°ç»„tempä¸­ for (int i = arr.length - 1; i &gt;= 0; i--) { temp[buckets[(arr[i] / exp) % 10] - 1] = arr[i]; buckets[(arr[i] / exp) % 10]--; } //å°†æœ‰åºå…ƒç´ tempèµ‹ç»™arr System.arraycopy(temp, 0, arr, 0, arr.length); } } } åè®° å†™å®Œä¹‹åè¿è¡Œäº†ä¸€ä¸‹æ—¶é—´æ¯”è¾ƒï¼š ä»è¿è¡Œç»“æœä¸Šæ¥çœ‹ï¼Œå †æ’åºã€å½’å¹¶æ’åºã€åŸºæ•°æ’åºæ˜¯çœŸçš„å¿«ã€‚ å¯¹äºå¿«é€Ÿæ’åºè¿­ä»£æ·±åº¦è¶…è¿‡çš„é—®é¢˜ï¼Œå¯ä»¥å°†è€ƒè™‘å°†å¿«æ’é€šè¿‡éé€’å½’çš„æ–¹å¼è¿›è¡Œå®ç°ã€‚ ","link":"https://tianxiawuhao.github.io/0BBhLzjWl/"},{"title":"Linuxæ–‡ä»¶æ“ä½œé«˜é¢‘ä½¿ç”¨å‘½ä»¤","content":"æ–°å»ºæ“ä½œï¼š mkdir abc #æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ touch abc.sh #æ–°å»ºä¸€ä¸ªæ–‡ä»¶ æŸ¥çœ‹æ“ä½œ æŸ¥çœ‹ç›®å½•ï¼š ll #æ˜¾ç¤ºç›®å½•æ–‡ä»¶è¯¦ç»†ä¿¡æ¯ du -h æ–‡ä»¶/ç›®å½• #æŸ¥çœ‹å¤§å° pwd #æ˜¾ç¤ºè·¯å¾„ æŸ¥çœ‹æ–‡ä»¶å†…å®¹ï¼š cat|head|tailå‘½ä»¤ #æŸ¥çœ‹abcçš„å†…å®¹ cat abc.txt #æŸ¥çœ‹abcå‰5è¡Œå†…å®¹ã€‚é»˜è®¤æ˜¯10è¡Œ head -5 abc.txt tail [é€‰é¡¹] æ–‡ä»¶å å„é€‰é¡¹çš„å«ä¹‰å¦‚ä¸‹ï¼š +numï¼šä»ç¬¬numè¡Œä»¥åå¼€å§‹æ˜¾ç¤º -numï¼šä»è·æ–‡ä»¶å°¾numè¡Œå¤„å¼€å§‹æ˜¾ç¤ºã€‚å¦‚æœçœç•¥numå‚æ•°ï¼Œç³»ç»Ÿé»˜è®¤å€¼ä¸º10. -f: å¾ªç¯è¯»å–,ä¾‹å¦‚æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—æ—¶ï¼Œå¯ä»¥å®æ—¶è§‚å¯Ÿ #filename æ–‡ä»¶é‡Œçš„æœ€å°¾éƒ¨çš„å†…å®¹æ˜¾ç¤ºåœ¨å±å¹•ä¸Šï¼Œå¹¶ä¸”ä¸æ–­åˆ·æ–°ã€‚ tail -f filename #æŸ¥çœ‹æœ€å20è¡Œ tail -f filename moreå‘½ä»¤ï¼š moreå‘½ä»¤ä¸€æ¬¡æ˜¾ç¤ºä¸€å±ä¿¡æ¯ï¼Œè‹¥ä¿¡æ¯æœªæ˜¾ç¤ºå®Œå±å¹•åº•éƒ¨å°†å‡ºç°â€œ-More-ï¼ˆxx%ï¼‰â€ã€‚ æ­¤æ—¶æŒ‰Spaceé”®ï¼Œå¯æ˜¾ç¤ºä¸‹ä¸€å±å†…å®¹ï¼› æŒ‰â€œå›è½¦â€é”®ï¼Œæ˜¾ç¤ºä¸‹ä¸€è¡Œå†…å®¹ï¼› æŒ‰Bé”®ï¼Œæ˜¾ç¤ºä¸Šä¸€å±ï¼› æŒ‰Qé”®ï¼Œå¯é€€å‡ºmoreå‘½ä»¤ã€‚ lesså‘½ä»¤ï¼š å’Œmoreå‘½ä»¤ç±»ä¼¼ï¼Œä½†æ˜¯æ¯”moreå‘½ä»¤æ›´å¼ºå¤§ã€‚åœ¨å¾ˆå¤šæ—¶å€™ï¼Œå¿…é¡»ä½¿ç”¨less,æ¯”å¦‚ç®¡é“ã€‚ä¾‹å¦‚ï¼š ll /etc | less stat å‘½ä»¤ï¼š æŸ¥çœ‹æ–‡ä»¶çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ¯”å¦‚åˆ›å»ºä¿®æ”¹æ—¶é—´ï¼Œå¤§å°ç­‰ [root@localhost zx]# stat index.html æ–‡ä»¶ï¼š&quot;index.html&quot; å¤§å°ï¼š29006 å—ï¼š64 IO å—ï¼š4096 æ™®é€šæ–‡ä»¶ è®¾å¤‡ï¼šfd00h/64768d Inodeï¼š17589607 ç¡¬é“¾æ¥ï¼š1 æƒé™ï¼š(0644/-rw-r--r--) Uidï¼š( 0/ root) Gidï¼š( 0/ root) ç¯å¢ƒï¼šunconfined_u:object_r:home_root_t:s0 æœ€è¿‘è®¿é—®ï¼š2021-04-25 21:47:41.824053666 +0800 æœ€è¿‘æ›´æ”¹ï¼š2021-04-25 21:44:33.588587500 +0800 æœ€è¿‘æ”¹åŠ¨ï¼š2021-04-25 21:44:33.588587500 +0800 åˆ›å»ºæ—¶é—´ï¼š- du å‘½ä»¤ï¼š é€‰é¡¹ï¼š-h ä»¥åˆé€‚çš„å•ä½æ˜¾ç¤ºï¼ˆä¼šæ ¹æ®æ–‡ä»¶çš„å¤§å°è‡ªåŠ¨é€‰æ‹©kbæˆ–Mç­‰å•ä½ï¼‰ [root@localhost zx]# du -h index.html 32K index.html å¤åˆ¶æ“ä½œ åŒä¸€æœºå™¨çš„å¤åˆ¶ï¼š cp:å¤åˆ¶æ–‡ä»¶æˆ–ç›®å½• è¯­æ³•ï¼š cp [options] source dest -aï¼šæ­¤é€‰é¡¹é€šå¸¸åœ¨å¤åˆ¶ç›®å½•æ—¶ä½¿ç”¨ï¼Œå®ƒä¿ç•™é“¾æ¥ã€æ–‡ä»¶å±æ€§ï¼Œå¹¶å¤åˆ¶ç›®å½•ä¸‹çš„æ‰€æœ‰å†…å®¹ã€‚å…¶ä½œç”¨ç­‰äºdpRå‚æ•°ç»„åˆã€‚ -dï¼šå¤åˆ¶æ—¶ä¿ç•™é“¾æ¥ã€‚è¿™é‡Œæ‰€è¯´çš„é“¾æ¥ç›¸å½“äºWindowsç³»ç»Ÿä¸­çš„å¿«æ·æ–¹å¼ã€‚ -fï¼šè¦†ç›–å·²ç»å­˜åœ¨çš„ç›®æ ‡æ–‡ä»¶è€Œä¸ç»™å‡ºæç¤ºã€‚ -iï¼šä¸-fé€‰é¡¹ç›¸åï¼Œåœ¨è¦†ç›–ç›®æ ‡æ–‡ä»¶ä¹‹å‰ç»™å‡ºæç¤ºï¼Œè¦æ±‚ç”¨æˆ·ç¡®è®¤æ˜¯å¦è¦†ç›–ï¼Œå›ç­”&quot;y&quot;æ—¶ç›®æ ‡æ–‡ä»¶å°†è¢«è¦†ç›–ã€‚ -pï¼šé™¤å¤åˆ¶æ–‡ä»¶çš„å†…å®¹å¤–ï¼Œè¿˜æŠŠä¿®æ”¹æ—¶é—´å’Œè®¿é—®æƒé™ä¹Ÿå¤åˆ¶åˆ°æ–°æ–‡ä»¶ä¸­ã€‚ -rï¼šè‹¥ç»™å‡ºçš„æºæ–‡ä»¶æ˜¯ä¸€ä¸ªç›®å½•æ–‡ä»¶ï¼Œæ­¤æ—¶å°†å¤åˆ¶è¯¥ç›®å½•ä¸‹æ‰€æœ‰çš„å­ç›®å½•å’Œæ–‡ä»¶ã€‚ -lï¼šä¸å¤åˆ¶æ–‡ä»¶ï¼Œåªæ˜¯ç”Ÿæˆé“¾æ¥æ–‡ä»¶ã€‚ ä¸¾ä¾‹ï¼š #å°†../html/index.html å¤åˆ¶åˆ°å½“å‰ç›®å½• cp ../html/index.html . #å°†../html/ ç›®å½•ä¸‹çš„æ–‡ä»¶åŠå­ç›®å½•å¤åˆ¶åˆ°å½“å‰çš„ttç›®å½•ä¸‹ï¼Œå¦‚æœttä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»º cp -r ../html/ tt/ #å°†æ–‡ä»¶fileå¤åˆ¶åˆ°ç›®å½•/usr/men/tmpä¸‹ï¼Œå¹¶æ”¹åä¸ºfile1 cp file /usr/men/tmp/file1 #å¦‚æœdir2ç›®å½•å·²å­˜åœ¨ï¼Œåˆ™éœ€è¦ä½¿ç”¨ cp -r dir1/. dir2 #å¦‚æœè¿™æ—¶ä½¿ç”¨cp -r dir1 dir2,åˆ™ä¹Ÿä¼šå°†dir1ç›®å½•å¤åˆ¶åˆ°dir2ä¸­ï¼Œæ˜æ˜¾ä¸ç¬¦åˆè¦æ±‚ã€‚ ps:dir1ã€dir2æ”¹æˆå¯¹åº”çš„ç›®å½•è·¯å¾„å³å¯ è¿œç¨‹å¤åˆ¶ #å°†å½“å‰ç›®å½•ä¸‹çš„test.txtå¤åˆ¶åˆ°è¿œç¨‹111.12æœºå™¨çš„/zxç›®å½•ä¸‹ scp test.txt root@192.168.111.12:/zx #å°†test.txtå¤åˆ¶åˆ°è¿œç¨‹ç”¨æˆ·çš„æ ¹ç›®å½•ï¼Œå¹¶å‘½åä¸ºtextA.txt scp test.txt root@192.168.111.12:testA.txt #ä¹Ÿå¯ä»¥ä¸æŒ‡å®šç”¨æˆ·ï¼Œåœ¨åç»­æç¤ºä¸­å†è¾“å…¥ï¼Œå¦‚ä¸‹ï¼š scp test.txt 192.168.111.12:/zx #ä»è¿œç¨‹å¤åˆ¶åˆ°æœ¬åœ°ï¼š -rç”¨äºé€’å½’æ•´ä¸ªç›®å½• scp -r remote_user@remote_ip:remote_folder local_path ç§»åŠ¨æ“ä½œ: ç§»åŠ¨æ“ä½œå¯ä»¥ç†è§£æˆå¤åˆ¶æ–‡ä»¶åï¼Œåˆ é™¤åŸæ–‡ä»¶ã€‚ #å¤åˆ¶/zx/softç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶åˆ°å½“å‰ç›®å½• mv /zx/soft/* . #å¤åˆ¶å½“å‰ç›®å½•a.txtåˆ°å½“å‰çš„testç›®å½•ä¸‹ã€‚ mv a.txt ./test/a.txt #å¤åˆ¶æ–‡ä»¶å¤¹åˆ°/tmp/ä¸‹ï¼Œå¿…é¡»ä¿è¯tmpæ˜¯å­˜åœ¨çš„æ–‡ä»¶å¤¹ mv /zx/soft/ /tmp/soft é‡å‘½åæ“ä½œ é‡å‘½åè¿˜æ˜¯ç”¨çš„ç§»åŠ¨æ“ä½œå‘½ä»¤ï¼Œæ¯”å¦‚ï¼š #å°†ç›®å½•(æ–‡ä»¶)Aé‡å‘½åä¸ºB mv A B #å°†/aç›®å½•(æ–‡ä»¶)ç§»åŠ¨åˆ°/bä¸‹ï¼Œå¹¶é‡å‘½åä¸ºcã€‚è¦ä¿è¯bç›®å½•å­˜åœ¨ã€‚ mv /a /b/c #å°†å½“å‰test1ç›®å½•ç§»åŠ¨åˆ°å½“å‰çš„testç›®å½•å¹¶å‘½åä¸ºb mv ./test1 ./test/b è§£å‹å‹ç¼©æ“ä½œ tar -c: å»ºç«‹å‹ç¼©æ¡£æ¡ˆ -xï¼šè§£å‹ -tï¼šæŸ¥çœ‹å†…å®¹ -rï¼šå‘å‹ç¼©å½’æ¡£æ–‡ä»¶æœ«å°¾è¿½åŠ æ–‡ä»¶ -uï¼šæ›´æ–°åŸå‹ç¼©åŒ…ä¸­çš„æ–‡ä»¶ è¿™äº”ä¸ªæ˜¯ç‹¬ç«‹çš„å‘½ä»¤ï¼Œå‹ç¼©è§£å‹éƒ½è¦ç”¨åˆ°å…¶ä¸­ä¸€ä¸ªï¼Œå¯ä»¥å’Œåˆ«çš„å‘½ä»¤è¿ç”¨ä½†åªèƒ½ç”¨å…¶ä¸­ä¸€ä¸ªã€‚ä¸‹é¢çš„å‚æ•°æ˜¯æ ¹æ®éœ€è¦åœ¨å‹ç¼©æˆ–è§£å‹æ¡£æ¡ˆæ—¶å¯é€‰çš„ã€‚ -zï¼šæœ‰gzipå±æ€§çš„ -jï¼šæœ‰bz2å±æ€§çš„ -Zï¼šæœ‰compresså±æ€§çš„ -vï¼šæ˜¾ç¤ºæ‰€æœ‰è¿‡ç¨‹ -Oï¼šå°†æ–‡ä»¶è§£å¼€åˆ°æ ‡å‡†è¾“å‡º ä¸‹é¢çš„å‚æ•°-fæ˜¯å¿…é¡»çš„ -f: ä½¿ç”¨æ¡£æ¡ˆåå­—ï¼Œåˆ‡è®°ï¼Œè¿™ä¸ªå‚æ•°æ˜¯æœ€åä¸€ä¸ªå‚æ•°ï¼Œåé¢åªèƒ½æ¥æ¡£æ¡ˆåã€‚ ä¸¾ä¾‹è¯´æ˜ tar -cf all.tar *.jpg è¿™æ¡å‘½ä»¤æ˜¯å°†æ‰€æœ‰.jpgçš„æ–‡ä»¶æ‰“æˆä¸€ä¸ªåä¸ºall.tarçš„åŒ…ã€‚-cæ˜¯è¡¨ç¤ºäº§ç”Ÿæ–°çš„åŒ…ï¼Œ-fæŒ‡å®šåŒ…çš„æ–‡ä»¶åã€‚ tar -tf all.tar è¿™æ¡å‘½ä»¤æ˜¯åˆ—å‡ºall.taråŒ…ä¸­æ‰€æœ‰æ–‡ä»¶ï¼Œ-tæ˜¯åˆ—å‡ºæ–‡ä»¶çš„æ„æ€ tar -xf all.tar è¿™æ¡å‘½ä»¤æ˜¯è§£å‡ºall.taråŒ…ä¸­æ‰€æœ‰æ–‡ä»¶ï¼Œ-xæ˜¯è§£å¼€çš„æ„æ€ å‹ç¼© tar â€“cvf jpg.tar *.jpg //å°†ç›®å½•é‡Œæ‰€æœ‰jpgæ–‡ä»¶æ‰“åŒ…æˆjpg.tar eg2: tar -xzf nginx-1.14.0.tar.gz //è§£å‹åˆ°å½“å‰ç›®å½• tar -zxf nginx-1.14.0.tar.gz -C /usr/local/nginx #è§£å‹åˆ°å¯¹åº”ç›®å½• eg3: tar -zxvf nginx...tar.gz #è§£å‹å¹¶æ˜¾ç¤ºè¿‡ç¨‹ æ³¨æ„ï¼šæœ‰äº›å‹ç¼©ç¨‹åºæç¤ºå‘½ä»¤æ‰¾ä¸åˆ°ï¼Œéœ€è¦è¿›è¡Œå®‰è£…ï¼Œä¾‹å¦‚ï¼š yum install unzip æˆ–åœ¨ubuntuä¸Šï¼š apt-get install unzip æ€»ç»“ 1ã€*.tar ç”¨ tar â€“xvf è§£å‹ 2ã€*.gz ç”¨ gzip -dæˆ–è€…gunzip è§£å‹ 3ã€*.tar.gzå’Œ*.tgz ç”¨ tar â€“xzf è§£å‹ 4ã€*.bz2 ç”¨ bzip2 -dæˆ–è€…ç”¨bunzip2 è§£å‹ 5ã€*.tar.bz2ç”¨tar â€“xjf è§£å‹ 6ã€*.Z ç”¨ uncompress è§£å‹ 7ã€*.tar.Z ç”¨tar â€“xZf è§£å‹ 8ã€*.rar ç”¨ unrar eè§£å‹ 9ã€*.zip ç”¨ unzip è§£å‹ è§£å‹çš„æ—¶å€™ï¼Œæœ‰æ—¶å€™ä¸æƒ³è¦†ç›–å·²ç»å­˜åœ¨çš„æ–‡ä»¶ï¼Œé‚£ä¹ˆå¯ä»¥åŠ ä¸Š-nå‚æ•° unzip -n test.zip unzip -n -d /temp test.zip åªçœ‹ä¸€ä¸‹zipå‹ç¼©åŒ…ä¸­åŒ…å«å“ªäº›æ–‡ä»¶ï¼Œä¸è¿›è¡Œè§£å‹ç¼© unzip -l test.zip æŸ¥çœ‹æ˜¾ç¤ºçš„æ–‡ä»¶åˆ—è¡¨è¿˜åŒ…å«å‹ç¼©æ¯”ç‡ unzip -v test.zip æ£€æŸ¥zipæ–‡ä»¶æ˜¯å¦æŸå unzip -t test.zip å¦‚æœå·²æœ‰ç›¸åŒçš„æ–‡ä»¶å­˜åœ¨ï¼Œè¦æ±‚unzipå‘½ä»¤è¦†ç›–åŸå…ˆçš„æ–‡ä»¶ unzip -o test.zip -d /tmp/ ç¤ºä¾‹ï¼š eg1: unzip mydata.zip -d mydatabak #è§£å‹åˆ°mydatabakç›®å½• 1. xz è¿™æ˜¯ä¸¤å±‚å‹ç¼©ï¼Œå¤–é¢æ˜¯xzå‹ç¼©æ–¹å¼ï¼Œé‡Œå±‚æ˜¯tarå‹ç¼©,æ‰€ä»¥å¯ä»¥åˆ†ä¸¤æ­¥å®ç°è§£å‹ $ xz -d node-v6.10.1-linux-x64.tar.xz $ tar -xvf node-v6.10.1-linux-x64.tar ä¸Šä¼ æ–‡ä»¶å·¥å…· ä»æœ¬åœ°windowsä¸Šä¼ ä¸€äº›æ–‡ä»¶åˆ°è¿œç¨‹LinuxæœåŠ¡å™¨å¯ä»¥é€šè¿‡xshellçš„xftpä¹Ÿå¯ä»¥é€šè¿‡ä¸‹é¢è¿™ä¸ªå°å·¥å…·lrzszï¼Œä½¿ç”¨æ›´åŠ æ–¹ä¾¿ã€‚ #å®‰è£…å·¥å…· yum install lrzsz å¸¸ç”¨å‘½ä»¤ï¼š #ä¸‹è½½æ–‡ä»¶dist.zipåˆ°æœ¬åœ° sz dist.zip #ä¼šæ‰“å¼€çª—å£ï¼Œä¸Šä¼ æ–‡ä»¶åˆ°è¿œç¨‹æœåŠ¡å™¨ rz lnã€fileå’Œtouchå‘½ä»¤ lnå‘½ä»¤ ç”¨äºåˆ›å»ºé“¾æ¥æ–‡ä»¶ï¼ŒåŒ…æ‹¬ç¡¬é“¾æ¥(Hard Link)å’Œç¬¦å·é“¾æ¥ï¼ˆSymbolic Link) ã€‚æˆ‘ä»¬å¸¸ç”¨çš„æ˜¯ç¬¦å·é“¾æ¥ï¼Œä¹Ÿç§°è½¯è¿æ¥ã€‚è½¯è¿æ¥å°±ç±»ä¼¼windowsé‡Œçš„å¿«æ·æ–¹å¼ã€‚ ç¤ºä¾‹ï¼š #åœ¨å½“å‰ç›®å½•åˆ›å»ºä¸€ä¸ªè½¯è¿æ¥ï¼ŒæŒ‡å‘/etc/fastabï¼Œåç§°ä¹Ÿæ˜¯fastab ln -s /etc/fastab #åœ¨å½“å‰ç›®å½•åˆ›å»ºä¸€ä¸ªæŒ‡å‘/boot/grubçš„è½¯è¿æ¥ï¼Œå‘½åä¸ºgb ln -s /boot/grub gb æ³¨æ„ï¼šåˆ é™¤è½¯è¿æ¥ æ­£ç¡®æ–¹å¼æ˜¯ï¼š rm -rf ./gb é”™è¯¯æ–¹å¼: rm -rf ./gb/ è¿™æ ·ä¼šåˆ é™¤äº†åŸæœ‰grubä¸‹çš„å†…å®¹ã€‚ç‰¹åˆ«æ˜¯é’ˆå¯¹ç³»ç»Ÿæ–‡ä»¶çš„è½¯è¿æ¥ï¼Œåˆ é™¤ä¸€å®šè¦æ…é‡ã€‚ fileå‘½ä»¤ ç”¨äºè¯†åˆ«æ–‡ä»¶çš„ç±»å‹ Linuxä¸­æ–‡ä»¶åç¼€åªæ˜¯æ–¹ä¾¿ä½¿ç”¨è€…è¯†åˆ«ï¼Œæ²¡æœ‰å®è´¨çš„çº¦æŸä½œç”¨ã€‚fileå‘½ä»¤å¯ä»¥æŸ¥çœ‹æ–‡ä»¶çš„å®è´¨ç±»å‹ï¼š file [-bcLz] æ–‡ä»¶|ç›®å½• é€‰é¡¹è¯´æ˜ï¼š æ–‡ä»¶|ç›®å½•ï¼šéœ€è¦è¯†åˆ«çš„æ–‡ä»¶æˆ–ç›®å½• -b: æ˜¾ç¤ºè¯†åˆ«ç»“æœæ—¶ï¼Œä¸æ˜¾ç¤ºæ–‡ä»¶å -c: æ˜¾ç¤ºæ‰§è¡Œè¿‡ç¨‹ -L: ç›´æ¥æ˜¾ç¤ºç¬¦å·é“¾æ¥æ–‡ä»¶æŒ‡å‘çš„æ–‡ä»¶ç±»å‹ -z: å°è¯•å»è§£è¯»å‹ç¼©æ–‡ä»¶çš„å†…å®¹ ç¤ºä¾‹ï¼š å¯ä»¥çœ‹å‡ºï¼Œindex.mp4æœ¬è´¨æ˜¯ä¸€ä¸ªHTMLè€Œéä¸€ä¸ªmp4æ–‡ä»¶ [root@VM_0_13_centos soft]# file index.mp4 index.mp4: HTML document, UTF-8 Unicode text, with very long lines**touchå‘½ä»¤ï¼š** ç”¨äºæ”¹å˜æ–‡ä»¶æˆ–ç›®å½•çš„è®¿é—®æ—¶é—´å’Œä¿®æ”¹æ—¶é—´ã€‚ touchå‘½ä»¤ï¼š ç”¨äºæ”¹å˜æ–‡ä»¶æˆ–ç›®å½•çš„è®¿é—®æ—¶é—´å’Œä¿®æ”¹æ—¶é—´ã€‚ touch [-am] [-t&lt;æ—¥æœŸæ—¶é—´&gt;] [ç›®å½•|æ–‡ä»¶] å¦‚æœæŒ‡å®šç›®å½•æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä¼šç›´æ¥åˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶ï¼Œæ‰€ä»¥touchä¹Ÿå¸¸ç”¨æ¥åˆ›å»ºä¸€ä¸ªç©ºç™½æ–‡ä»¶ #åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶aa.txt touch aa.txt é€‰é¡¹è¯´æ˜ï¼š -a: åªä¿®æ”¹è®¿é—®æ—¶é—´ -m : åªä¿®æ”¹ ä¿®æ”¹æ—¶é—´ -t : ä½¿ç”¨æŒ‡å®šæ—¥æœŸæ—¶é—´ï¼Œè€Œéç³»ç»Ÿæ—¶é—´ ã€‚ä¾‹å¦‚è¦ä¿®æ”¹ä¸º2019å¹´10æœˆ20æ—¥16ï¼š38åˆ†13ç§’ã€‚å‚æ•°å°±æ˜¯ï¼šâ€˜20191020163813â€™ ç¤ºä¾‹ï¼š ä¿®æ”¹ä¹‹å‰å¯ä»¥å…ˆæŸ¥çœ‹æ–‡ä»¶çš„æ—¶é—´æˆ³: ç”¨stat å‘½ä»¤æŸ¥çœ‹ [root@VM_0_13_centos soft]# stat index.html File: â€˜index.htmlâ€™ Size: 17215 Blocks: 40 IO Block: 4096 regular file Device: fd01h/64769d Inode: 529352 Links: 1 Access: (0644/-rw-r--r--) Uid: ( 0/ root) Gid: ( 0/ root) Access: 2021-04-25 15:15:37.280616254 +0800 Modify: 2021-04-25 15:15:37.280616254 +0800 Change: 2021-04-25 15:15:37.290616257 +0800 Birth: - å¼€å§‹ä¿®æ”¹ï¼šå°†index.htmlæ–‡ä»¶çš„è®¿é—®å’Œä¿®æ”¹æ—¶é—´ä¿®æ”¹æˆå½“å‰ç³»ç»Ÿçš„æ—¶é—´ã€‚ touch index.html æŸ¥æ‰¾æ“ä½œå‘½ä»¤ï¼š å¯¹äºè¦ç”¨åˆ°çš„æ–‡ä»¶ï¼Œç›®å½•ç­‰ï¼Œç»å¸¸æœ‰å¿˜è®°çš„æ—¶å€™ï¼Œæ‰€ä»¥æŸ¥æ‰¾å‘½ä»¤å°±æ˜¾å¾—æä¸ºå¿…è¦ï¼š find: æŸ¥æ‰¾æ–‡ä»¶æˆ–ç›®å½• (å¸¸ç”¨) è¯­æ³•å¦‚ä¸‹ï¼š find [ç›®å½•â€¦] [-amin &lt;åˆ†é’Ÿ&gt;] [-atime &lt;24å°æ—¶æ•°&gt;] [-cmin &lt;åˆ†é’Ÿ&gt;] [-ctime&lt;24å°æ—¶æ•°&gt;][-empty][-exec&lt;æ‰§è¡Œå‘½ä»¤&gt;][-fls&lt;åˆ—è¡¨æ–‡ä»¶&gt;][-follow] [-fstype &lt;ç³»ç»Ÿæ–‡ä»¶ç±»å‹&gt;] [-gid &lt;ç»„ç¼–å·&gt;] [-group &lt;ç»„åç§°&gt;] [-nogroup] [-mmin &lt;åˆ†é’Ÿ&gt;] [-mtime &lt;24å°æ—¶æ•°&gt;] [-name &lt;æŸ¥æ‰¾å†…å®¹&gt;] [-nogroup] [-nouser] [-perm &lt;æƒé™æ•°å€¼&gt;] [-size &lt;æ–‡ä»¶å¤§å°&gt;] [-uid &lt;ç”¨æˆ·ç¼–å·&gt;] [-user &lt;ç”¨æˆ·åç§°&gt;] [-nouser] å‡ ä¸ªå¸¸ç”¨é€‰é¡¹è¯´æ˜ï¼š -size &lt;æ–‡ä»¶å¤§å°&gt;ï¼šæŸ¥æ‰¾ç¬¦åˆæŒ‡å®šå¤§å°çš„æ–‡ä»¶ã€‚æ–‡ä»¶å¤§å°å•ä½å¯ä»¥æ˜¯â€œcâ€è¡¨ç¤ºByteï¼›â€œkâ€è¡¨ç¤ºKBã€‚å¦‚é…ç½®ä¸ºâ€œ100kâ€ï¼Œfindå‘½ä»¤ä¼šæŸ¥æ‰¾æ–‡ä»¶å¤§å°æ­£å¥½100KBçš„æ–‡ä»¶ï¼›é…ç½®ä¸ºâ€œ+100kâ€ï¼Œfindå‘½ä»¤ä¼šæŸ¥æ‰¾æ–‡ä»¶å¤§å°å¤§äº100KBçš„æ–‡ä»¶ï¼›é…ç½®ä¸ºâ€œ-100kâ€ï¼Œfindå‘½ä»¤ä¼šæŸ¥æ‰¾æ–‡ä»¶å¤§å°å°äº100KBçš„æ–‡ä»¶ã€‚ -user&lt;ç”¨æˆ·åç§°&gt;ï¼šæŸ¥æ‰¾æ‰€æœ‰è€…æ˜¯æŒ‡å®šç”¨æˆ·çš„æ–‡ä»¶æˆ–ç›®å½•ï¼Œä¹Ÿèƒ½ä»¥ç”¨æˆ·ç¼–å·æŒ‡å®š -name &lt;æŸ¥æ‰¾å†…å®¹&gt;ï¼šæŸ¥æ‰¾æŒ‡å®šçš„å†…å®¹ï¼Œåœ¨æŸ¥æ‰¾å†…å®¹ä¸­ä½¿ç”¨â€œ*â€ è¡¨ç¤ºä»»æ„ä¸ªå­—ç¬¦ï¼›ä½¿ç”¨â€œ?â€è¡¨ç¤ºä»»ä½•ä¸€ä¸ªå­—ç¬¦ -mtime &lt;24å°æ—¶æ•°&gt;ï¼šæŸ¥æ‰¾åœ¨æŒ‡å®šæ—¶é—´**æ›¾æ›´æ”¹è¿‡å†…å®¹**çš„æ–‡ä»¶æˆ–ç›®å½•ï¼Œå•ä½ä»¥24å°æ—¶è®¡ç®—ã€‚å¦‚é…ç½®ä¸º2ï¼Œfindå‘½ä»¤ä¼šæŸ¥æ‰¾åˆšå¥½åœ¨48å°æ—¶ä¹‹å‰æ›´æ”¹è¿‡å†…å®¹çš„æ–‡ä»¶ï¼›é…ç½®ä¸º+2ï¼Œfindå‘½ä»¤ä¼šæŸ¥æ‰¾è¶…è¿‡åœ¨48å°æ—¶ä¹‹å‰æ›´æ”¹è¿‡å†…å®¹çš„æ–‡ä»¶ï¼›é…ç½®ä¸º-2ï¼Œfindå‘½ä»¤ä¼šæŸ¥æ‰¾åœ¨48å°æ—¶ä¹‹å†…æ›´æ”¹è¿‡å†…å®¹çš„æ–‡ä»¶ã€‚ -mmin &lt;åˆ†é’Ÿ&gt;ï¼šæŸ¥æ‰¾åœ¨æŒ‡å®šæ—¶é—´æ›¾è¢«**æ›´æ”¹è¿‡å†…å®¹**çš„æ–‡ä»¶æˆ–ç›®å½•ï¼Œå•ä½ä»¥åˆ†é’Ÿè®¡ç®—ã€‚ -cmin &lt;åˆ†é’Ÿ&gt;ï¼šæŸ¥æ‰¾åœ¨æŒ‡å®šæ—¶é—´æ›¾è¢«**æ›´æ”¹è¿‡æƒé™**å±æ€§çš„æ–‡ä»¶æˆ–ç›®å½•ï¼Œå•ä½ä»¥åˆ†é’Ÿè®¡ç®—ã€‚-ctimeå¯¹åº”å°æ—¶ã€‚ -amin &lt;åˆ†é’Ÿ&gt;ï¼šæŸ¥æ‰¾çš„æ˜¯æŒ‡å®šæ—¶é—´**è®¿é—®è¿‡**çš„æ–‡ä»¶æˆ–ç›®å½•ã€‚-atimå¯¹åº”å°æ—¶ã€‚ -perm &lt;æƒé™æ•°å€¼&gt;ï¼šæŸ¥æ‰¾ç¬¦åˆæŒ‡å®šæƒé™æ•°å€¼ï¼ˆæœ‰å…³æƒé™æ•°å€¼è§ç¬¬6ç« ï¼‰çš„æ–‡ä»¶æˆ–ç›®å½•ã€‚å¦‚é…ç½®ä¸ºâ€œ0700â€ï¼Œfindå‘½ä»¤ä¼šæŸ¥æ‰¾æƒé™æ•°å€¼æ­£å¥½æ˜¯â€œ0700â€çš„æ–‡ä»¶æˆ–ç›®å½•ï¼›é…ç½®ä¸ºâ€œ+0700â€ï¼Œfindå‘½ä»¤ä¼šæŸ¥æ‰¾æƒé™æ•°å€¼å¤§äº â€œ0700â€çš„æ–‡ä»¶æˆ–ç›®å½•ï¼›é…ç½®ä¸ºâ€œ-0700â€ï¼Œfind é€‰é¡¹å¤§æ¦‚æœ‰ä»¥ä¸‹å‡ ç±»ï¼š 1.æŒ‰æ—¶é—´èŒƒå›´æŸ¥æ‰¾ 2.æŒ‰æ–‡ä»¶å¤§å°æŸ¥æ‰¾ 3.æŒ‰æ–‡ä»¶åç§°æŸ¥æ‰¾ 4.æŒ‰å…¶ä»–ï¼šæ¯”å¦‚æƒé™ã€ç”¨æˆ·ç»„ã€ç±»å‹ç­‰ ç¤ºä¾‹ï¼š #ä»æ ¹ç›®å¼€å§‹ï¼ŒæŸ¥æ‰¾åç§°ä»¥nginxå¼€å¤´çš„ç›®å½•å’Œæ–‡ä»¶ find / -name nginx* #æŸ¥æ‰¾æ–‡ä»¶å¤§å°è¶…è¿‡100Mçš„æ–‡ä»¶ find / -size +100M #æŸ¥æ‰¾/home/zxç›®å½•ä¸‹ï¼Œ10åˆ†é’Ÿå†…è¢«ä¿®æ”¹è¿‡çš„æ–‡ä»¶å’Œç›®å½• find /home/zx/ -mmin -10 locateï¼š æŸ¥æ‰¾æ–‡ä»¶æˆ–ç›®å½•(ä¸å¸¸ç”¨) locate æŸ¥æ‰¾å†…å®¹ ä¾‹å¦‚ï¼šlocate nginx ä¼šå°†æ‰€æœ‰åŒ…å«nginxçš„ç›®å½•å’Œæ–‡ä»¶éƒ½åˆ—å‡ºæ¥ã€‚å¯ä»¥ç”¨* æˆ–ï¼Ÿç­‰åŒ¹é…ç¬¦ã€‚ locateçš„æŸ¥æ‰¾é€Ÿåº¦éå¸¸å¿«ï¼Œå› ä¸ºè¯¥å‘½ä»¤æŸ¥æ‰¾çš„æ˜¯æ•°æ®åº“ï¼Œæ‰€ä»¥æœ‰äº›åˆšä¿®æ”¹çš„æ–‡ä»¶å’Œç›®å½•ï¼Œå¯èƒ½æ— æ³•æ‰¾åˆ°ã€‚å¯ä»¥é‡‡ç”¨ï¼šupdatedb å‘½ä»¤æ›´æ–°æ•°æ®åº“ã€‚ which: æŸ¥æ‰¾æ–‡ä»¶(ä¸å¸¸ç”¨) which [æ–‡ä»¶] whichå‘½ä»¤åªä¼šåœ¨PATHç¯å¢ƒå˜é‡å®šä¹‰çš„è·¯å¾„åŠå‘½ä»¤åˆ«åä¸­æŸ¥æ‰¾ï¼Œæ‰€ä»¥èŒƒå›´æœ‰é™ã€‚ whereis : æŸ¥æ‰¾æ–‡ä»¶(ä¸å¸¸ç”¨) whichis [-bu] [-B&lt;ç›®å½•&gt;] [-M&lt;ç›®å½•&gt;] [-S&lt;ç›®å½•&gt;] [æ–‡ä»¶] å¸¸ç”¨é€‰é¡¹ï¼š æ–‡ä»¶ï¼šè¦æŸ¥æ‰¾çš„å‘½ä»¤ -b: åªæŸ¥æ‰¾äºŒè¿›åˆ¶æ–‡ä»¶ -u: æŸ¥æ‰¾ä¸åŒ…å«æŒ‡å®šç±»å‹çš„æ–‡ä»¶ -B&lt;ç›®å½•&gt;ï¼š åªåœ¨æŒ‡å®šç›®å½•ä¸‹æŸ¥æ‰¾äºŒè¿›åˆ¶æ–‡ä»¶ -M&lt;ç›®å½•&gt;ï¼šåªåœ¨æŒ‡å®šç›®å½•æŸ¥æ‰¾å¸®åŠ©æ–‡ä»¶ -S&lt;ç›®å½•&gt;ï¼šåªåœ¨æŒ‡å®šç›®å½•æŸ¥æ‰¾æºç ç›®å½• ä¾‹å¦‚ï¼š é»˜è®¤åªä¼šåœ¨æŒ‡å®šç›®å½•æŸ¥æ‰¾ï¼ˆ/bin ,/etc ,/usr) [root@VM_0_13_centos soft]# whereis nginx nginx: /usr/local/nginx /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.bak ","link":"https://tianxiawuhao.github.io/yzriNkrRn/"},{"title":"JVMè°ƒä¼˜","content":"å †å¤§å°è®¾ç½® â€‹ JVM ä¸­æœ€å¤§å †å¤§å°æœ‰ä¸‰æ–¹é¢é™åˆ¶ï¼šç›¸å…³æ“ä½œç³»ç»Ÿçš„æ•°æ®æ¨¡å‹ï¼ˆ32-btè¿˜æ˜¯64-bitï¼‰é™åˆ¶ï¼›ç³»ç»Ÿçš„å¯ç”¨è™šæ‹Ÿå†…å­˜é™åˆ¶ï¼›ç³»ç»Ÿçš„å¯ç”¨ç‰©ç†å†…å­˜é™åˆ¶ã€‚32ä½ç³»ç»Ÿä¸‹ï¼Œä¸€èˆ¬é™åˆ¶åœ¨1.5G~2Gï¼›64ä¸ºæ“ä½œç³»ç»Ÿå¯¹å†…å­˜æ— é™åˆ¶ã€‚æˆ‘åœ¨Windows Server 2003 ç³»ç»Ÿï¼Œ3.5Gç‰©ç†å†…å­˜ï¼ŒJDK5.0ä¸‹æµ‹è¯•ï¼Œæœ€å¤§å¯è®¾ç½®ä¸º1478mã€‚ å…¸å‹è®¾ç½®ï¼š java -Xmx3550m -Xms3550m -Xmn2g -Xss128k // -Xmx3550mï¼šè®¾ç½®JVMæœ€å¤§å †å¯ç”¨å†…å­˜ä¸º3550Mã€‚ // -Xms3550mï¼šè®¾ç½®JVMåˆå§‹å †å†…å­˜ä¸º3550mã€‚æ­¤å€¼å¯ä»¥è®¾ç½®ä¸-Xmxç›¸åŒï¼Œä»¥é¿å…æ¯æ¬¡åƒåœ¾å›æ”¶å®ŒæˆåJVMé‡æ–°åˆ†é…å†…å­˜ã€‚ // -Xmn2gï¼šè®¾ç½®å¹´è½»ä»£å¤§å°ä¸º2Gã€‚æ•´ä¸ªJVMå†…å­˜å¤§å°=å¹´è½»ä»£å¤§å° + å¹´è€ä»£å¤§å° + æŒä¹…ä»£å¤§å°ã€‚æŒä¹…ä»£ä¸€èˆ¬å›ºå®šå¤§å°ä¸º64mï¼Œæ‰€ä»¥å¢å¤§å¹´è½»ä»£åï¼Œå°†ä¼šå‡å°å¹´è€ä»£å¤§å°ã€‚æ­¤å€¼å¯¹ç³»ç»Ÿæ€§èƒ½å½±å“è¾ƒå¤§ï¼ŒSunå®˜æ–¹æ¨èé…ç½®ä¸ºæ•´ä¸ªå †çš„3/8ã€‚ // -Xss128kï¼šè®¾ç½®æ¯ä¸ªçº¿ç¨‹çš„å †æ ˆå¤§å°ã€‚JDK5.0ä»¥åæ¯ä¸ªçº¿ç¨‹å †æ ˆå¤§å°ä¸º1Mï¼Œä»¥å‰æ¯ä¸ªçº¿ç¨‹å †æ ˆå¤§å°ä¸º256Kã€‚æ ¹æ®åº”ç”¨çš„çº¿ç¨‹æ‰€éœ€å†…å­˜å¤§å°è¿›è¡Œè°ƒæ•´ã€‚åœ¨ç›¸åŒç‰©ç†å†…å­˜ä¸‹ï¼Œå‡å°è¿™ä¸ªå€¼èƒ½ç”Ÿæˆæ›´å¤šçš„çº¿ç¨‹ã€‚ä½†æ˜¯æ“ä½œç³»ç»Ÿå¯¹ä¸€ä¸ªè¿›ç¨‹å†…çš„çº¿ç¨‹æ•°è¿˜æ˜¯æœ‰é™åˆ¶çš„ï¼Œä¸èƒ½æ— é™ç”Ÿæˆï¼Œç»éªŒå€¼åœ¨3000~5000å·¦å³ã€‚ java -Xmx3550m -Xms3550m -Xss128k -XX:NewRatio=4 -XX:SurvivorRatio=4 -XX:MaxPermSize=16m -XX:MaxTenuringThreshold=0 // -XX:NewRatio=4:è®¾ç½®å¹´è½»ä»£ï¼ˆåŒ…æ‹¬Edenå’Œä¸¤ä¸ªSurvivoråŒºï¼‰ä¸å¹´è€ä»£çš„æ¯”å€¼ï¼ˆé™¤å»æŒä¹…ä»£ï¼‰ã€‚è®¾ç½®ä¸º4ï¼Œåˆ™å¹´è½»ä»£ä¸å¹´è€ä»£æ‰€å æ¯”å€¼ä¸º1ï¼š4ï¼Œå¹´è½»ä»£å æ•´ä¸ªå †æ ˆçš„1/5 // -XX:SurvivorRatio=4ï¼šè®¾ç½®å¹´è½»ä»£ä¸­EdenåŒºä¸SurvivoråŒºçš„å¤§å°æ¯”å€¼ã€‚è®¾ç½®ä¸º4ï¼Œåˆ™ä¸¤ä¸ªSurvivoråŒºä¸ä¸€ä¸ªEdenåŒºçš„æ¯”å€¼ä¸º2:4ï¼Œä¸€ä¸ªSurvivoråŒºå æ•´ä¸ªå¹´è½»ä»£çš„1/6 // -XX:MaxPermSize=16m:è®¾ç½®æŒä¹…ä»£å¤§å°ä¸º16mã€‚ // -XX:MaxTenuringThreshold=0ï¼šè®¾ç½®åƒåœ¾æœ€å¤§å¹´é¾„ã€‚å¦‚æœè®¾ç½®ä¸º0çš„è¯ï¼Œåˆ™å¹´è½»ä»£å¯¹è±¡ä¸ç»è¿‡SurvivoråŒºï¼Œç›´æ¥è¿›å…¥å¹´è€ä»£ã€‚å¯¹äºå¹´è€ä»£æ¯”è¾ƒå¤šçš„åº”ç”¨ï¼Œå¯ä»¥æé«˜æ•ˆç‡ã€‚å¦‚æœå°†æ­¤å€¼è®¾ç½®ä¸ºä¸€ä¸ªè¾ƒå¤§å€¼ï¼Œåˆ™å¹´è½»ä»£å¯¹è±¡ä¼šåœ¨SurvivoråŒºè¿›è¡Œå¤šæ¬¡å¤åˆ¶ï¼Œè¿™æ ·å¯ä»¥å¢åŠ å¯¹è±¡å†å¹´è½»ä»£çš„å­˜æ´»æ—¶é—´ï¼Œå¢åŠ åœ¨å¹´è½»ä»£å³è¢«å›æ”¶çš„æ¦‚è®ºã€‚ å›æ”¶å™¨é€‰æ‹© â€‹ JVMç»™äº†ä¸‰ç§é€‰æ‹©ï¼šä¸²è¡Œæ”¶é›†å™¨ã€å¹¶è¡Œæ”¶é›†å™¨ã€å¹¶å‘æ”¶é›†å™¨ï¼Œä½†æ˜¯ä¸²è¡Œæ”¶é›†å™¨åªé€‚ç”¨äºå°æ•°æ®é‡çš„æƒ…å†µï¼Œæ‰€ä»¥è¿™é‡Œçš„é€‰æ‹©ä¸»è¦é’ˆå¯¹å¹¶è¡Œæ”¶é›†å™¨å’Œå¹¶å‘æ”¶é›†å™¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒJDK5.0ä»¥å‰éƒ½æ˜¯ä½¿ç”¨ä¸²è¡Œæ”¶é›†å™¨ï¼Œå¦‚æœæƒ³ä½¿ç”¨å…¶ä»–æ”¶é›†å™¨éœ€è¦åœ¨å¯åŠ¨æ—¶åŠ å…¥ç›¸åº”å‚æ•°ã€‚JDK5.0ä»¥åï¼ŒJVMä¼šæ ¹æ®å½“å‰ç³»ç»Ÿé…ç½®è¿›è¡Œåˆ¤æ–­ã€‚ ååé‡ä¼˜å…ˆçš„å¹¶è¡Œæ”¶é›†å™¨ å¦‚ä¸Šæ–‡æ‰€è¿°ï¼Œå¹¶è¡Œæ”¶é›†å™¨ä¸»è¦ä»¥åˆ°è¾¾ä¸€å®šçš„ååé‡ä¸ºç›®æ ‡ï¼Œé€‚ç”¨äºç§‘å­¦æŠ€æœ¯å’Œåå°å¤„ç†ç­‰ã€‚ å…¸å‹é…ç½®ï¼š java -Xmx3800m -Xms3800m -Xmn2g -Xss128k -XX:+UseParallelGC -XX:ParallelGCThreads=20 // -XX:+UseParallelGCï¼šé€‰æ‹©åƒåœ¾æ”¶é›†å™¨ä¸ºå¹¶è¡Œæ”¶é›†å™¨ã€‚æ­¤é…ç½®ä»…å¯¹å¹´è½»ä»£æœ‰æ•ˆã€‚å³ä¸Šè¿°é…ç½®ä¸‹ï¼Œå¹´è½»ä»£ä½¿ç”¨å¹¶å‘æ”¶é›†ï¼Œè€Œå¹´è€ä»£ä»æ—§ä½¿ç”¨ä¸²è¡Œæ”¶é›†ã€‚ // -XX:ParallelGCThreads=20ï¼šé…ç½®å¹¶è¡Œæ”¶é›†å™¨çš„çº¿ç¨‹æ•°ï¼Œå³ï¼šåŒæ—¶å¤šå°‘ä¸ªçº¿ç¨‹ä¸€èµ·è¿›è¡Œåƒåœ¾å›æ”¶ã€‚æ­¤å€¼æœ€å¥½é…ç½®ä¸å¤„ç†å™¨æ•°ç›®ç›¸ç­‰ã€‚ java -Xmx3550m -Xms3550m -Xmn2g -Xss128k -XX:+UseParallelGC -XX:ParallelGCThreads=20 -XX:+UseParallelOldGC // -XX:+UseParallelOldGCï¼šé…ç½®å¹´è€ä»£åƒåœ¾æ”¶é›†æ–¹å¼ä¸ºå¹¶è¡Œæ”¶é›†ã€‚JDK6.0æ”¯æŒå¯¹å¹´è€ä»£å¹¶è¡Œæ”¶é›†ã€‚ java -Xmx3550m -Xms3550m -Xmn2g -Xss128k -XX:+UseParallelGC -XX:MaxGCPauseMillis=100 // -XX:MaxGCPauseMillis=100:è®¾ç½®æ¯æ¬¡å¹´è½»ä»£åƒåœ¾å›æ”¶çš„æœ€é•¿æ—¶é—´ï¼Œå¦‚æœæ— æ³•æ»¡è¶³æ­¤æ—¶é—´ï¼ŒJVMä¼šè‡ªåŠ¨è°ƒæ•´å¹´è½»ä»£å¤§å°ï¼Œä»¥æ»¡è¶³æ­¤å€¼ã€‚ java -Xmx3550m -Xms3550m -Xmn2g -Xss128k -XX:+UseParallelGC -XX:MaxGCPauseMillis=100 -XX:+UseAdaptiveSizePolicy // -XX:+UseAdaptiveSizePolicyï¼šè®¾ç½®æ­¤é€‰é¡¹åï¼Œå¹¶è¡Œæ”¶é›†å™¨ä¼šè‡ªåŠ¨é€‰æ‹©å¹´è½»ä»£åŒºå¤§å°å’Œç›¸åº”çš„SurvivoråŒºæ¯”ä¾‹ï¼Œä»¥è¾¾åˆ°ç›®æ ‡ç³»ç»Ÿè§„å®šçš„æœ€ä½ç›¸åº”æ—¶é—´æˆ–è€…æ”¶é›†é¢‘ç‡ç­‰ï¼Œæ­¤å€¼å»ºè®®ä½¿ç”¨å¹¶è¡Œæ”¶é›†å™¨æ—¶ï¼Œä¸€ç›´æ‰“å¼€ã€‚ å“åº”æ—¶é—´ä¼˜å…ˆçš„å¹¶å‘æ”¶é›†å™¨ å¦‚ä¸Šæ–‡æ‰€è¿°ï¼Œå¹¶å‘æ”¶é›†å™¨ä¸»è¦æ˜¯ä¿è¯ç³»ç»Ÿçš„å“åº”æ—¶é—´ï¼Œå‡å°‘åƒåœ¾æ”¶é›†æ—¶çš„åœé¡¿æ—¶é—´ã€‚é€‚ç”¨äºåº”ç”¨æœåŠ¡å™¨ã€ç”µä¿¡é¢†åŸŸç­‰ã€‚ å…¸å‹é…ç½®ï¼š java -Xmx3550m -Xms3550m -Xmn2g -Xss128k -XX:ParallelGCThreads=20 -XX:+UseConcMarkSweepGC -XX:+UseParNewGC // -XX:+UseConcMarkSweepGCï¼šè®¾ç½®å¹´è€ä»£ä¸ºå¹¶å‘æ”¶é›†ã€‚æµ‹è¯•ä¸­é…ç½®è¿™ä¸ªä»¥åï¼Œ-XX:NewRatio=4çš„é…ç½®å¤±æ•ˆäº†ï¼ŒåŸå› ä¸æ˜ã€‚æ‰€ä»¥ï¼Œæ­¤æ—¶å¹´è½»ä»£å¤§å°æœ€å¥½ç”¨-Xmnè®¾ç½®ã€‚ // -XX:+UseParNewGC:è®¾ç½®å¹´è½»ä»£ä¸ºå¹¶è¡Œæ”¶é›†ã€‚å¯ä¸CMSæ”¶é›†åŒæ—¶ä½¿ç”¨ã€‚JDK5.0ä»¥ä¸Šï¼ŒJVMä¼šæ ¹æ®ç³»ç»Ÿé…ç½®è‡ªè¡Œè®¾ç½®ï¼Œæ‰€ä»¥æ— éœ€å†è®¾ç½®æ­¤å€¼ã€‚ java -Xmx3550m -Xms3550m -Xmn2g -Xss128k -XX:+UseConcMarkSweepGC -XX:CMSFullGCsBeforeCompaction=5 -XX:+UseCMSCompactAtFullCollection // -XX:CMSFullGCsBeforeCompactionï¼šç”±äºå¹¶å‘æ”¶é›†å™¨ä¸å¯¹å†…å­˜ç©ºé—´è¿›è¡Œå‹ç¼©ã€æ•´ç†ï¼Œæ‰€ä»¥è¿è¡Œä¸€æ®µæ—¶é—´ä»¥åä¼šäº§ç”Ÿâ€œç¢ç‰‡â€ï¼Œä½¿å¾—è¿è¡Œæ•ˆç‡é™ä½ã€‚æ­¤å€¼è®¾ç½®è¿è¡Œå¤šå°‘æ¬¡GCä»¥åå¯¹å†…å­˜ç©ºé—´è¿›è¡Œå‹ç¼©ã€æ•´ç†ã€‚ // -XX:+UseCMSCompactAtFullCollectionï¼šæ‰“å¼€å¯¹å¹´è€ä»£çš„å‹ç¼©ã€‚å¯èƒ½ä¼šå½±å“æ€§èƒ½ï¼Œä½†æ˜¯å¯ä»¥æ¶ˆé™¤ç¢ç‰‡ è¾…åŠ©ä¿¡æ¯ JVMæä¾›äº†å¤§é‡å‘½ä»¤è¡Œå‚æ•°ï¼Œæ‰“å°ä¿¡æ¯ï¼Œä¾›è°ƒè¯•ä½¿ç”¨ã€‚ä¸»è¦æœ‰ä»¥ä¸‹ä¸€äº›ï¼š -XX:+PrintGC è¾“å‡ºå½¢å¼ï¼š[GC 118250K-&gt;113543K(130112K), 0.0094143 secs] [Full GC 121376K-&gt;10414K(130112K), 0.0650971 secs] -XX:+PrintGCDetails è¾“å‡ºå½¢å¼ï¼š[GC [DefNew: 8614K-&gt;781K(9088K), 0.0123035 secs] 118250K-&gt;113543K(130112K), 0.0124633 secs] [GC [DefNew: 8614K-&gt;8614K(9088K), 0.0000665 secs][Tenured: 112761K-&gt;10414K(121024K), 0.0433488 secs] 121376K-&gt;10414K(130112K), 0.0436268 secs] -XX:+PrintGCTimeStamps -XX:+PrintGCï¼šPrintGCTimeStampså¯ä¸ä¸Šé¢ä¸¤ä¸ªæ··åˆä½¿ç”¨ è¾“å‡ºå½¢å¼ï¼š11.851: [GC 98328K-&gt;93620K(130112K), 0.0082960 secs] -XX:+PrintGCApplicationConcurrentTime:æ‰“å°æ¯æ¬¡åƒåœ¾å›æ”¶å‰ï¼Œç¨‹åºæœªä¸­æ–­çš„æ‰§è¡Œæ—¶é—´ã€‚å¯ä¸ä¸Šé¢æ··åˆä½¿ç”¨ è¾“å‡ºå½¢å¼ï¼šApplication time: 0.5291524 seconds -XX:+PrintGCApplicationStoppedTimeï¼šæ‰“å°åƒåœ¾å›æ”¶æœŸé—´ç¨‹åºæš‚åœçš„æ—¶é—´ã€‚å¯ä¸ä¸Šé¢æ··åˆä½¿ç”¨ è¾“å‡ºå½¢å¼ï¼šTotal time for which application threads were stopped: 0.0468229 seconds -XX:PrintHeapAtGC:æ‰“å°GCå‰åçš„è¯¦ç»†å †æ ˆä¿¡æ¯ -Xloggc:filename:ä¸ä¸Šé¢å‡ ä¸ªé…åˆä½¿ç”¨ï¼ŒæŠŠç›¸å…³æ—¥å¿—ä¿¡æ¯è®°å½•åˆ°æ–‡ä»¶ä»¥ä¾¿åˆ†æã€‚ å¸¸è§é…ç½®æ±‡æ€» å †è®¾ç½® -Xms:ç­‰ä»·äº(-XX:InitialHeapSize)åˆå§‹å †å¤§å° -Xmx:ç­‰ä»·äº(-XX:MaxHeapSize)æœ€å¤§å †å¤§å° -Xmn:å †ä¸­æ–°ç”Ÿä»£åˆå§‹åŠæœ€å¤§å¤§å°ï¼Œå¦‚æœéœ€è¦è¿›ä¸€æ­¥ç»†åŒ–ï¼Œåˆå§‹åŒ–å¤§å°ç”¨-XX:NewSizeï¼Œæœ€å¤§å¤§å°ç”¨-XX:MaxNewSize -Xss:ç­‰ä»·äº(-XX:ThreadStackSize)æ¯ä¸ªçº¿ç¨‹å †æ ˆçš„å¤§å° -XX:NewSize=n:è®¾ç½®å¹´è½»ä»£å¤§å° -XX:NewRatio=n:è®¾ç½®å¹´è½»ä»£å’Œå¹´è€ä»£çš„æ¯”å€¼ã€‚å¦‚:ä¸º3ï¼Œè¡¨ç¤ºå¹´è½»ä»£ä¸å¹´è€ä»£æ¯”å€¼ä¸º1ï¼š3ï¼Œå¹´è½»ä»£å æ•´ä¸ªå¹´è½»ä»£å¹´è€ä»£å’Œçš„1/4 -XX:SurvivorRatio=n:å¹´è½»ä»£ä¸­EdenåŒºä¸ä¸¤ä¸ªSurvivoråŒºçš„æ¯”å€¼ã€‚æ³¨æ„SurvivoråŒºæœ‰ä¸¤ä¸ªã€‚å¦‚ï¼š3ï¼Œè¡¨ç¤ºEdenï¼šSurvivor=3ï¼š2ï¼Œä¸€ä¸ªSurvivoråŒºå æ•´ä¸ªå¹´è½»ä»£çš„1/5 -XX:MaxPermSize=n:è®¾ç½®æŒä¹…ä»£å¤§å° -XX:MaxTenuringThreshold=n:è®¾ç½®åƒåœ¾æœ€å¤§å¹´é¾„,å¹´è½»ä»£å¤åˆ¶æ¬¡æ•° æ”¶é›†å™¨è®¾ç½® -XX:+UseSerialGC:è®¾ç½®ä¸²è¡Œæ”¶é›†å™¨ -XX:+UseParallelGC:è®¾ç½®å¹¶è¡Œæ”¶é›†å™¨ -XX:+UseParalledlOldGC:è®¾ç½®å¹¶è¡Œå¹´è€ä»£æ”¶é›†å™¨ -XX:+UseConcMarkSweepGC:è®¾ç½®å¹¶å‘æ”¶é›†å™¨ åƒåœ¾å›æ”¶ç»Ÿè®¡ä¿¡æ¯ -XX:+PrintGC :æ‰“å°GCä¿¡æ¯ -XX:+PrintGCDetails :æ‰“å°GCæ—¶çš„å†…å­˜ -XX:+PrintGCTimeStamps ï¼šé€‰æ‹©æ‰“å°GCçš„æ–¹å¼åï¼Œå†æ·»åŠ æ­¤å‚æ•°ã€‚æ¯”å¦‚ï¼š-XX:+PrintGC -XX:+PrintGCTimeStampsæ¯æ¬¡GCæ—¶ä¼šæ‰“å°ç¨‹åºå¯åŠ¨åè‡³GCå‘ç”Ÿçš„æ—¶é—´æˆ³ã€‚ -Xloggc:filenameï¼šå°†GCæ—¥å¿—è¾“å‡ºåˆ°æŒ‡å®šä½ç½® å¹¶è¡Œæ”¶é›†å™¨è®¾ç½® -XX:ParallelGCThreads=n:è®¾ç½®å¹¶è¡Œæ”¶é›†å™¨æ”¶é›†æ—¶ä½¿ç”¨çš„CPUæ•°ã€‚å¹¶è¡Œæ”¶é›†çº¿ç¨‹æ•°ã€‚ -XX:MaxGCPauseMillis=n:è®¾ç½®å¹¶è¡Œæ”¶é›†æœ€å¤§æš‚åœæ—¶é—´ -XX:GCTimeRatio=n:è®¾ç½®åƒåœ¾å›æ”¶æ—¶é—´å ç¨‹åºè¿è¡Œæ—¶é—´çš„ç™¾åˆ†æ¯”ã€‚å…¬å¼ä¸º1/(1+n) å¹¶å‘æ”¶é›†å™¨è®¾ç½® -XX:+CMSIncrementalMode:è®¾ç½®ä¸ºå¢é‡æ¨¡å¼ã€‚é€‚ç”¨äºå•CPUæƒ…å†µã€‚ -XX:ParallelGCThreads=n:è®¾ç½®å¹¶å‘æ”¶é›†å™¨å¹´è½»ä»£æ”¶é›†æ–¹å¼ä¸ºå¹¶è¡Œæ”¶é›†æ—¶ï¼Œä½¿ç”¨çš„CPUæ•°ã€‚å¹¶è¡Œæ”¶é›†çº¿ç¨‹æ•°ã€‚ è°ƒä¼˜æ€»ç»“ å¹´è½»ä»£å¤§å°é€‰æ‹© å“åº”æ—¶é—´ä¼˜å…ˆçš„åº”ç”¨ï¼šå°½å¯èƒ½è®¾å¤§ï¼Œç›´åˆ°æ¥è¿‘ç³»ç»Ÿçš„æœ€ä½å“åº”æ—¶é—´é™åˆ¶ï¼ˆæ ¹æ®å®é™…æƒ…å†µé€‰æ‹©ï¼‰ã€‚åœ¨æ­¤ç§æƒ…å†µä¸‹ï¼Œå¹´è½»ä»£æ”¶é›†å‘ç”Ÿçš„é¢‘ç‡ä¹Ÿæ˜¯æœ€å°çš„ã€‚åŒæ—¶ï¼Œå‡å°‘åˆ°è¾¾å¹´è€ä»£çš„å¯¹è±¡ã€‚ ååé‡ä¼˜å…ˆçš„åº”ç”¨ï¼šå°½å¯èƒ½çš„è®¾ç½®å¤§ï¼Œå¯èƒ½åˆ°è¾¾Gbitçš„ç¨‹åº¦ã€‚å› ä¸ºå¯¹å“åº”æ—¶é—´æ²¡æœ‰è¦æ±‚ï¼Œåƒåœ¾æ”¶é›†å¯ä»¥å¹¶è¡Œè¿›è¡Œï¼Œä¸€èˆ¬é€‚åˆ8CPUä»¥ä¸Šçš„åº”ç”¨ã€‚ å¹´è€ä»£å¤§å°é€‰æ‹© å“åº”æ—¶é—´ä¼˜å…ˆçš„åº”ç”¨ï¼šå¹´è€ä»£ä½¿ç”¨å¹¶å‘æ”¶é›†å™¨ï¼Œæ‰€ä»¥å…¶å¤§å°éœ€è¦å°å¿ƒè®¾ç½®ï¼Œä¸€èˆ¬è¦è€ƒè™‘å¹¶å‘ä¼šè¯ç‡å’Œä¼šè¯æŒç»­æ—¶é—´ç­‰ä¸€äº›å‚æ•°ã€‚å¦‚æœå †è®¾ç½®å°äº†ï¼Œå¯ä»¥ä¼šé€ æˆå†…å­˜ç¢ç‰‡ã€é«˜å›æ”¶é¢‘ç‡ä»¥åŠåº”ç”¨æš‚åœè€Œä½¿ç”¨ä¼ ç»Ÿçš„æ ‡è®°æ¸…é™¤æ–¹å¼ï¼›å¦‚æœå †å¤§äº†ï¼Œåˆ™éœ€è¦è¾ƒé•¿çš„æ”¶é›†æ—¶é—´ã€‚æœ€ä¼˜åŒ–çš„æ–¹æ¡ˆï¼Œä¸€èˆ¬éœ€è¦å‚è€ƒä»¥ä¸‹æ•°æ®è·å¾—ï¼š å¹¶å‘åƒåœ¾æ”¶é›†ä¿¡æ¯ æŒä¹…ä»£å¹¶å‘æ”¶é›†æ¬¡æ•° ä¼ ç»ŸGCä¿¡æ¯ èŠ±åœ¨å¹´è½»ä»£å’Œå¹´è€ä»£å›æ”¶ä¸Šçš„æ—¶é—´æ¯”ä¾‹ å‡å°‘å¹´è½»ä»£å’Œå¹´è€ä»£èŠ±è´¹çš„æ—¶é—´ï¼Œä¸€èˆ¬ä¼šæé«˜åº”ç”¨çš„æ•ˆç‡ ååé‡ä¼˜å…ˆçš„åº”ç”¨ï¼šä¸€èˆ¬ååé‡ä¼˜å…ˆçš„åº”ç”¨éƒ½æœ‰ä¸€ä¸ªå¾ˆå¤§çš„å¹´è½»ä»£å’Œä¸€ä¸ªè¾ƒå°çš„å¹´è€ä»£ã€‚åŸå› æ˜¯ï¼Œè¿™æ ·å¯ä»¥å°½å¯èƒ½å›æ”¶æ‰å¤§éƒ¨åˆ†çŸ­æœŸå¯¹è±¡ï¼Œå‡å°‘ä¸­æœŸçš„å¯¹è±¡ï¼Œè€Œå¹´è€ä»£å°½å­˜æ”¾é•¿æœŸå­˜æ´»å¯¹è±¡ã€‚ è¾ƒå°å †å¼•èµ·çš„ç¢ç‰‡é—®é¢˜ å› ä¸ºå¹´è€ä»£çš„å¹¶å‘æ”¶é›†å™¨ä½¿ç”¨æ ‡è®°ã€æ¸…é™¤ç®—æ³•ï¼Œæ‰€ä»¥ä¸ä¼šå¯¹å †è¿›è¡Œå‹ç¼©ã€‚å½“æ”¶é›†å™¨å›æ”¶æ—¶ï¼Œä»–ä¼šæŠŠç›¸é‚»çš„ç©ºé—´è¿›è¡Œåˆå¹¶ï¼Œè¿™æ ·å¯ä»¥åˆ†é…ç»™è¾ƒå¤§çš„å¯¹è±¡ã€‚ä½†æ˜¯ï¼Œå½“å †ç©ºé—´è¾ƒå°æ—¶ï¼Œè¿è¡Œä¸€æ®µæ—¶é—´ä»¥åï¼Œå°±ä¼šå‡ºç°â€œç¢ç‰‡â€ï¼Œå¦‚æœå¹¶å‘æ”¶é›†å™¨æ‰¾ä¸åˆ°è¶³å¤Ÿçš„ç©ºé—´ï¼Œé‚£ä¹ˆå¹¶å‘æ”¶é›†å™¨å°†ä¼šåœæ­¢ï¼Œç„¶åä½¿ç”¨ä¼ ç»Ÿçš„æ ‡è®°ã€æ¸…é™¤æ–¹å¼è¿›è¡Œå›æ”¶ã€‚å¦‚æœå‡ºç°â€œç¢ç‰‡â€ï¼Œå¯èƒ½éœ€è¦è¿›è¡Œå¦‚ä¸‹é…ç½®ï¼š -XX:+UseCMSCompactAtFullCollectionï¼šä½¿ç”¨å¹¶å‘æ”¶é›†å™¨æ—¶ï¼Œå¼€å¯å¯¹å¹´è€ä»£çš„å‹ç¼©ã€‚ -XX:CMSFullGCsBeforeCompaction=0ï¼šä¸Šé¢é…ç½®å¼€å¯çš„æƒ…å†µä¸‹ï¼Œè¿™é‡Œè®¾ç½®å¤šå°‘æ¬¡Full GCåï¼Œå¯¹å¹´è€ä»£è¿›è¡Œå‹ç¼© å®é™…åº”ç”¨å‘½ä»¤ jps æŸ¥çœ‹æ‰€æœ‰çš„jvmè¿›ç¨‹ï¼ŒåŒ…æ‹¬è¿›ç¨‹IDï¼Œè¿›ç¨‹å¯åŠ¨çš„è·¯å¾„ç­‰ç­‰ã€‚ æˆ‘è‡ªå·±ä¹Ÿç”¨PSï¼Œå³ï¼šps -ef | grep java jstack è§‚å¯Ÿjvmä¸­å½“å‰æ‰€æœ‰çº¿ç¨‹çš„è¿è¡Œæƒ…å†µå’Œçº¿ç¨‹å½“å‰çŠ¶æ€ã€‚ ç³»ç»Ÿå´©æºƒäº†ï¼Ÿå¦‚æœjavaç¨‹åºå´©æºƒç”Ÿæˆcoreæ–‡ä»¶ï¼Œjstackå·¥å…·å¯ä»¥ç”¨æ¥è·å¾—coreæ–‡ä»¶çš„java stackå’Œnative stackçš„ä¿¡æ¯ï¼Œä»è€Œå¯ä»¥è½»æ¾åœ°çŸ¥é“javaç¨‹åºæ˜¯å¦‚ä½•å´©æºƒå’Œåœ¨ç¨‹åºä½•å¤„å‘ç”Ÿé—®é¢˜ã€‚ ç³»ç»Ÿhungä½äº†ï¼Ÿjstackå·¥å…·è¿˜å¯ä»¥é™„å±åˆ°æ­£åœ¨è¿è¡Œçš„javaç¨‹åºä¸­ï¼Œçœ‹åˆ°å½“æ—¶è¿è¡Œçš„javaç¨‹åºçš„java stackå’Œnative stackçš„ä¿¡æ¯, å¦‚æœç°åœ¨è¿è¡Œçš„javaç¨‹åºå‘ˆç°hungçš„çŠ¶æ€ï¼Œjstackæ˜¯éå¸¸æœ‰ç”¨çš„ã€‚ jstat jstatåˆ©ç”¨JVMå†…å»ºçš„æŒ‡ä»¤å¯¹Javaåº”ç”¨ç¨‹åºçš„èµ„æºå’Œæ€§èƒ½è¿›è¡Œå®æ—¶çš„å‘½ä»¤è¡Œçš„ç›‘æ§ï¼ŒåŒ…æ‹¬äº†å¯¹è¿›ç¨‹çš„classloaderï¼Œcompilerï¼Œgcæƒ…å†µï¼› ç‰¹åˆ«çš„ï¼Œä¸€ä¸ªæå¼ºçš„ç›‘è§†å†…å­˜çš„å·¥å…·ï¼Œå¯ä»¥ç”¨æ¥ç›‘è§†VMå†…å­˜å†…çš„å„ç§å †å’Œéå †çš„å¤§å°åŠå…¶å†…å­˜ä½¿ç”¨é‡ï¼Œä»¥åŠåŠ è½½ç±»çš„æ•°é‡ã€‚ jmap ç›‘è§†è¿›ç¨‹è¿è¡Œä¸­çš„jvmç‰©ç†å†…å­˜çš„å ç”¨æƒ…å†µï¼Œè¯¥è¿›ç¨‹å†…å­˜å†…ï¼Œæ‰€æœ‰å¯¹è±¡çš„æƒ…å†µï¼Œä¾‹å¦‚äº§ç”Ÿäº†å“ªäº›å¯¹è±¡ï¼Œå¯¹è±¡æ•°é‡ï¼› ç³»ç»Ÿå´©æºƒäº†ï¼Ÿjmap å¯ä»¥ä»coreæ–‡ä»¶æˆ–è¿›ç¨‹ä¸­è·å¾—å†…å­˜çš„å…·ä½“åŒ¹é…æƒ…å†µï¼ŒåŒ…æ‹¬Heap size, Perm sizeç­‰ç­‰ jinfo è§‚å¯Ÿè¿›ç¨‹è¿è¡Œç¯å¢ƒå‚æ•°ï¼ŒåŒ…æ‹¬Java Systemå±æ€§å’ŒJVMå‘½ä»¤è¡Œå‚æ•° ç³»ç»Ÿå´©æºƒäº†ï¼Ÿjinfoå¯ä»¥ä»coreæ–‡ä»¶é‡Œé¢çŸ¥é“å´©æºƒçš„Javaåº”ç”¨ç¨‹åºçš„é…ç½®ä¿¡æ¯ã€‚ java -XX:+PrintFlagsInitial -version:æŸ¥çœ‹æ‰€æœ‰åˆå§‹åŒ–é»˜è®¤é…ç½® java -XX:+PrintFlagsFinal -version:æŸ¥çœ‹æ‰€æœ‰åŠä¿®æ”¹æ›´æ–°é…ç½® java -XX:+printCommandLineFlags -version:æ‰“å°å‘½ä»¤å‚æ•°é…ç½® :=:è¢«jvmæˆ–äººä¸ºä¿®æ”¹è¿‡çš„å‚æ•° -XX:+UseParallelGC:é‡‡ç”¨å¹¶è¡Œåƒåœ¾å›æ”¶å™¨ -XX:+UseSerialGC:é‡‡ç”¨ä¸²è¡Œåƒåœ¾å›æ”¶å™¨ ","link":"https://tianxiawuhao.github.io/HEMJYLqMW/"},{"title":"Javaçš„å€¼ä¼ é€’","content":"å½¢å‚ä¸å®å‚ æˆ‘ä»¬å…ˆæ¥é‡æ¸©ä¸€ç»„è¯­æ³•ï¼š å½¢å‚ï¼šæ–¹æ³•è¢«è°ƒç”¨æ—¶éœ€è¦ä¼ é€’è¿›æ¥çš„å‚æ•°ï¼Œå¦‚ï¼šfunc(int a)ä¸­çš„aï¼Œå®ƒåªæœ‰åœ¨funcè¢«è°ƒç”¨æœŸé—´aæ‰æœ‰æ„ä¹‰ï¼Œä¹Ÿå°±æ˜¯ä¼šè¢«åˆ†é…å†…å­˜ç©ºé—´ï¼Œåœ¨æ–¹æ³•funcæ‰§è¡Œå®Œæˆåï¼Œaå°±ä¼šè¢«é”€æ¯é‡Šæ”¾ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯ä¸å­˜åœ¨äº† å®å‚ï¼šæ–¹æ³•è¢«è°ƒç”¨æ—¶ä¼ å…¥çš„å®é™…å€¼ï¼Œå®ƒåœ¨æ–¹æ³•è¢«è°ƒç”¨å‰å°±å·²ç»è¢«åˆå§‹åŒ–å¹¶ä¸”åœ¨æ–¹æ³•è¢«è°ƒç”¨æ—¶ä¼ å…¥ã€‚ ä¸¾ä¸ªæ —å­ï¼š public static void func(int a){ a=20; System.out.println(a); } public static void main(String[] args) { int a=10; func(a); } ä¾‹å­ä¸­ int a=10;ä¸­çš„aåœ¨è¢«è°ƒç”¨ä¹‹å‰å°±å·²ç»åˆ›å»ºå¹¶åˆå§‹åŒ–ï¼Œåœ¨è°ƒç”¨funcæ–¹æ³•æ—¶ï¼Œä»–è¢«å½“åšå‚æ•°ä¼ å…¥ï¼Œæ‰€ä»¥è¿™ä¸ªaæ˜¯å®å‚ã€‚ è€Œfunc(int a)ä¸­çš„aåªæœ‰åœ¨funcè¢«è°ƒç”¨æ—¶å®ƒçš„ç”Ÿå‘½å‘¨æœŸæ‰å¼€å§‹ï¼Œè€Œåœ¨funcè°ƒç”¨ç»“æŸä¹‹åï¼Œå®ƒä¹Ÿéšä¹‹è¢«JVMé‡Šæ”¾æ‰ï¼Œæ‰€ä»¥è¿™ä¸ªaæ˜¯å½¢å‚ã€‚ Javaçš„æ•°æ®ç±»å‹ æ‰€è°“æ•°æ®ç±»å‹ï¼Œæ˜¯ç¼–ç¨‹è¯­è¨€ä¸­å¯¹å†…å­˜çš„ä¸€ç§æŠ½è±¡è¡¨è¾¾æ–¹å¼ï¼Œæˆ‘ä»¬çŸ¥é“ç¨‹åºæ˜¯ç”±ä»£ç æ–‡ä»¶å’Œé™æ€èµ„æºç»„æˆï¼Œåœ¨ç¨‹åºè¢«è¿è¡Œå‰ï¼Œè¿™äº›ä»£ç å­˜åœ¨åœ¨ç¡¬ç›˜é‡Œï¼Œç¨‹åºå¼€å§‹è¿è¡Œï¼Œè¿™äº›ä»£ç ä¼šè¢«è½¬æˆè®¡ç®—æœºèƒ½è¯†åˆ«çš„å†…å®¹æ”¾åˆ°å†…å­˜ä¸­è¢«æ‰§è¡Œã€‚ å› æ­¤ æ•°æ®ç±»å‹å®è´¨ä¸Šæ˜¯ç”¨æ¥å®šä¹‰ç¼–ç¨‹è¯­è¨€ä¸­ç›¸åŒç±»å‹çš„æ•°æ®çš„å­˜å‚¨å½¢å¼ï¼Œä¹Ÿå°±æ˜¯å†³å®šäº†å¦‚ä½•å°†ä»£è¡¨è¿™äº›å€¼çš„ä½å­˜å‚¨åˆ°è®¡ç®—æœºçš„å†…å­˜ä¸­ã€‚ æ‰€ä»¥ï¼Œæ•°æ®åœ¨å†…å­˜ä¸­çš„å­˜å‚¨ï¼Œæ˜¯æ ¹æ®æ•°æ®ç±»å‹æ¥åˆ’å®šå­˜å‚¨å½¢å¼å’Œå­˜å‚¨ä½ç½®çš„ã€‚ é‚£ä¹ˆ Javaçš„æ•°æ®ç±»å‹æœ‰å“ªäº›ï¼Ÿ åŸºæœ¬ç±»å‹ï¼šç¼–ç¨‹è¯­è¨€ä¸­å†…ç½®çš„æœ€å°ç²’åº¦çš„æ•°æ®ç±»å‹ã€‚å®ƒåŒ…æ‹¬å››å¤§ç±»å…«ç§ç±»å‹ï¼š 4ç§æ•´æ•°ç±»å‹ï¼šbyteã€shortã€intã€long 2ç§æµ®ç‚¹æ•°ç±»å‹ï¼šfloatã€double 1ç§å­—ç¬¦ç±»å‹ï¼šchar 1ç§å¸ƒå°”ç±»å‹ï¼šboolean å¼•ç”¨ç±»å‹ï¼šå¼•ç”¨ä¹Ÿå«å¥æŸ„ï¼Œå¼•ç”¨ç±»å‹ï¼Œæ˜¯ç¼–ç¨‹è¯­è¨€ä¸­å®šä¹‰çš„åœ¨å¥æŸ„ä¸­å­˜æ”¾ç€å®é™…å†…å®¹æ‰€åœ¨åœ°å€çš„åœ°å€å€¼çš„ä¸€ç§æ•°æ®å½¢å¼ã€‚å®ƒä¸»è¦åŒ…æ‹¬ï¼š ç±» æ¥å£ æ•°ç»„ æœ‰äº†æ•°æ®ç±»å‹ï¼ŒJVMå¯¹ç¨‹åºæ•°æ®çš„ç®¡ç†å°±è§„èŒƒåŒ–äº†ï¼Œä¸åŒçš„æ•°æ®ç±»å‹ï¼Œå®ƒçš„å­˜å‚¨å½¢å¼å’Œä½ç½®æ˜¯ä¸ä¸€æ ·çš„ï¼Œè¦æƒ³çŸ¥é“JVMæ˜¯æ€ä¹ˆå­˜å‚¨å„ç§ç±»å‹çš„æ•°æ®ï¼Œå°±å¾—å…ˆäº†è§£JVMçš„å†…å­˜åˆ’åˆ†ä»¥åŠæ¯éƒ¨åˆ†çš„èŒèƒ½ã€‚ JVMå†…å­˜çš„åˆ’åˆ†åŠèŒèƒ½ â€‹ Javaè¯­è¨€æœ¬èº«æ˜¯ä¸èƒ½æ“ä½œå†…å­˜çš„ï¼Œå®ƒçš„ä¸€åˆ‡éƒ½æ˜¯äº¤ç»™JVMæ¥ç®¡ç†å’Œæ§åˆ¶çš„ï¼Œå› æ­¤Javaå†…å­˜åŒºåŸŸçš„åˆ’åˆ†ä¹Ÿå°±æ˜¯JVMçš„åŒºåŸŸåˆ’åˆ†ï¼Œåœ¨è¯´JVMçš„å†…å­˜åˆ’åˆ†ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹Javaç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå¦‚ä¸‹å›¾ï¼š æœ‰å›¾å¯ä»¥çœ‹å‡ºï¼šJavaä»£ç è¢«ç¼–è¯‘å™¨ç¼–è¯‘æˆå­—èŠ‚ç ä¹‹åï¼ŒJVMå¼€è¾Ÿä¸€ç‰‡å†…å­˜ç©ºé—´ï¼ˆä¹Ÿå«è¿è¡Œæ—¶æ•°æ®åŒºï¼‰ï¼Œé€šè¿‡ç±»åŠ è½½å™¨åŠ åˆ°åˆ°è¿è¡Œæ—¶æ•°æ®åŒºæ¥å­˜å‚¨ç¨‹åºæ‰§è¡ŒæœŸé—´éœ€è¦ç”¨åˆ°çš„æ•°æ®å’Œç›¸å…³ä¿¡æ¯ï¼Œåœ¨è¿™ä¸ªæ•°æ®åŒºä¸­ï¼Œå®ƒç”±ä»¥ä¸‹å‡ éƒ¨åˆ†ç»„æˆï¼š è™šæ‹Ÿæœºæ ˆ å † ç¨‹åºè®¡æ•°å™¨ æ–¹æ³•åŒº æœ¬åœ°æ–¹æ³•æ ˆ æˆ‘ä»¬æ¥ç€æ¥äº†è§£ä¸€ä¸‹æ¯éƒ¨åˆ†çš„åŸç†ä»¥åŠå…·ä½“ç”¨æ¥å­˜å‚¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­çš„å“ªäº›æ•°æ®ã€‚ è™šæ‹Ÿæœºæ ˆ è™šæ‹Ÿæœºæ ˆæ˜¯Javaæ–¹æ³•æ‰§è¡Œçš„å†…å­˜æ¨¡å‹ï¼Œæ ˆä¸­å­˜æ”¾ç€æ ˆå¸§ï¼Œæ¯ä¸ªæ ˆå¸§åˆ†åˆ«å¯¹åº”ä¸€ä¸ªè¢«è°ƒç”¨çš„æ–¹æ³•ï¼Œæ–¹æ³•çš„è°ƒç”¨è¿‡ç¨‹å¯¹åº”æ ˆå¸§åœ¨è™šæ‹Ÿæœºä¸­å…¥æ ˆåˆ°å‡ºæ ˆçš„è¿‡ç¨‹ã€‚ æ ˆæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹ä¹‹é—´çš„æ ˆæ˜¯éš”ç¦»çš„ï¼›å½“ç¨‹åºä¸­æŸä¸ªçº¿ç¨‹å¼€å§‹æ‰§è¡Œä¸€ä¸ªæ–¹æ³•æ—¶å°±ä¼šç›¸åº”çš„åˆ›å»ºä¸€ä¸ªæ ˆå¸§å¹¶ä¸”å…¥æ ˆï¼ˆä½äºæ ˆé¡¶ï¼‰ï¼Œåœ¨æ–¹æ³•ç»“æŸåï¼Œæ ˆå¸§å‡ºæ ˆã€‚ ä¸‹å›¾è¡¨ç¤ºäº†ä¸€ä¸ªJavaæ ˆçš„æ¨¡å‹ä»¥åŠæ ˆå¸§çš„ç»„æˆï¼š æ ˆå¸§:æ˜¯ç”¨äºæ”¯æŒè™šæ‹Ÿæœºè¿›è¡Œæ–¹æ³•è°ƒç”¨å’Œæ–¹æ³•æ‰§è¡Œçš„æ•°æ®ç»“æ„ï¼Œå®ƒæ˜¯è™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºä¸­çš„è™šæ‹Ÿæœºæ ˆçš„æ ˆå…ƒç´ ã€‚ æ¯ä¸ªæ ˆå¸§ä¸­åŒ…æ‹¬ï¼š å±€éƒ¨å˜é‡è¡¨:ç”¨æ¥å­˜å‚¨æ–¹æ³•ä¸­çš„å±€éƒ¨å˜é‡ï¼ˆéé™æ€å˜é‡ã€å‡½æ•°å½¢å‚ï¼‰ã€‚å½“å˜é‡ä¸ºåŸºæœ¬æ•°æ®ç±»å‹æ—¶ï¼Œç›´æ¥å­˜å‚¨å€¼ï¼Œå½“å˜é‡ä¸ºå¼•ç”¨ç±»å‹æ—¶ï¼Œå­˜å‚¨çš„æ˜¯æŒ‡å‘å…·ä½“å¯¹è±¡çš„å¼•ç”¨ã€‚ æ“ä½œæ•°æ ˆ:Javaè™šæ‹Ÿæœºçš„è§£é‡Šæ‰§è¡Œå¼•æ“è¢«ç§°ä¸º&quot;åŸºäºæ ˆçš„æ‰§è¡Œå¼•æ“&quot;ï¼Œå…¶ä¸­æ‰€æŒ‡çš„æ ˆå°±æ˜¯æŒ‡æ“ä½œæ•°æ ˆã€‚ æŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± çš„å¼•ç”¨:å­˜å‚¨ç¨‹åºæ‰§è¡Œæ—¶å¯èƒ½ç”¨åˆ°å¸¸é‡çš„å¼•ç”¨ã€‚ æ–¹æ³•è¿”å›åœ°å€:å­˜å‚¨æ–¹æ³•æ‰§è¡Œå®Œæˆåçš„è¿”å›åœ°å€ã€‚ å † å †æ˜¯ç”¨æ¥å­˜å‚¨å¯¹è±¡æœ¬èº«å’Œæ•°ç»„çš„ï¼Œåœ¨JVMä¸­åªæœ‰ä¸€ä¸ªå †ï¼Œå› æ­¤ï¼Œå †æ˜¯è¢«æ‰€æœ‰çº¿ç¨‹å…±äº«çš„ã€‚ æ–¹æ³•åŒºï¼š â€‹ æ–¹æ³•åŒºæ˜¯ä¸€å—æ‰€æœ‰çº¿ç¨‹å…±äº«çš„å†…å­˜é€»è¾‘åŒºåŸŸï¼Œåœ¨JVMä¸­åªæœ‰ä¸€ä¸ªæ–¹æ³•åŒºï¼Œç”¨æ¥å­˜å‚¨ä¸€äº›çº¿ç¨‹å¯å…±äº«çš„å†…å®¹ï¼Œå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®æ–¹æ³•åŒºä¸­åŒä¸€ä¸ªå†…å®¹æ—¶ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è£…è½½è¯¥æ•°æ®ï¼Œå…¶å®ƒçº¿ç¨‹åªèƒ½ç­‰å¾…ã€‚ â€‹ æ–¹æ³•åŒºå¯å­˜å‚¨çš„å†…å®¹æœ‰ï¼šç±»çš„å…¨è·¯å¾„åã€ç±»çš„ç›´æ¥è¶…ç±»çš„æƒå…¨é™å®šåã€ç±»çš„è®¿é—®ä¿®é¥°ç¬¦ã€ç±»çš„ç±»å‹ï¼ˆç±»æˆ–æ¥å£ï¼‰ã€ç±»çš„ç›´æ¥æ¥å£å…¨é™å®šåçš„æœ‰åºåˆ—è¡¨ã€å¸¸é‡æ± ï¼ˆå­—æ®µï¼Œæ–¹æ³•ä¿¡æ¯ï¼Œé™æ€å˜é‡ï¼Œç±»å‹å¼•ç”¨ï¼ˆclassï¼‰ï¼‰ç­‰ã€‚ æœ¬åœ°æ–¹æ³•æ ˆï¼š â€‹ æœ¬åœ°æ–¹æ³•æ ˆçš„åŠŸèƒ½å’Œè™šæ‹Ÿæœºæ ˆæ˜¯åŸºæœ¬ä¸€è‡´çš„ï¼Œå¹¶ä¸”ä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œå®ƒä»¬çš„åŒºåˆ«åœ¨äºè™šæ‹Ÿæœºæ ˆæ˜¯ä¸ºæ‰§è¡ŒJavaæ–¹æ³•æœåŠ¡çš„ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆæ˜¯ä¸ºæ‰§è¡Œæœ¬åœ°æ–¹æ³•æœåŠ¡çš„ã€‚ æœ‰äººä¼šç–‘æƒ‘ï¼šä»€ä¹ˆæ˜¯æœ¬åœ°æ–¹æ³•ï¼Ÿä¸ºä»€ä¹ˆJavaè¿˜è¦è°ƒç”¨æœ¬åœ°æ–¹æ³•ï¼Ÿ ç¨‹åºè®¡æ•°å™¨ï¼š â€‹ çº¿ç¨‹ç§æœ‰çš„ã€‚è®°å½•ç€å½“å‰çº¿ç¨‹æ‰€æ‰§è¡Œçš„å­—èŠ‚ç çš„è¡Œå·æŒ‡ç¤ºå™¨ï¼Œåœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå­—èŠ‚ç è§£é‡Šå™¨å·¥ä½œæ—¶å°±æ˜¯é€šè¿‡æ”¹å˜è¿™ä¸ªè®¡æ•°å™¨çš„å€¼æ¥é€‰å–ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ï¼Œåˆ†æ”¯ã€å¾ªç¯ã€å¼‚å¸¸å¤„ç†ã€çº¿ç¨‹æ¢å¤ç­‰åŸºç¡€åŠŸèƒ½éƒ½éœ€è¦ä¾èµ–è®¡æ•°å™¨å®Œæˆã€‚ æ•°æ®å¦‚ä½•åœ¨å†…å­˜ä¸­å­˜å‚¨ï¼Ÿ ä»ä¸Šé¢ç¨‹åºè¿è¡Œå›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒJVMåœ¨ç¨‹åºè¿è¡Œæ—¶çš„å†…å­˜åˆ†é…æœ‰ä¸‰ä¸ªåœ°æ–¹ï¼š å † æ ˆ é™æ€æ–¹æ³•åŒº å¸¸é‡åŒº ç›¸åº”åœ°ï¼Œæ¯ä¸ªå­˜å‚¨åŒºåŸŸéƒ½æœ‰è‡ªå·±çš„å†…å­˜åˆ†é…ç­–ç•¥ï¼š å †å¼ï¼š æ ˆå¼ é™æ€ æˆ‘ä»¬å·²ç»çŸ¥é“ï¼šJavaä¸­çš„æ•°æ®ç±»å‹æœ‰åŸºæœ¬æ•°æ®ç±»å‹å’Œå¼•ç”¨æ•°æ®ç±»å‹ï¼Œé‚£ä¹ˆè¿™äº›æ•°æ®çš„å­˜å‚¨éƒ½ä½¿ç”¨å“ªä¸€ç§ç­–ç•¥å‘¢ï¼Ÿ è¿™é‡Œè¦åˆ†ä»¥ä¸‹çš„æƒ…å†µè¿›è¡Œæ¢ç©¶ï¼š åŸºæœ¬æ•°æ®ç±»å‹çš„å­˜å‚¨ï¼š A. åŸºæœ¬æ•°æ®ç±»å‹çš„å±€éƒ¨å˜é‡ B. åŸºæœ¬æ•°æ®ç±»å‹çš„æˆå‘˜å˜é‡ C. åŸºæœ¬æ•°æ®ç±»å‹çš„é™æ€å˜é‡ å¼•ç”¨æ•°æ®ç±»å‹çš„å­˜å‚¨ åŸºæœ¬æ•°æ®ç±»å‹çš„å­˜å‚¨ æˆ‘ä»¬åˆ†åˆ«æ¥ç ”ç©¶ä¸€ä¸‹ï¼š A.åŸºæœ¬æ•°æ®ç±»å‹çš„å±€éƒ¨å˜é‡ å®šä¹‰åŸºæœ¬æ•°æ®ç±»å‹çš„å±€éƒ¨å˜é‡ä»¥åŠæ•°æ®éƒ½æ˜¯ç›´æ¥å­˜å‚¨åœ¨å†…å­˜ä¸­çš„æ ˆä¸Šï¼Œä¹Ÿå°±æ˜¯å‰é¢è¯´åˆ°çš„â€œè™šæ‹Ÿæœºæ ˆâ€ï¼Œæ•°æ®æœ¬èº«çš„å€¼å°±æ˜¯å­˜å‚¨åœ¨æ ˆç©ºé—´é‡Œé¢ã€‚ å¦‚ä¸Šå›¾ï¼Œåœ¨æ–¹æ³•å†…å®šä¹‰çš„å˜é‡ç›´æ¥å­˜å‚¨åœ¨æ ˆä¸­ï¼Œå¦‚ int age=50; int weight=50; int grade=6; å½“æˆ‘ä»¬å†™â€œint age=50ï¼›â€ï¼Œå…¶å®æ˜¯åˆ†ä¸ºä¸¤æ­¥çš„ï¼š int age;//å®šä¹‰å˜é‡ age=50;//èµ‹å€¼ â€‹ é¦–å…ˆJVMåˆ›å»ºä¸€ä¸ªåä¸ºageçš„å˜é‡ï¼Œå­˜äºå±€éƒ¨å˜é‡è¡¨ä¸­ï¼Œç„¶åå»æ ˆä¸­æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨æœ‰å­—é¢é‡å€¼ä¸º50çš„å†…å®¹ï¼Œå¦‚æœæœ‰å°±ç›´æ¥æŠŠageæŒ‡å‘è¿™ä¸ªåœ°å€ï¼Œå¦‚æœæ²¡æœ‰ï¼ŒJVMä¼šåœ¨æ ˆä¸­å¼€è¾Ÿä¸€å—ç©ºé—´æ¥å­˜å‚¨â€œ50â€è¿™ä¸ªå†…å®¹ï¼Œå¹¶ä¸”æŠŠageæŒ‡å‘è¿™ä¸ªåœ°å€ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼š â€‹ æˆ‘ä»¬å£°æ˜å¹¶åˆå§‹åŒ–åŸºæœ¬æ•°æ®ç±»å‹çš„å±€éƒ¨å˜é‡æ—¶ï¼Œå˜é‡åä»¥åŠå­—é¢é‡å€¼éƒ½æ˜¯å­˜å‚¨åœ¨æ ˆä¸­ï¼Œè€Œä¸”æ˜¯çœŸå®çš„å†…å®¹ã€‚ â€‹ æˆ‘ä»¬å†æ¥çœ‹â€œint weight=50ï¼›â€ï¼ŒæŒ‰ç…§åˆšæ‰çš„æ€è·¯ï¼šå­—é¢é‡ä¸º50çš„å†…å®¹åœ¨æ ˆä¸­å·²ç»å­˜åœ¨ï¼Œå› æ­¤weightæ˜¯ç›´æ¥æŒ‡å‘è¿™ä¸ªåœ°å€çš„ã€‚ç”±æ­¤å¯è§ï¼šæ ˆä¸­çš„æ•°æ®åœ¨å½“å‰çº¿ç¨‹ä¸‹æ˜¯å…±äº«çš„ã€‚ â€‹ é‚£ä¹ˆå¦‚æœå†æ‰§è¡Œä¸‹é¢çš„ä»£ç å‘¢ï¼Ÿ â€‹ weight=40ï¼› â€‹ å½“ä»£ç ä¸­é‡æ–°ç»™weightå˜é‡è¿›è¡Œèµ‹å€¼æ—¶ï¼ŒJVMä¼šå»æ ˆä¸­å¯»æ‰¾å­—é¢é‡ä¸º40çš„å†…å®¹ï¼Œå‘ç°æ²¡æœ‰ï¼Œå°±ä¼šå¼€è¾Ÿä¸€å—å†…å­˜ç©ºé—´å­˜å‚¨40è¿™ä¸ªå†…å®¹ï¼Œå¹¶ä¸”æŠŠweightæŒ‡å‘è¿™ä¸ªåœ°å€ã€‚ç”±æ­¤å¯çŸ¥ï¼š â€‹ åŸºæœ¬æ•°æ®ç±»å‹çš„æ•°æ®æœ¬èº«æ˜¯ä¸ä¼šæ”¹å˜çš„ï¼Œå½“å±€éƒ¨å˜é‡é‡æ–°èµ‹å€¼æ—¶ï¼Œå¹¶ä¸æ˜¯åœ¨å†…å­˜ä¸­æ”¹å˜å­—é¢é‡å†…å®¹ï¼Œè€Œæ˜¯é‡æ–°åœ¨æ ˆä¸­å¯»æ‰¾å·²å­˜åœ¨çš„ç›¸åŒçš„æ•°æ®ï¼Œè‹¥æ ˆä¸­ä¸å­˜åœ¨ï¼Œåˆ™é‡æ–°å¼€è¾Ÿå†…å­˜å­˜æ–°æ•°æ®ï¼Œå¹¶ä¸”æŠŠè¦é‡æ–°èµ‹å€¼çš„å±€éƒ¨å˜é‡çš„å¼•ç”¨æŒ‡å‘æ–°æ•°æ®æ‰€åœ¨åœ°å€ã€‚ B. åŸºæœ¬æ•°æ®ç±»å‹çš„æˆå‘˜å˜é‡ æˆå‘˜å˜é‡ï¼šé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯åœ¨ç±»ä½“ä¸­å®šä¹‰çš„å˜é‡ã€‚ çœ‹ä¸‹å›¾ï¼š æˆ‘ä»¬çœ‹perçš„åœ°å€æŒ‡å‘çš„æ˜¯å †å†…å­˜ä¸­çš„ä¸€å—åŒºåŸŸï¼Œæˆ‘ä»¬æ¥è¿˜åŸä¸€ä¸‹ä»£ç ï¼š public class Person{ private int age; private String name; private int grade; //çœç•¥setter getteræ–¹æ³• static void run(){ System.out.println(&quot;run....&quot;); }; } //è°ƒç”¨ Person per=new Person(); â€‹ åŒæ ·æ˜¯å±€éƒ¨å˜é‡çš„ageã€nameã€gradeå´è¢«å­˜å‚¨åˆ°äº†å †ä¸­ä¸ºperå¯¹è±¡å¼€è¾Ÿçš„ä¸€å—ç©ºé—´ä¸­ã€‚å› æ­¤å¯çŸ¥ï¼šåŸºæœ¬æ•°æ®ç±»å‹çš„æˆå‘˜å˜é‡åå’Œå€¼éƒ½å­˜å‚¨äºå †ä¸­ï¼Œå…¶ç”Ÿå‘½å‘¨æœŸå’Œå¯¹è±¡çš„æ˜¯ä¸€è‡´çš„ã€‚ C. åŸºæœ¬æ•°æ®ç±»å‹çš„é™æ€å˜é‡ â€‹ å‰é¢æåˆ°æ–¹æ³•åŒºç”¨æ¥å­˜å‚¨ä¸€äº›å…±äº«æ•°æ®ï¼Œå› æ­¤åŸºæœ¬æ•°æ®ç±»å‹çš„é™æ€å˜é‡åä»¥åŠå€¼å­˜å‚¨äºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ï¼Œé™æ€å˜é‡éšç±»åŠ è½½è€ŒåŠ è½½ï¼Œéšç±»æ¶ˆå¤±è€Œæ¶ˆå¤± å¼•ç”¨æ•°æ®ç±»å‹çš„å­˜å‚¨: ä¸Šé¢æåˆ°ï¼šå †æ˜¯ç”¨æ¥å­˜å‚¨å¯¹è±¡æœ¬èº«å’Œæ•°ç»„ï¼Œè€Œå¼•ç”¨ï¼ˆå¥æŸ„ï¼‰å­˜æ”¾çš„æ˜¯å®é™…å†…å®¹çš„åœ°å€å€¼ï¼Œå› æ­¤é€šè¿‡ä¸Šé¢çš„ç¨‹åºè¿è¡Œå›¾ï¼Œä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œå½“æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå¯¹è±¡æ—¶ Person per=new Person(); å®é™…ä¸Šï¼Œå®ƒä¹Ÿæ˜¯æœ‰ä¸¤ä¸ªè¿‡ç¨‹ï¼š Person per;//å®šä¹‰å˜é‡ per=new Person();//èµ‹å€¼ â€‹ åœ¨æ‰§è¡ŒPerson per;æ—¶ï¼ŒJVMå…ˆåœ¨è™šæ‹Ÿæœºæ ˆä¸­çš„å˜é‡è¡¨ä¸­å¼€è¾Ÿä¸€å—å†…å­˜å­˜æ”¾perå˜é‡ï¼Œåœ¨æ‰§è¡Œper=new Person()æ—¶ï¼ŒJVMä¼šåˆ›å»ºä¸€ä¸ªPersonç±»çš„å®ä¾‹å¯¹è±¡å¹¶åœ¨å †ä¸­å¼€è¾Ÿä¸€å—å†…å­˜å­˜å‚¨è¿™ä¸ªå®ä¾‹ï¼ŒåŒæ—¶æŠŠå®ä¾‹çš„åœ°å€å€¼èµ‹å€¼ç»™perå˜é‡ã€‚å› æ­¤å¯è§ï¼š å¯¹äºå¼•ç”¨æ•°æ®ç±»å‹çš„å¯¹è±¡/æ•°ç»„ï¼Œå˜é‡åå­˜åœ¨æ ˆä¸­ï¼Œå˜é‡å€¼å­˜å‚¨çš„æ˜¯å¯¹è±¡çš„åœ°å€ï¼Œå¹¶ä¸æ˜¯å¯¹è±¡çš„å®é™…å†…å®¹ã€‚ å€¼ä¼ é€’å’Œå¼•ç”¨ä¼ é€’ â€‹ å‰é¢å·²ç»ä»‹ç»è¿‡å½¢å‚å’Œå®å‚ï¼Œä¹Ÿä»‹ç»äº†æ•°æ®ç±»å‹ä»¥åŠæ•°æ®åœ¨å†…å­˜ä¸­çš„å­˜å‚¨å½¢å¼ï¼Œæ¥ä¸‹æ¥ï¼Œå°±æ˜¯æ–‡ç« çš„ä¸»é¢˜ï¼šå€¼ä¼ é€’å’Œå¼•ç”¨çš„ä¼ é€’ã€‚ å€¼ä¼ é€’ï¼š åœ¨æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå®å‚é€šè¿‡å½¢å‚æŠŠå®ƒçš„å†…å®¹å‰¯æœ¬ä¼ å…¥æ–¹æ³•å†…éƒ¨ï¼Œæ­¤æ—¶å½¢å‚æ¥æ”¶åˆ°çš„å†…å®¹æ˜¯å®å‚å€¼çš„ä¸€ä¸ªæ‹·è´ï¼Œå› æ­¤åœ¨æ–¹æ³•å†…å¯¹å½¢å‚çš„ä»»ä½•æ“ä½œï¼Œéƒ½ä»…ä»…æ˜¯å¯¹è¿™ä¸ªå‰¯æœ¬çš„æ“ä½œï¼Œä¸å½±å“åŸå§‹å€¼çš„å†…å®¹ã€‚ æ¥çœ‹ä¸ªä¾‹å­ï¼š public static void valueCrossTest(int age,float weight){ System.out.println(&quot;ä¼ å…¥çš„ageï¼š&quot;+age); System.out.println(&quot;ä¼ å…¥çš„weightï¼š&quot;+weight); age=33; weight=89.5f; System.out.println(&quot;æ–¹æ³•å†…é‡æ–°èµ‹å€¼åçš„ageï¼š&quot;+age); System.out.println(&quot;æ–¹æ³•å†…é‡æ–°èµ‹å€¼åçš„weightï¼š&quot;+weight); } //æµ‹è¯• public static void main(String[] args) { int a=25; float w=77.5f; valueCrossTest(a,w); System.out.println(&quot;æ–¹æ³•æ‰§è¡Œåçš„ageï¼š&quot;+a); System.out.println(&quot;æ–¹æ³•æ‰§è¡Œåçš„weightï¼š&quot;+w); } è¾“å‡ºç»“æœï¼š ä¼ å…¥çš„ageï¼š25 ä¼ å…¥çš„weightï¼š77.5 æ–¹æ³•å†…é‡æ–°èµ‹å€¼åçš„ageï¼š33 æ–¹æ³•å†…é‡æ–°èµ‹å€¼åçš„weightï¼š89.5 æ–¹æ³•æ‰§è¡Œåçš„ageï¼š25 æ–¹æ³•æ‰§è¡Œåçš„weightï¼š77.5 ä»ä¸Šé¢çš„æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼š aå’Œwä½œä¸ºå®å‚ä¼ å…¥valueCrossTestä¹‹åï¼Œæ— è®ºåœ¨æ–¹æ³•å†…åšäº†ä»€ä¹ˆæ“ä½œï¼Œæœ€ç»ˆaå’Œwéƒ½æ²¡å˜åŒ–ã€‚ è¿™æ˜¯ä»€ä¹ˆé€ å‹å‘¢ï¼Ÿï¼ï¼ ä¸‹é¢æˆ‘ä»¬æ ¹æ®ä¸Šé¢å­¦åˆ°çš„çŸ¥è¯†ç‚¹ï¼Œè¿›è¡Œè¯¦ç»†çš„åˆ†æï¼š é¦–å…ˆç¨‹åºè¿è¡Œæ—¶ï¼Œè°ƒç”¨mian()æ–¹æ³•ï¼Œæ­¤æ—¶JVMä¸ºmain()æ–¹æ³•å¾€è™šæ‹Ÿæœºæ ˆä¸­å‹å…¥ä¸€ä¸ªæ ˆå¸§ï¼Œå³ä¸ºå½“å‰æ ˆå¸§ï¼Œç”¨æ¥å­˜æ”¾main()ä¸­çš„å±€éƒ¨å˜é‡è¡¨(åŒ…æ‹¬å‚æ•°)ã€æ“ä½œæ ˆã€æ–¹æ³•å‡ºå£ç­‰ä¿¡æ¯ï¼Œå¦‚aå’Œwéƒ½æ˜¯mian()æ–¹æ³•ä¸­çš„å±€éƒ¨å˜é‡ï¼Œå› æ­¤å¯ä»¥æ–­å®šï¼Œaå’Œwæ˜¯èººç€mianæ–¹æ³•æ‰€åœ¨çš„æ ˆå¸§ä¸­ å¦‚å›¾ï¼š è€Œå½“æ‰§è¡Œåˆ°valueCrossTest()æ–¹æ³•æ—¶ï¼ŒJVMä¹Ÿä¸ºå…¶å¾€è™šæ‹Ÿæœºæ ˆä¸­å‹å…¥ä¸€ä¸ªæ ˆï¼Œå³ä¸ºå½“å‰æ ˆå¸§ï¼Œç”¨æ¥å­˜æ”¾valueCrossTest()ä¸­çš„å±€éƒ¨å˜é‡ç­‰ä¿¡æ¯ï¼Œå› æ­¤ageå’Œweightæ˜¯èººç€valueCrossTestæ–¹æ³•æ‰€åœ¨çš„æ ˆå¸§ä¸­ï¼Œè€Œä»–ä»¬çš„å€¼æ˜¯ä»aå’Œwçš„å€¼copyäº†ä¸€ä»½å‰¯æœ¬è€Œå¾—ï¼Œå¦‚å›¾ï¼š å› è€Œå¯ä»¥aå’Œageã€wå’Œweightå¯¹åº”çš„å†…å®¹æ˜¯ä¸ä¸€è‡´çš„ï¼Œæ‰€ä»¥å½“åœ¨æ–¹æ³•å†…é‡æ–°èµ‹å€¼æ—¶ï¼Œå®é™…æµç¨‹å¦‚å›¾ï¼š ä¹Ÿå°±æ˜¯è¯´ï¼Œageå’Œweightçš„æ”¹åŠ¨ï¼Œåªæ˜¯æ”¹å˜äº†å½“å‰æ ˆå¸§ï¼ˆvalueCrossTestæ–¹æ³•æ‰€åœ¨æ ˆå¸§ï¼‰é‡Œçš„å†…å®¹ï¼Œå½“æ–¹æ³•æ‰§è¡Œç»“æŸä¹‹åï¼Œè¿™äº›å±€éƒ¨å˜é‡éƒ½ä¼šè¢«é”€æ¯ï¼Œmianæ–¹æ³•æ‰€åœ¨æ ˆå¸§é‡æ–°å›åˆ°æ ˆé¡¶ï¼Œæˆä¸ºå½“å‰æ ˆå¸§ï¼Œå†æ¬¡è¾“å‡ºaå’Œwæ—¶ï¼Œä¾ç„¶æ˜¯åˆå§‹åŒ–æ—¶çš„å†…å®¹ã€‚ å› æ­¤ï¼š å€¼ä¼ é€’ä¼ é€’çš„æ˜¯çœŸå®å†…å®¹çš„ä¸€ä¸ªå‰¯æœ¬ï¼Œå¯¹å‰¯æœ¬çš„æ“ä½œä¸å½±å“åŸå†…å®¹ï¼Œä¹Ÿå°±æ˜¯å½¢å‚æ€ä¹ˆå˜åŒ–ï¼Œä¸ä¼šå½±å“å®å‚å¯¹åº”çš„å†…å®¹ã€‚ å¼•ç”¨ä¼ é€’ï¼š â€‹ â€å¼•ç”¨â€ä¹Ÿå°±æ˜¯æŒ‡å‘çœŸå®å†…å®¹çš„åœ°å€å€¼ï¼Œåœ¨æ–¹æ³•è°ƒç”¨æ—¶ï¼Œå®å‚çš„åœ°å€é€šè¿‡æ–¹æ³•è°ƒç”¨è¢«ä¼ é€’ç»™ç›¸åº”çš„å½¢å‚ï¼Œåœ¨æ–¹æ³•ä½“å†…ï¼Œå½¢å‚å’Œå®å‚æŒ‡å‘åŒä¸€å—å†…å­˜åœ°å€ï¼Œå¯¹å½¢å‚çš„æ“ä½œä¼šå½±å“çš„çœŸå®å†…å®¹ã€‚ ä¸¾ä¸ªæ —å­ï¼š å…ˆå®šä¹‰ä¸€ä¸ªå¯¹è±¡ï¼š public class Person { private String name; private int age; public String getName() { return name; } public void setName(String name) { this.name = name; } public int getAge() { return age; } public void setAge(int age) { this.age = age; } } æˆ‘ä»¬å†™ä¸ªå‡½æ•°æµ‹è¯•ä¸€ä¸‹ï¼š public static void PersonCrossTest(Person person){ System.out.println(&quot;ä¼ å…¥çš„personçš„nameï¼š&quot;+person.getName()); person.setName(&quot;æˆ‘æ˜¯å¼ ä¸‰&quot;); System.out.println(&quot;æ–¹æ³•å†…é‡æ–°èµ‹å€¼åçš„nameï¼š&quot;+person.getName()); } //æµ‹è¯• public static void main(String[] args) { Person p=new Person(); p.setName(&quot;æˆ‘æ˜¯æå››&quot;); p.setAge(45); PersonCrossTest(p); System.out.println(&quot;æ–¹æ³•æ‰§è¡Œåçš„nameï¼š&quot;+p.getName()); } è¾“å‡ºç»“æœï¼š ä¼ å…¥çš„personçš„nameï¼šæˆ‘æ˜¯æå›› æ–¹æ³•å†…é‡æ–°èµ‹å€¼åçš„nameï¼šæˆ‘æ˜¯å¼ ä¸‰ æ–¹æ³•æ‰§è¡Œåçš„nameï¼šæˆ‘æ˜¯å¼ ä¸‰ å¯ä»¥çœ‹å‡ºï¼Œpersonç»è¿‡personCrossTest()æ–¹æ³•çš„æ‰§è¡Œä¹‹åï¼Œå†…å®¹å‘ç”Ÿäº†æ”¹å˜ï¼Œè¿™å°è¯äº†ä¸Šé¢æ‰€è¯´çš„â€œå¼•ç”¨ä¼ é€’â€ï¼Œå¯¹å½¢å‚çš„æ“ä½œï¼Œæ”¹å˜äº†å®é™…å¯¹è±¡çš„å†…å®¹ã€‚ é‚£ä¹ˆï¼Œåˆ°è¿™é‡Œå°±ç»“é¢˜äº†å—ï¼Ÿ ä¸æ˜¯çš„ï¼Œæ²¡é‚£ä¹ˆç®€å•ï¼Œ èƒ½çœ‹å¾—åˆ°æƒ³è¦çš„æ•ˆæœ æ˜¯å› ä¸ºåˆšå¥½é€‰å¯¹äº†ä¾‹å­è€Œå·²ï¼ï¼ï¼ ä¸‹é¢æˆ‘ä»¬å¯¹ä¸Šé¢çš„ä¾‹å­ç¨ä½œä¿®æ”¹ï¼ŒåŠ ä¸Šä¸€è¡Œä»£ç ï¼Œ public static void PersonCrossTest(Person person){ System.out.println(&quot;ä¼ å…¥çš„personçš„nameï¼š&quot;+person.getName()); person=new Person();//åŠ å¤šæ­¤è¡Œä»£ç  person.setName(&quot;æˆ‘æ˜¯å¼ ä¸‰&quot;); System.out.println(&quot;æ–¹æ³•å†…é‡æ–°èµ‹å€¼åçš„nameï¼š&quot;+person.getName()); } è¾“å‡ºç»“æœï¼š ä¼ å…¥çš„personçš„nameï¼šæˆ‘æ˜¯æå›› æ–¹æ³•å†…é‡æ–°èµ‹å€¼åçš„nameï¼šæˆ‘æ˜¯å¼ ä¸‰ æ–¹æ³•æ‰§è¡Œåçš„nameï¼šæˆ‘æ˜¯æå›› ä¸ºä»€ä¹ˆè¿™æ¬¡çš„è¾“å‡ºå’Œä¸Šæ¬¡çš„ä¸ä¸€æ ·äº†å‘¢ï¼Ÿ çœ‹å‡ºä»€ä¹ˆé—®é¢˜äº†å—ï¼Ÿ æŒ‰ç…§ä¸Šé¢è®²åˆ°JVMå†…å­˜æ¨¡å‹å¯ä»¥çŸ¥é“ï¼Œå¯¹è±¡å’Œæ•°ç»„æ˜¯å­˜å‚¨åœ¨Javaå †åŒºçš„ï¼Œè€Œä¸”å †åŒºæ˜¯å…±äº«çš„ï¼Œå› æ­¤ç¨‹åºæ‰§è¡Œåˆ°mainï¼ˆï¼‰æ–¹æ³•ä¸­çš„ä¸‹åˆ—ä»£ç æ—¶ Person p=new Person(); p.setName(&quot;æˆ‘æ˜¯æå››&quot;); p.setAge(45); PersonCrossTest(p); JVMä¼šåœ¨å †å†…å¼€è¾Ÿä¸€å—å†…å­˜ï¼Œç”¨æ¥å­˜å‚¨på¯¹è±¡çš„æ‰€æœ‰å†…å®¹ï¼ŒåŒæ—¶åœ¨mainï¼ˆï¼‰æ–¹æ³•æ‰€åœ¨çº¿ç¨‹çš„æ ˆåŒºä¸­åˆ›å»ºä¸€ä¸ªå¼•ç”¨på­˜å‚¨å †åŒºä¸­på¯¹è±¡çš„çœŸå®åœ°å€ï¼Œå¦‚å›¾ï¼š å½“æ‰§è¡Œåˆ°PersonCrossTest()æ–¹æ³•æ—¶ï¼Œå› ä¸ºæ–¹æ³•å†…æœ‰è¿™ä¹ˆä¸€è¡Œä»£ç ï¼š person=new Person(); JVMéœ€è¦åœ¨å †å†…å¦å¤–å¼€è¾Ÿä¸€å—å†…å­˜æ¥å­˜å‚¨new Person()ï¼Œå‡å¦‚åœ°å€ä¸ºâ€œxo3333â€ï¼Œé‚£æ­¤æ—¶å½¢å‚personæŒ‡å‘äº†è¿™ä¸ªåœ°å€ï¼Œå‡å¦‚çœŸçš„æ˜¯å¼•ç”¨ä¼ é€’ï¼Œé‚£ä¹ˆç”±ä¸Šé¢è®²åˆ°ï¼šå¼•ç”¨ä¼ é€’ä¸­å½¢å‚å®å‚æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼Œå½¢å‚çš„æ“ä½œä¼šæ”¹å˜å®å‚å¯¹è±¡çš„æ”¹å˜ã€‚ å¯ä»¥æ¨å‡ºï¼šå®å‚ä¹Ÿåº”è¯¥æŒ‡å‘äº†æ–°åˆ›å»ºçš„personå¯¹è±¡çš„åœ°å€ï¼Œæ‰€ä»¥åœ¨æ‰§è¡ŒPersonCrossTest()ç»“æŸä¹‹åï¼Œæœ€ç»ˆè¾“å‡ºçš„åº”è¯¥æ˜¯åé¢åˆ›å»ºçš„å¯¹è±¡å†…å®¹ã€‚ ç„¶è€Œå®é™…ä¸Šï¼Œæœ€ç»ˆçš„è¾“å‡ºç»“æœå´è·Ÿæˆ‘ä»¬æ¨æµ‹çš„ä¸ä¸€æ ·ï¼Œæœ€ç»ˆè¾“å‡ºçš„ä»ç„¶æ˜¯ä¸€å¼€å§‹åˆ›å»ºçš„å¯¹è±¡çš„å†…å®¹ã€‚ ç”±æ­¤å¯è§ï¼šå¼•ç”¨ä¼ é€’ï¼Œåœ¨Javaä¸­å¹¶ä¸å­˜åœ¨ã€‚ ä½†æ˜¯æœ‰äººä¼šç–‘é—®ï¼šä¸ºä»€ä¹ˆç¬¬ä¸€ä¸ªä¾‹å­ä¸­ï¼Œåœ¨æ–¹æ³•å†…ä¿®æ”¹äº†å½¢å‚çš„å†…å®¹ï¼Œä¼šå¯¼è‡´åŸå§‹å¯¹è±¡çš„å†…å®¹å‘ç”Ÿæ”¹å˜å‘¢ï¼Ÿ è¿™æ˜¯å› ä¸ºï¼šæ— è®ºæ˜¯åŸºæœ¬ç±»å‹å’Œæ˜¯å¼•ç”¨ç±»å‹ï¼Œåœ¨å®å‚ä¼ å…¥å½¢å‚æ—¶ï¼Œéƒ½æ˜¯å€¼ä¼ é€’ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼ é€’çš„éƒ½æ˜¯ä¸€ä¸ªå‰¯æœ¬ï¼Œè€Œä¸æ˜¯å†…å®¹æœ¬èº«ã€‚ æœ‰å›¾å¯ä»¥çœ‹å‡ºï¼Œæ–¹æ³•å†…çš„å½¢å‚personå’Œå®å‚på¹¶æ— å®è´¨å…³è”ï¼Œå®ƒåªæ˜¯ç”±på¤„copyäº†ä¸€ä»½æŒ‡å‘å¯¹è±¡çš„åœ°å€ï¼Œæ­¤æ—¶ï¼š på’Œpersonéƒ½æ˜¯æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ã€‚ å› æ­¤åœ¨ç¬¬ä¸€ä¸ªä¾‹å­ä¸­ï¼Œå¯¹å½¢å‚pçš„æ“ä½œï¼Œä¼šå½±å“åˆ°å®å‚å¯¹åº”çš„å¯¹è±¡å†…å®¹ã€‚è€Œåœ¨ç¬¬äºŒä¸ªä¾‹å­ä¸­ï¼Œå½“æ‰§è¡Œåˆ°new Person()ä¹‹åï¼ŒJVMåœ¨å †å†…å¼€è¾Ÿä¸€å—ç©ºé—´å­˜å‚¨æ–°å¯¹è±¡ï¼Œå¹¶ä¸”æŠŠpersonæ”¹æˆæŒ‡å‘æ–°å¯¹è±¡çš„åœ°å€ï¼Œæ­¤æ—¶ï¼š pä¾æ—§æ˜¯æŒ‡å‘æ—§çš„å¯¹è±¡ï¼ŒpersonæŒ‡å‘æ–°å¯¹è±¡çš„åœ°å€ã€‚ æ‰€ä»¥æ­¤æ—¶å¯¹personçš„æ“ä½œï¼Œå®é™…ä¸Šæ˜¯å¯¹æ–°å¯¹è±¡çš„æ“ä½œï¼Œäºå®å‚pä¸­å¯¹åº”çš„å¯¹è±¡æ¯«æ— å…³ç³»ã€‚ ç»“è¯­ å› æ­¤å¯è§ï¼šåœ¨Javaä¸­æ‰€æœ‰çš„å‚æ•°ä¼ é€’ï¼Œä¸ç®¡åŸºæœ¬ç±»å‹è¿˜æ˜¯å¼•ç”¨ç±»å‹ï¼Œéƒ½æ˜¯å€¼ä¼ é€’ï¼Œæˆ–è€…è¯´æ˜¯å‰¯æœ¬ä¼ é€’ã€‚ åªæ˜¯åœ¨ä¼ é€’è¿‡ç¨‹ä¸­ï¼š å¦‚æœæ˜¯å¯¹åŸºæœ¬æ•°æ®ç±»å‹çš„æ•°æ®è¿›è¡Œæ“ä½œï¼Œç”±äºåŸå§‹å†…å®¹å’Œå‰¯æœ¬éƒ½æ˜¯å­˜å‚¨å®é™…å€¼ï¼Œå¹¶ä¸”æ˜¯åœ¨ä¸åŒçš„æ ˆåŒºï¼Œå› æ­¤å½¢å‚çš„æ“ä½œï¼Œä¸å½±å“åŸå§‹å†…å®¹ã€‚ å¦‚æœæ˜¯å¯¹å¼•ç”¨ç±»å‹çš„æ•°æ®è¿›è¡Œæ“ä½œï¼Œåˆ†ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯å½¢å‚å’Œå®å‚ä¿æŒæŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡åœ°å€ï¼Œåˆ™å½¢å‚çš„æ“ä½œï¼Œä¼šå½±å“å®å‚æŒ‡å‘çš„å¯¹è±¡çš„å†…å®¹ã€‚ä¸€ç§æ˜¯å½¢å‚è¢«æ”¹åŠ¨æŒ‡å‘æ–°çš„å¯¹è±¡åœ°å€ï¼ˆå¦‚é‡æ–°èµ‹å€¼å¼•ç”¨ï¼‰ï¼Œåˆ™å½¢å‚çš„æ“ä½œï¼Œä¸ä¼šå½±å“å®å‚æŒ‡å‘çš„å¯¹è±¡çš„å†…å®¹ã€‚ ","link":"https://tianxiawuhao.github.io/nRZ1sLPT7/"},{"title":"é™„å½• kafkaå¸¸è§é¢è¯•é—®é¢˜æ±‡æ€»","content":"åŸºç¡€é¢˜ç›® 1ã€Apache Kafka æ˜¯ä»€ä¹ˆ? Apach Kafka æ˜¯ä¸€æ¬¾åˆ†å¸ƒå¼æµå¤„ç†æ¡†æ¶ï¼Œç”¨äºå®æ—¶æ„å»ºæµå¤„ç†åº”ç”¨ã€‚å®ƒæœ‰ä¸€ä¸ªæ ¸å¿ƒ çš„åŠŸèƒ½å¹¿ä¸ºäººçŸ¥ï¼Œå³ä½œä¸ºä¼ä¸šçº§çš„æ¶ˆæ¯å¼•æ“è¢«å¹¿æ³›ä½¿ç”¨ã€‚ ä½ ä¸€å®šè¦å…ˆæ˜ç¡®å®ƒçš„æµå¤„ç†æ¡†æ¶åœ°ä½ï¼Œè¿™æ ·èƒ½ç»™é¢è¯•å®˜ç•™ ä¸‹ä¸€ä¸ªå¾ˆä¸“ä¸šçš„å°è±¡ã€‚ 2ã€ä»€ä¹ˆæ˜¯æ¶ˆè´¹è€…ç»„? æ¶ˆè´¹è€…ç»„æ˜¯ Kafka ç‹¬æœ‰çš„æ¦‚å¿µï¼Œå¦‚æœé¢è¯•å®˜é—®è¿™ ä¸ªï¼Œå°±è¯´æ˜ä»–å¯¹æ­¤æ˜¯æœ‰ä¸€å®šäº†è§£çš„ã€‚æˆ‘å…ˆç»™å‡ºæ ‡å‡†ç­”æ¡ˆï¼š 1ã€å®šä¹‰ï¼šå³æ¶ˆè´¹è€…ç»„æ˜¯ Kafka æä¾›çš„å¯æ‰©å±•ä¸”å…·æœ‰å®¹é”™æ€§çš„æ¶ˆè´¹è€…æœºåˆ¶ã€‚ 2ã€åŸç†ï¼šåœ¨ Kafka ä¸­ï¼Œæ¶ˆè´¹è€…ç»„æ˜¯ä¸€ä¸ªç”±å¤šä¸ªæ¶ˆè´¹è€…å®ä¾‹ æ„æˆçš„ç»„ã€‚å¤šä¸ªå®ä¾‹å…±åŒè®¢é˜…è‹¥å¹²ä¸ªä¸»é¢˜ï¼Œå®ç°å…±åŒæ¶ˆè´¹ã€‚åŒä¸€ä¸ªç»„ä¸‹çš„æ¯ä¸ªå®ä¾‹éƒ½é…ç½®æœ‰ ç›¸åŒçš„ç»„ IDï¼Œè¢«åˆ†é…ä¸åŒçš„è®¢é˜…åˆ†åŒºã€‚å½“æŸä¸ªå®ä¾‹æŒ‚æ‰çš„æ—¶å€™ï¼Œå…¶ä»–å®ä¾‹ä¼šè‡ªåŠ¨åœ°æ‰¿æ‹…èµ· å®ƒè´Ÿè´£æ¶ˆè´¹çš„åˆ†åŒºã€‚ æ­¤æ—¶ï¼Œåˆæœ‰ä¸€ä¸ªå°æŠ€å·§ç»™åˆ°ä½ :æ¶ˆè´¹è€…ç»„çš„é¢˜ç›®ï¼Œèƒ½å¤Ÿå¸®ä½ åœ¨æŸç§ç¨‹åº¦ä¸ŠæŒæ§ä¸‹é¢çš„é¢è¯•æ–¹å‘ã€‚ 2.1æ¶ˆè´¹è€…ç»„çš„ä½ç§»æäº¤æœºåˆ¶ brokerç»´æŠ¤æ¶ˆè´¹è€…çš„æ¶ˆè´¹ä½ç§»ä¿¡æ¯ï¼Œè€çš„ç‰ˆæœ¬å­˜å‚¨åœ¨zkä¸Šï¼Œæ–°ç‰ˆæœ¬å­˜å‚¨åœ¨å†…éƒ¨çš„topicé‡Œã€‚æœ¬è´¨ä¸Šï¼Œä½ç§»ä¿¡æ¯æ¶ˆè´¹è€…è‡ªå·±ç»´æŠ¤ä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯å¦‚æœæ¶ˆè´¹è€…æŒ‚äº†æˆ–è€…é‡å¯ï¼Œå¯¹äºæŸä¸€ä¸ªåˆ†åŒºçš„æ¶ˆè´¹ä½ç§»ä¸å°±ä¸¢å¤±äº†å—ï¼Ÿæ‰€ä»¥ï¼Œè¿˜æ˜¯éœ€è¦æäº¤åˆ°brokerç«¯åšæŒä¹…åŒ–çš„ã€‚ 2.2æ¶ˆè´¹è€…ç»„ä¸ Broker ä¹‹é—´çš„äº¤äº’ Kafkaä¸­æ¶ˆè´¹è€…çš„æ¶ˆè´¹æ–¹å¼ consumeré‡‡ç”¨pull(æ‹‰)æ¨¡å¼ä»brokerä¸­è¯»å–æ•°æ®ã€‚ æ‹‰å–æ¨¡å¼ä¹Ÿæœ‰ä¸è¶³ï¼Œå¦‚æœkafkaæ²¡æœ‰æ•°æ®ï¼Œæ¶ˆè´¹è€…å¯èƒ½ä¼šé™·å…¥å¾ªç¯ä¸­ï¼Œä¸€ç›´è¿”å›ç©ºæ•°æ®ã€‚é’ˆå¯¹è¿™ä¸€ç‚¹ï¼Œkafkaæ¶ˆè´¹è€…åœ¨æ¶ˆè´¹æ•°æ®æ—¶ä¼šä¼ å…¥ä¸€ä¸ªæ—¶é•¿å‚æ•°timeoutï¼Œå¦‚æœå½“å‰æ²¡æœ‰æ•°æ®å¯ä¾›æ¶ˆè´¹ï¼Œconsumerä¼šç­‰å¾…ä¸€æ®µæ—¶é—´åå†è¿”å›ï¼Œè¿™æ®µæ—¶é•¿å³ä¸ºtimeout Kafkaçš„åˆ†åŒºåˆ†é…ç­–ç•¥ ä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸­æœ‰å¤šä¸ªæ¶ˆè´¹è€…ï¼Œä¸€ä¸ªbrokeræœ‰å¤šä¸ªåˆ†åŒºï¼Œæ‰€æœ‰å¿…ç„¶ä¼šæ¶‰åŠåˆ°åˆ†åŒºåˆ†é…é—®é¢˜ï¼Œå³ç¡®å®šå“ªä¸€ä¸ªåˆ†åŒºç”±å“ªä¸€ä¸ªconsumeræ¥æ¶ˆè´¹ã€‚kafkaæœ‰ä¸¤ç§åˆ†åŒºåˆ†é…ç­–ç•¥ï¼šRoundRobinå’ŒRange 1ï¼‰ RoundRobin æŒ‰ç…§æ¶ˆè´¹è€…ç»„åˆ’åˆ†ï¼Œå°†æ¶ˆè´¹è€…ç»„ä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œè¦æ±‚æ•´ä¸ªæ¶ˆè´¹è€…ç»„å†…çš„æ¶ˆè´¹è€…è®¢é˜…ç›¸åŒçš„ä¸»é¢˜ï¼Œå¦åˆ™ä¼šå¯¼è‡´é”™è¯¯çš„åˆ†é…çš„é—®é¢˜ã€‚ 2ï¼‰ Range ï¼ˆé»˜è®¤ï¼‰ æŒ‰ç…§å•ä¸ªä¸»é¢˜åˆ’åˆ†ï¼Œå¯èƒ½å¯¼è‡´æ¶ˆè´¹è€…æ¶ˆè´¹åˆ†åŒºä¸ªæ•°ä¸å¯¹ç­‰çš„é—®é¢˜ï¼› offsetçš„ç»´æŠ¤ ç”±äºkafkaå¯èƒ½å‡ºç°æ•…éšœï¼Œæ•…éšœä¹‹åè¦æ¢å¤åˆ°ä¸Šä¸€æ¬¡æ¶ˆè´¹çš„ä½ç½®ï¼Œå¾€ä¸‹ç»§ç»­è¿›è¡Œæ¶ˆè´¹ã€‚å› æ­¤consumeréœ€è¦å®æ—¶è®°å½•è‡ªå·±æ¶ˆè´¹åˆ°äº†å“ªä¸€ä¸ªoffsetï¼Œä»0.9ç‰ˆæœ¬å¼€å§‹ï¼Œconsumeré»˜è®¤å°†offsetä¿å­˜åœ¨kafkaçš„å†…ç½®topicä¸­ï¼Œè¯¥topicä¸º_consumer_offsetsï¼ˆ0.9ç‰ˆæœ¬å‰æ”¾åœ¨zookeeperä¸­ï¼‰ 3ã€åœ¨ Kafka ä¸­ï¼ŒZooKeeper çš„ä½œç”¨æ˜¯ä»€ä¹ˆ? ç›®å‰ï¼ŒKafka ä½¿ç”¨ ZooKeeper å­˜æ”¾é›†ç¾¤å…ƒæ•°æ®ã€æˆå‘˜ç®¡ç†ã€Controller é€‰ä¸¾ï¼Œä»¥åŠå…¶ä»–ä¸€äº›ç®¡ç†ç±»ä»»åŠ¡ã€‚ä¹‹åï¼Œç­‰ KIP-500 ææ¡ˆå®Œæˆåï¼ŒKafka å°†å®Œå…¨ä¸å†ä¾èµ– äº ZooKeeperã€‚ è®°ä½ï¼Œä¸€å®šè¦çªå‡ºâ€œç›®å‰â€ï¼Œä»¥å½°æ˜¾ä½ éå¸¸äº†è§£ç¤¾åŒºçš„æ¼”è¿›è®¡åˆ’ã€‚â€œå­˜æ”¾å…ƒæ•°æ®â€æ˜¯æŒ‡ä¸»é¢˜ åˆ†åŒºçš„æ‰€æœ‰æ•°æ®éƒ½ä¿å­˜åœ¨ ZooKeeper ä¸­ï¼Œä¸”ä»¥å®ƒä¿å­˜çš„æ•°æ®ä¸ºæƒå¨ï¼Œå…¶ä»–â€œäººâ€éƒ½è¦ä¸å®ƒ ä¿æŒå¯¹é½ã€‚â€œæˆå‘˜ç®¡ç†â€æ˜¯æŒ‡ Broker èŠ‚ç‚¹çš„æ³¨å†Œã€æ³¨é”€ä»¥åŠå±æ€§å˜æ›´ï¼Œç­‰ ç­‰ã€‚â€œController é€‰ä¸¾â€æ˜¯æŒ‡é€‰ä¸¾é›†ç¾¤ Controllerï¼Œè€Œå…¶ä»–ç®¡ç†ç±»ä»»åŠ¡åŒ…æ‹¬ä½†ä¸é™äºä¸»é¢˜ åˆ é™¤ã€å‚æ•°é…ç½®ç­‰ã€‚ ä¸è¿‡ï¼ŒæŠ›å‡º KIP-500 ä¹Ÿå¯èƒ½æ˜¯ä¸ªåŒåˆƒå‰‘ã€‚ç¢°åˆ°éå¸¸èµ„æ·±çš„é¢è¯•å®˜ï¼Œä»–å¯èƒ½ä¼šè¿›ä¸€æ­¥è¿½é—®ä½  KIP-500 æ˜¯æ€ä¹ˆåšçš„ã€‚ä¸€è¨€ä»¥è”½ä¹‹:KIP-500 æ€æƒ³ï¼Œæ˜¯ä½¿ç”¨ç¤¾åŒºè‡ªç ”çš„åŸºäº Raft çš„å…±è¯†ç®—æ³•ï¼Œ æ›¿ä»£ ZooKeeperï¼Œå®ç° Controller è‡ªé€‰ä¸¾ã€‚ 4ã€è§£é‡Šä¸‹ Kafka ä¸­ä½ç§»(offset)çš„ä½œç”¨ åœ¨ Kafka ä¸­ï¼Œæ¯ä¸ª ä¸»é¢˜åˆ†åŒºä¸‹çš„æ¯æ¡æ¶ˆæ¯éƒ½è¢«èµ‹äºˆäº†ä¸€ä¸ªå”¯ä¸€çš„ ID æ•°å€¼ï¼Œç”¨äºæ ‡è¯†å®ƒåœ¨åˆ†åŒºä¸­çš„ä½ç½®ã€‚è¿™ä¸ª ID æ•°å€¼ï¼Œå°±è¢«ç§°ä¸ºä½ç§»ï¼Œæˆ–è€…å«åç§»é‡ã€‚ä¸€æ—¦æ¶ˆæ¯è¢«å†™å…¥åˆ°åˆ†åŒºæ—¥å¿—ï¼Œå®ƒçš„ä½ç§»å€¼å°†ä¸èƒ½ è¢«ä¿®æ”¹ã€‚ ç­”å®Œè¿™äº›ä¹‹åï¼Œä½ è¿˜å¯ä»¥æŠŠæ•´ä¸ªé¢è¯•æ–¹å‘è½¬ç§»åˆ°ä½ å¸Œæœ›çš„åœ°æ–¹ã€‚å¸¸è§æ–¹æ³•æœ‰ä»¥ä¸‹ 3 ç§: å¦‚æœä½ æ·±è°™ Broker åº•å±‚æ—¥å¿—å†™å…¥çš„é€»è¾‘ï¼Œå¯ä»¥å¼ºè°ƒä¸‹æ¶ˆæ¯åœ¨æ—¥å¿—ä¸­çš„å­˜æ”¾æ ¼å¼; å¦‚æœä½ æ˜ç™½ä½ç§»å€¼ä¸€æ—¦è¢«ç¡®å®šä¸èƒ½ä¿®æ”¹ï¼Œå¯ä»¥å¼ºè°ƒä¸‹â€œLog Cleaner ç»„ä»¶éƒ½ä¸èƒ½å½±å“ä½ ç§»å€¼â€è¿™ä»¶äº‹æƒ…; å¦‚æœä½ å¯¹æ¶ˆè´¹è€…çš„æ¦‚å¿µè¿˜ç®—ç†Ÿæ‚‰ï¼Œå¯ä»¥å†è¯¦ç»†è¯´è¯´ä½ç§»å€¼å’Œæ¶ˆè´¹è€…ä½ç§»å€¼ä¹‹é—´çš„åŒºåˆ«ã€‚ 5ã€Partitionçš„Leader Replicaå’ŒFollower Replicaçš„åŒºåˆ« è¿™é“é¢˜è¡¨é¢ä¸Šæ˜¯è€ƒæ ¸ä½ å¯¹ Leader å’Œ Follower åŒºåˆ«çš„ç†è§£ï¼Œä½†å¾ˆå®¹æ˜“å¼•ç”³åˆ° Kafka çš„åŒæ­¥ æœºåˆ¶ä¸Šã€‚å› æ­¤ï¼Œæˆ‘å»ºè®®ä½ ä¸»åŠ¨å‡ºå‡»ï¼Œä¸€æ¬¡æ€§åœ°æŠŠéšå«çš„è€ƒç‚¹ä¹Ÿç­”å‡ºæ¥ï¼Œä¹Ÿè®¸èƒ½å¤Ÿæš‚æ—¶æŠŠé¢è¯• å®˜â€œå”¬ä½â€ï¼Œå¹¶ä½“ç°ä½ çš„ä¸“ä¸šæ€§ã€‚ ä½ å¯ä»¥è¿™ä¹ˆå›ç­”:Kafka å‰¯æœ¬å½“å‰åˆ†ä¸ºé¢†å¯¼è€…å‰¯æœ¬å’Œè¿½éšè€…å‰¯æœ¬ã€‚åªæœ‰ Leader å‰¯æœ¬æ‰èƒ½ å¯¹å¤–æä¾›è¯»å†™æœåŠ¡ï¼Œå“åº” Clients ç«¯çš„è¯·æ±‚ã€‚Follower å‰¯æœ¬åªæ˜¯é‡‡ç”¨æ‹‰(PULL)çš„æ–¹ å¼ï¼Œè¢«åŠ¨åœ°åŒæ­¥ Leader å‰¯æœ¬ä¸­çš„æ•°æ®ï¼Œå¹¶ä¸”åœ¨ Leader å‰¯æœ¬æ‰€åœ¨çš„ Broker å®•æœºåï¼Œéšæ—¶ å‡†å¤‡åº”è˜ Leader å‰¯æœ¬ã€‚ é€šå¸¸æ¥è¯´ï¼Œå›ç­”åˆ°è¿™ä¸ªç¨‹åº¦ï¼Œå…¶å®æ‰åªè¯´äº† 60%ï¼Œå› æ­¤ï¼Œæˆ‘å»ºè®®ä½ å†å›ç­”ä¸¤ä¸ªé¢å¤–çš„åŠ åˆ† é¡¹ã€‚ å¼ºè°ƒ Follower å‰¯æœ¬ä¹Ÿèƒ½å¯¹å¤–æä¾›è¯»æœåŠ¡ã€‚è‡ª Kafka 2.4 ç‰ˆæœ¬å¼€å§‹ï¼Œç¤¾åŒºé€šè¿‡å¼•å…¥æ–°çš„ Broker ç«¯å‚æ•°ï¼Œå…è®¸ Follower å‰¯æœ¬æœ‰é™åº¦åœ°æä¾›è¯»æœåŠ¡ã€‚ å¼ºè°ƒ Leader å’Œ Follower çš„æ¶ˆæ¯åºåˆ—åœ¨å®é™…åœºæ™¯ä¸­ä¸ä¸€è‡´ã€‚å¾ˆå¤šåŸå› éƒ½å¯èƒ½é€ æˆ Leader å’Œ Follower ä¿å­˜çš„æ¶ˆæ¯åºåˆ—ä¸ä¸€è‡´ï¼Œæ¯”å¦‚ç¨‹åº Bugã€ç½‘ç»œé—®é¢˜ç­‰ã€‚è¿™æ˜¯å¾ˆä¸¥é‡ çš„é”™è¯¯ï¼Œå¿…é¡»è¦å®Œå…¨è§„é¿ã€‚ä½ å¯ä»¥è¡¥å……ä¸‹ï¼Œä¹‹å‰ç¡®ä¿ä¸€è‡´æ€§çš„ä¸»è¦æ‰‹æ®µæ˜¯é«˜æ°´ä½æœºåˆ¶ï¼Œ ä½†é«˜æ°´ä½å€¼æ— æ³•ä¿è¯ Leader è¿ç»­å˜æ›´åœºæ™¯ä¸‹çš„æ•°æ®ä¸€è‡´æ€§ï¼Œå› æ­¤ï¼Œç¤¾åŒºå¼•å…¥äº† Leader Epoch æœºåˆ¶ï¼Œæ¥ä¿®å¤é«˜æ°´ä½å€¼çš„å¼Šç«¯ã€‚å…³äºâ€œLeader Epoch æœºåˆ¶â€ï¼Œå›½å†…çš„èµ„æ–™ä¸æ˜¯ å¾ˆå¤šï¼Œå®ƒçš„æ™®åŠåº¦è¿œä¸å¦‚é«˜æ°´ä½ï¼Œä¸å¦¨å¤§èƒ†åœ°æŠŠè¿™ä¸ªæ¦‚å¿µç§€å‡ºæ¥ï¼ŒåŠ›æ±‚æƒŠè‰³ä¸€æŠŠã€‚ ç‚«æŠ€å¼é¢˜ç›® 6ã€LEOã€LSOã€ARã€ISRã€HW éƒ½è¡¨ç¤ºä»€ä¹ˆå«ä¹‰? LEO:Log End Offsetã€‚æ—¥å¿—æœ«ç«¯ä½ç§»å€¼æˆ–æœ«ç«¯åç§»é‡ï¼Œè¡¨ç¤ºæ—¥å¿—ä¸‹ä¸€æ¡å¾…æ’å…¥æ¶ˆæ¯çš„ ä½ç§»å€¼ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæ—¥å¿—æœ‰ 10 æ¡æ¶ˆæ¯ï¼Œä½ç§»å€¼ä» 0 å¼€å§‹ï¼Œé‚£ä¹ˆï¼Œç¬¬ 10 æ¡æ¶ˆæ¯çš„ä½ ç§»å€¼å°±æ˜¯ 9ã€‚æ­¤æ—¶ï¼ŒLEO = 10ã€‚ LSO:Log Stable Offsetã€‚è¿™æ˜¯ Kafka äº‹åŠ¡çš„æ¦‚å¿µã€‚å¦‚æœä½ æ²¡æœ‰ä½¿ç”¨åˆ°äº‹åŠ¡ï¼Œé‚£ä¹ˆè¿™ä¸ª å€¼ä¸å­˜åœ¨(å…¶å®ä¹Ÿä¸æ˜¯ä¸å­˜åœ¨ï¼Œåªæ˜¯è®¾ç½®æˆä¸€ä¸ªæ— æ„ä¹‰çš„å€¼)ã€‚è¯¥å€¼æ§åˆ¶äº†äº‹åŠ¡å‹æ¶ˆè´¹ è€…èƒ½å¤Ÿçœ‹åˆ°çš„æ¶ˆæ¯èŒƒå›´ã€‚å®ƒç»å¸¸ä¸ Log Start Offsetï¼Œå³æ—¥å¿—èµ·å§‹ä½ç§»å€¼ç›¸æ··æ·†ï¼Œå› ä¸º æœ‰äº›äººå°†åè€…ç¼©å†™æˆ LSOï¼Œè¿™æ˜¯ä¸å¯¹çš„ã€‚åœ¨ Kafka ä¸­ï¼ŒLSO å°±æ˜¯æŒ‡ä»£ Log Stable Offsetã€‚ AR:Assigned Replicasã€‚AR æ˜¯ä¸»é¢˜è¢«åˆ›å»ºåï¼Œåˆ†åŒºåˆ›å»ºæ—¶è¢«åˆ†é…çš„å‰¯æœ¬é›†åˆï¼Œå‰¯æœ¬ä¸ª æ•°ç”±å‰¯æœ¬å› å­å†³å®šã€‚ ISR:In-Sync Replicasã€‚Kafka ä¸­ç‰¹åˆ«é‡è¦çš„æ¦‚å¿µï¼ŒæŒ‡ä»£çš„æ˜¯ AR ä¸­é‚£äº›ä¸ Leader ä¿ æŒåŒæ­¥çš„å‰¯æœ¬é›†åˆã€‚åœ¨ AR ä¸­çš„å‰¯æœ¬å¯èƒ½ä¸åœ¨ ISR ä¸­ï¼Œä½† Leader å‰¯æœ¬å¤©ç„¶å°±åŒ…å«åœ¨ ISR ä¸­ã€‚å…³äº ISRï¼Œè¿˜æœ‰ä¸€ä¸ªå¸¸è§çš„é¢è¯•é¢˜ç›®æ˜¯å¦‚ä½•åˆ¤æ–­å‰¯æœ¬æ˜¯å¦åº”è¯¥å±äº ISRã€‚ç›®å‰çš„åˆ¤æ–­ ä¾æ®æ˜¯:Follower å‰¯æœ¬çš„ LEO è½å Leader LEO çš„æ—¶é—´ï¼Œæ˜¯å¦è¶…è¿‡äº† Broker ç«¯å‚æ•° replica.lag.time.max.ms å€¼ã€‚å¦‚æœè¶…è¿‡äº†ï¼Œå‰¯æœ¬å°±ä¼šè¢«ä» ISR ä¸­ç§»é™¤ã€‚ HW:é«˜æ°´ä½å€¼(High watermark)ã€‚è¿™æ˜¯æ§åˆ¶æ¶ˆè´¹è€…å¯è¯»å–æ¶ˆæ¯èŒƒå›´çš„é‡è¦å­—æ®µã€‚ä¸€ ä¸ªæ™®é€šæ¶ˆè´¹è€…åªèƒ½â€œçœ‹åˆ°â€Leader å‰¯æœ¬ä¸Šä»‹äº Log Start Offset å’Œ HW(ä¸å«)ä¹‹é—´çš„ æ‰€æœ‰æ¶ˆæ¯ã€‚æ°´ä½ä»¥ä¸Šçš„æ¶ˆæ¯æ˜¯å¯¹æ¶ˆè´¹è€…ä¸å¯è§çš„ã€‚å…³äº HWï¼Œé—®æ³•æœ‰å¾ˆå¤šï¼Œæˆ‘èƒ½æƒ³åˆ°çš„ æœ€é«˜çº§çš„é—®æ³•ï¼Œå°±æ˜¯è®©ä½ å®Œæ•´åœ°æ¢³ç†ä¸‹ Follower å‰¯æœ¬æ‹‰å– Leader å‰¯æœ¬ã€æ‰§è¡ŒåŒæ­¥æœºåˆ¶ çš„è¯¦ç»†æ­¥éª¤ã€‚è¿™å°±æ˜¯æˆ‘ä»¬çš„ç¬¬ 20 é“é¢˜çš„é¢˜ç›®ï¼Œä¸€ä¼šå„¿æˆ‘ä¼šç»™å‡ºç­”æ¡ˆå’Œè§£æã€‚ 7ï¼ŒKafka çš„ ISR æœºåˆ¶æ˜¯ä»€ä¹ˆ? è¿™ä¸ªæœºåˆ¶ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä¼šè‡ªåŠ¨ç»™æ¯ä¸ª Partition ç»´æŠ¤ä¸€ä¸ª ISR åˆ—è¡¨ï¼Œè¿™ä¸ªåˆ—è¡¨é‡Œä¸€å®šä¼šæœ‰ Leaderï¼Œç„¶åè¿˜ä¼šåŒ…å«è·Ÿ Leader ä¿æŒåŒæ­¥çš„ Followerã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦ Leader çš„æŸä¸ª Follower ä¸€ç›´è·Ÿä»–ä¿æŒæ•°æ®åŒæ­¥ï¼Œé‚£ä¹ˆå°±ä¼šå­˜åœ¨äº ISR åˆ—è¡¨é‡Œã€‚ ä½†æ˜¯å¦‚æœ Follower å› ä¸ºè‡ªèº«å‘ç”Ÿä¸€äº›é—®é¢˜ï¼Œå¯¼è‡´ä¸èƒ½åŠæ—¶çš„ä» Leader åŒæ­¥æ•°æ®è¿‡å»ï¼Œé‚£ä¹ˆè¿™ä¸ª Follower å°±ä¼šè¢«è®¤ä¸ºæ˜¯â€œout-of-syncâ€ï¼Œè¢«ä» ISR åˆ—è¡¨é‡Œè¸¢å‡ºå»ã€‚ æ‰€ä»¥å¤§å®¶å…ˆå¾—æ˜ç™½è¿™ä¸ª ISR æ˜¯ä»€ä¹ˆï¼Œè¯´ç™½äº†ï¼Œå°±æ˜¯ Kafka è‡ªåŠ¨ç»´æŠ¤å’Œç›‘æ§å“ªäº› Follower åŠæ—¶çš„è·Ÿä¸Šäº† Leader çš„æ•°æ®åŒæ­¥ã€‚ 8ï¼ŒKafka å†™å…¥çš„æ•°æ®å¦‚ä½•ä¿è¯ä¸ä¸¢å¤±? æ‰€ä»¥å¦‚æœè¦è®©å†™å…¥ Kafka çš„æ•°æ®ä¸ä¸¢å¤±ï¼Œä½ éœ€è¦ä¿è¯å¦‚ä¸‹å‡ ç‚¹ï¼š æ¯ä¸ª Partition éƒ½è‡³å°‘å¾—æœ‰ 1 ä¸ª Follower åœ¨ ISR åˆ—è¡¨é‡Œï¼Œè·Ÿä¸Šäº† Leader çš„æ•°æ®åŒæ­¥ã€‚ æ¯æ¬¡å†™å…¥æ•°æ®çš„æ—¶å€™ï¼Œéƒ½è¦æ±‚è‡³å°‘å†™å…¥ Partition Leader æˆåŠŸï¼ŒåŒæ—¶è¿˜æœ‰è‡³å°‘ä¸€ä¸ª ISR é‡Œçš„ Follower ä¹Ÿå†™å…¥æˆåŠŸï¼Œæ‰ç®—è¿™ä¸ªå†™å…¥æ˜¯æˆåŠŸäº†ã€‚ å¦‚æœä¸æ»¡è¶³ä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶ï¼Œé‚£å°±ä¸€ç›´å†™å…¥å¤±è´¥ï¼Œè®©ç”Ÿäº§ç³»ç»Ÿä¸åœçš„å°è¯•é‡è¯•ï¼Œç›´åˆ°æ»¡è¶³ä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶ï¼Œç„¶åæ‰èƒ½è®¤ä¸ºå†™å…¥æˆåŠŸã€‚ æŒ‰ç…§ä¸Šè¿°æ€è·¯å»é…ç½®ç›¸åº”çš„å‚æ•°ï¼Œæ‰èƒ½ä¿è¯å†™å…¥ Kafka çš„æ•°æ®ä¸ä¼šä¸¢å¤±ã€‚ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå‡å¦‚ç°åœ¨ Leader æ²¡æœ‰ Follower äº†ï¼Œæˆ–è€…æ˜¯åˆšå†™å…¥ Leaderï¼ŒLeader ç«‹é©¬å°±å®•æœºï¼Œè¿˜æ²¡æ¥å¾—åŠåŒæ­¥ç»™ Followerã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå†™å…¥å°±ä¼šå¤±è´¥ï¼Œç„¶åä½ å°±è®©ç”Ÿäº§è€…ä¸åœçš„é‡è¯•ï¼Œç›´åˆ° Kafka æ¢å¤æ­£å¸¸æ»¡è¶³ä¸Šè¿°æ¡ä»¶ï¼Œæ‰èƒ½ç»§ç»­å†™å…¥ã€‚è¿™æ ·å°±å¯ä»¥è®©å†™å…¥ Kafka çš„æ•°æ®ä¸ä¸¢å¤±ã€‚ 9. é«˜æ°´ä½å’ŒEpoch åœ¨Kafkaä¸­ï¼Œé«˜æ°´ä½çš„ä½œç”¨ä¸»è¦æœ‰ä¸¤ä¸ª å®šä¹‰æ¶ˆæ¯å¯è§æ€§ï¼Œå³ç”¨æ¥æ ‡è¯†åˆ†åŒºä¸‹çš„å“ªäº›æ¶ˆæ¯æ˜¯å¯ä»¥è¢«æ¶ˆè´¹è€…æ¶ˆè´¹çš„ã€‚ å¸®åŠ©Kafkaå®Œæˆå‰¯æœ¬åŒæ­¥ ä¸‹é¢è¿™å¼ å›¾å±•ç¤ºäº†å¤šä¸ªä¸é«˜æ°´ä½ç›¸å…³çš„ Kafka æœ¯è¯­ã€‚ å‡è®¾è¿™æ˜¯æŸä¸ªåˆ†åŒº Leader å‰¯æœ¬çš„é«˜æ°´ä½å›¾ã€‚é¦–å…ˆï¼Œè¯·æ³¨æ„å›¾ä¸­çš„â€œå·²æäº¤æ¶ˆæ¯â€å’Œâ€œæœªæäº¤æ¶ˆæ¯â€ã€‚ä¹‹å‰åœ¨è®²åˆ° Kafka æŒä¹…æ€§ä¿éšœçš„æ—¶å€™ï¼Œç‰¹æ„å¯¹ä¸¤è€…è¿›è¡Œäº†åŒºåˆ†ã€‚ç°åœ¨ï¼Œå†æ¬¡å¼ºè°ƒä¸€ä¸‹ã€‚åœ¨åˆ†åŒºé«˜æ°´ä½ä»¥ä¸‹çš„æ¶ˆæ¯è¢«è®¤ä¸ºæ˜¯å·²æäº¤æ¶ˆæ¯ï¼Œåä¹‹å°±æ˜¯æœªæäº¤æ¶ˆæ¯ã€‚ æ¶ˆè´¹è€…åªèƒ½æ¶ˆè´¹å·²æäº¤æ¶ˆæ¯ï¼Œå³å›¾ä¸­ä½ç§»å°äº 8 çš„æ‰€æœ‰æ¶ˆæ¯ã€‚æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸è®¨è®º Kafka äº‹åŠ¡ï¼Œå› ä¸ºäº‹åŠ¡æœºåˆ¶ä¼šå½±å“æ¶ˆè´¹è€…æ‰€èƒ½çœ‹åˆ°çš„æ¶ˆæ¯çš„èŒƒå›´ï¼Œå®ƒä¸åªæ˜¯ç®€å•ä¾èµ–é«˜æ°´ä½æ¥åˆ¤æ–­ã€‚å®ƒä¾é ä¸€ä¸ªåä¸º LSOï¼ˆLog Stable Offsetï¼‰çš„ä½ç§»å€¼æ¥åˆ¤æ–­äº‹åŠ¡å‹æ¶ˆè´¹è€…çš„å¯è§æ€§ã€‚ å¦å¤–ï¼Œä½ç§»å€¼ç­‰äºé«˜æ°´ä½çš„æ¶ˆæ¯ä¹Ÿå±äºæœªæäº¤æ¶ˆæ¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé«˜æ°´ä½ä¸Šçš„æ¶ˆæ¯æ˜¯ä¸èƒ½è¢«æ¶ˆè´¹è€…æ¶ˆè´¹çš„ã€‚ Log End Offsetï¼ˆLEOï¼‰ Log End Offsetï¼ˆLEOï¼‰è¡¨ç¤ºå‰¯æœ¬å†™å…¥ä¸‹ä¸€æ¡æ¶ˆæ¯çš„ä½ç§»å€¼ã€‚æ³¨æ„ï¼Œæ•°å­— 15 æ‰€åœ¨çš„æ–¹æ¡†æ˜¯è™šçº¿ï¼Œè¿™å°±è¯´æ˜ï¼Œè¿™ä¸ªå‰¯æœ¬å½“å‰åªæœ‰ 15 æ¡æ¶ˆæ¯ï¼Œä½ç§»å€¼æ˜¯ä» 0 åˆ° 14ï¼Œä¸‹ä¸€æ¡æ–°æ¶ˆæ¯çš„ä½ç§»æ˜¯ 15ã€‚æ˜¾ç„¶ï¼Œä»‹äºé«˜æ°´ä½å’Œ LEO ä¹‹é—´çš„æ¶ˆæ¯å°±å±äºæœªæäº¤æ¶ˆæ¯ã€‚è¿™ä¹Ÿä»ä¾§é¢å‘Šè¯‰äº†æˆ‘ä»¬ä¸€ä¸ªé‡è¦çš„äº‹å®ï¼Œé‚£å°±æ˜¯ï¼šåŒä¸€ä¸ªå‰¯æœ¬å¯¹è±¡ï¼Œå…¶é«˜æ°´ä½å€¼ä¸ä¼šå¤§äº LEO å€¼ã€‚ é«˜æ°´ä½å’Œ LEO æ˜¯å‰¯æœ¬å¯¹è±¡çš„ä¸¤ä¸ªé‡è¦å±æ€§ã€‚Kafka æ‰€æœ‰å‰¯æœ¬éƒ½æœ‰å¯¹åº”çš„é«˜æ°´ä½å’Œ LEO å€¼ï¼Œè€Œä¸ä»…ä»…æ˜¯ Leader å‰¯æœ¬ã€‚åªä¸è¿‡ Leader å‰¯æœ¬æ¯”è¾ƒç‰¹æ®Šï¼ŒKafka ä½¿ç”¨ Leader å‰¯æœ¬çš„é«˜æ°´ä½æ¥å®šä¹‰æ‰€åœ¨åˆ†åŒºçš„é«˜æ°´ä½ã€‚æ¢å¥è¯è¯´ï¼Œåˆ†åŒºçš„é«˜æ°´ä½å°±æ˜¯å…¶ Leader å‰¯æœ¬çš„é«˜æ°´ä½ã€‚ é«˜æ°´ä½å’ŒLEOæ›´æ–°æœºåˆ¶ ç°åœ¨ï¼Œæˆ‘ä»¬çŸ¥é“äº†æ¯ä¸ªå‰¯æœ¬å¯¹è±¡éƒ½ä¿å­˜äº†ä¸€ç»„é«˜æ°´ä½å€¼å’Œ LEO å€¼ï¼Œä½†å®é™…ä¸Šï¼Œåœ¨ Leader å‰¯æœ¬æ‰€åœ¨çš„ Broker ä¸Šï¼Œè¿˜ä¿å­˜äº†å…¶ä»– Follower å‰¯æœ¬çš„HWå’ŒLEO å€¼ã€‚ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒBroker 0 ä¸Šä¿å­˜äº†æŸåˆ†åŒºçš„ Leader å‰¯æœ¬å’Œæ‰€æœ‰ Follower å‰¯æœ¬çš„ LEO å€¼ï¼Œè€Œ Broker 1 ä¸Šä»…ä»…ä¿å­˜äº†è¯¥åˆ†åŒºçš„æŸä¸ª Follower å‰¯æœ¬ã€‚Kafka æŠŠ Broker 0 ä¸Šä¿å­˜çš„è¿™äº› Follower å‰¯æœ¬åˆç§°ä¸ºè¿œç¨‹å‰¯æœ¬ï¼ˆRemote Replicaï¼‰ã€‚Kafka å‰¯æœ¬æœºåˆ¶åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šæ›´æ–° Broker 1 ä¸Š Follower å‰¯æœ¬çš„é«˜æ°´ä½å’Œ LEO å€¼ï¼ŒåŒæ—¶ä¹Ÿä¼šæ›´æ–° Broker 0 ä¸Š Leader å‰¯æœ¬çš„é«˜æ°´ä½å’Œ LEO ä»¥åŠæ‰€æœ‰è¿œç¨‹å‰¯æœ¬çš„ LEOï¼Œä½†å®ƒä¸ä¼šæ›´æ–°è¿œç¨‹å‰¯æœ¬çš„é«˜æ°´ä½å€¼ï¼Œä¹Ÿå°±æ˜¯æˆ‘åœ¨å›¾ä¸­æ ‡è®°ä¸ºç°è‰²çš„éƒ¨åˆ†ã€‚ ä¿å­˜è¿œç¨‹å‰¯æœ¬çš„ä½œç”¨ä¸»è¦æ˜¯å¸®åŠ© Leader å‰¯æœ¬ç¡®å®šå…¶é«˜æ°´ä½ï¼Œä¹Ÿå°±æ˜¯åˆ†åŒºé«˜æ°´ä½ã€‚ä¸‹å›¾æ˜¯å‰¯æœ¬åŒæ­¥æœºåˆ¶ï¼š 10,Leaderå‰¯æœ¬ä¿æŒåŒæ­¥ ä¸Leaderå‰¯æœ¬ä¿æŒåŒæ­¥çš„åˆ¤æ–­æ¡ä»¶æœ‰ä¸¤ä¸ªï¼š è¯¥è¿œç¨‹Followerå‰¯æœ¬åœ¨ISRä¸­ã€‚ è¯¥è¿œç¨‹Followerå‰¯æœ¬LEOå€¼è½åäºLeaderå‰¯æœ¬LEOå€¼çš„æ—¶é—´ï¼Œä¸è¶…è¿‡Brokerç«¯å‚æ•°replica.lag.time.max.msçš„å€¼ï¼ˆé»˜è®¤å€¼10ç§’ï¼‰ å‰¯æœ¬åŒæ­¥å…¨æµç¨‹ å½“ç”Ÿäº§è€…å‘é€ä¸€æ¡æ¶ˆæ¯æ—¶ï¼ŒLeader å’Œ Follower å‰¯æœ¬å¯¹åº”çš„é«˜æ°´ä½æ˜¯æ€ä¹ˆè¢«æ›´æ–°çš„å‘¢ï¼Ÿ é¦–å…ˆæ˜¯åˆå§‹çŠ¶æ€ã€‚ä¸‹é¢è¿™å¼ å›¾ä¸­çš„ remote LEO å°±æ˜¯åˆšæ‰çš„è¿œç¨‹å‰¯æœ¬çš„ LEO å€¼ã€‚åœ¨åˆå§‹çŠ¶æ€æ—¶ï¼Œæ‰€æœ‰å€¼éƒ½æ˜¯ 0ã€‚ å½“ç”Ÿäº§è€…ç»™ä¸»é¢˜åˆ†åŒºå‘é€ä¸€æ¡æ¶ˆæ¯åï¼ŒçŠ¶æ€å˜æ›´ä¸ºï¼š æ­¤æ—¶ï¼ŒLeader å‰¯æœ¬æˆåŠŸå°†æ¶ˆæ¯å†™å…¥äº†æœ¬åœ°ç£ç›˜ï¼Œæ•… LEO å€¼è¢«æ›´æ–°ä¸º 1ã€‚ Follower å†æ¬¡å°è¯•ä» Leader æ‹‰å–æ¶ˆæ¯ã€‚å’Œä¹‹å‰ä¸åŒçš„æ˜¯ï¼Œè¿™æ¬¡æœ‰æ¶ˆæ¯å¯ä»¥æ‹‰å–äº†ï¼Œå› æ­¤çŠ¶æ€è¿›ä¸€æ­¥å˜æ›´ä¸ºï¼š è¿™æ—¶ï¼ŒFollower å‰¯æœ¬ä¹ŸæˆåŠŸåœ°æ›´æ–° LEO ä¸º 1ã€‚æ­¤æ—¶ï¼ŒLeader å’Œ Follower å‰¯æœ¬çš„ LEO éƒ½æ˜¯ 1ï¼Œä½†å„è‡ªçš„é«˜æ°´ä½ä¾ç„¶æ˜¯ 0ï¼Œè¿˜æ²¡æœ‰è¢«æ›´æ–°ã€‚å®ƒä»¬éœ€è¦åœ¨ä¸‹ä¸€è½®çš„æ‹‰å–ä¸­è¢«æ›´æ–°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š åœ¨æ–°ä¸€è½®çš„æ‹‰å–è¯·æ±‚ä¸­ï¼Œç”±äºä½ç§»å€¼æ˜¯ 0 çš„æ¶ˆæ¯å·²ç»æ‹‰å–æˆåŠŸï¼Œå› æ­¤ Follower å‰¯æœ¬è¿™æ¬¡è¯·æ±‚æ‹‰å–çš„æ˜¯ä½ç§»å€¼ =1 çš„æ¶ˆæ¯ã€‚Leader å‰¯æœ¬æ¥æ”¶åˆ°æ­¤è¯·æ±‚åï¼Œæ›´æ–°è¿œç¨‹å‰¯æœ¬ LEO ä¸º 1ï¼Œç„¶åæ›´æ–° Leader é«˜æ°´ä½ä¸º 1ã€‚åšå®Œè¿™äº›ä¹‹åï¼Œå®ƒä¼šå°†å½“å‰å·²æ›´æ–°è¿‡çš„é«˜æ°´ä½å€¼ 1 å‘é€ç»™ Follower å‰¯æœ¬ã€‚Follower å‰¯æœ¬æ¥æ”¶åˆ°ä»¥åï¼Œä¹Ÿå°†è‡ªå·±çš„é«˜æ°´ä½å€¼æ›´æ–°æˆ 1ã€‚è‡³æ­¤ï¼Œä¸€æ¬¡å®Œæ•´çš„æ¶ˆæ¯åŒæ­¥å‘¨æœŸå°±ç»“æŸäº†ã€‚äº‹å®ä¸Šï¼ŒKafka å°±æ˜¯åˆ©ç”¨è¿™æ ·çš„æœºåˆ¶ï¼Œå®ç°äº† Leader å’Œ Follower å‰¯æœ¬ä¹‹é—´çš„åŒæ­¥ã€‚ Leader Epoch ä»åˆšæ‰çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ï¼ŒFollower å‰¯æœ¬çš„é«˜æ°´ä½æ›´æ–°éœ€è¦ä¸€è½®é¢å¤–çš„æ‹‰å–è¯·æ±‚æ‰èƒ½å®ç°ã€‚å¦‚æœæŠŠä¸Šé¢é‚£ä¸ªä¾‹å­æ‰©å±•åˆ°å¤šä¸ª Follower å‰¯æœ¬ï¼Œæƒ…å†µå¯èƒ½æ›´ç³Ÿï¼Œä¹Ÿè®¸éœ€è¦å¤šè½®æ‹‰å–è¯·æ±‚ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒLeader å‰¯æœ¬é«˜æ°´ä½æ›´æ–°å’Œ Follower å‰¯æœ¬é«˜æ°´ä½æ›´æ–°åœ¨æ—¶é—´ä¸Šæ˜¯å­˜åœ¨é”™é…çš„ã€‚è¿™ç§é”™é…æ˜¯å¾ˆå¤šâ€œæ•°æ®ä¸¢å¤±â€æˆ–â€œæ•°æ®ä¸ä¸€è‡´â€é—®é¢˜çš„æ ¹æºã€‚åŸºäºæ­¤ï¼Œç¤¾åŒºåœ¨ 0.11 ç‰ˆæœ¬æ­£å¼å¼•å…¥äº† Leader Epoch æ¦‚å¿µï¼Œæ¥è§„é¿å› é«˜æ°´ä½æ›´æ–°é”™é…å¯¼è‡´çš„å„ç§ä¸ä¸€è‡´é—®é¢˜ã€‚ æ‰€è°“ Leader Epochï¼Œæˆ‘ä»¬å¤§è‡´å¯ä»¥è®¤ä¸ºæ˜¯ Leader ç‰ˆæœ¬ã€‚å®ƒç”±ä¸¤éƒ¨åˆ†æ•°æ®ç»„æˆã€‚ Epochã€‚ä¸€ä¸ªå•è°ƒå¢åŠ çš„ç‰ˆæœ¬å·ã€‚æ¯å½“å‰¯æœ¬é¢†å¯¼æƒå‘ç”Ÿå˜æ›´æ—¶ï¼Œéƒ½ä¼šå¢åŠ è¯¥ç‰ˆæœ¬å·ã€‚å°ç‰ˆæœ¬å·çš„ Leader è¢«è®¤ä¸ºæ˜¯è¿‡æœŸ Leaderï¼Œä¸èƒ½å†è¡Œä½¿ Leader æƒåŠ›ã€‚ èµ·å§‹ä½ç§»ï¼ˆStart Offsetï¼‰ã€‚Leader å‰¯æœ¬åœ¨è¯¥ Epoch å€¼ä¸Šå†™å…¥çš„é¦–æ¡æ¶ˆæ¯çš„ä½ç§»ã€‚ ä¸¾ä¸ªä¾‹å­æ¥è¯´æ˜ä¸€ä¸‹ Leader Epochã€‚å‡è®¾ç°åœ¨æœ‰ä¸¤ä¸ª Leader Epoch&lt;0, 0&gt; å’Œ &lt;1, 120&gt;ï¼Œé‚£ä¹ˆï¼Œç¬¬ä¸€ä¸ª Leader Epoch è¡¨ç¤ºç‰ˆæœ¬å·æ˜¯ 0ï¼Œè¿™ä¸ªç‰ˆæœ¬çš„ Leader ä»ä½ç§» 0 å¼€å§‹ä¿å­˜æ¶ˆæ¯ï¼Œä¸€å…±ä¿å­˜äº† 120 æ¡æ¶ˆæ¯ã€‚ä¹‹åï¼ŒLeader å‘ç”Ÿäº†å˜æ›´ï¼Œç‰ˆæœ¬å·å¢åŠ åˆ° 1ï¼Œæ–°ç‰ˆæœ¬çš„èµ·å§‹ä½ç§»æ˜¯ 120ã€‚ Kafka Broker ä¼šåœ¨å†…å­˜ä¸­ä¸ºæ¯ä¸ªåˆ†åŒºéƒ½ç¼“å­˜ Leader Epoch æ•°æ®ï¼ŒåŒæ—¶å®ƒè¿˜ä¼šå®šæœŸåœ°å°†è¿™äº›ä¿¡æ¯æŒä¹…åŒ–åˆ°ä¸€ä¸ª checkpoint æ–‡ä»¶ä¸­ã€‚å½“ Leader å‰¯æœ¬å†™å…¥æ¶ˆæ¯åˆ°ç£ç›˜æ—¶ï¼ŒBroker ä¼šå°è¯•æ›´æ–°è¿™éƒ¨åˆ†ç¼“å­˜ã€‚å¦‚æœè¯¥ Leader æ˜¯é¦–æ¬¡å†™å…¥æ¶ˆæ¯ï¼Œé‚£ä¹ˆ Broker ä¼šå‘ç¼“å­˜ä¸­å¢åŠ ä¸€ä¸ª Leader Epoch æ¡ç›®ï¼Œå¦åˆ™å°±ä¸åšæ›´æ–°ã€‚è¿™æ ·ï¼Œæ¯æ¬¡æœ‰ Leader å˜æ›´æ—¶ï¼Œæ–°çš„ Leader å‰¯æœ¬ä¼šæŸ¥è¯¢è¿™éƒ¨åˆ†ç¼“å­˜ï¼Œå–å‡ºå¯¹åº”çš„ Leader Epoch çš„èµ·å§‹ä½ç§»ï¼Œä»¥é¿å…æ•°æ®ä¸¢å¤±å’Œä¸ä¸€è‡´çš„æƒ…å†µã€‚ æ¥ä¸‹æ¥çœ‹ä¸€ä¸ªå®é™…çš„ä¾‹å­ï¼Œå®ƒå±•ç¤ºçš„æ˜¯ Leader Epoch æ˜¯å¦‚ä½•é˜²æ­¢æ•°æ®ä¸¢å¤±çš„ã€‚ å¼•ç”¨ Leader Epoch æœºåˆ¶åï¼ŒFollower å‰¯æœ¬ B é‡å¯å›æ¥åï¼Œéœ€è¦å‘ A å‘é€ä¸€ä¸ªç‰¹æ®Šçš„è¯·æ±‚å»è·å– Leader çš„ LEO å€¼ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè¯¥å€¼ä¸º 2ã€‚å½“è·çŸ¥åˆ° Leader LEO=2 åï¼ŒB å‘ç°è¯¥ LEO å€¼ä¸æ¯”å®ƒè‡ªå·±çš„ LEO å€¼å°ï¼Œè€Œä¸”ç¼“å­˜ä¸­ä¹Ÿæ²¡æœ‰ä¿å­˜ä»»ä½•èµ·å§‹ä½ç§»å€¼ &gt; 2 çš„ Epoch æ¡ç›®ï¼Œå› æ­¤ B æ— éœ€æ‰§è¡Œä»»ä½•æ—¥å¿—æˆªæ–­æ“ä½œã€‚è¿™æ˜¯å¯¹é«˜æ°´ä½æœºåˆ¶çš„ä¸€ä¸ªæ˜æ˜¾æ”¹è¿›ï¼Œå³å‰¯æœ¬æ˜¯å¦æ‰§è¡Œæ—¥å¿—æˆªæ–­ä¸å†ä¾èµ–äºé«˜æ°´ä½è¿›è¡Œåˆ¤æ–­ã€‚ ç°åœ¨ï¼Œå‰¯æœ¬ A å®•æœºäº†ï¼ŒB æˆä¸º Leaderã€‚åŒæ ·åœ°ï¼Œå½“ A é‡å¯å›æ¥åï¼Œæ‰§è¡Œä¸ B ç›¸åŒçš„é€»è¾‘åˆ¤æ–­ï¼Œå‘ç°ä¹Ÿä¸ç”¨æ‰§è¡Œæ—¥å¿—æˆªæ–­ï¼Œè‡³æ­¤ä½ç§»å€¼ä¸º 1 çš„é‚£æ¡æ¶ˆæ¯åœ¨ä¸¤ä¸ªå‰¯æœ¬ä¸­å‡å¾—åˆ°ä¿ç•™ã€‚åé¢å½“ç”Ÿäº§è€…ç¨‹åºå‘ B å†™å…¥æ–°æ¶ˆæ¯æ—¶ï¼Œå‰¯æœ¬ B æ‰€åœ¨çš„ Broker ç¼“å­˜ä¸­ï¼Œä¼šç”Ÿæˆæ–°çš„ Leader Epoch æ¡ç›®ï¼š[Epoch=1, Offset=2]ã€‚ä¹‹åï¼Œå‰¯æœ¬ B ä¼šä½¿ç”¨è¿™ä¸ªæ¡ç›®å¸®åŠ©åˆ¤æ–­åç»­æ˜¯å¦æ‰§è¡Œæ—¥å¿—æˆªæ–­æ“ä½œã€‚è¿™æ ·ï¼Œé€šè¿‡ Leader Epoch æœºåˆ¶ï¼ŒKafka å®Œç¾åœ°è§„é¿äº†è¿™ç§æ•°æ®ä¸¢å¤±åœºæ™¯ã€‚ æ·±åº¦æ€è€ƒé¢˜ 11ã€Kafka ä¸ºä»€ä¹ˆä¸æ”¯æŒè¯»å†™åˆ†ç¦»? è¿™é“é¢˜ç›®è€ƒå¯Ÿçš„æ˜¯ä½ å¯¹ Leader/Follower æ¨¡å‹çš„æ€è€ƒã€‚ Leader/Follower æ¨¡å‹å¹¶æ²¡æœ‰è§„å®š Follower å‰¯æœ¬ä¸å¯ä»¥å¯¹å¤–æä¾›è¯»æœåŠ¡ã€‚å¾ˆå¤šæ¡†æ¶éƒ½æ˜¯å… è®¸è¿™ä¹ˆåšçš„ï¼Œåªæ˜¯ Kafka æœ€åˆä¸ºäº†é¿å…ä¸ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œè€Œé‡‡ç”¨äº†è®© Leader ç»Ÿä¸€æä¾›æœ åŠ¡çš„æ–¹å¼ã€‚ ä¸è¿‡ï¼Œåœ¨å¼€å§‹å›ç­”è¿™é“é¢˜æ—¶ï¼Œä½ å¯ä»¥ç‡å…ˆäº®å‡ºè§‚ç‚¹:è‡ª Kafka 2.4 ä¹‹åï¼ŒKafka æä¾›äº†æœ‰é™åº¦çš„è¯»å†™åˆ†ç¦»ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒFollower å‰¯æœ¬èƒ½å¤Ÿå¯¹å¤–æä¾›è¯»æœåŠ¡ã€‚ è¯´å®Œè¿™äº›ä¹‹åï¼Œä½ å¯ä»¥å†ç»™å‡ºä¹‹å‰çš„ç‰ˆæœ¬ä¸æ”¯æŒè¯»å†™åˆ†ç¦»çš„ç†ç”±ã€‚ åœºæ™¯ä¸é€‚ç”¨ã€‚è¯»å†™åˆ†ç¦»é€‚ç”¨äºé‚£ç§è¯»è´Ÿè½½å¾ˆå¤§ï¼Œè€Œå†™æ“ä½œç›¸å¯¹ä¸é¢‘ç¹çš„åœºæ™¯ï¼Œå¯ Kafka ä¸å±äºè¿™æ ·çš„åœºæ™¯ã€‚ åŒæ­¥æœºåˆ¶ã€‚Kafka é‡‡ç”¨ PULL æ–¹å¼å®ç° Follower çš„åŒæ­¥ï¼Œå› æ­¤ï¼ŒFollower ä¸ Leader å­˜ åœ¨ä¸ä¸€è‡´æ€§çª—å£ã€‚å¦‚æœå…è®¸è¯» Follower å‰¯æœ¬ï¼Œå°±åŠ¿å¿…è¦å¤„ç†æ¶ˆæ¯æ»å(Lagging)çš„é—®é¢˜ã€‚ 12ã€å¦‚ä½•è°ƒä¼˜ Kafka? å›ç­”ä»»ä½•è°ƒä¼˜é—®é¢˜çš„ç¬¬ä¸€æ­¥ï¼Œå°±æ˜¯ ç¡®å®šä¼˜åŒ–ç›®æ ‡ï¼Œå¹¶ä¸”å®šé‡ç»™å‡ºç›®æ ‡! è¿™ç‚¹ç‰¹åˆ«é‡è¦ã€‚å¯¹äº Kafka è€Œè¨€ï¼Œå¸¸è§çš„ä¼˜åŒ–ç›®æ ‡æ˜¯ååé‡ã€å»¶æ—¶ã€æŒä¹…æ€§å’Œå¯ç”¨æ€§ã€‚æ¯ä¸€ä¸ªæ–¹å‘çš„ä¼˜åŒ–æ€è·¯éƒ½ æ˜¯ä¸åŒçš„ï¼Œç”šè‡³æ˜¯ç›¸åçš„ã€‚ ç¡®å®šäº†ç›®æ ‡ä¹‹åï¼Œè¿˜è¦æ˜ç¡®ä¼˜åŒ–çš„ç»´åº¦ã€‚æœ‰äº›è°ƒä¼˜å±äºé€šç”¨çš„ä¼˜åŒ–æ€è·¯ï¼Œæ¯”å¦‚å¯¹æ“ä½œç³»ç»Ÿã€ JVM ç­‰çš„ä¼˜åŒ–;æœ‰äº›åˆ™æ˜¯æœ‰é’ˆå¯¹æ€§çš„ï¼Œæ¯”å¦‚è¦ä¼˜åŒ– Kafka çš„ TPSã€‚æˆ‘ä»¬éœ€è¦ä» 3 ä¸ªæ–¹å‘å»è€ƒè™‘ Producer ç«¯:å¢åŠ  batch.sizeã€linger.msï¼Œå¯ç”¨å‹ç¼©ï¼Œå…³é—­é‡è¯•ç­‰ã€‚ Broker ç«¯:å¢åŠ  num.replica.fetchersï¼Œæå‡ Follower åŒæ­¥ TPSï¼Œé¿å… Broker Full GC ç­‰ã€‚ Consumer:å¢åŠ  fetch.min.bytes ç­‰ 13ã€Controller å‘ç”Ÿç½‘ç»œåˆ†åŒº(Network Partitioning)æ—¶ï¼ŒKafka ä¼šæ€ ä¹ˆæ ·? è¿™é“é¢˜ç›®èƒ½å¤Ÿè¯±å‘æˆ‘ä»¬å¯¹åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡ã€CAP ç†è®ºã€ä¸€è‡´æ€§ç­‰å¤šæ–¹é¢çš„æ€è€ƒã€‚ä¸è¿‡ï¼Œé’ˆ å¯¹æ•…éšœå®šä½å’Œåˆ†æçš„è¿™ç±»é—®é¢˜ï¼Œæˆ‘å»ºè®®ä½ é¦–å…ˆè¨€æ˜â€œå®ç”¨è‡³ä¸Šâ€çš„è§‚ç‚¹ï¼Œå³ä¸è®ºæ€ä¹ˆè¿›è¡Œç†è®ºåˆ†æï¼Œæ°¸è¿œéƒ½è¦ä»¥å®é™…ç»“æœä¸ºå‡†ã€‚ä¸€æ—¦å‘ç”Ÿ Controller ç½‘ç»œåˆ†åŒºï¼Œé‚£ä¹ˆï¼Œç¬¬ä¸€è¦åŠ¡å°±æ˜¯ æŸ¥çœ‹é›†ç¾¤æ˜¯å¦å‡ºç°â€œè„‘è£‚â€ï¼Œå³åŒæ—¶å‡ºç°ä¸¤ä¸ªç”šè‡³æ˜¯å¤šä¸ª Controller ç»„ä»¶ã€‚è¿™å¯ä»¥æ ¹æ® Broker ç«¯ç›‘æ§æŒ‡æ ‡ ActiveControllerCount æ¥åˆ¤æ–­ã€‚ ç°åœ¨ï¼Œæˆ‘ä»¬åˆ†æä¸‹ï¼Œä¸€æ—¦å‡ºç°è¿™ç§æƒ…å†µï¼ŒKafka ä¼šæ€ä¹ˆæ ·ã€‚ ç”±äº Controller ä¼šç»™ Broker å‘é€ 3 ç±»è¯·æ±‚ï¼Œå³LeaderAndIsrRequestã€ StopReplicaRequest å’Œ UpdateMetadataRequestï¼Œå› æ­¤ï¼Œä¸€æ—¦å‡ºç°ç½‘ç»œåˆ†åŒºï¼Œè¿™äº›è¯·æ±‚å°†ä¸èƒ½é¡ºåˆ©åˆ°è¾¾ Broker ç«¯ã€‚è¿™å°†å½±å“ä¸»é¢˜çš„åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤æ“ä½œçš„ä¿¡æ¯åŒæ­¥ï¼Œè¡¨ç°ä¸º é›†ç¾¤ä»¿ä½›åƒµä½äº†ä¸€æ ·ï¼Œæ— æ³•æ„ŸçŸ¥åˆ°åé¢çš„æ‰€æœ‰æ“ä½œã€‚å› æ­¤ï¼Œç½‘ç»œåˆ†åŒºé€šå¸¸éƒ½æ˜¯éå¸¸ä¸¥é‡çš„é—® é¢˜ï¼Œè¦èµ¶å¿«ä¿®å¤ã€‚ 14ã€Java Consumer ä¸ºä»€ä¹ˆé‡‡ç”¨å•çº¿ç¨‹æ¥è·å–æ¶ˆæ¯? åœ¨å›ç­”ä¹‹å‰ï¼Œå¦‚æœå…ˆæŠŠè¿™å¥è¯è¯´å‡ºæ¥ï¼Œä¸€å®šä¼šåŠ åˆ†:Java Consumer æ˜¯åŒçº¿ç¨‹çš„è®¾è®¡ã€‚ä¸€ ä¸ªçº¿ç¨‹æ˜¯ç”¨æˆ·ä¸»çº¿ç¨‹ï¼Œè´Ÿè´£è·å–æ¶ˆæ¯;å¦ä¸€ä¸ªçº¿ç¨‹æ˜¯å¿ƒè·³çº¿ç¨‹ï¼Œè´Ÿè´£å‘ Kafka æ±‡æŠ¥æ¶ˆè´¹è€… å­˜æ´»æƒ…å†µã€‚å°†å¿ƒè·³å•ç‹¬æ”¾å…¥ä¸“å±çš„çº¿ç¨‹ï¼Œèƒ½å¤Ÿæœ‰æ•ˆåœ°è§„é¿å› æ¶ˆæ¯å¤„ç†é€Ÿåº¦æ…¢è€Œè¢«è§†ä¸ºä¸‹çº¿ çš„â€œå‡æ­»â€æƒ…å†µã€‚ å•çº¿ç¨‹è·å–æ¶ˆæ¯çš„è®¾è®¡èƒ½å¤Ÿé¿å…é˜»å¡å¼çš„æ¶ˆæ¯è·å–æ–¹å¼ã€‚å•çº¿ç¨‹è½®è¯¢æ–¹å¼å®¹æ˜“å®ç°å¼‚æ­¥éé˜»å¡å¼ï¼Œè¿™æ ·ä¾¿äºå°†æ¶ˆè´¹è€…æ‰©å±•æˆæ”¯æŒå®æ—¶æµå¤„ç†çš„æ“ä½œç®—å­ã€‚å› ä¸ºå¾ˆå¤šå®æ—¶æµå¤„ç†æ“ä½œç®—å­éƒ½ä¸èƒ½æ˜¯é˜»å¡å¼çš„ã€‚å¦å¤–ä¸€ä¸ªå¯èƒ½çš„å¥½å¤„æ˜¯ï¼Œå¯ä»¥ç®€åŒ–ä»£ç çš„å¼€å‘ã€‚å¤šçº¿ç¨‹äº¤äº’çš„ä»£ç æ˜¯éå¸¸å®¹æ˜“å‡ºé”™çš„ã€‚ 15ã€ç®€è¿° Follower å‰¯æœ¬æ¶ˆæ¯åŒæ­¥çš„å®Œæ•´æµç¨‹ é¦–å…ˆï¼ŒFollower å‘é€ FETCH è¯·æ±‚ç»™ Leaderã€‚æ¥ç€ï¼ŒLeader ä¼šè¯»å–åº•å±‚æ—¥å¿—æ–‡ä»¶ä¸­çš„æ¶ˆ æ¯æ•°æ®ï¼Œå†æ›´æ–°å®ƒå†…å­˜ä¸­çš„ Follower å‰¯æœ¬çš„ LEO å€¼ï¼Œæ›´æ–°ä¸º FETCH è¯·æ±‚ä¸­çš„ fetchOffset å€¼ã€‚æœ€åï¼Œå°è¯•æ›´æ–°åˆ†åŒºé«˜æ°´ä½å€¼ã€‚Follower æ¥æ”¶åˆ° FETCH å“åº”ä¹‹åï¼Œä¼šæŠŠ æ¶ˆæ¯å†™å…¥åˆ°åº•å±‚æ—¥å¿—ï¼Œæ¥ç€æ›´æ–° LEO å’Œ HW å€¼ã€‚ Leader å’Œ Follower çš„ HW å€¼æ›´æ–°æ—¶æœºæ˜¯ä¸åŒçš„ï¼ŒFollower çš„ HW æ›´æ–°æ°¸è¿œè½åäº Leader çš„ HWã€‚è¿™ç§æ—¶é—´ä¸Šçš„é”™é…æ˜¯é€ æˆå„ç§ä¸ä¸€è‡´çš„åŸå› ã€‚ ","link":"https://tianxiawuhao.github.io/aFuh1RRNc/"},{"title":"ç¬¬ä¸‰ç«  Apache Kafka ä¸Sparkçš„é›†æˆ","content":"åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºå¦‚ä½•å°†Apache Kafkaä¸Spark Streaming APIé›†æˆã€‚ å…³äºSpark Spark Streaming APIæ”¯æŒå®æ—¶æ•°æ®æµçš„å¯æ‰©å±•ï¼Œé«˜ååé‡ï¼Œå®¹é”™æµå¤„ç†ã€‚ æ•°æ®å¯ä»¥ä»è¯¸å¦‚Kafkaï¼ŒFlumeï¼ŒTwitterç­‰è®¸å¤šæºä¸­æå–ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨å¤æ‚çš„ç®—æ³•æ¥å¤„ç†ï¼Œä¾‹å¦‚åœ°å›¾ï¼Œç¼©å°ï¼Œè¿æ¥å’Œçª—å£ç­‰é«˜çº§åŠŸèƒ½ã€‚ æœ€åï¼Œå¤„ç†çš„æ•°æ®å¯ä»¥æ¨é€åˆ°æ–‡ä»¶ç³»ç»Ÿï¼Œæ•°æ®åº“å’Œæ´»åŠ¨ä»ªè¡¨æ¿ã€‚ å¼¹æ€§åˆ†å¸ƒå¼æ•°æ®é›†(RDD)æ˜¯Sparkçš„åŸºæœ¬æ•°æ®ç»“æ„ã€‚ å®ƒæ˜¯ä¸€ä¸ªä¸å¯å˜çš„åˆ†å¸ƒå¼å¯¹è±¡é›†åˆã€‚ RDDä¸­çš„æ¯ä¸ªæ•°æ®é›†åˆ’åˆ†ä¸ºé€»è¾‘åˆ†åŒºï¼Œå¯ä»¥åœ¨é›†ç¾¤çš„ä¸åŒèŠ‚ç‚¹ä¸Šè®¡ç®—ã€‚ ä¸Sparké›†æˆ Kafkaæ˜¯Sparkæµå¼ä¼ è¾“çš„æ½œåœ¨æ¶ˆæ¯ä¼ é€’å’Œé›†æˆå¹³å°ã€‚ Kafkaå……å½“å®æ—¶æ•°æ®æµçš„ä¸­å¿ƒæ¢çº½ï¼Œå¹¶ä½¿ç”¨Spark Streamingä¸­çš„å¤æ‚ç®—æ³•è¿›è¡Œå¤„ç†ã€‚ ä¸€æ—¦æ•°æ®è¢«å¤„ç†ï¼ŒSpark Streamingå¯ä»¥å°†ç»“æœå‘å¸ƒåˆ°å¦ä¸€ä¸ªKafkaä¸»é¢˜æˆ–å­˜å‚¨åœ¨HDFSï¼Œæ•°æ®åº“æˆ–ä»ªè¡¨æ¿ä¸­ã€‚ ä¸‹å›¾æè¿°äº†æ¦‚å¿µæµç¨‹ã€‚ ç°åœ¨ï¼Œè®©æˆ‘ä»¬è¯¦ç»†äº†è§£Kafka-Spark APIã€‚ SparkConf API å®ƒè¡¨ç¤ºSparkåº”ç”¨ç¨‹åºçš„é…ç½®ã€‚ ç”¨äºå°†å„ç§Sparkå‚æ•°è®¾ç½®ä¸ºé”®å€¼å¯¹ã€‚ SparkConf ç±»æœ‰ä»¥ä¸‹æ–¹æ³• - set(string keyï¼Œstring value) - è®¾ç½®é…ç½®å˜é‡ã€‚ remove(string key) - ä»é…ç½®ä¸­ç§»é™¤å¯†é’¥ã€‚ setAppName(string name) - è®¾ç½®åº”ç”¨ç¨‹åºçš„åº”ç”¨ç¨‹åºåç§°ã€‚ get(string key) - get key StreamingContext API è¿™æ˜¯SparkåŠŸèƒ½çš„ä¸»è¦å…¥å£ç‚¹ã€‚ SparkContextè¡¨ç¤ºåˆ°Sparké›†ç¾¤çš„è¿æ¥ï¼Œå¯ç”¨äºåœ¨é›†ç¾¤ä¸Šåˆ›å»ºRDDï¼Œç´¯åŠ å™¨å’Œå¹¿æ’­å˜é‡ã€‚ ç­¾åçš„å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºã€‚ public StreamingContext(String master, String appName, Duration batchDuration, String sparkHome, scala.collection.Seq&lt;String&gt; jars, scala.collection.Map&lt;String,String&gt; environment) ä¸» - è¦è¿æ¥çš„ç¾¤é›†ç½‘å€(ä¾‹å¦‚mesos:// host:portï¼Œspark:// host:portï¼Œlocal [4])ã€‚ appName - ä½œä¸šçš„åç§°ï¼Œä»¥æ˜¾ç¤ºåœ¨é›†ç¾¤Web UIä¸Š batchDuration - æµå¼æ•°æ®å°†è¢«åˆ†æˆæ‰¹æ¬¡çš„æ—¶é—´é—´éš” public StreamingContext(SparkConf conf, Duration batchDuration) é€šè¿‡æä¾›æ–°çš„SparkContextæ‰€éœ€çš„é…ç½®åˆ›å»ºStreamingContextã€‚ conf - Sparkå‚æ•° batchDuration - æµå¼æ•°æ®å°†è¢«åˆ†æˆæ‰¹æ¬¡çš„æ—¶é—´é—´éš” KafkaUtils API KafkaUtils APIç”¨äºå°†Kafkaé›†ç¾¤è¿æ¥åˆ°Sparkæµã€‚ æ­¤APIå…·æœ‰å¦‚ä¸‹å®šä¹‰çš„æ˜¾ç€æ–¹æ³• createStream ã€‚ public static ReceiverInputDStream&lt;scala.Tuple2&lt;String,String&gt;&gt; createStream( StreamingContext ssc, String zkQuorum, String groupId, scala.collection.immutable.Map&lt;String,Object&gt; topics, StorageLevel storageLevel) ä¸Šé¢æ˜¾ç¤ºçš„æ–¹æ³•ç”¨äºåˆ›å»ºä»Kafka Brokersæå–æ¶ˆæ¯çš„è¾“å…¥æµã€‚ ssc - StreamingContextå¯¹è±¡ã€‚ zkQuorum - Zookeeper quorumã€‚ groupId - æ­¤æ¶ˆè´¹è€…çš„ç»„IDã€‚ ä¸»é¢˜ - è¿”å›è¦æ¶ˆè´¹çš„ä¸»é¢˜çš„åœ°å›¾ã€‚ storageLevel - ç”¨äºå­˜å‚¨æ¥æ”¶çš„å¯¹è±¡çš„å­˜å‚¨çº§åˆ«ã€‚ KafkaUtils APIæœ‰å¦ä¸€ä¸ªæ–¹æ³•createDirectStreamï¼Œç”¨äºåˆ›å»ºä¸€ä¸ªè¾“å…¥æµï¼Œç›´æ¥ä»Kafka Brokersæ‹‰å–æ¶ˆæ¯ï¼Œè€Œä¸ä½¿ç”¨ä»»ä½•æ¥æ”¶å™¨ã€‚ è¿™ä¸ªæµå¯ä»¥ä¿è¯æ¥è‡ªKafkaçš„æ¯ä¸ªæ¶ˆæ¯éƒ½åŒ…å«åœ¨è½¬æ¢ä¸­ä¸€æ¬¡ã€‚ ç¤ºä¾‹åº”ç”¨ç¨‹åºåœ¨Scalaä¸­å®Œæˆã€‚ è¦ç¼–è¯‘åº”ç”¨ç¨‹åºï¼Œè¯·ä¸‹è½½å¹¶å®‰è£… sbt ï¼Œscalaæ„å»ºå·¥å…·(ç±»ä¼¼äºmaven)ã€‚ ä¸»è¦åº”ç”¨ç¨‹åºä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ import java.util.HashMap import org.apache.kafka.clients.producer.{KafkaProducer, ProducerConfig, Produc-erRecord} import org.apache.spark.SparkConf import org.apache.spark.streaming._ import org.apache.spark.streaming.kafka._ object KafkaWordCount { def main(args: Array[String]) { if (args.length &lt; 4) { System.err.println(&quot;Usage: KafkaWordCount &lt;zkQuorum&gt;&lt;group&gt; &lt;topics&gt; &lt;numThreads&gt;&quot;) System.exit(1) } val Array(zkQuorum, group, topics, numThreads) = args val sparkConf = new SparkConf().setAppName(&quot;KafkaWordCount&quot;) val ssc = new StreamingContext(sparkConf, Seconds(2)) ssc.checkpoint(&quot;checkpoint&quot;) val topicMap = topics.split(&quot;,&quot;).map((_, numThreads.toInt)).toMap val lines = KafkaUtils.createStream(ssc, zkQuorum, group, topicMap).map(_._2) val words = lines.flatMap(_.split(&quot; &quot;)) val wordCounts = words.map(x =&gt; (x, 1L)) .reduceByKeyAndWindow(_ &amp;plus; _, _ - _, Minutes(10), Seconds(2), 2) wordCounts.print() ssc.start() ssc.awaitTermination() } } æ„å»ºè„šæœ¬ spark-kafkaé›†æˆå–å†³äºSparkï¼ŒSparkæµå’ŒSparkä¸Kafkaçš„é›†æˆjarã€‚ åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ build.sbt ï¼Œå¹¶æŒ‡å®šåº”ç”¨ç¨‹åºè¯¦ç»†ä¿¡æ¯åŠå…¶ä¾èµ–å…³ç³»ã€‚ åœ¨ç¼–è¯‘å’Œæ‰“åŒ…åº”ç”¨ç¨‹åºæ—¶ï¼Œ sbt å°†ä¸‹è½½æ‰€éœ€çš„jarã€‚ name := &quot;Spark Kafka Project&quot; version := &quot;1.0&quot; scalaVersion := &quot;2.10.5&quot; libraryDependencies += &quot;org.apache.spark&quot; %% &quot;spark-core&quot; % &quot;1.6.0&quot; libraryDependencies += &quot;org.apache.spark&quot; %% &quot;spark-streaming&quot; % &quot;1.6.0&quot; libraryDependencies += &quot;org.apache.spark&quot; %% &quot;spark-streaming-kafka&quot; % &quot;1.6.0&quot; ç¼–è¯‘/åŒ…è£… è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥ç¼–è¯‘å’Œæ‰“åŒ…åº”ç”¨ç¨‹åºçš„jaræ–‡ä»¶ã€‚ æˆ‘ä»¬éœ€è¦å°†jaræ–‡ä»¶æäº¤åˆ°sparkæ§åˆ¶å°ä»¥è¿è¡Œåº”ç”¨ç¨‹åºã€‚ sbt package æäº¤åˆ°Spark å¯åŠ¨Kafka Producer CLI(åœ¨ä¸Šä¸€ç« ä¸­è§£é‡Š)ï¼Œåˆ›å»ºä¸€ä¸ªåä¸º my-first-topic çš„æ–°ä¸»é¢˜ï¼Œå¹¶æä¾›ä¸€äº›æ ·æœ¬æ¶ˆæ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ Another spark test message è¿è¡Œä»¥ä¸‹å‘½ä»¤å°†åº”ç”¨ç¨‹åºæäº¤åˆ°sparkæ§åˆ¶å°ã€‚ /usr/local/spark/bin/spark-submit --packages org.apache.spark:spark-streaming -kafka_2.10:1.6.0 --class &quot;KafkaWordCount&quot; --master local[4] target/scala-2.10/spark -kafka-project_2.10-1.0.jar localhost:2181 &lt;group name&gt; &lt;topic name&gt; &lt;number of threads&gt; æ­¤åº”ç”¨ç¨‹åºçš„ç¤ºä¾‹è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºã€‚ spark console messages .. (Test,1) (spark,1) (another,1) (message,1) spark console message .. åŸæ–‡ï¼šhttps://www.w3cschool.cn/apache_kafka/apache_kafka_integration_spark.html ","link":"https://tianxiawuhao.github.io/2csXIfKdw/"},{"title":"ç¬¬äºŒç«  Apache Kafka æ•´åˆ Storm","content":"åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•å°†Kafkaä¸Apache Stormé›†æˆã€‚ å…³äºStorm Stormæœ€åˆç”±Nathan Marzå’ŒBackTypeçš„å›¢é˜Ÿåˆ›å»ºã€‚ åœ¨çŸ­æ—¶é—´å†…ï¼ŒApache Stormæˆä¸ºåˆ†å¸ƒå¼å®æ—¶å¤„ç†ç³»ç»Ÿçš„æ ‡å‡†ï¼Œå…è®¸æ‚¨å¤„ç†å¤§é‡æ•°æ®ã€‚ Stormæ˜¯éå¸¸å¿«çš„ï¼Œå¹¶ä¸”ä¸€ä¸ªåŸºå‡†æ—¶é’Ÿä¸ºæ¯ä¸ªèŠ‚ç‚¹æ¯ç§’å¤„ç†è¶…è¿‡ä¸€ç™¾ä¸‡ä¸ªå…ƒç»„ã€‚ Apache StormæŒç»­è¿è¡Œï¼Œä»é…ç½®çš„æº(Spouts)æ¶ˆè€—æ•°æ®ï¼Œå¹¶å°†æ•°æ®ä¼ é€’åˆ°å¤„ç†ç®¡é“(Bolts)ã€‚ è”åˆï¼ŒSpoutså’ŒBoltæ„æˆä¸€ä¸ªæ‹“æ‰‘ã€‚ ä¸Stormé›†æˆ Kafkaå’ŒStormè‡ªç„¶äº’è¡¥ï¼Œå®ƒä»¬å¼ºå¤§çš„åˆä½œèƒ½å¤Ÿå®ç°å¿«é€Ÿç§»åŠ¨çš„å¤§æ•°æ®çš„å®æ—¶æµåˆ†æã€‚ Kafkaå’ŒStormé›†æˆæ˜¯ä¸ºäº†ä½¿å¼€å‘äººå‘˜æ›´å®¹æ˜“åœ°ä»Stormæ‹“æ‰‘è·å–å’Œå‘å¸ƒæ•°æ®æµã€‚ æ¦‚å¿µæµ Spoutsæ˜¯æµçš„æºã€‚ ä¾‹å¦‚ï¼Œä¸€ä¸ªå–·å¤´å¯ä»¥ä»Kafka Topicè¯»å–å…ƒç»„å¹¶å°†å®ƒä»¬ä½œä¸ºæµå‘é€ã€‚ Boltæ¶ˆè€—è¾“å…¥æµï¼Œå¤„ç†å¹¶å¯èƒ½å‘å°„æ–°çš„æµã€‚ Boltå¯ä»¥ä»è¿è¡Œå‡½æ•°ï¼Œè¿‡æ»¤å…ƒç»„ï¼Œæ‰§è¡Œæµèšåˆï¼Œæµè¿æ¥ï¼Œä¸æ•°æ®åº“äº¤è°ˆç­‰ç­‰åšä»»ä½•äº‹æƒ…ã€‚ Stormæ‹“æ‰‘ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹å¹¶è¡Œæ‰§è¡Œã€‚ æ‹“æ‰‘æ— é™è¿è¡Œï¼Œç›´åˆ°ç»ˆæ­¢å®ƒã€‚ Stormå°†è‡ªåŠ¨é‡æ–°åˆ†é…ä»»ä½•å¤±è´¥çš„ä»»åŠ¡ã€‚ æ­¤å¤–ï¼ŒStormä¿è¯æ²¡æœ‰æ•°æ®ä¸¢å¤±ï¼Œå³ä½¿æœºå™¨åœæœºå’Œæ¶ˆæ¯è¢«ä¸¢å¼ƒã€‚ è®©æˆ‘ä»¬è¯¦ç»†äº†è§£Kafka-Stormé›†æˆAPIã€‚ æœ‰ä¸‰ä¸ªä¸»è¦ç±»é›†æˆKafkaä¸Stormã€‚ ä»–ä»¬å¦‚ä¸‹ - BrokerHosts - ZkHosts &amp; StaticHosts BrokerHostsæ˜¯ä¸€ä¸ªæ¥å£ï¼ŒZkHostså’ŒStaticHostsæ˜¯å®ƒçš„ä¸¤ä¸ªä¸»è¦å®ç°ã€‚ ZkHostsç”¨äºé€šè¿‡åœ¨ZooKeeperä¸­ç»´æŠ¤ç»†èŠ‚æ¥åŠ¨æ€è·Ÿè¸ªKafkaä»£ç†ï¼Œè€ŒStaticHostsç”¨äºæ‰‹åŠ¨/é™æ€è®¾ç½®Kafkaä»£ç†åŠå…¶è¯¦ç»†ä¿¡æ¯ã€‚ ZkHostsæ˜¯è®¿é—®Kafkaä»£ç†çš„ç®€å•å¿«æ·çš„æ–¹å¼ã€‚ ZkHostsçš„ç­¾åå¦‚ä¸‹ - public ZkHosts(String brokerZkStr, String brokerZkPath) public ZkHosts(String brokerZkStr) å…¶ä¸­brokerZkStræ˜¯ZooKeeperä¸»æœºï¼ŒbrokerZkPathæ˜¯ZooKeeperè·¯å¾„ä»¥ç»´æŠ¤Kafkaä»£ç†è¯¦ç»†ä¿¡æ¯ã€‚ KafkaConfig API æ­¤APIç”¨äºå®šä¹‰Kafkaé›†ç¾¤çš„é…ç½®è®¾ç½®ã€‚ Kafka Con-figçš„ç­¾åå®šä¹‰å¦‚ä¸‹ public KafkaConfig(BrokerHosts hosts, string topic) ä¸»æœº - BrokerHostså¯ä»¥æ˜¯ZkHosts / StaticHostsã€‚ ä¸»é¢˜ - ä¸»é¢˜åç§°ã€‚ SpoutConfig API Spoutconfigæ˜¯KafkaConfigçš„æ‰©å±•ï¼Œæ”¯æŒé¢å¤–çš„ZooKeeperä¿¡æ¯ã€‚ public SpoutConfig(BrokerHosts hosts, string topic, string zkRoot, string id) ä¸»æœº - BrokerHostså¯ä»¥æ˜¯BrokerHostsæ¥å£çš„ä»»ä½•å®ç° ä¸»é¢˜ - ä¸»é¢˜åç§°ã€‚ zkRoot - ZooKeeperæ ¹è·¯å¾„ã€‚ id - spoutså­˜å‚¨åœ¨Zookeeperä¸­æ¶ˆè€—çš„åç§»é‡çš„çŠ¶æ€ã€‚ IDåº”è¯¥å”¯ä¸€æ ‡è¯†æ‚¨çš„å–·å˜´ã€‚ SchemeAsMultiScheme SchemeAsMultiSchemeæ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”¨äºæŒ‡ç¤ºå¦‚ä½•å°†ä»Kafkaä¸­æ¶ˆè€—çš„ByteBufferè½¬æ¢ä¸ºé£æš´å…ƒç»„ã€‚ å®ƒæºè‡ªMultiSchemeå¹¶æ¥å—Schemeç±»çš„å®ç°ã€‚ æœ‰å¾ˆå¤šSchemeç±»çš„å®ç°ï¼Œä¸€ä¸ªè¿™æ ·çš„å®ç°æ˜¯StringSchemeï¼Œå®ƒå°†å­—èŠ‚è§£æä¸ºä¸€ä¸ªç®€å•çš„å­—ç¬¦ä¸²ã€‚ å®ƒè¿˜æ§åˆ¶è¾“å‡ºå­—æ®µçš„å‘½åã€‚ ç­¾åå®šä¹‰å¦‚ä¸‹ã€‚ public SchemeAsMultiScheme(Scheme scheme) æ–¹æ¡ˆ - ä»kafkaæ¶ˆè€—çš„å­—èŠ‚ç¼“å†²åŒºã€‚ KafkaSpout API KafkaSpoutæ˜¯æˆ‘ä»¬çš„spoutå®ç°ï¼Œå®ƒå°†ä¸Stormé›†æˆã€‚ å®ƒä»kafkaä¸»é¢˜è·å–æ¶ˆæ¯ï¼Œå¹¶å°†å…¶ä½œä¸ºå…ƒç»„å‘é€åˆ°Stormç”Ÿæ€ç³»ç»Ÿã€‚ KafkaSpoutä»SpoutConfigè·å–å…¶é…ç½®è¯¦ç»†ä¿¡æ¯ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªåˆ›å»ºä¸€ä¸ªç®€å•çš„Kafkaå–·æ°´å˜´çš„ç¤ºä¾‹ä»£ç ã€‚ // ZooKeeper connection string BrokerHosts hosts = new ZkHosts(zkConnString); //Creating SpoutConfig Object SpoutConfig spoutConfig = new SpoutConfig(hosts, topicName, &quot;/&quot; + topicName UUID.randomUUID().toString()); //convert the ByteBuffer to String. spoutConfig.scheme = new SchemeAsMultiScheme(new StringScheme()); //Assign SpoutConfig to KafkaSpout. KafkaSpout kafkaSpout = new KafkaSpout(spoutConfig); åˆ›å»ºBolt Boltæ˜¯ä¸€ä¸ªä½¿ç”¨å…ƒç»„ä½œä¸ºè¾“å…¥ï¼Œå¤„ç†å…ƒç»„ï¼Œå¹¶äº§ç”Ÿæ–°çš„å…ƒç»„ä½œä¸ºè¾“å‡ºçš„ç»„ä»¶ã€‚ Boltå°†å®ç°IRichBoltæ¥å£ã€‚ åœ¨æ­¤ç¨‹åºä¸­ï¼Œä½¿ç”¨ä¸¤ä¸ªBoltç±»WordSplitter-Boltå’ŒWordCounterBoltæ¥æ‰§è¡Œæ“ä½œã€‚ IRichBoltæ¥å£æœ‰ä»¥ä¸‹æ–¹æ³• - å‡†å¤‡ - ä¸ºBoltæä¾›è¦æ‰§è¡Œçš„ç¯å¢ƒã€‚ æ‰§è¡Œå™¨å°†è¿è¡Œæ­¤æ–¹æ³•æ¥åˆå§‹åŒ–å–·å¤´ã€‚ æ‰§è¡Œ - å¤„ç†å•ä¸ªå…ƒç»„çš„è¾“å…¥ã€‚ æ¸…ç† - å½“Boltè¦å…³é—­æ—¶è°ƒç”¨ã€‚ declareOutputFields - å£°æ˜å…ƒç»„çš„è¾“å‡ºæ¨¡å¼ã€‚ è®©æˆ‘ä»¬åˆ›å»ºSplitBolt.javaï¼Œå®ƒå®ç°é€»è¾‘åˆ†å‰²ä¸€ä¸ªå¥å­åˆ°è¯å’ŒCountBolt.javaï¼Œå®ƒå®ç°é€»è¾‘åˆ†ç¦»ç‹¬ç‰¹çš„å•è¯å’Œè®¡æ•°å…¶å‡ºç°ã€‚ SplitBolt.java import java.util.Map; import backtype.storm.tuple.Tuple; import backtype.storm.tuple.Fields; import backtype.storm.tuple.Values; import backtype.storm.task.OutputCollector; import backtype.storm.topology.OutputFieldsDeclarer; import backtype.storm.topology.IRichBolt; import backtype.storm.task.TopologyContext; public class SplitBolt implements IRichBolt { private OutputCollector collector; @Override public void prepare(Map stormConf, TopologyContext context, OutputCollector collector) { this.collector = collector; } @Override public void execute(Tuple input) { String sentence = input.getString(0); String[] words = sentence.split(&quot; &quot;); for(String word: words) { word = word.trim(); if(!word.isEmpty()) { word = word.toLowerCase(); collector.emit(new Values(word)); } } collector.ack(input); } @Override public void declareOutputFields(OutputFieldsDeclarer declarer) { declarer.declare(new Fields(&quot;word&quot;)); } @Override public void cleanup() {} @Override public Map&lt;String, Object&gt; getComponentConfiguration() { return null; } } CountBolt.java import java.util.Map; import java.util.HashMap; import backtype.storm.tuple.Tuple; import backtype.storm.task.OutputCollector; import backtype.storm.topology.OutputFieldsDeclarer; import backtype.storm.topology.IRichBolt; import backtype.storm.task.TopologyContext; public class CountBolt implements IRichBolt{ Map&lt;String, Integer&gt; counters; private OutputCollector collector; @Override public void prepare(Map stormConf, TopologyContext context, OutputCollector collector) { this.counters = new HashMap&lt;String, Integer&gt;(); this.collector = collector; } @Override public void execute(Tuple input) { String str = input.getString(0); if(!counters.containsKey(str)){ counters.put(str, 1); }else { Integer c = counters.get(str) +1; counters.put(str, c); } collector.ack(input); } @Override public void cleanup() { for(Map.Entry&lt;String, Integer&gt; entry:counters.entrySet()){ System.out.println(entry.getKey()&amp;plus;&quot; : &quot; &amp;plus; entry.getValue()); } } @Override public void declareOutputFields(OutputFieldsDeclarer declarer) { } @Override public Map&lt;String, Object&gt; getComponentConfiguration() { return null; } } æäº¤æ‹“æ‰‘ Stormæ‹“æ‰‘åŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªThriftç»“æ„ã€‚ TopologyBuilderç±»æä¾›äº†ç®€å•è€Œå®¹æ˜“çš„æ–¹æ³•æ¥åˆ›å»ºå¤æ‚çš„æ‹“æ‰‘ã€‚ TopologyBuilderç±»å…·æœ‰è®¾ç½®spout(setSpout)å’Œè®¾ç½®bolt(setBolt)çš„æ–¹æ³•ã€‚ æœ€åï¼ŒTopologyBuilderæœ‰createTopologyæ¥åˆ›å»ºto-pologyã€‚ shuffleGroupingå’ŒfieldsGroupingæ–¹æ³•æœ‰åŠ©äºä¸ºå–·å¤´å’ŒBoltè®¾ç½®æµåˆ†ç»„ã€‚ æœ¬åœ°é›†ç¾¤ - ä¸ºäº†å¼€å‘ç›®çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ LocalCluster å¯¹è±¡åˆ›å»ºæœ¬åœ°é›†ç¾¤ï¼Œç„¶åä½¿ç”¨ LocalClusterçš„ submitTopology ç±»ã€‚ KafkaStormSample.java import backtype.storm.Config; import backtype.storm.LocalCluster; import backtype.storm.topology.TopologyBuilder; import java.util.ArrayList; import java.util.List; import java.util.UUID; import backtype.storm.spout.SchemeAsMultiScheme; import storm.kafka.trident.GlobalPartitionInformation; import storm.kafka.ZkHosts; import storm.kafka.Broker; import storm.kafka.StaticHosts; import storm.kafka.BrokerHosts; import storm.kafka.SpoutConfig; import storm.kafka.KafkaConfig; import storm.kafka.KafkaSpout; import storm.kafka.StringScheme; public class KafkaStormSample { public static void main(String[] args) throws Exception{ Config config = new Config(); config.setDebug(true); config.put(Config.TOPOLOGY_MAX_SPOUT_PENDING, 1); String zkConnString = &quot;localhost:2181&quot;; String topic = &quot;my-first-topic&quot;; BrokerHosts hosts = new ZkHosts(zkConnString); SpoutConfig kafkaSpoutConfig = new SpoutConfig (hosts, topic, &quot;/&quot; + topic, UUID.randomUUID().toString()); kafkaSpoutConfig.bufferSizeBytes = 1024 * 1024 * 4; kafkaSpoutConfig.fetchSizeBytes = 1024 * 1024 * 4; kafkaSpoutConfig.forceFromStart = true; kafkaSpoutConfig.scheme = new SchemeAsMultiScheme(new StringScheme()); TopologyBuilder builder = new TopologyBuilder(); builder.setSpout(&quot;kafka-spout&quot;, new KafkaSpout(kafkaSpoutCon-fig)); builder.setBolt(&quot;word-spitter&quot;, new SplitBolt()).shuffleGroup-ing(&quot;kafka-spout&quot;); builder.setBolt(&quot;word-counter&quot;, new CountBolt()).shuffleGroup-ing(&quot;word-spitter&quot;); LocalCluster cluster = new LocalCluster(); cluster.submitTopology(&quot;KafkaStormSample&quot;, config, builder.create-Topology()); Thread.sleep(10000); cluster.shutdown(); } } åœ¨ç§»åŠ¨ç¼–è¯‘ä¹‹å‰ï¼ŒKakfa-Stormé›†æˆéœ€è¦ç­–å±•äººZooKeeperå®¢æˆ·ç«¯javaåº“ã€‚ ç­–å±•äººç‰ˆæœ¬2.9.1æ”¯æŒApache Storm 0.9.5ç‰ˆ(æˆ‘ä»¬åœ¨æœ¬æ•™ç¨‹ä¸­ä½¿ç”¨)ã€‚ ä¸‹è½½ä¸‹é¢æŒ‡å®šçš„jaræ–‡ä»¶å¹¶å°†å…¶æ”¾åœ¨javaç±»è·¯å¾„ä¸­ã€‚ curator-client-2.9.1.jar curator-framework-2.9.1.jar åœ¨åŒ…æ‹¬ä¾èµ–æ–‡ä»¶ä¹‹åï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç¼–è¯‘ç¨‹åºï¼Œ javac -cp &quot;/path/to/Kafka/apache-storm-0.9.5/lib/*&quot; *.java æ‰§è¡Œ å¯åŠ¨Kafka Producer CLI(åœ¨ä¸Šä¸€ç« èŠ‚ä¸­è§£é‡Š)ï¼Œåˆ›å»ºä¸€ä¸ªåä¸º my-first-topic çš„æ–°ä¸»é¢˜ï¼Œå¹¶æä¾›ä¸€äº›æ ·æœ¬æ¶ˆæ¯ï¼Œå¦‚ä¸‹æ‰€ç¤º - hello kafka storm spark test message another test message ç°åœ¨ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰§è¡Œåº”ç”¨ç¨‹åº - java -cp â€œ/path/to/Kafka/apache-storm-0.9.5/lib/*&quot;:. KafkaStormSample æ­¤åº”ç”¨ç¨‹åºçš„ç¤ºä¾‹è¾“å‡ºå¦‚ä¸‹æ‰€ç¤º - storm : 1 test : 2 spark : 1 another : 1 kafka : 1 hello : 1 message : 2 åŸæ–‡ï¼šhttps://www.w3cschool.cn/apache_kafka/apache_kafka_integration_storm.html ","link":"https://tianxiawuhao.github.io/wAqEEPZon/"},{"title":"ç¬¬ä¸€ç«  Kafkaçš„å®‰è£…ä¸ä½¿ç”¨","content":"Kafka åŸºç¡€çŸ¥è¯† å¯¹äºå¤§æ•°æ®ï¼Œæˆ‘ä»¬è¦è€ƒè™‘çš„é—®é¢˜æœ‰å¾ˆå¤šï¼Œé¦–å…ˆæµ·é‡æ•°æ®å¦‚ä½•æ”¶é›†ï¼ˆå¦‚ Flumeï¼‰ï¼Œç„¶åå¯¹äºæ”¶é›†åˆ°çš„æ•°æ®å¦‚ä½•å­˜å‚¨ï¼ˆå…¸å‹çš„åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ HDFSã€åˆ†å¸ƒå¼æ•°æ®åº“ HBaseã€NoSQL æ•°æ®åº“ Redisï¼‰ï¼Œå…¶æ¬¡å­˜å‚¨çš„æ•°æ®ä¸æ˜¯å­˜èµ·æ¥å°±æ²¡äº‹äº†ï¼Œè¦é€šè¿‡è®¡ç®—ä»ä¸­è·å–æœ‰ç”¨çš„ä¿¡æ¯ï¼Œè¿™å°±æ¶‰åŠåˆ°è®¡ç®—æ¨¡å‹ï¼ˆå…¸å‹çš„ç¦»çº¿è®¡ç®— MapReduceã€æµå¼å®æ—¶è®¡ç®—Stormã€Sparkï¼‰ï¼Œæˆ–è€…è¦ä»æ•°æ®ä¸­æŒ–æ˜ä¿¡æ¯ï¼Œè¿˜éœ€è¦ç›¸åº”çš„æœºå™¨å­¦ä¹ ç®—æ³•ã€‚åœ¨è¿™äº›ä¹‹ä¸Šï¼Œè¿˜æœ‰ä¸€äº›å„ç§å„æ ·çš„æŸ¥è¯¢åˆ†ææ•°æ®çš„å·¥å…·ï¼ˆå¦‚ Hiveã€Pig ç­‰ï¼‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¦æ„å»ºåˆ†å¸ƒå¼åº”ç”¨è¿˜éœ€è¦ä¸€äº›å·¥å…·ï¼Œæ¯”å¦‚åˆ†å¸ƒå¼åè°ƒæœåŠ¡ Zookeeper ç­‰ç­‰ã€‚ è¿™é‡Œï¼Œæˆ‘ä»¬è®²åˆ°çš„æ˜¯æ¶ˆæ¯ç³»ç»Ÿï¼ŒKafka ä¸“ä¸ºåˆ†å¸ƒå¼é«˜ååé‡ç³»ç»Ÿè€Œè®¾è®¡ï¼Œå…¶ä»–æ¶ˆæ¯ä¼ é€’ç³»ç»Ÿç›¸æ¯”ï¼ŒKafka å…·æœ‰æ›´å¥½çš„ååé‡ï¼Œå†…ç½®åˆ†åŒºï¼Œå¤åˆ¶å’Œå›ºæœ‰çš„å®¹é”™èƒ½åŠ›ï¼Œè¿™ä½¿å¾—å®ƒéå¸¸é€‚åˆå¤§è§„æ¨¡æ¶ˆæ¯å¤„ç†åº”ç”¨ç¨‹åºã€‚ æ¶ˆæ¯ç³»ç»Ÿ â€‹ ç‚¹å¯¹ç‚¹æ¶ˆæ¯ç³»ç»Ÿï¼šç”Ÿäº§è€…å‘é€ä¸€æ¡æ¶ˆæ¯åˆ°queueï¼Œä¸€ä¸ªqueueå¯ä»¥æœ‰å¾ˆå¤šæ¶ˆè´¹è€…ï¼Œä½†æ˜¯ä¸€ä¸ªæ¶ˆæ¯åªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¥å—ï¼Œå½“æ²¡æœ‰æ¶ˆè´¹è€…å¯ç”¨æ—¶ï¼Œè¿™ä¸ªæ¶ˆæ¯ä¼šè¢«ä¿å­˜ç›´åˆ°æœ‰ ä¸€ä¸ªå¯ç”¨çš„æ¶ˆè´¹è€…ï¼Œæ‰€ä»¥Queueå®ç°äº†ä¸€ä¸ªå¯é çš„è´Ÿè½½å‡è¡¡ã€‚ â€‹ å‘å¸ƒè®¢é˜…æ¶ˆæ¯ç³»ç»Ÿï¼šå‘å¸ƒè€…å‘é€åˆ°topicçš„æ¶ˆæ¯ï¼Œåªæœ‰è®¢é˜…äº†topicçš„è®¢é˜…è€…æ‰ä¼šæ”¶åˆ°æ¶ˆæ¯ã€‚topicå®ç°äº†å‘å¸ƒå’Œè®¢é˜…ï¼Œå½“ä½ å‘å¸ƒä¸€ä¸ªæ¶ˆæ¯ï¼Œæ‰€æœ‰è®¢é˜…è¿™ä¸ªtopicçš„æœåŠ¡éƒ½èƒ½å¾—åˆ°è¿™ä¸ªæ¶ˆæ¯ï¼Œæ‰€ä»¥ä»1åˆ°Nä¸ªè®¢é˜…è€…éƒ½èƒ½å¾—åˆ°è¿™ä¸ªæ¶ˆæ¯çš„æ‹·è´ã€‚ kafkaæœ¯è¯­ Apache Kafka æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼å‘å¸ƒ - è®¢é˜…æ¶ˆæ¯ç³»ç»Ÿå’Œä¸€ä¸ªå¼ºå¤§çš„é˜Ÿåˆ—ï¼Œå¯ä»¥å¤„ç†å¤§é‡çš„æ•°æ®ï¼Œå¹¶ä½¿ä½ èƒ½å¤Ÿå°†æ¶ˆæ¯ä»ä¸€ä¸ªç«¯ç‚¹ä¼ é€’åˆ°å¦ä¸€ä¸ªç«¯ç‚¹ã€‚ Kafka é€‚åˆç¦»çº¿å’Œåœ¨çº¿æ¶ˆæ¯æ¶ˆè´¹ã€‚ Kafka æ¶ˆæ¯ä¿ç•™åœ¨ç£ç›˜ä¸Šï¼Œå¹¶åœ¨ç¾¤é›†å†…å¤åˆ¶ä»¥é˜²æ­¢æ•°æ®ä¸¢å¤±ã€‚ Kafka æ„å»ºåœ¨ ZooKeeper åŒæ­¥æœåŠ¡ä¹‹ä¸Šã€‚ å®ƒä¸ Apache Storm å’Œ Spark éå¸¸å¥½åœ°é›†æˆï¼Œç”¨äºå®æ—¶æµå¼æ•°æ®åˆ†æã€‚ Kafka æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå…·æœ‰é«˜æ€§èƒ½ã€æŒä¹…åŒ–ã€å¤šå‰¯æœ¬å¤‡ä»½ã€æ¨ªå‘æ‰©å±•èƒ½åŠ›ã€‚ç”Ÿäº§è€…å¾€é˜Ÿåˆ—é‡Œå†™æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ä»é˜Ÿåˆ—é‡Œå–æ¶ˆæ¯è¿›è¡Œä¸šåŠ¡é€»è¾‘ã€‚ä¸€èˆ¬åœ¨æ¶æ„è®¾è®¡ä¸­èµ·åˆ°è§£è€¦ã€å‰Šå³°ã€å¼‚æ­¥å¤„ç†çš„ä½œç”¨ã€‚ â€‹ æ¶ˆæ¯ç”±produceräº§ç”Ÿï¼Œæ¶ˆæ¯æŒ‰ç…§topicå½’ç±»ï¼Œå¹¶å‘é€åˆ°brokerä¸­ï¼Œbrokerä¸­ä¿å­˜äº†ä¸€ä¸ªæˆ–å¤šä¸ªtopicçš„æ¶ˆæ¯ï¼Œconsumeré€šè¿‡è®¢é˜…ä¸€ç»„topicçš„æ¶ˆæ¯ï¼Œé€šè¿‡æŒç»­çš„pollæ“ä½œä»brokerè·å–æ¶ˆæ¯ï¼Œå¹¶è¿›è¡Œåç»­çš„æ¶ˆæ¯å¤„ç†ã€‚ Producer ï¼šæ¶ˆæ¯ç”Ÿäº§è€…ï¼Œå°±æ˜¯å‘brokerå‘æŒ‡å®štopicæ¶ˆæ¯çš„å®¢æˆ·ç«¯ã€‚ Consumer ï¼šæ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œé€šè¿‡è®¢é˜…ä¸€ç»„topicçš„æ¶ˆæ¯ï¼Œä»brokerè¯»å–æ¶ˆæ¯çš„å®¢æˆ·ç«¯ã€‚ Broker ï¼šä¸€ä¸ªkafkaé›†ç¾¤åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡å™¨ï¼Œä¸€å°kafkaæœåŠ¡å™¨å°±æ˜¯ä¸€ä¸ªbrokerï¼Œç”¨äºä¿å­˜producerå‘é€çš„æ¶ˆæ¯ã€‚ä¸€ä¸ªbrokerå¯ä»¥å®¹çº³å¤šä¸ªtopicã€‚ Topic ï¼šæ¯æ¡å‘é€åˆ°brokerçš„æ¶ˆæ¯éƒ½æœ‰ä¸€ä¸ªç±»åˆ«ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªé˜Ÿåˆ—æˆ–è€…æ•°æ®åº“çš„ä¸€å¼ è¡¨ã€‚ Partitionï¼šä¸€ä¸ªtopicçš„æ¶ˆæ¯ç”±å¤šä¸ªpartitioné˜Ÿåˆ—å­˜å‚¨çš„ï¼Œä¸€ä¸ªpartitioné˜Ÿåˆ—åœ¨kafkaä¸Šç§°ä¸ºä¸€ä¸ªåˆ†åŒºã€‚æ¯ä¸ªpartitionæ˜¯ä¸€ä¸ªæœ‰åºçš„é˜Ÿåˆ—ï¼Œå¤šä¸ªpartitioné—´åˆ™æ˜¯æ— åºçš„ã€‚partitionä¸­çš„æ¯æ¡æ¶ˆæ¯éƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªæœ‰åºçš„idï¼ˆoffsetï¼‰ã€‚ Offsetï¼šåç§»é‡ã€‚kafkaä¸ºæ¯æ¡åœ¨åˆ†åŒºçš„æ¶ˆæ¯ä¿å­˜ä¸€ä¸ªåç§»é‡offsetï¼Œè¿™ä¹Ÿæ˜¯æ¶ˆè´¹è€…åœ¨åˆ†åŒºçš„ä½ç½®ã€‚kafkaçš„å­˜å‚¨æ–‡ä»¶éƒ½æ˜¯æŒ‰ç…§offset.kafkaæ¥å‘½åï¼Œä½äº2049ä½ç½®çš„å³ä¸º2048.kafkaçš„æ–‡ä»¶ã€‚æ¯”å¦‚ä¸€ä¸ªåç§»é‡æ˜¯5çš„æ¶ˆè´¹è€…ï¼Œè¡¨ç¤ºå·²ç»æ¶ˆè´¹äº†ä»0-4åç§»é‡çš„æ¶ˆæ¯ï¼Œä¸‹ä¸€ä¸ªè¦æ¶ˆè´¹çš„æ¶ˆæ¯çš„åç§»é‡æ˜¯5ã€‚ Consumer Group ï¼ˆCGï¼‰ï¼šè‹¥å¹²ä¸ªConsumerç»„æˆçš„é›†åˆã€‚è¿™æ˜¯kafkaç”¨æ¥å®ç°ä¸€ä¸ªtopicæ¶ˆæ¯çš„å¹¿æ’­ï¼ˆå‘ç»™æ‰€æœ‰çš„consumerï¼‰å’Œå•æ’­ï¼ˆå‘ç»™ä»»æ„ä¸€ä¸ªconsumerï¼‰çš„æ‰‹æ®µã€‚ä¸€ä¸ªtopicå¯ä»¥æœ‰å¤šä¸ªCGã€‚topicçš„æ¶ˆæ¯ä¼šå¤åˆ¶ï¼ˆä¸æ˜¯çœŸçš„å¤åˆ¶ï¼Œæ˜¯æ¦‚å¿µä¸Šçš„ï¼‰åˆ°æ‰€æœ‰çš„CGï¼Œä½†æ¯ä¸ªCGåªä¼šæŠŠæ¶ˆæ¯å‘ç»™è¯¥CGä¸­çš„ä¸€ä¸ªconsumerã€‚å¦‚æœéœ€è¦å®ç°å¹¿æ’­ï¼Œåªè¦æ¯ä¸ªconsumeræœ‰ä¸€ä¸ªç‹¬ç«‹çš„CGå°±å¯ä»¥äº†ã€‚è¦å®ç°å•æ’­åªè¦æ‰€æœ‰çš„consumeråœ¨åŒä¸€ä¸ªCGã€‚ç”¨CGè¿˜å¯ä»¥å°†consumerè¿›è¡Œè‡ªç”±çš„åˆ†ç»„è€Œä¸éœ€è¦å¤šæ¬¡å‘é€æ¶ˆæ¯åˆ°ä¸åŒçš„topicã€‚ â€‹ å‡å¦‚ä¸€ä¸ªæ¶ˆè´¹è€…ç»„æœ‰ä¸¤ä¸ªæ¶ˆè´¹è€…ï¼Œè®¢é˜…äº†ä¸€ä¸ªå…·æœ‰4ä¸ªåˆ†åŒºçš„topicçš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆè¿™ä¸ªæ¶ˆè´¹è€…ç»„çš„æ¯ä¸€ä¸ªæ¶ˆè´¹è€…éƒ½ä¼šæ¶ˆè´¹ä¸¤ä¸ªåˆ†åŒºçš„æ¶ˆæ¯ã€‚æ¶ˆè´¹è€…ç»„çš„æˆå‘˜æ˜¯åŠ¨æ€ç»´æŠ¤çš„ï¼Œå¦‚æœæ–°å¢æˆ–è€…å‡å°‘äº†æ¶ˆè´¹è€…ç»„ä¸­çš„æ¶ˆè´¹è€…ï¼Œé‚£ä¹ˆæ¯ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹çš„åˆ†åŒºçš„æ¶ˆæ¯ä¹Ÿä¼šåŠ¨æ€å˜åŒ–ã€‚æ¯”å¦‚åŸæ¥ä¸€ä¸ªæ¶ˆè´¹è€…ç»„æœ‰ä¸¤ä¸ªæ¶ˆè´¹è€…ï¼Œå…¶ä¸­ä¸€ä¸ªæ¶ˆè´¹è€…å› ä¸ºæ•…éšœè€Œä¸èƒ½ç»§ç»­æ¶ˆè´¹æ¶ˆæ¯äº†ï¼Œé‚£ä¹ˆå‰©ä¸‹ä¸€ä¸ªæ¶ˆè´¹è€…å°†ä¼šæ¶ˆè´¹å…¨éƒ¨4ä¸ªåˆ†åŒºçš„æ¶ˆæ¯ã€‚ Apache KafkaåŸºæœ¬åŸç† 1ã€åˆ†å¸ƒå¼å’Œåˆ†åŒºï¼ˆdistributedã€partitionedï¼‰ æˆ‘ä»¬è¯´ kafka æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ¶ˆæ¯ç³»ç»Ÿï¼Œæ‰€è°“çš„åˆ†å¸ƒå¼ï¼Œå®é™…ä¸Šæˆ‘ä»¬å·²ç»å¤§è‡´äº†è§£ã€‚æ¶ˆæ¯ä¿å­˜åœ¨ Topic ä¸­ï¼Œè€Œä¸ºäº†èƒ½å¤Ÿå®ç°å¤§æ•°æ®çš„å­˜å‚¨ï¼Œä¸€ä¸ª topic åˆ’åˆ†ä¸ºå¤šä¸ªåˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºå¯¹åº”ä¸€ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥åˆ†åˆ«å­˜å‚¨åˆ°ä¸åŒçš„æœºå™¨ä¸Šï¼Œä»¥å®ç°åˆ†å¸ƒå¼çš„é›†ç¾¤å­˜å‚¨ã€‚å¦å¤–ï¼Œæ¯ä¸ª partition å¯ä»¥æœ‰ä¸€å®šçš„å‰¯æœ¬ï¼Œå¤‡ä»½åˆ°å¤šå°æœºå™¨ä¸Šï¼Œä»¥æé«˜å¯ç”¨æ€§ã€‚ æ€»ç»“èµ·æ¥å°±æ˜¯ï¼šä¸€ä¸ª topic å¯¹åº”çš„å¤šä¸ª partition åˆ†æ•£å­˜å‚¨åˆ°é›†ç¾¤ä¸­çš„å¤šä¸ª broker ä¸Šï¼Œå­˜å‚¨æ–¹å¼æ˜¯ä¸€ä¸ª partition å¯¹åº”ä¸€ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ª broker è´Ÿè´£å­˜å‚¨åœ¨è‡ªå·±æœºå™¨ä¸Šçš„ partition ä¸­çš„æ¶ˆæ¯è¯»å†™ã€‚ 2ã€å‰¯æœ¬ï¼ˆreplicated ï¼‰ kafka è¿˜å¯ä»¥é…ç½® partitions éœ€è¦å¤‡ä»½çš„ä¸ªæ•°(replicas),æ¯ä¸ª partition å°†ä¼šè¢«å¤‡ä»½åˆ°å¤šå°æœºå™¨ä¸Š,ä»¥æé«˜å¯ç”¨æ€§ï¼Œå¤‡ä»½çš„æ•°é‡å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶æŒ‡å®šã€‚ è¿™ç§å†—ä½™å¤‡ä»½çš„æ–¹å¼åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ˜¯å¾ˆå¸¸è§çš„ï¼Œé‚£ä¹ˆæ—¢ç„¶æœ‰å‰¯æœ¬ï¼Œå°±æ¶‰åŠåˆ°å¯¹åŒä¸€ä¸ªæ–‡ä»¶çš„å¤šä¸ªå¤‡ä»½å¦‚ä½•è¿›è¡Œç®¡ç†å’Œè°ƒåº¦ã€‚kafka é‡‡å–çš„æ–¹æ¡ˆæ˜¯ï¼šæ¯ä¸ª partition é€‰ä¸¾ä¸€ä¸ª server ä½œä¸ºâ€œleaderâ€ï¼Œç”± leader è´Ÿè´£æ‰€æœ‰å¯¹è¯¥åˆ†åŒºçš„è¯»å†™ï¼Œå…¶ä»– server ä½œä¸º follower åªéœ€è¦ç®€å•çš„ä¸ leader åŒæ­¥ï¼Œä¿æŒè·Ÿè¿›å³å¯ã€‚å¦‚æœåŸæ¥çš„ leader å¤±æ•ˆï¼Œä¼šé‡æ–°é€‰ä¸¾ç”±å…¶ä»–çš„ follower æ¥æˆä¸ºæ–°çš„ leaderã€‚ è‡³äºå¦‚ä½•é€‰å– leaderï¼Œå®é™…ä¸Šå¦‚æœæˆ‘ä»¬äº†è§£ ZooKeeperï¼Œå°±ä¼šå‘ç°å…¶å®è¿™æ­£æ˜¯ Zookeeper æ‰€æ“…é•¿çš„ï¼ŒKafka ä½¿ç”¨ ZK åœ¨ Broker ä¸­é€‰å‡ºä¸€ä¸ª Controllerï¼Œç”¨äº Partition åˆ†é…å’Œ Leader é€‰ä¸¾ã€‚ å¦å¤–ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå®é™…ä¸Šä½œä¸º leader çš„ server æ‰¿æ‹…äº†è¯¥åˆ†åŒºæ‰€æœ‰çš„è¯»å†™è¯·æ±‚ï¼Œå› æ­¤å…¶å‹åŠ›æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œä»æ•´ä½“è€ƒè™‘ï¼Œä»å¤šå°‘ä¸ª partition å°±æ„å‘³ç€ä¼šæœ‰å¤šå°‘ä¸ªleaderï¼Œkafka ä¼šå°† leader åˆ†æ•£åˆ°ä¸åŒçš„ broker ä¸Šï¼Œç¡®ä¿æ•´ä½“çš„è´Ÿè½½å‡è¡¡ã€‚ 3ã€æ•´ä½“æ•°æ®æµç¨‹ Kafka çš„æ€»ä½“æ•°æ®æµæ»¡è¶³ä¸‹å›¾ï¼Œè¯¥å›¾å¯ä»¥è¯´æ˜¯æ¦‚æ‹¬äº†æ•´ä¸ª kafka çš„åŸºæœ¬åŸç†ã€‚ ï¼ˆ1ï¼‰æ•°æ®ç”Ÿäº§è¿‡ç¨‹ï¼ˆProduceï¼‰ å¯¹äºç”Ÿäº§è€…è¦å†™å…¥çš„ä¸€æ¡è®°å½•ï¼Œå¯ä»¥æŒ‡å®šå››ä¸ªå‚æ•°ï¼šåˆ†åˆ«æ˜¯ topicã€partitionã€key å’Œ valueï¼Œå…¶ä¸­ topic å’Œ valueï¼ˆè¦å†™å…¥çš„æ•°æ®ï¼‰æ˜¯å¿…é¡»è¦æŒ‡å®šçš„ï¼Œè€Œ key å’Œ partition æ˜¯å¯é€‰çš„ã€‚ å¯¹äºä¸€æ¡è®°å½•ï¼Œå…ˆå¯¹å…¶è¿›è¡Œåºåˆ—åŒ–ï¼Œç„¶åæŒ‰ç…§ Topic å’Œ Partitionï¼Œæ”¾è¿›å¯¹åº”çš„å‘é€é˜Ÿåˆ—ä¸­ã€‚å¦‚æœ Partition æ²¡å¡«ï¼Œé‚£ä¹ˆæƒ…å†µä¼šæ˜¯è¿™æ ·çš„ï¼šaã€Key æœ‰å¡«ã€‚æŒ‰ç…§ Key è¿›è¡Œå“ˆå¸Œï¼Œç›¸åŒ Key å»ä¸€ä¸ª Partitionã€‚bã€Key æ²¡å¡«ã€‚Round-Robin æ¥é€‰ Partitionã€‚ producer å°†ä¼šå’ŒTopicä¸‹æ‰€æœ‰ partition leader ä¿æŒ socket è¿æ¥ï¼Œæ¶ˆæ¯ç”± producer ç›´æ¥é€šè¿‡ socket å‘é€åˆ° brokerã€‚å…¶ä¸­ partition leader çš„ä½ç½®( host : port )æ³¨å†Œåœ¨ zookeeper ä¸­ï¼Œproducer ä½œä¸º zookeeper clientï¼Œå·²ç»æ³¨å†Œäº† watch ç”¨æ¥ç›‘å¬ partition leader çš„å˜æ›´äº‹ä»¶ï¼Œå› æ­¤ï¼Œå¯ä»¥å‡†ç¡®çš„çŸ¥é“è°æ˜¯å½“å‰çš„ leaderã€‚ producer ç«¯é‡‡ç”¨å¼‚æ­¥å‘é€ï¼šå°†å¤šæ¡æ¶ˆæ¯æš‚ä¸”åœ¨å®¢æˆ·ç«¯ buffer èµ·æ¥ï¼Œå¹¶å°†ä»–ä»¬æ‰¹é‡çš„å‘é€åˆ° brokerï¼Œå°æ•°æ® IO å¤ªå¤šï¼Œä¼šæ‹–æ…¢æ•´ä½“çš„ç½‘ç»œå»¶è¿Ÿï¼Œæ‰¹é‡å»¶è¿Ÿå‘é€äº‹å®ä¸Šæå‡äº†ç½‘ç»œæ•ˆç‡ã€‚ ï¼ˆ2ï¼‰æ•°æ®æ¶ˆè´¹è¿‡ç¨‹ï¼ˆConsumeï¼‰ å¯¹äºæ¶ˆè´¹è€…ï¼Œä¸æ˜¯ä»¥å•ç‹¬çš„å½¢å¼å­˜åœ¨çš„ï¼Œæ¯ä¸€ä¸ªæ¶ˆè´¹è€…å±äºä¸€ä¸ª consumer groupï¼Œä¸€ä¸ª group åŒ…å«å¤šä¸ª consumerã€‚ç‰¹åˆ«éœ€è¦æ³¨æ„çš„æ˜¯ï¼šè®¢é˜… Topic æ˜¯ä»¥ä¸€ä¸ªæ¶ˆè´¹ç»„æ¥è®¢é˜…çš„ï¼Œå‘é€åˆ° Topic çš„æ¶ˆæ¯ï¼Œåªä¼šè¢«è®¢é˜…æ­¤ Topic çš„æ¯ä¸ª group ä¸­çš„ä¸€ä¸ª consumer æ¶ˆè´¹ã€‚ å¦‚æœæ‰€æœ‰çš„ Consumer éƒ½å…·æœ‰ç›¸åŒçš„ groupï¼Œé‚£ä¹ˆå°±åƒæ˜¯ä¸€ä¸ªç‚¹å¯¹ç‚¹çš„æ¶ˆæ¯ç³»ç»Ÿï¼›å¦‚æœæ¯ä¸ª consumer éƒ½å…·æœ‰ä¸åŒçš„ groupï¼Œé‚£ä¹ˆæ¶ˆæ¯ä¼šå¹¿æ’­ç»™æ‰€æœ‰çš„æ¶ˆè´¹è€…ã€‚ å…·ä½“è¯´æ¥ï¼Œè¿™å®é™…ä¸Šæ˜¯æ ¹æ® partition æ¥åˆ†çš„ï¼Œä¸€ä¸ª Partitionï¼Œåªèƒ½è¢«æ¶ˆè´¹ç»„é‡Œçš„ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œä½†æ˜¯å¯ä»¥åŒæ—¶è¢«å¤šä¸ªæ¶ˆè´¹ç»„æ¶ˆè´¹ï¼Œæ¶ˆè´¹ç»„é‡Œçš„æ¯ä¸ªæ¶ˆè´¹è€…æ˜¯å…³è”åˆ°ä¸€ä¸ª partition çš„ï¼Œå› æ­¤æœ‰è¿™æ ·çš„è¯´æ³•ï¼šå¯¹äºä¸€ä¸ª topic,åŒä¸€ä¸ª group ä¸­ä¸èƒ½æœ‰å¤šäº partitions ä¸ªæ•°çš„ consumer åŒæ—¶æ¶ˆè´¹,å¦åˆ™å°†æ„å‘³ç€æŸäº› consumer å°†æ— æ³•å¾—åˆ°æ¶ˆæ¯ã€‚ åŒä¸€ä¸ªæ¶ˆè´¹ç»„çš„ä¸¤ä¸ªæ¶ˆè´¹è€…ä¸ä¼šåŒæ—¶æ¶ˆè´¹ä¸€ä¸ª partitionã€‚ åœ¨ kafka ä¸­ï¼Œé‡‡ç”¨äº† pull æ–¹å¼ï¼Œå³ consumer åœ¨å’Œ broker å»ºç«‹è¿æ¥ä¹‹åï¼Œä¸»åŠ¨å» pull(æˆ–è€…è¯´ fetch )æ¶ˆæ¯ï¼Œé¦–å…ˆ consumer ç«¯å¯ä»¥æ ¹æ®è‡ªå·±çš„æ¶ˆè´¹èƒ½åŠ›é€‚æ—¶çš„å» fetch æ¶ˆæ¯å¹¶å¤„ç†ï¼Œä¸”å¯ä»¥æ§åˆ¶æ¶ˆæ¯æ¶ˆè´¹çš„è¿›åº¦(offset)ã€‚ partition ä¸­çš„æ¶ˆæ¯åªæœ‰ä¸€ä¸ª consumer åœ¨æ¶ˆè´¹ï¼Œä¸”ä¸å­˜åœ¨æ¶ˆæ¯çŠ¶æ€çš„æ§åˆ¶ï¼Œä¹Ÿæ²¡æœ‰å¤æ‚çš„æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼Œå¯è§ kafka broker ç«¯æ˜¯ç›¸å½“è½»é‡çº§çš„ã€‚å½“æ¶ˆæ¯è¢« consumer æ¥æ”¶ä¹‹åï¼Œéœ€è¦ä¿å­˜ Offset è®°å½•æ¶ˆè´¹åˆ°å“ªï¼Œä»¥å‰ä¿å­˜åœ¨ ZK ä¸­ï¼Œç”±äº ZK çš„å†™æ€§èƒ½ä¸å¥½ï¼Œä»¥å‰çš„è§£å†³æ–¹æ³•éƒ½æ˜¯ Consumer æ¯éš”ä¸€åˆ†é’Ÿä¸ŠæŠ¥ä¸€æ¬¡ï¼Œåœ¨ 0.10 ç‰ˆæœ¬åï¼ŒKafka æŠŠè¿™ä¸ª Offset çš„ä¿å­˜ï¼Œä» ZK ä¸­å‰¥ç¦»ï¼Œä¿å­˜åœ¨ä¸€ä¸ªåå« consumeroffsets topic çš„ Topic ä¸­ï¼Œç”±æ­¤å¯è§ï¼Œconsumer å®¢æˆ·ç«¯ä¹Ÿå¾ˆè½»é‡çº§ã€‚ 4ã€æ¶ˆæ¯ä¼ é€æœºåˆ¶ Kafka æ”¯æŒ 3 ç§æ¶ˆæ¯æŠ•é€’è¯­ä¹‰,åœ¨ä¸šåŠ¡ä¸­ï¼Œå¸¸å¸¸éƒ½æ˜¯ä½¿ç”¨ At least once çš„æ¨¡å‹ã€‚ At most onceï¼šæœ€å¤šä¸€æ¬¡ï¼Œæ¶ˆæ¯å¯èƒ½ä¼šä¸¢å¤±ï¼Œä½†ä¸ä¼šé‡å¤ã€‚ At least onceï¼šæœ€å°‘ä¸€æ¬¡ï¼Œæ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼Œå¯èƒ½ä¼šé‡å¤ã€‚ Exactly onceï¼šåªä¸”ä¸€æ¬¡ï¼Œæ¶ˆæ¯ä¸ä¸¢å¤±ä¸é‡å¤ï¼Œåªä¸”æ¶ˆè´¹ä¸€æ¬¡ã€‚ kafkaå®‰è£…å’Œä½¿ç”¨ åœ¨Windowså®‰è£…è¿è¡ŒKafkaï¼šhttps://blog.csdn.net/weixin_38004638/article/details/91893910 kafkaè¿è¡Œ ä¸€æ¬¡å†™å…¥ï¼Œæ”¯æŒå¤šä¸ªåº”ç”¨è¯»å–ï¼Œè¯»å–ä¿¡æ¯æ˜¯ç›¸åŒçš„ kafka-study.pom &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt; &lt;artifactId&gt;kafka_2.12&lt;/artifactId&gt; &lt;version&gt;2.2.1&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.slf4j&lt;/groupId&gt; &lt;artifactId&gt;slf4j-nop&lt;/artifactId&gt; &lt;version&gt;1.7.24&lt;/version&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt; &lt;version&gt;3.0&lt;/version&gt; &lt;configuration&gt; &lt;source&gt;1.8&lt;/source&gt; &lt;target&gt;1.8&lt;/target&gt; &lt;encoding&gt;UTF-8&lt;/encoding&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt; Producerç”Ÿäº§è€… â€‹ å‘é€æ¶ˆæ¯çš„æ–¹å¼ï¼Œåªç®¡å‘é€ï¼Œä¸ç®¡ç»“æœï¼šåªè°ƒç”¨æ¥å£å‘é€æ¶ˆæ¯åˆ° Kafka æœåŠ¡å™¨ï¼Œä½†ä¸ç®¡æˆåŠŸå†™å…¥ä¸å¦ã€‚ç”±äº Kafka æ˜¯é«˜å¯ç”¨çš„ï¼Œå› æ­¤å¤§éƒ¨åˆ†æƒ…å†µä¸‹æ¶ˆæ¯éƒ½ä¼šå†™å…¥ï¼Œä½†åœ¨å¼‚å¸¸æƒ…å†µä¸‹ä¼šä¸¢æ¶ˆæ¯ åŒæ­¥å‘é€ï¼šè°ƒç”¨ send() æ–¹æ³•è¿”å›ä¸€ä¸ª Future å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒçš„ get() æ–¹æ³•æ¥åˆ¤æ–­æ¶ˆæ¯å‘é€æˆåŠŸä¸å¦ å¼‚æ­¥å‘é€ï¼šè°ƒç”¨ send() æ—¶æä¾›ä¸€ä¸ªå›è°ƒæ–¹æ³•ï¼Œå½“æ¥æ”¶åˆ° broker ç»“æœåå›è°ƒæ­¤æ–¹æ³• public class MyProducer { private static KafkaProducer&lt;String, String&gt; producer; //åˆå§‹åŒ– static { Properties properties = new Properties(); //kafkaå¯åŠ¨ï¼Œç”Ÿäº§è€…å»ºç«‹è¿æ¥brokerçš„åœ°å€ properties.put(&quot;bootstrap.servers&quot;, &quot;127.0.0.1:9092&quot;); //kafkaåºåˆ—åŒ–æ–¹å¼ properties.put(&quot;key.serializer&quot;, &quot;org.apache.kafka.common.serialization.StringSerializer&quot;); properties.put(&quot;value.serializer&quot;, &quot;org.apache.kafka.common.serialization.StringSerializer&quot;); //è‡ªå®šä¹‰åˆ†åŒºåˆ†é…å™¨ properties.put(&quot;partitioner.class&quot;, &quot;com.imooc.kafka.CustomPartitioner&quot;); producer = new KafkaProducer&lt;&gt;(properties); } /** * åˆ›å»ºtopicï¼š.\\bin\\windows\\kafka-topics.bat --create --zookeeper localhost:2181 * --replication-factor 1 --partitions 1 --topic kafka-study * åˆ›å»ºæ¶ˆè´¹è€…ï¼š.\\bin\\windows\\kafka-console-consumer.bat --bootstrap-server localhost:9092 * --topic kafka-study --from-beginning */ //å‘é€æ¶ˆæ¯ï¼Œå‘é€å®Œåä¸åšå¤„ç† private static void sendMessageForgetResult() { ProducerRecord&lt;String, String&gt; record = new ProducerRecord&lt;&gt;(&quot;kafka-study&quot;, &quot;name&quot;, &quot;ForgetResult&quot;); producer.send(record); producer.close(); } //å‘é€åŒæ­¥æ¶ˆæ¯ï¼Œè·å–å‘é€çš„æ¶ˆæ¯ private static void sendMessageSync() throws Exception { ProducerRecord&lt;String, String&gt; record = new ProducerRecord&lt;&gt;(&quot;kafka-study&quot;, &quot;name&quot;, &quot;sync&quot;); RecordMetadata result = producer.send(record).get(); System.out.println(result.topic());//kafka-study System.out.println(result.partition());//åˆ†åŒºä¸ºnameçš„hashå¯¹åº”åˆ†åŒº System.out.println(result.offset());//å·²å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œæ­¤æ—¶åç§»é‡+1 producer.close(); } /** * åˆ›å»ºtopicï¼š.\\bin\\windows\\kafka-topics.bat --create --zookeeper localhost:2181 * --replication-factor 1 --partitions 3 --topic kafka-study-x * åˆ›å»ºæ¶ˆè´¹è€…ï¼š.\\bin\\windows\\kafka-console-consumer.bat --bootstrap-server localhost:9092 * --topic kafka-study-x --from-beginning */ //å‘é€å¼‚æ­¥æ¶ˆæ¯ï¼Œè·å–å›è°ƒçš„æ¶ˆæ¯ private static void sendMessageCallback() { ProducerRecord&lt;String, String&gt; record = new ProducerRecord&lt;&gt;(&quot;kafka-study-x&quot;, &quot;name&quot;, &quot;callback&quot;); producer.send(record, new MyProducerCallback()); //å‘é€å¤šæ¡æ¶ˆæ¯ record = new ProducerRecord&lt;&gt;(&quot;kafka-study-x&quot;, &quot;name-x&quot;, &quot;callback&quot;); producer.send(record, new MyProducerCallback()); producer.close(); } } //å‘é€å¼‚æ­¥æ¶ˆæ¯ //åœºæ™¯ï¼šæ¯æ¡æ¶ˆæ¯å‘é€æœ‰å»¶è¿Ÿï¼Œå¤šæ¡æ¶ˆæ¯å‘é€ï¼Œæ— éœ€åŒæ­¥ç­‰å¾…ï¼Œå¯ä»¥æ‰§è¡Œå…¶ä»–æ“ä½œï¼Œç¨‹åºä¼šè‡ªåŠ¨å¼‚æ­¥è°ƒç”¨ private static class MyProducerCallback implements Callback { @Override public void onCompletion(RecordMetadata recordMetadata, Exception e) { if (e != null) { e.printStackTrace(); return; } System.out.println(&quot;*** MyProducerCallback ***&quot;); System.out.println(recordMetadata.topic()); System.out.println(recordMetadata.partition()); System.out.println(recordMetadata.offset()); } } public static void main(String[] args) throws Exception { //sendMessageForgetResult(); //sendMessageSync(); sendMessageCallback(); } } è‡ªå®šä¹‰åˆ†åŒºåˆ†é…å™¨ï¼šå†³å®šæ¶ˆæ¯å­˜æ”¾åœ¨å“ªä¸ªåˆ†åŒº.ã€‚é»˜è®¤åˆ†é…å™¨ä½¿ç”¨è½®è¯¢å­˜æ”¾ï¼Œè½®åˆ°å·²æ»¡åˆ†åŒºå°†ä¼šå†™å…¥å¤±è´¥ã€‚ public class CustomPartitioner implements Partitioner { @Override public int partition(String topic, Object key, byte[] keyBytes, Object value, byte[] valueBytes, Cluster cluster) { //è·å–topicæ‰€æœ‰åˆ†åŒº List&lt;PartitionInfo&gt; partitionInfos = cluster.partitionsForTopic(topic); int numPartitions = partitionInfos.size(); //æ¶ˆæ¯å¿…é¡»æœ‰key if (null == keyBytes || !(key instanceof String)) { throw new InvalidRecordException(&quot;kafka message must have key&quot;); } //å¦‚æœåªæœ‰ä¸€ä¸ªåˆ†åŒºï¼Œå³0å·åˆ†åŒº if (numPartitions == 1) {return 0;} //å¦‚æœkeyä¸ºnameï¼Œå‘é€è‡³æœ€åä¸€ä¸ªåˆ†åŒº if (key.equals(&quot;name&quot;)) {return numPartitions - 1;} return Math.abs(Utils.murmur2(keyBytes)) % (numPartitions - 1); } @Override public void close() {} @Override public void configure(Map&lt;String, ?&gt; map) {} } å¯åŠ¨ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ï¼Œé€šè¿‡è‡ªå®šä¹‰åˆ†åŒºåˆ†é…å™¨åˆ†é…ï¼ŒæŸ¥è¯¢åˆ°topicä¿¡æ¯çš„offsetã€partitioner topic partition offset kafka-study 0 1 kafka-study 1 2 kafka-study-x 0 1 Kafkaæ¶ˆè´¹è€…ï¼ˆç»„ï¼‰ public class MyConsumer { private static KafkaConsumer&lt;String, String&gt; consumer; private static Properties properties; //åˆå§‹åŒ– static { properties = new Properties(); //å»ºç«‹è¿æ¥brokerçš„åœ°å€ properties.put(&quot;bootstrap.servers&quot;, &quot;127.0.0.1:9092&quot;); //kafkaååºåˆ—åŒ– properties.put(&quot;key.deserializer&quot;, &quot;org.apache.kafka.common.serialization.StringDeserializer&quot;); properties.put(&quot;value.deserializer&quot;, &quot;org.apache.kafka.common.serialization.StringDeserializer&quot;); //æŒ‡å®šæ¶ˆè´¹è€…ç»„ properties.put(&quot;group.id&quot;, &quot;KafkaStudy&quot;); } //è‡ªåŠ¨æäº¤ä½ç§»ï¼šç”±consumeè‡ªåŠ¨ç®¡ç†æäº¤ private static void generalConsumeMessageAutoCommit() { //é…ç½® properties.put(&quot;enable.auto.commit&quot;, true); consumer = new KafkaConsumer&lt;&gt;(properties); //æŒ‡å®štopic consumer.subscribe(Collections.singleton(&quot;kafka-study-x&quot;)); try { while (true) { boolean flag = true; //æ‹‰å–ä¿¡æ¯ï¼Œè¶…æ—¶æ—¶é—´100ms ConsumerRecords&lt;String, String&gt; records = consumer.poll(100); //éå†æ‰“å°æ¶ˆæ¯ for (ConsumerRecord&lt;String, String&gt; record : records) { System.out.println(String.format( &quot;topic = %s, partition = %s, key = %s, value = %s&quot;, record.topic(), record.partition(), record.key(), record.value() )); //æ¶ˆæ¯å‘é€å®Œæˆ if (record.value().equals(&quot;done&quot;)) { flag = false; } } if (!flag) { break; } } } finally { consumer.close(); } } //æ‰‹åŠ¨åŒæ­¥æäº¤å½“å‰ä½ç§»ï¼Œæ ¹æ®éœ€æ±‚æäº¤ï¼Œä½†å®¹æ˜“å‘é€é˜»å¡ï¼Œæäº¤å¤±è´¥ä¼šè¿›è¡Œé‡è¯•ç›´åˆ°æŠ›å‡ºå¼‚å¸¸ private static void generalConsumeMessageSyncCommit() { properties.put(&quot;auto.commit.offset&quot;, false); consumer = new KafkaConsumer&lt;&gt;(properties); consumer.subscribe(Collections.singletonList(&quot;kafka-study-x&quot;)); while (true) { boolean flag = true; ConsumerRecords&lt;String, String&gt; records = consumer.poll(100); for (ConsumerRecord&lt;String, String&gt; record : records) { System.out.println(String.format( &quot;topic = %s, partition = %s, key = %s, value = %s&quot;, record.topic(), record.partition(), record.key(), record.value() )); if (record.value().equals(&quot;done&quot;)) { flag = false; } } try { //æ‰‹åŠ¨åŒæ­¥æäº¤ consumer.commitSync(); } catch (CommitFailedException ex) { System.out.println(&quot;commit failed error: &quot; + ex.getMessage()); } if (!flag) { break; } } } //æ‰‹åŠ¨å¼‚æ­¥æäº¤å½“å‰ä½ç§»ï¼Œæäº¤é€Ÿåº¦å¿«ï¼Œä½†å¤±è´¥ä¸ä¼šè®°å½• private static void generalConsumeMessageAsyncCommit() { properties.put(&quot;auto.commit.offset&quot;, false); consumer = new KafkaConsumer&lt;&gt;(properties); consumer.subscribe(Collections.singletonList(&quot;kafka-study-x&quot;)); while (true) { boolean flag = true; ConsumerRecords&lt;String, String&gt; records = consumer.poll(100); for (ConsumerRecord&lt;String, String&gt; record : records) { System.out.println(String.format( &quot;topic = %s, partition = %s, key = %s, value = %s&quot;, record.topic(), record.partition(), record.key(), record.value() )); if (record.value().equals(&quot;done&quot;)) { flag = false; } } //æ‰‹åŠ¨å¼‚æ­¥æäº¤ consumer.commitAsync(); if (!flag) { break; } } } //æ‰‹åŠ¨å¼‚æ­¥æäº¤å½“å‰ä½ç§»å¸¦å›è°ƒ private static void generalConsumeMessageAsyncCommitWithCallback() { properties.put(&quot;auto.commit.offset&quot;, false); consumer = new KafkaConsumer&lt;&gt;(properties); consumer.subscribe(Collections.singletonList(&quot;kafka-study-x&quot;)); while (true) { boolean flag = true; ConsumerRecords&lt;String, String&gt; records = consumer.poll(100); for (ConsumerRecord&lt;String, String&gt; record : records) { System.out.println(String.format( &quot;topic = %s, partition = %s, key = %s, value = %s&quot;, record.topic(), record.partition(), record.key(), record.value() )); if (record.value().equals(&quot;done&quot;)) { flag = false; } } //ä½¿ç”¨java8å‡½æ•°å¼ç¼–ç¨‹ consumer.commitAsync((map, e) -&gt; { if (e != null) { System.out.println(&quot;commit failed for offsets: &quot; + e.getMessage()); } }); if (!flag) { break; } } } //æ··åˆåŒæ­¥ä¸å¼‚æ­¥æäº¤ä½ç§» @SuppressWarnings(&quot;all&quot;) private static void mixSyncAndAsyncCommit() { properties.put(&quot;auto.commit.offset&quot;, false); consumer = new KafkaConsumer&lt;&gt;(properties); consumer.subscribe(Collections.singletonList(&quot;kafka-study-x&quot;)); try { while (true) { //boolean flag = true; ConsumerRecords&lt;String, String&gt; records = consumer.poll(100); for (ConsumerRecord&lt;String, String&gt; record : records) { System.out.println(String.format( &quot;topic = %s, partition = %s, key = %s, &quot; + &quot;value = %s&quot;, record.topic(), record.partition(), record.key(), record.value() )); //if (record.value().equals(&quot;done&quot;)) { flag = false; } } //æ‰‹åŠ¨å¼‚æ­¥æäº¤ï¼Œä¿è¯æ€§èƒ½ consumer.commitAsync(); //if (!flag) { break; } } } catch (Exception ex) { System.out.println(&quot;commit async error: &quot; + ex.getMessage()); } finally { try { //å¼‚æ­¥æäº¤å¤±è´¥ï¼Œå†å°è¯•æ‰‹åŠ¨åŒæ­¥æäº¤ consumer.commitSync(); } finally { consumer.close(); } } } public static void main(String[] args) { //è‡ªåŠ¨æäº¤ä½ç§» generalConsumeMessageAutoCommit(); //æ‰‹åŠ¨åŒæ­¥æäº¤å½“å‰ä½ç§» //generalConsumeMessageSyncCommit(); //æ‰‹åŠ¨å¼‚æ­¥æäº¤å½“å‰ä½ç§» //generalConsumeMessageAsyncCommit(); //æ‰‹åŠ¨å¼‚æ­¥æäº¤å½“å‰ä½ç§»å¸¦å›è°ƒ //generalConsumeMessageAsyncCommitWithCallback() //æ··åˆåŒæ­¥ä¸å¼‚æ­¥æäº¤ä½ç§» //mixSyncAndAsyncCommit(); } } å…ˆå¯åŠ¨æ¶ˆè´¹è€…ç­‰å¾…æ¥æ”¶æ¶ˆæ¯ï¼Œå†å¯åŠ¨ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ï¼Œè¿›è¡Œæ¶ˆè´¹æ¶ˆæ¯ topic partition key value kafka-study-x 1 name-x callback kafka-study-x 2 name-x callback kafka-study-x 1 name-x callback kafka-study-x 1 name-x callback kafka-study-x 2 name-x callback ","link":"https://tianxiawuhao.github.io/w7MMk_8-a/"},{"title":"é™„å½• Flinkå¸¸è§é¢è¯•é—®é¢˜æ±‡æ€»","content":"é¢è¯•é¢˜ä¸€ï¼šåº”ç”¨æ¶æ„ é—®é¢˜ï¼š å…¬å¸æ€ä¹ˆæäº¤çš„å®æ—¶ä»»åŠ¡ï¼Œ æœ‰å¤šå°‘ Job Managerã€ Task Managerï¼Ÿ è§£ç­”ï¼š æˆ‘ä»¬ä½¿ç”¨ yarn session æ¨¡å¼æäº¤ä»»åŠ¡ï¼› å¦ä¸€ç§æ–¹å¼æ˜¯æ¯æ¬¡æäº¤éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Flink é›†ç¾¤ï¼Œ ä¸ºæ¯ä¸€ä¸ª job æä¾›èµ„æºï¼Œ ä»»åŠ¡ä¹‹é—´äº’ç›¸ç‹¬ç«‹ï¼Œ äº’ä¸å½±å“ï¼Œ æ–¹ä¾¿ç®¡ç†ã€‚ ä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹ååˆ›å»ºçš„é›†ç¾¤ä¹Ÿä¼šæ¶ˆå¤±ã€‚ çº¿ä¸Šå‘½ä»¤è„šæœ¬å¦‚ä¸‹ï¼šbin/yarn-session.sh -n 7 -s 8 -jm 3072 -tm 32768 -qu root.. -nm - -då…¶ä¸­ç”³è¯· 7 ä¸ª taskManagerï¼Œ æ¯ä¸ª 8 æ ¸ï¼Œ æ¯ä¸ª taskmanager æœ‰ 32768M å†…å­˜ã€‚ é›†ç¾¤é»˜è®¤åªæœ‰ä¸€ä¸ª Job Managerã€‚ ä½†ä¸ºäº†é˜²æ­¢å•ç‚¹æ•…éšœï¼Œ æˆ‘ä»¬é…ç½®äº†é«˜å¯ç”¨ã€‚ å¯¹äº standlone æ¨¡å¼ï¼Œ æˆ‘ä»¬å…¬å¸ä¸€èˆ¬é…ç½®ä¸€ä¸ªä¸» Job Managerï¼Œ ä¸¤ä¸ªå¤‡ç”¨ Job Managerï¼Œ ç„¶åç»“åˆ ZooKeeper çš„ä½¿ç”¨ï¼Œ æ¥è¾¾åˆ°é«˜å¯ç”¨ï¼› å¯¹äº yarn æ¨¡å¼ï¼Œ yarn åœ¨ Job Mananger æ•…éšœä¼šè‡ªåŠ¨è¿›è¡Œé‡å¯ï¼Œ æ‰€ä»¥åªéœ€è¦ä¸€ä¸ªï¼Œ æˆ‘ä»¬é…ç½®çš„æœ€å¤§é‡å¯æ¬¡æ•°æ˜¯ 10 æ¬¡ã€‚ é¢è¯•é¢˜äºŒï¼šå‹æµ‹å’Œç›‘æ§ é—®é¢˜ï¼š æ€ä¹ˆåšå‹åŠ›æµ‹è¯•å’Œç›‘æ§ï¼Ÿ è§£ç­”ï¼š æˆ‘ä»¬ä¸€èˆ¬ç¢°åˆ°çš„å‹åŠ›æ¥è‡ªä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š äº§ç”Ÿæ•°æ®æµçš„é€Ÿåº¦å¦‚æœè¿‡å¿«ï¼Œ è€Œä¸‹æ¸¸çš„ç®—å­æ¶ˆè´¹ä¸è¿‡æ¥çš„è¯ï¼Œ ä¼šäº§ç”ŸèƒŒå‹ã€‚ èƒŒå‹çš„ç›‘æ§å¯ä»¥ä½¿ç”¨ Flink Web UI(localhost:8081) æ¥å¯è§†åŒ–ç›‘æ§ Metricsï¼Œ ä¸€æ—¦æŠ¥è­¦ å°±èƒ½çŸ¥é“ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹èƒŒå‹é—®é¢˜çš„äº§ç”Ÿå¯èƒ½æ˜¯ç”±äº sink è¿™ä¸ª æ“ä½œç¬¦æ²¡æœ‰ä¼˜åŒ–å¥½ï¼Œ åšä¸€ä¸‹ä¼˜åŒ–å°±å¯ä»¥äº†ã€‚ æ¯”å¦‚å¦‚æœæ˜¯å†™å…¥ ElasticSearchï¼Œ é‚£ä¹ˆå¯ä»¥æ”¹æˆæ‰¹é‡å†™å…¥ï¼Œ å¯ä»¥è°ƒå¤§ ElasticSearch é˜Ÿåˆ—çš„å¤§å°ç­‰ç­‰ç­–ç•¥ã€‚ è®¾ç½® watermark çš„æœ€å¤§å»¶è¿Ÿæ—¶é—´è¿™ä¸ªå‚æ•°ï¼Œ å¦‚æœè®¾ç½®çš„è¿‡å¤§ï¼Œ å¯èƒ½ä¼šé€ æˆ å†…å­˜çš„å‹åŠ›ã€‚ å¯ä»¥è®¾ç½®æœ€å¤§å»¶è¿Ÿæ—¶é—´å°ä¸€äº›ï¼Œ ç„¶åæŠŠè¿Ÿåˆ°å…ƒç´ å‘é€åˆ°ä¾§è¾“å‡ºæµä¸­å»ã€‚ æ™šä¸€ç‚¹æ›´æ–°ç»“æœã€‚ æˆ–è€…ä½¿ç”¨ç±»ä¼¼äº RocksDB è¿™æ ·çš„çŠ¶æ€åç«¯ï¼Œ RocksDB ä¼šå¼€è¾Ÿ å †å¤–å­˜å‚¨ç©ºé—´ï¼Œ ä½† IO é€Ÿåº¦ä¼šå˜æ…¢ï¼Œ éœ€è¦æƒè¡¡ã€‚ è¿˜æœ‰å°±æ˜¯æ»‘åŠ¨çª—å£çš„é•¿åº¦å¦‚æœè¿‡é•¿ï¼Œ è€Œæ»‘åŠ¨è·ç¦»å¾ˆçŸ­çš„è¯ï¼Œ Flink çš„æ€§èƒ½ ä¼šä¸‹é™çš„å¾ˆå‰å®³ã€‚ æˆ‘ä»¬ä¸»è¦é€šè¿‡æ—¶é—´åˆ†ç‰‡çš„æ–¹æ³•ï¼Œ å°†æ¯ä¸ªå…ƒç´ åªå­˜å…¥ä¸€ä¸ªâ€œ é‡å çª— å£â€ ï¼Œ è¿™æ ·å°±å¯ä»¥å‡å°‘çª—å£å¤„ç†ä¸­çŠ¶æ€çš„å†™å…¥ã€‚ å‚è§é“¾æ¥ï¼š https://www.infoq.cn/article/sIhs_qY6HCpMQNblTI9M çŠ¶æ€åç«¯ä½¿ç”¨ RocksDBï¼Œ è¿˜æ²¡æœ‰ç¢°åˆ°è¢«æ’‘çˆ†çš„é—®é¢˜ã€‚ é¢è¯•é¢˜ä¸‰ï¼šä¸ºä»€ä¹ˆç”¨ Flink é—®é¢˜ï¼š ä¸ºä»€ä¹ˆä½¿ç”¨ Flink æ›¿ä»£ Sparkï¼Ÿ è§£ç­”ï¼š ä¸»è¦è€ƒè™‘çš„æ˜¯ flink çš„ä½å»¶è¿Ÿã€ é«˜ååé‡å’Œå¯¹æµå¼æ•°æ®åº”ç”¨åœºæ™¯æ›´å¥½çš„æ”¯ æŒï¼› å¦å¤–ï¼Œ flink å¯ä»¥å¾ˆå¥½åœ°å¤„ç†ä¹±åºæ•°æ®ï¼Œ è€Œä¸”å¯ä»¥ä¿è¯ exactly-once çš„çŠ¶æ€ä¸€è‡´ æ€§ã€‚ è¯¦è§æ–‡æ¡£ç¬¬ä¸€ç« ï¼Œ æœ‰ Flink å’Œ Spark çš„è¯¦ç»†å¯¹æ¯”ã€‚ é¢è¯•é¢˜å››ï¼šcheckpoint çš„å­˜å‚¨ é—®é¢˜ï¼š Flink çš„ checkpoint å­˜åœ¨å“ªé‡Œï¼Ÿ è§£ç­”ï¼š å¯ä»¥æ˜¯å†…å­˜ï¼Œ æ–‡ä»¶ç³»ç»Ÿï¼Œ æˆ–è€… RocksDBã€‚ è¯¦è§æ–‡æ¡£ ç¬¬ä¹ç«  çŠ¶æ€ç¼–ç¨‹å’Œå®¹é”™æœºåˆ¶ã€‚ é¢è¯•é¢˜äº”ï¼šexactly-once çš„ä¿è¯ é—®é¢˜ï¼š å¦‚æœä¸‹çº§å­˜å‚¨ä¸æ”¯æŒäº‹åŠ¡ï¼Œ Flink æ€ä¹ˆä¿è¯ exactly-onceï¼Ÿ è§£ç­”ï¼š ç«¯åˆ°ç«¯çš„ exactly-once å¯¹ sink è¦æ±‚æ¯”è¾ƒé«˜ï¼Œ å…·ä½“å®ç°ä¸»è¦æœ‰å¹‚ç­‰å†™å…¥å’Œ äº‹åŠ¡æ€§å†™å…¥ä¸¤ç§æ–¹å¼ã€‚ å¹‚ç­‰å†™å…¥çš„åœºæ™¯ä¾èµ–äºä¸šåŠ¡é€»è¾‘ï¼Œ æ›´å¸¸è§çš„æ˜¯ç”¨äº‹åŠ¡æ€§å†™å…¥ã€‚ è€Œäº‹åŠ¡æ€§å†™å…¥åˆæœ‰é¢„å†™æ—¥å¿—ï¼ˆ WALï¼‰ å’Œä¸¤é˜¶æ®µæäº¤ï¼ˆ 2PCï¼‰ ä¸¤ç§æ–¹å¼ã€‚ å¦‚æœå¤–éƒ¨ç³»ç»Ÿä¸æ”¯æŒäº‹åŠ¡ï¼Œ é‚£ä¹ˆå¯ä»¥ç”¨é¢„å†™æ—¥å¿—çš„æ–¹å¼ï¼Œ æŠŠç»“æœæ•°æ®å…ˆå½“æˆçŠ¶ æ€ä¿å­˜ï¼Œ ç„¶ååœ¨æ”¶åˆ° checkpoint å®Œæˆçš„é€šçŸ¥æ—¶ï¼Œ ä¸€æ¬¡æ€§å†™å…¥ sink ç³»ç»Ÿã€‚ å‚è§æ–‡æ¡£ç¬¬ä¹ç«  çŠ¶æ€ç¼–ç¨‹å’Œå®¹é”™æœºåˆ¶ é¢è¯•é¢˜å…­ï¼šçŠ¶æ€æœºåˆ¶ é—®é¢˜ï¼š è¯´ä¸€ä¸‹ Flink çŠ¶æ€æœºåˆ¶ï¼Ÿ è§£ç­”ï¼š Flink å†…ç½®çš„å¾ˆå¤šç®—å­ï¼Œ åŒ…æ‹¬æº sourceï¼Œ æ•°æ®å­˜å‚¨ sink éƒ½æ˜¯æœ‰çŠ¶æ€çš„ã€‚ åœ¨ Flink ä¸­ï¼Œ çŠ¶æ€å§‹ç»ˆä¸ç‰¹å®šç®—å­ç›¸å…³è”ã€‚ Flink ä¼šä»¥ checkpoint çš„å½¢å¼å¯¹å„ä¸ªä»»åŠ¡çš„ çŠ¶æ€è¿›è¡Œå¿«ç…§ï¼Œ ç”¨äºä¿è¯æ•…éšœæ¢å¤æ—¶çš„çŠ¶æ€ä¸€è‡´æ€§ã€‚ Flink é€šè¿‡çŠ¶æ€åç«¯æ¥ç®¡ç†çŠ¶æ€ å’Œ checkpoint çš„å­˜å‚¨ï¼Œ çŠ¶æ€åç«¯å¯ä»¥æœ‰ä¸åŒçš„é…ç½®é€‰æ‹©ã€‚ è¯¦è§æ–‡æ¡£ç¬¬ä¹ç« ã€‚ é¢è¯•é¢˜ä¸ƒï¼šæµ·é‡ key å»é‡ é—®é¢˜ï¼š æ€ä¹ˆå»é‡ï¼Ÿ è€ƒè™‘ä¸€ä¸ªå®æ—¶åœºæ™¯ï¼š åŒåä¸€åœºæ™¯ï¼Œ æ»‘åŠ¨çª—å£é•¿åº¦ä¸º 1 å°æ—¶ï¼Œ æ»‘åŠ¨è·ç¦»ä¸º 10 ç§’é’Ÿï¼Œ äº¿çº§ç”¨æˆ·ï¼Œ æ€æ ·è®¡ç®— UVï¼Ÿ è§£ç­”ï¼š ä½¿ç”¨ç±»ä¼¼äº scala çš„ set æ•°æ®ç»“æ„æˆ–è€… redis çš„ set æ˜¾ç„¶æ˜¯ä¸è¡Œçš„ï¼Œ å› ä¸ºå¯èƒ½æœ‰ä¸Šäº¿ä¸ª Keyï¼Œ å†…å­˜æ”¾ä¸ä¸‹ã€‚ æ‰€ä»¥å¯ä»¥è€ƒè™‘ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆ Bloom Filterï¼‰ æ¥å»é‡ã€‚ é¢è¯•é¢˜å…«ï¼šcheckpoint ä¸ spark æ¯”è¾ƒ é—®é¢˜ï¼š Flink çš„ checkpoint æœºåˆ¶å¯¹æ¯” spark æœ‰ä»€ä¹ˆä¸åŒå’Œä¼˜åŠ¿ï¼Ÿ è§£ç­”ï¼š spark streaming çš„ checkpoint ä»…ä»…æ˜¯é’ˆå¯¹ driver çš„æ•…éšœæ¢å¤åšäº†æ•°æ® å’Œå…ƒæ•°æ®çš„ checkpointã€‚ è€Œ flink çš„ checkpoint æœºåˆ¶ è¦å¤æ‚äº†å¾ˆå¤šï¼Œ å®ƒé‡‡ç”¨çš„æ˜¯ è½»é‡çº§çš„åˆ†å¸ƒå¼å¿«ç…§ï¼Œ å®ç°äº†æ¯ä¸ªç®—å­çš„å¿«ç…§ï¼Œ åŠæµåŠ¨ä¸­çš„æ•°æ®çš„å¿«ç…§ã€‚ å‚è§æ–‡æ¡£ ç¬¬ä¹ç«  çŠ¶æ€ç¼–ç¨‹å’Œå®¹é”™æœºåˆ¶åŠæ–‡ç« é“¾æ¥ï¼š https://cloud.tencent.com/developer/article/1189624 é¢è¯•é¢˜ä¹ï¼šwatermark æœºåˆ¶ é—®é¢˜ï¼š è¯·è¯¦ç»†è§£é‡Šä¸€ä¸‹ Flink çš„ Watermark æœºåˆ¶ã€‚ è§£ç­”ï¼š Watermark æœ¬è´¨æ˜¯ Flink ä¸­è¡¡é‡ EventTime è¿›å±•çš„ä¸€ä¸ªæœºåˆ¶ï¼Œ ä¸»è¦ç”¨æ¥å¤„ ç†ä¹±åºæ•°æ®ã€‚ è¯¦è§æ–‡æ¡£ç¬¬ä¸ƒç«  æ—¶é—´è¯­ä¹‰ä¸ Wartermarkã€‚ é¢è¯•é¢˜åï¼šexactly-once å¦‚ä½•å®ç° é—®é¢˜ï¼š Flink ä¸­ exactly-once è¯­ä¹‰æ˜¯å¦‚ä½•å®ç°çš„ï¼Œ çŠ¶æ€æ˜¯å¦‚ä½•å­˜å‚¨çš„ï¼Ÿ è§£ç­”ï¼š Flink ä¾é  checkpoint æœºåˆ¶æ¥å®ç° exactly-once è¯­ä¹‰ï¼Œ å¦‚æœè¦å®ç°ç«¯åˆ°ç«¯ çš„ exactly-onceï¼Œ è¿˜éœ€è¦å¤–éƒ¨ source å’Œ sink æ»¡è¶³ä¸€å®šçš„æ¡ä»¶ã€‚ çŠ¶æ€çš„å­˜å‚¨é€šè¿‡çŠ¶æ€ åç«¯æ¥ç®¡ç†ï¼Œ Flink ä¸­å¯ä»¥é…ç½®ä¸åŒçš„çŠ¶æ€åç«¯ã€‚ è¯¦è§æ–‡æ¡£ ç¬¬ä¹ç«  çŠ¶æ€ç¼–ç¨‹å’Œå®¹é”™æœºåˆ¶ã€‚ é¢è¯•é¢˜åä¸€ï¼šCEP é—®é¢˜ï¼š Flink CEP ç¼–ç¨‹ä¸­å½“çŠ¶æ€æ²¡æœ‰åˆ°è¾¾çš„æ—¶å€™ä¼šå°†æ•°æ®ä¿å­˜åœ¨å“ªé‡Œï¼Ÿ è§£ç­”ï¼š åœ¨æµå¼å¤„ç†ä¸­ï¼Œ CEP å½“ç„¶æ˜¯è¦æ”¯æŒ EventTime çš„ï¼Œ é‚£ä¹ˆç›¸å¯¹åº”çš„ä¹Ÿè¦ æ”¯æŒæ•°æ®çš„è¿Ÿåˆ°ç°è±¡ï¼Œ ä¹Ÿå°±æ˜¯ watermark çš„å¤„ç†é€»è¾‘ã€‚ CEP å¯¹æœªåŒ¹é…æˆåŠŸçš„äº‹ä»¶åº åˆ—çš„å¤„ç†ï¼Œ å’Œè¿Ÿåˆ°æ•°æ®æ˜¯ç±»ä¼¼çš„ã€‚ åœ¨ Flink CEP çš„å¤„ç†é€»è¾‘ä¸­ï¼Œ çŠ¶æ€æ²¡æœ‰æ»¡è¶³çš„å’Œ è¿Ÿåˆ°çš„æ•°æ®ï¼Œ éƒ½ä¼šå­˜å‚¨åœ¨ä¸€ä¸ª Map æ•°æ®ç»“æ„ä¸­ï¼Œ ä¹Ÿå°±æ˜¯è¯´ï¼Œ å¦‚æœæˆ‘ä»¬é™å®šåˆ¤æ–­äº‹ä»¶ åºåˆ—çš„æ—¶é•¿ä¸º 5 åˆ†é’Ÿï¼Œ é‚£ä¹ˆå†…å­˜ä¸­å°±ä¼šå­˜å‚¨ 5 åˆ†é’Ÿçš„æ•°æ®ï¼Œ è¿™åœ¨æˆ‘çœ‹æ¥ï¼Œ ä¹Ÿæ˜¯å¯¹å†… å­˜çš„æå¤§æŸä¼¤ä¹‹ä¸€ã€‚ é¢è¯•é¢˜åäºŒï¼šä¸‰ç§æ—¶é—´è¯­ä¹‰ é—®é¢˜ï¼š Flink ä¸‰ç§æ—¶é—´è¯­ä¹‰æ˜¯ä»€ä¹ˆï¼Œ åˆ†åˆ«è¯´å‡ºåº”ç”¨åœºæ™¯ï¼Ÿ è§£ç­”ï¼š Event Timeï¼š è¿™æ˜¯å®é™…åº”ç”¨æœ€å¸¸è§çš„æ—¶é—´è¯­ä¹‰ï¼Œ å…·ä½“è§æ–‡æ¡£ç¬¬ä¸ƒç« ã€‚ Processing Timeï¼š æ²¡æœ‰äº‹ä»¶æ—¶é—´çš„æƒ…å†µä¸‹ï¼Œ æˆ–è€…å¯¹å®æ—¶æ€§è¦æ±‚è¶…é«˜çš„æƒ…å†µä¸‹ã€‚ Ingestion Timeï¼š å­˜åœ¨å¤šä¸ª Source Operator çš„æƒ…å†µä¸‹ï¼Œ æ¯ä¸ª Source Operator å¯ä»¥ä½¿ç”¨è‡ªå·±æœ¬åœ°ç³»ç»Ÿæ—¶é’ŸæŒ‡æ´¾ Ingestion Timeã€‚ åç»­åŸºäºæ—¶é—´ç›¸å…³çš„å„ç§æ“ä½œï¼Œ éƒ½ä¼šä½¿ç”¨æ•°æ®è®°å½•ä¸­çš„ Ingestion Timeã€‚ é¢è¯•é¢˜åä¸‰ï¼šæ•°æ®é«˜å³°çš„å¤„ç† é—®é¢˜ï¼š Flink ç¨‹åºåœ¨é¢å¯¹æ•°æ®é«˜å³°æœŸæ—¶å¦‚ä½•å¤„ç†ï¼Ÿ è§£ç­”ï¼š ä½¿ç”¨å¤§å®¹é‡çš„ Kafka æŠŠæ•°æ®å…ˆæ”¾åˆ°æ¶ˆæ¯é˜Ÿåˆ—é‡Œé¢ä½œä¸ºæ•°æ®æºï¼Œ å†ä½¿ç”¨ Flink è¿›è¡Œæ¶ˆè´¹ï¼Œ ä¸è¿‡è¿™æ ·ä¼šå½±å“åˆ°ä¸€ç‚¹å®æ—¶æ€§ ","link":"https://tianxiawuhao.github.io/EEiV7EREL/"},{"title":"ç¬¬åç«  Table API ä¸ SQL","content":"Flink Table&amp;SQL flink table &amp; sqlæ—¶é—´å±æ€§ä¸çª—å£ flinkç‰ˆæœ¬ï¼š1.13.1 scalaç‰ˆæœ¬ï¼š2.12 maven ä¾èµ–å¼•ç”¨ &lt;!-- ä½¿ç”¨table api å¼•å…¥çš„ä¾èµ–ï¼Œä½¿ç”¨æ¡¥æ¥å™¨å’Œåº•å±‚datastream apiè¿æ¥æ”¯æŒ--&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-table-api-java-bridge_${scala.binary.version}&lt;/artifactId&gt; &lt;version&gt;${flink.version}&lt;/version&gt; &lt;/dependency&gt; &lt;!--å¦‚æœéœ€è¦åœ¨æœ¬åœ°è¿è¡Œtable apiå’Œsql è¿˜éœ€è¦å¼•å…¥ä¸€ä¸‹ä¾èµ–--&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-table-planner-blink_${scala.binary.version}&lt;/artifactId&gt; &lt;version&gt;${flink.version}&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-streaming-scala_${scala.binary.version}&lt;/artifactId&gt; &lt;version&gt;${flink.version}&lt;/version&gt; &lt;/dependency&gt; &lt;!--å¦‚æœæƒ³å®ç°è‡ªå®šä¹‰çš„æ•°æ®æ ¼å¼æ¥åšåºåˆ—åŒ–ï¼Œéœ€è¦å¼•å…¥ä¸€ä¸‹ä¾èµ–--&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-table-common&lt;/artifactId&gt; &lt;version&gt;${flink.version}&lt;/version&gt; &lt;/dependency&gt; &lt;!--è¿æ¥å¤–éƒ¨æ•°æ®æ ¼å¼è§£æ,é‡‡ç”¨csvæ–¹å¼æ¥è§£æ--&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-csv&lt;/artifactId&gt; &lt;version&gt;${flink.version}&lt;/version&gt; &lt;/dependency&gt; æ—¶é—´å±æ€§ 1 äº‹ä»¶æ—¶é—´ åœ¨DDLè¿æ¥è¡¨ä¸­åˆ›å»º CREATE TABLE EventTable( user STRING, url STRING, ts TIMESTAMP(3), // ä¼ å…¥å¾—å€¼æ˜¯bigint,è‡ªåŠ¨è½¬æ¢ WATERMARK FOR ts AS ts - INTERVAL '5' SECOND ) WITH ( ... ); è¯´æ˜ï¼š è¿™é‡Œæˆ‘ä»¬æŠŠ ts å­—æ®µå®šä¹‰ä¸ºäº‹ä»¶æ—¶é—´å±æ€§ï¼Œè€Œä¸”åŸºäº ts è®¾ç½®äº† 5 ç§’çš„æ°´ä½çº¿å»¶è¿Ÿã€‚ è¿™é‡Œçš„â€œ5 ç§’â€æ˜¯ä»¥â€œæ—¶é—´é—´éš”â€çš„å½¢å¼å®šä¹‰çš„ï¼Œæ ¼å¼æ˜¯ INTERVAL &lt;æ•°å€¼&gt; &lt;æ—¶é—´å•ä½&gt;ï¼šINTERVAL â€˜5â€™ SECONDï¼Œè¿™é‡Œçš„æ•°å€¼å¿…é¡»ç”¨å•å¼•å·å¼•èµ·æ¥ï¼Œè€Œå•ä½ç”¨ SECOND å’Œ SECONDS æ˜¯ç­‰æ•ˆçš„ã€‚ TIMESTAMPä¼šè‡ªåŠ¨è½¬ä¸ºå›½é™…UTFæ—¶é—´ï¼Œä½¿ç”¨å½“åœ°æ—¶é—´éœ€è¦ä½¿ç”¨TIMESTAMP_LTZ CREATE TABLE events ( user STRING, url STRING, ts BIGINT, ts_ltz AS TO_TIMESTAMP_LTZ(ts, 3), WATERMARK FOR ts_ltz AS ts_ltz - INTERVAL '5' SECOND ) WITH ( ... ); è¯´æ˜ï¼š Flink ä¸­æ”¯æŒçš„äº‹ä»¶æ—¶é—´å±æ€§æ•°æ®ç±»å‹å¿…é¡»ä¸º TIMESTAMP æˆ–è€… TIMESTAMP_LTZã€‚è¿™é‡Œ TIMESTAMP_LTZ æ˜¯æŒ‡å¸¦æœ‰æœ¬åœ°æ—¶åŒºä¿¡æ¯çš„æ—¶é—´æˆ³ï¼ˆTIMESTAMP WITH LOCAL TIME ZONEï¼‰ï¼›ä¸€èˆ¬æƒ…å†µä¸‹å¦‚æœæ•°æ®ä¸­çš„æ—¶é—´æˆ³æ˜¯â€œå¹´-æœˆ-æ—¥-æ—¶-åˆ†-ç§’â€çš„å½¢å¼ï¼Œé‚£å°±æ˜¯ä¸å¸¦æ—¶åŒºä¿¡ æ¯çš„ï¼Œå¯ä»¥å°†äº‹ä»¶æ—¶é—´å±æ€§å®šä¹‰ä¸º TIMESTAMP ç±»å‹ã€‚ è€Œå¦‚æœåŸå§‹çš„æ—¶é—´æˆ³å°±æ˜¯ä¸€ä¸ªé•¿æ•´å‹çš„æ¯«ç§’æ•°ï¼Œè¿™æ—¶å°±éœ€è¦å¦å¤–å®šä¹‰ä¸€ä¸ªå­—æ®µæ¥è¡¨ç¤ºäº‹ä»¶ æ—¶é—´å±æ€§ï¼Œç±»å‹å®šä¹‰ä¸º TIMESTAMP_LTZ ä¼šæ›´æ–¹ä¾¿ã€‚ åœ¨æ•°æ®æµè½¬æ¢ä¸ºè¡¨æ—¶å®šä¹‰ public class TimeAndWindowTest { public static void main(String[] args) throws Exception{ StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); env.setParallelism(1); StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env); //2.åœ¨æµè½¬æ¢æˆTableçš„æ—¶å€™å®šä¹‰æ—¶é—´å±æ€§ SingleOutputStreamOperator&lt;Event&gt; clickStream = env.addSource(new ClickSource()) .assignTimestampsAndWatermarks(WatermarkStrategy.&lt;Event&gt;forBoundedOutOfOrderness(Duration.ZERO) .withTimestampAssigner(new SerializableTimestampAssigner&lt;Event&gt;() { @Override public long extractTimestamp(Event element, long recordTimestamp) { return element.timestamp; } })); Table clickTable = tableEnv.fromDataStream(clickStream, $(&quot;user&quot;), $(&quot;url&quot;), $(&quot;timestamp&quot;).as(&quot;ts&quot;), $(&quot;et&quot;).rowtime()); clickTable.printSchema(); } } è¯´æ˜ è®¾ç½®æ°´ä½çº¿(assignTimestampsAndWatermarks),(â€œetâ€).rowtime()è‡ªåŠ¨è·å–ï¼Œetä¸ºè™šæ‹Ÿè¡¨åˆ«å(â€œetâ€).rowtime()è‡ªåŠ¨è·å–ï¼Œetä¸ºè™šæ‹Ÿè¡¨åˆ«å (â€œetâ€).rowtime()è‡ªåŠ¨è·å–ï¼Œetä¸ºè™šæ‹Ÿè¡¨åˆ«å(â€œpsâ€).proctime()è¡¨ç¤ºç³»ç»Ÿå¤„ç†æ—¶é—´ï¼Œpsä¸ºè™šæ‹Ÿè¡¨åˆ«å .rowtime()ï¼Œ.proctime()å€¼å‡æ˜¯å›½é™…UTFæ—¶é—´ 2 å¤„ç†æ—¶é—´ åœ¨åˆ›å»ºè¡¨çš„ DDL ä¸­å®šä¹‰ CREATE TABLE EventTable( user STRING, url STRING, ts AS PROCTIME() ) WITH ( ... ); åœ¨æ•°æ®æµè½¬æ¢ä¸ºè¡¨æ—¶å®šä¹‰ DataStream&lt;Tuple2&lt;String, String&gt;&gt; stream = ...; // å£°æ˜ä¸€ä¸ªé¢å¤–çš„å­—æ®µä½œä¸ºå¤„ç†æ—¶é—´å±æ€§å­—æ®µï¼Œ$(&quot;ts&quot;).proctime()ç³»ç»Ÿå¤„ç†æ—¶é—´ Table table = tEnv.fromDataStream(stream, $(&quot;user&quot;), $(&quot;url&quot;), $(&quot;ts&quot;).proctime()); 1.1 æ¡ˆä¾‹1ï¼ˆDataStream SQLç»Ÿè®¡ï¼‰ éœ€æ±‚ï¼šå°†DataStreamæ³¨å†Œä¸ºTableå’ŒViewå¹¶è¿›è¡ŒSQLç»Ÿè®¡ã€‚ ä»£ç å¦‚ä¸‹ï¼š import lombok.AllArgsConstructor; import lombok.Data; import lombok.NoArgsConstructor; import org.apache.flink.streaming.api.datastream.DataStream; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.table.api.Table; import org.apache.flink.table.api.bridge.java.StreamTableEnvironment; import java.util.Arrays; import static org.apache.flink.table.api.Expressions.$; /** * æ¡ˆä¾‹1ï¼šå°†DataStreamæ³¨å†Œä¸ºTableå’ŒViewå¹¶è¿›è¡ŒSQLç»Ÿè®¡ */ public class Demo1 { public static void main(String[] args) throws Exception { //1.å‡†å¤‡ç¯å¢ƒ StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); //EnvironmentSettings settings = EnvironmentSettings.newInstance().useBlinkPlanner().inStreamingMode().build(); //StreamTableEnvironment tEnv = StreamTableEnvironment.create(env, settings); StreamTableEnvironment tEnv = StreamTableEnvironment.create(env); //2.Source DataStream&lt;Order&gt; orderA = env.fromCollection(Arrays.asList( new Order(1L, &quot;beer&quot;, 3), new Order(1L, &quot;diaper&quot;, 4), new Order(3L, &quot;rubber&quot;, 2))); DataStream&lt;Order&gt; orderB = env.fromCollection(Arrays.asList( new Order(2L, &quot;pen&quot;, 3), new Order(2L, &quot;rubber&quot;, 3), new Order(4L, &quot;beer&quot;, 1))); //3.æ³¨å†Œè¡¨ // convert DataStream to Table Table tableA = tEnv.fromDataStream(orderA, $(&quot;user&quot;), $(&quot;product&quot;), $(&quot;amount&quot;)); // register DataStream as Table tEnv.createTemporaryView(&quot;OrderB&quot;, orderB, $(&quot;user&quot;), $(&quot;product&quot;), $(&quot;amount&quot;)); //4.æ‰§è¡ŒæŸ¥è¯¢ System.out.println(tableA); // union the two tables Table resultTable = tEnv.sqlQuery( &quot;SELECT * FROM &quot; + tableA + &quot; WHERE amount &gt; 2 &quot; + &quot;UNION ALL &quot; + &quot;SELECT * FROM OrderB WHERE amount &lt; 2&quot; ); //5.è¾“å‡ºç»“æœ DataStream&lt;Order&gt; resultDS = tEnv.toAppendStream(resultTable, Order.class); resultDS.print(); env.execute(); } @Data @NoArgsConstructor @AllArgsConstructor public static class Order { public Long user; public String product; public int amount; } } è¿è¡Œç»“æœï¼š 1.2 æ¡ˆä¾‹2ï¼ˆDataStream Table&amp;SQLç»Ÿè®¡ï¼‰ éœ€æ±‚ï¼šä½¿ç”¨SQLå’ŒTableä¸¤ç§æ–¹å¼å¯¹DataStreamä¸­çš„å•è¯è¿›è¡Œç»Ÿè®¡ã€‚ ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼ˆSQLæ–¹å¼ï¼‰ï¼š import lombok.AllArgsConstructor; import lombok.Data; import lombok.NoArgsConstructor; import org.apache.flink.api.java.tuple.Tuple2; import org.apache.flink.streaming.api.datastream.DataStream; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.table.api.Table; import org.apache.flink.table.api.bridge.java.StreamTableEnvironment; import static org.apache.flink.table.api.Expressions.$; /** * ä½¿ç”¨SQLå’ŒTableä¸¤ç§æ–¹å¼å¯¹DataStreamä¸­çš„å•è¯è¿›è¡Œç»Ÿè®¡ã€‚ * */ public class Demo02 { public static void main(String[] args) throws Exception { //1.å‡†å¤‡ç¯å¢ƒ StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); StreamTableEnvironment tEnv = StreamTableEnvironment.create(env); //2.Source DataStream&lt;WC&gt; input = env.fromElements( new WC(&quot;Hello&quot;, 1), new WC(&quot;World&quot;, 1), new WC(&quot;Hello&quot;, 1) ); //3.æ³¨å†Œè¡¨ tEnv.createTemporaryView(&quot;WordCount&quot;, input, $(&quot;word&quot;), $(&quot;frequency&quot;)); //4.æ‰§è¡ŒæŸ¥è¯¢ Table resultTable = tEnv.sqlQuery(&quot;SELECT word, SUM(frequency) as frequency FROM WordCount GROUP BY word&quot;); //5.è¾“å‡ºç»“æœ //toAppendStream doesn't support consuming update changes which is produced by node GroupAggregate //DataStream&lt;WC&gt; resultDS = tEnv.toAppendStream(resultTable, WC.class); DataStream&lt;Tuple2&lt;Boolean, WC&gt;&gt; resultDS = tEnv.toRetractStream(resultTable, WC.class); resultDS.print(); env.execute(); } @Data @NoArgsConstructor @AllArgsConstructor public static class WC { public String word; public long frequency; } } è¿è¡Œç»“æœï¼š ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼ˆTableæ–¹å¼ï¼‰ï¼š import lombok.AllArgsConstructor; import lombok.Data; import lombok.NoArgsConstructor; import org.apache.flink.api.java.tuple.Tuple2; import org.apache.flink.streaming.api.datastream.DataStream; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.table.api.Table; import org.apache.flink.table.api.bridge.java.StreamTableEnvironment; import static org.apache.flink.table.api.Expressions.$; /** * ä½¿ç”¨SQLå’ŒTableä¸¤ç§æ–¹å¼å¯¹DataStreamä¸­çš„å•è¯è¿›è¡Œç»Ÿè®¡ * */ public class Demo02Table { public static void main(String[] args) throws Exception { //1.å‡†å¤‡ç¯å¢ƒ StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); StreamTableEnvironment tEnv = StreamTableEnvironment.create(env); //2.Source DataStream&lt;WC&gt; input = env.fromElements( new WC(&quot;Hello&quot;, 1), new WC(&quot;World&quot;, 1), new WC(&quot;Hello&quot;, 1) ); //3.æ³¨å†Œè¡¨ Table table = tEnv.fromDataStream(input); //4.æ‰§è¡ŒæŸ¥è¯¢ Table resultTable = table .groupBy($(&quot;word&quot;)) .select($(&quot;word&quot;), $(&quot;frequency&quot;).sum().as(&quot;frequency&quot;)) .filter($(&quot;frequency&quot;).isEqual(2)); //5.è¾“å‡ºç»“æœ DataStream&lt;Tuple2&lt;Boolean, WC&gt;&gt; resultDS = tEnv.toRetractStream(resultTable, WC.class); resultDS.print(); env.execute(); } @Data @NoArgsConstructor @AllArgsConstructor public static class WC { public String word; public long frequency; } } 1.4 æ¡ˆä¾‹4ï¼ˆSQLæ¶ˆè´¹Kafkaï¼‰ éœ€æ±‚ï¼šä»Kafkaä¸­æ¶ˆè´¹æ•°æ®å¹¶è¿‡æ»¤å‡ºçŠ¶æ€ä¸ºsuccessçš„æ•°æ®å†å†™å…¥åˆ°Kafka {&quot;user_id&quot;: &quot;1&quot;, &quot;page_id&quot;:&quot;1&quot;, &quot;status&quot;: &quot;success&quot;} {&quot;user_id&quot;: &quot;1&quot;, &quot;page_id&quot;:&quot;1&quot;, &quot;status&quot;: &quot;success&quot;} {&quot;user_id&quot;: &quot;1&quot;, &quot;page_id&quot;:&quot;1&quot;, &quot;status&quot;: &quot;success&quot;} {&quot;user_id&quot;: &quot;1&quot;, &quot;page_id&quot;:&quot;1&quot;, &quot;status&quot;: &quot;success&quot;} {&quot;user_id&quot;: &quot;1&quot;, &quot;page_id&quot;:&quot;1&quot;, &quot;status&quot;: &quot;fail&quot;} /export/server/kafka/bin/kafka-topics.sh --create --zookeeper node1:2181 --replication-factor 2 --partitions 3 --topic input_kafka /export/server/kafka/bin/kafka-topics.sh --create --zookeeper node1:2181 --replication-factor 2 --partitions 3 --topic output_kafka /export/server/kafka/bin/kafka-console-producer.sh --broker-list node1:9092 --topic input_kafka /export/server/kafka/bin/kafka-console-consumer.sh --bootstrap-server node1:9092 --topic output_kafka --from-beginning ä»£ç å®ç°ï¼š https://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/ https://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/kafka.html import org.apache.flink.api.java.tuple.Tuple2; import org.apache.flink.streaming.api.datastream.DataStream; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.table.api.Table; import org.apache.flink.table.api.TableResult; import org.apache.flink.table.api.bridge.java.StreamTableEnvironment; import org.apache.flink.types.Row; /** * ä»Kafkaä¸­æ¶ˆè´¹æ•°æ®å¹¶è¿‡æ»¤å‡ºçŠ¶æ€ä¸ºsuccessçš„æ•°æ®å†å†™å…¥åˆ°Kafka */ public class Demo4 { public static void main(String[] args) throws Exception { //1.å‡†å¤‡ç¯å¢ƒ StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); StreamTableEnvironment tEnv = StreamTableEnvironment.create(env); //2.Source TableResult inputTable = tEnv.executeSql( &quot;CREATE TABLE input_kafka (\\n&quot; + &quot; `user_id` BIGINT,\\n&quot; + &quot; `page_id` BIGINT,\\n&quot; + &quot; `status` STRING\\n&quot; + &quot;) WITH (\\n&quot; + &quot; 'connector' = 'kafka',\\n&quot; + &quot; 'topic' = 'input_kafka',\\n&quot; + &quot; 'properties.bootstrap.servers' = 'node1:9092',\\n&quot; + &quot; 'properties.group.id' = 'testGroup',\\n&quot; + &quot; 'scan.startup.mode' = 'latest-offset',\\n&quot; + &quot; 'format' = 'json'\\n&quot; + &quot;)&quot; ); TableResult outputTable = tEnv.executeSql( &quot;CREATE TABLE output_kafka (\\n&quot; + &quot; `user_id` BIGINT,\\n&quot; + &quot; `page_id` BIGINT,\\n&quot; + &quot; `status` STRING\\n&quot; + &quot;) WITH (\\n&quot; + &quot; 'connector' = 'kafka',\\n&quot; + &quot; 'topic' = 'output_kafka',\\n&quot; + &quot; 'properties.bootstrap.servers' = 'node1:9092',\\n&quot; + &quot; 'format' = 'json',\\n&quot; + &quot; 'sink.partitioner' = 'round-robin'\\n&quot; + &quot;)&quot; ); String sql = &quot;select &quot; + &quot;user_id,&quot; + &quot;page_id,&quot; + &quot;status &quot; + &quot;from input_kafka &quot; + &quot;where status = 'success'&quot;; Table ResultTable = tEnv.sqlQuery(sql); DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; resultDS = tEnv.toRetractStream(ResultTable, Row.class); resultDS.print(); tEnv.executeSql(&quot;insert into output_kafka select * from &quot; + ResultTable); //7.excute env.execute(); } } 2 Flink SQLå¸¸ç”¨ç®—å­ 2.1 SELECT SELECT ï¼šç”¨äºä» DataSet/DataStream ä¸­é€‰æ‹©æ•°æ®ï¼Œç”¨äºç­›é€‰å‡ºæŸäº›åˆ—ã€‚ ç¤ºä¾‹ï¼š SELECT * FROM Tableï¼›// å–å‡ºè¡¨ä¸­çš„æ‰€æœ‰åˆ— SELECT nameï¼Œage FROM Tableï¼›// å–å‡ºè¡¨ä¸­ name å’Œ ageä¸¤åˆ— ä¸æ­¤åŒæ—¶ SELECTè¯­å¥ä¸­å¯ä»¥ä½¿ç”¨å‡½æ•°å’Œåˆ«åï¼Œä¾‹å¦‚æˆ‘ä»¬ä¸Šé¢æåˆ°çš„ WordCountä¸­ï¼š SELECT word, COUNT(word) FROM table GROUP BY word; 2.2 WHERE WHERE ï¼šç”¨äºä»æ•°æ®é›†/æµä¸­è¿‡æ»¤æ•°æ®ï¼Œä¸ SELECT ä¸€èµ·ä½¿ç”¨ï¼Œç”¨äºæ ¹æ®æŸäº›æ¡ä»¶å¯¹å…³ç³»åšæ°´å¹³åˆ†å‰²ï¼Œå³é€‰æ‹©ç¬¦åˆæ¡ä»¶çš„è®°å½•ã€‚ ç¤ºä¾‹ï¼š SELECT nameï¼Œage FROM Table where name LIKE â€˜% å°æ˜ %â€™ï¼› SELECT * FROM Table WHERE age = 20ï¼› WHEREæ˜¯ä»åŸæ•°æ®ä¸­è¿›è¡Œè¿‡æ»¤ï¼Œé‚£ä¹ˆåœ¨WHEREæ¡ä»¶ä¸­ï¼ŒFlink SQLåŒæ ·æ”¯æŒ =ã€&lt;ã€&gt;ã€&lt;&gt;ã€&gt;=ã€&lt;=ï¼Œä»¥åŠ ANDã€ORç­‰è¡¨è¾¾å¼çš„ç»„åˆï¼Œæœ€ç»ˆæ»¡è¶³è¿‡æ»¤æ¡ä»¶çš„æ•°æ®ä¼šè¢«é€‰æ‹©å‡ºæ¥ã€‚å¹¶ä¸” WHERE å¯ä»¥ç»“åˆINã€NOT INè”åˆä½¿ç”¨ã€‚ä¸¾ä¸ªä¾‹å­ï¼š SELECT name, age FROM Table WHERE name IN (SELECT name FROM Table2) 2.3 DISTINCT DISTINCTï¼š ç”¨äºä»æ•°æ®é›†/æµä¸­å»é‡æ ¹æ® SELECT çš„ç»“æœè¿›è¡Œå»é‡ã€‚ ç¤ºä¾‹ï¼š SELECT DISTINCT name FROM Table; å¯¹äºæµå¼æŸ¥è¯¢ï¼Œè®¡ç®—æŸ¥è¯¢ç»“æœæ‰€éœ€çš„ Stateå¯èƒ½ä¼šæ— é™å¢é•¿ï¼Œç”¨æˆ·éœ€è¦è‡ªå·±æ§åˆ¶æŸ¥è¯¢çš„çŠ¶æ€èŒƒå›´ï¼Œä»¥é˜²æ­¢çŠ¶æ€è¿‡å¤§ã€‚ 2.4 GROUP BY GROUP BY ï¼šæ˜¯å¯¹æ•°æ®è¿›è¡Œåˆ†ç»„æ“ä½œã€‚ä¾‹å¦‚æˆ‘ä»¬éœ€è¦è®¡ç®—æˆç»©æ˜ç»†è¡¨ä¸­ï¼Œæ¯ä¸ªå­¦ç”Ÿçš„æ€»åˆ†ã€‚ ç¤ºä¾‹ï¼š SELECT name, SUM(score) as TotalScore FROM Table GROUP BY name; 2.5 UNION å’Œ UNION ALL UNION: ç”¨äºå°†ä¸¤ä¸ªç»“æœé›†åˆå¹¶èµ·æ¥ï¼Œè¦æ±‚ä¸¤ä¸ªç»“æœé›†å­—æ®µå®Œå…¨ä¸€è‡´ï¼ŒåŒ…æ‹¬å­—æ®µç±»å‹ã€å­—æ®µé¡ºåºã€‚ä¸åŒäº UNION ALL çš„æ˜¯ï¼ŒUNION ä¼šå¯¹ç»“æœæ•°æ®å»é‡ã€‚ ç¤ºä¾‹ï¼š SELECT * FROM T1 UNION (ALL) SELECT * FROM T2ï¼› 2.6 JOIN JOIN ï¼šç”¨äºæŠŠæ¥è‡ªä¸¤ä¸ªè¡¨çš„æ•°æ®è”åˆèµ·æ¥å½¢æˆç»“æœè¡¨ï¼ŒFlinkæ”¯æŒçš„JOIN ç±»å‹åŒ…æ‹¬ï¼š JOIN - INNER JOIN LEFT JOIN - LEFT OUTER JOIN RIGHT JOIN - RIGHT OUTER JOIN FULL JOIN - FULL OUTER JOIN è¿™é‡Œçš„ JOINçš„è¯­ä¹‰å’Œæˆ‘ä»¬åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ä½¿ç”¨çš„ JOIN è¯­ä¹‰ä¸€è‡´ã€‚ ç¤ºä¾‹ï¼šJOIN(å°†è®¢å•è¡¨æ•°æ®å’Œå•†å“è¡¨è¿›è¡Œå…³è”) SELECT * FROM Orders INNER JOIN Product ON Orders.productId = Product.id LEFT JOINä¸ JOIN çš„åŒºåˆ«æ˜¯å½“å³è¡¨æ²¡æœ‰ä¸å·¦è¾¹ç›¸ JOIN çš„æ•°æ®æ—¶å€™ï¼Œå³è¾¹å¯¹åº”çš„å­—æ®µè¡¥NULLè¾“å‡ºï¼ŒRIGHT JOIN ç›¸å½“äºLEFT JOINå·¦å³ä¸¤ä¸ªè¡¨äº¤äº’ä¸€ä¸‹ä½ç½®ã€‚FULL JOINç›¸å½“äºRIGHT JOIN å’Œ LEFT JOINä¹‹åè¿›è¡ŒUNION ALL æ“ä½œï¼Œç¤ºä¾‹ï¼š SELECT * FROM Orders LEFT JOIN Product ON Orders.productId = Product.id SELECT * FROM Orders RIGHT JOIN Product ON Orders.productId = Product.id SELECT * FROM Orders FULL OUTER JOIN Product ON Orders.productId = Product.id 3 çª—å£(window) 3 èšåˆï¼ˆAggregationï¼‰æŸ¥è¯¢ 3.1 TTL åœ¨æŒç»­æŸ¥è¯¢çš„è¿‡ç¨‹ä¸­ï¼Œç”±äºç”¨äºåˆ†ç»„çš„ key å¯èƒ½ä¼šä¸æ–­å¢åŠ ï¼Œå› æ­¤è®¡ç®—ç»“æœæ‰€éœ€è¦ ç»´æŠ¤çš„çŠ¶æ€ä¹Ÿä¼šæŒç»­å¢é•¿ã€‚ä¸ºäº†é˜²æ­¢çŠ¶æ€æ— é™å¢é•¿è€—å°½èµ„æº æ–¹å¼1 TableEnvironment tableEnv = ... // è·å–è¡¨ç¯å¢ƒçš„é…ç½® TableConfig tableConfig = tableEnv.getConfig(); // é…ç½®çŠ¶æ€ä¿æŒæ—¶é—´ tableConfig.setIdleStateRetention(Duration.ofMinutes(60)); æ–¹å¼2 TableEnvironment tableEnv = ... Configuration configuration = tableEnv.getConfig().getConfiguration(); configuration.setString(&quot;table.exec.state.ttl&quot;, &quot;60 min&quot;); 3.2 åˆ†ç»„èšåˆ è¿ç”¨ Table eventCountTable = tableEnv.sqlQuery(&quot;SELECT user, COUNT(url) as cnt FROM EventTable GROUP BY user&quot;); csvæ•°æ® Mary,./home,1000 Alice,./cart,2000 Bob,./prod?id=100,3000 Bob,./cart,4000 Bob,./home,5000 Mary,./home,6000 Bob,./cart,7000 Bob,./home,8000 Bob,./prod?id=10,9000 Bob,./prod?id=10,11000 Bob,./prod?id=10,13000 Bob,./prod?id=10,15000 public class TimeAndWindowTest { public static void main(String[] args) throws Exception{ StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); env.setParallelism(1); StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env); //1. åœ¨åˆ›å»ºè¡¨çš„DDLä¸­ç›´æ¥å®šä¹‰æ—¶é—´å±æ€§ String createDDL = &quot;CREATE TABLE clickTable (&quot; + &quot; user_name STRING, &quot; + &quot; url STRING, &quot; + &quot; ts BIGINT,&quot; + &quot; et AS TO_TIMESTAMP(FROM_UNIXTIME(ts/1000)),&quot; +//TO_TIMESTAMPè¦String,ä½¿ç”¨FROM_UNIXTIMEè½¬æˆstringä¼ å…¥ï¼Œts/1000æ˜¯ç§’ &quot; WATERMARK FOR et AS et - INTERVAL '1' SECOND &quot; +//æ°´ä½çº¿ &quot; ) WITH (&quot; + &quot; 'connector' = 'filesystem',&quot; + &quot; 'path' = 'input/clicks.csv',&quot;+ &quot; 'format' = 'csv'&quot; + &quot;) &quot;; tableEnv.executeSql(createDDL); //2.åœ¨æµè½¬æ¢æˆTableçš„æ—¶å€™å®šä¹‰æ—¶é—´å±æ€§ SingleOutputStreamOperator&lt;Event&gt; clickStream = env.addSource(new ClickSource()) .assignTimestampsAndWatermarks(WatermarkStrategy.&lt;Event&gt;forBoundedOutOfOrderness(Duration.ZERO) .withTimestampAssigner(new SerializableTimestampAssigner&lt;Event&gt;() { @Override public long extractTimestamp(Event element, long recordTimestamp) { return element.timestamp; } })); Table clickTable = tableEnv.fromDataStream(clickStream, $(&quot;user&quot;), $(&quot;url&quot;), $(&quot;timestamp&quot;).as(&quot;ts&quot;), $(&quot;et&quot;).rowtime()); //3.èšåˆæŸ¥è¯¢è½¬æ¢ //3.1 åˆ†ç»„èšåˆ Table aggTable = tableEnv.sqlQuery(&quot;select user_name,count(url) from clickTable group by user_name&quot;); //3.2 åˆ†ç»„çª—å£èšåˆ Table groupWindowResultTable = tableEnv.sqlQuery(&quot;select &quot; + &quot; user_name,count(1) as cnt,&quot; + &quot; TUMBLE_END(et,INTERVAL '10' SECOND) as entT &quot; + &quot; from clickTable group by user_name,&quot; + &quot; TUMBLE(et,INTERVAL '10' SECOND)&quot;); //clickTable.printSchema(); tableEnv.toChangelogStream(aggTable).print(&quot;agg&quot;); tableEnv.toChangelogStream(groupWindowResultTable).print(&quot;group window&quot;); env.execute(); } aggç»“æœ agg&gt; +I[Mary, 1] agg&gt; +I[Alice, 1] agg&gt; +I[Bob, 1] agg&gt; -U[Bob, 1] agg&gt; +U[Bob, 2] agg&gt; -U[Bob, 2] agg&gt; +U[Bob, 3] agg&gt; -U[Mary, 1] agg&gt; +U[Mary, 2] agg&gt; -U[Bob, 3] agg&gt; +U[Bob, 4] agg&gt; -U[Bob, 4] agg&gt; +U[Bob, 5] agg&gt; -U[Bob, 5] agg&gt; +U[Bob, 6] agg&gt; -U[Bob, 6] agg&gt; +U[Bob, 7] agg&gt; -U[Bob, 7] agg&gt; +U[Bob, 8] agg&gt; -U[Bob, 8] agg&gt; +U[Bob, 9] group windowç»“æœ group window:&gt; +I[Mary, 2, 1970-01-01T08:00:10] group window:&gt; +I[Alice, 1, 1970-01-01T08:00:10] group window:&gt; +I[Bob, 6, 1970-01-01T08:00:10] group window:&gt; +I[Bob, 3, 1970-01-01T08:00:20] è¡¨ç¤ºMaryåœ¨ç¬¬ä¸€ä¸ªåç§’ä¹‹å†…æœ‰2æ¬¡ç‚¹å‡»ï¼ŒBob6æ¬¡ï¼ŒAlice1æ¬¡ åœ¨ç¬¬äºŒä¸ªçª—å£åç§’ä¸­ï¼ŒBobæœ‰3æ¬¡ 3.3 åˆ†ç»„çª—å£ åœ¨ Flink 1.12 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼ŒTable API å’Œ SQL æä¾›äº†ä¸€ç»„â€œåˆ†ç»„çª—å£â€ï¼ˆGroup Windowï¼‰å‡½æ•°ï¼Œå¸¸ç”¨çš„æ—¶é—´çª—å£å¦‚æ»šåŠ¨çª—å£ã€æ»‘åŠ¨çª—å£ã€ä¼šè¯çª—å£éƒ½æœ‰å¯¹åº”çš„å®ç°ï¼›å…·ä½“åœ¨ SQL ä¸­å°±æ˜¯è°ƒç”¨ TUMBLE()ã€HOP()ã€SESSION()ï¼Œä¼ å…¥æ—¶é—´å±æ€§å­—æ®µã€çª—å£å¤§å°ç­‰å‚æ•°å°±å¯ä»¥äº†ã€‚ 3.3.1 è€ç‰ˆæœ¬ Table result = tableEnv.sqlQuery( &quot;SELECT &quot; + &quot;user, &quot; + &quot;TUMBLE_END(ts, INTERVAL '1' HOUR) as endT, &quot; + &quot;COUNT(url) AS cnt &quot; + &quot;FROM EventTable &quot; + &quot;GROUP BY &quot; + // ä½¿ç”¨çª—å£å’Œç”¨æˆ·åè¿›è¡Œåˆ†ç»„ &quot;user, &quot; + &quot;TUMBLE(ts, INTERVAL '1' HOUR)&quot; // å®šä¹‰ 1 å°æ—¶æ»šåŠ¨çª—å£ ); è¿™é‡Œå®šä¹‰äº† 1 å°æ—¶çš„æ»šåŠ¨çª—å£ï¼Œå°†çª—å£å’Œç”¨æˆ· user ä¸€èµ·ä½œä¸ºåˆ†ç»„çš„å­—æ®µã€‚ç”¨èšåˆå‡½æ•°COUNT()å¯¹åˆ†ç»„æ•°æ®çš„ä¸ªæ•°è¿›è¡Œäº†èšåˆç»Ÿè®¡ï¼Œå¹¶å°†ç»“æœå­—æ®µé‡å‘½åä¸ºcntï¼›ç”¨TUPMBLE_END()å‡½æ•°è·å–æ»šåŠ¨çª—å£çš„ç»“æŸæ—¶é—´ï¼Œé‡å‘½åä¸º endT æå–å‡ºæ¥ã€‚ 3.3.2 æ–°ç‰ˆæœ¬ï¼ˆçª—å£è¡¨å€¼å‡½æ•° Windowing TVFsï¼‰ ä» 1.13 ç‰ˆæœ¬å¼€å§‹ï¼ŒFlink å¼€å§‹ä½¿ç”¨çª—å£è¡¨å€¼å‡½æ•°ï¼ˆWindowing table-valued functionsï¼ŒWindowing TVFsï¼‰æ¥å®šä¹‰çª—å£ã€‚çª—å£è¡¨å€¼å‡½æ•°æ˜¯ Flink å®šä¹‰çš„å¤šæ€è¡¨å‡½æ•°ï¼ˆPTFï¼‰ï¼Œå¯ä»¥å°†è¡¨è¿›è¡Œæ‰©å±•åè¿”å›ã€‚è¡¨å‡½æ•°ï¼ˆtable functionï¼‰å¯ä»¥çœ‹ä½œæ˜¯è¿”å›ä¸€ä¸ªè¡¨çš„å‡½æ•° æ¡ˆä¾‹ StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); env.setParallelism(1); StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env); TableConfig config = tableEnv.getConfig(); config.setIdleStateRetention(Duration.ofMillis(60)); SingleOutputStreamOperator&lt;Event&gt; dataStream = env.addSource(new ClickSource()).assignTimestampsAndWatermarks(WatermarkStrategy.&lt;Event&gt;forBoundedOutOfOrderness(Duration.ZERO) .withTimestampAssigner(new SerializableTimestampAssigner&lt;Event&gt;() { @Override public long extractTimestamp(Event element, long recordTimestamp) { return element.getTimestamp(); } })); // 1. æ³¨å†Œè™šæ‹Ÿè¡¨ tableEnv.createTemporaryView(&quot;table_click&quot;, dataStream, $(&quot;user&quot;), $(&quot;ts&quot;).rowtime()); // 2. çª—å£èšåˆæŸ¥è¯¢ è€ç‰ˆæœ¬-æ»šåŠ¨çª—å£ Table agg = tableEnv.sqlQuery(&quot;select &quot; + &quot; user,&quot; + &quot; count(1) AS ct,&quot; + &quot; TUMBLE_END(ts,INTERVAL '10' SECOND) AS endTime&quot; + &quot; from table_click &quot; + &quot; group by user, TUMBLE(ts, INTERVAL '10' SECOND)&quot;); // æ»šåŠ¨çª—å£ å¸ƒé•¿10 // 3. çª—å£èšåˆæŸ¥è¯¢ TVF-æ»šåŠ¨çª—å£ Table tvfTumbleAgg = tableEnv.sqlQuery(&quot;select &quot; + &quot; user,&quot; + &quot; count(1) AS ct,&quot; + &quot; window_start,&quot; + &quot; window_end&quot; + &quot; from TABLE(&quot; + // åˆ›å»ºä¸€ä¸ªæ»šåŠ¨çª—å£,å‚æ•°1:æ•°æ®æ¥æºçš„è™šæ‹Ÿè¡¨,å‚æ•°2:æ»šåŠ¨æ—¥æœŸå‚æ•°ï¼Œå‚æ•°3ï¼šçª—å£å¸ƒé•¿ &quot; TUMBLE(table table_click, DESCRIPTOR(ts), INTERVAL '10' SECOND))&quot; + &quot; GROUP BY user, window_start, window_end&quot;); // group by window_start, window_end å›ºå®šå†™æ³• // 4. çª—å£èšåˆæŸ¥è¯¢ TVF-æ»‘åŠ¨çª—å£ Table tvfHopAgg = tableEnv.sqlQuery(&quot;select &quot; + &quot; user,&quot; + &quot; count(1) AS ct,&quot; + &quot; window_start,&quot; + &quot; window_end&quot; + &quot; from TABLE(&quot; + // åˆ›å»ºä¸€ä¸ªæ»šåŠ¨çª—å£,å‚æ•°1:æ•°æ®æ¥æºçš„è™šæ‹Ÿè¡¨,å‚æ•°2:æ»šåŠ¨æ—¥æœŸå‚æ•°ï¼Œå‚æ•°3ï¼šæ»‘åŠ¨è¡¥å¸ƒé•¿ å‚æ•°4ï¼šçª—å£å¸ƒé•¿ &quot; HOP(table table_click, DESCRIPTOR(ts), INTERVAL '5' SECOND,INTERVAL '10' SECOND))&quot; + &quot; GROUP BY user, window_start, window_end&quot;); // group by window_start, window_end å›ºå®šå†™æ³• // 5. ç´¯è®¡çª—å£ Table tvfCumulateAgg = tableEnv.sqlQuery(&quot;select &quot; + &quot; CURRENT_TIME as cutTime,&quot; + &quot; user,&quot; + &quot; count(1) AS ct,&quot; + &quot; window_start,&quot; + &quot; window_end&quot; + &quot; from TABLE(&quot; + // åˆ›å»ºä¸€ä¸ªæ»šåŠ¨çª—å£,å‚æ•°1:æ•°æ®æ¥æºçš„è™šæ‹Ÿè¡¨,å‚æ•°2:æ»šåŠ¨æ—¥æœŸå‚æ•°ï¼Œå‚æ•°3ï¼šæ¯éš”å¤šä¹…è®¡ç®—è¾“å‡ºä¸€æ¬¡ å‚æ•°4ï¼šå…¨çª—å£å¸ƒé•¿ &quot; CUMULATE(table table_click, DESCRIPTOR(ts), INTERVAL '5' SECOND,INTERVAL '10' SECOND))&quot; + &quot; GROUP BY user, window_start, window_end&quot;); // group by window_start, window_end å›ºå®šå†™æ³• dataStream.print(&quot;source:&quot;); //tableEnv.toChangelogStream(agg).print(&quot;agg:&quot;); //tableEnv.toChangelogStream(tvfTumbleAgg).print(&quot;tvfTumbleAgg:&quot;); //tableEnv.toChangelogStream(tvfHopAgg).print(&quot;tvfHotAgg:&quot;); tableEnv.toChangelogStream(tvfCumulateAgg).print(&quot;tvfCumulateAgg:&quot;); æ³¨æ„ï¼šGROUP BY window_start, window_end æ˜¯å›ºå®šå†™æ³• 3.4 å¼€çª—ï¼ˆOverï¼‰èšåˆ Flink SQL ä¸­çš„å¼€çª—å‡½æ•°ä¹Ÿæ˜¯é€šè¿‡ OVER å­å¥æ¥å®ç°çš„ 3.4.1 è¯­æ³• &lt;èšåˆå‡½æ•°&gt; OVER ( [PARTITION BY &lt;å­—æ®µ 1&gt;[, &lt;å­—æ®µ 2&gt;, ...]] ORDER BY &lt;æ—¶é—´å±æ€§å­—æ®µ&gt; &lt;å¼€çª—èŒƒå›´&gt;), ... FROM ... PARTITION BYï¼ˆå¯é€‰ï¼‰ ç”¨æ¥æŒ‡å®šåˆ†åŒºçš„é”®ï¼ˆkeyï¼‰ï¼Œç±»ä¼¼äº GROUP BY çš„åˆ†ç»„ï¼Œè¿™éƒ¨åˆ†æ˜¯å¯é€‰çš„ ORDER BY OVER çª—å£æ˜¯åŸºäºå½“å‰è¡Œæ‰©å±•å‡ºçš„ä¸€æ®µæ•°æ®èŒƒå›´ï¼Œé€‰æ‹©çš„æ ‡å‡†å¯ä»¥åŸºäºæ—¶é—´ä¹Ÿå¯ä»¥åŸºäºæ•°é‡ã€‚ä¸è®ºé‚£ç§å®šä¹‰ï¼Œæ•°æ®éƒ½åº”è¯¥æ˜¯ä»¥æŸç§é¡ºåºæ’åˆ—å¥½çš„ï¼›è€Œè¡¨ä¸­çš„æ•°æ®æœ¬èº«æ˜¯æ— åºçš„ã€‚æ‰€ä»¥åœ¨OVER å­å¥ä¸­å¿…é¡»ç”¨ ORDER BY æ˜ç¡®åœ°æŒ‡å‡ºæ•°æ®åŸºäºé‚£ä¸ªå­—æ®µæ’åºã€‚åœ¨ Flink çš„æµå¤„ç†ä¸­ï¼Œç›®å‰åªæ”¯æŒæŒ‰ç…§æ—¶é—´å±æ€§çš„å‡åºæ’åˆ—ï¼Œæ‰€ä»¥è¿™é‡Œ ORDER BY åé¢çš„å­—æ®µå¿…é¡»æ˜¯å®šä¹‰å¥½çš„æ—¶é—´å±æ€§ã€‚ å¼€çª—èŒƒå›´ å¯¹äºå¼€çª—å‡½æ•°è€Œè¨€ï¼Œè¿˜æœ‰ä¸€ä¸ªå¿…é¡»è¦æŒ‡å®šçš„å°±æ˜¯å¼€çª—çš„èŒƒå›´ï¼Œä¹Ÿå°±æ˜¯åˆ°åº•è¦æ‰©å±•å¤šå°‘è¡Œæ¥åšèšåˆã€‚è¿™ä¸ªèŒƒå›´æ˜¯ç”± BETWEEN &lt;ä¸‹ç•Œ&gt; AND &lt;ä¸Šç•Œ&gt; æ¥å®šä¹‰çš„ï¼Œä¹Ÿå°±æ˜¯â€œä»ä¸‹ç•Œåˆ°ä¸Šç•Œâ€çš„èŒƒå›´ã€‚ç›®å‰æ”¯æŒçš„ä¸Šç•Œåªèƒ½æ˜¯ CURRENT ROWï¼Œä¹Ÿå°±æ˜¯å®šä¹‰ä¸€ä¸ªâ€œä»ä¹‹å‰æŸä¸€è¡Œåˆ°å½“å‰è¡Œâ€çš„èŒƒå›´ï¼Œæ‰€ä»¥ä¸€èˆ¬çš„å½¢å¼ä¸ºï¼š PRECEDING æŒ‡å‰é¢å‡ ä¸ª/å‰ä¸€æ®µæ—¶é—´ï¼›CURRENT ROWï¼šæŒ‡åˆ°å½“å‰æœ€æ–°å¾—è¡Œæ•° BETWEEN ... PRECEDING AND CURRENT ROW èŒƒå›´é—´éš” èŒƒå›´é—´éš”ä»¥ RANGE ä¸ºå‰ç¼€ï¼Œå°±æ˜¯åŸºäº ORDER BY æŒ‡å®šçš„æ—¶é—´å­—æ®µå»é€‰å–ä¸€ä¸ªèŒƒå›´ï¼Œä¸€èˆ¬å°±æ˜¯å½“å‰è¡Œæ—¶é—´æˆ³ä¹‹å‰çš„ä¸€æ®µæ—¶é—´ã€‚ä¾‹å¦‚å¼€çª—èŒƒå›´é€‰æ‹©å½“å‰è¡Œä¹‹å‰ 1 å°æ—¶çš„æ•°æ®ï¼š RANGE BETWEEN INTERVAL '1' HOUR PRECEDING AND CURRENT ROW è¡Œé—´éš” è¡Œé—´éš”ä»¥ ROWS ä¸ºå‰ç¼€ï¼Œå°±æ˜¯ç›´æ¥ç¡®å®šè¦é€‰å¤šå°‘è¡Œï¼Œç”±å½“å‰è¡Œå‡ºå‘å‘å‰é€‰å–å°±å¯ä»¥äº†ã€‚ ä¾‹å¦‚å¼€çª—èŒƒå›´é€‰æ‹©å½“å‰è¡Œä¹‹å‰çš„ 5 è¡Œæ•°æ®ï¼ˆæœ€ç»ˆèšåˆä¼šåŒ…æ‹¬å½“å‰è¡Œï¼Œæ‰€ä»¥ä¸€å…± 6 æ¡æ•°æ®ï¼‰ ROWS BETWEEN 5 PRECEDING AND CURRENT ROW SELECT user, COUNT(url) OVER ( PARTITION BY user ORDER BY ts RANGE BETWEEN INTERVAL '1' HOUR PRECEDING AND CURRENT ROW ) AS cnt FROM EventTable 4 topN example import com.flink.dto.Event; import org.apache.flink.api.common.eventtime.SerializableTimestampAssigner; import org.apache.flink.api.common.eventtime.WatermarkStrategy; import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.table.api.Table; import org.apache.flink.table.api.bridge.java.StreamTableEnvironment; import static org.apache.flink.table.api.Expressions.$; public class WindowTopNExample { public static void main(String[] args) throws Exception { StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); env.setParallelism(1); // è¯»å–æ•°æ®æºï¼Œå¹¶åˆ†é…æ—¶é—´æˆ³ã€ç”Ÿæˆæ°´ä½çº¿ SingleOutputStreamOperator&lt;Event&gt; eventStream = env .fromElements( new Event(&quot;Alice&quot;, &quot;./home&quot;, 1000L), new Event(&quot;Bob&quot;, &quot;./cart&quot;, 1000L), new Event(&quot;Alice&quot;, &quot;./prod?id=1&quot;, 25 * 60 * 1000L), new Event(&quot;Alice&quot;, &quot;./prod?id=4&quot;, 55 * 60 * 1000L), new Event(&quot;Bob&quot;, &quot;./prod?id=5&quot;, 3600 * 1000L + 60 * 1000L), new Event(&quot;Cary&quot;, &quot;./home&quot;, 3600 * 1000L + 30 * 60 * 1000L), new Event(&quot;Cary&quot;, &quot;./prod?id=7&quot;, 3600 * 1000L + 59 * 60 * 1000L) ).assignTimestampsAndWatermarks(WatermarkStrategy.&lt;Event&gt;forMonotonousTimestamps() .withTimestampAssigner(new SerializableTimestampAssigner&lt;Event&gt;() { @Override public long extractTimestamp(Event element, long recordTimestamp) { return element.getTimestamp(); } })); // åˆ›å»ºè¡¨ç¯å¢ƒ StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env); // å°†æ•°æ®æµè½¬æ¢æˆè¡¨ï¼Œå¹¶æŒ‡å®šæ—¶é—´å±æ€§ Table eventTable = tableEnv.fromDataStream( eventStream, $(&quot;user&quot;), $(&quot;url&quot;), $(&quot;timestamp&quot;).rowtime().as(&quot;ts&quot;) // å°† timestamp æŒ‡å®šä¸ºäº‹ä»¶æ—¶é—´ï¼Œå¹¶å‘½åä¸º ts ); // ä¸ºæ–¹ä¾¿åœ¨ SQL ä¸­å¼•ç”¨ï¼Œåœ¨ç¯å¢ƒä¸­æ³¨å†Œè¡¨ EventTable tableEnv.createTemporaryView(&quot;EventTable&quot;, eventTable); // å®šä¹‰å­æŸ¥è¯¢ï¼Œè¿›è¡Œçª—å£èšåˆï¼Œå¾—åˆ°åŒ…å«çª—å£ä¿¡æ¯ã€ç”¨æˆ·ä»¥åŠè®¿é—®æ¬¡æ•°çš„ç»“æœè¡¨ String subQuery = &quot;SELECT window_start, window_end, user, COUNT(url) as cnt &quot; + &quot;FROM TABLE ( &quot; + &quot;TUMBLE( TABLE EventTable, DESCRIPTOR(ts), INTERVAL '1' HOUR )) &quot; + // æ»šåŠ¨çª—å£ å¸ƒé•¿1å°æ—¶ &quot;GROUP BY window_start, window_end, user &quot;; // å®šä¹‰ Top N çš„å¤–å±‚æŸ¥è¯¢ String topNQuery = &quot;SELECT * &quot; + &quot;FROM (&quot; + &quot;SELECT *, &quot; + &quot;ROW_NUMBER() OVER ( &quot; + &quot;PARTITION BY window_start, window_end &quot; + &quot;ORDER BY cnt desc &quot; + &quot;) AS row_num &quot; + &quot;FROM (&quot; + subQuery + &quot;)) &quot; + &quot;WHERE row_num &lt;= 2&quot;; // æ‰§è¡Œ SQL å¾—åˆ°ç»“æœè¡¨ Table result = tableEnv.sqlQuery(topNQuery); tableEnv.toDataStream(result).print(); env.execute(); } } 5 è”ç»“æŸ¥è¯¢ 5.1 å¸¸è§„è”ç»“æŸ¥è¯¢ ç­‰å€¼å†…è¿æ¥ ç­‰å€¼å¤–è¿æ¥ è¿™éƒ¨åˆ†è·Ÿæ ‡å‡†SQLä¸€æ ·å‘¢ï¼Œå°±ä¸èµ˜è¿°å•¦ 5.2 é—´éš”è”ç»“æŸ¥è¯¢ 1.æ—¶é—´é—´éš”é™åˆ¶ ltime BETWEEN rtime - INTERVAL '10' SECOND AND rtime + INTERVAL '5' SECOND SELECT * FROM Order o, Shipment s WHERE o.id = s.order_id AND o.order_time BETWEEN s.ship_time - INTERVAL '4' HOUR AND s.ship_time åœ¨æµå¤„ç†ä¸­ï¼Œé—´éš”è”ç»“æŸ¥è¯¢åªæ”¯æŒå…·æœ‰æ—¶é—´å±æ€§çš„â€œä»…è¿½åŠ â€ï¼ˆAppend-onlyï¼‰è¡¨ã€‚ ","link":"https://tianxiawuhao.github.io/ODDWghbcN/"},{"title":"ç¬¬åç«  Table API ä¸ SQL","content":"Table API &amp; SQL ä»‹ç» 1.1 Flink Tableæ¨¡å— å‚è€ƒï¼šhttps://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/ Flinkçš„Tableæ¨¡å—åŒ…æ‹¬ Table APIå’Œ SQLï¼š Table APIï¼š æ˜¯ä¸€ç§ç±»SQLçš„APIï¼Œé€šè¿‡Table APIï¼Œç”¨æˆ·å¯ä»¥åƒæ“ä½œè¡¨ä¸€æ ·æ“ä½œæ•°æ®ï¼Œéå¸¸ç›´è§‚å’Œæ–¹ä¾¿ï¼› SQLï¼šä½œä¸ºä¸€ç§å£°æ˜å¼è¯­è¨€ï¼Œæœ‰ç€æ ‡å‡†çš„è¯­æ³•å’Œè§„èŒƒï¼Œç”¨æˆ·å¯ä»¥ä¸ç”¨å…³å¿ƒåº•å±‚å®ç°å³å¯è¿›è¡Œæ•°æ®çš„å¤„ç†ï¼Œéå¸¸æ˜“äºä¸Šæ‰‹ã€‚ Flink Table API å’Œ SQL çš„å®ç°ä¸Šæœ‰80%å·¦å³çš„ä»£ç æ˜¯å…¬ç”¨çš„ã€‚ä½œä¸ºä¸€ä¸ªæµæ‰¹ç»Ÿä¸€çš„è®¡ç®—å¼•æ“ï¼ŒFlink çš„ Runtime å±‚æ˜¯ç»Ÿä¸€çš„ã€‚ 1.2 Table API &amp; SQLç‰¹ç‚¹ Flinkä¹‹æ‰€ä»¥é€‰æ‹©å°† Table API &amp; SQLä½œä¸ºæœªæ¥çš„æ ¸å¿ƒ APIï¼Œæ˜¯å› ä¸ºå…¶å…·æœ‰ä¸€äº›éå¸¸é‡è¦çš„ç‰¹ç‚¹ï¼š å£°æ˜å¼ï¼šç”¨æˆ·åªå…³å¿ƒåšä»€ä¹ˆï¼Œä¸ç”¨å…³å¿ƒæ€ä¹ˆåš é«˜æ€§èƒ½ï¼šæ”¯æŒæŸ¥è¯¢ä¼˜åŒ–ï¼Œå¯ä»¥è·å–æ›´å¥½çš„æ‰§è¡Œæ€§èƒ½ æ‰¹æµç»Ÿä¸€ï¼šç›¸åŒçš„ç»Ÿè®¡é€»è¾‘ï¼Œæ—¢å¯ä»¥æµæ¨¡å¼è¿è¡Œï¼Œä¹Ÿå¯ä»¥æ‰¹æ¨¡å¼è¿è¡Œ æ ‡å‡†ç¨³å®šï¼šè¯­ä¹‰éµå¾ªSQLæ ‡å‡†ï¼Œä¸æ˜“å˜åŠ¨ æ˜“ç†è§£ï¼šè¯­ä¹‰æ˜ç¡®ï¼Œæ‰€è§å³æ‰€å¾— ä½¿ç”¨ä¸¾ä¾‹ï¼š Table API SQL tab.groupBy(â€œwordâ€).select(&quot;word,count(1) as count&quot;) SELECT word,COUNT(*) AS cnt FROM MyTable GROUP BY word 1.3 Table API&amp; SQLå‘å±•å†ç¨‹ è‡ª 2015 å¹´å¼€å§‹ï¼Œé˜¿é‡Œå·´å·´å¼€å§‹è°ƒç ”å¼€æºæµè®¡ç®—å¼•æ“ï¼Œæœ€ç»ˆå†³å®šåŸºäº Flink æ‰“é€ æ–°ä¸€ä»£è®¡ç®—å¼•æ“ï¼Œé’ˆå¯¹ Flinkå­˜åœ¨çš„ä¸è¶³è¿›è¡Œä¼˜åŒ–å’Œæ”¹è¿›ï¼Œå¹¶ä¸”åœ¨ 2019 å¹´åˆå°†æœ€ç»ˆä»£ç å¼€æºï¼Œä¹Ÿå°±æ˜¯Blinkã€‚ Blink åœ¨åŸæ¥çš„ Flink åŸºç¡€ä¸Šæœ€æ˜¾è‘—çš„ä¸€ä¸ªè´¡çŒ®å°±æ˜¯ Flink SQLçš„å®ç°ï¼ æ¶æ„å‡çº§ï¼š æŸ¥è¯¢å¤„ç†å™¨çš„é€‰æ‹© ï¼š Flink1.11ä¹‹åBlink Query ProcessoræŸ¥è¯¢å¤„ç†å™¨å·²ç»æ˜¯é»˜è®¤çš„äº†ã€‚ 03 å¼€å‘å‡†å¤‡ å‚è€ƒï¼šhttps://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/ 2.1 æ·»åŠ ä¾èµ– &lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-table-api-scala-bridge_2.12&lt;/artifactId&gt; &lt;version&gt;${flink.version}&lt;/version&gt; &lt;scope&gt;provided&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-table-api-java-bridge_2.12&lt;/artifactId&gt; &lt;version&gt;${flink.version}&lt;/version&gt; &lt;scope&gt;provided&lt;/scope&gt; &lt;/dependency&gt; &lt;!-- flinkæ‰§è¡Œè®¡åˆ’,è¿™æ˜¯1.9ç‰ˆæœ¬ä¹‹å‰çš„--&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-table-planner_2.12&lt;/artifactId&gt; &lt;version&gt;${flink.version}&lt;/version&gt; &lt;/dependency&gt; &lt;!-- blinkæ‰§è¡Œè®¡åˆ’,1.11+é»˜è®¤çš„--&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-table-planner-blink_2.12&lt;/artifactId&gt; &lt;version&gt;${flink.version}&lt;/version&gt; &lt;scope&gt;provided&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-table-common&lt;/artifactId&gt; &lt;version&gt;${flink.version}&lt;/version&gt; &lt;scope&gt;provided&lt;/scope&gt; &lt;/dependency&gt; è§£æï¼š flink-table-commonï¼šè¿™ä¸ªåŒ…ä¸­ä¸»è¦æ˜¯åŒ…å« Flink Plannerå’Œ Blink Plannerä¸€äº›å…±ç”¨çš„ä»£ç ã€‚ flink-table-api-javaï¼šè¿™éƒ¨åˆ†æ˜¯ç”¨æˆ·ç¼–ç¨‹ä½¿ç”¨çš„ APIï¼ŒåŒ…å«äº†å¤§éƒ¨åˆ†çš„APIã€‚ flink-table-api-scalaï¼šè¿™é‡Œåªæ˜¯éå¸¸è–„çš„ä¸€å±‚ï¼Œä»…å’Œ Table APIçš„ Expression å’Œ DSL ç›¸å…³ã€‚ ä¸¤ä¸ª Plannerï¼šflink-table-plannerå’Œ flink-table-planner-blinkã€‚ ä¸¤ä¸ª Bridgeï¼šflink-table-api-scala-bridge å’Œ flink-table-api-java-bridge Flink Planner å’Œ Blink Planner éƒ½ä¼šä¾èµ–äºå…·ä½“çš„ JavaAPIï¼Œä¹Ÿä¼šä¾èµ–äºå…·ä½“çš„ Bridgeï¼Œé€šè¿‡Bridgeå¯ä»¥å°† API æ“ä½œç›¸åº”çš„è½¬åŒ–ä¸ºScalaçš„ DataStreamï¼Œæˆ–è€…è½¬åŒ–ä¸ºJAVAçš„ DataStream 2.2 ç¨‹åºç»“æ„ å‚è€ƒï¼šhttps://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/common.html#structure-of-table-api-and-sql-programs // create a TableEnvironment for specific planner batch or streaming TableEnvironment tableEnv = ...; // see &quot;Create a TableEnvironment&quot; section // create a Table tableEnv.connect(...).createTemporaryTable(&quot;table1&quot;); // register an output Table tableEnv.connect(...).createTemporaryTable(&quot;outputTable&quot;); // create a Table object from a Table API query Table tapiResult = tableEnv.from(&quot;table1&quot;).select(...); // create a Table object from a SQL query Table sqlResult = tableEnv.sqlQuery(&quot;SELECT ... FROM table1 ... &quot;); // emit a Table API result Table to a TableSink, same for SQL result TableResult tableResult = tapiResult.executeInsert(&quot;outputTable&quot;); tableResult... 2.3 API 2.3.1 è·å–ç¯å¢ƒ å‚è€ƒï¼šhttps://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/common.html#create-a-tableenvironment // ********************** // FLINK STREAMING QUERY // ********************** import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.table.api.EnvironmentSettings; import org.apache.flink.table.api.bridge.java.StreamTableEnvironment; EnvironmentSettings fsSettings = EnvironmentSettings.newInstance().useOldPlanner().inStreamingMode().build(); StreamExecutionEnvironment fsEnv = StreamExecutionEnvironment.getExecutionEnvironment(); StreamTableEnvironment fsTableEnv = StreamTableEnvironment.create(fsEnv, fsSettings); // or TableEnvironment fsTableEnv = TableEnvironment.create(fsSettings); // ****************** // FLINK BATCH QUERY // ****************** import org.apache.flink.api.java.ExecutionEnvironment; import org.apache.flink.table.api.bridge.java.BatchTableEnvironment; ExecutionEnvironment fbEnv = ExecutionEnvironment.getExecutionEnvironment(); BatchTableEnvironment fbTableEnv = BatchTableEnvironment.create(fbEnv); // ********************** // BLINK STREAMING QUERY // ********************** import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.table.api.EnvironmentSettings; import org.apache.flink.table.api.bridge.java.StreamTableEnvironment; StreamExecutionEnvironment bsEnv = StreamExecutionEnvironment.getExecutionEnvironment(); EnvironmentSettings bsSettings = EnvironmentSettings.newInstance().useBlinkPlanner().inStreamingMode().build(); StreamTableEnvironment bsTableEnv = StreamTableEnvironment.create(bsEnv, bsSettings); // or TableEnvironment bsTableEnv = TableEnvironment.create(bsSettings); // ****************** // BLINK BATCH QUERY // ****************** import org.apache.flink.table.api.EnvironmentSettings; import org.apache.flink.table.api.TableEnvironment; EnvironmentSettings bbSettings = EnvironmentSettings.newInstance().useBlinkPlanner().inBatchMode().build(); TableEnvironment bbTableEnv = TableEnvironment.create(bbSettings); 2.3.3 åˆ›å»ºè¡¨ // get a TableEnvironment TableEnvironment tableEnv = ...; // see &quot;Create a TableEnvironment&quot; section // table is the result of a simple projection query Table projTable = tableEnv.from(&quot;X&quot;).select(...); // register the Table projTable as table &quot;projectedTable&quot; tableEnv.createTemporaryView(&quot;projectedTable&quot;, projTable); tableEnvironment .connect(...) .withFormat(...) .withSchema(...) .inAppendMode() .createTemporaryTable(&quot;MyTable&quot;) 2.3.4 æŸ¥è¯¢è¡¨ Table APIï¼š // get a TableEnvironment TableEnvironment tableEnv = ...; // see &quot;Create a TableEnvironment&quot; section // register Orders table // scan registered Orders table Table orders = tableEnv.from(&quot;Orders&quot;);// compute revenue for all customers from France Table revenue = orders .filter($(&quot;cCountry&quot;) .isEqual(&quot;FRANCE&quot;)) .groupBy($(&quot;cID&quot;), $(&quot;cName&quot;) .select($(&quot;cID&quot;), $(&quot;cName&quot;), $(&quot;revenue&quot;) .sum() .as(&quot;revSum&quot;)); // emit or convert Table // execute query SQLï¼š // get a TableEnvironment TableEnvironment tableEnv = ...; // see &quot;Create a TableEnvironment&quot; section // register Orders table // compute revenue for all customers from France Table revenue = tableEnv.sqlQuery( &quot;SELECT cID, cName, SUM(revenue) AS revSum &quot; + &quot;FROM Orders &quot; + &quot;WHERE cCountry = 'FRANCE' &quot; + &quot;GROUP BY cID, cName&quot; ); // emit or convert Table // execute query // get a TableEnvironment TableEnvironment tableEnv = ...; // see &quot;Create a TableEnvironment&quot; section // register &quot;Orders&quot; table // register &quot;RevenueFrance&quot; output table // compute revenue for all customers from France and emit to &quot;RevenueFrance&quot; tableEnv.executeSql( &quot;INSERT INTO RevenueFrance &quot; + &quot;SELECT cID, cName, SUM(revenue) AS revSum &quot; + &quot;FROM Orders &quot; + &quot;WHERE cCountry = 'FRANCE' &quot; + &quot;GROUP BY cID, cName&quot; ); 2.3.5 å†™å‡ºè¡¨ // get a TableEnvironment TableEnvironment tableEnv = ...; // see &quot;Create a TableEnvironment&quot; section // create an output Table final Schema schema = new Schema() .field(&quot;a&quot;, DataTypes.INT()) .field(&quot;b&quot;, DataTypes.STRING()) .field(&quot;c&quot;, DataTypes.BIGINT()); tableEnv.connect(new FileSystem().path(&quot;/path/to/file&quot;)) .withFormat(new Csv().fieldDelimiter('|').deriveSchema()) .withSchema(schema) .createTemporaryTable(&quot;CsvSinkTable&quot;); // compute a result Table using Table API operators and/or SQL queries Table result = ... // emit the result Table to the registered TableSink result.executeInsert(&quot;CsvSinkTable&quot;); 2.3.6 ä¸DataStreamé›†æˆ å‚è€ƒï¼šhttps://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/common.html#integration-with-datastream-and-dataset-api 3.3.6.1 ä»DataStreamåˆ›å»ºè§†å›¾ Create a View from a DataStream or DataSetï¼š // get StreamTableEnvironment // registration of a DataSet in a BatchTableEnvironment is equivalent StreamTableEnvironment tableEnv = ...; // see &quot;Create a TableEnvironment&quot; section DataStream&lt;Tuple2&lt;Long, String&gt;&gt; stream = ... // register the DataStream as View &quot;myTable&quot; with fields &quot;f0&quot;, &quot;f1&quot; tableEnv.createTemporaryView(&quot;myTable&quot;, stream); // register the DataStream as View &quot;myTable2&quot; with fields &quot;myLong&quot;, &quot;myString&quot; tableEnv.createTemporaryView(&quot;myTable2&quot;, stream, $(&quot;myLong&quot;), $(&quot;myString&quot;)); 2.3.6.2 è½¬æ¢DataStreamåˆ°è¡¨ Convert a DataStream or DataSet into a Tableï¼š // get StreamTableEnvironment// registration of a DataSet in a BatchTableEnvironment is equivalent StreamTableEnvironment tableEnv = ...; // see &quot;Create a TableEnvironment&quot; section DataStream&lt;Tuple2&lt;Long, String&gt;&gt; stream = ... // Convert the DataStream into a Table with default fields &quot;f0&quot;, &quot;f1&quot; Table table1 = tableEnv.fromDataStream(stream); // Convert the DataStream into a Table with fields &quot;myLong&quot;, &quot;myString&quot; Table table2 = tableEnv.fromDataStream(stream, $(&quot;myLong&quot;), $(&quot;myString&quot;)); 2.3.6.3 è½¬æ¢è¡¨åˆ°DataStream Convert a Table into a DataStreamï¼š è¿½åŠ æ¨¡å¼ï¼ˆAppend Modeï¼‰ï¼šåªæœ‰å½“åŠ¨æ€è¡¨ä»…é€šè¿‡æ’å…¥æ›´æ”¹è¿›è¡Œä¿®æ”¹æ—¶ï¼Œæ‰èƒ½ä½¿ç”¨æ­¤æ¨¡å¼ï¼Œå³ï¼Œå®ƒæ˜¯ä»…è¿½åŠ æ¨¡å¼ï¼Œå¹¶ä¸”ä»¥å‰å‘å‡ºçš„ç»“æœä»ä¸æ›´æ–°ï¼› æ’¤å›æ¨¡å¼ï¼ˆRetract Modeï¼‰ï¼šæ­¤æ¨¡å¼å§‹ç»ˆå¯ç”¨ã€‚å®ƒä½¿ç”¨å¸ƒå°”æ ‡å¿—å¯¹æ’å…¥å’Œåˆ é™¤æ›´æ”¹è¿›è¡Œç¼–ç ã€‚ // get StreamTableEnvironment. StreamTableEnvironment tableEnv = ...; // see &quot;Create a TableEnvironment&quot; section // Table with two fields (String name, Integer age) Table table = ... // convert the Table into an append DataStream of Row by specifying the class DataStream&lt;Row&gt; dsRow = tableEnv.toAppendStream(table, Row.class); // convert the Table into an append DataStream of Tuple2&lt;String, Integer&gt; // via a TypeInformation TupleTypeInfo&lt;Tuple2&lt;String, Integer&gt;&gt; tupleType = new TupleTypeInfo&lt;&gt;( Types.STRING(), Types.INT()); DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; dsTuple = tableEnv.toAppendStream(table, tupleType); // convert the Table into a retract DataStream of Row. // A retract stream of type X is a DataStream&lt;Tuple2&lt;Boolean, X&gt;&gt;. // The boolean field indicates the type of the change. // True is INSERT, false is DELETE. DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; retractStream = tableEnv.toRetractStream(table, Row.class); 2.3.7 TableAPI å‚è€ƒï¼šhttps://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/tableApi.html 2.3.8 SQL å‚è€ƒï¼šhttps://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sql/ 03 ç›¸å…³æ¦‚å¿µ å‚è€ƒï¼šhttps://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/streaming/dynamic_tables.html 3.1 åŠ¨æ€è¡¨å’Œè¿ç»­æŸ¥è¯¢ åœ¨Flinkä¸­ï¼Œå®ƒæŠŠé’ˆå¯¹æ— ç•Œæµçš„è¡¨ç§°ä¹‹ä¸ºDynamic Tableï¼ˆåŠ¨æ€è¡¨ï¼‰ã€‚å®ƒæ˜¯Flink Table APIå’ŒSQLçš„æ ¸å¿ƒæ¦‚å¿µï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒè¡¨ç¤ºäº†Tableæ˜¯ä¸æ–­å˜åŒ–çš„ã€‚ æˆ‘ä»¬å¯ä»¥è¿™æ ·æ¥ç†è§£ï¼Œå½“æˆ‘ä»¬ç”¨Flinkçš„APIï¼Œå»ºç«‹ä¸€ä¸ªè¡¨ï¼Œå…¶å®æŠŠå®ƒç†è§£ä¸ºå»ºç«‹ä¸€ä¸ªé€»è¾‘ç»“æ„ï¼Œè¿™ä¸ªé€»è¾‘ç»“æ„éœ€è¦æ˜ å°„åˆ°æ•°æ®ä¸Šå»ã€‚ Flink sourceæºæºä¸æ–­çš„æµå…¥æ•°æ®ï¼Œå°±å¥½æ¯”æ¯æ¬¡éƒ½å¾€è¡¨ä¸Šæ–°å¢ä¸€æ¡æ•°æ®ã€‚è¡¨ä¸­æœ‰äº†æ•°æ®ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨SQLå»æŸ¥è¯¢äº†ã€‚è¦æ³¨æ„ä¸€ä¸‹ï¼Œæµå¤„ç†ä¸­çš„æ•°æ®æ˜¯åªæœ‰æ–°å¢çš„ï¼Œæ‰€ä»¥çœ‹èµ·æ¥æ•°æ®ä¼šæºæºä¸æ–­åœ°æ·»åŠ åˆ°è¡¨ä¸­ã€‚ åŠ¨æ€è¡¨ä¹Ÿæ˜¯ä¸€ç§è¡¨ï¼Œæ—¢ç„¶æ˜¯è¡¨ï¼Œå°±åº”è¯¥èƒ½å¤Ÿè¢«æŸ¥è¯¢ã€‚æˆ‘ä»¬æ¥å›æƒ³ä¸€ä¸‹åŸå…ˆæˆ‘ä»¬æŸ¥è¯¢è¡¨çš„åœºæ™¯ã€‚ æ‰“å¼€ç¼–è¯‘å·¥å…·ï¼Œç¼–å†™ä¸€æ¡SQLè¯­å¥ å°†SQLè¯­å¥æ”¾å…¥åˆ°mysqlçš„ç»ˆç«¯æ‰§è¡Œ æŸ¥çœ‹ç»“æœ å†ç¼–å†™ä¸€æ¡SQLè¯­å¥ å†æ”¾å…¥åˆ°ç»ˆç«¯æ‰§è¡Œ å†æŸ¥çœ‹ç»“æœ â€¦â€¦å¦‚æ­¤åå¤ è€Œé’ˆå¯¹åŠ¨æ€è¡¨ï¼ŒFlinkçš„sourceç«¯è‚¯å®šæ˜¯æºæºä¸æ–­åœ°ä¼šæœ‰æ•°æ®æµå…¥ï¼Œç„¶åæˆ‘ä»¬åŸºäºè¿™ä¸ªæ•°æ®æµå»ºç«‹äº†ä¸€å¼ è¡¨ï¼Œå†ç¼–å†™SQLè¯­å¥æŸ¥è¯¢æ•°æ®ï¼Œè¿›è¡Œå¤„ç†ã€‚è¿™ä¸ªSQLè¯­å¥ä¸€å®šæ˜¯ä¸æ–­åœ°æ‰§è¡Œçš„ï¼Œè€Œä¸æ˜¯åªæ‰§è¡Œä¸€æ¬¡ã€‚ æ³¨æ„ï¼šé’ˆå¯¹æµå¤„ç†çš„SQLç»å¯¹ä¸ä¼šåƒæ‰¹å¼å¤„ç†ä¸€æ ·ï¼Œæ‰§è¡Œä¸€æ¬¡æ‹¿åˆ°ç»“æœå°±å®Œäº†ã€‚è€Œæ˜¯ä¼šä¸åœåœ°æ‰§è¡Œï¼Œä¸æ–­åœ°æŸ¥è¯¢è·å–ç»“æœå¤„ç†ã€‚æ‰€ä»¥ï¼Œå®˜æ–¹ç»™è¿™ç§æŸ¥è¯¢æ–¹å¼å–äº†ä¸€ä¸ªåå­—ï¼Œå«Continuous Queryï¼Œä¸­æ–‡ç¿»è¯‘è¿‡æ¥å«è¿ç»­æŸ¥è¯¢ã€‚è€Œä¸”æ¯ä¸€æ¬¡æŸ¥è¯¢å‡ºæ¥çš„æ•°æ®ä¹Ÿæ˜¯ä¸æ–­å˜åŒ–çš„ã€‚ è¯¥ç¤ºæ„å›¾æè¿°äº†ï¼šæˆ‘ä»¬é€šè¿‡å»ºç«‹åŠ¨æ€è¡¨å’Œè¿ç»­æŸ¥è¯¢æ¥å®ç°åœ¨æ— ç•Œæµä¸­çš„SQLæ“ä½œã€‚ å¤§å®¶ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œåœ¨Continuousä¸Šé¢æœ‰ä¸€ä¸ªStateï¼Œè¡¨ç¤ºæŸ¥è¯¢å‡ºæ¥çš„ç»“æœä¼šå­˜å‚¨åœ¨Stateä¸­ï¼Œå†ä¸‹æ¥Flinkæœ€ç»ˆè¿˜æ˜¯ä½¿ç”¨æµæ¥è¿›è¡Œå¤„ç†ã€‚ æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºFlinkçš„Table APIå’ŒSQLï¼Œæ˜¯ä¸€ä¸ªé€»è¾‘æ¨¡å‹ï¼Œé€šè¿‡è¯¥é€»è¾‘æ¨¡å‹å¯ä»¥è®©æˆ‘ä»¬çš„æ•°æ®å¤„ç†å˜å¾—æ›´åŠ ç®€å•ã€‚ 3.2 è¡¨ä¸Streamçš„è½¬æ¢ 3.2.1 è¡¨ä¸­çš„Updateå’ŒDelete æˆ‘ä»¬å‰é¢æåˆ°çš„è¡¨ç¤ºä¸æ–­åœ° Appendï¼Œè¡¨çš„æ•°æ®æ˜¯ä¸€ç›´ç´¯åŠ çš„ï¼Œå› ä¸ºè¡¨ç¤ºå¯¹æ¥Sourceçš„ï¼ŒSourceæ˜¯ä¸ä¼šæœ‰updateçš„ï¼Œä½†å¦‚æœæˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ªSQLã€‚è¿™ä¸ªSQLçœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š SELECT user, sum(money) FROM order GROUP BY user; å½“æ‰§è¡Œä¸€æ¡SQLè¯­å¥ä¹‹åï¼Œè¿™æ¡è¯­å¥çš„ç»“æœè¿˜æ˜¯ä¸€ä¸ªè¡¨ï¼Œå› ä¸ºåœ¨Flinkä¸­æ‰§è¡Œçš„SQLæ˜¯Continuous Queryï¼Œè¿™ä¸ªè¡¨çš„æ•°æ®æ˜¯ä¸æ–­å˜åŒ–çš„ã€‚æ–°åˆ›å»ºçš„è¡¨å­˜åœ¨Updateçš„æƒ…å†µã€‚ä»”ç»†çœ‹ä¸‹ä¸‹é¢çš„ç¤ºä¾‹ï¼Œä¾‹å¦‚ï¼š ç¬¬ä¸€æ¡æ•°æ®ï¼Œå¼ ä¸‰,2000ï¼Œæ‰§è¡Œè¿™æ¡SQLè¯­å¥çš„ç»“æœæ˜¯ï¼Œå¼ ä¸‰,2000 ç¬¬äºŒæ¡æ•°æ®ï¼Œæå››,1500ï¼Œç»§ç»­æ‰§è¡Œè¿™æ¡SQLè¯­å¥ï¼Œç»“æœæ˜¯ï¼Œå¼ ä¸‰,2000 | æå››,1500 ç¬¬ä¸‰æ¡æ•°æ®ï¼Œå¼ ä¸‰,300ï¼Œç»§ç»­æ‰§è¡Œè¿™æ¡SQLè¯­å¥ï¼Œç»“æœæ˜¯ï¼Œå¼ ä¸‰,2300 | æå››,1500 â€¦. å¤§å®¶å‘ç°äº†å—ï¼Œç°åœ¨æ•°æ®ç»“æœæ˜¯æœ‰Updateçš„ï¼Œå¼ ä¸‰ä¸€å¼€å§‹æ˜¯2000ï¼Œä½†åé¢å˜æˆäº†2300ã€‚ é‚£è¿˜æœ‰åˆ é™¤çš„æƒ…å†µå—ï¼Ÿæœ‰çš„ï¼Œçœ‹ä¸‹é¢è¿™æ¡SQLè¯­å¥ï¼š SELECT t1.`user`, SUM(t1.`money`) FROM t_order t1 WHERE NOT EXISTS (SELECT T2.`user`AS TOTAL_MONEY FROM t_order t2 WHERE T2.`user` = T1.`user` GROUP BY t2.`user` HAVING SUM(T2.`money`) &gt; 3000) GROUP BY t1.`user`GROUP BY t1.`user` ç¬¬ä¸€æ¡æ•°æ®ï¼Œå¼ ä¸‰,2000ï¼Œæ‰§è¡Œè¿™æ¡SQLè¯­å¥çš„ç»“æœæ˜¯ï¼Œå¼ ä¸‰,2000 ç¬¬äºŒæ¡æ•°æ®ï¼Œæå››,1500ï¼Œç»§ç»­æ‰§è¡Œè¿™æ¡SQLè¯­å¥ï¼Œç»“æœæ˜¯ï¼Œå¼ ä¸‰,2000 | æå››,1500 ç¬¬ä¸‰æ¡æ•°æ®ï¼Œå¼ ä¸‰,300ï¼Œç»§ç»­æ‰§è¡Œè¿™æ¡SQLè¯­å¥ï¼Œç»“æœæ˜¯ï¼Œå¼ ä¸‰,2300 | æå››,1500 ç¬¬å››æ¡æ•°æ®ï¼Œå¼ ä¸‰,800ï¼Œç»§ç»­æ‰§è¡Œè¿™æ¡SQLè¯­å¥ï¼Œç»“æœæ˜¯ï¼Œæå››,1500 å› ä¸ºå¼ ä¸‰çš„æ¶ˆè´¹çš„é‡‘é¢å·²ç»è¶…è¿‡äº†3000ï¼Œæ‰€ä»¥SQLæ‰§è¡Œå®Œåï¼Œå¼ ä¸‰æ˜¯è¢«å¤„ç†æ‰äº†ã€‚ä»æ•°æ®çš„è§’åº¦æ¥çœ‹ï¼Œå®ƒä¸å°±æ˜¯è¢«åˆ é™¤äº†å—ï¼Ÿ é€šè¿‡ä¸Šé¢çš„ä¸¤ä¸ªç¤ºä¾‹ï¼Œå¯ä»¥çŸ¥é“åœ¨Flink SQLä¸­ï¼Œå¯¹æ¥Sourceçš„è¡¨éƒ½æ˜¯Append-onlyçš„ï¼Œä¸æ–­åœ°å¢åŠ ï¼Œæ‰§è¡Œä¸€äº›SQLç”Ÿæˆçš„è¡¨ï¼Œè¿™ä¸ªè¡¨å¯èƒ½æ˜¯è¦UPDATEçš„ã€ä¹Ÿå¯èƒ½æ˜¯è¦INSERTçš„ã€‚ 3.2.2 å¯¹è¡¨çš„ç¼–ç æ“ä½œ æˆ‘ä»¬å‰é¢è¯´åˆ°è¿‡ï¼Œè¡¨æ˜¯ä¸€ç§é€»è¾‘ç»“æ„ï¼Œè€ŒFlinkä¸­çš„æ ¸å¿ƒè¿˜æ˜¯Streamï¼Œæ‰€ä»¥ï¼ŒTableæœ€ç»ˆè¿˜æ˜¯ä¼šä»¥Streamæ–¹å¼æ¥ç»§ç»­å¤„ç†ï¼Œå¦‚æœæ˜¯ä»¥Streamæ–¹å¼å¤„ç†ï¼Œæœ€ç»ˆStreamä¸­çš„æ•°æ®æœ‰å¯èƒ½ä¼šå†™å…¥åˆ°å…¶ä»–çš„å¤–éƒ¨ç³»ç»Ÿä¸­ï¼Œä¾‹å¦‚ï¼šå°†Streamä¸­çš„æ•°æ®å†™å…¥åˆ°MySQLä¸­ã€‚ æˆ‘ä»¬å‰é¢ä¹Ÿçœ‹åˆ°äº†ï¼Œè¡¨æ˜¯æœ‰å¯èƒ½ä¼šUPDATEå’ŒDELETEçš„ï¼Œé‚£ä¹ˆå¦‚æœæ˜¯è¾“å‡ºåˆ°MySQLä¸­ï¼Œå°±è¦æ‰§è¡ŒUPDATEå’ŒDELETEè¯­å¥äº†ï¼Œè€ŒDataStreamæˆ‘ä»¬åœ¨å­¦ä¹ Flinkçš„æ—¶å€™å°±å­¦ä¹ è¿‡äº†ï¼ŒDataStreamæ˜¯ä¸èƒ½æ›´æ–°ã€åˆ é™¤äº‹ä»¶çš„ã€‚ å¦‚æœå¯¹è¡¨çš„æ“ä½œæ˜¯INSERTï¼Œè¿™å¾ˆå¥½åŠï¼Œç›´æ¥è½¬æ¢è¾“å‡ºå°±å¥½ï¼Œå› ä¸ºDataStreamæ•°æ®ä¹Ÿæ˜¯ä¸æ–­é€’å¢çš„ã€‚ä½†å¦‚æœä¸€ä¸ªTABLEä¸­çš„æ•°æ®è¢«UPDATEäº†ã€æˆ–è€…è¢«DELETEäº†ï¼Œå¦‚æœç”¨æµæ¥è¡¨è¾¾å‘¢ï¼Ÿ å› ä¸ºæµä¸å¯å˜çš„ç‰¹å¾ï¼Œæˆ‘ä»¬è‚¯å®šè¦å¯¹è¿™ç§èƒ½å¤Ÿè¿›è¡ŒUPDATE/DELETEçš„TABLEåšç‰¹æ®Šæ“ä½œã€‚ è§£å†³æ–¹æ¡ˆï¼šæˆ‘ä»¬å¯ä»¥é’ˆå¯¹æ¯ä¸€ç§æ“ä½œï¼ŒINSERT/UPDATE/DELETEéƒ½ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªç»è¿‡ç¼–ç çš„äº‹ä»¶æ¥è¡¨ç¤ºã€‚ä¾‹å¦‚ï¼š é’ˆå¯¹UPDATEï¼Œæˆ‘ä»¬ç”¨ä¸¤ä¸ªæ“ä½œæ¥è¡¨è¾¾ï¼Œ[DELETE]æ•°æ®+ [INSERT]æ•°æ®ã€‚ä¹Ÿå°±æ˜¯å…ˆæŠŠä¹‹å‰çš„æ•°æ®åˆ é™¤ï¼Œç„¶åå†æ’å…¥ä¸€æ¡æ–°çš„æ•°æ®ã€‚ é’ˆå¯¹DELETEï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹æµä¸­çš„æ•°æ®è¿›è¡Œç¼–ç ï¼Œ[DELETE]æ•°æ®ã€‚ æ€»ä½“æ¥è¯´ï¼Œæˆ‘ä»¬é€šè¿‡å¯¹æµæ•°æ®è¿›è¡Œç¼–ç ï¼Œä¹Ÿå¯ä»¥å‘Šè¯‰DataStreamçš„ä¸‹æ¸¸ï¼Œ[DELETE]è¡¨ç¤ºå‘å‡ºMySQLçš„DELETEæ“ä½œï¼Œå°†æ•°æ®åˆ é™¤ã€‚ç”¨[INSERT]è¡¨ç¤ºæ’å…¥æ–°çš„æ•°æ®ã€‚ 3.2.3 å°†è¡¨è½¬æ¢ä¸ºä¸‰ç§ä¸åŒç¼–ç æ–¹å¼çš„æµ Flinkä¸­çš„Table APIæˆ–è€…SQLæ”¯æŒä¸‰ç§ä¸åŒçš„ç¼–ç æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯ï¼š Append-onlyæµ Retractæµ Upsertæµ 3.2.3.1 Append-onlyæµ è·ŸINSERTæ“ä½œå¯¹åº”ã€‚è¿™ç§ç¼–ç ç±»å‹çš„æµé’ˆå¯¹çš„æ˜¯åªä¼šä¸æ–­æ–°å¢çš„Dynamic Tableï¼Œè¿™ç§æ–¹å¼å¥½å¤„ç†ï¼Œä¸éœ€è¦è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œæºæºä¸æ–­åœ°å¾€æµä¸­å‘é€äº‹ä»¶å³å¯ã€‚ 3.2.3.2 Retractæµ è¿™ç§æµå°±å’ŒAppend-onlyä¸å¤ªä¸€æ ·ï¼Œä¸Šé¢çš„åªèƒ½å¤„ç†INSERTï¼Œå¦‚æœè¡¨ä¼šå‘ç”ŸDELETEæˆ–è€…UPDATEï¼ŒAppend-onlyç¼–ç æ–¹å¼çš„æµå°±ä¸åˆé€‚äº†ã€‚ Retractæµæœ‰å‡ ç§ç±»å‹çš„äº‹ä»¶ç±»å‹ï¼š ADD MESSAGEï¼šè¿™ç§æ¶ˆæ¯å¯¹åº”çš„å°±æ˜¯INSERTæ“ä½œã€‚ RETRACT MESSAGEï¼šç›´è¯‘è¿‡æ¥å«æ’¤å›æ¶ˆæ¯ï¼Œè¿™ç§æ¶ˆæ¯å¯¹åº”çš„å°±æ˜¯DELETEæ“ä½œã€‚ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°é€šè¿‡ADD MESSAGEå’ŒRETRACT MESSAGEå¯ä»¥å¾ˆå¥½çš„å‘å¤–éƒ¨ç³»ç»Ÿè¡¨è¾¾åˆ é™¤å’Œæ’å…¥æ“ä½œï¼Œé‚£å¦‚ä½•è¿›è¡ŒUPDATEå‘¢ï¼Ÿå…¶å®RETRACT MESSAGE + ADD MESSAGEå³å¯ï¼ˆå…ˆæŠŠä¹‹å‰çš„æ•°æ®è¿›è¡Œåˆ é™¤ï¼Œç„¶åæ’å…¥ä¸€æ¡æ–°çš„ï¼‰ã€‚ 3.2.3.3 Upsertæµ å‰é¢æˆ‘ä»¬çœ‹åˆ°çš„RETRACTç¼–ç æ–¹å¼çš„æµï¼Œå®ç°UPDATEæ˜¯ä½¿ç”¨DELETE + INSERTæ¨¡å¼çš„ã€‚ å¤§å®¶æƒ³ä¸€ä¸‹ï¼šåœ¨MySQLä¸­æˆ‘ä»¬æ›´æ–°æ•°æ®çš„æ—¶å€™ï¼Œè‚¯å®šä¸ä¼šå…ˆDELETEæ‰ä¸€æ¡æ•°æ®ï¼Œç„¶åå†æ’å…¥ä¸€æ¡æ•°æ®ï¼Œè‚¯å®šæ˜¯ç›´æ¥å‘å‡ºUPDATEè¯­å¥æ‰§è¡Œæ›´æ–°ã€‚ è€ŒUpsertç¼–ç æ–¹å¼çš„æµï¼Œæ˜¯èƒ½å¤Ÿæ”¯æŒUpdateçš„ï¼Œè¿™ç§æ•ˆç‡æ›´é«˜ã€‚å®ƒåŒæ ·æœ‰ä¸¤ç§ç±»å‹çš„æ¶ˆæ¯ï¼š UPSERT MESSAGEï¼šè¿™ç§æ¶ˆæ¯å¯ä»¥è¡¨ç¤ºè¦å¯¹å¤–éƒ¨ç³»ç»Ÿè¿›è¡ŒUpdateæˆ–è€…INSERTæ“ä½œ DELETE MESSAGEï¼šè¿™ç§æ¶ˆæ¯è¡¨ç¤ºDELETEæ“ä½œã€‚ Upsertæµæ˜¯è¦æ±‚å¿…é¡»æŒ‡å®šPrimary Keyçš„ï¼Œå› ä¸ºUpsertæ“ä½œæ˜¯è¦æœ‰Keyçš„ï¼ŒUpsertæµé’ˆå¯¹UPDATEæ“ä½œç”¨ä¸€ä¸ªUPSERT MESSAGEå°±å¯ä»¥æè¿°ï¼Œæ‰€ä»¥æ•ˆç‡ä¼šæ›´é«˜ã€‚ ","link":"https://tianxiawuhao.github.io/tloS_nSAM/"},{"title":"ç¬¬ä¹ç«  çŠ¶æ€ç¼–ç¨‹å’Œå®¹é”™æœºåˆ¶","content":"æµå¼è®¡ç®—åˆ†ä¸ºæ— çŠ¶æ€å’Œæœ‰çŠ¶æ€ä¸¤ç§æƒ…å†µã€‚ æ— çŠ¶æ€çš„è®¡ç®—è§‚å¯Ÿæ¯ä¸ªç‹¬ç«‹äº‹ä»¶ï¼Œ å¹¶æ ¹æ®æœ€åä¸€ä¸ªäº‹ä»¶è¾“å‡ºç»“æœã€‚ ä¾‹å¦‚ï¼Œ æµå¤„ç†åº”ç”¨ç¨‹åºä»ä¼ æ„Ÿå™¨æ¥æ”¶æ¸©åº¦è¯»æ•°ï¼Œ å¹¶åœ¨ æ¸©åº¦è¶…è¿‡ 90 åº¦æ—¶å‘å‡ºè­¦å‘Šã€‚ æœ‰çŠ¶æ€çš„è®¡ç®—åˆ™ä¼šåŸºäºå¤šä¸ªäº‹ä»¶è¾“å‡ºç»“æœã€‚ ä»¥ä¸‹æ˜¯ä¸€äº› ä¾‹å­ã€‚ æ‰€æœ‰ç±»å‹çš„çª—å£ã€‚ ä¾‹å¦‚ï¼Œ è®¡ç®—è¿‡å»ä¸€å°æ—¶çš„å¹³å‡æ¸©åº¦ï¼Œ å°±æ˜¯æœ‰çŠ¶æ€çš„è®¡ç®—ã€‚ æ‰€æœ‰ç”¨äºå¤æ‚äº‹ä»¶å¤„ç†çš„çŠ¶æ€æœºã€‚ ä¾‹å¦‚ï¼Œ è‹¥åœ¨ä¸€åˆ†é’Ÿå†…æ”¶åˆ°ä¸¤ä¸ªç›¸å·® 20 åº¦ ä»¥ä¸Šçš„æ¸©åº¦è¯»æ•°ï¼Œ åˆ™å‘å‡ºè­¦å‘Šï¼Œ è¿™æ˜¯æœ‰çŠ¶æ€çš„è®¡ç®—ã€‚ æµä¸æµä¹‹é—´çš„æ‰€æœ‰å…³è”æ“ä½œï¼Œ ä»¥åŠæµä¸é™æ€è¡¨æˆ–åŠ¨æ€è¡¨ä¹‹é—´çš„å…³è”æ“ä½œï¼Œ éƒ½æ˜¯æœ‰çŠ¶æ€çš„è®¡ç®—ã€‚ ä¸‹å›¾å±•ç¤ºäº†æ— çŠ¶æ€æµå¤„ç†å’Œæœ‰çŠ¶æ€æµå¤„ç†çš„ä¸»è¦åŒºåˆ«ã€‚ æ— çŠ¶æ€æµå¤„ç†åˆ†åˆ«æ¥æ”¶æ¯æ¡æ•°æ®è®°å½•(å›¾ä¸­çš„é»‘æ¡)ï¼Œ ç„¶åæ ¹æ®æœ€æ–°è¾“å…¥çš„æ•°æ®ç”Ÿæˆè¾“å‡ºæ•°æ®(ç™½æ¡)ã€‚ æœ‰çŠ¶æ€ æµå¤„ç†ä¼šç»´æŠ¤çŠ¶æ€(æ ¹æ®æ¯æ¡è¾“å…¥è®°å½•è¿›è¡Œæ›´æ–°)ï¼Œ å¹¶åŸºäºæœ€æ–°è¾“å…¥çš„è®°å½•å’Œå½“å‰çš„ çŠ¶æ€å€¼ç”Ÿæˆè¾“å‡ºè®°å½•(ç°æ¡)ã€‚ å›¾ æ— çŠ¶æ€å’Œæœ‰çŠ¶æ€çš„æµå¤„ç† ä¸Šå›¾ä¸­è¾“å…¥æ•°æ®ç”±é»‘æ¡è¡¨ç¤ºã€‚ æ— çŠ¶æ€æµå¤„ç†æ¯æ¬¡åªè½¬æ¢ä¸€æ¡è¾“å…¥è®°å½•ï¼Œ å¹¶ä¸”ä»…æ ¹æ®æœ€æ–°çš„è¾“å…¥è®°å½•è¾“å‡ºç»“æœ(ç™½æ¡)ã€‚ æœ‰çŠ¶æ€ æµå¤„ç†ç»´æŠ¤æ‰€æœ‰å·²å¤„ç†è®°å½•çš„çŠ¶æ€ å€¼ï¼Œ å¹¶æ ¹æ®æ¯æ¡æ–°è¾“å…¥çš„è®°å½•æ›´æ–°çŠ¶æ€ï¼Œ å› æ­¤è¾“å‡ºè®°å½•(ç°æ¡)åæ˜ çš„æ˜¯ç»¼åˆè€ƒè™‘å¤š ä¸ªäº‹ä»¶ä¹‹åçš„ç»“æœã€‚ å°½ç®¡æ— çŠ¶æ€çš„è®¡ç®—å¾ˆé‡è¦ï¼Œ ä½†æ˜¯æµå¤„ç†å¯¹æœ‰çŠ¶æ€çš„è®¡ç®—æ›´æ„Ÿå…´è¶£ã€‚ äº‹å®ä¸Šï¼Œ æ­£ç¡®åœ°å®ç°æœ‰çŠ¶æ€çš„è®¡ç®—æ¯”å®ç°æ— çŠ¶æ€çš„è®¡ç®—éš¾å¾—å¤šã€‚ æ—§çš„æµå¤„ç†ç³»ç»Ÿå¹¶ä¸æ”¯æŒæœ‰çŠ¶ æ€çš„è®¡ç®—ï¼Œ è€Œæ–°ä¸€ä»£çš„æµå¤„ç†ç³»ç»Ÿåˆ™å°†çŠ¶æ€åŠå…¶æ­£ç¡®æ€§è§†ä¸ºé‡ä¸­ä¹‹é‡ã€‚ æœ‰çŠ¶æ€çš„ç®—å­å’Œåº”ç”¨ç¨‹åº Flink å†…ç½®çš„å¾ˆå¤šç®—å­ï¼Œ æ•°æ®æº sourceï¼Œ æ•°æ®å­˜å‚¨ sink éƒ½æ˜¯æœ‰çŠ¶æ€çš„ï¼Œ æµä¸­çš„æ•°æ®éƒ½æ˜¯ buffer recordsï¼Œ ä¼šä¿å­˜ä¸€å®šçš„å…ƒç´ æˆ–è€…å…ƒæ•°æ®ã€‚ ä¾‹å¦‚: ProcessWindowFunctionä¼šç¼“å­˜è¾“å…¥æµçš„æ•°æ®ï¼Œ ProcessFunction ä¼šä¿å­˜è®¾ç½®çš„å®šæ—¶å™¨ä¿¡æ¯ç­‰ç­‰ã€‚ åœ¨ Flink ä¸­ï¼Œ çŠ¶æ€å§‹ç»ˆä¸ç‰¹å®šç®—å­ç›¸å…³è”ã€‚ æ€»çš„æ¥è¯´ï¼Œ æœ‰ä¸¤ç§ç±»å‹çš„çŠ¶æ€ï¼š ç®—å­çŠ¶æ€ï¼ˆ operator stateï¼‰ é”®æ§çŠ¶æ€ï¼ˆ keyed stateï¼‰ ç®—å­çŠ¶æ€ï¼ˆoperator stateï¼‰ ç®—å­çŠ¶æ€çš„ä½œç”¨èŒƒå›´é™å®šä¸ºç®—å­ä»»åŠ¡ã€‚ è¿™æ„å‘³ç€ç”±åŒä¸€å¹¶è¡Œä»»åŠ¡æ‰€å¤„ç†çš„æ‰€æœ‰æ•°æ®éƒ½å¯ä»¥è®¿é—®åˆ°ç›¸åŒçš„çŠ¶æ€ï¼Œ çŠ¶æ€å¯¹äºåŒä¸€ä»»åŠ¡è€Œè¨€æ˜¯å…±äº«çš„ã€‚ ç®—å­çŠ¶æ€ä¸èƒ½ç”± ç›¸åŒæˆ–ä¸åŒç®—å­çš„å¦ä¸€ä¸ªä»»åŠ¡è®¿é—®ã€‚ å›¾ å…·æœ‰ç®—å­çŠ¶æ€çš„ä»»åŠ¡ Flink ä¸ºç®—å­çŠ¶æ€æä¾›ä¸‰ç§åŸºæœ¬æ•°æ®ç»“æ„ï¼š åˆ—è¡¨çŠ¶æ€ï¼ˆList stateï¼‰ å°†çŠ¶æ€è¡¨ç¤ºä¸ºä¸€ç»„æ•°æ®çš„åˆ—è¡¨ã€‚ è”åˆåˆ—è¡¨çŠ¶æ€ï¼ˆUnion list stateï¼‰ ä¹Ÿå°†çŠ¶æ€è¡¨ç¤ºä¸ºæ•°æ®çš„åˆ—è¡¨ã€‚ å®ƒä¸å¸¸è§„åˆ—è¡¨çŠ¶æ€çš„åŒºåˆ«åœ¨äºï¼Œ åœ¨å‘ç”Ÿæ•…éšœæ—¶ï¼Œ æˆ–è€…ä»ä¿ å­˜ç‚¹ï¼ˆsavepointï¼‰ å¯åŠ¨åº”ç”¨ç¨‹åºæ—¶å¦‚ä½•æ¢å¤ã€‚ å¹¿æ’­çŠ¶æ€ï¼ˆBroadcast stateï¼‰ å¦‚æœä¸€ä¸ªç®—å­æœ‰å¤šé¡¹ä»»åŠ¡ï¼Œ è€Œå®ƒçš„æ¯é¡¹ä»»åŠ¡çŠ¶æ€åˆéƒ½ç›¸åŒï¼Œ é‚£ä¹ˆè¿™ç§ç‰¹æ®Šæƒ…å†µæœ€é€‚åˆåº” ç”¨å¹¿æ’­çŠ¶æ€ã€‚ é”®æ§çŠ¶æ€ï¼ˆkeyed stateï¼‰ é”®æ§çŠ¶æ€æ˜¯æ ¹æ®è¾“å…¥æ•°æ®æµä¸­å®šä¹‰çš„é”®ï¼ˆkeyï¼‰ æ¥ç»´æŠ¤å’Œè®¿é—®çš„ã€‚ Flink ä¸ºæ¯ä¸ªé”®å€¼ç»´æŠ¤ä¸€ä¸ªçŠ¶æ€å®ä¾‹ï¼Œ å¹¶å°†å…·æœ‰ç›¸åŒé”®çš„æ‰€æœ‰æ•°æ®ï¼Œ éƒ½åˆ†åŒºåˆ°åŒä¸€ä¸ªç®—å­ä»»åŠ¡ä¸­ï¼Œ è¿™ä¸ªä»»åŠ¡ä¼šç»´æŠ¤å’Œå¤„ç†è¿™ä¸ª key å¯¹åº”çš„çŠ¶æ€ã€‚ å½“ä»»åŠ¡å¤„ç†ä¸€æ¡æ•°æ®æ—¶ï¼Œ å®ƒä¼šè‡ªåŠ¨å°†çŠ¶æ€çš„è®¿é—®èŒƒå›´é™å®šä¸ºå½“ å‰æ•°æ®çš„ keyã€‚ å› æ­¤ï¼Œ å…·æœ‰ç›¸åŒ key çš„æ‰€æœ‰æ•°æ®éƒ½ä¼šè®¿é—®ç›¸åŒçš„çŠ¶æ€ã€‚ Keyed State å¾ˆç±»ä¼¼äº ä¸€ä¸ªåˆ†å¸ƒå¼çš„ key-value map æ•°æ®ç»“æ„ï¼Œ åªèƒ½ç”¨äº KeyedStreamï¼ˆ keyBy ç®—å­å¤„ç†ä¹‹åï¼‰ ã€‚ å›¾ å…·æœ‰é”®æ§çŠ¶æ€çš„ä»»åŠ¡ Flink çš„ Keyed State æ”¯æŒä»¥ä¸‹æ•°æ®ç±»å‹ï¼š ValueState[T]ä¿å­˜å•ä¸ªçš„å€¼ï¼Œ å€¼çš„ç±»å‹ä¸º Tã€‚ 1.1 get æ“ä½œ: ValueState.value() 1.2 set æ“ä½œ: ValueState.update(value: T) ListState[T]ä¿å­˜ä¸€ä¸ªåˆ—è¡¨ï¼Œ åˆ—è¡¨é‡Œçš„å…ƒç´ çš„æ•°æ®ç±»å‹ä¸º Tã€‚ åŸºæœ¬æ“ä½œå¦‚ä¸‹ï¼š 2.1 ListState.add(value: T) 2.2 ListState.addAll(values: java.util.List[T]) 2.3 ListState.get()è¿”å› Iterable[T] 2.4 ListState.update(values: java.util.List[T]) MapState[K, V]ä¿å­˜ Key-Value å¯¹ã€‚ 3.1 MapState.get(key: K) 3.2 MapState.put(key: K, value: V) 3.3 MapState.contains(key: K) 3.4 MapState.remove(key: K) ReducingState[T] AggregatingState[I, O] State.clear()æ˜¯æ¸…ç©ºæ“ä½œã€‚ é€šè¿‡ RuntimeContext æ³¨å†Œ StateDescriptorã€‚ StateDescriptor ä»¥çŠ¶æ€ state çš„åå­—å’Œå­˜å‚¨çš„æ•°æ®ç±»å‹ä¸ºå‚æ•°ã€‚ åœ¨ open()æ–¹æ³•ä¸­åˆ›å»º state å˜é‡ã€‚ æ³¨æ„å¤ä¹ ä¹‹å‰çš„ RichFunction ç›¸å…³çŸ¥è¯†ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨äº† FlatMap with keyed ValueState çš„å¿«æ·æ–¹å¼ flatMapWithState å®ç°ä»¥ä¸Šéœ€æ±‚ã€‚ çŠ¶æ€ä¸€è‡´æ€§ å½“åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¼•å…¥çŠ¶æ€æ—¶ï¼Œ è‡ªç„¶ä¹Ÿå¼•å…¥äº†ä¸€è‡´æ€§é—®é¢˜ã€‚ ä¸€è‡´æ€§å®é™…ä¸Šæ˜¯\"æ­£ç¡®æ€§çº§åˆ«\"çš„å¦ä¸€ç§è¯´æ³•ï¼Œ ä¹Ÿå°±æ˜¯è¯´åœ¨æˆåŠŸå¤„ç†æ•…éšœå¹¶æ¢å¤ä¹‹åå¾—åˆ°çš„ç»“æœï¼Œ ä¸æ²¡ æœ‰å‘ç”Ÿä»»ä½•æ•…éšœæ—¶å¾—åˆ°çš„ç»“æœç›¸æ¯”ï¼Œ å‰è€…åˆ°åº•æœ‰å¤šæ­£ç¡®ï¼Ÿ ä¸¾ä¾‹æ¥è¯´ï¼Œ å‡è®¾è¦å¯¹æœ€è¿‘ ä¸€å°æ—¶ç™»å½•çš„ç”¨æˆ·è®¡æ•°ã€‚ åœ¨ç³»ç»Ÿç»å†æ•…éšœä¹‹åï¼Œ è®¡æ•°ç»“æœæ˜¯å¤šå°‘ï¼Ÿ å¦‚æœæœ‰åå·®ï¼Œ æ˜¯ æœ‰æ¼æ‰çš„è®¡æ•°è¿˜æ˜¯é‡å¤è®¡æ•°ï¼Ÿ ä¸€è‡´æ€§çº§åˆ« åœ¨æµå¤„ç†ä¸­ï¼Œ ä¸€è‡´æ€§å¯ä»¥åˆ†ä¸º 3 ä¸ªçº§åˆ«ï¼š at-most-once: è¿™å…¶å®æ˜¯æ²¡æœ‰æ­£ç¡®æ€§ä¿éšœçš„å§”å©‰è¯´æ³•â€”â€”æ•…éšœå‘ç”Ÿä¹‹åï¼Œ è®¡ æ•°ç»“æœå¯èƒ½ä¸¢å¤±ã€‚ åŒæ ·çš„è¿˜æœ‰ udpã€‚ at-least-once: è¿™è¡¨ç¤ºè®¡æ•°ç»“æœå¯èƒ½å¤§äºæ­£ç¡®å€¼ï¼Œ ä½†ç»ä¸ä¼šå°äºæ­£ç¡®å€¼ã€‚ ä¹Ÿ å°±æ˜¯è¯´ï¼Œ è®¡æ•°ç¨‹åºåœ¨å‘ç”Ÿæ•…éšœåå¯èƒ½å¤šç®—ï¼Œ ä½†æ˜¯ç»ä¸ä¼šå°‘ç®—ã€‚ exactly-once: è¿™æŒ‡çš„æ˜¯ç³»ç»Ÿä¿è¯åœ¨å‘ç”Ÿæ•…éšœåå¾—åˆ°çš„è®¡æ•°ç»“æœä¸æ­£ç¡®å€¼ä¸€ è‡´ã€‚ æ›¾ç»ï¼Œ at-least-once éå¸¸æµè¡Œã€‚ ç¬¬ä¸€ä»£æµå¤„ç†å™¨(å¦‚ Storm å’Œ Samza)åˆšé—®ä¸–æ—¶åªä¿è¯ at-least-onceï¼Œ åŸå› æœ‰äºŒã€‚ ä¿è¯ exactly-once çš„ç³»ç»Ÿå®ç°èµ·æ¥æ›´å¤æ‚ã€‚ è¿™åœ¨åŸºç¡€æ¶æ„å±‚(å†³å®šä»€ä¹ˆä»£è¡¨ æ­£ç¡®ï¼Œ ä»¥åŠ exactly-once çš„èŒƒå›´æ˜¯ä»€ä¹ˆ)å’Œå®ç°å±‚éƒ½å¾ˆæœ‰æŒ‘æˆ˜æ€§ã€‚ æµå¤„ç†ç³»ç»Ÿçš„æ—©æœŸç”¨æˆ·æ„¿æ„æ¥å—æ¡†æ¶çš„å±€é™æ€§ï¼Œ å¹¶åœ¨åº”ç”¨å±‚æƒ³åŠæ³•å¼¥è¡¥(ä¾‹ å¦‚ä½¿åº”ç”¨ç¨‹åºå…·æœ‰å¹‚ç­‰æ€§ï¼Œ æˆ–è€…ç”¨æ‰¹é‡è®¡ç®—å±‚å†åšä¸€éè®¡ç®—)ã€‚ æœ€å…ˆä¿è¯ exactly-once çš„ç³»ç»Ÿ(Storm Trident å’Œ Spark Streaming)åœ¨æ€§èƒ½å’Œè¡¨ç°åŠ› è¿™ä¸¤ä¸ªæ–¹é¢ä»˜å‡ºäº†å¾ˆå¤§çš„ä»£ä»·ã€‚ ä¸ºäº†ä¿è¯ exactly-onceï¼Œ è¿™äº›ç³»ç»Ÿæ— æ³•å•ç‹¬åœ°å¯¹æ¯æ¡ è®°å½•è¿ç”¨åº”ç”¨é€»è¾‘ï¼Œ è€Œæ˜¯åŒæ—¶å¤„ç†å¤šæ¡(ä¸€æ‰¹)è®°å½•ï¼Œ ä¿è¯å¯¹æ¯ä¸€æ‰¹çš„å¤„ç†è¦ä¹ˆå…¨éƒ¨ æˆåŠŸï¼Œ è¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚ è¿™å°±å¯¼è‡´åœ¨å¾—åˆ°ç»“æœå‰ï¼Œ å¿…é¡»ç­‰å¾…ä¸€æ‰¹è®°å½•å¤„ç†ç»“æŸã€‚ å› æ­¤ï¼Œ ç”¨æˆ·ç»å¸¸ä¸å¾—ä¸ä½¿ç”¨ä¸¤ä¸ªæµå¤„ç†æ¡†æ¶(ä¸€ä¸ªç”¨æ¥ä¿è¯ exactly-onceï¼Œ å¦ä¸€ä¸ªç”¨æ¥å¯¹æ¯ ä¸ªå…ƒç´ åšä½å»¶è¿Ÿå¤„ç†)ï¼Œ ç»“æœä½¿åŸºç¡€è®¾æ–½æ›´åŠ å¤æ‚ã€‚ æ›¾ç»ï¼Œ ç”¨æˆ·ä¸å¾—ä¸åœ¨ä¿è¯ exactly-once ä¸è·å¾—ä½å»¶è¿Ÿå’Œæ•ˆç‡ä¹‹é—´æƒè¡¡åˆ©å¼Šã€‚ Flink é¿å…äº†è¿™ç§æƒè¡¡ã€‚ Flink çš„ä¸€ä¸ªé‡å¤§ä»·å€¼åœ¨äºï¼Œ å®ƒæ—¢ä¿è¯äº† exactly-onceï¼Œ ä¹Ÿå…·æœ‰ä½å»¶è¿Ÿå’Œé«˜åå çš„å¤„ç†èƒ½åŠ›ã€‚ ä»æ ¹æœ¬ä¸Šè¯´ï¼Œ Flink é€šè¿‡ä½¿è‡ªèº«æ»¡è¶³æ‰€æœ‰éœ€æ±‚æ¥é¿å…æƒè¡¡ï¼Œ å®ƒæ˜¯ä¸šç•Œçš„ä¸€æ¬¡æ„ä¹‰ é‡å¤§çš„æŠ€æœ¯é£è·ƒã€‚ å°½ç®¡è¿™åœ¨å¤–è¡Œçœ‹æ¥å¾ˆç¥å¥‡ï¼Œ ä½†æ˜¯ä¸€æ—¦äº†è§£ï¼Œ å°±ä¼šæç„¶å¤§æ‚Ÿã€‚ ç«¯åˆ°ç«¯ï¼ˆend-to-endï¼‰ çŠ¶æ€ä¸€è‡´æ€§ ç›®å‰æˆ‘ä»¬çœ‹åˆ°çš„ä¸€è‡´æ€§ä¿è¯éƒ½æ˜¯ç”±æµå¤„ç†å™¨å®ç°çš„ï¼Œ ä¹Ÿå°±æ˜¯è¯´éƒ½æ˜¯åœ¨ Flink æµå¤„ç†å™¨å†…éƒ¨ä¿è¯çš„ï¼› è€Œåœ¨çœŸå®åº”ç”¨ä¸­ï¼Œ æµå¤„ç†åº”ç”¨é™¤äº†æµå¤„ç†å™¨ä»¥å¤–è¿˜åŒ…å«äº†æ•°æ® æºï¼ˆ ä¾‹å¦‚ Kafkaï¼‰ å’Œè¾“å‡ºåˆ°æŒä¹…åŒ–ç³»ç»Ÿã€‚ ç«¯åˆ°ç«¯çš„ä¸€è‡´æ€§ä¿è¯ï¼Œ æ„å‘³ç€ç»“æœçš„æ­£ç¡®æ€§è´¯ç©¿äº†æ•´ä¸ªæµå¤„ç†åº”ç”¨çš„å§‹ç»ˆï¼› æ¯ä¸€ä¸ªç»„ä»¶éƒ½ä¿è¯äº†å®ƒè‡ªå·±çš„ä¸€è‡´æ€§ï¼Œ æ•´ä¸ªç«¯åˆ°ç«¯çš„ä¸€è‡´æ€§çº§åˆ«å–å†³äºæ‰€æœ‰ç»„ä»¶ä¸­ä¸€ è‡´æ€§æœ€å¼±çš„ç»„ä»¶ã€‚ å…·ä½“å¯ä»¥åˆ’åˆ†å¦‚ä¸‹ï¼š å†…éƒ¨ä¿è¯ â€”â€” ä¾èµ– checkpoint source ç«¯ â€”â€” éœ€è¦å¤–éƒ¨æºå¯é‡è®¾æ•°æ®çš„è¯»å–ä½ç½® sink ç«¯ â€”â€” éœ€è¦ä¿è¯ä»æ•…éšœæ¢å¤æ—¶ï¼Œ æ•°æ®ä¸ä¼šé‡å¤å†™å…¥å¤–éƒ¨ç³»ç»Ÿ è€Œå¯¹äº sink ç«¯ï¼Œ åˆæœ‰ä¸¤ç§å…·ä½“çš„å®ç°æ–¹å¼ï¼š å¹‚ç­‰ï¼ˆ Idempotentï¼‰ å†™å…¥å’Œäº‹åŠ¡æ€§ ï¼ˆ Transactionalï¼‰ å†™å…¥ã€‚ å¹‚ç­‰å†™å…¥ æ‰€è°“å¹‚ç­‰æ“ä½œï¼Œ æ˜¯è¯´ä¸€ä¸ªæ“ä½œï¼Œ å¯ä»¥é‡å¤æ‰§è¡Œå¾ˆå¤šæ¬¡ï¼Œ ä½†åªå¯¼è‡´ä¸€æ¬¡ç»“æœæ›´æ”¹ï¼Œ ä¹Ÿå°±æ˜¯è¯´ï¼Œ åé¢å†é‡å¤æ‰§è¡Œå°±ä¸èµ·ä½œç”¨äº†ã€‚ äº‹åŠ¡å†™å…¥ éœ€è¦æ„å»ºäº‹åŠ¡æ¥å†™å…¥å¤–éƒ¨ç³»ç»Ÿï¼Œ æ„å»ºçš„äº‹åŠ¡å¯¹åº”ç€ checkpointï¼Œ ç­‰åˆ° checkpoint çœŸæ­£å®Œæˆçš„æ—¶å€™ï¼Œ æ‰æŠŠæ‰€æœ‰å¯¹åº”çš„ç»“æœå†™å…¥ sink ç³»ç»Ÿä¸­ã€‚ å¯¹äºäº‹åŠ¡æ€§å†™å…¥ï¼Œ å…·ä½“åˆæœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼š é¢„å†™æ—¥å¿—ï¼ˆ WALï¼‰ å’Œä¸¤é˜¶æ®µæäº¤ï¼ˆ 2PCï¼‰ ã€‚ DataStream API æä¾›äº† GenericWriteAheadSink æ¨¡æ¿ç±»å’Œ TwoPhaseCommitSinkFunction æ¥å£ï¼Œ å¯ä»¥æ–¹ä¾¿åœ°å®ç°è¿™ä¸¤ç§æ–¹å¼çš„äº‹åŠ¡æ€§å†™å…¥ã€‚ ä¸åŒ Source å’Œ Sink çš„ä¸€è‡´æ€§ä¿è¯å¯ä»¥ç”¨ä¸‹è¡¨è¯´æ˜ï¼š æ£€æŸ¥ç‚¹ï¼ˆcheckpointï¼‰ Flink å…·ä½“å¦‚ä½•ä¿è¯ exactly-once å‘¢? å®ƒä½¿ç”¨ä¸€ç§è¢«ç§°ä¸º\"æ£€æŸ¥ç‚¹\"ï¼ˆ checkpointï¼‰çš„ç‰¹æ€§ï¼Œ åœ¨å‡ºç°æ•…éšœæ—¶å°†ç³»ç»Ÿé‡ç½®å›æ­£ç¡®çŠ¶æ€ã€‚ ä¸‹é¢é€šè¿‡ç®€å•çš„ç±»æ¯”æ¥è§£é‡Šæ£€æŸ¥ç‚¹ çš„ä½œç”¨ã€‚ å‡è®¾ä½ å’Œä¸¤ä½æœ‹å‹æ­£åœ¨æ•°é¡¹é“¾ä¸Šæœ‰å¤šå°‘é¢—ç å­ï¼Œ å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ ä½ æä½ç å­ï¼Œ è¾¹æ•°è¾¹æ‹¨ï¼Œ æ¯æ‹¨è¿‡ä¸€é¢—ç å­å°±ç»™æ€»æ•°åŠ ä¸€ã€‚ ä½ çš„æœ‹å‹ä¹Ÿè¿™æ ·æ•°ä»–ä»¬æ‰‹ä¸­çš„ç å­ã€‚ å½“ä½  åˆ†ç¥å¿˜è®°æ•°åˆ°å“ªé‡Œæ—¶ï¼Œ æ€ä¹ˆåŠå‘¢? å¦‚æœé¡¹é“¾ä¸Šæœ‰å¾ˆå¤šç å­ï¼Œ ä½ æ˜¾ç„¶ä¸æƒ³ä»å¤´å†æ•°ä¸€ éï¼Œ å°¤å…¶æ˜¯å½“ä¸‰äººçš„é€Ÿåº¦ä¸ä¸€æ ·å´åˆè¯•å›¾åˆä½œçš„æ—¶å€™ï¼Œ æ›´æ˜¯å¦‚æ­¤(æ¯”å¦‚æƒ³è®°å½•å‰ä¸€åˆ† é’Ÿä¸‰äººä¸€å…±æ•°äº†å¤šå°‘é¢—ç å­ï¼Œ å›æƒ³ä¸€ä¸‹ä¸€åˆ†é’Ÿæ»šåŠ¨çª—å£)ã€‚ äºæ˜¯ï¼Œ ä½ æƒ³äº†ä¸€ä¸ªæ›´å¥½çš„åŠæ³•: åœ¨é¡¹é“¾ä¸Šæ¯éš”ä¸€æ®µå°±æ¾æ¾åœ°ç³»ä¸Šä¸€æ ¹æœ‰è‰²çš®ç­‹ï¼Œ å°†ç å­åˆ†éš”å¼€; å½“ç å­è¢«æ‹¨åŠ¨çš„æ—¶å€™ï¼Œ çš®ç­‹ä¹Ÿå¯ä»¥è¢«æ‹¨åŠ¨; ç„¶åï¼Œ ä½ å®‰æ’ä¸€ä¸ªåŠ©æ‰‹ï¼Œ è®©ä»–åœ¨ä½ å’Œæœ‹å‹æ‹¨åˆ°çš®ç­‹æ—¶è®°å½•æ€»æ•°ã€‚ ç”¨è¿™ç§æ–¹æ³•ï¼Œ å½“æœ‰äººæ•°é”™æ—¶ï¼Œ å°±ä¸å¿…ä»å¤´å¼€ å§‹æ•°ã€‚ ç›¸åï¼Œ ä½ å‘å…¶ä»–äººå‘å‡ºé”™è¯¯è­¦ç¤ºï¼Œ ç„¶åä½ ä»¬éƒ½ä»ä¸Šä¸€æ ¹çš®ç­‹å¤„å¼€å§‹é‡æ•°ï¼Œ åŠ© æ‰‹åˆ™ä¼šå‘Šè¯‰æ¯ä¸ªäººé‡æ•°æ—¶çš„èµ·å§‹æ•°å€¼ï¼Œ ä¾‹å¦‚åœ¨ç²‰è‰²çš®ç­‹å¤„çš„æ•°å€¼æ˜¯å¤šå°‘ã€‚ Flink æ£€æŸ¥ç‚¹çš„ä½œç”¨å°±ç±»ä¼¼äºçš®ç­‹æ ‡è®°ã€‚ æ•°ç å­è¿™ä¸ªç±»æ¯”çš„å…³é”®ç‚¹æ˜¯: å¯¹äºæŒ‡å®šçš„çš®ç­‹è€Œè¨€ï¼Œ ç å­çš„ç›¸å¯¹ä½ç½®æ˜¯ç¡®å®šçš„; è¿™è®©çš®ç­‹æˆä¸ºé‡æ–°è®¡æ•°çš„å‚è€ƒç‚¹ã€‚ æ€»çŠ¶æ€ (ç å­çš„æ€»æ•°)åœ¨æ¯é¢—ç å­è¢«æ‹¨åŠ¨ä¹‹åæ›´æ–°ä¸€æ¬¡ï¼Œ åŠ©æ‰‹åˆ™ä¼šä¿å­˜ä¸æ¯æ ¹çš®ç­‹å¯¹åº”çš„æ£€ æŸ¥ç‚¹çŠ¶æ€ï¼Œ å¦‚å½“é‡åˆ°ç²‰è‰²çš®ç­‹æ—¶ä¸€å…±æ•°äº†å¤šå°‘ç å­ï¼Œ å½“é‡åˆ°æ©™è‰²çš®ç­‹æ—¶åˆæ˜¯å¤šå°‘ã€‚ å½“é—®é¢˜å‡ºç°æ—¶ï¼Œ è¿™ç§æ–¹æ³•ä½¿å¾—é‡æ–°è®¡æ•°å˜å¾—ç®€å•ã€‚ Flink çš„æ£€æŸ¥ç‚¹ç®—æ³• Flink æ£€æŸ¥ç‚¹çš„æ ¸å¿ƒä½œç”¨æ˜¯ç¡®ä¿çŠ¶æ€æ­£ç¡®ï¼Œ å³ä½¿é‡åˆ°ç¨‹åºä¸­æ–­ï¼Œ ä¹Ÿè¦æ­£ç¡®ã€‚ è®°ä½è¿™ä¸€åŸºæœ¬ç‚¹ä¹‹åï¼Œ æˆ‘ä»¬ç”¨ä¸€ä¸ªä¾‹å­æ¥çœ‹æ£€æŸ¥ç‚¹æ˜¯å¦‚ä½•è¿è¡Œçš„ã€‚ Flink ä¸ºç”¨æˆ·æä¾›äº†ç”¨ æ¥å®šä¹‰çŠ¶æ€çš„å·¥å…·ã€‚ ä¾‹å¦‚ï¼Œ ä»¥ä¸‹è¿™ä¸ª Scala ç¨‹åºæŒ‰ç…§è¾“å…¥è®°å½•çš„ç¬¬ä¸€ä¸ªå­—æ®µ(ä¸€ä¸ªå­— ç¬¦ä¸²)è¿›è¡Œåˆ†ç»„å¹¶ç»´æŠ¤ç¬¬äºŒä¸ªå­—æ®µçš„è®¡æ•°çŠ¶æ€ã€‚ val stream: DataStream[(String, Int)] = ... val counts: DataStream[(String, Int)] = stream .keyBy(record =&gt; record._1) .mapWithState( (in: (String, Int), state: Option[Int]) =&gt; state match { case Some(c) =&gt; ( (in._1, c + in._2), Some(c + in._2) ) case None =&gt; ( (in._1, in._2), Some(in._2) ) }) è¯¥ç¨‹åºæœ‰ä¸¤ä¸ªç®—å­: keyBy ç®—å­ç”¨æ¥å°†è®°å½•æŒ‰ç…§ç¬¬ä¸€ä¸ªå…ƒç´ (ä¸€ä¸ªå­—ç¬¦ä¸²)è¿›è¡Œåˆ†ç»„ï¼Œ æ ¹æ®è¯¥ key å°†æ•°æ®è¿›è¡Œé‡æ–°åˆ†åŒºï¼Œ ç„¶åå°†è®°å½•å†å‘é€ç»™ä¸‹ä¸€ä¸ªç®—å­: æœ‰çŠ¶æ€çš„ map ç®—å­(mapWithState)ã€‚ map ç®—å­åœ¨æ¥æ”¶åˆ°æ¯ä¸ªå…ƒç´ åï¼Œ å°†è¾“å…¥è®°å½•çš„ç¬¬äºŒä¸ªå­—æ®µ çš„æ•°æ®åŠ åˆ°ç°æœ‰æ€»æ•°ä¸­ï¼Œ å†å°†æ›´æ–°è¿‡çš„å…ƒç´ å‘å°„å‡ºå»ã€‚ ä¸‹å›¾è¡¨ç¤ºç¨‹åºçš„åˆå§‹çŠ¶æ€: è¾“ å…¥æµä¸­çš„ 6 æ¡è®°å½•è¢«æ£€æŸ¥ç‚¹åˆ†å‰²çº¿(checkpoint barrier)éš”å¼€ï¼Œ æ‰€æœ‰çš„ map ç®—å­çŠ¶æ€å‡ ä¸º 0(è®¡æ•°è¿˜æœªå¼€å§‹)ã€‚ æ‰€æœ‰ key ä¸º a çš„è®°å½•å°†è¢«é¡¶å±‚çš„ map ç®—å­å¤„ç†ï¼Œ æ‰€æœ‰ key ä¸º b çš„è®°å½•å°†è¢«ä¸­é—´å±‚çš„ map ç®—å­å¤„ç†ï¼Œ æ‰€æœ‰ key ä¸º c çš„è®°å½•åˆ™å°†è¢«åº•å±‚çš„ map ç®—å­å¤„ ç†ã€‚ å›¾ æŒ‰ key ç´¯åŠ è®¡æ•°ç¨‹åºåˆå§‹çŠ¶æ€ ä¸Šå›¾æ˜¯ç¨‹åºçš„åˆå§‹çŠ¶æ€ã€‚ æ³¨æ„ï¼Œ aã€ bã€ c ä¸‰ç»„çš„åˆå§‹è®¡æ•°çŠ¶æ€éƒ½æ˜¯ 0ï¼Œ å³ä¸‰ä¸ªåœ†æŸ±ä¸Šçš„å€¼ã€‚ ckpt è¡¨ç¤ºæ£€æŸ¥ç‚¹åˆ†å‰²çº¿ï¼ˆ checkpoint barriersï¼‰ ã€‚ æ¯æ¡è®°å½•åœ¨å¤„ç†é¡ºåºä¸Šä¸¥æ ¼åœ°éµå®ˆåœ¨æ£€æŸ¥ç‚¹ä¹‹å‰æˆ–ä¹‹åçš„è§„å®šï¼Œ ä¾‹å¦‚[\"b\",2]åœ¨æ£€æŸ¥ç‚¹ä¹‹å‰è¢«å¤„ç†ï¼Œ [\"a\",2] åˆ™åœ¨æ£€æŸ¥ç‚¹ä¹‹åè¢«å¤„ç†ã€‚ å½“è¯¥ç¨‹åºå¤„ç†è¾“å…¥æµä¸­çš„ 6 æ¡è®°å½•æ—¶ï¼Œ æ¶‰åŠçš„æ“ä½œéå¸ƒ 3 ä¸ªå¹¶è¡Œå®ä¾‹(èŠ‚ç‚¹ã€ CPUå†…æ ¸ç­‰)ã€‚ é‚£ä¹ˆï¼Œ æ£€æŸ¥ç‚¹è¯¥å¦‚ä½•ä¿è¯ exactly-once å‘¢? æ£€æŸ¥ç‚¹åˆ†å‰²çº¿å’Œæ™®é€šæ•°æ®è®°å½•ç±»ä¼¼ã€‚ å®ƒä»¬ç”±ç®—å­å¤„ç†ï¼Œ ä½†å¹¶ä¸å‚ä¸è®¡ç®—ï¼Œ è€Œæ˜¯ä¼šè§¦å‘ä¸æ£€æŸ¥ç‚¹ç›¸å…³çš„è¡Œä¸ºã€‚ å½“è¯»å–è¾“å…¥æµçš„æ•°æ®æº(åœ¨æœ¬ä¾‹ä¸­ä¸ keyBy ç®—å­å†…è”) é‡åˆ°æ£€æŸ¥ç‚¹å±éšœæ—¶ï¼Œ å®ƒå°†å…¶åœ¨è¾“å…¥æµä¸­çš„ä½ç½®ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨ä¸­ã€‚ å¦‚æœè¾“å…¥æµæ¥ è‡ªæ¶ˆæ¯ä¼ è¾“ç³»ç»Ÿ(Kafka)ï¼Œ è¿™ä¸ªä½ç½®å°±æ˜¯åç§»é‡ã€‚ Flink çš„å­˜å‚¨æœºåˆ¶æ˜¯æ’ä»¶åŒ–çš„ï¼Œ æŒä¹… åŒ–å­˜å‚¨å¯ä»¥æ˜¯åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼Œ å¦‚ HDFSã€‚ ä¸‹å›¾å±•ç¤ºäº†è¿™ä¸ªè¿‡ç¨‹ã€‚ å›¾ é‡åˆ° checkpoint barrier æ—¶ï¼Œ ä¿å­˜å…¶åœ¨è¾“å…¥æµä¸­çš„ä½ç½® å½“ Flink æ•°æ®æº(åœ¨æœ¬ä¾‹ä¸­ä¸ keyBy ç®—å­å†…è”)é‡åˆ°æ£€æŸ¥ç‚¹åˆ†ç•Œçº¿ï¼ˆ barrierï¼‰ æ—¶ï¼Œå®ƒä¼šå°†å…¶åœ¨è¾“å…¥æµä¸­çš„ä½ç½®ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨ä¸­ã€‚ è¿™è®© Flink å¯ä»¥æ ¹æ®è¯¥ä½ç½®é‡å¯ã€‚æ£€æŸ¥ç‚¹åƒæ™®é€šæ•°æ®è®°å½•ä¸€æ ·åœ¨ç®—å­ä¹‹é—´æµåŠ¨ã€‚ å½“ map ç®—å­å¤„ç†å®Œå‰ 3 æ¡æ•°æ®å¹¶ æ”¶åˆ°æ£€æŸ¥ç‚¹åˆ†ç•Œçº¿æ—¶ï¼Œ å®ƒä»¬ä¼šå°†çŠ¶æ€ä»¥å¼‚æ­¥çš„æ–¹å¼å†™å…¥æŒä¹…åŒ–å­˜å‚¨ï¼Œ å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ å›¾ ä¿å­˜ map ç®—å­çŠ¶æ€ï¼Œ ä¹Ÿå°±æ˜¯å½“å‰å„ä¸ª key çš„è®¡æ•°å€¼ ä½äºæ£€æŸ¥ç‚¹ä¹‹å‰çš„æ‰€æœ‰è®°å½•([\"b\",2]ã€ [\"b\",3]å’Œ[\"c\",1])è¢« map ç®—å­å¤„ç†ä¹‹åçš„æƒ…å†µã€‚ æ­¤æ—¶ï¼Œ æŒä¹…åŒ–å­˜å‚¨å·²ç»å¤‡ä»½äº†æ£€æŸ¥ç‚¹åˆ†ç•Œçº¿åœ¨è¾“å…¥æµä¸­çš„ä½ç½®(å¤‡ä»½æ“ä½œå‘ç”Ÿåœ¨barrier è¢«è¾“å…¥ç®—å­å¤„ç†çš„æ—¶å€™)ã€‚ map ç®—å­æ¥ç€å¼€å§‹å¤„ç†æ£€æŸ¥ç‚¹åˆ†ç•Œçº¿ï¼Œ å¹¶è§¦å‘å°†çŠ¶ æ€å¼‚æ­¥å¤‡ä»½åˆ°ç¨³å®šå­˜å‚¨ä¸­è¿™ä¸ªåŠ¨ä½œã€‚ å½“ map ç®—å­çš„çŠ¶æ€å¤‡ä»½å’Œæ£€æŸ¥ç‚¹åˆ†ç•Œçº¿çš„ä½ç½®å¤‡ä»½è¢«ç¡®è®¤ä¹‹åï¼Œ è¯¥æ£€æŸ¥ç‚¹æ“ä½œå°±å¯ä»¥è¢«æ ‡è®°ä¸ºå®Œæˆï¼Œ å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ æˆ‘ä»¬åœ¨æ— é¡»åœæ­¢æˆ–è€…é˜»æ–­è®¡ç®—çš„æ¡ä»¶ä¸‹ï¼Œ åœ¨ä¸€ ä¸ªé€»è¾‘æ—¶é—´ç‚¹(å¯¹åº”æ£€æŸ¥ç‚¹å±éšœåœ¨è¾“å…¥æµä¸­çš„ä½ç½®)ä¸ºè®¡ç®—çŠ¶æ€æ‹äº†å¿«ç…§ã€‚ é€šè¿‡ç¡®ä¿ å¤‡ä»½çš„çŠ¶æ€å’Œä½ç½®æŒ‡å‘åŒä¸€ä¸ªé€»è¾‘æ—¶é—´ç‚¹ï¼Œ åæ–‡å°†è§£é‡Šå¦‚ä½•åŸºäºå¤‡ä»½æ¢å¤è®¡ç®—ï¼Œ ä» è€Œä¿è¯ exactly-onceã€‚ å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ å½“æ²¡æœ‰å‡ºç°æ•…éšœæ—¶ï¼Œ Flink æ£€æŸ¥ç‚¹çš„å¼€é”€æå°ï¼Œ æ£€æŸ¥ç‚¹æ“ä½œçš„é€Ÿåº¦ç”±æŒä¹…åŒ–å­˜å‚¨çš„å¯ç”¨å¸¦å®½å†³å®šã€‚ å›é¡¾æ•°ç å­çš„ä¾‹å­: é™¤äº†å› ä¸ºæ•° é”™è€Œéœ€è¦ç”¨åˆ°çš®ç­‹ä¹‹å¤–ï¼Œ çš®ç­‹ä¼šè¢«å¾ˆå¿«åœ°æ‹¨è¿‡ã€‚ å›¾ æ£€æŸ¥ç‚¹æ“ä½œå®Œæˆï¼Œ ç»§ç»­å¤„ç†æ•°æ® æ£€æŸ¥ç‚¹æ“ä½œå®Œæˆï¼Œ çŠ¶æ€å’Œä½ç½®å‡å·²å¤‡ä»½åˆ°ç¨³å®šå­˜å‚¨ä¸­ã€‚ è¾“å…¥æµä¸­çš„æ‰€æœ‰æ•°æ®è®°å½•éƒ½å·²å¤„ç†å®Œæˆã€‚ å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ å¤‡ä»½çš„çŠ¶æ€å€¼ä¸å®é™…çš„çŠ¶æ€å€¼æ˜¯ä¸åŒçš„ã€‚ å¤‡ä»½å æ˜ çš„æ˜¯æ£€æŸ¥ç‚¹çš„çŠ¶æ€ã€‚ å¦‚æœæ£€æŸ¥ç‚¹æ“ä½œå¤±è´¥ï¼Œ Flink å¯ä»¥ä¸¢å¼ƒè¯¥æ£€æŸ¥ç‚¹å¹¶ç»§ç»­æ­£å¸¸æ‰§è¡Œï¼Œ å› ä¸ºä¹‹åçš„æŸä¸€ä¸ªæ£€æŸ¥ç‚¹å¯èƒ½ä¼šæˆåŠŸã€‚ è™½ç„¶æ¢å¤æ—¶é—´å¯èƒ½æ›´é•¿ï¼Œ ä½†æ˜¯å¯¹äºçŠ¶æ€çš„ä¿è¯ä¾æ—§å¾ˆæœ‰åŠ›ã€‚ åªæœ‰åœ¨ä¸€ç³»åˆ—è¿ç»­çš„æ£€æŸ¥ç‚¹æ“ä½œå¤±è´¥ä¹‹åï¼Œ Flink æ‰ä¼šæŠ›å‡ºé”™è¯¯ï¼Œ å› ä¸ºè¿™é€šå¸¸é¢„ç¤ºç€ å‘ç”Ÿäº†ä¸¥é‡ä¸”æŒä¹…çš„é”™è¯¯ã€‚ ç°åœ¨æ¥çœ‹çœ‹ä¸‹å›¾æ‰€ç¤ºçš„æƒ…å†µ: æ£€æŸ¥ç‚¹æ“ä½œå·²ç»å®Œæˆï¼Œ ä½†æ•…éšœç´§éšå…¶åã€‚ å›¾ æ•…éšœç´§è·Ÿæ£€æŸ¥ç‚¹ï¼Œ å¯¼è‡´æœ€åº•éƒ¨çš„å®ä¾‹ä¸¢å¤± åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ Flink ä¼šé‡æ–°æ‹“æ‰‘(å¯èƒ½ä¼šè·å–æ–°çš„æ‰§è¡Œèµ„æº)ï¼Œ å°†è¾“å…¥æµå€’å›åˆ°ä¸Šä¸€ä¸ªæ£€æŸ¥ç‚¹ï¼Œ ç„¶åæ¢å¤çŠ¶æ€å€¼å¹¶ä»è¯¥å¤„å¼€å§‹ç»§ç»­è®¡ç®—ã€‚ åœ¨æœ¬ä¾‹ä¸­ï¼Œ [\"a\",2]ã€ [\"a\",2]å’Œ[\"c\",2]è¿™å‡ æ¡è®°å½•å°†è¢«é‡æ’­ã€‚ ä¸‹å›¾å±•ç¤ºäº†è¿™ä¸€é‡æ–°å¤„ç†è¿‡ç¨‹ã€‚ ä»ä¸Šä¸€ä¸ªæ£€æŸ¥ç‚¹å¼€å§‹é‡æ–°è®¡ç®—ï¼Œ å¯ä»¥ä¿è¯åœ¨å‰©ä¸‹çš„è®°å½•è¢«å¤„ç†ä¹‹åï¼Œ å¾—åˆ°çš„ map ç®—å­çš„çŠ¶æ€å€¼ä¸æ²¡æœ‰å‘ç”Ÿæ•…éšœæ—¶çš„çŠ¶æ€å€¼ä¸€è‡´ã€‚ å›¾ æ•…éšœæ—¶çš„çŠ¶æ€æ¢å¤ Flink å°†è¾“å…¥æµå€’å›åˆ°ä¸Šä¸€ä¸ªæ£€æŸ¥ç‚¹å±éšœçš„ä½ç½®ï¼Œ åŒæ—¶æ¢å¤ map ç®—å­çš„çŠ¶æ€å€¼ã€‚ç„¶åï¼Œ Flink ä»æ­¤å¤„å¼€å§‹é‡æ–°å¤„ç†ã€‚ è¿™æ ·åšä¿è¯äº†åœ¨è®°å½•è¢«å¤„ç†ä¹‹åï¼Œ map ç®—å­çš„çŠ¶ æ€å€¼ä¸æ²¡æœ‰å‘ç”Ÿæ•…éšœæ—¶çš„ä¸€è‡´ã€‚ Flink æ£€æŸ¥ç‚¹ç®—æ³•çš„æ­£å¼åç§°æ˜¯å¼‚æ­¥åˆ†ç•Œçº¿å¿«ç…§(asynchronous barrier snapshotting)ã€‚ è¯¥ç®—æ³•å¤§è‡´åŸºäº Chandy-Lamport åˆ†å¸ƒå¼å¿«ç…§ç®—æ³•ã€‚ æ£€æŸ¥ç‚¹æ˜¯ Flink æœ€æœ‰ä»·å€¼çš„åˆ›æ–°ä¹‹ä¸€ï¼Œ å› ä¸ºå®ƒä½¿ Flink å¯ä»¥ä¿è¯ exactly-onceï¼Œ å¹¶ä¸”ä¸éœ€è¦ç‰ºç‰²æ€§èƒ½ã€‚ Flink+Kafka å¦‚ä½•å®ç°ç«¯åˆ°ç«¯çš„ exactly-once è¯­ä¹‰ æˆ‘ä»¬çŸ¥é“ï¼Œ ç«¯åˆ°ç«¯çš„çŠ¶æ€ä¸€è‡´æ€§çš„å®ç°ï¼Œ éœ€è¦æ¯ä¸€ä¸ªç»„ä»¶éƒ½å®ç°ï¼Œ å¯¹äº Flink +Kafka çš„æ•°æ®ç®¡é“ç³»ç»Ÿï¼ˆ Kafka è¿›ã€ Kafka å‡ºï¼‰ è€Œè¨€ï¼Œ å„ç»„ä»¶æ€æ ·ä¿è¯ exactly-once è¯­ä¹‰å‘¢ï¼Ÿ å†…éƒ¨ â€”â€” åˆ©ç”¨ checkpoint æœºåˆ¶ï¼Œ æŠŠçŠ¶æ€å­˜ç›˜ï¼Œ å‘ç”Ÿæ•…éšœçš„æ—¶å€™å¯ä»¥æ¢å¤ï¼Œ ä¿è¯å†…éƒ¨çš„çŠ¶æ€ä¸€è‡´æ€§ source â€”â€” kafka consumer ä½œä¸º sourceï¼Œ å¯ä»¥å°†åç§»é‡ä¿å­˜ä¸‹æ¥ï¼Œ å¦‚æœå ç»­ä»»åŠ¡å‡ºç°äº†æ•…éšœï¼Œ æ¢å¤çš„æ—¶å€™å¯ä»¥ç”±è¿æ¥å™¨é‡ç½®åç§»é‡ï¼Œ é‡æ–°æ¶ˆè´¹æ•°æ®ï¼Œ ä¿è¯ä¸€è‡´æ€§ sink â€”â€” kafka producer ä½œä¸º sinkï¼Œ é‡‡ç”¨ä¸¤é˜¶æ®µæäº¤ sinkï¼Œ éœ€è¦å®ç°ä¸€ä¸ª TwoPhaseCommitSinkFunction å†…éƒ¨çš„ checkpoint æœºåˆ¶æˆ‘ä»¬å·²ç»æœ‰äº†äº†è§£ï¼Œ é‚£ source å’Œ sink å…·ä½“åˆæ˜¯æ€æ ·è¿è¡Œçš„å‘¢ï¼Ÿ æ¥ä¸‹æ¥æˆ‘ä»¬é€æ­¥åšä¸€ä¸ªåˆ†æã€‚ æˆ‘ä»¬çŸ¥é“ Flink ç”± JobManager åè°ƒå„ä¸ª TaskManager è¿›è¡Œ checkpoint å­˜å‚¨ï¼Œcheckpoint ä¿å­˜åœ¨ StateBackend ä¸­ï¼Œ é»˜è®¤ StateBackend æ˜¯å†…å­˜çº§çš„ï¼Œ ä¹Ÿå¯ä»¥æ”¹ä¸ºæ–‡ä»¶çº§çš„è¿›è¡ŒæŒä¹…åŒ–ä¿å­˜ã€‚ å½“ checkpoint å¯åŠ¨æ—¶ï¼Œ JobManager ä¼šå°†æ£€æŸ¥ç‚¹åˆ†ç•Œçº¿ï¼ˆ barrierï¼‰ æ³¨å…¥æ•°æ®æµï¼›barrier ä¼šåœ¨ç®—å­é—´ä¼ é€’ä¸‹å»ã€‚ æ¯ä¸ªç®—å­ä¼šå¯¹å½“å‰çš„çŠ¶æ€åšä¸ªå¿«ç…§ï¼Œ ä¿å­˜åˆ°çŠ¶æ€åç«¯ã€‚ å¯¹äº source ä»»åŠ¡è€Œè¨€ï¼Œå°±ä¼šæŠŠå½“å‰çš„ offset ä½œä¸ºçŠ¶æ€ä¿å­˜èµ·æ¥ã€‚ ä¸‹æ¬¡ä» checkpoint æ¢å¤æ—¶ï¼Œ source ä»»åŠ¡å¯ä»¥é‡æ–°æäº¤åç§»é‡ï¼Œ ä»ä¸Šæ¬¡ä¿å­˜çš„ä½ç½®å¼€å§‹é‡æ–°æ¶ˆè´¹æ•°æ®ã€‚ æ¯ä¸ªå†…éƒ¨çš„ transform ä»»åŠ¡é‡åˆ° barrier æ—¶ï¼Œ éƒ½ä¼šæŠŠçŠ¶æ€å­˜åˆ° checkpoint é‡Œã€‚sink ä»»åŠ¡é¦–å…ˆæŠŠæ•°æ®å†™å…¥å¤–éƒ¨ kafkaï¼Œ è¿™äº›æ•°æ®éƒ½å±äºé¢„æäº¤çš„äº‹åŠ¡ï¼ˆ è¿˜ä¸èƒ½ è¢«æ¶ˆè´¹ï¼‰ ï¼› å½“é‡åˆ° barrier æ—¶ï¼Œ æŠŠçŠ¶æ€ä¿å­˜åˆ°çŠ¶æ€åç«¯ï¼Œ å¹¶å¼€å¯æ–°çš„é¢„æäº¤äº‹åŠ¡ã€‚ å½“æ‰€æœ‰ç®—å­ä»»åŠ¡çš„å¿«ç…§å®Œæˆï¼Œ ä¹Ÿå°±æ˜¯è¿™æ¬¡çš„ checkpoint å®Œæˆæ—¶ï¼Œ JobManager ä¼š å‘æ‰€æœ‰ä»»åŠ¡å‘é€šçŸ¥ï¼Œ ç¡®è®¤è¿™æ¬¡ checkpoint å®Œæˆã€‚ å½“ sink ä»»åŠ¡æ”¶åˆ°ç¡®è®¤é€šçŸ¥ï¼Œ å°±ä¼šæ­£å¼æäº¤ä¹‹å‰çš„äº‹åŠ¡ï¼Œ kafka ä¸­æœªç¡®è®¤çš„æ•°æ®å°±æ”¹ä¸ºâ€œ å·²ç¡®è®¤â€ ï¼Œ æ•°æ®å°±çœŸæ­£å¯ä»¥è¢«æ¶ˆè´¹äº†ã€‚ æ‰€ä»¥æˆ‘ä»¬çœ‹åˆ°ï¼Œ æ‰§è¡Œè¿‡ç¨‹å®é™…ä¸Šæ˜¯ä¸€ä¸ªä¸¤æ®µå¼æäº¤ï¼Œ æ¯ä¸ªç®—å­æ‰§è¡Œå®Œæˆï¼Œ ä¼šè¿›è¡Œâ€œ é¢„æäº¤â€ ï¼Œ ç›´åˆ°æ‰§è¡Œå®Œ sink æ“ä½œï¼Œ ä¼šå‘èµ·â€œ ç¡®è®¤æäº¤â€ ï¼Œ å¦‚æœæ‰§è¡Œå¤±è´¥ï¼Œ é¢„æ äº¤ä¼šæ”¾å¼ƒæ‰ã€‚ å…·ä½“çš„ä¸¤é˜¶æ®µæäº¤æ­¥éª¤æ€»ç»“å¦‚ä¸‹ï¼š ç¬¬ä¸€æ¡æ•°æ®æ¥äº†ä¹‹åï¼Œ å¼€å¯ä¸€ä¸ª kafka çš„äº‹åŠ¡ï¼ˆ transactionï¼‰ ï¼Œ æ­£å¸¸å†™å…¥ kafka åˆ†åŒºæ—¥å¿—ä½†æ ‡è®°ä¸ºæœªæäº¤ï¼Œ è¿™å°±æ˜¯â€œ é¢„æäº¤â€ jobmanager è§¦å‘ checkpoint æ“ä½œï¼Œ barrier ä» source å¼€å§‹å‘ä¸‹ä¼ é€’ï¼Œ é‡åˆ° barrier çš„ç®—å­å°†çŠ¶æ€å­˜å…¥çŠ¶æ€åç«¯ï¼Œ å¹¶é€šçŸ¥ jobmanager sink è¿æ¥å™¨æ”¶åˆ° barrierï¼Œ ä¿å­˜å½“å‰çŠ¶æ€ï¼Œ å­˜å…¥ checkpointï¼Œ é€šçŸ¥ jobmanagerï¼Œ å¹¶å¼€å¯ä¸‹ä¸€é˜¶æ®µçš„äº‹åŠ¡ï¼Œ ç”¨äºæäº¤ä¸‹ä¸ªæ£€æŸ¥ç‚¹çš„æ•°æ® jobmanager æ”¶åˆ°æ‰€æœ‰ä»»åŠ¡çš„é€šçŸ¥ï¼Œ å‘å‡ºç¡®è®¤ä¿¡æ¯ï¼Œ è¡¨ç¤º checkpoint å®Œæˆ sink ä»»åŠ¡æ”¶åˆ° jobmanager çš„ç¡®è®¤ä¿¡æ¯ï¼Œ æ­£å¼æäº¤è¿™æ®µæ—¶é—´çš„æ•°æ® å¤–éƒ¨ kafka å…³é—­äº‹åŠ¡ï¼Œ æäº¤çš„æ•°æ®å¯ä»¥æ­£å¸¸æ¶ˆè´¹äº†ã€‚ æ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œ å¦‚æœå®•æœºéœ€è¦é€šè¿‡ StateBackend è¿›è¡Œæ¢å¤ï¼Œ åªèƒ½æ¢å¤æ‰€æœ‰ç¡®è®¤æäº¤çš„æ“ä½œã€‚ é€‰æ‹©ä¸€ä¸ªçŠ¶æ€åç«¯(state backend) MemoryStateBackend å†…å­˜çº§çš„çŠ¶æ€åç«¯ï¼Œ ä¼šå°†é”®æ§çŠ¶æ€ä½œä¸ºå†…å­˜ä¸­çš„å¯¹è±¡è¿›è¡Œç®¡ç†ï¼Œ å°†å®ƒä»¬å­˜å‚¨ åœ¨ TaskManager çš„ JVM å †ä¸Šï¼› è€Œå°† checkpoint å­˜å‚¨åœ¨ JobManager çš„å†…å­˜ä¸­ã€‚ FsStateBackend å°† checkpoint å­˜åˆ°è¿œç¨‹çš„æŒä¹…åŒ–æ–‡ä»¶ç³»ç»Ÿï¼ˆ FileSystemï¼‰ ä¸Šã€‚ è€Œå¯¹äºæœ¬åœ°çŠ¶æ€ï¼Œ è·Ÿ MemoryStateBackend ä¸€æ ·ï¼Œ ä¹Ÿä¼šå­˜åœ¨ TaskManager çš„ JVM å †ä¸Šã€‚ RocksDBStateBackend å°†æ‰€æœ‰çŠ¶æ€åºåˆ—åŒ–åï¼Œ å­˜å…¥æœ¬åœ°çš„ RocksDB ä¸­å­˜å‚¨ã€‚ æ³¨æ„ï¼š RocksDB çš„æ”¯æŒå¹¶ä¸ç›´æ¥åŒ…å«åœ¨ flink ä¸­ï¼Œ éœ€è¦å¼•å…¥ä¾èµ–ï¼š &lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-statebackend-rocksdb_2.12&lt;/artifactId&gt; &lt;version&gt;1.10.1&lt;/version&gt; &lt;/dependency&gt; è®¾ç½®çŠ¶æ€åç«¯ä¸º FsStateBackendï¼š val env = StreamExecutionEnvironment.getExecutionEnvironment val checkpointPath: String = ??? val backend = new RocksDBStateBackend(checkpointPath) env.setStateBackend(backend) env.setStateBackend(new FsStateBackend(&quot;file:///tmp/checkpoints&quot;)) env.enableCheckpointing(1000) // é…ç½®é‡å¯ç­–ç•¥ env.setRestartStrategy(RestartStrategies.fixedDelayRestart(60, Time.of(10, TimeUnit.SECONDS))) ","link":"https://tianxiawuhao.github.io/rxadb61B8/"},{"title":"ç¬¬å…«ç«  ProcessFunction APIï¼ˆåº•å±‚ APIï¼‰","content":"ä¹‹å‰æ‰€ä»‹ç»çš„æµå¤„ç† APIï¼Œæ— è®ºæ˜¯åŸºæœ¬çš„è½¬æ¢ã€èšåˆï¼Œè¿˜æ˜¯æ›´ä¸ºå¤æ‚çš„çª—å£æ“ä½œï¼Œå…¶å®éƒ½æ˜¯åŸºäº DataStream è¿›è¡Œè½¬æ¢çš„ï¼›æ‰€ä»¥å¯ä»¥ç»Ÿç§°ä¸º DataStream APIï¼Œè¿™ä¹Ÿæ˜¯ Flink ç¼–ç¨‹çš„æ ¸å¿ƒã€‚è€Œæˆ‘ä»¬çŸ¥é“ï¼Œä¸ºäº†è®©ä»£ç æœ‰æ›´å¼ºå¤§çš„è¡¨ç°åŠ›å’Œæ˜“ç”¨æ€§ï¼ŒFlink æœ¬èº«æä¾›äº†å¤šå±‚ APIï¼ŒDataStream API åªæ˜¯ä¸­é—´çš„ä¸€ç¯ åœ¨æ›´åº•å±‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¸å®šä¹‰ä»»ä½•å…·ä½“çš„ç®—å­ï¼ˆæ¯”å¦‚ mapï¼Œfilterï¼Œæˆ–è€… windowï¼‰ï¼Œè€Œåªæ˜¯æç‚¼å‡ºä¸€ä¸ªç»Ÿä¸€çš„â€œå¤„ç†â€ï¼ˆprocessï¼‰æ“ä½œâ€”â€”å®ƒæ˜¯æ‰€æœ‰è½¬æ¢ç®—å­çš„ä¸€ä¸ªæ¦‚æ‹¬æ€§çš„è¡¨è¾¾ï¼Œå¯ä»¥è‡ªå®šä¹‰å¤„ç†é€»è¾‘ï¼Œæ‰€ä»¥è¿™ä¸€å±‚æ¥å£å°±è¢«å«ä½œâ€œå¤„ç†å‡½æ•°â€ï¼ˆprocess functionï¼‰ã€‚ åœ¨å¤„ç†å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ç›´é¢çš„å°±æ˜¯æ•°æ®æµä¸­æœ€åŸºæœ¬çš„å…ƒç´ ï¼šæ•°æ®äº‹ä»¶ï¼ˆeventï¼‰ã€çŠ¶æ€ï¼ˆstateï¼‰ä»¥åŠæ—¶é—´ï¼ˆtimeï¼‰ã€‚è¿™å°±ç›¸å½“äºå¯¹æµæœ‰äº†å®Œå…¨çš„æ§åˆ¶æƒã€‚å¤„ç†å‡½æ•°æ¯”è¾ƒæŠ½è±¡ï¼Œæ²¡æœ‰å…·ä½“çš„æ“ä½œï¼Œæ‰€ä»¥å¯¹äºä¸€äº›å¸¸è§çš„ç®€å•åº”ç”¨ï¼ˆæ¯”å¦‚æ±‚å’Œã€å¼€çª—å£ï¼‰ä¼šæ˜¾å¾—æœ‰äº›éº»çƒ¦ï¼›ä¸è¿‡æ­£æ˜¯å› ä¸ºå®ƒä¸é™å®šå…·ä½“åšä»€ä¹ˆï¼Œæ‰€ä»¥ç†è®ºä¸Šæˆ‘ä»¬å¯ä»¥åšä»»ä½•äº‹æƒ…ï¼Œå®ç°æ‰€æœ‰éœ€æ±‚ã€‚æ‰€ä»¥å¯ä»¥è¯´ï¼Œå¤„ç†å‡½æ•°æ˜¯æˆ‘ä»¬è¿›è¡Œ Flink ç¼–ç¨‹çš„â€œå¤§æ‹›â€ï¼Œè½»æ˜“ä¸ç”¨ï¼Œä¸€æ—¦æ”¾å‡ºæ¥å¿…ç„¶ä¼šæ‰«å¹³ä¸€åˆ‡ã€‚ åŸºæœ¬å¤„ç†å‡½æ•°ï¼ˆProcessFunctionï¼‰ å¤„ç†å‡½æ•°ä¸»è¦æ˜¯å®šä¹‰æ•°æ®æµçš„è½¬æ¢æ“ä½œï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥æŠŠå®ƒå½’åˆ°è½¬æ¢ç®—å­ä¸­ã€‚æˆ‘ä»¬çŸ¥é“åœ¨Flink ä¸­å‡ ä¹æ‰€æœ‰è½¬æ¢ç®—å­éƒ½æä¾›äº†å¯¹åº”çš„å‡½æ•°ç±»æ¥å£ï¼Œå¤„ç†å‡½æ•°ä¹Ÿä¸ä¾‹å¤–ï¼›å®ƒæ‰€å¯¹åº”çš„å‡½æ•°ç±»ï¼Œå°±å«ä½œ ProcessFunctionã€‚ å¤„ç†å‡½æ•°çš„åŠŸèƒ½å’Œä½¿ç”¨ æˆ‘ä»¬ä¹‹å‰å­¦ä¹ çš„è½¬æ¢ç®—å­ï¼Œä¸€èˆ¬åªæ˜¯é’ˆå¯¹æŸç§å…·ä½“æ“ä½œæ¥å®šä¹‰çš„ï¼Œèƒ½å¤Ÿæ‹¿åˆ°çš„ä¿¡æ¯æ¯”è¾ƒæœ‰é™ã€‚æ¯”å¦‚ map ç®—å­ï¼Œæˆ‘ä»¬å®ç°çš„ MapFunction ä¸­ï¼Œåªèƒ½è·å–åˆ°å½“å‰çš„æ•°æ®ï¼Œå®šä¹‰å®ƒè½¬æ¢ä¹‹åçš„å½¢å¼ï¼›è€Œåƒçª—å£èšåˆè¿™æ ·çš„å¤æ‚æ“ä½œï¼ŒAggregateFunction ä¸­é™¤æ•°æ®å¤–ï¼Œè¿˜å¯ä»¥è·å–åˆ°å½“å‰çš„çŠ¶æ€ï¼ˆä»¥ç´¯åŠ å™¨ Accumulator å½¢å¼å‡ºç°ï¼‰ã€‚å¦å¤–æˆ‘ä»¬è¿˜ä»‹ç»è¿‡å¯Œå‡½æ•°ç±»ï¼Œæ¯”å¦‚ RichMapFunctionï¼Œå®ƒæä¾›äº†è·å–è¿è¡Œæ—¶ä¸Šä¸‹æ–‡çš„æ–¹æ³• getRuntimeContext()ï¼Œå¯ä»¥æ‹¿åˆ°çŠ¶æ€ï¼Œè¿˜æœ‰å¹¶è¡Œåº¦ã€ä»»åŠ¡åç§°ä¹‹ç±»çš„è¿è¡Œæ—¶ä¿¡æ¯ã€‚ ä½†æ˜¯æ— è®ºé‚£ç§ç®—å­ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦è®¿é—®äº‹ä»¶çš„æ—¶é—´æˆ³ï¼Œæˆ–è€…å½“å‰çš„æ°´ä½çº¿ä¿¡æ¯ï¼Œéƒ½æ˜¯å®Œå…¨åšä¸åˆ°çš„ã€‚åœ¨å®šä¹‰ç”Ÿæˆè§„åˆ™ä¹‹åï¼Œæ°´ä½çº¿ä¼šæºæºä¸æ–­åœ°äº§ç”Ÿï¼Œåƒæ•°æ®ä¸€æ ·åœ¨ä»»åŠ¡é—´æµåŠ¨ï¼Œå¯æˆ‘ä»¬å´ä¸èƒ½åƒæ•°æ®ä¸€æ ·å»å¤„ç†å®ƒï¼›è·Ÿæ—¶é—´ç›¸å…³çš„æ“ä½œï¼Œç›®å‰æˆ‘ä»¬åªä¼šç”¨çª—å£æ¥å¤„ç†ã€‚è€Œåœ¨å¾ˆå¤šåº”ç”¨éœ€æ±‚ä¸­ï¼Œè¦æ±‚æˆ‘ä»¬å¯¹æ—¶é—´æœ‰æ›´ç²¾ç»†çš„æ§åˆ¶ï¼Œéœ€è¦èƒ½å¤Ÿè·å–æ°´ä½çº¿ï¼Œç”šè‡³è¦â€œæŠŠæ§æ—¶é—´â€ã€å®šä¹‰ä»€ä¹ˆæ—¶å€™åšä»€ä¹ˆäº‹ï¼Œè¿™å°±ä¸æ˜¯åŸºæœ¬çš„æ—¶é—´çª—å£èƒ½å¤Ÿå®ç°çš„äº†ã€‚ äºæ˜¯å¿…é¡»ç¥­å‡ºå¤§æ‹›â€”â€”å¤„ç†å‡½æ•°ï¼ˆProcessFunctionï¼‰äº†ã€‚å¤„ç†å‡½æ•°æä¾›äº†ä¸€ä¸ªâ€œå®šæ—¶æœåŠ¡â€ï¼ˆTimerServiceï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒè®¿é—®æµä¸­çš„äº‹ä»¶ï¼ˆeventï¼‰ã€æ—¶é—´æˆ³ï¼ˆtimestampï¼‰ã€æ°´ä½çº¿ï¼ˆwatermarkï¼‰ï¼Œç”šè‡³å¯ä»¥æ³¨å†Œâ€œå®šæ—¶äº‹ä»¶â€ã€‚è€Œä¸”å¤„ç†å‡½æ•°ç»§æ‰¿äº† AbstractRichFunction æŠ½è±¡ç±»ï¼Œæ‰€ä»¥æ‹¥æœ‰å¯Œå‡½æ•°ç±»çš„æ‰€æœ‰ç‰¹æ€§ï¼ŒåŒæ ·å¯ä»¥è®¿é—®çŠ¶æ€ï¼ˆstateï¼‰å’Œå…¶ä»–è¿è¡Œæ—¶ä¿¡æ¯ã€‚æ­¤å¤–ï¼Œå¤„ç†å‡½æ•°è¿˜å¯ä»¥ç›´æ¥å°†æ•°æ®è¾“å‡ºåˆ°ä¾§è¾“å‡ºæµï¼ˆside outputï¼‰ä¸­ã€‚æ‰€ä»¥ï¼Œå¤„ç†å‡½æ•°æ˜¯æœ€ä¸ºçµæ´»çš„å¤„ç†æ–¹æ³•ï¼Œå¯ä»¥å®ç°å„ç§è‡ªå®šä¹‰çš„ä¸šåŠ¡é€»è¾‘ï¼›åŒæ—¶ä¹Ÿæ˜¯æ•´ä¸ª DataStream API çš„åº•å±‚åŸºç¡€ã€‚ stream.process(new MyProcessFunction()) è¿™é‡Œ ProcessFunction ä¸æ˜¯æ¥å£ï¼Œè€Œæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œç»§æ‰¿äº† AbstractRichFunctionï¼›MyProcessFunction æ˜¯å®ƒçš„ä¸€ä¸ªå…·ä½“å®ç°ã€‚æ‰€ä»¥æ‰€æœ‰çš„å¤„ç†å‡½æ•°ï¼Œéƒ½æ˜¯å¯Œå‡½æ•°ï¼ˆRichFunctionï¼‰ï¼Œå¯Œå‡½æ•°å¯ä»¥è°ƒç”¨çš„ä¸œè¥¿è¿™é‡ŒåŒæ ·éƒ½å¯ä»¥è°ƒç”¨ã€‚ import org.apache.flink.api.common.eventtime.SerializableTimestampAssigner; import org.apache.flink.api.common.eventtime.WatermarkStrategy; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.streaming.api.functions.ProcessFunction; import org.apache.flink.util.Collector; public class ProcessFunctionExample { public static void main(String[] args) throws Exception { StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); env.setParallelism(1); env.addSource(new ClickSource()) .assignTimestampsAndWatermarks( WatermarkStrategy.&lt;Event&gt;forMonotonousTimestamps().withTimestampAssigner(new SerializableTimestampAssigner&lt;Event&gt;() { @Override public long extractTimestamp(Event event, long l) { return event.timestamp; } }) ) .process(new ProcessFunction&lt;Event, String&gt;() { @Override public void processElement(Event value, Context ctx, Collector&lt;String&gt; out) throws Exception { if (value.user.equals(&quot;Mary&quot;)) { out.collect(value.user); } else if (value.user.equals(&quot;Bob&quot;)) { out.collect(value.user); out.collect(value.user); } System.out.println(ctx.timerService().currentWatermark()); } }) .print(); env.execute(); } } è¿™é‡Œæˆ‘ä»¬åœ¨ ProcessFunction ä¸­é‡å†™äº†.processElement()æ–¹æ³•ï¼Œè‡ªå®šä¹‰äº†ä¸€ç§å¤„ç†é€»è¾‘ï¼šå½“æ•°æ®çš„ user ä¸ºâ€œMaryâ€æ—¶ï¼Œå°†å…¶è¾“å‡ºä¸€æ¬¡ï¼›è€Œå¦‚æœä¸ºâ€œBobâ€æ—¶ï¼Œå°† user è¾“å‡ºä¸¤æ¬¡ã€‚è¿™é‡Œçš„è¾“ å‡º ï¼Œ æ˜¯ é€š è¿‡ è°ƒ ç”¨ out.collect() æ¥å®ç°çš„ã€‚å¦å¤–æˆ‘ä»¬è¿˜å¯ä»¥è°ƒç”¨ctx.timerService().currentWatermark() æ¥ è· å– å½“ å‰ çš„ æ°´ ä½ çº¿ æ‰“ å° è¾“ å‡º ã€‚ æ‰€ ä»¥ å¯ ä»¥ çœ‹ åˆ° ï¼ŒProcessFunction å‡½æ•°æœ‰ç‚¹åƒ FlatMapFunction çš„å‡çº§ç‰ˆã€‚å¯ä»¥å®ç° Mapã€Filterã€FlatMap çš„æ‰€æœ‰åŠŸèƒ½ã€‚å¾ˆæ˜æ˜¾ï¼Œå¤„ç†å‡½æ•°éå¸¸å¼ºå¤§ï¼Œèƒ½å¤Ÿåšå¾ˆå¤šä¹‹å‰åšä¸åˆ°çš„äº‹æƒ…ã€‚ ProcessFunction è§£æ åœ¨æºç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒæŠ½è±¡ç±» ProcessFunction ç»§æ‰¿äº† AbstractRichFunctionï¼Œæœ‰ä¸¤ä¸ªæ³›å‹ç±»å‹å‚æ•°ï¼šI è¡¨ç¤º Inputï¼Œä¹Ÿå°±æ˜¯è¾“å…¥çš„æ•°æ®ç±»å‹ï¼›O è¡¨ç¤º Outputï¼Œä¹Ÿå°±æ˜¯å¤„ç†å®Œæˆä¹‹åè¾“å‡ºçš„æ•°æ®ç±»å‹ã€‚ å†…éƒ¨å•ç‹¬å®šä¹‰äº†ä¸¤ä¸ªæ–¹æ³•ï¼šä¸€ä¸ªæ˜¯å¿…é¡»è¦å®ç°çš„æŠ½è±¡æ–¹æ³•.processElement()ï¼›å¦ä¸€ä¸ªæ˜¯éæŠ½è±¡æ–¹æ³•.onTimer()ã€‚ public abstract class ProcessFunction&lt;I, O&gt; extends AbstractRichFunction { ... public abstract void processElement(I value, Context ctx, Collector&lt;O&gt; out)throws Exception; public void onTimer(long timestamp, OnTimerContext ctx, Collector&lt;O&gt; out) throws Exception {} ... } æŠ½è±¡æ–¹æ³•.processElement() ç”¨äºâ€œå¤„ç†å…ƒç´ â€ï¼Œå®šä¹‰äº†å¤„ç†çš„æ ¸å¿ƒé€»è¾‘ã€‚è¿™ä¸ªæ–¹æ³•å¯¹äºæµä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½ä¼šè°ƒç”¨ä¸€æ¬¡ï¼Œå‚æ•°åŒ…æ‹¬ä¸‰ä¸ªï¼šè¾“å…¥æ•°æ®å€¼ valueï¼Œä¸Šä¸‹æ–‡ ctxï¼Œä»¥åŠâ€œæ”¶é›†å™¨â€ï¼ˆCollectorï¼‰outã€‚æ–¹æ³•æ²¡æœ‰è¿”å›å€¼ï¼Œå¤„ç†ä¹‹åçš„è¾“å‡ºæ•°æ®æ˜¯é€šè¿‡æ”¶é›†å™¨ out æ¥å®šä¹‰çš„ã€‚ valueï¼šå½“å‰æµä¸­çš„è¾“å…¥å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯æ­£åœ¨å¤„ç†çš„æ•°æ®ï¼Œç±»å‹ä¸æµä¸­æ•°æ®ç±»å‹ä¸€è‡´ã€‚ ctxï¼šç±»å‹æ˜¯ ProcessFunction ä¸­å®šä¹‰çš„å†…éƒ¨æŠ½è±¡ç±» Contextï¼Œè¡¨ç¤ºå½“å‰è¿è¡Œçš„ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥è·å–åˆ°å½“å‰çš„æ—¶é—´æˆ³ï¼Œå¹¶æä¾›äº†ç”¨äºæŸ¥è¯¢æ—¶é—´å’Œæ³¨å†Œå®šæ—¶å™¨çš„â€œå®šæ—¶æœåŠ¡â€(TimerService)ï¼Œä»¥åŠå¯ä»¥å°†æ•°æ®å‘é€åˆ°â€œä¾§è¾“å‡ºæµâ€ï¼ˆside outputï¼‰çš„æ–¹æ³•.output()ã€‚Context æŠ½è±¡ç±»å®šä¹‰å¦‚ä¸‹ï¼š public abstract class Context { public abstract Long timestamp(); public abstract TimerService timerService(); public abstract &lt;X&gt; void output(OutputTag&lt;X&gt; outputTag, X value); } outï¼šâ€œæ”¶é›†å™¨â€ï¼ˆç±»å‹ä¸º Collectorï¼‰ï¼Œç”¨äºè¿”å›è¾“å‡ºæ•°æ®ã€‚ä½¿ç”¨æ–¹å¼ä¸ flatMapç®—å­ä¸­çš„æ”¶é›†å™¨å®Œå…¨ä¸€æ ·ï¼Œç›´æ¥è°ƒç”¨ out.collect()æ–¹æ³•å°±å¯ä»¥å‘ä¸‹æ¸¸å‘å‡ºä¸€ä¸ªæ•°æ®ã€‚è¿™ä¸ªæ–¹æ³•å¯ä»¥å¤šæ¬¡è°ƒç”¨ï¼Œä¹Ÿå¯ä»¥ä¸è°ƒç”¨ã€‚ é€šè¿‡å‡ ä¸ªå‚æ•°çš„åˆ†æä¸éš¾å‘ç°ï¼ŒProcessFunction å¯ä»¥è½»æ¾å®ç° flatMap è¿™æ ·çš„åŸºæœ¬è½¬æ¢åŠŸèƒ½ï¼ˆå½“ç„¶ mapã€filter æ›´ä¸åœ¨è¯ä¸‹ï¼‰ï¼›è€Œé€šè¿‡å¯Œå‡½æ•°æä¾›çš„è·å–ä¸Šä¸‹æ–‡æ–¹æ³•.getRuntimeContext()ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰çŠ¶æ€ï¼ˆstateï¼‰è¿›è¡Œå¤„ç†ï¼Œè¿™ä¹Ÿå°±èƒ½å®ç°èšåˆæ“ä½œçš„åŠŸèƒ½äº†ã€‚ éæŠ½è±¡æ–¹æ³•.onTimer() ç”¨äºå®šä¹‰å®šæ—¶è§¦å‘çš„æ“ä½œï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å¼ºå¤§ã€ä¹Ÿéå¸¸æœ‰è¶£çš„åŠŸèƒ½ã€‚è¿™ä¸ªæ–¹æ³•åªæœ‰åœ¨æ³¨å†Œå¥½çš„å®šæ—¶å™¨è§¦å‘çš„æ—¶å€™æ‰ä¼šè°ƒç”¨ï¼Œè€Œå®šæ—¶å™¨æ˜¯é€šè¿‡â€œå®šæ—¶æœåŠ¡â€TimerService æ¥æ³¨å†Œçš„ã€‚æ‰“ä¸ªæ¯”æ–¹ï¼Œæ³¨å†Œå®šæ—¶å™¨ï¼ˆtimerï¼‰å°±æ˜¯è®¾äº†ä¸€ä¸ªé—¹é’Ÿï¼Œåˆ°äº†è®¾å®šæ—¶é—´å°±ä¼šå“ï¼›è€Œ.onTimer()ä¸­å®šä¹‰çš„ï¼Œå°±æ˜¯é—¹é’Ÿå“çš„æ—¶å€™è¦åšçš„äº‹ã€‚æ‰€ä»¥å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªåŸºäºæ—¶é—´çš„â€œå›è°ƒâ€ï¼ˆcallbackï¼‰æ–¹æ³•ï¼Œé€šè¿‡æ—¶é—´çš„è¿›å±•æ¥è§¦å‘ï¼›åœ¨äº‹ä»¶æ—¶é—´è¯­ä¹‰ä¸‹å°±æ˜¯ç”±æ°´ä½çº¿ï¼ˆwatermarkï¼‰æ¥è§¦å‘äº†ã€‚ ä¸.processElement()ç±»ä¼¼ï¼Œå®šæ—¶æ–¹æ³•.onTimer()ä¹Ÿæœ‰ä¸‰ä¸ªå‚æ•°ï¼šæ—¶é—´æˆ³ï¼ˆtimestampï¼‰ï¼Œä¸Šä¸‹æ–‡ï¼ˆctxï¼‰ï¼Œä»¥åŠæ”¶é›†å™¨ï¼ˆoutï¼‰ã€‚è¿™é‡Œçš„ timestamp æ˜¯æŒ‡è®¾å®šå¥½çš„è§¦å‘æ—¶é—´ï¼Œäº‹ä»¶æ—¶é—´è¯­ä¹‰ä¸‹å½“ç„¶å°±æ˜¯æ°´ä½çº¿äº†ã€‚å¦å¤–è¿™é‡ŒåŒæ ·æœ‰ä¸Šä¸‹æ–‡å’Œæ”¶é›†å™¨ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥è°ƒç”¨å®šæ—¶æœåŠ¡ï¼ˆTimerServiceï¼‰ï¼Œä»¥åŠä»»æ„è¾“å‡ºå¤„ç†ä¹‹åçš„æ•°æ®ã€‚ æ—¢ç„¶æœ‰.onTimer()æ–¹æ³•åšå®šæ—¶è§¦å‘ï¼Œæˆ‘ä»¬ç”¨ ProcessFunction ä¹Ÿå¯ä»¥è‡ªå®šä¹‰æ•°æ®æŒ‰ç…§æ—¶é—´åˆ†ç»„ã€å®šæ—¶è§¦å‘è®¡ç®—è¾“å‡ºç»“æœï¼›è¿™å…¶å®å°±å®ç°äº†çª—å£ï¼ˆwindowï¼‰çš„åŠŸèƒ½ã€‚æ‰€ä»¥è¯´ ProcessFunctionæ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„ç»ˆæå¥¥ä¹‰ï¼Œç”¨å®ƒå¯ä»¥å®ç°ä¸€åˆ‡åŠŸèƒ½ã€‚ æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œå¤„ç†å‡½æ•°éƒ½æ˜¯åŸºäºäº‹ä»¶è§¦å‘çš„ã€‚æ°´ä½çº¿å°±å¦‚åŒæ’å…¥æµä¸­çš„ä¸€æ¡æ•°æ®ä¸€æ ·ï¼›åªä¸è¿‡å¤„ç†çœŸæ­£çš„æ•°æ®äº‹ä»¶è°ƒç”¨çš„æ˜¯.processElement()æ–¹æ³•ï¼Œè€Œå¤„ç†æ°´ä½çº¿äº‹ä»¶è°ƒç”¨çš„æ˜¯.onTimer()ã€‚ è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸Šé¢çš„.onTimer()æ–¹æ³•åªæ˜¯å®šæ—¶å™¨è§¦å‘æ—¶çš„æ“ä½œï¼Œè€Œå®šæ—¶å™¨ï¼ˆtimerï¼‰çœŸæ­£çš„è®¾ç½®éœ€è¦ç”¨åˆ°ä¸Šä¸‹æ–‡ ctx ä¸­çš„å®šæ—¶æœåŠ¡ã€‚åœ¨ Flink ä¸­ï¼Œåªæœ‰â€œæŒ‰é”®åˆ†åŒºæµâ€KeyedStreamæ‰æ”¯æŒè®¾ç½®å®šæ—¶å™¨çš„æ“ä½œï¼Œæ‰€ä»¥ä¹‹å‰çš„ä»£ç ä¸­æˆ‘ä»¬å¹¶æ²¡æœ‰ä½¿ç”¨å®šæ—¶å™¨ã€‚æ‰€ä»¥åŸºäºä¸åŒç±»å‹çš„æµï¼Œå¯ä»¥ä½¿ç”¨ä¸åŒçš„å¤„ç†å‡½æ•°ï¼Œå®ƒä»¬ä¹‹é—´è¿˜æ˜¯æœ‰ä¸€äº›å¾®å°çš„åŒºåˆ«çš„ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±ä»‹ç»ä¸€ä¸‹å¤„ç†å‡½æ•°çš„åˆ†ç±»ã€‚ å¤„ç†å‡½æ•°çš„åˆ†ç±» Flink ä¸­çš„å¤„ç†å‡½æ•°å…¶å®æ˜¯ä¸€ä¸ªå¤§å®¶æ—ï¼ŒProcessFunction åªæ˜¯å…¶ä¸­ä¸€å‘˜ã€‚ æˆ‘ä»¬çŸ¥é“ï¼ŒDataStream åœ¨è°ƒç”¨ä¸€äº›è½¬æ¢æ–¹æ³•ä¹‹åï¼Œæœ‰å¯èƒ½ç”Ÿæˆæ–°çš„æµç±»å‹ï¼›ä¾‹å¦‚è°ƒç”¨.keyBy()ä¹‹åå¾—åˆ° KeyedStreamï¼Œè¿›è€Œå†è°ƒç”¨.window()ä¹‹åå¾—åˆ° WindowedStreamã€‚å¯¹äºä¸åŒç±»å‹çš„æµï¼Œå…¶å®éƒ½å¯ä»¥ç›´æ¥è°ƒç”¨.process()æ–¹æ³•è¿›è¡Œè‡ªå®šä¹‰å¤„ç†ï¼Œè¿™æ—¶ä¼ å…¥çš„å‚æ•°å°±éƒ½å«ä½œå¤„ç†å‡½æ•°ã€‚å½“ç„¶ï¼Œå®ƒä»¬å°½ç®¡æœ¬è´¨ç›¸åŒï¼Œéƒ½æ˜¯å¯ä»¥è®¿é—®çŠ¶æ€å’Œæ—¶é—´ä¿¡æ¯çš„åº•å±‚ APIï¼Œå¯å½¼æ­¤ä¹‹é—´ä¹Ÿä¼šæœ‰æ‰€å·®å¼‚ã€‚ Flink æä¾›äº† 8 ä¸ªä¸åŒçš„å¤„ç†å‡½æ•°ï¼š ï¼ˆ1ï¼‰ProcessFunction æœ€åŸºæœ¬çš„å¤„ç†å‡½æ•°ï¼ŒåŸºäº DataStream ç›´æ¥è°ƒç”¨.process()æ—¶ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚ ï¼ˆ2ï¼‰KeyedProcessFunction å¯¹æµæŒ‰é”®åˆ†åŒºåçš„å¤„ç†å‡½æ•°ï¼ŒåŸºäº KeyedStream è°ƒç”¨.process()æ—¶ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚è¦æƒ³ä½¿ç”¨å®šæ—¶å™¨ï¼Œæ¯”å¦‚åŸºäº KeyedStreamã€‚ ï¼ˆ3ï¼‰ProcessWindowFunction å¼€çª—ä¹‹åçš„å¤„ç†å‡½æ•°ï¼Œä¹Ÿæ˜¯å…¨çª—å£å‡½æ•°çš„ä»£è¡¨ã€‚åŸºäº WindowedStream è°ƒç”¨.process()æ—¶ä½œ ä¸ºå‚æ•°ä¼ å…¥ã€‚ ï¼ˆ4ï¼‰ProcessAllWindowFunction åŒæ ·æ˜¯å¼€çª—ä¹‹åçš„å¤„ç†å‡½æ•°ï¼ŒåŸºäº AllWindowedStream è°ƒç”¨.process()æ—¶ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚ ï¼ˆ5ï¼‰CoProcessFunction åˆå¹¶ï¼ˆconnectï¼‰ä¸¤æ¡æµä¹‹åçš„å¤„ç†å‡½æ•°ï¼ŒåŸºäº ConnectedStreams è°ƒç”¨.process()æ—¶ä½œä¸ºå‚ æ•°ä¼ å…¥ã€‚å…³äºæµçš„è¿æ¥åˆå¹¶æ“ä½œ ï¼ˆ6ï¼‰ProcessJoinFunction é—´éš”è¿æ¥ï¼ˆinterval joinï¼‰ä¸¤æ¡æµä¹‹åçš„å¤„ç†å‡½æ•°ï¼ŒåŸºäº IntervalJoined è°ƒç”¨.process()æ—¶ä½œä¸º å‚æ•°ä¼ å…¥ã€‚ ï¼ˆ7ï¼‰BroadcastProcessFunction å¹¿æ’­è¿æ¥æµå¤„ç†å‡½æ•°ï¼ŒåŸºäº BroadcastConnectedStream è°ƒç”¨.process()æ—¶ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚è¿™é‡Œçš„â€œå¹¿æ’­è¿æ¥æµâ€BroadcastConnectedStreamï¼Œæ˜¯ä¸€ä¸ªæœª keyBy çš„æ™®é€š DataStream ä¸ä¸€ä¸ªå¹¿æ’­æµï¼ˆBroadcastStreamï¼‰åšè¿æ¥ï¼ˆconncetï¼‰ä¹‹åçš„äº§ç‰©ã€‚ ï¼ˆ8ï¼‰KeyedBroadcastProcessFunction æŒ‰é”®åˆ†åŒºçš„å¹¿æ’­è¿æ¥æµå¤„ç†å‡½æ•°ï¼ŒåŒæ ·æ˜¯åŸºäº BroadcastConnectedStream è°ƒç”¨.process()æ—¶ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚ä¸ BroadcastProcessFunction ä¸åŒçš„æ˜¯ï¼Œè¿™æ—¶çš„å¹¿æ’­è¿æ¥æµï¼Œæ˜¯ä¸€ä¸ª KeyedStreamä¸å¹¿æ’­æµï¼ˆBroadcastStreamï¼‰åšè¿æ¥ä¹‹åçš„äº§ç‰©ã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯¹ KeyedProcessFunction å’Œ ProcessWindowFunction çš„å…·ä½“ç”¨æ³•å±•å¼€è¯¦ç»†è¯´æ˜ã€‚ æŒ‰é”®åˆ†åŒºå¤„ç†å‡½æ•°ï¼ˆKeyedProcessFunctionï¼‰ åœ¨ Flink ç¨‹åºä¸­ï¼Œä¸ºäº†å®ç°æ•°æ®çš„èšåˆç»Ÿè®¡ï¼Œæˆ–è€…å¼€çª—è®¡ç®—ä¹‹ç±»çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½è¦å…ˆç”¨ keyBy ç®—å­å¯¹æ•°æ®æµè¿›è¡Œâ€œæŒ‰é”®åˆ†åŒºâ€ï¼Œå¾—åˆ°ä¸€ä¸ª KeyedStreamã€‚ä¹Ÿå°±æ˜¯æŒ‡å®šä¸€ä¸ªé”®ï¼ˆkeyï¼‰ï¼ŒæŒ‰ç…§å®ƒçš„å“ˆå¸Œå€¼ï¼ˆhash codeï¼‰å°†æ•°æ®åˆ†æˆä¸åŒçš„â€œç»„â€ï¼Œç„¶ååˆ†é…åˆ°ä¸åŒçš„å¹¶è¡Œå­ä»»åŠ¡ä¸Šæ‰§è¡Œè®¡ç®—ï¼›è¿™ç›¸å½“äºåšäº†ä¸€ä¸ªé€»è¾‘åˆ†æµçš„æ“ä½œï¼Œä»è€Œå¯ä»¥å……åˆ†åˆ©ç”¨å¹¶è¡Œè®¡ç®—çš„ä¼˜åŠ¿å®æ—¶å¤„ç†æµ·é‡æ•°æ®ã€‚ å¦å¤–æˆ‘ä»¬åœ¨ä¸ŠèŠ‚ä¸­ä¹Ÿæåˆ°ï¼Œåªæœ‰åœ¨ KeyedStream ä¸­æ‰æ”¯æŒä½¿ç”¨ TimerService è®¾ç½®å®šæ—¶å™¨çš„æ“ä½œã€‚æ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½æ˜¯å…ˆåšäº† keyBy åˆ†åŒºä¹‹åï¼Œå†å»å®šä¹‰å¤„ç†æ“ä½œï¼›ä»£ç ä¸­æ›´åŠ å¸¸è§çš„å¤„ç†å‡½æ•°æ˜¯ KeyedProcessFunctionï¼Œæœ€åŸºæœ¬çš„ ProcessFunction åè€Œå‡ºé•œç‡æ²¡é‚£ä¹ˆé«˜ã€‚ å®šæ—¶å™¨ï¼ˆTimerï¼‰å’Œå®šæ—¶æœåŠ¡ï¼ˆTimerServiceï¼‰ KeyedProcessFunction çš„ä¸€ä¸ªç‰¹è‰²ï¼Œå°±æ˜¯å¯ä»¥çµæ´»åœ°ä½¿ç”¨å®šæ—¶å™¨ã€‚ å®šæ—¶å™¨ï¼ˆtimersï¼‰æ˜¯å¤„ç†å‡½æ•°ä¸­è¿›è¡Œæ—¶é—´ç›¸å…³æ“ä½œçš„ä¸»è¦æœºåˆ¶ã€‚åœ¨.onTimer()æ–¹æ³•ä¸­å¯ä»¥å®ç°å®šæ—¶å¤„ç†çš„é€»è¾‘ï¼Œè€Œå®ƒèƒ½è§¦å‘çš„å‰æï¼Œå°±æ˜¯ä¹‹å‰æ›¾ç»æ³¨å†Œè¿‡å®šæ—¶å™¨ã€å¹¶ä¸”ç°åœ¨å·²ç»åˆ°äº†è§¦å‘æ—¶é—´ã€‚æ³¨å†Œå®šæ—¶å™¨çš„åŠŸèƒ½ï¼Œæ˜¯é€šè¿‡ä¸Šä¸‹æ–‡ä¸­æä¾›çš„â€œå®šæ—¶æœåŠ¡â€ï¼ˆTimerServiceï¼‰æ¥å®ç°çš„ã€‚ å®šæ—¶æœåŠ¡ä¸å½“å‰è¿è¡Œçš„ç¯å¢ƒæœ‰å…³ã€‚å‰é¢å·²ç»ä»‹ç»è¿‡ï¼ŒProcessFunction çš„ä¸Šä¸‹æ–‡ï¼ˆContextï¼‰ä¸­æä¾›äº†.timerService()æ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥è¿”å›ä¸€ä¸ª TimerService å¯¹è±¡ï¼š public abstract TimerService timerService(); //TimerService æ˜¯ Flink å…³äºæ—¶é—´å’Œå®šæ—¶å™¨çš„åŸºç¡€æœåŠ¡æ¥å£ï¼ŒåŒ…å«ä»¥ä¸‹å…­ä¸ªæ–¹æ³•ï¼š // è·å–å½“å‰çš„å¤„ç†æ—¶é—´ long currentProcessingTime(); // è·å–å½“å‰çš„æ°´ä½çº¿ï¼ˆäº‹ä»¶æ—¶é—´ï¼‰ long currentWatermark(); // æ³¨å†Œå¤„ç†æ—¶é—´å®šæ—¶å™¨ï¼Œå½“å¤„ç†æ—¶é—´è¶…è¿‡ time æ—¶è§¦å‘ void registerProcessingTimeTimer(long time); // æ³¨å†Œäº‹ä»¶æ—¶é—´å®šæ—¶å™¨ï¼Œå½“æ°´ä½çº¿è¶…è¿‡ time æ—¶è§¦å‘ void registerEventTimeTimer(long time); // åˆ é™¤è§¦å‘æ—¶é—´ä¸º time çš„å¤„ç†æ—¶é—´å®šæ—¶å™¨ void deleteProcessingTimeTimer(long time); // åˆ é™¤è§¦å‘æ—¶é—´ä¸º time çš„å¤„ç†æ—¶é—´å®šæ—¶å™¨ void deleteEventTimeTimer(long time); å…­ä¸ªæ–¹æ³•å¯ä»¥åˆ†æˆä¸¤å¤§ç±»ï¼šåŸºäºå¤„ç†æ—¶é—´å’ŒåŸºäºäº‹ä»¶æ—¶é—´ã€‚è€Œå¯¹åº”çš„æ“ä½œä¸»è¦æœ‰ä¸‰ä¸ªï¼šè·å–å½“å‰æ—¶é—´ï¼Œæ³¨å†Œå®šæ—¶å™¨ï¼Œä»¥åŠåˆ é™¤å®šæ—¶å™¨ã€‚éœ€è¦æ³¨æ„ï¼Œå°½ç®¡å¤„ç†å‡½æ•°ä¸­éƒ½å¯ä»¥ç›´æ¥è®¿é—®TimerServiceï¼Œä¸è¿‡åªæœ‰åŸºäº KeyedStream çš„å¤„ç†å‡½æ•°ï¼Œæ‰èƒ½å»è°ƒç”¨æ³¨å†Œå’Œåˆ é™¤å®šæ—¶å™¨çš„æ–¹æ³•ï¼›æœªä½œæŒ‰é”®åˆ†åŒºçš„ DataStream ä¸æ”¯æŒå®šæ—¶å™¨æ“ä½œï¼Œåªèƒ½è·å–å½“å‰æ—¶é—´ã€‚ å¯¹äºå¤„ç†æ—¶é—´å’Œäº‹ä»¶æ—¶é—´è¿™ä¸¤ç§ç±»å‹çš„å®šæ—¶å™¨ï¼ŒTimerService å†…éƒ¨ä¼šç”¨ä¸€ä¸ªä¼˜å…ˆé˜Ÿåˆ—å°†å®ƒä»¬çš„æ—¶é—´æˆ³ï¼ˆtimestampï¼‰ä¿å­˜èµ·æ¥ï¼Œæ’é˜Ÿç­‰å¾…æ‰§è¡Œã€‚å¯ä»¥è®¤ä¸ºï¼Œå®šæ—¶å™¨å…¶å®æ˜¯ KeyedStreamä¸Šå¤„ç†ç®—å­çš„ä¸€ä¸ªçŠ¶æ€ï¼Œå®ƒä»¥æ—¶é—´æˆ³ä½œä¸ºåŒºåˆ†ã€‚æ‰€ä»¥ TimerService ä¼šä»¥é”®ï¼ˆkeyï¼‰å’Œæ—¶é—´æˆ³ä¸ºæ ‡å‡†ï¼Œå¯¹å®šæ—¶å™¨è¿›è¡Œå»é‡ï¼›ä¹Ÿå°±æ˜¯è¯´å¯¹äºæ¯ä¸ª key å’Œæ—¶é—´æˆ³ï¼Œæœ€å¤šåªæœ‰ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå¦‚æœæ³¨å†Œäº†å¤šæ¬¡ï¼ŒonTimer()æ–¹æ³•ä¹Ÿå°†åªè¢«è°ƒç”¨ä¸€æ¬¡ã€‚è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬åœ¨ä»£ç ä¸­å°±æ–¹ä¾¿äº†å¾ˆå¤šï¼Œå¯ä»¥è‚†æ— å¿Œæƒ®åœ°å¯¹ä¸€ä¸ª key æ³¨å†Œå®šæ—¶å™¨ï¼Œè€Œä¸ç”¨æ‹…å¿ƒé‡å¤å®šä¹‰â€”â€”å› ä¸ºä¸€ä¸ªæ—¶é—´æˆ³ä¸Šçš„å®šæ—¶å™¨åªä¼šè§¦å‘ä¸€æ¬¡ã€‚ åŸºäº KeyedStream æ³¨å†Œå®šæ—¶å™¨æ—¶ï¼Œä¼šä¼ å…¥ä¸€ä¸ªå®šæ—¶å™¨è§¦å‘çš„æ—¶é—´æˆ³ï¼Œè¿™ä¸ªæ—¶é—´æˆ³çš„å®šæ—¶å™¨å¯¹äºæ¯ä¸ª key éƒ½æ˜¯æœ‰æ•ˆçš„ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬çš„ä»£ç å¹¶ä¸éœ€è¦åšé¢å¤–çš„å¤„ç†ï¼Œåº•å±‚å°±å¯ä»¥ç›´æ¥å¯¹ä¸åŒkey è¿›è¡Œç‹¬ç«‹çš„å¤„ç†æ“ä½œäº†ã€‚ åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œæœ‰æ—¶æˆ‘ä»¬å¯ä»¥æ•…æ„é™ä½æ—¶é—´æˆ³çš„ç²¾åº¦ï¼Œæ¥å‡å°‘å®šæ—¶å™¨çš„æ•°é‡ï¼Œä»è€Œæé«˜å¤„ç†æ€§èƒ½ã€‚æ¯”å¦‚æˆ‘ä»¬å¯ä»¥åœ¨è®¾ç½®å®šæ—¶å™¨æ—¶åªä¿ç•™æ•´ç§’æ•°ï¼Œé‚£ä¹ˆå®šæ—¶å™¨çš„è§¦å‘é¢‘ç‡å°±æ˜¯æœ€å¤š 1 ç§’ä¸€æ¬¡ã€‚ long coalescedTime = time / 1000 * 1000; ctx.timerService().registerProcessingTimeTimer(coalescedTime); è¿™é‡Œæ³¨æ„å®šæ—¶å™¨çš„æ—¶é—´æˆ³å¿…é¡»æ˜¯æ¯«ç§’æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—åˆ°æ•´ç§’ä¹‹åè¿˜è¦ä¹˜ä»¥ 1000ã€‚å®šæ—¶å™¨é»˜è®¤çš„åŒºåˆ†ç²¾åº¦æ˜¯æ¯«ç§’ã€‚ å¦å¤– Flink å¯¹.onTimer()å’Œ.processElement()æ–¹æ³•æ˜¯åŒæ­¥è°ƒç”¨çš„ï¼ˆsynchronousï¼‰ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šå‡ºç°çŠ¶æ€çš„å¹¶å‘ä¿®æ”¹ã€‚ Flink çš„å®šæ—¶å™¨åŒæ ·å…·æœ‰å®¹é”™æ€§ï¼Œå®ƒå’ŒçŠ¶æ€ä¸€èµ·éƒ½ä¼šè¢«ä¿å­˜åˆ°ä¸€è‡´æ€§æ£€æŸ¥ç‚¹ï¼ˆcheckpointï¼‰ä¸­ã€‚å½“å‘ç”Ÿæ•…éšœæ—¶ï¼ŒFlink ä¼šé‡å¯å¹¶è¯»å–æ£€æŸ¥ç‚¹ä¸­çš„çŠ¶æ€ï¼Œæ¢å¤å®šæ—¶å™¨ã€‚å¦‚æœæ˜¯å¤„ç†æ—¶é—´çš„å®šæ—¶å™¨ï¼Œæœ‰å¯èƒ½ä¼šå‡ºç°å·²ç»â€œè¿‡æœŸâ€çš„æƒ…å†µï¼Œè¿™æ—¶å®ƒä»¬ä¼šåœ¨é‡å¯æ—¶è¢«ç«‹åˆ»è§¦å‘ã€‚ KeyedProcessFunction çš„ä½¿ç”¨ KeyedProcessFunction å¯ä»¥è¯´æ˜¯å¤„ç†å‡½æ•°ä¸­çš„â€œå«¡ç³»éƒ¨é˜Ÿâ€ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ ProcessFunction çš„ä¸€ä¸ªæ‰©å±•ã€‚æˆ‘ä»¬åªè¦åŸºäº keyBy ä¹‹åçš„ KeyedStreamï¼Œç›´æ¥è°ƒç”¨.process()æ–¹æ³•ï¼Œè¿™æ—¶éœ€è¦ä¼ å…¥çš„å‚æ•°å°±æ˜¯ KeyedProcessFunction çš„å®ç°ç±»ã€‚ stream.keyBy( t -&gt; t.f0 ) .process(new MyKeyedProcessFunction()) ç±»ä¼¼åœ°ï¼ŒKeyedProcessFunction ä¹Ÿæ˜¯ç»§æ‰¿è‡ª AbstractRichFunction çš„ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæºç ä¸­å®šä¹‰å¦‚ä¸‹ï¼š public abstract class KeyedProcessFunction&lt;K, I, O&gt; extends AbstractRichFunction { ... public abstract void processElement(I value, Context ctx, Collector&lt;O&gt; out) throws Exception; public void onTimer(long timestamp, OnTimerContext ctx, Collector&lt;O&gt; out) throws Exception {} public abstract class Context {...} ... } å¯ä»¥çœ‹åˆ°ä¸ ProcessFunction çš„å®šä¹‰å‡ ä¹å®Œå…¨ä¸€æ ·ï¼ŒåŒºåˆ«åªæ˜¯åœ¨äºç±»å‹å‚æ•°å¤šäº†ä¸€ä¸ª Kï¼Œè¿™æ˜¯å½“å‰æŒ‰é”®åˆ†åŒºçš„ key çš„ç±»å‹ã€‚åŒæ ·åœ°ï¼Œæˆ‘ä»¬å¿…é¡»å®ç°ä¸€ä¸ª.processElement()æŠ½è±¡æ–¹æ³•ï¼Œç”¨æ¥å¤„ç†æµä¸­çš„æ¯ä¸€ä¸ªæ•°æ®ï¼›å¦å¤–è¿˜æœ‰ä¸€ä¸ªéæŠ½è±¡æ–¹æ³•.onTimer()ï¼Œç”¨æ¥å®šä¹‰å®šæ—¶å™¨è§¦å‘æ—¶çš„å›è°ƒæ“ä½œã€‚ç”±äºå®šæ—¶å™¨åªèƒ½åœ¨ KeyedStream ä¸Šä½¿ç”¨ï¼Œæ‰€ä»¥åˆ°äº† KeyedProcessFunction è¿™é‡Œï¼Œæˆ‘ä»¬æ‰çœŸæ­£å¯¹æ—¶é—´æœ‰äº†ç²¾ç»†çš„æ§åˆ¶ï¼Œå®šæ—¶æ–¹æ³•.onTimer()æ‰çœŸæ­£æ´¾ä¸Šäº†ç”¨åœºã€‚ import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.streaming.api.functions.KeyedProcessFunction; import org.apache.flink.util.Collector; import java.sql.Timestamp; public class ProcessingTimeTimerTest { public static void main(String[] args) throws Exception { StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); env.setParallelism(1); // å¤„ç†æ—¶é—´è¯­ä¹‰ï¼Œä¸éœ€è¦åˆ†é…æ—¶é—´æˆ³å’Œ watermark SingleOutputStreamOperator&lt;Event&gt; stream = env.addSource(new ClickSource()); // è¦ç”¨å®šæ—¶å™¨ï¼Œå¿…é¡»åŸºäº KeyedStream stream.keyBy(data -&gt; true) .process(new KeyedProcessFunction&lt;Boolean, Event, String&gt;() { @Override public void processElement(Event value, Context ctx, Collector&lt;String&gt; out) throws Exception { Long currTs = ctx.timerService().currentProcessingTime(); out.collect(&quot;æ•°æ®åˆ°è¾¾ï¼Œåˆ°è¾¾æ—¶é—´ï¼š&quot; + new Timestamp(currTs)); // æ³¨å†Œä¸€ä¸ª 10 ç§’åçš„å®šæ—¶å™¨ ctx.timerService().registerProcessingTimeTimer(currTs + 10 * 1000L); } @Override public void onTimer(long timestamp, OnTimerContext ctx, Collector&lt;String&gt; out) throws Exception { out.collect(&quot;å®šæ—¶å™¨è§¦å‘ï¼Œè§¦å‘æ—¶é—´ï¼š&quot; + new Timestamp(timestamp)); } }).print(); env.execute(); } } åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œç”±äºå®šæ—¶å™¨åªèƒ½åœ¨ KeyedStream ä¸Šä½¿ç”¨ï¼Œæ‰€ä»¥å…ˆè¦è¿›è¡Œ keyByï¼›è¿™é‡Œçš„.keyBy(data -&gt; true)æ˜¯å°†æ‰€æœ‰æ•°æ®çš„ key éƒ½æŒ‡å®šä¸ºäº† trueï¼Œå…¶å®å°±æ˜¯æ‰€æœ‰æ•°æ®æ‹¥æœ‰ç›¸åŒçš„ keyï¼Œä¼šåˆ†é…åˆ°åŒä¸€ä¸ªåˆ†åŒºã€‚ ä¹‹åæˆ‘ä»¬è‡ªå®šä¹‰äº†ä¸€ä¸ª KeyedProcessFunctionï¼Œå…¶ä¸­.processElement()æ–¹æ³•æ˜¯æ¯æ¥ä¸€ä¸ªæ•°æ®éƒ½ä¼šè°ƒç”¨ä¸€æ¬¡ï¼Œä¸»è¦æ˜¯å®šä¹‰äº†ä¸€ä¸ª 10 ç§’ä¹‹åçš„å®šæ—¶å™¨ï¼›è€Œ.onTimer()æ–¹æ³•åˆ™ä¼šåœ¨å®šæ—¶å™¨è§¦å‘æ—¶è°ƒç”¨ã€‚æ‰€ä»¥æˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œç¨‹åºè¿è¡Œåå…ˆåœ¨æ§åˆ¶å°è¾“å‡ºâ€œæ•°æ®åˆ°è¾¾â€çš„ä¿¡æ¯ï¼Œç­‰å¾… 10 ç§’ä¹‹åï¼Œåˆä¼šè¾“å‡ºâ€œå®šæ—¶å™¨è§¦å‘â€çš„ä¿¡æ¯ï¼Œæ‰“å°å‡ºçš„æ—¶é—´é—´éš”æ­£æ˜¯ 10 ç§’ã€‚ å½“ç„¶ï¼Œä¸Šé¢çš„ä¾‹å­æ˜¯å¤„ç†æ—¶é—´çš„å®šæ—¶å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬æ˜¯çœŸçš„éœ€è¦ç­‰å¾… 10 ç§’æ‰ä¼šçœ‹åˆ°ç»“æœã€‚äº‹ä»¶æ—¶é—´è¯­ä¹‰ä¸‹ï¼Œåˆä¼šæœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å¯¹ä¸Šé¢çš„ä»£ç ç•¥ä½œä¿®æ”¹ï¼Œåšä¸€ä¸ªæµ‹è¯•ï¼š import org.apache.flink.api.common.eventtime.SerializableTimestampAssigner; import org.apache.flink.api.common.eventtime.WatermarkStrategy; import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.streaming.api.functions.KeyedProcessFunction; import org.apache.flink.streaming.api.functions.source.SourceFunction; import org.apache.flink.util.Collector; public class EventTimeTimerTest { public static void main(String[] args) throws Exception { StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); env.setParallelism(1); SingleOutputStreamOperator&lt;Event&gt; stream = env.addSource(new CustomSource()) .assignTimestampsAndWatermarks(WatermarkStrategy.&lt;Event&gt;forMonotonousTimestamps() .withTimestampAssigner(new SerializableTimestampAssigner&lt;Event&gt;() { @Override public long extractTimestamp(Event element, long recordTimestamp) { return element.timestamp; } })); // åŸºäº KeyedStream å®šä¹‰äº‹ä»¶æ—¶é—´å®šæ—¶å™¨ stream.keyBy(data -&gt; true) .process(new KeyedProcessFunction&lt;Boolean, Event, String&gt;() { @Override public void processElement(Event value, Context ctx, Collector&lt;String&gt; out) throws Exception { out.collect(&quot;æ•°æ®åˆ°è¾¾ï¼Œæ—¶é—´æˆ³ä¸ºï¼š&quot; + ctx.timestamp()); out.collect(&quot; æ•°æ®åˆ°è¾¾ï¼Œæ°´ä½çº¿ä¸ºï¼š &quot; + ctx.timerService().currentWatermark() + &quot;\\n -------åˆ†å‰²çº¿-------&quot;); // æ³¨å†Œä¸€ä¸ª 10 ç§’åçš„å®šæ—¶å™¨ ctx.timerService().registerEventTimeTimer(ctx.timestamp() + 10 * 1000L); } @Override public void onTimer(long timestamp, OnTimerContext ctx, Collector&lt;String&gt; out) throws Exception { out.collect(&quot;å®šæ—¶å™¨è§¦å‘ï¼Œè§¦å‘æ—¶é—´ï¼š&quot; + timestamp); } }) .print(); env.execute(); } // è‡ªå®šä¹‰æµ‹è¯•æ•°æ®æº public static class CustomSource implements SourceFunction&lt;Event&gt; { @Override public void run(SourceContext&lt;Event&gt; ctx) throws Exception { // ç›´æ¥å‘å‡ºæµ‹è¯•æ•°æ® ctx.collect(new Event(&quot;Mary&quot;, &quot;./home&quot;, 1000L)); // ä¸ºäº†æ›´åŠ æ˜æ˜¾ï¼Œä¸­é—´åœé¡¿ 5 ç§’é’Ÿ Thread.sleep(5000L); // å‘å‡º 10 ç§’åçš„æ•°æ® ctx.collect(new Event(&quot;Mary&quot;, &quot;./home&quot;, 11000L)); Thread.sleep(5000L); // å‘å‡º 10 ç§’+1ms åçš„æ•°æ® ctx.collect(new Event(&quot;Alice&quot;, &quot;./cart&quot;, 11001L)); Thread.sleep(5000L); } @Override public void cancel() { } } } ç”±äºæ˜¯äº‹ä»¶æ—¶é—´è¯­ä¹‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»ä»æ•°æ®ä¸­æå–å‡ºæ•°æ®äº§ç”Ÿçš„æ—¶é—´æˆ³ã€‚è¿™é‡Œä¸ºäº†æ›´æ¸…æ¥šåœ°çœ‹åˆ°ç¨‹åºè¡Œä¸ºï¼Œæˆ‘ä»¬è‡ªå®šä¹‰äº†ä¸€ä¸ªæ•°æ®æºï¼Œå‘å‡ºä¸‰æ¡æµ‹è¯•æ•°æ®ï¼Œæ—¶é—´æˆ³åˆ†åˆ«ä¸º 1000ã€11000å’Œ 11001ï¼Œå¹¶ä¸”å‘å‡ºæ•°æ®åéƒ½ä¼šåœé¡¿ 5 ç§’ã€‚ åœ¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¾ç„¶å°†æ‰€æœ‰æ•°æ®åˆ†åˆ°åŒä¸€åˆ†åŒºï¼Œç„¶ååœ¨è‡ªå®šä¹‰çš„ KeyedProcessFunction ä¸­ä½¿ç”¨å®šæ—¶å™¨ã€‚åŒæ ·åœ°ï¼Œæ¯æ¥ä¸€æ¡æ•°æ®ï¼Œæˆ‘ä»¬å°±å°†å½“å‰çš„æ•°æ®æ—¶é—´æˆ³å’Œæ°´ä½çº¿ä¿¡æ¯è¾“å‡ºï¼Œå¹¶æ³¨å†Œä¸€ä¸ª 10 ç§’åï¼ˆä»¥å½“å‰æ•°æ®æ—¶é—´æˆ³ä¸ºåŸºå‡†ï¼‰çš„äº‹ä»¶æ—¶é—´å®šæ—¶å™¨ã€‚æ‰§è¡Œç¨‹åºç»“æœå¦‚ä¸‹ï¼š æ•°æ®åˆ°è¾¾ï¼Œæ—¶é—´æˆ³ä¸ºï¼š1000 æ•°æ®åˆ°è¾¾ï¼Œæ°´ä½çº¿ä¸ºï¼š-9223372036854775808 -------åˆ†å‰²çº¿------- æ•°æ®åˆ°è¾¾ï¼Œæ—¶é—´æˆ³ä¸ºï¼š11000 æ•°æ®åˆ°è¾¾ï¼Œæ°´ä½çº¿ä¸ºï¼š999 -------åˆ†å‰²çº¿------- æ•°æ®åˆ°è¾¾ï¼Œæ—¶é—´æˆ³ä¸ºï¼š11001 æ•°æ®åˆ°è¾¾ï¼Œæ°´ä½çº¿ä¸ºï¼š10999 -------åˆ†å‰²çº¿------- å®šæ—¶å™¨è§¦å‘ï¼Œè§¦å‘æ—¶é—´ï¼š11000 å®šæ—¶å™¨è§¦å‘ï¼Œè§¦å‘æ—¶é—´ï¼š21000 å®šæ—¶å™¨è§¦å‘ï¼Œè§¦å‘æ—¶é—´ï¼š21001 æ¯æ¥ä¸€æ¡æ•°æ®ï¼Œéƒ½ä¼šè¾“å‡ºä¸¤è¡Œâ€œæ•°æ®åˆ°è¾¾â€çš„ä¿¡æ¯ï¼Œå¹¶ä»¥åˆ†å‰²çº¿éš”å¼€ï¼›ä¸¤æ¡æ•°æ®åˆ°è¾¾çš„æ—¶é—´é—´éš”ä¸º 5 ç§’ã€‚å½“ç¬¬ä¸‰æ¡æ•°æ®åˆ°è¾¾åï¼Œéšåç«‹å³è¾“å‡ºä¸€æ¡å®šæ—¶å™¨è§¦å‘çš„ä¿¡æ¯ï¼›å†è¿‡ 5 ç§’ä¹‹åï¼Œå‰©ä½™ä¸¤æ¡å®šæ—¶å™¨ä¿¡æ¯è¾“å‡ºï¼Œç¨‹åºè¿è¡Œç»“æŸã€‚ æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæ•°æ®åˆ°æ¥ä¹‹åï¼Œå½“å‰çš„æ°´ä½çº¿ä¸æ—¶é—´æˆ³å¹¶ä¸æ˜¯ä¸€è‡´çš„ã€‚å½“ç¬¬ä¸€æ¡æ•°æ®åˆ°æ¥ï¼Œæ—¶é—´æˆ³ä¸º 1000ï¼Œå¯æ°´ä½çº¿çš„ç”Ÿæˆæ˜¯å‘¨æœŸæ€§çš„ï¼ˆé»˜è®¤ 200ms ä¸€æ¬¡ï¼‰ï¼Œä¸ä¼šç«‹å³å‘ç”Ÿæ”¹å˜ï¼Œæ‰€ä»¥ä¾ç„¶æ˜¯æœ€å°å€¼ Long.MIN_VALUEï¼›éšååªè¦åˆ°äº†æ°´ä½çº¿ç”Ÿæˆçš„æ—¶é—´ç‚¹ï¼ˆ200ms åˆ°äº†ï¼‰ï¼Œå°±ä¼šä¾æ®å½“å‰çš„æœ€å¤§æ—¶é—´æˆ³ 1000 æ¥ç”Ÿæˆæ°´ä½çº¿äº†ã€‚è¿™é‡Œæˆ‘ä»¬æ²¡æœ‰è®¾ç½®æ°´ä½çº¿å»¶è¿Ÿï¼Œé»˜è®¤éœ€è¦å‡å» 1 æ¯«ç§’ï¼Œæ‰€ä»¥æ°´ä½çº¿æ¨è¿›åˆ°äº† 999ã€‚è€Œå½“æ—¶é—´æˆ³ä¸º 11000 çš„ç¬¬äºŒæ¡æ•°æ®åˆ°æ¥ä¹‹åï¼Œæ°´ä½çº¿åŒæ ·æ²¡æœ‰ç«‹å³æ”¹å˜ï¼Œä»ç„¶æ˜¯ 999ï¼Œå°±å¥½åƒæ€»æ˜¯â€œæ»åâ€æ•°æ®ä¸€æ ·ã€‚ è¿™æ ·ç¨‹åºçš„è¡Œä¸ºå°±å¯ä»¥å¾—åˆ°åˆç†è§£é‡Šäº†ã€‚äº‹ä»¶æ—¶é—´è¯­ä¹‰ä¸‹ï¼Œå®šæ—¶å™¨è§¦å‘çš„æ¡ä»¶å°±æ˜¯æ°´ä½çº¿æ¨è¿›åˆ°è®¾å®šçš„æ—¶é—´ã€‚ç¬¬ä¸€æ¡æ•°æ®åˆ°æ¥åï¼Œè®¾å®šçš„å®šæ—¶å™¨æ—¶é—´ä¸º 1000 + 10 * 1000 = 11000ï¼›è€Œå½“æ—¶é—´æˆ³ä¸º 11000 çš„ç¬¬äºŒæ¡æ•°æ®åˆ°æ¥ï¼Œæ°´ä½çº¿è¿˜å¤„åœ¨ 999 çš„ä½ç½®ï¼Œå½“ç„¶ä¸ä¼šç«‹å³è§¦å‘å®šæ—¶å™¨ï¼›è€Œä¹‹åæ°´ä½çº¿ä¼šæ¨è¿›åˆ° 10999ï¼ŒåŒæ ·æ˜¯æ— æ³•è§¦å‘å®šæ—¶å™¨çš„ã€‚å¿…é¡»ç­‰åˆ°ç¬¬ä¸‰æ¡æ•°æ®åˆ°æ¥ï¼Œå°†æ°´ä½çº¿çœŸæ­£æ¨è¿›åˆ° 11000ï¼Œå°±å¯ä»¥è§¦å‘ç¬¬ä¸€ä¸ªå®šæ—¶å™¨äº†ã€‚ç¬¬ä¸‰æ¡æ•°æ®å‘å‡ºåå†è¿‡ 5 ç§’ï¼Œæ²¡æœ‰æ›´å¤šçš„æ•°æ®ç”Ÿæˆäº†ï¼Œæ•´ä¸ªç¨‹åºè¿è¡Œç»“æŸå°†è¦é€€å‡ºï¼Œæ­¤æ—¶ Flink ä¼šè‡ªåŠ¨å°†æ°´ä½çº¿æ¨è¿›åˆ°é•¿æ•´å‹çš„æœ€å¤§å€¼ï¼ˆLong.MAX_VALUEï¼‰ã€‚äºæ˜¯æ‰€æœ‰å°šæœªè§¦å‘çš„å®šæ—¶å™¨è¿™æ—¶å°±ç»Ÿä¸€è§¦å‘äº†ï¼Œæˆ‘ä»¬å°±åœ¨æ§åˆ¶å°çœ‹åˆ°äº†åä¸¤ä¸ªå®šæ—¶å™¨çš„è§¦å‘ä¿¡æ¯ã€‚ çª—å£å¤„ç†å‡½æ•° é™¤ äº† KeyedProcessFunction ï¼Œ å¦ å¤– ä¸€ å¤§ ç±» å¸¸ ç”¨ çš„ å¤„ ç† å‡½ æ•° ï¼Œ å°± æ˜¯ åŸº äº çª— å£ çš„ProcessWindowFunction å’Œ ProcessAllWindowFunction äº†ã€‚ çª—å£å¤„ç†å‡½æ•°çš„ä½¿ç”¨ è¿›è¡Œçª—å£è®¡ç®—ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è°ƒç”¨ç°æˆçš„ç®€å•èšåˆæ–¹æ³•ï¼ˆsum/max/minï¼‰,ä¹Ÿå¯ä»¥é€šè¿‡è°ƒç”¨.reduce()æˆ–.aggregate()æ¥è‡ªå®šä¹‰ä¸€èˆ¬çš„å¢é‡èšåˆå‡½æ•°ï¼ˆReduceFunction/AggregateFucntionï¼‰ï¼›è€Œå¯¹äºæ›´åŠ å¤æ‚ã€éœ€è¦çª—å£ä¿¡æ¯å’Œé¢å¤–çŠ¶æ€çš„ä¸€äº›åœºæ™¯ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç›´æ¥ä½¿ç”¨å…¨çª—å£å‡½æ•°ã€æŠŠæ•°æ®å…¨éƒ¨æ”¶é›†ä¿å­˜åœ¨çª—å£å†…ï¼Œç­‰åˆ°è§¦å‘çª—å£è®¡ç®—æ—¶å†ç»Ÿä¸€å¤„ç†ã€‚çª—å£å¤„ç†å‡½æ•°å°±æ˜¯ä¸€ç§å…¸å‹çš„å…¨çª—å£å‡½æ•°ã€‚ çª— å£ å¤„ ç† å‡½ æ•° ProcessWindowFunction çš„ ä½¿ ç”¨ ä¸ å…¶ ä»– çª— å£ å‡½ æ•° ç±» ä¼¼ ï¼Œ ä¹Ÿ æ˜¯ åŸº äºWindowedStream ç›´æ¥è°ƒç”¨æ–¹æ³•å°±å¯ä»¥ï¼Œåªä¸è¿‡è¿™æ—¶è°ƒç”¨çš„æ˜¯.process()ã€‚ stream.keyBy( t -&gt; t.f0 ) .window( TumblingEventTimeWindows.of(Time.seconds(10)) ) .process(new MyProcessWindowFunction()) ProcessWindowFunction è§£æ ProcessWindowFunction æ—¢æ˜¯å¤„ç†å‡½æ•°åˆæ˜¯å…¨çª—å£å‡½æ•°ã€‚ä»åå­—ä¸Šä¹Ÿå¯ä»¥æ¨æµ‹å‡ºï¼Œå®ƒçš„æœ¬è´¨ä¼¼ä¹æ›´å€¾å‘äºâ€œçª—å£å‡½æ•°â€ä¸€äº›ã€‚äº‹å®ä¸Šå®ƒçš„ç”¨æ³•ä¹Ÿç¡®å®è·Ÿå…¶ä»–å¤„ç†å‡½æ•°æœ‰å¾ˆå¤§ä¸åŒã€‚æˆ‘ä»¬å¯ä»¥ä»æºç ä¸­çš„å®šä¹‰çœ‹åˆ°è¿™ä¸€ç‚¹ï¼š public abstract class ProcessWindowFunction&lt;IN, OUT, KEY, W extends Window&gt; extends AbstractRichFunction { ... public abstract void process( KEY key, Context context, Iterable&lt;IN&gt; elements, Collector&lt;OUT&gt; out) throws Exception; public void clear(Context context) throws Exception {} public abstract class Context implements java.io.Serializable {...} } ProcessWindowFunction ä¾ç„¶æ˜¯ä¸€ä¸ªç»§æ‰¿äº† AbstractRichFunction çš„æŠ½è±¡ç±»ï¼Œå®ƒæœ‰å››ä¸ªç±»å‹å‚æ•°ï¼š INï¼šinputï¼Œæ•°æ®æµä¸­çª—å£ä»»åŠ¡çš„è¾“å…¥æ•°æ®ç±»å‹ã€‚ OUTï¼šoutputï¼Œçª—å£ä»»åŠ¡è¿›è¡Œè®¡ç®—ä¹‹åçš„è¾“å‡ºæ•°æ®ç±»å‹ã€‚ KEYï¼šæ•°æ®ä¸­é”® key çš„ç±»å‹ã€‚ Wï¼šçª—å£çš„ç±»å‹ï¼Œæ˜¯ Window çš„å­ç±»å‹ã€‚ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬å®šä¹‰æ—¶é—´çª—å£ï¼ŒWå°±æ˜¯ TimeWindowã€‚ è€Œå†…éƒ¨å®šä¹‰çš„æ–¹æ³•ï¼Œè·Ÿæˆ‘ä»¬ä¹‹å‰ç†Ÿæ‚‰çš„å¤„ç†å‡½æ•°å°±æœ‰æ‰€åŒºåˆ«äº†ã€‚å› ä¸ºå…¨çª—å£å‡½æ•°ä¸æ˜¯é€ä¸ªå¤„ç†å…ƒç´ çš„ï¼Œæ‰€ä»¥å¤„ç†æ•°æ®çš„æ–¹æ³•åœ¨è¿™é‡Œå¹¶ä¸æ˜¯.processElement()ï¼Œè€Œæ˜¯æ”¹æˆäº†.process()ã€‚æ–¹æ³•åŒ…å«å››ä¸ªå‚æ•°ã€‚ keyï¼šçª—å£åšç»Ÿè®¡è®¡ç®—åŸºäºçš„é”®ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰ keyBy ç”¨æ¥åˆ†åŒºçš„å­—æ®µã€‚ contextï¼šå½“å‰çª—å£è¿›è¡Œè®¡ç®—çš„ä¸Šä¸‹æ–‡ï¼Œå®ƒçš„ç±»å‹å°±æ˜¯ ProcessWindowFunctionå†…éƒ¨å®šä¹‰çš„æŠ½è±¡ç±» Contextã€‚ elementsï¼šçª—å£æ”¶é›†åˆ°ç”¨æ¥è®¡ç®—çš„æ‰€æœ‰æ•°æ®ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯è¿­ä»£çš„é›†åˆç±»å‹ã€‚ outï¼šç”¨æ¥å‘é€æ•°æ®è¾“å‡ºè®¡ç®—ç»“æœçš„æ”¶é›†å™¨ï¼Œç±»å‹ä¸º Collectorã€‚ å¯ä»¥æ˜æ˜¾çœ‹å‡ºï¼Œè¿™é‡Œçš„å‚æ•°ä¸å†æ˜¯ä¸€ä¸ªè¾“å…¥æ•°æ®ï¼Œè€Œæ˜¯çª—å£ä¸­æ‰€æœ‰æ•°æ®çš„é›†åˆã€‚è€Œä¸Šä¸‹æ–‡context æ‰€åŒ…å«çš„å†…å®¹ä¹Ÿè·Ÿå…¶ä»–å¤„ç†å‡½æ•°æœ‰æ‰€å·®åˆ«ï¼š public abstract class Context implements java.io.Serializable { public abstract W window(); public abstract long currentProcessingTime(); public abstract long currentWatermark(); public abstract KeyedStateStore windowState(); public abstract KeyedStateStore globalState(); public abstract &lt;X&gt; void output(OutputTag&lt;X&gt; outputTag, X value); } é™¤äº†å¯ä»¥é€šè¿‡.output()æ–¹æ³•å®šä¹‰ä¾§è¾“å‡ºæµä¸å˜å¤–ï¼Œå…¶ä»–éƒ¨åˆ†éƒ½æœ‰æ‰€å˜åŒ–ã€‚è¿™é‡Œä¸å†æŒæœ‰TimerService å¯¹è±¡ï¼Œåªèƒ½é€šè¿‡ currentProcessingTime()å’Œ currentWatermark()æ¥è·å–å½“å‰æ—¶é—´ï¼Œæ‰€ä»¥å¤±å»äº†è®¾ç½®å®šæ—¶å™¨çš„åŠŸèƒ½ï¼›å¦å¤–ç”±äºå½“å‰ä¸æ˜¯åªå¤„ç†ä¸€ä¸ªæ•°æ®ï¼Œæ‰€ä»¥ä¹Ÿä¸å†æä¾›.timestamp()æ–¹æ³•ã€‚ä¸æ­¤åŒæ—¶ï¼Œä¹Ÿå¢åŠ äº†ä¸€äº›è·å–å…¶ä»–ä¿¡æ¯çš„æ–¹æ³•ï¼šæ¯”å¦‚å¯ä»¥é€šè¿‡.window()ç›´æ¥è·å–åˆ°å½“å‰çš„çª—å£å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥é€šè¿‡.windowState()å’Œ.globalState()è·å–åˆ°å½“å‰è‡ªå®šä¹‰çš„çª—å£çŠ¶æ€å’Œå…¨å±€çŠ¶æ€ã€‚æ³¨æ„è¿™é‡Œçš„â€œçª—å£çŠ¶æ€â€æ˜¯è‡ªå®šä¹‰çš„ï¼Œä¸åŒ…æ‹¬çª—å£æœ¬èº«å·²ç»æœ‰çš„çŠ¶æ€ï¼Œé’ˆå¯¹å½“å‰ keyã€å½“å‰çª—å£æœ‰æ•ˆï¼›è€Œâ€œå…¨å±€çŠ¶æ€â€åŒæ ·æ˜¯è‡ªå®šä¹‰çš„çŠ¶æ€ï¼Œé’ˆå¯¹å½“å‰ key çš„æ‰€æœ‰çª—å£æœ‰æ•ˆã€‚ æ‰€ä»¥æˆ‘ä»¬ä¼šå‘ç°ï¼ŒProcessWindowFunction ä¸­é™¤äº†.process()æ–¹æ³•å¤–ï¼Œå¹¶æ²¡æœ‰.onTimer()æ–¹æ³•ï¼Œè€Œæ˜¯å¤šå‡ºäº†ä¸€ä¸ª.clear()æ–¹æ³•ã€‚ä»åå­—å°±å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸»è¦æ˜¯æ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œçª—å£çš„æ¸…ç†å·¥ä½œã€‚å¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰äº†çª—å£çŠ¶æ€ï¼Œé‚£ä¹ˆå¿…é¡»åœ¨.clear()æ–¹æ³•ä¸­è¿›è¡Œæ˜¾å¼åœ°æ¸…é™¤ï¼Œé¿å…å†…å­˜æº¢å‡ºã€‚ è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼šæ²¡æœ‰äº†å®šæ—¶å™¨ï¼Œé‚£çª—å£å¤„ç†å‡½æ•°å°±å¤±å»äº†ä¸€ä¸ªæœ€ç»™åŠ›çš„æ­¦å™¨ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›æœ‰ä¸€äº›å®šæ—¶æ“ä½œåˆè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿå…¶å®ä»”ç»†æ€è€ƒä¼šå‘ç°ï¼Œå¯¹äºçª—å£è€Œè¨€ï¼Œå®ƒæœ¬èº«çš„å®šä¹‰å°±åŒ…å«äº†ä¸€ä¸ªè§¦å‘è®¡ç®—çš„æ—¶é—´ç‚¹ï¼Œå…¶å®ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯æ²¡æœ‰å¿…è¦å†å»åšå®šæ—¶æ“ä½œçš„ã€‚å¦‚æœéè¦è¿™ä¹ˆå¹²ï¼ŒFlinkä¹Ÿæä¾›äº†å¦å¤–çš„é€”å¾„â€”â€”ä½¿ç”¨çª—å£è§¦å‘å™¨ï¼ˆTriggerï¼‰ã€‚åœ¨è§¦å‘å™¨ä¸­ä¹Ÿæœ‰ä¸€ä¸ªTriggerContextï¼Œå®ƒå¯ä»¥èµ·åˆ°ç±»ä¼¼ TimerService çš„ä½œç”¨ï¼šè·å–å½“å‰æ—¶é—´ã€æ³¨å†Œå’Œåˆ é™¤å®šæ—¶å™¨ï¼Œå¦å¤–è¿˜å¯ä»¥è·å–å½“å‰çš„çŠ¶æ€ã€‚è¿™æ ·è®¾è®¡æ— ç–‘ä¼šè®©å¤„ç†æµç¨‹æ›´åŠ æ¸…æ™°â€”â€”å®šæ—¶æ“ä½œä¹Ÿæ˜¯ä¸€ç§â€œè§¦å‘â€ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±è®©æ‰€æœ‰çš„è§¦å‘æ“ä½œå½’è§¦å‘å™¨ç®¡ï¼Œè€Œæ‰€æœ‰å¤„ç†æ•°æ®çš„æ“ä½œåˆ™å½’çª—å£å‡½æ•°ç®¡ã€‚ è‡³äºå¦ä¸€ç§çª—å£å¤„ç†å‡½æ•° ProcessAllWindowFunctionï¼Œå®ƒçš„ç”¨æ³•éå¸¸ç±»ä¼¼ã€‚åŒºåˆ«åœ¨äºå®ƒåŸºäºçš„æ˜¯ AllWindowedStreamï¼Œç›¸å½“äºå¯¹æ²¡æœ‰ keyBy çš„æ•°æ®æµç›´æ¥å¼€çª—å¹¶è°ƒç”¨.process()æ–¹æ³•: stream.windowAll( TumblingEventTimeWindows.of(Time.seconds(10)) ) .process(new MyProcessAllWindowFunction()) åº”ç”¨æ¡ˆä¾‹â€”â€”Top N çª—å£çš„è®¡ç®—å¤„ç†ï¼Œåœ¨å®é™…åº”ç”¨ä¸­éå¸¸å¸¸è§ã€‚å¯¹äºä¸€äº›æ¯”è¾ƒå¤æ‚çš„éœ€æ±‚ï¼Œå¦‚æœå¢é‡èšåˆå‡½æ•°æ— æ³•æ»¡è¶³ï¼Œæˆ‘ä»¬å°±éœ€è¦è€ƒè™‘ä½¿ç”¨çª—å£å¤„ç†å‡½æ•°è¿™æ ·çš„â€œå¤§æ‹›â€äº†ã€‚ ç½‘ç«™ä¸­ä¸€ä¸ªéå¸¸ç»å…¸çš„ä¾‹å­ï¼Œå°±æ˜¯å®æ—¶ç»Ÿè®¡ä¸€æ®µæ—¶é—´å†…çš„çƒ­é—¨ urlã€‚ä¾‹å¦‚ï¼Œéœ€è¦ç»Ÿè®¡æœ€è¿‘10 ç§’é’Ÿå†…æœ€çƒ­é—¨çš„ä¸¤ä¸ª url é“¾æ¥ï¼Œå¹¶ä¸”æ¯ 5 ç§’é’Ÿæ›´æ–°ä¸€æ¬¡ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œè¿™å¯ä»¥ç”¨ä¸€ä¸ªæ»‘åŠ¨çª—å£æ¥å®ç°ï¼Œè€Œâ€œçƒ­é—¨åº¦â€ä¸€èˆ¬å¯ä»¥ç›´æ¥ç”¨è®¿é—®é‡æ¥è¡¨ç¤ºã€‚äºæ˜¯å°±éœ€è¦å¼€æ»‘åŠ¨çª—å£æ”¶é›† url çš„è®¿é—®æ•°æ®ï¼ŒæŒ‰ç…§ä¸åŒçš„ url è¿›è¡Œç»Ÿè®¡ï¼Œè€Œåæ±‡æ€»æ’åºå¹¶æœ€ç»ˆè¾“å‡ºå‰ä¸¤åã€‚è¿™å…¶å®å°±æ˜¯è‘—åçš„â€œTop Nâ€é—®é¢˜ã€‚ å¾ˆæ˜¾ç„¶ï¼Œç®€å•çš„å¢é‡èšåˆå¯ä»¥å¾—åˆ° url é“¾æ¥çš„è®¿é—®é‡ï¼Œä½†æ˜¯åç»­çš„æ’åºè¾“å‡º Top N å°±å¾ˆéš¾å®ç°äº†ã€‚æ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬ç”¨çª—å£å¤„ç†å‡½æ•°è¿›è¡Œå®ç°ã€‚ ä½¿ç”¨ ProcessAllWindowFunction ä¸€ç§æœ€ç®€å•çš„æƒ³æ³•æ˜¯ï¼Œæˆ‘ä»¬å¹²è„†ä¸åŒºåˆ† url é“¾æ¥ï¼Œè€Œæ˜¯å°†æ‰€æœ‰è®¿é—®æ•°æ®éƒ½æ”¶é›†èµ·æ¥ï¼Œç»Ÿä¸€è¿›è¡Œç»Ÿè®¡è®¡ç®—ã€‚æ‰€ä»¥å¯ä»¥ä¸åš keyByï¼Œç›´æ¥åŸºäº DataStream å¼€çª—ï¼Œç„¶åä½¿ç”¨å…¨çª—å£å‡½æ•°ProcessAllWindowFunction æ¥è¿›è¡Œå¤„ç†ã€‚ åœ¨çª—å£ä¸­å¯ä»¥ç”¨ä¸€ä¸ª HashMap æ¥ä¿å­˜æ¯ä¸ª url çš„è®¿é—®æ¬¡æ•°ï¼Œåªè¦éå†çª—å£ä¸­çš„æ‰€æœ‰æ•°æ®ï¼Œè‡ªç„¶å°±èƒ½å¾—åˆ°æ‰€æœ‰ url çš„çƒ­é—¨åº¦ã€‚æœ€åæŠŠ HashMap è½¬æˆä¸€ä¸ªåˆ—è¡¨ ArrayListï¼Œç„¶åè¿›è¡Œæ’åºã€å–å‡ºå‰ä¸¤åè¾“å‡ºå°±å¯ä»¥äº†ã€‚ import org.apache.flink.api.common.eventtime.SerializableTimestampAssigner; import org.apache.flink.api.common.eventtime.WatermarkStrategy; import org.apache.flink.api.common.functions.MapFunction; import org.apache.flink.api.java.tuple.Tuple2; import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.streaming.api.functions.windowing.ProcessAllWindowFunction; import org.apache.flink.streaming.api.windowing.assigners.SlidingEventTimeWindows; import org.apache.flink.streaming.api.windowing.time.Time; import org.apache.flink.streaming.api.windowing.windows.TimeWindow; import org.apache.flink.util.Collector; import java.sql.Timestamp; import java.util.ArrayList; import java.util.Comparator; import java.util.HashMap; public class ProcessAllWindowTopN { public static void main(String[] args) throws Exception { StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); env.setParallelism(1); SingleOutputStreamOperator&lt;Event&gt; eventStream = env.addSource(new ClickSource()) .assignTimestampsAndWatermarks(WatermarkStrategy.&lt;Event&gt;forMonotonousTimestamps() .withTimestampAssigner(new SerializableTimestampAssigner&lt;Event&gt;() { @Override public long extractTimestamp(Event element, long recordTimestamp) { return element.timestamp; } }) ); // åªéœ€è¦ url å°±å¯ä»¥ç»Ÿè®¡æ•°é‡ï¼Œæ‰€ä»¥è½¬æ¢æˆ String ç›´æ¥å¼€çª—ç»Ÿè®¡ SingleOutputStreamOperator&lt;String&gt; result = eventStream .map(new MapFunction&lt;Event, String&gt;() { @Override public String map(Event value) throws Exception { return value.url; } }) .windowAll(SlidingEventTimeWindows.of(Time.seconds(10), Time.seconds(5))) // å¼€æ»‘åŠ¨çª—å£ .process(new ProcessAllWindowFunction&lt;String, String, TimeWindow&gt;() { @Override public void process(Context context, Iterable&lt;String&gt; elements, Collector&lt;String&gt; out) throws Exception { HashMap&lt;String, Long&gt; urlCountMap = new HashMap&lt;&gt;(); // éå†çª—å£ä¸­æ•°æ®ï¼Œå°†æµè§ˆé‡ä¿å­˜åˆ°ä¸€ä¸ª HashMap ä¸­ for (String url : elements) { if (urlCountMap.containsKey(url)) { long count = urlCountMap.get(url); urlCountMap.put(url, count + 1L); } else { urlCountMap.put(url, 1L); } } ArrayList&lt;Tuple2&lt;String, Long&gt;&gt; mapList = new ArrayList&lt;Tuple2&lt;String, Long&gt;&gt;(); // å°†æµè§ˆé‡æ•°æ®æ”¾å…¥ ArrayListï¼Œè¿›è¡Œæ’åº for (String key : urlCountMap.keySet()) { mapList.add(Tuple2.of(key, urlCountMap.get(key))); } mapList.sort(new Comparator&lt;Tuple2&lt;String, Long&gt;&gt;() { @Override public int compare(Tuple2&lt;String, Long&gt; o1, Tuple2&lt;String, Long&gt; o2) { return o2.f1.intValue() - o1.f1.intValue(); } }); // å–æ’åºåçš„å‰ä¸¤åï¼Œæ„å»ºè¾“å‡ºç»“æœ StringBuilder result = new StringBuilder(); result.append(&quot;========================================\\n&quot;); for (int i = 0; i &lt; 2; i++) { Tuple2&lt;String, Long&gt; temp = mapList.get(i); String info = &quot;æµè§ˆé‡ No.&quot; + (i + 1) + &quot; urlï¼š&quot; + temp.f0 + &quot; æµè§ˆé‡ï¼š&quot; + temp.f1 + &quot; çª— å£ ç»“ æŸ æ—¶ é—´ ï¼š &quot; + new Timestamp(context.window().getEnd()) + &quot;\\n&quot;; result.append(info); } result.append(&quot;========================================\\n&quot;); out.collect(result.toString()); } }); result.print(); env.execute(); } } è¿è¡Œç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š ======================================== æµè§ˆé‡ No.1 urlï¼š./prod?id=1 æµè§ˆé‡ï¼š2 çª—å£ç»“æŸæ—¶é—´ï¼š2021-07-01 15:24:25.0 æµè§ˆé‡ No.2 urlï¼š./cart æµè§ˆé‡ï¼š1 çª—å£ç»“æŸæ—¶é—´ï¼š2021-07-01 15:24:25.0 ======================================== ä½¿ç”¨ KeyedProcessFunction åœ¨ä¸Šä¸€å°èŠ‚çš„å®ç°è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰è¿›è¡ŒæŒ‰é”®åˆ†åŒºï¼Œç›´æ¥å°†æ‰€æœ‰æ•°æ®æ”¾åœ¨ä¸€ä¸ªåˆ†åŒºä¸Šè¿›è¡Œäº†å¼€çª—æ“ä½œã€‚è¿™ç›¸å½“äºå°†å¹¶è¡Œåº¦å¼ºè¡Œè®¾ç½®ä¸º 1ï¼Œåœ¨å®é™…åº”ç”¨ä¸­æ˜¯è¦å°½é‡é¿å…çš„ï¼Œæ‰€ä»¥ Flink å®˜æ–¹ä¹Ÿå¹¶ä¸æ¨èä½¿ç”¨ AllWindowedStream è¿›è¡Œå¤„ç†ã€‚å¦å¤–ï¼Œæˆ‘ä»¬åœ¨å…¨çª—å£å‡½æ•°ä¸­å®šä¹‰äº† HashMap æ¥ç»Ÿè®¡ url é“¾æ¥çš„æµè§ˆé‡ï¼Œè®¡ç®—è¿‡ç¨‹æ˜¯è¦å…ˆæ”¶é›†é½æ‰€æœ‰æ•°æ®ã€ç„¶åå†é€ä¸€éå†æ›´æ–° HashMapï¼Œè¿™æ˜¾ç„¶ä¸å¤Ÿé«˜æ•ˆã€‚å¦‚æœæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å¢é‡èšåˆå‡½æ•°çš„ç‰¹æ€§ï¼Œæ¯æ¥ä¸€æ¡æ•°æ®å°±æ›´æ–°ä¸€æ¬¡å¯¹åº” urlçš„æµè§ˆé‡ï¼Œé‚£ä¹ˆåˆ°çª—å£è§¦å‘è®¡ç®—æ—¶åªéœ€è¦åšæ’åºè¾“å‡ºå°±å¯ä»¥äº†ã€‚ åŸºäºè¿™æ ·çš„æƒ³æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸¤ä¸ªæ–¹é¢å»åšä¼˜åŒ–ï¼šä¸€æ˜¯å¯¹æ•°æ®è¿›è¡ŒæŒ‰é”®åˆ†åŒºï¼Œåˆ†åˆ«ç»Ÿè®¡æµè§ˆé‡ï¼›äºŒæ˜¯è¿›è¡Œå¢é‡èšåˆï¼Œå¾—åˆ°ç»“æœæœ€åå†åšæ’åºè¾“å‡ºã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¢é‡èšåˆå‡½æ•°AggregateFunction è¿›è¡Œæµè§ˆé‡çš„ç»Ÿè®¡ï¼Œç„¶åç»“åˆ ProcessWindowFunction æ’åºè¾“å‡ºæ¥å®ç° Top Nçš„éœ€æ±‚ã€‚ å…·ä½“å®ç°æ€è·¯å°±æ˜¯ï¼Œå…ˆæŒ‰ç…§ url å¯¹æ•°æ®è¿›è¡Œ keyBy åˆ†åŒºï¼Œç„¶åå¼€çª—è¿›è¡Œå¢é‡èšåˆã€‚è¿™é‡Œå°±ä¼šå‘ç°ä¸€ä¸ªé—®é¢˜ï¼šæˆ‘ä»¬è¿›è¡ŒæŒ‰é”®åˆ†åŒºä¹‹åï¼Œçª—å£çš„è®¡ç®—å°±ä¼šåªé’ˆå¯¹å½“å‰ key æœ‰æ•ˆäº†ï¼›ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªçª—å£çš„ç»Ÿè®¡ç»“æœä¸­ï¼Œåªä¼šæœ‰ä¸€ä¸ª url çš„æµè§ˆé‡ï¼Œè¿™æ˜¯æ— æ³•ç›´æ¥ç”¨ ProcessWindowFunctionè¿›è¡Œæ’åºçš„ã€‚æ‰€ä»¥æˆ‘ä»¬åªèƒ½åˆ†æˆä¸¤æ­¥ï¼šå…ˆå¯¹æ¯ä¸ª url é“¾æ¥ç»Ÿè®¡å‡ºæµè§ˆé‡ï¼Œç„¶åå†å°†ç»Ÿè®¡ç»“æœæ”¶é›†èµ·æ¥ï¼Œæ’åºè¾“å‡ºæœ€ç»ˆç»“æœã€‚å› ä¸ºæœ€åçš„æ’åºè¿˜æ˜¯åŸºäºæ¯ä¸ªæ—¶é—´çª—å£çš„ï¼Œæ‰€ä»¥ä¸ºäº†è®©è¾“å‡ºçš„ç»Ÿè®¡ç»“æœä¸­åŒ…å«çª—å£ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥å€Ÿç”¨ç¬¬å…­ç« ä¸­å®šä¹‰çš„ POJO ç±» UrlViewCount æ¥è¡¨ç¤ºï¼Œå®ƒåŒ…å«äº† urlã€æµè§ˆé‡ï¼ˆcountï¼‰ä»¥åŠçª—å£çš„èµ·å§‹ç»“æŸæ—¶é—´ã€‚ä¹‹åå¯¹ UrlViewCount çš„å¤„ç†ï¼Œå¯ä»¥å…ˆæŒ‰çª—å£åˆ†åŒºï¼Œç„¶åç”¨ KeyedProcessFunction æ¥å®ç°ã€‚ æ€»ç»“å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š è¯»å–æ•°æ®æºï¼› ç­›é€‰æµè§ˆè¡Œä¸ºï¼ˆpvï¼‰ï¼› æå–æ—¶é—´æˆ³å¹¶ç”Ÿæˆæ°´ä½çº¿ï¼› æŒ‰ç…§ url è¿›è¡Œ keyBy åˆ†åŒºæ“ä½œï¼› å¼€é•¿åº¦ä¸º 1 å°æ—¶ã€æ­¥é•¿ä¸º 5 åˆ†é’Ÿçš„äº‹ä»¶æ—¶é—´æ»‘åŠ¨çª—å£ï¼› ä½¿ç”¨å¢é‡èšåˆå‡½æ•° AggregateFunctionï¼Œå¹¶ç»“åˆå…¨çª—å£å‡½æ•° WindowFunction è¿›è¡Œçª—å£èšåˆï¼Œå¾—åˆ°æ¯ä¸ª urlã€åœ¨æ¯ä¸ªç»Ÿè®¡çª—å£å†…çš„æµè§ˆé‡ï¼ŒåŒ…è£…æˆ UrlViewCountï¼› æŒ‰ç…§çª—å£è¿›è¡Œ keyBy åˆ†åŒºæ“ä½œï¼› å¯¹åŒä¸€çª—å£çš„ç»Ÿè®¡ç»“æœæ•°æ®ï¼Œä½¿ç”¨ KeyedProcessFunction è¿›è¡Œæ”¶é›†å¹¶æ’åºè¾“å‡ºã€‚ ç³Ÿç³•çš„æ˜¯ï¼Œè¿™é‡Œåˆä¼šå¸¦æ¥å¦ä¸€ä¸ªé—®é¢˜ã€‚æœ€åæˆ‘ä»¬ç”¨ KeyedProcessFunction æ¥æ”¶é›†æ•°æ®åšæ’åºï¼Œè¿™æ—¶é¢å¯¹çš„å°±æ˜¯çª—å£èšåˆä¹‹åçš„æ•°æ®æµï¼Œè€Œçª—å£å·²ç»ä¸å­˜åœ¨äº†ï¼›é‚£åˆ°åº•ä»€ä¹ˆæ—¶å€™ä¼šæ”¶é›†é½æ‰€æœ‰æ•°æ®å‘¢ï¼Ÿè¿™é—®é¢˜å¬èµ·æ¥ä¼¼ä¹æœ‰äº›æ²¡é“ç†ã€‚æˆ‘ä»¬ç»Ÿè®¡æµè§ˆé‡çš„çª—å£å·²ç»å…³é—­ï¼Œå°±è¯´æ˜äº†å½“å‰å·²ç»åˆ°äº†è¦è¾“å‡ºç»“æœçš„æ—¶å€™ï¼Œç›´æ¥è¾“å‡ºä¸å°±è¡Œäº†å—ï¼Ÿ æ²¡æœ‰è¿™ä¹ˆç®€å•ã€‚å› ä¸ºæ•°æ®æµä¸­çš„å…ƒç´ æ˜¯é€ä¸ªåˆ°æ¥çš„ï¼Œæ‰€ä»¥å³ä½¿ç†è®ºä¸Šæˆ‘ä»¬åº”è¯¥â€œåŒæ—¶â€æ”¶åˆ°å¾ˆå¤š url çš„æµè§ˆé‡ç»Ÿè®¡ç»“æœï¼Œå®é™…ä¹Ÿæ˜¯æœ‰å…ˆåçš„ã€åªèƒ½ä¸€æ¡ä¸€æ¡å¤„ç†ã€‚ä¸‹æ¸¸ä»»åŠ¡ï¼ˆå°±æ˜¯æˆ‘ä»¬å®šä¹‰çš„ KeyedProcessFunctionï¼‰çœ‹åˆ°ä¸€ä¸ª url çš„ç»Ÿè®¡ç»“æœï¼Œå¹¶ä¸èƒ½ä¿è¯è¿™ä¸ªæ—¶é—´æ®µçš„ç»Ÿè®¡æ•°æ®ä¸ä¼šå†æ¥äº†ï¼Œæ‰€ä»¥ä¹Ÿä¸èƒ½è´¸ç„¶è¿›è¡Œæ’åºè¾“å‡ºã€‚è§£å†³çš„åŠæ³•ï¼Œè‡ªç„¶å°±æ˜¯è¦ç­‰æ‰€æœ‰æ•°æ®åˆ°é½äº†â€”â€”è¿™å¾ˆå®¹æ˜“è®©æˆ‘ä»¬è”æƒ³èµ·æ°´ä½çº¿è®¾ç½®å»¶è¿Ÿæ—¶é—´çš„æ–¹æ³•ã€‚è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥â€œå¤šç­‰ä¸€ä¼šå„¿â€ï¼Œç­‰åˆ°æ°´ä½çº¿çœŸæ­£è¶…è¿‡äº†çª—å£ç»“æŸæ—¶é—´ï¼Œè¦ç»Ÿè®¡çš„æ•°æ®å°±è‚¯å®šåˆ°é½äº†ã€‚ å…·ä½“å®ç°ä¸Šï¼Œå¯ä»¥é‡‡ç”¨ä¸€ä¸ªå»¶è¿Ÿè§¦å‘çš„äº‹ä»¶æ—¶é—´å®šæ—¶å™¨ã€‚åŸºäºçª—å£çš„ç»“æŸæ—¶é—´æ¥è®¾å®šå»¶è¿Ÿï¼Œå…¶å®å¹¶ä¸éœ€è¦ç­‰å¤ªä¹…â€”â€”å› ä¸ºæˆ‘ä»¬æ˜¯é æ°´ä½çº¿çš„æ¨è¿›æ¥è§¦å‘å®šæ—¶å™¨ï¼Œè€Œæ°´ä½çº¿çš„å«ä¹‰å°±æ˜¯â€œä¹‹å‰çš„æ•°æ®éƒ½åˆ°é½äº†â€ã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è®¾ç½® 1 æ¯«ç§’çš„å»¶è¿Ÿï¼Œå°±ä¸€å®šå¯ä»¥ä¿è¯è¿™ä¸€ç‚¹ã€‚ è€Œåœ¨ç­‰å¾…è¿‡ç¨‹ä¸­ï¼Œä¹‹å‰å·²ç»åˆ°è¾¾çš„æ•°æ®åº”è¯¥ç¼“å­˜èµ·æ¥ï¼Œæˆ‘ä»¬è¿™é‡Œç”¨ä¸€ä¸ªè‡ªå®šä¹‰çš„â€œåˆ—è¡¨çŠ¶æ€â€ï¼ˆListStateï¼‰æ¥è¿›è¡Œå­˜å‚¨ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚è¿™ä¸ªçŠ¶æ€éœ€è¦ä½¿ç”¨å¯Œå‡½æ•°ç±»çš„ getRuntimeContext()æ–¹æ³•è·å–è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ¥å®šä¹‰ï¼Œæˆ‘ä»¬ä¸€èˆ¬æŠŠå®ƒæ”¾åœ¨ open()ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸­ã€‚ä¹‹åæ¯æ¥ä¸€ä¸ªUrlViewCountï¼Œå°±æŠŠå®ƒæ·»åŠ åˆ°å½“å‰çš„åˆ—è¡¨çŠ¶æ€ä¸­ï¼Œå¹¶æ³¨å†Œä¸€ä¸ªè§¦å‘æ—¶é—´ä¸ºçª—å£ç»“æŸæ—¶é—´åŠ  1æ¯«ç§’ï¼ˆwindowEnd + 1ï¼‰çš„å®šæ—¶å™¨ã€‚å¾…åˆ°æ°´ä½çº¿åˆ°è¾¾è¿™ä¸ªæ—¶é—´ï¼Œå®šæ—¶å™¨è§¦å‘ï¼Œæˆ‘ä»¬å¯ä»¥ä¿è¯å½“å‰çª—å£æ‰€æœ‰ url çš„ç»Ÿè®¡ç»“æœ UrlViewCount éƒ½åˆ°é½äº†ï¼›äºæ˜¯ä»çŠ¶æ€ä¸­å–å‡ºè¿›è¡Œæ’åºè¾“å‡ºã€‚ import org.apache.flink.api.common.eventtime.SerializableTimestampAssigner; import org.apache.flink.api.common.eventtime.WatermarkStrategy; import org.apache.flink.api.common.functions.AggregateFunction; import org.apache.flink.api.common.state.ListState; import org.apache.flink.api.common.state.ListStateDescriptor; import org.apache.flink.api.common.typeinfo.Types; import org.apache.flink.configuration.Configuration; import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.streaming.api.functions.KeyedProcessFunction; import org.apache.flink.streaming.api.functions.windowing.ProcessWindowFunction; import org.apache.flink.streaming.api.windowing.assigners.SlidingEventTimeWindows; import org.apache.flink.streaming.api.windowing.time.Time; import org.apache.flink.streaming.api.windowing.windows.TimeWindow; import org.apache.flink.util.Collector; import java.sql.Timestamp; import java.util.ArrayList; import java.util.Comparator; public class KeyedProcessTopN { public static void main(String[] args) throws Exception { StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); env.setParallelism(1); // ä»è‡ªå®šä¹‰æ•°æ®æºè¯»å–æ•°æ® SingleOutputStreamOperator&lt;Event&gt; eventStream = env.addSource(new ClickSource()) .assignTimestampsAndWatermarks(WatermarkStrategy.&lt;Event&gt;forMonotonousTimestamps() .withTimestampAssigner(new SerializableTimestampAssigner&lt;Event&gt;() { @Override public long extractTimestamp(Event element, long recordTimestamp) { return element.timestamp; } })); // éœ€è¦æŒ‰ç…§ url åˆ†ç»„ï¼Œæ±‚å‡ºæ¯ä¸ª url çš„è®¿é—®é‡ SingleOutputStreamOperator&lt;UrlViewCount&gt; urlCountStream = eventStream.keyBy(data -&gt; data.url) .window(SlidingEventTimeWindows.of(Time.seconds(10), Time.seconds(5))) .aggregate(new UrlViewCountAgg(), new UrlViewCountResult()); // å¯¹ç»“æœä¸­åŒä¸€ä¸ªçª—å£çš„ç»Ÿè®¡æ•°æ®ï¼Œè¿›è¡Œæ’åºå¤„ç† SingleOutputStreamOperator&lt;String&gt; result = urlCountStream.keyBy(data -&gt; data.windowEnd) .process(new TopN(2)); result.print(&quot;result&quot;); env.execute(); } // è‡ªå®šä¹‰å¢é‡èšåˆ public static class UrlViewCountAgg implements AggregateFunction&lt;Event, Long, Long&gt; { @Override public Long createAccumulator() { return 0L; } @Override public Long add(Event value, Long accumulator) { return accumulator + 1; } @Override public Long getResult(Long accumulator) { return accumulator; } @Override public Long merge(Long a, Long b) { return null; } } // è‡ªå®šä¹‰å…¨çª—å£å‡½æ•°ï¼Œåªéœ€è¦åŒ…è£…çª—å£ä¿¡æ¯ public static class UrlViewCountResult extends ProcessWindowFunction&lt;Long, UrlViewCount, String, TimeWindow&gt; { @Override public void process(String url, Context context, Iterable&lt;Long&gt; elements, Collector&lt;UrlViewCount&gt; out) throws Exception { // ç»“åˆçª—å£ä¿¡æ¯ï¼ŒåŒ…è£…è¾“å‡ºå†…å®¹ Long start = context.window().getStart(); Long end = context.window().getEnd(); out.collect(new UrlViewCount(url, elements.iterator().next(), start, end)); } } // è‡ªå®šä¹‰å¤„ç†å‡½æ•°ï¼Œæ’åºå– top n public static class TopN extends KeyedProcessFunction&lt;Long, UrlViewCount, String&gt; { // å°† n ä½œä¸ºå±æ€§ private Integer n; // å®šä¹‰ä¸€ä¸ªåˆ—è¡¨çŠ¶æ€ private ListState&lt;UrlViewCount&gt; urlViewCountListState; public TopN(Integer n) { this.n = n; } @Override public void open(Configuration parameters) throws Exception { // ä»ç¯å¢ƒä¸­è·å–åˆ—è¡¨çŠ¶æ€å¥æŸ„ urlViewCountListState = getRuntimeContext().getListState( new ListStateDescriptor&lt;UrlViewCount&gt;(&quot;url-view-count-list&quot;, Types.POJO(UrlViewCount.class))); } @Override public void processElement(UrlViewCount value, Context ctx, Collector&lt;String&gt; out) throws Exception { // å°† count æ•°æ®æ·»åŠ åˆ°åˆ—è¡¨çŠ¶æ€ä¸­ï¼Œä¿å­˜èµ·æ¥ urlViewCountListState.add(value); // æ³¨å†Œ window end + 1ms åçš„å®šæ—¶å™¨ï¼Œç­‰å¾…æ‰€æœ‰æ•°æ®åˆ°é½å¼€å§‹æ’åº ctx.timerService().registerEventTimeTimer(ctx.getCurrentKey() + 1); } @Override public void onTimer(long timestamp, OnTimerContext ctx, Collector&lt;String&gt; out) throws Exception { // å°†æ•°æ®ä»åˆ—è¡¨çŠ¶æ€å˜é‡ä¸­å–å‡ºï¼Œæ”¾å…¥ ArrayListï¼Œæ–¹ä¾¿æ’åº ArrayList&lt;UrlViewCount&gt; urlViewCountArrayList = new ArrayList&lt;&gt;(); for (UrlViewCount urlViewCount : urlViewCountListState.get()) { urlViewCountArrayList.add(urlViewCount); } // æ¸…ç©ºçŠ¶æ€ï¼Œé‡Šæ”¾èµ„æº urlViewCountListState.clear(); // æ’åº urlViewCountArrayList.sort(new Comparator&lt;UrlViewCount&gt;() { @Override public int compare(UrlViewCount o1, UrlViewCount o2) { return o2.count.intValue() - o1.count.intValue(); } }); // å–å‰ä¸¤åï¼Œæ„å»ºè¾“å‡ºç»“æœ StringBuilder result = new StringBuilder(); result.append(&quot;========================================\\n&quot;); result.append(&quot;çª—å£ç»“æŸæ—¶é—´ï¼š&quot; + new Timestamp(timestamp - 1) + &quot;\\n&quot;); for (int i = 0; i &lt; this.n; i++) { UrlViewCount UrlViewCount = urlViewCountArrayList.get(i); String info = &quot;No.&quot; + (i + 1) + &quot; &quot; + &quot;urlï¼š&quot; + UrlViewCount.url + &quot; &quot; + &quot;æµè§ˆé‡ï¼š&quot; + UrlViewCount.count + &quot;\\n&quot;; result.append(info); } result.append(&quot;========================================\\n&quot;); out.collect(result.toString()); } } } ä»£ç ä¸­ï¼Œæˆ‘ä»¬è¿˜åˆ©ç”¨äº†å®šæ—¶å™¨çš„ç‰¹æ€§ï¼šé’ˆå¯¹åŒä¸€ keyã€åŒä¸€æ—¶é—´æˆ³ä¼šè¿›è¡Œå»é‡ã€‚æ‰€ä»¥å¯¹äºåŒä¸€ä¸ªçª—å£è€Œè¨€ï¼Œæˆ‘ä»¬æ¥åˆ°ç»Ÿè®¡ç»“æœæ•°æ®åè®¾å®šçš„ windowEnd + 1 çš„å®šæ—¶å™¨éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæœ€ç»ˆåªä¼šè§¦å‘ä¸€æ¬¡è®¡ç®—ã€‚è€Œå¯¹äºä¸åŒçš„ keyï¼ˆè¿™é‡Œ key æ˜¯ windowEndï¼‰ï¼Œå®šæ—¶å™¨å’ŒçŠ¶æ€éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿä¸ç”¨æ‹…å¿ƒä¸åŒçª—å£é—´æ•°æ®çš„å¹²æ‰°ã€‚ æˆ‘ä»¬åœ¨ä¸Šé¢çš„ä»£ç ä¸­ä½¿ç”¨äº†åé¢è¦è®²è§£çš„ ListStateã€‚è¿™é‡Œå¯ä»¥å…ˆç®€å•è¯´æ˜ä¸€ä¸‹ã€‚æˆ‘ä»¬å…ˆå£°æ˜ä¸€ä¸ªåˆ—è¡¨çŠ¶æ€å˜é‡: private ListState&lt;Event&gt; UrlViewCountListState; ç„¶ååœ¨ open æ–¹æ³•ä¸­åˆå§‹åŒ–äº†åˆ—è¡¨çŠ¶æ€å˜é‡ï¼Œæˆ‘ä»¬åˆå§‹åŒ–çš„æ—¶å€™ä½¿ç”¨äº† ListStateDescriptoræè¿°ç¬¦ï¼Œè¿™ä¸ªæè¿°ç¬¦ç”¨æ¥å‘Šè¯‰ Flink åˆ—è¡¨çŠ¶æ€å˜é‡çš„åå­—å’Œç±»å‹ã€‚åˆ—è¡¨çŠ¶æ€å˜é‡æ˜¯å•ä¾‹ï¼Œä¹Ÿå°±æ˜¯è¯´åªä¼šè¢«å®ä¾‹åŒ–ä¸€æ¬¡ã€‚è¿™ä¸ªåˆ—è¡¨çŠ¶æ€å˜é‡çš„ä½œç”¨åŸŸæ˜¯å½“å‰ key æ‰€å¯¹åº”çš„é€»è¾‘åˆ†åŒºã€‚æˆ‘ä»¬ä½¿ç”¨add æ–¹æ³•å‘åˆ—è¡¨çŠ¶æ€å˜é‡ä¸­æ·»åŠ æ•°æ®ï¼Œä½¿ç”¨ get æ–¹æ³•è¯»å–åˆ—è¡¨çŠ¶æ€å˜é‡ä¸­çš„æ‰€æœ‰å…ƒç´ ã€‚ ä¾§è¾“å‡ºæµï¼ˆSide Outputï¼‰ å¤„ç†å‡½æ•°è¿˜æœ‰å¦å¤–ä¸€ä¸ªç‰¹æœ‰åŠŸèƒ½ï¼Œå°±æ˜¯å°†è‡ªå®šä¹‰çš„æ•°æ®æ”¾å…¥â€œä¾§è¾“å‡ºæµâ€ï¼ˆside outputï¼‰è¾“å‡ºã€‚è¿™ä¸ªæ¦‚å¿µæˆ‘ä»¬å¹¶ä¸é™Œç”Ÿï¼Œä¹‹å‰åœ¨è®²åˆ°çª—å£å¤„ç†è¿Ÿåˆ°æ•°æ®æ—¶ï¼Œæœ€åä¸€æ‹›å°±æ˜¯è¾“å‡ºåˆ°ä¾§è¾“å‡ºæµã€‚è€Œè¿™ç§å¤„ç†æ–¹å¼çš„æœ¬è´¨ï¼Œå…¶å®å°±æ˜¯å¤„ç†å‡½æ•°çš„ä¾§è¾“å‡ºæµåŠŸèƒ½ã€‚ æˆ‘ä»¬ä¹‹å‰è®²åˆ°çš„ç»å¤§å¤šæ•°è½¬æ¢ç®—å­ï¼Œè¾“å‡ºçš„éƒ½æ˜¯å•ä¸€æµï¼Œæµé‡Œçš„æ•°æ®ç±»å‹åªèƒ½æœ‰ä¸€ç§ã€‚è€Œä¾§è¾“å‡ºæµå¯ä»¥è®¤ä¸ºæ˜¯â€œä¸»æµâ€ä¸Šåˆ†å‰å‡ºçš„â€œæ”¯æµâ€ï¼Œæ‰€ä»¥å¯ä»¥ç”±ä¸€æ¡æµäº§ç”Ÿå‡ºå¤šæ¡æµï¼Œè€Œä¸”è¿™äº›æµä¸­çš„æ•°æ®ç±»å‹è¿˜å¯ä»¥ä¸ä¸€æ ·ã€‚åˆ©ç”¨è¿™ä¸ªåŠŸèƒ½å¯ä»¥å¾ˆå®¹æ˜“åœ°å®ç°â€œåˆ†æµâ€æ“ä½œã€‚ å…·ä½“åº”ç”¨æ—¶ï¼Œåªè¦åœ¨å¤„ç†å‡½æ•°çš„.processElement()æˆ–è€….onTimer()æ–¹æ³•ä¸­ï¼Œè°ƒç”¨ä¸Šä¸‹æ–‡çš„.output()æ–¹æ³•å°±å¯ä»¥äº†ã€‚ DataStream&lt;Integer&gt; stream = env.addSource(...); SingleOutputStreamOperator&lt;Long&gt; longStream = stream.process(new ProcessFunction&lt;Integer, Long&gt;() { @Override public void processElement( Integer value, Context ctx, Collector&lt;Integer&gt; out) throws Exception { // è½¬æ¢æˆ Longï¼Œè¾“å‡ºåˆ°ä¸»æµä¸­ out.collect(Long.valueOf(value)); // è½¬æ¢æˆ Stringï¼Œè¾“å‡ºåˆ°ä¾§è¾“å‡ºæµä¸­ ctx.output(outputTag, &quot;side-output: &quot; + String.valueOf(value)); } }); è¿™é‡Œ output()æ–¹æ³•éœ€è¦ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯ä¸€ä¸ªâ€œè¾“å‡ºæ ‡ç­¾â€OutputTagï¼Œç”¨æ¥æ ‡è¯†ä¾§è¾“å‡ºæµï¼Œä¸€èˆ¬ä¼šåœ¨å¤–éƒ¨ç»Ÿä¸€å£°æ˜ï¼›ç¬¬äºŒä¸ªå°±æ˜¯è¦è¾“å‡ºçš„æ•°æ®ã€‚ æˆ‘ä»¬å¯ä»¥åœ¨å¤–éƒ¨å…ˆå°† OutputTag å£°æ˜å‡ºæ¥ï¼š OutputTag&lt;String&gt; outputTag = new OutputTag&lt;String&gt;(&quot;side-output&quot;) {}; å¦‚æœæƒ³è¦è·å–è¿™ä¸ªä¾§è¾“å‡ºæµï¼Œå¯ä»¥åŸºäºå¤„ç†ä¹‹åçš„ DataStream ç›´æ¥è°ƒç”¨.getSideOutput()æ–¹æ³•ï¼Œä¼ å…¥å¯¹åº”çš„ OutputTagï¼Œè¿™ä¸ªæ–¹å¼ä¸çª—å£ API ä¸­è·å–ä¾§è¾“å‡ºæµæ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚ DataStream&lt;String&gt; stringStream = longStream.getSideOutput(outputTag); ","link":"https://tianxiawuhao.github.io/cctea1w9G/"},{"title":"ç¬¬ä¸ƒç«  flinkæµåˆå¹¶","content":"å¤šæµè½¬æ¢ æ— è®ºæ˜¯åŸºæœ¬çš„ç®€å•è½¬æ¢å’Œèšåˆï¼Œ è¿˜æ˜¯åŸºäºçª—å£çš„è®¡ç®—ï¼Œéƒ½æ˜¯é’ˆå¯¹ä¸€æ¡æµä¸Šçš„æ•°æ®è¿›è¡Œ å¤„ç†çš„ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œ å¯èƒ½éœ€è¦å°†ä¸åŒæ¥æºçš„æ•°æ®è¿æ¥åˆå¹¶åœ¨ä¸€èµ·å¤„ç†ï¼Œ ä¹Ÿæœ‰å¯èƒ½éœ€è¦å°† ä¸€æ¡æµæ‹†åˆ†å¼€ï¼Œ æ‰€ä»¥ç»å¸¸ä¼šæœ‰å¯¹å¤šæ¡æµè¿›è¡Œå¤„ç†çš„åœºæ™¯ã€‚ç®€å•åˆ’åˆ†ï¼Œå¤šæµè½¬æ¢å¯ä»¥åˆ†ä¸ºâ€œåˆ†æµâ€å’Œâ€œåˆæµâ€ä¸¤å¤§ç±»ã€‚ç›®å‰åˆ†æµçš„æ“ä½œä¸€èˆ¬æ˜¯é€š è¿‡ä¾§è¾“å‡ºæµ(side output) æ¥å®ç°ï¼Œè€Œåˆæµçš„ç®—å­æ¯”è¾ƒä¸°å¯Œï¼Œæ ¹æ®ä¸åŒçš„éœ€æ±‚å¯ä»¥è°ƒç”¨ unionã€ connectã€join ä»¥åŠ coGroup ç­‰æ¥å£è¿›è¡Œè¿æ¥åˆå¹¶æ“ä½œã€‚ ä¾§è¾“å‡ºæµ ç®€å•æ¥è¯´ï¼Œåªéœ€è¦è°ƒç”¨ä¸Šä¸‹æ–‡ ctxçš„output()æ–¹æ³•ï¼Œå°±å¯ä»¥è¾“å‡ºä»»æ„ç±»å‹çš„æ•°æ®äº†ã€‚è€Œä¾§è¾“å‡ºæµçš„æ ‡è®°å’Œæå–ï¼Œ éƒ½ç¦»ä¸å¼€ä¸€ä¸ªâ€œè¾“å‡ºæ ‡ç­¾â€(OutputTag)ï¼ŒæŒ‡å®šäº†ä¾§è¾“å‡ºæµçš„ id å’Œç±»å‹ã€‚ ä»£ç ç¤ºä¾‹ï¼š package com.company.flink.demo; import com.company.flink.data.ClickSource; import com.company.flink.entity.Event; import org.apache.flink.api.java.tuple.Tuple3; import org.apache.flink.streaming.api.datastream.DataStream; import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.streaming.api.functions.ProcessFunction; import org.apache.flink.util.Collector; import org.apache.flink.util.OutputTag; public class SplitStreamDemo { // å®šä¹‰ä¾§è¾“å‡ºæµ private static OutputTag&lt;Tuple3&lt;String, String, Long&gt;&gt; zhangsanTag = new OutputTag&lt;Tuple3&lt;String, String, Long&gt;&gt;(&quot;zhangsan-pv&quot;){}; private static OutputTag&lt;Tuple3&lt;String, String, Long&gt;&gt; lisiTag = new OutputTag&lt;Tuple3&lt;String, String, Long&gt;&gt;(&quot;lisi-pv&quot;){}; public static void main(String[] args) throws Exception { StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); SingleOutputStreamOperator&lt;Event&gt; stream = env .addSource(new ClickSource()); SingleOutputStreamOperator&lt;Event&gt; outPutStream = stream.process( new ProcessFunction&lt;Event, Event&gt;() { @Override public void processElement(Event value, Context ctx, Collector&lt;Event&gt; out) { if (value.user.equals(&quot;zhangsan&quot;)) { ctx.output(zhangsanTag, new Tuple3&lt;&gt;(value.user, value.url, value.timestamp)); } else if (value.user.equals(&quot;lisi&quot;)) { ctx.output(lisiTag, new Tuple3&lt;&gt;(value.user, value.url, value.timestamp)); } else { out.collect(value); } } }); DataStream&lt;Tuple3&lt;String, String, Long&gt;&gt; zhangsanSideOutput = outPutStream.getSideOutput(zhangsanTag); zhangsanSideOutput.print(&quot;zhangsan pv&quot;); DataStream&lt;Tuple3&lt;String, String, Long&gt;&gt; lisiSideOutput = outPutStream.getSideOutput(lisiTag); lisiSideOutput.print(&quot;lisi pv&quot;); outPutStream.print(&quot;else&quot;); env.execute(); } } åˆæµæ“ä½œ Flink ä¸­åˆæµçš„æ“ä½œä¼šæ›´åŠ æ™®éï¼Œå¯¹åº”çš„ API ä¹Ÿæ›´åŠ ä¸°å¯Œã€‚ 1ï¼‰è”åˆ(Union) â€‹ æœ€ç®€å•çš„åˆæµæ“ä½œï¼Œ å°±æ˜¯ç›´æ¥å°†å¤šæ¡æµåˆåœ¨ä¸€èµ·ï¼Œå«ä½œæµâ€œè”åˆâ€(union)ã€‚è”åˆæ“ä½œè¦æ±‚å¿…é¡»æµä¸­çš„æ•°æ®ç±»å‹å¿…é¡»ç›¸åŒï¼Œåˆå¹¶ä¹‹åçš„æ–°æµä¼šåŒ…æ‹¬æ‰€æœ‰æµä¸­çš„å…ƒç´ ï¼Œ æ•°æ®ç±»å‹ä¸å˜ã€‚ 2ï¼‰è¿æ¥ï¼ˆConnectï¼‰ â€‹ æµçš„è”åˆè™½ç„¶ç®€å•ï¼Œä¸è¿‡å—é™äºæ•°æ®ç±»å‹ä¸èƒ½æ”¹å˜ï¼Œçµæ´»æ€§ä¸è¶³ï¼Œå®è·µä¸­è¾ƒå°‘ä½¿ç”¨ã€‚é™¤äº†è”åˆï¼ˆunionï¼‰ï¼ŒFlink è¿˜æä¾›äº†å¦å¤–ä¸€ç§åˆæµæ“ä½œå°±æ˜¯è¿æ¥ï¼ˆconnectï¼‰ã€‚è¿™ç§æ“ä½œå°±æ˜¯ç›´æ¥æŠŠä¸¤æ¡æµåƒæ¥çº¿ä¸€æ ·å¯¹æ¥èµ·æ¥ã€‚ â€‹ ä¸ºäº†å¤„ç†æ›´åŠ çµæ´»ï¼Œè¿æ¥æ“ä½œå…è®¸æµçš„æ•°æ®ç±»å‹ä¸åŒã€‚ä½†ä¸€ä¸ª DataStream ä¸­çš„æ•°æ®ç±»å‹æ˜¯å”¯ä¸€çš„ï¼ˆæ‰€ä»¥éœ€è¦ï¼ˆco-processï¼‰è½¬æ¢æ“ä½œï¼‰ åŸºäºæ—¶é—´çš„åˆæµâ€”â€”åŒæµè”ç»“(Join) å¯¹äºä¸¤æ¡æµçš„åˆå¹¶ï¼Œå¾ˆå¤šæƒ…å†µå¹¶ä¸æ˜¯ç®€å•åœ°å°†æ‰€æœ‰æ•°æ®æ”¾åœ¨ä¸€èµ·ï¼Œè€Œæ˜¯å¸Œæœ›æ ¹æ®æŸä¸ªå­—æ®µçš„å€¼å°†å®ƒä»¬è”ç»“èµ·æ¥â€œé…å¯¹â€åšå¤„ç†ã€‚ è¿™ç§éœ€æ±‚ä¸å…³ç³»å‹æ•°æ®åº“ä¸­è¡¨çš„join æ“ä½œéå¸¸ç›¸ä¼¼ã€‚Flink ä¸­ä¸¤æ¡æµ çš„ connect æ“ä½œï¼Œå°±å¯ä»¥é€šè¿‡ keyBy æŒ‡å®šé”®è¿›è¡Œåˆ†ç»„ååˆå¹¶ï¼Œå®ç°äº†ç±»ä¼¼äº SQL ä¸­çš„ join æ“ä½œï¼› å¦å¤– connect æ”¯æŒå¤„ç†å‡½æ•°ï¼Œå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çŠ¶æ€å’Œ TimerService çµæ´»å®ç°å„ç§éœ€æ±‚ã€‚ 1ï¼‰çª—å£è”ç»“(Window Join) â€‹ çª—å£è”ç»“é¦–å…ˆéœ€è¦è°ƒç”¨ DataStream çš„.join()æ–¹æ³•æ¥åˆå¹¶ä¸¤æ¡æµï¼Œ å¾—åˆ°ä¸€ ä¸ª ã€JoinedStreams ï¼›æ¥ç€é€šè¿‡ .where() å’Œ.equalTo() æ–¹æ³•æŒ‡å®šä¸¤æ¡æµä¸­è”ç»“çš„ key ï¼›ç„¶åé€š è¿‡.window()å¼€çª—å£ï¼Œ å¹¶è°ƒç”¨.apply()ä¼ å…¥è”ç»“çª—å£å‡½æ•°è¿›è¡Œå¤„ç†è®¡ç®—ã€‚è°ƒç”¨å½¢å¼å¦‚ä¸‹ï¼š SingleOutputStreamOperator&lt;Event&gt; eventStream = env.addSource(new ClickSource()) .join(DataStream otherStream) .where(KeySelector keySelector) .equalTo(KeySelector keySelector) .window(WindowAssigner assigner) .apply(JoinFunction function) ä¸Šé¢ä»£ç ä¸­.where()çš„å‚æ•°æ˜¯é”®é€‰æ‹©å™¨(KeySelector)ï¼Œ ç”¨æ¥æŒ‡å®šç¬¬ä¸€æ¡æµä¸­çš„ key ï¼›è€Œ.equalTo()ä¼ å…¥çš„ KeySelector åˆ™æŒ‡å®šäº†ç¬¬äºŒæ¡æµä¸­çš„ keyã€‚ä¸¤è€…ç›¸åŒçš„å…ƒç´ ï¼Œå¦‚æœåœ¨åŒä¸€çª—å£ä¸­ï¼Œ å°±å¯ä»¥åŒ¹é…èµ·æ¥ï¼Œ å¹¶é€šè¿‡ä¸€ä¸ªâ€œè”ç»“å‡½æ•°â€(JoinFunction) è¿›è¡Œå¤„ç†ã€‚è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œ JoinFunciton å¹¶ä¸æ˜¯çœŸæ­£çš„â€œçª—å£å‡½æ•°â€ï¼Œå®ƒåªæ˜¯å®šä¹‰äº†çª—å£å‡½æ•°åœ¨è°ƒç”¨æ—¶ å¯¹åŒ¹é…æ•°æ®çš„å…·ä½“å¤„ç†é€»è¾‘ã€‚ ä¸¤æ¡æµçš„æ•°æ®åˆ°æ¥ä¹‹åï¼Œ é¦–å…ˆä¼šæŒ‰ç…§ key åˆ†ç»„ã€è¿›å…¥å¯¹åº”çš„çª—å£ä¸­å­˜å‚¨ï¼›å½“åˆ°è¾¾çª—å£ç»“æŸæ—¶é—´æ—¶ï¼Œç®—å­ä¼šå…ˆç»Ÿè®¡å‡ºçª—å£å†…ä¸¤æ¡æµçš„æ•°æ®çš„æ‰€æœ‰ç»„åˆï¼Œä¹Ÿå°±æ˜¯å¯¹ä¸¤æ¡æµä¸­çš„æ•°æ®åšä¸€ä¸ªç¬›å¡å°”ç§¯(ç›¸å½“äºè¡¨çš„äº¤å‰è¿æ¥ï¼Œ cross join)ï¼Œç„¶åè¿›è¡Œéå†ï¼ŒæŠŠæ¯ä¸€å¯¹åŒ¹é…çš„æ•°æ®ï¼Œ ä½œä¸ºå‚æ•° (first ï¼Œsecond)ä¼ å…¥ JoinFunction çš„.join()æ–¹æ³•è¿›è¡Œè®¡ç®—å¤„ç†ã€‚æ‰€ä»¥çª—å£ä¸­æ¯æœ‰ä¸€å¯¹æ•°æ®æˆåŠŸè”ç»“åŒ¹é…ï¼Œ JoinFunction çš„.join()æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œ å¹¶è¾“ å‡ºä¸€ä¸ªç»“æœã€‚ çª—å£joinçš„è°ƒç”¨å’ŒSQLä¸­è¡¨çš„joinéå¸¸ç›¸ä¼¼ã€‚SQLçš„ inner join ... onæœ¬èº«è¡¨ç¤ºçš„æ˜¯ä¸¤å¼ è¡¨åŸºäº id çš„â€œå†…è¿æ¥â€(inner join)ã€‚è€Œ Flink ä¸­çš„ window joinï¼ŒåŒæ ·ç±»ä¼¼äº inner joinã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæœ€å å¤„ç†è¾“å‡ºçš„ï¼Œåªæœ‰ä¸¤æ¡æµä¸­æ•°æ®æŒ‰ key é…å¯¹æˆåŠŸçš„é‚£äº›ï¼›å¦‚æœæŸä¸ªçª—å£ä¸­ä¸€æ¡æµçš„æ•°æ®æ²¡æœ‰ä»» ä½•å¦ä¸€æ¡æµçš„æ•°æ®åŒ¹é…ï¼Œ é‚£ä¹ˆå°±ä¸ä¼šè°ƒç”¨ JoinFunction çš„.join()æ–¹æ³•ï¼Œ ä¹Ÿå°±æ²¡æœ‰ä»»ä½•è¾“å‡ºã€‚ ä»£ç ç¤ºåˆ—ï¼š package com.company.flink.demo; import org.apache.flink.api.common.eventtime.SerializableTimestampAssigner; import org.apache.flink.api.common.eventtime.WatermarkStrategy; import org.apache.flink.api.common.functions.JoinFunction; import org.apache.flink.api.java.tuple.Tuple2; import org.apache.flink.streaming.api.datastream.DataStream; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.streaming.api.windowing.assigners.TumblingEventTimeWindows; import org.apache.flink.streaming.api.windowing.time.Time; public class FlinkWindowJoinDemo { public static void main(String[] args) throws Exception { StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); env.setParallelism(1); DataStream&lt;Tuple2&lt;String, Long&gt;&gt; stream1 = env .fromElements( Tuple2.of(&quot;a&quot;, 1000L), Tuple2.of(&quot;a&quot;, 2000L), Tuple2.of(&quot;b&quot;, 1000L), Tuple2.of(&quot;b&quot;, 2000L), Tuple2.of(&quot;c&quot;, 5000L) ) .assignTimestampsAndWatermarks( WatermarkStrategy .&lt;Tuple2&lt;String, Long&gt;&gt;forMonotonousTimestamps().withTimestampAssigner( (SerializableTimestampAssigner&lt;Tuple2&lt;String, Long&gt;&gt;) (stringLongTuple2, l) -&gt; stringLongTuple2.f1 ) ); DataStream&lt;Tuple2&lt;String, Long&gt;&gt; stream2 = env .fromElements( Tuple2.of(&quot;a&quot;, 3000L), Tuple2.of(&quot;a&quot;, 4000L), Tuple2.of(&quot;b&quot;, 3000L), Tuple2.of(&quot;b&quot;, 4000L) ) .assignTimestampsAndWatermarks( WatermarkStrategy .&lt;Tuple2&lt;String, Long&gt;&gt;forMonotonousTimestamps().withTimestampAssigner( (SerializableTimestampAssigner&lt;Tuple2&lt;String, Long&gt;&gt;) (stringLongTuple2, l) -&gt; stringLongTuple2.f1 ) ); stream1 .join(stream2) .where(r -&gt; r.f0) .equalTo(r -&gt; r.f0) .window(TumblingEventTimeWindows.of(Time.seconds(5))) .apply((JoinFunction&lt;Tuple2&lt;String, Long&gt;, Tuple2&lt;String, Long&gt;, String&gt;) (left, right) -&gt; left + &quot;=&gt;&quot; + right) .print(); env.execute(); } } 2ï¼‰é—´éš”è”ç»“(Interval Join) åœ¨ä¸€äº›åœºæ™¯ä¸‹ï¼Œ å¤„ç†çš„æ—¶é—´é—´éš”å¯èƒ½å¹¶ä¸æ˜¯å›ºå®šçš„ã€‚æ¯”å¦‚ï¼Œ åœ¨äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œ éœ€è¦å®æ—¶åœ°å¯¹æ¯ä¸€ç¬”äº¤æ˜“è¿›è¡Œæ ¸éªŒï¼Œä¿è¯ä¸¤ä¸ªè´¦æˆ·è½¬å…¥è½¬å‡ºæ•°é¢ç›¸ç­‰ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„â€œå®æ—¶å¯¹è´¦â€ã€‚ ä¸¤æ¬¡è½¬è´¦çš„æ•°æ®å¯èƒ½å†™å…¥äº†ä¸åŒçš„æ—¥å¿—æµï¼Œå®ƒä»¬çš„æ—¶é—´æˆ³ç›¸å·®ä¸å¤§ï¼Œæ‰€ä»¥å¯ä»¥è€ƒè™‘åªç»Ÿè®¡ä¸€æ®µæ—¶é—´å†…æ˜¯å¦æœ‰å‡ºè´¦å…¥è´¦çš„æ•°æ®åŒ¹é…ã€‚è¿™æ—¶æ˜¾ç„¶ä¸èƒ½ç”¨æ»šåŠ¨çª—å£æˆ–æ»‘åŠ¨çª—å£æ¥å¤„ç†å› ä¸ºåŒ¹é…çš„ä¸¤ä¸ªæ•°æ®æœ‰å¯èƒ½åˆšå¥½åœ¨çª—å£è¾¹ç¼˜ä¸¤ä¾§ï¼Œè¿™æ—¶çª—å£å†…å°±éƒ½æ²¡æœ‰åŒ¹é…äº†ï¼›ä¼šè¯çª—å£è™½ç„¶æ—¶é—´ä¸å›ºå®šï¼Œä½†ä¹Ÿæ˜æ˜¾ä¸é€‚åˆè¿™ä¸ªåœºæ™¯ã€‚Flink ä¸ºè¿™ç§åœºæ™¯æä¾›äº†ä¸€ç§å«ä½œâ€œé—´éš”è”ç»“â€(interval join) çš„åˆæµæ“ä½œï¼Œé—´éš”è”ç»“çš„æ€è·¯å°±æ˜¯é’ˆå¯¹ä¸€æ¡æµçš„æ¯æ¡æ•°æ®ï¼Œå¼€è¾Ÿå‡ºå…¶æ—¶é—´æˆ³å‰åçš„ä¸€æ®µæ—¶é—´é—´éš”ï¼Œ çœ‹è¿™æœŸé—´æ˜¯å¦æœ‰æ¥è‡ªå¦ä¸€æ¡æµçš„æ•°æ®ä¸ä¹‹åŒ¹é…ã€‚ é—´éš”è¿æ¥åŸç†ï¼š ç»™å®šä¸¤ä¸ªæ—¶é—´ç‚¹ï¼Œåˆ†åˆ«å«ä½œé—´éš”çš„â€œä¸Šç•Œâ€(upperBound) å’Œâ€œä¸‹ç•Œâ€(lowerBound)ï¼›å¯¹äºä¸€æ¡æµA ä¸­çš„ä»»æ„ä¸€ä¸ªæ•°æ®å…ƒç´  aï¼Œå°±å¯ä»¥ å¼€è¾Ÿä¸€æ®µæ—¶é—´é—´éš”ï¼š [a.timestamp + lowerBound, a.timestamp + upperBoundï¼‰æŠŠè¿™æ®µæ—¶é—´ä½œä¸ºå¯ä»¥åŒ¹é…å¦ä¸€æ¡æµæ•°æ® çš„â€œçª—å£â€èŒƒå›´ã€‚æ‰€ä»¥å¯¹äºå¦ä¸€æ¡æµ B ä¸­çš„æ•°æ®å…ƒç´  bï¼Œå¦‚æœå®ƒçš„æ—¶é—´æˆ³è½åœ¨äº†è¿™ ä¸ªåŒºé—´èŒƒå›´å†…ï¼Œ a å’Œ b å°±å¯ä»¥æˆåŠŸé…å¯¹ï¼Œè¿›è€Œè¿›è¡Œè®¡ç®—è¾“å‡ºç»“æœã€‚æ‰€ä»¥åŒ¹é…çš„æ¡ä»¶ä¸ºï¼ša.timestamp + lowerBound &lt;= b.timestamp &lt;= a.timestamp + upperBound è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œ åšé—´éš”è”ç»“çš„ä¸¤æ¡æµ A å’Œ Bï¼Œä¹Ÿå¿…é¡»åŸºäºç›¸åŒçš„ keyï¼› é—´éš”è”ç»“ç›®å‰åªæ”¯æŒäº‹ä»¶æ—¶é—´è¯­ä¹‰ã€‚å¦‚å›¾æ‰€ç¤ºï¼š å¯ä»¥çœ‹åˆ°ï¼Œé—´éš”è”ç»“åŒæ ·æ˜¯ä¸€ç§å†…è¿æ¥(inner join)ã€‚ä¸çª—å£è”ç»“ä¸åŒçš„æ˜¯ï¼Œinterval join åšåŒ¹é…çš„æ—¶é—´æ®µæ˜¯åŸºäºæµä¸­æ•°æ®çš„å¹¶ä¸ç¡®å®šï¼› è€Œä¸”æµ B ä¸­çš„æ•°æ®å¯ä»¥ä¸åªåœ¨ä¸€ä¸ªåŒºé—´å†…è¢«åŒ¹é…ã€‚ ä»£ç ç¤ºåˆ—ï¼š package com.company.flink.demo; import com.company.flink.entity.Event; import org.apache.flink.api.common.eventtime.SerializableTimestampAssigner; import org.apache.flink.api.common.eventtime.WatermarkStrategy; import org.apache.flink.api.java.tuple.Tuple3; import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.streaming.api.functions.co.ProcessJoinFunction; import org.apache.flink.streaming.api.windowing.time.Time; import org.apache.flink.util.Collector; // åŸºäºé—´éš”çš„ join public class FlinkIntervalJoinDemo { public static void main(String[] args) throws Exception { StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); env.setParallelism(1); SingleOutputStreamOperator&lt;Tuple3&lt;String, String, Long&gt;&gt; orderStream = env.fromElements( Tuple3.of(&quot;Mary&quot;, &quot;order-1&quot;, 5000L), Tuple3.of(&quot;Alice&quot;, &quot;order-2&quot;, 5000L), Tuple3.of(&quot;Bob&quot;, &quot;order-3&quot;, 20000L), Tuple3.of(&quot;Alice&quot;, &quot;order-4&quot;, 20000L), Tuple3.of(&quot;Cary&quot;, &quot;order-5&quot;, 51000L) ).assignTimestampsAndWatermarks(WatermarkStrategy.&lt;Tuple3&lt;String, String, Long&gt;&gt;forMonotonousTimestamps() .withTimestampAssigner((SerializableTimestampAssigner&lt;Tuple3&lt;String, String, Long&gt;&gt;) (element, recordTimestamp) -&gt; element.f2) ); SingleOutputStreamOperator&lt;Event&gt; clickStream = env.fromElements( new Event(&quot;Bob&quot;, &quot;./cart&quot;, 2000L), new Event(&quot;Alice&quot;, &quot;./prod?id=100&quot;, 3000L), new Event(&quot;Alice&quot;, &quot;./prod?id=200&quot;, 3500L), new Event(&quot;Bob&quot;, &quot;./prod?id=2&quot;, 2500L), new Event(&quot;Alice&quot;, &quot;./prod?id=300&quot;, 36000L), new Event(&quot;Bob&quot;, &quot;./home&quot;, 30000L), new Event(&quot;Bob&quot;, &quot;./prod?id=1&quot;, 23000L), new Event(&quot;Bob&quot;, &quot;./prod?id=3&quot;, 33000L) ).assignTimestampsAndWatermarks(WatermarkStrategy.&lt;Event&gt;forMonotonousTimestamps() .withTimestampAssigner((SerializableTimestampAssigner&lt;Event&gt;) (element, recordTimestamp) -&gt; element.timestamp) ); orderStream.keyBy(data -&gt; data.f0) .intervalJoin(clickStream.keyBy(data -&gt; data.user)) .between(Time.seconds(-5), Time.seconds(10)) .process(new ProcessJoinFunction&lt;Tuple3&lt;String, String, Long&gt;, Event, String&gt;() { @Override public void processElement(Tuple3&lt;String, String, Long&gt; left, Event right, Context ctx, Collector&lt;String&gt; out) throws Exception { out.collect(right + &quot; =&gt; &quot; + left); } }) .print(); env.execute(); } } 3ï¼‰çª—å£åŒç»„è”ç»“(Window CoGroup) çª—å£åŒç»„è”ç»“(window coGroup)çš„ç”¨æ³•è·Ÿ window join éå¸¸ç±»ä¼¼ï¼Œ ä¹Ÿæ˜¯å°†ä¸¤æ¡æµåˆå¹¶ä¹‹åå¼€çª—å¤„ç†åŒ¹é…çš„å…ƒç´ ï¼Œè°ƒç”¨æ—¶åªéœ€è¦å°†.join()æ¢ä¸º.coGroup()å°±å¯ä»¥äº†ã€‚ ä¸ window joinçš„åŒºåˆ«åœ¨äºï¼Œè°ƒç”¨ .apply() æ–¹æ³•å®šä¹‰ å…·ä½“æ“ä½œ æ—¶ï¼Œä¼ å…¥çš„æ˜¯ä¸€ä¸ªCoGroupFunctionã€‚å®ƒæ˜¯ä¸€ä¸ªå‡½æ•°ç±»æ¥å£ public interface CoGroupFunction&lt;IN1, IN2, O&gt; extends Function, Serializable { void coGroup(Iterable&lt;IN1&gt; first, Iterable&lt;IN2&gt; second, Collector&lt;O&gt; out) throws Exception; } coGroup()æ–¹æ³•ï¼Œæœ‰äº›ç±»ä¼¼äº FlatJoinFunctionä¸­ join()çš„å½¢å¼ï¼Œ åŒæ ·æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œ åˆ†åˆ«ä»£è¡¨ä¸¤æ¡æµä¸­çš„æ•°æ®ä»¥åŠç”¨äºè¾“å‡ºçš„æ”¶é›†å™¨(Collector)ã€‚ä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œçš„å‰ä¸¤ä¸ªå‚æ•° ä¸å†æ˜¯å•ç‹¬çš„æ¯ä¸€ç»„â€œé…å¯¹â€æ•°æ®äº†ï¼Œ è€Œæ˜¯ä¼ å…¥äº†å¯éå†çš„æ•°æ®é›†åˆã€‚ä¹Ÿå°±æ˜¯è¯´ä¸ä¼šå†å»è®¡ç®—çª—å£ä¸­ä¸¤æ¡æµæ•°æ®é›†çš„ç¬›å¡å°”ç§¯ï¼Œè€Œæ˜¯ç›´æ¥æŠŠæ”¶é›†åˆ°çš„æ‰€æœ‰æ•°æ®ä¸€æ¬¡æ€§ä¼ å…¥ï¼Œè‡³äºè¦æ€æ ·é…å¯¹å®Œå…¨æ˜¯è‡ªå®šä¹‰ã€‚è¿™æ ·coGroup()æ–¹æ³•åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œ è€Œä¸”å³ä½¿ä¸€æ¡æµçš„æ•°æ®æ²¡æœ‰ä»»ä½•å¦ä¸€æ¡æµçš„æ•°æ®åŒ¹é…ï¼Œ ä¹Ÿå¯ä»¥å‡ºç°åœ¨é›†åˆä¸­ã€å½“ç„¶ä¹Ÿå¯ä»¥å®šä¹‰è¾“å‡ºç»“æœäº†ã€‚èƒ½å¤Ÿçœ‹å‡º coGroup æ“ä½œæ¯”çª—å£çš„ join æ›´åŠ é€šç”¨ï¼Œä¸ä»…å¯ä»¥å®ç°ç±»ä¼¼ SQL ä¸­çš„â€œå†… è¿æ¥â€(inner join)ï¼Œä¹Ÿå¯ä»¥å®ç°å·¦å¤–è¿æ¥(left outer join)ã€å³å¤–è¿æ¥(right outer join) å’Œå…¨å¤– è¿æ¥(full outer join)ã€‚äº‹å®ä¸Šï¼Œ çª—å£join çš„åº•å±‚ï¼Œä¹Ÿæ˜¯é€šè¿‡ coGroup æ¥å®ç°çš„ã€‚ ä»£ç ç¤ºä¾‹ï¼š package com.company.flink.demo; import org.apache.flink.api.common.eventtime.SerializableTimestampAssigner; import org.apache.flink.api.common.eventtime.WatermarkStrategy; import org.apache.flink.api.common.functions.CoGroupFunction; import org.apache.flink.api.java.tuple.Tuple2; import org.apache.flink.streaming.api.datastream.DataStream; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.streaming.api.windowing.assigners.TumblingEventTimeWindows; import org.apache.flink.streaming.api.windowing.time.Time; import org.apache.flink.util.Collector; public class FlinkCoGroupDemo { public static void main(String[] args) throws Exception { StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); env.setParallelism(1); DataStream&lt;Tuple2&lt;String, Long&gt;&gt; stream1 = env .fromElements( Tuple2.of(&quot;a&quot;, 1000L), Tuple2.of(&quot;a&quot;, 2000L), Tuple2.of(&quot;b&quot;, 1000L), Tuple2.of(&quot;b&quot;, 2000L) ) .assignTimestampsAndWatermarks( WatermarkStrategy .&lt;Tuple2&lt;String, Long&gt;&gt;forMonotonousTimestamps() .withTimestampAssigner( (SerializableTimestampAssigner&lt;Tuple2&lt;String, Long&gt;&gt;) (stringLongTuple2, l) -&gt; stringLongTuple2.f1 ) ); DataStream&lt;Tuple2&lt;String, Long&gt;&gt; stream2 = env .fromElements( Tuple2.of(&quot;a&quot;, 3000L), Tuple2.of(&quot;b&quot;, 3000L), Tuple2.of(&quot;b&quot;, 4000L), Tuple2.of(&quot;a&quot;, 4000L), Tuple2.of(&quot;c&quot;, 4000L) ) .assignTimestampsAndWatermarks( WatermarkStrategy .&lt;Tuple2&lt;String, Long&gt;&gt;forMonotonousTimestamps() .withTimestampAssigner( (SerializableTimestampAssigner&lt;Tuple2&lt;String, Long&gt;&gt;) (stringLongTuple2, l) -&gt; stringLongTuple2.f1 ) ); stream1 .coGroup(stream2) .where(r -&gt; r.f0) .equalTo(r -&gt; r.f0) .window(TumblingEventTimeWindows.of(Time.seconds(5))) .apply(new CoGroupFunction&lt;Tuple2&lt;String, Long&gt;, Tuple2&lt;String, Long&gt;, String&gt;() { @Override public void coGroup(Iterable&lt;Tuple2&lt;String, Long&gt;&gt; iter1, Iterable&lt;Tuple2&lt;String, Long&gt;&gt; iter2, Collector&lt;String&gt; collector) { collector.collect(iter1 + &quot;=&gt;&quot; + iter2); } }) .print(); env.execute(); } } ","link":"https://tianxiawuhao.github.io/6pSug_PPu/"},{"title":"ç¬¬ä¸ƒç«  æ—¶é—´è¯­ä¹‰ä¸ Wartermark","content":"Flink ä¸­çš„æ—¶é—´è¯­ä¹‰ åœ¨ Flink çš„æµå¼å¤„ç†ä¸­ï¼Œ ä¼šæ¶‰åŠåˆ°æ—¶é—´çš„ä¸åŒæ¦‚å¿µï¼Œ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å›¾ Flink æ—¶é—´æ¦‚å¿µ Event Timeï¼š æ˜¯äº‹ä»¶åˆ›å»ºçš„æ—¶é—´ã€‚ å®ƒé€šå¸¸ç”±äº‹ä»¶ä¸­çš„æ—¶é—´æˆ³æè¿°ï¼Œ ä¾‹å¦‚é‡‡é›†çš„ æ—¥å¿—æ•°æ®ä¸­ï¼Œ æ¯ä¸€æ¡æ—¥å¿—éƒ½ä¼šè®°å½•è‡ªå·±çš„ç”Ÿæˆæ—¶é—´ï¼Œ Flink é€šè¿‡æ—¶é—´æˆ³åˆ†é…å™¨è®¿é—®äº‹ ä»¶æ—¶é—´æˆ³ã€‚ Ingestion Timeï¼š æ˜¯æ•°æ®è¿›å…¥ Flink çš„æ—¶é—´ã€‚ Processing Timeï¼š æ˜¯æ¯ä¸€ä¸ªæ‰§è¡ŒåŸºäºæ—¶é—´æ“ä½œçš„ç®—å­çš„æœ¬åœ°ç³»ç»Ÿæ—¶é—´ï¼Œ ä¸æœºå™¨ ç›¸å…³ï¼Œ é»˜è®¤çš„æ—¶é—´å±æ€§å°±æ˜¯ Processing Timeã€‚ ä¸€ä¸ªä¾‹å­â€”â€”ç”µå½±ã€Š æ˜Ÿçƒå¤§æˆ˜ã€‹ ï¼š ä¾‹å¦‚ï¼Œ ä¸€æ¡æ—¥å¿—è¿›å…¥ Flink çš„æ—¶é—´ä¸º 2020-11-12 10:00:00.123ï¼Œ åˆ°è¾¾ Window çš„ ç³»ç»Ÿæ—¶é—´ä¸º 2020-11-12 10:00:01.234ï¼Œ æ—¥å¿—çš„å†…å®¹å¦‚ä¸‹ï¼š 2020-11-02 18:37:15.624 INFO Fail over to rm2 å¯¹äºä¸šåŠ¡æ¥è¯´ï¼Œ è¦ç»Ÿè®¡ 1min å†…çš„æ•…éšœæ—¥å¿—ä¸ªæ•°ï¼Œ å“ªä¸ªæ—¶é—´æ˜¯æœ€æœ‰æ„ä¹‰çš„ï¼Ÿ â€”â€” eventTimeï¼Œ å› ä¸ºæˆ‘ä»¬è¦æ ¹æ®æ—¥å¿—çš„ç”Ÿæˆæ—¶é—´è¿›è¡Œç»Ÿè®¡ã€‚ EventTime çš„å¼•å…¥ åœ¨ Flink çš„æµå¼å¤„ç†ä¸­ï¼Œ ç»å¤§éƒ¨åˆ†çš„ä¸šåŠ¡éƒ½ä¼šä½¿ç”¨ eventTimeï¼Œ ä¸€èˆ¬åªåœ¨eventTime æ— æ³•ä½¿ç”¨æ—¶ï¼Œ æ‰ä¼šè¢«è¿«ä½¿ç”¨ ProcessingTime æˆ–è€… IngestionTimeã€‚ å¦‚æœè¦ä½¿ç”¨ EventTimeï¼Œ é‚£ä¹ˆéœ€è¦å¼•å…¥ EventTime çš„æ—¶é—´å±æ€§ï¼Œ å¼•å…¥æ–¹å¼å¦‚ä¸‹æ‰€ ç¤ºï¼š // åˆ›å»º execution environment StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); // å‘Šè¯‰ç³»ç»ŸæŒ‰ç…§ EventTime å¤„ç† env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime); Watermark åŸºæœ¬æ¦‚å¿µ æˆ‘ä»¬çŸ¥é“ï¼Œ æµå¤„ç†ä»äº‹ä»¶äº§ç”Ÿï¼Œ åˆ°æµç» sourceï¼Œ å†åˆ° operatorï¼Œ ä¸­é—´æ˜¯æœ‰ä¸€ä¸ªè¿‡ç¨‹å’Œæ—¶é—´çš„ï¼Œ è™½ç„¶å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œ æµåˆ° operator çš„æ•°æ®éƒ½æ˜¯æŒ‰ç…§äº‹ä»¶äº§ç”Ÿçš„æ—¶é—´é¡ºåºæ¥çš„ï¼Œ ä½†æ˜¯ä¹Ÿä¸æ’é™¤ç”±äºç½‘ç»œã€ åˆ†å¸ƒå¼ç­‰åŸå› ï¼Œ å¯¼è‡´ä¹±åºçš„äº§ç”Ÿï¼Œ æ‰€è°“ä¹±åºï¼Œ å°± æ˜¯æŒ‡ Flink æ¥æ”¶åˆ°çš„äº‹ä»¶çš„å…ˆåé¡ºåºä¸æ˜¯ä¸¥æ ¼æŒ‰ç…§äº‹ä»¶çš„ Event Time é¡ºåºæ’åˆ—çš„ã€‚ å›¾ æ•°æ®çš„ä¹±åº é‚£ä¹ˆæ­¤æ—¶å‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œ ä¸€æ—¦å‡ºç°ä¹±åºï¼Œ å¦‚æœåªæ ¹æ® eventTime å†³å®š window çš„è¿è¡Œï¼Œ æˆ‘ä»¬ä¸èƒ½æ˜ç¡®æ•°æ®æ˜¯å¦å…¨éƒ¨åˆ°ä½ï¼Œ ä½†åˆä¸èƒ½æ— é™æœŸçš„ç­‰ä¸‹å»ï¼Œ æ­¤æ—¶å¿…é¡»è¦æœ‰ ä¸ªæœºåˆ¶æ¥ä¿è¯ä¸€ä¸ªç‰¹å®šçš„æ—¶é—´åï¼Œ å¿…é¡»è§¦å‘ window å»è¿›è¡Œè®¡ç®—äº†ï¼Œ è¿™ä¸ªç‰¹åˆ«çš„æœº åˆ¶ï¼Œ å°±æ˜¯ Watermarkã€‚ Watermark æ˜¯ä¸€ç§è¡¡é‡ Event Time è¿›å±•çš„æœºåˆ¶ã€‚ Watermark æ˜¯ç”¨äºå¤„ç†ä¹±åºäº‹ä»¶çš„ï¼Œ è€Œæ­£ç¡®çš„å¤„ç†ä¹±åºäº‹ä»¶ï¼Œ é€šå¸¸ç”¨ Watermark æœºåˆ¶ç»“åˆ window æ¥å®ç°ã€‚ æ•°æ®æµä¸­çš„ Watermark ç”¨äºè¡¨ç¤º timestamp å°äº Watermark çš„æ•°æ®ï¼Œ éƒ½å·²ç» åˆ°è¾¾äº†ï¼Œ å› æ­¤ï¼Œ window çš„æ‰§è¡Œä¹Ÿæ˜¯ç”± Watermark è§¦å‘çš„ã€‚ Watermark å¯ä»¥ç†è§£æˆä¸€ä¸ªå»¶è¿Ÿè§¦å‘æœºåˆ¶ï¼Œ æˆ‘ä»¬å¯ä»¥è®¾ç½® Watermark çš„å»¶æ—¶ æ—¶é•¿ tï¼Œ æ¯æ¬¡ç³»ç»Ÿä¼šæ ¡éªŒå·²ç»åˆ°è¾¾çš„æ•°æ®ä¸­æœ€å¤§çš„ maxEventTimeï¼Œ ç„¶åè®¤å®š eventTime å°äº maxEventTime - t çš„æ‰€æœ‰æ•°æ®éƒ½å·²ç»åˆ°è¾¾ï¼Œ å¦‚æœæœ‰çª—å£çš„åœæ­¢æ—¶é—´ç­‰äº maxEventTime â€“ tï¼Œ é‚£ä¹ˆè¿™ä¸ªçª—å£è¢«è§¦å‘æ‰§è¡Œã€‚ æœ‰åºæµçš„ Watermarker å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ï¼ˆ Watermark è®¾ç½®ä¸º 0ï¼‰ å›¾ æœ‰åºæ•°æ®çš„ Watermark ä¹±åºæµçš„ Watermarker å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ï¼ˆ Watermark è®¾ç½®ä¸º 2ï¼‰ å›¾ æ— åºæ•°æ®çš„ Watermark å½“ Flink æ¥æ”¶åˆ°æ•°æ®æ—¶ï¼Œ ä¼šæŒ‰ç…§ä¸€å®šçš„è§„åˆ™å»ç”Ÿæˆ Watermarkï¼Œ è¿™æ¡ Watermark å°±ç­‰äºå½“å‰æ‰€æœ‰åˆ°è¾¾æ•°æ®ä¸­çš„ maxEventTime - å»¶è¿Ÿæ—¶é•¿ï¼Œ ä¹Ÿå°±æ˜¯è¯´ï¼Œ Watermark æ˜¯ åŸºäºæ•°æ®æºå¸¦çš„æ—¶é—´æˆ³ç”Ÿæˆçš„ï¼Œ ä¸€æ—¦ Watermark æ¯”å½“å‰æœªè§¦å‘çš„çª—å£çš„åœæ­¢æ—¶é—´è¦ æ™šï¼Œ é‚£ä¹ˆå°±ä¼šè§¦å‘ç›¸åº”çª—å£çš„æ‰§è¡Œã€‚ ç”±äº event time æ˜¯ç”±æ•°æ®æºå¸¦çš„ï¼Œ å› æ­¤ï¼Œ å¦‚æœ è¿è¡Œè¿‡ç¨‹ä¸­æ— æ³•è·å–æ–°çš„æ•°æ®ï¼Œ é‚£ä¹ˆæ²¡æœ‰è¢«è§¦å‘çš„çª—å£å°†æ°¸è¿œéƒ½ä¸è¢«è§¦å‘ã€‚ ä¸Šå›¾ä¸­ï¼Œ æˆ‘ä»¬è®¾ç½®çš„å…è®¸æœ€å¤§å»¶è¿Ÿåˆ°è¾¾æ—¶é—´ä¸º 2sï¼Œ æ‰€ä»¥æ—¶é—´æˆ³ä¸º 7s çš„äº‹ä»¶å¯¹åº” çš„ Watermark æ˜¯ 5sï¼Œ æ—¶é—´æˆ³ä¸º 12s çš„äº‹ä»¶çš„ Watermark æ˜¯ 10sï¼Œ å¦‚æœæˆ‘ä»¬çš„çª—å£ 1 æ˜¯ 1s~5sï¼Œ çª—å£ 2 æ˜¯ 6s~10sï¼Œ é‚£ä¹ˆæ—¶é—´æˆ³ä¸º 7s çš„äº‹ä»¶åˆ°è¾¾æ—¶çš„ Watermarker æ°å¥½è§¦ å‘çª—å£ 1ï¼Œ æ—¶é—´æˆ³ä¸º 12s çš„äº‹ä»¶åˆ°è¾¾æ—¶çš„ Watermark æ°å¥½è§¦å‘çª—å£ 2ã€‚Watermark å°±æ˜¯è§¦å‘å‰ä¸€çª—å£çš„â€œ å…³çª—æ—¶é—´â€ ï¼Œ ä¸€æ—¦è§¦å‘å…³é—¨é‚£ä¹ˆä»¥å½“å‰æ—¶åˆ»ä¸ºå‡†åœ¨çª—å£èŒƒå›´å†…çš„æ‰€æœ‰æ‰€æœ‰æ•°æ®éƒ½ä¼šæ”¶å…¥çª—ä¸­ã€‚ åªè¦æ²¡æœ‰è¾¾åˆ°æ°´ä½é‚£ä¹ˆä¸ç®¡ç°å®ä¸­çš„æ—¶é—´æ¨è¿›äº†å¤šä¹…éƒ½ä¸ä¼šè§¦å‘å…³çª—ã€‚ Watermark çš„å¼•å…¥ watermark çš„å¼•å…¥å¾ˆç®€å•ï¼Œ å¯¹äºä¹±åºæ•°æ®ï¼Œ æœ€å¸¸è§çš„å¼•ç”¨æ–¹å¼å¦‚ä¸‹ï¼š // æŠ½å–å‡ºæ—¶é—´å’Œç”Ÿæˆ watermark dataStream.assignTimestampsAndWatermarks(new AscendingTimestampExtractor&lt;UserBehavior&gt;() { @Override public long extractAscendingTimestamp(UserBehavior userBehavior) { // åŸå§‹æ•°æ®å•ä½ç§’ï¼Œå°†å…¶è½¬æˆæ¯«ç§’ return userBehavior.timestamp * 1000; } }) Event Time çš„ä½¿ç”¨ä¸€å®šè¦æŒ‡å®šæ•°æ®æºä¸­çš„æ—¶é—´æˆ³ã€‚ å¦åˆ™ç¨‹åºæ— æ³•çŸ¥é“äº‹ä»¶çš„äº‹ ä»¶æ—¶é—´æ˜¯ä»€ä¹ˆ(æ•°æ®æºé‡Œçš„æ•°æ®æ²¡æœ‰æ—¶é—´æˆ³çš„è¯ï¼Œ å°±åªèƒ½ä½¿ç”¨ Processing Time äº†)ã€‚ æˆ‘ä»¬çœ‹åˆ°ä¸Šé¢çš„ä¾‹å­ä¸­åˆ›å»ºäº†ä¸€ä¸ªçœ‹èµ·æ¥æœ‰ç‚¹å¤æ‚çš„ç±»ï¼Œ è¿™ä¸ªç±»å®ç°çš„å…¶å®å°± æ˜¯åˆ†é…æ—¶é—´æˆ³çš„æ¥å£ã€‚ Flink æš´éœ²äº† TimestampAssigner æ¥å£ä¾›æˆ‘ä»¬å®ç°ï¼Œ ä½¿æˆ‘ä»¬å¯ ä»¥è‡ªå®šä¹‰å¦‚ä½•ä»äº‹ä»¶æ•°æ®ä¸­æŠ½å–æ—¶é—´æˆ³ã€‚ // åˆ›å»º execution environment final StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); // é€šè¿‡è¿æ¥ socket è·å–è¾“å…¥æ•°æ®ï¼Œè¿™é‡Œè¿æ¥åˆ°æœ¬åœ°9000ç«¯å£ï¼Œå¦‚æœ9000ç«¯å£å·²è¢«å ç”¨ï¼Œè¯·æ¢ä¸€ä¸ªç«¯å£ DataStream&lt;String&gt; text = env.socketTextStream(&quot;localhost&quot;, 9000, &quot;\\n&quot;); text.assignTimestampsAndWatermarks(new MyAssigner()) MyAssigner æœ‰ä¸¤ç§ç±»å‹ AssignerWithPeriodicWatermarks AssignerWithPunctuatedWatermarks ä»¥ä¸Šä¸¤ä¸ªæ¥å£éƒ½ç»§æ‰¿è‡ª TimestampAssignerã€‚ Assigner with periodic watermarks å‘¨æœŸæ€§çš„ç”Ÿæˆ watermarkï¼š ç³»ç»Ÿä¼šå‘¨æœŸæ€§çš„å°† watermark æ’å…¥åˆ°æµä¸­(æ°´ä½çº¿ä¹Ÿ æ˜¯ä¸€ç§ç‰¹æ®Šçš„äº‹ä»¶!)ã€‚ é»˜è®¤å‘¨æœŸæ˜¯ 200 æ¯«ç§’ã€‚ å¯ä»¥ä½¿ç”¨ ExecutionConfig.setAutoWatermarkInterval()æ–¹æ³•è¿›è¡Œè®¾ç½®ã€‚ StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime) // æ¯éš” 5 ç§’äº§ç”Ÿä¸€ä¸ª watermark env.getConfig.setAutoWatermarkInterval(5000) äº§ç”Ÿ watermark çš„é€»è¾‘ï¼š æ¯éš” 5 ç§’é’Ÿï¼Œ Flink ä¼šè°ƒç”¨ AssignerWithPeriodicWatermarks çš„ getCurrentWatermark()æ–¹æ³•ã€‚ å¦‚æœæ–¹æ³•è¿”å›ä¸€ä¸ª æ—¶é—´æˆ³å¤§äºä¹‹å‰æ°´ä½çš„æ—¶é—´æˆ³ï¼Œ æ–°çš„ watermark ä¼šè¢«æ’å…¥åˆ°æµä¸­ã€‚ è¿™ä¸ªæ£€æŸ¥ä¿è¯äº† æ°´ä½çº¿æ˜¯å•è°ƒé€’å¢çš„ã€‚ å¦‚æœæ–¹æ³•è¿”å›çš„æ—¶é—´æˆ³å°äºç­‰äºä¹‹å‰æ°´ä½çš„æ—¶é—´æˆ³ï¼Œ åˆ™ä¸ä¼š äº§ç”Ÿæ–°çš„ watermarkã€‚ ä¾‹å­ï¼Œ è‡ªå®šä¹‰ä¸€ä¸ªå‘¨æœŸæ€§çš„æ—¶é—´æˆ³æŠ½å–ï¼š public class PeriodicAssigner extends AssignerWithPeriodicWatermarks&lt;SensorReading&gt; { Long bound= 60 * 1000 // å»¶æ—¶ä¸º 1 åˆ†é’Ÿ Long maxTs = Long.MinValue // è§‚å¯Ÿåˆ°çš„æœ€å¤§æ—¶é—´æˆ³ public Watermark getCurrentWatermark() { new Watermark(maxTs - bound) } public void extractTimestamp(SensorReading r,Long previousTS) = { maxTs = maxTs.max(r.timestamp) r.timestamp } } ä¸€ç§ç®€å•çš„ç‰¹æ®Šæƒ…å†µæ˜¯ï¼Œ å¦‚æœæˆ‘ä»¬äº‹å…ˆå¾—çŸ¥æ•°æ®æµçš„æ—¶é—´æˆ³æ˜¯å•è°ƒé€’å¢çš„ï¼Œ ä¹Ÿå°±æ˜¯è¯´æ²¡æœ‰ä¹±åºï¼Œ é‚£æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ assignAscendingTimestampsï¼Œ è¿™ä¸ªæ–¹æ³•ä¼šç›´æ¥ä½¿ ç”¨æ•°æ®çš„æ—¶é—´æˆ³ç”Ÿæˆ watermarkã€‚ DataStream&lt;SensorReading&gt; stream: = ... DataStream&lt;SensorReading&gt; withTimestampsAndWatermarks = stream .assignAscendingTimestamps(e =&gt; e.timestamp) &gt;&gt; result: E(1), W(1), E(2), W(2), ... è€Œå¯¹äºä¹±åºæ•°æ®æµï¼Œ å¦‚æœæˆ‘ä»¬èƒ½å¤§è‡´ä¼°ç®—å‡ºæ•°æ®æµä¸­çš„äº‹ä»¶çš„æœ€å¤§å»¶è¿Ÿæ—¶é—´ï¼Œ å°±å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç ï¼š DataStream&lt;SensorReading&gt; stream: = ... DataStream&lt;SensorReading&gt; withTimestampsAndWatermarks = stream.assignTimestampsAndWatermarks( new SensorTimeAssigner() ) public class SensorTimeAssigner extends BoundedOutOfOrdernessTimestampExtractor&lt;SensorReading&gt;(Time.seconds(5)) { // æŠ½å–æ—¶é—´æˆ³ public Long extractTimestamp(SensorReading r){ return r.timestamp } } &gt;&gt; relust: E(10), W(0), E(8), E(7), E(11), W(1), ... Assigner with punctuated watermarks é—´æ–­å¼åœ°ç”Ÿæˆ watermarkã€‚ å’Œå‘¨æœŸæ€§ç”Ÿæˆçš„æ–¹å¼ä¸åŒï¼Œ è¿™ç§æ–¹å¼ä¸æ˜¯å›ºå®šæ—¶é—´çš„ï¼Œè€Œæ˜¯å¯ä»¥æ ¹æ®éœ€è¦å¯¹æ¯æ¡æ•°æ®è¿›è¡Œç­›é€‰å’Œå¤„ç†ã€‚ ç›´æ¥ä¸Šä»£ç æ¥ä¸¾ä¸ªä¾‹å­ï¼Œ æˆ‘ä»¬åªç»™ sensor_1 çš„ä¼ æ„Ÿå™¨çš„æ•°æ®æµæ’å…¥ watermarkï¼š public class PunctuatedAssigner extends AssignerWithPunctuatedWatermarks&lt;SensorReading&gt; { Long bound=60 * 1000 public Watermark checkAndGetNextWatermark(SensorReading r , Long extractedTS) { if (r.id == &quot;sensor_1&quot;) { new Watermark(extractedTS - bound) } else { null } } public Long extractTimestamp(SensorReading r, Long previousTS){ return r.timestamp } } EvnetTime åœ¨ window ä¸­çš„ä½¿ç”¨ æ»šåŠ¨çª—å£ï¼ˆTumblingEventTimeWindowsï¼‰ public class EventTimeTumblingWindowAllDemo { public static void main(String[] args) throws Exception { // 2021-03-06 21:00:00,1 // 2021-03-06 21:00:05,2 // ç»“æœ ï¼š 2&gt; 1 // 3&gt; 2 StreamExecutionEnvironment env = StreamExecutionEnvironment.createLocalEnvironmentWithWebUI(new Configuration()); // è€ç‰ˆæœ¬å¿…é¡»è¦è®¾ç½®æ—¶é—´æ ‡å‡† ï¼ˆ1.20 ä¹‹å‰çš„ï¼‰ env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime); DataStreamSource&lt;String&gt; lines = env.socketTextStream(&quot;linux01&quot;, 8888); // flinké‡Œé¢çš„æ—¶é—´éƒ½ç²¾ç¡®åˆ°æ¯«ç§’ // æ—¶é—´æå–å™¨ BoundedOutOfOrdernessTimestampExtractor : å…è®¸æ—¶é—´ä¹±åºï¼Œå¹¶ä¸”å¯ä»¥æŒ‡å®šçª—å£å»¶æ—¶ // WaterMark ï¼ˆæ°´ä½çº¿ï¼Œå¯ä»¥è®©çª—å£å»¶è¿Ÿè§¦å‘çš„ä¸€ç§æœºåˆ¶ï¼‰ // ä¸€ä¸ªçª—å£ä¸­çš„ä¸€ä¸ªåˆ†åŒºçš„æ°´ä½çº¿ = å½“å‰çª—å£å½“å‰åˆ†åŒºæœ€å¤§çš„ EventTime - å»¶è¿Ÿæ—¶é—´ Time.seconds(0) SingleOutputStreamOperator&lt;String&gt; linesWithWaterMark = lines.assignTimestampsAndWatermarks(new BoundedOutOfOrdernessTimestampExtractor&lt;String&gt;(Time.seconds(0)) { private SimpleDateFormat dateFormat = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;) ; @Override public long extractTimestamp(String s) { String strings = s.split(&quot;,&quot;)[0]; long timestamp = 0; try { Date date = dateFormat.parse(strings); timestamp = date.getTime(); } catch (ParseException e) { e.printStackTrace(); timestamp = System.currentTimeMillis(); } return timestamp; } }); SingleOutputStreamOperator&lt;Integer&gt; nums = linesWithWaterMark.map(new MapFunction&lt;String, Integer&gt;() { @Override public Integer map(String s) throws Exception { int i = Integer.parseInt(s.split(&quot;,&quot;)[1]); return i; } }); // åˆ’åˆ†çª—å£ AllWindowedStream&lt;Integer, TimeWindow&gt; window = nums.windowAll(TumblingProcessingTimeWindows.of(Time.seconds(5))); // å¯¹ window ä¸­çš„æ•°æ® è¿›è¡Œèšåˆ SingleOutputStreamOperator&lt;Integer&gt; sum = window.sum(0); sum.print(); env.execute() ; } } ç»“æœæ˜¯æŒ‰ç…§ Event Time çš„æ—¶é—´çª—å£è®¡ç®—å¾—å‡ºçš„ï¼Œ è€Œæ— å…³ç³»ç»Ÿçš„æ—¶é—´ï¼ˆ åŒ…æ‹¬è¾“å…¥çš„å¿«æ…¢ï¼‰ ã€‚ æ»‘åŠ¨çª—å£ï¼ˆSlidingEventTimeWindowsï¼‰ public class EventTimeSlidingWindowDemo { public static void main(String[] args) throws Exception { StreamExecutionEnvironment env = StreamExecutionEnvironment.createLocalEnvironmentWithWebUI(new Configuration()); // ä¸¤ç§’ è°ƒä¸€æ¬¡æ–¹æ³• env.getConfig().setAutoWatermarkInterval(1000); // è€ç‰ˆæœ¬å¿…é¡»è¦è®¾ç½®æ—¶é—´æ ‡å‡† ï¼ˆ1.20 ä¹‹å‰çš„ï¼‰ env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime); DataStreamSource&lt;String&gt; lines = env.socketTextStream(&quot;linux01&quot;, 8888); // flinké‡Œé¢çš„æ—¶é—´éƒ½ç²¾ç¡®åˆ°æ¯«ç§’ // æ—¶é—´æå–å™¨ BoundedOutOfOrdernessTimestampExtractor : å…è®¸æ—¶é—´ä¹±åºï¼Œå¹¶ä¸”å¯ä»¥æŒ‡å®šçª—å£å»¶æ—¶ // WaterMark ï¼ˆæ°´ä½çº¿ï¼Œå¯ä»¥è®©çª—å£å»¶è¿Ÿè§¦å‘çš„ä¸€ç§æœºåˆ¶ï¼‰ // ä¸€ä¸ªçª—å£ä¸­çš„ä¸€ä¸ªåˆ†åŒºçš„æ°´ä½çº¿ = å½“å‰çª—å£å½“å‰åˆ†åŒºæœ€å¤§çš„ EventTime - å»¶è¿Ÿæ—¶é—´ Time.seconds(0) SingleOutputStreamOperator&lt;String&gt; linesWithWaterMark = lines.assignTimestampsAndWatermarks(new BoundedOutOfOrdernessTimestampExtractor&lt;String&gt;(Time.seconds(0)) { @Override public long extractTimestamp(String s) { return Long.parseLong(s.split(&quot;,&quot;)[0]); // EventTime } }); // æå–å®Œ EventTime åç”Ÿæˆ WaterMark ï¼Œä½†æ•°æ®è¿˜æ˜¯åŸæ¥çš„è€æ ·å­ // 1000,spark,1 --&gt; spark,1 SingleOutputStreamOperator &lt;Tuple2&lt;String,Integer&gt;&gt; WordAndCount = linesWithWaterMark.map(new MapFunction&lt;String, Tuple2&lt;String,Integer&gt;&gt;() { @Override public Tuple2&lt;String,Integer&gt; map(String s) throws Exception { String[] split = s.split(&quot;,&quot;); return Tuple2.of(split[1],Integer.parseInt(split[2])); } }); // å…ˆ keyByï¼Œå†åˆ’åˆ†çª—å£ KeyedStream&lt;Tuple2&lt;String, Integer&gt;, String&gt; keyed = WordAndCount.keyBy(t -&gt; t.f0); // åˆ’åˆ†çª—å£ WindowedStream&lt;Tuple2&lt;String, Integer&gt;, String, TimeWindow&gt; window = keyed.window(SlidingEventTimeWindows.of(Time.seconds(10), Time.seconds(5))); // å¯¹çª—å£é‡Œé¢çš„æ•°æ®è¿›è¡Œ sum SingleOutputStreamOperator&lt;Tuple2&lt;String, Integer&gt;&gt; sum = window.sum(1); sum.print(); env.execute() ; } } ä¼šè¯çª—å£ï¼ˆEventTimeSessionWindowsï¼‰ ç›¸é‚»ä¸¤æ¬¡æ•°æ®çš„ EventTime çš„æ—¶é—´å·®è¶…è¿‡æŒ‡å®šçš„æ—¶é—´é—´éš”å°±ä¼šè§¦å‘æ‰§è¡Œã€‚ å¦‚æœåŠ å…¥ Watermarkï¼Œ ä¼šåœ¨ç¬¦åˆçª—å£è§¦å‘çš„æƒ…å†µä¸‹è¿›è¡Œå»¶è¿Ÿã€‚ åˆ°è¾¾å»¶è¿Ÿæ°´ä½å†è¿›è¡Œçª—å£ è§¦å‘ã€‚ public class EventTimeSessionWindowDemo { public static void main(String[] args) throws Exception { StreamExecutionEnvironment env = StreamExecutionEnvironment.createLocalEnvironmentWithWebUI(new Configuration()); // ä¸¤ç§’ è°ƒä¸€æ¬¡æ–¹æ³• env.getConfig().setAutoWatermarkInterval(1000); // è€ç‰ˆæœ¬å¿…é¡»è¦è®¾ç½®æ—¶é—´æ ‡å‡† ï¼ˆ1.20 ä¹‹å‰çš„ï¼‰ env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime); DataStreamSource&lt;String&gt; lines = env.socketTextStream(&quot;linux01&quot;, 8888); // flinké‡Œé¢çš„æ—¶é—´éƒ½ç²¾ç¡®åˆ°æ¯«ç§’ // æ—¶é—´æå–å™¨ BoundedOutOfOrdernessTimestampExtractor : å…è®¸æ—¶é—´ä¹±åºï¼Œå¹¶ä¸”å¯ä»¥æŒ‡å®šçª—å£å»¶æ—¶ // WaterMark ï¼ˆæ°´ä½çº¿ï¼Œå¯ä»¥è®©çª—å£å»¶è¿Ÿè§¦å‘çš„ä¸€ç§æœºåˆ¶ï¼‰ // ä¸€ä¸ªçª—å£ä¸­çš„ä¸€ä¸ªåˆ†åŒºçš„æ°´ä½çº¿ = å½“å‰çª—å£å½“å‰åˆ†åŒºæœ€å¤§çš„ EventTime - å»¶è¿Ÿæ—¶é—´ Time.seconds(0) SingleOutputStreamOperator&lt;String&gt; linesWithWaterMark = lines.assignTimestampsAndWatermarks(new BoundedOutOfOrdernessTimestampExtractor&lt;String&gt;(Time.seconds(0)) { @Override public long extractTimestamp(String s) { return Long.parseLong(s.split(&quot;,&quot;)[0]); // EventTime } }); // æå–å®Œ EventTime åç”Ÿæˆ WaterMark ï¼Œä½†æ•°æ®è¿˜æ˜¯åŸæ¥çš„è€æ ·å­ // 1000,spark,1 --&gt; spark,1 SingleOutputStreamOperator &lt;Tuple2&lt;String,Integer&gt;&gt; WordAndCount = linesWithWaterMark.map(new MapFunction&lt;String, Tuple2&lt;String,Integer&gt;&gt;() { @Override public Tuple2&lt;String,Integer&gt; map(String s) throws Exception { String[] split = s.split(&quot;,&quot;); return Tuple2.of(split[1],Integer.parseInt(split[2])); } }); // å…ˆ keyByï¼Œå†åˆ’åˆ†çª—å£ KeyedStream&lt;Tuple2&lt;String, Integer&gt;, String&gt; keyed = WordAndCount.keyBy(t -&gt; t.f0); // åˆ’åˆ†çª—å£ WindowedStream&lt;Tuple2&lt;String, Integer&gt;, String, TimeWindow&gt; window = keyed.window(EventTimeSessionWindows.withGap(Time.seconds(5))); // å¯¹çª—å£é‡Œé¢çš„æ•°æ®è¿›è¡Œ sum SingleOutputStreamOperator&lt;Tuple2&lt;String, Integer&gt;&gt; sum = window.sum(1); sum.print(); env.execute() ; } } ","link":"https://tianxiawuhao.github.io/GzZxLdaVh/"},{"title":"ç¬¬å…­ç«  Flink çš„Window æ“ä½œ","content":"çª—å£å‡½æ•°ï¼ˆWindow Functionsï¼‰ å®šä¹‰äº†çª—å£åˆ†é…å™¨ï¼Œæˆ‘ä»¬åªæ˜¯çŸ¥é“äº†æ•°æ®å±äºå“ªä¸ªçª—å£ï¼Œå¯ä»¥å°†æ•°æ®æ”¶é›†èµ·æ¥äº†ï¼›è‡³äºæ”¶é›†èµ·æ¥åˆ°åº•è¦åšä»€ä¹ˆï¼Œå…¶å®è¿˜å®Œå…¨æ²¡æœ‰å¤´ç»ªã€‚æ‰€ä»¥åœ¨çª—å£åˆ†é…å™¨ä¹‹åï¼Œå¿…é¡»å†æ¥ä¸Šä¸€ä¸ªå®šä¹‰çª—å£å¦‚ä½•è¿›è¡Œè®¡ç®—çš„æ“ä½œï¼Œè¿™å°±æ˜¯æ‰€è°“çš„â€œçª—å£å‡½æ•°â€ï¼ˆwindow functionsï¼‰ã€‚ ç»çª—å£åˆ†é…å™¨å¤„ç†ä¹‹åï¼Œæ•°æ®å¯ä»¥åˆ†é…åˆ°å¯¹åº”çš„çª—å£ä¸­ï¼Œè€Œæ•°æ®æµç»è¿‡è½¬æ¢å¾—åˆ°çš„æ•°æ®ç±»å‹æ˜¯ WindowedStreamã€‚è¿™ä¸ªç±»å‹å¹¶ä¸æ˜¯ DataStreamï¼Œæ‰€ä»¥å¹¶ä¸èƒ½ç›´æ¥è¿›è¡Œå…¶ä»–è½¬æ¢ï¼Œè€Œå¿…é¡»è¿›ä¸€æ­¥è°ƒç”¨çª—å£å‡½æ•°ï¼Œå¯¹æ”¶é›†åˆ°çš„æ•°æ®è¿›è¡Œå¤„ç†è®¡ç®—ä¹‹åï¼Œæ‰èƒ½æœ€ç»ˆå†æ¬¡å¾—åˆ° DataStreamã€‚ çª—å£å‡½æ•°å®šä¹‰äº†è¦å¯¹çª—å£ä¸­æ”¶é›†çš„æ•°æ®åšçš„è®¡ç®—æ“ä½œï¼Œæ ¹æ®å¤„ç†çš„æ–¹å¼å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼šå¢é‡èšåˆå‡½æ•°å’Œå…¨çª—å£å‡½æ•°ã€‚ä¸‹é¢æˆ‘ä»¬æ¥è¿›è¡Œåˆ†åˆ«è®²è§£ã€‚ å¢é‡èšåˆå‡½æ•°ï¼ˆincremental aggregation functionsï¼‰ çª—å£å°†æ•°æ®æ”¶é›†èµ·æ¥ï¼Œæœ€åŸºæœ¬çš„å¤„ç†æ“ä½œå½“ç„¶å°±æ˜¯è¿›è¡Œèšåˆã€‚çª—å£å¯¹æ— é™æµçš„åˆ‡åˆ†ï¼Œå¯ä»¥çœ‹ä½œå¾—åˆ°äº†ä¸€ä¸ªæœ‰ç•Œæ•°æ®é›†ã€‚å¦‚æœæˆ‘ä»¬ç­‰åˆ°æ‰€æœ‰æ•°æ®éƒ½æ”¶é›†é½ï¼Œåœ¨çª—å£åˆ°äº†ç»“æŸæ—¶é—´è¦è¾“å‡ºç»“æœçš„ä¸€ç¬é—´å†å»è¿›è¡Œèšåˆï¼Œæ˜¾ç„¶å°±ä¸å¤Ÿé«˜æ•ˆäº†â€”â€”è¿™ç›¸å½“äºçœŸçš„åœ¨ç”¨æ‰¹å¤„ç†çš„æ€è·¯æ¥åšå®æ—¶æµå¤„ç†ã€‚ ä¸ºäº†æé«˜å®æ—¶æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å†æ¬¡å°†æµå¤„ç†çš„æ€è·¯å‘æ‰¬å…‰å¤§ï¼šå°±åƒ DataStream çš„ç®€å•èšåˆä¸€æ ·ï¼Œæ¯æ¥ä¸€æ¡æ•°æ®å°±ç«‹å³è¿›è¡Œè®¡ç®—ï¼Œä¸­é—´åªè¦ä¿æŒä¸€ä¸ªç®€å•çš„èšåˆçŠ¶æ€å°±å¯ä»¥äº†ï¼›åŒºåˆ«åªæ˜¯åœ¨äºä¸ç«‹å³è¾“å‡ºç»“æœï¼Œè€Œæ˜¯è¦ç­‰åˆ°çª—å£ç»“æŸæ—¶é—´ã€‚ç­‰åˆ°çª—å£åˆ°äº†ç»“æŸæ—¶é—´éœ€è¦è¾“å‡ºè®¡ç®—ç»“æœçš„æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦æ‹¿å‡ºä¹‹å‰èšåˆçš„çŠ¶æ€ç›´æ¥è¾“å‡ºï¼Œè¿™æ— ç–‘å°±å¤§å¤§æé«˜äº†ç¨‹åºè¿è¡Œçš„æ•ˆç‡å’Œå®æ—¶æ€§ã€‚ å…¸å‹çš„å¢é‡èšåˆå‡½æ•°æœ‰ä¸¤ä¸ªï¼šReduceFunction å’Œ AggregateFunctionã€‚ å½’çº¦å‡½æ•°ï¼ˆReduceFunctionï¼‰ æœ€åŸºæœ¬çš„èšåˆæ–¹å¼å°±æ˜¯å½’çº¦ï¼ˆreduceï¼‰ã€‚æˆ‘ä»¬åœ¨åŸºæœ¬è½¬æ¢çš„èšåˆç®—å­ä¸­ä»‹ç»è¿‡ reduce çš„ç”¨æ³•ï¼Œçª—å£çš„å½’çº¦èšåˆä¹Ÿéå¸¸ç±»ä¼¼ï¼Œå°±æ˜¯å°†çª—å£ä¸­æ”¶é›†åˆ°çš„æ•°æ®ä¸¤ä¸¤è¿›è¡Œå½’çº¦ã€‚å½“æˆ‘ä»¬è¿›è¡Œæµå¤„ç†æ—¶ï¼Œå°±æ˜¯è¦ä¿å­˜ä¸€ä¸ªçŠ¶æ€ï¼›æ¯æ¥ä¸€ä¸ªæ–°çš„æ•°æ®ï¼Œå°±å’Œä¹‹å‰çš„èšåˆçŠ¶æ€åšå½’çº¦ï¼Œè¿™æ ·å°±å®ç°äº†å¢é‡å¼çš„èšåˆã€‚ çª—å£å‡½æ•°ä¸­ä¹Ÿæä¾›äº† ReduceFunctionï¼šåªè¦åŸºäº WindowedStream è°ƒç”¨.reduce()æ–¹æ³•ï¼Œç„¶åä¼ å…¥ ReduceFunction ä½œä¸ºå‚æ•°ï¼Œå°±å¯ä»¥æŒ‡å®šä»¥å½’çº¦ä¸¤ä¸ªå…ƒç´ çš„æ–¹å¼å»å¯¹çª—å£ä¸­æ•°æ®è¿›è¡Œèšåˆäº†ã€‚è¿™é‡Œçš„ ReduceFunction å…¶å®ä¸ç®€å•èšåˆæ—¶ç”¨åˆ°çš„ ReduceFunction æ˜¯åŒä¸€ä¸ªå‡½æ•°ç±»æ¥å£ï¼Œæ‰€ä»¥ä½¿ç”¨æ–¹å¼ä¹Ÿæ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚ æˆ‘ä»¬å›å¿†ä¸€ä¸‹ï¼ŒReduceFunction ä¸­éœ€è¦é‡å†™ä¸€ä¸ª reduce æ–¹æ³•ï¼Œå®ƒçš„ä¸¤ä¸ªå‚æ•°ä»£è¡¨è¾“å…¥çš„ä¸¤ä¸ªå…ƒç´ ï¼Œè€Œå½’çº¦æœ€ç»ˆè¾“å‡ºç»“æœçš„æ•°æ®ç±»å‹ï¼Œä¸è¾“å…¥çš„æ•°æ®ç±»å‹å¿…é¡»ä¿æŒä¸€è‡´ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸­é—´èšåˆçš„çŠ¶æ€å’Œè¾“å‡ºçš„ç»“æœï¼Œéƒ½å’Œè¾“å…¥çš„æ•°æ®ç±»å‹æ˜¯ä¸€æ ·çš„ã€‚ public class ClickSource implements SourceFunction&lt;Event&gt; { // å£°æ˜ä¸€ä¸ªå¸ƒå°”å˜é‡ï¼Œä½œä¸ºæ§åˆ¶æ•°æ®ç”Ÿæˆçš„æ ‡è¯†ä½ private Boolean running = true; public void run(SourceContext&lt;Event&gt; sourceContext) throws Exception { Random random = new Random(); // åœ¨æŒ‡å®šçš„æ•°æ®é›†ä¸­éšæœºé€‰å–æ•°æ® String[] users = {&quot;Mary&quot;, &quot;Alice&quot;, &quot;Bob&quot;, &quot;Cary&quot;}; String[] urls = {&quot;./home&quot;, &quot;./cart&quot;, &quot;./fav&quot;, &quot;./prod?id=1&quot;, &quot;./prod?id=2&quot;}; while (running) { sourceContext.collect(new Event( users[random.nextInt(users.length)], urls[random.nextInt(urls.length)], Calendar.getInstance().getTimeInMillis() )); // éš” 1 ç§’ç”Ÿæˆä¸€ä¸ªç‚¹å‡»äº‹ä»¶ï¼Œæ–¹ä¾¿è§‚æµ‹ Thread.sleep(1000); } } public void cancel() { running = false; } } import org.apache.flink.api.common.eventtime.SerializableTimestampAssigner; import org.apache.flink.api.common.eventtime.WatermarkStrategy; import org.apache.flink.api.common.functions.MapFunction; import org.apache.flink.api.common.functions.ReduceFunction; import org.apache.flink.api.java.tuple.Tuple2; import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.streaming.api.windowing.assigners.TumblingEventTimeWindows; import org.apache.flink.streaming.api.windowing.time.Time; import java.time.Duration; public class WindowReduceExample { public static void main(String[] args) throws Exception { StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); env.setParallelism(1); // ä»è‡ªå®šä¹‰æ•°æ®æºè¯»å–æ•°æ®ï¼Œå¹¶æå–æ—¶é—´æˆ³ã€ç”Ÿæˆæ°´ä½çº¿ SingleOutputStreamOperator&lt;Event&gt; stream = env.addSource(new ClickSource()) .assignTimestampsAndWatermarks(WatermarkStrategy.&lt;Event&gt;forBoundedOutOfOrderness(Duration.ZERO) .withTimestampAssigner(new SerializableTimestampAssigner&lt;Event&gt;() { @Override public long extractTimestamp(Event element, long recordTimestamp) { return element.timestamp; } })); stream.map(new MapFunction&lt;Event, Tuple2&lt;String, Long&gt;&gt;() { @Override public Tuple2&lt;String, Long&gt; map(Event value) throws Exception { // å°†æ•°æ®è½¬æ¢æˆäºŒå…ƒç»„ï¼Œæ–¹ä¾¿è®¡ç®— return Tuple2.of(value.user, 1L); } }) .keyBy(r -&gt; r.f0) // è®¾ç½®æ»šåŠ¨äº‹ä»¶æ—¶é—´çª—å£ .window(TumblingEventTimeWindows.of(Time.seconds(5))) .reduce(new ReduceFunction&lt;Tuple2&lt;String, Long&gt;&gt;() { @Override public Tuple2&lt;String, Long&gt; reduce(Tuple2&lt;String, Long&gt; value1, Tuple2&lt;String, Long&gt; value2) throws Exception { // å®šä¹‰ç´¯åŠ è§„åˆ™ï¼Œçª—å£é—­åˆæ—¶ï¼Œå‘ä¸‹æ¸¸å‘é€ç´¯åŠ ç»“æœ return Tuple2.of(value1.f0, value1.f1 + value2.f1); } }) .print(); env.execute(); } } è¿è¡Œç»“æœï¼šæ¯äº”ç§’é’Ÿè¾“å‡ºä¸€æ¬¡ (Bob,1) (Alice,2) (Mary,2) ... ä»£ç ä¸­æˆ‘ä»¬å¯¹æ¯ä¸ªç”¨æˆ·çš„è¡Œä¸ºæ•°æ®è¿›è¡Œäº†å¼€çª—ç»Ÿè®¡ã€‚ä¸ word count é€»è¾‘ç±»ä¼¼ï¼Œé¦–å…ˆå°†æ•°æ®è½¬æ¢æˆ(user, count)çš„äºŒå…ƒç»„å½¢å¼ï¼ˆç±»å‹ä¸º Tuple2&lt;String, Long&gt;ï¼‰ï¼Œæ¯æ¡æ•°æ®å¯¹åº”çš„åˆå§‹ countå€¼éƒ½æ˜¯ 1ï¼›ç„¶åæŒ‰ç…§ç”¨æˆ· id åˆ†ç»„ï¼Œåœ¨å¤„ç†æ—¶é—´ä¸‹å¼€æ»šåŠ¨çª—å£ï¼Œç»Ÿè®¡æ¯ 5 ç§’å†…çš„ç”¨æˆ·è¡Œä¸ºæ•°é‡ã€‚å¯¹äºçª—å£çš„è®¡ç®—ï¼Œæˆ‘ä»¬ç”¨ ReduceFunction å¯¹ count å€¼åšäº†å¢é‡èšåˆï¼šçª—å£ä¸­ä¼šå°†å½“å‰çš„æ€» countå€¼ä¿å­˜æˆä¸€ä¸ªå½’çº¦çŠ¶æ€ï¼Œæ¯æ¥ä¸€æ¡æ•°æ®ï¼Œå°±ä¼šè°ƒç”¨å†…éƒ¨çš„ reduce æ–¹æ³•ï¼Œå°†æ–°æ•°æ®ä¸­çš„ countå€¼å åŠ åˆ°çŠ¶æ€ä¸Šï¼Œå¹¶å¾—åˆ°æ–°çš„çŠ¶æ€ä¿å­˜èµ·æ¥ã€‚ç­‰åˆ°äº† 5 ç§’çª—å£çš„ç»“æŸæ—¶é—´ï¼Œå°±æŠŠå½’çº¦å¥½çš„çŠ¶æ€ç›´æ¥è¾“å‡ºã€‚ è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œæˆ‘ä»¬ç»è¿‡çª—å£èšåˆè½¬æ¢è¾“å‡ºçš„æ•°æ®ï¼Œæ•°æ®ç±»å‹ä¾ç„¶æ˜¯äºŒå…ƒç»„ Tuple2&lt;String, Long&gt;ã€‚ èšåˆå‡½æ•°ï¼ˆAggregateFunctionï¼‰ ReduceFunction å¯ä»¥è§£å†³å¤§å¤šæ•°å½’çº¦èšåˆçš„é—®é¢˜ï¼Œä½†æ˜¯è¿™ä¸ªæ¥å£æœ‰ä¸€ä¸ªé™åˆ¶ï¼Œå°±æ˜¯èšåˆçŠ¶æ€çš„ç±»å‹ã€è¾“å‡ºç»“æœçš„ç±»å‹éƒ½å¿…é¡»å’Œè¾“å…¥æ•°æ®ç±»å‹ä¸€æ ·ã€‚è¿™å°±è¿«ä½¿æˆ‘ä»¬å¿…é¡»åœ¨èšåˆå‰ï¼Œå…ˆå°†æ•°æ®è½¬æ¢ï¼ˆmapï¼‰æˆé¢„æœŸç»“æœç±»å‹ï¼›è€Œåœ¨æœ‰äº›æƒ…å†µä¸‹ï¼Œè¿˜éœ€è¦å¯¹çŠ¶æ€è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†æ‰èƒ½å¾—åˆ°è¾“å‡ºç»“æœï¼Œè¿™æ—¶å®ƒä»¬çš„ç±»å‹å¯èƒ½ä¸åŒï¼Œä½¿ç”¨ ReduceFunction å°±ä¼šéå¸¸éº»çƒ¦ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›è®¡ç®—ä¸€ç»„æ•°æ®çš„å¹³å‡å€¼ï¼Œåº”è¯¥æ€æ ·åšèšåˆå‘¢ï¼Ÿå¾ˆæ˜æ˜¾ï¼Œè¿™æ—¶æˆ‘ä»¬éœ€è¦è®¡ç®—ä¸¤ä¸ªçŠ¶æ€é‡ï¼šæ•°æ®çš„æ€»å’Œï¼ˆsumï¼‰ï¼Œä»¥åŠæ•°æ®çš„ä¸ªæ•°ï¼ˆcountï¼‰ï¼Œè€Œæœ€ç»ˆè¾“å‡ºç»“æœæ˜¯ä¸¤è€…çš„å•†ï¼ˆsum/countï¼‰ã€‚å¦‚æœç”¨ ReduceFunctionï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å…ˆæŠŠæ•°æ®è½¬æ¢æˆäºŒå…ƒç»„(sum, count)çš„å½¢å¼ï¼Œç„¶åè¿›è¡Œå½’çº¦èšåˆï¼Œæœ€åå†å°†å…ƒç»„çš„ä¸¤ä¸ªå…ƒç´ ç›¸é™¤è½¬æ¢å¾—åˆ°æœ€åçš„å¹³å‡å€¼ã€‚æœ¬æ¥åº”è¯¥åªæ˜¯ä¸€ä¸ªä»»åŠ¡ï¼Œå¯æˆ‘ä»¬å´éœ€è¦ map-reduce-map ä¸‰æ­¥æ“ä½œï¼Œè¿™æ˜¾ç„¶ä¸å¤Ÿé«˜æ•ˆã€‚ äºæ˜¯è‡ªç„¶å¯ä»¥æƒ³åˆ°ï¼Œå¦‚æœå–æ¶ˆç±»å‹ä¸€è‡´çš„é™åˆ¶ï¼Œè®©è¾“å…¥æ•°æ®ã€ä¸­é—´çŠ¶æ€ã€è¾“å‡ºç»“æœä¸‰è€…ç±»å‹éƒ½å¯ä»¥ä¸åŒï¼Œä¸å°±å¯ä»¥ä¸€æ­¥ç›´æ¥æå®šäº†å—ï¼Ÿ Flink çš„ Window API ä¸­çš„ aggregate å°±æä¾›äº†è¿™æ ·çš„æ“ä½œã€‚ç›´æ¥åŸºäº WindowedStream è°ƒ ç”¨.aggregate()æ–¹æ³•ï¼Œå°±å¯ä»¥å®šä¹‰æ›´åŠ çµæ´»çš„å£èšåˆæ“ä½œã€‚è¿™ä¸ªæ–¹æ³•éœ€è¦ä¼ å…¥ä¸€ä¸ªAggregateFunction çš„å®ç°ç±»ä½œä¸ºå‚æ•°ã€‚AggregateFunction åœ¨æºç ä¸­çš„å®šä¹‰å¦‚ä¸‹ public interface AggregateFunction&lt;IN, ACC, OUT&gt; extends Function, Serializable { ACC createAccumulator(); ACC add(IN value, ACC accumulator); OUT getResult(ACC accumulator); ACC merge(ACC a, ACC b); } AggregateFunction å¯ä»¥çœ‹ä½œæ˜¯ ReduceFunction çš„é€šç”¨ç‰ˆæœ¬ï¼Œè¿™é‡Œæœ‰ä¸‰ç§ç±»å‹ï¼šè¾“å…¥ç±»å‹ï¼ˆINï¼‰ã€ç´¯åŠ å™¨ç±»å‹ï¼ˆACCï¼‰å’Œè¾“å‡ºç±»å‹ï¼ˆOUTï¼‰ã€‚è¾“å…¥ç±»å‹ IN å°±æ˜¯è¾“å…¥æµä¸­å…ƒç´ çš„æ•°æ®ç±»å‹ï¼›ç´¯åŠ å™¨ç±»å‹ ACC åˆ™æ˜¯æˆ‘ä»¬è¿›è¡Œèšåˆçš„ä¸­é—´çŠ¶æ€ç±»å‹ï¼›è€Œè¾“å‡ºç±»å‹å½“ç„¶å°±æ˜¯æœ€ç»ˆè®¡ç®—ç»“æœçš„ç±»å‹äº†ã€‚ æ¥å£ä¸­æœ‰å››ä¸ªæ–¹æ³•ï¼š createAccumulator()ï¼šåˆ›å»ºä¸€ä¸ªç´¯åŠ å™¨ï¼Œè¿™å°±æ˜¯ä¸ºèšåˆåˆ›å»ºäº†ä¸€ä¸ªåˆå§‹çŠ¶æ€ï¼Œæ¯ä¸ªèšåˆä»»åŠ¡åªä¼šè°ƒç”¨ä¸€æ¬¡ã€‚ add()ï¼šå°†è¾“å…¥çš„å…ƒç´ æ·»åŠ åˆ°ç´¯åŠ å™¨ä¸­ã€‚è¿™å°±æ˜¯åŸºäºèšåˆçŠ¶æ€ï¼Œå¯¹æ–°æ¥çš„æ•°æ®è¿›è¡Œè¿›ä¸€æ­¥èšåˆçš„è¿‡ç¨‹ã€‚æ–¹æ³•ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼šå½“å‰æ–°åˆ°çš„æ•°æ® valueï¼Œå’Œå½“å‰çš„ç´¯åŠ å™¨accumulatorï¼›è¿”å›ä¸€ä¸ªæ–°çš„ç´¯åŠ å™¨å€¼ï¼Œä¹Ÿå°±æ˜¯å¯¹èšåˆçŠ¶æ€è¿›è¡Œæ›´æ–°ã€‚æ¯æ¡æ•°æ®åˆ°æ¥ä¹‹åéƒ½ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚ getResult()ï¼šä»ç´¯åŠ å™¨ä¸­æå–èšåˆçš„è¾“å‡ºç»“æœã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰å¤šä¸ªçŠ¶æ€ï¼Œç„¶åå†åŸºäºè¿™äº›èšåˆçš„çŠ¶æ€è®¡ç®—å‡ºä¸€ä¸ªç»“æœè¿›è¡Œè¾“å‡ºã€‚æ¯”å¦‚ä¹‹å‰æˆ‘ä»¬æåˆ°çš„è®¡ç®—å¹³å‡å€¼ï¼Œå°±å¯ä»¥æŠŠ sum å’Œ count ä½œä¸ºçŠ¶æ€æ”¾å…¥ç´¯åŠ å™¨ï¼Œè€Œåœ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ—¶ç›¸é™¤å¾—åˆ°æœ€ç»ˆç»“æœã€‚è¿™ä¸ªæ–¹æ³•åªåœ¨çª—å£è¦è¾“å‡ºç»“æœæ—¶è°ƒç”¨ã€‚ merge()ï¼šåˆå¹¶ä¸¤ä¸ªç´¯åŠ å™¨ï¼Œå¹¶å°†åˆå¹¶åçš„çŠ¶æ€ä½œä¸ºä¸€ä¸ªç´¯åŠ å™¨è¿”å›ã€‚è¿™ä¸ªæ–¹æ³•åªåœ¨éœ€è¦åˆå¹¶çª—å£çš„åœºæ™¯ä¸‹æ‰ä¼šè¢«è°ƒç”¨ï¼›æœ€å¸¸è§çš„åˆå¹¶çª—å£ï¼ˆMerging Windowï¼‰çš„åœºæ™¯å°±æ˜¯ä¼šè¯çª—å£ï¼ˆSession Windowsï¼‰ã€‚ æ‰€ä»¥å¯ä»¥çœ‹åˆ°ï¼ŒAggregateFunction çš„å·¥ä½œåŸç†æ˜¯ï¼šé¦–å…ˆè°ƒç”¨ createAccumulator()ä¸ºä»»åŠ¡åˆå§‹åŒ–ä¸€ä¸ªçŠ¶æ€(ç´¯åŠ å™¨)ï¼›è€Œåæ¯æ¥ä¸€ä¸ªæ•°æ®å°±è°ƒç”¨ä¸€æ¬¡ add()æ–¹æ³•ï¼Œå¯¹æ•°æ®è¿›è¡Œèšåˆï¼Œå¾—åˆ°çš„ç»“æœä¿å­˜åœ¨çŠ¶æ€ä¸­ï¼›ç­‰åˆ°äº†çª—å£éœ€è¦è¾“å‡ºæ—¶ï¼Œå†è°ƒç”¨ getResult()æ–¹æ³•å¾—åˆ°è®¡ç®—ç»“æœã€‚å¾ˆæ˜æ˜¾ï¼Œä¸ ReduceFunction ç›¸åŒï¼ŒAggregateFunction ä¹Ÿæ˜¯å¢é‡å¼çš„èšåˆï¼›è€Œç”±äºè¾“å…¥ã€ä¸­é—´çŠ¶æ€ã€è¾“å‡ºçš„ç±»å‹å¯ä»¥ä¸åŒï¼Œä½¿å¾—åº”ç”¨æ›´åŠ çµæ´»æ–¹ä¾¿ã€‚ ä¸‹é¢æ¥çœ‹ä¸€ä¸ªå…·ä½“ä¾‹å­ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ç”µå•†ç½‘ç«™ä¸­ï¼ŒPVï¼ˆé¡µé¢æµè§ˆé‡ï¼‰å’Œ UVï¼ˆç‹¬ç«‹è®¿å®¢æ•°ï¼‰æ˜¯éå¸¸é‡è¦çš„ä¸¤ä¸ªæµé‡æŒ‡æ ‡ã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒPV ç»Ÿè®¡çš„æ˜¯æ‰€æœ‰çš„ç‚¹å‡»é‡ï¼›è€Œå¯¹ç”¨æˆ· id è¿›è¡Œå»é‡ä¹‹åï¼Œå¾—åˆ°çš„å°±æ˜¯ UVã€‚æ‰€ä»¥æœ‰æ—¶æˆ‘ä»¬ä¼šç”¨ PV/UV è¿™ä¸ªæ¯”å€¼ï¼Œæ¥è¡¨ç¤ºâ€œäººå‡é‡å¤è®¿é—®é‡â€ï¼Œä¹Ÿå°±æ˜¯å¹³å‡æ¯ä¸ªç”¨æˆ·ä¼šè®¿é—®å¤šå°‘æ¬¡é¡µé¢ï¼Œè¿™åœ¨ä¸€å®šç¨‹åº¦ä¸Šä»£è¡¨äº†ç”¨æˆ·çš„ç²˜åº¦ã€‚ import org.apache.flink.api.common.eventtime.SerializableTimestampAssigner; import org.apache.flink.api.common.eventtime.WatermarkStrategy; import org.apache.flink.api.common.functions.AggregateFunction; import org.apache.flink.api.java.tuple.Tuple2; import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.streaming.api.windowing.assigners.SlidingEventTimeWindows; import org.apache.flink.streaming.api.windowing.time.Time; import java.util.HashSet; public class WindowAggregateFunctionExample { public static void main(String[] args) throws Exception { StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); env.setParallelism(1); SingleOutputStreamOperator&lt;Event&gt; stream = env.addSource(new ClickSource()) .assignTimestampsAndWatermarks(WatermarkStrategy.&lt;Event&gt;forMonotonousTimestamps() .withTimestampAssigner(new SerializableTimestampAssigner&lt;Event&gt;() { @Override public long extractTimestamp(Event element, long recordTimestamp) { return element.timestamp; } })); // æ‰€æœ‰æ•°æ®è®¾ç½®ç›¸åŒçš„ keyï¼Œå‘é€åˆ°åŒä¸€ä¸ªåˆ†åŒºç»Ÿè®¡ PV å’Œ UVï¼Œå†ç›¸é™¤ stream.keyBy(data -&gt; true) .window(SlidingEventTimeWindows.of(Time.seconds(10), Time.seconds(2))) .aggregate(new AvgPv()) .print(); env.execute(); } public static class AvgPv implements AggregateFunction&lt;Event, Tuple2&lt;HashSet&lt;String&gt;, Long&gt;, Double&gt; { @Override public Tuple2&lt;HashSet&lt;String&gt;, Long&gt; createAccumulator() { // åˆ›å»ºç´¯åŠ å™¨ return Tuple2.of(new HashSet&lt;String&gt;(), 0L); } @Override public Tuple2&lt;HashSet&lt;String&gt;, Long&gt; add(Event value, Tuple2&lt;HashSet&lt;String&gt;, Long&gt; accumulator) { // å±äºæœ¬çª—å£çš„æ•°æ®æ¥ä¸€æ¡ç´¯åŠ ä¸€æ¬¡ï¼Œå¹¶è¿”å›ç´¯åŠ å™¨ accumulator.f0.add(value.user); return Tuple2.of(accumulator.f0, accumulator.f1 + 1L); } @Override public Double getResult(Tuple2&lt;HashSet&lt;String&gt;, Long&gt; accumulator) { // çª—å£é—­åˆæ—¶ï¼Œå¢é‡èšåˆç»“æŸï¼Œå°†è®¡ç®—ç»“æœå‘é€åˆ°ä¸‹æ¸¸ return (double) accumulator.f1 / accumulator.f0.size(); } @Override public Tuple2&lt;HashSet&lt;String&gt;, Long&gt; merge(Tuple2&lt;HashSet&lt;String&gt;, Long&gt; a, Tuple2&lt;HashSet&lt;String&gt;, Long&gt; b) { return null; } } } è¾“å‡ºç»“æœï¼š 1.0 1.6666666666666667 ... ä»£ç ä¸­æˆ‘ä»¬åˆ›å»ºäº†äº‹ä»¶æ—¶é—´æ»‘åŠ¨çª—å£ï¼Œç»Ÿè®¡ 10 ç§’é’Ÿçš„â€œäººå‡ PVâ€ï¼Œæ¯ 2 ç§’ç»Ÿè®¡ä¸€æ¬¡ã€‚ç”±äºèšåˆçš„çŠ¶æ€è¿˜éœ€è¦åšå¤„ç†è®¡ç®—ï¼Œå› æ­¤çª—å£èšåˆæ—¶ä½¿ç”¨äº†æ›´åŠ çµæ´»çš„ AggregateFunctionã€‚ä¸ºäº†ç»Ÿè®¡ UVï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ª HashSet ä¿å­˜æ‰€æœ‰å‡ºç°è¿‡çš„ç”¨æˆ· idï¼Œå®ç°è‡ªåŠ¨å»é‡ï¼›è€Œ PV çš„ç»Ÿè®¡åˆ™ç±»ä¼¼ä¸€ä¸ªè®¡æ•°å™¨ï¼Œæ¯æ¥ä¸€ä¸ªæ•°æ®åŠ ä¸€å°±å¯ä»¥äº†ã€‚æ‰€ä»¥è¿™é‡Œçš„çŠ¶æ€ï¼Œå®šä¹‰ä¸ºåŒ…å«ä¸€ä¸ª HashSet å’Œä¸€ä¸ª count å€¼çš„äºŒå…ƒç»„ï¼ˆTuple2&lt;HashSet, Long&gt;ï¼‰ï¼Œæ¯æ¥ä¸€æ¡æ•°æ®ï¼Œå°±å°† user å­˜å…¥ HashSetï¼ŒåŒæ—¶ count åŠ  1ã€‚è¿™é‡Œçš„ count å°±æ˜¯ PVï¼Œè€Œ HashSet ä¸­å…ƒç´ çš„ä¸ªæ•°ï¼ˆsizeï¼‰å°±æ˜¯ UVï¼›æ‰€ä»¥æœ€ç»ˆçª—å£çš„è¾“å‡ºç»“æœï¼Œå°±æ˜¯å®ƒä»¬çš„æ¯”å€¼ã€‚ è¿™é‡Œæ²¡æœ‰æ¶‰åŠä¼šè¯çª—å£ï¼Œæ‰€ä»¥ merge()æ–¹æ³•å¯ä»¥ä¸åšä»»ä½•æ“ä½œã€‚ å¦å¤–ï¼ŒFlink ä¹Ÿä¸ºçª—å£çš„èšåˆæä¾›äº†ä¸€ç³»åˆ—é¢„å®šä¹‰çš„ç®€å•èšåˆæ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥åŸºäºWindowedStream è°ƒç”¨ã€‚ä¸»è¦åŒ…æ‹¬.sum()/max()/maxBy()/min()/minBy()ï¼Œä¸ KeyedStream çš„ç®€å•èšåˆéå¸¸ç›¸ä¼¼ã€‚å®ƒä»¬çš„åº•å±‚ï¼Œå…¶å®éƒ½æ˜¯é€šè¿‡ AggregateFunction æ¥å®ç°çš„ã€‚ é€šè¿‡ ReduceFunction å’Œ AggregateFunction æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå¢é‡èšåˆå‡½æ•°å…¶å®å°±æ˜¯åœ¨ç”¨æµå¤„ç†çš„æ€è·¯æ¥å¤„ç†æœ‰ç•Œæ•°æ®é›†ï¼Œæ ¸å¿ƒæ˜¯ä¿æŒä¸€ä¸ªèšåˆçŠ¶æ€ï¼Œå½“æ•°æ®åˆ°æ¥æ—¶ä¸åœåœ°æ›´æ–°çŠ¶æ€ã€‚è¿™å°±æ˜¯ Flink æ‰€è°“çš„â€œæœ‰çŠ¶æ€çš„æµå¤„ç†â€ï¼Œé€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥æå¤§åœ°æé«˜ç¨‹åºè¿è¡Œçš„æ•ˆç‡ï¼Œæ‰€ä»¥ åœ¨å®é™…åº”ç”¨ä¸­æœ€ä¸ºå¸¸è§ã€‚ å…¨çª—å£å‡½æ•°ï¼ˆfull window functionsï¼‰ çª—å£æ“ä½œä¸­çš„å¦ä¸€å¤§ç±»å°±æ˜¯å…¨çª—å£å‡½æ•°ã€‚ä¸å¢é‡èšåˆå‡½æ•°ä¸åŒï¼Œå…¨çª—å£å‡½æ•°éœ€è¦å…ˆæ”¶é›†çª—å£ä¸­çš„æ•°æ®ï¼Œå¹¶åœ¨å†…éƒ¨ç¼“å­˜èµ·æ¥ï¼Œç­‰åˆ°çª—å£è¦è¾“å‡ºç»“æœçš„æ—¶å€™å†å–å‡ºæ•°æ®è¿›è¡Œè®¡ç®—ã€‚ å¾ˆæ˜æ˜¾ï¼Œè¿™å°±æ˜¯å…¸å‹çš„æ‰¹å¤„ç†æ€è·¯äº†â€”â€”å…ˆæ”’æ•°æ®ï¼Œç­‰ä¸€æ‰¹éƒ½åˆ°é½äº†å†æ­£å¼å¯åŠ¨å¤„ç†æµç¨‹ã€‚è¿™æ ·åšæ¯«æ— ç–‘é—®æ˜¯ä½æ•ˆçš„ï¼šå› ä¸ºçª—å£å…¨éƒ¨çš„è®¡ç®—ä»»åŠ¡éƒ½ç§¯å‹åœ¨äº†è¦è¾“å‡ºç»“æœçš„é‚£ä¸€ç¬é—´ï¼Œè€Œåœ¨ä¹‹å‰æ”¶é›†æ•°æ®çš„æ¼«é•¿è¿‡ç¨‹ä¸­å´æ— æ‰€äº‹äº‹ã€‚è¿™å°±å¥½æ¯”å¹³æ—¶ä¸ç”¨åŠŸï¼Œåˆ°è€ƒè¯•ä¹‹å‰é€šå®µæŠ±ä½›è„šï¼Œè‚¯å®šä¸å¦‚æŠŠå·¥å¤«èŠ±åœ¨æ—¥å¸¸ç§¯ç´¯ä¸Šã€‚ é‚£ä¸ºä»€ä¹ˆè¿˜éœ€è¦æœ‰å…¨çª—å£å‡½æ•°å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºæœ‰äº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬è¦åšçš„è®¡ç®—å¿…é¡»åŸºäºå…¨éƒ¨çš„æ•°æ®æ‰æœ‰æ•ˆï¼Œè¿™æ—¶åšå¢é‡èšåˆå°±æ²¡ä»€ä¹ˆæ„ä¹‰äº†ï¼›å¦å¤–ï¼Œè¾“å‡ºçš„ç»“æœæœ‰å¯èƒ½è¦åŒ…å«ä¸Šä¸‹æ–‡ä¸­çš„ä¸€äº›ä¿¡æ¯ï¼ˆæ¯”å¦‚çª—å£çš„èµ·å§‹æ—¶é—´ï¼‰ï¼Œè¿™æ˜¯å¢é‡èšåˆå‡½æ•°åšä¸åˆ°çš„ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æœ‰æ›´ä¸°å¯Œçš„çª—å£è®¡ç®—æ–¹å¼ï¼Œè¿™å°±å¯ä»¥ç”¨å…¨çª—å£å‡½æ•°æ¥å®ç°ã€‚ åœ¨ Flink ä¸­ï¼Œå…¨çª—å£å‡½æ•°ä¹Ÿæœ‰ä¸¤ç§ï¼šWindowFunction å’Œ ProcessWindowFunctionã€‚ çª—å£å‡½æ•°ï¼ˆWindowFunctionï¼‰ WindowFunction å­—é¢ä¸Šå°±æ˜¯â€œçª—å£å‡½æ•°â€ï¼Œå®ƒå…¶å®æ˜¯è€ç‰ˆæœ¬çš„é€šç”¨çª—å£å‡½æ•°æ¥å£ã€‚æˆ‘ä»¬å¯ä»¥åŸºäº WindowedStream è°ƒç”¨.apply()æ–¹æ³•ï¼Œä¼ å…¥ä¸€ä¸ª WindowFunction çš„å®ç°ç±»ã€‚ stream .keyBy(&lt;key selector&gt;) .window(&lt;window assigner&gt;) .apply(new MyWindowFunction()); è¿™ä¸ªç±»ä¸­å¯ä»¥è·å–åˆ°åŒ…å«çª—å£æ‰€æœ‰æ•°æ®çš„å¯è¿­ä»£é›†åˆï¼ˆIterableï¼‰ï¼Œè¿˜å¯ä»¥æ‹¿åˆ°çª—å£ï¼ˆWindowï¼‰æœ¬èº«çš„ä¿¡æ¯ã€‚WindowFunction æ¥å£åœ¨æºç ä¸­å®ç°å¦‚ä¸‹ï¼š public interface WindowFunction&lt;IN, OUT, KEY, W extends Window&gt; extends Function, Serializable { void apply(KEY key, W window, Iterable&lt;IN&gt; input, Collector&lt;OUT&gt; out) throws Exception; } å½“çª—å£åˆ°è¾¾ç»“æŸæ—¶é—´éœ€è¦è§¦å‘è®¡ç®—æ—¶ï¼Œå°±ä¼šè°ƒç”¨è¿™é‡Œçš„ apply æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥ä» input é›†åˆä¸­å–å‡ºçª—å£æ”¶é›†çš„æ•°æ®ï¼Œç»“åˆ key å’Œ window ä¿¡æ¯ï¼Œé€šè¿‡æ”¶é›†å™¨ï¼ˆCollectorï¼‰è¾“å‡ºç»“æœã€‚è¿™é‡Œ Collector çš„ç”¨æ³•ï¼Œä¸ FlatMapFunction ä¸­ç›¸åŒã€‚ ä¸è¿‡æˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†ï¼ŒWindowFunction èƒ½æä¾›çš„ä¸Šä¸‹æ–‡ä¿¡æ¯è¾ƒå°‘ï¼Œä¹Ÿæ²¡æœ‰æ›´é«˜çº§çš„åŠŸèƒ½ã€‚äº‹å®ä¸Šï¼Œå®ƒçš„ä½œç”¨å¯ä»¥è¢« ProcessWindowFunction å…¨è¦†ç›–ï¼Œæ‰€ä»¥ä¹‹åå¯èƒ½ä¼šé€æ¸å¼ƒç”¨ã€‚ä¸€èˆ¬åœ¨å®é™…åº”ç”¨ï¼Œç›´æ¥ä½¿ç”¨ProcessWindowFunction å°±å¯ä»¥äº†ã€‚ å¤„ç†çª—å£å‡½æ•°ï¼ˆProcessWindowFunctionï¼‰ ProcessWindowFunction æ˜¯ Window API ä¸­æœ€åº•å±‚çš„é€šç”¨çª—å£å‡½æ•°æ¥å£ã€‚ä¹‹æ‰€ä»¥è¯´å®ƒâ€œæœ€åº•å±‚â€ï¼Œæ˜¯å› ä¸ºé™¤äº†å¯ä»¥æ‹¿åˆ°çª—å£ä¸­çš„æ‰€æœ‰æ•°æ®ä¹‹å¤–ï¼ŒProcessWindowFunction è¿˜å¯ä»¥è·å–åˆ°ä¸€ä¸ªâ€œä¸Šä¸‹æ–‡å¯¹è±¡â€ï¼ˆContextï¼‰ã€‚è¿™ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡éå¸¸å¼ºå¤§ï¼Œä¸ä»…èƒ½å¤Ÿè·å–çª—å£ä¿¡æ¯ï¼Œè¿˜å¯ä»¥è®¿é—®å½“å‰çš„æ—¶é—´å’ŒçŠ¶æ€ä¿¡æ¯ã€‚è¿™é‡Œçš„æ—¶é—´å°±åŒ…æ‹¬äº†å¤„ç†æ—¶é—´ï¼ˆprocessing timeï¼‰å’Œäº‹ä»¶æ—¶é—´æ°´ä½çº¿ï¼ˆeventtime watermarkï¼‰ã€‚è¿™å°±ä½¿å¾— ProcessWindowFunction æ›´åŠ çµæ´»ã€åŠŸèƒ½æ›´åŠ ä¸°å¯Œã€‚äº‹å®ä¸Šï¼ŒProcessWindowFunction æ˜¯ Flink åº•å±‚ APIâ€”â€”å¤„ç†å‡½æ•°ï¼ˆprocess functionï¼‰ä¸­çš„ä¸€å‘˜ï¼Œå…³äºå¤„ç†å‡½æ•°æˆ‘ä»¬ä¼šåœ¨åç»­ç« èŠ‚å±•å¼€è®²è§£ã€‚ å½“ ç„¶ ï¼Œ è¿™ äº› å¥½ å¤„ æ˜¯ ä»¥ ç‰º ç‰² æ€§ èƒ½ å’Œ èµ„ æº ä¸º ä»£ ä»· çš„ ã€‚ ä½œ ä¸º ä¸€ ä¸ª å…¨ çª— å£ å‡½ æ•° ï¼ŒProcessWindowFunction åŒæ ·éœ€è¦å°†æ‰€æœ‰æ•°æ®ç¼“å­˜ä¸‹æ¥ã€ç­‰åˆ°çª—å£è§¦å‘è®¡ç®—æ—¶æ‰ä½¿ç”¨ã€‚å®ƒå…¶å®å°±æ˜¯ä¸€ä¸ªå¢å¼ºç‰ˆçš„ WindowFunctionã€‚ å…·ä½“ä½¿ç”¨è·Ÿ WindowFunction éå¸¸ç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥åŸºäº WindowedStream è°ƒç”¨.process()æ–¹æ³•ï¼Œä¼ å…¥ä¸€ä¸ª ProcessWindowFunction çš„å®ç°ç±»ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç”µå•†ç½‘ç«™ç»Ÿè®¡æ¯å°æ—¶ UV çš„ä¾‹å­ï¼š import org.apache.flink.api.common.eventtime.SerializableTimestampAssigner; import org.apache.flink.api.common.eventtime.WatermarkStrategy; import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.streaming.api.functions.windowing.ProcessWindowFunction; import org.apache.flink.streaming.api.windowing.assigners.TumblingEventTimeWindows; import org.apache.flink.streaming.api.windowing.time.Time; import org.apache.flink.streaming.api.windowing.windows.TimeWindow; import org.apache.flink.util.Collector; import java.sql.Timestamp; import java.time.Duration; import java.util.HashSet; public class UvCountByWindowExample { public static void main(String[] args) throws Exception { StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); env.setParallelism(1); SingleOutputStreamOperator&lt;Event&gt; stream = env.addSource(new ClickSource()) .assignTimestampsAndWatermarks(WatermarkStrategy.&lt;Event&gt;forBoundedOutOfOrderness(Duration.ZERO) .withTimestampAssigner(new SerializableTimestampAssigner&lt;Event&gt;() { @Override public long extractTimestamp(Event element, long recordTimestamp) { return element.timestamp; } })); // å°†æ•°æ®å…¨éƒ¨å‘å¾€åŒä¸€åˆ†åŒºï¼ŒæŒ‰çª—å£ç»Ÿè®¡ UV stream.keyBy(data -&gt; true) .window(TumblingEventTimeWindows.of(Time.seconds(10))) .process(new UvCountByWindow()) .print(); env.execute(); } // è‡ªå®šä¹‰çª—å£å¤„ç†å‡½æ•° public static class UvCountByWindow extends ProcessWindowFunction&lt;Event, String, Boolean, TimeWindow&gt; { @Override public void process(Boolean aBoolean, Context context, Iterable&lt;Event&gt; elements, Collector&lt;String&gt; out) throws Exception { HashSet&lt;String&gt; userSet = new HashSet&lt;&gt;(); // éå†æ‰€æœ‰æ•°æ®ï¼Œæ”¾åˆ° Set é‡Œå»é‡ for (Event event : elements) { userSet.add(event.user); } // ç»“åˆçª—å£ä¿¡æ¯ï¼ŒåŒ…è£…è¾“å‡ºå†…å®¹ Long start = context.window().getStart(); Long end = context.window().getEnd(); out.collect(&quot; çª— å£ : &quot; + new Timestamp(start) + &quot; ~ &quot; + new Timestamp(end) + &quot; çš„ç‹¬ç«‹è®¿å®¢æ•°é‡æ˜¯ï¼š&quot; + userSet.size()); } } } è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯äº‹ä»¶æ—¶é—´è¯­ä¹‰ã€‚å®šä¹‰ 10 ç§’é’Ÿçš„æ»šåŠ¨äº‹ä»¶çª—å£åï¼Œç›´æ¥ä½¿ç”¨ProcessWindowFunction æ¥å®šä¹‰å¤„ç†çš„é€»è¾‘ã€‚æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª HashSetï¼Œå°†çª—å£æ‰€æœ‰æ•°æ®çš„userId å†™å…¥å®ç°å»é‡ï¼Œæœ€ç»ˆå¾—åˆ° HashSet çš„å…ƒç´ ä¸ªæ•°å°±æ˜¯ UV å€¼ã€‚ å½“ç„¶ï¼Œè¿™é‡Œæˆ‘ä»¬å¹¶æ²¡æœ‰ç”¨åˆ°ä¸‹æ–‡ä¸­å…¶ä»–ä¿¡æ¯ ï¼Œ æ‰€ä»¥å…¶å®æ²¡æœ‰å¿…è¦ä½¿ç”¨ProcessWindowFunctionã€‚å…¨çª—å£å‡½æ•°å› ä¸ºè¿è¡Œæ•ˆç‡è¾ƒä½ï¼Œå¾ˆå°‘ç›´æ¥å•ç‹¬ä½¿ç”¨ï¼Œå¾€å¾€ä¼šå’Œå¢é‡èšåˆå‡½æ•°ç»“åˆåœ¨ä¸€èµ·ï¼Œå…±åŒå®ç°çª—å£çš„å¤„ç†è®¡ç®—ã€‚ å¢é‡èšåˆå’Œå…¨çª—å£å‡½æ•°çš„ç»“åˆä½¿ç”¨ æˆ‘ä»¬å·²ç»äº†è§£äº† Window API ä¸­ä¸¤ç±»çª—å£å‡½æ•°çš„ç”¨æ³•ï¼Œä¸‹é¢æˆ‘ä»¬å…ˆæ¥åšä¸ªç®€å•çš„æ€»ç»“ã€‚ å¢é‡èšåˆå‡½æ•°å¤„ç†è®¡ç®—ä¼šæ›´é«˜æ•ˆã€‚ä¸¾ä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼Œå¯¹ä¸€ç»„æ•°æ®æ±‚å’Œã€‚å¤§é‡çš„æ•°æ®è¿ç»­ä¸æ–­åˆ°æ¥ï¼Œå…¨çª—å£å‡½æ•°åªæ˜¯æŠŠå®ƒä»¬æ”¶é›†ç¼“å­˜èµ·æ¥ï¼Œå¹¶æ²¡æœ‰å¤„ç†ï¼›åˆ°äº†çª—å£è¦å…³é—­ã€è¾“å‡ºç»“æœçš„æ—¶å€™ï¼Œå†éå†æ‰€æœ‰æ•°æ®ä¾æ¬¡å åŠ ï¼Œå¾—åˆ°æœ€ç»ˆç»“æœã€‚è€Œå¦‚æœæˆ‘ä»¬é‡‡ç”¨å¢é‡èšåˆçš„æ–¹å¼ï¼Œé‚£ä¹ˆåªéœ€è¦ä¿å­˜ä¸€ä¸ªå½“å‰å’Œçš„çŠ¶æ€ï¼Œæ¯ä¸ªæ•°æ®åˆ°æ¥æ—¶å°±ä¼šåšä¸€æ¬¡åŠ æ³•ï¼Œæ›´æ–°çŠ¶æ€ï¼›åˆ°äº†è¦è¾“å‡ºç»“æœçš„æ—¶å€™ï¼Œåªè¦å°†å½“å‰çŠ¶æ€ç›´æ¥æ‹¿å‡ºæ¥å°±å¯ä»¥äº†ã€‚å¢é‡èšåˆç›¸å½“äºæŠŠè®¡ç®—é‡â€œå‡æ‘Šâ€åˆ°äº†çª—å£æ”¶é›†æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œè‡ªç„¶å°±ä¼šæ¯”å…¨çª—å£èšåˆæ›´åŠ é«˜æ•ˆã€è¾“å‡ºæ›´åŠ å®æ—¶ã€‚ è€Œå…¨çª—å£å‡½æ•°çš„ä¼˜åŠ¿åœ¨äºæä¾›äº†æ›´å¤šçš„ä¿¡æ¯ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯æ›´åŠ â€œé€šç”¨â€çš„çª—å£æ“ä½œã€‚å®ƒåªè´Ÿè´£æ”¶é›†æ•°æ®ã€æä¾›ä¸Šä¸‹æ–‡ç›¸å…³ä¿¡æ¯ï¼ŒæŠŠæ‰€æœ‰çš„åŸææ–™éƒ½å‡†å¤‡å¥½ï¼Œè‡³äºæ‹¿æ¥åšä»€ä¹ˆæˆ‘ä»¬å®Œå…¨å¯ä»¥ä»»æ„å‘æŒ¥ã€‚è¿™å°±ä½¿å¾—çª—å£è®¡ç®—æ›´åŠ çµæ´»ï¼ŒåŠŸèƒ½æ›´åŠ å¼ºå¤§ã€‚ æ‰€ä»¥åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¾€å¾€å¸Œæœ›å…¼å…·è¿™ä¸¤è€…çš„ä¼˜ç‚¹ï¼ŒæŠŠå®ƒä»¬ç»“åˆåœ¨ä¸€èµ·ä½¿ç”¨ã€‚Flink çš„Window API å°±ç»™æˆ‘ä»¬å®ç°äº†è¿™æ ·çš„ç”¨æ³•ã€‚ã€ã€ æˆ‘ä»¬ä¹‹å‰åœ¨è°ƒç”¨ WindowedStream çš„.reduce()å’Œ.aggregate()æ–¹æ³•æ—¶ï¼Œåªæ˜¯ç®€å•åœ°ç›´æ¥ä¼ å…¥äº†ä¸€ä¸ª ReduceFunction æˆ– AggregateFunction è¿›è¡Œå¢é‡èšåˆã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå…¶å®è¿˜å¯ä»¥ä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°ï¼šä¸€ä¸ªå…¨çª—å£å‡½æ•°ï¼Œå¯ä»¥æ˜¯ WindowFunction æˆ–è€… ProcessWindowFunctionã€‚ // ReduceFunction ä¸ WindowFunction ç»“åˆ public &lt;R&gt; SingleOutputStreamOperator&lt;R&gt; reduce(ReduceFunction&lt;T&gt; reduceFunction, WindowFunction&lt;T, R, K, W&gt; function) // ReduceFunction ä¸ ProcessWindowFunction ç»“åˆ public &lt;R&gt; SingleOutputStreamOperator&lt;R&gt; reduce(ReduceFunction&lt;T&gt; reduceFunction, ProcessWindowFunction&lt;T, R, K, W&gt; function) // AggregateFunction ä¸ WindowFunction ç»“åˆ public &lt;ACC, V, R&gt; SingleOutputStreamOperator&lt;R&gt; aggregate(AggregateFunction&lt;T, ACC, V&gt; aggFunction, WindowFunction&lt;V, R, K, W&gt; windowFunction) // AggregateFunction ä¸ ProcessWindowFunction ç»“åˆ public &lt;ACC, V, R&gt; SingleOutputStreamOperator&lt;R&gt; aggregate(AggregateFunction&lt;T, ACC, V&gt; aggFunction,ProcessWindowFunction&lt;V, R, K, W&gt; windowFunction) è¿™æ ·è°ƒç”¨çš„å¤„ç†æœºåˆ¶æ˜¯ï¼šåŸºäºç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆå¢é‡èšåˆå‡½æ•°ï¼‰æ¥å¤„ç†çª—å£æ•°æ®ï¼Œæ¯æ¥ä¸€ä¸ªæ•°æ®å°±åšä¸€æ¬¡èšåˆï¼›ç­‰åˆ°çª—å£éœ€è¦è§¦å‘è®¡ç®—æ—¶ï¼Œåˆ™è°ƒç”¨ç¬¬äºŒä¸ªå‚æ•°ï¼ˆå…¨çª—å£å‡½æ•°ï¼‰çš„å¤„ç†é€»è¾‘è¾“å‡ºç»“æœã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„å…¨çª—å£å‡½æ•°å°±ä¸å†ç¼“å­˜æ‰€æœ‰æ•°æ®äº†ï¼Œè€Œæ˜¯ç›´æ¥å°†å¢é‡èšåˆå‡½æ•°çš„ç»“æœæ‹¿æ¥å½“ä½œäº† Iterable ç±»å‹çš„è¾“å…¥ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿™æ—¶çš„å¯è¿­ä»£é›†åˆä¸­å°±åªæœ‰ä¸€ä¸ªå…ƒç´ äº†ã€‚ ä¸‹é¢æˆ‘ä»¬ä¸¾ä¸€ä¸ªå…·ä½“çš„å®ä¾‹æ¥è¯´æ˜ã€‚åœ¨ç½‘ç«™çš„å„ç§ç»Ÿè®¡æŒ‡æ ‡ä¸­ï¼Œä¸€ä¸ªå¾ˆé‡è¦çš„ç»Ÿè®¡æŒ‡æ ‡å°±æ˜¯çƒ­é—¨çš„é“¾æ¥ï¼›æƒ³è¦å¾—åˆ°çƒ­é—¨çš„ urlï¼Œå‰ææ˜¯å¾—åˆ°æ¯ä¸ªé“¾æ¥çš„â€œçƒ­é—¨åº¦â€ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¯ä»¥ç”¨url çš„æµè§ˆé‡ï¼ˆç‚¹å‡»é‡ï¼‰è¡¨ç¤ºçƒ­é—¨åº¦ã€‚æˆ‘ä»¬è¿™é‡Œç»Ÿè®¡ 10 ç§’é’Ÿçš„ url æµè§ˆé‡ï¼Œæ¯ 5 ç§’é’Ÿæ›´æ–°ä¸€æ¬¡ï¼›å¦å¤–ä¸ºäº†æ›´åŠ æ¸…æ™°åœ°å±•ç¤ºï¼Œè¿˜åº”è¯¥æŠŠçª—å£çš„èµ·å§‹ç»“æŸæ—¶é—´ä¸€èµ·è¾“å‡ºã€‚æˆ‘ä»¬å¯ä»¥å®šä¹‰æ»‘åŠ¨çª—å£ï¼Œå¹¶ç»“åˆå¢é‡èšåˆå‡½æ•°å’Œå…¨çª—å£å‡½æ•°æ¥å¾—åˆ°ç»Ÿè®¡ç»“æœã€‚ import org.apache.flink.api.common.eventtime.SerializableTimestampAssigner; import org.apache.flink.api.common.eventtime.WatermarkStrategy; import org.apache.flink.api.common.functions.AggregateFunction; import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.streaming.api.functions.windowing.ProcessWindowFunction; import org.apache.flink.streaming.api.windowing.assigners.SlidingEventTimeWindows; import org.apache.flink.streaming.api.windowing.time.Time; import org.apache.flink.streaming.api.windowing.windows.TimeWindow; import org.apache.flink.util.Collector; public class UrlViewCountExample { public static void main(String[] args) throws Exception { StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); env.setParallelism(1); SingleOutputStreamOperator&lt;Event&gt; stream = env.addSource(new ClickSource()) .assignTimestampsAndWatermarks(WatermarkStrategy.&lt;Event&gt;forMonotonousTimestamps() .withTimestampAssigner(new SerializableTimestampAssigner&lt;Event&gt;() { @Override public long extractTimestamp(Event element, long recordTimestamp) { return element.timestamp; } })); // éœ€è¦æŒ‰ç…§ url åˆ†ç»„ï¼Œå¼€æ»‘åŠ¨çª—å£ç»Ÿè®¡ stream.keyBy(data -&gt; data.url) .window(SlidingEventTimeWindows.of(Time.seconds(10), Time.seconds(5))) // åŒæ—¶ä¼ å…¥å¢é‡èšåˆå‡½æ•°å’Œå…¨çª—å£å‡½æ•° .aggregate(new UrlViewCountAgg(), new UrlViewCountResult()) .print(); env.execute(); } // è‡ªå®šä¹‰å¢é‡èšåˆå‡½æ•°ï¼Œæ¥ä¸€æ¡æ•°æ®å°±åŠ ä¸€ public static class UrlViewCountAgg implements AggregateFunction&lt;Event, Long, Long&gt; { @Override public Long createAccumulator() { return 0L; } @Override public Long add(Event value, Long accumulator) { return accumulator + 1; } @Override public Long getResult(Long accumulator) { return accumulator; } @Override public Long merge(Long a, Long b) { return null; } } // è‡ªå®šä¹‰çª—å£å¤„ç†å‡½æ•°ï¼Œåªéœ€è¦åŒ…è£…çª—å£ä¿¡æ¯ public static class UrlViewCountResult extends ProcessWindowFunction&lt;Long, UrlViewCount, String, TimeWindow&gt; { @Override public void process(String url, Context context, Iterable&lt;Long&gt; elements, Collector&lt;UrlViewCount&gt; out) throws Exception { // ç»“åˆçª—å£ä¿¡æ¯ï¼ŒåŒ…è£…è¾“å‡ºå†…å®¹ Long start = context.window().getStart(); Long end = context.window().getEnd(); // è¿­ä»£å™¨ä¸­åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œå°±æ˜¯å¢é‡èšåˆå‡½æ•°çš„è®¡ç®—ç»“æœ out.collect(new UrlViewCount(url, elements.iterator().next(), start, end)); } } } import java.sql.Timestamp; public class UrlViewCount { public String url; public Long count; public Long windowStart; public Long windowEnd; public UrlViewCount() { } public UrlViewCount(String url, Long count, Long windowStart, Long windowEnd) { this.url = url; this.count = count; this.windowStart = windowStart; this.windowEnd = windowEnd; } @Override public String toString() { return &quot;UrlViewCount{&quot; + &quot;url='&quot; + url + '\\'' + &quot;, count=&quot; + count + &quot;, windowStart=&quot; + new Timestamp(windowStart) + &quot;, windowEnd=&quot; + new Timestamp(windowEnd) + '}'; } } ä»£ç ä¸­ç”¨ä¸€ä¸ª AggregateFunction æ¥å®ç°å¢é‡èšåˆï¼Œæ¯æ¥ä¸€ä¸ªæ•°æ®å°±è®¡æ•°åŠ ä¸€ï¼›å¾—åˆ°çš„ç»“æœäº¤ç»™ ProcessWindowFunctionï¼Œç»“åˆçª—å£ä¿¡æ¯åŒ…è£…æˆæˆ‘ä»¬æƒ³è¦çš„ UrlViewCountï¼Œæœ€ç»ˆè¾“å‡ºç»Ÿè®¡ç»“æœã€‚ æ³¨ï¼šProcessWindowFunction æ˜¯å¤„ç†å‡½æ•°ä¸­çš„ä¸€ç§ï¼Œåé¢æˆ‘ä»¬ä¼šè¯¦ç»†è®²è§£ã€‚è¿™é‡Œåªç”¨å®ƒæ¥å°†å¢é‡èšåˆå‡½æ•°çš„è¾“å‡ºç»“æœåŒ…è£¹ä¸€å±‚çª—å£ä¿¡æ¯ã€‚ çª—å£å¤„ç†çš„ä¸»ä½“è¿˜æ˜¯å¢é‡èšåˆï¼Œè€Œå¼•å…¥å…¨çª—å£å‡½æ•°åˆå¯ä»¥è·å–åˆ°æ›´å¤šçš„ä¿¡æ¯åŒ…è£…è¾“å‡ºï¼Œè¿™æ ·çš„ç»“åˆå…¼å…·äº†ä¸¤ç§çª—å£å‡½æ•°çš„ä¼˜åŠ¿ï¼Œåœ¨ä¿è¯å¤„ç†æ€§èƒ½å’Œå®æ—¶æ€§çš„åŒæ—¶æ”¯æŒäº†æ›´åŠ ä¸°å¯Œçš„åº”ç”¨åœºæ™¯ã€‚ æµ‹è¯•æ°´ä½çº¿å’Œçª—å£çš„ä½¿ç”¨ ä¹‹å‰è®²è¿‡ï¼Œå½“æ°´ä½çº¿åˆ°è¾¾çª—å£ç»“æŸæ—¶é—´æ—¶ï¼Œçª—å£å°±ä¼šé—­åˆä¸å†æ¥æ”¶è¿Ÿåˆ°çš„æ•°æ®ï¼Œå› ä¸ºæ ¹æ®æ°´ä½çº¿çš„å®šä¹‰ï¼Œæ‰€æœ‰å°äºç­‰äºæ°´ä½çº¿çš„æ•°æ®éƒ½å·²ç»åˆ°è¾¾ï¼Œæ‰€ä»¥æ˜¾ç„¶ Flink ä¼šè®¤ä¸ºçª—å£ä¸­çš„æ•°æ®éƒ½åˆ°è¾¾äº†ï¼ˆå°½ç®¡å¯èƒ½å­˜åœ¨è¿Ÿåˆ°æ•°æ®ï¼Œä¹Ÿå°±æ˜¯æ—¶é—´æˆ³å°äºå½“å‰æ°´ä½çº¿çš„æ•°æ®ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ä¹‹å‰ç”Ÿæˆæ°´ä½çº¿ä»£ç  WatermarkTest çš„åŸºç¡€ä¸Šï¼Œå¢åŠ çª—å£åº”ç”¨åšä¸€ä¸‹æµ‹è¯•ï¼š import org.apache.flink.api.common.eventtime.SerializableTimestampAssigner; import org.apache.flink.api.common.eventtime.WatermarkStrategy; import org.apache.flink.api.common.functions.MapFunction; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.streaming.api.functions.windowing.ProcessWindowFunction; import org.apache.flink.streaming.api.windowing.assigners.TumblingEventTimeWindows; import org.apache.flink.streaming.api.windowing.time.Time; import org.apache.flink.streaming.api.windowing.windows.TimeWindow; import org.apache.flink.util.Collector; import java.time.Duration; public class WatermarkTest { public static void main(String[] args) throws Exception { StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); env.setParallelism(1); // å°†æ•°æ®æºæ”¹ä¸º socket æ–‡æœ¬æµï¼Œå¹¶è½¬æ¢æˆ Event ç±»å‹ env.socketTextStream(&quot;localhost&quot;, 7777) .map(new MapFunction&lt;String, Event&gt;() { @Override public Event map(String value) throws Exception { String[] fields = value.split(&quot;,&quot;); return new Event(fields[0].trim(), fields[1].trim(), Long.valueOf(fields[2].trim())); } }) // æ’å…¥æ°´ä½çº¿çš„é€»è¾‘ .assignTimestampsAndWatermarks( // é’ˆå¯¹ä¹±åºæµæ’å…¥æ°´ä½çº¿ï¼Œå»¶è¿Ÿæ—¶é—´è®¾ç½®ä¸º 5s WatermarkStrategy.&lt;Event&gt;forBoundedOutOfOrderness(Duration.ofSeconds(5)) .withTimestampAssigner(new SerializableTimestampAssigner&lt;Event&gt;() { // æŠ½å–æ—¶é—´æˆ³çš„é€»è¾‘ @Override public long extractTimestamp(Event element, long recordTimestamp) { return element.timestamp; } }) ) // æ ¹æ® user åˆ†ç»„ï¼Œå¼€çª—ç»Ÿè®¡ .keyBy(data -&gt; data.user) .window(TumblingEventTimeWindows.of(Time.seconds(10))) .process(new WatermarkTestResult()) .print(); env.execute(); } // è‡ªå®šä¹‰å¤„ç†çª—å£å‡½æ•°ï¼Œè¾“å‡ºå½“å‰çš„æ°´ä½çº¿å’Œçª—å£ä¿¡æ¯ public static class WatermarkTestResult extends ProcessWindowFunction&lt;Event, String, String, TimeWindow&gt; { @Override public void process(String s, Context context, Iterable&lt;Event&gt; elements, Collector&lt;String&gt; out) throws Exception { Long start = context.window().getStart(); Long end = context.window().getEnd(); Long currentWatermark = context.currentWatermark(); Long count = elements.spliterator().getExactSizeIfKnown(); out.collect(&quot;çª—å£&quot; + start + &quot; ~ &quot; + end + &quot;ä¸­å…±æœ‰&quot; + count + &quot;ä¸ªå…ƒç´ ï¼Œçª—å£é—­åˆè®¡ç®—æ—¶ï¼Œæ°´ä½çº¿å¤„äºï¼š&quot; + currentWatermark); } } } æˆ‘ä»¬è¿™é‡Œè®¾ç½®çš„æœ€å¤§å»¶è¿Ÿæ—¶é—´æ˜¯ 5 ç§’ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬åœ¨ç»ˆç«¯å¯åŠ¨ nc ç¨‹åºï¼Œä¹Ÿå°±æ˜¯ nc â€“lk 7777 ç„¶åè¾“å…¥å¦‚ä¸‹æ•°æ®æ—¶ï¼š Alice, ./home, 1000 Alice, ./cart, 2000 Alice, ./prod?id=100, 10000 Alice, ./prod?id=200, 8000 Alice, ./prod?id=300, 15000 æˆ‘ä»¬ä¼šçœ‹åˆ°å¦‚ä¸‹ç»“æœï¼š çª—å£ 0 ~ 10000 ä¸­å…±æœ‰ 3 ä¸ªå…ƒç´ ï¼Œçª—å£é—­åˆè®¡ç®—æ—¶ï¼Œæ°´ä½çº¿å¤„äºï¼š9999 æˆ‘ä»¬å°±ä¼šå‘ç°ï¼Œå½“æœ€åè¾“å…¥[Alice, ./prod?id=300, 15000]æ—¶ï¼Œæµä¸­ä¼šå‘¨æœŸæ€§åœ°ï¼ˆé»˜è®¤ 200æ¯«ç§’ï¼‰æ’å…¥ä¸€ä¸ªæ—¶é—´æˆ³ä¸º 15000L â€“ 5 * 1000L â€“ 1L = 9999 æ¯«ç§’çš„æ°´ä½çº¿ï¼Œå·²ç»åˆ°è¾¾äº†çª—å£[0,10000)çš„ç»“æŸæ—¶é—´ï¼Œæ‰€ä»¥ä¼šè§¦å‘çª—å£çš„é—­åˆè®¡ç®—ã€‚è€Œåé¢å†è¾“å…¥ä¸€æ¡[Alice, ./prod?id=200, 9000]æ—¶ï¼Œå°†ä¸ä¼šæœ‰ä»»ä½•ç»“æœï¼›å› ä¸ºè¿™æ˜¯ä¸€æ¡è¿Ÿåˆ°æ•°æ®ï¼Œå®ƒæ‰€å±äºçš„çª—å£å·²ç»è§¦å‘è®¡ç®—ç„¶åé”€æ¯äº†ï¼ˆçª—å£é»˜è®¤è¢«é”€æ¯ï¼‰ï¼Œæ‰€ä»¥æ— æ³•å†è¿›å…¥åˆ°çª—å£ä¸­ï¼Œè‡ªç„¶ä¹Ÿå°±æ— æ³•æ›´æ–°è®¡ç®—ç»“æœäº†ã€‚çª—å£ä¸­çš„è¿Ÿåˆ°æ•°æ®é»˜è®¤ä¼šè¢«ä¸¢å¼ƒï¼Œè¿™ä¼šå¯¼è‡´è®¡ç®—ç»“æœä¸å¤Ÿå‡†ç¡®ã€‚ å…¶ä»– API å¯¹äºä¸€ä¸ªçª—å£ç®—å­è€Œè¨€ï¼Œçª—å£åˆ†é…å™¨å’Œçª—å£å‡½æ•°æ˜¯å¿…ä¸å¯å°‘çš„ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒFlink è¿˜æä¾›äº†å…¶ä»–ä¸€äº›å¯é€‰çš„ APIï¼Œè®©æˆ‘ä»¬å¯ä»¥æ›´åŠ çµæ´»åœ°æ§åˆ¶çª—å£è¡Œä¸ºã€‚ è§¦å‘å™¨ï¼ˆTriggerï¼‰ è§¦å‘å™¨ä¸»è¦æ˜¯ç”¨æ¥æ§åˆ¶çª—å£ä»€ä¹ˆæ—¶å€™è§¦å‘è®¡ç®—ã€‚æ‰€è°“çš„â€œè§¦å‘è®¡ç®—â€ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯æ‰§è¡Œçª—å£å‡½æ•°ï¼Œæ‰€ä»¥å¯ä»¥è®¤ä¸ºæ˜¯è®¡ç®—å¾—åˆ°ç»“æœå¹¶è¾“å‡ºçš„è¿‡ç¨‹ã€‚ åŸºäº WindowedStream è°ƒç”¨.trigger()æ–¹æ³•ï¼Œå°±å¯ä»¥ä¼ å…¥ä¸€ä¸ªè‡ªå®šä¹‰çš„çª—å£è§¦å‘å™¨ï¼ˆTriggerï¼‰ã€‚ stream.keyBy(...) .window(...) .trigger(new MyTrigger()) Trigger æ˜¯çª—å£ç®—å­çš„å†…éƒ¨å±æ€§ï¼Œæ¯ä¸ªçª—å£åˆ†é…å™¨ï¼ˆWindowAssignerï¼‰éƒ½ä¼šå¯¹åº”ä¸€ä¸ªé»˜è®¤çš„è§¦å‘å™¨ï¼›å¯¹äº Flink å†…ç½®çš„çª—å£ç±»å‹ï¼Œå®ƒä»¬çš„è§¦å‘å™¨éƒ½å·²ç»åšäº†å®ç°ã€‚ä¾‹å¦‚ï¼Œæ‰€æœ‰äº‹ä»¶æ—¶é—´çª—å£ï¼Œé»˜è®¤çš„è§¦å‘å™¨éƒ½æ˜¯ EventTimeTriggerï¼›ç±»ä¼¼è¿˜æœ‰ ProcessingTimeTrigger å’Œ CountTriggerã€‚æ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ä¸éœ€è¦è‡ªå®šä¹‰è§¦å‘å™¨çš„ï¼Œä¸è¿‡æˆ‘ä»¬ä¾ç„¶æœ‰å¿…è¦äº†è§£å®ƒçš„åŸç†ã€‚Trigger æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œè‡ªå®šä¹‰æ—¶å¿…é¡»å®ç°ä¸‹é¢å››ä¸ªæŠ½è±¡æ–¹æ³•ï¼š onElement()ï¼šçª—å£ä¸­æ¯åˆ°æ¥ä¸€ä¸ªå…ƒç´ ï¼Œéƒ½ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚ onEventTime()ï¼šå½“æ³¨å†Œçš„äº‹ä»¶æ—¶é—´å®šæ—¶å™¨è§¦å‘æ—¶ï¼Œå°†è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚ onProcessingTime ()ï¼šå½“æ³¨å†Œçš„å¤„ç†æ—¶é—´å®šæ—¶å™¨è§¦å‘æ—¶ï¼Œå°†è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚ clear()ï¼šå½“çª—å£å…³é—­é”€æ¯æ—¶ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚ä¸€èˆ¬ç”¨æ¥æ¸…é™¤è‡ªå®šä¹‰çš„çŠ¶æ€ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œé™¤äº† clear()æ¯”è¾ƒåƒç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œå…¶ä»–ä¸‰ä¸ªæ–¹æ³•å…¶å®éƒ½æ˜¯å¯¹æŸç§äº‹ä»¶çš„å“åº”ã€‚onElement()æ˜¯å¯¹æµä¸­æ•°æ®å…ƒç´ åˆ°æ¥çš„å“åº”ï¼›è€Œå¦ä¸¤ä¸ªåˆ™æ˜¯å¯¹æ—¶é—´çš„å“åº”ã€‚è¿™å‡ ä¸ªæ–¹æ³•çš„å‚æ•°ä¸­éƒ½æœ‰ä¸€ä¸ªâ€œè§¦å‘å™¨ä¸Šä¸‹æ–‡â€ï¼ˆTriggerContextï¼‰å¯¹è±¡ï¼Œå¯ä»¥ç”¨æ¥æ³¨å†Œå®šæ—¶å™¨å›è°ƒï¼ˆcallbackï¼‰ã€‚è¿™é‡Œæåˆ°çš„â€œå®šæ—¶å™¨â€ï¼ˆTimerï¼‰ï¼Œå…¶å®å°±æ˜¯æˆ‘ä»¬è®¾å®šçš„ä¸€ä¸ªâ€œé—¹é’Ÿâ€ï¼Œä»£è¡¨æœªæ¥æŸä¸ªæ—¶é—´ç‚¹ä¼šæ‰§è¡Œçš„äº‹ä»¶ï¼›å½“æ—¶é—´è¿›å±•åˆ°è®¾å®šçš„å€¼æ—¶ï¼Œå°±ä¼šæ‰§è¡Œå®šä¹‰å¥½çš„æ“ä½œã€‚å¾ˆæ˜æ˜¾ï¼Œå¯¹äºæ—¶é—´çª—å£ï¼ˆTimeWindowï¼‰è€Œè¨€ï¼Œå°±åº”è¯¥æ˜¯åœ¨çª—å£çš„ç»“æŸæ—¶é—´è®¾å®šäº†ä¸€ä¸ªå®šæ—¶å™¨ï¼Œè¿™æ ·åˆ°æ—¶é—´å°±å¯ä»¥è§¦å‘çª—å£çš„è®¡ç®—è¾“å‡ºäº†ã€‚å…³äºå®šæ—¶å™¨çš„å†…å®¹ï¼Œæˆ‘ä»¬åœ¨åé¢è®²è§£å¤„ç†å‡½æ•°ï¼ˆprocess functionï¼‰æ—¶è¿˜ä¼šæåˆ°ã€‚ ä¸Šé¢çš„å‰ä¸‰ä¸ªæ–¹æ³•å¯ä»¥å“åº”äº‹ä»¶ï¼Œé‚£å®ƒä»¬åˆæ˜¯æ€æ ·è·Ÿçª—å£æ“ä½œè”ç³»èµ·æ¥çš„å‘¢ï¼Ÿè¿™å°±éœ€è¦äº†è§£ä¸€ä¸‹å®ƒä»¬çš„è¿”å›å€¼ã€‚è¿™ä¸‰ä¸ªæ–¹æ³•è¿”å›ç±»å‹éƒ½æ˜¯ TriggerResultï¼Œè¿™æ˜¯ä¸€ä¸ªæšä¸¾ç±»å‹ï¼ˆenumï¼‰ï¼Œå…¶ä¸­å®šä¹‰äº†å¯¹çª—å£è¿›è¡Œæ“ä½œçš„å››ç§ç±»å‹ã€‚ CONTINUEï¼ˆç»§ç»­ï¼‰ï¼šä»€ä¹ˆéƒ½ä¸åš FIREï¼ˆè§¦å‘ï¼‰ï¼šè§¦å‘è®¡ç®—ï¼Œè¾“å‡ºç»“æœ PURGEï¼ˆæ¸…é™¤ï¼‰ï¼šæ¸…ç©ºçª—å£ä¸­çš„æ‰€æœ‰æ•°æ®ï¼Œé”€æ¯çª—å£ FIRE_AND_PURGEï¼ˆè§¦å‘å¹¶æ¸…é™¤ï¼‰ï¼šè§¦å‘è®¡ç®—è¾“å‡ºç»“æœï¼Œå¹¶æ¸…é™¤çª—å£ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒTrigger é™¤äº†å¯ä»¥æ§åˆ¶è§¦å‘è®¡ç®—ï¼Œè¿˜å¯ä»¥å®šä¹‰çª—å£ä»€ä¹ˆæ—¶å€™å…³é—­ï¼ˆé”€æ¯ï¼‰ã€‚ä¸Šé¢çš„å››ç§ç±»å‹ï¼Œå…¶å®ä¹Ÿå°±æ˜¯è¿™ä¸¤ä¸ªæ“ä½œäº¤å‰é…å¯¹äº§ç”Ÿçš„ç»“æœã€‚ä¸€èˆ¬æˆ‘ä»¬ä¼šè®¤ä¸ºï¼Œåˆ°äº†çª—å£çš„ç»“æŸæ—¶é—´ï¼Œé‚£ä¹ˆå°±ä¼šè§¦å‘è®¡ç®—è¾“å‡ºç»“æœï¼Œç„¶åå…³é—­çª—å£â€”â€”ä¼¼ä¹è¿™ä¸¤ä¸ªæ“ä½œåº”è¯¥æ˜¯åŒæ—¶å‘ç”Ÿçš„ï¼›ä½† TriggerResult çš„å®šä¹‰å‘Šè¯‰æˆ‘ä»¬ï¼Œä¸¤è€…å¯ä»¥åˆ†å¼€ã€‚ç¨åæˆ‘ä»¬å°±ä¼šçœ‹åˆ°å®ƒä»¬åˆ†å¼€æ“ä½œçš„åœºæ™¯ã€‚ ä¸‹é¢æˆ‘ä»¬ä¸¾ä¸€ä¸ªä¾‹å­ã€‚åœ¨æ—¥å¸¸ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šå¼€æ¯”è¾ƒå¤§çš„çª—å£æ¥è®¡ç®—æ¯ä¸ªçª—å£çš„pv æˆ–è€… uv ç­‰æ•°æ®ã€‚ä½†çª—å£å¼€çš„å¤ªå¤§ï¼Œä¼šä½¿æˆ‘ä»¬çœ‹åˆ°è®¡ç®—ç»“æœçš„æ—¶é—´é—´éš”å˜é•¿ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è§¦å‘å™¨ï¼Œæ¥éš”ä¸€æ®µæ—¶é—´è§¦å‘ä¸€æ¬¡çª—å£è®¡ç®—ã€‚æˆ‘ä»¬åœ¨ä»£ç ä¸­è®¡ç®—äº†æ¯ä¸ª url åœ¨ 10 ç§’æ»šåŠ¨çª—å£çš„ pv æŒ‡æ ‡ï¼Œç„¶åè®¾ç½®äº†è§¦å‘å™¨ï¼Œæ¯éš” 1 ç§’é’Ÿè§¦å‘ä¸€æ¬¡çª—å£çš„è®¡ç®—ã€‚ import org.apache.flink.api.common.eventtime.SerializableTimestampAssigner; import org.apache.flink.api.common.eventtime.WatermarkStrategy; import org.apache.flink.api.common.state.ValueState; import org.apache.flink.api.common.state.ValueStateDescriptor; import org.apache.flink.api.common.typeinfo.Types; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.streaming.api.functions.windowing.ProcessWindowFunction; import org.apache.flink.streaming.api.windowing.assigners.TumblingEventTimeWindows; import org.apache.flink.streaming.api.windowing.time.Time; import org.apache.flink.streaming.api.windowing.triggers.Trigger; import org.apache.flink.streaming.api.windowing.triggers.TriggerResult; import org.apache.flink.streaming.api.windowing.windows.TimeWindow; import org.apache.flink.util.Collector; public class TriggerExample { public static void main(String[] args) throws Exception { StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); env.setParallelism(1); env.addSource(new ClickSource()) .assignTimestampsAndWatermarks(WatermarkStrategy.&lt;Event&gt;forMonotonousTimestamps() .withTimestampAssigner(new SerializableTimestampAssigner&lt;Event&gt;() { @Override public long extractTimestamp(Event event, long l) { return event.timestamp; } }) ) .keyBy(r -&gt; r.url) .window(TumblingEventTimeWindows.of(Time.seconds(10))) .trigger(new MyTrigger()) .process(new WindowResult()) .print(); env.execute(); } public static class WindowResult extends ProcessWindowFunction&lt;Event, UrlViewCount, String, TimeWindow&gt; { @Override public void process(String s, Context context, Iterable&lt;Event&gt; iterable, Collector&lt;UrlViewCount&gt; collector) throws Exception { collector.collect( new UrlViewCount( s, // è·å–è¿­ä»£å™¨ä¸­çš„å…ƒç´ ä¸ªæ•° iterable.spliterator().getExactSizeIfKnown(), context.window().getStart(), context.window().getEnd() ) ); } } public static class MyTrigger extends Trigger&lt;Event, TimeWindow&gt; { @Override public TriggerResult onElement(Event event, long l, TimeWindow timeWindow, TriggerContext triggerContext) throws Exception { ValueState&lt;Boolean&gt; isFirstEvent = triggerContext.getPartitionedState( new ValueStateDescriptor&lt;Boolean&gt;(&quot;first-event&quot;, Types.BOOLEAN) ); if (isFirstEvent.value() == null) { for (long i = timeWindow.getStart(); i &lt; timeWindow.getEnd(); i = i + 1000L) { triggerContext.registerEventTimeTimer(i); } isFirstEvent.update(true); } return TriggerResult.CONTINUE; } @Override public TriggerResult onEventTime(long l, TimeWindow timeWindow, TriggerContext triggerContext) throws Exception { return TriggerResult.FIRE; } @Override public TriggerResult onProcessingTime(long l, TimeWindow timeWindow, TriggerContext triggerContext) throws Exception { return TriggerResult.CONTINUE; } @Override public void clear(TimeWindow timeWindow, TriggerContext triggerContext) throws Exception { ValueState&lt;Boolean&gt; isFirstEvent = triggerContext.getPartitionedState( new ValueStateDescriptor&lt;Boolean&gt;(&quot;first-event&quot;, Types.BOOLEAN) ); isFirstEvent.clear(); } } } è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š UrlViewCount{url='./prod?id=1', count=1, windowStart=2021-07-01 14:44:10.0, windowEnd=2021-07-01 14:44:20.0} UrlViewCount{url='./prod?id=1', count=1, windowStart=2021-07-01 14:44:10.0, windowEnd=2021-07-01 14:44:20.0} UrlViewCount{url='./prod?id=1', count=1, windowStart=2021-07-01 14:44:10.0, windowEnd=2021-07-01 14:44:20.0} UrlViewCount{url='./prod?id=1', count=1, windowStart=2021-07-01 14:44:10.0, windowEnd=2021-07-01 14:44:20.0} ç§»é™¤å™¨ï¼ˆEvictorï¼‰ ç§»é™¤å™¨ä¸»è¦ç”¨æ¥å®šä¹‰ç§»é™¤æŸäº›æ•°æ®çš„é€»è¾‘ã€‚åŸºäº WindowedStream è°ƒç”¨.evictor()æ–¹æ³•ï¼Œå°±å¯ä»¥ä¼ å…¥ä¸€ä¸ªè‡ªå®šä¹‰çš„ç§»é™¤å™¨ï¼ˆEvictorï¼‰ã€‚Evictor æ˜¯ä¸€ä¸ªæ¥å£ï¼Œä¸åŒçš„çª—å£ç±»å‹éƒ½æœ‰å„è‡ªé¢„å®ç°çš„ç§»é™¤å™¨ã€‚ stream.keyBy(...) .window(...) .evictor(new MyEvictor()) Evictor æ¥å£å®šä¹‰äº†ä¸¤ä¸ªæ–¹æ³•ï¼š evictBefore()ï¼šå®šä¹‰æ‰§è¡Œçª—å£å‡½æ•°ä¹‹å‰çš„ç§»é™¤æ•°æ®æ“ä½œ evictAfter()ï¼šå®šä¹‰æ‰§è¡Œçª—å£å‡½æ•°ä¹‹åçš„ä»¥å¤„æ•°æ®æ“ä½œ é»˜è®¤æƒ…å†µä¸‹ï¼Œé¢„å®ç°çš„ç§»é™¤å™¨éƒ½æ˜¯åœ¨æ‰§è¡Œçª—å£å‡½æ•°ï¼ˆwindow fucntionsï¼‰ä¹‹å‰ç§»é™¤æ•°æ®çš„ã€‚ å…è®¸å»¶è¿Ÿï¼ˆAllowed Latenessï¼‰ åœ¨äº‹ä»¶æ—¶é—´è¯­ä¹‰ä¸‹ï¼Œçª—å£ä¸­å¯èƒ½ä¼šå‡ºç°æ•°æ®è¿Ÿåˆ°çš„æƒ…å†µã€‚è¿™æ˜¯å› ä¸ºåœ¨ä¹±åºæµä¸­ï¼Œæ°´ä½çº¿ï¼ˆwatermarkï¼‰å¹¶ä¸ä¸€å®šèƒ½ä¿è¯æ—¶é—´æˆ³æ›´æ—©çš„æ‰€æœ‰æ•°æ®ä¸ä¼šå†æ¥ã€‚å½“æ°´ä½çº¿å·²ç»åˆ°è¾¾çª—å£ç»“æŸæ—¶é—´æ—¶ï¼Œçª—å£ä¼šè§¦å‘è®¡ç®—å¹¶è¾“å‡ºç»“æœï¼Œè¿™æ—¶ä¸€èˆ¬ä¹Ÿå°±è¦é”€æ¯çª—å£äº†ï¼›å¦‚æœçª—å£å…³é—­ä¹‹åï¼Œåˆæœ‰æœ¬å±äºçª—å£å†…çš„æ•°æ®å§—å§—æ¥è¿Ÿï¼Œé»˜è®¤æƒ…å†µä¸‹å°±ä¼šè¢«ä¸¢å¼ƒã€‚è¿™ä¹Ÿå¾ˆå¥½ç†è§£ï¼šçª—å£è§¦å‘è®¡ç®—å°±åƒå‘è½¦ï¼Œå¦‚æœè¦èµ¶çš„è½¦å·²ç»å¼€èµ°äº†ï¼Œåˆä¸èƒ½åå…¶ä»–çš„è½¦ï¼ˆä¿è¯åˆ†é…çª—å£çš„æ­£ç¡®æ€§ï¼‰ï¼Œé‚£å°±åªå¥½æ”¾å¼ƒåç­è½¦äº†ã€‚ ä¸è¿‡åœ¨å¤šæ•°æƒ…å†µä¸‹ï¼Œç›´æ¥ä¸¢å¼ƒæ•°æ®ä¹Ÿä¼šå¯¼è‡´ç»Ÿè®¡ç»“æœä¸å‡†ç¡®ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¸Œæœ›è¯¥ä¸Šè½¦çš„äººéƒ½èƒ½ä¸Šæ¥ã€‚ä¸ºäº†è§£å†³è¿Ÿåˆ°æ•°æ®çš„é—®é¢˜ï¼ŒFlink æä¾›äº†ä¸€ä¸ªç‰¹æ®Šçš„æ¥å£ï¼Œå¯ä»¥ä¸ºçª—å£ç®—å­è®¾ç½®ä¸€ä¸ªâ€œå…è®¸çš„æœ€å¤§å»¶è¿Ÿâ€ï¼ˆAllowed Latenessï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥è®¾å®šå…è®¸å»¶è¿Ÿä¸€æ®µæ—¶é—´ï¼Œåœ¨è¿™æ®µæ—¶é—´å†…ï¼Œçª—å£ä¸ä¼šé”€æ¯ï¼Œç»§ç»­åˆ°æ¥çš„æ•°æ®ä¾ç„¶å¯ä»¥è¿›å…¥çª—å£ä¸­å¹¶è§¦å‘è®¡ç®—ã€‚ç›´åˆ°æ°´ä½çº¿æ¨è¿›åˆ°äº† çª—å£ç»“æŸæ—¶é—´ + å»¶è¿Ÿæ—¶é—´ï¼Œæ‰çœŸæ­£å°†çª—å£çš„å†…å®¹æ¸…ç©ºï¼Œæ­£å¼å…³é—­çª—å£ã€‚ åŸºäº WindowedStream è°ƒç”¨.allowedLateness()æ–¹æ³•ï¼Œä¼ å…¥ä¸€ä¸ª Time ç±»å‹çš„å»¶è¿Ÿæ—¶é—´ï¼Œå°±å¯ä»¥è¡¨ç¤ºå…è®¸è¿™æ®µæ—¶é—´å†…çš„å»¶è¿Ÿæ•°æ®ã€‚ stream.keyBy(...) .window(TumblingEventTimeWindows.of(Time.hours(1))) .allowedLateness(Time.minutes(1)) æ¯”å¦‚ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº† 1 å°æ—¶çš„æ»šåŠ¨çª—å£ï¼Œå¹¶è®¾ç½®äº†å…è®¸ 1 åˆ†é’Ÿçš„å»¶è¿Ÿæ•°æ®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä¸è€ƒè™‘æ°´ä½çº¿å»¶è¿Ÿçš„æƒ…å†µä¸‹ï¼Œå¯¹äº 8 ç‚¹~9 ç‚¹çš„çª—å£ï¼Œæœ¬æ¥åº”è¯¥æ˜¯æ°´ä½çº¿åˆ°è¾¾ 9 ç‚¹æ•´å°±è§¦å‘è®¡ç®—å¹¶å…³é—­çª—å£ï¼›ç°åœ¨å…è®¸å»¶è¿Ÿ 1 åˆ†é’Ÿï¼Œé‚£ä¹ˆ 9 ç‚¹æ•´å°±åªæ˜¯è§¦å‘ä¸€æ¬¡è®¡ç®—å¹¶è¾“å‡ºç»“æœï¼Œå¹¶ä¸ä¼šå…³çª—ã€‚åç»­åˆ°è¾¾çš„æ•°æ®ï¼Œåªè¦å±äº 8 ç‚¹~9 ç‚¹çª—å£ï¼Œä¾ç„¶å¯ä»¥åœ¨ä¹‹å‰ç»Ÿè®¡çš„åŸºç¡€ä¸Šç»§ç»­å åŠ ï¼Œå¹¶ä¸”å†æ¬¡è¾“å‡ºä¸€ä¸ªæ›´æ–°åçš„ç»“æœã€‚ç›´åˆ°æ°´ä½çº¿åˆ°è¾¾äº† 9 ç‚¹é›¶ 1 åˆ†ï¼Œè¿™æ—¶å°±çœŸæ­£æ¸…ç©ºçŠ¶æ€ã€å…³é—­çª—å£ï¼Œä¹‹åå†æ¥çš„è¿Ÿåˆ°æ•°æ®å°±ä¼šè¢«ä¸¢å¼ƒäº†ã€‚ ä»è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ï¼Œçª—å£çš„è§¦å‘è®¡ç®—ï¼ˆFireï¼‰å’Œæ¸…é™¤ï¼ˆPurgeï¼‰æ“ä½œç¡®å®å¯ä»¥åˆ†å¼€ã€‚ä¸è¿‡åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå…è®¸çš„å»¶è¿Ÿæ˜¯ 0ï¼Œè¿™æ ·ä¸€æ—¦æ°´ä½çº¿åˆ°è¾¾äº†çª—å£ç»“æŸæ—¶é—´å°±ä¼šè§¦å‘è®¡ç®—å¹¶æ¸…é™¤çª—å£ï¼Œä¸¤ä¸ªæ“ä½œçœ‹èµ·æ¥å°±æ˜¯åŒæ—¶å‘ç”Ÿäº†ã€‚å½“çª—å£è¢«æ¸…é™¤ï¼ˆå…³é—­ï¼‰ä¹‹åï¼Œå†æ¥çš„æ•°æ®å°±ä¼šè¢«ä¸¢å¼ƒã€‚ å°†è¿Ÿåˆ°çš„æ•°æ®æ”¾å…¥ä¾§è¾“å‡ºæµ æˆ‘ä»¬è‡ªç„¶ä¼šæƒ³åˆ°ï¼Œå³ä½¿å¯ä»¥è®¾ç½®çª—å£çš„å»¶è¿Ÿæ—¶é—´ï¼Œç»ˆå½’è¿˜æ˜¯æœ‰é™çš„ï¼Œåç»­çš„æ•°æ®è¿˜æ˜¯ä¼šè¢«ä¸¢å¼ƒã€‚å¦‚æœä¸æƒ³ä¸¢å¼ƒä»»ä½•ä¸€ä¸ªæ•°æ®ï¼Œåˆè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ Flink è¿˜æä¾›äº†å¦å¤–ä¸€ç§æ–¹å¼å¤„ç†è¿Ÿåˆ°æ•°æ®ã€‚æˆ‘ä»¬å¯ä»¥å°†æœªæ”¶å…¥çª—å£çš„è¿Ÿåˆ°æ•°æ®ï¼Œæ”¾å…¥â€œä¾§è¾“å‡ºæµâ€ï¼ˆside outputï¼‰è¿›è¡Œå¦å¤–çš„å¤„ç†ã€‚æ‰€è°“çš„ä¾§è¾“å‡ºæµï¼Œç›¸å½“äºæ˜¯æ•°æ®æµçš„ä¸€ä¸ªâ€œåˆ†æ”¯â€ï¼Œè¿™ä¸ªæµä¸­å•ç‹¬æ”¾ç½®é‚£äº›é”™è¿‡äº†è¯¥ä¸Šçš„è½¦ã€æœ¬è¯¥è¢«ä¸¢å¼ƒçš„æ•°æ®ã€‚ åŸºäº WindowedStream è°ƒç”¨.sideOutputLateData() æ–¹æ³•ï¼Œå°±å¯ä»¥å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚æ–¹æ³•éœ€è¦ä¼ å…¥ä¸€ä¸ªâ€œè¾“å‡ºæ ‡ç­¾â€ï¼ˆOutputTagï¼‰ï¼Œç”¨æ¥æ ‡è®°åˆ†æ”¯çš„è¿Ÿåˆ°æ•°æ®æµã€‚å› ä¸ºä¿å­˜çš„å°±æ˜¯æµä¸­çš„åŸå§‹æ•°æ®ï¼Œæ‰€ä»¥ OutputTag çš„ç±»å‹ä¸æµä¸­æ•°æ®ç±»å‹ç›¸åŒã€‚ DataStream&lt;Event&gt; stream = env.addSource(...); OutputTag&lt;Event&gt; outputTag = new OutputTag&lt;Event&gt;(&quot;late&quot;) {}; stream.keyBy(...) .window(TumblingEventTimeWindows.of(Time.hours(1))) .sideOutputLateData(outputTag) å°†è¿Ÿåˆ°æ•°æ®æ”¾å…¥ä¾§è¾“å‡ºæµä¹‹åï¼Œè¿˜åº”è¯¥å¯ä»¥å°†å®ƒæå–å‡ºæ¥ã€‚åŸºäºçª—å£å¤„ç†å®Œæˆä¹‹åçš„DataStreamï¼Œè°ƒç”¨.getSideOutput()æ–¹æ³•ï¼Œä¼ å…¥å¯¹åº”çš„è¾“å‡ºæ ‡ç­¾ï¼Œå°±å¯ä»¥è·å–åˆ°è¿Ÿåˆ°æ•°æ®æ‰€åœ¨çš„æµäº†ã€‚ SingleOutputStreamOperator&lt;AggResult&gt; winAggStream = stream.keyBy(...) .window(TumblingEventTimeWindows.of(Time.hours(1))) .sideOutputLateData(outputTag) .aggregate(new MyAggregateFunction()) DataStream&lt;Event&gt; lateStream = winAggStream.getSideOutput(outputTag); è¿™é‡Œæ³¨æ„ï¼ŒgetSideOutput()æ˜¯ SingleOutputStreamOperator çš„æ–¹æ³•ï¼Œè·å–åˆ°çš„ä¾§è¾“å‡ºæµæ•°æ®ç±»å‹åº”è¯¥å’Œ OutputTag æŒ‡å®šçš„ç±»å‹ä¸€è‡´ï¼Œä¸çª—å£èšåˆä¹‹åæµä¸­çš„æ•°æ®ç±»å‹å¯ä»¥ä¸åŒã€‚ çª—å£çš„ç”Ÿå‘½å‘¨æœŸ ç†Ÿæ‚‰äº†çª—å£ API çš„ä½¿ç”¨ï¼Œæˆ‘ä»¬å†å›å¤´æ¢³ç†ä¸€ä¸‹çª—å£æœ¬èº«çš„ç”Ÿå‘½å‘¨æœŸï¼Œè¿™ä¹Ÿæ˜¯å¯¹çª—å£æ‰€æœ‰æ“ä½œçš„ä¸€ä¸ªæ€»ç»“ã€‚ çª—å£çš„åˆ›å»º çª—å£çš„ç±»å‹å’ŒåŸºæœ¬ä¿¡æ¯ç”±çª—å£åˆ†é…å™¨ï¼ˆwindow assignersï¼‰æŒ‡å®šï¼Œä½†çª—å£ä¸ä¼šé¢„å…ˆåˆ›å»ºå¥½ï¼Œè€Œæ˜¯ç”±æ•°æ®é©±åŠ¨åˆ›å»ºã€‚å½“ç¬¬ä¸€ä¸ªåº”è¯¥å±äºè¿™ä¸ªçª—å£çš„æ•°æ®å…ƒç´ åˆ°è¾¾æ—¶ï¼Œå°±ä¼šåˆ›å»ºå¯¹åº”çš„çª—å£ã€‚ çª—å£è®¡ç®—çš„è§¦å‘ é™¤äº†çª—å£åˆ†é…å™¨ï¼Œæ¯ä¸ªçª—å£è¿˜ä¼šæœ‰è‡ªå·±çš„çª—å£å‡½æ•°ï¼ˆwindow functionsï¼‰å’Œè§¦å‘å™¨ï¼ˆtriggerï¼‰ã€‚çª—å£å‡½æ•°å¯ä»¥åˆ†ä¸ºå¢é‡èšåˆå‡½æ•°å’Œå…¨çª—å£å‡½æ•°ï¼Œä¸»è¦å®šä¹‰äº†çª—å£ä¸­è®¡ç®—çš„é€»è¾‘ï¼›è€Œè§¦å‘å™¨åˆ™æ˜¯æŒ‡å®šè°ƒç”¨çª—å£å‡½æ•°çš„æ¡ä»¶ã€‚ å¯¹äºä¸åŒçš„çª—å£ç±»å‹ï¼Œè§¦å‘è®¡ç®—çš„æ¡ä»¶ä¹Ÿä¼šä¸åŒã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªæ»šåŠ¨äº‹ä»¶æ—¶é—´çª—å£ï¼Œåº”è¯¥åœ¨æ°´ä½çº¿åˆ°è¾¾çª—å£ç»“æŸæ—¶é—´çš„æ—¶å€™è§¦å‘è®¡ç®—ï¼Œå±äºâ€œå®šç‚¹å‘è½¦â€ï¼›è€Œä¸€ä¸ªè®¡æ•°çª—å£ï¼Œä¼šåœ¨çª—å£ä¸­å…ƒç´ æ•°é‡è¾¾åˆ°å®šä¹‰å¤§å°æ—¶è§¦å‘è®¡ç®—ï¼Œå±äºâ€œäººæ»¡å°±å‘è½¦â€ã€‚æ‰€ä»¥ Flink é¢„å®šä¹‰çš„çª—å£ç±»å‹éƒ½æœ‰å¯¹åº”å†…ç½®çš„è§¦å‘å™¨ã€‚ å¯¹äºäº‹ä»¶æ—¶é—´çª—å£è€Œè¨€ï¼Œé™¤å»åˆ°è¾¾ç»“æŸæ—¶é—´çš„â€œå®šç‚¹å‘è½¦â€ï¼Œè¿˜æœ‰å¦ä¸€ç§æƒ…å½¢ã€‚å½“æˆ‘ä»¬è®¾ç½®äº†å…è®¸å»¶è¿Ÿï¼Œé‚£ä¹ˆå¦‚æœæ°´ä½çº¿è¶…è¿‡äº†çª—å£ç»“æŸæ—¶é—´ã€ä½†è¿˜æ²¡æœ‰åˆ°è¾¾è®¾å®šçš„æœ€å¤§å»¶è¿Ÿæ—¶é—´ï¼Œè¿™æœŸé—´å†…åˆ°è¾¾çš„è¿Ÿåˆ°æ•°æ®ä¹Ÿä¼šè§¦å‘çª—å£è®¡ç®—ã€‚è¿™ç±»ä¼¼äºæ²¡æœ‰å‡†æ—¶èµ¶ä¸Šç­è½¦çš„äººåˆè¿½ä¸Šäº†è½¦ï¼Œè¿™æ—¶è½¦è¦å†æ¬¡åœé ã€å¼€é—¨ï¼Œå°†æ–°çš„æ•°æ®æ•´åˆç»Ÿè®¡è¿›æ¥ã€‚ çª—å£çš„é”€æ¯ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå½“æ—¶é—´è¾¾åˆ°äº†ç»“æŸç‚¹ï¼Œå°±ä¼šç›´æ¥è§¦å‘è®¡ç®—è¾“å‡ºç»“æœã€è¿›è€Œæ¸…é™¤çŠ¶æ€é”€æ¯çª—å£ã€‚è¿™æ—¶çª—å£çš„é”€æ¯å¯ä»¥è®¤ä¸ºå’Œè§¦å‘è®¡ç®—æ˜¯åŒä¸€æ—¶åˆ»ã€‚è¿™é‡Œéœ€è¦æ³¨æ„ï¼ŒFlink ä¸­åªå¯¹æ—¶é—´çª—å£ï¼ˆTimeWindowï¼‰æœ‰é”€æ¯æœºåˆ¶ï¼›ç”±äºè®¡æ•°çª—å£ï¼ˆCountWindowï¼‰æ˜¯åŸºäºå…¨å±€çª—å£ï¼ˆGlobalWindwï¼‰å®ç°çš„ï¼Œè€Œå…¨å±€çª—å£ä¸ä¼šæ¸…é™¤çŠ¶æ€ï¼Œæ‰€ä»¥å°±ä¸ä¼šè¢«é”€æ¯ã€‚ åœ¨ç‰¹æ®Šçš„åœºæ™¯ä¸‹ï¼Œçª—å£çš„é”€æ¯å’Œè§¦å‘è®¡ç®—ä¼šæœ‰æ‰€ä¸åŒã€‚äº‹ä»¶æ—¶é—´è¯­ä¹‰ä¸‹ï¼Œå¦‚æœè®¾ç½®äº†å…è®¸å»¶è¿Ÿï¼Œé‚£ä¹ˆåœ¨æ°´ä½çº¿åˆ°è¾¾çª—å£ç»“æŸæ—¶é—´æ—¶ï¼Œä»ç„¶ä¸ä¼šé”€æ¯çª—å£ï¼›çª—å£çœŸæ­£è¢«å®Œå…¨åˆ é™¤çš„æ—¶é—´ç‚¹ï¼Œæ˜¯çª—å£çš„ç»“æŸæ—¶é—´åŠ ä¸Šç”¨æˆ·æŒ‡å®šçš„å…è®¸å»¶è¿Ÿæ—¶é—´ã€‚ çª—å£ API è°ƒç”¨æ€»ç»“ åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å½»åº•æ˜ç™½äº† Flink ä¸­çª—å£çš„æ¦‚å¿µå’Œ Window API çš„è°ƒç”¨ï¼Œæˆ‘ä»¬å†ç”¨ä¸€å¼ å›¾åšä¸€ä¸ªå®Œæ•´æ€»ç»“ Window API é¦–å…ˆæŒ‰ç…§æ—¶å€™æŒ‰é”®åˆ†åŒºåˆ†æˆä¸¤ç±»ã€‚keyBy ä¹‹åçš„ KeyedStreamï¼Œå¯ä»¥è°ƒç”¨.window()æ–¹æ³•å£°æ˜æŒ‰é”®åˆ†åŒºçª—å£ï¼ˆKeyed Windowsï¼‰ï¼›è€Œå¦‚æœä¸åš keyByï¼ŒDataStream ä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨.windowAll()å£°æ˜éæŒ‰é”®åˆ†åŒºçª—å£ã€‚ä¹‹åçš„æ–¹æ³•è°ƒç”¨å°±å®Œå…¨ä¸€æ ·äº†ã€‚ æ¥ä¸‹æ¥é¦–å…ˆæ˜¯é€šè¿‡.window()/.windowAll()æ–¹æ³•å®šä¹‰çª—å£åˆ†é…å™¨ï¼Œå¾—åˆ° WindowedStreamï¼›ç„¶ å é€š è¿‡ å„ ç§ è½¬ æ¢ æ–¹ æ³• ï¼ˆ reduce/aggregate/apply/process ï¼‰ ç»™ å‡º çª— å£ å‡½ æ•°(ReduceFunction/AggregateFunction/ProcessWindowFunction)ï¼Œå®šä¹‰çª—å£çš„å…·ä½“è®¡ç®—å¤„ç†é€»è¾‘ï¼Œè½¬æ¢ä¹‹åé‡æ–°å¾—åˆ° DataStreamã€‚è¿™ä¸¤è€…å¿…ä¸å¯å°‘ï¼Œæ˜¯çª—å£ç®—å­ï¼ˆWindowOperatorï¼‰æœ€é‡è¦çš„ç»„æˆéƒ¨åˆ†ã€‚ æ­¤å¤–ï¼Œåœ¨è¿™ä¸¤è€…ä¹‹é—´ï¼Œè¿˜å¯ä»¥åŸºäº WindowedStream è°ƒç”¨.trigger()è‡ªå®šä¹‰è§¦å‘å™¨ã€è°ƒç”¨.evictor()å®šä¹‰ç§»é™¤å™¨ã€è°ƒç”¨.allowedLateness()æŒ‡å®šå…è®¸å»¶è¿Ÿæ—¶é—´ã€è°ƒç”¨.sideOutputLateData()å°†è¿Ÿåˆ°æ•°æ®å†™å…¥ä¾§è¾“å‡ºæµï¼Œè¿™äº›éƒ½æ˜¯å¯é€‰çš„ APIï¼Œä¸€èˆ¬ä¸éœ€è¦å®ç°ã€‚è€Œå¦‚æœå®šä¹‰äº†ä¾§è¾“å‡ºæµï¼Œå¯ä»¥åŸºäºçª—å£èšåˆä¹‹åçš„ DataStream è°ƒç”¨.getSideOutput()è·å–ä¾§è¾“å‡ºæµã€‚ è¿Ÿåˆ°æ•°æ®çš„å¤„ç† æœ‰äº†äº‹ä»¶æ—¶é—´ã€æ°´ä½çº¿å’Œçª—å£çš„ç›¸å…³çŸ¥è¯†ï¼Œç°åœ¨å°±å¯ä»¥ç³»ç»Ÿæ€§åœ°è®¨è®ºä¸€ä¸‹æ€æ ·å¤„ç†è¿Ÿåˆ°æ•°æ®äº†ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œæ‰€è°“çš„â€œè¿Ÿåˆ°æ•°æ®â€ï¼ˆlate dataï¼‰ï¼Œæ˜¯æŒ‡æŸä¸ªæ°´ä½çº¿ä¹‹ååˆ°æ¥çš„æ•°æ®ï¼Œå®ƒçš„æ—¶é—´æˆ³å…¶å®æ˜¯åœ¨æ°´ä½çº¿ä¹‹å‰çš„ã€‚æ‰€ä»¥åªæœ‰åœ¨äº‹ä»¶æ—¶é—´è¯­ä¹‰ä¸‹ï¼Œè®¨è®ºè¿Ÿåˆ°æ•°æ®çš„å¤„ç†æ‰æ˜¯æœ‰æ„ä¹‰çš„ã€‚ äº‹ä»¶æ—¶é—´é‡Œç”¨æ¥è¡¨ç¤ºæ—¶é’Ÿè¿›å±•çš„å°±æ˜¯æ°´ä½çº¿ï¼ˆwatermarkï¼‰ã€‚å¯¹äºä¹±åºæµï¼Œæ°´ä½çº¿æœ¬èº«å°±å¯ä»¥è®¾ç½®ä¸€ä¸ªå»¶è¿Ÿæ—¶é—´ï¼›è€Œåšçª—å£è®¡ç®—æ—¶ï¼Œæˆ‘ä»¬åˆå¯ä»¥è®¾ç½®çª—å£çš„å…è®¸å»¶è¿Ÿæ—¶é—´ï¼›å¦å¤–çª—å£è¿˜æœ‰å°†è¿Ÿåˆ°æ•°æ®è¾“å‡ºåˆ°æµ‹è¾“å‡ºæµçš„ç”¨æ³•ã€‚æ‰€æœ‰çš„è¿™äº›æ–¹æ³•ï¼Œå®ƒä»¬ä¹‹é—´æœ‰ä»€ä¹ˆå…³ç³»ï¼Œæˆ‘ä»¬åˆè¯¥æ€æ ·åˆç†åˆ©ç”¨å‘¢ï¼Ÿè¿™ä¸€èŠ‚æˆ‘ä»¬å°±æ¥è®¨è®ºè¿™ä¸ªé—®é¢˜ã€‚ è®¾ç½®æ°´ä½çº¿å»¶è¿Ÿæ—¶é—´ æ°´ä½çº¿æ˜¯äº‹ä»¶æ—¶é—´çš„è¿›å±•ï¼Œå®ƒæ˜¯æˆ‘ä»¬æ•´ä¸ªåº”ç”¨çš„å…¨å±€é€»è¾‘æ—¶é’Ÿã€‚æ°´ä½çº¿ç”Ÿæˆä¹‹åï¼Œä¼šéšç€æ•°æ®åœ¨ä»»åŠ¡é—´æµåŠ¨ï¼Œä»è€Œç»™æ¯ä¸ªä»»åŠ¡æŒ‡æ˜å½“å‰çš„äº‹ä»¶æ—¶é—´ã€‚æ‰€ä»¥ä»è¿™ä¸ªæ„ä¹‰ä¸Šè®²ï¼Œæ°´ä½çº¿æ˜¯ä¸€ä¸ªè¦†ç›–ä¸‡ç‰©çš„å­˜åœ¨ï¼Œå®ƒå¹¶ä¸åªé’ˆå¯¹äº‹ä»¶æ—¶é—´çª—å£æœ‰æ•ˆã€‚ ä¹‹å‰æˆ‘ä»¬è®²åˆ°è§¦å‘å™¨æ—¶æ›¾æåˆ°è¿‡â€œå®šæ—¶å™¨â€ï¼Œæ—¶é—´çª—å£çš„æ“ä½œåº•å±‚å°±æ˜¯é å®šæ—¶å™¨æ¥æ§åˆ¶è§¦å‘çš„ã€‚æ—¢ç„¶æ˜¯åº•å±‚æœºåˆ¶ï¼Œå®šæ—¶å™¨è‡ªç„¶å°±ä¸å¯èƒ½æ˜¯çª—å£çš„ä¸“åˆ©äº†ï¼›äº‹å®ä¸Šå®ƒæ˜¯ Flink åº•å±‚ APIâ€” â€”å¤„ç†å‡½æ•°ï¼ˆprocess functionï¼‰çš„é‡è¦éƒ¨åˆ†ã€‚ æ‰€ä»¥æ°´ä½çº¿å…¶å®æ˜¯æ‰€æœ‰äº‹ä»¶æ—¶é—´å®šæ—¶å™¨è§¦å‘çš„åˆ¤æ–­æ ‡å‡†ã€‚é‚£ä¹ˆæ°´ä½çº¿çš„å»¶è¿Ÿï¼Œå½“ç„¶ä¹Ÿå°±æ˜¯å…¨å±€æ—¶é’Ÿçš„æ»åï¼Œç›¸å½“äºæ˜¯ä¸Šå¸æ‹¨åŠ¨äº†ç´å¼¦ï¼Œæ‰€æœ‰äººçš„è¡¨éƒ½å˜æ…¢äº†ã€‚ æ—¢ç„¶æ°´ä½çº¿è¿™ä¹ˆé‡è¦ï¼Œé‚£ä¸€èˆ¬æƒ…å†µå°±ä¸åº”è¯¥æŠŠå®ƒçš„å»¶è¿Ÿè®¾ç½®å¾—å¤ªå¤§ï¼Œå¦åˆ™æµå¤„ç†çš„å®æ—¶æ€§å°±ä¼šå¤§å¤§é™ä½ã€‚å› ä¸ºæ°´ä½çº¿çš„å»¶è¿Ÿä¸»è¦æ˜¯ç”¨æ¥å¯¹ä»˜åˆ†å¸ƒå¼ç½‘ç»œä¼ è¾“å¯¼è‡´çš„æ•°æ®ä¹±åºï¼Œè€Œç½‘ç»œä¼ è¾“çš„ä¹±åºç¨‹åº¦ä¸€èˆ¬å¹¶ä¸ä¼šå¾ˆå¤§ï¼Œå¤§å¤šé›†ä¸­åœ¨å‡ æ¯«ç§’è‡³å‡ ç™¾æ¯«ç§’ã€‚æ‰€ä»¥å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¾€å¾€ä¼šç»™æ°´ä½çº¿è®¾ç½®ä¸€ä¸ªâ€œèƒ½å¤Ÿå¤„ç†å¤§å¤šæ•°ä¹±åºæ•°æ®çš„å°å»¶è¿Ÿâ€ï¼Œè§†éœ€æ±‚ä¸€èˆ¬è®¾åœ¨æ¯«ç§’~ç§’çº§ã€‚ å½“æˆ‘ä»¬è®¾ç½®äº†æ°´ä½çº¿å»¶è¿Ÿæ—¶é—´åï¼Œæ‰€æœ‰å®šæ—¶å™¨å°±éƒ½ä¼šæŒ‰ç…§å»¶è¿Ÿåçš„æ°´ä½çº¿æ¥è§¦å‘ã€‚å¦‚æœä¸€ä¸ªæ•°æ®æ‰€åŒ…å«çš„æ—¶é—´æˆ³ï¼Œå°äºå½“å‰çš„æ°´ä½çº¿ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯æ‰€è°“çš„â€œè¿Ÿåˆ°æ•°æ®â€ã€‚ å…è®¸çª—å£å¤„ç†è¿Ÿåˆ°æ•°æ® æ°´ä½çº¿å»¶è¿Ÿè®¾ç½®çš„æ¯”è¾ƒå°ï¼Œé‚£ä¹‹åå¦‚æœä»æœ‰æ•°æ®è¿Ÿåˆ°è¯¥æ€ä¹ˆåŠï¼Ÿå¯¹äºçª—å£è®¡ç®—è€Œè¨€ï¼Œå¦‚æœæ°´ä½çº¿å·²ç»åˆ°äº†çª—å£ç»“æŸæ—¶é—´ï¼Œé»˜è®¤çª—å£å°±ä¼šå…³é—­ï¼Œé‚£ä¹ˆä¹‹åå†æ¥çš„æ•°æ®å°±è¦è¢«ä¸¢å¼ƒäº†ã€‚ è‡ªç„¶æƒ³åˆ°ï¼ŒFlink çš„çª—å£ä¹Ÿæ˜¯å¯ä»¥è®¾ç½®å»¶è¿Ÿæ—¶é—´ï¼Œå…è®¸ç»§ç»­å¤„ç†è¿Ÿåˆ°æ•°æ®çš„ã€‚ è¿™ç§æƒ…å†µä¸‹ï¼Œç”±äºå¤§éƒ¨åˆ†ä¹±åºæ•°æ®å·²ç»è¢«æ°´ä½çº¿çš„å»¶è¿Ÿç­‰åˆ°äº†ï¼Œæ‰€ä»¥å¾€å¾€è¿Ÿåˆ°çš„æ•°æ®ä¸ä¼šå¤ªå¤šã€‚è¿™æ ·ï¼Œæˆ‘ä»¬ä¼šåœ¨æ°´ä½çº¿åˆ°è¾¾çª—å£ç»“æŸæ—¶é—´æ—¶ï¼Œå…ˆå¿«é€Ÿåœ°è¾“å‡ºä¸€ä¸ªè¿‘ä¼¼æ­£ç¡®çš„è®¡ç®—ç»“æœï¼›ç„¶åä¿æŒçª—å£ç»§ç»­ç­‰åˆ°å»¶è¿Ÿæ•°æ®ï¼Œæ¯æ¥ä¸€æ¡æ•°æ®ï¼Œçª—å£å°±ä¼šå†æ¬¡è®¡ç®—ï¼Œå¹¶å°†æ›´æ–°åçš„ç»“æœè¾“å‡ºã€‚è¿™æ ·å°±å¯ä»¥é€æ­¥ä¿®æ­£è®¡ç®—ç»“æœï¼Œæœ€ç»ˆå¾—åˆ°å‡†ç¡®çš„ç»Ÿè®¡å€¼äº†ã€‚ ç±»æ¯”ç­è½¦çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·ç†è§£ï¼šå¤§å¤šæ•°äººæ˜¯åœ¨å‘è½¦æ—¶åˆ»å‰ååˆ°è¾¾çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦æŠŠè¡¨è°ƒæ…¢ï¼Œç¨å¾®ç­‰ä¸€ä¼šå„¿ï¼Œç»å¤§éƒ¨åˆ†äººå°±éƒ½ä¸Šè½¦äº†ï¼Œè¿™ä¸ªæŠŠè¡¨è°ƒæ…¢çš„æ—¶é—´å°±æ˜¯æ°´ä½çº¿çš„å»¶è¿Ÿï¼›åˆ°ç‚¹ä¹‹åï¼Œç­è½¦å°±å‡†æ—¶å‡ºå‘äº†ï¼Œä¸è¿‡å¯èƒ½è¿˜æœ‰è¯¥æ¥çš„äººæ²¡èµ¶ä¸Šã€‚äºæ˜¯æˆ‘ä»¬å°±å…ˆæ…¢æ…¢å¾€å‰å¼€ï¼Œè¿™æ®µæ—¶é—´å†…ï¼Œå¦‚æœè¿Ÿåˆ°çš„äººæŠ“ç‚¹ç´§è¿˜æ˜¯å¯ä»¥è¿½ä¸Šçš„ï¼›å¦‚æœæœ‰äººè¿½ä¸Šæ¥äº†ï¼Œå°±åœè½¦å¼€é—¨è®©ä»–ä¸Šæ¥ï¼Œç„¶åè½¦ç»§ç»­å‘å‰å¼€ã€‚å½“ç„¶æˆ‘ä»¬çš„è½¦ä¸èƒ½ä¸€ç›´æ…¢æ…¢å¼€ï¼Œéœ€è¦æœ‰ä¸€ä¸ªæ—¶é—´é™åˆ¶ï¼Œè¿™å°±æ˜¯çª—å£çš„å…è®¸å»¶è¿Ÿæ—¶é—´ã€‚ä¸€æ—¦è¶…è¿‡äº†è¿™ä¸ªæ—¶é—´ï¼Œç­è½¦å°±ä¸å†åœç•™ï¼Œå¼€ä¸Šé«˜é€Ÿç–¾é©°è€Œå»äº†ã€‚ æ‰€ä»¥æˆ‘ä»¬å°†æ°´ä½çº¿çš„å»¶è¿Ÿå’Œçª—å£çš„å…è®¸å»¶è¿Ÿæ•°æ®ç»“åˆèµ·æ¥ï¼Œæœ€åçš„æ•ˆæœå°±æ˜¯å…ˆå¿«é€Ÿå®æ—¶åœ°è¾“å‡ºä¸€ä¸ªè¿‘ä¼¼çš„ç»“æœï¼Œè€Œåå†ä¸æ–­è°ƒæ•´ï¼Œæœ€ç»ˆå¾—åˆ°æ­£ç¡®çš„è®¡ç®—ç»“æœã€‚å›æƒ³æµå¤„ç†çš„å‘å±•è¿‡ç¨‹ï¼Œè¿™ä¸å°±æ˜¯è‘—åçš„ Lambda æ¶æ„å—ï¼ŸåŸå…ˆéœ€è¦ä¸¤å¥—ç‹¬ç«‹çš„ç³»ç»Ÿæ¥åŒæ—¶ä¿è¯å®æ—¶æ€§å’Œç»“æœçš„æœ€ç»ˆæ­£ç¡®æ€§ï¼Œå¦‚ä»Š Flink ä¸€å¥—ç³»ç»Ÿå°±å…¨éƒ¨æå®šäº†ã€‚ å°†è¿Ÿåˆ°æ•°æ®æ”¾å…¥çª—å£ä¾§è¾“å‡ºæµ å³ä½¿æˆ‘ä»¬æœ‰äº†å‰é¢çš„åŒé‡ä¿è¯ï¼Œå¯çª—å£ä¸èƒ½ä¸€ç›´ç­‰ä¸‹å»ï¼Œæœ€åæ€»è¦çœŸæ­£å…³é—­ã€‚çª—å£ä¸€æ—¦å…³é—­ï¼Œåç»­çš„æ•°æ®å°±éƒ½è¦è¢«ä¸¢å¼ƒäº†ã€‚é‚£å¦‚æœçœŸçš„è¿˜æœ‰æ¼ç½‘ä¹‹é±¼åˆè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ é‚£å°±è¦ç”¨åˆ°æœ€åä¸€æ‹›äº†ï¼šç”¨çª—å£çš„ä¾§è¾“å‡ºæµæ¥æ”¶é›†å…³çª—ä»¥åçš„è¿Ÿåˆ°æ•°æ®ã€‚è¿™ç§æ–¹å¼æ˜¯æœ€åâ€œå…œåº•â€çš„æ–¹æ³•ï¼Œåªèƒ½ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼›å› ä¸ºçª—å£å·²ç»çœŸæ­£å…³é—­ï¼Œæ‰€ä»¥æ˜¯æ— æ³•åŸºäºä¹‹å‰çª—å£çš„ç»“æœç›´æ¥åšæ›´æ–°çš„ã€‚æˆ‘ä»¬åªèƒ½å°†ä¹‹å‰çš„çª—å£è®¡ç®—ç»“æœä¿å­˜ä¸‹æ¥ï¼Œç„¶åè·å–ä¾§è¾“å‡ºæµä¸­çš„è¿Ÿåˆ°æ•°æ®ï¼Œåˆ¤æ–­æ•°æ®æ‰€å±çš„çª—å£ï¼Œæ‰‹åŠ¨å¯¹ç»“æœè¿›è¡Œåˆå¹¶æ›´æ–°ã€‚å°½ç®¡æœ‰äº›çƒ¦çï¼Œå®æ—¶æ€§ä¹Ÿä¸å¤Ÿå¼ºï¼Œä½†èƒ½å¤Ÿä¿è¯æœ€ç»ˆç»“æœä¸€å®šæ˜¯æ­£ç¡®çš„ã€‚ å¦‚æœè¿˜ç”¨èµ¶ç­è½¦æ¥ç±»æ¯”ï¼Œé‚£å°±æ˜¯è½¦å·²ç»ä¸Šé«˜é€Ÿå¼€èµ°äº†ï¼Œè¿™ç­è½¦æ˜¯è‚¯å®šèµ¶ä¸ä¸Šäº†ã€‚ä¸è¿‡æˆ‘ä»¬è¿˜ç•™ä¸‹äº†è¡Œè¿›è·¯çº¿å’Œè”ç³»æ–¹å¼ï¼Œè¿Ÿåˆ°çš„äººå¦‚æœæƒ³åŠæ³•è¾—è½¬åˆ°äº†ç›®çš„åœ°ï¼Œè¿˜æ˜¯å¯ä»¥å’Œå¤§éƒ¨é˜Ÿä¼šåˆçš„ã€‚æœ€ç»ˆï¼Œæ‰€æœ‰è¯¥åˆ°çš„äººéƒ½ä¼šåœ¨ç›®çš„åœ°å‡ºç°ã€‚ æ‰€ä»¥æ€»ç»“èµ·æ¥ï¼ŒFlink å¤„ç†è¿Ÿåˆ°æ•°æ®ï¼Œå¯¹äºç»“æœçš„æ­£ç¡®æ€§æœ‰ä¸‰é‡ä¿éšœï¼šæ°´ä½çº¿çš„å»¶è¿Ÿï¼Œçª—å£å…è®¸è¿Ÿåˆ°æ•°æ®ï¼Œä»¥åŠå°†è¿Ÿåˆ°æ•°æ®æ”¾å…¥çª—å£ä¾§è¾“å‡ºæµã€‚æˆ‘ä»¬å¯ä»¥å›å¿†ä¸€ä¸‹ä¹‹å‰ 6.3.5 å°èŠ‚ç»Ÿè®¡æ¯ä¸ª url æµè§ˆæ¬¡æ•°çš„ä»£ç  UrlViewCountExampleï¼Œç¨ä½œæ”¹è¿›ï¼Œå¢åŠ å¤„ç†è¿Ÿåˆ°æ•°æ®çš„åŠŸèƒ½ã€‚å…·ä½“ä»£ç å¦‚ä¸‹ã€‚ import org.apache.flink.api.common.eventtime.SerializableTimestampAssigner; import org.apache.flink.api.common.eventtime.WatermarkStrategy; import org.apache.flink.api.common.functions.AggregateFunction; import org.apache.flink.api.common.functions.MapFunction; import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.streaming.api.functions.windowing.ProcessWindowFunction; import org.apache.flink.streaming.api.windowing.assigners.TumblingEventTimeWindows; import org.apache.flink.streaming.api.windowing.time.Time; import org.apache.flink.streaming.api.windowing.windows.TimeWindow; import org.apache.flink.util.Collector; import org.apache.flink.util.OutputTag; import java.time.Duration; public class ProcessLateDataExample { public static void main(String[] args) throws Exception { StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); env.setParallelism(1); // è¯»å– socket æ–‡æœ¬æµ SingleOutputStreamOperator&lt;Event&gt; stream = env.socketTextStream(&quot;localhost&quot;, 7777) .map(new MapFunction&lt;String, Event&gt;() { @Override public Event map(String value) throws Exception { String[] fields = value.split(&quot; &quot;); return new Event(fields[0].trim(), fields[1].trim(), Long.valueOf(fields[2].trim())); } }) // æ–¹å¼ä¸€ï¼šè®¾ç½® watermark å»¶è¿Ÿæ—¶é—´ï¼Œ2 ç§’é’Ÿ .assignTimestampsAndWatermarks(WatermarkStrategy.&lt;Event&gt;forBoundedOutOfOrderness(Duration.ofSeconds(2)) .withTimestampAssigner(new SerializableTimestampAssigner&lt;Event&gt;() { @Override public long extractTimestamp(Event element, long recordTimestamp) { return element.timestamp; } })); // å®šä¹‰ä¾§è¾“å‡ºæµæ ‡ç­¾ OutputTag&lt;Event&gt; outputTag = new OutputTag&lt;Event&gt;(&quot;late&quot;) {}; SingleOutputStreamOperator&lt;UrlViewCount&gt; result = stream.keyBy(data -&gt; data.url) .window(TumblingEventTimeWindows.of(Time.seconds(10))) // æ–¹å¼äºŒï¼šå…è®¸çª—å£å¤„ç†è¿Ÿåˆ°æ•°æ®ï¼Œè®¾ç½® 1 åˆ†é’Ÿçš„ç­‰å¾…æ—¶é—´ .allowedLateness(Time.minutes(1)) // æ–¹å¼ä¸‰ï¼šå°†æœ€åçš„è¿Ÿåˆ°æ•°æ®è¾“å‡ºåˆ°ä¾§è¾“å‡ºæµ .sideOutputLateData(outputTag) .aggregate(new UrlViewCountAgg(), new UrlViewCountResult()); result.print(&quot;result&quot;); result.getSideOutput(outputTag).print(&quot;late&quot;); // ä¸ºæ–¹ä¾¿è§‚å¯Ÿï¼Œå¯ä»¥å°†åŸå§‹æ•°æ®ä¹Ÿè¾“å‡º stream.print(&quot;input&quot;); env.execute(); } public static class UrlViewCountAgg implements AggregateFunction&lt;Event, Long, Long&gt; { @Override public Long createAccumulator() { return 0L; } @Override public Long add(Event value, Long accumulator) { return accumulator + 1; } @Override public Long getResult(Long accumulator) { return accumulator; } @Override public Long merge(Long a, Long b) { return null; } } public static class UrlViewCountResult extends ProcessWindowFunction&lt;Long, UrlViewCount, String, TimeWindow&gt; { @Override public void process(String url, Context context, Iterable&lt;Long&gt; elements, Collector&lt;UrlViewCount&gt; out) throws Exception { // ç»“åˆçª—å£ä¿¡æ¯ï¼ŒåŒ…è£…è¾“å‡ºå†…å®¹ Long start = context.window().getStart(); Long end = context.window().getEnd(); out.collect(new UrlViewCount(url, elements.iterator().next(), start, end)); } } } æˆ‘ä»¬è¿˜æ˜¯å…ˆå¯åŠ¨ nc â€“lk 7777ï¼Œç„¶åä¾æ¬¡è¾“å…¥ä»¥ä¸‹æ•°æ®ï¼š Alice, ./home, 1000 Alice, ./home, 2000 Alice, ./home, 10000 Alice, ./home, 9000 Alice, ./cart, 12000 Alice, ./prod?id=100, 15000 Alice, ./home, 9000 Alice, ./home, 8000 Alice, ./prod?id=200, 70000 Alice, ./home, 8000 Alice, ./prod?id=300, 72000 Alice, ./home, 8000 ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ç¨‹åºçš„è¿è¡Œè¿‡ç¨‹ã€‚å½“è¾“å…¥æ•°æ®[Alice, ./home, 10000]æ—¶ï¼Œæ—¶é—´æˆ³ä¸º10000ï¼Œç”±äºè®¾ç½®äº† 2 ç§’é’Ÿçš„æ°´ä½çº¿å»¶è¿Ÿæ—¶é—´ï¼Œæ‰€ä»¥æ­¤æ—¶æ°´ä½çº¿åˆ°è¾¾äº† 8 ç§’ï¼ˆäº‹å®ä¸Šæ˜¯ 7999æ¯«ç§’ï¼Œè¿™é‡Œä¸å†è¿½ç©¶å‡ 1 çš„ç»†èŠ‚ï¼‰ï¼Œå¹¶æ²¡æœ‰è§¦å‘ [0, 10s) çª—å£çš„è®¡ç®—ï¼›æ‰€ä»¥æ¥ä¸‹æ¥æ—¶é—´æˆ³ä¸º 9000çš„æ•°æ®åˆ°æ¥ï¼ŒåŒæ ·å¯ä»¥ç›´æ¥è¿›å…¥çª—å£åšå¢é‡èšåˆã€‚å½“æ—¶é—´æˆ³ä¸º 12000 çš„æ•°æ®åˆ°æ¥æ—¶ï¼ˆæ— æ‰€è°“url æ˜¯ä»€ä¹ˆï¼Œæ‰€æœ‰æ•°æ®éƒ½å¯ä»¥æ¨åŠ¨æ°´ä½çº¿å‰è¿›ï¼‰ï¼Œæ°´ä½çº¿åˆ°è¾¾äº† 12000 â€“ 2 * 1000 = 10000ï¼Œæ‰€ä»¥è§¦å‘äº†[0, 10s) çª—å£çš„è®¡ç®—ï¼Œç¬¬ä¸€æ¬¡è¾“å‡ºäº†çª—å£ç»Ÿè®¡ç»“æœï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š result&gt; UrlViewCount{url='./home,', count=3, windowStart=1970-01-01 08:00:00.0, windowEnd=1970-01-01 08:00:10.0} è¿™é‡Œ count å€¼ä¸º 3ï¼Œå°±åŒ…æ‹¬äº†ä¹‹å‰è¾“å…¥çš„æ—¶é—´æˆ³ä¸º 1000ã€2000ã€9000 çš„ä¸‰æ¡æ•°æ®ã€‚ ä¸è¿‡çª—å£è§¦å‘è®¡ç®—ä¹‹åå¹¶æ²¡æœ‰å…³é—­é”€æ¯ï¼Œè€Œæ˜¯ç»§ç»­ç­‰å¾…è¿Ÿåˆ°æ•°æ®ã€‚ä¹‹åæ—¶é—´æˆ³ä¸º 15000çš„æ•°æ®ç»§ç»­æ¨è¿›æ°´ä½çº¿ï¼Œæ­¤æ—¶æ—¶é’Ÿå·²ç»è¿›å±•åˆ°äº† 13000msï¼›æ­¤æ—¶å†æ¥ä¸€æ¡æ—¶é—´æˆ³ä¸º 9000 çš„æ•°æ®ï¼Œæˆ‘ä»¬ä¼šå‘ç°ç«‹å³è¾“å‡ºäº†ä¸€æ¡ç»Ÿè®¡ç»“æœï¼š result&gt; UrlViewCount{url='./home,', count=4, windowStart=1970-01-01 08:00:00.0, windowEnd=1970-01-01 08:00:10.0} å¾ˆæ˜æ˜¾ï¼Œè¿™ä»ç„¶æ˜¯[0, 10s) çš„çª—å£ï¼Œåœ¨ä¹‹å‰è®¡æ•°å€¼ 3 çš„åŸºç¡€ä¸Šç»§ç»­å åŠ ï¼Œæ›´æ–°ç»Ÿè®¡ç»“æœä¸º4ã€‚æ‰€ä»¥å…è®¸çª—å£å¤„ç†è¿Ÿåˆ°æ•°æ®ä¹‹åï¼Œç›¸å½“äºçª—å£æœ‰äº†ä¸€æ®µç­‰å¾…æ—¶é—´ï¼Œåœ¨è¿™æœŸé—´æ‰€æœ‰çš„è¿Ÿåˆ°æ•°æ®éƒ½ä¼šç«‹å³è§¦å‘çª—å£è®¡ç®—ï¼Œæ›´æ–°ä¹‹å‰çš„ç»“æœã€‚ å› æ­¤ï¼Œä¹‹åæ—¶é—´æˆ³ä¸º 8000 çš„æ•°æ®åˆ°æ¥ï¼ŒåŒæ ·ä¼šç«‹å³è¾“å‡ºï¼š result&gt; UrlViewCount{url='./home,', count=5, windowStart=1970-01-01 08:00:00.0, windowEnd=1970-01-01 08:00:10.0} æˆ‘ä»¬è®¾ç½®çª—å£ç­‰å¾…çš„æ—¶é—´ä¸º 1 åˆ†é’Ÿï¼Œæ‰€ä»¥å½“æ—¶é—´æ¨è¿›åˆ° 10000 + 60 * 1000 = 70000 æ—¶ï¼Œçª—å£å°±ä¼šçœŸæ­£è¢«é”€æ¯ã€‚æ­¤å‰çš„æ‰€æœ‰è¿Ÿåˆ°æ•°æ®å¯ä»¥ç›´æ¥æ›´æ–°çª—å£çš„è®¡ç®—ç»“æœï¼Œè€Œä¹‹åçš„è¿Ÿåˆ°æ•°æ®å·²ç»æ— æ³•æ•´åˆè¿›çª—å£ï¼Œå°±åªèƒ½ç”¨ä¾§è¾“å‡ºæµæ¥æ•è·äº†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„â€œæ—¶é—´â€ä¾ç„¶æ˜¯ç”±æ°´ ä½çº¿æ¥æŒ‡ç¤ºçš„ï¼Œæ‰€ä»¥æ—¶é—´æˆ³ä¸º 70000 çš„æ•°æ®åˆ°æ¥ï¼Œå¹¶ä¸ä¼šè§¦å‘çª—å£çš„é”€æ¯ï¼›å½“æ—¶é—´æˆ³ä¸º 72000çš„æ•°æ®åˆ°æ¥ï¼Œæ°´ä½çº¿æ¨è¿›åˆ°äº† 72000 â€“ 2 * 1000 = 70000ï¼Œæ­¤æ—¶çª—å£çœŸæ­£é”€æ¯å…³é—­ï¼Œä¹‹åå†æ¥çš„è¿Ÿåˆ°æ•°æ®å°±ä¼šè¾“å‡ºåˆ°ä¾§è¾“å‡ºæµäº†ï¼š late&gt; Event{user='Alice,', url='./home,', timestamp=1970-01-01 08:00:08.0} ","link":"https://tianxiawuhao.github.io/5uA_yv-aO/"},{"title":"ç¬¬å…­ç«  Flink ä¸­çš„ Window","content":"Window Window æ¦‚è¿° streaming æµå¼è®¡ç®—æ˜¯ä¸€ç§è¢«è®¾è®¡ç”¨äºå¤„ç†æ— é™æ•°æ®é›†çš„æ•°æ®å¤„ç†å¼•æ“ï¼Œ è€Œæ— é™æ•°æ®é›†æ˜¯æŒ‡ä¸€ç§ä¸æ–­å¢é•¿çš„æœ¬è´¨ä¸Šæ— é™çš„æ•°æ®é›†ï¼Œ è€Œ window æ˜¯ä¸€ç§åˆ‡å‰²æ— é™æ•°æ® ä¸ºæœ‰é™å—è¿›è¡Œå¤„ç†çš„æ‰‹æ®µã€‚ Window æ˜¯æ— é™æ•°æ®æµå¤„ç†çš„æ ¸å¿ƒï¼Œ Window å°†ä¸€ä¸ªæ— é™çš„ stream æ‹†åˆ†æˆæœ‰é™å¤§å°çš„â€ bucketsâ€ æ¡¶ï¼Œ æˆ‘ä»¬å¯ä»¥åœ¨è¿™äº›æ¡¶ä¸Šåšè®¡ç®—æ“ä½œã€‚ Window ç±»å‹ Window å¯ä»¥åˆ†æˆä¸¤ç±»ï¼š CountWindowï¼š æŒ‰ç…§æŒ‡å®šçš„æ•°æ®æ¡æ•°ç”Ÿæˆä¸€ä¸ª Windowï¼Œ ä¸æ—¶é—´æ— å…³ã€‚ TimeWindowï¼š æŒ‰ç…§æ—¶é—´ç”Ÿæˆ Windowã€‚ å¯¹äº TimeWindowï¼Œ å¯ä»¥æ ¹æ®çª—å£å®ç°åŸç†çš„ä¸åŒåˆ†æˆä¸‰ç±»ï¼š æ»šåŠ¨çª—å£ï¼ˆ TumblingWindowï¼‰ ã€ æ»‘åŠ¨çª—å£ï¼ˆ Sliding Windowï¼‰ã€ å’Œä¼šè¯çª—å£ï¼ˆ Session Windowï¼‰ ã€‚ æ»šåŠ¨çª—å£ï¼ˆTumbling Windowsï¼‰ å°†æ•°æ®ä¾æ®å›ºå®šçš„çª—å£é•¿åº¦å¯¹æ•°æ®è¿›è¡Œåˆ‡ç‰‡ã€‚ ç‰¹ç‚¹ï¼š æ—¶é—´å¯¹é½ï¼Œ çª—å£é•¿åº¦å›ºå®šï¼Œ æ²¡æœ‰é‡å ã€‚ æ»šåŠ¨çª—å£åˆ†é…å™¨å°†æ¯ä¸ªå…ƒç´ åˆ†é…åˆ°ä¸€ä¸ªæŒ‡å®šçª—å£å¤§å°çš„çª—å£ä¸­ï¼Œ æ»šåŠ¨çª—å£æœ‰ä¸€ä¸ªå›ºå®šçš„å¤§å°ï¼Œ å¹¶ä¸”ä¸ä¼šå‡ºç°é‡å ã€‚ ä¾‹å¦‚ï¼š å¦‚æœä½ æŒ‡å®šäº†ä¸€ä¸ª 5 åˆ†é’Ÿå¤§å°çš„æ»šåŠ¨çª— å£ï¼Œ çª—å£çš„åˆ›å»ºå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å›¾ æ»šåŠ¨çª—å£ é€‚ç”¨åœºæ™¯ï¼š é€‚åˆåš BI ç»Ÿè®¡ç­‰ï¼ˆ åšæ¯ä¸ªæ—¶é—´æ®µçš„èšåˆè®¡ç®—ï¼‰ ã€‚ æ»‘åŠ¨çª—å£ï¼ˆSliding Windowsï¼‰ æ»‘åŠ¨çª—å£æ˜¯å›ºå®šçª—å£çš„æ›´å¹¿ä¹‰çš„ä¸€ç§å½¢å¼ï¼Œ æ»‘åŠ¨çª—å£ç”±å›ºå®šçš„çª—å£é•¿åº¦å’Œæ»‘åŠ¨é—´éš”ç»„æˆã€‚ ç‰¹ç‚¹ï¼šæ—¶é—´å¯¹é½ï¼Œ çª—å£é•¿åº¦å›ºå®šï¼Œ å¯ä»¥æœ‰é‡å ã€‚ æ»‘åŠ¨çª—å£åˆ†é…å™¨å°†å…ƒç´ åˆ†é…åˆ°å›ºå®šé•¿åº¦çš„çª—å£ä¸­ï¼Œ ä¸æ»šåŠ¨çª—å£ç±»ä¼¼ï¼Œ çª—å£çš„å¤§å°ç”±çª—å£å¤§å°å‚æ•°æ¥é…ç½®ï¼Œ å¦ä¸€ä¸ªçª—å£æ»‘åŠ¨å‚æ•°æ§åˆ¶æ»‘åŠ¨çª—å£å¼€å§‹çš„é¢‘ç‡ã€‚ å› æ­¤ï¼Œ æ»‘åŠ¨çª—å£å¦‚æœæ»‘åŠ¨å‚æ•°å°äºçª—å£å¤§å°çš„è¯ï¼Œ çª—å£æ˜¯å¯ä»¥é‡å çš„ï¼Œ åœ¨è¿™ç§æƒ…å†µä¸‹å…ƒç´ ä¼šè¢«åˆ†é…åˆ°å¤šä¸ªçª—å£ä¸­ã€‚ ä¾‹å¦‚ï¼Œ ä½ æœ‰ 10 åˆ†é’Ÿçš„çª—å£å’Œ 5 åˆ†é’Ÿçš„æ»‘åŠ¨ï¼Œ é‚£ä¹ˆæ¯ä¸ªçª—å£ä¸­ 5 åˆ†é’Ÿçš„çª—å£é‡ŒåŒ…å«ç€ä¸Šä¸ª 10 åˆ†é’Ÿäº§ç”Ÿçš„æ•°æ®ï¼Œ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å›¾ æ»‘åŠ¨çª—å£ é€‚ç”¨åœºæ™¯ï¼š å¯¹æœ€è¿‘ä¸€ä¸ªæ—¶é—´æ®µå†…çš„ç»Ÿè®¡ï¼ˆ æ±‚æŸæ¥å£æœ€è¿‘ 5min çš„å¤±è´¥ç‡æ¥å†³å®šæ˜¯ å¦è¦æŠ¥è­¦ï¼‰ ã€‚ ä¼šè¯çª—å£ï¼ˆSession Windowsï¼‰ ç”±ä¸€ç³»åˆ—äº‹ä»¶ç»„åˆä¸€ä¸ªæŒ‡å®šæ—¶é—´é•¿åº¦çš„ timeout é—´éš™ç»„æˆï¼Œ ç±»ä¼¼äº web åº”ç”¨çš„sessionï¼Œ ä¹Ÿå°±æ˜¯ä¸€æ®µæ—¶é—´æ²¡æœ‰æ¥æ”¶åˆ°æ–°æ•°æ®å°±ä¼šç”Ÿæˆæ–°çš„çª—å£ã€‚ ç‰¹ç‚¹ï¼š æ—¶é—´æ— å¯¹é½ã€‚ session çª—å£åˆ†é…å™¨é€šè¿‡ session æ´»åŠ¨æ¥å¯¹å…ƒç´ è¿›è¡Œåˆ†ç»„ï¼Œ session çª—å£è·Ÿæ»šåŠ¨çª—å£å’Œæ»‘åŠ¨çª—å£ç›¸æ¯”ï¼Œ ä¸ä¼šæœ‰é‡å å’Œå›ºå®šçš„å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´çš„æƒ…å†µï¼Œ ç›¸åï¼Œ å½“å®ƒåœ¨ä¸€ä¸ªå›ºå®šçš„æ—¶é—´å‘¨æœŸå†…ä¸å†æ”¶åˆ°å…ƒç´ ï¼Œ å³éæ´»åŠ¨é—´éš”äº§ç”Ÿï¼Œ é‚£ä¸ªè¿™ä¸ªçª—å£å°±ä¼šå…³ é—­ã€‚ ä¸€ä¸ª session çª—å£é€šè¿‡ä¸€ä¸ª session é—´éš”æ¥é…ç½®ï¼Œ è¿™ä¸ª session é—´éš”å®šä¹‰äº†éæ´»è·ƒ å‘¨æœŸçš„é•¿åº¦ï¼Œ å½“è¿™ä¸ªéæ´»è·ƒå‘¨æœŸäº§ç”Ÿï¼Œ é‚£ä¹ˆå½“å‰çš„ session å°†å…³é—­å¹¶ä¸”åç»­çš„å…ƒç´ å°† è¢«åˆ†é…åˆ°æ–°çš„ session çª—å£ä¸­å»ã€‚ å›¾ ä¼šè¯çª—å£ Window API TimeWindow TimeWindow æ˜¯å°†æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„æ‰€æœ‰æ•°æ®ç»„æˆä¸€ä¸ª windowï¼Œ ä¸€æ¬¡å¯¹ä¸€ä¸ª window é‡Œé¢çš„æ‰€æœ‰æ•°æ®è¿›è¡Œè®¡ç®—ã€‚ æ»šåŠ¨çª—å£ Flink é»˜è®¤çš„æ—¶é—´çª—å£æ ¹æ® Processing Time è¿›è¡Œçª—å£çš„åˆ’åˆ†ï¼Œ å°† Flink è·å–åˆ°çš„ æ•°æ®æ ¹æ®è¿›å…¥ Flink çš„æ—¶é—´åˆ’åˆ†åˆ°ä¸åŒçš„çª—å£ä¸­ã€‚ æ—¶é—´é—´éš”å¯ä»¥é€šè¿‡ Time.milliseconds(x)ï¼Œ Time.seconds(x)ï¼Œ Time.minutes(x)ç­‰å…¶ ä¸­çš„ä¸€ä¸ªæ¥æŒ‡å®šã€‚ import com.tan.flink.bean.SensorReading; import com.tan.flink.source.SourceFromCustom; import org.apache.flink.streaming.api.datastream.DataStreamSource; import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.streaming.api.windowing.time.Time; public class TimeWindow_Tumbling { public static void main(String[] args) throws Exception { StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); DataStreamSource&lt;SensorReading&gt; inputDataStream = env.addSource(new SourceFromCustom.CustomSource()); SingleOutputStreamOperator&lt;SensorReading&gt; resultDataStream = inputDataStream.keyBy(&quot;id&quot;) .timeWindow(Time.seconds(5L)) // æ»šåŠ¨æ—¶é—´çª—å£å¤§å° .maxBy(&quot;temperature&quot;); resultDataStream.print(); env.execute(); } } æ»‘åŠ¨çª—å£ï¼ˆSlidingEventTimeWindowsï¼‰ æ»‘åŠ¨çª—å£å’Œæ»šåŠ¨çª—å£çš„å‡½æ•°åæ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œ åªæ˜¯åœ¨ä¼ å‚æ•°æ—¶éœ€è¦ä¼ å…¥ä¸¤ä¸ªå‚ æ•°ï¼Œ ä¸€ä¸ªæ˜¯ window_sizeï¼Œ ä¸€ä¸ªæ˜¯ sliding_sizeã€‚ä¸‹é¢ä»£ç ä¸­çš„ sliding_size è®¾ç½®ä¸ºäº† 5sï¼Œ ä¹Ÿå°±æ˜¯è¯´ï¼Œ æ¯ 5s å°±è®¡ç®—è¾“å‡ºç»“æœä¸€æ¬¡ï¼Œæ¯ä¸€æ¬¡è®¡ç®—çš„ window èŒƒå›´æ˜¯ 15s å†…çš„æ‰€æœ‰å…ƒç´ ã€‚ æ—¶é—´é—´éš”å¯ä»¥é€šè¿‡ Time.milliseconds(x)ï¼Œ Time.seconds(x)ï¼Œ Time.minutes(x)ç­‰å…¶ ä¸­çš„ä¸€ä¸ªæ¥æŒ‡å®šã€‚ import com.tan.flink.bean.SensorReading; import com.tan.flink.source.SourceFromCustom; import org.apache.flink.streaming.api.datastream.DataStreamSource; import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.streaming.api.windowing.time.Time; public class TimeWindow_Sliding { public static void main(String[] args) throws Exception { StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); DataStreamSource&lt;SensorReading&gt; inputDataStream = env.addSource(new SourceFromCustom.CustomSource()); SingleOutputStreamOperator&lt;SensorReading&gt; resultDataStream = inputDataStream.keyBy(&quot;id&quot;) .timeWindow(Time.seconds(15L), Time.seconds(5)) // çª—å£å¤§å°15ç§’ æ»‘åŠ¨å¤§å°5ç§’ .minBy(&quot;temperature&quot;); resultDataStream.print(); env.execute(); } } CountWindow CountWindow æ ¹æ®çª—å£ä¸­ç›¸åŒ key å…ƒç´ çš„æ•°é‡æ¥è§¦å‘æ‰§è¡Œï¼Œ æ‰§è¡Œæ—¶åªè®¡ç®—å…ƒç´ æ•°é‡è¾¾åˆ°çª—å£å¤§å°çš„ key å¯¹åº”çš„ç»“æœã€‚ æ³¨æ„ï¼š CountWindow çš„ window_size æŒ‡çš„æ˜¯ç›¸åŒ Key çš„å…ƒç´ çš„ä¸ªæ•°ï¼Œ ä¸æ˜¯è¾“å…¥ çš„æ‰€æœ‰å…ƒç´ çš„æ€»æ•°ã€‚ 1 æ»šåŠ¨çª—å£ é»˜è®¤çš„ CountWindow æ˜¯ä¸€ä¸ªæ»šåŠ¨çª—å£ï¼Œ åªéœ€è¦æŒ‡å®šçª—å£å¤§å°å³å¯ï¼Œ å½“å…ƒç´ æ•°é‡è¾¾åˆ°çª—å£å¤§å°æ—¶ï¼Œ å°±ä¼šè§¦å‘çª—å£çš„æ‰§è¡Œã€‚ import com.tan.flink.bean.SensorReading; import com.tan.flink.source.SourceFromCustom; import org.apache.flink.streaming.api.datastream.DataStreamSource; import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; public class CountWindow_Tumbling { public static void main(String[] args) throws Exception { StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); DataStreamSource&lt;SensorReading&gt; inputDataStream = env.addSource(new SourceFromCustom.CustomSource()); SingleOutputStreamOperator&lt;SensorReading&gt; resultDataStream = inputDataStream.keyBy(&quot;id&quot;) .countWindow(3) .maxBy(&quot;temperature&quot;); resultDataStream.print(); env.execute(); } } 2 æ»‘åŠ¨çª—å£ æ»‘åŠ¨çª—å£å’Œæ»šåŠ¨çª—å£çš„å‡½æ•°åæ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œ åªæ˜¯åœ¨ä¼ å‚æ•°æ—¶éœ€è¦ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œ ä¸€ä¸ªæ˜¯ window_sizeï¼Œ ä¸€ä¸ªæ˜¯ sliding_sizeã€‚ ä¸‹é¢ä»£ç ä¸­çš„ sliding_size è®¾ç½®ä¸ºäº† 2ï¼Œ ä¹Ÿå°±æ˜¯è¯´ï¼Œ æ¯æ”¶åˆ°ä¸¤ä¸ªç›¸åŒ key çš„æ•°æ®å°±è®¡ç®—ä¸€æ¬¡ï¼Œ æ¯ä¸€æ¬¡è®¡ç®—çš„ window èŒƒå›´æ˜¯ 10 ä¸ªå…ƒç´ ã€‚ import com.tan.flink.bean.SensorReading; import com.tan.flink.source.SourceFromCustom; import org.apache.flink.streaming.api.datastream.DataStreamSource; import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; public class CountWindow_Sliding { public static void main(String[] args) throws Exception { StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); DataStreamSource&lt;SensorReading&gt; inputDataStream = env.addSource(new SourceFromCustom.CustomSource()); SingleOutputStreamOperator&lt;SensorReading&gt; resultDataStream = inputDataStream.keyBy(&quot;id&quot;) .countWindow(10, 2) .minBy(&quot;temperature&quot;); resultDataStream.print(); env.execute(); } } window function window function å®šä¹‰äº†è¦å¯¹çª—å£ä¸­æ”¶é›†çš„æ•°æ®åšçš„è®¡ç®—æ“ä½œï¼Œ ä¸»è¦å¯ä»¥åˆ†ä¸ºä¸¤ ç±»ï¼š å¢é‡èšåˆå‡½æ•°ï¼ˆ incremental aggregation functionsï¼‰ æ¯æ¡æ•°æ®åˆ°æ¥å°±è¿›è¡Œè®¡ç®—ï¼Œ ä¿æŒä¸€ä¸ªç®€å•çš„çŠ¶æ€ã€‚ å…¸å‹çš„å¢é‡èšåˆå‡½æ•°æœ‰ ReduceFunction, AggregateFunctionã€‚ å…¨çª—å£å‡½æ•°ï¼ˆ full window functionsï¼‰ å…ˆæŠŠçª—å£æ‰€æœ‰æ•°æ®æ”¶é›†èµ·æ¥ï¼Œ ç­‰åˆ°è®¡ç®—çš„æ—¶å€™ä¼šéå†æ‰€æœ‰æ•°æ®ã€‚ ProcessWindowFunction å°±æ˜¯ä¸€ä¸ªå…¨çª—å£å‡½æ•°ã€‚ å…¶å®ƒå¯é€‰ API trigger() â€”â€” è§¦å‘å™¨ å®šä¹‰ window ä»€ä¹ˆæ—¶å€™å…³é—­ï¼Œ è§¦å‘è®¡ç®—å¹¶è¾“å‡ºç»“æœ evitor() â€”â€” ç§»é™¤å™¨,å®šä¹‰ç§»é™¤æŸäº›æ•°æ®çš„é€»è¾‘ allowedLateness() â€”â€” å…è®¸å¤„ç†è¿Ÿåˆ°çš„æ•°æ® sideOutputLateData() â€”â€” å°†è¿Ÿåˆ°çš„æ•°æ®æ”¾å…¥ä¾§è¾“å‡ºæµ getSideOutput() â€”â€” è·å–ä¾§è¾“å‡º ","link":"https://tianxiawuhao.github.io/FnbZ5kiHQ/"},{"title":"ç¬¬äº”ç«  Flink æµå¤„ç† API","content":"Environment getExecutionEnvironment åˆ›å»ºä¸€ä¸ªæ‰§è¡Œç¯å¢ƒï¼Œ è¡¨ç¤ºå½“å‰æ‰§è¡Œç¨‹åºçš„ä¸Šä¸‹æ–‡ã€‚ å¦‚æœç¨‹åºæ˜¯ç‹¬ç«‹è°ƒç”¨çš„ï¼Œ åˆ™ æ­¤æ–¹æ³•è¿”å›æœ¬åœ°æ‰§è¡Œç¯å¢ƒï¼› å¦‚æœä»å‘½ä»¤è¡Œå®¢æˆ·ç«¯è°ƒç”¨ç¨‹åºä»¥æäº¤åˆ°é›†ç¾¤ï¼Œ åˆ™æ­¤æ–¹æ³• è¿”å›æ­¤é›†ç¾¤çš„æ‰§è¡Œç¯å¢ƒï¼Œ ä¹Ÿå°±æ˜¯è¯´ï¼Œ getExecutionEnvironment ä¼šæ ¹æ®æŸ¥è¯¢è¿è¡Œçš„æ–¹ å¼å†³å®šè¿”å›ä»€ä¹ˆæ ·çš„è¿è¡Œç¯å¢ƒï¼Œ æ˜¯æœ€å¸¸ç”¨çš„ä¸€ç§åˆ›å»ºæ‰§è¡Œç¯å¢ƒçš„æ–¹å¼ã€‚ // æ‰¹å¤„ç†ç¯å¢ƒ ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment() // æµå¼æ•°æ®å¤„ç†ç¯å¢ƒ StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment() å¦‚æœæ²¡æœ‰è®¾ç½®å¹¶è¡Œåº¦ï¼Œ ä¼šä»¥ flink-conf.yaml ä¸­çš„é…ç½®ä¸ºå‡†ï¼Œ é»˜è®¤æ˜¯ 1ã€‚ createLocalEnvironment è¿”å›æœ¬åœ°æ‰§è¡Œç¯å¢ƒï¼Œ éœ€è¦åœ¨è°ƒç”¨æ—¶æŒ‡å®šé»˜è®¤çš„å¹¶è¡Œåº¦ã€‚ LocalStreamEnvironment localEnvironment = StreamExecutionEnvironment.createLocalEnvironment(1); createRemoteEnvironment è¿”å›é›†ç¾¤æ‰§è¡Œç¯å¢ƒï¼Œ å°† Jar æäº¤åˆ°è¿œç¨‹æœåŠ¡å™¨ã€‚ éœ€è¦åœ¨è°ƒç”¨æ—¶æŒ‡å®š JobManagerçš„ IP å’Œç«¯å£å·ï¼Œ å¹¶æŒ‡å®šè¦åœ¨é›†ç¾¤ä¸­è¿è¡Œçš„ Jar åŒ…ã€‚ final ExecutionEnvironment env = ExecutionEnvironment.createRemoteEnvironment( cluster.getHostname(), cluster.getPort(), config ); scala val env = ExecutionEnvironment.createRemoteEnvironment(&quot;jobmanage-hostname&quot;, 6123,&quot;YOURPATH//wordcount.jar&quot;) setParallelism // ä¸ºäº†æ‰“å°åˆ°æ§åˆ¶å°çš„ç»“æœä¸ä¹±åºï¼Œæˆ‘ä»¬é…ç½®å…¨å±€çš„å¹¶å‘ä¸º1ï¼Œæ”¹å˜å¹¶å‘å¯¹ç»“æœæ­£ç¡®æ€§æ²¡æœ‰å½±å“ env.setParallelism(1); Source ä»é›†åˆè¯»å–æ•°æ® package myflink; import lombok.*; //ä¼ æ„Ÿå™¨æ¸©åº¦è¯»æ•°çš„æ•°æ®ç±»å‹ @Data @NoArgsConstructor @AllArgsConstructor @Builder @ToString public class SensorReading { //å±æ€§ id,æ—¶é—´æˆ³,æ¸©åº¦å€¼ private String id; private Long timestamp; private Double temperature; } public class SourceReading_Collection { public static void main(String[] args) throws Exception { //åˆ›å»ºæ‰§è¡Œç¯å¢ƒ StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); //è®¾ç½®å¹¶è¡Œè°ƒåº¦ //env.setParallelism(1); //ä»é›†åˆä¸­è¯»å–æ•°æ® //å±æ€§ id,æ—¶é—´æˆ³,æ¸©åº¦å€¼ DataStream&lt;SensorReading&gt; dataStream = env.fromCollection(Arrays.asList(new SensorReading(&quot;sensor_1&quot;, 1537718199L, 35.8), new SensorReading(&quot;sensor_6&quot;, 1547718201L, 15.4), new SensorReading(&quot;sensor_7&quot;, 1547718202L, 6.7), new SensorReading(&quot;sensor_10&quot;, 1547718205L, 38.1))); DataStream&lt;Integer&gt; integerDataStream = env.fromElements(1, 2, 4, 67, 189); //æ‰“å°è¾“å‡º dataStream.print(&quot;data&quot;); integerDataStream.print(&quot;int&quot;); //æ‰§è¡Œ Flinkçš„jobName env.execute(&quot;SensorReading&quot;); } } ä»æ–‡ä»¶è¯»å–æ•°æ® public class SourceReading_File { public static void main(String[] args) throws Exception { //åˆ›å»ºæ‰§è¡Œç¯å¢ƒ StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); //è¯»å–æ–‡ä»¶ DataStream&lt;String&gt; dataStream = env.readTextFile(filePath,charsetName); //æ‰“å°è¾“å‡º dataStream.print(&quot;data&quot;); //æ‰§è¡Œ Flinkçš„jobName env.execute(&quot;SensorReading&quot;); } } ä»¥ kafka æ¶ˆæ¯é˜Ÿåˆ—çš„æ•°æ®ä½œä¸ºæ¥æº éœ€è¦å¼•å…¥ kafka è¿æ¥å™¨çš„ä¾èµ–ï¼š pom.xml &lt;!-- https://mvnrepository.com/artifact/org.apache.flink/flink-connector-kafka-0.11 --&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-connector-kafka-0.11_2.12&lt;/artifactId&gt; &lt;version&gt;1.10.1&lt;/version&gt; &lt;/dependency&gt; //1. åˆ›å»ºä¸€ä¸ªTopicåä¸ºâ€œtest20201217â€çš„ä¸»é¢˜ kafka-topics.bat --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic test20201217 //2. åˆ›å»ºproducer(ç”Ÿäº§è€…)ï¼Œç”Ÿäº§ä¸»é¢˜çš„æ¶ˆæ¯ kafka-console-producer.bat --broker-list localhost:9092 --topic test20201217 //3. åˆ›å»ºconsumer(æ¶ˆè´¹è€…)ï¼Œæ¶ˆè´¹ä¸»é¢˜æ¶ˆæ¯ kafka-console-consumer.bat --bootstrap-server localhost:9092 --topic test20201217 å…·ä½“ä»£ç å¦‚ä¸‹ï¼š /** * kafkaSource * * å¾æŒ‡å®šçš„offsetå‡ºæ¶ˆè´¹kafka */ public class StreamingKafkaSource { public static void main(String[] args) throws Exception { // åˆ›å»ºæµå¤„ç†çš„æ‰§è¡Œç¯å¢ƒ StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); // é…ç½®KafKa //é…ç½®KafKaå’ŒZookeeperçš„ipå’Œç«¯å£ Properties properties = new Properties(); properties.setProperty(&quot;bootstrap.servers&quot;, &quot;localhost:9092&quot;); properties.setProperty(&quot;zookeeper.connect&quot;, &quot;localhost:2181&quot;); properties.setProperty(&quot;group.id&quot;, &quot;consumer-group&quot;); //å°†kafkaå’Œzookeeperé…ç½®ä¿¡æ¯åŠ è½½åˆ°Flinkçš„æ‰§è¡Œç¯å¢ƒå½“ä¸­StreamExecutionEnvironment FlinkKafkaConsumer011&lt;String&gt; myConsumer = new FlinkKafkaConsumer011&lt;String&gt;(&quot;test20201217&quot;, new SimpleStringSchema(), properties); //æ·»åŠ æ•°æ®æºï¼Œæ­¤å¤„é€‰ç”¨æ•°æ®æµçš„æ–¹å¼ï¼Œå°†KafKaä¸­çš„æ•°æ®è½¬æ¢æˆFlinkçš„DataStreamç±»å‹ DataStream&lt;String&gt; stream = env.addSource(myConsumer); //æ‰“å°è¾“å‡º stream.print(); //æ‰§è¡ŒJobï¼ŒFlinkæ‰§è¡Œç¯å¢ƒå¿…é¡»è¦æœ‰jobçš„æ‰§è¡Œæ­¥éª¤ï¼Œè€Œä»¥ä¸Šçš„æ•´ä¸ªè¿‡ç¨‹å°±æ˜¯ä¸€ä¸ªJob env.execute(&quot;kafka sink test&quot;); } } è‡ªå®šä¹‰ Source é™¤äº†ä»¥ä¸Šçš„ source æ•°æ®æ¥æºï¼Œ æˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰ sourceã€‚ éœ€è¦åšçš„ï¼Œ åªæ˜¯ä¼ å…¥ä¸€ä¸ª SourceFunction å°±å¯ä»¥ã€‚ å…·ä½“è°ƒç”¨å¦‚ä¸‹ï¼š env.addSource( new MySensorSource() ) æˆ‘ä»¬å¸Œæœ›å¯ä»¥éšæœºç”Ÿæˆä¼ æ„Ÿå™¨æ•°æ®ï¼Œ MySensorSource å…·ä½“çš„ä»£ç å®ç°å¦‚ä¸‹ï¼š import org.apache.flink.api.common.functions.MapFunction; import org.apache.flink.api.java.tuple.Tuple; import org.apache.flink.api.java.tuple.Tuple2; import org.apache.flink.streaming.api.datastream.DataStreamSource; import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator; import org.apache.flink.streaming.api.datastream.WindowedStream; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.streaming.api.functions.source.SourceFunction; import org.apache.flink.streaming.api.functions.windowing.WindowFunction; import org.apache.flink.streaming.api.windowing.time.Time; import org.apache.flink.streaming.api.windowing.windows.TimeWindow; import org.apache.flink.util.Collector; import org.apache.log4j.Level; import org.apache.log4j.Logger; import org.apache.lucene.analysis.CachingTokenFilter; import java.util.Random; public class MySelfSourceTest01 { public static void main(String[] args) { Logger.getLogger(&quot;org&quot;).setLevel(Level.OFF); StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); DataStreamSource&lt;String&gt; dataStreamSource = env.addSource(new SourceFunction&lt;String&gt;() { @Override public void run(SourceContext&lt;String&gt; ctx) throws Exception { Random random = new Random(); // å¾ªç¯å¯ä»¥ä¸åœçš„è¯»å–é™æ€æ•°æ® while (true) { int nextInt = random.nextInt(100); ctx.collect(&quot;random : &quot; + nextInt); Thread.sleep(1000); } } @Override public void cancel() { } }); WindowedStream&lt;Tuple2&lt;String, Integer&gt;, Tuple, TimeWindow&gt; window = dataStreamSource.map(new MapFunction&lt;String, Tuple2&lt;String, Integer&gt;&gt;() { @Override public Tuple2&lt;String, Integer&gt; map(String value) throws Exception { String[] sps = value.split(&quot;:&quot;); return new Tuple2&lt;&gt;(value, Integer.parseInt(sps[1].trim())); } }).keyBy(0).timeWindow(Time.seconds(5)); SingleOutputStreamOperator&lt;String&gt; apply = window.apply(new WindowFunction&lt;Tuple2&lt;String, Integer&gt;, String, Tuple, TimeWindow&gt;() { @Override public void apply(Tuple tuple, TimeWindow window, Iterable&lt;Tuple2&lt;String, Integer&gt;&gt; input, Collector&lt;String&gt; out) throws Exception { input.forEach(x -&gt; { System.out.println(&quot;apply function -&gt; &quot; + x.f0); out.collect(x.f0); }); } }); apply.print(); try { env.execute(&quot;myself_source_test01&quot;); } catch (Exception e) { e.printStackTrace(); } } } Transform è½¬æ¢ç®—å­ map stream.map { x =&gt; x * 2 } // 1.map.æŠŠstringè½¬åŒ–æˆé•¿åº¦è¾“å‡º //å‚æ•°T R //Tå°±æ˜¯ä¼ çš„æ•°æ®ï¼Œä»€ä¹ˆç±»å‹éƒ½è¡Œ //Rå°±æ˜¯è¿”å›çš„ç±»å‹ DataStream&lt;Integer&gt; mapStream = stringDataStream.map(new MapFunction&lt;String, Integer&gt;() { @Override public Integer map(String value) throws Exception { return value.length(); } }); flatMap flatMap çš„å‡½æ•°ç­¾åï¼š def flatMap[A,B](as: List[A])(f: A â‡’ List[B]): List[B] ä¾‹å¦‚: flatMap(List(1,2,3))(i â‡’ List(i,i)) ç»“æœæ˜¯ List(1,1,2,2,3,3), è€Œ List(&quot;a b&quot;, &quot;c d&quot;).flatMap(line â‡’ line.split(&quot; &quot;)) ç»“æœæ˜¯ List(a, b, c, d)ã€‚ stream.flatMap{ x =&gt; x.split(&quot; &quot;) } //2ã€flatmap,æŒ‰ç…§é€—å·åˆ†éš” DataStream&lt;String&gt; flatMapStream = stringDataStream.flatMap(new FlatMapFunction&lt;String, String&gt;() { @Override public void flatMap(String value, Collector&lt;String&gt; out) throws Exception { String[] fields = value.split(&quot;,&quot;); for(String field:fields) out.collect(field); } }); Filter stream.filter{ x =&gt; x == 1 } //3.filter,ç­›é€‰sensor_1å¼€å¤´çš„çš„idå¯¹åº”çš„æ•°æ® DataStream&lt;String&gt; filterStream = stringDataStream.filter(new FilterFunction&lt;String&gt;() { @Override public boolean filter(String value) throws Exception { return value.startsWith(&quot;sensor_1&quot;); } }); KeyBy DataStream â†’ KeyedStreamï¼š é€»è¾‘åœ°å°†ä¸€ä¸ªæµæ‹†åˆ†æˆä¸ç›¸äº¤çš„åˆ†åŒºï¼Œ æ¯ä¸ªåˆ†åŒºåŒ…å«å…·æœ‰ç›¸åŒ key çš„å…ƒç´ ï¼Œ åœ¨å†…éƒ¨ä»¥ hash çš„å½¢å¼å®ç°çš„ã€‚ DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; windowCounts = text .flatMap(new FlatMapFunction&lt;String, Tuple2&lt;String, Integer&gt;&gt;() { @Override public void flatMap(String value, Collector&lt;Tuple2&lt;String, Integer&gt;&gt; out) { for (String word : value.split(&quot;\\\\s&quot;)) { out.collect(Tuple2.of(word, 1)); } } }) //æŒ‰Tuple2çš„ç¬¬ä¸€ä¸ªå±æ€§è¿›è¡Œåˆ†åŒº .keyBy(0) //æˆ–è€…æ ¹æ®å¯¹è±¡å±æ€§è¿›è¡Œåˆ†åŒº KeyedStream&lt;SensorReading, String&gt; tempkeyedStream = mapDataStream.keyBy(mpdata -&gt; mpdata.getId()); æ»šåŠ¨èšåˆç®—å­ï¼ˆRolling Aggregationï¼‰ è¿™äº›ç®—å­å¯ä»¥é’ˆå¯¹ KeyedStream çš„æ¯ä¸€ä¸ªæ”¯æµåšèšåˆã€‚ sum() min() max() minBy() maxBy() Reduce KeyedStream â†’ DataStreamï¼š ä¸€ä¸ªåˆ†ç»„æ•°æ®æµçš„èšåˆæ“ä½œï¼Œ åˆå¹¶å½“å‰çš„å…ƒç´ å’Œä¸Šæ¬¡èšåˆçš„ç»“æœï¼Œ äº§ç”Ÿä¸€ä¸ªæ–°çš„å€¼ï¼Œ è¿”å›çš„æµä¸­åŒ…å«æ¯ä¸€æ¬¡èšåˆçš„ç»“æœï¼Œ è€Œä¸æ˜¯åªè¿”å›æœ€åä¸€æ¬¡èšåˆçš„æœ€ç»ˆç»“æœã€‚ DataStream&lt;String&gt; stream2 = env.readTextFile(&quot;YOUR_PATH\\\\sensor.txt&quot;) .map( data =&gt; { String[] dataArray = data.split(&quot;,&quot;) SensorReading(dataArray(0).trim, dataArray(1).trim.toLong, dataArray(2).trim.toDouble) }) .keyBy(&quot;id&quot;) .reduce( (x, y) =&gt; SensorReading(x.id, x.timestamp + 1, y.temperature) ) Split å’Œ Select Split å›¾ Split DataStream â†’ SplitStreamï¼š æ ¹æ®æŸäº›ç‰¹å¾æŠŠä¸€ä¸ª DataStream æ‹†åˆ†æˆä¸¤ä¸ªæˆ–è€… å¤šä¸ª DataStreamã€‚ Select å›¾ Select SplitStreamâ†’ DataStreamï¼š ä»ä¸€ä¸ª SplitStream ä¸­è·å–ä¸€ä¸ªæˆ–è€…å¤šä¸ª DataStreamã€‚ éœ€æ±‚ï¼š ä¼ æ„Ÿå™¨æ•°æ®æŒ‰ç…§æ¸©åº¦é«˜ä½ï¼ˆ ä»¥ 30 åº¦ä¸ºç•Œï¼‰ ï¼Œ æ‹†åˆ†æˆä¸¤ä¸ªæµã€‚ public static void main(String[] args) throws Exception { final StreamExecutionEnvironment env=StreamExecutionEnvironment.getExecutionEnvironment(); DataStream&lt;Long&gt; input=env.generateSequence(0,10); SplitStream&lt;Long&gt; splitStream = input.split(new OutputSelector&lt;Long&gt;(){ @Override public Iterable&lt;String&gt; select(Long value) { List&lt;String&gt; output = new ArrayList&lt;String&gt;(); if (value % 2 == 0) { output.add(&quot;even&quot;); }else { output.add(&quot;odd&quot;); } return output; } }); //splitStream.print(); DataStream&lt;Long&gt; even = splitStream.select(&quot;even&quot;); DataStream&lt;Long&gt; odd = splitStream.select(&quot;odd&quot;); DataStream&lt;Long&gt; all = splitStream.select(&quot;even&quot;,&quot;odd&quot;); //even.print(); odd.print(); //all.print(); env.execute(); } Connect å’Œ CoMap å›¾ Connect ç®—å­ DataStream,DataStream â†’ ConnectedStreamsï¼š è¿æ¥ä¸¤ä¸ªä¿æŒä»–ä»¬ç±»å‹çš„æ•° æ®æµï¼Œ ä¸¤ä¸ªæ•°æ®æµè¢« Connect ä¹‹åï¼Œ åªæ˜¯è¢«æ”¾åœ¨äº†ä¸€ä¸ªåŒä¸€ä¸ªæµä¸­ï¼Œ å†…éƒ¨ä¾ç„¶ä¿æŒ å„è‡ªçš„æ•°æ®å’Œå½¢å¼ä¸å‘ç”Ÿä»»ä½•å˜åŒ–ï¼Œ ä¸¤ä¸ªæµç›¸äº’ç‹¬ç«‹ã€‚ CoMap,CoFlatMap å›¾ CoMap/CoFlatMap ConnectedStreams â†’ DataStreamï¼š ä½œç”¨äº ConnectedStreams ä¸Šï¼Œ åŠŸèƒ½ä¸ map å’Œ flatMap ä¸€æ ·ï¼Œ å¯¹ ConnectedStreams ä¸­çš„æ¯ä¸€ä¸ª Stream åˆ†åˆ«è¿›è¡Œ map å’Œ flatMap å¤„ç†ã€‚ DataStream warning = high.map( sensorData =&gt; (sensorData.id, sensorData.temperature) ) ConnectedStreams connected = warning.connect(low) DataStream coMap = connected.map( warningData =&gt; (warningData._1, warningData._2, &quot;warning&quot;), lowData =&gt; (lowData.id, &quot;healthy&quot;) ) Union å›¾ Union DataStream â†’ DataStreamï¼š å¯¹ä¸¤ä¸ªæˆ–è€…ä¸¤ä¸ªä»¥ä¸Šçš„ DataStream è¿›è¡Œ union æ“ ä½œï¼Œ äº§ç”Ÿä¸€ä¸ªåŒ…å«æ‰€æœ‰ DataStream å…ƒç´ çš„æ–° DataStreamã€‚ //åˆå¹¶ä»¥åæ‰“å° DataStream&lt;StartUpLog&gt; unionStream = appStoreStream.union(otherStream) unionStream.print(&quot;union:::&quot;) Connect ä¸ Union åŒºåˆ«ï¼š Union ä¹‹å‰ä¸¤ä¸ªæµçš„ç±»å‹å¿…é¡»æ˜¯ä¸€æ ·ï¼Œ Connect å¯ä»¥ä¸ä¸€æ ·ï¼Œ åœ¨ä¹‹åçš„ coMap ä¸­å†å»è°ƒæ•´æˆä¸ºä¸€æ ·çš„ã€‚ Connect åªèƒ½æ“ä½œä¸¤ä¸ªæµï¼Œ Union å¯ä»¥æ“ä½œå¤šä¸ªã€‚ æ”¯æŒçš„æ•°æ®ç±»å‹ Flink æµåº”ç”¨ç¨‹åºå¤„ç†çš„æ˜¯ä»¥æ•°æ®å¯¹è±¡è¡¨ç¤ºçš„äº‹ä»¶æµã€‚ æ‰€ä»¥åœ¨ Flink å†…éƒ¨ï¼Œ æˆ‘ä»¬ éœ€è¦èƒ½å¤Ÿå¤„ç†è¿™äº›å¯¹è±¡ã€‚ å®ƒä»¬éœ€è¦è¢«åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œ ä»¥ä¾¿é€šè¿‡ç½‘ç»œä¼ é€å®ƒä»¬ï¼› æˆ–è€…ä»çŠ¶æ€åç«¯ã€ æ£€æŸ¥ç‚¹å’Œä¿å­˜ç‚¹è¯»å–å®ƒä»¬ã€‚ ä¸ºäº†æœ‰æ•ˆåœ°åšåˆ°è¿™ä¸€ç‚¹ï¼Œ Flink éœ€è¦æ˜ ç¡®çŸ¥é“åº”ç”¨ç¨‹åºæ‰€å¤„ç†çš„æ•°æ®ç±»å‹ã€‚ Flink ä½¿ç”¨ç±»å‹ä¿¡æ¯çš„æ¦‚å¿µæ¥è¡¨ç¤ºæ•°æ®ç±»å‹ï¼Œ å¹¶ ä¸ºæ¯ä¸ªæ•°æ®ç±»å‹ç”Ÿæˆç‰¹å®šçš„åºåˆ—åŒ–å™¨ã€ ååºåˆ—åŒ–å™¨å’Œæ¯”è¾ƒå™¨ã€‚ Flink è¿˜å…·æœ‰ä¸€ä¸ªç±»å‹æå–ç³»ç»Ÿï¼Œ è¯¥ç³»ç»Ÿåˆ†æå‡½æ•°çš„è¾“å…¥å’Œè¿”å›ç±»å‹ï¼Œ ä»¥è‡ªåŠ¨è· å–ç±»å‹ä¿¡æ¯ï¼Œ ä»è€Œè·å¾—åºåˆ—åŒ–å™¨å’Œååºåˆ—åŒ–å™¨ã€‚ ä½†æ˜¯ï¼Œ åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œ ä¾‹å¦‚ lambda å‡½æ•°æˆ–æ³›å‹ç±»å‹ï¼Œ éœ€è¦æ˜¾å¼åœ°æä¾›ç±»å‹ä¿¡æ¯ï¼Œ æ‰èƒ½ä½¿åº”ç”¨ç¨‹åºæ­£å¸¸å·¥ä½œæˆ–æé«˜å…¶æ€§ èƒ½ã€‚ Flink æ”¯æŒ Java å’Œ Scala ä¸­æ‰€æœ‰å¸¸è§æ•°æ®ç±»å‹ã€‚ ä½¿ç”¨æœ€å¹¿æ³›çš„ç±»å‹æœ‰ä»¥ä¸‹å‡ ç§ã€‚ åŸºç¡€æ•°æ®ç±»å‹ Flink æ”¯æŒæ‰€æœ‰çš„ Java å’Œ Scala åŸºç¡€æ•°æ®ç±»å‹ï¼Œ Int, Double, Long, String, â€¦â€‹ DataStream&lt;Long&gt; numbers = env.fromElements(1L, 2L, 3L, 4L) numbers.map( n =&gt; n + 1 ) Java å’Œ Scala å…ƒç»„ï¼ˆTuplesï¼‰ DataStream&lt;String, Integer&gt; persons= env.fromElements( (&quot;Adam&quot;, 17), (&quot;Sarah&quot;, 23) ) persons.filter(p =&gt; p._2 &gt; 18) Scala æ ·ä¾‹ç±»ï¼ˆcase classesï¼‰ case class Person(name: String, age: Int) val persons: DataStream[Person] = env.fromElements( Person(&quot;Adam&quot;, 17), Person(&quot;Sarah&quot;, 23) ) persons.filter(p =&gt; p.age &gt; 18) Java ç®€å•å¯¹è±¡ï¼ˆPOJOsï¼‰ public class Person { public String name; public int age; public Person() {} public Person(String name, int age) { this.name = name; this.age = age; } } DataStream&lt;Person&gt; persons = env.fromElements( new Person(&quot;Alex&quot;, 42), new Person(&quot;Wendy&quot;, 23)); å…¶å®ƒï¼ˆArrays, Lists, Maps, Enums, ç­‰ç­‰ï¼‰ Flink å¯¹ Java å’Œ Scala ä¸­çš„ä¸€äº›ç‰¹æ®Šç›®çš„çš„ç±»å‹ä¹Ÿéƒ½æ˜¯æ”¯æŒçš„ï¼Œ æ¯”å¦‚ Java çš„ ArrayListï¼Œ HashMapï¼Œ Enum ç­‰ç­‰ã€‚ å®ç° UDF å‡½æ•°â€”â€”æ›´ç»†ç²’åº¦çš„æ§åˆ¶æµ å‡½æ•°ç±»ï¼ˆFunction Classesï¼‰ Flink æš´éœ²äº†æ‰€æœ‰ udf å‡½æ•°çš„æ¥å£(å®ç°æ–¹å¼ä¸ºæ¥å£æˆ–è€…æŠ½è±¡ç±»)ã€‚ ä¾‹å¦‚ MapFunction, FilterFunction, ProcessFunction ç­‰ç­‰ã€‚ ä¸‹é¢ä¾‹å­å®ç°äº† FilterFunction æ¥å£ï¼š public class CustomFilterFunction implements FilterFunction&lt;SensorReading&gt; { @Override public boolean filter(SensorReading sensorReading) throws Exception { return sensorReading.temperature&gt;30.0; } } public static void main(String[] args) throws Exception { // åˆ›å»ºæµå¤„ç†çš„æ‰§è¡Œç¯å¢ƒ StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); // ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ® String inputPath = &quot;F:\\\\Projects\\\\BigData\\\\Flink\\\\FlinkTutorial\\\\src\\\\main\\\\resources\\\\sensor.txt&quot;; // è·å–æ•°æ® DataStreamSource&lt;String&gt; dataStream = env.readTextFile(inputPath); // 1ã€å…ˆè½¬æ¢æˆSensorReadingç±»å‹ï¼ˆç®€å•è½¬æ¢æ“ä½œï¼‰ DataStream&lt;SensorReading&gt; stream = dataStream.map(new MapFunction&lt;String, SensorReading&gt;() { @Override public SensorReading map(String data) throws Exception { String[] arr = data.split(&quot;,&quot;); return new SensorReading(arr[0], arr[1], Double.valueOf(arr[2].toString())); } }); // è°ƒç”¨è‡ªå®šä¹‰CustomFilterFunctionç±»çš„ï¼Œå®ç°è¿‡æ»¤ DataStream&lt;SensorReading&gt; dataStreamFilter = stream.filter(new CustomFilterFunction()); dataStreamFilter .print(&quot;CustomFilterFunction&quot;); env.execute(&quot;Function test&quot;); } è¿˜å¯ä»¥å°†å‡½æ•°å®ç°æˆåŒ¿åç±» DataStream&lt;SensorReading&gt; dataStreamFilter = stream.filter(new FilterFunction&lt;SensorReading&gt;() { @Override public boolean filter(SensorReading sensorReading) throws Exception { return sensorReading.temperature&gt;30.0; } ); æˆ‘ä»¬ filter çš„å­—ç¬¦ä¸²&quot;flink&quot;è¿˜å¯ä»¥å½“ä½œå‚æ•°ä¼ è¿›å»ã€‚ DataStream&lt;String&gt; tweets = ... DataStream&lt;String&gt; flinkTweets = tweets.filter(new KeywordFilter(&quot;flink&quot;)) public class KeywordFilter(String keyWord) implements FilterFunction&lt;String&gt; { @Override public boolean filter(String value) throws Exception { return value.contains(keyWord) } } åŒ¿åå‡½æ•°ï¼ˆLambda Functionsï¼‰ DataStream&lt;String&gt; tweets = ... DataStream&lt;String&gt; flinkTweets = tweets.filter((value) -&gt;value.contains(&quot;flink&quot;)) å¯Œå‡½æ•°ï¼ˆRich Functionsï¼‰ â€œ å¯Œå‡½æ•°â€ æ˜¯ DataStream API æä¾›çš„ä¸€ä¸ªå‡½æ•°ç±»çš„æ¥å£ï¼Œ æ‰€æœ‰ Flink å‡½æ•°ç±»éƒ½ æœ‰å…¶ Rich ç‰ˆæœ¬ã€‚ å®ƒä¸å¸¸è§„å‡½æ•°çš„ä¸åŒåœ¨äºï¼Œ å¯ä»¥è·å–è¿è¡Œç¯å¢ƒçš„ä¸Šä¸‹æ–‡ï¼Œ å¹¶æ‹¥æœ‰ä¸€ äº›ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œ æ‰€ä»¥å¯ä»¥å®ç°æ›´å¤æ‚çš„åŠŸèƒ½ã€‚ RichMapFunction RichFlatMapFunction RichFilterFunction â€¦â€‹ Rich Function æœ‰ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸçš„æ¦‚å¿µã€‚ å…¸å‹çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•æœ‰ï¼š open()æ–¹æ³•æ˜¯ rich function çš„åˆå§‹åŒ–æ–¹æ³•ï¼Œ å½“ä¸€ä¸ªç®—å­ä¾‹å¦‚ map æˆ–è€… filter è¢«è°ƒç”¨ä¹‹å‰ open()ä¼šè¢«è°ƒç”¨ã€‚ close()æ–¹æ³•æ˜¯ç”Ÿå‘½å‘¨æœŸä¸­çš„æœ€åä¸€ä¸ªè°ƒç”¨çš„æ–¹æ³•ï¼Œ åšä¸€äº›æ¸…ç†å·¥ä½œã€‚ getRuntimeContext()æ–¹æ³•æä¾›äº†å‡½æ•°çš„ RuntimeContext çš„ä¸€äº›ä¿¡æ¯ï¼Œ ä¾‹å¦‚å‡½ æ•°æ‰§è¡Œçš„å¹¶è¡Œåº¦ï¼Œ ä»»åŠ¡çš„åå­—ï¼Œ ä»¥åŠ state çŠ¶æ€ public class MyFlatMap extends RichFlatMapFunction&lt;Tuple2&lt;Integer, Integer&gt;, Tuple2&lt;Integer, Integer&gt;&gt; { Integer subTaskIndex = 0 StreamingRuntimeContext context = (StreamingRuntimeContext) getRuntimeContext() public void open(Configuration parameters) throws Exception { subTaskIndex = context.getIndexOfThisSubtask // ä»¥ä¸‹å¯ä»¥åšä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼Œ ä¾‹å¦‚å»ºç«‹ä¸€ä¸ªå’Œ HDFS çš„è¿æ¥ } @Override public void flatMap(Tuple2&lt;Integer, Integer&gt; integerIntegerTuple2, Collector&lt;Tuple2&lt;Integer, Integer&gt;&gt; collector) throws Exception { if (in % 2 == subTaskIndex) { out.collect((subTaskIndex, in)) } } public void close() throws Exception { // ä»¥ä¸‹åšä¸€äº›æ¸…ç†å·¥ä½œï¼Œ ä¾‹å¦‚æ–­å¼€å’Œ HDFS çš„è¿æ¥ã€‚ } } Sink Flink æ²¡æœ‰ç±»ä¼¼äº spark ä¸­ foreach æ–¹æ³•ï¼Œ è®©ç”¨æˆ·è¿›è¡Œè¿­ä»£çš„æ“ä½œã€‚ è™½æœ‰å¯¹å¤–çš„ è¾“å‡ºæ“ä½œéƒ½è¦åˆ©ç”¨ Sink å®Œæˆã€‚ æœ€åé€šè¿‡ç±»ä¼¼å¦‚ä¸‹æ–¹å¼å®Œæˆæ•´ä¸ªä»»åŠ¡æœ€ç»ˆè¾“å‡ºæ“ä½œã€‚ stream.addSink(new MySink(xxxx)) å®˜æ–¹æä¾›äº†ä¸€éƒ¨åˆ†çš„æ¡†æ¶çš„ sinkã€‚ é™¤æ­¤ä»¥å¤–ï¼Œ éœ€è¦ç”¨æˆ·è‡ªå®šä¹‰å®ç° sinkã€‚ Kafka pom.xml &lt;!-- https://mvnrepository.com/artifact/org.apache.flink/flink-connector-kafka-0.11 --&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-connector-kafka-0.11_2.12&lt;/artifactId&gt; &lt;version&gt;1.10.1&lt;/version&gt; &lt;/dependency&gt; ä¸»å‡½æ•°ä¸­æ·»åŠ  sinkï¼š DataStream&lt;String&gt; union = high.union(low).map(item-&gt;item.temperature.toString) union.addSink(new FlinkKafkaProducer&lt;String&gt;(&quot;localhost:9092&quot;, &quot;test&quot;, new SimpleStringSchema())) Redis pom.xml &lt;!-- https://mvnrepository.com/artifact/org.apache.bahir/flink-connector-redis --&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.bahir&lt;/groupId&gt; &lt;artifactId&gt;flink-connector-redis_2.11&lt;/artifactId&gt; &lt;version&gt;1.0&lt;/version&gt; &lt;/dependency&gt; å®šä¹‰ä¸€ä¸ª redis çš„ mapper ç±»ï¼Œ ç”¨äºå®šä¹‰ä¿å­˜åˆ° redis æ—¶è°ƒç”¨çš„å‘½ä»¤ï¼š public class MyRedisMapper extends RedisMapper&lt;SensorReading&gt;{ public RedisCommandDescription getCommandDescription{ new RedisCommandDescription(RedisCommand.HSET, &quot;sensor_temperature&quot;) } public String getValueFromData(SensorReading t){ t.temperature.toString String getKeyFromData(SensorReading t) { return t.id } } } åœ¨ä¸»å‡½æ•°ä¸­è°ƒç”¨ï¼š dataStream.addSink( new RedisSink&lt;SensorReading&gt;( new FlinkJedisPoolConfig.Builder().setHost(&quot;localhost&quot;).setPort(6379).build(), new MyRedisMapper) ) Elasticsearch pom.xml &lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-connector-elasticsearch6_2.12&lt;/artifactId&gt; &lt;version&gt;1.10.1&lt;/version&gt; &lt;/dependency&gt; åœ¨ä¸»å‡½æ•°ä¸­è°ƒç”¨ï¼š List httpHosts = new ArrayList&lt;HttpHost&gt;() httpHosts.add(new HttpHost(&quot;localhost&quot;, 9200)) DataStream esSinkBuilder = new ElasticsearchSink.Builder&lt;SensorReading&gt;( httpHosts,new ElasticsearchSinkFunction&lt;SensorReading&gt; { public Unit process(SensorReading t, RuntimeContext runtimeContext, RequestIndexer requestIndexer ) { println(&quot;saving data: &quot; + t) map json = new util.HashMap&lt;String, String&gt;() json.put(&quot;data&quot;, t.toString) IndexRequest indexRequest = Requests.indexRequest().index(&quot;sensor&quot;).`type`(&quot;readingData&quot;).source(json) requestIndexer.add(indexRequest) println(&quot;saved successfully&quot;) } } ) dataStream.addSink( esSinkBuilder.build() ) JDBC è‡ªå®šä¹‰ sink &lt;!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java --&gt; &lt;dependency&gt; &lt;groupId&gt;mysql&lt;/groupId&gt; &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt; &lt;version&gt;5.1.44&lt;/version&gt; &lt;/dependency&gt; æ·»åŠ  MyJdbcSink public class MyJdbcSink() extends RichSinkFunction&lt;SensorReading&gt;{ Connection conn; PreparedStatement insertStmt; PreparedStatement updateStmt; // open ä¸»è¦æ˜¯åˆ›å»ºè¿æ¥ public Unit open(Configuration parameters) = { super.open(parameters) conn = DriverManager.getConnection(&quot;jdbc:mysql://localhost:3306/test&quot;, &quot;root&quot;, &quot;123456&quot;) insertStmt = conn.prepareStatement(&quot;INSERT INTO temperatures (sensor, temp) VALUES (?, ?)&quot;) updateStmt = conn.prepareStatement(&quot;UPDATE temperatures SET temp = ? WHERE sensor = ?&quot;) } //è°ƒç”¨è¿æ¥ï¼Œ æ‰§è¡Œ sql public Unit invoke(SensorReading value , SinkFunction.Context[] contextï¼‰{ updateStmt.setDouble(1, value.temperature) updateStmt.setString(2, value.id) updateStmt.execute() if (updateStmt.getUpdateCount == 0) { insertStmt.setString(1, value.id) insertStmt.setDouble(2, value.temperature) insertStmt.execute() } } public Unit close() { insertStmt.close() updateStmt.close() conn.close() } } åœ¨ main æ–¹æ³•ä¸­å¢åŠ ï¼Œ æŠŠæ˜ç»†ä¿å­˜åˆ° mysql ä¸­ dataStream.addSink(new MyJdbcSink()) ","link":"https://tianxiawuhao.github.io/lvf921hnA/"},{"title":"ç¬¬å››ç«  Flink è¿è¡Œæ¶æ„","content":"Flink è¿è¡Œæ—¶çš„ç»„ä»¶ Flink è¿è¡Œæ—¶æ¶æ„ä¸»è¦åŒ…æ‹¬å››ä¸ªä¸åŒçš„ç»„ä»¶ï¼Œ å®ƒä»¬ä¼šåœ¨è¿è¡Œæµå¤„ç†åº”ç”¨ç¨‹åºæ—¶ååŒå·¥ä½œï¼š ä½œä¸šç®¡ç†å™¨ï¼ˆJobManagerï¼‰ ã€ èµ„æºç®¡ç†å™¨ï¼ˆResourceManagerï¼‰ ã€ ä»»åŠ¡ç®¡ç†å™¨ï¼ˆTaskManagerï¼‰ï¼Œä»¥åŠåˆ†å‘å™¨ï¼ˆDispatcherï¼‰ ã€‚ å› ä¸º Flink æ˜¯ç”¨ Java å’Œ Scala å®ç°çš„ï¼Œ æ‰€ä»¥æ‰€æœ‰ç»„ä»¶éƒ½ä¼šè¿è¡Œåœ¨Java è™šæ‹Ÿæœºä¸Šã€‚ æ¯ä¸ªç»„ä»¶çš„èŒè´£å¦‚ä¸‹ï¼š 1. ä½œä¸šç®¡ç†å™¨ï¼ˆJobManagerï¼‰ æ§åˆ¶ä¸€ä¸ªåº”ç”¨ç¨‹åºæ‰§è¡Œçš„ä¸»è¿›ç¨‹ï¼Œ ä¹Ÿå°±æ˜¯è¯´ï¼Œ æ¯ä¸ªåº”ç”¨ç¨‹åºéƒ½ä¼šè¢«ä¸€ä¸ªä¸åŒçš„ JobManager æ‰€æ§åˆ¶æ‰§è¡Œã€‚ JobManager ä¼šå…ˆæ¥æ”¶åˆ°è¦æ‰§è¡Œçš„åº”ç”¨ç¨‹åºï¼Œ è¿™ä¸ªåº”ç”¨ç¨‹åºä¼šåŒ…æ‹¬ï¼š ä½œä¸šå›¾ï¼ˆJobGraphï¼‰ ã€ é€»è¾‘æ•°æ®æµå›¾ï¼ˆlogical dataflow graphï¼‰ å’Œæ‰“åŒ…äº†æ‰€æœ‰çš„ç±»ã€ åº“å’Œå…¶å®ƒ èµ„æºçš„ JAR åŒ…ã€‚ JobManager ä¼šæŠŠ JobGraph è½¬æ¢æˆä¸€ä¸ªç‰©ç†å±‚é¢çš„æ•°æ®æµå›¾ï¼Œ è¿™ä¸ªå›¾è¢«å«åš â€œæ‰§è¡Œå›¾â€ ï¼ˆExecutionGraphï¼‰ ï¼Œ åŒ…å«äº†æ‰€æœ‰å¯ä»¥å¹¶å‘æ‰§è¡Œçš„ä»»åŠ¡ã€‚ JobManager ä¼šå‘èµ„æºç®¡ ç†å™¨ï¼ˆResourceManagerï¼‰ è¯·æ±‚æ‰§è¡Œä»»åŠ¡å¿…è¦çš„èµ„æºï¼Œ ä¹Ÿå°±æ˜¯ä»»åŠ¡ç®¡ç†å™¨ï¼ˆTaskManagerï¼‰ ä¸Š çš„æ’æ§½ï¼ˆ slotï¼‰ ã€‚ ä¸€æ—¦å®ƒè·å–åˆ°äº†è¶³å¤Ÿçš„èµ„æºï¼Œ å°±ä¼šå°†æ‰§è¡Œå›¾åˆ†å‘åˆ°çœŸæ­£è¿è¡Œå®ƒä»¬çš„TaskManager ä¸Šã€‚ è€Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œ JobManager ä¼šè´Ÿè´£æ‰€æœ‰éœ€è¦ä¸­å¤®åè°ƒçš„æ“ä½œï¼Œ æ¯”å¦‚è¯´æ£€ æŸ¥ç‚¹ï¼ˆcheckpointsï¼‰ çš„åè°ƒã€‚ 2. èµ„æºç®¡ç†å™¨ï¼ˆResourceManagerï¼‰ ä¸»è¦è´Ÿè´£ç®¡ç†ä»»åŠ¡ç®¡ç†å™¨ï¼ˆTaskManagerï¼‰ çš„æ’æ§½ï¼ˆslotï¼‰ ï¼Œ TaskManger æ’æ§½æ˜¯ Flink ä¸­ å®šä¹‰çš„å¤„ç†èµ„æºå•å…ƒã€‚ Flink ä¸ºä¸åŒçš„ç¯å¢ƒå’Œèµ„æºç®¡ç†å·¥å…·æä¾›äº†ä¸åŒèµ„æºç®¡ç†å™¨ï¼Œ æ¯”å¦‚ YARNã€ Mesosã€ K8sï¼Œ ä»¥åŠ standalone éƒ¨ç½²ã€‚ å½“ JobManager ç”³è¯·æ’æ§½èµ„æºæ—¶ï¼Œ ResourceManagerä¼šå°†æœ‰ç©ºé—²æ’æ§½çš„ TaskManager åˆ†é…ç»™ JobManagerã€‚ å¦‚æœ ResourceManager æ²¡æœ‰è¶³å¤Ÿçš„æ’æ§½æ¥æ»¡è¶³ JobManager çš„è¯·æ±‚ï¼Œ å®ƒè¿˜å¯ä»¥å‘èµ„æºæä¾›å¹³å°å‘èµ·ä¼šè¯ï¼Œ ä»¥æä¾›å¯åŠ¨ TaskManagerè¿›ç¨‹çš„å®¹å™¨ã€‚ å¦å¤–ï¼Œ ResourceManager è¿˜è´Ÿè´£ç»ˆæ­¢ç©ºé—²çš„TaskManagerï¼Œ é‡Šæ”¾è®¡ç®—èµ„æºã€‚ 3. ä»»åŠ¡ç®¡ç†å™¨ï¼ˆTaskManagerï¼‰ Flink ä¸­çš„å·¥ä½œè¿›ç¨‹ã€‚ é€šå¸¸åœ¨ Flink ä¸­ä¼šæœ‰å¤šä¸ª TaskManager è¿è¡Œï¼Œ æ¯ä¸€ä¸ª TaskManager éƒ½åŒ…å«äº†ä¸€å®šæ•°é‡çš„æ’æ§½ï¼ˆslotsï¼‰ ã€‚ æ’æ§½çš„æ•°é‡é™åˆ¶äº† TaskManager èƒ½å¤Ÿæ‰§è¡Œçš„ä»»åŠ¡æ•°é‡ã€‚ å¯åŠ¨ä¹‹åï¼Œ TaskManager ä¼šå‘èµ„æºç®¡ç†å™¨æ³¨å†Œå®ƒçš„æ’æ§½ï¼› æ”¶åˆ°èµ„æºç®¡ç†å™¨çš„æŒ‡ä»¤åï¼ŒTaskManager å°±ä¼šå°†ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ’æ§½æä¾›ç»™ JobManager è°ƒç”¨ã€‚ JobManager å°±å¯ä»¥å‘æ’æ§½åˆ†é…ä»»åŠ¡ï¼ˆtasksï¼‰ æ¥æ‰§è¡Œäº†ã€‚ åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œ ä¸€ä¸ª TaskManager å¯ä»¥è·Ÿå…¶å®ƒè¿è¡ŒåŒä¸€åº”ç”¨ç¨‹åºçš„ TaskManager äº¤æ¢æ•°æ®ã€‚ 4. åˆ†å‘å™¨ï¼ˆDispatcherï¼‰ å¯ä»¥è·¨ä½œä¸šè¿è¡Œï¼Œ å®ƒä¸ºåº”ç”¨æäº¤æä¾›äº† REST æ¥å£ã€‚ å½“ä¸€ä¸ªåº”ç”¨è¢«æäº¤æ‰§è¡Œæ—¶ï¼Œ åˆ†å‘å™¨ å°±ä¼šå¯åŠ¨å¹¶å°†åº”ç”¨ç§»äº¤ç»™ä¸€ä¸ª JobManagerã€‚ ç”±äºæ˜¯ REST æ¥å£ï¼Œ æ‰€ä»¥ Dispatcher å¯ä»¥ä½œä¸ºé›† ç¾¤çš„ä¸€ä¸ª HTTP æ¥å…¥ç‚¹ï¼Œ è¿™æ ·å°±èƒ½å¤Ÿä¸å—é˜²ç«å¢™é˜»æŒ¡ã€‚ Dispatcher ä¹Ÿä¼šå¯åŠ¨ä¸€ä¸ª Web UIï¼Œ ç”¨ æ¥æ–¹ä¾¿åœ°å±•ç¤ºå’Œç›‘æ§ä½œä¸šæ‰§è¡Œçš„ä¿¡æ¯ã€‚ Dispatcher åœ¨æ¶æ„ä¸­å¯èƒ½å¹¶ä¸æ˜¯å¿…éœ€çš„ï¼Œ è¿™å–å†³äºåº” ç”¨æäº¤è¿è¡Œçš„æ–¹å¼ã€‚ ä»»åŠ¡æäº¤æµç¨‹ æˆ‘ä»¬æ¥çœ‹çœ‹å½“ä¸€ä¸ªåº”ç”¨æäº¤æ‰§è¡Œæ—¶ï¼Œ Flink çš„å„ä¸ªç»„ä»¶æ˜¯å¦‚ä½•äº¤äº’åä½œçš„ï¼š å›¾ ä»»åŠ¡æäº¤å’Œç»„ä»¶äº¤äº’æµç¨‹ ä¸Šå›¾æ˜¯ä»ä¸€ä¸ªè¾ƒä¸ºé«˜å±‚çº§çš„è§†è§’ï¼Œ æ¥çœ‹åº”ç”¨ä¸­å„ç»„ä»¶çš„äº¤äº’åä½œã€‚ å¦‚æœéƒ¨ç½²çš„é›†ç¾¤ç¯å¢ƒ ä¸åŒï¼ˆä¾‹å¦‚ YARNï¼Œ Mesosï¼Œ Kubernetesï¼Œ standalone ç­‰ï¼‰ ï¼Œ å…¶ä¸­ä¸€äº›æ­¥éª¤å¯ä»¥è¢«çœç•¥ï¼Œ æˆ–æ˜¯ æœ‰äº›ç»„ä»¶ä¼šè¿è¡Œåœ¨åŒä¸€ä¸ª JVM è¿›ç¨‹ä¸­ã€‚ å…·ä½“åœ°ï¼Œ å¦‚æœæˆ‘ä»¬å°† Flink é›†ç¾¤éƒ¨ç½²åˆ° YARN ä¸Šï¼Œ é‚£ä¹ˆå°±ä¼šæœ‰å¦‚ä¸‹çš„æäº¤æµç¨‹ï¼š å›¾ Yarn æ¨¡å¼ä»»åŠ¡æäº¤æµç¨‹ Flink ä»» åŠ¡ æ äº¤ å ï¼Œ Client å‘ HDFS ä¸Š ä¼  Flink çš„ Jar åŒ… å’Œ é… ç½® ï¼Œ ä¹‹ å å‘ YarnResourceManager æ äº¤ ä»» åŠ¡ ï¼Œ ResourceManager åˆ† é… Container èµ„ æº å¹¶ é€š çŸ¥ å¯¹ åº” çš„NodeManager å¯åŠ¨ ApplicationMasterï¼Œ ApplicationMaster å¯åŠ¨ååŠ è½½ Flink çš„ Jar åŒ…å’Œé…ç½®æ„å»ºç¯å¢ƒï¼Œ ç„¶åå¯åŠ¨ JobManagerï¼Œ ä¹‹å ApplicationMaster å‘ ResourceManagerç”³ è¯· èµ„ æº å¯ åŠ¨ TaskManager ï¼Œ ResourceManager åˆ† é… Container èµ„ æº å ï¼Œ ç”±ApplicationMaster é€š çŸ¥ èµ„ æº æ‰€ åœ¨ èŠ‚ ç‚¹ çš„ NodeManager å¯ åŠ¨ TaskManager ï¼ŒNodeManager åŠ è½½ Flink çš„ Jar åŒ…å’Œé…ç½®æ„å»ºç¯å¢ƒå¹¶å¯åŠ¨ TaskManagerï¼Œ TaskManagerå¯åŠ¨åå‘ JobManager å‘é€å¿ƒè·³åŒ…ï¼Œ å¹¶ç­‰å¾… JobManager å‘å…¶åˆ†é…ä»»åŠ¡ã€‚ ä»»åŠ¡è°ƒåº¦åŸç† å›¾ ä»»åŠ¡è°ƒåº¦åŸç† å®¢ æˆ· ç«¯ ä¸ æ˜¯ è¿ è¡Œ æ—¶ å’Œ ç¨‹ åº æ‰§ è¡Œ çš„ ä¸€ éƒ¨ åˆ† ï¼Œ ä½† å®ƒ ç”¨ äº å‡† å¤‡ å¹¶ å‘ é€ dataflow(JobGraph)ç»™ Master(JobManager)ï¼Œ ç„¶åï¼Œ å®¢æˆ·ç«¯æ–­å¼€è¿æ¥æˆ–è€…ç»´æŒè¿æ¥ä»¥ ç­‰å¾…æ¥æ”¶è®¡ç®—ç»“æœã€‚ å½“ Flink é›† ç¾¤ å¯ åŠ¨ å ï¼Œ é¦– å…ˆ ä¼š å¯ åŠ¨ ä¸€ ä¸ª JobManger å’Œ ä¸€ ä¸ª æˆ– å¤š ä¸ª çš„TaskManagerã€‚ ç”± Client æäº¤ä»»åŠ¡ç»™ JobManagerï¼Œ JobManager å†è°ƒåº¦ä»»åŠ¡åˆ°å„ä¸ªTaskManager å»æ‰§è¡Œï¼Œ ç„¶å TaskManager å°†å¿ƒè·³å’Œç»Ÿè®¡ä¿¡æ¯æ±‡æŠ¥ç»™ JobManagerã€‚TaskManager ä¹‹é—´ä»¥æµçš„å½¢å¼è¿›è¡Œæ•°æ®çš„ä¼ è¾“ã€‚ ä¸Šè¿°ä¸‰è€…å‡ä¸ºç‹¬ç«‹çš„ JVM è¿›ç¨‹ã€‚ Client ä¸ºæäº¤ Job çš„å®¢æˆ·ç«¯ï¼Œ å¯ä»¥æ˜¯è¿è¡Œåœ¨ä»»ä½•æœºå™¨ä¸Šï¼ˆ ä¸ JobManager ç¯å¢ƒè¿é€šå³å¯ï¼‰ ã€‚ æäº¤ Job åï¼Œ Client å¯ä»¥ç»“æŸè¿›ç¨‹ï¼ˆ Streaming çš„ä»»åŠ¡ï¼‰ ï¼Œ ä¹Ÿå¯ä»¥ä¸ç»“æŸå¹¶ç­‰å¾…ç»“æœè¿”å›ã€‚ JobManager`ä¸» è¦ è´Ÿ è´£ è°ƒ åº¦ Job å¹¶ å è°ƒ Task åš checkpoint ï¼Œ èŒ è´£ ä¸Š å¾ˆ åƒStorm çš„ Nimbusã€‚ ä» Client å¤„æ¥æ”¶åˆ° Job å’Œ JAR åŒ…ç­‰èµ„æºåï¼Œ ä¼šç”Ÿæˆä¼˜åŒ–åçš„æ‰§è¡Œè®¡åˆ’ï¼Œ å¹¶ä»¥ Task çš„å•å…ƒè°ƒåº¦åˆ°å„ä¸ª TaskManager å»æ‰§è¡Œã€‚ TaskManager`åœ¨å¯åŠ¨çš„æ—¶å€™å°±è®¾ç½®å¥½äº†æ§½ä½æ•°ï¼ˆ Slotï¼‰ ï¼Œ æ¯ä¸ª slot èƒ½å¯åŠ¨ä¸€ä¸ªTaskï¼Œ Task ä¸ºçº¿ç¨‹ã€‚ ä» JobManager å¤„æ¥æ”¶éœ€è¦éƒ¨ç½²çš„ Taskï¼Œ éƒ¨ç½²å¯åŠ¨åï¼Œ ä¸è‡ªå·±çš„ä¸Šæ¸¸å»ºç«‹ Netty è¿æ¥ï¼Œ æ¥æ”¶æ•°æ®å¹¶å¤„ç†ã€‚ TaskManger ä¸ Slots Flink ä¸­æ¯ä¸€ä¸ª worker(TaskManager)éƒ½æ˜¯ä¸€ä¸ª `JVM è¿›ç¨‹`ï¼Œ å®ƒå¯èƒ½ä¼šåœ¨`ç‹¬ç«‹çš„çº¿ ç¨‹`ä¸Šæ‰§è¡Œä¸€ä¸ªæˆ–å¤šä¸ª subtaskã€‚ ä¸ºäº†æ§åˆ¶ä¸€ä¸ª worker èƒ½æ¥æ”¶å¤šå°‘ä¸ª taskï¼Œ worker é€š è¿‡ task slot æ¥è¿›è¡Œæ§åˆ¶ï¼ˆ ä¸€ä¸ª worker è‡³å°‘æœ‰ä¸€ä¸ª task slotï¼‰ ã€‚ æ¯ä¸ª task slot è¡¨ç¤º TaskManager æ‹¥æœ‰èµ„æºçš„`ä¸€ä¸ªå›ºå®šå¤§å°çš„å­é›†` ã€‚ å‡å¦‚ä¸€ä¸ª TaskManager æœ‰ä¸‰ä¸ª slotï¼Œ é‚£ä¹ˆå®ƒä¼šå°†å…¶ç®¡ç†çš„å†…å­˜åˆ†æˆä¸‰ä»½ç»™å„ä¸ª slotã€‚ èµ„æº slot åŒ–æ„å‘³ç€ä¸€ä¸ª subtask å°†ä¸éœ€è¦è·Ÿæ¥è‡ªå…¶ä»– job çš„ subtask ç«äº‰è¢«ç®¡ç†çš„å†…å­˜ï¼Œ å–è€Œ ä»£ä¹‹çš„æ˜¯å®ƒå°†æ‹¥æœ‰ä¸€å®šæ•°é‡çš„å†…å­˜å‚¨å¤‡ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ è¿™é‡Œä¸ä¼šæ¶‰åŠåˆ° CPU çš„éš” ç¦»ï¼Œ slot ç›®å‰ä»…ä»…ç”¨æ¥éš”ç¦» task çš„å—ç®¡ç†çš„å†…å­˜ã€‚ é€šè¿‡è°ƒæ•´ task slot çš„æ•°é‡ï¼Œ å…è®¸ç”¨æˆ·å®šä¹‰ subtask ä¹‹é—´å¦‚ä½•äº’ç›¸éš”ç¦»ã€‚ å¦‚æœä¸€ä¸ª TaskManager ä¸€ä¸ª slotï¼Œ é‚£å°†æ„å‘³ç€æ¯ä¸ª task group è¿è¡Œåœ¨ç‹¬ç«‹çš„ JVM ä¸­ï¼ˆ è¯¥ JVM å¯èƒ½æ˜¯é€šè¿‡ä¸€ä¸ªç‰¹å®šçš„å®¹å™¨å¯åŠ¨çš„ï¼‰ ï¼Œ è€Œä¸€ä¸ª TaskManager å¤šä¸ª slot æ„å‘³ç€æ›´å¤šçš„ subtask å¯ä»¥å…±äº«åŒä¸€ä¸ª JVMã€‚ è€Œåœ¨åŒä¸€ä¸ª JVM è¿›ç¨‹ä¸­çš„ task å°†å…±äº« TCP è¿æ¥ï¼ˆ åŸº äºå¤šè·¯å¤ç”¨ï¼‰ å’Œå¿ƒè·³æ¶ˆæ¯ã€‚ å®ƒä»¬ä¹Ÿå¯èƒ½å…±äº«æ•°æ®é›†å’Œæ•°æ®ç»“æ„ï¼Œ å› æ­¤è¿™å‡å°‘äº†æ¯ä¸ª task çš„è´Ÿè½½ã€‚ å›¾ TaskManager ä¸ Slot å›¾ å­ä»»åŠ¡å…±äº« é»˜è®¤æƒ…å†µä¸‹ï¼Œ Flink å…è®¸å­ä»»åŠ¡å…±äº« slotï¼Œ å³ä½¿å®ƒä»¬æ˜¯ä¸åŒä»»åŠ¡çš„å­ä»»åŠ¡ï¼ˆ å‰ææ˜¯å®ƒä»¬æ¥è‡ªåŒä¸€ä¸ª jobï¼‰ ã€‚ è¿™æ ·çš„ç»“æœæ˜¯ï¼Œ ä¸€ä¸ª slot å¯ä»¥ä¿å­˜ä½œä¸šçš„æ•´ä¸ªç®¡é“ã€‚ Task Slot æ˜¯é™æ€çš„æ¦‚å¿µï¼Œ æ˜¯æŒ‡ TaskManager å…·æœ‰çš„å¹¶å‘æ‰§è¡Œèƒ½åŠ›ï¼Œ å¯ä»¥é€šè¿‡å‚æ•° taskmanager.numberOfTaskSlots è¿›è¡Œé…ç½®ï¼› è€Œå¹¶è¡Œåº¦ parallelism æ˜¯åŠ¨æ€æ¦‚å¿µï¼Œå³ TaskManager è¿è¡Œç¨‹åºæ—¶å®é™…ä½¿ç”¨çš„å¹¶å‘èƒ½åŠ›ï¼Œ å¯ä»¥é€šè¿‡å‚æ•° parallelism.default è¿›è¡Œé…ç½®ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œ å‡è®¾ä¸€å…±æœ‰ 3 ä¸ª TaskManagerï¼Œ æ¯ä¸€ä¸ª TaskManager ä¸­çš„åˆ†é… 3 ä¸ªTaskSlotï¼Œ ä¹Ÿå°±æ˜¯æ¯ä¸ª TaskManager å¯ä»¥æ¥æ”¶ 3 ä¸ª taskï¼Œ ä¸€å…± 9 ä¸ª TaskSlotï¼Œ å¦‚æœæˆ‘ä»¬è®¾ç½® parallelism.default=1ï¼Œ å³è¿è¡Œç¨‹åºé»˜è®¤çš„å¹¶è¡Œåº¦ä¸º 1ï¼Œ 9 ä¸ª TaskSlot åªç”¨äº† 1ä¸ªï¼Œ æœ‰ 8 ä¸ªç©ºé—²ï¼Œ å› æ­¤ï¼Œ è®¾ç½®åˆé€‚çš„å¹¶è¡Œåº¦æ‰èƒ½æé«˜æ•ˆç‡ã€‚ ç¨‹åºä¸æ•°æ®æµï¼ˆDataFlowï¼‰ æ‰€æœ‰çš„ Flink ç¨‹åºéƒ½æ˜¯ç”±ä¸‰éƒ¨åˆ†ç»„æˆçš„ï¼š `Source` ã€ `Transformation` å’Œ `Sink`ã€‚ Source è´Ÿè´£è¯»å–æ•°æ®æºï¼Œ Transformation åˆ©ç”¨å„ç§ç®—å­è¿›è¡Œå¤„ç†åŠ å·¥ï¼Œ Sink è´Ÿè´£è¾“å‡ºã€‚ åœ¨è¿è¡Œæ—¶ï¼Œ Flink ä¸Šè¿è¡Œçš„ç¨‹åºä¼šè¢«æ˜ å°„æˆâ€œ é€»è¾‘æ•°æ®æµâ€ ï¼ˆ dataflowsï¼‰ ï¼Œ å®ƒåŒ…å«äº†è¿™ä¸‰éƒ¨åˆ†ã€‚ æ¯ä¸€ä¸ª dataflow ä»¥ä¸€ä¸ªæˆ–å¤šä¸ª sources å¼€å§‹ä»¥ä¸€ä¸ªæˆ–å¤šä¸ª sinks ç»“æŸã€‚ dataflow ç±»ä¼¼äºä»»æ„çš„æœ‰å‘æ— ç¯å›¾ï¼ˆ DAGï¼‰ ã€‚ åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œ ç¨‹åºä¸­çš„è½¬æ¢ è¿ç®—ï¼ˆ transformationsï¼‰ è·Ÿ dataflow ä¸­çš„ç®—å­ï¼ˆ operatorï¼‰ æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œ ä½†æœ‰ æ—¶å€™ï¼Œ ä¸€ä¸ª transformation å¯èƒ½å¯¹åº”å¤šä¸ª operatorã€‚ å›¾ ç¨‹åºä¸æ•°æ®æµ æ‰§è¡Œå›¾ï¼ˆExecutionGraphï¼‰ ç”± Flink ç¨‹åºç›´æ¥æ˜ å°„æˆçš„æ•°æ®æµå›¾æ˜¯ StreamGraphï¼Œ ä¹Ÿè¢«ç§°ä¸ºé€»è¾‘æµå›¾ï¼Œ å› ä¸ºå®ƒä»¬è¡¨ç¤ºçš„æ˜¯è®¡ç®—é€»è¾‘çš„é«˜çº§è§†å›¾ã€‚ ä¸ºäº†æ‰§è¡Œä¸€ä¸ªæµå¤„ç†ç¨‹åºï¼Œ Flink éœ€è¦å°†é€»è¾‘æµ å›¾è½¬æ¢ä¸ºç‰©ç†æ•°æ®æµå›¾ï¼ˆ ä¹Ÿå«æ‰§è¡Œå›¾ï¼‰ ï¼Œ è¯¦ç»†è¯´æ˜ç¨‹åºçš„æ‰§è¡Œæ–¹å¼ã€‚ Flink ä¸­çš„æ‰§è¡Œå›¾å¯ä»¥åˆ†æˆå››å±‚ï¼š StreamGraph -> JobGraph -> ExecutionGraph -> ç‰©ç†æ‰§è¡Œå›¾ã€‚ StreamGraphï¼š æ˜¯æ ¹æ®ç”¨æˆ·é€šè¿‡ Stream API ç¼–å†™çš„ä»£ç ç”Ÿæˆçš„æœ€åˆçš„å›¾ã€‚ ç”¨æ¥è¡¨ç¤ºç¨‹åºçš„æ‹“æ‰‘ç»“æ„ã€‚ JobGraphï¼š StreamGraph ç»è¿‡ä¼˜åŒ–åç”Ÿæˆäº† JobGraphï¼Œ æäº¤ç»™ JobManager çš„æ•°æ®ç»“æ„ã€‚ ä¸»è¦çš„ä¼˜åŒ–ä¸ºï¼Œ å°†å¤šä¸ªç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹ chain åœ¨ä¸€èµ·ä½œä¸ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œ è¿™æ ·å¯ä»¥å‡å°‘æ•°æ®åœ¨èŠ‚ç‚¹ä¹‹é—´æµåŠ¨æ‰€éœ€è¦çš„åºåˆ—åŒ–/ååºåˆ—åŒ–/ä¼ è¾“æ¶ˆè€—ã€‚ ExecutionGraph ï¼š JobManager æ ¹ æ® JobGraph ç”Ÿ æˆ ExecutionGraph ã€‚ExecutionGraph æ˜¯ JobGraph çš„å¹¶è¡ŒåŒ–ç‰ˆæœ¬ï¼Œ æ˜¯è°ƒåº¦å±‚æœ€æ ¸å¿ƒçš„æ•°æ®ç»“æ„ã€‚ ç‰©ç†æ‰§è¡Œå›¾ï¼š JobManager æ ¹æ® ExecutionGraph å¯¹ Job è¿›è¡Œè°ƒåº¦åï¼Œ åœ¨å„ä¸ªTaskManager ä¸Šéƒ¨ç½² Task åå½¢æˆçš„â€œ å›¾â€ ï¼Œ å¹¶ä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„æ•°æ®ç»“æ„ã€‚ å¹¶è¡Œåº¦ï¼ˆParallelismï¼‰ Flink ç¨‹åºçš„æ‰§è¡Œå…·æœ‰å¹¶è¡Œã€ åˆ†å¸ƒå¼çš„ç‰¹æ€§ã€‚ åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œ ä¸€ä¸ªæµï¼ˆ streamï¼‰ åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªåˆ†åŒºï¼ˆ stream partitionï¼‰ ï¼Œ è€Œ æ¯ä¸€ä¸ªç®—å­ï¼ˆ operatorï¼‰ å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå­ä»»åŠ¡ï¼ˆ operator subtaskï¼‰ ï¼Œ è¿™äº›å­ä»» åŠ¡åœ¨ä¸åŒçš„çº¿ç¨‹ã€ ä¸åŒçš„ç‰©ç†æœºæˆ–ä¸åŒçš„å®¹å™¨ä¸­å½¼æ­¤äº’ä¸ä¾èµ–åœ°æ‰§è¡Œã€‚ ä¸€ä¸ªç‰¹å®šç®—å­çš„å­ä»»åŠ¡ï¼ˆ subtaskï¼‰ çš„ä¸ªæ•°è¢«ç§°ä¹‹ä¸ºå…¶å¹¶è¡Œåº¦ï¼ˆ parallelismï¼‰ ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ ä¸€ä¸ªæµç¨‹åºçš„å¹¶è¡Œåº¦ï¼Œ å¯ä»¥è®¤ä¸ºå°±æ˜¯å…¶æ‰€æœ‰ç®—å­ä¸­æœ€å¤§çš„å¹¶è¡Œåº¦ã€‚ ä¸€ ä¸ªç¨‹åºä¸­ï¼Œ ä¸åŒçš„ç®—å­å¯èƒ½å…·æœ‰ä¸åŒçš„å¹¶è¡Œåº¦ã€‚ å›¾ å¹¶è¡Œæ•°æ®æµ Stream åœ¨ç®—å­ä¹‹é—´ä¼ è¾“æ•°æ®çš„å½¢å¼å¯ä»¥æ˜¯ one-to-one(forwarding)çš„æ¨¡å¼ä¹Ÿå¯ä»¥æ˜¯ redistributing çš„æ¨¡å¼ï¼Œ å…·ä½“æ˜¯å“ªä¸€ç§å½¢å¼ï¼Œ å–å†³äºç®—å­çš„ç§ç±»ã€‚ One-to-oneï¼š stream(æ¯”å¦‚åœ¨ source å’Œ map operator ä¹‹é—´)ç»´æŠ¤ç€åˆ†åŒºä»¥åŠå…ƒç´ çš„ é¡ºåºã€‚ é‚£æ„å‘³ç€ map ç®—å­çš„å­ä»»åŠ¡çœ‹åˆ°çš„å…ƒç´ çš„ä¸ªæ•°ä»¥åŠé¡ºåºè·Ÿ source ç®—å­çš„å­ ä»»åŠ¡ç”Ÿäº§çš„å…ƒç´ çš„ä¸ªæ•°ã€ é¡ºåºç›¸åŒï¼Œ mapã€ fliterã€ flatMap ç­‰ç®—å­éƒ½æ˜¯ one-to-one çš„ å¯¹åº”å…³ç³»ã€‚ ç±»ä¼¼äº spark ä¸­çš„çª„ä¾èµ– Redistributingï¼š stream(map()è·Ÿ keyBy/window ä¹‹é—´æˆ–è€… keyBy/window è·Ÿ sinkä¹‹é—´)çš„åˆ†åŒºä¼šå‘ç”Ÿæ”¹å˜ã€‚ æ¯ä¸€ä¸ªç®—å­çš„å­ä»»åŠ¡ä¾æ®æ‰€é€‰æ‹©çš„ transformation å‘é€æ•°æ®åˆ°ä¸åŒçš„ç›®æ ‡ä»»åŠ¡ã€‚ ä¾‹å¦‚ï¼Œ keyBy() åŸºäº hashCode é‡åˆ†åŒºã€ broadcast å’Œ rebalanceä¼šéšæœºé‡æ–°åˆ†åŒºï¼Œ è¿™äº›ç®—å­éƒ½ä¼šå¼•èµ· redistribute è¿‡ç¨‹ï¼Œ è€Œ redistribute è¿‡ç¨‹å°±ç±»ä¼¼äºSpark ä¸­çš„ shuffle è¿‡ç¨‹ã€‚ ç±»ä¼¼äº spark ä¸­çš„å®½ä¾èµ– ä»»åŠ¡é“¾ï¼ˆOperator Chainsï¼‰ ç›¸åŒå¹¶è¡Œåº¦çš„ one to one æ“ä½œï¼Œ Flink è¿™æ ·ç›¸è¿çš„ç®—å­é“¾æ¥åœ¨ä¸€èµ·å½¢æˆä¸€ä¸ª taskï¼ŒåŸæ¥çš„ç®—å­æˆä¸ºé‡Œé¢çš„ä¸€éƒ¨åˆ†ã€‚ å°†ç®—å­é“¾æ¥æˆ task æ˜¯éå¸¸æœ‰æ•ˆçš„ä¼˜åŒ–ï¼š å®ƒèƒ½å‡å°‘çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢å’ŒåŸºäºç¼“å­˜åŒºçš„æ•°æ®äº¤æ¢ï¼Œ åœ¨å‡å°‘æ—¶å»¶çš„åŒæ—¶æå‡ååé‡ã€‚ é“¾æ¥çš„è¡Œ ä¸ºå¯ä»¥åœ¨ç¼–ç¨‹ API ä¸­è¿›è¡ŒæŒ‡å®šã€‚ å›¾ task ä¸ operator chains ","link":"https://tianxiawuhao.github.io/4_EhGqVjY/"},{"title":"ç¬¬ä¸‰ç«  Flink éƒ¨ç½²","content":"Standalone æ¨¡å¼ å®‰è£… è§£å‹ç¼© flink-1.10.1-bin-scala_2.12.tgzï¼Œ è¿›å…¥ conf ç›®å½•ä¸­ã€‚ ä¿®æ”¹ flink/conf/flink-conf.yaml æ–‡ä»¶ï¼š ä¿®æ”¹ /conf/slaves æ–‡ä»¶ï¼š åˆ†å‘ç»™å¦å¤–ä¸¤å°æœºå­ï¼š å¯åŠ¨ è®¿é—® http://localhost:8081 å¯ä»¥å¯¹ flink é›†ç¾¤å’Œä»»åŠ¡è¿›è¡Œç›‘æ§ç®¡ç†ã€‚ æäº¤ä»»åŠ¡ å‡†å¤‡æ•°æ®æ–‡ä»¶ï¼ˆ å¦‚æœéœ€è¦ï¼‰ æŠŠå«æ•°æ®æ–‡ä»¶çš„æ–‡ä»¶å¤¹ï¼Œ åˆ†å‘åˆ° taskmanage æœºå™¨ä¸­ å¦‚ æœ ä» æ–‡ ä»¶ ä¸­ è¯» å– æ•° æ® ï¼Œ ç”± äº æ˜¯ ä» æœ¬ åœ° ç£ ç›˜ è¯» å– ï¼Œ å® é™… ä»» åŠ¡ ä¼š è¢« åˆ† å‘ åˆ°taskmanage çš„æœºå™¨ä¸­ï¼Œ æ‰€ä»¥è¦æŠŠç›®æ ‡æ–‡ä»¶åˆ†å‘ã€‚ æ‰§è¡Œç¨‹åº ./flink run -c com.atguigu.wc.StreamWordCount â€“p 2 FlinkTutorial-1.0-SNAPSHOT-jar-with-dependencies.jar --host lcoalhost â€“port 7777 åˆ°ç›®æ ‡æ–‡ä»¶å¤¹ä¸­æŸ¥çœ‹è®¡ç®—ç»“æœ æ³¨ æ„ ï¼š å¦‚ æœ è®¡ ç®— ç»“ æœ è¾“ å‡º åˆ° æ–‡ ä»¶ ï¼Œ ä¼š ä¿ å­˜ åˆ° taskmanage çš„ æœº å™¨ ä¸‹ ï¼Œ ä¸ ä¼š åœ¨jobmanage ä¸‹ã€‚ åœ¨ webui æ§åˆ¶å°æŸ¥çœ‹è®¡ç®—è¿‡ç¨‹ Yarn æ¨¡å¼ ä»¥ Yarn æ¨¡å¼éƒ¨ç½² Flink ä»»åŠ¡æ—¶ï¼Œ è¦æ±‚ Flink æ˜¯æœ‰ Hadoop æ”¯æŒçš„ç‰ˆæœ¬ï¼Œ Hadoopç¯å¢ƒéœ€è¦ä¿è¯ç‰ˆæœ¬åœ¨ 2.2 ä»¥ä¸Šï¼Œ å¹¶ä¸”é›†ç¾¤ä¸­å®‰è£…æœ‰ HDFS æœåŠ¡ Flink on Yarn Flink æä¾›äº†ä¸¤ç§åœ¨ yarn ä¸Šè¿è¡Œçš„æ¨¡å¼ï¼Œ åˆ†åˆ«ä¸º Session-Cluster å’Œ Per-Job-Clusteræ¨¡å¼ã€‚ Session-cluster æ¨¡å¼ï¼š Session-Cluster æ¨¡å¼éœ€è¦å…ˆå¯åŠ¨é›†ç¾¤ï¼Œ ç„¶åå†æäº¤ä½œä¸šï¼Œ æ¥ç€ä¼šå‘ yarn ç”³è¯·ä¸€å—ç©ºé—´åï¼Œ èµ„æºæ°¸è¿œä¿æŒä¸å˜ã€‚ å¦‚æœèµ„æºæ»¡äº†ï¼Œ ä¸‹ä¸€ä¸ªä½œä¸šå°±æ— æ³•æäº¤ï¼Œ åªèƒ½ç­‰åˆ° yarn ä¸­çš„å…¶ä¸­ä¸€ä¸ªä½œä¸šæ‰§è¡Œå®Œæˆåï¼Œ é‡Šæ”¾äº†èµ„æºï¼Œ ä¸‹ä¸ªä½œä¸šæ‰ä¼šæ­£å¸¸æäº¤ã€‚ æ‰€æœ‰ä½œ ä¸šå…±äº« Dispatcher å’Œ ResourceManagerï¼› å…±äº«èµ„æºï¼› é€‚åˆè§„æ¨¡å°æ‰§è¡Œæ—¶é—´çŸ­çš„ä½œä¸šã€‚ åœ¨ yarn ä¸­åˆå§‹åŒ–ä¸€ä¸ª flink é›†ç¾¤ï¼Œ å¼€è¾ŸæŒ‡å®šçš„èµ„æºï¼Œ ä»¥åæäº¤ä»»åŠ¡éƒ½å‘è¿™é‡Œæäº¤ã€‚ è¿™ä¸ª flink é›†ç¾¤ä¼šå¸¸é©»åœ¨ yarn é›†ç¾¤ä¸­ï¼Œ é™¤éæ‰‹å·¥åœæ­¢ã€‚ Per-Job-Cluster æ¨¡å¼ï¼š ä¸€ä¸ª Job ä¼šå¯¹åº”ä¸€ä¸ªé›†ç¾¤ï¼Œ æ¯æäº¤ä¸€ä¸ªä½œä¸šä¼šæ ¹æ®è‡ªèº«çš„æƒ…å†µï¼Œ éƒ½ä¼šå•ç‹¬å‘ yarnç”³è¯·èµ„æºï¼Œ ç›´åˆ°ä½œä¸šæ‰§è¡Œå®Œæˆï¼Œ ä¸€ä¸ªä½œä¸šçš„å¤±è´¥ä¸å¦å¹¶ä¸ä¼šå½±å“ä¸‹ä¸€ä¸ªä½œä¸šçš„æ­£å¸¸ æäº¤å’Œè¿è¡Œã€‚ ç‹¬äº« Dispatcher å’Œ ResourceManagerï¼Œ æŒ‰éœ€æ¥å—èµ„æºç”³è¯·ï¼› é€‚åˆè§„æ¨¡å¤§ é•¿æ—¶é—´è¿è¡Œçš„ä½œä¸šã€‚ æ¯æ¬¡æäº¤éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ flink é›†ç¾¤ï¼Œ ä»»åŠ¡ä¹‹é—´äº’ç›¸ç‹¬ç«‹ï¼Œ äº’ä¸å½±å“ï¼Œ æ–¹ä¾¿ç®¡ç†ã€‚ ä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹ååˆ›å»ºçš„é›†ç¾¤ä¹Ÿä¼šæ¶ˆå¤±ã€‚ Session Cluster å¯åŠ¨ hadoop é›†ç¾¤ï¼ˆ ç•¥ï¼‰ å¯åŠ¨ yarn-session ./yarn-session.sh -n 2 -s 2 -jm 1024 -tm 1024 -nm test -d å…¶ä¸­ï¼š -n(--container)ï¼š TaskManager çš„æ•°é‡ã€‚ -s(--slots)ï¼š æ¯ä¸ª TaskManager çš„ slot æ•°é‡ï¼Œ é»˜è®¤ä¸€ä¸ª slot ä¸€ä¸ª coreï¼Œ é»˜è®¤æ¯ä¸ª taskmanager çš„ slot çš„ä¸ªæ•°ä¸º 1ï¼Œ æœ‰æ—¶å¯ä»¥å¤šä¸€äº› taskmanagerï¼Œ åšå†—ä½™ã€‚ -jmï¼š JobManager çš„å†…å­˜ï¼ˆ å•ä½ MB)ã€‚ -tmï¼š æ¯ä¸ª taskmanager çš„å†…å­˜ï¼ˆ å•ä½ MB)ã€‚ -nmï¼š yarn çš„ appName(ç°åœ¨ yarn çš„ ui ä¸Šçš„åå­—)ã€‚ -dï¼š åå°æ‰§è¡Œã€‚ æ‰§è¡Œä»»åŠ¡ ./flink run -c com.atguigu.wc.StreamWordCount FlinkTutorial-1.0-SNAPSHOT-jar-with-dependencies.jar --host lcoalhost â€“port 7777 å» yarn æ§åˆ¶å°æŸ¥çœ‹ä»»åŠ¡çŠ¶æ€ å–æ¶ˆ yarn-session yarn application --kill application_1577588252906_0001 3.2.2 Per Job Cluster å¯åŠ¨ hadoop é›†ç¾¤ï¼ˆ ç•¥ï¼‰ ä¸å¯åŠ¨ yarn-sessionï¼Œ ç›´æ¥æ‰§è¡Œ job ./flink run â€“m yarn-cluster -c com.atguigu.wc.StreamWordCount FlinkTutorial-1.0-SNAPSHOT-jar-with-dependencies.jar --host lcoalhost â€“port 7777 Kubernetes éƒ¨ç½² å®¹å™¨åŒ–éƒ¨ç½²æ—¶ç›®å‰ä¸šç•Œå¾ˆæµè¡Œçš„ä¸€é¡¹æŠ€æœ¯ï¼Œ åŸºäº Docker é•œåƒè¿è¡Œèƒ½å¤Ÿè®©ç”¨æˆ·æ›´åŠ  æ–¹ ä¾¿ åœ° å¯¹ åº” ç”¨ è¿› è¡Œ ç®¡ ç† å’Œ è¿ ç»´ ã€‚ å®¹ å™¨ ç®¡ ç† å·¥ å…· ä¸­ æœ€ ä¸º æµ è¡Œ çš„ å°± æ˜¯ Kubernetesï¼ˆ k8sï¼‰ ï¼Œ è€Œ Flink ä¹Ÿåœ¨æœ€è¿‘çš„ç‰ˆæœ¬ä¸­æ”¯æŒäº† k8s éƒ¨ç½²æ¨¡å¼ã€‚ æ­å»º Kubernetes é›†ç¾¤ï¼ˆ ç•¥ï¼‰ é…ç½®å„ç»„ä»¶çš„ yaml æ–‡ä»¶ åœ¨ k8s ä¸Šæ„å»º Flink Session Clusterï¼Œ éœ€è¦å°† Flink é›†ç¾¤çš„ç»„ä»¶å¯¹åº”çš„ docker é•œåƒåˆ†åˆ«åœ¨ k8s ä¸Šå¯åŠ¨ï¼Œ åŒ…æ‹¬ JobManagerã€ TaskManagerã€ JobManagerService ä¸‰ä¸ªé•œåƒæœåŠ¡ã€‚ æ¯ä¸ªé•œåƒæœåŠ¡éƒ½å¯ä»¥ä»ä¸­å¤®é•œåƒä»“åº“ä¸­è·å–ã€‚ å¯åŠ¨ Flink Session Cluster // å¯åŠ¨ jobmanager-service æœåŠ¡ kubectl create -f jobmanager-service.yaml // å¯åŠ¨ jobmanager-deployment æœåŠ¡ kubectl create -f jobmanager-deployment.yaml // å¯åŠ¨ taskmanager-deployment æœåŠ¡ kubectl create -f taskmanager-deployment.yaml è®¿é—® Flink UI é¡µé¢ é›†ç¾¤å¯åŠ¨åï¼Œ å°±å¯ä»¥é€šè¿‡ JobManagerServicers ä¸­é…ç½®çš„ WebUI ç«¯å£ï¼Œ ç”¨æµè§ˆå™¨è¾“å…¥ä»¥ä¸‹ url æ¥è®¿é—® Flink UI é¡µé¢äº†ï¼š http://{JobManagerHost:Port}/api/v1/namespaces/default/services/flink-jobmanager:ui/proxy ","link":"https://tianxiawuhao.github.io/aPsJFkgVZ/"},{"title":"ç¬¬äºŒç«  å¿«é€Ÿä¸Šæ‰‹","content":"æ­å»º maven å·¥ç¨‹ FlinkTutorial pom æ–‡ä»¶ &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;groupId&gt;org.example&lt;/groupId&gt; &lt;artifactId&gt;flink-test&lt;/artifactId&gt; &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt; &lt;properties&gt; &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt; &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt; &lt;encoding&gt;UTF-8&lt;/encoding&gt; &lt;scala.version&gt;2.11&lt;/scala.version&gt; &lt;flink.version&gt;1.10.0&lt;/flink.version&gt; &lt;hadoop.version&gt;2.7.7&lt;/hadoop.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-java&lt;/artifactId&gt; &lt;version&gt;${flink.version}&lt;/version&gt; &lt;!--&lt;scope&gt;provided&lt;/scope&gt;--&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-streaming-java_${scala.version}&lt;/artifactId&gt; &lt;version&gt;${flink.version}&lt;/version&gt; &lt;!--&lt;scope&gt;provided&lt;/scope&gt;--&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;/project&gt; æ‰¹å¤„ç† wordcount WordCount ç¨‹åºæ˜¯å¤§æ•°æ®å¤„ç†æ¡†æ¶çš„å…¥é—¨ç¨‹åºï¼Œä¿—ç§°â€œå•è¯è®¡æ•°â€ã€‚ç”¨æ¥ç»Ÿè®¡ä¸€æ®µæ–‡å­—æ¯ä¸ªå•è¯çš„å‡ºç°æ¬¡æ•°ï¼Œè¯¥ç¨‹åºä¸»è¦åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šä¸€éƒ¨åˆ†æ˜¯å°†æ–‡å­—æ‹†åˆ†æˆå•è¯ï¼›å¦ä¸€éƒ¨åˆ†æ˜¯å•è¯è¿›è¡Œåˆ†ç»„è®¡æ•°å¹¶æ‰“å°è¾“å‡ºç»“æœã€‚ public static void main(String[] args) throws Exception { // åˆ›å»ºFlinkè¿è¡Œçš„ä¸Šä¸‹æ–‡ç¯å¢ƒ final ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment(); // åˆ›å»ºDataSetï¼Œè¿™é‡Œæˆ‘ä»¬çš„è¾“å…¥æ˜¯ä¸€è¡Œä¸€è¡Œçš„æ–‡æœ¬ DataSet&lt;String&gt; text = env.fromElements( &quot;Flink Spark Storm&quot;, &quot;Flink Flink Flink&quot;, &quot;Spark Spark Spark&quot;, &quot;Storm Storm Storm&quot; ); // é€šè¿‡Flinkå†…ç½®çš„è½¬æ¢å‡½æ•°è¿›è¡Œè®¡ç®— DataSet&lt;Tuple2&lt;String, Integer&gt;&gt; counts = text.flatMap(new LineSplitter()) .groupBy(0) .sum(1); //ç»“æœæ‰“å° counts.printToErr(); } public static final class LineSplitter implements FlatMapFunction&lt;String, Tuple2&lt;String, Integer&gt;&gt; { @Override public void flatMap(String value, Collector&lt;Tuple2&lt;String, Integer&gt;&gt; out) { // å°†æ–‡æœ¬åˆ†å‰² String[] tokens = value.toLowerCase().split(&quot;\\\\W+&quot;); for (String token : tokens) { if (token.length() &gt; 0) { out.collect(new Tuple2&lt;String, Integer&gt;(token, 1)); } } } } å®ç°çš„æ•´ä¸ªè¿‡ç¨‹ä¸­åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»º Flink çš„ä¸Šä¸‹æ–‡è¿è¡Œç¯å¢ƒï¼š å¤åˆ¶ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment(); ç„¶åï¼Œä½¿ç”¨ fromElements å‡½æ•°åˆ›å»ºä¸€ä¸ª DataSet å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¸­åŒ…å«äº†æˆ‘ä»¬çš„è¾“å…¥ï¼Œä½¿ç”¨ FlatMapã€GroupByã€SUM å‡½æ•°è¿›è¡Œè½¬æ¢ã€‚ æœ€åï¼Œç›´æ¥åœ¨æ§åˆ¶å°æ‰“å°è¾“å‡ºã€‚ æˆ‘ä»¬å¯ä»¥ç›´æ¥å³é”®è¿è¡Œä¸€ä¸‹ main æ–¹æ³•ï¼Œåœ¨æ§åˆ¶å°ä¼šå‡ºç°æˆ‘ä»¬æ‰“å°çš„è®¡ç®—ç»“æœï¼š æµå¤„ç† wordcount ä¸ºäº†æ¨¡ä»¿ä¸€ä¸ªæµå¼è®¡ç®—ç¯å¢ƒï¼Œæˆ‘ä»¬é€‰æ‹©ç›‘å¬ä¸€ä¸ªæœ¬åœ°çš„ Socket ç«¯å£ï¼Œå¹¶ä¸”ä½¿ç”¨ Flink ä¸­çš„æ»šåŠ¨çª—å£ï¼Œæ¯ 5 ç§’æ‰“å°ä¸€æ¬¡è®¡ç®—ç»“æœã€‚ä»£ç å¦‚ä¸‹ï¼š public class StreamingJob { public static void main(String[] args) throws Exception { // åˆ›å»ºFlinkçš„æµå¼è®¡ç®—ç¯å¢ƒ final StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); // ç›‘å¬æœ¬åœ°9000ç«¯å£ DataStream&lt;String&gt; text = env.socketTextStream(&quot;127.0.0.1&quot;, 9000, &quot;\\n&quot;); // å°†æ¥æ”¶çš„æ•°æ®è¿›è¡Œæ‹†åˆ†ï¼Œåˆ†ç»„ï¼Œçª—å£è®¡ç®—å¹¶ä¸”è¿›è¡Œèšåˆè¾“å‡º DataStream&lt;WordWithCount&gt; windowCounts = text .flatMap(new FlatMapFunction&lt;String, WordWithCount&gt;() { @Override public void flatMap(String value, Collector&lt;WordWithCount&gt; out) { for (String word : value.split(&quot;\\\\s&quot;)) { out.collect(new WordWithCount(word, 1L)); } } }) .keyBy(&quot;word&quot;) .timeWindow(Time.seconds(5), Time.seconds(1)) .reduce(new ReduceFunction&lt;WordWithCount&gt;() { @Override public WordWithCount reduce(WordWithCount a, WordWithCount b) { return new WordWithCount(a.word, a.count + b.count); } }); // æ‰“å°ç»“æœ windowCounts.print().setParallelism(1); env.execute(&quot;Socket Window WordCount&quot;); } // Data type for words with count public static class WordWithCount { public String word; public long count; public WordWithCount() {} public WordWithCount(String word, long count) { this.word = word; this.count = count; } @Override public String toString() { return word + &quot; : &quot; + count; } } } æ•´ä¸ªæµå¼è®¡ç®—çš„è¿‡ç¨‹åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ã€‚ é¦–å…ˆåˆ›å»ºä¸€ä¸ªæµå¼è®¡ç®—ç¯å¢ƒï¼š å¤åˆ¶StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); ç„¶åè¿›è¡Œç›‘å¬æœ¬åœ° 9000 ç«¯å£ï¼Œå°†æ¥æ”¶çš„æ•°æ®è¿›è¡Œæ‹†åˆ†ã€åˆ†ç»„ã€çª—å£è®¡ç®—å¹¶ä¸”è¿›è¡Œèšåˆè¾“å‡ºã€‚ä»£ç ä¸­ä½¿ç”¨äº† Flink çš„çª—å£å‡½æ•°ï¼Œæˆ‘ä»¬åœ¨åé¢çš„è¯¾ç¨‹ä¸­å°†è¯¦ç»†è®²è§£ã€‚ æˆ‘ä»¬åœ¨æœ¬åœ°ä½¿ç”¨ netcat å‘½ä»¤å¯åŠ¨ä¸€ä¸ªç«¯å£ï¼š nc -lk 9000 ç„¶åç›´æ¥è¿è¡Œæˆ‘ä»¬çš„ main æ–¹æ³•ï¼š æµ‹è¯•â€”â€”åœ¨ linux ç³»ç»Ÿä¸­ç”¨ netcat å‘½ä»¤è¿›è¡Œå‘é€æµ‹è¯•ã€‚ åœ¨ nc ä¸­è¾“å…¥ï¼š $ nc -lk 9000 Flink Flink Flink Flink Spark Storm å¯ä»¥åœ¨æ§åˆ¶å°çœ‹åˆ°ï¼š Flink : 4 Spark : 1 Storm : 1 ","link":"https://tianxiawuhao.github.io/pQQ9j5lFD/"},{"title":"ç¬¬ä¸€ç«  Flink ç®€ä»‹","content":"åˆè¯† Flink Flink èµ·æºäº Stratosphere é¡¹ç›®ï¼Œ Stratosphere æ˜¯åœ¨ 2010~2014 å¹´ç”± 3 æ‰€åœ°å¤„æŸæ—çš„å¤§å­¦å’Œæ¬§æ´²çš„ä¸€äº›å…¶ä»–çš„å¤§å­¦å…±åŒè¿›è¡Œçš„ç ”ç©¶é¡¹ç›®ï¼Œ 2014 å¹´ 4 æœˆ Stratosphere çš„ä»£ ç  è¢« å¤ åˆ¶ å¹¶ æ èµ  ç»™ äº† Apache è½¯ ä»¶ åŸº é‡‘ ä¼š ï¼Œ å‚ åŠ  è¿™ ä¸ª å­µ åŒ– é¡¹ ç›® çš„ åˆ å§‹ æˆ å‘˜ æ˜¯Stratosphere ç³»ç»Ÿçš„æ ¸å¿ƒå¼€å‘äººå‘˜ï¼Œ 2014 å¹´ 12 æœˆï¼Œ Flink ä¸€è·ƒæˆä¸º Apache è½¯ä»¶åŸºé‡‘ä¼šçš„é¡¶çº§é¡¹ç›®ã€‚ åœ¨å¾·è¯­ä¸­ï¼Œ Flink ä¸€è¯è¡¨ç¤ºå¿«é€Ÿå’Œçµå·§ï¼Œ é¡¹ç›®é‡‡ç”¨ä¸€åªæ¾é¼ çš„å½©è‰²å›¾æ¡ˆä½œä¸º logoï¼Œè¿™ä¸ä»…æ˜¯å› ä¸ºæ¾é¼ å…·æœ‰å¿«é€Ÿå’Œçµå·§çš„ç‰¹ç‚¹ï¼Œ è¿˜å› ä¸ºæŸæ—çš„æ¾é¼ æœ‰ä¸€ç§è¿·äººçš„çº¢æ£•è‰²ï¼Œ è€Œ Flink çš„æ¾é¼  logo æ‹¥æœ‰å¯çˆ±çš„å°¾å·´ï¼Œ å°¾å·´çš„é¢œè‰²ä¸ Apache è½¯ä»¶åŸºé‡‘ä¼šçš„ logo é¢œ è‰²ç›¸å‘¼åº”ï¼Œ ä¹Ÿå°±æ˜¯è¯´ï¼Œ è¿™æ˜¯ä¸€åª Apache é£æ ¼çš„æ¾é¼ ã€‚ Flink é¡¹ç›®çš„ç†å¿µæ˜¯ï¼šâ€œ Apache Flink æ˜¯ä¸ºåˆ†å¸ƒå¼ã€ é«˜æ€§èƒ½ã€ éšæ—¶å¯ç”¨ä»¥åŠå‡†ç¡®çš„æµå¤„ç†åº”ç”¨ç¨‹åºæ‰“é€ çš„å¼€æºæµå¤„ç†æ¡†æ¶â€ã€‚ Apache Flink æ˜¯ä¸€ä¸ªæ¡†æ¶å’Œåˆ†å¸ƒå¼å¤„ç†å¼•æ“ï¼Œ ç”¨äºå¯¹æ— ç•Œå’Œæœ‰ç•Œæ•°æ®æµè¿›è¡Œæœ‰çŠ¶æ€è®¡ç®—ã€‚ Flink è¢«è®¾è®¡åœ¨æ‰€æœ‰å¸¸è§çš„é›†ç¾¤ç¯å¢ƒä¸­è¿è¡Œï¼Œ ä»¥å†…å­˜æ‰§è¡Œé€Ÿåº¦å’Œä»»æ„è§„æ¨¡ æ¥æ‰§è¡Œè®¡ç®—ã€‚ Flink çš„é‡è¦ç‰¹ç‚¹ äº‹ä»¶é©±åŠ¨å‹(Event-driven) äº‹ä»¶é©±åŠ¨å‹åº”ç”¨æ˜¯ä¸€ç±»å…·æœ‰çŠ¶æ€çš„åº”ç”¨ï¼Œ å®ƒä»ä¸€ä¸ªæˆ–å¤šä¸ªäº‹ä»¶æµæå–æ•°æ®ï¼Œ å¹¶æ ¹æ®åˆ°æ¥çš„äº‹ä»¶è§¦å‘è®¡ç®—ã€ çŠ¶æ€æ›´æ–°æˆ–å…¶ä»–å¤–éƒ¨åŠ¨ä½œã€‚ æ¯”è¾ƒå…¸å‹çš„å°±æ˜¯ä»¥ kafka ä¸ºä»£è¡¨çš„æ¶ˆæ¯é˜Ÿåˆ—å‡ ä¹éƒ½æ˜¯äº‹ä»¶é©±åŠ¨å‹åº”ç”¨ã€‚ ä¸ä¹‹ä¸åŒçš„å°±æ˜¯ SparkStreaming å¾®æ‰¹æ¬¡ï¼Œ å¦‚å›¾ï¼š äº‹ä»¶é©±åŠ¨å‹ï¼š æµä¸æ‰¹çš„ä¸–ç•Œè§‚ æ‰¹å¤„ç†çš„ç‰¹ç‚¹æ˜¯æœ‰ç•Œã€ æŒä¹…ã€ å¤§é‡ï¼Œ éå¸¸é€‚åˆéœ€è¦è®¿é—®å…¨å¥—è®°å½•æ‰èƒ½å®Œæˆçš„è®¡ç®—å·¥ä½œï¼Œ ä¸€èˆ¬ç”¨äºç¦»çº¿ç»Ÿè®¡ã€‚ æµå¤„ç†çš„ç‰¹ç‚¹æ˜¯æ— ç•Œã€ å®æ—¶, æ— éœ€é’ˆå¯¹æ•´ä¸ªæ•°æ®é›†æ‰§è¡Œæ“ä½œï¼Œ è€Œæ˜¯å¯¹é€šè¿‡ç³»ç»Ÿä¼ è¾“çš„æ¯ä¸ªæ•°æ®é¡¹æ‰§è¡Œæ“ä½œï¼Œ ä¸€èˆ¬ç”¨äºå®æ—¶ç»Ÿè®¡ã€‚åœ¨ spark çš„ä¸–ç•Œè§‚ä¸­ï¼Œ ä¸€åˆ‡éƒ½æ˜¯ç”±æ‰¹æ¬¡ç»„æˆçš„ï¼Œ ç¦»çº¿æ•°æ®æ˜¯ä¸€ä¸ªå¤§æ‰¹æ¬¡ï¼Œ è€Œå®æ—¶æ•°æ®æ˜¯ç”±ä¸€ä¸ªä¸€ä¸ªæ— é™çš„å°æ‰¹æ¬¡ç»„æˆçš„ã€‚è€Œåœ¨ flink çš„ä¸–ç•Œè§‚ä¸­ï¼Œ ä¸€åˆ‡éƒ½æ˜¯ç”±æµç»„æˆçš„ï¼Œ ç¦»çº¿æ•°æ®æ˜¯æœ‰ç•Œé™çš„æµï¼Œ å®æ—¶æ•°æ®æ˜¯ä¸€ä¸ªæ²¡æœ‰ç•Œé™çš„æµï¼Œ è¿™å°±æ˜¯æ‰€è°“çš„æœ‰ç•Œæµå’Œæ— ç•Œæµã€‚ æ— ç•Œæ•°æ®æµï¼š æ— ç•Œæ•°æ®æµæœ‰ä¸€ä¸ªå¼€å§‹ä½†æ˜¯æ²¡æœ‰ç»“æŸï¼Œ å®ƒä»¬ä¸ä¼šåœ¨ç”Ÿæˆæ—¶ç»ˆæ­¢å¹¶æä¾›æ•°æ®ï¼Œ å¿…é¡»è¿ç»­å¤„ç†æ— ç•Œæµï¼Œ ä¹Ÿå°±æ˜¯è¯´å¿…é¡»åœ¨è·å–åç«‹å³å¤„ç† eventã€‚ å¯¹äºæ— ç•Œ æ•°æ®æµæˆ‘ä»¬æ— æ³•ç­‰å¾…æ‰€æœ‰æ•°æ®éƒ½åˆ°è¾¾ï¼Œ å› ä¸ºè¾“å…¥æ˜¯æ— ç•Œçš„ï¼Œ å¹¶ä¸”åœ¨ä»»ä½•æ—¶é—´ç‚¹éƒ½ä¸ä¼šå®Œæˆã€‚ å¤„ç†æ— ç•Œæ•°æ®é€šå¸¸è¦æ±‚ä»¥ç‰¹å®šé¡ºåºï¼ˆ ä¾‹å¦‚äº‹ä»¶å‘ç”Ÿçš„é¡ºåºï¼‰ è·å– eventï¼Œ ä»¥ä¾¿èƒ½å¤Ÿæ¨æ–­ç»“æœå®Œæ•´æ€§ã€‚ æœ‰ç•Œæ•°æ®æµï¼š æœ‰ç•Œæ•°æ®æµæœ‰æ˜ç¡®å®šä¹‰çš„å¼€å§‹å’Œç»“æŸï¼Œ å¯ä»¥åœ¨æ‰§è¡Œä»»ä½•è®¡ç®—ä¹‹å‰é€šè¿‡è·å–æ‰€æœ‰æ•°æ®æ¥å¤„ç†æœ‰ç•Œæµï¼Œ å¤„ç†æœ‰ç•Œæµä¸éœ€è¦æœ‰åºè·å–ï¼Œ å› ä¸ºå¯ä»¥å§‹ç»ˆå¯¹æœ‰ ç•Œæ•°æ®é›†è¿›è¡Œæ’åºï¼Œ æœ‰ç•Œæµçš„å¤„ç†ä¹Ÿç§°ä¸ºæ‰¹å¤„ç†ã€‚ è¿™ç§ä»¥æµä¸ºä¸–ç•Œè§‚çš„æ¶æ„ï¼Œ è·å¾—çš„æœ€å¤§å¥½å¤„å°±æ˜¯å…·æœ‰æä½çš„å»¶è¿Ÿã€‚ åˆ†å±‚ api æœ€åº•å±‚çº§çš„æŠ½è±¡ä»…ä»…æä¾›äº†æœ‰çŠ¶æ€æµï¼Œ å®ƒå°†é€šè¿‡è¿‡ç¨‹å‡½æ•°ï¼ˆ Process Functionï¼‰è¢«åµŒå…¥åˆ° DataStream API ä¸­ã€‚ åº•å±‚è¿‡ç¨‹å‡½æ•°ï¼ˆ Process Functionï¼‰ ä¸ DataStream APIç›¸é›†æˆï¼Œ ä½¿å…¶å¯ä»¥å¯¹æŸäº›ç‰¹å®šçš„æ“ä½œè¿›è¡Œåº•å±‚çš„æŠ½è±¡ï¼Œ å®ƒå…è®¸ç”¨æˆ·å¯ä»¥è‡ªç”±åœ°å¤„ç† æ¥è‡ªä¸€ä¸ªæˆ–å¤šä¸ªæ•°æ®æµçš„äº‹ä»¶ï¼Œ å¹¶ä½¿ç”¨ä¸€è‡´çš„å®¹é”™çš„çŠ¶æ€ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œ ç”¨æˆ·å¯ä»¥æ³¨å†Œäº‹ä»¶æ—¶é—´å¹¶å¤„ç†æ—¶é—´å›è°ƒï¼Œ ä»è€Œä½¿ç¨‹åºå¯ä»¥å¤„ç†å¤æ‚çš„è®¡ç®—ã€‚ å®é™…ä¸Šï¼Œ å¤§å¤šæ•°åº”ç”¨å¹¶ä¸éœ€è¦ä¸Šè¿°çš„åº•å±‚æŠ½è±¡ï¼Œ è€Œæ˜¯é’ˆå¯¹æ ¸å¿ƒ APIï¼ˆ Core APIsï¼‰è¿›è¡Œç¼–ç¨‹ï¼Œ æ¯”å¦‚ DataStream APIï¼ˆ æœ‰ç•Œæˆ–æ— ç•Œæµæ•°æ®ï¼‰ ä»¥åŠ DataSet APIï¼ˆ æœ‰ç•Œæ•°æ®é›†ï¼‰ ã€‚ è¿™äº› API ä¸ºæ•°æ®å¤„ç†æä¾›äº†é€šç”¨çš„æ„å»ºæ¨¡å—ï¼Œ æ¯”å¦‚ç”±ç”¨æˆ·å®šä¹‰çš„å¤šç§å½¢å¼çš„ è½¬æ¢ï¼ˆ transformationsï¼‰ ï¼Œ è¿æ¥ï¼ˆ joinsï¼‰ ï¼Œ èšåˆï¼ˆ aggregationsï¼‰ ï¼Œ çª—å£æ“ä½œï¼ˆ windowsï¼‰ç­‰ç­‰ã€‚ DataSet API ä¸ºæœ‰ç•Œæ•°æ®é›†æä¾›äº†é¢å¤–çš„æ”¯æŒï¼Œ ä¾‹å¦‚å¾ªç¯ä¸è¿­ä»£ã€‚ è¿™äº› API å¤„ç†çš„æ•°æ®ç±»å‹ä»¥ç±»ï¼ˆ classesï¼‰ çš„å½¢å¼ç”±å„è‡ªçš„ç¼–ç¨‹è¯­è¨€æ‰€è¡¨ç¤ºã€‚ Table API æ˜¯ä»¥è¡¨ä¸ºä¸­å¿ƒçš„å£°æ˜å¼ç¼–ç¨‹ï¼Œ å…¶ä¸­è¡¨å¯èƒ½ä¼šåŠ¨æ€å˜åŒ–ï¼ˆ åœ¨è¡¨è¾¾æµæ•°æ®æ—¶ï¼‰ ã€‚ Table API éµå¾ªï¼ˆ æ‰©å±•çš„ï¼‰ å…³ç³»æ¨¡å‹ï¼š è¡¨æœ‰äºŒç»´æ•°æ®ç»“æ„ï¼ˆ schemaï¼‰ ï¼ˆ ç±»ä¼¼äºå…³ç³»æ•°æ®åº“ä¸­çš„è¡¨ï¼‰ï¼Œ åŒæ—¶ API æä¾›å¯æ¯”è¾ƒçš„æ“ä½œï¼Œ ä¾‹å¦‚ selectã€ projectã€ joinã€group-byã€aggregate ç­‰ã€‚ Table API ç¨‹åºå£°æ˜å¼åœ°å®šä¹‰äº†ä»€ä¹ˆé€»è¾‘æ“ä½œåº”è¯¥æ‰§è¡Œï¼Œ è€Œä¸æ˜¯å‡†ç¡®åœ° ç¡®å®šè¿™äº›æ“ä½œä»£ç çš„çœ‹ä¸Šå»å¦‚ä½•ã€‚ å°½ç®¡ Table API å¯ä»¥é€šè¿‡å¤šç§ç±»å‹çš„ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°ï¼ˆ UDFï¼‰ è¿›è¡Œæ‰©å±•ï¼Œ å…¶ä»ä¸å¦‚æ ¸å¿ƒ API æ›´å…·è¡¨è¾¾èƒ½åŠ›ï¼Œ ä½†æ˜¯ä½¿ç”¨èµ·æ¥å´æ›´åŠ ç®€æ´ï¼ˆ ä»£ç é‡æ›´å°‘ï¼‰ ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œ Table API ç¨‹åºåœ¨æ‰§è¡Œä¹‹å‰ä¼šç»è¿‡å†…ç½®ä¼˜åŒ–å™¨è¿›è¡Œä¼˜åŒ–ã€‚ ä½ å¯ä»¥åœ¨è¡¨ä¸ DataStream/DataSet ä¹‹é—´æ— ç¼åˆ‡æ¢ï¼Œ ä»¥å…è®¸ç¨‹åºå°† Table API ä¸DataStream ä»¥åŠ DataSet æ··åˆä½¿ç”¨ã€‚ Flink æ ä¾› çš„ æœ€é«˜ å±‚ çº§ çš„ æŠ½ è±¡ æ˜¯ SQL ã€‚ è¿™ ä¸€ å±‚æŠ½ è±¡ åœ¨ è¯­ æ³• ä¸ è¡¨ è¾¾èƒ½ åŠ› ä¸Š ä¸Table API ç±»ä¼¼ï¼Œ ä½†æ˜¯æ˜¯ä»¥ SQL æŸ¥è¯¢è¡¨è¾¾å¼çš„å½¢å¼è¡¨ç°ç¨‹åºã€‚ SQL æŠ½è±¡ä¸ Table APIã€‚äº¤äº’å¯†åˆ‡ï¼Œ åŒæ—¶ SQL æŸ¥è¯¢å¯ä»¥ç›´æ¥åœ¨ Table API å®šä¹‰çš„è¡¨ä¸Šæ‰§è¡Œã€‚ ç›®å‰ Flink ä½œä¸ºæ‰¹å¤„ç†è¿˜ä¸æ˜¯ä¸»æµï¼Œ ä¸å¦‚ Spark æˆç†Ÿï¼Œ æ‰€ä»¥ DataSet ä½¿ç”¨çš„å¹¶ä¸æ˜¯å¾ˆå¤šã€‚ Flink Table API å’Œ Flink SQL ä¹Ÿå¹¶ä¸å®Œå–„ï¼Œ å¤§å¤šéƒ½ç”±å„å¤§å‚å•†è‡ªå·±å®šåˆ¶ã€‚ æ‰€ä»¥æˆ‘ä»¬ä¸»è¦å­¦ä¹  DataStream API çš„ä½¿ç”¨ã€‚ å®é™…ä¸Š Flink ä½œä¸ºæœ€æ¥è¿‘ Google DataFlowæ¨¡å‹çš„å®ç°ï¼Œ æ˜¯æµæ‰¹ç»Ÿä¸€çš„è§‚ç‚¹ï¼Œ æ‰€ä»¥åŸºæœ¬ä¸Šä½¿ç”¨ DataStream å°±å¯ä»¥äº†ã€‚ Flink å‡ å¤§æ¨¡å— Flink Table &amp; SQL(è¿˜æ²¡å¼€å‘å®Œ) Flink Gelly(å›¾è®¡ç®—) Flink CEP(å¤æ‚äº‹ä»¶å¤„ç†) ","link":"https://tianxiawuhao.github.io/gam9PGQCS/"},{"title":"Flink é›¶åŸºç¡€å®æˆ˜æ•™ç¨‹ï¼šå¦‚ä½•è®¡ç®—å®æ—¶çƒ­é—¨å•†å“","content":"åœ¨ä¸Šä¸€ç¯‡å…¥é—¨æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»èƒ½å¤Ÿå¿«é€Ÿæ„å»ºä¸€ä¸ªåŸºç¡€çš„ Flink ç¨‹åºäº†ã€‚æœ¬æ–‡ä¼šä¸€æ­¥æ­¥åœ°å¸¦é¢†ä½ å®ç°ä¸€ä¸ªæ›´å¤æ‚çš„ Flink åº”ç”¨ç¨‹åºï¼šå®æ—¶çƒ­é—¨å•†å“ã€‚åœ¨å¼€å§‹æœ¬æ–‡å‰æˆ‘ä»¬å»ºè®®ä½ å…ˆå®è·µä¸€éä¸Šç¯‡æ–‡ç« ï¼Œå› ä¸ºæœ¬æ–‡ä¼šæ²¿ç”¨ä¸Šæ–‡çš„my-flink-projecté¡¹ç›®æ¡†æ¶ã€‚ é€šè¿‡æœ¬æ–‡ä½ å°†å­¦åˆ°ï¼š 1. å¦‚ä½•åŸºäº EventTime å¤„ç†ï¼Œå¦‚ä½•æŒ‡å®š Watermark 2. å¦‚ä½•ä½¿ç”¨ Flink çµæ´»çš„ Window API 3. ä½•æ—¶éœ€è¦ç”¨åˆ° Stateï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨ 4. å¦‚ä½•ä½¿ç”¨ ProcessFunction å®ç° TopN åŠŸèƒ½ å®æˆ˜æ¡ˆä¾‹ä»‹ç» æœ¬æ¡ˆä¾‹å°†å®ç°ä¸€ä¸ªâ€œå®æ—¶çƒ­é—¨å•†å“â€çš„éœ€æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥å°†â€œå®æ—¶çƒ­é—¨å•†å“â€ç¿»è¯‘æˆç¨‹åºå‘˜æ›´å¥½ç†è§£çš„éœ€æ±‚ï¼šæ¯éš”5åˆ†é’Ÿè¾“å‡ºæœ€è¿‘ä¸€å°æ—¶å†…ç‚¹å‡»é‡æœ€å¤šçš„å‰ N ä¸ªå•†å“ã€‚å°†è¿™ä¸ªéœ€æ±‚è¿›è¡Œåˆ†è§£æˆ‘ä»¬å¤§æ¦‚è¦åšè¿™ä¹ˆå‡ ä»¶äº‹æƒ…ï¼š * æŠ½å–å‡ºä¸šåŠ¡æ—¶é—´æˆ³ï¼Œå‘Šè¯‰ Flink æ¡†æ¶åŸºäºä¸šåŠ¡æ—¶é—´åšçª—å£ * è¿‡æ»¤å‡ºç‚¹å‡»è¡Œä¸ºæ•°æ® * æŒ‰ä¸€å°æ—¶çš„çª—å£å¤§å°ï¼Œæ¯5åˆ†é’Ÿç»Ÿè®¡ä¸€æ¬¡ï¼Œåšæ»‘åŠ¨çª—å£èšåˆï¼ˆSliding Windowï¼‰ * æŒ‰æ¯ä¸ªçª—å£èšåˆï¼Œè¾“å‡ºæ¯ä¸ªçª—å£ä¸­ç‚¹å‡»é‡å‰Nåçš„å•†å“ æ•°æ®å‡†å¤‡ è¿™é‡Œæˆ‘ä»¬å‡†å¤‡äº†ä¸€ä»½æ·˜å®ç”¨æˆ·è¡Œä¸ºæ•°æ®é›†ï¼ˆæ¥è‡ªé˜¿é‡Œäº‘å¤©æ± å…¬å¼€æ•°æ®é›†ï¼Œç‰¹åˆ«æ„Ÿè°¢ï¼‰ã€‚æœ¬æ•°æ®é›†åŒ…å«äº†æ·˜å®ä¸ŠæŸä¸€å¤©éšæœºä¸€ç™¾ä¸‡ç”¨æˆ·çš„æ‰€æœ‰è¡Œä¸ºï¼ˆåŒ…æ‹¬ç‚¹å‡»ã€è´­ä¹°ã€åŠ è´­ã€æ”¶è—ï¼‰ã€‚æ•°æ®é›†çš„ç»„ç»‡å½¢å¼å’ŒMovieLens-20Mç±»ä¼¼ï¼Œå³æ•°æ®é›†çš„æ¯ä¸€è¡Œè¡¨ç¤ºä¸€æ¡ç”¨æˆ·è¡Œä¸ºï¼Œç”±ç”¨æˆ·IDã€å•†å“IDã€å•†å“ç±»ç›®IDã€è¡Œä¸ºç±»å‹å’Œæ—¶é—´æˆ³ç»„æˆï¼Œå¹¶ä»¥é€—å·åˆ†éš”ã€‚å…³äºæ•°æ®é›†ä¸­æ¯ä¸€åˆ—çš„è¯¦ç»†æè¿°å¦‚ä¸‹ï¼š åˆ—åç§° è¯´æ˜ ç”¨æˆ·ID æ•´æ•°ç±»å‹ï¼ŒåŠ å¯†åçš„ç”¨æˆ·ID å•†å“ID æ•´æ•°ç±»å‹ï¼ŒåŠ å¯†åçš„å•†å“ID å•†å“ç±»ç›®ID æ•´æ•°ç±»å‹ï¼ŒåŠ å¯†åçš„å•†å“æ‰€å±ç±»ç›®ID è¡Œä¸ºç±»å‹ å­—ç¬¦ä¸²ï¼Œæšä¸¾ç±»å‹ï¼ŒåŒ…æ‹¬(â€˜pvâ€™, â€˜buyâ€™, â€˜cartâ€™, â€˜favâ€™) æ—¶é—´æˆ³ è¡Œä¸ºå‘ç”Ÿçš„æ—¶é—´æˆ³ï¼Œå•ä½ç§’ ä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤ä¸‹è½½æ•°æ®é›†åˆ°é¡¹ç›®çš„ resources ç›®å½•ä¸‹ï¼š $ cd my-flink-project/src/main/resources $ curl https://raw.githubusercontent.com/wuchong/my-flink-project/master/src/main/resources/UserBehavior.csv &gt; UserBehavior.csv è¿™é‡Œæ˜¯å¦ä½¿ç”¨ curl å‘½ä»¤ä¸‹è½½æ•°æ®å¹¶ä¸é‡è¦ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ wget å‘½ä»¤æˆ–è€…ç›´æ¥è®¿é—®é“¾æ¥ä¸‹è½½æ•°æ®ã€‚å…³é”®æ˜¯ï¼Œå°†æ•°æ®æ–‡ä»¶ä¿å­˜åˆ°é¡¹ç›®çš„ resources ç›®å½•ä¸‹ï¼Œæ–¹ä¾¿åº”ç”¨ç¨‹åºè®¿é—®ã€‚ ç¼–å†™ç¨‹åº åœ¨ src/main/java/myflink ä¸‹åˆ›å»º HotItems.java æ–‡ä»¶ï¼š package myflink; public class HotItems { public static void main(String[] args) throws Exception { } } ä¸ä¸Šæ–‡ä¸€æ ·ï¼Œæˆ‘ä»¬ä¼šä¸€æ­¥æ­¥å¾€é‡Œé¢å¡«å……ä»£ç ã€‚ç¬¬ä¸€æ­¥ä»ç„¶æ˜¯åˆ›å»ºä¸€ä¸ª StreamExecutionEnvironmentï¼Œæˆ‘ä»¬æŠŠå®ƒæ·»åŠ åˆ° main å‡½æ•°ä¸­ã€‚ StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); // ä¸ºäº†æ‰“å°åˆ°æ§åˆ¶å°çš„ç»“æœä¸ä¹±åºï¼Œæˆ‘ä»¬é…ç½®å…¨å±€çš„å¹¶å‘ä¸º1ï¼Œè¿™é‡Œæ”¹å˜å¹¶å‘å¯¹ç»“æœæ­£ç¡®æ€§æ²¡æœ‰å½±å“ env.setParallelism(1); åˆ›å»ºæ¨¡æ‹Ÿæ•°æ®æº åœ¨æ•°æ®å‡†å¤‡ç« èŠ‚ï¼Œæˆ‘ä»¬å·²ç»å°†æµ‹è¯•çš„æ•°æ®é›†ä¸‹è½½åˆ°æœ¬åœ°äº†ã€‚ç”±äºæ˜¯ä¸€ä¸ªcsvæ–‡ä»¶ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ CsvInputFormat åˆ›å»ºæ¨¡æ‹Ÿæ•°æ®æºã€‚ æ³¨ï¼šè™½ç„¶ä¸€ä¸ªæµå¼åº”ç”¨åº”è¯¥æ˜¯ä¸€ä¸ªä¸€ç›´è¿è¡Œç€çš„ç¨‹åºï¼Œéœ€è¦æ¶ˆè´¹ä¸€ä¸ªæ— é™æ•°æ®æºã€‚ä½†æ˜¯åœ¨æœ¬æ¡ˆä¾‹æ•™ç¨‹ä¸­ï¼Œä¸ºäº†çœå»æ„å»ºçœŸå®æ•°æ®æºçš„ç¹çï¼Œæˆ‘ä»¬ä½¿ç”¨äº†æ–‡ä»¶æ¥æ¨¡æ‹ŸçœŸå®æ•°æ®æºï¼Œè¿™å¹¶ä¸å½±å“ä¸‹æ–‡è¦ä»‹ç»çš„çŸ¥è¯†ç‚¹ã€‚è¿™ä¹Ÿæ˜¯ä¸€ç§æœ¬åœ°éªŒè¯ Flink åº”ç”¨ç¨‹åºæ­£ç¡®æ€§çš„å¸¸ç”¨æ–¹å¼ã€‚ æˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ª UserBehavior çš„ POJO ç±»ï¼ˆæ‰€æœ‰æˆå‘˜å˜é‡å£°æ˜æˆpublicä¾¿æ˜¯POJOç±»ï¼‰ï¼Œå¼ºç±»å‹åŒ–åèƒ½æ–¹ä¾¿åç»­çš„å¤„ç†ã€‚ /** ç”¨æˆ·è¡Œä¸ºæ•°æ®ç»“æ„ **/ public static class UserBehavior { public long userId; // ç”¨æˆ·ID public long itemId; // å•†å“ID public int categoryId; // å•†å“ç±»ç›®ID public String behavior; // ç”¨æˆ·è¡Œä¸º, åŒ…æ‹¬(&quot;pv&quot;, &quot;buy&quot;, &quot;cart&quot;, &quot;fav&quot;) public long timestamp; // è¡Œä¸ºå‘ç”Ÿçš„æ—¶é—´æˆ³ï¼Œå•ä½ç§’ } æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºä¸€ä¸ª PojoCsvInputFormat äº†ï¼Œ è¿™æ˜¯ä¸€ä¸ªè¯»å– csv æ–‡ä»¶å¹¶å°†æ¯ä¸€è¡Œè½¬æˆæŒ‡å®š POJO ç±»å‹ï¼ˆåœ¨æˆ‘ä»¬æ¡ˆä¾‹ä¸­æ˜¯ UserBehaviorï¼‰çš„è¾“å…¥å™¨ã€‚ // UserBehavior.csv çš„æœ¬åœ°æ–‡ä»¶è·¯å¾„ URL fileUrl = HotItems2.class.getClassLoader().getResource(&quot;UserBehavior.csv&quot;); Path filePath = Path.fromLocalFile(new File(fileUrl.toURI())); // æŠ½å– UserBehavior çš„ TypeInformationï¼Œæ˜¯ä¸€ä¸ª PojoTypeInfo PojoTypeInfo&lt;UserBehavior&gt; pojoType = (PojoTypeInfo&lt;UserBehavior&gt;) TypeExtractor.createTypeInfo(UserBehavior.class); // ç”±äº Java åå°„æŠ½å–å‡ºçš„å­—æ®µé¡ºåºæ˜¯ä¸ç¡®å®šçš„ï¼Œéœ€è¦æ˜¾å¼æŒ‡å®šä¸‹æ–‡ä»¶ä¸­å­—æ®µçš„é¡ºåº String[] fieldOrder = new String[]{&quot;userId&quot;, &quot;itemId&quot;, &quot;categoryId&quot;, &quot;behavior&quot;, &quot;timestamp&quot;}; // åˆ›å»º PojoCsvInputFormat PojoCsvInputFormat&lt;UserBehavior&gt; csvInput = new PojoCsvInputFormat&lt;&gt;(filePath, pojoType, fieldOrder); ä¸‹ä¸€æ­¥æˆ‘ä»¬ç”¨ PojoCsvInputFormat åˆ›å»ºè¾“å…¥æºã€‚ DataStream&lt;UserBehavior&gt; dataSource = env.createInput(csvInput, pojoType); è¿™å°±åˆ›å»ºäº†ä¸€ä¸ª UserBehavior ç±»å‹çš„ DataStreamã€‚ EventTime ä¸ Watermark å½“æˆ‘ä»¬è¯´â€œç»Ÿè®¡è¿‡å»ä¸€å°æ—¶å†…ç‚¹å‡»é‡â€ï¼Œè¿™é‡Œçš„â€œä¸€å°æ—¶â€æ˜¯æŒ‡ä»€ä¹ˆå‘¢ï¼Ÿ åœ¨ Flink ä¸­å®ƒå¯ä»¥æ˜¯æŒ‡ ProcessingTime ï¼Œä¹Ÿå¯ä»¥æ˜¯ EventTimeï¼Œç”±ç”¨æˆ·å†³å®šã€‚ ProcessingTimeï¼šäº‹ä»¶è¢«å¤„ç†çš„æ—¶é—´ã€‚ä¹Ÿå°±æ˜¯ç”±æœºå™¨çš„ç³»ç»Ÿæ—¶é—´æ¥å†³å®šã€‚ EventTimeï¼šäº‹ä»¶å‘ç”Ÿçš„æ—¶é—´ã€‚ä¸€èˆ¬å°±æ˜¯æ•°æ®æœ¬èº«æºå¸¦çš„æ—¶é—´ã€‚ åœ¨æœ¬æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç»Ÿè®¡ä¸šåŠ¡æ—¶é—´ä¸Šçš„æ¯å°æ—¶çš„ç‚¹å‡»é‡ï¼Œæ‰€ä»¥è¦åŸºäº EventTime æ¥å¤„ç†ã€‚é‚£ä¹ˆå¦‚æœè®© Flink æŒ‰ç…§æˆ‘ä»¬æƒ³è¦çš„ä¸šåŠ¡æ—¶é—´æ¥å¤„ç†å‘¢ï¼Ÿè¿™é‡Œä¸»è¦æœ‰ä¸¤ä»¶äº‹æƒ…è¦åšã€‚ ç¬¬ä¸€ä»¶æ˜¯å‘Šè¯‰ Flink æˆ‘ä»¬ç°åœ¨æŒ‰ç…§ EventTime æ¨¡å¼è¿›è¡Œå¤„ç†ï¼ŒFlink é»˜è®¤ä½¿ç”¨ ProcessingTime å¤„ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ˜¾å¼è®¾ç½®ä¸‹ã€‚ env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime); ç¬¬äºŒä»¶äº‹æƒ…æ˜¯æŒ‡å®šå¦‚ä½•è·å¾—ä¸šåŠ¡æ—¶é—´ï¼Œä»¥åŠç”Ÿæˆ Watermarkã€‚Watermark æ˜¯ç”¨æ¥è¿½è¸ªä¸šåŠ¡äº‹ä»¶çš„æ¦‚å¿µï¼Œå¯ä»¥ç†è§£æˆ EventTime ä¸–ç•Œä¸­çš„æ—¶é’Ÿï¼Œç”¨æ¥æŒ‡ç¤ºå½“å‰å¤„ç†åˆ°ä»€ä¹ˆæ—¶åˆ»çš„æ•°æ®äº†ã€‚ç”±äºæˆ‘ä»¬çš„æ•°æ®æºçš„æ•°æ®å·²ç»ç»è¿‡æ•´ç†ï¼Œæ²¡æœ‰ä¹±åºï¼Œå³äº‹ä»¶çš„æ—¶é—´æˆ³æ˜¯å•è°ƒé€’å¢çš„ï¼Œæ‰€ä»¥å¯ä»¥å°†æ¯æ¡æ•°æ®çš„ä¸šåŠ¡æ—¶é—´å°±å½“åš Watermarkã€‚è¿™é‡Œæˆ‘ä»¬ç”¨ AscendingTimestampExtractor æ¥å®ç°æ—¶é—´æˆ³çš„æŠ½å–å’Œ Watermark çš„ç”Ÿæˆã€‚ æ³¨ï¼šçœŸå®ä¸šåŠ¡åœºæ™¯ä¸€èˆ¬éƒ½æ˜¯å­˜åœ¨ä¹±åºçš„ï¼Œæ‰€ä»¥ä¸€èˆ¬ä½¿ç”¨ BoundedOutOfOrdernessTimestampExtractorã€‚ DataStream&lt;UserBehavior&gt; timedData = dataSource .assignTimestampsAndWatermarks(new AscendingTimestampExtractor&lt;UserBehavior&gt;() { @Override public long extractAscendingTimestamp(UserBehavior userBehavior) { // åŸå§‹æ•°æ®å•ä½ç§’ï¼Œå°†å…¶è½¬æˆæ¯«ç§’ return userBehavior.timestamp * 1000; } }); è¿™æ ·æˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€ä¸ªå¸¦æœ‰æ—¶é—´æ ‡è®°çš„æ•°æ®æµäº†ï¼Œåé¢å°±èƒ½åšä¸€äº›çª—å£çš„æ“ä½œã€‚ è¿‡æ»¤å‡ºç‚¹å‡»äº‹ä»¶ åœ¨å¼€å§‹çª—å£æ“ä½œä¹‹å‰ï¼Œå…ˆå›é¡¾ä¸‹éœ€æ±‚â€œæ¯éš”5åˆ†é’Ÿè¾“å‡ºè¿‡å»ä¸€å°æ—¶å†…ç‚¹å‡»é‡æœ€å¤šçš„å‰ N ä¸ªå•†å“â€ã€‚ç”±äºåŸå§‹æ•°æ®ä¸­å­˜åœ¨ç‚¹å‡»ã€åŠ è´­ã€è´­ä¹°ã€æ”¶è—å„ç§è¡Œä¸ºçš„æ•°æ®ï¼Œä½†æ˜¯æˆ‘ä»¬åªéœ€è¦ç»Ÿè®¡ç‚¹å‡»é‡ï¼Œæ‰€ä»¥å…ˆä½¿ç”¨ FilterFunction å°†ç‚¹å‡»è¡Œä¸ºæ•°æ®è¿‡æ»¤å‡ºæ¥ã€‚ DataStream&lt;UserBehavior&gt; pvData = timedData .filter(new FilterFunction&lt;UserBehavior&gt;() { @Override public boolean filter(UserBehavior userBehavior) throws Exception { // è¿‡æ»¤å‡ºåªæœ‰ç‚¹å‡»çš„æ•°æ® return userBehavior.behavior.equals(&quot;pv&quot;); } }); çª—å£ç»Ÿè®¡ç‚¹å‡»é‡ ç”±äºè¦æ¯éš”5åˆ†é’Ÿç»Ÿè®¡ä¸€æ¬¡æœ€è¿‘ä¸€å°æ—¶æ¯ä¸ªå•†å“çš„ç‚¹å‡»é‡ï¼Œæ‰€ä»¥çª—å£å¤§å°æ˜¯ä¸€å°æ—¶ï¼Œæ¯éš”5åˆ†é’Ÿæ»‘åŠ¨ä¸€æ¬¡ã€‚å³åˆ†åˆ«è¦ç»Ÿè®¡ [09:00, 10:00), [09:05, 10:05), [09:10, 10:10)â€¦ ç­‰çª—å£çš„å•†å“ç‚¹å‡»é‡ã€‚æ˜¯ä¸€ä¸ªå¸¸è§çš„æ»‘åŠ¨çª—å£éœ€æ±‚ï¼ˆSliding Windowï¼‰ã€‚ DataStream&lt;ItemViewCount&gt; windowedData = pvData .keyBy(&quot;itemId&quot;) .timeWindow(Time.minutes(60), Time.minutes(5)) .aggregate(new CountAgg(), new WindowResultFunction()); æˆ‘ä»¬ä½¿ç”¨.keyBy(&quot;itemId&quot;)å¯¹å•†å“è¿›è¡Œåˆ†ç»„ï¼Œä½¿ç”¨.timeWindow(Time size, Time slide)å¯¹æ¯ä¸ªå•†å“åšæ»‘åŠ¨çª—å£ï¼ˆ1å°æ—¶çª—å£ï¼Œ5åˆ†é’Ÿæ»‘åŠ¨ä¸€æ¬¡ï¼‰ã€‚ç„¶åæˆ‘ä»¬ä½¿ç”¨.aggregate(AggregateFunction af, WindowFunction wf)åšå¢é‡çš„èšåˆæ“ä½œï¼Œå®ƒèƒ½ä½¿ç”¨AggregateFunctionæå‰èšåˆæ‰æ•°æ®ï¼Œå‡å°‘ state çš„å­˜å‚¨å‹åŠ›ã€‚è¾ƒä¹‹.apply(WindowFunction wf)ä¼šå°†çª—å£ä¸­çš„æ•°æ®éƒ½å­˜å‚¨ä¸‹æ¥ï¼Œæœ€åä¸€èµ·è®¡ç®—è¦é«˜æ•ˆåœ°å¤šã€‚aggregate()æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ç”¨äº è¿™é‡Œçš„CountAggå®ç°äº†AggregateFunctionæ¥å£ï¼ŒåŠŸèƒ½æ˜¯ç»Ÿè®¡çª—å£ä¸­çš„æ¡æ•°ï¼Œå³é‡åˆ°ä¸€æ¡æ•°æ®å°±åŠ ä¸€ã€‚ /** COUNT ç»Ÿè®¡çš„èšåˆå‡½æ•°å®ç°ï¼Œæ¯å‡ºç°ä¸€æ¡è®°å½•åŠ ä¸€ */ public static class CountAgg implements AggregateFunction&lt;UserBehavior, Long, Long&gt; { @Override public Long createAccumulator() { return 0L; } @Override public Long add(UserBehavior userBehavior, Long acc) { return acc + 1; } @Override public Long getResult(Long acc) { return acc; } @Override public Long merge(Long acc1, Long acc2) { return acc1 + acc2; } } .aggregate(AggregateFunction af, WindowFunction wf) çš„ç¬¬äºŒä¸ªå‚æ•°WindowFunctionå°†æ¯ä¸ª keyæ¯ä¸ªçª—å£èšåˆåçš„ç»“æœå¸¦ä¸Šå…¶ä»–ä¿¡æ¯è¿›è¡Œè¾“å‡ºã€‚æˆ‘ä»¬è¿™é‡Œå®ç°çš„WindowResultFunctionå°†ä¸»é”®å•†å“IDï¼Œçª—å£ï¼Œç‚¹å‡»é‡å°è£…æˆäº†ItemViewCountè¿›è¡Œè¾“å‡ºã€‚ /** ç”¨äºè¾“å‡ºçª—å£çš„ç»“æœ */ public static class WindowResultFunction implements WindowFunction&lt;Long, ItemViewCount, Tuple, TimeWindow&gt; { @Override public void apply( Tuple key, // çª—å£çš„ä¸»é”®ï¼Œå³ itemId TimeWindow window, // çª—å£ Iterable&lt;Long&gt; aggregateResult, // èšåˆå‡½æ•°çš„ç»“æœï¼Œå³ count å€¼ Collector&lt;ItemViewCount&gt; collector // è¾“å‡ºç±»å‹ä¸º ItemViewCount ) throws Exception { Long itemId = ((Tuple1&lt;Long&gt;) key).f0; Long count = aggregateResult.iterator().next(); collector.collect(ItemViewCount.of(itemId, window.getEnd(), count)); } } /** å•†å“ç‚¹å‡»é‡(çª—å£æ“ä½œçš„è¾“å‡ºç±»å‹) */ public static class ItemViewCount { public long itemId; // å•†å“ID public long windowEnd; // çª—å£ç»“æŸæ—¶é—´æˆ³ public long viewCount; // å•†å“çš„ç‚¹å‡»é‡ public static ItemViewCount of(long itemId, long windowEnd, long viewCount) { ItemViewCount result = new ItemViewCount(); result.itemId = itemId; result.windowEnd = windowEnd; result.viewCount = viewCount; return result; } } ç°åœ¨æˆ‘ä»¬å¾—åˆ°äº†æ¯ä¸ªå•†å“åœ¨æ¯ä¸ªçª—å£çš„ç‚¹å‡»é‡çš„æ•°æ®æµã€‚ TopN è®¡ç®—æœ€çƒ­é—¨å•†å“ ä¸ºäº†ç»Ÿè®¡æ¯ä¸ªçª—å£ä¸‹æœ€çƒ­é—¨çš„å•†å“ï¼Œæˆ‘ä»¬éœ€è¦å†æ¬¡æŒ‰çª—å£è¿›è¡Œåˆ†ç»„ï¼Œè¿™é‡Œæ ¹æ®ItemViewCountä¸­çš„windowEndè¿›è¡ŒkeyBy()æ“ä½œã€‚ç„¶åä½¿ç”¨ ProcessFunction å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„ TopN å‡½æ•° TopNHotItems æ¥è®¡ç®—ç‚¹å‡»é‡æ’åå‰3åçš„å•†å“ï¼Œå¹¶å°†æ’åç»“æœæ ¼å¼åŒ–æˆå­—ç¬¦ä¸²ï¼Œä¾¿äºåç»­è¾“å‡ºã€‚ DataStream&lt;String&gt; topItems = windowedData .keyBy(&quot;windowEnd&quot;) .process(new TopNHotItems(3)); // æ±‚ç‚¹å‡»é‡å‰3åçš„å•†å“ ProcessFunction æ˜¯ Flink æä¾›çš„ä¸€ä¸ª low-level APIï¼Œç”¨äºå®ç°æ›´é«˜çº§çš„åŠŸèƒ½ã€‚å®ƒä¸»è¦æä¾›äº†å®šæ—¶å™¨ timer çš„åŠŸèƒ½ï¼ˆæ”¯æŒEventTimeæˆ–ProcessingTimeï¼‰ã€‚æœ¬æ¡ˆä¾‹ä¸­æˆ‘ä»¬å°†åˆ©ç”¨ timer æ¥åˆ¤æ–­ä½•æ—¶æ”¶é½äº†æŸä¸ª window ä¸‹æ‰€æœ‰å•†å“çš„ç‚¹å‡»é‡æ•°æ®ã€‚ç”±äº Watermark çš„è¿›åº¦æ˜¯å…¨å±€çš„ï¼Œ åœ¨ processElement æ–¹æ³•ä¸­ï¼Œæ¯å½“æ”¶åˆ°ä¸€æ¡æ•°æ®ï¼ˆItemViewCountï¼‰ï¼Œæˆ‘ä»¬å°±æ³¨å†Œä¸€ä¸ª windowEnd+1 çš„å®šæ—¶å™¨ï¼ˆFlink æ¡†æ¶ä¼šè‡ªåŠ¨å¿½ç•¥åŒä¸€æ—¶é—´çš„é‡å¤æ³¨å†Œï¼‰ã€‚windowEnd+1 çš„å®šæ—¶å™¨è¢«è§¦å‘æ—¶ï¼Œæ„å‘³ç€æ”¶åˆ°äº†windowEnd+1çš„ Watermarkï¼Œå³æ”¶é½äº†è¯¥windowEndä¸‹çš„æ‰€æœ‰å•†å“çª—å£ç»Ÿè®¡å€¼ã€‚æˆ‘ä»¬åœ¨onTimer() ä¸­å¤„ç†å°†æ”¶é›†çš„æ‰€æœ‰å•†å“åŠç‚¹å‡»é‡è¿›è¡Œæ’åºï¼Œé€‰å‡º TopNï¼Œå¹¶å°†æ’åä¿¡æ¯æ ¼å¼åŒ–æˆå­—ç¬¦ä¸²åè¿›è¡Œè¾“å‡ºã€‚ è¿™é‡Œæˆ‘ä»¬è¿˜ä½¿ç”¨äº† ListState&lt;ItemViewCount&gt; æ¥å­˜å‚¨æ”¶åˆ°çš„æ¯æ¡ ItemViewCount æ¶ˆæ¯ï¼Œä¿è¯åœ¨å‘ç”Ÿæ•…éšœæ—¶ï¼ŒçŠ¶æ€æ•°æ®çš„ä¸ä¸¢å¤±å’Œä¸€è‡´æ€§ã€‚ListState æ˜¯ Flink æä¾›çš„ç±»ä¼¼ Java List æ¥å£çš„ State APIï¼Œå®ƒé›†æˆäº†æ¡†æ¶çš„ checkpoint æœºåˆ¶ï¼Œè‡ªåŠ¨åšåˆ°äº† exactly-once çš„è¯­ä¹‰ä¿è¯ã€‚ /** æ±‚æŸä¸ªçª—å£ä¸­å‰ N åçš„çƒ­é—¨ç‚¹å‡»å•†å“ï¼Œkey ä¸ºçª—å£æ—¶é—´æˆ³ï¼Œè¾“å‡ºä¸º TopN çš„ç»“æœå­—ç¬¦ä¸² */ public static class TopNHotItems extends KeyedProcessFunction&lt;Tuple, ItemViewCount, String&gt; { private final int topSize; public TopNHotItems(int topSize) { this.topSize = topSize; } // ç”¨äºå­˜å‚¨å•†å“ä¸ç‚¹å‡»æ•°çš„çŠ¶æ€ï¼Œå¾…æ”¶é½åŒä¸€ä¸ªçª—å£çš„æ•°æ®åï¼Œå†è§¦å‘ TopN è®¡ç®— private ListState&lt;ItemViewCount&gt; itemState; @Override public void open(Configuration parameters) throws Exception { super.open(parameters); // çŠ¶æ€çš„æ³¨å†Œ ListStateDescriptor&lt;ItemViewCount&gt; itemsStateDesc = new ListStateDescriptor&lt;&gt;( &quot;itemState-state&quot;, ItemViewCount.class); itemState = getRuntimeContext().getListState(itemsStateDesc); } @Override public void processElement( ItemViewCount input, Context context, Collector&lt;String&gt; collector) throws Exception { // æ¯æ¡æ•°æ®éƒ½ä¿å­˜åˆ°çŠ¶æ€ä¸­ itemState.add(input); // æ³¨å†Œ windowEnd+1 çš„ EventTime Timer, å½“è§¦å‘æ—¶ï¼Œè¯´æ˜æ”¶é½äº†å±äºwindowEndçª—å£çš„æ‰€æœ‰å•†å“æ•°æ® context.timerService().registerEventTimeTimer(input.windowEnd + 1); } @Override public void onTimer( long timestamp, OnTimerContext ctx, Collector&lt;String&gt; out) throws Exception { // è·å–æ”¶åˆ°çš„æ‰€æœ‰å•†å“ç‚¹å‡»é‡ List&lt;ItemViewCount&gt; allItems = new ArrayList&lt;&gt;(); for (ItemViewCount item : itemState.get()) { allItems.add(item); } // æå‰æ¸…é™¤çŠ¶æ€ä¸­çš„æ•°æ®ï¼Œé‡Šæ”¾ç©ºé—´ itemState.clear(); // æŒ‰ç…§ç‚¹å‡»é‡ä»å¤§åˆ°å°æ’åº allItems.sort(new Comparator&lt;ItemViewCount&gt;() { @Override public int compare(ItemViewCount o1, ItemViewCount o2) { return (int) (o2.viewCount - o1.viewCount); } }); // å°†æ’åä¿¡æ¯æ ¼å¼åŒ–æˆ String, ä¾¿äºæ‰“å° StringBuilder result = new StringBuilder(); result.append(&quot;====================================\\n&quot;); result.append(&quot;æ—¶é—´: &quot;).append(new Timestamp(timestamp-1)).append(&quot;\\n&quot;); for (int i=0;i&lt;topSize;i++) { ItemViewCount currentItem = allItems.get(i); // No1: å•†å“ID=12224 æµè§ˆé‡=2413 result.append(&quot;No&quot;).append(i).append(&quot;:&quot;) .append(&quot; å•†å“ID=&quot;).append(currentItem.itemId) .append(&quot; æµè§ˆé‡=&quot;).append(currentItem.viewCount) .append(&quot;\\n&quot;); } result.append(&quot;====================================\\n\\n&quot;); out.collect(result.toString()); } } æ‰“å°è¾“å‡º æœ€åä¸€æ­¥æˆ‘ä»¬å°†ç»“æœæ‰“å°è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œå¹¶è°ƒç”¨env.executeæ‰§è¡Œä»»åŠ¡ã€‚ topItems.print(); env.execute(&quot;Hot Items Job&quot;); è¿è¡Œç¨‹åº ç›´æ¥è¿è¡Œ main å‡½æ•°ï¼Œå°±èƒ½çœ‹åˆ°ä¸æ–­è¾“å‡ºçš„æ¯ä¸ªæ—¶é—´ç‚¹çš„çƒ­é—¨å•†å“IDã€‚ æ›´æ¢ Kafka ä½œä¸ºæ•°æ®æº å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œ æˆ‘ä»¬çš„æ•°æ®æµå¾€å¾€æ˜¯ä» Kafka è·å–åˆ°çš„ã€‚ å¦‚æœè¦è®©ä»£ç æ›´è´´ è¿‘ç”Ÿäº§å®é™…ï¼Œ æˆ‘ä»¬åªéœ€å°† source æ›´æ¢ä¸º Kafka å³å¯ï¼š val properties = new Properties() properties.setProperty(&quot;bootstrap.servers&quot;, &quot;localhost:9092&quot;) properties.setProperty(&quot;group.id&quot;, &quot;consumer-group&quot;) properties.setProperty(&quot;key.deserializer&quot;, &quot;org.apache.kafka.common.serialization.StringDeserializer&quot;) properties.setProperty(&quot;value.deserializer&quot;, &quot;org.apache.kafka.common.serialization.StringDeserializer&quot;) properties.setProperty(&quot;auto.offset.reset&quot;, &quot;latest&quot;) val env = StreamExecutionEnvironment.getExecutionEnvironment env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime) env.setParallelism(1) val stream = env .addSource(new FlinkKafkaConsumer[String](&quot;hotitems&quot;, new SimpleStringSchema(), properties)) å½“ç„¶ï¼Œ æ ¹æ®å®é™…çš„éœ€è¦ï¼Œ æˆ‘ä»¬è¿˜å¯ä»¥å°† Sink æŒ‡å®šä¸º Kafkaã€ ESã€ Redis æˆ–å…¶å®ƒ å­˜å‚¨ï¼Œ è¿™é‡Œå°±ä¸ä¸€ä¸€å±•å¼€å®ç°äº† æ€»ç»“ æœ¬æ–‡çš„å®Œæ•´ä»£ç å¯ä»¥é€šè¿‡ GitHub è®¿é—®åˆ°ã€‚æœ¬æ–‡é€šè¿‡å®ç°ä¸€ä¸ªâ€œå®æ—¶çƒ­é—¨å•†å“â€çš„æ¡ˆä¾‹ï¼Œå­¦ä¹ å’Œå®è·µäº† Flink çš„å¤šä¸ªæ ¸å¿ƒæ¦‚å¿µå’Œ API ç”¨æ³•ã€‚åŒ…æ‹¬ EventTimeã€Watermark çš„ä½¿ç”¨ï¼ŒState çš„ä½¿ç”¨ï¼ŒWindow API çš„ä½¿ç”¨ï¼Œä»¥åŠ TopN çš„å®ç°ã€‚å¸Œæœ›æœ¬æ–‡èƒ½åŠ æ·±å¤§å®¶å¯¹ Flink çš„ç†è§£ï¼Œå¸®åŠ©å¤§å®¶è§£å†³å®æˆ˜ä¸Šé‡åˆ°çš„é—®é¢˜ã€‚ ","link":"https://tianxiawuhao.github.io/use-flink-calculate-hot-items/"},{"title":"ä»é›¶æ„å»ºç¬¬ä¸€ä¸ª Flink åº”ç”¨","content":" åŸæ–‡ï¼šhttp://wuchong.me/blog/2018/11/07/5-minutes-build-first-flink-application/ ä½œè€…ï¼šäº‘é‚ªï¼ˆJarkï¼‰ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä»é›¶å¼€å§‹ï¼Œæ•™æ‚¨å¦‚ä½•æ„å»ºç¬¬ä¸€ä¸ª Flink åº”ç”¨ç¨‹åºã€‚ å¼€å‘ç¯å¢ƒå‡†å¤‡ Flink å¯ä»¥è¿è¡Œåœ¨ Linux, Max OS X, æˆ–è€…æ˜¯ Windows ä¸Šã€‚ä¸ºäº†å¼€å‘ Flink åº”ç”¨ç¨‹åºï¼Œåœ¨æœ¬åœ°æœºå™¨ä¸Šéœ€è¦æœ‰ Java 8.x å’Œ maven ç¯å¢ƒã€‚ å¦‚æœæœ‰ Java 8 ç¯å¢ƒï¼Œè¿è¡Œä¸‹é¢çš„å‘½ä»¤ä¼šè¾“å‡ºå¦‚ä¸‹ç‰ˆæœ¬ä¿¡æ¯ï¼š $ java -version java version &quot;1.8.0_65&quot; Java(TM) SE Runtime Environment (build 1.8.0_65-b17) Java HotSpot(TM) 64-Bit Server VM (build 25.65-b01, mixed mode) å¦‚æœæœ‰ maven ç¯å¢ƒï¼Œè¿è¡Œä¸‹é¢çš„å‘½ä»¤ä¼šè¾“å‡ºå¦‚ä¸‹ç‰ˆæœ¬ä¿¡æ¯ï¼š $ mvn -version Apache Maven 3.5.4 (1edded0938998edf8bf061f1ceb3cfdeccf443fe; 2018-06-18T02:33:14+08:00) Maven home: /Users/wuchong/dev/maven Java version: 1.8.0_65, vendor: Oracle Corporation, runtime: /Library/Java/JavaVirtualMachines/jdk1.8.0_65.jdk/Contents/Home/jre Default locale: zh_CN, platform encoding: UTF-8 OS name: &quot;mac os x&quot;, version: &quot;10.13.6&quot;, arch: &quot;x86_64&quot;, family: &quot;mac&quot; å¦å¤–æˆ‘ä»¬æ¨èä½¿ç”¨ ItelliJ IDEA ï¼ˆç¤¾åŒºå…è´¹ç‰ˆå·²å¤Ÿç”¨ï¼‰ä½œä¸º Flink åº”ç”¨ç¨‹åºçš„å¼€å‘ IDEã€‚Eclipse è™½ç„¶ä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯ Eclipse åœ¨ Scala å’Œ Java æ··åˆå‹é¡¹ç›®ä¸‹ä¼šæœ‰äº›å·²çŸ¥é—®é¢˜ï¼Œæ‰€ä»¥ä¸å¤ªæ¨è Eclipseã€‚ä¸‹ä¸€ç« èŠ‚ï¼Œæˆ‘ä»¬ä¼šä»‹ç»å¦‚ä½•åˆ›å»ºä¸€ä¸ª Flink å·¥ç¨‹å¹¶å°†å…¶å¯¼å…¥ ItelliJ IDEAã€‚ åˆ›å»º Maven é¡¹ç›® æˆ‘ä»¬å°†ä½¿ç”¨ Flink Maven Archetype æ¥åˆ›å»ºæˆ‘ä»¬çš„é¡¹ç›®ç»“æ„å’Œä¸€äº›åˆå§‹çš„é»˜è®¤ä¾èµ–ã€‚åœ¨ä½ çš„å·¥ä½œç›®å½•ä¸‹ï¼Œè¿è¡Œå¦‚ä¸‹å‘½ä»¤æ¥åˆ›å»ºé¡¹ç›®ï¼š mvn archetype:generate \\ -DarchetypeGroupId=org.apache.flink \\ -DarchetypeArtifactId=flink-quickstart-java \\ -DarchetypeVersion=1.6.1 \\ -DgroupId=my-flink-project \\ -DartifactId=my-flink-project \\ -Dversion=0.1 \\ -Dpackage=myflink \\ -DinteractiveMode=false ä½ å¯ä»¥ç¼–è¾‘ä¸Šé¢çš„ groupId, artifactId, package æˆä½ å–œæ¬¢çš„è·¯å¾„ã€‚ä½¿ç”¨ä¸Šé¢çš„å‚æ•°ï¼ŒMaven å°†è‡ªåŠ¨ä¸ºä½ åˆ›å»ºå¦‚ä¸‹æ‰€ç¤ºçš„é¡¹ç›®ç»“æ„ï¼š $ tree my-flink-project my-flink-project â”œâ”€â”€ pom.xml â””â”€â”€ src â””â”€â”€ main â”œâ”€â”€ java â”‚ â””â”€â”€ myflink â”‚ â”œâ”€â”€ BatchJob.java â”‚ â””â”€â”€ StreamingJob.java â””â”€â”€ resources â””â”€â”€ log4j.properties æˆ‘ä»¬çš„ pom.xml æ–‡ä»¶å·²ç»åŒ…å«äº†æ‰€éœ€çš„ Flink ä¾èµ–ï¼Œå¹¶ä¸”åœ¨ src/main/java ä¸‹æœ‰å‡ ä¸ªç¤ºä¾‹ç¨‹åºæ¡†æ¶ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†å¼€å§‹ç¼–å†™ç¬¬ä¸€ä¸ª Flink ç¨‹åºã€‚ ç¼–å†™ Flink ç¨‹åº å¯åŠ¨ IntelliJ IDEAï¼Œé€‰æ‹© â€œImport Projectâ€ï¼ˆå¯¼å…¥é¡¹ç›®ï¼‰ï¼Œé€‰æ‹© my-flink-project æ ¹ç›®å½•ä¸‹çš„ pom.xmlã€‚æ ¹æ®å¼•å¯¼ï¼Œå®Œæˆé¡¹ç›®å¯¼å…¥ã€‚ åœ¨ src/main/java/myflink ä¸‹åˆ›å»º SocketWindowWordCount.java æ–‡ä»¶ï¼š package myflink; public class SocketWindowWordCount { public static void main(String[] args) throws Exception { } } ç°åœ¨è¿™ç¨‹åºè¿˜å¾ˆåŸºç¡€ï¼Œæˆ‘ä»¬ä¼šä¸€æ­¥æ­¥å¾€é‡Œé¢å¡«ä»£ç ã€‚æ³¨æ„ä¸‹æ–‡ä¸­æˆ‘ä»¬ä¸ä¼šå°† import è¯­å¥ä¹Ÿå†™å‡ºæ¥ï¼Œå› ä¸º IDE ä¼šè‡ªåŠ¨å°†ä»–ä»¬æ·»åŠ ä¸Šå»ã€‚åœ¨æœ¬èŠ‚æœ«å°¾ï¼Œæˆ‘ä¼šå°†å®Œæ•´çš„ä»£ç å±•ç¤ºå‡ºæ¥ï¼Œå¦‚æœä½ æƒ³è·³è¿‡ä¸‹é¢çš„æ­¥éª¤ï¼Œå¯ä»¥ç›´æ¥å°†æœ€åçš„å®Œæ•´ä»£ç ç²˜åˆ°ç¼–è¾‘å™¨ä¸­ã€‚ Flink ç¨‹åºçš„ç¬¬ä¸€æ­¥æ˜¯åˆ›å»ºä¸€ä¸ª StreamExecutionEnvironment ã€‚è¿™æ˜¯ä¸€ä¸ªå…¥å£ç±»ï¼Œå¯ä»¥ç”¨æ¥è®¾ç½®å‚æ•°å’Œåˆ›å»ºæ•°æ®æºä»¥åŠæäº¤ä»»åŠ¡ã€‚æ‰€ä»¥è®©æˆ‘ä»¬æŠŠå®ƒæ·»åŠ åˆ° main å‡½æ•°ä¸­ï¼š StreamExecutionEnvironment see = StreamExecutionEnvironment.getExecutionEnvironment(); ä¸‹ä¸€æ­¥æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªä»æœ¬åœ°ç«¯å£å· 9000 çš„ socket ä¸­è¯»å–æ•°æ®çš„æ•°æ®æºï¼š DataStream&lt;String&gt; text = env.socketTextStream(&quot;localhost&quot;, 9000, &quot;\\n&quot;); è¿™åˆ›å»ºäº†ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„ DataStreamã€‚DataStream æ˜¯ Flink ä¸­åšæµå¤„ç†çš„æ ¸å¿ƒ APIï¼Œä¸Šé¢å®šä¹‰äº†éå¸¸å¤šå¸¸è§çš„æ“ä½œï¼ˆå¦‚ï¼Œè¿‡æ»¤ã€è½¬æ¢ã€èšåˆã€çª—å£ã€å…³è”ç­‰ï¼‰ã€‚åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æ„Ÿå…´è¶£çš„æ˜¯æ¯ä¸ªå•è¯åœ¨ç‰¹å®šæ—¶é—´çª—å£ä¸­å‡ºç°çš„æ¬¡æ•°ï¼Œæ¯”å¦‚è¯´5ç§’çª—å£ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬é¦–å…ˆè¦å°†å­—ç¬¦ä¸²æ•°æ®è§£ææˆå•è¯å’Œæ¬¡æ•°ï¼ˆä½¿ç”¨Tuple2&lt;String, Integer&gt;è¡¨ç¤ºï¼‰ï¼Œç¬¬ä¸€ä¸ªå­—æ®µæ˜¯å•è¯ï¼Œç¬¬äºŒä¸ªå­—æ®µæ˜¯æ¬¡æ•°ï¼Œæ¬¡æ•°åˆå§‹å€¼éƒ½è®¾ç½®æˆäº†1ã€‚æˆ‘ä»¬å®ç°äº†ä¸€ä¸ª flatmap æ¥åšè§£æçš„å·¥ä½œï¼Œå› ä¸ºä¸€è¡Œæ•°æ®ä¸­å¯èƒ½æœ‰å¤šä¸ªå•è¯ã€‚ DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; wordCounts = text .flatMap(new FlatMapFunction&lt;String, Tuple2&lt;String, Integer&gt;&gt;() { @Override public void flatMap(String value, Collector&lt;Tuple2&lt;String, Integer&gt;&gt; out) { for (String word : value.split(&quot;\\\\s&quot;)) { out.collect(Tuple2.of(word, 1)); } } }); æ¥ç€æˆ‘ä»¬å°†æ•°æ®æµæŒ‰ç…§å•è¯å­—æ®µï¼ˆå³0å·ç´¢å¼•å­—æ®µï¼‰åšåˆ†ç»„ï¼Œè¿™é‡Œå¯ä»¥ç®€å•åœ°ä½¿ç”¨ keyBy(int index) æ–¹æ³•ï¼Œå¾—åˆ°ä¸€ä¸ªä»¥å•è¯ä¸º key çš„Tuple2&lt;String, Integer&gt;æ•°æ®æµã€‚ç„¶åæˆ‘ä»¬å¯ä»¥åœ¨æµä¸ŠæŒ‡å®šæƒ³è¦çš„çª—å£ï¼Œå¹¶æ ¹æ®çª—å£ä¸­çš„æ•°æ®è®¡ç®—ç»“æœã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æƒ³è¦æ¯5ç§’èšåˆä¸€æ¬¡å•è¯æ•°ï¼Œæ¯ä¸ªçª—å£éƒ½æ˜¯ä»é›¶å¼€å§‹ç»Ÿè®¡çš„ï¼šã€‚ DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; windowCounts = wordCounts .keyBy(0) .timeWindow(Time.seconds(5)) .sum(1); ç¬¬äºŒä¸ªè°ƒç”¨çš„.timeWindow()æŒ‡å®šæˆ‘ä»¬æƒ³è¦5ç§’çš„ç¿»æ»šçª—å£ï¼ˆTumbleï¼‰ã€‚ç¬¬ä¸‰ä¸ªè°ƒç”¨ä¸ºæ¯ä¸ªkeyæ¯ä¸ªçª—å£æŒ‡å®šäº†sumèšåˆå‡½æ•°ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯æŒ‰ç…§æ¬¡æ•°å­—æ®µï¼ˆå³1å·ç´¢å¼•å­—æ®µï¼‰ç›¸åŠ ã€‚å¾—åˆ°çš„ç»“æœæ•°æ®æµï¼Œå°†æ¯5ç§’è¾“å‡ºä¸€æ¬¡è¿™5ç§’å†…æ¯ä¸ªå•è¯å‡ºç°çš„æ¬¡æ•°ã€‚ æœ€åä¸€ä»¶äº‹å°±æ˜¯å°†æ•°æ®æµæ‰“å°åˆ°æ§åˆ¶å°ï¼Œå¹¶å¼€å§‹æ‰§è¡Œï¼š windowCounts.print().setParallelism(1); env.execute(&quot;Socket Window WordCount&quot;); æœ€åçš„ env.execute è°ƒç”¨æ˜¯å¯åŠ¨å®é™…Flinkä½œä¸šæ‰€å¿…éœ€çš„ã€‚æ‰€æœ‰ç®—å­æ“ä½œï¼ˆä¾‹å¦‚åˆ›å»ºæºã€èšåˆã€æ‰“å°ï¼‰åªæ˜¯æ„å»ºäº†å†…éƒ¨ç®—å­æ“ä½œçš„å›¾å½¢ã€‚åªæœ‰åœ¨execute()è¢«è°ƒç”¨æ—¶æ‰ä¼šåœ¨æäº¤åˆ°é›†ç¾¤ä¸Šæˆ–æœ¬åœ°è®¡ç®—æœºä¸Šæ‰§è¡Œã€‚ ä¸‹é¢æ˜¯å®Œæ•´çš„ä»£ç ï¼Œéƒ¨åˆ†ä»£ç ç»è¿‡ç®€åŒ–ï¼ˆä»£ç åœ¨ GitHub ä¸Šä¹Ÿèƒ½è®¿é—®åˆ°ï¼‰ï¼š package myflink; import org.apache.flink.api.common.functions.FlatMapFunction; import org.apache.flink.api.java.tuple.Tuple2; import org.apache.flink.streaming.api.datastream.DataStream; import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment; import org.apache.flink.streaming.api.windowing.time.Time; import org.apache.flink.util.Collector; public class SocketWindowWordCount { public static void main(String[] args) throws Exception { // åˆ›å»º execution environment final StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); // é€šè¿‡è¿æ¥ socket è·å–è¾“å…¥æ•°æ®ï¼Œè¿™é‡Œè¿æ¥åˆ°æœ¬åœ°9000ç«¯å£ï¼Œå¦‚æœ9000ç«¯å£å·²è¢«å ç”¨ï¼Œè¯·æ¢ä¸€ä¸ªç«¯å£ DataStream&lt;String&gt; text = env.socketTextStream(&quot;localhost&quot;, 9000, &quot;\\n&quot;); // è§£ææ•°æ®ï¼ŒæŒ‰ word åˆ†ç»„ï¼Œå¼€çª—ï¼Œèšåˆ DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; windowCounts = text .flatMap(new FlatMapFunction&lt;String, Tuple2&lt;String, Integer&gt;&gt;() { @Override public void flatMap(String value, Collector&lt;Tuple2&lt;String, Integer&gt;&gt; out) { for (String word : value.split(&quot;\\\\s&quot;)) { out.collect(Tuple2.of(word, 1)); } } }) .keyBy(0) .timeWindow(Time.seconds(5)) .sum(1); // å°†ç»“æœæ‰“å°åˆ°æ§åˆ¶å°ï¼Œæ³¨æ„è¿™é‡Œä½¿ç”¨çš„æ˜¯å•çº¿ç¨‹æ‰“å°ï¼Œè€Œéå¤šçº¿ç¨‹ windowCounts.print().setParallelism(1); env.execute(&quot;Socket Window WordCount&quot;); } } è¿è¡Œç¨‹åº è¦è¿è¡Œç¤ºä¾‹ç¨‹åºï¼Œé¦–å…ˆæˆ‘ä»¬åœ¨ç»ˆç«¯å¯åŠ¨ netcat è·å¾—è¾“å…¥æµï¼š nc -lk 9000 å¦‚æœæ˜¯ Windows å¹³å°ï¼Œå¯ä»¥é€šè¿‡ https://nmap.org/ncat/ å®‰è£… ncat ç„¶åè¿è¡Œï¼š ncat -lk 9000 ç„¶åç›´æ¥è¿è¡ŒSocketWindowWordCountçš„ main æ–¹æ³•ã€‚ åªéœ€è¦åœ¨ netcat æ§åˆ¶å°è¾“å…¥å•è¯ï¼Œå°±èƒ½åœ¨ SocketWindowWordCount çš„è¾“å‡ºæ§åˆ¶å°çœ‹åˆ°æ¯ä¸ªå•è¯çš„è¯é¢‘ç»Ÿè®¡ã€‚å¦‚æœæƒ³çœ‹åˆ°å¤§äº1çš„è®¡æ•°ï¼Œè¯·åœ¨5ç§’å†…åå¤é”®å…¥ç›¸åŒçš„å•è¯ã€‚ Cheers! ğŸ‰ ","link":"https://tianxiawuhao.github.io/build-first-flink-application/"}]}